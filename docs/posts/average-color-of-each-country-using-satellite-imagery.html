<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://eox.at/2021/08/average-colors-of-the-world/">Original</a>
    <h1>Average color of each country (using satellite imagery)</h1>
    
    <div id="readability-page-1" class="page"><article> <header><section><p><img src="https://eox.at/images/worldmap.png" alt="" width="100%" height="auto"/></p></section>    <!----></header>  <section><div><p><em>Couple of weeks ago we have noticed the <a href="https://erdavis.com/2021/06/26/average-colors-of-the-world/?ref=sidebar" target="_blank" rel="noopener noreferrer">article<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a>
getting attention around <a href="https://twitter.com/simongerman600/status/1416128010906963970?s=20" target="_blank" rel="noopener noreferrer">twitter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a>.
As it is using our <a href="https://tiles.maps.eox.at/wms?service=wms&amp;request=getcapabilities" target="_blank" rel="noopener noreferrer">WMS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a>
EOxMaps endpoint we have asked <a href="https://erdavis.com/" target="_blank" rel="noopener noreferrer">Erin Davis<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a> if we could host
her idea here. At EOX we endorse brilliant and unique ideas that utilize our
tools and data. Thank you for this most interesting contribution. Now follows
the original article.</em></p> <hr/> <p>I wrote that I wanted to expand creatively beyond maps in 2021, but here we are,
halfway in, and half my posts are maps.</p> <p>In my defense, I made these last year and just haven’t gotten around to posting
them yet! They’ve been sitting in a folder since December, mocking me.
It’s time to get these guys off my computer and out into the world so
I can move on to other things.</p> <p>Since it’s been so long, I really don’t remember what inspired me to make these.
I’m sure memories of this amazing <a href="https://www.nytimes.com/interactive/2020/09/02/upshot/america-political-spectrum.html" target="_blank" rel="noopener noreferrer">NYT Upshot article<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a>
were involved. The difference here is I didn’t even try to tell a story with
these maps… I just made them as something pretty to look at.</p> <h2 id="average-colors-of-the-usa"><a href="#average-colors-of-the-usa">#</a> Average colors of the USA</h2> <p>A question: do you think it’s best practice to label US states?
I usually haven’t in my personal work, but I do in my day job… the labeled
look might be growing on me.</p> <div><div><div><figure><img src="https://eox.at/images/usa_v2.png"/> <figcaption></figcaption></figure></div></div></div> <div><div><div><figure><img src="https://eox.at/images/usa_bystate.png"/> <figcaption></figcaption></figure></div></div></div> <h2 id="average-colors-of-the-world"><a href="#average-colors-of-the-world">#</a> Average colors of the world</h2> <div><div><div><figure><img src="https://eox.at/images/worldmap.png"/> <figcaption></figcaption></figure></div></div></div> <div><div><div><figure><img src="https://eox.at/images/africa.png"/> <figcaption></figcaption></figure></div></div></div> <div><div><div><figure><img src="https://eox.at/images/asia.png"/> <figcaption></figcaption></figure></div></div></div> <div><div><div><figure><img src="https://eox.at/images/europe.png"/> <figcaption></figcaption></figure></div></div></div> <div><div><div><figure><img src="https://eox.at/images/southamerica.png"/> <figcaption></figcaption></figure></div></div></div> <h2 id="how-i-did-it"><a href="#how-i-did-it">#</a> How I did it</h2> <p>To do this, you’ll need a few things:</p> <ol><li>A shapefile of the areas you want the colors for (from e. g.: <a href="https://www.naturalearthdata.com/" target="_blank" rel="noopener noreferrer">https://www.naturalearthdata.com/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a>)</li> <li><a href="https://www.qgis.org/en/site/" target="_blank" rel="noopener noreferrer">QGIS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a> installed (or GDAL/Python, but installing QGIS will set it all up for you)</li> <li>R and <a href="https://www.rstudio.com/" target="_blank" rel="noopener noreferrer">RStudio<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a> installed</li></ol> <p>In short, my process was the following:</p> <ol><li>Wrote a script (in R) to find the bounding boxes of all the areas I was interested in</li> <li>In R, downloaded pictures of those areas from Sentinel-2</li> <li>In R, wrote a script that created a series of <a href="https://gdal.org/" target="_blank" rel="noopener noreferrer">GDAL<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a> commands to:
<ol><li>Georeference the downloaded image to create a geotiff</li> <li>Crop the geotiff to the borders of the area</li> <li>Re-project the geotiff to a sensible projection</li></ol></li> <li>Ran that GDAL script</li> <li>In R, converted the geotiffs back to pngs, and found the average color of the png</li></ol> <p>Basically, I did everything in R, including creating the GDAL script.
I just briefly stepped outside of R to run that script then jumped back in to
finish the project. What the GDAL script does is possible within R using the
<a href="https://github.com/paleolimbot/qgisprocess" target="_blank" rel="noopener noreferrer">qgisprocess<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a> package, but I’m
pretty sure (based on 0 testing tbh) that GDAL is faster.</p> <p>Side note: I feel really embarrassed lifting the curtain and showing my wacky
processes to get viz done. I’ve often avoided sharing, especially in
professional situations, for fear that better-informed people will laugh at me.
But I think it’s good to have more people sharing their code so we can all
improve. All my GIS knowledge (and quite a lot of my general coding knowledge)
is self-taught, and I owe a huge debt to people online who bothered to explain
how they did things. My point? I don’t know… I guess if you know of a better
way to do this, please let me know! But also I was really proud I figured out
this much on my own.</p> <div><pre><code>

 

library<span>(</span>magick<span>)</span>
library<span>(</span>sf<span>)</span>
library<span>(</span>dplyr<span>)</span>
</code></pre> </div><p>Get your shapefile loaded and prepped:</p> <div><pre><code>
setwd<span>(</span><span>&#34;C:/Users/Erin/Documents/DataViz/AvgColor/Temp/&#34;</span><span>)</span>
 

dir.create<span>(</span>file.path<span>(</span>getwd<span>(</span><span>)</span><span>,</span> <span>&#34;satellite&#34;</span><span>)</span><span>,</span> showWarnings <span>=</span> <span>FALSE</span><span>)</span>
dir.create<span>(</span>file.path<span>(</span>getwd<span>(</span><span>)</span><span>,</span> <span>&#34;shapes&#34;</span><span>)</span><span>,</span> showWarnings <span>=</span> <span>FALSE</span><span>)</span>
 


shapes <span>&lt;-</span> read_sf<span>(</span><span>&#34;cb_2018_us_state_20m.shp&#34;</span><span>)</span>
 

<span>for</span> <span>(</span>i <span>in</span> <span>1</span><span>:</span>nrow<span>(</span>shapes<span>)</span><span>)</span> <span>{</span>
  shape <span>&lt;-</span> shapes<span>[</span>i<span>,</span> <span>]</span>
  write_sf<span>(</span>shape<span>,</span> paste0<span>(</span><span>&#34;./shapes/&#34;</span><span>,</span> shape<span>$</span>NAME<span>,</span> <span>&#34;.shp&#34;</span><span>)</span><span>,</span> delete_datasource <span>=</span> <span>TRUE</span><span>)</span>
<span>}</span>
</code></pre> </div><p>Download the satellite imagery</p> <div><pre><code>

shapes <span>&lt;-</span> read_sf<span>(</span><span>&#34;cb_2018_us_state_20m.shp&#34;</span><span>)</span>
 

<span>for</span> <span>(</span>i <span>in</span> <span>1</span><span>:</span>nrow<span>(</span>shapes<span>)</span><span>)</span> <span>{</span>
  shape <span>&lt;-</span> shapes<span>[</span>i<span>,</span> <span>]</span> <span>%&gt;%</span> st_transform<span>(</span><span>4326</span><span>)</span>
  box <span>&lt;-</span> st_bbox<span>(</span>shape<span>)</span>
   
  url <span>&lt;-</span> paste0<span>(</span><span>&#34;https://tiles.maps.eox.at/wms?service=wms&amp;request=getmap&amp;version=1.1.1&amp;layers=s2cloudless-2019&amp;&#34;</span><span>,</span>
                <span>&#34;bbox=&#34;</span><span>,</span> box<span>$</span>xmin<span>-</span><span>.05</span><span>,</span> <span>&#34;,&#34;</span><span>,</span> box<span>$</span>ymin<span>-</span><span>.05</span><span>,</span> <span>&#34;,&#34;</span><span>,</span> box<span>$</span>xmax<span>+</span><span>.05</span><span>,</span> <span>&#34;,&#34;</span><span>,</span> box<span>$</span>ymax<span>+</span><span>.05</span><span>,</span>
                <span>&#34;&amp;width=4096&amp;height=4096&amp;srs=epsg:4326&#34;</span><span>)</span>
   
  
  
  download.file<span>(</span>url<span>,</span> paste0<span>(</span><span>&#34;./satellite/&#34;</span><span>,</span> gsub<span>(</span><span>&#34;/&#34;</span><span>,</span> <span>&#34;&#34;</span><span>,</span> shape<span>$</span>NAME<span>)</span><span>,</span> <span>&#34;.jpg&#34;</span><span>)</span><span>,</span> mode <span>=</span> <span>&#34;wb&#34;</span><span>)</span>
<span>}</span>
</code></pre> </div><p>Create a GDAL script to transform those square satellite images into cropped,
reprojected geotifs.</p> <p>Note: for some reason, GDAL refuses to deal with any folders other than my
temp directory. I couldn’t figure out how to get it to successfully write
to my working directory, so I just did stuff in the temp one.
Minor annoyance, but what can you do.</p> <div><pre><code>
<span>if</span> <span>(</span>file.exists<span>(</span><span>&#34;script.txt&#34;</span><span>)</span><span>)</span> <span>{</span> file.remove<span>(</span><span>&#34;script.txt&#34;</span><span>)</span><span>}</span>
 

<span>for</span> <span>(</span>i <span>in</span> <span>1</span><span>:</span>nrow<span>(</span>shapes<span>)</span><span>)</span> <span>{</span>
  shape <span>&lt;-</span> shapes<span>[</span>i<span>,</span> <span>]</span>
  box <span>&lt;-</span> st_bbox<span>(</span>shape<span>)</span>
   
  file_origin <span>&lt;-</span> paste0<span>(</span>getwd<span>(</span><span>)</span><span>,</span> <span>&#39;/satellite/&#39;</span><span>,</span> shape<span>$</span>NAME<span>,</span> <span>&#39;.jpg&#39;</span><span>)</span>
  file_temp <span>&lt;-</span> paste0<span>(</span>tempdir<span>(</span><span>)</span><span>,</span> <span>&#34;/&#34;</span><span>,</span> shape<span>$</span>NAME<span>,</span> <span>&#39;.jpg&#39;</span><span>)</span>
  file_final <span>&lt;-</span> paste0<span>(</span>tempdir<span>(</span><span>)</span><span>,</span> <span>&#34;/&#34;</span><span>,</span> shape<span>$</span>NAME<span>,</span> <span>&#39;_ref.tif&#39;</span><span>)</span>
   
  cmd1 <span>&lt;-</span> paste0<span>(</span><span>&#34;gdal_translate -of GTiff&#34;</span><span>,</span>
                 <span>&#34; -gcp &#34;</span><span>,</span> <span>0</span><span>,</span> <span>&#34; &#34;</span><span>,</span> <span>0</span><span>,</span> <span>&#34; &#34;</span><span>,</span> box<span>$</span>xmin<span>,</span> <span>&#34; &#34;</span><span>,</span> box<span>$</span>ymax<span>,</span>
                 <span>&#34; -gcp &#34;</span><span>,</span> <span>4096</span><span>,</span> <span>&#34; &#34;</span><span>,</span> <span>0</span><span>,</span> <span>&#34; &#34;</span><span>,</span> box<span>$</span>xmax<span>,</span> <span>&#34; &#34;</span><span>,</span> box<span>$</span>ymax<span>,</span>
                 <span>&#34; -gcp &#34;</span><span>,</span> <span>0</span><span>,</span> <span>&#34; &#34;</span><span>,</span> <span>4096</span><span>,</span> <span>&#34; &#34;</span><span>,</span> box<span>$</span>xmin<span>,</span> <span>&#34; &#34;</span><span>,</span> box<span>$</span>ymin<span>,</span>
                 <span>&#34; -gcp &#34;</span><span>,</span> <span>4096</span><span>,</span> <span>&#34; &#34;</span><span>,</span> <span>4096</span><span>,</span> <span>&#34; &#34;</span><span>,</span> box<span>$</span>xmax<span>,</span> <span>&#34; &#34;</span><span>,</span> box<span>$</span>ymin<span>,</span>
                 <span>&#39; &#34;&#39;</span><span>,</span> file_origin<span>,</span> <span>&#39;&#34;&#39;</span><span>,</span>
                 <span>&#39; &#34;&#39;</span><span>,</span> file_temp<span>,</span> <span>&#39;&#34;&#39;</span><span>)</span>
   
  cmd2 <span>&lt;-</span> paste0<span>(</span><span>&#34;gdalwarp -r near -tps -co COMPRESS=NONE  -t_srs EPSG:4326&#34;</span><span>,</span>
                 <span>&#39; &#34;&#39;</span><span>,</span> file_temp<span>,</span> <span>&#39;&#34;&#39;</span><span>,</span>
                 <span>&#39; &#34;&#39;</span><span>,</span> file_final<span>,</span> <span>&#39;&#34;&#39;</span><span>)</span>
   
  write<span>(</span>cmd1<span>,</span>file<span>=</span><span>&#34;script.txt&#34;</span><span>,</span>append<span>=</span><span>TRUE</span><span>)</span>
  write<span>(</span>cmd2<span>,</span>file<span>=</span><span>&#34;script.txt&#34;</span><span>,</span>append<span>=</span><span>TRUE</span><span>)</span>
<span>}</span>
 

<span>for</span> <span>(</span>i <span>in</span>  <span>1</span><span>:</span>nrow<span>(</span>shapes<span>)</span><span>)</span> <span>{</span>
  shape <span>&lt;-</span> shapes<span>[</span>i<span>,</span> <span>]</span>
  file_shp <span>&lt;-</span> paste0<span>(</span>getwd<span>(</span><span>)</span><span>,</span> <span>&#39;/shapes/&#39;</span><span>,</span> shape<span>$</span>NAME<span>,</span> <span>&#39;.shp&#39;</span><span>)</span>
  file_orig <span>&lt;-</span>  paste0<span>(</span>tempdir<span>(</span><span>)</span><span>,</span> <span>&#34;/&#34;</span><span>,</span> shape<span>$</span>NAME<span>,</span> <span>&#39;_ref.tif&#39;</span><span>)</span>
  file_crop <span>&lt;-</span>  paste0<span>(</span>tempdir<span>(</span><span>)</span><span>,</span> <span>&#34;/&#34;</span><span>,</span> shape<span>$</span>NAME<span>,</span> <span>&#39;_crop.tif&#39;</span><span>)</span>
   
  cmd <span>&lt;-</span> paste0<span>(</span><span>&#34;gdalwarp -cutline&#34;</span><span>,</span>
                <span>&#39; &#34;&#39;</span><span>,</span> file_shp<span>,</span> <span>&#39;&#34;&#39;</span><span>,</span>
                <span>&#34; -crop_to_cutline -of GTiff  -dstnodata 255&#34;</span><span>,</span>
                <span>&#39; &#34;&#39;</span><span>,</span> file_orig<span>,</span> <span>&#39;&#34;&#39;</span><span>,</span>
                <span>&#39; &#34;&#39;</span><span>,</span> file_crop<span>,</span> <span>&#39;&#34;&#39;</span><span>,</span>
                <span>&#34; -co COMPRESS=LZW -co TILED=YES --config GDAL_CACHEMAX 2048 -multi&#34;</span><span>)</span>
   
  write<span>(</span>cmd<span>,</span>file<span>=</span><span>&#34;script.txt&#34;</span><span>,</span>append<span>=</span><span>TRUE</span><span>)</span>
<span>}</span>
 

<span>for</span> <span>(</span>i <span>in</span>  <span>1</span><span>:</span>nrow<span>(</span>shapes<span>)</span><span>)</span> <span>{</span>
  shape <span>&lt;-</span> shapes<span>[</span>i<span>,</span> <span>]</span>
   
  center <span>&lt;-</span> st_centroid<span>(</span>shape<span>)</span> <span>%&gt;%</span> st_coordinates
  utm <span>&lt;-</span> as.character<span>(</span>floor<span>(</span><span>(</span>center<span>[</span><span>1</span><span>]</span> <span>+</span> <span>180</span><span>)</span> <span>/</span> <span>6</span><span>)</span> <span>+</span> <span>1</span><span>)</span>
  <span>if</span> <span>(</span>nchar<span>(</span>utm<span>)</span> <span>==</span> <span>1</span><span>)</span> <span>{</span>utm <span>&lt;-</span> paste0<span>(</span><span>&#34;0&#34;</span><span>,</span> utm<span>)</span><span>}</span>
  <span>if</span> <span>(</span>center<span>[</span><span>2</span><span>]</span> <span>&gt;=</span><span>0</span><span>)</span> <span>{</span>
    epsg <span>&lt;-</span> paste0<span>(</span><span>&#34;326&#34;</span><span>,</span> utm<span>)</span>
  <span>}</span> <span>else</span> <span>{</span>
    epsg <span>&lt;-</span> paste0<span>(</span><span>&#34;327&#34;</span><span>,</span> utm<span>)</span>
  <span>}</span>
   
  file_orig <span>&lt;-</span> paste0<span>(</span>tempdir<span>(</span><span>)</span><span>,</span> <span>&#34;/&#34;</span><span>,</span> shape<span>$</span>NAME<span>,</span> <span>&#39;_crop.tif&#39;</span><span>)</span>
  file_mod <span>&lt;-</span> paste0<span>(</span>tempdir<span>(</span><span>)</span><span>,</span> <span>&#34;/&#34;</span><span>,</span> shape<span>$</span>NAME<span>,</span> <span>&#39;_reproj.tif&#39;</span><span>)</span>
   
  cmd <span>&lt;-</span> paste0<span>(</span><span>&#34;gdalwarp -t_srs EPSG:&#34;</span><span>,</span> epsg<span>,</span>
                <span>&#39; &#34;&#39;</span><span>,</span> file_orig<span>,</span> <span>&#39;&#34;&#39;</span><span>,</span>
                <span>&#39; &#34;&#39;</span><span>,</span> file_mod<span>,</span> <span>&#39;&#34;&#39;</span><span>)</span>
   
  write<span>(</span>cmd<span>,</span>file<span>=</span><span>&#34;script.txt&#34;</span><span>,</span>append<span>=</span><span>TRUE</span><span>)</span>
<span>}</span>
</code></pre> </div><p><strong>Now’s the time to step out of R and into GDAL</strong></p> <ol><li>In the start menu, search for OSGeo4W Shell and open it. You should see a command-line style interface.</li> <li>In your working directory, find and open script.txt. It should have a bunch of commands in it.</li> <li>Copy all the commands in script.txt and paste them right into the OSGeo4W Shell. Press enter to run the commands.</li> <li>If you have many shapefiles, this might take a while. Wait until everything has finished running before moving to the next step.</li></ol> <p><strong>Now, hop back into R.</strong></p> <p>Move the files we just created back into the working directory.</p> <div><pre><code>
files <span>&lt;-</span> list.files<span>(</span>tempdir<span>(</span><span>)</span><span>,</span> pattern <span>=</span> <span>&#34;_reproj.tif&#34;</span><span>)</span>
<span>for</span> <span>(</span>i <span>in</span> <span>1</span><span>:</span>length<span>(</span>files<span>)</span><span>)</span> <span>{</span>
  file.rename<span>(</span>from<span>=</span>paste0<span>(</span>tempdir<span>(</span><span>)</span><span>,</span> <span>&#34;/&#34;</span><span>,</span> files<span>[</span>i<span>]</span><span>)</span><span>,</span>to<span>=</span> paste0<span>(</span><span>&#34;./reproj/&#34;</span><span>,</span> files<span>[</span>i<span>]</span><span>)</span><span>)</span>
<span>}</span>
</code></pre> </div><p>Now get the average color of each image. Here I use a slightly different method
than I did for the plots shown above. While writing up this code, I found
a neat trick (resizing the image down to 1 px) that works faster than what I
did before (averaging the R, G, and B values of each pixel).</p> <div><pre><code>
files <span>&lt;-</span> list.files<span>(</span><span>&#34;./reproj/&#34;</span><span>)</span>
colors <span>&lt;-</span> <span>NULL</span>
 
<span>for</span> <span>(</span>i <span>in</span> <span>1</span><span>:</span>length<span>(</span>files<span>)</span><span>)</span> <span>{</span>
  
  img <span>&lt;-</span> image_read<span>(</span>paste0<span>(</span><span>&#34;./reproj/&#34;</span><span>,</span> files<span>[</span>i<span>]</span><span>)</span><span>)</span>
  img <span>&lt;-</span> image_transparent<span>(</span>img<span>,</span> <span>&#34;#ffffff&#34;</span><span>,</span> fuzz <span>=</span> <span>0</span><span>)</span>
 
  
  
  img <span>&lt;-</span> image_scale<span>(</span>img<span>,</span><span>&#34;1x1!&#34;</span><span>)</span>
   
  
  avgcolor <span>&lt;-</span> image_data<span>(</span>img<span>,</span> channels <span>=</span> <span>&#34;rgba&#34;</span><span>)</span><span>[</span><span>1</span><span>:</span><span>3</span><span>]</span> <span>%&gt;%</span> paste0<span>(</span>collapse<span>=</span><span>&#34;&#34;</span><span>)</span>
   
  
  colors <span>&lt;-</span> bind_rows<span>(</span>colors<span>,</span> data.frame<span>(</span>name <span>=</span> gsub<span>(</span><span>&#34;_reproj.tif&#34;</span><span>,</span> <span>&#34;&#34;</span><span>,</span> files<span>[</span>i<span>]</span><span>)</span><span>,</span> color <span>=</span> paste0<span>(</span><span>&#34;#&#34;</span><span>,</span> avgcolor<span>)</span><span>)</span><span>)</span>
<span>}</span>
 

write.csv<span>(</span>colors<span>,</span> <span>&#34;colors.csv&#34;</span><span>,</span> row.names <span>=</span> F<span>)</span>
</code></pre> </div><p>Et voilà! A lovely csv with the average color of each of your regions.</p> <p>And if you’d like to plot it all pretty, here’s how I did it in R. For this
example, I’m only going to plot the lower 48 states.</p> <div><pre><code>
install.packages<span>(</span>c<span>(</span><span>&#39;sf&#39;</span><span>,</span> <span>&#39;ggplot2&#39;</span><span>,</span> <span>&#39;ggthemes&#39;</span><span>,</span> <span>&#39;dplyr&#39;</span><span>)</span><span>)</span>
 

library<span>(</span>sf<span>)</span>
library<span>(</span>ggplot2<span>)</span>
library<span>(</span>ggthemes<span>)</span>
library<span>(</span>dplyr<span>)</span>
 

setwd<span>(</span><span>&#34;C:/Users/Erin/Documents/DataViz/AvgColor/Temp/&#34;</span><span>)</span>
 

shapes <span>&lt;-</span> read_sf<span>(</span><span>&#34;cb_2018_us_state_20m.shp&#34;</span><span>)</span>
colors <span>&lt;-</span> read.csv<span>(</span><span>&#34;colors.csv&#34;</span><span>)</span>
 

shapes <span>&lt;-</span> inner_join<span>(</span>shapes<span>,</span> colors<span>,</span> by <span>=</span> c<span>(</span><span>&#34;NAME&#34;</span> <span>=</span> <span>&#34;name&#34;</span><span>)</span><span>)</span> 
 


shapes <span>&lt;-</span> st_transform<span>(</span>shapes<span>,</span> <span>2163</span><span>)</span>
 

shapes <span>&lt;-</span> subset<span>(</span>shapes<span>,</span> <span>!</span><span>(</span>STUSPS <span>%in%</span> c<span>(</span><span>&#34;AK&#34;</span><span>,</span> <span>&#34;HI&#34;</span><span>,</span> <span>&#34;PR&#34;</span><span>)</span><span>)</span><span>)</span>
 

ggplot<span>(</span><span>)</span> <span>+</span> theme_map<span>(</span><span>)</span> <span>+</span>
  geom_sf<span>(</span>data <span>=</span> shapes<span>,</span> aes<span>(</span>fill <span>=</span> I<span>(</span>color<span>)</span><span>)</span><span>,</span> color <span>=</span> alpha<span>(</span><span>&#34;#fffbf2&#34;</span><span>,</span> <span>.1</span><span>)</span><span>)</span> <span>+</span>
  theme<span>(</span>plot.background <span>=</span> element_rect<span>(</span>fill <span>=</span> <span>&#39;#fffbf2&#39;</span><span>,</span> colour <span>=</span> <span>&#39;#fffbf2&#39;</span><span>)</span><span>)</span>
 

ggsave<span>(</span><span>&#34;avgcolors.png&#34;</span><span>,</span> width <span>=</span> <span>7</span><span>,</span> height <span>=</span> <span>9</span><span>,</span> units <span>=</span> <span>&#34;in&#34;</span><span>,</span> dpi <span>=</span> <span>500</span><span>)</span>
</code></pre> </div><hr/> <p>Erin Davis</p> <p>Originally posted on the 26th of June 2021 at <a href="https://erdavis.com/" target="_blank" rel="noopener noreferrer">https://erdavis.com/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a></p> <p>Link to the article: <a href="https://erdavis.com/2021/06/26/average-colors-of-the-world/" target="_blank" rel="noopener noreferrer">https://erdavis.com/2021/06/26/average-colors-of-the-world/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a></p> <p><em>Sentinel-2 cloudless - <a href="https://s2maps.eu" target="_blank" rel="noopener noreferrer">https://s2maps.eu<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a> by EOX IT Services GmbH (Contains modified Copernicus Sentinel data 2019)</em></p> <hr/> <p>Media coverage and other references:</p> <ul><li><a href="https://mymodernmet.com/erin-davis-maps-average-colors-of-the-world/" target="_blank" rel="noopener noreferrer">https://mymodernmet.com/erin-davis-maps-average-colors-of-the-world/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a></li> <li><a href="https://www.zmescience.com/science/news-science/average-colors-of-world-map-052353/" target="_blank" rel="noopener noreferrer">https://www.zmescience.com/science/news-science/average-colors-of-world-map-052353/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a></li> <li><a href="https://flowingdata.com/2021/06/29/average-color-of-geographic-areas/" target="_blank" rel="noopener noreferrer">https://flowingdata.com/2021/06/29/average-color-of-geographic-areas/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a></li> <li><a href="http://googlemapsmania.blogspot.com/2021/06/the-average-color-of-earth.html" target="_blank" rel="noopener noreferrer">http://googlemapsmania.blogspot.com/2021/06/the-average-color-of-earth.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a></li> <li><a href="https://blog.adafruit.com/2021/07/17/data-scientist-makes-maps-of-the-average-colors-of-the-world/" target="_blank" rel="noopener noreferrer">https://blog.adafruit.com/2021/07/17/data-scientist-makes-maps-of-the-average-colors-of-the-world/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a></li></ul></div></section> </article></div>
  </body>
</html>
