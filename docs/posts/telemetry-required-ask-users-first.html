<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://dev.blog.documentfoundation.org/2023/02/21/telemetry-required-ask-users-first/">Original</a>
    <h1>Telemetry required? Ask users first</h1>
    
    <div id="readability-page-1" class="page"><div>
															<p>In this article, I will discuss the recent problems with compiling LibreOffice using Microsoft Visual Studio, things that I did to debug and find the root cause, the source of problem itself – which is problems in Microsoft’s telemetry – and how I could fix it.</p>
<h3>Describing The Problem</h3>
<p>Recently, I was encountering a problem when configuring LibreOffice’s source code before compilation. Sometimes, random errors appeared without further details on why. The title: “powershell.exe” was also strange, as I wasn’t using PowerShell directly.</p>
<div id="attachment_758"><p><img aria-describedby="caption-attachment-758" decoding="async" src="https://dev.blog.documentfoundation.org/wp-content/uploads/sites/11/2023/02/powershell-error-1024x396.png" alt="Powershell Error" width="960" height="371" srcset="https://dev.blog.documentfoundation.org/wp-content/uploads/sites/11/2023/02/powershell-error-1024x396.png 1024w, https://dev.blog.documentfoundation.org/wp-content/uploads/sites/11/2023/02/powershell-error-300x116.png 300w, https://dev.blog.documentfoundation.org/wp-content/uploads/sites/11/2023/02/powershell-error-768x297.png 768w, https://dev.blog.documentfoundation.org/wp-content/uploads/sites/11/2023/02/powershell-error.png 1285w" sizes="(max-width: 960px) 100vw, 960px"/></p><p id="caption-attachment-758">Powershell Error</p></div>
<p>At first, I ignored the message, but then it become more error common, and at some point the configuration was aborted. I ignored that for a while, but after a few days, one of the mentees reported a somehow similar problem.</p>
<p>The error was that the UCRT (which is Microsoft Visual Studio C++’s standard C library), was not found. This is an error log:</p>

<h3>Checking the Error Logs</h3>
<p>The important log that contains the output of the configuration is the config.log file. In this file, I could see these related lines:</p>

<p>The strange thing was that I could configure that compilation with another Cygwin terminal with slightly different settings. To find the differences, I used the command export to see the values of the environment variables in the two configured terminals, and compare them using diff.</p>
<p>Then, I found that I could evade the problem by setting this environment variable. This was the environment variable from one of the terminals:</p>

<p>Unfortunately, this was not the case for our mentee who has the same problem. I also knew that this approach may lead to performance degradation.</p>
<h3>Looking Further Into the Details</h3>
<p>I tried to look further into the details of configure.ac, and debug to understand the root cause of the problem. At first, I changed the version manually in configure.ac, and the configuration actually worked! If you take a look into find_ucrt() function, the relevant part is:</p>
<pre>PathFormat &#34;$(win_get_env_from_vsdevcmdbat UniversalCRTSdkDir)&#34;
UCRTSDKDIR=$formatted_path
UCRTVERSION=$(win_get_env_from_vsdevcmdbat UCRTVersion)</pre>
<p>Setting the PathFormat and UCRTVERSION to something from a good build fixed the problem: configuration and make went smooth, and finished successfully.</p>
<p>Then, I tried to look into win_get_env_from_vsdevcmdbat() function. As the name implies, it runs the VsDevCmd.bat, and uses the contents of the two environment variables: PathFormat and UCRTVERSION.</p>
<p>This function creates a batch file in the temporary folder, runs it and gets the output, and then removes it. So, removed the removal part, and saved the created batch files.</p>
<p>I was skeptical about the commands that were processing the outputs of the batch files, so I tried to change them a little, but that didn’t help. The nice thing was that each of them were working fine. I ran them several times, but there was no problem! Then I decided to run them exactly one after another, and then I saw that sometimes there was no output.</p>
<h3>Finding the Root Cause</h3>
<p>At the point, I was almost certain that the problem was from the VSDevCMD.bat itself, but I didn’t know why, and how to fix that. So, I took a look into the script, and guess what: the problem was from the telemetry! If the variable VSCMD_SKIP_SENDTELEMETRY is not set, the command line tries to open a PowerShell script, and send data to Microsoft! That was the source of problem. This is the relevant part of the code:</p>
<pre>@REM Send Telemetry if user&#39;s VS is opted-in
if &#34;%VSCMD_SKIP_SENDTELEMETRY%&#34;==&#34;&#34; (
    if &#34;%VSCMD_DEBUG%&#34; NEQ &#34;&#34; (
        @echo [DEBUG:%~nx0] Sending telemetry
        powershell.exe -NoProfile -Command &#34;&amp; {Import-Module &#39;%~dp0\Microsoft.VisualStudio.DevShell.dll&#39;; Send-VsDevShellTelemetry -NewInstanceType Cmd;}&#34;
    ) else (
        START &#34;&#34; /B powershell.exe -NoProfile -Command &#34;&amp; {if($PSVersionTable.PSVersion.Major -ge 3){Import-Module &#39;%~dp0\Microsoft.VisualStudio.DevShell.dll&#39;; Send-VsDevShellTelemetry -NewInstanceType Cmd; }}&#34; &gt; NUL
    )
)
</pre>
<p>To fix that, I used the value 1 for the variable to opt out of telemetry:</p>
<p><span id="output">set VSCMD_SKIP_SENDTELEMETRY=1 </span></p>
<p>This change is now merged into the LibreOffice code:</p>
<ul>
<li><a href="https://gerrit.libreoffice.org/c/core/+/146677">tdf#153476 Disable MS telemetry in VsDevCmd.bat</a></li>
</ul>
<p>So, the problem should be fixed by now.</p>
<h3>Best Practices for Doing Telemetry</h3>
<p>It took a lot of time to debug and find the root cause of the problem. I think the best way to avoid causing problems for the users of the Visual Studio would be asking for the users’ consent before activating the telemetry.</p>
<p>I agree that there are legitimate or justifiable reasons to do telemetry, but getting the users’ consent is very important before sending data back to the corporate servers.</p>
<p>In LibreOffice, we consider users the top priority, and we are bound to the best practice of: “Telemetry required? Ask users first”, and we ask others to do the same.</p>

															 
													</div></div>
  </body>
</html>
