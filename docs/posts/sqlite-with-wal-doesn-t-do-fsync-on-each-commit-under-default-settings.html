<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://avi.im/blag/2025/sqlite-fsync/">Original</a>
    <h1>SQLite (with WAL) doesn&#39;t do `fsync` on each commit under default settings</h1>
    
    <div id="readability-page-1" class="page"><div><article><p>SQLite has a WAL mode (the default is journal mode), but youâ€™re likely using it if you want higher write throughput. SQLite also has a PRAGMA called <code>synchronous</code> which configures how <code>fsync</code> is called. The default is <code>NORMAL</code>. This is what the docs say:</p><blockquote><p>[..] but WAL mode does lose durability. A transaction committed in WAL mode with <code>synchronous=NORMAL</code> might roll back following a power loss or system crash.</p></blockquote><blockquote><p>In WAL mode when synchronous is <code>NORMAL (1)</code>, the WAL file is synchronized before each checkpoint and the database file is synchronized after each completed checkpoint and the WAL file header is synchronized when a WAL file begins to be reused after a checkpoint, but no sync operations occur during most transactions.</p></blockquote><blockquote><p>If durability is not a concern, then synchronous=NORMAL is normally all one needs in WAL mode.</p></blockquote><p>If you want <code>fsync</code> to be called on each commit, use <code>FULL</code>:</p><blockquote><p>With <code>synchronous=FULL</code> in WAL mode, an additional sync operation of the WAL file happens after each transaction commit. The extra WAL sync following each transaction helps ensure that transactions are durable across a power loss. Transactions are consistent with or without the extra syncs provided by <code>synchronous=FULL</code>.</p></blockquote><p><a href="https://www.sqlite.org/pragma.html#pragma_synchronous">https://www.sqlite.org/pragma.html#pragma_synchronous</a></p><h3 id="update"><strong>update</strong>:</h3><p>I was wrong about this one! It seems the default SQLite3 on macOS behaves like this:</p><pre tabindex="0"><code>$ sqlite3 test.db

SQLite version 3.43.2 2023-10-10 13:08:14
Enter &#34;.help&#34; for usage hints.
sqlite&gt; PRAGMA journal_mode=wal;
wal
sqlite&gt; PRAGMA synchronous;
1
sqlite&gt;
</code></pre><p>but a fresh copy from homebrew behaved differently:</p><pre tabindex="0"><code>$ /opt/homebrew/opt/sqlite/bin/sqlite3 test.db

SQLite version 3.50.4 2025-07-30 19:33:53
Enter &#34;.help&#34; for usage hints.
sqlite&gt; PRAGMA journal_mode=wal;
wal
sqlite&gt; PRAGMA synchronous;
2
sqlite&gt;
</code></pre><p>Furthermore, as pointed out by charleslmunger on HN, the compile time options do set it to <code>FULL</code>:</p><blockquote><p><code>SQLITE_DEFAULT_SYNCHRONOUS=&lt;0-3&gt;</code> This macro determines the default value of the PRAGMA synchronous setting. If not overridden at compile-time, the default setting is 2 (FULL).</p></blockquote><blockquote><p><code>SQLITE_DEFAULT_WAL_SYNCHRONOUS=&lt;0-3&gt;</code> This macro determines the default value of the PRAGMA synchronous setting for database files that open in WAL mode. If not overridden at compile-time, this value is the same as <code>SQLITE_DEFAULT_SYNCHRONOUS</code>.</p></blockquote><p><a href="https://sqlite.org/compile.html#default_synchronous">https://sqlite.org/compile.html#default_synchronous</a></p><hr/><p><small>Someone passed me this post <a href="https://blog.cf8.gg/surrealdbs-ch/">SurrealDB is sacrificing data durability to make benchmarks look better</a> and asked me how SQLite works.</small></p></article></div></div>
  </body>
</html>
