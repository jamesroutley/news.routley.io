<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://alexharri.com/blog/ascii-rendering">Original</a>
    <h1>ASCII characters are not pixels: a deep dive into ASCII rendering</h1>
    
    <div id="readability-page-1" class="page"><div><main>
<p>Recently, I’ve been spending my time building an image-to-ASCII renderer. Below is the result — try dragging it around, the demo is interactive!</p>

<p>One thing I spent a lot of effort on is getting edges looking sharp. Take a look at this rotating cube example:</p>

<p>Try opening the “split” view. Notice how well the characters follow the contour of the square.</p>
<p>This renderer works well for animated scenes, like the ones above, but we can also use it to render static images:</p>

<p>The image of Saturn was <a target="_blank" href="https://chatgpt.com/share/69524279-7564-800f-ae22-a2f433794abe">generated with ChatGPT</a>.</p>
<p>Then, to get better separation between different colored regions, I also implemented a <a target="_blank" href="https://en.wikipedia.org/wiki/Cel_shading">cel shading</a>-like effect to enhance contrast between edges. Try dragging the contrast slider below:</p>

<p>The contrast enhancement makes the separation between different colored regions far clearer. That was key to making the 3D scene above look as good as it does.</p>
<p>I put so much focus on sharp edges because they’re an aspect of ASCII rendering that is often overlooked when programmatically rendering images as ASCII. Consider this animated 3D scene from Cognition’s landing page that is rendered via ASCII characters:</p>

<p>Source: <a target="_blank" href="https://cognition.ai/">cognition.ai</a></p>
<p>It’s a cool effect, especially while in motion, but take a look at those blurry edges! The characters follow the cube contours very poorly, and as a result, the edges look blurry and jagged in places:</p>
<div><p><img src="https://blog.veitheller.de/images/posts/ascii-rendering/cube-logo-zoomed-in.png" width="450"/></p></div>
<p>This blurriness happens because the ASCII characters are being treated like pixels — their <em>shape</em> is ignored. It’s disappointing to see because ASCII art looks <em>so much</em> better when shape is utilized. I don’t believe I’ve ever seen shape utilized in generated ASCII art, and I think that’s because it’s not really obvious how to consider shape when building an ASCII renderer.</p>
<p>I started building my ASCII renderer to prove to myself that it’s possible to utilize shape in ASCII rendering. In this post, I’ll cover the techniques and ideas I used to capture shape and build this ASCII renderer in detail.</p>
<p>We’ll start with the basics of image-to-ASCII conversion and see where the common issue of blurry edges comes from. After that, I’ll show you the approach I used to fix that and achieve sharp, high-quality ASCII rendering. At the end, we’ll improve on that by implementing the contrast enhancement effect I showed above.</p>
<p>Let’s get to it!</p>
<h2>Image to ASCII conversion</h2>
<p>ASCII contains <a target="_blank" href="https://www.ascii-code.com/characters/printable-characters">95 printable characters</a> that we can use. Let’s start off by rendering the following image containing a white circle using those ASCII characters:</p>

<p>ASCII art is (almost) always rendered using a <a target="_blank" href="https://en.wikipedia.org/wiki/Monospaced_font">monospace</a> font. Since every character in a monospace font is equally wide and tall, we can split the image into a grid. Each grid cell will contain a single ASCII character.</p>
<p>The image with the circle is <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="9.553ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 4222.4 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-1-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path id="MJX-1-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-1-TEX-N-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="33" xlink:href="#MJX-1-TEX-N-33"></use><use data-c="36" xlink:href="#MJX-1-TEX-N-36" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-1-TEX-N-30" transform="translate(1000,0)"></use></g><g data-mml-node="mo" transform="translate(1722.2,0)"><use data-c="D7" xlink:href="#MJX-1-TEX-N-D7"></use></g><g data-mml-node="mn" transform="translate(2722.4,0)"><use data-c="33" xlink:href="#MJX-1-TEX-N-33"></use><use data-c="36" xlink:href="#MJX-1-TEX-N-36" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-1-TEX-N-30" transform="translate(1000,0)"></use></g></g></g></svg></mjx-container> pixels. For the ASCII grid, I’ll pick a row height of <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.532ex" role="img" focusable="false" viewBox="0 -677 1000 677" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-2-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-2-TEX-N-34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-2-TEX-N-32"></use><use data-c="34" xlink:href="#MJX-2-TEX-N-34" transform="translate(500,0)"></use></g></g></g></svg></mjx-container> pixels and a column width of <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-3-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-3-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-3-TEX-N-32"></use><use data-c="30" xlink:href="#MJX-3-TEX-N-30" transform="translate(500,0)"></use></g></g></g></svg></mjx-container> pixels. That splits the canvas into <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-4-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-4-TEX-N-35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-4-TEX-N-31"></use><use data-c="35" xlink:href="#MJX-4-TEX-N-35" transform="translate(500,0)"></use></g></g></g></svg></mjx-container> rows and <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-5-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-5-TEX-N-38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-5-TEX-N-31"></use><use data-c="38" xlink:href="#MJX-5-TEX-N-38" transform="translate(500,0)"></use></g></g></g></svg></mjx-container> columns — an <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="7.291ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 3222.4 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-6-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-6-TEX-N-38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z"></path><path id="MJX-6-TEX-N-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path><path id="MJX-6-TEX-N-35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-6-TEX-N-31"></use><use data-c="38" xlink:href="#MJX-6-TEX-N-38" transform="translate(500,0)"></use></g><g data-mml-node="mo" transform="translate(1222.2,0)"><use data-c="D7" xlink:href="#MJX-6-TEX-N-D7"></use></g><g data-mml-node="mn" transform="translate(2222.4,0)"><use data-c="31" xlink:href="#MJX-6-TEX-N-31"></use><use data-c="35" xlink:href="#MJX-6-TEX-N-35" transform="translate(500,0)"></use></g></g></g></svg></mjx-container> grid:</p>

<p>Monospace characters are typically taller than they are wide, so I made each grid cell a bit taller than it is wide.</p>
<p>Our task is now to pick which character to place in each cell. The simplest approach is to calculate a lightness value for each cell and pick a character based on that.</p>
<p>We can get a lightness value for each cell by sampling the lightness of the pixel at the cell’s center:</p>

<p>We want each pixel’s lightness as a numeric value between <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-7-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-7-TEX-N-30"></use></g></g></g></svg></mjx-container> and <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 500 666" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-8-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-8-TEX-N-31"></use></g></g></g></svg></mjx-container>, but our image data consists of pixels with <a target="_blank" href="https://en.wikipedia.org/wiki/RGB_color_model">RGB</a> color values.</p>
<p>We can use the following formula to convert an RGB color (with component values between <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-9-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-9-TEX-N-30"></use></g></g></g></svg></mjx-container> and <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="3.394ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-10-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-10-TEX-N-35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-10-TEX-N-32"></use><use data-c="35" xlink:href="#MJX-10-TEX-N-35" transform="translate(500,0)"></use><use data-c="35" xlink:href="#MJX-10-TEX-N-35" transform="translate(1000,0)"></use></g></g></g></svg></mjx-container>) to a lightness value:</p>

<p>See <a target="_blank" href="https://en.wikipedia.org/wiki/Relative_luminance#Relative_luminance_and_%22gamma_encoded%22_colorspaces">relative luminance</a>.</p>
<h3>Mapping lightness values to ASCII characters</h3>
<p>Now that we have a lightness value for each cell, we want to use those values to pick ASCII characters. As mentioned before, ASCII has 95 printable characters, but let’s start simple with just these characters:</p>

<p>We can sort them in approximate density order like so, with lower-density characters to the left, and high-density characters to the right:</p>

<p>We’ll put these characters in a <code><span>CHARS</span></code> array:</p>
<div><div><div><pre><p><span>const</span><span> </span><span>CHARS</span><span> </span><span>=</span><span> </span><span>[</span><span>&#34; &#34;</span><span>,</span><span> </span><span>&#34;.&#34;</span><span>,</span><span> </span><span>&#34;:&#34;</span><span>,</span><span> </span><span>&#34;-&#34;</span><span>,</span><span> </span><span>&#34;=&#34;</span><span>,</span><span> </span><span>&#34;+&#34;</span><span>,</span><span> </span><span>&#34;*&#34;</span><span>,</span><span> </span><span>&#34;#&#34;</span><span>,</span><span> </span><span>&#34;%&#34;</span><span>,</span><span> </span><span>&#34;@&#34;</span><span>]</span><span></span></p></pre></div></div></div>
<p>I added space as the first (least dense) character.</p>
<p>We can then map lightness values between <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-12-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-12-TEX-N-30"></use></g></g></g></svg></mjx-container> and <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 500 666" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-13-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-13-TEX-N-31"></use></g></g></g></svg></mjx-container> to one of those characters like so:</p>
<div><div><div><pre><p><span>function</span><span> </span><span>getCharacterFromLightness</span><span>(</span><span>lightness</span><span>:</span><span> </span><span>number</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>  </span><span>const</span><span> index </span><span>=</span><span> Math</span><span>.</span><span>floor</span><span>(</span><span>lightness </span><span>*</span><span> </span><span>(</span><span>CHARS</span><span>.</span><span>length </span><span>-</span><span> </span><span>1</span><span>)</span><span>)</span><span>;</span><span></span></p><p><span>  </span><span>return</span><span> </span><span>CHARS</span><span>[</span><span>index</span><span>]</span><span>;</span><span></span></p><p><span></span><span>}</span><span></span></p></pre></div></div></div>
<p>This maps low lightness values to low-density characters and high lightness values to high-density characters.</p>
<p>Rendering the circle from above with this method gives us:</p>

<p>That works... but the result is pretty ugly. We seem to always get <code>@</code> for cells that fall within the circle and a space for cells that fall outside.</p>
<p>That is happening because we’ve pretty much just implemented nearest-neighbor downsampling. Let’s see what that means.</p>
<h2>Nearest neighbor downsampling</h2>
<p>Downsampling, in the context of image processing, is taking a larger image (in our case, the <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="9.553ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 4222.4 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-14-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-14-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path id="MJX-14-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-14-TEX-N-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="33" xlink:href="#MJX-14-TEX-N-33"></use><use data-c="36" xlink:href="#MJX-14-TEX-N-36" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-14-TEX-N-30" transform="translate(1000,0)"></use></g><g data-mml-node="mo" transform="translate(1722.2,0)"><use data-c="D7" xlink:href="#MJX-14-TEX-N-D7"></use></g><g data-mml-node="mn" transform="translate(2722.4,0)"><use data-c="33" xlink:href="#MJX-14-TEX-N-33"></use><use data-c="36" xlink:href="#MJX-14-TEX-N-36" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-14-TEX-N-30" transform="translate(1000,0)"></use></g></g></g></svg></mjx-container> image with the circle) and using that image’s data to construct a lower resolution image (in our case, the <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="7.291ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 3222.4 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-15-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-15-TEX-N-38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z"></path><path id="MJX-15-TEX-N-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path><path id="MJX-15-TEX-N-35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-15-TEX-N-31"></use><use data-c="38" xlink:href="#MJX-15-TEX-N-38" transform="translate(500,0)"></use></g><g data-mml-node="mo" transform="translate(1222.2,0)"><use data-c="D7" xlink:href="#MJX-15-TEX-N-D7"></use></g><g data-mml-node="mn" transform="translate(2222.4,0)"><use data-c="31" xlink:href="#MJX-15-TEX-N-31"></use><use data-c="35" xlink:href="#MJX-15-TEX-N-35" transform="translate(500,0)"></use></g></g></g></svg></mjx-container> ASCII grid). The pixel values of the lower resolution image are calculated by sampling values from the higher resolution image.</p>
<p>The simplest and fastest method of sampling is <a target="_blank" href="https://en.wikipedia.org/wiki/Nearest-neighbor_interpolation">nearest-neighbor interpolation</a>, where, for each cell (pixel), we only take a single sample from the higher resolution image.</p>
<p>Consider the circle example again. Using nearest-neighbor interpolation, every sample either falls inside or outside of the shape, resulting in either <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.127ex" xmlns="http://www.w3.org/2000/svg" width="3.016ex" height="1.824ex" role="img" focusable="false" viewBox="0 -750 1333 806" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-16-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-16-TEX-N-25" d="M465 605Q428 605 394 614T340 632T319 641Q332 608 332 548Q332 458 293 403T202 347Q145 347 101 402T56 548Q56 637 101 693T202 750Q241 750 272 719Q359 642 464 642Q580 642 650 732Q662 748 668 749Q670 750 673 750Q682 750 688 743T693 726Q178 -47 170 -52Q166 -56 160 -56Q147 -56 142 -45Q137 -36 142 -27Q143 -24 363 304Q469 462 525 546T581 630Q528 605 465 605ZM207 385Q235 385 263 427T292 548Q292 617 267 664T200 712Q193 712 186 709T167 698T147 668T134 615Q132 595 132 548V527Q132 436 165 403Q183 385 203 385H207ZM500 146Q500 234 544 290T647 347Q699 347 737 292T776 146T737 0T646 -56Q590 -56 545 0T500 146ZM651 -18Q679 -18 707 24T736 146Q736 215 711 262T644 309Q637 309 630 306T611 295T591 265T578 212Q577 200 577 146V124Q577 -18 647 -18H651Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-16-TEX-N-30"></use></g><g data-mml-node="mi" transform="translate(500,0)"><use data-c="25" xlink:href="#MJX-16-TEX-N-25"></use></g></g></g></svg></mjx-container> or <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.127ex" xmlns="http://www.w3.org/2000/svg" width="5.278ex" height="1.824ex" role="img" focusable="false" viewBox="0 -750 2333 806" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-17-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-17-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-17-TEX-N-25" d="M465 605Q428 605 394 614T340 632T319 641Q332 608 332 548Q332 458 293 403T202 347Q145 347 101 402T56 548Q56 637 101 693T202 750Q241 750 272 719Q359 642 464 642Q580 642 650 732Q662 748 668 749Q670 750 673 750Q682 750 688 743T693 726Q178 -47 170 -52Q166 -56 160 -56Q147 -56 142 -45Q137 -36 142 -27Q143 -24 363 304Q469 462 525 546T581 630Q528 605 465 605ZM207 385Q235 385 263 427T292 548Q292 617 267 664T200 712Q193 712 186 709T167 698T147 668T134 615Q132 595 132 548V527Q132 436 165 403Q183 385 203 385H207ZM500 146Q500 234 544 290T647 347Q699 347 737 292T776 146T737 0T646 -56Q590 -56 545 0T500 146ZM651 -18Q679 -18 707 24T736 146Q736 215 711 262T644 309Q637 309 630 306T611 295T591 265T578 212Q577 200 577 146V124Q577 -18 647 -18H651Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-17-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-17-TEX-N-30" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-17-TEX-N-30" transform="translate(1000,0)"></use></g><g data-mml-node="mi" transform="translate(1500,0)"><use data-c="25" xlink:href="#MJX-17-TEX-N-25"></use></g></g></g></svg></mjx-container> lightness:</p>

<p>If, instead of picking an ASCII character for each grid cell, we color each grid cell (pixel) according to the sampled value, we get the following pixelated rendering:</p>

<p>This pixelated rendering is pretty much equivalent to the ASCII rendering from before. The only difference is that instead of <code>@</code>s we have white pixels, and instead of spaces we have black pixels.</p>
<p>These square, jagged looking edges are aliasing artifacts, commonly called <a target="_blank" href="https://en.wikipedia.org/wiki/Jaggies">jaggies</a>. They’re a common result of using nearest-neighbor interpolation.</p>
<h3>Supersampling</h3>
<p>To get rid of jaggies, we can collect more samples for each cell. Consider this line:</p>

<p>The line’s slope on the <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.464ex" xmlns="http://www.w3.org/2000/svg" width="1.109ex" height="1.464ex" role="img" focusable="false" viewBox="0 -442 490 647" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-18-TEX-I-1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D466" xlink:href="#MJX-18-TEX-I-1D466"></use></g></g></g></svg></mjx-container> axis is <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-1.602ex" xmlns="http://www.w3.org/2000/svg" width="3.421ex" height="4.638ex" role="img" focusable="false" viewBox="0 -1342 1512 2050" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-19-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-19-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-19-TEX-I-1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mstyle"><g data-mml-node="mfrac"><g data-mml-node="mn" transform="translate(220,676)"><use data-c="31" xlink:href="#MJX-19-TEX-N-31"></use></g><g data-mml-node="mn" transform="translate(220,-686)"><use data-c="33" xlink:href="#MJX-19-TEX-N-33"></use></g><rect width="700" height="60" x="120" y="220"></rect></g></g><g data-mml-node="mi" transform="translate(940,0)"><use data-c="1D465" xlink:href="#MJX-19-TEX-I-1D465"></use></g></g></g></svg></mjx-container>. When we pixelate it with nearest-neighbor interpolation, we get the following:</p>

<p>Let’s try to get rid of the jagginess by taking multiple samples within each cell and using the average sampled lightness value as the cell’s lightness. The example below lets you vary the number of samples using the slider:</p>

<p>With multiple samples, cells that lie on the edge of a shape will have some of their samples fall within the shape, and some outside of it. Averaging those, we get gray in-between colors that smooth the downsampled image. Below is the same example, but with an overlay showing where the samples are taken:</p>

<p>This method of collecting multiple samples from the larger image is called <a target="_blank" href="https://en.wikipedia.org/wiki/Supersampling">supersampling</a>. It’s a common method of <a target="_blank" href="https://en.wikipedia.org/wiki/Spatial_anti-aliasing">spatial anti-aliasing</a> (avoiding jaggies at edges). Here’s what the rotating square looks like with supersampling (using <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-20-TEX-N-38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="38" xlink:href="#MJX-20-TEX-N-38"></use></g></g></g></svg></mjx-container> samples for each cell):</p>

<p>Let’s look at what supersampling does for the circle example from earlier. Try dragging the sample quality slider:</p>

<p>The circle becomes less jagged, but the edges feel blurry. Why’s that?</p>
<p>Well, they feel blurry because we’re pretty much just rendering a low-resolution, pixelated image of a circle. Take a look at the pixelated view:</p>

<p>The ASCII and pixelated views are mirror images of each other. Both are just low-resolution versions of the original high-resolution image, scaled up to the original’s size — it’s no wonder they both look blurry.</p>
<hr/>
<p>Increasing the number of samples is insufficient. No matter how many samples we take per cell, the samples will be averaged into a single lightness value, used to render a single pixel.</p>
<p>And that’s the core problem: treating each grid cell as a pixel in an image. It’s an obvious and simple method, but it disregards that ASCII characters have shape.</p>
<p>We can make our ASCII renderings far more crisp by picking characters based on their shape. Here’s the circle rendered that way:</p>

<p>The characters follow the contour of the circle very well. By picking characters based on shape, we get a far higher <em>effective</em> resolution. The result is also more visually interesting.</p>
<p>Let’s see how we can implement this.</p>
<h2>Shape</h2>
<p>So what do I mean by shape? Well, consider the characters <code>T</code>, <code>L</code>, and <code>O</code> placed within grid cells:</p>

<p>The character <code>T</code> is top-heavy. Its visual density in the upper half of the grid cell is higher than in the lower half. The opposite can be said for <code>L</code> — it’s bottom-heavy. <code>O</code> is pretty much equally dense in the upper and lower halves of the cell.</p>
<p>We might also compare characters like <code>L</code> and <code>J</code>. The character <code>L</code> is heavier within the left half of the cell, while <code>J</code> is heavier in the right half:</p>

<p>We also have more “extreme” characters, such as <code>_</code> and <code>^</code>, that only occupy the lower or upper portion of the cell, respectively:</p>

<p>This is, roughly, what I mean by “shape” in the context of ASCII rendering. Shape refers to which regions of a cell a given character visually occupies.</p>
<h3>Quantifying shape</h3>
<p>To pick characters based on their shape, we’ll somehow need to quantify (put numbers to) the shape of each character.</p>
<p>Let’s start by only considering how much characters occupy the upper and lower regions of our cell. To do that, we’ll define two “sampling circles” for each grid cell — one placed in the upper half and one in the lower half:</p>

<p>It may seem odd or arbitrary to use circles instead of just splitting the cell into two rectangles, but using circles will give us more flexibility later on.</p>
<p>A character placed within a cell will overlap each of the cell’s sampling circles to <em>some</em> extent.</p>

<p>One can compute that overlap by taking a bunch of samples within the circle (for example, at every pixel). The fraction of samples that land inside the character gives us the overlap as a numeric value between <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-21-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-21-TEX-N-30"></use></g></g></g></svg></mjx-container> and <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 500 666" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-22-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-22-TEX-N-31"></use></g></g></g></svg></mjx-container>:</p>


<p>For T, we get an overlap of approximately <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="5.154ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 2278 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-24-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-24-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-24-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-24-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path id="MJX-24-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-24-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-24-TEX-N-2E" transform="translate(500,0)"></use><use data-c="32" xlink:href="#MJX-24-TEX-N-32" transform="translate(778,0)"></use><use data-c="36" xlink:href="#MJX-24-TEX-N-36" transform="translate(1278,0)"></use><use data-c="31" xlink:href="#MJX-24-TEX-N-31" transform="translate(1778,0)"></use></g></g></g></svg></mjx-container> for the upper circle and <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="5.154ex" height="1.579ex" role="img" focusable="false" viewBox="0 -676 2278 698" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-25-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-25-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-25-TEX-N-39" d="M352 287Q304 211 232 211Q154 211 104 270T44 396Q42 412 42 436V444Q42 537 111 606Q171 666 243 666Q245 666 249 666T257 665H261Q273 665 286 663T323 651T370 619T413 560Q456 472 456 334Q456 194 396 97Q361 41 312 10T208 -22Q147 -22 108 7T68 93T121 149Q143 149 158 135T173 96Q173 78 164 65T148 49T135 44L131 43Q131 41 138 37T164 27T206 22H212Q272 22 313 86Q352 142 352 280V287ZM244 248Q292 248 321 297T351 430Q351 508 343 542Q341 552 337 562T323 588T293 615T246 625Q208 625 181 598Q160 576 154 546T147 441Q147 358 152 329T172 282Q197 248 244 248Z"></path><path id="MJX-25-TEX-N-37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-25-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-25-TEX-N-2E" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-25-TEX-N-30" transform="translate(778,0)"></use><use data-c="39" xlink:href="#MJX-25-TEX-N-39" transform="translate(1278,0)"></use><use data-c="37" xlink:href="#MJX-25-TEX-N-37" transform="translate(1778,0)"></use></g></g></g></svg></mjx-container> for the lower. Those overlap values form a <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 500 666" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-26-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-26-TEX-N-32"></use></g></g></g></svg></mjx-container>-dimensional vector:</p>

<p>We can generate such a <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 500 666" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-28-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-28-TEX-N-32"></use></g></g></g></svg></mjx-container>-dimensional vector for each character within the ASCII alphabet. These vectors quantify the shape of each ASCII character along these <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 500 666" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-29-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-29-TEX-N-32"></use></g></g></g></svg></mjx-container> dimensions (upper and lower). I’ll call these vectors <em>shape vectors</em>.</p>
<p>Below are some ASCII characters and their shape vectors. I’m coloring the sampling circles using the component values of the shape vectors:</p>

<p>We can use the shape vectors as 2D coordinates — here’s every ASCII character on a 2D plot:</p>
<p><svg viewBox="-0.041760000000000005 0 0.47676 0.47676" preserveAspectRatio="xMidYMid meet"><defs><marker id="arrowhead" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto" viewBox="0 0 8 8"><path d="M0,0 L4,4 L0,8" stroke="#399ef4" stroke-width="1.5" fill="none"></path></marker></defs><g><line x1="0" y1="0" x2="0" y2="0.435"></line><line x1="0" y1="0.435" x2="0.435" y2="0.435"></line><line x1="0.05" y1="0" x2="0.05" y2="0.435"></line><line x1="0" y1="0.385" x2="0.435" y2="0.385"></line><line x1="0.1" y1="0" x2="0.1" y2="0.435"></line><line x1="0" y1="0.33499999999999996" x2="0.435" y2="0.33499999999999996"></line><line x1="0.15000000000000002" y1="0" x2="0.15000000000000002" y2="0.435"></line><line x1="0" y1="0.285" x2="0.435" y2="0.285"></line><line x1="0.2" y1="0" x2="0.2" y2="0.435"></line><line x1="0" y1="0.235" x2="0.435" y2="0.235"></line><line x1="0.25" y1="0" x2="0.25" y2="0.435"></line><line x1="0" y1="0.185" x2="0.435" y2="0.185"></line><line x1="0.30000000000000004" y1="0" x2="0.30000000000000004" y2="0.435"></line><line x1="0" y1="0.13499999999999995" x2="0.435" y2="0.13499999999999995"></line><line x1="0.35000000000000003" y1="0" x2="0.35000000000000003" y2="0.435"></line><line x1="0" y1="0.08499999999999996" x2="0.435" y2="0.08499999999999996"></line><line x1="0.4" y1="0" x2="0.4" y2="0.435"></line><line x1="0" y1="0.034999999999999976" x2="0.435" y2="0.034999999999999976"></line></g><g><text x="0" y="0.439176" dy="1.2em" font-size="0.010440000000000001">0</text><text x="-0.017748000000000003" y="0.435" dy="0.3em" text-anchor="end" font-size="0.010440000000000001">0</text><text x="0.05" y="0.439176" dy="1.2em" font-size="0.010440000000000001">0.05</text><text x="-0.017748000000000003" y="0.385" dy="0.3em" text-anchor="end" font-size="0.010440000000000001">0.05</text><text x="0.1" y="0.439176" dy="1.2em" font-size="0.010440000000000001">0.1</text><text x="-0.017748000000000003" y="0.33499999999999996" dy="0.3em" text-anchor="end" font-size="0.010440000000000001">0.1</text><text x="0.15000000000000002" y="0.439176" dy="1.2em" font-size="0.010440000000000001">0.15</text><text x="-0.017748000000000003" y="0.285" dy="0.3em" text-anchor="end" font-size="0.010440000000000001">0.15</text><text x="0.2" y="0.439176" dy="1.2em" font-size="0.010440000000000001">0.2</text><text x="-0.017748000000000003" y="0.235" dy="0.3em" text-anchor="end" font-size="0.010440000000000001">0.2</text><text x="0.25" y="0.439176" dy="1.2em" font-size="0.010440000000000001">0.25</text><text x="-0.017748000000000003" y="0.185" dy="0.3em" text-anchor="end" font-size="0.010440000000000001">0.25</text><text x="0.30000000000000004" y="0.439176" dy="1.2em" font-size="0.010440000000000001">0.3</text><text x="-0.017748000000000003" y="0.13499999999999995" dy="0.3em" text-anchor="end" font-size="0.010440000000000001">0.3</text><text x="0.35000000000000003" y="0.439176" dy="1.2em" font-size="0.010440000000000001">0.35</text><text x="-0.017748000000000003" y="0.08499999999999996" dy="0.3em" text-anchor="end" font-size="0.010440000000000001">0.35</text><text x="0.4" y="0.439176" dy="1.2em" font-size="0.010440000000000001">0.4</text><text x="-0.017748000000000003" y="0.034999999999999976" dy="0.3em" text-anchor="end" font-size="0.010440000000000001">0.4</text></g><text x="0.2175" y="0.470496" text-anchor="middle" font-size="0.011442240000000003">Upper</text><text x="-0.039672000000000006" y="0.2175" text-anchor="middle" dominant-baseline="middle" font-size="0.011442240000000003" transform="rotate(-90, -0.039672000000000006, 0.2175)">Lower</text><rect x="0" y="0" width="0.435" height="0.435"></rect><g><circle cx="0" cy="0.435" r="0.001525632"></circle><circle cx="0.11821758803855989" cy="0.36039838677946096" r="0.001525632"></circle><circle cx="0.1773952390320677" cy="0.435" r="0.001525632"></circle><circle cx="0.25848908125122966" cy="0.21852678864187822" r="0.001525632"></circle><circle cx="0.3255098694996394" cy="0.1731926683716965" r="0.001525632"></circle><circle cx="0.28755328218243836" cy="0.20379139615712508" r="0.001525632"></circle><circle cx="0.21459112072922823" cy="0.2507911994229129" r="0.001525632"></circle><circle cx="0.0885697422781822" cy="0.435" r="0.001525632"></circle><circle cx="0.122224408157912" cy="0.31297232605416747" r="0.001525632"></circle><circle cx="0.06432552954292085" cy="0.3624181913568103" r="0.001525632"></circle><circle cx="0" cy="0.2881969309462915" r="0.001525632"></circle><circle cx="0" cy="0.3419578333005443" r="0.001525632"></circle><circle cx="0.14572758869434063" cy="0.3142248672044068" r="0.001525632"></circle><circle cx="0.18889107482457868" cy="0.26723162174568804" r="0.001525632"></circle><circle cx="0.1893829103547775" cy="0.2670939077972325" r="0.001525632"></circle><circle cx="0.1364941963407436" cy="0.31925470522657223" r="0.001525632"></circle><circle cx="0.15455439700964002" cy="0.3025060659715392" r="0.001525632"></circle><circle cx="0.15566266640435444" cy="0.30124040920716116" r="0.001525632"></circle><circle cx="0.07777559184208799" cy="0.35706702078824837" r="0.001525632"></circle><circle cx="0.07777559184208799" cy="0.28718047085054754" r="0.001525632"></circle><circle cx="0.10804642927405075" cy="0.3261994229129779" r="0.001525632"></circle><circle cx="0.09930487245065252" cy="0.3319571775198374" r="0.001525632"></circle><circle cx="0.10855138041838808" cy="0.3248091678142829" r="0.001525632"></circle><circle cx="0.2037445078365794" cy="0.35984753098563843" r="0.001525632"></circle><circle cx="0.24616040396091562" cy="0.14953210046560428" r="0.001525632"></circle><circle cx="0.14530133123483513" cy="0.3136018755328218" r="0.001525632"></circle><circle cx="0.19216342055216742" cy="0.435" r="0.001525632"></circle><circle cx="0.05790543642206046" cy="0.435" r="0.001525632"></circle><circle cx="0.1776313200865631" cy="0.28479342907731653" r="0.001525632"></circle><circle cx="0.17881828316610926" cy="0.28443930749557345" r="0.001525632"></circle><circle cx="0.027641156797167023" cy="0.4038963210702341" r="0.001525632"></circle><circle cx="0.006675847596563709" cy="0.42262541806020065" r="0.001525632"></circle><circle cx="0" cy="0.298932061118762" r="0.001525632"></circle><circle cx="0.2652698537609022" cy="0.21760869565217386" r="0.001525632"></circle><circle cx="0.16862745098039206" cy="0.2583523509738346" r="0.001525632"></circle><circle cx="0.18839268148731061" cy="0.24143320873499924" r="0.001525632"></circle><circle cx="0.1989114040264935" cy="0.2720057052921503" r="0.001525632"></circle><circle cx="0.12333923535969571" cy="0.26068693029051104" r="0.001525632"></circle><circle cx="0.22670339038625487" cy="0.2819407830021641" r="0.001525632"></circle><circle cx="0.20956784051413202" cy="0.2563391042035543" r="0.001525632"></circle><circle cx="0.19799986884385862" cy="0.33628533018558593" r="0.001525632"></circle><circle cx="0.27226703390386253" cy="0.23941996196471899" r="0.001525632"></circle><circle cx="0.2280411830283954" cy="0.29418420880057705" r="0.001525632"></circle><circle cx="0.19589481277460816" cy="0.20369302905108527" r="0.001525632"></circle><circle cx="0.29015017378188757" cy="0.22776018099547518" r="0.001525632"></circle><circle cx="0.1701488622204735" cy="0.2751141058430061" r="0.001525632"></circle><circle cx="0.2349662272935932" cy="0.23597711325332815" r="0.001525632"></circle><circle cx="0.22486064659977736" cy="0.2638871401403372" r="0.001525632"></circle><circle cx="0.2204406846350583" cy="0.3462663125450849" r="0.001525632"></circle><circle cx="0.17966424027805114" cy="0.23707882484097315" r="0.001525632"></circle><circle cx="0.24468489737031945" cy="0.27933733359564544" r="0.001525632"></circle><circle cx="0.20061643386451578" cy="0.2530864318971735" r="0.001525632"></circle><circle cx="0.15756443045445592" cy="0.27827496885041636" r="0.001525632"></circle><circle cx="0.23382516886353202" cy="0.23113089382910354" r="0.001525632"></circle><circle cx="0.10785625286904064" cy="0.25520460358056274" r="0.001525632"></circle><circle cx="0.3290248540887927" cy="0.2380231490589548" r="0.001525632"></circle><circle cx="0.27671978490392823" cy="0.20783756311889318" r="0.001525632"></circle><circle cx="0.21219096334185844" cy="0.2547258836645026" r="0.001525632"></circle><circle cx="0.24623909764574722" cy="0.32359597350645947" r="0.001525632"></circle><circle cx="0.21066299429470783" cy="0.18520657092268344" r="0.001525632"></circle><circle cx="0.27609023542527383" cy="0.2406462718866811" r="0.001525632"></circle><circle cx="0.24087481146304673" cy="0.25970325923011345" r="0.001525632"></circle><circle cx="0.2383369401272215" cy="0.3359836710603974" r="0.001525632"></circle><circle cx="0.18660240015738727" cy="0.24563020525936127" r="0.001525632"></circle><circle cx="0.2149780313463178" cy="0.2786684372745754" r="0.001525632"></circle><circle cx="0.2771132533280871" cy="0.16859564561610602" r="0.001525632"></circle><circle cx="0.22646730933175951" cy="0.23246868647124402" r="0.001525632"></circle><circle cx="0.2390123942553611" cy="0.33364253393665155" r="0.001525632"></circle><circle cx="0.21674863925503313" cy="0.22838973047412964" r="0.001525632"></circle><circle cx="0.11309594071742411" cy="0.18910190832185725" r="0.001525632"></circle><circle cx="0.2116269919338973" cy="0.22998983539904252" r="0.001525632"></circle><circle cx="0.11532559512099155" cy="0.2847540822349006" r="0.001525632"></circle><circle cx="0.20904321594858669" cy="0.22939307495573485" r="0.001525632"></circle><circle cx="0.11894550462325396" cy="0.23684930159354708" r="0.001525632"></circle><circle cx="0.2533608761230244" cy="0.3412692635582661" r="0.001525632"></circle><circle cx="0.15601023017902813" cy="0.06340186241720747" r="0.001525632"></circle><circle cx="0.2105187225391829" cy="0.27655026559118634" r="0.001525632"></circle><circle cx="0.14461276149255692" cy="0.26013607449668846" r="0.001525632"></circle><circle cx="0.15413469735720384" cy="0.2478729752770673" r="0.001525632"></circle><circle cx="0.1931405338054954" cy="0.2340622335890878" r="0.001525632"></circle><circle cx="0.16915863335300677" cy="0.30026985376090237" r="0.001525632"></circle><circle cx="0.1696570266902748" cy="0.22629123221194838" r="0.001525632"></circle><circle cx="0.1410977769034035" cy="0.27655026559118634" r="0.001525632"></circle><circle cx="0.12373926159092398" cy="0.2493091350252475" r="0.001525632"></circle><circle cx="0.14038953373991736" cy="0.16158534985900724" r="0.001525632"></circle><circle cx="0.13718932389009109" cy="0.15843104465866636" r="0.001525632"></circle><circle cx="0.16752573939274704" cy="0.29740409207161134" r="0.001525632"></circle><circle cx="0.11361400747590003" cy="0.22793724178634653" r="0.001525632"></circle><circle cx="0.1711522067020787" cy="0.29528592038822216" r="0.001525632"></circle><circle cx="0.09076004983933374" cy="0.2272224408157912" r="0.001525632"></circle><circle cx="0.09908190701029577" cy="0.2779601941110893" r="0.001525632"></circle><circle cx="0.09757361138435307" cy="0.17291068266771598" r="0.001525632"></circle><circle cx="0.12972653944520954" cy="0.23848219555380687" r="0.001525632"></circle><circle cx="0.09931798806479115" cy="0.19530559380943008" r="0.001525632"></circle><circle cx="0.1428487113909108" cy="0.24596465341989657" r="0.001525632"></circle></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.18262822055216743" y="0.41020848" width="0.019070399999999998" height="0.019070399999999998" rx="0.0023837999999999997"></rect><text x="0.19216342055216742" y="0.41974368" text-anchor="middle" dominant-baseline="middle" font-size="0.015892">^</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.23662520396091563" y="0.1247405804656043" width="0.019070399999999998" height="0.019070399999999998" rx="0.0023837999999999997"></rect><text x="0.24616040396091562" y="0.1342757804656043" text-anchor="middle" dominant-baseline="middle" font-size="0.015892">@</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.1276541238900911" y="0.13363952465866638" width="0.019070399999999998" height="0.019070399999999998" rx="0.0023837999999999997"></rect><text x="0.13718932389009109" y="0.14317472465866637" text-anchor="middle" dominant-baseline="middle" font-size="0.015892">q</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.22880174012722151" y="0.3111921510603974" width="0.019070399999999998" height="0.019070399999999998" rx="0.0023837999999999997"></rect><text x="0.2383369401272215" y="0.3207273510603974" text-anchor="middle" dominant-baseline="middle" font-size="0.015892">T</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.31948965408879265" y="0.21323162905895482" width="0.019070399999999998" height="0.019070399999999998" rx="0.0023837999999999997"></rect><text x="0.3290248540887927" y="0.2227668290589548" text-anchor="middle" dominant-baseline="middle" font-size="0.015892">M</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.08122484983933374" y="0.20243092081579123" width="0.019070399999999998" height="0.019070399999999998" rx="0.0023837999999999997"></rect><text x="0.09076004983933374" y="0.21196612081579122" text-anchor="middle" dominant-baseline="middle" font-size="0.015892">u</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.21693210933175952" y="0.20767716647124404" width="0.019070399999999998" height="0.019070399999999998" rx="0.0023837999999999997"></rect><text x="0.22646730933175951" y="0.21721236647124403" text-anchor="middle" dominant-baseline="middle" font-size="0.015892">X</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.31597466949963937" y="0.14840114837169652" width="0.019070399999999998" height="0.019070399999999998" rx="0.0023837999999999997"></rect><text x="0.3255098694996394" y="0.1579363483716965" text-anchor="middle" dominant-baseline="middle" font-size="0.015892">$</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.14647503017902813" y="0.03861034241720746" width="0.019070399999999998" height="0.019070399999999998" rx="0.0023837999999999997"></rect><text x="0.15601023017902813" y="0.04814554241720746" text-anchor="middle" dominant-baseline="middle" font-size="0.015892">g</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.08976967245065252" y="0.3071656575198374" width="0.019070399999999998" height="0.019070399999999998" rx="0.0023837999999999997"></rect><text x="0.09930487245065252" y="0.3167008575198374" text-anchor="middle" dominant-baseline="middle" font-size="0.015892">=</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.16061366222047352" y="0.2503225858430061" width="0.019070399999999998" height="0.019070399999999998" rx="0.0023837999999999997"></rect><text x="0.1701488622204735" y="0.2598577858430061" text-anchor="middle" dominant-baseline="middle" font-size="0.015892">C</text></g></svg></p>
<h3>Shape-based lookup</h3>
<p>Let’s say that we have our ASCII characters and their associated shape vectors in a <code><span>CHARACTERS</span></code> array:</p>
<div><div><div><pre><p><span>const</span><span> </span><span>CHARACTERS</span><span>:</span><span> </span><span>Array</span><span>&lt;</span><span>{</span><span></span></p><p><span>  character</span><span>:</span><span> </span><span>string</span><span>,</span><span></span></p><p><span>  shapeVector</span><span>:</span><span> </span><span>number</span><span>[</span><span>]</span><span>,</span><span></span></p><p><span></span><span>}</span><span>&gt;</span><span> </span><span>=</span><span> </span><span>[</span><span>...</span><span>]</span><span>;</span><span></span></p></pre></div></div></div>
<p>We can then perform a nearest neighbor search like so:</p>
<div><div><div><pre><p><span>function</span><span> </span><span>findBestCharacter</span><span>(</span><span>inputVector</span><span>:</span><span> </span><span>number</span><span>[</span><span>]</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>  </span><span>let</span><span> bestCharacter </span><span>=</span><span> </span><span>&#34;&#34;</span><span>;</span><span></span></p><p><span>  </span><span>let</span><span> bestDistance </span><span>=</span><span> </span><span>Infinity</span><span>;</span><span></span></p><p><span>  </span><span>for</span><span> </span><span>(</span><span>const</span><span> </span><span>{</span><span> character</span><span>,</span><span> shapeVector </span><span>}</span><span> </span><span>of</span><span> </span><span>CHARACTERS</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>    </span><span>const</span><span> dist </span><span>=</span><span> </span><span>getDistance</span><span>(</span><span>shapeVector</span><span>,</span><span> inputVector</span><span>)</span><span>;</span><span></span></p><p><span>    </span><span>if</span><span> </span><span>(</span><span>dist </span><span>&lt;</span><span> bestDistance</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>      bestDistance </span><span>=</span><span> dist</span><span>;</span><span></span></p><p><span>      bestCharacter </span><span>=</span><span> character</span><span>;</span><span></span></p><p><span>    </span><span>}</span><span></span></p><p><span>  </span><span>}</span><span></span></p><p><span>  </span><span>return</span><span> bestCharacter</span><span>;</span><span></span></p><p><span></span><span>}</span><span></span></p></pre></div></div></div>
<p>The <code><span>findBestCharacter</span></code> function gives us the ASCII character whose shape best matches the input lookup vector.</p>
<p>Note: this brute force search is not very performant. This becomes a bottleneck when we start rendering thousands of ASCII characters at <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-30-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path id="MJX-30-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="36" xlink:href="#MJX-30-TEX-N-36"></use><use data-c="30" xlink:href="#MJX-30-TEX-N-30" transform="translate(500,0)"></use></g></g></g></svg></mjx-container> <abbr title="Frames per second">FPS</abbr>. I’ll talk more about this later.</p>
<p>To make use of this in our ASCII renderer, we’ll calculate a lookup vector for each cell in the ASCII grid and pass it to <code><span>findBestCharacter</span></code> to determine the character to display.</p>
<p>Let’s try it out. Consider the following zoomed-in circle as an example. It is split into three grid cells:</p>

<p>Overlaying our sampling circles, we see varying degrees of overlap:</p>

<p>When calculating the shape vector of each ASCII character, we took a huge number of samples. We could afford to do that because we only need to calculate those shape vectors once up front. After they’re calculated, we can use them again and again.</p>
<p>However, if we’re converting an animated image (e.g. canvas or video) to ASCII, we need to be mindful of performance when calculating the lookup vectors. An ASCII rendering might have hundreds or thousands of cells. Multiplying that by tens or hundreds of samples would be incredibly costly in terms of performance.</p>
<p>With that being said, let’s pick a sampling quality of <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.554ex" role="img" focusable="false" viewBox="0 -665 500 687" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-31-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="33" xlink:href="#MJX-31-TEX-N-33"></use></g></g></g></svg></mjx-container> with the samples placed like so:</p>

<p>For the top sampling circle of the leftmost cell, we get one white sample and two black, giving us an average lightness of <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="4.023ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1778 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-32-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-32-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-32-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-32-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-32-TEX-N-2E" transform="translate(500,0)"></use><use data-c="33" xlink:href="#MJX-32-TEX-N-33" transform="translate(778,0)"></use><use data-c="33" xlink:href="#MJX-32-TEX-N-33" transform="translate(1278,0)"></use></g></g></g></svg></mjx-container>. Doing the same calculation for all of the sampling circles, we get the following 2D vectors:</p>

<p>From now on, instead of using the term “lookup vectors”, I’ll call these vectors, sampled from the image that we’re rendering as ASCII, <em>sampling vectors</em>. One sampling vector is calculated for each cell in the grid.</p>
<p>Anyway, we can use these sampling vectors to find the best-matching ASCII character. Let’s see what that looks like on our 2D plot — I’ll label the sampling vectors (from left to right) C0, C1, and C2:</p>
<p><svg viewBox="-0.096 0 1.096 1.096" preserveAspectRatio="xMidYMid meet"><defs><marker id="arrowhead" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto" viewBox="0 0 8 8"><path d="M0,0 L4,4 L0,8" stroke="#399ef4" stroke-width="1.5" fill="none"></path></marker></defs><g><line x1="0" y1="0" x2="0" y2="1"></line><line x1="0" y1="1" x2="1" y2="1"></line><line x1="0.1" y1="0" x2="0.1" y2="1"></line><line x1="0" y1="0.9" x2="1" y2="0.9"></line><line x1="0.2" y1="0" x2="0.2" y2="1"></line><line x1="0" y1="0.8" x2="1" y2="0.8"></line><line x1="0.30000000000000004" y1="0" x2="0.30000000000000004" y2="1"></line><line x1="0" y1="0.7" x2="1" y2="0.7"></line><line x1="0.4" y1="0" x2="0.4" y2="1"></line><line x1="0" y1="0.6" x2="1" y2="0.6"></line><line x1="0.5" y1="0" x2="0.5" y2="1"></line><line x1="0" y1="0.5" x2="1" y2="0.5"></line><line x1="0.6000000000000001" y1="0" x2="0.6000000000000001" y2="1"></line><line x1="0" y1="0.3999999999999999" x2="1" y2="0.3999999999999999"></line><line x1="0.7000000000000001" y1="0" x2="0.7000000000000001" y2="1"></line><line x1="0" y1="0.29999999999999993" x2="1" y2="0.29999999999999993"></line><line x1="0.8" y1="0" x2="0.8" y2="1"></line><line x1="0" y1="0.19999999999999996" x2="1" y2="0.19999999999999996"></line><line x1="0.9" y1="0" x2="0.9" y2="1"></line><line x1="0" y1="0.09999999999999998" x2="1" y2="0.09999999999999998"></line><line x1="1" y1="0" x2="1" y2="1"></line><line x1="0" y1="0" x2="1" y2="0"></line></g><g><text x="0" y="1.0096" dy="1.2em" font-size="0.024">0</text><text x="-0.0408" y="1" dy="0.3em" text-anchor="end" font-size="0.024">0</text><text x="0.1" y="1.0096" dy="1.2em" font-size="0.024">0.1</text><text x="-0.0408" y="0.9" dy="0.3em" text-anchor="end" font-size="0.024">0.1</text><text x="0.2" y="1.0096" dy="1.2em" font-size="0.024">0.2</text><text x="-0.0408" y="0.8" dy="0.3em" text-anchor="end" font-size="0.024">0.2</text><text x="0.30000000000000004" y="1.0096" dy="1.2em" font-size="0.024">0.3</text><text x="-0.0408" y="0.7" dy="0.3em" text-anchor="end" font-size="0.024">0.3</text><text x="0.4" y="1.0096" dy="1.2em" font-size="0.024">0.4</text><text x="-0.0408" y="0.6" dy="0.3em" text-anchor="end" font-size="0.024">0.4</text><text x="0.5" y="1.0096" dy="1.2em" font-size="0.024">0.5</text><text x="-0.0408" y="0.5" dy="0.3em" text-anchor="end" font-size="0.024">0.5</text><text x="0.6000000000000001" y="1.0096" dy="1.2em" font-size="0.024">0.6</text><text x="-0.0408" y="0.3999999999999999" dy="0.3em" text-anchor="end" font-size="0.024">0.6</text><text x="0.7000000000000001" y="1.0096" dy="1.2em" font-size="0.024">0.7</text><text x="-0.0408" y="0.29999999999999993" dy="0.3em" text-anchor="end" font-size="0.024">0.7</text><text x="0.8" y="1.0096" dy="1.2em" font-size="0.024">0.8</text><text x="-0.0408" y="0.19999999999999996" dy="0.3em" text-anchor="end" font-size="0.024">0.8</text><text x="0.9" y="1.0096" dy="1.2em" font-size="0.024">0.9</text><text x="-0.0408" y="0.09999999999999998" dy="0.3em" text-anchor="end" font-size="0.024">0.9</text><text x="1" y="1.0096" dy="1.2em" font-size="0.024">1</text><text x="-0.0408" y="0" dy="0.3em" text-anchor="end" font-size="0.024">1</text></g><text x="0.5" y="1.0816" text-anchor="middle" font-size="0.026304000000000004">Upper</text><text x="-0.0912" y="0.5" text-anchor="middle" dominant-baseline="middle" font-size="0.026304000000000004" transform="rotate(-90, -0.0912, 0.5)">Lower</text><rect x="0" y="0" width="1" height="1"></rect><g><circle cx="0" cy="1" r="0.0035072000000000007"></circle><circle cx="0.11821758803855989" cy="0.925398386779461" r="0.0035072000000000007"></circle><circle cx="0.1773952390320677" cy="1" r="0.0035072000000000007"></circle><circle cx="0.25848908125122966" cy="0.7835267886418782" r="0.0035072000000000007"></circle><circle cx="0.3255098694996394" cy="0.7381926683716965" r="0.0035072000000000007"></circle><circle cx="0.28755328218243836" cy="0.7687913961571251" r="0.0035072000000000007"></circle><circle cx="0.21459112072922823" cy="0.8157911994229129" r="0.0035072000000000007"></circle><circle cx="0.0885697422781822" cy="1" r="0.0035072000000000007"></circle><circle cx="0.122224408157912" cy="0.8779723260541675" r="0.0035072000000000007"></circle><circle cx="0.06432552954292085" cy="0.9274181913568103" r="0.0035072000000000007"></circle><circle cx="0" cy="0.8531969309462915" r="0.0035072000000000007"></circle><circle cx="0" cy="0.9069578333005444" r="0.0035072000000000007"></circle><circle cx="0.14572758869434063" cy="0.8792248672044068" r="0.0035072000000000007"></circle><circle cx="0.18889107482457868" cy="0.8322316217456881" r="0.0035072000000000007"></circle><circle cx="0.1893829103547775" cy="0.8320939077972325" r="0.0035072000000000007"></circle><circle cx="0.1364941963407436" cy="0.8842547052265722" r="0.0035072000000000007"></circle><circle cx="0.15455439700964002" cy="0.8675060659715391" r="0.0035072000000000007"></circle><circle cx="0.15566266640435444" cy="0.8662404092071612" r="0.0035072000000000007"></circle><circle cx="0.07777559184208799" cy="0.9220670207882484" r="0.0035072000000000007"></circle><circle cx="0.07777559184208799" cy="0.8521804708505476" r="0.0035072000000000007"></circle><circle cx="0.10804642927405075" cy="0.8911994229129778" r="0.0035072000000000007"></circle><circle cx="0.09930487245065252" cy="0.8969571775198374" r="0.0035072000000000007"></circle><circle cx="0.10855138041838808" cy="0.8898091678142829" r="0.0035072000000000007"></circle><circle cx="0.2037445078365794" cy="0.9248475309856384" r="0.0035072000000000007"></circle><circle cx="0.24616040396091562" cy="0.7145321004656042" r="0.0035072000000000007"></circle><circle cx="0.14530133123483513" cy="0.8786018755328219" r="0.0035072000000000007"></circle><circle cx="0.19216342055216742" cy="1" r="0.0035072000000000007"></circle><circle cx="0.05790543642206046" cy="1" r="0.0035072000000000007"></circle><circle cx="0.1776313200865631" cy="0.8497934290773165" r="0.0035072000000000007"></circle><circle cx="0.17881828316610926" cy="0.8494393074955735" r="0.0035072000000000007"></circle><circle cx="0.027641156797167023" cy="0.9688963210702342" r="0.0035072000000000007"></circle><circle cx="0.006675847596563709" cy="0.9876254180602007" r="0.0035072000000000007"></circle><circle cx="0" cy="0.863932061118762" r="0.0035072000000000007"></circle><circle cx="0.2652698537609022" cy="0.7826086956521738" r="0.0035072000000000007"></circle><circle cx="0.16862745098039206" cy="0.8233523509738346" r="0.0035072000000000007"></circle><circle cx="0.18839268148731061" cy="0.8064332087349992" r="0.0035072000000000007"></circle><circle cx="0.1989114040264935" cy="0.8370057052921503" r="0.0035072000000000007"></circle><circle cx="0.12333923535969571" cy="0.825686930290511" r="0.0035072000000000007"></circle><circle cx="0.22670339038625487" cy="0.846940783002164" r="0.0035072000000000007"></circle><circle cx="0.20956784051413202" cy="0.8213391042035544" r="0.0035072000000000007"></circle><circle cx="0.19799986884385862" cy="0.9012853301855859" r="0.0035072000000000007"></circle><circle cx="0.27226703390386253" cy="0.804419961964719" r="0.0035072000000000007"></circle><circle cx="0.2280411830283954" cy="0.859184208800577" r="0.0035072000000000007"></circle><circle cx="0.19589481277460816" cy="0.7686930290510853" r="0.0035072000000000007"></circle><circle cx="0.29015017378188757" cy="0.7927601809954752" r="0.0035072000000000007"></circle><circle cx="0.1701488622204735" cy="0.8401141058430062" r="0.0035072000000000007"></circle><circle cx="0.2349662272935932" cy="0.8009771132533281" r="0.0035072000000000007"></circle><circle cx="0.22486064659977736" cy="0.8288871401403373" r="0.0035072000000000007"></circle><circle cx="0.2204406846350583" cy="0.9112663125450849" r="0.0035072000000000007"></circle><circle cx="0.17966424027805114" cy="0.8020788248409731" r="0.0035072000000000007"></circle><circle cx="0.24468489737031945" cy="0.8443373335956454" r="0.0035072000000000007"></circle><circle cx="0.20061643386451578" cy="0.8180864318971734" r="0.0035072000000000007"></circle><circle cx="0.15756443045445592" cy="0.8432749688504164" r="0.0035072000000000007"></circle><circle cx="0.23382516886353202" cy="0.7961308938291035" r="0.0035072000000000007"></circle><circle cx="0.10785625286904064" cy="0.8202046035805628" r="0.0035072000000000007"></circle><circle cx="0.3290248540887927" cy="0.8030231490589548" r="0.0035072000000000007"></circle><circle cx="0.27671978490392823" cy="0.7728375631188932" r="0.0035072000000000007"></circle><circle cx="0.21219096334185844" cy="0.8197258836645026" r="0.0035072000000000007"></circle><circle cx="0.24623909764574722" cy="0.8885959735064595" r="0.0035072000000000007"></circle><circle cx="0.21066299429470783" cy="0.7502065709226835" r="0.0035072000000000007"></circle><circle cx="0.27609023542527383" cy="0.8056462718866811" r="0.0035072000000000007"></circle><circle cx="0.24087481146304673" cy="0.8247032592301135" r="0.0035072000000000007"></circle><circle cx="0.2383369401272215" cy="0.9009836710603973" r="0.0035072000000000007"></circle><circle cx="0.18660240015738727" cy="0.8106302052593612" r="0.0035072000000000007"></circle><circle cx="0.2149780313463178" cy="0.8436684372745754" r="0.0035072000000000007"></circle><circle cx="0.2771132533280871" cy="0.733595645616106" r="0.0035072000000000007"></circle><circle cx="0.22646730933175951" cy="0.797468686471244" r="0.0035072000000000007"></circle><circle cx="0.2390123942553611" cy="0.8986425339366515" r="0.0035072000000000007"></circle><circle cx="0.21674863925503313" cy="0.7933897304741296" r="0.0035072000000000007"></circle><circle cx="0.11309594071742411" cy="0.7541019083218572" r="0.0035072000000000007"></circle><circle cx="0.2116269919338973" cy="0.7949898353990426" r="0.0035072000000000007"></circle><circle cx="0.11532559512099155" cy="0.8497540822349007" r="0.0035072000000000007"></circle><circle cx="0.20904321594858669" cy="0.7943930749557349" r="0.0035072000000000007"></circle><circle cx="0.11894550462325396" cy="0.8018493015935471" r="0.0035072000000000007"></circle><circle cx="0.2533608761230244" cy="0.9062692635582661" r="0.0035072000000000007"></circle><circle cx="0.15601023017902813" cy="0.6284018624172074" r="0.0035072000000000007"></circle><circle cx="0.2105187225391829" cy="0.8415502655911863" r="0.0035072000000000007"></circle><circle cx="0.14461276149255692" cy="0.8251360744966885" r="0.0035072000000000007"></circle><circle cx="0.15413469735720384" cy="0.8128729752770674" r="0.0035072000000000007"></circle><circle cx="0.1931405338054954" cy="0.7990622335890878" r="0.0035072000000000007"></circle><circle cx="0.16915863335300677" cy="0.8652698537609024" r="0.0035072000000000007"></circle><circle cx="0.1696570266902748" cy="0.7912912322119484" r="0.0035072000000000007"></circle><circle cx="0.1410977769034035" cy="0.8415502655911863" r="0.0035072000000000007"></circle><circle cx="0.12373926159092398" cy="0.8143091350252475" r="0.0035072000000000007"></circle><circle cx="0.14038953373991736" cy="0.7265853498590072" r="0.0035072000000000007"></circle><circle cx="0.13718932389009109" cy="0.7234310446586664" r="0.0035072000000000007"></circle><circle cx="0.16752573939274704" cy="0.8624040920716114" r="0.0035072000000000007"></circle><circle cx="0.11361400747590003" cy="0.7929372417863465" r="0.0035072000000000007"></circle><circle cx="0.1711522067020787" cy="0.8602859203882222" r="0.0035072000000000007"></circle><circle cx="0.09076004983933374" cy="0.7922224408157912" r="0.0035072000000000007"></circle><circle cx="0.09908190701029577" cy="0.8429601941110892" r="0.0035072000000000007"></circle><circle cx="0.09757361138435307" cy="0.737910682667716" r="0.0035072000000000007"></circle><circle cx="0.12972653944520954" cy="0.8034821955538068" r="0.0035072000000000007"></circle><circle cx="0.09931798806479115" cy="0.7603055938094301" r="0.0035072000000000007"></circle><circle cx="0.1428487113909108" cy="0.8109646534198965" r="0.0035072000000000007"></circle></g><g><line x1="0.33" y1="1" x2="0.26261100017213196" y2="0.9175822965816084" marker-end="url(#arrowhead)"></line><circle cx="0.33" cy="1" r="0.004384000000000001"></circle><text x="0.33" y="0.9766186666666666" text-anchor="middle" dominant-baseline="auto" font-size="0.023381333333333337">C0</text></g><g><line x1="1" y1="0.6699999999999999" x2="0.3400490838358168" y2="0.7367227168086151" marker-end="url(#arrowhead)"></line><circle cx="1" cy="0.6699999999999999" r="0.004384000000000001"></circle><text x="1" y="0.6466186666666666" text-anchor="end" dominant-baseline="auto" font-size="0.023381333333333337">C1</text></g><g><line x1="1" y1="0.33999999999999997" x2="0.33809389561120473" y2="0.7307635501242493" marker-end="url(#arrowhead)"></line><circle cx="1" cy="0.33999999999999997" r="0.004384000000000001"></circle><text x="1" y="0.3166186666666666" text-anchor="end" dominant-baseline="auto" font-size="0.023381333333333337">C2</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.22431909764574723" y="0.8316039735064594" width="0.04384" height="0.04384" rx="0.00548"></rect><text x="0.24623909764574722" y="0.8535239735064595" text-anchor="middle" dominant-baseline="middle" font-size="0.036533333333333334">P</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.3035898694996394" y="0.6812006683716965" width="0.04384" height="0.04384" rx="0.00548"></rect><text x="0.3255098694996394" y="0.7031206683716965" text-anchor="middle" dominant-baseline="middle" font-size="0.036533333333333334">$</text></g></svg></p>
<p>Hmm... this is not what we want. Since none of the ASCII shape vector components exceed <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.891ex" height="1.581ex" role="img" focusable="false" viewBox="0 -677 1278 699" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-34-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-34-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-34-TEX-N-34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-34-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-34-TEX-N-2E" transform="translate(500,0)"></use><use data-c="34" xlink:href="#MJX-34-TEX-N-34" transform="translate(778,0)"></use></g></g></g></svg></mjx-container>, they’re all clustered towards the bottom-left region of our plot. This makes our sampling vectors map to a few characters on the edge of the cluster.</p>
<p>We can fix this by <em>normalizing</em> the shape vectors. We’ll do that by taking the maximum value of each component across all shape vectors, and dividing the components of each shape vector by the maximum. Expressed in code, that looks like so:</p>
<div><div><div><pre><p><span>const</span><span> max </span><span>=</span><span> </span><span>[</span><span>0</span><span>,</span><span> </span><span>0</span><span>]</span><span></span></p><p><span></span><span>for</span><span> </span><span>(</span><span>const</span><span> vector </span><span>of</span><span> characterVectors</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>  </span><span>for</span><span> </span><span>(</span><span>const</span><span> </span><span>[</span><span>i</span><span>,</span><span> value</span><span>]</span><span> </span><span>of</span><span> Object</span><span>.</span><span>entries</span><span>(</span><span>vector</span><span>)</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>    </span><span>if</span><span> </span><span>(</span><span>value </span><span>&gt;</span><span> max</span><span>[</span><span>i</span><span>]</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>      max</span><span>[</span><span>i</span><span>]</span><span> </span><span>=</span><span> value</span><span>;</span><span></span></p><p><span>    </span><span>}</span><span></span></p><p><span>  </span><span>}</span><span></span></p><p><span></span><span>}</span><span></span></p><p><span></span><span>const</span><span> normalizedCharacterVectors </span><span>=</span><span> characterVectors</span><span>.</span><span>map</span><span>(</span><span></span></p><p><span>  vector </span><span>=&gt;</span><span> vector</span><span>.</span><span>map</span><span>(</span><span>(</span><span>value</span><span>,</span><span> i</span><span>)</span><span> </span><span>=&gt;</span><span> value </span><span>/</span><span> max</span><span>[</span><span>i</span><span>]</span><span>)</span><span></span></p><p><span></span><span>)</span><span></span></p></pre></div></div></div>
<p>Here’s what the plot looks like with the shape vectors normalized:</p>
<p><svg viewBox="-0.096 0 1.096 1.096" preserveAspectRatio="xMidYMid meet"><defs><marker id="arrowhead" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto" viewBox="0 0 8 8"><path d="M0,0 L4,4 L0,8" stroke="#399ef4" stroke-width="1.5" fill="none"></path></marker></defs><g><line x1="0" y1="0" x2="0" y2="1"></line><line x1="0" y1="1" x2="1" y2="1"></line><line x1="0.1" y1="0" x2="0.1" y2="1"></line><line x1="0" y1="0.9" x2="1" y2="0.9"></line><line x1="0.2" y1="0" x2="0.2" y2="1"></line><line x1="0" y1="0.8" x2="1" y2="0.8"></line><line x1="0.30000000000000004" y1="0" x2="0.30000000000000004" y2="1"></line><line x1="0" y1="0.7" x2="1" y2="0.7"></line><line x1="0.4" y1="0" x2="0.4" y2="1"></line><line x1="0" y1="0.6" x2="1" y2="0.6"></line><line x1="0.5" y1="0" x2="0.5" y2="1"></line><line x1="0" y1="0.5" x2="1" y2="0.5"></line><line x1="0.6000000000000001" y1="0" x2="0.6000000000000001" y2="1"></line><line x1="0" y1="0.3999999999999999" x2="1" y2="0.3999999999999999"></line><line x1="0.7000000000000001" y1="0" x2="0.7000000000000001" y2="1"></line><line x1="0" y1="0.29999999999999993" x2="1" y2="0.29999999999999993"></line><line x1="0.8" y1="0" x2="0.8" y2="1"></line><line x1="0" y1="0.19999999999999996" x2="1" y2="0.19999999999999996"></line><line x1="0.9" y1="0" x2="0.9" y2="1"></line><line x1="0" y1="0.09999999999999998" x2="1" y2="0.09999999999999998"></line><line x1="1" y1="0" x2="1" y2="1"></line><line x1="0" y1="0" x2="1" y2="0"></line></g><g><text x="0" y="1.0096" dy="1.2em" font-size="0.024">0</text><text x="-0.0408" y="1" dy="0.3em" text-anchor="end" font-size="0.024">0</text><text x="0.1" y="1.0096" dy="1.2em" font-size="0.024">0.1</text><text x="-0.0408" y="0.9" dy="0.3em" text-anchor="end" font-size="0.024">0.1</text><text x="0.2" y="1.0096" dy="1.2em" font-size="0.024">0.2</text><text x="-0.0408" y="0.8" dy="0.3em" text-anchor="end" font-size="0.024">0.2</text><text x="0.30000000000000004" y="1.0096" dy="1.2em" font-size="0.024">0.3</text><text x="-0.0408" y="0.7" dy="0.3em" text-anchor="end" font-size="0.024">0.3</text><text x="0.4" y="1.0096" dy="1.2em" font-size="0.024">0.4</text><text x="-0.0408" y="0.6" dy="0.3em" text-anchor="end" font-size="0.024">0.4</text><text x="0.5" y="1.0096" dy="1.2em" font-size="0.024">0.5</text><text x="-0.0408" y="0.5" dy="0.3em" text-anchor="end" font-size="0.024">0.5</text><text x="0.6000000000000001" y="1.0096" dy="1.2em" font-size="0.024">0.6</text><text x="-0.0408" y="0.3999999999999999" dy="0.3em" text-anchor="end" font-size="0.024">0.6</text><text x="0.7000000000000001" y="1.0096" dy="1.2em" font-size="0.024">0.7</text><text x="-0.0408" y="0.29999999999999993" dy="0.3em" text-anchor="end" font-size="0.024">0.7</text><text x="0.8" y="1.0096" dy="1.2em" font-size="0.024">0.8</text><text x="-0.0408" y="0.19999999999999996" dy="0.3em" text-anchor="end" font-size="0.024">0.8</text><text x="0.9" y="1.0096" dy="1.2em" font-size="0.024">0.9</text><text x="-0.0408" y="0.09999999999999998" dy="0.3em" text-anchor="end" font-size="0.024">0.9</text><text x="1" y="1.0096" dy="1.2em" font-size="0.024">1</text><text x="-0.0408" y="0" dy="0.3em" text-anchor="end" font-size="0.024">1</text></g><text x="0.5" y="1.0816" text-anchor="middle" font-size="0.026304000000000004">Upper</text><text x="-0.0912" y="0.5" text-anchor="middle" dominant-baseline="middle" font-size="0.026304000000000004" transform="rotate(-90, -0.0912, 0.5)">Lower</text><rect x="0" y="0" width="1" height="1"></rect><g><circle cx="0" cy="1" r="0.0035072000000000007"></circle><circle cx="0.35929683295796544" cy="0.7992411541515928" r="0.0035072000000000007"></circle><circle cx="0.5391545253423157" cy="1" r="0.0035072000000000007"></circle><circle cx="0.7856217487493277" cy="0.41745345451336857" r="0.0035072000000000007"></circle><circle cx="0.9893169633069583" cy="0.29545574869849156" r="0.0035072000000000007"></circle><circle cx="0.8739561118529893" cy="0.37779934703961926" r="0.0035072000000000007"></circle><circle cx="0.6522033763179402" cy="0.5042795376334599" r="0.0035072000000000007"></circle><circle cx="0.26918860741833267" cy="1" r="0.0035072000000000007"></circle><circle cx="0.3714746975464892" cy="0.671613870996206" r="0.0035072000000000007"></circle><circle cx="0.1955035576903913" cy="0.8046766081355335" r="0.0035072000000000007"></circle><circle cx="0" cy="0.6049413218035824" r="0.0035072000000000007"></circle><circle cx="0" cy="0.749616165181329" r="0.0035072000000000007"></circle><circle cx="0.4429075399119049" cy="0.6749845583693639" r="0.0035072000000000007"></circle><circle cx="0.574093636019373" cy="0.5485220153533925" r="0.0035072000000000007"></circle><circle cx="0.5755884639148551" cy="0.5481514162181241" r="0.0035072000000000007"></circle><circle cx="0.41484463755406287" cy="0.688520250595606" r="0.0035072000000000007"></circle><circle cx="0.46973471787614873" cy="0.643448336715786" r="0.0035072000000000007"></circle><circle cx="0.473103063400634" cy="0.6400423541868882" r="0.0035072000000000007"></circle><circle cx="0.2363821178721623" cy="0.7902761845936646" r="0.0035072000000000007"></circle><circle cx="0.2363821178721623" cy="0.6022059472337424" r="0.0035072000000000007"></circle><circle cx="0.32838379207940527" cy="0.7072090355598695" r="0.0035072000000000007"></circle><circle cx="0.3018157176170451" cy="0.7227036089296746" r="0.0035072000000000007"></circle><circle cx="0.3299184820520997" cy="0.7034677490514428" r="0.0035072000000000007"></circle><circle cx="0.6192374384629182" cy="0.7977587576105181" r="0.0035072000000000007"></circle><circle cx="0.748151396169255" cy="0.23178328774375756" r="0.0035072000000000007"></circle><circle cx="0.4416120224024876" cy="0.67330803847172" r="0.0035072000000000007"></circle><circle cx="0.5840392242839777" cy="1" r="0.0035072000000000007"></circle><circle cx="0.17599107089470434" cy="1" r="0.0035072000000000007"></circle><circle cx="0.539872042732147" cy="0.595782228889085" r="0.0035072000000000007"></circle><circle cx="0.5434795607199092" cy="0.5948292596841085" r="0.0035072000000000007"></circle><circle cx="0.0840093277260678" cy="0.9162975381628872" r="0.0035072000000000007"></circle><circle cx="0.020289797301337377" cy="0.9666990205594282" r="0.0035072000000000007"></circle><circle cx="0" cy="0.6338304067766705" r="0.0035072000000000007"></circle><circle cx="0.806230442668367" cy="0.41498279361157697" r="0.0035072000000000007"></circle><circle cx="0.5125067267255294" cy="0.5246271949174985" r="0.0035072000000000007"></circle><circle cx="0.5725788770852849" cy="0.47909644401306006" r="0.0035072000000000007"></circle><circle cx="0.6045482630099853" cy="0.5613694520427075" r="0.0035072000000000007"></circle><circle cx="0.37486297410958086" cy="0.530909732639196" r="0.0035072000000000007"></circle><circle cx="0.6890160046240011" cy="0.5881055325156624" r="0.0035072000000000007"></circle><circle cx="0.6369362007454208" cy="0.5192093885114272" r="0.0035072000000000007"></circle><circle cx="0.6017778486436929" cy="0.7343510103238332" r="0.0035072000000000007"></circle><circle cx="0.8274968608614195" cy="0.4736786376069887" r="0.0035072000000000007"></circle><circle cx="0.6930819364997114" cy="0.6210535603988354" r="0.0035072000000000007"></circle><circle cx="0.5953799852510314" cy="0.37753463337157" r="0.0035072000000000007"></circle><circle cx="0.8818488031411325" cy="0.4423012441542403" r="0.0035072000000000007"></circle><circle cx="0.5171307276822197" cy="0.5697344039530577" r="0.0035072000000000007"></circle><circle cx="0.714129113268093" cy="0.4644136592252718" r="0.0035072000000000007"></circle><circle cx="0.6834153827755975" cy="0.5395217506397254" r="0.0035072000000000007"></circle><circle cx="0.669981862754869" cy="0.7612106238418778" r="0.0035072000000000007"></circle><circle cx="0.546050664700138" cy="0.46737845230742103" r="0.0035072000000000007"></circle><circle cx="0.7436669124828098" cy="0.5810994441012969" r="0.0035072000000000007"></circle><circle cx="0.6097303330476553" cy="0.510456189887938" r="0.0035072000000000007"></circle><circle cx="0.4788830645964958" cy="0.5782405364863674" r="0.0035072000000000007"></circle><circle cx="0.7106611125505751" cy="0.4513720991793879" r="0.0035072000000000007"></circle><circle cx="0.32780579195981924" cy="0.5161563575399282" r="0.0035072000000000007"></circle><circle cx="1" cy="0.46991970352069246" r="0.0035072000000000007"></circle><circle cx="0.8410300360751803" cy="0.3886879025853709" r="0.0035072000000000007"></circle><circle cx="0.6449086161879894" cy="0.5148680843554225" r="0.0035072000000000007"></circle><circle cx="0.7483905686325314" cy="0.7002029471455046" r="0.0035072000000000007"></circle><circle cx="0.6402646841926933" cy="0.3277861113562167" r="0.0035072000000000007"></circle><circle cx="0.8391166563689636" cy="0.47697873466866714" r="0.0035072000000000007"></circle><circle cx="0.7320869790524784" cy="0.528262595958705" r="0.0035072000000000007"></circle><circle cx="0.7243736671117934" cy="0.7335392217418161" r="0.0035072000000000007"></circle><circle cx="0.5671377035457316" cy="0.4903908938498194" r="0.0035072000000000007"></circle><circle cx="0.6533793075957189" cy="0.5792993911585638" r="0.0035072000000000007"></circle><circle cx="0.8422258983915654" cy="0.28308479661166563" r="0.0035072000000000007"></circle><circle cx="0.68829848723417" cy="0.45497220506485514" r="0.0035072000000000007"></circle><circle cx="0.726426564088255" cy="0.7272390364422483" r="0.0035072000000000007"></circle><circle cx="0.6587606880194528" cy="0.44399541162975464" r="0.0035072000000000007"></circle><circle cx="0.34373069180635013" cy="0.3382687726109598" r="0.0035072000000000007"></circle><circle cx="0.6431945468678374" cy="0.44830142063001877" r="0.0035072000000000007"></circle><circle cx="0.3505072449325335" cy="0.5956763434218656" r="0.0035072000000000007"></circle><circle cx="0.6353417176569068" cy="0.44669549104385475" r="0.0035072000000000007"></circle><circle cx="0.3615091782432782" cy="0.4667607870819732" r="0.0035072000000000007"></circle><circle cx="0.7700356765591053" cy="0.7477631695049856" r="0.0035072000000000007"></circle><circle cx="0.4741594084467742" cy="0" r="0.0035072000000000007"></circle><circle cx="0.6398262013433521" cy="0.573599223506574" r="0.0035072000000000007"></circle><circle cx="0.43951926334881325" cy="0.5294273360981212" r="0.0035072000000000007"></circle><circle cx="0.46845913140533785" cy="0.4964263654813379" r="0.0035072000000000007"></circle><circle cx="0.5870089490363342" cy="0.4592605664872499" r="0.0035072000000000007"></circle><circle cx="0.5141211408526499" cy="0.6374305126621373" r="0.0035072000000000007"></circle><circle cx="0.5156358997867381" cy="0.4383481867113743" r="0.0035072000000000007"></circle><circle cx="0.4288362266557711" cy="0.573599223506574" r="0.0035072000000000007"></circle><circle cx="0.3760787674645726" cy="0.5002911850348541" r="0.0035072000000000007"></circle><circle cx="0.4266836744862775" cy="0.2642195358687027" r="0.0035072000000000007"></circle><circle cx="0.41695732764634347" cy="0.2557310509132632" r="0.0035072000000000007"></circle><circle cx="0.5091583122396508" cy="0.629718521132975" r="0.0035072000000000007"></circle><circle cx="0.3453052438562573" cy="0.44277772875672816" r="0.0035072000000000007"></circle><circle cx="0.5201801765890017" cy="0.6240183534809849" r="0.0035072000000000007"></circle><circle cx="0.2758455743128775" cy="0.44085414276890533" r="0.0035072000000000007"></circle><circle cx="0.30113806230442675" cy="0.5773934527486105" r="0.0035072000000000007"></circle><circle cx="0.2965539234249497" cy="0.29469690285008443" r="0.0035072000000000007"></circle><circle cx="0.39427580571223575" cy="0.47115503397158787" r="0.0035072000000000007"></circle><circle cx="0.30185557969425797" cy="0.3549633812759201" r="0.0035072000000000007"></circle><circle cx="0.4341578139636854" cy="0.4912909203211867" r="0.0035072000000000007"></circle></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.5621192242839776" y="0.943008" width="0.04384" height="0.04384" rx="0.00548"></rect><text x="0.5840392242839777" y="0.964928" text-anchor="middle" dominant-baseline="middle" font-size="0.036533333333333334">^</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.7262313961692549" y="0.17479128774375757" width="0.04384" height="0.04384" rx="0.00548"></rect><text x="0.748151396169255" y="0.19671128774375757" text-anchor="middle" dominant-baseline="middle" font-size="0.036533333333333334">@</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.3950373276463435" y="0.19873905091326322" width="0.04384" height="0.04384" rx="0.00548"></rect><text x="0.41695732764634347" y="0.2206590509132632" text-anchor="middle" dominant-baseline="middle" font-size="0.036533333333333334">q</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.7024536671117934" y="0.676547221741816" width="0.04384" height="0.04384" rx="0.00548"></rect><text x="0.7243736671117934" y="0.6984672217418161" text-anchor="middle" dominant-baseline="middle" font-size="0.036533333333333334">T</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.97808" y="0.41292770352069247" width="0.04384" height="0.04384" rx="0.00548"></rect><text x="1" y="0.43484770352069246" text-anchor="middle" dominant-baseline="middle" font-size="0.036533333333333334">M</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.2539255743128775" y="0.38386214276890535" width="0.04384" height="0.04384" rx="0.00548"></rect><text x="0.2758455743128775" y="0.40578214276890534" text-anchor="middle" dominant-baseline="middle" font-size="0.036533333333333334">u</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.6663784872341699" y="0.39798020506485515" width="0.04384" height="0.04384" rx="0.00548"></rect><text x="0.68829848723417" y="0.41990020506485515" text-anchor="middle" dominant-baseline="middle" font-size="0.036533333333333334">X</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.9673969633069582" y="0.23846374869849157" width="0.04384" height="0.04384" rx="0.00548"></rect><text x="0.9893169633069583" y="0.26038374869849157" text-anchor="middle" dominant-baseline="middle" font-size="0.036533333333333334">$</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.4522394084467742" y="-0.056992" width="0.04384" height="0.04384" rx="0.00548"></rect><text x="0.4741594084467742" y="-0.035072000000000006" text-anchor="middle" dominant-baseline="middle" font-size="0.036533333333333334">g</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.2798957176170451" y="0.6657116089296745" width="0.04384" height="0.04384" rx="0.00548"></rect><text x="0.3018157176170451" y="0.6876316089296746" text-anchor="middle" dominant-baseline="middle" font-size="0.036533333333333334">=</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.4952107276822197" y="0.5127424039530577" width="0.04384" height="0.04384" rx="0.00548"></rect><text x="0.5171307276822197" y="0.5346624039530578" text-anchor="middle" dominant-baseline="middle" font-size="0.036533333333333334">C</text></g></svg></p>
<p>If we now map the sampling vectors to their nearest neighbors, we get a much more sensible result:</p>
<p><svg viewBox="-0.096 0 1.096 1.096" preserveAspectRatio="xMidYMid meet"><defs><marker id="arrowhead" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto" viewBox="0 0 8 8"><path d="M0,0 L4,4 L0,8" stroke="#399ef4" stroke-width="1.5" fill="none"></path></marker></defs><g><line x1="0" y1="0" x2="0" y2="1"></line><line x1="0" y1="1" x2="1" y2="1"></line><line x1="0.1" y1="0" x2="0.1" y2="1"></line><line x1="0" y1="0.9" x2="1" y2="0.9"></line><line x1="0.2" y1="0" x2="0.2" y2="1"></line><line x1="0" y1="0.8" x2="1" y2="0.8"></line><line x1="0.30000000000000004" y1="0" x2="0.30000000000000004" y2="1"></line><line x1="0" y1="0.7" x2="1" y2="0.7"></line><line x1="0.4" y1="0" x2="0.4" y2="1"></line><line x1="0" y1="0.6" x2="1" y2="0.6"></line><line x1="0.5" y1="0" x2="0.5" y2="1"></line><line x1="0" y1="0.5" x2="1" y2="0.5"></line><line x1="0.6000000000000001" y1="0" x2="0.6000000000000001" y2="1"></line><line x1="0" y1="0.3999999999999999" x2="1" y2="0.3999999999999999"></line><line x1="0.7000000000000001" y1="0" x2="0.7000000000000001" y2="1"></line><line x1="0" y1="0.29999999999999993" x2="1" y2="0.29999999999999993"></line><line x1="0.8" y1="0" x2="0.8" y2="1"></line><line x1="0" y1="0.19999999999999996" x2="1" y2="0.19999999999999996"></line><line x1="0.9" y1="0" x2="0.9" y2="1"></line><line x1="0" y1="0.09999999999999998" x2="1" y2="0.09999999999999998"></line><line x1="1" y1="0" x2="1" y2="1"></line><line x1="0" y1="0" x2="1" y2="0"></line></g><g><text x="0" y="1.0096" dy="1.2em" font-size="0.024">0</text><text x="-0.0408" y="1" dy="0.3em" text-anchor="end" font-size="0.024">0</text><text x="0.1" y="1.0096" dy="1.2em" font-size="0.024">0.1</text><text x="-0.0408" y="0.9" dy="0.3em" text-anchor="end" font-size="0.024">0.1</text><text x="0.2" y="1.0096" dy="1.2em" font-size="0.024">0.2</text><text x="-0.0408" y="0.8" dy="0.3em" text-anchor="end" font-size="0.024">0.2</text><text x="0.30000000000000004" y="1.0096" dy="1.2em" font-size="0.024">0.3</text><text x="-0.0408" y="0.7" dy="0.3em" text-anchor="end" font-size="0.024">0.3</text><text x="0.4" y="1.0096" dy="1.2em" font-size="0.024">0.4</text><text x="-0.0408" y="0.6" dy="0.3em" text-anchor="end" font-size="0.024">0.4</text><text x="0.5" y="1.0096" dy="1.2em" font-size="0.024">0.5</text><text x="-0.0408" y="0.5" dy="0.3em" text-anchor="end" font-size="0.024">0.5</text><text x="0.6000000000000001" y="1.0096" dy="1.2em" font-size="0.024">0.6</text><text x="-0.0408" y="0.3999999999999999" dy="0.3em" text-anchor="end" font-size="0.024">0.6</text><text x="0.7000000000000001" y="1.0096" dy="1.2em" font-size="0.024">0.7</text><text x="-0.0408" y="0.29999999999999993" dy="0.3em" text-anchor="end" font-size="0.024">0.7</text><text x="0.8" y="1.0096" dy="1.2em" font-size="0.024">0.8</text><text x="-0.0408" y="0.19999999999999996" dy="0.3em" text-anchor="end" font-size="0.024">0.8</text><text x="0.9" y="1.0096" dy="1.2em" font-size="0.024">0.9</text><text x="-0.0408" y="0.09999999999999998" dy="0.3em" text-anchor="end" font-size="0.024">0.9</text><text x="1" y="1.0096" dy="1.2em" font-size="0.024">1</text><text x="-0.0408" y="0" dy="0.3em" text-anchor="end" font-size="0.024">1</text></g><text x="0.5" y="1.0816" text-anchor="middle" font-size="0.026304000000000004">Upper</text><text x="-0.0912" y="0.5" text-anchor="middle" dominant-baseline="middle" font-size="0.026304000000000004" transform="rotate(-90, -0.0912, 0.5)">Lower</text><rect x="0" y="0" width="1" height="1"></rect><g><circle cx="0" cy="1" r="0.0035072000000000007"></circle><circle cx="0.35929683295796544" cy="0.7992411541515928" r="0.0035072000000000007"></circle><circle cx="0.5391545253423157" cy="1" r="0.0035072000000000007"></circle><circle cx="0.7856217487493277" cy="0.41745345451336857" r="0.0035072000000000007"></circle><circle cx="0.9893169633069583" cy="0.29545574869849156" r="0.0035072000000000007"></circle><circle cx="0.8739561118529893" cy="0.37779934703961926" r="0.0035072000000000007"></circle><circle cx="0.6522033763179402" cy="0.5042795376334599" r="0.0035072000000000007"></circle><circle cx="0.26918860741833267" cy="1" r="0.0035072000000000007"></circle><circle cx="0.3714746975464892" cy="0.671613870996206" r="0.0035072000000000007"></circle><circle cx="0.1955035576903913" cy="0.8046766081355335" r="0.0035072000000000007"></circle><circle cx="0" cy="0.6049413218035824" r="0.0035072000000000007"></circle><circle cx="0" cy="0.749616165181329" r="0.0035072000000000007"></circle><circle cx="0.4429075399119049" cy="0.6749845583693639" r="0.0035072000000000007"></circle><circle cx="0.574093636019373" cy="0.5485220153533925" r="0.0035072000000000007"></circle><circle cx="0.5755884639148551" cy="0.5481514162181241" r="0.0035072000000000007"></circle><circle cx="0.41484463755406287" cy="0.688520250595606" r="0.0035072000000000007"></circle><circle cx="0.46973471787614873" cy="0.643448336715786" r="0.0035072000000000007"></circle><circle cx="0.473103063400634" cy="0.6400423541868882" r="0.0035072000000000007"></circle><circle cx="0.2363821178721623" cy="0.7902761845936646" r="0.0035072000000000007"></circle><circle cx="0.2363821178721623" cy="0.6022059472337424" r="0.0035072000000000007"></circle><circle cx="0.32838379207940527" cy="0.7072090355598695" r="0.0035072000000000007"></circle><circle cx="0.3018157176170451" cy="0.7227036089296746" r="0.0035072000000000007"></circle><circle cx="0.3299184820520997" cy="0.7034677490514428" r="0.0035072000000000007"></circle><circle cx="0.6192374384629182" cy="0.7977587576105181" r="0.0035072000000000007"></circle><circle cx="0.748151396169255" cy="0.23178328774375756" r="0.0035072000000000007"></circle><circle cx="0.4416120224024876" cy="0.67330803847172" r="0.0035072000000000007"></circle><circle cx="0.5840392242839777" cy="1" r="0.0035072000000000007"></circle><circle cx="0.17599107089470434" cy="1" r="0.0035072000000000007"></circle><circle cx="0.539872042732147" cy="0.595782228889085" r="0.0035072000000000007"></circle><circle cx="0.5434795607199092" cy="0.5948292596841085" r="0.0035072000000000007"></circle><circle cx="0.0840093277260678" cy="0.9162975381628872" r="0.0035072000000000007"></circle><circle cx="0.020289797301337377" cy="0.9666990205594282" r="0.0035072000000000007"></circle><circle cx="0" cy="0.6338304067766705" r="0.0035072000000000007"></circle><circle cx="0.806230442668367" cy="0.41498279361157697" r="0.0035072000000000007"></circle><circle cx="0.5125067267255294" cy="0.5246271949174985" r="0.0035072000000000007"></circle><circle cx="0.5725788770852849" cy="0.47909644401306006" r="0.0035072000000000007"></circle><circle cx="0.6045482630099853" cy="0.5613694520427075" r="0.0035072000000000007"></circle><circle cx="0.37486297410958086" cy="0.530909732639196" r="0.0035072000000000007"></circle><circle cx="0.6890160046240011" cy="0.5881055325156624" r="0.0035072000000000007"></circle><circle cx="0.6369362007454208" cy="0.5192093885114272" r="0.0035072000000000007"></circle><circle cx="0.6017778486436929" cy="0.7343510103238332" r="0.0035072000000000007"></circle><circle cx="0.8274968608614195" cy="0.4736786376069887" r="0.0035072000000000007"></circle><circle cx="0.6930819364997114" cy="0.6210535603988354" r="0.0035072000000000007"></circle><circle cx="0.5953799852510314" cy="0.37753463337157" r="0.0035072000000000007"></circle><circle cx="0.8818488031411325" cy="0.4423012441542403" r="0.0035072000000000007"></circle><circle cx="0.5171307276822197" cy="0.5697344039530577" r="0.0035072000000000007"></circle><circle cx="0.714129113268093" cy="0.4644136592252718" r="0.0035072000000000007"></circle><circle cx="0.6834153827755975" cy="0.5395217506397254" r="0.0035072000000000007"></circle><circle cx="0.669981862754869" cy="0.7612106238418778" r="0.0035072000000000007"></circle><circle cx="0.546050664700138" cy="0.46737845230742103" r="0.0035072000000000007"></circle><circle cx="0.7436669124828098" cy="0.5810994441012969" r="0.0035072000000000007"></circle><circle cx="0.6097303330476553" cy="0.510456189887938" r="0.0035072000000000007"></circle><circle cx="0.4788830645964958" cy="0.5782405364863674" r="0.0035072000000000007"></circle><circle cx="0.7106611125505751" cy="0.4513720991793879" r="0.0035072000000000007"></circle><circle cx="0.32780579195981924" cy="0.5161563575399282" r="0.0035072000000000007"></circle><circle cx="1" cy="0.46991970352069246" r="0.0035072000000000007"></circle><circle cx="0.8410300360751803" cy="0.3886879025853709" r="0.0035072000000000007"></circle><circle cx="0.6449086161879894" cy="0.5148680843554225" r="0.0035072000000000007"></circle><circle cx="0.7483905686325314" cy="0.7002029471455046" r="0.0035072000000000007"></circle><circle cx="0.6402646841926933" cy="0.3277861113562167" r="0.0035072000000000007"></circle><circle cx="0.8391166563689636" cy="0.47697873466866714" r="0.0035072000000000007"></circle><circle cx="0.7320869790524784" cy="0.528262595958705" r="0.0035072000000000007"></circle><circle cx="0.7243736671117934" cy="0.7335392217418161" r="0.0035072000000000007"></circle><circle cx="0.5671377035457316" cy="0.4903908938498194" r="0.0035072000000000007"></circle><circle cx="0.6533793075957189" cy="0.5792993911585638" r="0.0035072000000000007"></circle><circle cx="0.8422258983915654" cy="0.28308479661166563" r="0.0035072000000000007"></circle><circle cx="0.68829848723417" cy="0.45497220506485514" r="0.0035072000000000007"></circle><circle cx="0.726426564088255" cy="0.7272390364422483" r="0.0035072000000000007"></circle><circle cx="0.6587606880194528" cy="0.44399541162975464" r="0.0035072000000000007"></circle><circle cx="0.34373069180635013" cy="0.3382687726109598" r="0.0035072000000000007"></circle><circle cx="0.6431945468678374" cy="0.44830142063001877" r="0.0035072000000000007"></circle><circle cx="0.3505072449325335" cy="0.5956763434218656" r="0.0035072000000000007"></circle><circle cx="0.6353417176569068" cy="0.44669549104385475" r="0.0035072000000000007"></circle><circle cx="0.3615091782432782" cy="0.4667607870819732" r="0.0035072000000000007"></circle><circle cx="0.7700356765591053" cy="0.7477631695049856" r="0.0035072000000000007"></circle><circle cx="0.4741594084467742" cy="0" r="0.0035072000000000007"></circle><circle cx="0.6398262013433521" cy="0.573599223506574" r="0.0035072000000000007"></circle><circle cx="0.43951926334881325" cy="0.5294273360981212" r="0.0035072000000000007"></circle><circle cx="0.46845913140533785" cy="0.4964263654813379" r="0.0035072000000000007"></circle><circle cx="0.5870089490363342" cy="0.4592605664872499" r="0.0035072000000000007"></circle><circle cx="0.5141211408526499" cy="0.6374305126621373" r="0.0035072000000000007"></circle><circle cx="0.5156358997867381" cy="0.4383481867113743" r="0.0035072000000000007"></circle><circle cx="0.4288362266557711" cy="0.573599223506574" r="0.0035072000000000007"></circle><circle cx="0.3760787674645726" cy="0.5002911850348541" r="0.0035072000000000007"></circle><circle cx="0.4266836744862775" cy="0.2642195358687027" r="0.0035072000000000007"></circle><circle cx="0.41695732764634347" cy="0.2557310509132632" r="0.0035072000000000007"></circle><circle cx="0.5091583122396508" cy="0.629718521132975" r="0.0035072000000000007"></circle><circle cx="0.3453052438562573" cy="0.44277772875672816" r="0.0035072000000000007"></circle><circle cx="0.5201801765890017" cy="0.6240183534809849" r="0.0035072000000000007"></circle><circle cx="0.2758455743128775" cy="0.44085414276890533" r="0.0035072000000000007"></circle><circle cx="0.30113806230442675" cy="0.5773934527486105" r="0.0035072000000000007"></circle><circle cx="0.2965539234249497" cy="0.29469690285008443" r="0.0035072000000000007"></circle><circle cx="0.39427580571223575" cy="0.47115503397158787" r="0.0035072000000000007"></circle><circle cx="0.30185557969425797" cy="0.3549633812759201" r="0.0035072000000000007"></circle><circle cx="0.4341578139636854" cy="0.4912909203211867" r="0.0035072000000000007"></circle></g><g><line x1="0.33" y1="1" x2="0.283801940751666" y2="1" marker-end="url(#arrowhead)"></line><circle cx="0.33" cy="1" r="0.004384000000000001"></circle><text x="0.33" y="0.9766186666666666" text-anchor="middle" dominant-baseline="auto" font-size="0.023381333333333337">C0</text></g><g><line x1="1" y1="0.6699999999999999" x2="1" y2="0.4845330368540258" marker-end="url(#arrowhead)"></line><circle cx="1" cy="0.6699999999999999" r="0.004384000000000001"></circle><text x="0.9795413333333334" y="0.6699999999999999" text-anchor="end" dominant-baseline="middle" font-size="0.023381333333333337">C1</text></g><g><line x1="1" y1="0.33999999999999997" x2="0.9927250324679331" y2="0.3096661172969877" marker-end="url(#arrowhead)"></line><circle cx="1" cy="0.33999999999999997" r="0.004384000000000001"></circle><text x="0.9795413333333334" y="0.33999999999999997" text-anchor="end" dominant-baseline="middle" font-size="0.023381333333333337">C2</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.97808" y="0.41292770352069247" width="0.04384" height="0.04384" rx="0.00548"></rect><text x="1" y="0.43484770352069246" text-anchor="middle" dominant-baseline="middle" font-size="0.036533333333333334">M</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.9673969633069582" y="0.23846374869849157" width="0.04384" height="0.04384" rx="0.00548"></rect><text x="0.9893169633069583" y="0.26038374869849157" text-anchor="middle" dominant-baseline="middle" font-size="0.036533333333333334">$</text></g><g opacity="1" style="transition:opacity 0.2s ease"><rect x="0.24726860741833268" y="0.943008" width="0.04384" height="0.04384" rx="0.00548"></rect><text x="0.26918860741833267" y="0.964928" text-anchor="middle" dominant-baseline="middle" font-size="0.036533333333333334">&#39;</text></g></svg></p>
<p>We get <code>&#39;</code>, <code>M</code> and <code>$</code>.  Let’s see how well those characters match the circle:</p>

<p>Nice! They match very well.</p>
<p>Let’s try rendering the full circle from before with the same method:</p>

<p>Much better than before! The picked characters follow the contour of the circle very well.</p>
<h2>Limits of a 2D shape vector</h2>
<p>Using two sampling circles — one upper and one lower — produces a much better result than the <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 500 666" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-35-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-35-TEX-N-31"></use></g></g></g></svg></mjx-container>-dimensional (pixelated) approach. However, it still falls short when trying to capture other aspects of a character’s shape.</p>
<p>For example, two circles don’t capture the shape of characters that fall in the middle of the cell. Consider <code>-</code>:</p>

<p>For <code>-</code>, we get a shape vector of <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-2.149ex" xmlns="http://www.w3.org/2000/svg" width="7.543ex" height="5.43ex" role="img" focusable="false" viewBox="0 -1450 3334 2400" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-36-TEX-S3-5B" d="M247 -949V1450H516V1388H309V-887H516V-949H247Z"></path><path id="MJX-36-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-36-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-36-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-36-TEX-N-39" d="M352 287Q304 211 232 211Q154 211 104 270T44 396Q42 412 42 436V444Q42 537 111 606Q171 666 243 666Q245 666 249 666T257 665H261Q273 665 286 663T323 651T370 619T413 560Q456 472 456 334Q456 194 396 97Q361 41 312 10T208 -22Q147 -22 108 7T68 93T121 149Q143 149 158 135T173 96Q173 78 164 65T148 49T135 44L131 43Q131 41 138 37T164 27T206 22H212Q272 22 313 86Q352 142 352 280V287ZM244 248Q292 248 321 297T351 430Q351 508 343 542Q341 552 337 562T323 588T293 615T246 625Q208 625 181 598Q160 576 154 546T147 441Q147 358 152 329T172 282Q197 248 244 248Z"></path><path id="MJX-36-TEX-S3-5D" d="M11 1388V1450H280V-949H11V-887H218V1388H11Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mrow"><g data-mml-node="mo" transform="translate(0 -0.5)"><use data-c="5B" xlink:href="#MJX-36-TEX-S3-5B"></use></g><g data-mml-node="mtable" transform="translate(528,0)"><g data-mml-node="mtr" transform="translate(0,700)"><g data-mml-node="mtd"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-36-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-36-TEX-N-2E" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-36-TEX-N-30" transform="translate(778,0)"></use><use data-c="32" xlink:href="#MJX-36-TEX-N-32" transform="translate(1278,0)"></use><use data-c="39" xlink:href="#MJX-36-TEX-N-39" transform="translate(1778,0)"></use></g></g></g><g data-mml-node="mtr" transform="translate(0,-700)"><g data-mml-node="mtd"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-36-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-36-TEX-N-2E" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-36-TEX-N-30" transform="translate(778,0)"></use><use data-c="30" xlink:href="#MJX-36-TEX-N-30" transform="translate(1278,0)"></use><use data-c="32" xlink:href="#MJX-36-TEX-N-32" transform="translate(1778,0)"></use></g></g></g></g><g data-mml-node="mo" transform="translate(2806,0) translate(0 -0.5)"><use data-c="5D" xlink:href="#MJX-36-TEX-S3-5D"></use></g></g></g></g></svg></mjx-container>. That doesn’t represent the character very well at all.</p>
<p>The two upper-lower sampling circles also don’t capture left-right differences, such as the difference between <code>p</code> and <code>q</code>:</p>

<p>We could use such differences to get better character picks, but our two sampling circles don’t capture them. Let’s add more dimensions to our shape to fix that.</p>
<h2>Increasing to 6 dimensions</h2>
<p>Since cells are taller than they are wide (at least with the monospace font I’m using), we can use <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-37-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="36" xlink:href="#MJX-37-TEX-N-36"></use></g></g></g></svg></mjx-container> sampling circles to cover the area of each cell quite well:</p>

<p><mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-38-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="36" xlink:href="#MJX-38-TEX-N-36"></use></g></g></g></svg></mjx-container> sampling circles capture left-right differences, such as between <code>p</code> and <code>q</code>, while also capturing differences across the top, bottom, and middle regions of the cell, differentiating <code>^</code>, <code>-</code>, and <code>_</code>. They also capture the shape of “diagonal” characters like <code>/</code> to a reasonable degree.</p>

<p>One problem with this grid-like configuration for the sampling circles is that there are gaps. For example, <code>.</code> falls between the sampling circles:</p>

<p>To compensate for this, we can stagger the sampling circles vertically (e.g. lowering the left sampling circles and raising the right ones) and make them a bit larger. This causes the cell to be almost fully covered while not causing excessive overlap across the sampling circles:</p>

<p>We can use the same procedure as before to generate character vectors using these sampling circles, this time yielding a <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-39-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="36" xlink:href="#MJX-39-TEX-N-36"></use></g></g></g></svg></mjx-container>-dimensional vector. Consider the character <code>L</code>:</p>

<p>For <code>L</code>, we get the vector:</p>

<p>I’m presenting <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-41-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="36" xlink:href="#MJX-41-TEX-N-36"></use></g></g></g></svg></mjx-container>-dimensional shape vectors in a <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="5.028ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 2222.4 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-42-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-42-TEX-N-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path><path id="MJX-42-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="33" xlink:href="#MJX-42-TEX-N-33"></use></g><g data-mml-node="mo" transform="translate(722.2,0)"><use data-c="D7" xlink:href="#MJX-42-TEX-N-D7"></use></g><g data-mml-node="mn" transform="translate(1722.4,0)"><use data-c="32" xlink:href="#MJX-42-TEX-N-32"></use></g></g></g></svg></mjx-container> matrix form because it’s easier to grok geometrically, but the actual vector is a flat list of numbers.</p>
<p>The lightness values certainly look L-shaped! The 6D shape vector captures <code>L</code>’s shape very well.</p>
<h3>Nearest neighbor lookups in a 6D space</h3>
<p>Now we have a 6D shape vector for every ASCII character. Does that affect character lookups (how we find the best matching character)?</p>
<p>Earlier, in the <code><span>findBestCharacter</span></code> function, I referenced a <code><span>getDistance</span></code> function. That function returns the <a target="_blank" href="https://en.wikipedia.org/wiki/Euclidean_distance">Euclidean distance</a> between the input points. Given two 2D points <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.023ex" xmlns="http://www.w3.org/2000/svg" width="1.197ex" height="1.02ex" role="img" focusable="false" viewBox="0 -441 529 451" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-43-TEX-I-1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D44E" xlink:href="#MJX-43-TEX-I-1D44E"></use></g></g></g></svg></mjx-container> and <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.025ex" xmlns="http://www.w3.org/2000/svg" width="0.971ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 429 705" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-44-TEX-I-1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D44F" xlink:href="#MJX-44-TEX-I-1D44F"></use></g></g></g></svg></mjx-container>, the formula to calculate their Euclidean distance looks like so:</p>

<p>This generalizes to higher dimensions:</p>

<p>Put into code, this looks like so:</p>
<div><div><div><pre><p><span>function</span><span> </span><span>getDistance</span><span>(</span><span>a</span><span>:</span><span> </span><span>number</span><span>[</span><span>]</span><span>,</span><span> b</span><span>:</span><span> </span><span>number</span><span>[</span><span>]</span><span>)</span><span>:</span><span> </span><span>number</span><span> </span><span>{</span><span></span></p><p><span>  </span><span>let</span><span> sum </span><span>=</span><span> </span><span>0</span><span>;</span><span></span></p><p><span>  </span><span>for</span><span> </span><span>(</span><span>let</span><span> i </span><span>=</span><span> </span><span>0</span><span>;</span><span> i </span><span>&lt;</span><span> a</span><span>.</span><span>length</span><span>;</span><span> i</span><span>++</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>    sum </span><span>+=</span><span> </span><span>(</span><span>a</span><span>[</span><span>i</span><span>]</span><span> </span><span>-</span><span> b</span><span>[</span><span>i</span><span>]</span><span>)</span><span> </span><span>**</span><span> </span><span>2</span><span>;</span><span></span></p><p><span>  </span><span>}</span><span></span></p><p><span>  </span><span>return</span><span> Math</span><span>.</span><span>sqrt</span><span>(</span><span>sum</span><span>)</span><span>;</span><span></span></p><p><span></span><span>}</span><span></span></p></pre></div></div></div>
<p>Note: since we’re just using this for the purposes of finding the closest point, we can skip the expensive <code><span>Math</span><span>.</span><span>sqrt</span><span>(</span><span>)</span></code> call and just return the squared distance. It does not affect the result.</p>
<p>So, no, the dimensionality of our shape vector does not change lookups at all. We can use the same <code><span>getDistance</span></code> function for both 2D and 6D.</p>
<p>With that out of the way, let’s see what the 6D approach yields!</p>
<h3>Trying out the 6D approach</h3>
<p>Our new 6D approach works really well for flat shapes, like the circle example we’ve been using:</p>

<p>Now let’s see how this approach works when we render a 3D scene with more shades of gray:</p>

<p>Firstly, the outer contours look nice and sharp. I also like how well the gradients across the sphere and cone look.</p>
<p>However, internally, the objects all kind of blend together. The edges <em>between</em> surfaces with different lightnesses aren’t sharp enough. For example, the lighter faces of the cubes all kind of blend into one solid color. When there is a change in color — like when two faces of a cube meet — I’d like to see more sharpness in the ASCII rendering.</p>
<p>To demonstrate what I mean, consider the following split:</p>

<p>It’s currently rendered like so:</p>

<p>The different shades result in <code>i</code>s on the left and <code>B</code>s on the right, but the boundary is not very sharp.</p>
<p>By applying some effects to the sampling vector, we can enhance the contrast at the boundary so that it appears sharper:</p>

<p>The added contrast makes a <em>big</em> difference in readability for the 3D scene. Let’s look at how we can implement this contrast enhancement effect.</p>
<h2>Contrast enhancement</h2>
<p>Consider cells overlapping a color boundary like so:</p>

<p>For the cells on the boundary, we get a 6D sampling vector that looks like so:</p>

<p>To make future examples easier to visualize, I’ll start drawing the sampling vector using <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-48-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="36" xlink:href="#MJX-48-TEX-N-36"></use></g></g></g></svg></mjx-container> circles like so:</p>

<p>Currently, this sampling vector resolves to the character <code>T</code>:</p>

<p>That’s a sensible choice. The character <code>T</code> is visually dense in the top half and less so in the bottom half, so it matches the image fairly well.</p>

<p>Still, I want the picked character to emphasize the shape of the boundary better. We can achieve that by enhancing the contrast of the sampling vector.</p>
<p>To increase the contrast of our sampling vector, we might raise each component of the vector to the power of some exponent.</p>
<p>Consider how an exponent affects values between <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-49-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-49-TEX-N-30"></use></g></g></g></svg></mjx-container> and <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 500 666" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-50-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-50-TEX-N-31"></use></g></g></g></svg></mjx-container>. Numbers close to <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-51-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-51-TEX-N-30"></use></g></g></g></svg></mjx-container> experience a strong pull towards <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-52-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-52-TEX-N-30"></use></g></g></g></svg></mjx-container> while larger numbers experience less pull. For example, <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.186ex" xmlns="http://www.w3.org/2000/svg" width="10.919ex" height="2.14ex" role="img" focusable="false" viewBox="0 -864 4826.1 946" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-53-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-53-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-53-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-53-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-53-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-53-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-53-TEX-N-2E" transform="translate(500,0)"></use><use data-c="31" xlink:href="#MJX-53-TEX-N-31" transform="translate(778,0)"></use></g><g data-mml-node="mn" transform="translate(1311,393.1) scale(0.707)"><use data-c="32" xlink:href="#MJX-53-TEX-N-32"></use></g></g><g data-mml-node="mo" transform="translate(1992.3,0)"><use data-c="3D" xlink:href="#MJX-53-TEX-N-3D"></use></g><g data-mml-node="mn" transform="translate(3048.1,0)"><use data-c="30" xlink:href="#MJX-53-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-53-TEX-N-2E" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-53-TEX-N-30" transform="translate(778,0)"></use><use data-c="31" xlink:href="#MJX-53-TEX-N-31" transform="translate(1278,0)"></use></g></g></g></svg></mjx-container>, a 90% reduction, while <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.186ex" xmlns="http://www.w3.org/2000/svg" width="10.919ex" height="2.14ex" role="img" focusable="false" viewBox="0 -864 4826.1 946" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-54-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-54-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-54-TEX-N-39" d="M352 287Q304 211 232 211Q154 211 104 270T44 396Q42 412 42 436V444Q42 537 111 606Q171 666 243 666Q245 666 249 666T257 665H261Q273 665 286 663T323 651T370 619T413 560Q456 472 456 334Q456 194 396 97Q361 41 312 10T208 -22Q147 -22 108 7T68 93T121 149Q143 149 158 135T173 96Q173 78 164 65T148 49T135 44L131 43Q131 41 138 37T164 27T206 22H212Q272 22 313 86Q352 142 352 280V287ZM244 248Q292 248 321 297T351 430Q351 508 343 542Q341 552 337 562T323 588T293 615T246 625Q208 625 181 598Q160 576 154 546T147 441Q147 358 152 329T172 282Q197 248 244 248Z"></path><path id="MJX-54-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-54-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-54-TEX-N-38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z"></path><path id="MJX-54-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-54-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-54-TEX-N-2E" transform="translate(500,0)"></use><use data-c="39" xlink:href="#MJX-54-TEX-N-39" transform="translate(778,0)"></use></g><g data-mml-node="mn" transform="translate(1311,393.1) scale(0.707)"><use data-c="32" xlink:href="#MJX-54-TEX-N-32"></use></g></g><g data-mml-node="mo" transform="translate(1992.3,0)"><use data-c="3D" xlink:href="#MJX-54-TEX-N-3D"></use></g><g data-mml-node="mn" transform="translate(3048.1,0)"><use data-c="30" xlink:href="#MJX-54-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-54-TEX-N-2E" transform="translate(500,0)"></use><use data-c="38" xlink:href="#MJX-54-TEX-N-38" transform="translate(778,0)"></use><use data-c="31" xlink:href="#MJX-54-TEX-N-31" transform="translate(1278,0)"></use></g></g></g></svg></mjx-container>, only a reduction of 10%.</p>
<p>The level of pull depends on the exponent. Here’s a chart of <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.025ex" xmlns="http://www.w3.org/2000/svg" width="2.282ex" height="1.912ex" role="img" focusable="false" viewBox="0 -833.9 1008.6 844.9" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-55-TEX-I-1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path><path id="MJX-55-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mi"><use data-c="1D465" xlink:href="#MJX-55-TEX-I-1D465"></use></g><g data-mml-node="mn" transform="translate(605,363) scale(0.707)"><use data-c="32" xlink:href="#MJX-55-TEX-N-32"></use></g></g></g></g></svg></mjx-container> for values of <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.025ex" xmlns="http://www.w3.org/2000/svg" width="1.294ex" height="1.025ex" role="img" focusable="false" viewBox="0 -442 572 453" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-56-TEX-I-1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D465" xlink:href="#MJX-56-TEX-I-1D465"></use></g></g></g></svg></mjx-container> between <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-57-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-57-TEX-N-30"></use></g></g></g></svg></mjx-container> and <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 500 666" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-58-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-58-TEX-N-31"></use></g></g></g></svg></mjx-container>:</p>
<div><p><img src="https://blog.veitheller.de/images/posts/ascii-rendering/x-pow-2-chart.png" width="500"/></p></div>
<p>This effect becomes more pronounced with higher exponents:</p>
<div><p><img src="https://blog.veitheller.de/images/posts/ascii-rendering/x-pow-n-chart.png" width="500"/></p></div>
<p>A higher exponent translates to a stronger pull towards zero.</p>
<p>Applying an exponent should make dark values darker more quickly than light ones. The example below allows you to vary the exponent applied to the sampling vector:</p>

<p>As the exponent is increased to <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 500 666" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-59-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-59-TEX-N-32"></use></g></g></g></svg></mjx-container>, the darker components of the sampling vector quickly become <em>much</em> darker, just like we wanted. However, the lighter components also get pulled towards zero by a significant amount.</p>
<p>I don’t want that. I want to increase the contrast <em>between</em> the lighter and darker components of the sampling vector, not the vector in its entirety.</p>
<p>To achieve that, we can normalize the sampling vector to the range <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.566ex" xmlns="http://www.w3.org/2000/svg" width="4.526ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2000.7 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-60-TEX-N-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path><path id="MJX-60-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-60-TEX-N-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path id="MJX-60-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-60-TEX-N-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><use data-c="5B" xlink:href="#MJX-60-TEX-N-5B"></use></g><g data-mml-node="mn" transform="translate(278,0)"><use data-c="30" xlink:href="#MJX-60-TEX-N-30"></use></g><g data-mml-node="mo" transform="translate(778,0)"><use data-c="2C" xlink:href="#MJX-60-TEX-N-2C"></use></g><g data-mml-node="mn" transform="translate(1222.7,0)"><use data-c="31" xlink:href="#MJX-60-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(1722.7,0)"><use data-c="5D" xlink:href="#MJX-60-TEX-N-5D"></use></g></g></g></svg></mjx-container> prior to applying the exponent, and then “denormalize” the vector back to the original range afterwards.</p>
<p>The normalization to <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.566ex" xmlns="http://www.w3.org/2000/svg" width="4.526ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2000.7 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-61-TEX-N-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path><path id="MJX-61-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-61-TEX-N-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path id="MJX-61-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-61-TEX-N-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><use data-c="5B" xlink:href="#MJX-61-TEX-N-5B"></use></g><g data-mml-node="mn" transform="translate(278,0)"><use data-c="30" xlink:href="#MJX-61-TEX-N-30"></use></g><g data-mml-node="mo" transform="translate(778,0)"><use data-c="2C" xlink:href="#MJX-61-TEX-N-2C"></use></g><g data-mml-node="mn" transform="translate(1222.7,0)"><use data-c="31" xlink:href="#MJX-61-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(1722.7,0)"><use data-c="5D" xlink:href="#MJX-61-TEX-N-5D"></use></g></g></g></svg></mjx-container> can be done by dividing each component by the maximum component value. After applying the exponent, mapping back to the original range is done by multiplying each component by the same max value:</p>
<div><div><div><pre><p><span>const</span><span> maxValue </span><span>=</span><span> Math</span><span>.</span><span>max</span><span>(</span><span>...</span><span>samplingVector</span><span>)</span><span></span></p><p><span>samplingVector </span><span>=</span><span> samplingVector</span><span>.</span><span>map</span><span>(</span><span>(</span><span>value</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span></span></p><p><span>  value </span><span>=</span><span> x </span><span>/</span><span> maxValue</span><span>;</span><span> </span><span></span></p><p><span>  value </span><span>=</span><span> Math</span><span>.</span><span>pow</span><span>(</span><span>x</span><span>,</span><span> exponent</span><span>)</span><span>;</span><span></span></p><p><span>  value </span><span>=</span><span> x </span><span>*</span><span> maxValue</span><span>;</span><span> </span><span></span></p><p><span>  </span><span>return</span><span> value</span><span>;</span><span></span></p><p><span></span><span>}</span><span>)</span><span></span></p></pre></div></div></div>
<p>Here’s the same example, but with this normalization applied:</p>

<p>Very nice! The lightest component values are retained, and the contrast between the lighter and darker components is increased by “crunching” the lower values.</p>
<p>This affects which character is picked. The following example shows how the selected character changes as the contrast is increased:</p>

<p>Awesome! The pick of <code>&#34;</code> over <code>T</code> emphasizes the separation between the lighter region above and the darker region below!</p>

<p>By enhancing the contrast of the sampling vector, we exaggerate its shape. This gives us a character that less faithfully represents the underlying image, but improves readability as a whole by enhancing the separation between different colored regions.</p>
<p>Let’s look at another example. Observe how the L-shape of the sampling vector below becomes more pronounced as the exponent increases, and how that affects the picked character:</p>

<p>Works really nicely! I <em>love</em> the transition from <code>&amp; -&gt; b -&gt; L</code> as the L-shape of the vector becomes clearer.</p>
<p>What’s nice about applying exponents to normalized sampling vectors is that it barely affects vectors that are uniform in value. If all component values are similar, applying an exponent has a minimal effect:</p>

<p>Because the vector is fairly uniform, the exponent only has a slight effect and doesn’t change the picked character.</p>
<p>This is a good thing! If we have a smooth gradient in our image, we want to retain it. We very much do <em>not</em> want to introduce unnecessary choppiness.</p>
<p>Compare the 3D scene ASCII rendering with and without this contrast enhancement:</p>

<p>We do see more contrast at boundaries, but this is not quite there yet. Some edges are still not sharp enough, and we also observe a “staircasing” effect happening at some boundaries.</p>
<p>Let’s look at the staircasing effect first. We can reproduce it with a boundary like so:</p>

<p>Below is the ASCII rendering of that boundary. Notice how the lower edge (the <code>!</code>s) becomes “staircase-y” as you increase the exponent:</p>

<p>We see a staircase pattern like so:</p>
<div><div><div><pre><p><span>               !!!!!</span></p><p><span>          !!!!!!!!!!</span></p><p><span>     !!!!!!!!!!!!!!!</span></p><p><span>!!!!!!!!!!!!!!!!!!!!</span></p></pre></div></div></div>
<p>To understand why that’s happening, let’s consider the row in the middle of the canvas, progressing from left to right. As we start off, every sample is equally light, giving us <code>U</code>s:</p>

<p>As we reach the boundary, the lower right samples become a bit darker. Those darker components are crunched by contrast enhancement, giving us some <code>Y</code>s:</p>

<p>So we get:</p>

<p>As we progress further right, the middle and lower samples get darker, so we get some <code>f</code>s:</p>

<p>This trend continues towards <code>&#34;</code>, <code>&#39;</code>, and finally, <code>`</code>:</p>

<p>Giving us a sequence like so:</p>

<p>That looks good, but at some point we get <em>no</em> light samples. Once we get no light samples, our contrast enhancement has no effect because every component is equally light. This causes us to always get <code>!</code>s:</p>

<p>Making our sequence look like so:</p>
<div><div><div><pre><p><span>UUUUUUUUYYf&#34;&#34;&#39;&#39;`!!!!!!!!!! -&gt;</span></p></pre></div></div></div>
<p>This sudden stop in contrast enhancement having an effect is what causes the staircasing effect:</p>
<div><div><div><pre><p><span>               !!!!!</span></p><p><span>          !!!!!!!!!!</span></p><p><span>     !!!!!!!!!!!!!!!</span></p><p><span>!!!!!!!!!!!!!!!!!!!!</span></p></pre></div></div></div>
<p>Let’s see how we can counteract this staircasing effect with <em>another</em> layer of contrast enhancement, this time looking outside of the boundary of each cell.</p>
<h3>Directional contrast enhancement</h3>
<p>We currently have sampling circles arranged like so:</p>

<p>For each of those sampling circles, we’ll specify an “external sampling circle”, placed outside of the cell’s boundary, like so:</p>

<p>Each of those external sampling circles is “reaching” into the region of a neighboring cell. Together, the samples that are collected by the external sampling circles constitute an “external sampling vector”.</p>
<p>Let’s simplify the visualization and consider a single example. Imagine that we collected a sampling vector and an external sampling vector that look like so:</p>

<p>The circles colored red are the external sampling vector components. Currently, they have no effect.</p>
<p>The “internal” sampling vector itself is fairly uniform, with values ranging from <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="4.023ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1778 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-62-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-62-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-62-TEX-N-35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path><path id="MJX-62-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-62-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-62-TEX-N-2E" transform="translate(500,0)"></use><use data-c="35" xlink:href="#MJX-62-TEX-N-35" transform="translate(778,0)"></use><use data-c="31" xlink:href="#MJX-62-TEX-N-31" transform="translate(1278,0)"></use></g></g></g></svg></mjx-container> to <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="4.023ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1778 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-63-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-63-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-63-TEX-N-35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path><path id="MJX-63-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-63-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-63-TEX-N-2E" transform="translate(500,0)"></use><use data-c="35" xlink:href="#MJX-63-TEX-N-35" transform="translate(778,0)"></use><use data-c="33" xlink:href="#MJX-63-TEX-N-33" transform="translate(1278,0)"></use></g></g></g></svg></mjx-container>. The external vector’s values are similar, except in the upper left region where the values are significantly lighter (<mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.891ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1278 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-64-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-64-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-64-TEX-N-38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-64-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-64-TEX-N-2E" transform="translate(500,0)"></use><use data-c="38" xlink:href="#MJX-64-TEX-N-38" transform="translate(778,0)"></use></g></g></g></svg></mjx-container> and <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="4.023ex" height="1.579ex" role="img" focusable="false" viewBox="0 -676 1778 698" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-65-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-65-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-65-TEX-N-35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path><path id="MJX-65-TEX-N-37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-65-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-65-TEX-N-2E" transform="translate(500,0)"></use><use data-c="35" xlink:href="#MJX-65-TEX-N-35" transform="translate(778,0)"></use><use data-c="37" xlink:href="#MJX-65-TEX-N-37" transform="translate(1278,0)"></use></g></g></g></svg></mjx-container>). This indicates a color boundary above and to the left of the cell.</p>
<p>To enhance this apparent boundary, we’ll darken the top-left and middle-left components of the sampling vector. We can do that by applying <em>component-wise</em> contrast enhancement using the values from the external vector.</p>
<p>In the previous contrast enhancement, we calculated the maximum component value across the sampling vector and normalized the vector using that value:</p>
<div><div><div><pre><p><span>const</span><span> maxValue </span><span>=</span><span> Math</span><span>.</span><span>max</span><span>(</span><span>...</span><span>samplingVector</span><span>)</span><span></span></p><p><span>samplingVector </span><span>=</span><span> samplingVector</span><span>.</span><span>map</span><span>(</span><span>(</span><span>value</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span></span></p><p><span>  value </span><span>=</span><span> x </span><span>/</span><span> maxValue</span><span>;</span><span> </span><span></span></p><p><span>  value </span><span>=</span><span> Math</span><span>.</span><span>pow</span><span>(</span><span>x</span><span>,</span><span> exponent</span><span>)</span><span>;</span><span></span></p><p><span>  value </span><span>=</span><span> x </span><span>*</span><span> maxValue</span><span>;</span><span> </span><span></span></p><p><span>  </span><span>return</span><span> value</span><span>;</span><span></span></p><p><span></span><span>}</span><span>)</span><span></span></p></pre></div></div></div>
<p>But the new component-wise contrast enhancement will take the maximum value between each component of the sampling vector and the corresponding component in the external sampling vector:</p>
<div><div><div><pre><p><span>samplingVector </span><span>=</span><span> samplingVector</span><span>.</span><span>map</span><span>(</span><span>(</span><span>value</span><span>,</span><span> i</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span></span></p><p><span>  </span><span>const</span><span> maxValue </span><span>=</span><span> Math</span><span>.</span><span>max</span><span>(</span><span>value</span><span>,</span><span> externalSamplingVector</span><span>[</span><span>i</span><span>]</span><span>)</span><span></span></p><p><span></span><span>}</span><span>)</span><span>;</span><span></span></p></pre></div></div></div>
<p>Aside from that, the contrast enhancement is performed in the same way:</p>
<div><div><div><pre><p><span>samplingVector </span><span>=</span><span> samplingVector</span><span>.</span><span>map</span><span>(</span><span>(</span><span>value</span><span>,</span><span> i</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span></span></p><p><span>  </span><span>const</span><span> maxValue </span><span>=</span><span> Math</span><span>.</span><span>max</span><span>(</span><span>value</span><span>,</span><span> externalSamplingVector</span><span>[</span><span>i</span><span>]</span><span>)</span><span>;</span><span></span></p><p><span>  value </span><span>=</span><span> value </span><span>/</span><span> maxValue</span><span>;</span><span></span></p><p><span>  value </span><span>=</span><span> Math</span><span>.</span><span>pow</span><span>(</span><span>value</span><span>,</span><span> exponent</span><span>)</span><span>;</span><span></span></p><p><span>  value </span><span>=</span><span> value </span><span>*</span><span> maxValue</span><span>;</span><span></span></p><p><span>  </span><span>return</span><span> value</span><span>;</span><span></span></p><p><span></span><span>}</span><span>)</span><span>;</span><span></span></p></pre></div></div></div>
<p>The example below shows how light values in the external sampling vector push values in the sampling vector down:</p>

<p>I call this “directional contrast enhancement”, since each of the external sampling circles reaches outside of the cell in the <em>direction</em> of the sampling vector component that it is enhancing the contrast of. I describe the other effect as “global contrast enhancement” since it acts on all of the sampling vector’s components together.</p>
<p>Let’s see what this directional contrast enhancement does to get rid of the staircasing effect:</p>

<p>Hmm, that’s not doing what I wanted. I wanted to see a sequence like so:</p>
<div><div><div><pre><p><span>            ..::!!</span></p><p><span>      ..::!!!!!!!!</span></p><p><span>..::!!!!!!!!!!!!!!</span></p></pre></div></div></div>
<p>But we just see <code>!</code> changing to <code>:</code></p>

<p>This happens because the directional contrast enhancement doesn’t reach far enough into our sampling vector. The light upper values in the external vector <em>do</em> push the upper values of the sampling vector down, but because the lightness of the four bottom components is retained, we don’t get to <code>.</code>, just <code>:</code>.</p>
<h3>Widening the directional contrast enhancement</h3>
<p>I’d like to “widen” the directional contrast enhancement so that, for example, light external values at the top spread to the middle components of the sampling vector.</p>
<p>To do that, I’ll introduce a few more external sampling circles, arranged like so:</p>

<p>These are a total of <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-66-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-66-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-66-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-66-TEX-N-30" transform="translate(500,0)"></use></g></g></g></svg></mjx-container> external sampling circles. Each of the external sampling circles will affect one or more of the internal sampling circles. Here’s an illustration showing which internal circles each external circle affects:</p>

<p>For each component of the internal sampling vector, we’ll calculate the maximum value across the external sampling vector components that affect it, and use that maximum to perform the contrast enhancement.</p>
<p>Let’s implement that. I’ll order the internal and external sampling circles like so:</p>

<p>We can then define a mapping from the internal circles to the external sampling circles that affect them:</p>
<div><div><div><pre><p><span>const</span><span> </span><span>AFFECTING_EXTERNAL_INDICES</span><span> </span><span>=</span><span> </span><span>[</span><span></span></p><p><span>  </span><span>[</span><span>0</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>2</span><span>,</span><span> </span><span>4</span><span>]</span><span>,</span><span></span></p><p><span>  </span><span>[</span><span>0</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>3</span><span>,</span><span> </span><span>5</span><span>]</span><span>,</span><span></span></p><p><span>  </span><span>[</span><span>2</span><span>,</span><span> </span><span>4</span><span>,</span><span> </span><span>6</span><span>]</span><span>,</span><span></span></p><p><span>  </span><span>[</span><span>3</span><span>,</span><span> </span><span>5</span><span>,</span><span> </span><span>7</span><span>]</span><span>,</span><span></span></p><p><span>  </span><span>[</span><span>4</span><span>,</span><span> </span><span>6</span><span>,</span><span> </span><span>8</span><span>,</span><span> </span><span>9</span><span>]</span><span>,</span><span></span></p><p><span>  </span><span>[</span><span>5</span><span>,</span><span> </span><span>7</span><span>,</span><span> </span><span>8</span><span>,</span><span> </span><span>9</span><span>]</span><span>,</span><span></span></p><p><span></span><span>]</span><span>;</span><span></span></p></pre></div></div></div>
<p>With this, we can change the calculation of <code><span>maxValue</span></code> to take the maximum affecting external value:</p>
<div><div><div><pre><p><span></span><span>const</span><span> maxValue </span><span>=</span><span> Math</span><span>.</span><span>max</span><span>(</span><span>value</span><span>,</span><span> externalSamplingVector</span><span>[</span><span>i</span><span>]</span><span>)</span><span>;</span><span></span></p><p><span></span><span>let</span><span> maxValue </span><span>=</span><span> value</span><span>;</span><span></span></p><p><span></span><span>for</span><span> </span><span>(</span><span>const</span><span> externalIndex </span><span>of</span><span> </span><span>AFFECTING_EXTERNAL_INDICES</span><span>[</span><span>i</span><span>]</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>  maxValue </span><span>=</span><span> Math</span><span>.</span><span>max</span><span>(</span><span>value</span><span>,</span><span> externalSamplingVector</span><span>[</span><span>externalIndex</span><span>]</span><span>)</span><span>;</span><span></span></p><p><span></span><span>}</span><span></span></p></pre></div></div></div>
<p>Now look what happens if the top four external sampling circles are light: it causes the contrast enhancement to reach into the middle of the sampling vector, giving us the desired effect:</p>

<p>We now smoothly transition from <code>! -&gt; : -&gt; .</code> — beautiful stuff!</p>
<p>Let’s see if this change resolves the staircasing effect:</p>

<p>Oh yeah, looks awesome! We get the desired effect. The boundary is nice and sharp while not being too jagged.</p>
<p>Here’s the 3D scene again. The contrast slider now applies both types of contrast enhancement at the same time — try it out:</p>

<p>This really enhances the contrast at boundaries, making the image far more readable!</p>
<p>Together, the 6D shape vector approach and contrast enhancement techniques have given us a really nice final ASCII rendering.</p>
<h2>Final words</h2>
<p>This post was really fun to build and write! I hope you enjoyed reading it.</p>
<p>ASCII rendering is perhaps not the most useful topic to write about, but I think the idea of using a high-dimensional vector to capture shape is interesting and could easily be applied to many other problems. There are parallels to be drawn to <a target="_blank" href="https://en.wikipedia.org/wiki/Word_embedding">word embeddings</a>.</p>
<p>I started writing this ASCII renderer to see if the idea of using a vector to capture the shape of characters would work at all. That approach turned out to work very well, but the initial prototype was terribly slow — I only got single-digit FPS on my iPhone. To get the ASCII renderer running at a smooth <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-67-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path id="MJX-67-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="36" xlink:href="#MJX-67-TEX-N-36"></use><use data-c="30" xlink:href="#MJX-67-TEX-N-30" transform="translate(500,0)"></use></g></g></g></svg></mjx-container> FPS on mobile required a lot of optimization work. I describe some of that optimization work in the appendices on <a target="" href="https://blog.veitheller.de/blog/ascii-rendering#character-lookup-performance">character lookup performance</a> and <a target="" href="https://blog.veitheller.de/blog/ascii-rendering#appendix-gpu-acceleration">GPU acceleration</a> below.</p>
<p>My colleagues, after reading a draft of this post, suggested <em>many</em> alternatives to the approaches I described in this post. For example, why not make the sampling vector <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="5.028ex" height="1.554ex" role="img" focusable="false" viewBox="0 -665 2222.4 687" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-68-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-68-TEX-N-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="33" xlink:href="#MJX-68-TEX-N-33"></use></g><g data-mml-node="mo" transform="translate(722.2,0)"><use data-c="D7" xlink:href="#MJX-68-TEX-N-D7"></use></g><g data-mml-node="mn" transform="translate(1722.4,0)"><use data-c="33" xlink:href="#MJX-68-TEX-N-33"></use></g></g></g></svg></mjx-container>? That would capture the shape of <code>T</code> far better — just look how <code>T</code>’s stem falls between the two sampling circles in each row:</p>

<p>And yeah, he’s right! A <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="5.028ex" height="1.554ex" role="img" focusable="false" viewBox="0 -665 2222.4 687" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-69-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-69-TEX-N-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="33" xlink:href="#MJX-69-TEX-N-33"></use></g><g data-mml-node="mo" transform="translate(722.2,0)"><use data-c="D7" xlink:href="#MJX-69-TEX-N-D7"></use></g><g data-mml-node="mn" transform="translate(1722.4,0)"><use data-c="33" xlink:href="#MJX-69-TEX-N-33"></use></g></g></g></svg></mjx-container> layout would certainly capture it better. They also suggested many alternative approaches to the contrast enhancement methods I described, but I won’t explore those in this post.</p>
<p>It’s really fun how large the solution space to the problem of ASCII rendering is. There are so, so many approaches and trade-offs to explore. I imagine you probably thought of a few yourself while reading this post!</p>
<p>One dimension I intentionally did not explore was using different colors or lightnesses for the ASCII characters themselves. This is for many reasons, but the two primary ones are that 1) it would have expanded the scope of this post too much, and 2) it’s just a different effect, and I personally don’t like the look.<br/></p>
<p>At the time of writing these final words, around <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-70-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="36" xlink:href="#MJX-70-TEX-N-36"></use></g></g></g></svg></mjx-container> months have elapsed since I started working on this post. This has been my longest writing process to date. Much of that can be explained by the birth of my now <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.532ex" role="img" focusable="false" viewBox="0 -677 500 677" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-71-TEX-N-34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="34" xlink:href="#MJX-71-TEX-N-34"></use></g></g></g></svg></mjx-container>-month-old daughter. I’ve needed to be a lot more intentional about finding time to write — and disciplined when spending it. I intend to write some smaller posts next. Let’s see if I manage to stick to that promise.</p>
<p>Thanks for reading! And huge thanks to <a target="_blank" href="https://www.linkedin.com/in/gunnlaugur-briem/">Gunnlaugur Þór Briem</a> and <a target="_blank" href="https://eirikur.dev">Eiríkur Fannar Torfason</a> for reading and providing feedback on a draft of this post.</p>
<p>— Alex Harri</p>
<div><div><p>Mailing list</p><div><p>To be notified of new posts, subscribe to my mailing list.</p></div></div></div>
<div><h2>Appendix I: Character lookup performance</h2></div>
<p>Earlier in this post, I showed how can find the best character by finding the character with the shortest Euclidean distance to our sampling vector.</p>
<div><div><div><pre><p><span>function</span><span> </span><span>findBestCharacter</span><span>(</span><span>inputVector</span><span>:</span><span> </span><span>number</span><span>[</span><span>]</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>  </span><span>let</span><span> bestCharacter </span><span>=</span><span> </span><span>&#34;&#34;</span><span>;</span><span></span></p><p><span>  </span><span>let</span><span> bestDistance </span><span>=</span><span> </span><span>Infinity</span><span>;</span><span></span></p><p><span>  </span><span>for</span><span> </span><span>(</span><span>const</span><span> </span><span>{</span><span> character</span><span>,</span><span> shapeVector </span><span>}</span><span> </span><span>of</span><span> </span><span>CHARACTERS</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>    </span><span>const</span><span> dist </span><span>=</span><span> </span><span>getDistance</span><span>(</span><span>shapeVector</span><span>,</span><span> inputVector</span><span>)</span><span>;</span><span></span></p><p><span>    </span><span>if</span><span> </span><span>(</span><span>dist </span><span>&lt;</span><span> bestDistance</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>      bestDistance </span><span>=</span><span> dist</span><span>;</span><span></span></p><p><span>      bestCharacter </span><span>=</span><span> character</span><span>;</span><span></span></p><p><span>    </span><span>}</span><span></span></p><p><span>  </span><span>}</span><span></span></p><p><span>  </span><span>return</span><span> bestCharacter</span><span>;</span><span></span></p><p><span></span><span>}</span><span></span></p></pre></div></div></div>
<p>I tried benchmarking this for <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.439ex" xmlns="http://www.w3.org/2000/svg" width="7.416ex" height="1.946ex" role="img" focusable="false" viewBox="0 -666 3278 860" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-72-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-72-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-72-TEX-N-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-72-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-72-TEX-N-30" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-72-TEX-N-30" transform="translate(1000,0)"></use><use data-c="2C" xlink:href="#MJX-72-TEX-N-2C" transform="translate(1500,0)"></use><use data-c="30" xlink:href="#MJX-72-TEX-N-30" transform="translate(1778,0)"></use><use data-c="30" xlink:href="#MJX-72-TEX-N-30" transform="translate(2278,0)"></use><use data-c="30" xlink:href="#MJX-72-TEX-N-30" transform="translate(2778,0)"></use></g></g></g></svg></mjx-container> input sampling vectors on my MacBook — <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="3.394ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-73-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-73-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-73-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-73-TEX-N-30" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-73-TEX-N-30" transform="translate(1000,0)"></use></g></g></g></svg></mjx-container>K invocations of this function consistently take about <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="3.394ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-74-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-74-TEX-N-39" d="M352 287Q304 211 232 211Q154 211 104 270T44 396Q42 412 42 436V444Q42 537 111 606Q171 666 243 666Q245 666 249 666T257 665H261Q273 665 286 663T323 651T370 619T413 560Q456 472 456 334Q456 194 396 97Q361 41 312 10T208 -22Q147 -22 108 7T68 93T121 149Q143 149 158 135T173 96Q173 78 164 65T148 49T135 44L131 43Q131 41 138 37T164 27T206 22H212Q272 22 313 86Q352 142 352 280V287ZM244 248Q292 248 321 297T351 430Q351 508 343 542Q341 552 337 562T323 588T293 615T246 625Q208 625 181 598Q160 576 154 546T147 441Q147 358 152 329T172 282Q197 248 244 248Z"></path><path id="MJX-74-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-74-TEX-N-31"></use><use data-c="39" xlink:href="#MJX-74-TEX-N-39" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-74-TEX-N-30" transform="translate(1000,0)"></use></g></g></g></svg></mjx-container>ms. If we want to be able to use this for an animated canvas at <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-75-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path id="MJX-75-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="36" xlink:href="#MJX-75-TEX-N-36"></use><use data-c="30" xlink:href="#MJX-75-TEX-N-30" transform="translate(500,0)"></use></g></g></g></svg></mjx-container> FPS, we only have <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="5.154ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 2278 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-76-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-76-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path id="MJX-76-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-76-TEX-N-31"></use><use data-c="36" xlink:href="#MJX-76-TEX-N-36" transform="translate(500,0)"></use></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(1000,0)"><g data-mml-node="mo"><use data-c="2E" xlink:href="#MJX-76-TEX-N-2E"></use></g></g><g data-mml-node="mn" transform="translate(1278,0)"><use data-c="36" xlink:href="#MJX-76-TEX-N-36"></use><use data-c="36" xlink:href="#MJX-76-TEX-N-36" transform="translate(500,0)"></use></g></g></g></svg></mjx-container>ms to render each frame. We can use this to get a rough budget for how many lookups we can perform each frame:</p>

<p>If we allow ourselves <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.127ex" xmlns="http://www.w3.org/2000/svg" width="4.147ex" height="1.824ex" role="img" focusable="false" viewBox="0 -750 1833 806" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-78-TEX-N-35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path><path id="MJX-78-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-78-TEX-N-25" d="M465 605Q428 605 394 614T340 632T319 641Q332 608 332 548Q332 458 293 403T202 347Q145 347 101 402T56 548Q56 637 101 693T202 750Q241 750 272 719Q359 642 464 642Q580 642 650 732Q662 748 668 749Q670 750 673 750Q682 750 688 743T693 726Q178 -47 170 -52Q166 -56 160 -56Q147 -56 142 -45Q137 -36 142 -27Q143 -24 363 304Q469 462 525 546T581 630Q528 605 465 605ZM207 385Q235 385 263 427T292 548Q292 617 267 664T200 712Q193 712 186 709T167 698T147 668T134 615Q132 595 132 548V527Q132 436 165 403Q183 385 203 385H207ZM500 146Q500 234 544 290T647 347Q699 347 737 292T776 146T737 0T646 -56Q590 -56 545 0T500 146ZM651 -18Q679 -18 707 24T736 146Q736 215 711 262T644 309Q637 309 630 306T611 295T591 265T578 212Q577 200 577 146V124Q577 -18 647 -18H651Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="35" xlink:href="#MJX-78-TEX-N-35"></use><use data-c="30" xlink:href="#MJX-78-TEX-N-30" transform="translate(500,0)"></use></g><g data-mml-node="mi" transform="translate(1000,0)"><use data-c="25" xlink:href="#MJX-78-TEX-N-25"></use></g></g></g></svg></mjx-container> of the performance budget for just lookups, this gives us a budget of about <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.532ex" role="img" focusable="false" viewBox="0 -677 500 677" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-79-TEX-N-34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="34" xlink:href="#MJX-79-TEX-N-34"></use></g></g></g></svg></mjx-container>K characters. Not terrible, but far from great, especially considering that we’re using numbers from a powerful laptop. A mobile device might have a <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-80-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-80-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-80-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-80-TEX-N-30" transform="translate(500,0)"></use></g></g></g></svg></mjx-container> times lower budget. Let’s see how we can improve this.</p>
<h3>k-d trees</h3>
<p><mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.025ex" xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 521 705" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-81-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D458" xlink:href="#MJX-81-TEX-I-1D458"></use></g></g></g></svg></mjx-container>-d trees are a data structure that enables nearest-neighbor lookups in multi-dimensional (<mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.025ex" xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 521 705" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-82-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D458" xlink:href="#MJX-82-TEX-I-1D458"></use></g></g></g></svg></mjx-container>-dimensional) space. Their performance <a target="_blank" href="https://graphics.stanford.edu/~tpurcell/pubs/search.pdf">degrades in higher dimensions</a> (e.g. <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.09ex" xmlns="http://www.w3.org/2000/svg" width="4.651ex" height="1.597ex" role="img" focusable="false" viewBox="0 -666 2055.8 706" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-83-TEX-N-3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"></path><path id="MJX-83-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-83-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><use data-c="3E" xlink:href="#MJX-83-TEX-N-3E"></use></g><g data-mml-node="mn" transform="translate(1055.8,0)"><use data-c="32" xlink:href="#MJX-83-TEX-N-32"></use><use data-c="30" xlink:href="#MJX-83-TEX-N-30" transform="translate(500,0)"></use></g></g></g></svg></mjx-container>), but they perform well in <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-84-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="36" xlink:href="#MJX-84-TEX-N-36"></use></g></g></g></svg></mjx-container> dimensions — perfect for our purpose.</p>
<p>Internally, <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.025ex" xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 521 705" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-85-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D458" xlink:href="#MJX-85-TEX-I-1D458"></use></g></g></g></svg></mjx-container>-d trees are a binary tree where each node is a <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.025ex" xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 521 705" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-86-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D458" xlink:href="#MJX-86-TEX-I-1D458"></use></g></g></g></svg></mjx-container>-dimensional point. Each node can be thought to split the <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.025ex" xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 521 705" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-87-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D458" xlink:href="#MJX-87-TEX-I-1D458"></use></g></g></g></svg></mjx-container>-dimensional space in half with a hyperplane, with the left subtree on one side of the hyperplane and the right subtree on the other.</p>
<div><div><p>I won’t go into much detail on <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.025ex" xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 521 705" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-88-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D458" xlink:href="#MJX-88-TEX-I-1D458"></use></g></g></g></svg></mjx-container>-d trees here. You’ll have to look at other resources if you’re interested in learning more.</p><p>One could also look at the <a target="_blank" href="https://en.wikipedia.org/wiki/Hierarchical_navigable_small_world">hierarchical navigable small worlds</a> (HNSW) algorithm, which <a target="_blank" href="https://eirikur.dev">Eiríkur</a> pointed me to. It is used for approximate nearest neighbor lookups in vector databases, so definitely relevant.</p></div></div>
<p>Let’s see how it performs! We’ll construct a <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.025ex" xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 521 705" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-89-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D458" xlink:href="#MJX-89-TEX-I-1D458"></use></g></g></g></svg></mjx-container>-d tree with our characters and their associated vectors:</p>
<div><div><div><pre><p><span>const</span><span> kdTree </span><span>=</span><span> </span><span>new</span><span> </span><span>KdTree</span><span>(</span><span></span></p><p><span>  </span><span>CHARACTERS</span><span>.</span><span>map</span><span>(</span><span>(</span><span>{</span><span> character</span><span>,</span><span> shapeVector </span><span>}</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>(</span><span>{</span><span></span></p><p><span>    point</span><span>:</span><span> shapeVector</span><span>,</span><span></span></p><p><span>    data</span><span>:</span><span> character</span><span>,</span><span></span></p><p><span>  </span><span>}</span><span>)</span><span>)</span><span></span></p><p><span></span><span>)</span><span>;</span><span></span></p></pre></div></div></div>
<p>We can now perform nearest-neighbor lookups on the <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.025ex" xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 521 705" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-90-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D458" xlink:href="#MJX-90-TEX-I-1D458"></use></g></g></g></svg></mjx-container>-d tree:</p>
<div><div><div><pre><p><span>const</span><span> result </span><span>=</span><span> kdTree</span><span>.</span><span>findNearest</span><span>(</span><span>samplingVector</span><span>)</span><span>;</span><span></span></p></pre></div></div></div>
<p>Running <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="3.394ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-91-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-91-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-91-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-91-TEX-N-30" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-91-TEX-N-30" transform="translate(1000,0)"></use></g></g></g></svg></mjx-container>K such lookups takes about <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-92-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="36" xlink:href="#MJX-92-TEX-N-36"></use><use data-c="36" xlink:href="#MJX-92-TEX-N-36" transform="translate(500,0)"></use></g></g></g></svg></mjx-container>ms on my MacBook. That’s about <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.554ex" role="img" focusable="false" viewBox="0 -665 500 687" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-93-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="33" xlink:href="#MJX-93-TEX-N-33"></use></g></g></g></svg></mjx-container>x faster than the brute-force approach. We can use this to calculate, roughly, the number of lookups we can perform per frame:</p>

<p>That’s a lot of lookups per frame, but again, we’re benchmarking on a powerful machine. This is still not good enough.</p>
<p>Let’s see how we can eke out even more performance.</p>
<h3>Caching</h3>
<p>An obvious avenue for speeding up lookups is to cache the result:</p>
<div><div><div><pre><p><span>function</span><span> </span><span>searchCached</span><span>(</span><span>samplingVector</span><span>:</span><span> </span><span>number</span><span>[</span><span>]</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>  </span><span>const</span><span> key </span><span>=</span><span> </span><span>generateCacheKey</span><span>(</span><span>samplingVector</span><span>)</span><span></span></p><p><span>  </span><span>if</span><span> </span><span>(</span><span>cache</span><span>.</span><span>has</span><span>(</span><span>key</span><span>)</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>    </span><span>return</span><span> cache</span><span>.</span><span>get</span><span>(</span><span>key</span><span>)</span><span>!</span><span>;</span><span></span></p><p><span>  </span><span>}</span><span></span></p><p><span>  </span><span>const</span><span> result </span><span>=</span><span> </span><span>search</span><span>(</span><span>samplingVector</span><span>)</span><span>;</span><span></span></p><p><span>  cache</span><span>.</span><span>set</span><span>(</span><span>key</span><span>,</span><span> result</span><span>)</span><span>;</span><span></span></p><p><span>  </span><span>return</span><span> result</span><span>;</span><span></span></p><p><span></span><span>}</span><span></span></p></pre></div></div></div>
<p>But how does one generate a cache key for a <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-95-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="36" xlink:href="#MJX-95-TEX-N-36"></use></g></g></g></svg></mjx-container>-dimensional vector?</p>
<p>Well, one way is to quantize each vector component so that it fits into a set number of bits and packing those bits into a single number. JavaScript numbers give us <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-96-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-96-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="33" xlink:href="#MJX-96-TEX-N-33"></use><use data-c="32" xlink:href="#MJX-96-TEX-N-32" transform="translate(500,0)"></use></g></g></g></svg></mjx-container> bits to work with, so each vector component gets <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-97-TEX-N-35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="35" xlink:href="#MJX-97-TEX-N-35"></use></g></g></g></svg></mjx-container> bits.</p>
<p>We can quantize a numeric value between <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-98-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-98-TEX-N-30"></use></g></g></g></svg></mjx-container> and <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 500 666" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-99-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-99-TEX-N-31"></use></g></g></g></svg></mjx-container> to the range <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-100-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-100-TEX-N-30"></use></g></g></g></svg></mjx-container> to <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-101-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-101-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="33" xlink:href="#MJX-101-TEX-N-33"></use><use data-c="31" xlink:href="#MJX-101-TEX-N-31" transform="translate(500,0)"></use></g></g></g></svg></mjx-container> (the most that <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-102-TEX-N-35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="35" xlink:href="#MJX-102-TEX-N-35"></use></g></g></g></svg></mjx-container> bits can store) like so:</p>
<div><div><div><pre><p><span>const</span><span> </span><span>BITS</span><span> </span><span>=</span><span> </span><span>5</span><span>;</span><span></span></p><p><span></span><span>const</span><span> </span><span>RANGE</span><span> </span><span>=</span><span> </span><span>2</span><span> </span><span>**</span><span> </span><span>BITS</span><span>;</span><span></span></p><p><span></span><span>function</span><span> </span><span>quantizeTo5Bits</span><span>(</span><span>value</span><span>:</span><span> </span><span>number</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>  </span><span>return</span><span> Math</span><span>.</span><span>min</span><span>(</span><span>RANGE</span><span> </span><span>-</span><span> </span><span>1</span><span>,</span><span> Math</span><span>.</span><span>floor</span><span>(</span><span>value </span><span>*</span><span> </span><span>RANGE</span><span>)</span><span>)</span><span>;</span><span></span></p><p><span></span><span>}</span><span></span></p></pre></div></div></div>
<p>Applying a max of <code><span>RANGE</span><span> </span><span>-</span><span> </span><span>1</span></code> is done so that a <code><span>value</span></code> of exactly <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 500 666" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-103-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-103-TEX-N-31"></use></g></g></g></svg></mjx-container> is mapped to <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-104-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-104-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="33" xlink:href="#MJX-104-TEX-N-33"></use><use data-c="31" xlink:href="#MJX-104-TEX-N-31" transform="translate(500,0)"></use></g></g></g></svg></mjx-container> instead of <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-105-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-105-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="33" xlink:href="#MJX-105-TEX-N-33"></use><use data-c="32" xlink:href="#MJX-105-TEX-N-32" transform="translate(500,0)"></use></g></g></g></svg></mjx-container>.</p>
<p>We can quantize each of the sampling vector components in this manner and use bit shifting to pack all of the quantized values into a single number like so:</p>
<div><div><div><pre><p><span>const</span><span> </span><span>BITS</span><span> </span><span>=</span><span> </span><span>5</span><span>;</span><span></span></p><p><span></span><span>const</span><span> </span><span>RANGE</span><span> </span><span>=</span><span> </span><span>2</span><span> </span><span>**</span><span> </span><span>BITS</span><span>;</span><span></span></p><p><span></span><span>function</span><span> </span><span>generateCacheKey</span><span>(</span><span>vector</span><span>:</span><span> </span><span>number</span><span>[</span><span>]</span><span>)</span><span>:</span><span> </span><span>number</span><span> </span><span>{</span><span></span></p><p><span>  </span><span>let</span><span> key </span><span>=</span><span> </span><span>0</span><span>;</span><span></span></p><p><span>  </span><span>for</span><span> </span><span>(</span><span>let</span><span> i </span><span>=</span><span> </span><span>0</span><span>;</span><span> i </span><span>&lt;</span><span> vector</span><span>.</span><span>length</span><span>;</span><span> i</span><span>++</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>    </span><span>const</span><span> quantized </span><span>=</span><span> Math</span><span>.</span><span>min</span><span>(</span><span>RANGE</span><span> </span><span>-</span><span> </span><span>1</span><span>,</span><span> Math</span><span>.</span><span>floor</span><span>(</span><span>vector</span><span>[</span><span>i</span><span>]</span><span> </span><span>*</span><span> </span><span>RANGE</span><span>)</span><span>)</span><span>;</span><span></span></p><p><span>    key </span><span>=</span><span> </span><span>(</span><span>key </span><span>&lt;&lt;</span><span> </span><span>BITS</span><span>)</span><span> </span><span>|</span><span> quantized</span><span>;</span><span></span></p><p><span>  </span><span>}</span><span></span></p><p><span>  </span><span>return</span><span> key</span><span>;</span><span></span></p><p><span></span><span>}</span><span></span></p></pre></div></div></div>
<p>The <code><span>RANGE</span></code> is current set to <code><span>2</span><span> </span><span>**</span><span> </span><span>5</span></code>, but consider how large that makes our key space. Each vector component is one of <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-106-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-106-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="33" xlink:href="#MJX-106-TEX-N-33"></use><use data-c="32" xlink:href="#MJX-106-TEX-N-32" transform="translate(500,0)"></use></g></g></g></svg></mjx-container> possible values. With <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-107-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="36" xlink:href="#MJX-107-TEX-N-36"></use></g></g></g></svg></mjx-container> vector components, that makes the total number of possible keys <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="3.25ex" height="2.005ex" role="img" focusable="false" viewBox="0 -864 1436.6 886" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-108-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-108-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-108-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="33" xlink:href="#MJX-108-TEX-N-33"></use><use data-c="32" xlink:href="#MJX-108-TEX-N-32" transform="translate(500,0)"></use></g><g data-mml-node="mn" transform="translate(1033,393.1) scale(0.707)"><use data-c="36" xlink:href="#MJX-108-TEX-N-36"></use></g></g></g></g></svg></mjx-container>, which equals <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.439ex" xmlns="http://www.w3.org/2000/svg" width="13.199ex" height="1.971ex" role="img" focusable="false" viewBox="0 -677 5834 871" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-109-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-109-TEX-N-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path id="MJX-109-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-109-TEX-N-37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z"></path><path id="MJX-109-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-109-TEX-N-34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path><path id="MJX-109-TEX-N-38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z"></path><path id="MJX-109-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-109-TEX-N-31"></use><use data-c="2C" xlink:href="#MJX-109-TEX-N-2C" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-109-TEX-N-30" transform="translate(778,0)"></use><use data-c="37" xlink:href="#MJX-109-TEX-N-37" transform="translate(1278,0)"></use><use data-c="33" xlink:href="#MJX-109-TEX-N-33" transform="translate(1778,0)"></use><use data-c="2C" xlink:href="#MJX-109-TEX-N-2C" transform="translate(2278,0)"></use><use data-c="37" xlink:href="#MJX-109-TEX-N-37" transform="translate(2556,0)"></use><use data-c="34" xlink:href="#MJX-109-TEX-N-34" transform="translate(3056,0)"></use><use data-c="31" xlink:href="#MJX-109-TEX-N-31" transform="translate(3556,0)"></use><use data-c="2C" xlink:href="#MJX-109-TEX-N-2C" transform="translate(4056,0)"></use><use data-c="38" xlink:href="#MJX-109-TEX-N-38" transform="translate(4334,0)"></use><use data-c="32" xlink:href="#MJX-109-TEX-N-32" transform="translate(4834,0)"></use><use data-c="34" xlink:href="#MJX-109-TEX-N-34" transform="translate(5334,0)"></use></g></g></g></svg></mjx-container>. If the cache were to be fully saturated, just storing the keys would take <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-110-TEX-N-38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="38" xlink:href="#MJX-110-TEX-N-38"></use></g></g></g></svg></mjx-container>GB of memory! I’d also expect the cache hit rate to be incredibly low if we were to lazily fill the cache.</p>
<p>Alright, <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-111-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-111-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="33" xlink:href="#MJX-111-TEX-N-33"></use><use data-c="32" xlink:href="#MJX-111-TEX-N-32" transform="translate(500,0)"></use></g></g></g></svg></mjx-container> is too high, but what value should we pick? We can pick any number under <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-112-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-112-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="33" xlink:href="#MJX-112-TEX-N-33"></use><use data-c="32" xlink:href="#MJX-112-TEX-N-32" transform="translate(500,0)"></use></g></g></g></svg></mjx-container> for our range. To help, here’s a table showing the number of possible keys (and the memory needed to store them) for range values between <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-113-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="36" xlink:href="#MJX-113-TEX-N-36"></use></g></g></g></svg></mjx-container> and <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 1000 666" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-114-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-114-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-114-TEX-N-31"></use><use data-c="32" xlink:href="#MJX-114-TEX-N-32" transform="translate(500,0)"></use></g></g></g></svg></mjx-container>:</p>
<table><tbody><tr><th>Range</th><th>Number of keys</th><th>Memory needed to store keys</th></tr><tr><td>6</td><td>46,656</td><td>364 KB</td></tr><tr><td>7</td><td>117,649</td><td>919 KB</td></tr><tr><td>8</td><td>262,144</td><td>2.00 MB</td></tr><tr><td>9</td><td>531,441</td><td>4.05 MB</td></tr><tr><td>10</td><td>1,000,000</td><td>7.63 MB</td></tr><tr><td>11</td><td>1,771,561</td><td>13.52 MB</td></tr><tr><td>12</td><td>2,985,984</td><td>22.78 MB</td></tr></tbody></table>
<p>There are trade-offs to consider here. As the range gets smaller, the quality of the results drops. If we pick a range of <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-115-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="36" xlink:href="#MJX-115-TEX-N-36"></use></g></g></g></svg></mjx-container>, for example, the only possible lightness values are <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-116-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-116-TEX-N-30"></use></g></g></g></svg></mjx-container>, <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.891ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1278 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-117-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-117-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-117-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-117-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-117-TEX-N-2E" transform="translate(500,0)"></use><use data-c="32" xlink:href="#MJX-117-TEX-N-32" transform="translate(778,0)"></use></g></g></g></svg></mjx-container>, <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.891ex" height="1.581ex" role="img" focusable="false" viewBox="0 -677 1278 699" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-118-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-118-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-118-TEX-N-34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-118-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-118-TEX-N-2E" transform="translate(500,0)"></use><use data-c="34" xlink:href="#MJX-118-TEX-N-34" transform="translate(778,0)"></use></g></g></g></svg></mjx-container>, <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.891ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1278 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-119-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-119-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-119-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-119-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-119-TEX-N-2E" transform="translate(500,0)"></use><use data-c="36" xlink:href="#MJX-119-TEX-N-36" transform="translate(778,0)"></use></g></g></g></svg></mjx-container>, <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.891ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1278 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-120-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-120-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-120-TEX-N-38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-120-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-120-TEX-N-2E" transform="translate(500,0)"></use><use data-c="38" xlink:href="#MJX-120-TEX-N-38" transform="translate(778,0)"></use></g></g></g></svg></mjx-container> and <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 500 666" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-121-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-121-TEX-N-31"></use></g></g></g></svg></mjx-container>. That noticeably affects the quality of character picks.</p>
<p>At the same time, if we increase the possible number of keys, we need more memory to store them. Additionally, the cache hit rate might be very low, especially when the cache is relatively empty.</p>
<p>I ended up picking a range of <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-122-TEX-N-38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="38" xlink:href="#MJX-122-TEX-N-38"></use></g></g></g></svg></mjx-container>. It’s a large enough range that quality doesn’t suffer too much while keeping the cache size reasonably low.</p>
<p>Cached lookups are incredibly fast — fast enough that lookup performance just isn’t a concern anymore (<mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="3.394ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-123-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-123-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-123-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-123-TEX-N-30" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-123-TEX-N-30" transform="translate(1000,0)"></use></g></g></g></svg></mjx-container>K lookups take a few ms on my MacBook). And if we prepopulate the cache, we can expect consistently fast performance, though I encountered no problems just lazily populating the cache.</p>
<div><h2>Appendix II: GPU acceleration</h2></div>
<p>Lookups were not the only performance concern. Just collecting the sampling vectors (internal and external) turned out to be terribly expensive.</p>
<p>Just consider the sheer amount of samples that need to be collected. The 3D scene I’ve been using as an example uses a <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="8.422ex" height="1.581ex" role="img" focusable="false" viewBox="0 -677 3722.4 699" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-124-TEX-N-34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path><path id="MJX-124-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-124-TEX-N-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path><path id="MJX-124-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-124-TEX-N-37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="34" xlink:href="#MJX-124-TEX-N-34"></use><use data-c="31" xlink:href="#MJX-124-TEX-N-31" transform="translate(500,0)"></use></g><g data-mml-node="mo" transform="translate(1222.2,0)"><use data-c="D7" xlink:href="#MJX-124-TEX-N-D7"></use></g><g data-mml-node="mn" transform="translate(2222.4,0)"><use data-c="31" xlink:href="#MJX-124-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-124-TEX-N-30" transform="translate(500,0)"></use><use data-c="37" xlink:href="#MJX-124-TEX-N-37" transform="translate(1000,0)"></use></g></g></g></svg></mjx-container> grid, which equals <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.439ex" xmlns="http://www.w3.org/2000/svg" width="5.154ex" height="1.971ex" role="img" focusable="false" viewBox="0 -677 2278 871" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-125-TEX-N-34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path><path id="MJX-125-TEX-N-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path id="MJX-125-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-125-TEX-N-38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z"></path><path id="MJX-125-TEX-N-37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="34" xlink:href="#MJX-125-TEX-N-34"></use><use data-c="2C" xlink:href="#MJX-125-TEX-N-2C" transform="translate(500,0)"></use><use data-c="33" xlink:href="#MJX-125-TEX-N-33" transform="translate(778,0)"></use><use data-c="38" xlink:href="#MJX-125-TEX-N-38" transform="translate(1278,0)"></use><use data-c="37" xlink:href="#MJX-125-TEX-N-37" transform="translate(1778,0)"></use></g></g></g></svg></mjx-container> cells. For each of those cells, we compute a <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 500 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-126-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="36" xlink:href="#MJX-126-TEX-N-36"></use></g></g></g></svg></mjx-container>-dimensional sampling vector and a <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 1000 688" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-127-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-127-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-127-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-127-TEX-N-30" transform="translate(500,0)"></use></g></g></g></svg></mjx-container>-dimensional external sampling vector. That is more than <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.05ex" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.579ex" role="img" focusable="false" viewBox="0 -676 1000 698" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-128-TEX-N-37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z"></path><path id="MJX-128-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="37" xlink:href="#MJX-128-TEX-N-37"></use><use data-c="30" xlink:href="#MJX-128-TEX-N-30" transform="translate(500,0)"></use></g></g></g></svg></mjx-container>K vector components to compute on every frame!</p>

<p>And that’s if we use a sampling quality of <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:0" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 500 666" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-130-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-130-TEX-N-31"></use></g></g></g></svg></mjx-container>. If we increase the sampling quality, this number just gets bigger.</p>
<p>Collecting these samples absolutely <em>crushed</em> performance on my iPhone, so I needed to either collect fewer samples or speed up the collection of samples. Collecting fewer samples would have meant rendering fewer ASCII characters or removing the directional contrast enhancement, neither of which was an appealing solution.</p>
<p>My initial implementation ran on the CPU, which could only collect one sample at a time. To speed this up, I moved the work of sampling collection and applying the contrast enhancement to the GPU. The pipeline for that looks like so (each of the steps listed is a single shader pass):</p>
<ol>
<li>Collect the raw internal sampling vectors into a <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.025ex" xmlns="http://www.w3.org/2000/svg" width="24.746ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 10937.9 705" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-131-TEX-N-63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z"></path><path id="MJX-131-TEX-N-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path><path id="MJX-131-TEX-N-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path><path id="MJX-131-TEX-N-73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z"></path><path id="MJX-131-TEX-N-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path><path id="MJX-131-TEX-N-72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z"></path><path id="MJX-131-TEX-N-77" d="M90 368Q84 378 76 380T40 385H18V431H24L43 430Q62 430 84 429T116 428Q206 428 221 431H229V385H215Q177 383 177 368Q177 367 221 239L265 113L339 328L333 345Q323 374 316 379Q308 384 278 385H258V431H264Q270 428 348 428Q439 428 454 431H461V385H452Q404 385 404 369Q404 366 418 324T449 234T481 143L496 100L537 219Q579 341 579 347Q579 363 564 373T530 385H522V431H529Q541 428 624 428Q692 428 698 431H703V385H697Q696 385 691 385T682 384Q635 377 619 334L559 161Q546 124 528 71Q508 12 503 1T487 -11H479Q460 -11 456 -4Q455 -3 407 133L361 267Q359 263 266 -4Q261 -11 243 -11H238Q225 -11 220 -3L90 368Z"></path><path id="MJX-131-TEX-N-6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"></path><path id="MJX-131-TEX-N-75" d="M383 58Q327 -10 256 -10H249Q124 -10 105 89Q104 96 103 226Q102 335 102 348T96 369Q86 385 36 385H25V408Q25 431 27 431L38 432Q48 433 67 434T105 436Q122 437 142 438T172 441T184 442H187V261Q188 77 190 64Q193 49 204 40Q224 26 264 26Q290 26 311 35T343 58T363 90T375 120T379 144Q379 145 379 161T380 201T380 248V315Q380 361 370 372T320 385H302V431Q304 431 378 436T457 442H464V264Q464 84 465 81Q468 61 479 55T524 46H542V0Q540 0 467 -5T390 -11H383V58Z"></path><path id="MJX-131-TEX-N-6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"></path><path id="MJX-131-TEX-N-20" d=""></path><path id="MJX-131-TEX-N-69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z"></path><path id="MJX-131-TEX-N-65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mtext"><use data-c="63" xlink:href="#MJX-131-TEX-N-63"></use><use data-c="6F" xlink:href="#MJX-131-TEX-N-6F" transform="translate(444,0)"></use><use data-c="6C" xlink:href="#MJX-131-TEX-N-6C" transform="translate(944,0)"></use><use data-c="73" xlink:href="#MJX-131-TEX-N-73" transform="translate(1222,0)"></use></g><g data-mml-node="mo" transform="translate(1838.2,0)"><use data-c="D7" xlink:href="#MJX-131-TEX-N-D7"></use></g><g data-mml-node="mtext" transform="translate(2838.4,0)"><use data-c="72" xlink:href="#MJX-131-TEX-N-72"></use><use data-c="6F" xlink:href="#MJX-131-TEX-N-6F" transform="translate(392,0)"></use><use data-c="77" xlink:href="#MJX-131-TEX-N-77" transform="translate(892,0)"></use><use data-c="73" xlink:href="#MJX-131-TEX-N-73" transform="translate(1614,0)"></use></g><g data-mml-node="mo" transform="translate(5068.7,0)"><use data-c="D7" xlink:href="#MJX-131-TEX-N-D7"></use></g><g data-mml-node="mtext" transform="translate(6068.9,0)"><use data-c="6E" xlink:href="#MJX-131-TEX-N-6E"></use><use data-c="75" xlink:href="#MJX-131-TEX-N-75" transform="translate(556,0)"></use><use data-c="6D" xlink:href="#MJX-131-TEX-N-6D" transform="translate(1112,0)"></use><use data-c="20" xlink:href="#MJX-131-TEX-N-20" transform="translate(1945,0)"></use><use data-c="63" xlink:href="#MJX-131-TEX-N-63" transform="translate(2195,0)"></use><use data-c="69" xlink:href="#MJX-131-TEX-N-69" transform="translate(2639,0)"></use><use data-c="72" xlink:href="#MJX-131-TEX-N-72" transform="translate(2917,0)"></use><use data-c="63" xlink:href="#MJX-131-TEX-N-63" transform="translate(3309,0)"></use><use data-c="6C" xlink:href="#MJX-131-TEX-N-6C" transform="translate(3753,0)"></use><use data-c="65" xlink:href="#MJX-131-TEX-N-65" transform="translate(4031,0)"></use><use data-c="73" xlink:href="#MJX-131-TEX-N-73" transform="translate(4475,0)"></use></g></g></g></svg></mjx-container> texture, using the canvas (image) as the input texture.</li>
<li>Do the same for the external sampling vectors.</li>
<li>Calculate the maximum external value affecting each internal vector component into a <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.025ex" xmlns="http://www.w3.org/2000/svg" width="24.746ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 10937.9 705" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-132-TEX-N-63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z"></path><path id="MJX-132-TEX-N-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path><path id="MJX-132-TEX-N-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path><path id="MJX-132-TEX-N-73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z"></path><path id="MJX-132-TEX-N-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path><path id="MJX-132-TEX-N-72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z"></path><path id="MJX-132-TEX-N-77" d="M90 368Q84 378 76 380T40 385H18V431H24L43 430Q62 430 84 429T116 428Q206 428 221 431H229V385H215Q177 383 177 368Q177 367 221 239L265 113L339 328L333 345Q323 374 316 379Q308 384 278 385H258V431H264Q270 428 348 428Q439 428 454 431H461V385H452Q404 385 404 369Q404 366 418 324T449 234T481 143L496 100L537 219Q579 341 579 347Q579 363 564 373T530 385H522V431H529Q541 428 624 428Q692 428 698 431H703V385H697Q696 385 691 385T682 384Q635 377 619 334L559 161Q546 124 528 71Q508 12 503 1T487 -11H479Q460 -11 456 -4Q455 -3 407 133L361 267Q359 263 266 -4Q261 -11 243 -11H238Q225 -11 220 -3L90 368Z"></path><path id="MJX-132-TEX-N-6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"></path><path id="MJX-132-TEX-N-75" d="M383 58Q327 -10 256 -10H249Q124 -10 105 89Q104 96 103 226Q102 335 102 348T96 369Q86 385 36 385H25V408Q25 431 27 431L38 432Q48 433 67 434T105 436Q122 437 142 438T172 441T184 442H187V261Q188 77 190 64Q193 49 204 40Q224 26 264 26Q290 26 311 35T343 58T363 90T375 120T379 144Q379 145 379 161T380 201T380 248V315Q380 361 370 372T320 385H302V431Q304 431 378 436T457 442H464V264Q464 84 465 81Q468 61 479 55T524 46H542V0Q540 0 467 -5T390 -11H383V58Z"></path><path id="MJX-132-TEX-N-6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"></path><path id="MJX-132-TEX-N-20" d=""></path><path id="MJX-132-TEX-N-69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z"></path><path id="MJX-132-TEX-N-65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mtext"><use data-c="63" xlink:href="#MJX-132-TEX-N-63"></use><use data-c="6F" xlink:href="#MJX-132-TEX-N-6F" transform="translate(444,0)"></use><use data-c="6C" xlink:href="#MJX-132-TEX-N-6C" transform="translate(944,0)"></use><use data-c="73" xlink:href="#MJX-132-TEX-N-73" transform="translate(1222,0)"></use></g><g data-mml-node="mo" transform="translate(1838.2,0)"><use data-c="D7" xlink:href="#MJX-132-TEX-N-D7"></use></g><g data-mml-node="mtext" transform="translate(2838.4,0)"><use data-c="72" xlink:href="#MJX-132-TEX-N-72"></use><use data-c="6F" xlink:href="#MJX-132-TEX-N-6F" transform="translate(392,0)"></use><use data-c="77" xlink:href="#MJX-132-TEX-N-77" transform="translate(892,0)"></use><use data-c="73" xlink:href="#MJX-132-TEX-N-73" transform="translate(1614,0)"></use></g><g data-mml-node="mo" transform="translate(5068.7,0)"><use data-c="D7" xlink:href="#MJX-132-TEX-N-D7"></use></g><g data-mml-node="mtext" transform="translate(6068.9,0)"><use data-c="6E" xlink:href="#MJX-132-TEX-N-6E"></use><use data-c="75" xlink:href="#MJX-132-TEX-N-75" transform="translate(556,0)"></use><use data-c="6D" xlink:href="#MJX-132-TEX-N-6D" transform="translate(1112,0)"></use><use data-c="20" xlink:href="#MJX-132-TEX-N-20" transform="translate(1945,0)"></use><use data-c="63" xlink:href="#MJX-132-TEX-N-63" transform="translate(2195,0)"></use><use data-c="69" xlink:href="#MJX-132-TEX-N-69" transform="translate(2639,0)"></use><use data-c="72" xlink:href="#MJX-132-TEX-N-72" transform="translate(2917,0)"></use><use data-c="63" xlink:href="#MJX-132-TEX-N-63" transform="translate(3309,0)"></use><use data-c="6C" xlink:href="#MJX-132-TEX-N-6C" transform="translate(3753,0)"></use><use data-c="65" xlink:href="#MJX-132-TEX-N-65" transform="translate(4031,0)"></use><use data-c="73" xlink:href="#MJX-132-TEX-N-73" transform="translate(4475,0)"></use></g></g></g></svg></mjx-container> texture.</li>
<li>Apply directional contrast enhancement to each sampling vector component, using the maximum external values texture.</li>
<li>Calculate the maximum value for each internal sampling vector into a <mjx-container classname="MathJax" jax="SVG"><svg style="vertical-align:-0.025ex" xmlns="http://www.w3.org/2000/svg" width="10.965ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 4846.4 705" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-133-TEX-N-63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z"></path><path id="MJX-133-TEX-N-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path><path id="MJX-133-TEX-N-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path><path id="MJX-133-TEX-N-73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z"></path><path id="MJX-133-TEX-N-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path><path id="MJX-133-TEX-N-72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z"></path><path id="MJX-133-TEX-N-77" d="M90 368Q84 378 76 380T40 385H18V431H24L43 430Q62 430 84 429T116 428Q206 428 221 431H229V385H215Q177 383 177 368Q177 367 221 239L265 113L339 328L333 345Q323 374 316 379Q308 384 278 385H258V431H264Q270 428 348 428Q439 428 454 431H461V385H452Q404 385 404 369Q404 366 418 324T449 234T481 143L496 100L537 219Q579 341 579 347Q579 363 564 373T530 385H522V431H529Q541 428 624 428Q692 428 698 431H703V385H697Q696 385 691 385T682 384Q635 377 619 334L559 161Q546 124 528 71Q508 12 503 1T487 -11H479Q460 -11 456 -4Q455 -3 407 133L361 267Q359 263 266 -4Q261 -11 243 -11H238Q225 -11 220 -3L90 368Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mtext"><use data-c="63" xlink:href="#MJX-133-TEX-N-63"></use><use data-c="6F" xlink:href="#MJX-133-TEX-N-6F" transform="translate(444,0)"></use><use data-c="6C" xlink:href="#MJX-133-TEX-N-6C" transform="translate(944,0)"></use><use data-c="73" xlink:href="#MJX-133-TEX-N-73" transform="translate(1222,0)"></use></g><g data-mml-node="mo" transform="translate(1838.2,0)"><use data-c="D7" xlink:href="#MJX-133-TEX-N-D7"></use></g><g data-mml-node="mtext" transform="translate(2838.4,0)"><use data-c="72" xlink:href="#MJX-133-TEX-N-72"></use><use data-c="6F" xlink:href="#MJX-133-TEX-N-6F" transform="translate(392,0)"></use><use data-c="77" xlink:href="#MJX-133-TEX-N-77" transform="translate(892,0)"></use><use data-c="73" xlink:href="#MJX-133-TEX-N-73" transform="translate(1614,0)"></use></g></g></g></svg></mjx-container> texture.</li>
<li>Apply global contrast enhancement to each sampling vector component, using the maximum internal values texture.</li>
</ol>
<p>I’m glossing over the details because I could spend a whole other post covering them, but moving work to the GPU made the renderer many times more performant than it was when everything ran on the CPU.</p><div><div><p>Mailing list</p><div><p>To be notified of new posts, subscribe to my mailing list.</p></div></div></div></main></div></div>
  </body>
</html>
