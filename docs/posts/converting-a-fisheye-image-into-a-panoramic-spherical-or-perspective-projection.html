<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://paulbourke.net/dome/fish2/">Original</a>
    <h1>Converting a fisheye image into a panoramic, spherical or perspective projection</h1>
    
    <div id="readability-page-1" class="page"><div><div>


<center>

Written by <a href="https://squidarth.com/productivity/2022/08/">Paul Bourke</a></center>
<p>
<i>The source code implementing the projections below is only available
on request for a small fee. It includes a demo application and an invitation to
convert an image of your choice to verify the code does what you seek. 
For more information please contact the <a href="https://squidarth.com/productivity/2022/">author</a>.</i>
</p>
<b>See also:
</b><ul><b>
</b><li><b><a href="https://squidarth.com/productivity/2022/08/dualfish2sphere/">
Converting a pair of fisheye images to a 360 equirectangular panorama</a></b>.
</li>
<li><a href="https://squidarth.com/productivity/2022/08/29/instructions.pdf">Instructions for measuring fisheye center and radius, required
if the fisheye is from a real camera sensor</a>
</li>
<li><a href="https://squidarth.com/productivity/2022/08/fisheyecorrect/">Applying correction to convert a real fisheye to an idealised fisheye</a>
</li>
</ul>
<p>

<b>Index</b></p><dd>
<a href="#1">Fisheye to perspective transformation</a><p>
<a href="#2">Front fisheye to panorama (superceeded)</a></p><p>
<a href="#3">Fisheye to (partial) spherical projection</a></p><p>
<a href="#4">Fisheye to (full) panorama</a></p><p>
<a href="#5">Fisheye to cube maps</a></p></dd>

<p>
The following documents various transformations from fisheye into other projection
types, specifically standard perspective as per a pinhole camera, panorama and
spherical projections.
Fisheye images capture a wide field of view, traditionally one thinks of 180
degrees but the mathematical definition extends past that and indeed there are
many physical fisheye lenses that extend past 180 degrees. The two main applications
for the following are: the inspection of images/video from security cameras where
panorama or perspective views may be more natural to view, creating panorama or
spherical images that are blended together to form even wider field of view images.
</p>

<p>
The general options for the software include the dimensions of the output image as well
as the field of view of the output panoramic or perspective frustum. Some other
requirements arise from imperfect fisheye capture such as the fisheye not
being centered on the input image, the fisheye not be aligned with the
intended axis, and the fisheye being of any angle.
Another characteristic of real fisheye images is their lack of linearity
with radius on the image, while this is not addressed here as it requires
a lens calibration, it is a straightforward correction to make.
</p>

<p>
The usual approach for such image transformations is to perform the inverse mapping. That
is, one needs to consider each pixel in the output image and map backwards to
find the closest pixel in the input image (fisheye). In this way every pixel
in the output image is found (compared to a forward mapping), it also means
that the performance is governed by the resolution of the output image
(and supersampling) irrespective of the size of the input image.
A key aspect of these mappings is also to perform some sort of antialiasing, the
solutions here use a simple supersampling approach.
</p>

<p>
The code here are all plain vanilla C tested on Unix style gcc systems (specifically Mac and Linux),
but the algorithms/code can readily be modified for other
operating systems and programming languages.
This is not meant to be a final application but rather something you integrate into your code base. 
Having said that it is wrapped up in a simple TGA image reader/writer for the purposes of algorithm 
testing, the intent is that one would be implementing the function into ones own code base. 
They all operate on a RGB buffer (fisheye image) in memory.
For each test utility the usage message is provided. The source images for the examples
provided are provided along with the command line that generated them.
</p>


<h3>Fisheye to perspective transformation</h3>
<b>Software:</b> fish2persp<pre>Usage: fish2persp [options] fisheyeimage
Options
   -w n        perspective image width, default = 800
   -h n        perspective image height, default = 600
   -t n        field of view of perspective (degrees), default = 100
   -s n        field of view of fisheye (degrees), default = 180
   -c x y      center of the fisheye image, default is center of image
   -r n        fisheye radius (horizontal), default is half width of fisheye image
   -ry n       fisheye radius (vertical) for anamophic lens, default is circular fisheye
   -x n        tilt angle (degrees), default: 0
   -y n        roll angle (degrees), default: 0
   -z n        pan angle (degrees), default: 0
   -a n        antialiasing level, default = 2
   -p n n n n  4th order lens correction, default: off
   -d          verbose mode, default: off
</pre>
<p>
It should be noted at the outset that a fisheye projection is not a &#34;distorted&#34; image, 
and the process isn&#39;t a &#34;dewarping&#34;. 
A fisheye like other projections is one of many ways of mapping a 3D world onto a 2D plane,  it is no 
more or less &#34;distorted&#34; than other projections including a rectangular perspective projection ... 
it is what it is.
</p>

<p>
Example source fisheye image.
</p>
<center>
	<img src="https://squidarth.com/productivity/2022/08/29/fisheye.jpg" width="800" height="533"/>
</center><p>
A critical consideration is antialiasing, required when sampling 
any discrete signal. The approach here is a simple supersampling antialiasing, 
that is,
each pixel in the output image is subdivided into a 2x2, 3x3....grid and
the inverse mapping applied to the subsamples. The final value for the output
pixel is the weighted average of the inverse mapped subsamples.
There is a sense in which the image plane is considered to be a continuous
function. Since the number of samples that are inverse mapped 
is the principle determinant of
performance, high levels of antialiasing can be very expensive, typically
2x2 or 3x3 are sufficient especially for images captured from video in which
neighbouring pixels are not independent in the first place.
For example a 3x3 antialiasing is 9 times slower than no antialiasing.
In general the jagged edges are more noticeable in features
with a sharp colour/intensity boundary.
</p>

<p>
Default perspective view looking forwards, 100 degrees horizontal field of view.
</p>
<center>
<img src="https://squidarth.com/productivity/2022/08/29/persp1.jpg" width="800" height="600"/></center><p>
The vertical aperture is automatically adjusted to match the width and height.
Controls are provided for any angle fisheye as well as fisheyes that are not
level or tilted, noting that the exact order of the correction rotations may
need to be considered for particular cases.
Note that a perspective projection is not defined for greater than 180 degrees,
indeed it gets increasingly inefficient past around 140 degrees.
The field of view can be adjusted as well as the viewing direction.
The following example is a 120 degrees horizontal field of view and looking upwards 
by 30 degrees.
</p>
<center>
<img src="https://squidarth.com/productivity/2022/08/29/persp2.jpg" width="800" height="600"/></center>

<p>
If &#34;straight&#34; lines are not straight that normally means the fisheye center or radius are not 
specified correctly or the angle is not defined correctly.
Curvature in what should be straight lines near the rim of the fisheye normally means
the fisheye lens has non-linearities near the rim (a deviation from the mathematically pure
fisheye projection) and corrections need to be applied.
The following is looking right by 40 degrees and a narrower field of view of 80 degrees.
</p>
<center>
<img src="https://squidarth.com/productivity/2022/08/29/persp3.jpg" width="800" height="600"/></center><p>
The center of the fisheye on the input image can be found by projecting
lines along vertical structure in the scene. Where these lines intersect
is a close approximation to the center of the fisheye, assuming the
camera is mounted vertically. Alternatively, and perhaps easier, is to identify the edges of the
fisheye and assume a perfect circular inscribed circle. Note that for the example utilities provided
here the origin is assumed to be the bottom left corner, unlike the more common top right that
image editing programs use.
</p>

<p>
To test the algorithm a fisheye rendering inside a gridded cube is a good example,
see image on left below. Any correct perspective projection should result in straight lines.
</p>
<center><table><tbody><tr><td>
   <a href="https://squidarth.com/productivity/2022/08/29/cube_orig.jpg"><img src="https://squidarth.com/productivity/2022/08/29/cube_origs.jpg" width="400" height="400"/></a></td><td>
   <a href="https://squidarth.com/productivity/2022/08/29/cube_p1.jpg"><img src="https://squidarth.com/productivity/2022/08/29/cube_p1s.jpg" width="400" height="400"/></a></td></tr></tbody></table></center><center><table><tbody><tr><td>
   <a href="https://squidarth.com/productivity/2022/08/29/cube_p2.jpg"><img src="https://squidarth.com/productivity/2022/08/29/cube_p2s.jpg" width="400" height="400"/></a></td><td>
   <a href="https://squidarth.com/productivity/2022/08/29/cube_p3.jpg"><img src="https://squidarth.com/productivity/2022/08/29/cube_p3s.jpg" width="400" height="400"/></a></td></tr></tbody></table></center><p>
<a href="https://squidarth.com/productivity/2022/08/29/fish2perspffmpeg.pdf">Instructions for converting movies using ffmpeg</a></p><h3>Front fisheye to panorama</h3>
<a href="#4">Now superceeded by fish2pano</a><p>
<b>Software:</b> frontfish2pano</p><p>
Update November 2016: frontfish2pano is now redundant, fisheye orientation can
now be controlled with <a href="#fish2pano">fish2pano</a>, see later.
</p>

<p>
This case is developed mainly for &#34;front pointing&#34; fisheyes although it does have application
for other orientations. The projection is more correctly called a cylindrical panorama.
</p>

<pre>Usage: frontfish2pano [options] fisheyeimage
Options
   -w n     panoramic image width, default = 800
   -h n     panoramic image height, default = -1
  -ap n     vertical aperture of panoramic, default = 100
  -af n     aperture of fisheye (degrees), default = 180
  -cf x y   center of the fisheye image, default is image center
   -r n     radius of the fisheye image, default is half the image width
  -fa n     angle for tilted fisheye, default = 0
  -fb n     angle for rotated fisheye, default = 0
   -a n     antialiasing level, default = 1 (no antialising)
</pre>
<p>
Source fisheye image.
</p>
<center>
<img src="https://squidarth.com/productivity/2022/08/29/inputfisheye.jpg" width="800" height="533"/>
</center><p>
Transformation with the default settings is shown below.
</p>
<center>
<img src="https://squidarth.com/productivity/2022/08/29/test1b.jpg" width="800" height="444"/></center><p>
Correct for the fact that the camera is not quite horizontal, this is the
reason the vertical structure doesn&#39;t appear vertical in the panoramic projection.
Of course nothing is for free, one looses a bit of the image in the bottom
left and right corners.
</p>
<center>
<img src="https://squidarth.com/productivity/2022/08/29/test4b.jpg" width="800" height="444"/></center><p>
Set the vertical field of view of the panorama, in the following cases narrowed from
the default of 100 degrees to 80 degrees. As with perspective projections there is a limit, 
in this case, to the vertical field of view, a hard limit at 180 degrees but increasingly inefficient
past 140 degrees.
</p>
<center>
<img src="https://squidarth.com/productivity/2022/08/29/test2b.jpg" width="800" height="355"/></center><h3>Fisheye to (partial) spherical projection</h3>
<a href="https://squidarth.com/productivity/2022/08/29/fish2sphere.pdf">Additional notes on the algorithm</a></div></div></div>
  </body>
</html>
