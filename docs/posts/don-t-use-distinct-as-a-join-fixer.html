<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.red-gate.com/simple-talk/databases/sql-server/t-sql-programming-sql-server/dont-use-distinct-as-a-join-fixer/">Original</a>
    <h1>Don&#39;t use DISTINCT as a &#34;join-fixer&#34;</h1>
    
    <div id="readability-page-1" class="page"><div>
				<p>I’ve quietly resolved performance issues by re-writing slow queries to avoid <code>DISTINCT</code>. Often, the <code>DISTINCT</code> is there only to serve as a “join-fixer,” and I can explain what that means using an example.</p>
<p>Let’s say we have the following grossly simplified schema, representing customers, products, and product categories:</p>
<!-- Urvanov Syntax Highlighter v2.8.28 -->

		<div id="urvanov-syntax-highlighter-6533a40cdd2af718940205" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p></div>
				</td>
						<td><div><p><span> </span><span>CREATE</span><span> </span><span>TABLE</span><span> </span><span>dbo</span><span>.</span><span>Customers</span></p><p><span> </span><span>(</span></p><p><span>   </span><span>CustomerID</span><span> </span><span>int</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>,</span></p><p><span>   </span><span>Name</span><span>       </span><span>nvarchar</span><span>(</span><span>255</span><span>)</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>,</span></p><p><span>   </span><span>CONSTRAINT</span><span> </span><span>PK_Customers</span><span> </span><span>PRIMARY</span><span> </span><span>KEY</span><span> </span><span>(</span><span>CustomerID</span><span>)</span></p><p><span> </span><span>)</span><span>;</span></p><p><span> </span><span>CREATE</span><span> </span><span>TABLE</span><span> </span><span>dbo</span><span>.</span><span>Categories</span></p><p><span> </span><span>(</span></p><p><span>   </span><span>CategoryID</span><span> </span><span>int</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>,</span></p><p><span>   </span><span>Name</span><span>       </span><span>nvarchar</span><span>(</span><span>255</span><span>)</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>,</span></p><p><span>   </span><span>CONSTRAINT</span><span> </span><span>PK_Categories</span><span> </span><span>PRIMARY</span><span> </span><span>KEY</span><span> </span><span>(</span><span>CategoryID</span><span>)</span><span>,</span></p><p><span>   </span><span>CONSTRAINT</span><span> </span><span>UQ_Categories</span><span> </span><span>UNIQUE</span><span> </span><span>(</span><span>Name</span><span>)</span></p><p><span> </span><span>)</span><span>;</span></p><p><span> </span><span>CREATE</span><span> </span><span>TABLE</span><span> </span><span>dbo</span><span>.</span><span>Products</span></p><p><span> </span><span>(</span></p><p><span>   </span><span>ProductID</span><span>  </span><span>int</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>,</span></p><p><span>   </span><span>CategoryID</span><span> </span><span>int</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>,</span></p><p><span>   </span><span>Name</span><span>       </span><span>nvarchar</span><span>(</span><span>255</span><span>)</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>,</span></p><p><span>   </span><span>CONSTRAINT</span><span> </span><span>PK_Products</span><span> </span><span>PRIMARY</span><span> </span><span>KEY</span><span> </span><span>(</span><span>ProductID</span><span>)</span></p><p><span> </span><span>)</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>And then we have tables for orders and order details:</p>
<!-- Urvanov Syntax Highlighter v2.8.28 -->

		<div id="urvanov-syntax-highlighter-6533a40cdd2b6767556046" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p></div>
				</td>
						<td><div><p><span> </span><span>CREATE</span><span> </span><span>TABLE</span><span> </span><span>dbo</span><span>.</span><span>Orders</span></p><p><span> </span><span>(</span></p><p><span>   </span><span>OrderID</span><span>    </span><span>int</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>,</span></p><p><span>   </span><span>CustomerID</span><span> </span><span>int</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>,</span></p><p><span>   </span><span>OrderDate</span><span>  </span><span>date</span><span>,</span></p><p><span>   </span><span>OrderTotal</span><span> </span><span>decimal</span><span>(</span><span>12</span><span>,</span><span>2</span><span>)</span><span>,</span></p><p><span>   </span><span>CONSTRAINT</span><span> </span><span>PK_Orders</span><span> </span><span>PRIMARY</span><span> </span><span>KEY</span><span> </span><span>(</span><span>OrderID</span><span>)</span></p><p><span> </span><span>)</span><span>;</span></p><p><span> </span><span>CREATE</span><span> </span><span>TABLE</span><span> </span><span>dbo</span><span>.</span><span>OrderDetails</span></p><p><span> </span><span>(</span></p><p><span>   </span><span>OrderID</span><span>    </span><span>int</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>,</span></p><p><span>   </span><span>LineItemID</span><span> </span><span>int</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>,</span></p><p><span>   </span><span>ProductID</span><span>  </span><span>int</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>,</span></p><p><span>   </span><span>Quantity</span><span>   </span><span>int</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>,</span></p><p><span>   </span><span>CONSTRAINT</span><span> </span><span>PK_OrderDetails</span><span> </span><span>PRIMARY</span><span> </span><span>KEY</span><span>  </span><span>(</span><span>OrderID</span><span>,</span><span> </span><span>LineItemID</span><span>)</span><span>,</span></p><p><span>   </span><span>INDEX</span><span> </span><span>IX_OrderDetails_OrderID_ProductID </span><span>(</span><span>OrderID</span><span>,</span><span> </span><span>ProductID</span><span>)</span></p><p><span> </span><span>)</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>And some sample data:</p>
<!-- Urvanov Syntax Highlighter v2.8.28 -->

		<div id="urvanov-syntax-highlighter-6533a40cdd2b8107479982" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span> </span><span>INSERT</span><span> </span><span>dbo</span><span>.</span><span>Customers </span><span>(</span><span>CustomerID</span><span>,</span><span> </span><span>Name</span><span>)</span></p><p><span>   </span><span>VALUES</span><span> </span><span>(</span><span>1</span><span>,</span><span>N</span><span>&#39;Aaron&#39;</span><span>)</span><span>,</span><span> </span><span>(</span><span>2</span><span>,</span><span>N</span><span>&#39;Bob&#39;</span><span>)</span><span>;</span></p><p><span> </span><span>INSERT</span><span> </span><span>dbo</span><span>.</span><span>Categories </span><span>(</span><span>CategoryID</span><span>,</span><span> </span><span>Name</span><span>)</span></p><p><span>   </span><span>VALUES</span><span>(</span><span>1</span><span>,</span><span>N</span><span>&#39;Beauty&#39;</span><span>)</span><span>,</span><span> </span><span>(</span><span>2</span><span>,</span><span>N</span><span>&#39;Grocery&#39;</span><span>)</span><span>;</span></p><p><span> </span><span>INSERT</span><span> </span><span>dbo</span><span>.</span><span>Products </span><span>(</span><span>ProductID</span><span>,</span><span> </span><span>CategoryID</span><span>,</span><span> </span><span>Name</span><span>)</span></p><p><span>   </span><span>VALUES</span><span> </span><span>(</span><span>1</span><span>,</span><span>1</span><span>,</span><span>N</span><span>&#39;Lipstick&#39;</span><span>)</span><span>,</span><span> </span><span>(</span><span>2</span><span>,</span><span>1</span><span>,</span><span>N</span><span>&#39;Mascara&#39;</span><span>)</span><span>,</span><span> </span><span>(</span><span>3</span><span>,</span><span>2</span><span>,</span><span>N</span><span>&#39;Strawberries&#39;</span><span>)</span><span>;</span><span> </span></p><p><span> </span><span>INSERT</span><span> </span><span>dbo</span><span>.</span><span>Orders </span><span>(</span><span>OrderID</span><span>,</span><span> </span><span>CustomerID</span><span>,</span><span> </span><span>OrderDate</span><span>,</span><span> </span><span>OrderTotal</span><span>)</span></p><p><span>   </span><span>VALUES</span><span> </span><span>(</span><span>1</span><span>,</span><span>1</span><span>,</span><span>getdate</span><span>(</span><span>)</span><span>,</span><span>32.50</span><span>)</span><span>,</span><span> </span><span>(</span><span>2</span><span>,</span><span>2</span><span>,</span><span>getdate</span><span>(</span><span>)</span><span>,</span><span>47.05</span><span>)</span><span>;</span></p><p><span> </span><span>INSERT</span><span> </span><span>dbo</span><span>.</span><span>OrderDetails </span><span>(</span><span>OrderID</span><span>,</span><span> </span><span>LineItemID</span><span>,</span><span> </span><span>ProductID</span><span>,</span><span> </span><span>Quantity</span><span>)</span><span> </span></p><p><span>   </span><span>VALUES</span><span> </span><span>(</span><span>1</span><span>,</span><span>1</span><span>,</span><span>1</span><span>,</span><span>5</span><span>)</span><span>,</span><span> </span><span>(</span><span>2</span><span>,</span><span>1</span><span>,</span><span>3</span><span>,</span><span>10</span><span>)</span><span>;</span><span> </span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>Marketing says we want to send an e-mail or give a discount code to all the customers who have ordered a product from the beauty category. The initial attempt at a query for this might be something like this:</p>
<!-- Urvanov Syntax Highlighter v2.8.28 -->

		<div id="urvanov-syntax-highlighter-6533a40cdd2b9397823398" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span> </span><span>SELECT</span><span> </span><span>c</span><span>.</span><span>CustomerID</span><span>,</span><span> </span><span>c</span><span>.</span><span>Name</span></p><p><span> </span><span>FROM</span><span> </span><span>dbo</span><span>.</span><span>Customers</span><span> </span><span>AS</span><span> </span><span>c</span></p><p><span> </span><span>INNER</span><span> </span><span>JOIN</span><span> </span><span>dbo</span><span>.</span><span>Orders</span><span> </span><span>AS</span><span> </span><span>o</span></p><p><span>   </span><span>ON</span><span> </span><span>c</span><span>.</span><span>CustomerID</span><span> </span><span>=</span><span> </span><span>o</span><span>.</span><span>CustomerID</span></p><p><span> </span><span>INNER</span><span> </span><span>JOIN</span><span> </span><span>dbo</span><span>.</span><span>OrderDetails</span><span> </span><span>AS</span><span> </span><span>od</span></p><p><span>   </span><span>ON</span><span> </span><span>o</span><span>.</span><span>OrderID</span><span> </span><span>=</span><span> </span><span>od</span><span>.</span><span>OrderID</span></p><p><span> </span><span>INNER</span><span> </span><span>JOIN</span><span> </span><span>dbo</span><span>.</span><span>Products</span><span> </span><span>AS</span><span> </span><span>p</span></p><p><span>   </span><span>ON</span><span> </span><span>od</span><span>.</span><span>ProductID</span><span> </span><span>=</span><span> </span><span>p</span><span>.</span><span>ProductID</span></p><p><span> </span><span>INNER</span><span> </span><span>JOIN</span><span> </span><span>dbo</span><span>.</span><span>Categories</span><span> </span><span>AS</span><span> </span><span>cat</span></p><p><span>   </span><span>ON</span><span> </span><span>p</span><span>.</span><span>CategoryID</span><span> </span><span>=</span><span> </span><span>cat</span><span>.</span><span>CategoryID</span></p><p><span>   </span><span>WHERE</span><span> </span><span>cat</span><span>.</span><span>Name</span><span> </span><span>=</span><span> </span><span>N</span><span>&#39;Beauty&#39;</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<p>The plan doesn’t look so bad (yet):</p>
<p><a href="https://www.red-gate.com/simple-talk/wp-content/uploads/2023/09/joinfix-p1.png" target="_blank" rel="noopener"><img decoding="async" src="https://www.red-gate.com/simple-talk/wp-content/uploads/2023/09/joinfix-p1.png" alt="A simple plan"/></a></p>
<p>And in local or test data, the output might look right, since we may have inserted a single row into <code>OrderDetails</code> to match our criteria (and to make our tests pass). But what if I have ordered <em>two</em> products from the beauty category (in the same order, or across multiple orders)?</p>
<!-- Urvanov Syntax Highlighter v2.8.28 -->

		<div id="urvanov-syntax-highlighter-6533a40cdd2bb233570363" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span> </span><span>INSERT</span><span> </span><span>dbo</span><span>.</span><span>OrderDetails </span><span>(</span><span>OrderID</span><span>,</span><span> </span><span>LineItemID</span><span>,</span><span> </span><span>ProductID</span><span>,</span><span> </span><span>Quantity</span><span>)</span></p><p><span>   </span><span>VALUES</span><span>(</span><span>1</span><span>,</span><span>2</span><span>,</span><span>2</span><span>,</span><span>1</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->

<p>Now the query returns that customer twice! We certainly don’t want to send them two e-mails, or issue multiple discount codes to the same customer. And the plan, on its own, can’t really provide any obvious clues that there are duplicate rows:</p>
<p><a href="https://www.red-gate.com/simple-talk/wp-content/uploads/2023/09/joinfix-p2.png" target="_blank" rel="noopener"><img decoding="async" src="https://www.red-gate.com/simple-talk/wp-content/uploads/2023/09/joinfix-p2.png" alt="Hidden duplicates"/></a></p>
<p>But you sure will notice if you inspect the results, or an end user will notice if you unleash this in production. The quick fix tends to be: slap a big ol’ <code>DISTINCT</code> on there which, indeed, fixes the symptom by eliminating duplicates:</p>
<!-- Urvanov Syntax Highlighter v2.8.28 -->

		<div id="urvanov-syntax-highlighter-6533a40cdd2bc009679629" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span> </span><span>SELECT</span><span> </span><span>DISTINCT</span><span> </span><span>c</span><span>.</span><span>CustomerID</span><span>,</span><span> </span><span>c</span><span>.</span><span>Name</span></p><p><span> </span><span>-------^^^^^^^^</span></p><p><span> </span><span>FROM</span><span> </span><span>dbo</span><span>.</span><span>Customers</span><span> </span><span>AS</span><span> </span><span>c</span></p><p><span> </span><span>INNER</span><span> </span><span>JOIN</span><span> </span><span>dbo</span><span>.</span><span>Orders</span><span> </span><span>AS</span><span> </span><span>o</span></p><p><span>   </span><span>ON</span><span> </span><span>c</span><span>.</span><span>CustomerID</span><span> </span><span>=</span><span> </span><span>o</span><span>.</span><span>CustomerID</span></p><p><span> </span><span>INNER</span><span> </span><span>JOIN</span><span> </span><span>dbo</span><span>.</span><span>OrderDetails</span><span> </span><span>AS</span><span> </span><span>od</span></p><p><span>   </span><span>ON</span><span> </span><span>o</span><span>.</span><span>OrderID</span><span> </span><span>=</span><span> </span><span>od</span><span>.</span><span>OrderID</span></p><p><span> </span><span>INNER</span><span> </span><span>JOIN</span><span> </span><span>dbo</span><span>.</span><span>Products</span><span> </span><span>AS</span><span> </span><span>p</span></p><p><span>   </span><span>ON</span><span> </span><span>od</span><span>.</span><span>ProductID</span><span> </span><span>=</span><span> </span><span>p</span><span>.</span><span>ProductID</span></p><p><span> </span><span>INNER</span><span> </span><span>JOIN</span><span> </span><span>dbo</span><span>.</span><span>Categories</span><span> </span><span>AS</span><span> </span><span>cat</span></p><p><span>   </span><span>ON</span><span> </span><span>p</span><span>.</span><span>CategoryID</span><span> </span><span>=</span><span> </span><span>cat</span><span>.</span><span>CategoryID</span></p><p><span>   </span><span>WHERE</span><span> </span><span>cat</span><span>.</span><span>Name</span><span> </span><span>=</span><span> </span><span>N</span><span>&#39;Beauty&#39;</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<p>But at what cost? A <a href="https://sqlserverfast.com/epr/sort/" target="_blank" rel="noopener">distinct sort</a>, that’s what!</p>
<p><a href="https://www.red-gate.com/simple-talk/wp-content/uploads/2023/09/joinfix-p3.png" target="_blank" rel="noopener"><img decoding="async" src="https://www.red-gate.com/simple-talk/wp-content/uploads/2023/09/joinfix-p3.png" alt="Pain caused by that DISTINCT"/></a></p>
<p>If I’m testing changes to this query in my local environment, and maybe just testing the output and that it returned the data quickly, I might miss clues in the plan and be pretty satisfied that adding <code>DISTINCT</code> fixed the issue without impacting performance.</p>
<h3>This will only get worse with more data.</h3>
<p>And while we could spend a lot of time tuning indexes on all the involved tables to make that sort hurt less, this multi-table join is always going to produce rows you never ultimately need. Think about SQL Server’s job: yes, it needs to return correct results, but it also should do that <em>in the most efficient way possible</em>. Reading all the data (and then sorting it), only to throw away some or most of it, is very wasteful.</p>
<h3>Can we express the query without DISTINCT?</h3>
<p>When I know I need to “join” to tables but only care about existence of rows and not any of the output from those tables, I turn to <code>EXISTS</code>. I also try to eliminate looking up values that I know are going to be the same on every row. In this case, I don’t need to join to <code>Categories</code> every time if <code>CategoryID</code> is effectively a constant.</p>
<p>One way to express this same query, ensuring no duplicate customers and, hopefully, reducing the cost of sorting:</p>
<!-- Urvanov Syntax Highlighter v2.8.28 -->

		<div id="urvanov-syntax-highlighter-6533a40cdd2bd825218610" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p></div>
				</td>
						<td><div><p><span> </span><span>DECLARE</span><span> </span><span>@</span><span>CategoryID</span><span> </span><span>int</span><span>;</span></p><p><span> </span><span>SELECT</span><span> </span><span>@</span><span>CategoryID</span><span> </span><span>=</span><span> </span><span>CategoryID</span></p><p><span>   </span><span>FROM</span><span> </span><span>dbo</span><span>.</span><span>Categories</span><span> </span><span>WHERE</span><span> </span><span>Name</span><span> </span><span>=</span><span> </span><span>N</span><span>&#39;Beauty&#39;</span><span>;</span></p><p><span> </span><span>SELECT</span><span> </span><span>c</span><span>.</span><span>CustomerID</span><span>,</span><span> </span><span>c</span><span>.</span><span>Name</span></p><p><span>   </span><span>FROM</span><span> </span><span>dbo</span><span>.</span><span>Customers</span><span> </span><span>AS</span><span> </span><span>c</span></p><p><span>   </span><span>WHERE</span><span> </span><span>EXISTS</span></p><p><span>   </span><span>(</span></p><p><span>     </span><span>SELECT</span><span> </span><span>1</span><span> </span><span>FROM</span><span> </span><span>dbo</span><span>.</span><span>OrderDetails</span><span> </span><span>AS</span><span> </span><span>od</span></p><p><span>       </span><span>INNER</span><span> </span><span>JOIN</span><span> </span><span>dbo</span><span>.</span><span>Orders</span><span> </span><span>AS</span><span> </span><span>o</span></p><p><span>	     </span><span>ON</span><span> </span><span>od</span><span>.</span><span>OrderID</span><span> </span><span>=</span><span> </span><span>o</span><span>.</span><span>OrderID</span></p><p><span>	   </span><span>INNER</span><span> </span><span>JOIN</span><span> </span><span>dbo</span><span>.</span><span>Products</span><span> </span><span>AS</span><span> </span><span>p</span></p><p><span>	     </span><span>ON</span><span> </span><span>od</span><span>.</span><span>ProductID</span><span> </span><span>=</span><span> </span><span>p</span><span>.</span><span>ProductID</span></p><p><span>       </span><span>WHERE</span><span> </span><span>o</span><span>.</span><span>CustomerID</span><span> </span><span>=</span><span> </span><span>c</span><span>.</span><span>CustomerID</span></p><p><span>	     </span><span>AND</span><span> </span><span>p</span><span>.</span><span>CategoryID</span><span> </span><span>=</span><span> </span><span>@</span><span>CategoryID</span></p><p><span>   </span><span>)</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<p>There’s a simple, additional index seek against <code>Categories</code>, of course, but the plan for the overall query has been made drastically more efficient (we’re down to 2 scans and 2 seeks)</p>
<p><a href="https://www.red-gate.com/simple-talk/wp-content/uploads/2023/09/joinfix-p4.png" target="_blank" rel="noopener"><img decoding="async" src="https://www.red-gate.com/simple-talk/wp-content/uploads/2023/09/joinfix-p4.png" alt="A plan using EXISTS"/></a></p>
<p>Another way to express the same query is to force <code>Orders</code> to be scanned later:</p>
<!-- Urvanov Syntax Highlighter v2.8.28 -->

		<div id="urvanov-syntax-highlighter-6533a40cdd2bf420277732" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p></div>
				</td>
						<td><div><p><span> </span><span>DECLARE</span><span> </span><span>@</span><span>CategoryID</span><span> </span><span>int</span><span>;</span></p><p><span> </span><span>SELECT</span><span> </span><span>@</span><span>CategoryID</span><span> </span><span>=</span><span> </span><span>CategoryID</span></p><p><span>   </span><span>FROM</span><span> </span><span>dbo</span><span>.</span><span>Categories</span><span> </span><span>WHERE</span><span> </span><span>Name</span><span> </span><span>=</span><span> </span><span>N</span><span>&#39;Beauty&#39;</span><span>;</span></p><p><span> </span><span>WITH</span><span> </span><span>cte</span><span> </span><span>AS</span><span> </span></p><p><span> </span><span>(</span></p><p><span>   </span><span>SELECT</span><span> </span><span>CustomerID</span><span> </span><span>FROM</span><span> </span><span>dbo</span><span>.</span><span>Orders</span><span> </span><span>AS</span><span> </span><span>o</span></p><p><span>   </span><span>WHERE</span><span> </span><span>EXISTS</span><span> </span></p><p><span>   </span><span>(</span></p><p><span>     </span><span>SELECT</span><span> </span><span>1</span><span> </span><span>FROM</span><span> </span><span>dbo</span><span>.</span><span>OrderDetails</span><span> </span><span>AS</span><span> </span><span>od</span></p><p><span>	   </span><span>INNER</span><span> </span><span>JOIN</span><span> </span><span>dbo</span><span>.</span><span>Products</span><span> </span><span>AS</span><span> </span><span>p</span></p><p><span>	     </span><span>ON</span><span> </span><span>od</span><span>.</span><span>ProductID</span><span> </span><span>=</span><span> </span><span>p</span><span>.</span><span>ProductID</span></p><p><span>       </span><span>WHERE</span><span> </span><span>od</span><span>.</span><span>OrderID</span><span> </span><span>=</span><span> </span><span>o</span><span>.</span><span>OrderID</span></p><p><span>	     </span><span>AND</span><span> </span><span>p</span><span>.</span><span>CategoryID</span><span> </span><span>=</span><span> </span><span>@</span><span>CategoryID</span></p><p><span>   </span><span>)</span></p><p><span> </span><span>)</span></p><p><span> </span><span>SELECT</span><span> </span><span>cust</span><span>.</span><span>CustomerID</span><span>,</span><span> </span><span>cust</span><span>.</span><span>Name</span></p><p><span>   </span><span>FROM</span><span> </span><span>dbo</span><span>.</span><span>Customers</span><span> </span><span>AS</span><span> </span><span>cust</span></p><p><span>   </span><span>INNER</span><span> </span><span>JOIN</span><span> </span><span>cte</span><span> </span><span>ON</span><span> </span><span>cte</span><span>.</span><span>CustomerID</span><span> </span><span>=</span><span> </span><span>cust</span><span>.</span><span>CustomerID</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>This can be beneficial if you have more <code>Orders</code> than <code>Customers</code> (I certainly hope that’s the case). Notice in the plan that we still have two scans and two seeks, but <code>Orders</code> is scanned later, and <code>Products</code> is scanned instead of <code>Customers</code>.</p>
<p><a href="https://www.red-gate.com/simple-talk/wp-content/uploads/2023/09/joinfix-p5.png" target="_blank" rel="noopener"><img decoding="async" src="https://www.red-gate.com/simple-talk/wp-content/uploads/2023/09/joinfix-p5.png" alt="A slightly different EXISTS plan"/></a></p>
<p>Overall, fewer rows move through the plan, and this is reflected in slightly lower reads. This will be amplified by more rows in the table, wider rows in general, and more rows filtered out earlier.</p>
<h3>Conclusion</h3>
<p><code>DISTINCT</code> is often hiding flaws in the underlying logic, and it can really pay off to explore other ways to write your queries without it. There was another interesting use case <a href="https://sqlperformance.com/2017/01/t-sql-queries/surprises-assumptions-group-by-distinct" target="_blank" rel="noopener">I wrote about a few years ago</a> that showed how changing <code>DISTINCT</code> to <code>GROUP BY</code> – even though it carries the same semantics and produces the same results – can help SQL Server filter out duplicates earlier and have a serious impact on performance.</p>
			</div></div>
  </body>
</html>
