<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tech.marksblogg.com/pretty-maps-in-python.html">Original</a>
    <h1>Pretty Maps in Python</h1>
    
    <div id="readability-page-1" class="page"><div id="article_text">
            <p>Last year I came across an article on Hacker News advertising a new project called <a href="https://github.com/marceloprates/prettymaps">prettymaps</a>. It&#39;s largely the work of <a href="https://twitter.com/marceloprates_">Marcelo de Oliveira Rosa Prates</a> and <a href="https://twitter.com/chrieke">Christoph Rieke</a> and allows you to specify a location by its name and, using some great default styles, will generate a map of that area in PNG format. Below is an example depicting Tallinn&#39;s Old Town.</p>
<p><a href="https://tech.marksblogg.com/theme/images/tallinn.png"><img alt="Tallinn&#39;s Old Town" src="https://tech.marksblogg.com/theme/images/tallinn.png"/></a></p><p>The project only contains 425 lines of Python due to intense 3rd-party package use.</p>
<p>The map data is collected from OpenStreetMap using the <a href="https://github.com/gboeing/osmnx">OSMnx</a> library. This library itself is made up of only 3,700 lines of Python as its relying on <a href="https://github.com/networkx/networkx">NetworkX</a>. NetworkX wraps up functionality relating to complex networks and is made up of 78K lines of Python. NetworkX is largely the work of <a href="http://aric.hagberg.org/">Aric Hagberg</a>, an applied mathematician at the Los Alamos National Laboratory as well as <a href="https://www.jarrodmillman.com/">Jarrod Millman</a> who was once the release manager for both NumPy and SciPy.</p>
<p>Rendering is handled by <a href="https://github.com/abey79/vsketch">vsketch</a>, a project made up of 4.6K lines of Python and is based largely on the efforts of <a href="https://twitter.com/abey79">Antoine Beyeler</a>, an entrepreneur based in Switzerland.</p>
<p>In this post, I&#39;ll walk through generating the following rendering of Tallinn&#39;s Old Town.</p>
<div id="installing-prerequisites">
<h2>Installing Prerequisites</h2>
<p>I&#39;m using a fresh install of Ubuntu 20.04 LTS with an Intel Core i5 4670K clocked at 3.4 GHz, 16 GB of DDR3 RAM and 250 GB of NVMe SSD capacity.</p>
<p>Below I&#39;ll install Python and some build tools used throughout this post.</p>
<div><pre><span></span>$ sudo apt update
$ sudo apt install <span>\</span>
    jq <span>\</span>
    python3-virtualenv
</pre></div>
<p>I&#39;ll set up a Python virtual environment and install a few packages.</p>
<div><pre><span></span>$ virtualenv ~/.pretty
$ <span>source</span> ~/.pretty/bin/activate
$ python3 -m pip install <span>\</span>
    prettymaps <span>\</span>
    typer <span>\</span>
    git+https://github.com/abey79/vsketch.git
</pre></div>
<p>As of this writing, the Python requirements file for prettymaps pins to OSMnx version 1.0.1 which is out of date. The code in this post won&#39;t run without an update to a newer version. I found version 1.2.1 to run without issue.</p>
<div><pre><span></span>$ python3 -m pip install <span>\</span>
    <span>osmnx</span><span>==</span><span>1</span>.2.1
</pre></div>
</div>
<div id="mapping-the-old-town">
<h2>Mapping the Old Town</h2>
<p>The following is a script that you can call from the command line. It allows you to pick a location based on its name and optionally you can control the radius in meters around the centre point as well as the size of the rendering.</p>

<div><pre><span></span><span>import</span> <span>uuid</span>

<span>import</span> <span>typer</span>
<span>import</span> <span>vsketch</span>
<span>from</span>   <span>prettymaps</span> <span>import</span> <span>*</span>
<span>import</span> <span>matplotlib.font_manager</span> <span>as</span> <span>fm</span>
<span>from</span>   <span>matplotlib</span> <span>import</span> <span>pyplot</span> <span>as</span> <span>plt</span>


<span>def</span> <span>draw</span><span>(</span><span>location</span><span>:</span><span>str</span><span>=</span><span>&#39;Old Town, Tallinn&#39;</span><span>,</span>
         <span>radius</span><span>:</span><span>int</span><span>=</span><span>1000</span><span>,</span>
         <span>width</span><span>:</span><span>int</span><span>=</span><span>12</span><span>,</span>
         <span>height</span><span>:</span><span>int</span><span>=</span><span>12</span><span>):</span>
    <span>fig</span><span>,</span> <span>ax</span> <span>=</span> <span>plt</span><span>.</span><span>subplots</span><span>(</span><span>figsize</span><span>=</span><span>(</span><span>width</span><span>,</span> <span>height</span><span>),</span>
                           <span>constrained_layout</span><span>=</span><span>True</span><span>)</span>

    <span>backup</span> <span>=</span> <span>plot</span><span>(</span>
        <span>location</span><span>,</span>
        <span>radius</span><span>=</span><span>radius</span><span>,</span>
        <span>ax</span><span>=</span><span>ax</span><span>,</span>
        <span>layers</span> <span>=</span> <span>{</span>
            <span>&#39;perimeter&#39;</span><span>:</span> <span>{},</span>
            <span>&#39;streets&#39;</span><span>:</span> <span>{</span>
                <span>&#39;custom_filter&#39;</span><span>:</span>
                    <span>&#39;[&#34;highway&#34;~&#34;motorway|trunk|primary|&#39;</span>
                      <span>&#39;secondary|tertiary|residential|service|&#39;</span>
                      <span>&#39;unclassified|pedestrian|footway&#34;]&#39;</span><span>,</span>
                <span>&#39;width&#39;</span><span>:</span> <span>{</span>
                    <span>&#39;motorway&#39;</span><span>:</span> <span>5</span><span>,</span>
                    <span>&#39;trunk&#39;</span><span>:</span> <span>5</span><span>,</span>
                    <span>&#39;primary&#39;</span><span>:</span> <span>4.5</span><span>,</span>
                    <span>&#39;secondary&#39;</span><span>:</span> <span>4</span><span>,</span>
                    <span>&#39;tertiary&#39;</span><span>:</span> <span>3.5</span><span>,</span>
                    <span>&#39;residential&#39;</span><span>:</span> <span>3</span><span>,</span>
                    <span>&#39;service&#39;</span><span>:</span> <span>2</span><span>,</span>
                    <span>&#39;unclassified&#39;</span><span>:</span> <span>2</span><span>,</span>
                    <span>&#39;pedestrian&#39;</span><span>:</span> <span>2</span><span>,</span>
                    <span>&#39;footway&#39;</span><span>:</span> <span>1</span><span>,</span>
                <span>}</span>
            <span>},</span>
            <span>&#39;building&#39;</span><span>:</span> <span>{</span><span>&#39;tags&#39;</span><span>:</span> <span>{</span><span>&#39;building&#39;</span><span>:</span> <span>True</span><span>,</span>
                                  <span>&#39;landuse&#39;</span><span>:</span> <span>&#39;construction&#39;</span><span>},</span>
                         <span>&#39;union&#39;</span><span>:</span> <span>False</span><span>},</span>
            <span>&#39;water&#39;</span><span>:</span> <span>{</span><span>&#39;tags&#39;</span><span>:</span> <span>{</span><span>&#39;natural&#39;</span><span>:</span> <span>[</span><span>&#39;water&#39;</span><span>,</span> <span>&#39;bay&#39;</span><span>]}},</span>
            <span>&#39;green&#39;</span><span>:</span> <span>{</span><span>&#39;tags&#39;</span><span>:</span> <span>{</span><span>&#39;landuse&#39;</span><span>:</span> <span>&#39;grass&#39;</span><span>,</span>
                               <span>&#39;natural&#39;</span><span>:</span> <span>[</span><span>&#39;island&#39;</span><span>,</span> <span>&#39;wood&#39;</span><span>],</span>
                               <span>&#39;leisure&#39;</span><span>:</span> <span>&#39;park&#39;</span><span>}},</span>
            <span>&#39;forest&#39;</span><span>:</span> <span>{</span><span>&#39;tags&#39;</span><span>:</span> <span>{</span><span>&#39;landuse&#39;</span><span>:</span> <span>&#39;forest&#39;</span><span>}},</span>
            <span>&#39;parking&#39;</span><span>:</span> <span>{</span><span>&#39;tags&#39;</span><span>:</span> <span>{</span><span>&#39;amenity&#39;</span><span>:</span> <span>&#39;parking&#39;</span><span>,</span>
                                 <span>&#39;highway&#39;</span><span>:</span> <span>&#39;pedestrian&#39;</span><span>,</span>
                                 <span>&#39;man_made&#39;</span><span>:</span> <span>&#39;pier&#39;</span><span>}}</span>
        <span>},</span>
        <span>drawing_kwargs</span> <span>=</span> <span>{</span>
            <span>&#39;background&#39;</span><span>:</span> <span>{</span><span>&#39;fc&#39;</span><span>:</span> <span>&#39;#F2F4CB&#39;</span><span>,</span>
                           <span>&#39;ec&#39;</span><span>:</span> <span>&#39;#dadbc1&#39;</span><span>,</span>
                           <span>&#39;hatch&#39;</span><span>:</span> <span>&#39;ooo...&#39;</span><span>,</span>
                           <span>&#39;zorder&#39;</span><span>:</span> <span>-</span><span>1</span><span>},</span>
            <span>&#39;perimeter&#39;</span><span>:</span> <span>{</span><span>&#39;fc&#39;</span><span>:</span> <span>&#39;#F2F4CB&#39;</span><span>,</span>
                          <span>&#39;ec&#39;</span><span>:</span> <span>&#39;#dadbc1&#39;</span><span>,</span>
                          <span>&#39;lw&#39;</span><span>:</span> <span>0</span><span>,</span> <span>&#39;hatch&#39;</span><span>:</span>
                          <span>&#39;ooo...&#39;</span><span>,</span>
                          <span>&#39;zorder&#39;</span><span>:</span> <span>0</span><span>},</span>
            <span>&#39;green&#39;</span><span>:</span> <span>{</span><span>&#39;fc&#39;</span><span>:</span> <span>&#39;#D0F1BF&#39;</span><span>,</span>
                      <span>&#39;ec&#39;</span><span>:</span> <span>&#39;#2F3737&#39;</span><span>,</span>
                      <span>&#39;lw&#39;</span><span>:</span> <span>1</span><span>,</span>
                      <span>&#39;zorder&#39;</span><span>:</span> <span>1</span><span>},</span>
            <span>&#39;forest&#39;</span><span>:</span> <span>{</span><span>&#39;fc&#39;</span><span>:</span> <span>&#39;#64B96A&#39;</span><span>,</span>
                       <span>&#39;ec&#39;</span><span>:</span> <span>&#39;#2F3737&#39;</span><span>,</span>
                       <span>&#39;lw&#39;</span><span>:</span> <span>1</span><span>,</span>
                       <span>&#39;zorder&#39;</span><span>:</span> <span>1</span><span>},</span>
            <span>&#39;water&#39;</span><span>:</span> <span>{</span><span>&#39;fc&#39;</span><span>:</span> <span>&#39;#a1e3ff&#39;</span><span>,</span>
                      <span>&#39;ec&#39;</span><span>:</span> <span>&#39;#2F3737&#39;</span><span>,</span>
                      <span>&#39;hatch&#39;</span><span>:</span> <span>&#39;ooo...&#39;</span><span>,</span>
                      <span>&#39;hatch_c&#39;</span><span>:</span> <span>&#39;#85c9e6&#39;</span><span>,</span>
                      <span>&#39;lw&#39;</span><span>:</span> <span>1</span><span>,</span>
                      <span>&#39;zorder&#39;</span><span>:</span> <span>2</span><span>},</span>
            <span>&#39;parking&#39;</span><span>:</span> <span>{</span><span>&#39;fc&#39;</span><span>:</span> <span>&#39;#F2F4CB&#39;</span><span>,</span>
                        <span>&#39;ec&#39;</span><span>:</span> <span>&#39;#2F3737&#39;</span><span>,</span>
                        <span>&#39;lw&#39;</span><span>:</span> <span>1</span><span>,</span>
                        <span>&#39;zorder&#39;</span><span>:</span> <span>3</span><span>},</span>
            <span>&#39;streets&#39;</span><span>:</span> <span>{</span><span>&#39;fc&#39;</span><span>:</span> <span>&#39;#2F3737&#39;</span><span>,</span>
                        <span>&#39;ec&#39;</span><span>:</span> <span>&#39;#475657&#39;</span><span>,</span>
                        <span>&#39;alpha&#39;</span><span>:</span> <span>1</span><span>,</span>
                        <span>&#39;lw&#39;</span><span>:</span> <span>0</span><span>,</span>
                        <span>&#39;zorder&#39;</span><span>:</span> <span>3</span><span>},</span>
            <span>&#39;building&#39;</span><span>:</span> <span>{</span><span>&#39;palette&#39;</span><span>:</span> <span>[</span><span>&#39;#FFC857&#39;</span><span>,</span>
                                     <span>&#39;#E9724C&#39;</span><span>,</span>
                                     <span>&#39;#C5283D&#39;</span><span>],</span>
                         <span>&#39;ec&#39;</span><span>:</span> <span>&#39;#2F3737&#39;</span><span>,</span>
                         <span>&#39;lw&#39;</span><span>:</span> <span>.5</span><span>,</span>
                         <span>&#39;zorder&#39;</span><span>:</span> <span>4</span><span>},</span>
        <span>}</span>
    <span>)</span>

    <span>filename</span> <span>=</span> <span>str</span><span>(</span><span>uuid</span><span>.</span><span>uuid4</span><span>())</span><span>.</span><span>split</span><span>(</span><span>&#39;-&#39;</span><span>)[</span><span>0</span><span>]</span> <span>+</span> <span>&#39;.png&#39;</span>
    <span>plt</span><span>.</span><span>savefig</span><span>(</span><span>filename</span><span>)</span>
    <span>print</span><span>(</span><span>filename</span><span>)</span>


<span>if</span> <span>__name__</span> <span>==</span> <span>&#34;__main__&#34;</span><span>:</span>
    <span>typer</span><span>.</span><span>run</span><span>(</span><span>draw</span><span>)</span>
</pre></div>
<p>I&#39;ve wrapped the draw function with typer which has generated a CLI interface for this script.</p>
<div><pre><span></span>$ python3 pretty.py --help
</pre></div>
<div><pre><span></span>Usage: pretty.py [OPTIONS]

Options:
  --location TEXT                 [default: Old Town, Tallinn]
  --radius INTEGER                [default: 1000]
  --width INTEGER                 [default: 12]
  --height INTEGER                [default: 12]
  --install-completion [bash|zsh|fish|powershell|pwsh]
                                  Install completion for the specified shell.
  --show-completion [bash|zsh|fish|powershell|pwsh]
                                  Show completion for the specified shell, to
                                  copy it or customize the installation.
  --help                          Show this message and exit.
</pre></div>
<p>The following will render the Old Town of Tallinn as a 600x600-pixel PNG.</p>
<div><pre><span></span>$ python3 pretty.py <span>\</span>
    --location<span>=</span><span>&#39;Old Town, Tallinn&#39;</span> <span>\</span>
    --width<span>=</span><span>6</span> <span>\</span>
    --height<span>=</span><span>6</span>
</pre></div>
<p>The above produced a file called <tt>89222126.png</tt> which is 629 KB in size. I ran this through a PNG crusher and brought the file size down further to 188 KB.</p>
<p>Note, a <tt>~/cache</tt> directory will appear in your home folder when you run the above. It&#39;ll contain JSON files that are uncompressed and could grow substantially depending on your use of this application.</p>
<p>The following example file contains 222,947 lines when formatted and is 2.7 MB decompressed.</p>
<div><pre><span></span>$ cat ~/cache/cd3dadcdd6b03fce64983fa1a369d46009c9f62c.json <span>\</span>
    <span>|</span> jq <span>\</span>
    <span>|</span> head -n20
</pre></div>
<div><pre><span></span><span>{</span>
  <span>&#34;version&#34;</span><span>:</span> <span>0.6</span><span>,</span>
  <span>&#34;generator&#34;</span><span>:</span> <span>&#34;Overpass API 0.7.58.5 b0c4acbb&#34;</span><span>,</span>
  <span>&#34;osm3s&#34;</span><span>:</span> <span>{</span>
    <span>&#34;timestamp_osm_base&#34;</span><span>:</span> <span>&#34;2022-07-20T17:46:03Z&#34;</span><span>,</span>
    <span>&#34;copyright&#34;</span><span>:</span> <span>&#34;The data included in this document is from www.openstreetmap.org. The data is made available under ODbL.&#34;</span>
  <span>},</span>
  <span>&#34;elements&#34;</span><span>:</span> <span>[</span>
    <span>{</span>
      <span>&#34;type&#34;</span><span>:</span> <span>&#34;node&#34;</span><span>,</span>
      <span>&#34;id&#34;</span><span>:</span> <span>10578470</span><span>,</span>
      <span>&#34;lat&#34;</span><span>:</span> <span>59.4320723</span><span>,</span>
      <span>&#34;lon&#34;</span><span>:</span> <span>24.7205922</span>
    <span>},</span>
    <span>{</span>
      <span>&#34;type&#34;</span><span>:</span> <span>&#34;node&#34;</span><span>,</span>
      <span>&#34;id&#34;</span><span>:</span> <span>10578472</span><span>,</span>
      <span>&#34;lat&#34;</span><span>:</span> <span>59.428396</span><span>,</span>
      <span>&#34;lon&#34;</span><span>:</span> <span>24.7234038</span>
    <span>},</span>
</pre></div>
<p>Finally, there is a prettymaps <a href="https://share.streamlit.io/chrieke/prettymapp/main/streamlit-prettymapp/app.py">Web UI</a> for anyone not interested in installing and running code.</p>
</div>

        </div><p>
            Thank you for taking the time to read this post. I offer both consulting and hands-on development services to clients in North America and Europe. If you&#39;d like to discuss how my offerings can help your business please contact me via <a href="https://uk.linkedin.com/in/marklitwintschik/">LinkedIn</a>.
        </p></div>
  </body>
</html>
