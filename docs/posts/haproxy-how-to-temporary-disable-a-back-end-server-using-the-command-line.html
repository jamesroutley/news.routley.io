<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.claudiokuenzler.com/blog/1240/haproxy-how-to-disable-enable-backend-server-command-line-cli-socket">Original</a>
    <h1>HAProxy: How to temporary disable a back end server using the command line</h1>
    
    <div id="readability-page-1" class="page"><div> 
	 


<!-- content within col-md-8 -->
<hr/><p>It&#39;s nothing new that <a href="https://www.haproxy.org" target="_blank" title="">HAProxy</a> is one of the most widely used (and stable) open source (tcp) load balancers. It&#39;s documentation is very extensive and well written. It&#39;s honestly a pleasure to work with this open source software.</p> 
  <p>What is not so widely known is that <a href="https://www.claudiokuenzler.com/HAProxy" target="" title="">HAProxy</a> can be controlled from the command line using its &#34;admin socket&#34;. Requirement for this is that the <strong>stats socket</strong> is actually defined in the <strong>haproxy config</strong> file (in the <strong>global section</strong>):</p> 
  <p>root@haproxy:~# <span>grep &#34;stats socket&#34; /etc/haproxy/haproxy.cfg</span></p> 
  <p>Another requirement is to have the socat command available. It can easily be installed using <span>apt</span>:</p> 
  <p> root@haproxy:~# <span>apt install socat</span><br/></p> 
  <p>With this all kinds of <a href="http://cbonte.github.io/haproxy-dconv/2.5/management.html#9.3" target="_blank" title="">commands can be sent to the socket</a>, for example looking at the current backend/servers status:</p> 
  <p>root@haproxy:~# <span>echo &#34;show servers state&#34; | socat unix-connect:/var/run/haproxy/admin.sock stdio</span></p> 
  <p>The highlighted srv_op_state shows the current status of a backend server. The value 2 stands for &#34;UP&#34; (what you would see in the HAProxy User Interface).</p> 
  <h2>Setting a backend server into maintenance mode (disabling a backend server)<br/></h2> 
  <p>If you are using HAProxy, you probably already <a href="https://www.claudiokuenzler.com/blog/897/boosting-check_haproxy-monitoring-plugin-ignore-backends-bytes-performance-data" target="_blank" title="">monitor the HAProxy status</a>, so looking at the status using <span>socat</span> isn&#39;t that special. However if you quickly need to place a backend server into a maintenance mode (= disabling the backend server), you can use the admin socket, too:</p> 
  <p>root@haproxy:~# <span>echo &#34;disable server backend1/server05.example.local&#34; | socat unix-connect:/var/run/haproxy/admin.sock stdio</span>root@haproxy:~# <span>echo &#34;disable server backend2/server05.example.local&#34; | socat unix-connect:/var/run/haproxy/admin.sock stdio</span><span></span></p> 
  <p>Looking at the admin user interface now shows this particular backend server with a brown background, it&#39;s status set to MAINT. </p> 
  <p><a href="https://www.claudiokuenzler.com/graph/news/1240-haproxy-stats-maint.png" rel="lightbox"><img src="https://www.claudiokuenzler.com/graph/news/1240-haproxy-stats-maint_small.png" alt="HAProxy backend server in MAINT status"/> </a></p> 
  <p>Using <span>socat</span>, we can verify this on the command line:</p> 
  <p>root@haproxy:~#Â  <span>echo &#34;show servers state&#34; | socat unix-connect:/var/run/haproxy/admin.sock stdio | grep server05</span></p> 
  <p>We can see the srv_op_state has changed to the value 0, the srv_admin_state next to it has changed from 0 to 1. That combo is represented in the UI as &#34;MAINT&#34; status.</p>
  <h2>Enabling a backend server again</h2>
  <p>Once the maintenance tasks are completed on the affected server, it can easily be enabled again:</p>
  <p>root@haproxy:~# <span>echo &#34;enable server backend1/server05.example.local&#34; | socat unix-connect:/var/run/haproxy/admin.sock stdio</span></p>
  <p> Trafifc is now balanced to this backend server again and it shows up as UP again.</p>
  <p>root@haproxy:~# <span>echo &#34;show servers state&#34; | socat unix-connect:/var/run/haproxy/admin.sock stdio | grep server05</span></p>
  <h2>Other socket command examples</h2>
  <p>A great overview of other handy socket commands can be found on <a title="" target="_blank" href="https://sleeplessbeastie.eu/2020/01/29/how-to-use-haproxy-stats-socket/">sleeplessbeastie&#39;s blog</a>.</p>
   
   
  
        </div></div>
  </body>
</html>
