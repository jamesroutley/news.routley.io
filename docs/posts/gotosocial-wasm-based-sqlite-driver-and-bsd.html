<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.tumfatig.net/2024/gotosocial-wasm-based-sqlite-driver-and-bsd/">Original</a>
    <h1>GoToSocial WASM-based SQLite driver and BSD</h1>
    
    <div id="readability-page-1" class="page"><article><h4><i></i>¬†
<time datetime="2024-11-05">2024-11-05
</time>¬†¬†
<i></i>¬†
1227 words, 6 minutes<ul><li><a href="http://tinylogger.com/tags/gotosocial">gotosocial</a></li><li><a href="http://tinylogger.com/tags/netbsd">netbsd</a></li><li><a href="http://tinylogger.com/tags/omnios">omnios</a></li><li><a href="http://tinylogger.com/tags/pkgsrc">pkgsrc</a></li><li><a href="http://tinylogger.com/tags/sqlite">sqlite</a></li></ul></h4><nav id="TableOfContents"><ol><li><a href="#introduction">Introduction</a></li><li><a href="#using-wasm-based-sqlite-driver-on-netbsd-or-omnios">Using WASM-based SQLite driver on NetBSD or OmniOS</a></li><li><a href="#fail-using-nowasm-on-omnios">(Fail) Using nowasm on OmniOS</a></li><li><a href="#using-nowasm-on-netbsd">Using nowasm on NetBSD</a></li><li><a href="#migration-from-wasm-to-nowasm">Migration from WASM to nowasm</a></li><li><a href="#conclusion">Conclusion</a></li></ol></nav><p>I started using <a href="https://github.com/superseriousbusiness/gotosocial/" target="_blank" rel="external nofollow">GoToSocial (the fast, fun and small ActivityPub
server)</a>
in 2022 on
OpenBSD. Because it was nearly the only OpenBSD-native ActivityPub
options at that time, because it was light and because it could use the
<a href="https://sqlite.org/" target="_blank" rel="external nofollow">SQLite database engine</a>
.</p><p>I stopped using it when <a href="https://cvsweb.openbsd.org/ports/www/gotosocial/Makefile?rev=1.12&amp;content-type=text/x-cvsweb-markup" target="_blank" rel="external nofollow">it was marked
BROKEN</a>
because of incompatibilities between modernc.org/sqlite and OpenBSD
kernel. This is when I switched to Mastodon and stop using it. Until
recently, when I discovered there was a
<a href="https://cdn.netbsd.org/pub/pkgsrc/current/pkgsrc/www/gotosocial/index.html" target="_blank" rel="external nofollow">pkgsrc</a>
option available.</p><p>I decided to use GoToSocial again this summer to communicate on the Fediverse
about what happens to the <a href="https://nogoo.me" target="_blank" rel="external nofollow">noGoo.me</a>
service; a
SearXNG instance I run on OpenBSD and that can be used by anybody.
Thanks to pkgsrc, GoToSocial would either run on a <a href="https://www.tumfatig.net/2024/running-gotosocial-on-netbsd/">NetBSD bhyve virtual
machine</a>
or
on am OmniOS/illumos zone; depending on what works and what doesn‚Äôt, and
depending on my daily mood ;-)</p><p>With version 0.16.0 ‚ÄúSnappy Sloth‚Äù, the project introduced an <a href="https://github.com/superseriousbusiness/gotosocial/pull/2863" target="_blank" rel="external nofollow">alternative wasm
sqlite3
implementation</a>
and it started having impacts on the program memory usage. With version
0.17.0 ‚ÄúSelective Sloth‚Äù, it became even worse and the devs made an
unsupported ‚Äúnowasm‚Äù option available which basically targets FreeBSD
and Linux 32-bits. On my NetBSD VM or the OmniOS zone, I need to allocate 4GB
of RAM for GtS to start even though this is a single user instance that
posts like 5 messages a week. Given that my OmniOS hypervisor has 128GB
of RAM, this is not a problem for me but GoToSocial is supposed to be
light so there must be ways to have it light on non-Linux 64-bit
platforms‚Ä¶</p><p>I could simply switch to some Linux implementation but‚Ä¶</p><blockquote><p>‚ÄúStrength lies in differences, not in similarities.‚Äù ‚Äì Stephen Covey</p></blockquote><p>Disclaimer: I never tried running GtS on FreeBSD or OpenBSD these days.
What follows may apply to those OSes or be totally useless.</p><p>Whether you‚Äôre using pkgsrc binary packages or compile GoToSocial using
the pkgsrc source tree, you‚Äôll get a WASM (GO_BUILDTAGS=‚Äúwasmsqlite3‚Äù) enabled version of the
software. Depending on the time you run the installation (or the
compilation), your version of GtS may differ. There are <a href="https://marc.info/?l=pkgsrc-users&amp;m=173022773724582&amp;w=2" target="_blank" rel="external nofollow">patches for
version 0.17.1</a>
on their way that may not be committed yet.</p><p>No matter if I used an OmniOS pkgsrc branded zone or a NetBSD bhyve
virtual machine, resource usage was about the same running GtS 0.17.0 in
WASM mode: CPU usage was rather low but the gotosocial process used
about 1GB of RSS memory and 6GB of virtual memory. There seem to be a
4GB of memory that is required for accessing the SQLite database when
the program starts.</p><p>The working settings is used were:</p><ul><li>db-type: ‚Äúsqlite‚Äù</li><li>db-address: ‚Äú/var/db/gotosocial/sqlite.db‚Äù</li><li>db-max-open-conns-multiplier: 8</li><li>db-sqlite-journal-mode: ‚ÄúWAL‚Äù</li><li>db-sqlite-synchronous: ‚ÄúNORMAL‚Äù</li></ul><p>Trying to compile GoToSocial 0.17.1 with the <code>GO_BUILDTAGS=&#34;nowasm&#34;</code>
option failed whatever I tried. The error looked like :</p><pre tabindex="0"><code># modernc.org/libc
vendor/modernc.org/libc/libc_unix.go:1308:34:
  (*ctime.Tm)(unsafe.Pointer(tm)).Ftm_gmtoff undefined (type
  *struct{Ftm_sec int32; Ftm_min int32; Ftm_hour int32; Ftm_mday int32;
  Ftm_mon int32; Ftm_year int32; Ftm_wday int32; Ftm_yday int32; Ftm_isdst
  int32} has no field or method Ftm_gmtoff)
vendor/modernc.org/libc/libc_unix.go:1309:34:
  (*ctime.Tm)(unsafe.Pointer(tm)).Ftm_zone undefined (type *struct{Ftm_sec
  int32; Ftm_min int32; Ftm_hour int32; Ftm_mday int32; Ftm_mon int32;
  Ftm_year int32; Ftm_wday int32; Ftm_yday int32; Ftm_isdst int32} has no
  field or method Ftm_zone)
  *** Error code 1
</code></pre><p>There is a <a href="https://github.com/superseriousbusiness/gotosocial/issues/2952" target="_blank" rel="external nofollow">closed pull
request</a>
that indicates this should work someday. I couldn‚Äôt compile it, even
adding the <code>sqlite3_flock</code> flags. Maybe it will work on next GtS release‚Ä¶</p><p>After patching my local pkgsrc tree, I could compile GoToSocial 0.17.1
‚ÄúVery Selective Sloth‚Äù on NetBSD, without WASM, using <code>env PKG_OPTIONS.gotosocial=nowasm make build</code>. This modification runs the
build script with <code>GO_BUILDTAGS=&#34;nowasm&#34;</code> configured.</p><p>Unfortunately, replacing the wasm binary with the nowasm binary,
GoToSocial would not start anymore. Even starting with an empty (or non
existent) <code>sqlite.db</code>, errors would raise and make the program die:</p><pre tabindex="0"><code>func=cache.(*Caches).Start level=INFO msg=&#34;start: 0xc001548008&#34;
unexpected fault address 0x7f7fb11c556b fatal error: fault
[signal SIGBUS: bus error code=0x2 addr=0x7f7fb11c556b pc=0x1f6be2f]

goroutine 1 gp=0xc0000061c0 m=0 mp=0x44f2ce0 [running]:
runtime.throw({0x28b01f9?, 0x100000000?})
        runtime/panic.go:1067 +0x48 fp=0xc0009e9a20 sp=0xc0009e99f0 pc=0x470088
runtime.sigpanic()
        runtime/signal_unix.go:897 +0x18a fp=0xc0009e9a80 sp=0xc0009e9a20 pc=0x4722aa
modernc.org/libc.Xmemcpy(...)
        modernc.org/libc@v1.55.3/libc.go:1745
(...)
</code></pre><p>I could finally have GtS start with an empty database when I changed the
db-sqlite-journal-mode setting to ‚ÄúTRUNCATE‚Äù.</p><p>The working nowasm settings I used were:</p><ul><li>db-type: ‚Äúsqlite‚Äù</li><li>db-address: ‚Äú/var/db/gotosocial/sqlite.db‚Äù</li><li>db-max-open-conns-multiplier: 8</li><li>db-sqlite-journal-mode: ‚ÄúTRUNCATE‚Äù</li><li>db-sqlite-synchronous: ‚ÄúNORMAL‚Äù</li></ul><p>Still, there were no settings that allowed me to recover my existing
data by transferring the <code>sqlite.*</code> files; as I normally do. So I went
for another SQLite backup / restore method. See next section.</p><p>With the empty database, resources consumption of the gotosocial process
was finally quite low again: very low CPU, 84M of RSS memory and 1.2GB
of Virtual Memory. I could then switch my NetBSD VM back to using 1 vCPU
and 1GB of vRAM. The 4GB of RAM to access the SQLite database aren‚Äôt
required anymore.</p><p>The migration from one OS to the other is straightforward when the GtS
version and the WASM feature are the same. I also could upgrade from
0.17.0 WASM on NetBSD to 0.17.1 WASM on OmniOS.</p><p>But when it comes to switching from WASM to nowasm, the gotosocial
binary quickly dies exposing line of logs that I am not smart enough to
understand. To my eyes, it was like ‚Äúblah blah memory allocation failed
blah blah trying to open sqlite.db blah blah modernc.org/sqlite blah
blah dies‚Äù.</p><p>Hopefully, after a helpful discussion with the kind GtS devs who pointed
me towards configuration options to try and what is expected (or not)
regarding SQLite data migration, I finally got a stable way to migrate
my existing data from a WASM instance to a nowasm instance. Here‚Äôs the
receipt so that you don‚Äôt enjoy the same adventure I encountered:
üå¨Ô∏èüåäüö£‚õàÔ∏è</p><p>On the ‚Äúold‚Äù WASM GoToSocial instance, stop GtS, make a copy of the
configuration file and the storage directory. Then use the <code>sqlite3</code>
command to make a proper flat export of the SQLite database. On my
initial OmniOS zone, it looked like this:</p><pre tabindex="0"><code># svcadm disable svc:/pkgsrc/gotosocial:default

# tar cpf gts-backup.tar /opt/local/etc/gotosocial /var/db/gotosocial
# sqlite3 /var/db/gotosocial/sqlite.db .dump &gt; gts-sqlite.dump.sql
# gzip -f gts-backup.tar gts-sqlite.dump.sql
</code></pre><p>Transfer the backup archives to the ‚Äúnew‚Äù nowasm GoToSocial instance. In
my case, this is a NetBSD 10.0_STABLE byhve virtual machine. I adapted
the configuration file with the correct db-sqlite-journal-mode
parameter, extracted the storage directory content and recreated a sane
sqlite.db file using the <code>sqlite3</code> command.</p><pre tabindex="0"><code># tar xzpf gts-backup.tar.gz -C / /var/db/gotosocial/storage

# rm /var/db/gotosocial/sqlite.db*
# sudo -u gotosocial sh -c \
  &#34;zcat gts-sqlite.dump.sql.gz | sqlite3 /var/db/gotosocial/sqlite.db&#34;
</code></pre><p>GoToSocial can now be started. It will check the database and apply
migration commands if required.</p><p>Note that in this configuration, <code>ffmpeg</code> needs to be installed on the
system. GtS expects the command to have this exact name and to be
located in the <code>PATH</code> environment variable.</p><pre tabindex="0"><code># pkgin in ffmpeg7
# ln -s /usr/pkg/bin/ffmpeg7 /usr/pkg/bin/ffmpeg
# ln -s /usr/pkg/bin/ffprobe7 /usr/pkg/bin/ffprobe

# grep -B2 PATH /etc/rc.conf
# Add local overrides below.
#
export PATH=$PATH:/usr/pkg/sbin:/usr/pkg/bin:/usr/local/sbin:/usr/local/bin
</code></pre><p>The following dashboard illustrate the memory gain of switching to
nowasm; the switch occurred on the 31/10/2024.</p><p><a target="_blank" href="https://www.tumfatig.net/images/2024/grafana-gotosocial-netbsd-nowasm.jpg"><img src="https://www.tumfatig.net/images/2024/grafana-gotosocial-netbsd-nowasm.jpg" alt="A Grafana dashboard displaying GoToSocial resource usage"/></a></p><p>The program is stable and has not crashed during the last week. There
wasn‚Äôt any error while using WASM on OmniOS either. So you can choose
whether you want to compile GtS with a special flag or give it a bit
more memory than what a light daemon should get :)</p></article></div>
  </body>
</html>
