<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gitlab.com/owl-lisp/owl">Original</a>
    <h1>Owl Lisp â€“ A functional Scheme for world domination</h1>
    
    <div id="readability-page-1" class="page"><div id="observablehq-main">


<p><img src="https://mclare.blog/_file/posts/simple-map-dashboards-with-observable-framework/new_dashboard.1e63bc4b.gif" alt="New Dashboard"/></p>
<p>
  <a href="https://mclare.dev/nyc-building-complaints" target="_blank" rel="noopener noreferrer">NYC Department of Buildings Active 311 Complaints</a>
</p>
<h2 id="previous-work" tabindex="-1"><a href="#previous-work">Previous work</a></h2>
<p>After some publicized incidents in NYC with building maintenance lasy year, I threw together an interactive map of all of the complaints lodged to the 311 department with the NYC Department of Buildings. To my surprise, there were over 600k complaints that were active (out of over 3 million records), with many of them lacking any inspection date or resolution. The volume of complaints gave me pause, so I didn&#39;t end up writing it up or publicizing it much (the app was thrown together in a weekend, and the code looked it). I also wasn&#39;t happy with the fact that it was a snapshot of data that is updated on a pretty regular basis (unlike the National Bridge Inventory), so I put the application on the backburner until I had more time to figure out a simple ETL with mapping pipeline that I could run off a CRON job locally on a daily or weekly basis.</p>
<p><img src="https://mclare.blog/_file/posts/simple-map-dashboards-with-observable-framework/old_map.d86ee6e9.gif" alt="Initial NYC DOB Complaint Map"/></p>
<h2 id="bad-data" tabindex="-1"><a href="#bad-data">Bad Data</a></h2>
<p>As it turns out, the data <em>was</em> bad (I pulled the information in April 2023). When I picked this project up a week ago, the first thing I did was the full CSV download from <a href="https://data.cityofnewyork.us/Housing-Development/DOB-Complaints-Received/eabe-havv/about_data" target="_blank" rel="noopener noreferrer">NYC Open Data</a>, and I noticed that the number of complaints in the db had <em>decreased</em> by a count of nearly 500k records! And that 600k &#34;ACTIVE&#34; complaint volume was now less than 30k. Without some inspection heroics, there was no way that it indicated a massive increase in inspections in 2023-2024, so I used <a href="https://www.visidata.org/" target="_blank" rel="noopener noreferrer">Visidata</a> to do some quick and dirty comparisons between the two data sets.</p>
<p><a href="https://www.visidata.org/" target="_blank" rel="noopener noreferrer">Visidata</a> has this neat feature where you can effectively do a df.merge on two different files with a few keystrokes:</p>
<pre data-language="sh"><code>vd /Users/mclare/DOB_Complaints_Received.csv /Users/mclare/DOB_Complaints_Received_20241121.csv
</code></pre>
<p>I made the complaint number the key column on two sheets, one of which was filtered to the ACTIVE data only (to get those 600k entries)</p>
<pre><code>s s &amp; inner
</code></pre>
<p>which created a join sheet based on the <code>inner</code> join between the two data sets.</p>
<p><img src="https://mclare.blog/_file/posts/simple-map-dashboards-with-observable-framework/visidata.4784f71e.png" alt="Visidata Sheets View"/></p>
<p>Discrepancies I found:</p>
<ul>
<li>There were a number of duplicate keys/complaints (rows that had zero difference across all fields).</li>
<li>The original dump had a variety of values in the <code>dob_run_date</code> field, which <em>should</em> have been the current date (as in the date I pulled the data, not some time in 2018).</li>
</ul>
<p>I don&#39;t know when/where the discrepancies were dealt with, but since I started pulling data last week, I&#39;m getting a consistent <code>dob_run_date</code> for all records.</p>
<h2 id="python-data-loaders-with-the-us-census-geocoder" tabindex="-1"><a href="#python-data-loaders-with-the-us-census-geocoder">Python Data Loaders with the US Census Geocoder</a></h2>
<p>The first time I did this, I mixed in a lot of different scripts while I was initially exploring the data. I&#39;d used Node and D3 for some things, and then Python/Visidata/Pandas for others. I decided to unify everything into a single <a href="https://observablehq.com/framework/data-loaders" target="_blank" rel="noopener noreferrer">data loader</a> that ran a Python script to do the following:</p>
<ol>
<li>Query the NYC Open Data API for <em>only</em> active complaints (this was very easy to set up an API key, which I tested with Postman)</li>
<li>Load the result of the API call into a dataframe, and create a new column for the concatenated address string required for a geocoder.</li>
<li>Dedupe the address strings, and check against the existing geocode address file that I had from my previous exploration. This was done to avoid making unnecessary calls to the <a href="https://geocoding.geo.census.gov/geocoder/" target="_blank" rel="noopener noreferrer">US Census Geocoder</a></li>
<li>The US Census Geocoder allows a maximum batch request of 10000 entries. I took the address strings that didn&#39;t turn up a match in the existing geocode file and split them into equal chunks to make asynchronous requests to the geocoder, and then stitched the results of the async calls together.</li>
<li>Merged the complaint data frame with the unique address one as a <code>inner</code> join, to get a dataframe with <em>only</em> matched lat/longs from the geocoder.</li>
<li>Used the merged df to generate a <code>FeatureCollection</code> that I could feed into <a href="https://github.com/felt/tippecanoe" target="_blank" rel="noopener noreferrer"><code>tippcanoe</code></a> to generate <a href="https://protomaps.com/" target="_blank" rel="noopener noreferrer">Protomaps</a> vector maptiles (<code>pmtiles</code>, rather than <code>mbtiles</code>)</li>
</ol>
<p>One of the requirements for using data loaders with Observable Framework is that you need to feed something to <code>stdout</code>, because the mechanism for running the data loader in the first place depends on whether the file generated by the data loader already exists in the cache. So technically I had to write a shell script as a data loader that ran the python script and then ran <code>tippecanoe</code>, with the <code>complaints.csv</code> as the required artifact generated by the data loader and the <code>pmtiles</code> file from <code>tippecanoe</code> command as a side effect.</p>
<p>If I was expecting a giant file of complaints, I&#39;d probably revise this process further, but I was only getting about 3.5mb for <code>complaints.csv</code>, which is fine for loading into the browser at runtime for some of the other non-map elements in the dashboard.</p>
<pre data-language="sh"><code><span>#!/usr/bin/env sh</span>

DATE=$(<span>date</span> +%Y-%m-%d)

<span>cd</span> ~/workspaces/nyc-dob-observable/src/data || <span>exit</span>
~/.virtualenvs/nyc-dob/bin/python3 complaints.py

tippecanoe -z20 -o <span>&#34;nyc-buildings.pmtiles&#34;</span> -r1 <span>&#39;--cluster-distance=1&#39;</span> --cluster-densest-as-needed --no-tile-size-limit --extend-zooms-if-still-dropping <span>&#34;<span>${DATE}</span>_nycdob_rollup.json&#34;</span> -l <span>&#34;nyc-buildings&#34;</span> --force

<span>rm</span> <span>&#34;<span>${DATE}</span>_nycdob_rollup.json&#34;</span>
</code></pre>
<p>So now I had a <code>csv</code> of complaints, and a <code>pmtiles</code> vector tileset for all the complaints I was able to geocode with the US Census Geocoder. FWIW, I was able to get a ~98% address match with the <em>free</em> geocoder, which is good enough for me on a side project.</p>
<h2 id="observable-framework-components" tabindex="-1"><a href="#observable-framework-components">Observable Framework Components</a></h2>
<p>I&#39;ve already built <a href="https://mclare.blog/posts/building-oss-map-apps-with-observable-framework/" target="_blank" rel="noopener noreferrer">one map</a> with Observable Framework, but this time around I wanted to try to make more reusable components. I was only partially successful due to hitting some edges with Observable Framework.</p>
<p>Things I couldn&#39;t do with Observable Framework:</p>
<ul>
<li>import <code>json</code> files into <code>React</code> components (I had some classification data dumps for the categories that are JSON files)</li>
<li>use existing styling from the old map with <a href="https://mui.com/material-ui/" target="_blank" rel="noopener noreferrer">Material UI</a>. This appears to have been a pain point for others <a href="https://github.com/observablehq/framework/discussions/1464" target="_blank" rel="noopener noreferrer">as well</a>!</li>
<li>import styled components from <a href="https://ant.design/" target="_blank" rel="noopener noreferrer">Ant Design</a></li>
<li>import <code>css</code> files into <code>React</code> components (so I couldn&#39;t use CSS modules either :( )</li>
</ul>
<p>I ended up resorting to styling within the React components themselves (but not inline at least).</p>
<pre data-language="js"><code><span>const</span> styles = {
  <span>keyStyle</span>: {
    <span>display</span>: <span>&#34;inline&#34;</span>,
    <span>fontWeight</span>: <span>700</span>,
    <span>textTransform</span>: <span>&#34;uppercase&#34;</span>,
    <span>fontSize</span>: <span>&#34;0.875rem&#34;</span>,
    <span>letterSpacing</span>: <span>&#34;0.02857em&#34;</span>,
    <span>fontFamily</span>: <span>&#39;&#34;Roboto&#34;,&#34;Helvetica&#34;,&#34;Arial&#34;,sans-serif&#39;</span>,
  },
  <span>valueStyle</span>: {
    <span>display</span>: <span>&#34;inline&#34;</span>,
    <span>fontSize</span>: <span>&#34;0.875rem&#34;</span>,
    <span>fontFamily</span>: <span>&#39;&#34;Roboto&#34;,&#34;Helvetica&#34;,&#34;Arial&#34;,sans-serif&#39;</span>,
  },
  <span>entryContainer</span>: {
    <span>marginBottom</span>: <span>&#34;0.5rem&#34;</span>,
  },
};
</code></pre>
<p>Things I could do with Observable Framework:</p>
<ul>
<li>create <code>React</code> components with state! I used this to be able to keep the HUD from my original map.</li>
<li>quickly additional plots with Observable Plot based on the original <code>complaints.csv</code> file. I added a table view of the raw data, as well as a multi-select component for viewing complaints grouped by complaint type and borough.</li>
</ul>
<blockquote>
<p>Is anyone surprised that the most prevalent complaint is for Illegal Conversion of a building?</p>
</blockquote>
<p>My <code>index.md</code> file still feels a bit too verbose, but there was only so much I could make into components at this point, particularly with the recurring import errors. I still can&#39;t reference files (like the tilesets) from a component, so all that loading logic has to exist in the Markdown file. I also haven&#39;t figured out (except for adding to the CRON script itself) how to dump the cache for every run. If I don&#39;t dump the cache, the data loader won&#39;t re-run, so I won&#39;t get an up to date map or data set. I was hoping to handle this by using environment variables to check if a file for the date of the CRON job exists already, but this doesn&#39;t seem to work currently <a href="https://github.com/observablehq/framework/discussions/1737" target="_blank" rel="noopener noreferrer">outside data loaders or page loaders</a> in Observable Framework, so I can&#39;t have an env variable inside the markdown file (or React components).</p>
<h6 id="github-repo-nyc-dob-complaint-map-observable" tabindex="-1">Github Repo: <a href="https://github.com/m-clare/nyc-dob-complaint-map-observable" target="_blank" rel="noopener noreferrer">nyc-dob-complaint-map-observable</a></h6>
<h6 id="final-site-nyc-department-of-buildings-active-311-complaints" tabindex="-1">Final site: <a href="https://mclare.dev/nyc-building-complaints/" target="_blank" rel="noopener noreferrer">NYC Department of Buildings Active 311 Complaints</a></h6>
<p><img src="https://mclare.blog/_file/posts/simple-map-dashboards-with-observable-framework/bar_plot.953fad23.png" alt="Bar Plot"/></p>
<p><img src="https://mclare.blog/_file/posts/simple-map-dashboards-with-observable-framework/map.5ed88f13.png" alt="Final Map"/></p>
</div></div>
  </body>
</html>
