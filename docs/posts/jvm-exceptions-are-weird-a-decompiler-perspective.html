<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://purplesyringa.moe/blog/jvm-exceptions-are-weird-a-decompiler-perspective/">Original</a>
    <h1>JVM exceptions are weird: a decompiler perspective</h1>
    
    <div id="readability-page-1" class="page"><section><div><h2>JVM exceptions are weird: a decompiler perspective</h2><p><time>November 2, 2025</time><a href="https://news.ycombinator.com/item?id=45808899"> Hacker News</a><a href="https://lobste.rs/s/ooxamp/jvm_exceptions_are_weird_decompiler"> Lobsters</a></p><p>Some time ago, I played around with decompiling Java class files in a more efficient manner than traditional solutions like <a href="https://github.com/Vineflower/vineflower">Vineflower</a> allow. Eventually, I wrote <a href="https://novalis.org/recovering-control-flow-structures-without-cfgs/">an article</a> on my approach to decompiling control flow, which was a great performance boost for my prototype.</p><p>At the time, I believed that this method can be straightforwardly extended to handling exceptional control flow, i.e. decompiling <code>try</code>…<code>catch</code> blocks. In retrospect, I should’ve known it wouldn’t be so easy. It turns out that there are many edge cases, ranging from strange <code>javac</code> behavior to consequences of the JVM design and the class file format, that significantly complicate this. In this post, I’ll cover these details, why simple solutions don’t work, and what approach I’ve eventually settled on.</p><p>JVM is a stack-based language. The majority of instructions interact exclusively with the stack, e.g. <code>iadd</code> pop two integers off the top of the stack and pushes their sum back. A small handful of instructions, like <code>if_icmpeq</code>, transfer control to a given address based on whether a primitive condition holds (e.g. <code>value1 == value2</code> in this case). That is sufficient to implement <code>if</code>, <code>while</code>, and many other explicit control flow constructs.</p><p>Exceptional control flow, however, is implicit, so it cannot be handled the same way. A single <code>try</code> block should catch all exceptions arising in its region, be that exceptions forwarded from a method call in <code>invokevirtual</code>, division by zero in <code>idiv</code>, or null pointer dereference in <code>getfield</code>. Such relations cannot be efficiently encoded in the bytecode itself, so they are stored separately in the <em>exception table</em>.</p><p>Each entry of the exception table specifies which region of instructions is associated with which exception handler. If an exception is raised within such a region, the stack is cleared, the exception object is pushed onto the stack, and control is transferred to the first instruction of the handler.</p><p>For example, here’s what the bytecode and the exception table look like for a simple method containing one <code>try</code>…<code>catch</code> block (produced with <code>javap -c</code>):</p><pre><code><span>static</span> <span>void</span> <span>method</span><span>()</span> {
    <span>try</span> {
        System.out.println(<span>&#34;Hello, world!&#34;</span>);
    } <span>catch</span> (Exception ex) {
        System.out.println(<span>&#34;Oops, an error happened&#34;</span>);
    }
}
</code></pre><pre><code>Code:
   
   <span>0</span>: getstatic     #<span>7</span>                  
   <span>3</span>: ldc           #<span>13</span>                 
   <span>5</span>: invokevirtual #<span>15</span>                 
   
   <span>8</span>: goto          <span>20</span>
   
   
  <span>11</span>: astore_0
   
  <span>12</span>: getstatic     #<span>7</span>                  
  <span>15</span>: ldc           #<span>23</span>                 
  <span>17</span>: invokevirtual #<span>15</span>                 
   
  <span>20</span>: <span>return</span>
Exception table:
   from    to  target type
   
   
       <span>0</span>     <span>8</span>    <span>11</span>   Class java/lang/Exception
</code></pre><p>If there are multiple rows in the exception table, the first matching one is used. For example, if there are nested <code>try</code> blocks, the inner <code>try</code> block will be listed first, followed by the outer one.</p><p>Note that the exception table is just a list of regions. JVM imposes no requirements on the nesting structure of those regions: for example, it’s possible for two ranges to intersect without one being nested in the other, and it’s possible for <code>target</code> to be located before <code>from</code> or even inside the <code>from</code>…<code>to</code> range.</p><p>As we’ll soon see, this is not a hypothetical, and real-world class files do often violate these “obvious” assumptions. This makes the problem important to handle well not only if you’re building an unconditionally correct decompiler, like I’m trying to do, but any decompiler.</p><p>Before we tackle this, we need to discuss how javac handles <code>try</code>…<code>finally</code> blocks. The body of <code>finally</code> should be executed regardless of whether an exception is thrown, but where the control is transferred after the end of <code>finally</code> depends on the presence of an exception:</p><p><svg viewBox="-68.680783 -68.679778 353.354955 68.23032" height="68.23032pt" version="1.1" width="353.354955pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path d="M4.722291 0H5.846077V-.095641C5.702615-.430386 5.630884-.896638 5.630884-1.482441V-4.387547C5.606974-5.021171 5.391781-5.523288 4.985305-5.881943C4.566874-6.240598 3.993026-6.43188 3.275716-6.43188C2.809465-6.43188 2.391034-6.336239 2.008468-6.168867S1.315068-5.762391 1.099875-5.475467C.872727-5.188543 .765131-4.877709 .765131-4.566874H1.853051C1.853051-4.841843 1.984558-5.080946 2.247572-5.272229S2.833375-5.559153 3.21594-5.559153C3.646326-5.559153 3.981071-5.439601 4.208219-5.224408C4.423412-4.99726 4.542964-4.698381 4.542964-4.327771V-3.825654H3.490909C2.582316-3.825654 1.888917-3.634371 1.3868-3.275716S.633624-2.402989 .633624-1.745455C.633624-1.207472 .824907-.765131 1.231382-.406476C1.625903-.047821 2.139975 .119552 2.761644 .119552C3.455044 .119552 4.064757-.143462 4.566874-.669489C4.60274-.3467 4.65056-.119552 4.722291 0ZM2.929016-.824907C2.570361-.824907 2.283437-.920548 2.056289-1.111831S1.721544-1.566127 1.721544-1.900872C1.721544-2.666002 2.379078-3.060523 3.706102-3.060523H4.542964V-1.769365C4.399502-1.482441 4.184309-1.255293 3.88543-1.08792C3.574595-.908593 3.263761-.824907 2.929016-.824907Z" id="g0-97"></path><path d="M3.347447-.765131C2.785554-.765131 2.355168-.956413 2.056289-1.350934S1.613948-2.307347 1.613948-3.036613V-3.239851C1.613948-3.981071 1.75741-4.554919 2.068244-4.94944C2.367123-5.34396 2.797509-5.547198 3.347447-5.547198C3.753923-5.547198 4.088667-5.415691 4.375592-5.152677C4.65056-4.889664 4.805978-4.554919 4.841843-4.148443H5.858032C5.822167-4.817933 5.571108-5.36787 5.104857-5.798257C4.638605-6.216687 4.052802-6.43188 3.347447-6.43188C2.773599-6.43188 2.271482-6.300374 1.853051-6.03736C1.422665-5.774346 1.099875-5.391781 .872727-4.913574S.537983-3.88543 .537983-3.275716V-3.096389C.537983-2.092154 .789041-1.315068 1.291158-.74122S2.486675 .119552 3.347447 .119552C3.777833 .119552 4.184309 .02391 4.566874-.167372S5.248319-.621669 5.487422-.956413C5.71457-1.291158 5.834122-1.637858 5.858032-1.996513H4.841843C4.805978-1.637858 4.638605-1.350934 4.351681-1.111831S3.730012-.765131 3.347447-.765131Z" id="g0-99"></path><path d="M.549938-3.21594V-3.132254C.549938-2.163885 .777086-1.374844 1.243337-.777086C1.697634-.179328 2.295392 .119552 3.036613 .119552C3.801743 .119552 4.411457-.155417 4.841843-.681445L4.889664 0H5.881943V-8.966376H4.805978V-5.678705C4.375592-6.180822 3.789788-6.43188 3.048568-6.43188S1.697634-6.133001 1.243337-5.547198C.777086-4.961395 .549938-4.184309 .549938-3.21594ZM1.637858-3.084433C1.637858-3.88543 1.78132-4.495143 2.080199-4.901619C2.367123-5.308095 2.785554-5.511333 3.311582-5.511333C3.981071-5.511333 4.471233-5.224408 4.805978-4.62665V-1.721544C4.483188-1.099875 3.981071-.800996 3.299626-.800996C2.773599-.800996 2.367123-.992279 2.080199-1.398755C1.78132-1.80523 1.637858-2.367123 1.637858-3.084433Z" id="g0-100"></path><path d="M3.443088 .119552C4.495143 .119552 5.296139-.286924 5.822167-1.099875L5.164633-1.613948C4.961395-1.350934 4.722291-1.147696 4.459278-.992279S3.873474-.765131 3.490909-.765131C2.952927-.765131 2.510585-.956413 2.163885-1.338979S1.637858-2.223661 1.625903-2.84533H5.905853V-3.299626C5.905853-4.303861 5.66675-5.068991 5.212453-5.618929C4.758157-6.156912 4.112578-6.43188 3.299626-6.43188C2.797509-6.43188 2.331258-6.288418 1.900872-6.01345C1.470486-5.726526 1.135741-5.34396 .896638-4.853798S.537983-3.801743 .537983-3.180075V-2.988792C.537983-2.032379 .800996-1.279203 1.350934-.71731C1.888917-.155417 2.582316 .119552 3.443088 .119552ZM3.299626-5.547198C3.753923-5.547198 4.112578-5.391781 4.375592-5.092902C4.638605-4.782067 4.782067-4.363636 4.817933-3.813699V-3.730012H1.661768C1.721544-4.303861 1.900872-4.746202 2.199751-5.068991C2.486675-5.379826 2.857285-5.547198 3.299626-5.547198Z" id="g0-101"></path><path d="M1.350934 0H2.426899V-5.475467H3.777833V-6.312329H2.426899V-6.981818C2.426899-7.364384 2.52254-7.651308 2.713823-7.854545S3.16812-8.16538 3.526775-8.16538C3.730012-8.16538 3.921295-8.141469 4.112578-8.117559L4.172354-8.990286C3.921295-9.050062 3.670237-9.085928 3.431133-9.085928C2.761644-9.085928 2.247572-8.894645 1.888917-8.53599C1.530262-8.16538 1.350934-7.639352 1.350934-6.969863V-6.312329H.3467V-5.475467H1.350934V0Z" id="g0-102"></path><path d="M1.900872-5.547198V-8.966376H.812951V0H1.900872V-4.495143C2.044334-4.805978 2.247572-5.045081 2.510585-5.236364C2.773599-5.415691 3.084433-5.511333 3.443088-5.511333C3.873474-5.511333 4.184309-5.403736 4.399502-5.188543C4.60274-4.97335 4.710336-4.638605 4.710336-4.184309V0H5.786301V-4.172354C5.762391-5.678705 5.092902-6.43188 3.765878-6.43188C3.000747-6.43188 2.379078-6.133001 1.900872-5.547198Z" id="g0-104"></path><path d="M1.996513 0V-6.312329H.908593V0H1.996513ZM.824907-7.986052C.824907-7.806725 .872727-7.663263 .980324-7.543711S1.243337-7.376339 1.458531-7.376339C1.661768-7.376339 1.817186-7.424159 1.936737-7.543711C2.044334-7.663263 2.10411-7.806725 2.10411-7.986052C2.10411-8.153425 2.044334-8.308842 1.936737-8.428394C1.817186-8.547945 1.661768-8.619676 1.458531-8.619676C1.243337-8.619676 1.08792-8.547945 .980324-8.428394S.824907-8.153425 .824907-7.986052Z" id="g0-105"></path><path d="M1.996513 0V-8.966376H.908593V0H1.996513Z" id="g0-108"></path><path d="M1.841096-6.312329H.812951V0H1.900872V-4.495143C2.044334-4.805978 2.247572-5.045081 2.510585-5.236364C2.773599-5.415691 3.084433-5.511333 3.443088-5.511333C3.873474-5.511333 4.184309-5.403736 4.399502-5.188543C4.60274-4.97335 4.710336-4.638605 4.710336-4.184309V0H5.786301V-4.172354C5.762391-5.678705 5.092902-6.43188 3.765878-6.43188C2.988792-6.43188 2.355168-6.121046 1.876961-5.523288L1.841096-6.312329Z" id="g0-110"></path><path d="M.526027-3.21594V-3.144209C.526027-2.163885 .789041-1.374844 1.327024-.777086C1.853051-.179328 2.546451 .119552 3.407223 .119552C3.969116 .119552 4.471233-.011955 4.913574-.286924C5.34396-.561893 5.678705-.944458 5.917808-1.43462C6.156912-1.912827 6.276463-2.462765 6.276463-3.084433V-3.16812C6.276463-4.148443 6.001494-4.937484 5.475467-5.535243S4.25604-6.43188 3.395268-6.43188C2.833375-6.43188 2.331258-6.288418 1.900872-6.025405S1.123786-5.379826 .884682-4.889664C.645579-4.387547 .526027-3.837609 .526027-3.21594ZM1.613948-3.084433C1.613948-3.873474 1.769365-4.471233 2.10411-4.901619C2.426899-5.332005 2.857285-5.547198 3.395268-5.547198C3.945205-5.547198 4.375592-5.332005 4.710336-4.901619C5.033126-4.471233 5.200498-3.90934 5.200498-3.21594C5.200498-2.438854 5.033126-1.841096 4.710336-1.41071S3.957161-.765131 3.407223-.765131S2.426899-.968369 2.10411-1.398755C1.769365-1.817186 1.613948-2.379078 1.613948-3.084433Z" id="g0-111"></path><path d="M6.156912-3.084433V-3.19203C6.156912-4.208219 5.929763-4.99726 5.487422-5.571108S4.447323-6.43188 3.694147-6.43188C2.905106-6.43188 2.283437-6.156912 1.853051-5.618929L1.80523-6.312329H.812951V2.426899H1.900872V-.609714C2.331258-.119552 2.940971 .119552 3.706102 .119552C4.447323 .119552 5.045081-.167372 5.487422-.753176S6.156912-2.116065 6.156912-3.084433ZM5.068991-3.21594C5.068991-2.402989 4.913574-1.78132 4.614695-1.374844C4.303861-.968369 3.897385-.765131 3.383313-.765131C2.713823-.765131 2.223661-1.052055 1.900872-1.625903V-4.65056C2.223661-5.224408 2.713823-5.511333 3.371357-5.511333C3.897385-5.511333 4.303861-5.296139 4.614695-4.889664C4.913574-4.483188 5.068991-3.921295 5.068991-3.21594Z" id="g0-112"></path><path d="M3.873474-5.34396V-6.348194C3.753923-6.396015 3.598506-6.43188 3.395268-6.43188C2.737733-6.43188 2.235616-6.144956 1.888917-5.583064L1.865006-6.312329H.812951V0H1.900872V-4.483188C2.139975-5.080946 2.618182-5.391781 3.335492-5.391781C3.526775-5.379826 3.706102-5.36787 3.873474-5.34396Z" id="g0-114"></path><path d="M2.283437-7.84259H1.207472V-6.312329H.047821V-5.475467H1.207472V-1.566127C1.207472-1.016189 1.327024-.597758 1.566127-.310834S2.175841 .119552 2.666002 .119552C2.929016 .119552 3.203985 .083686 3.490909 0V-.872727C3.275716-.824907 3.096389-.800996 2.976837-.800996C2.713823-.800996 2.534496-.860772 2.438854-.992279C2.331258-1.111831 2.283437-1.303113 2.283437-1.566127V-5.475467H3.466999V-6.312329H2.283437V-7.84259Z" id="g0-116"></path><path d="M6.40797-1.494396L4.913574-6.312329H4.040847L2.570361-1.590037L1.327024-6.312329H.251059L2.080199 0H2.964882L4.459278-4.782067L5.989539 0H6.862267L8.703362-6.312329H7.627397L6.40797-1.494396Z" id="g0-119"></path><path d="M2.940971-4.004981L1.554172-6.312329H.298879L2.367123-3.19203L.239103 0H1.494396L2.952927-2.367123L4.411457 0H5.66675L3.526775-3.19203L5.595019-6.312329H4.339726L2.940971-4.004981Z" id="g0-120"></path><path d="M2.881196-1.578082L1.303113-6.312329H.131507L2.379078-.071731L2.139975 .573848C2.008468 .968369 1.841096 1.243337 1.637858 1.3868C1.422665 1.530262 1.135741 1.601993 .777086 1.601993L.490162 1.578082V2.462765L.896638 2.534496L1.099875 2.546451C1.960648 2.558406 2.582316 2.032379 2.976837 .980324L5.511333-6.312329H4.351681L2.881196-1.578082Z" id="g0-121"></path><path d="M1.183562 0H2.259527V-5.475467H3.550685V-6.312329H2.259527V-6.862267C2.259527-7.268742 2.355168-7.579577 2.570361-7.79477C2.773599-8.009963 3.108344-8.117559 3.574595-8.117559C4.004981-8.105604 4.471233-8.009963 4.961395-7.81868L5.140722-8.727273C4.471233-8.966376 3.921295-9.085928 3.490909-9.085928C2.749689-9.085928 2.187796-8.88269 1.78132-8.488169S1.183562-7.543711 1.183562-6.850311V-6.312329H.179328V-5.475467H1.183562V0ZM5.678705 0V-6.312329H4.590785V0H5.678705Z" id="g0-128"></path></defs><g id="page1"><path d="M29.433595-62.8633H43.6055C57.7813-62.8633 86.1289-40.1875 100.3008-40.1875H113.2773" fill="none" stroke="#f33" stroke-width="1.19553"></path><path d="M110.8476-44.01566C111.40229-41.71878 112.63276-40.632843 113.874947-40.187531C112.63276-39.738312 111.40229-38.65237 110.8476-36.3555" fill="none" stroke="#f33" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.19553"></path><g transform="matrix(1 0 0 1 -54.1306 -25.077)"><use x="29.433417" xlink:href="#g0-101" y="-34.516848"></use><use x="35.757705" xlink:href="#g0-110" y="-34.516848"></use><use x="42.344998" xlink:href="#g0-100" y="-34.516848"></use><use x="52.02867" xlink:href="#g0-111" y="-34.516848"></use><use x="58.843112" xlink:href="#g0-102" y="-34.516848"></use><use x="65.944473" xlink:href="#g0-116" y="-34.516848"></use><use x="69.84186" xlink:href="#g0-114" y="-34.516848"></use><use x="73.990294" xlink:href="#g0-121" y="-34.516848"></use></g><path d="M29.433595-6.1719H43.6055C57.7813-6.1719 86.1289-28.84766 100.3008-28.84766H113.2773" fill="none" stroke="#f33" stroke-miterlimit="10" stroke-width="1.19553"></path><path d="M110.8476-32.67966C111.40229-30.37888 112.63276-29.292938 113.874947-28.847626C112.63276-28.402313 111.40229-27.31638 110.8476-25.01559" fill="none" stroke="#f33" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="1.19553"></path><g transform="matrix(1 0 0 1 -98.1142 31.64049)"><use x="29.433417" xlink:href="#g0-101" y="-34.516848"></use><use x="35.757705" xlink:href="#g0-120" y="-34.516848"></use><use x="41.55595" xlink:href="#g0-99" y="-34.516848"></use><use x="47.8085" xlink:href="#g0-101" y="-34.516848"></use><use x="54.132787" xlink:href="#g0-112" y="-34.516848"></use><use x="60.839635" xlink:href="#g0-116" y="-34.516848"></use><use x="64.737022" xlink:href="#g0-105" y="-34.516848"></use><use x="67.630168" xlink:href="#g0-111" y="-34.516848"></use><use x="74.44461" xlink:href="#g0-110" y="-34.516848"></use><use x="83.98482" xlink:href="#g0-104" y="-34.516848"></use><use x="90.560164" xlink:href="#g0-97" y="-34.516848"></use><use x="97.051823" xlink:href="#g0-110" y="-34.516848"></use><use x="103.639117" xlink:href="#g0-100" y="-34.516848"></use><use x="110.369873" xlink:href="#g0-108" y="-34.516848"></use><use x="113.263019" xlink:href="#g0-101" y="-34.516848"></use><use x="119.587307" xlink:href="#g0-114" y="-34.516848"></use></g><g transform="matrix(1 0 0 1 89.3176 3.2698)"><use x="29.433417" xlink:href="#g0-128" y="-34.516848"></use><use x="36.044631" xlink:href="#g0-110" y="-34.516848"></use><use x="42.631924" xlink:href="#g0-97" y="-34.516848"></use><use x="49.123583" xlink:href="#g0-108" y="-34.516848"></use><use x="52.016729" xlink:href="#g0-108" y="-34.516848"></use><use x="54.909875" xlink:href="#g0-121" y="-34.516848"></use></g><path d="M238.0044-62.8633H225.0274C210.8514-62.8633 182.5074-40.1875 168.3324-40.1875H154.1604" fill="none" stroke="#f33" stroke-miterlimit="10" stroke-width="1.19553"></path><path d="M235.57437-66.69531C236.12515-64.39453 237.35952-63.308592 238.60171-62.86328C237.35952-62.417967 236.12515-61.33203 235.57437-59.03125" fill="none" stroke="#f33" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="1.19553"></path><g transform="matrix(1 0 0 1 213.6846 -25.077)"><use x="29.433417" xlink:href="#g0-97" y="-34.516848"></use><use x="35.925076" xlink:href="#g0-102" y="-34.516848"></use><use x="40.073521" xlink:href="#g0-116" y="-34.516848"></use><use x="43.970909" xlink:href="#g0-101" y="-34.516848"></use><use x="50.295196" xlink:href="#g0-114" y="-34.516848"></use><use x="57.288962" xlink:href="#g0-116" y="-34.516848"></use><use x="61.186349" xlink:href="#g0-114" y="-34.516848"></use><use x="65.334783" xlink:href="#g0-121" y="-34.516848"></use></g><path d="M238.0044-6.1719H225.0274C210.8514-6.1719 182.5074-28.84766 168.3324-28.84766H154.1604" fill="none" stroke="#f33" stroke-miterlimit="10" stroke-width="1.19553"></path><path d="M235.57437-10C236.12515-7.70312 237.35952-6.617187 238.60171-6.171875C237.35952-5.722656 236.12515-4.63672 235.57437-2.33984" fill="none" stroke="#f33" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="1.19553"></path><g transform="matrix(1 0 0 1 213.6846 32.79417)"><use x="29.433417" xlink:href="#g0-114" y="-34.516848"></use><use x="33.36667" xlink:href="#g0-101" y="-34.516848"></use><use x="39.690957" xlink:href="#g0-116" y="-34.516848"></use><use x="43.588344" xlink:href="#g0-104" y="-34.516848"></use><use x="50.163689" xlink:href="#g0-114" y="-34.516848"></use><use x="54.084977" xlink:href="#g0-111" y="-34.516848"></use><use x="60.89942" xlink:href="#g0-119" y="-34.516848"></use></g></g><title>A graph with two visible paths. The first path is &#34;end of try&#34; to &#34;finally&#34; to &#34;after try&#34;. The second path is &#34;exception handler&#34; to &#34;finally&#34; to &#34;rethrow&#34;. The same node is used for &#34;finally&#34; in both paths, resulting in a star-like topology.</title></svg></p><p><svg viewBox="-68.680783 -68.679778 353.354955 68.23032" height="68.23032pt" version="1.1" width="353.354955pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path d="M4.722291 0H5.846077V-.095641C5.702615-.430386 5.630884-.896638 5.630884-1.482441V-4.387547C5.606974-5.021171 5.391781-5.523288 4.985305-5.881943C4.566874-6.240598 3.993026-6.43188 3.275716-6.43188C2.809465-6.43188 2.391034-6.336239 2.008468-6.168867S1.315068-5.762391 1.099875-5.475467C.872727-5.188543 .765131-4.877709 .765131-4.566874H1.853051C1.853051-4.841843 1.984558-5.080946 2.247572-5.272229S2.833375-5.559153 3.21594-5.559153C3.646326-5.559153 3.981071-5.439601 4.208219-5.224408C4.423412-4.99726 4.542964-4.698381 4.542964-4.327771V-3.825654H3.490909C2.582316-3.825654 1.888917-3.634371 1.3868-3.275716S.633624-2.402989 .633624-1.745455C.633624-1.207472 .824907-.765131 1.231382-.406476C1.625903-.047821 2.139975 .119552 2.761644 .119552C3.455044 .119552 4.064757-.143462 4.566874-.669489C4.60274-.3467 4.65056-.119552 4.722291 0ZM2.929016-.824907C2.570361-.824907 2.283437-.920548 2.056289-1.111831S1.721544-1.566127 1.721544-1.900872C1.721544-2.666002 2.379078-3.060523 3.706102-3.060523H4.542964V-1.769365C4.399502-1.482441 4.184309-1.255293 3.88543-1.08792C3.574595-.908593 3.263761-.824907 2.929016-.824907Z" id="g0-97"></path><path d="M3.347447-.765131C2.785554-.765131 2.355168-.956413 2.056289-1.350934S1.613948-2.307347 1.613948-3.036613V-3.239851C1.613948-3.981071 1.75741-4.554919 2.068244-4.94944C2.367123-5.34396 2.797509-5.547198 3.347447-5.547198C3.753923-5.547198 4.088667-5.415691 4.375592-5.152677C4.65056-4.889664 4.805978-4.554919 4.841843-4.148443H5.858032C5.822167-4.817933 5.571108-5.36787 5.104857-5.798257C4.638605-6.216687 4.052802-6.43188 3.347447-6.43188C2.773599-6.43188 2.271482-6.300374 1.853051-6.03736C1.422665-5.774346 1.099875-5.391781 .872727-4.913574S.537983-3.88543 .537983-3.275716V-3.096389C.537983-2.092154 .789041-1.315068 1.291158-.74122S2.486675 .119552 3.347447 .119552C3.777833 .119552 4.184309 .02391 4.566874-.167372S5.248319-.621669 5.487422-.956413C5.71457-1.291158 5.834122-1.637858 5.858032-1.996513H4.841843C4.805978-1.637858 4.638605-1.350934 4.351681-1.111831S3.730012-.765131 3.347447-.765131Z" id="g0-99"></path><path d="M.549938-3.21594V-3.132254C.549938-2.163885 .777086-1.374844 1.243337-.777086C1.697634-.179328 2.295392 .119552 3.036613 .119552C3.801743 .119552 4.411457-.155417 4.841843-.681445L4.889664 0H5.881943V-8.966376H4.805978V-5.678705C4.375592-6.180822 3.789788-6.43188 3.048568-6.43188S1.697634-6.133001 1.243337-5.547198C.777086-4.961395 .549938-4.184309 .549938-3.21594ZM1.637858-3.084433C1.637858-3.88543 1.78132-4.495143 2.080199-4.901619C2.367123-5.308095 2.785554-5.511333 3.311582-5.511333C3.981071-5.511333 4.471233-5.224408 4.805978-4.62665V-1.721544C4.483188-1.099875 3.981071-.800996 3.299626-.800996C2.773599-.800996 2.367123-.992279 2.080199-1.398755C1.78132-1.80523 1.637858-2.367123 1.637858-3.084433Z" id="g0-100"></path><path d="M3.443088 .119552C4.495143 .119552 5.296139-.286924 5.822167-1.099875L5.164633-1.613948C4.961395-1.350934 4.722291-1.147696 4.459278-.992279S3.873474-.765131 3.490909-.765131C2.952927-.765131 2.510585-.956413 2.163885-1.338979S1.637858-2.223661 1.625903-2.84533H5.905853V-3.299626C5.905853-4.303861 5.66675-5.068991 5.212453-5.618929C4.758157-6.156912 4.112578-6.43188 3.299626-6.43188C2.797509-6.43188 2.331258-6.288418 1.900872-6.01345C1.470486-5.726526 1.135741-5.34396 .896638-4.853798S.537983-3.801743 .537983-3.180075V-2.988792C.537983-2.032379 .800996-1.279203 1.350934-.71731C1.888917-.155417 2.582316 .119552 3.443088 .119552ZM3.299626-5.547198C3.753923-5.547198 4.112578-5.391781 4.375592-5.092902C4.638605-4.782067 4.782067-4.363636 4.817933-3.813699V-3.730012H1.661768C1.721544-4.303861 1.900872-4.746202 2.199751-5.068991C2.486675-5.379826 2.857285-5.547198 3.299626-5.547198Z" id="g0-101"></path><path d="M1.350934 0H2.426899V-5.475467H3.777833V-6.312329H2.426899V-6.981818C2.426899-7.364384 2.52254-7.651308 2.713823-7.854545S3.16812-8.16538 3.526775-8.16538C3.730012-8.16538 3.921295-8.141469 4.112578-8.117559L4.172354-8.990286C3.921295-9.050062 3.670237-9.085928 3.431133-9.085928C2.761644-9.085928 2.247572-8.894645 1.888917-8.53599C1.530262-8.16538 1.350934-7.639352 1.350934-6.969863V-6.312329H.3467V-5.475467H1.350934V0Z" id="g0-102"></path><path d="M1.900872-5.547198V-8.966376H.812951V0H1.900872V-4.495143C2.044334-4.805978 2.247572-5.045081 2.510585-5.236364C2.773599-5.415691 3.084433-5.511333 3.443088-5.511333C3.873474-5.511333 4.184309-5.403736 4.399502-5.188543C4.60274-4.97335 4.710336-4.638605 4.710336-4.184309V0H5.786301V-4.172354C5.762391-5.678705 5.092902-6.43188 3.765878-6.43188C3.000747-6.43188 2.379078-6.133001 1.900872-5.547198Z" id="g0-104"></path><path d="M1.996513 0V-6.312329H.908593V0H1.996513ZM.824907-7.986052C.824907-7.806725 .872727-7.663263 .980324-7.543711S1.243337-7.376339 1.458531-7.376339C1.661768-7.376339 1.817186-7.424159 1.936737-7.543711C2.044334-7.663263 2.10411-7.806725 2.10411-7.986052C2.10411-8.153425 2.044334-8.308842 1.936737-8.428394C1.817186-8.547945 1.661768-8.619676 1.458531-8.619676C1.243337-8.619676 1.08792-8.547945 .980324-8.428394S.824907-8.153425 .824907-7.986052Z" id="g0-105"></path><path d="M1.996513 0V-8.966376H.908593V0H1.996513Z" id="g0-108"></path><path d="M1.841096-6.312329H.812951V0H1.900872V-4.495143C2.044334-4.805978 2.247572-5.045081 2.510585-5.236364C2.773599-5.415691 3.084433-5.511333 3.443088-5.511333C3.873474-5.511333 4.184309-5.403736 4.399502-5.188543C4.60274-4.97335 4.710336-4.638605 4.710336-4.184309V0H5.786301V-4.172354C5.762391-5.678705 5.092902-6.43188 3.765878-6.43188C2.988792-6.43188 2.355168-6.121046 1.876961-5.523288L1.841096-6.312329Z" id="g0-110"></path><path d="M.526027-3.21594V-3.144209C.526027-2.163885 .789041-1.374844 1.327024-.777086C1.853051-.179328 2.546451 .119552 3.407223 .119552C3.969116 .119552 4.471233-.011955 4.913574-.286924C5.34396-.561893 5.678705-.944458 5.917808-1.43462C6.156912-1.912827 6.276463-2.462765 6.276463-3.084433V-3.16812C6.276463-4.148443 6.001494-4.937484 5.475467-5.535243S4.25604-6.43188 3.395268-6.43188C2.833375-6.43188 2.331258-6.288418 1.900872-6.025405S1.123786-5.379826 .884682-4.889664C.645579-4.387547 .526027-3.837609 .526027-3.21594ZM1.613948-3.084433C1.613948-3.873474 1.769365-4.471233 2.10411-4.901619C2.426899-5.332005 2.857285-5.547198 3.395268-5.547198C3.945205-5.547198 4.375592-5.332005 4.710336-4.901619C5.033126-4.471233 5.200498-3.90934 5.200498-3.21594C5.200498-2.438854 5.033126-1.841096 4.710336-1.41071S3.957161-.765131 3.407223-.765131S2.426899-.968369 2.10411-1.398755C1.769365-1.817186 1.613948-2.379078 1.613948-3.084433Z" id="g0-111"></path><path d="M6.156912-3.084433V-3.19203C6.156912-4.208219 5.929763-4.99726 5.487422-5.571108S4.447323-6.43188 3.694147-6.43188C2.905106-6.43188 2.283437-6.156912 1.853051-5.618929L1.80523-6.312329H.812951V2.426899H1.900872V-.609714C2.331258-.119552 2.940971 .119552 3.706102 .119552C4.447323 .119552 5.045081-.167372 5.487422-.753176S6.156912-2.116065 6.156912-3.084433ZM5.068991-3.21594C5.068991-2.402989 4.913574-1.78132 4.614695-1.374844C4.303861-.968369 3.897385-.765131 3.383313-.765131C2.713823-.765131 2.223661-1.052055 1.900872-1.625903V-4.65056C2.223661-5.224408 2.713823-5.511333 3.371357-5.511333C3.897385-5.511333 4.303861-5.296139 4.614695-4.889664C4.913574-4.483188 5.068991-3.921295 5.068991-3.21594Z" id="g0-112"></path><path d="M3.873474-5.34396V-6.348194C3.753923-6.396015 3.598506-6.43188 3.395268-6.43188C2.737733-6.43188 2.235616-6.144956 1.888917-5.583064L1.865006-6.312329H.812951V0H1.900872V-4.483188C2.139975-5.080946 2.618182-5.391781 3.335492-5.391781C3.526775-5.379826 3.706102-5.36787 3.873474-5.34396Z" id="g0-114"></path><path d="M2.283437-7.84259H1.207472V-6.312329H.047821V-5.475467H1.207472V-1.566127C1.207472-1.016189 1.327024-.597758 1.566127-.310834S2.175841 .119552 2.666002 .119552C2.929016 .119552 3.203985 .083686 3.490909 0V-.872727C3.275716-.824907 3.096389-.800996 2.976837-.800996C2.713823-.800996 2.534496-.860772 2.438854-.992279C2.331258-1.111831 2.283437-1.303113 2.283437-1.566127V-5.475467H3.466999V-6.312329H2.283437V-7.84259Z" id="g0-116"></path><path d="M6.40797-1.494396L4.913574-6.312329H4.040847L2.570361-1.590037L1.327024-6.312329H.251059L2.080199 0H2.964882L4.459278-4.782067L5.989539 0H6.862267L8.703362-6.312329H7.627397L6.40797-1.494396Z" id="g0-119"></path><path d="M2.940971-4.004981L1.554172-6.312329H.298879L2.367123-3.19203L.239103 0H1.494396L2.952927-2.367123L4.411457 0H5.66675L3.526775-3.19203L5.595019-6.312329H4.339726L2.940971-4.004981Z" id="g0-120"></path><path d="M2.881196-1.578082L1.303113-6.312329H.131507L2.379078-.071731L2.139975 .573848C2.008468 .968369 1.841096 1.243337 1.637858 1.3868C1.422665 1.530262 1.135741 1.601993 .777086 1.601993L.490162 1.578082V2.462765L.896638 2.534496L1.099875 2.546451C1.960648 2.558406 2.582316 2.032379 2.976837 .980324L5.511333-6.312329H4.351681L2.881196-1.578082Z" id="g0-121"></path><path d="M1.183562 0H2.259527V-5.475467H3.550685V-6.312329H2.259527V-6.862267C2.259527-7.268742 2.355168-7.579577 2.570361-7.79477C2.773599-8.009963 3.108344-8.117559 3.574595-8.117559C4.004981-8.105604 4.471233-8.009963 4.961395-7.81868L5.140722-8.727273C4.471233-8.966376 3.921295-9.085928 3.490909-9.085928C2.749689-9.085928 2.187796-8.88269 1.78132-8.488169S1.183562-7.543711 1.183562-6.850311V-6.312329H.179328V-5.475467H1.183562V0ZM5.678705 0V-6.312329H4.590785V0H5.678705Z" id="g0-128"></path></defs><g id="page1"><path d="M29.433595-62.8633H43.6055C57.7813-62.8633 86.1289-40.1875 100.3008-40.1875H113.2773" fill="none" stroke="#e64d80" stroke-width="1.19553"></path><path d="M110.8476-44.01566C111.40229-41.71878 112.63276-40.632843 113.874947-40.187531C112.63276-39.738312 111.40229-38.65237 110.8476-36.3555" fill="none" stroke="#e64d80" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.19553"></path><g transform="matrix(1 0 0 1 -54.1306 -25.077)" fill="#fff"><use x="29.433417" xlink:href="#g0-101" y="-34.516848"></use><use x="35.757705" xlink:href="#g0-110" y="-34.516848"></use><use x="42.344998" xlink:href="#g0-100" y="-34.516848"></use><use x="52.02867" xlink:href="#g0-111" y="-34.516848"></use><use x="58.843112" xlink:href="#g0-102" y="-34.516848"></use><use x="65.944473" xlink:href="#g0-116" y="-34.516848"></use><use x="69.84186" xlink:href="#g0-114" y="-34.516848"></use><use x="73.990294" xlink:href="#g0-121" y="-34.516848"></use></g><path d="M29.433595-6.1719H43.6055C57.7813-6.1719 86.1289-28.84766 100.3008-28.84766H113.2773" fill="none" stroke="#e64d80" stroke-miterlimit="10" stroke-width="1.19553"></path><path d="M110.8476-32.67966C111.40229-30.37888 112.63276-29.292938 113.874947-28.847626C112.63276-28.402313 111.40229-27.31638 110.8476-25.01559" fill="none" stroke="#e64d80" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="1.19553"></path><g transform="matrix(1 0 0 1 -98.1142 31.64049)" fill="#fff"><use x="29.433417" xlink:href="#g0-101" y="-34.516848"></use><use x="35.757705" xlink:href="#g0-120" y="-34.516848"></use><use x="41.55595" xlink:href="#g0-99" y="-34.516848"></use><use x="47.8085" xlink:href="#g0-101" y="-34.516848"></use><use x="54.132787" xlink:href="#g0-112" y="-34.516848"></use><use x="60.839635" xlink:href="#g0-116" y="-34.516848"></use><use x="64.737022" xlink:href="#g0-105" y="-34.516848"></use><use x="67.630168" xlink:href="#g0-111" y="-34.516848"></use><use x="74.44461" xlink:href="#g0-110" y="-34.516848"></use><use x="83.98482" xlink:href="#g0-104" y="-34.516848"></use><use x="90.560164" xlink:href="#g0-97" y="-34.516848"></use><use x="97.051823" xlink:href="#g0-110" y="-34.516848"></use><use x="103.639117" xlink:href="#g0-100" y="-34.516848"></use><use x="110.369873" xlink:href="#g0-108" y="-34.516848"></use><use x="113.263019" xlink:href="#g0-101" y="-34.516848"></use><use x="119.587307" xlink:href="#g0-114" y="-34.516848"></use></g><g transform="matrix(1 0 0 1 89.3176 3.2698)" fill="#fff"><use x="29.433417" xlink:href="#g0-128" y="-34.516848"></use><use x="36.044631" xlink:href="#g0-110" y="-34.516848"></use><use x="42.631924" xlink:href="#g0-97" y="-34.516848"></use><use x="49.123583" xlink:href="#g0-108" y="-34.516848"></use><use x="52.016729" xlink:href="#g0-108" y="-34.516848"></use><use x="54.909875" xlink:href="#g0-121" y="-34.516848"></use></g><path d="M238.0044-62.8633H225.0274C210.8514-62.8633 182.5074-40.1875 168.3324-40.1875H154.1604" fill="none" stroke="#e64d80" stroke-miterlimit="10" stroke-width="1.19553"></path><path d="M235.57437-66.69531C236.12515-64.39453 237.35952-63.308592 238.60171-62.86328C237.35952-62.417967 236.12515-61.33203 235.57437-59.03125" fill="none" stroke="#e64d80" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="1.19553"></path><g transform="matrix(1 0 0 1 213.6846 -25.077)" fill="#fff"><use x="29.433417" xlink:href="#g0-97" y="-34.516848"></use><use x="35.925076" xlink:href="#g0-102" y="-34.516848"></use><use x="40.073521" xlink:href="#g0-116" y="-34.516848"></use><use x="43.970909" xlink:href="#g0-101" y="-34.516848"></use><use x="50.295196" xlink:href="#g0-114" y="-34.516848"></use><use x="57.288962" xlink:href="#g0-116" y="-34.516848"></use><use x="61.186349" xlink:href="#g0-114" y="-34.516848"></use><use x="65.334783" xlink:href="#g0-121" y="-34.516848"></use></g><path d="M238.0044-6.1719H225.0274C210.8514-6.1719 182.5074-28.84766 168.3324-28.84766H154.1604" fill="none" stroke="#e64d80" stroke-miterlimit="10" stroke-width="1.19553"></path><path d="M235.57437-10C236.12515-7.70312 237.35952-6.617187 238.60171-6.171875C237.35952-5.722656 236.12515-4.63672 235.57437-2.33984" fill="none" stroke="#e64d80" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="1.19553"></path><g transform="matrix(1 0 0 1 213.6846 32.79417)" fill="#fff"><use x="29.433417" xlink:href="#g0-114" y="-34.516848"></use><use x="33.36667" xlink:href="#g0-101" y="-34.516848"></use><use x="39.690957" xlink:href="#g0-116" y="-34.516848"></use><use x="43.588344" xlink:href="#g0-104" y="-34.516848"></use><use x="50.163689" xlink:href="#g0-114" y="-34.516848"></use><use x="54.084977" xlink:href="#g0-111" y="-34.516848"></use><use x="60.89942" xlink:href="#g0-119" y="-34.516848"></use></g></g><title>A graph with two visible paths. The first path is &#34;end of try&#34; to &#34;finally&#34; to &#34;after try&#34;. The second path is &#34;exception handler&#34; to &#34;finally&#34; to &#34;rethrow&#34;. The same node is used for &#34;finally&#34; in both paths, resulting in a star-like topology.</title></svg></p><p>It’s not clear how the <code>finally</code> block should know where to transfer control next. One option is to store the possible exception to rethrow in a hidden variable and treat <code>null</code> as a signal that the <code>try</code> block completed without an exception, but that’s not enough. A <code>try</code> block can have exit points aside from fallthrough: <code>continue</code>, <code>break</code>, and even <code>return</code> can be exit points, each requiring a different post-<code>finally</code> target. Handling this properly would require a jump table, which is likely to be slow as-is, not to mention confusing to JIT compilers and static analyzers, including the one in JVM validating that uninitialized variables are not accessed.</p><p>Instead, <code>javac</code> does something simultaneously cursed and genius: it duplicates the <code>finally</code> body on each exit path. Let’s consider the following snippet:</p><pre><code><span>static</span> <span>void</span> <span>method</span><span>()</span> {
    <span>try</span> {
        try_body();
    } <span>catch</span> (Exception ex) {
        <span>throw</span> ex;
    } <span>finally</span> {
        finally_body();
    }
}
</code></pre><pre><code>Code:
   <span>0</span>: invokestatic  #<span>7</span>                  
   <span>3</span>: invokestatic  #<span>12</span>                 
   <span>6</span>: goto          <span>18</span>
   <span>9</span>: astore_0
  <span>10</span>: aload_0
  <span>11</span>: athrow
  <span>12</span>: astore_1
  <span>13</span>: invokestatic  #<span>12</span>                 
  <span>16</span>: aload_1
  <span>17</span>: athrow
  <span>18</span>: <span>return</span>
Exception table:
   from    to  target type
       <span>0</span>     <span>3</span>     <span>9</span>   Class java/lang/Exception
       <span>0</span>     <span>3</span>    <span>12</span>   any
       <span>9</span>    <span>13</span>    <span>12</span>   any
</code></pre><p>First, <code>javac</code> recognizes that the <code>try</code> body can fallthrough, so it adds a call to <code>finally_body</code> right after the <code>try</code> body, followed to a jump to <code>return</code>. The <code>catch</code> body cannot fallthrough, so <code>finally_body</code> is not inserted after <code>11: athrow</code>.</p><p>Secondly, <code>javac</code> recognizes that the <code>try</code> body can throw, so it wraps it in a catch-all handler (<code>0 3 12 any</code> in the table) that saves the thrown exception, calls <code>finally_body</code>, and then rethrows the saved exception. Similarly, the <code>catch</code> body can throw, so it’s also wrapped in a catch-all handler (<code>9 13 12 any</code> in the table).</p><p>For whatever reason, the region of this last catch-all handler additionally covers the first instruction of the handler itself. I’ve narrowed it down to a <a href="https://github.com/openjdk/jdk/blob/b06459d3a83c13c0fbc7a0a7698435f17265982e/src/jdk.compiler/share/classes/com/sun/tools/javac/jvm/Gen.java#L1615">questionable line</a> in <code>javac</code> code, but it’s been there for so long I doubt anyone wants to touch it. Even if it’s fixed at some point, old class files will still suffer from this problem, so it’s not like we can hope to forget about it.</p><p>Now, it might seem that the <code>astore_1</code> instruction can’t throw, so this should be easy to fix during parsing – just decrease <code>to</code> to <code>target</code> if no instructions in range <code>target</code>…<code>to</code> can throw. But this decision has wider-ranging implications than it seems.</p><p>For one thing, <em>any JVM instruction can throw</em>. <a href="https://docs.oracle.com/javase/specs/jvms/se25/html/jvms-6.html#jvms-6.3">The JVM specification</a> is very clear about this: <code>VirtualMachineError</code> “[…] may be thrown at any time during the operation of the Java Virtual Machine”. <code>VirtualMachineError</code> is a superclass of such bangers as <code>OutOfMemoryError</code> and <code>StackOverflowError</code>, and I don’t think it’s hard to imagine a JVM interpreter that throws <code>StackOverflowError</code> when a JVM-internal function runs out of stack, or <code>OutOfMemoryError</code> if any ad-hoc allocation fails. Even <code>astore_1</code> can realistically throw if the locals array is allocated on demand. At least we don’t have to deal with <code>Thread.stop</code> throwing arbitrary exceptions at arbitrary points since Java 20.</p><p>But a false positive (i.e. catching an exception when it shouldn’t be caught) is just one part of the problem. A false negative can also occur under certain conditions. Consider the following:</p><pre><code><span>static</span> <span>int</span> <span>method</span><span>(<span>boolean</span> condition)</span> {
    <span>try</span> {
        <span>if</span> (condition) {
            <span>return</span> <span>1</span>;
        }
    } <span>finally</span> {
        finally_body();
    }
    <span>return</span> <span>2</span>;
}
</code></pre><p>The main goal here is to create a <code>return</code> statement within a <code>try</code>…<code>finally</code> block. While the <code>if (condition)</code> part and the initialization of <code>1</code> will be covered by the <code>try</code> region, the <code>return</code> itself has to be preceded by a call to <code>finally_body</code>, which should be located outside <code>try</code>. So where does the <code>return</code> instruction itself go? It turns out that <code>javac</code> generates it outside the <code>try</code> block:</p><pre><code><div><p>Code:
   
   <span>0</span>: iload_0
   <span>1</span>: ifeq          <span>11</span>
   
   <span>4</span>: iconst_1
   <span>5</span>: istore_1
   
   <span>6</span>: invokestatic  #<span>7</span>                  
   
   <span>9</span>: iload_1
  <span>10</span>: ireturn
   
   
  <span>11</span>: invokestatic  #<span>7</span>                  
   
  <span>14</span>: goto          <span>23</span>
   
  <span>17</span>: astore_2
  <span>18</span>: invokestatic  #<span>7</span>                  
  <span>21</span>: aload_2
  <span>22</span>: athrow
   
  <span>23</span>: iconst_2
  <span>24</span>: ireturn
Exception table:
   from    to  target type
       <span>0</span>     <span>6</span>    <span>17</span>   any
</p><p><label for="expansible1">Expand</label></p></div></code></pre><p>From the source code, we’d expect exceptions arising during <code>return</code> to be caught by the <code>try</code> block, yet they aren’t. But <em>surely</em> <code>return</code> can only throw <code>VirtualMachineError</code>s that we can turn a blind eye to? Not quite: <a href="https://docs.oracle.com/javase/specs/jvms/se25/html/jvms-6.html#jvms-6.5.return">according to the JVM specification</a>, <code>return</code> can also throw <code> IllegalMonitorStateException</code> if, for example, some monitors that were acquired during the execution of the function haven’t been released by the time the function returns. <code>javac</code> generates code that never exhibits this behavior, and since monitors are incompatible with coroutines, it’s likely that other frontends won’t use this feature as much. But hand-written Java bytecode is not guaranteed to be valid in this regard, so a decompiler still has to take this design oddity into account.</p><p>My solution to this is unimpressive. If monitors can be statically verified to be correct, <code>return</code> cannot throw, and the worst thing that can happen is that OOM or stack overflow during <code>astore</code> is erroneously caught/not caught, which cannot happen on HotSpot or any other reasonably efficient JVM implementation. This means that we can assume that, for all intents and purposes, most instructions can’t throw. On the other hand, if the well-formedness of monitors cannot be verified, the decompiler cannot produce Java code anyway, so how exactly <code>javac</code> interprets the resulting pseudocode doesn’t matter.</p><p>Before we discuss other nuanced stuff, I want to cover a simpler topic.</p><p>JVM is weird in that it has two type checkers. If the bytecode compiler provides a table (called <code>StackMapTable</code>) containing information about which type each stack element has at each point, JVM only needs to verify that all operations are correctly typed. If such a table is not provided, JVM needs to infer types instead. Since type inference takes a non-trivial amount of time, <code>StackMapTable</code> is required to be present in all classfiles since Java 6. However, modern JVMs are still capable of loading old classfiles, so we’ll be stuck with two type checkers for a while.</p><p>There is a major difference between the two type checkers: while type checking by verification (i.e. using <code>StackMapTable</code>) validates every instruction in the bytecode, type checking by inference necessarily verifies only every <em>reachable</em> instruction, since it cannot know the stack layout of unreachable instructions. This means that invalid combinations of bytecode instructions, like <code>iconst_1; ladd</code>, can be present in old classfiles, but not new ones.</p><p>How is this relevant to exception handling? Since rows in the exception table have two parameters <code>to</code> and <code>target</code> that typically coincide for Java code (<code>try</code> ends at <code>}</code>, immediately followed by <code>catch (...) {</code>), but are frequently distinct in bytecode (e.g. due to a <code>goto</code> inbetween), you might foolishly try to expand the <code>try</code> range to the right to <code>target</code> if no instruction in range <code>to</code>…<code>target</code> can throw. This expansion has an odd side-effect: if no instruction in range <code>from</code>…<code>to</code> has previously been reachable, but <code>to</code>…<code>target</code> is reachable, then you’ve just made the exception handler reachable when it was unreachable in bytecode. And in old classfiles, this might make valid code seem incorrectly typed. That’s bad!</p><p>Of course, you might not be interested in handling old classfiles, but it’s about time to discuss why this band-aid doesn’t have a chance to work regardless.</p><p>It might seem intuitive that one <code>try</code>…<code>catch</code> block should be compiled to one row in the exception table, but that’s not the case. Since <code>finally</code> blocks need to be duplicated at each exit point, and you obviously wouldn’t want exceptions inside <code>finally</code> to be caught, some subregions need to be excluded from exception handling. For example:</p><pre><code><span>try</span> {
    <span>if</span> (condition) {
        <span>return</span> <span>1</span>;
    } <span>else</span> {
        <span>return</span> <span>2</span>;
    }
} <span>finally</span> {
    finally_body();
}
</code></pre><pre><code><div><p>Code:
   <span>0</span>: iload_0
   <span>1</span>: ifeq          <span>11</span>
   <span>4</span>: iconst_1
   <span>5</span>: istore_1
   
   <span>6</span>: invokestatic  #<span>7</span>                  
   <span>9</span>: iload_1
  <span>10</span>: ireturn
  <span>11</span>: iconst_2
  <span>12</span>: istore_1
   
  <span>13</span>: invokestatic  #<span>7</span>                  
  <span>16</span>: iload_1
  <span>17</span>: ireturn
   
  <span>18</span>: astore_2
  <span>19</span>: invokestatic  #<span>7</span>                  
  <span>22</span>: aload_2
  <span>23</span>: athrow
Exception table:
   from    to  target type
       <span>0</span>     <span>6</span>    <span>18</span>   any
      <span>11</span>    <span>13</span>    <span>18</span>   any
</p><p><label for="expansible2">Expand</label></p></div></code></pre><p>Even if the <code>finally</code> block is absent, <code>javac</code> merely treats it as empty, still excluding <code>return</code> and <code>goto</code> statements from the <code>try</code> ranges:</p><pre><code><span>try</span> {
    <span>if</span> (condition) {
        <span>return</span> <span>1</span>;
    } <span>else</span> {
        <span>return</span> <span>2</span>;
    }
} <span>catch</span> (Exception ex) {
    <span>return</span> <span>3</span>;
}
</code></pre><pre><code>Code:
   <span>0</span>: iload_0
   <span>1</span>: ifeq          <span>6</span>
   <span>4</span>: iconst_1
   <span>5</span>: ireturn 
   <span>6</span>: iconst_2
   <span>7</span>: ireturn
   <span>8</span>: astore_1
   <span>9</span>: iconst_3
  <span>10</span>: ireturn
Exception table:
   from    to  target type
       <span>0</span>     <span>5</span>     <span>8</span>   Class java/lang/Exception
       <span>6</span>     <span>7</span>     <span>8</span>   Class java/lang/Exception
</code></pre><p>(This also means that the code between <code>to</code> and <code>target</code> is not always just a <code>goto</code> or a <code>return</code> – it may also include the contents of the <code>finally</code> block, which are not guaranteed to be non-throwing.)</p><p>Perhaps the most confusing implication is that while exception handling ranges can cross control flow constructs (e.g. it’s possible for <code>from</code> to be located outside an <code>if</code> and for <code>to</code> br inside an <code>if</code>), ranges of <em>exemption</em> from EH correspond to single positions in source code, and thus cannot cross control flow. So in the eyes of a decompiler, the code above should be parsed like this:</p><pre><code><span>try</span> #<span>1</span> {
    <span>if</span> (condition) {
        <span>int</span> <span>tmp</span> <span>=</span> <span>1</span>;
        exempt #<span>1</span> {
            <span>return</span> tmp;
        }
    } <span>else</span> {
        <span>int</span> <span>tmp</span> <span>=</span> <span>2</span>;
        exempt #<span>1</span> {
            <span>return</span> tmp;
        }
    }
} <span>catch</span> (Exception ex) {
}
<span>return</span> <span>3</span>;
</code></pre><p>…and not by creating one <code>try</code> block for each row. The decompiler can then verify that <code>exempt</code> blocks are present on each exit path of a <code>try</code> block and have matching contents, and simplify the code to a <code>try</code>…<code>finally</code>. The details are fuzzy and I haven’t figured out everything myself yet, but I believe it can be implemented in a single pass.</p><p>One minor issue I haven’t mentioned yet is how to represent exception handlers in the IR. When a handler is entered, the stack is cleared and the exception object is pushed onto the stack. My approach to decompilation assumes the existence of a linear order comprised of individual instructions from the bytecode – so where would the stack store go? It can’t just be inserted at the entry to the handler, since the first instruction of the exception handler may also be reachable by a <code>goto</code> or any other explicit control flow mechanism, not just with <code>try</code>…<code>catch</code>. There is no other possibility but to treat this stack store as special in some way and introduce it into the IR at a later point, i.e. when a syntactic block is created for <code>try</code>…<code>catch</code>.</p><p>I wanted this post to be about Java gimmicks rather than my decompiler in particular, so that’s it for now. If I’ve missed anything important or you wanted to share an idea, feel free to message me.</p></div></section></div>
  </body>
</html>
