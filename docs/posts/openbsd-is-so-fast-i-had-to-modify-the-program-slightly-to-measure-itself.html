<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://flak.tedunangst.com/post/is-OpenBSD-10x-faster-than-Linux">Original</a>
    <h1>OpenBSD is so fast, I had to modify the program slightly to measure itself</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>Here’s a little benchmark complements of <a href="https://infosec.exchange/@jann/115022521451508325">Jann Horn</a>. It’s unexpectedly slow on Linux.</p><p>OpenBSD is so fast, I had to modify the program slightly to measure itself, as the <i>time</i> utility is missing sufficient precision to even record nonzero.</p><p>All it does is create one extra thread, then both existing threads create 256 sockets. What’s so hard about that?</p><pre><code><span>#include &lt;pthread.h&gt;</span>
<span>#include &lt;unistd.h&gt;</span>
<span>#include &lt;err.h&gt;</span>
<span>#include &lt;stdio.h&gt;</span>
<span>#include &lt;sys/time.h&gt;</span>
<span>#include &lt;sys/socket.h&gt;</span>

<span>static</span> <span>void</span> open_sockets<span>(</span><span>void</span><span>)</span> <span>{</span>
    <span>for</span> <span>(</span><span>int</span> i<span>=</span><span>0</span>; i<span>&lt;</span><span>256</span>; i<span>++</span><span>)</span> <span>{</span>
        <span>int</span> sock <span>=</span> socket<span>(</span>AF_INET<span>,</span> SOCK_STREAM<span>,</span> <span>0</span><span>)</span>;
        <span>if</span> <span>(</span>sock <span>==</span> <span>-</span><span>1</span><span>)</span>
            err<span>(</span><span>1</span><span>,</span> <span>&#34;socket&#34;</span><span>)</span>;
    <span>}</span>
<span>}</span>

<span>static</span> <span>void</span> <span>*</span>thread_fn<span>(</span><span>void</span> <span>*</span>dummy<span>)</span> <span>{</span>
    open_sockets<span>(</span><span>)</span>;
    <span>return</span> <span>NULL</span>;
<span>}</span>

<span>int</span> main<span>(</span><span>int</span> argc<span>)</span> <span>{</span>
    <span>struct</span> timeval one<span>,</span> two;
    gettimeofday<span>(</span>&amp;one<span>,</span> <span>NULL</span><span>)</span>;
    <span>if</span> <span>(</span>argc <span>&gt;</span> <span>1</span><span>)</span>
        dup2<span>(</span><span>0</span><span>,</span> <span>666</span><span>)</span>;
    pthread_t thread;
    <span>if</span> <span>(</span>pthread_create<span>(</span>&amp;thread<span>,</span> <span>NULL</span><span>,</span> thread_fn<span>,</span> <span>NULL</span><span>)</span><span>)</span>
        errx<span>(</span><span>1</span><span>,</span> <span>&#34;pthread_create&#34;</span><span>)</span>;
    open_sockets<span>(</span><span>)</span>;
    <span>if</span> <span>(</span>pthread_join<span>(</span>thread<span>,</span> <span>NULL</span><span>)</span><span>)</span>
        errx<span>(</span><span>1</span><span>,</span> <span>&#34;pthread_join&#34;</span><span>)</span>;
    gettimeofday<span>(</span>&amp;two<span>,</span> <span>NULL</span><span>)</span>;
    timersub<span>(</span>&amp;two<span>,</span> &amp;one<span>,</span> &amp;one<span>)</span>;
    printf<span>(</span><span>&#34;elapsed: %lld.%06lds\n&#34;</span><span>,</span> one<span>.</span>tv_sec<span>,</span> one<span>.</span>tv_usec<span>)</span>;
    <span>return</span> <span>0</span>;
<span>}</span></code></pre><p>On Linux, I get results approximately as so:</p><pre><code>tedu@penguin:~$ ./a.out 
elapsed: 0.017770s
tedu@penguin:~$ ./a.out 
elapsed: 0.026309s
tedu@penguin:~$ ./a.out 
elapsed: 0.018414s</code></pre><p>On OpenBSD, here we go, choo choo:</p><pre><code>ox$ ./a.out                                                                               
a.out: a.out: socketsocket: : Too many open files
Too many open files
ox$ ulimit -n 1024
ox$ ./a.out                                                                               
elapsed: 0.006096s
ox$ ./a.out  
elapsed: 0.002508s
ox$ ./a.out  
elapsed: 0.002326s</code></pre><p>These aren’t identical machines, but roughly comparable.</p><p>There’s a hint in the code (nothing to do with networking code, if that was your first guess), with more explanation in the linked thread, which is worth reading and some thinking. I’d love to see the system and benchmark where Linux outperforms here.</p><p>Really, I just found it a little funny. Usually it’s the weirdo benchmark that shows OpenBSD being 10x slower, so this one is definitely going in the collection.
</p></div><div><p>
Posted 15 Aug 2025 16:33 by tedu Updated: 15 Aug 2025 16:33 
</p></div></div>
  </body>
</html>
