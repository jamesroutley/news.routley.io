<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://efe.me/posts/nullable-but-not-null/">Original</a>
    <h1>Nullable but not null</h1>
    
    <div id="readability-page-1" class="page"><article> <p>When working on backend applications, especially those with evolving database schemas, it’s common to see a recurring pattern:</p>
<ol>
<li>A new field is added to a model.</li>
<li>To avoid locking the table during the migration, the field is added as <strong>nullable</strong>.</li>
<li>The application logic is updated to start filling in this field.</li>
<li>A backfill job runs to populate the existing records.</li>
<li>The field is left as nullable.</li>
</ol>
<p>People often forget the final step which is updating the schema to make the field non-nullable once the data is fully populated.</p>
<h3 id="why-it-matters">Why it matters</h3>
<p>Leaving a field marked as nullable when it no longer contains nulls creates a mismatch between your schema and your actual data. This can lead to confusion, missed constraints and unnecessary complexity in your code. Over time, your schema becomes harder to trust. If a field is supposed to be required, your database should enforce it.</p>
<p>This happens because marking a field as non-nullable in production often requires care. Teams delay or skip it to avoid risk and the field stays nullable indefinitely. But a field that is <strong>nullable in the schema</strong> and <strong>never null in practice is a silent lie</strong>. This is a missed opportunity to make your data model clearer and safer.</p>
<h3 id="how-to-fix-it">How to fix it?</h3>
<p>To help find these fields, I wrote a simple script that checks all models in a project. It scans for nullable fields and calculates how many rows actually contain null values. The idea is to identify cases where the field could safely be changed to non-nullable.</p>
<p>Here’s the code (written for Django, but the logic can be adapted to any ORM or raw SQL setup):</p>
<pre tabindex="0" data-language="python"><code><span><span>from</span><span> django.apps </span><span>import</span><span> apps</span></span>
<span><span>from</span><span> django.db </span><span>import</span><span> connection, transaction</span></span>
<span></span>
<span><span>def</span><span> get_nullable_fields</span><span>(model):</span></span>
<span><span>    nullable_fields </span><span>=</span><span> []</span></span>
<span><span>    for</span><span> field </span><span>in</span><span> model._meta.fields:</span></span>
<span><span>        if</span><span> getattr</span><span>(field, </span><span>&#39;null&#39;</span><span>, </span><span>False</span><span>) </span><span>and</span><span> not</span><span> field.auto_created:</span></span>
<span><span>            nullable_fields.append(field.name)</span></span>
<span><span>    return</span><span> nullable_fields</span></span>
<span></span>
<span><span>def</span><span> get_null_percentage_for_field</span><span>(model, field_name, total_rows):</span></span>
<span><span>    if</span><span> total_rows </span><span>==</span><span> 0</span><span>:</span></span>
<span><span>        return</span><span> 0.0</span></span>
<span><span>    null_count </span><span>=</span><span> model.objects.filter(</span><span>**</span><span>{</span><span>f</span><span>&#34;</span><span>{</span><span>field_name</span><span>}</span><span>__isnull&#34;</span><span>: </span><span>True</span><span>}).count()</span></span>
<span><span>    return</span><span> round</span><span>((null_count </span><span>/</span><span> total_rows) </span><span>*</span><span> 100</span><span>, </span><span>2</span><span>)</span></span>
<span></span>
<span><span>def</span><span> analyze_all_models_fields_nulls_with_timeout</span><span>(timeout_ms</span><span>=</span><span>5000</span><span>):</span></span>
<span><span>    &#34;&#34;&#34;</span></span>
<span><span>    Analyze every nullable field in every model with a DB-level timeout in ms.</span></span>
<span><span>    &#34;&#34;&#34;</span></span>
<span><span>    results </span><span>=</span><span> []</span></span>
<span></span>
<span><span>    for</span><span> model </span><span>in</span><span> apps.get_models():</span></span>
<span><span>        model_label </span><span>=</span><span> f</span><span>&#34;</span><span>{</span><span>model._meta.app_label</span><span>}</span><span>.</span><span>{</span><span>model.</span><span>__name__}</span><span>&#34;</span></span>
<span></span>
<span><span>        with</span><span> connection.cursor() </span><span>as</span><span> cursor:</span></span>
<span><span>            cursor.execute(</span><span>f</span><span>&#34;SET LOCAL statement_timeout = </span><span>{</span><span>timeout_ms</span><span>}</span><span>;&#34;</span><span>)</span></span>
<span><span>            with</span><span> transaction.atomic():</span></span>
<span><span>                nullable_fields </span><span>=</span><span> get_nullable_fields(model)</span></span>
<span><span>                total_rows </span><span>=</span><span> model.objects.count()</span></span>
<span></span>
<span><span>                if</span><span> total_rows </span><span>==</span><span> 0</span><span>:</span></span>
<span><span>                    continue</span></span>
<span></span>
<span><span>                for</span><span> field </span><span>in</span><span> nullable_fields:</span></span>
<span><span>                    null_percent </span><span>=</span><span> get_null_percentage_for_field(model, field, total_rows)</span></span>
<span><span>                    results.append({</span></span>
<span><span>                        &#34;model&#34;</span><span>: model_label,</span></span>
<span><span>                        &#34;field&#34;</span><span>: field,</span></span>
<span><span>                        &#34;null_percentage&#34;</span><span>: null_percent,</span></span>
<span><span>                    })</span></span>
<span><span>    return</span><span> results</span></span>
<span></span></code></pre>
<h3 id="how-to-use-it">How to use it?</h3>
<p>You can integrate this logic into a command-line tool, admin report, or health check. The output shows each nullable field and what percentage of rows actually contain nulls.</p>
<p>If a field has <strong>0.0%</strong> nulls, that’s a strong signal it should no longer be nullable. That change makes your schema more accurate, improves validation, and simplifies your codebase.</p>
<pre tabindex="0" data-language="json"><code><span><span>[</span></span>
<span><span>    {</span></span>
<span><span>        &#34;model&#34;</span><span>: </span><span>&#34;users.Profile&#34;</span><span>,</span></span>
<span><span>        &#34;field&#34;</span><span>: </span><span>&#34;birth_date&#34;</span><span>,</span></span>
<span><span>        &#34;null_percentage&#34;</span><span>: </span><span>0.0</span></span>
<span><span>    },</span></span>
<span><span>    {</span></span>
<span><span>        &#34;model&#34;</span><span>: </span><span>&#34;orders.Order&#34;</span><span>,</span></span>
<span><span>        &#34;field&#34;</span><span>: </span><span>&#34;coupon_code&#34;</span><span>,</span></span>
<span><span>        &#34;null_percentage&#34;</span><span>: </span><span>92.4</span></span>
<span><span>    },</span></span>
<span><span>    {</span></span>
<span><span>        &#34;model&#34;</span><span>: </span><span>&#34;products.Product&#34;</span><span>,</span></span>
<span><span>        &#34;field&#34;</span><span>: </span><span>&#34;description&#34;</span><span>,</span></span>
<span><span>        &#34;null_percentage&#34;</span><span>: </span><span>0.0</span></span>
<span><span>    }</span></span>
<span><span>]</span></span>
<span></span></code></pre>
<h3 id="final-thoughts">Final thoughts</h3>
<p>Nullable fields that never hold nulls are often the result of incomplete migrations or forgotten cleanup steps. Catching and fixing them keeps your data model honest and your application healthier.</p>
<p>If a field is meant to be required, your database should say so. Nullable but not null? Time to clean that up.</p> </article></div>
  </body>
</html>
