<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://deno.com/blog/v1.20">Original</a>
    <h1>Deno 1.20</h1>
    
    <div id="readability-page-1" class="page"><div><p><a href="https://github.com/denoland/deno/releases/tag/v1.20.1" rel="noopener noreferrer">Deno 1.20</a> has been
tagged and released with the following new features and changes:</p>
<ul>
<li><a href="#faster-calls-into-rust">Faster calls into Rust</a></li>
<li><a href="#auto-compression-for-http-response-bodies">Auto-compression for HTTP response bodies</a></li>
<li><a href="#new-subcommand-deno-bench">New subcommand: <code>deno bench</code></a></li>
<li><a href="#new-subcommand-deno-task">New subcommand: <code>deno task</code></a></li>
<li><a href="#import-map-specified-in-the-configuration-file">Import map specified in config file</a></li>
<li><a href="#do-not-require-tlshttps-information-to-be-external-files">Do not require TLS/HTTPS information to be external files</a></li>
<li><a href="#low-level-api-to-upgrade-http-connections">Low level API to upgrade HTTP connections</a></li>
<li><a href="#ffi-api-supports-read-only-global-statics">FFI API supports read only global statics</a></li>
<li><a href="#tracing-operations-while-using-deno-test">Tracing operations while using <code>deno test</code></a></li>
<li><a href="#support-for-abortsignaltimeoutms">Support for <code>AbortSignal.timeout()</code></a></li>
<li><a href="#dedicated-interface-for-tcp-and-unix-connections">Dedicated interface for TCP and Unix connections</a></li>
<li><a href="#breaking-stricter-defaults-in-programatic-permissions-for-tests-and-workers"><strong>BREAKING</strong>: Stricter defaults in programatic permissions for tests and workers</a></li>
<li><a href="#typescript-46">TypeScript 4.6</a></li>
<li><a href="#v8-100">V8 10.0</a></li>
</ul>
<p>If you already have Deno installed, you can upgrade to 1.20 by running:</p>
<p>If you are installing Deno for the first time, you can use one of the methods
listed below:</p>
<div><pre>

<span>curl</span> -fsSL https://deno.land/x/install/install.sh <span>|</span> <span>sh</span>


iwr https://deno.land/x/install/install.ps1 -useb <span>|</span> iex


brew <span>install</span> deno


scoop <span>install</span> deno


choco <span>install</span> deno</pre></div><h2 id="faster-calls-into-rust"><a aria-hidden="true" tabindex="-1" href="#faster-calls-into-rust"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Faster calls into Rust</h2><p>While not a directly user facing feature, when your code is executed, it often
needs to communicate between the Javascript engine (V8) and the rest of Deno,
which is written in Rust.</p>
<p>In this release we have optimized our communication layer to be up to ~60%
faster - we have leveraged Rust <em>proc macros</em> to generate highly optimized V8
bindings from existing Rust code.</p>
<p>The macro optimizes away deserialization of unused arguments, speeds up metric
collection and provides a base for future integration with the V8 Fast API,
which will further improve performance between Javascript and Rust.</p>
<p>Previous versions of Deno used a common V8 binding along with a routing
mechanism to call into the ops (what we call a message between Rust and V8).
With this new proc macro, each op gets its own V8 binding thus eliminating the
need for routing ops.</p>
<p>Here are some baseline overhead benchmarks:</p>
<p><img src="https://deno.com/v1.20/op_sync_benchmark.svg" width="500" alt="a graph demonstrating the significant performance improvement of internal Deno ops"/></p><p>Overall thanks to this change and other optimizations, Deno 1.20 improves base64
roundtrip of 1mb string from ~125ms to ~3.3ms in Deno 1.19!</p>
<p>For more details, dive into
<a href="https://github.com/denoland/deno/pull/13861" rel="noopener noreferrer">this PR</a>.</p>
<h2 id="auto-compression-for-http-response-bodies"><a aria-hidden="true" tabindex="-1" href="#auto-compression-for-http-response-bodies"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Auto-compression for HTTP Response bodies</h2><p>Deno&#39;s native HTTP server now supports auto-compression for response bodies.
When a client request supports either gzip or brotli compression, and your
server responds with a body that isn&#39;t a stream, the body will be automatically
compressed within Deno, without any need for you to configure anything:</p>
<div><pre><span>import</span> <span>{</span> serve <span>}</span> <span>from</span> <span>&#34;https://deno.land/std@0.130.0/http/server.ts&#34;</span><span>;</span>

<span>function</span> <span>handler</span><span>(</span>req<span>:</span> Request<span>)</span><span>:</span> Response <span>{</span>
  <span>const</span> body <span>=</span> <span>JSON</span><span>.</span><span>stringify</span><span>(</span><span>{</span>
    hello<span>:</span> <span>&#34;deno&#34;</span><span>,</span>
    now<span>:</span> <span>&#34;with&#34;</span><span>,</span>
    compressed<span>:</span> <span>&#34;body&#34;</span><span>,</span>
  <span>}</span><span>)</span><span>;</span>
  <span>return</span> <span>new</span> <span>Response</span><span>(</span>body<span>,</span> <span>{</span>
    headers<span>:</span> <span>{</span>
      <span>&#34;content-type&#34;</span><span>:</span> <span>&#34;application/json; charset=utf-8&#34;</span><span>,</span>
    <span>}</span><span>,</span>
  <span>}</span><span>)</span><span>;</span>
<span>}</span>

<span>serve</span><span>(</span>handler<span>,</span> <span>{</span> port<span>:</span> <span>4242</span> <span>}</span><span>)</span><span>;</span></pre></div><p>Internally, Deno will analyze the <code>Accept-Encoding</code> header, plus ensure the
response body content type is compressible and automatically compress the
response:</p>
<pre><code>&gt; curl -I --request GET --url http://localhost:4242 --H &#34;Accept-Encoding: gzip, deflate, br&#34;

HTTP/1.1 200 OK
content-type: application/json; charset=utf-8
vary: Accept-Encoding
content-encoding: gzip
content-length: 72
date: Tue, 15 Mar 2022 00:00:00 GMT</code></pre><p>There are a few more details and caveats. Check out
<a href="https://deno.land/manual@main/runtime/http_server_apis#automatic-body-compression" rel="noopener noreferrer">Automatic Body Compression</a>
in the manual for more details.</p>
<h2 id="new-subcommand-deno-bench"><a aria-hidden="true" tabindex="-1" href="#new-subcommand-deno-bench"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>New subcommand: <code>deno bench</code></h2><p>Benchmarking your code is an effective way to identify performance issues and
regressions and this release adds new <code>deno bench</code> subcommand and <code>Deno.bench()</code>
API. <code>deno bench</code> is modelled after <code>deno test</code> and works in similar manner.</p>
<p>First, let us create a file <code>url_bench.ts</code> and register a benchmark test using
the <code>Deno.bench()</code> function.</p>
<p><strong>url_bench.ts</strong></p>
<div><pre>Deno<span>.</span><span>bench</span><span>(</span><span>&#34;URL parsing&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>new</span> <span><span>URL</span></span><span>(</span><span>&#34;https://deno.land&#34;</span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span></pre></div><p>Second, run the benchmark using the <code>deno bench</code> subcommand (<code>--unstable</code> is
required for now, since it is a new API).</p>
<pre><code>deno bench --unstable url_bench.ts
running 1 bench from file:///dev/url_bench.ts
bench URL parsing ... 1000 iterations 23,063 ns/iter (208..356,041 ns/iter) ok (1s)

bench result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out (1s)</code></pre><p>By default, each registered bench case will be run 2000 times: first a thousand
warmup iterations will be performed to allow the V8 JavaScript engine to
optimize your code; and then another thousand iterations will be measured and
reported.</p>
<p>You can customize number of warmup and measure iterations by setting
<code>Deno.BenchDefinition.warmup</code> and <code>Deno.BenchDefinition.n</code> respectively:</p>
<div><pre>

Deno<span>.</span><span>bench</span><span>(</span><span>{</span> warmup<span>:</span> <span>1e5</span><span>,</span> n<span>:</span> <span>1e6</span> <span>}</span><span>,</span> <span>function</span> <span>resolveUrl</span><span>(</span><span>)</span> <span>{</span>
  <span>new</span> <span><span>URL</span></span><span>(</span><span>&#34;./foo.js&#34;</span><span>,</span> <span>import</span><span>.</span>meta<span>.</span>url<span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span></pre></div><p>To learn more about <code>deno bench</code> visit
<a href="https://deno.land/manual@v1.20.1/tools/benchmarker" rel="noopener noreferrer">the manual</a>.</p>
<p>We plan to add more features to <code>deno bench</code> in the near future, including:</p>
<ul>
<li>more detailed reports with percentile ranks</li>
<li>JSON and CSV report output</li>
<li>integration into the language server so it can be used in editors</li>
</ul>
<p>We are also looking for feedback from the community to help shape the feature
and stabilize it.</p>
<h2 id="new-subcommand-deno-task"><a aria-hidden="true" tabindex="-1" href="#new-subcommand-deno-task"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>New subcommand: <code>deno task</code></h2><p>Deno 1.20 adds a new task runner to provide a convenient way of defining and
executing custom commands specific to the development of a codebase. This is
similar to npm scripts or makefiles, and is designed to work in a cross platform
way.</p>
<p>Say we had the following command that was used often in our codebase:</p>
<div><pre>deno run --allow-read<span>=</span>. scripts/analyze.js</pre></div><p>We could define this in a
<a href="https://deno.land/manual@v1.20.1/getting_started/configuration_file" rel="noopener noreferrer">Deno configuration file</a>:</p>
<div><pre><span>{</span>
  <span>&#34;tasks&#34;</span><span>:</span> <span>{</span>
    <span>&#34;analyze&#34;</span><span>:</span> <span>&#34;deno run --allow-read=. scripts/analyze.js&#34;</span>
  <span>}</span>
<span>}</span></pre></div><p>Then when in a directory that automatically resolves this configuration file,
tasks may be run by calling <code>deno task &lt;task-name&gt;</code>. So in this case, to execute
the <code>analyze</code> task we would run:</p>
<p>Or a more complex example:</p>
<div><pre><span>{</span>
  <span>&#34;tasks&#34;</span><span>:</span> <span>{</span>
    
    
    
    
    
    
    <span>&#34;npm:publish&#34;</span><span>:</span> <span>&#34;BUILD=prod deno task npm:build &amp;&amp; cd dist &amp;&amp; npm publish&#34;</span><span>,</span>
    
    <span>&#34;npm:build&#34;</span><span>:</span> <span>&#34;deno run -A scripts/build_npm_package.js&#34;</span>
  <span>}</span>
<span>}</span></pre></div><p>The syntax used is a subset of POSIX like shells and works cross platform on
Windows, Mac, and Linux. Additionally, it comes with a few built-in cross
platform commands such as <code>mkdir</code>, <code>cp</code>, <code>mv</code>, <code>rm</code>, and <code>sleep</code>. This shared
syntax and built-in commands exist to eliminate the need for additional cross
platform tools seen in the npm ecosystem such as
<a href="https://www.npmjs.com/package/cross-env" rel="noopener noreferrer">cross-env</a>,
<a href="https://www.npmjs.com/package/rimraf" rel="noopener noreferrer">rimraf</a>, etc.</p>
<p>For a more detailed overview
<a href="https://deno.land/manual@v1.20.1/tools/task_runner" rel="noopener noreferrer">see the manual</a>.</p>
<p>Note that <code>deno task</code> is unstable and might drastically change in the future. We
would appreciate your feedback to help shape this feature.</p>
<h2 id="import-map-specified-in-the-configuration-file"><a aria-hidden="true" tabindex="-1" href="#import-map-specified-in-the-configuration-file"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Import map specified in the configuration file</h2><p>Previously, specifying an
<a href="https://deno.land/manual@v1.20.1/linking_to_external_code/import_maps" rel="noopener noreferrer">import map</a>
file required always providing the <code>--import-map</code> flag on the command line.</p>
<div><pre>deno run --import-map<span>=</span>import_map.json main.ts</pre></div><p>In Deno 1.20, this may now be specified in the
<a href="https://deno.land/manual@v1.20.1/getting_started/configuration_file" rel="noopener noreferrer">Deno configuration file</a>.</p>
<div><pre><span>{</span>
  <span>&#34;importMap&#34;</span><span>:</span> <span>&#34;import_map.json&#34;</span>
<span>}</span></pre></div><p>The benefit is that if your current working directory resolves a configuration
file or you specify a configuration file via <code>--config=&lt;FILE&gt;</code>, then you no
longer need to also remember to specify the <code>--import-map=&lt;FILE&gt;</code> flag.</p>
<p>Additionally, the configuration file serves as a single source of truth. For
example, after upgrading to Deno 1.20 you can move your LSP import map
configuration to deno.json (e.g. in VSCode you can move the
<code>&#34;deno.importMap&#34;: &#34;&lt;FILE&gt;&#34;</code> config in your editor settings to only be in your
<code>deno.jsonc</code> config file if you desire).</p>
<h2 id="do-not-require-tlshttps-information-to-be-external-files"><a aria-hidden="true" tabindex="-1" href="#do-not-require-tlshttps-information-to-be-external-files"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Do not require TLS/HTTPS information to be external files</h2><p>Secure HTTPS requests require certificate and private key information to support
the TLS protocol to secure those connections. Previously Deno only allowed the
certificate and the private key to be stored as physical files on disk. In this
release we have added <code>cert</code> and <code>key</code> options to <code>Deno.listenTls()</code> API and
deprecated <code>certFile</code> and <code>keyFile</code>.</p>
<p>This allows users to load the PEM certificate and private key from any source as
a string. For example:</p>
<div><pre><span>const</span> listener <span>=</span> Deno<span>.</span><span>listenTls</span><span>(</span><span>{</span>
  hostname<span>:</span> <span>&#34;localhost&#34;</span><span>,</span>
  port<span>:</span> <span>6969</span><span>,</span>
  cert<span>:</span> <span>await</span> Deno<span>.</span><span>readTextFile</span><span>(</span><span>&#34;localhost.crt&#34;</span><span>)</span><span>,</span>
  key<span>:</span> <span>await</span> Deno<span>.</span><span>readTextFile</span><span>(</span><span>&#34;localhost.key&#34;</span><span>)</span><span>,</span>
<span>}</span><span>)</span><span>;</span></pre></div><h2 id="low-level-api-to-upgrade-http-connections"><a aria-hidden="true" tabindex="-1" href="#low-level-api-to-upgrade-http-connections"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Low-level API to upgrade HTTP connections</h2><p>A new Deno namespace API was added in this release: <code>Deno.upgradeHttp()</code>. It is
unstable and requires the <code>--unstable</code> flag to be used.</p>
<p>You can use this API to perform an upgrade of the HTTP connection, which allows
to implement higher level protocols based on HTTP (like WebSockets); the API
works for TCP, TLS and Unix socket connections.</p>
<p>This is a low level API and most users won&#39;t need to use it directly.</p>
<p>An example using TCP connection:</p>
<div><pre><span>import</span> <span>{</span> serve <span>}</span> <span>from</span> <span>&#34;https://deno.land/std@0.130.0/http/server.ts&#34;</span><span>;</span>

<span>serve</span><span>(</span><span>(</span>req<span>)</span> <span>=&gt;</span> <span>{</span>
  <span>const</span> p <span>=</span> Deno<span>.</span><span>upgradeHttp</span><span>(</span>req<span>)</span><span>;</span>

  
  
  <span>(</span><span>async</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>const</span> <span>[</span>conn<span>,</span> firstPacket<span>]</span> <span>=</span> <span>await</span> p<span>;</span>
    <span>const</span> decoder <span>=</span> <span>new</span> <span>TextDecoder</span><span>(</span><span>)</span><span>;</span>
    <span>const</span> text <span>=</span> decoder<span>.</span><span>decode</span><span>(</span>firstPacket<span>)</span><span>;</span>
    <span>console</span><span>.</span><span>log</span><span>(</span>text<span>)</span><span>;</span>
    
    conn<span>.</span><span>close</span><span>(</span><span>)</span><span>;</span>
  <span>}</span><span>)</span><span>(</span><span>)</span><span>;</span>

  
  <span>return</span> <span>new</span> <span>Response</span><span>(</span><span>null</span><span>,</span> <span>{</span> status<span>:</span> <span>101</span> <span>}</span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span></pre></div><h2 id="ffi-api-supports-read-only-global-statics"><a aria-hidden="true" tabindex="-1" href="#ffi-api-supports-read-only-global-statics"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>FFI API supports read-only global statics</h2><p>This release adds ability to use global statics in
<a href="https://deno.land/manual@v1.20.1/runtime/ffi_api" rel="noopener noreferrer">Foreign Function Interface API</a>.</p>
<p>Given following definitions:</p>
<div><pre><span>#[no_mangle]</span>
<span>pub</span> <span>static</span> static_u32<span>:</span> <span>u32</span> <span>=</span> <span>42</span><span>;</span>

<span>#[repr(C)]</span>
<span>pub</span> <span>struct</span> <span>Structure</span> <span>{</span>
  _data<span>:</span> <span>u32</span><span>,</span>
<span>}</span>

<span>#[no_mangle]</span>
<span>pub</span> <span>static</span> static_ptr<span>:</span> <span>Structure</span> <span>=</span> <span>Structure</span> <span>{</span> _data<span>:</span> <span>42</span> <span>}</span><span>;</span></pre></div><p>You can now access them in your user code:</p>
<div><pre><span>const</span> dylib <span>=</span> Deno<span>.</span><span>dlopen</span><span>(</span><span>&#34;./path/to/lib.so&#34;</span><span>,</span> <span>{</span>
  <span>&#34;static_u32&#34;</span><span>:</span> <span>{</span>
    type<span>:</span> <span>&#34;u32&#34;</span><span>,</span>
  <span>}</span><span>,</span>
  <span>&#34;static_ptr&#34;</span><span>:</span> <span>{</span>
    type<span>:</span> <span>&#34;pointer&#34;</span><span>,</span>
  <span>}</span><span>,</span>
<span>}</span><span>)</span><span>;</span>

<span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;Static u32:&#34;</span><span>,</span> dylib<span>.</span>symbols<span>.</span>static_u32<span>)</span><span>;</span>

<span>console</span><span>.</span><span>log</span><span>(</span>
  <span>&#34;Static ptr:&#34;</span><span>,</span>
  dylib<span>.</span>symbols<span>.</span>static_ptr <span>instanceof</span> <span>Deno</span><span>.</span>UnsafePointer<span>,</span>
<span>)</span><span>;</span>

<span>const</span> view <span>=</span> <span>new</span> <span>Deno</span><span>.</span><span>UnsafePointerView</span><span>(</span>dylib<span>.</span>symbols<span>.</span>static_ptr<span>)</span><span>;</span>
<span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;Static ptr value:&#34;</span><span>,</span> view<span>.</span><span>getUint32</span><span>(</span><span>)</span><span>)</span><span>;</span>
</pre></div><p>Thank you to <a href="https://github.com/aapoalas" rel="noopener noreferrer">Aapo Alasuutari</a> for implementing
this feature.</p>
<h2 id="tracing-operations-while-using-deno-test"><a aria-hidden="true" tabindex="-1" href="#tracing-operations-while-using-deno-test"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Tracing operations while using <code>deno test</code></h2><p>In v1.19 we introduced
<a href="https://deno.com/blog/v1.19#better-errors-for-ops-and-resource-sanitizers-in-denotest" rel="noopener noreferrer">better errors for ops and resource sanitizers in <code>Deno.test</code></a>.</p>
<p>This is a very useful feature for debugging testing code that has leaks of ops
or resources. Unfortunately after shipping this change we received reports that
performance of <code>deno test</code> degraded noticeably. The performance regression was
caused by excessive collection of stack traces and source mapping of code.</p>
<p>Without a clear way to not incur performance hit for users who do not need these
detailed error messages with traces, we decided to disable tracing feature by
default. Starting with v1.20, the sanitizers will collect detailed tracing data
only with <code>--trace-ops</code> flag present.</p>
<p>In case your test leaks ops and you did not invoke <code>deno test</code> with
<code>--trace-ops</code> you will be prompted to do so in the error message:</p>
<div><pre>

Deno<span>.</span><span>test</span><span>(</span><span>&#34;test 1&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>setTimeout</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>{</span><span>}</span><span>,</span> <span>10000</span><span>)</span><span>;</span>
  <span>setTimeout</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>{</span><span>}</span><span>,</span> <span>10001</span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span></pre></div><pre><code>$ deno test ./test.ts
Check ./test.ts
running 1 test from ./test.ts
test test 1 ... FAILED (1ms)

failures:

test 1
Test case is leaking async ops.

- 2 async operations to sleep for a duration were started in this test, but never completed. This is often caused by not cancelling a `setTimeout` or `setInterval` call.

To get more details where ops were leaked, run again with --trace-ops flag.

failures:

    test 1

test result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out ([WILDCARD])

error: Test failed</code></pre><p>Running again with <code>--trace-ops</code> will show where the leaks occurred:</p>
<pre><code>$ deno test --trace-ops file:///dev/test.ts
Check file:///dev/test.ts
running 1 test from ./test.ts
test test 1 ... FAILED (1ms)

failures:

test 1
Test case is leaking async ops.

- 2 async operations to sleep for a duration were started in this test, but never completed. This is often caused by not cancelling a `setTimeout` or `setInterval` call. The operations were started here:
    at Object.opAsync (deno:core/01_core.js:161:42)
    at runAfterTimeout (deno:ext/web/02_timers.js:234:31)
    at initializeTimer (deno:ext/web/02_timers.js:200:5)
    at setTimeout (deno:ext/web/02_timers.js:337:12)
    at test (file:///dev/test.ts:4:3)
    at file:///dev/test.ts:8:27

    at Object.opAsync (deno:core/01_core.js:161:42)
    at runAfterTimeout (deno:ext/web/02_timers.js:234:31)
    at initializeTimer (deno:ext/web/02_timers.js:200:5)
    at setTimeout (deno:ext/web/02_timers.js:337:12)
    at test (file:///dev/test.ts:5:3)
    at file:///dev/test.ts:8:27


failures:

    test 1

test result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out ([WILDCARD])

error: Test failed</code></pre><h2 id="support-for-abortsignaltimeoutms"><a aria-hidden="true" tabindex="-1" href="#support-for-abortsignaltimeoutms"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Support for <code>AbortSignal.timeout(ms)</code></h2><p>Aborting an <code>AbortSignal</code> after a certain amount of time has passed is a common
pattern. For example:</p>
<div><pre>

<span>const</span> controller <span>=</span> <span>new</span> <span>AbortController</span><span>(</span><span>)</span><span>;</span>
<span>setTimeout</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> controller<span>.</span><span>abort</span><span>(</span><span>)</span><span>,</span> <span>2_000</span><span>)</span><span>;</span>
<span>const</span> signal <span>=</span> controller<span>.</span>signal<span>;</span>

<span>try</span> <span>{</span>
  <span>const</span> result <span>=</span> <span>await</span> <span>fetch</span><span>(</span><span>&#34;https://deno.land&#34;</span><span>,</span> <span>{</span> signal <span>}</span><span>)</span><span>;</span>
  
<span>}</span> <span>catch</span> <span>(</span>err<span>)</span> <span>{</span>
  <span>if</span> <span>(</span>signal<span>.</span>aborted<span>)</span> <span>{</span>
    
  <span>}</span> <span>else</span> <span>{</span>
    <span>throw</span> err<span>;</span>
  <span>}</span>
<span>}</span></pre></div><p>To simplify this pattern, <a href="https://whatwg.org/" rel="noopener noreferrer">WHATWG</a> introduced a new
<code>AbortSignal.timeout(ms)</code> static method. When called, this will create a new
<code>AbortSignal</code> which will be aborted with a &#34;TimeoutError&#34; <code>DOMException</code> in the
specified number of milliseconds.</p>
<div><pre><span>try</span> <span>{</span>
  <span>const</span> result <span>=</span> <span>await</span> <span>fetch</span><span>(</span><span>&#34;https://deno.land&#34;</span><span>,</span> <span>{</span>
    
    signal<span>:</span> AbortSignal<span>.</span><span>timeout</span><span>(</span><span>2_000</span><span>)</span><span>,</span>
  <span>}</span><span>)</span><span>;</span>
  
<span>}</span> <span>catch</span> <span>(</span>err<span>)</span> <span>{</span>
  <span>if</span> <span>(</span>err <span>instanceof</span> <span>DOMException</span> <span>&amp;&amp;</span> err<span>.</span>name <span>===</span> <span>&#34;TimeoutError&#34;</span><span>)</span> <span>{</span>
    
  <span>}</span> <span>else</span> <span>{</span>
    <span>throw</span> err<span>;</span>
  <span>}</span>
<span>}</span></pre></div><p>Thank you to <a href="https://github.com/andreubotella" rel="noopener noreferrer">Andreu Botella</a> for implementing
this feature.</p>
<h2 id="dedicated-interface-for-tcp-and-unix-connections"><a aria-hidden="true" tabindex="-1" href="#dedicated-interface-for-tcp-and-unix-connections"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Dedicated interface for TCP and Unix connections</h2><p>This release adds two new interfaces: <code>Deno.TcpConn</code> and <code>Deno.UnixConn</code>, which
are used as return types for <code>Deno.connect()</code> API.</p>
<p>This is a small quality of life improvement for type checking your code and
allows for easier discovery of methods available for both connection types.</p>
<h2 id="breaking-stricter-defaults-in-programatic-permissions-for-tests-and-workers"><a aria-hidden="true" tabindex="-1" href="#breaking-stricter-defaults-in-programatic-permissions-for-tests-and-workers"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>BREAKING: Stricter defaults in programatic permissions for tests and workers</h2><p>When spawning a web worker using the <code>Worker</code> interface or registering a test
with <code>Deno.test</code>, you have the ability to specify a specific set of permissions
to apply to that worker or test. This is done by passing a &#34;permissions&#34; object
to the options bag of the calls. These permissions must be a subset of the
current permissions (to prevent permission escalations). If no permissions are
explicitly specified in the options bag, the default permissions will be used.</p>
<p>Previously, if you only specified new permissions for a certain capability (for
example <code>&#34;net&#34;</code>), then all other capabilities would have their permissions
inherited from the current permissions. Here is an example:</p>
<div><pre>


Deno<span>.</span><span>test</span><span>(</span><span>&#34;read only test&#34;</span><span>,</span> <span>{</span> permissions<span>:</span> <span>{</span> read<span>:</span> <span>true</span> <span>}</span> <span>}</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
  
  
  
  
<span>}</span><span>)</span><span>;</span></pre></div><p>We avoid breaking changes in minor releases, but we feel strongly that we had
gotten this existing behavior wrong.</p>
<p>Instead of defaulting permissions for omitted capabilities to <code>&#34;inherit&#34;</code>, we
now default to <code>&#34;none&#34;</code>. This means if a certain permission is omitted, but some
permissions are specified, it will be assumed that the user doesn&#39;t want to
grant this permission in the downstream scope. Again, while this is a breaking
change, we feel the new behavior is less surprising as well as reduces
situations where permissions are accidentally granted.</p>
<p>If you relied on this previous behaviour, update your permissions bag to
explicitly specify <code>&#34;inherit&#34;</code> for all capabilities that do not have explicit
values set.</p>
<p>This release additionally adds a <code>Deno.PermissionOptions</code> interface which
unifies an API for specifying permissions for <code>WorkerOptions</code>,
<code>Deno.TestDefinition</code> and <code>Deno.BenchDefinition</code>. Previously all three of these
had seperate implementations.</p>
<h2 id="typescript-46"><a aria-hidden="true" tabindex="-1" href="#typescript-46"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>TypeScript 4.6</h2><p>Deno 1.20 ships with the latest stable version of TypeScript. For more
information on new features in TypeScript see
<a href="https://devblogs.microsoft.com/typescript/announcing-typescript-4-6/" rel="noopener noreferrer">TypeScript&#39;s 4.6 blog post</a></p>
<h2 id="v8-100"><a aria-hidden="true" tabindex="-1" href="#v8-100"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>V8 10.0</h2><p>This release upgrades to the latest release of V8 (10.0, previously 9.9). The
<a href="https://v8.dev/" rel="noopener noreferrer">V8 team</a> has not yet posted about the release. When they do,
we will link it here. In lieu of a blog post explore the diff:
<a href="https://github.com/v8/v8/compare/9.9-lkgr...10.0-lkgr" rel="noopener noreferrer">https://github.com/v8/v8/compare/9.9-lkgr...10.0-lkgr</a></p>
</div></div>
  </body>
</html>
