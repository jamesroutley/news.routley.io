<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.frost.kiwi/dual-kawase/">Original</a>
    <h1>Video Game Blurs (and how the best one works)</h1>
    
    <div id="readability-page-1" class="page"><div><p>Blurs are the basic building block for many <a href="https://en.wikipedia.org/wiki/Video_post-processing#Uses_in_3D_rendering" target="_blank">video game post-processing effects</a> and essential for sleek and modern <a href="https://en.wikipedia.org/wiki/Graphical_user_interface" target="_blank">GUIs</a>. Video game <a href="https://dev.epicgames.com/documentation/en-us/unreal-engine/depth-of-field-in-unreal-engine" target="_blank">Depth of Field</a> and <a href="https://en.wikipedia.org/wiki/Bloom_(shader_effect)" target="_blank">Bloom</a> or <a href="https://blog.frost.kiwi/GLSL-noise-and-radial-gradient/#microsoft-windows-acrylic" target="_blank">frosted panels</a> in modern user interfaces - used subtly or obviously - they‚Äôre everywhere. <span onmouseout="this.style.filter=&#34;none&#34;" onmouseover="this.style.filter=&#34;blur(4px)&#34;">Even your browser can do it, just tap this sentence!</span></p><figure><img src="https://blog.frost.kiwi/dual-kawase/img/intro.png" alt="Texture coordinates, also called UV Coordinates or UVs for short"/><figcaption>Effect of &#34;<a href="https://en.wikipedia.org/wiki/Bloom_(shader_effect)" target="_blank">Bloom</a>&#34;, one of many use-cases for blur algorithms</figcaption></figure><p>Conceptually, <em>‚ÄúMake thing go blurry‚Äù</em> is easy, boiling down to some form of <em>‚Äúaverage colors in radius‚Äù</em>. Doing so in <a href="https://en.wikipedia.org/wiki/Real-time_computing" target="_blank">realtime</a> however, took many a graphics programmer through decades upon decades of research and experimentation, across computer science and maths. In this article, we‚Äôll follow their footsteps.</p><blockquote><p>A graphics programming time travel, if you will.</p><img src="https://blog.frost.kiwi/assets/kiwis/cyber.svg"/></blockquote><p>Using the <a href="https://en.wikipedia.org/wiki/Graphics_processing_unit" target="_blank">GPU</a> in the device you are reading this article on, and the <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API" target="_blank">WebGL</a> capability of your browser, we‚Äôll implement realtime blurring techniques and retrace the trade-offs graphics programmers had to make in order to marry two, sometimes opposing, worlds: <strong>Mathematical theory</strong> and <strong>Technological reality</strong>.</p><blockquote><div><p>This is my submission to this year&#39;s <a href="https://some.3b1b.co/" target="_blank">Summer of Math Exposition</a></p></div><img src="https://blog.frost.kiwi/dual-kawase/img/SOMELogo.svg"/></blockquote><p>With many interactive visualizations to guide us, we‚Äôll journey through a bunch of blurs, make a detour through frequency space manipulations, torture your graphics processor to measure performance, before finally arriving at an algorithm with years worth of cumulative graphics programmer sweat - The ‚ú® Dual Kawase Blur üåü</p><h2 id="setup---no-blur-yet" tabindex="-1">Setup - No blur yet <a href="#setup---no-blur-yet">#</a></h2><p>In the context of video game post-processing, a 3D scene is drawn, also called <a href="https://en.wikipedia.org/wiki/Rendering_(computer_graphics)" target="_blank">rendering</a>, and saved to an intermediary image - a <a href="https://learnopengl.com/Advanced-OpenGL/Framebuffers" target="_blank">framebuffer</a>. In turn, this framebuffer is processed to achieve <a href="https://en.wikipedia.org/wiki/Video_post-processing#Uses_in_3D_rendering" target="_blank">various effects</a>. Since this <em>processing</em> happens <em>after</em> a 3D scene is rendered, it‚Äôs called <em>post-processing</em>. All that, <em>many</em> times a second.</p><blockquote><div><p><strong>Depending on technique</strong>, framebuffers <a href="https://learnopengl.com/Advanced-Lighting/Deferred-Shading" target="_blank">can hold non-image data</a> and post-processing effects like <a href="https://en.wikipedia.org/wiki/Color_correction" target="_blank">Color-correction</a> or <a href="https://en.wikipedia.org/wiki/Tone_mapping" target="_blank">Tone-mapping</a> don&#39;t even require intermediate framebuffers: There&#39;s <a href="https://takahirox.github.io/three.js/examples/webgl_tonemapping.html" target="_blank">more</a> than <a href="https://gdcvault.com/play/1020631/The-Revolution-in-Mobile-Game" target="_blank">one way (@35:20)</a></p></div><img src="https://blog.frost.kiwi/assets/kiwis/detective.svg"/></blockquote><p>This is where we jump in: with a framebuffer in hand, after the 3D scene was drawn. We‚Äôll use a scene from a <a href="https://en.wikipedia.org/wiki/Video_game_modding" target="_blank">mod</a> called <a href="https://store.steampowered.com/app/244630/NEOTOKYO/" target="_blank">NEOTOKYO¬∞</a>. Each time we‚Äôll implement a blur, there will be a box, a <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Elements/canvas" target="_blank">canvas</a> instructed with <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API" target="_blank">WebGL 1.0</a>, rendering at <a href="https://en.wikipedia.org/wiki/1:1_pixel_mapping" target="_blank"><strong>native</strong> resolution</a> of your device. Each box has controls and relevant parts of its code below.</p><blockquote><p>No coding or graphics programming knowledge required to follow along. <a href="https://github.com/FrostKiwi/treasurechest/tree/main/posts/dual-kawase" target="_blank">But also no curtains!</a> You can always see <a href="https://www.youtube.com/watch?v=ONH-pxBMJu4" target="_blank">how we talk</a> with your GPU. Terms and meanings will be explained, once it&#39;s relevant.</p><img src="https://blog.frost.kiwi/assets/kiwis/speak.svg"/></blockquote><div id="WebGLBox-Simple"><div><p><label> Scene</label> <label> Lights</label> <label> Bloom</label></p><p><label> Animate</label></p></div><div><canvas></canvas><p>‚ùå The browser killed this WebGL Context, please reload the page. If this happened as the result of a long benchmark, decrease the iteration count. On some platforms (iOS / iPad) you may have to restart the browser App completely, as the browser will temporarily refuse to allow this site to run WebGL again.</p><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" fill="transparent" r="10" stroke-width="2"></circle><rect height="7" rx="1" width="2" x="11" y="6"></rect><rect height="9" rx="1" width="2" x="11" y="11"></rect></svg></div><table><tbody><tr><td colspan="4"><p><span><strong>FPS:</strong><output id="fps">?</output>/<output id="ms">?</output>ms </span><span><strong>Resolution:</strong><output id="width">?</output>x<output id="height">?</output></span></p></td></tr><tr><td colspan="4"><code>lightBrightness</code></td></tr><tr><td><code>lightBrightness</code></td><td></td><td><output>100</output>¬†%</td><td></td></tr></tbody></table></div><blockquote><details><summary>Blur Fragment Shader <a href="https://blog.frost.kiwi/dual-kawase/shader/noBlurYet.fs" target="_blank">noBlurYet.fs</a></summary><pre><code>


<span>precision</span> <span>highp</span> <span>float</span><span>;</span>


<span>varying</span> <span>vec2</span> uv<span>;</span>


<span>uniform</span> <span>float</span> lightBrightness<span>;</span>


<span>uniform</span> <span>sampler2D</span> texture<span>;</span>


<span>void</span> <span>main</span><span>(</span><span>)</span> <span>{</span>
	
	gl_FragColor <span>=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv<span>)</span> <span>*</span> lightBrightness<span>;</span>
<span>}</span></code></pre></details><details><summary>WebGL Javascript <a href="https://blog.frost.kiwi/dual-kawase/js/blur/simple.js" target="_blank">simple.js</a></summary><pre><code><span>import</span> <span>*</span> <span>as</span> util <span>from</span> <span>&#39;../utility.js&#39;</span>

<span>export</span> <span>async</span> <span>function</span> <span>setupSimple</span><span>(</span><span>)</span> <span>{</span>
	
	<span>const</span> WebGLBox <span>=</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-Simple&#39;</span><span>)</span><span>;</span>
	<span>const</span> canvas <span>=</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;canvas&#39;</span><span>)</span><span>;</span>

	
	<span>const</span> radius <span>=</span> <span>0.12</span><span>;</span>

	
	<span>const</span> gl <span>=</span> canvas<span>.</span><span>getContext</span><span>(</span><span>&#39;webgl&#39;</span><span>,</span> <span>{</span>
		<span>preserveDrawingBuffer</span><span>:</span> <span>false</span><span>,</span>
		<span>antialias</span><span>:</span> <span>false</span><span>,</span>
		<span>alpha</span><span>:</span> <span>false</span><span>,</span>
	<span>}</span><span>)</span><span>;</span>

	
	<span>const</span> ctx <span>=</span> <span>{</span>
		
		<span>mode</span><span>:</span> <span>&#34;scene&#34;</span><span>,</span>
		<span>flags</span><span>:</span> <span>{</span> <span>isRendering</span><span>:</span> <span>false</span><span>,</span> <span>buffersInitialized</span><span>:</span> <span>false</span><span>,</span> <span>initComplete</span><span>:</span> <span>false</span><span>,</span> <span>benchMode</span><span>:</span> <span>false</span> <span>}</span><span>,</span>
		
		<span>tex</span><span>:</span> <span>{</span> <span>sdr</span><span>:</span> <span>null</span><span>,</span> <span>selfIllum</span><span>:</span> <span>null</span><span>,</span> <span>frame</span><span>:</span> <span>null</span><span>,</span> <span>frameFinal</span><span>:</span> <span>null</span> <span>}</span><span>,</span>
		
		<span>fb</span><span>:</span> <span>{</span> <span>scene</span><span>:</span> <span>null</span><span>,</span> <span>final</span><span>:</span> <span>null</span> <span>}</span><span>,</span>
		
		<span>shd</span><span>:</span> <span>{</span>
			<span>scene</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>offset</span><span>:</span> <span>null</span><span>,</span> <span>radius</span><span>:</span> <span>null</span> <span>}</span> <span>}</span><span>,</span>
			<span>blur</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>frameSizeRCP</span><span>:</span> <span>null</span><span>,</span> <span>samplePosMult</span><span>:</span> <span>null</span><span>,</span> <span>lightBrightness</span><span>:</span> <span>null</span> <span>}</span> <span>}</span><span>,</span>
			<span>bloom</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>offset</span><span>:</span> <span>null</span><span>,</span> <span>radius</span><span>:</span> <span>null</span><span>,</span> <span>texture</span><span>:</span> <span>null</span><span>,</span> <span>textureAdd</span><span>:</span> <span>null</span> <span>}</span> <span>}</span>
		<span>}</span>
	<span>}</span><span>;</span>

	
	<span>const</span> ui <span>=</span> <span>{</span>
		<span>display</span><span>:</span> <span>{</span>
			<span>spinner</span><span>:</span> canvas<span>.</span>parentElement<span>.</span><span>querySelector</span><span>(</span><span>&#39;svg&#39;</span><span>,</span> canvas<span>.</span>parentElement<span>)</span><span>,</span>
			<span>contextLoss</span><span>:</span> canvas<span>.</span>parentElement<span>.</span><span>querySelector</span><span>(</span><span>&#39;div&#39;</span><span>,</span> canvas<span>.</span>parentElement<span>)</span><span>,</span>
			<span>fps</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#fps&#39;</span><span>)</span><span>,</span>
			<span>ms</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#ms&#39;</span><span>)</span><span>,</span>
			<span>width</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#width&#39;</span><span>)</span><span>,</span>
			<span>height</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#height&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>rendering</span><span>:</span> <span>{</span>
			<span>animate</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#animateCheck&#39;</span><span>)</span><span>,</span>
			<span>modes</span><span>:</span> WebGLBox<span>.</span><span>querySelectorAll</span><span>(</span><span>&#39;input[type=&#34;radio&#34;]&#39;</span><span>)</span><span>,</span>
			<span>lightBrightness</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#lightBrightness&#39;</span><span>)</span><span>,</span>
			<span>lightBrightnessReset</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#lightBrightnessReset&#39;</span><span>)</span><span>,</span>
		<span>}</span>
	<span>}</span><span>;</span>

	
	<span>const</span> circleAnimation <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/circleAnimation.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> simpleTexture <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/simpleTexture.fs&#34;</span><span>)</span><span>;</span>
	<span>const</span> bloomVert <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/bloom.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> bloomFrag <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/bloom.fs&#34;</span><span>)</span><span>;</span>
	<span>const</span> simpleQuad <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/simpleQuad.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> noBlurYetFrag <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/noBlurYet.fs&#34;</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>animate<span>.</span><span>addEventListener</span><span>(</span><span>&#34;change&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
			<span>startRendering</span><span>(</span><span>)</span><span>;</span>
		<span>else</span> <span>{</span>
			ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
			ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
			ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>false</span><span>;</span>
			<span>redraw</span><span>(</span><span>)</span>
		<span>}</span>
	<span>}</span><span>)</span><span>;</span>

	canvas<span>.</span><span>addEventListener</span><span>(</span><span>&#34;webglcontextlost&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ui<span>.</span>display<span>.</span>contextLoss<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>modes<span>.</span><span>forEach</span><span>(</span><span>radio</span> <span>=&gt;</span> <span>{</span>
		
		<span>if</span> <span>(</span>radio<span>.</span>value <span>===</span> <span>&#34;scene&#34;</span><span>)</span>
			radio<span>.</span>checked <span>=</span> <span>true</span><span>;</span>
		radio<span>.</span><span>addEventListener</span><span>(</span><span>&#39;change&#39;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
			ctx<span>.</span>mode <span>=</span> event<span>.</span>target<span>.</span>value<span>;</span>
			ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>disabled <span>=</span> ctx<span>.</span>mode <span>===</span> <span>&#34;scene&#34;</span><span>;</span>
			ui<span>.</span>rendering<span>.</span>lightBrightnessReset<span>.</span>disabled <span>=</span> ctx<span>.</span>mode <span>===</span> <span>&#34;scene&#34;</span><span>;</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>scene <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> circleAnimation<span>,</span> simpleTexture<span>,</span> <span>[</span><span>&#34;offset&#34;</span><span>,</span> <span>&#34;radius&#34;</span><span>]</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>bloom <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> bloomVert<span>,</span> bloomFrag<span>,</span> <span>[</span><span>&#34;texture&#34;</span><span>,</span> <span>&#34;textureAdd&#34;</span><span>,</span> <span>&#34;offset&#34;</span><span>,</span> <span>&#34;radius&#34;</span><span>]</span><span>)</span><span>;</span>

	
	<span>function</span> <span>reCompileBlurShader</span><span>(</span><span>)</span> <span>{</span>
		ctx<span>.</span>shd<span>.</span>blur <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> simpleQuad<span>,</span> noBlurYetFrag<span>,</span> <span>[</span><span>&#34;lightBrightness&#34;</span><span>]</span><span>)</span><span>;</span>
	<span>}</span>

	
	<span>reCompileBlurShader</span><span>(</span><span>)</span>

	
	util<span>.</span><span>bindUnitQuad</span><span>(</span>gl<span>)</span><span>;</span>

	<span>async</span> <span>function</span> <span>setupTextureBuffers</span><span>(</span><span>)</span> <span>{</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>buffersInitialized <span>=</span> <span>true</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>false</span><span>;</span>

		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>final<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>scene<span>,</span> ctx<span>.</span>tex<span>.</span>frame<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>final<span>,</span> ctx<span>.</span>tex<span>.</span>frameFinal<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>

		<span>let</span> <span>[</span>base<span>,</span> selfIllum<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>
			<span>fetch</span><span>(</span><span>&#34;/dual-kawase/img/SDR_No_Sprite.png&#34;</span><span>)</span><span>,</span>
			<span>fetch</span><span>(</span><span>&#34;/dual-kawase/img/Selfillumination.png&#34;</span><span>)</span>
		<span>]</span><span>)</span><span>;</span>
		<span>let</span> <span>[</span>baseBlob<span>,</span> selfIllumBlob<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>base<span>.</span><span>blob</span><span>(</span><span>)</span><span>,</span> selfIllum<span>.</span><span>blob</span><span>(</span><span>)</span><span>]</span><span>)</span><span>;</span>
		<span>let</span> <span>[</span>baseBitmap<span>,</span> selfIllumBitmap<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>
			<span>createImageBitmap</span><span>(</span>baseBlob<span>,</span> <span>{</span> <span>colorSpaceConversion</span><span>:</span> <span>&#39;none&#39;</span><span>,</span> <span>resizeWidth</span><span>:</span> canvas<span>.</span>width <span>*</span> <span>1.12</span><span>,</span> <span>resizeHeight</span><span>:</span> canvas<span>.</span>height <span>*</span> <span>1.12</span><span>,</span> <span>resizeQuality</span><span>:</span> <span>&#34;high&#34;</span> <span>}</span><span>)</span><span>,</span>
			<span>createImageBitmap</span><span>(</span>selfIllumBlob<span>,</span> <span>{</span> <span>colorSpaceConversion</span><span>:</span> <span>&#39;none&#39;</span><span>,</span> <span>resizeWidth</span><span>:</span> canvas<span>.</span>width <span>*</span> <span>1.12</span><span>,</span> <span>resizeHeight</span><span>:</span> canvas<span>.</span>height <span>*</span> <span>1.12</span><span>,</span> <span>resizeQuality</span><span>:</span> <span>&#34;high&#34;</span> <span>}</span><span>)</span>
		<span>]</span><span>)</span><span>;</span>

		ctx<span>.</span>tex<span>.</span>sdr <span>=</span> util<span>.</span><span>setupTexture</span><span>(</span>gl<span>,</span> <span>null</span><span>,</span> <span>null</span><span>,</span> ctx<span>.</span>tex<span>.</span>sdr<span>,</span> gl<span>.</span><span>LINEAR</span><span>,</span> baseBitmap<span>)</span><span>;</span>
		ctx<span>.</span>tex<span>.</span>selfIllum <span>=</span> util<span>.</span><span>setupTexture</span><span>(</span>gl<span>,</span> <span>null</span><span>,</span> <span>null</span><span>,</span> ctx<span>.</span>tex<span>.</span>selfIllum<span>,</span> gl<span>.</span><span>LINEAR</span><span>,</span> selfIllumBitmap<span>)</span><span>;</span>

		baseBitmap<span>.</span><span>close</span><span>(</span><span>)</span><span>;</span>
		selfIllumBitmap<span>.</span><span>close</span><span>(</span><span>)</span><span>;</span>

		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>true</span><span>;</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;none&#34;</span><span>;</span>
	<span>}</span>

	<span>let</span> prevNow <span>=</span> performance<span>.</span><span>now</span><span>(</span><span>)</span><span>;</span>
	<span>let</span> lastStatsUpdate <span>=</span> prevNow<span>;</span>
	<span>let</span> fpsEMA <span>=</span> <span>60</span><span>;</span>
	<span>let</span> msEMA <span>=</span> <span>16</span><span>;</span>

	<span>async</span> <span>function</span> <span>redraw</span><span>(</span><span>)</span> <span>{</span>
		<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>buffersInitialized<span>)</span>
			<span>await</span> <span>setupTextureBuffers</span><span>(</span><span>)</span><span>;</span>
		<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>initComplete<span>)</span>
			<span>return</span><span>;</span>

		
		ui<span>.</span>display<span>.</span>width<span>.</span>value <span>=</span> canvas<span>.</span>width<span>;</span>
		ui<span>.</span>display<span>.</span>height<span>.</span>value <span>=</span> canvas<span>.</span>height<span>;</span>

		
		<span>let</span> radiusSwitch <span>=</span> ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked <span>?</span> radius <span>:</span> <span>0.0</span><span>;</span>
		<span>let</span> speed <span>=</span> <span>(</span>performance<span>.</span><span>now</span><span>(</span><span>)</span> <span>/</span> <span>10000</span><span>)</span> <span>%</span> Math<span>.</span><span>PI</span> <span>*</span> <span>2</span><span>;</span>
		<span>const</span> offset <span>=</span> <span>[</span>radiusSwitch <span>*</span> Math<span>.</span><span>cos</span><span>(</span>speed<span>)</span><span>,</span> radiusSwitch <span>*</span> Math<span>.</span><span>sin</span><span>(</span>speed<span>)</span><span>]</span><span>;</span>
		gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>handle<span>)</span><span>;</span>
		<span>const</span> texture <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> ctx<span>.</span>tex<span>.</span>sdr <span>:</span> ctx<span>.</span>tex<span>.</span>selfIllum<span>;</span>
		gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
		gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> texture<span>)</span><span>;</span>
		gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>uniforms<span>.</span>offset<span>,</span> offset<span>)</span><span>;</span>
		gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>uniforms<span>.</span>radius<span>,</span> radiusSwitch<span>)</span><span>;</span>

		
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span>
		gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>

		
		gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>

		
		gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>handle<span>)</span><span>;</span>
		<span>const</span> finalFB <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;bloom&#34;</span> <span>?</span> ctx<span>.</span>fb<span>.</span>final <span>:</span> <span>null</span><span>;</span>
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> finalFB<span>)</span><span>;</span>
		gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
		gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>lightBrightness<span>,</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> <span>1.0</span> <span>:</span> ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>value<span>)</span><span>;</span>
		gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
		gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>frame<span>)</span><span>;</span>
		gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>

		<span>if</span> <span>(</span>ctx<span>.</span>mode <span>==</span> <span>&#34;bloom&#34;</span><span>)</span> <span>{</span>
			
			gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> <span>null</span><span>)</span><span>;</span>
			gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>handle<span>)</span><span>;</span>

			gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>offset<span>,</span> offset<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>radius<span>,</span> radiusSwitch<span>)</span><span>;</span>

			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>sdr<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1i</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>texture<span>,</span> <span>0</span><span>)</span><span>;</span>

			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE1</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>frameFinal<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1i</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>textureAdd<span>,</span> <span>1</span><span>)</span><span>;</span>

			gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
		<span>}</span>

		
		gl<span>.</span><span>finish</span><span>(</span><span>)</span><span>;</span>

		<span>const</span> now <span>=</span> performance<span>.</span><span>now</span><span>(</span><span>)</span><span>;</span>
		<span>let</span> dt <span>=</span> now <span>-</span> prevNow<span>;</span>

		<span>if</span> <span>(</span>dt <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
			<span>const</span> instFPS <span>=</span> <span>1000</span> <span>/</span> dt<span>;</span>
			<span>const</span> <span>ALPHA</span> <span>=</span> <span>0.05</span><span>;</span>
			fpsEMA <span>=</span> <span>ALPHA</span> <span>*</span> instFPS <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>ALPHA</span><span>)</span> <span>*</span> fpsEMA<span>;</span>
			msEMA <span>=</span> <span>ALPHA</span> <span>*</span> dt <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>ALPHA</span><span>)</span> <span>*</span> msEMA<span>;</span>
		<span>}</span>
		prevNow <span>=</span> now<span>;</span>

		<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked <span>&amp;&amp;</span> now <span>-</span> lastStatsUpdate <span>&gt;=</span> <span>1000</span><span>)</span> <span>{</span>
			ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> fpsEMA<span>.</span><span>toFixed</span><span>(</span><span>0</span><span>)</span><span>;</span>
			ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> msEMA<span>.</span><span>toFixed</span><span>(</span><span>2</span><span>)</span><span>;</span>
			lastStatsUpdate <span>=</span> now<span>;</span>
		<span>}</span>
	<span>}</span>

	<span>let</span> animationFrameId<span>;</span>

	
	<span>function</span> <span>nativeResize</span><span>(</span><span>)</span> <span>{</span>
		<span>const</span> <span>[</span>width<span>,</span> height<span>]</span> <span>=</span> util<span>.</span><span>getNativeSize</span><span>(</span>canvas<span>)</span><span>;</span>

		<span>if</span> <span>(</span>width <span>&amp;&amp;</span> canvas<span>.</span>width <span>!==</span> width <span>||</span> height <span>&amp;&amp;</span> canvas<span>.</span>height <span>!==</span> height<span>)</span> <span>{</span>
			canvas<span>.</span>width <span>=</span> width<span>;</span>
			canvas<span>.</span>height <span>=</span> height<span>;</span>

			<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>benchMode<span>)</span> <span>{</span>
				<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
				<span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
				<span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span>
	<span>}</span>

	
	<span>nativeResize</span><span>(</span><span>)</span><span>;</span>

	<span>let</span> resizePending <span>=</span> <span>false</span><span>;</span>
	window<span>.</span><span>addEventListener</span><span>(</span><span>&#39;resize&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>if</span> <span>(</span><span>!</span>resizePending<span>)</span> <span>{</span>
			resizePending <span>=</span> <span>true</span><span>;</span>
			<span>requestAnimationFrame</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
				resizePending <span>=</span> <span>false</span><span>;</span>
				<span>nativeResize</span><span>(</span><span>)</span><span>;</span>
			<span>}</span><span>)</span><span>;</span>
		<span>}</span>
	<span>}</span><span>)</span><span>;</span>

	<span>function</span> <span>renderLoop</span><span>(</span><span>)</span> <span>{</span>
		<span>if</span> <span>(</span>ctx<span>.</span>flags<span>.</span>isRendering <span>&amp;&amp;</span> ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>{</span>
			<span>redraw</span><span>(</span><span>)</span><span>;</span>
			animationFrameId <span>=</span> <span>requestAnimationFrame</span><span>(</span>renderLoop<span>)</span><span>;</span>
		<span>}</span>
	<span>}</span>

	<span>function</span> <span>startRendering</span><span>(</span><span>)</span> <span>{</span>
		
		ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>true</span><span>;</span>
		<span>renderLoop</span><span>(</span><span>)</span><span>;</span>
	<span>}</span>

	<span>function</span> <span>stopRendering</span><span>(</span><span>)</span> <span>{</span>
		
		ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>false</span><span>;</span>
		<span>cancelAnimationFrame</span><span>(</span>animationFrameId<span>)</span><span>;</span>
		
		gl<span>.</span><span>finish</span><span>(</span><span>)</span><span>;</span>

		
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>sdr<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>sdr <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>selfIllum<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>selfIllum <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>frame<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>frame <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>frameFinal<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>frameFinal <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>scene <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>final<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>final <span>=</span> <span>null</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>buffersInitialized <span>=</span> <span>false</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>false</span><span>;</span>
		ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
		ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
	<span>}</span>

	<span>function</span> <span>handleIntersection</span><span>(</span><span>entries</span><span>)</span> <span>{</span>
		entries<span>.</span><span>forEach</span><span>(</span><span>entry</span> <span>=&gt;</span> <span>{</span>
			<span>if</span> <span>(</span>entry<span>.</span>isIntersecting<span>)</span> <span>{</span>
				<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>isRendering <span>&amp;&amp;</span> <span>!</span>ctx<span>.</span>flags<span>.</span>benchMode<span>)</span> <span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span> <span>else</span> <span>{</span>
				<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span>

	
	<span>let</span> observer <span>=</span> <span>new</span> <span>IntersectionObserver</span><span>(</span>handleIntersection<span>)</span><span>;</span>
	observer<span>.</span><span>observe</span><span>(</span>canvas<span>)</span><span>;</span>
<span>}</span></code></pre></details></blockquote><p>We don‚Äôt have a blur implemented yet, not much happening. Above the box you have an <code>Animate</code> button, which will move the scene around to tease out problems of upcoming algorithms. Movement happens <strong>before</strong> our blur will be applied, akin to the player character moving. To see our blur in different use-cases, there are 3 modes:</p><blockquote><p>Different blur algorithms behave differently based on use-case. Some are very performance efficient, but break under movement. Some reveal their flaws with small, high contrast regions like far-away lights</p><img src="https://blog.frost.kiwi/assets/kiwis/teach.svg"/></blockquote><ul><li>In <code>Scene</code> mode the blur will be applied across the whole image</li><li>In <code>Lights</code> mode we see and blur just the <a href="https://docs.blender.org/manual/en/latest/render/shader_nodes/shader/principled.html#emission" target="_blank">Emission</a> parts of the scene, sometimes called ‚Äú<a href="https://developer.valvesoftware.com/wiki/Glowing_textures_(Source)#$selfillum" target="_blank">Self-Illumination</a>‚Äù<ul><li>This also unlocks the <code>lightBrightness</code> slider, where you can boost the energy output of the lights</li></ul></li><li>In <code>Bloom</code> mode, we use the original scene and add the blurred lights from the previous mode on top to create a moody scene. This implements the effect of <a href="https://en.wikipedia.org/wiki/Bloom_(shader_effect)" target="_blank">Bloom</a>, an important use-case for blurs in real-time 3D graphics</li></ul><blockquote><p>Adding the blurred emission <a href="https://chrismillervfx.wordpress.com/2013/04/15/understanding-render-passes/" target="_blank">pass</a> as we do in this article, or <a href="https://en.wikipedia.org/wiki/Thresholding_(image_processing)" target="_blank">thresholding</a> the scene and blurring that, is <strong>not</strong> actually how modern video games do bloom. We&#39;ll get into that a bit later.</p><img src="https://blog.frost.kiwi/assets/kiwis/detective.svg"/></blockquote><p>Finally, you see <a href="https://en.wikipedia.org/wiki/Image_resolution" target="_blank">Resolution</a> of the canvas and <a href="https://en.wikipedia.org/wiki/Frame_rate" target="_blank">Frames per Second / time taken per frame, aka ‚Äúframetime‚Äù</a>. A very important piece of the puzzle is <em><strong>performance</strong></em>, which will become more and more important as the article continues and the <a href="https://en.wikipedia.org/wiki/Necessity_is_the_mother_of_invention" target="_blank">mother of invention</a> behind our story.</p><blockquote><p>Frame-rate will be capped at your screen&#39;s <a href="https://www.intel.com/content/www/us/en/gaming/resources/highest-refresh-rate-gaming.html" target="_blank">refresh rate</a>, most likely 60 fps / 16.6 ms. We&#39;ll get into proper <a href="https://en.wikipedia.org/wiki/Benchmark_(computing)" target="_blank">benchmarking</a> as our hero descents this article into blurry madness</p><img src="https://blog.frost.kiwi/assets/kiwis/book.svg"/></blockquote><h3 id="technical-breakdown" tabindex="-1">Technical breakdown <a href="#technical-breakdown">#</a></h3><blockquote><p>Understanding the GPU code is not necessary to follow this article, but if you do choose to <a href="https://github.com/FrostKiwi/treasurechest/tree/main/posts/dual-kawase" target="_blank">peek behind the curtain</a>, here is what you need to know</p><img src="https://blog.frost.kiwi/assets/kiwis/teach.svg"/></blockquote><p>We‚Äôll implement our blurs as a <a href="https://learnopengl.com/Getting-started/Hello-Triangle" target="_blank">fragment shader</a> written in <a href="https://en.wikipedia.org/wiki/OpenGL_Shading_Language" target="_blank">GLSL</a>. In a nut-shell, a fragment shader is code that runs on the GPU for every output-pixel, in-parallel. Image inputs in shaders are called <a href="https://learnopengl.com/Getting-started/Textures" target="_blank">Textures</a>. These textures have coordinates, often called <a href="https://en.wikipedia.org/wiki/UV_mapping" target="_blank">UV coordinates</a> - <em>these</em> are the numbers we care about.</p><blockquote><p>Technically, fragment shaders run per <a href="https://www.khronos.org/opengl/wiki/Fragment" target="_blank">fragment</a>, which aren&#39;t necessarily pixel sized and there are <a href="https://registry.khronos.org/OpenGL/extensions/EXT/EXT_shader_framebuffer_fetch.txt" target="_blank">other ways</a> to read framebuffers, but none of that matters in the context of this article.</p><img src="https://blog.frost.kiwi/assets/kiwis/detective.svg"/></blockquote><figure><img src="https://blog.frost.kiwi/dual-kawase/img/UV.svg" alt="Texture coordinates, also called UV Coordinates or UVs for short"/><figcaption>Texture coordinates, also called &#34;UV&#34; Coordinates or &#34;UVs&#34; for short</figcaption></figure><p>UV coordinates specify the position we read in the image, with bottom left being <code>0,0</code> and the top right being <code>1,1</code>. Neither UV coordinates, nor shaders themselves have any concept of image resolution, screen resolution or aspect ratio. If we want to address individual pixels, it‚Äôs on us to express that in terms of UV coordinates.</p><blockquote><div><p>Although <a href="https://michaldrobot.com/2014/04/01/gcn-execution-patterns-in-full-screen-passes/" target="_blank">there are ways to find out</a>, we don&#39;t know which order output-pixels are processed in, and although the <a href="https://docs.gl/sl4/gl_FragCoord" target="_blank">graphics pipeline can tell us</a>, the shader doesn&#39;t even know which output-pixel it currently processes</p></div><img src="https://blog.frost.kiwi/assets/kiwis/book.svg"/></blockquote><p>The framebuffer is passed into the fragment shader in line <code>uniform sampler2D texture</code> as a texture. Using the blur shader, we draw a ‚ÄúFull Screen Quad‚Äù, a rectangle covering the entire canvas, with matching <code>0,0</code> in the bottom-left and <code>1,1</code> in the top-right <code>varying vec2 uv</code> UV coordinates to read from the texture.</p><p>The texture‚Äôs aspect-ratio and resolution are the same as the output canvas‚Äôs aspect-ratio and resolution, thus there is a 1:1 pixel mapping between the texture we will process and our output canvas. The <a href="https://github.com/FrostKiwi/treasurechest/blob/main/posts/dual-kawase/js/blur/simple.js" target="_blank">graphics pipeline steps</a> and <a href="https://github.com/FrostKiwi/treasurechest/blob/main/posts/dual-kawase/shader/simpleQuad.vs" target="_blank">vertex shader</a> responsible for this are not important for this article.</p><p>The blur fragment shader accesses the color of the texture with <code>texture2D(texture, uv)</code>, at the matching output pixel‚Äôs position. In following examples, we‚Äôll read from neighboring pixels, for which we‚Äôll need to calculate a UV coordinate offset, a decimal fraction corresponding to one pixel step, calculated with with <code>1 / canvasResolution</code></p><blockquote><p>One way to think of fragment shader code is &#34;What are the instructions to construct this output pixel?&#34;</p><img src="https://blog.frost.kiwi/assets/kiwis/think.svg"/></blockquote><p>Graphics programming is <a href="https://www.youtube.com/watch?v=xJQ0qXh1-m0" target="_blank">uniquely challenging</a> in the beginning, because of how many rules and limitations the hardware, <a href="https://en.wikipedia.org/wiki/Graphics_library" target="_blank">graphics APIs</a> and the <a href="https://fgiesen.wordpress.com/2011/07/09/a-trip-through-the-graphics-pipeline-2011-index/" target="_blank">rendering pipeline</a> impose. But it also unlocks incredible potential, as other limitations dissolve. Let‚Äôs find out how graphics programmers have leveraged that potential.</p><h2 id="box-blur" tabindex="-1">Box Blur <a href="#box-blur">#</a></h2><p>From a programmer‚Äôs perspective, the most straight forward way is to average the neighbors of a pixel using a <a href="https://en.wikipedia.org/wiki/For_loop" target="_blank">for-loop</a>. What the fragment shader is expressing is: ‚Äú<em>look Y pixels up &amp; down, X pixels left &amp; right and average the colors</em>‚Äù. The more we want to blur, the more we have to increase <code>kernelSize</code>, the bounds of our for-loop.</p><pre><code>
<span>for</span> <span>(</span><span>int</span> y <span>=</span> <span>-</span>kernel_size<span>;</span> y <span>&lt;=</span> kernel_size<span>;</span> <span>++</span>y<span>)</span> <span>{</span>

	<span>for</span> <span>(</span><span>int</span> x <span>=</span> <span>-</span>kernel_size<span>;</span> x <span>&lt;=</span> kernel_size<span>;</span> <span>++</span>x<span>)</span> <span>{</span>
		
		<span>vec2</span> offset <span>=</span> <span>vec2</span><span>(</span>x<span>,</span> y<span>)</span> <span>*</span> samplePosMult <span>*</span> frameSizeRCP<span>;</span>
		
		sum <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> offset<span>)</span><span>;</span>
	<span>}</span>
<span>}</span></code></pre><p>The bigger the for-loop, the more texture reads we perform, <strong>per output-pixel</strong>. Each texture read is often called a ‚Äútexture tap‚Äù and the total amount of those ‚Äútaps‚Äù per-frame will now also be displayed. New controls, new <code>samplePosMultiplier</code>, new terms - Play around with them, get a feel for them, with a constant eye on FPS.</p><div id="WebGLBox-BoxBlur"><div><p><label> Scene</label> <label> Lights</label> <label> Bloom</label></p><p><label> Animate</label></p></div><div><canvas></canvas><p>‚ùå The browser killed this WebGL Context, please reload the page. If this happened as the result of a long benchmark, decrease the iteration count. On some platforms (iOS / iPad) you may have to restart the browser App completely, as the browser will temporarily refuse to allow this site to run WebGL again.</p><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" fill="transparent" r="10" stroke-width="2"></circle><rect height="7" rx="1" width="2" x="11" y="6"></rect><rect height="9" rx="1" width="2" x="11" y="11"></rect></svg></div><table><tbody><tr><td colspan="4"><p><span><strong>FPS:</strong><output id="fps">?</output>/<output id="ms">?</output>ms </span><span><strong>Resolution:</strong><output id="width">?</output>x<output id="height">?</output></span><span><strong>Texture Taps:</strong><output id="taps">?</output></span></p></td></tr><tr><td colspan="4"><code>kernelSize</code></td></tr><tr><td><code>kernelSize</code></td><td></td><td><output>7x7</output>¬†px</td><td></td></tr><tr><td colspan="4"><code>samplePosMultiplier</code></td></tr><tr><td><code>samplePosMultiplier</code></td><td></td><td><output>100</output>¬†%</td><td></td></tr><tr><td colspan="4"><code>lightBrightness</code></td></tr><tr><td><code>lightBrightness</code></td><td></td><td><output>100</output>¬†%</td><td></td></tr></tbody></table></div><blockquote id="WebGLBox-BoxBlurDetail"><details><summary>Blur Fragment Shader <a href="https://blog.frost.kiwi/dual-kawase/shader/boxBlur.fs" target="_blank">boxBlur.fs</a></summary><pre><code>
<span>precision</span> <span>highp</span> <span>float</span><span>;</span>

<span>varying</span> <span>vec2</span> uv<span>;</span>


<span>uniform</span> <span>vec2</span> frameSizeRCP<span>;</span>
<span>uniform</span> <span>float</span> samplePosMult<span>;</span> 

<span>uniform</span> <span>float</span> bloomStrength<span>;</span> 

<span>uniform</span> <span>sampler2D</span> texture<span>;</span>

<span>const</span> <span>int</span> kernel_size <span>=</span> KERNEL_SIZE<span>;</span>

<span>void</span> <span>main</span><span>(</span><span>)</span> <span>{</span>
	
	<span>vec4</span> sum <span>=</span> <span>vec4</span><span>(</span><span>0.0</span><span>)</span><span>;</span>
	
	<span>const</span> <span>int</span> size <span>=</span> <span>2</span> <span>*</span> kernel_size <span>+</span> <span>1</span><span>;</span>
	
	<span>const</span> <span>float</span> totalSamples <span>=</span> <span>float</span><span>(</span>size <span>*</span> size<span>)</span><span>;</span>

	
	<span>for</span> <span>(</span><span>int</span> y <span>=</span> <span>-</span>kernel_size<span>;</span> y <span>&lt;=</span> kernel_size<span>;</span> <span>++</span>y<span>)</span> <span>{</span>
	
		<span>for</span> <span>(</span><span>int</span> x <span>=</span> <span>-</span>kernel_size<span>;</span> x <span>&lt;=</span> kernel_size<span>;</span> <span>++</span>x<span>)</span> <span>{</span>
			
			<span>vec2</span> offset <span>=</span> <span>vec2</span><span>(</span>x<span>,</span> y<span>)</span> <span>*</span> samplePosMult <span>*</span> frameSizeRCP<span>;</span>
			
			sum <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> offset<span>)</span><span>;</span>
		<span>}</span>
	<span>}</span>

	
	gl_FragColor <span>=</span> <span>(</span>sum <span>/</span> totalSamples<span>)</span> <span>*</span> bloomStrength<span>;</span>
<span>}</span></code></pre></details><details><summary>WebGL Javascript <a href="https://blog.frost.kiwi/dual-kawase/js/blur/boxBlur.js" target="_blank">boxBlur.js</a></summary><pre><code><span>import</span> <span>*</span> <span>as</span> util <span>from</span> <span>&#39;../utility.js&#39;</span>

<span>export</span> <span>async</span> <span>function</span> <span>setupBoxBlur</span><span>(</span><span>)</span> <span>{</span>
	
	<span>const</span> WebGLBox <span>=</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-BoxBlur&#39;</span><span>)</span><span>;</span>
	<span>const</span> WebGLBoxDetail <span>=</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-BoxBlurDetail&#39;</span><span>)</span><span>;</span>
	<span>const</span> canvas <span>=</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;canvas&#39;</span><span>)</span><span>;</span>

	
	<span>const</span> radius <span>=</span> <span>0.12</span><span>;</span>

	
	<span>const</span> gl <span>=</span> canvas<span>.</span><span>getContext</span><span>(</span><span>&#39;webgl&#39;</span><span>,</span> <span>{</span>
		<span>preserveDrawingBuffer</span><span>:</span> <span>false</span><span>,</span>
		<span>antialias</span><span>:</span> <span>false</span><span>,</span>
		<span>alpha</span><span>:</span> <span>false</span><span>,</span>
	<span>}</span><span>)</span><span>;</span>

	
	<span>const</span> ctx <span>=</span> <span>{</span>
		
		<span>mode</span><span>:</span> <span>&#34;scene&#34;</span><span>,</span>
		<span>flags</span><span>:</span> <span>{</span> <span>isRendering</span><span>:</span> <span>false</span><span>,</span> <span>buffersInitialized</span><span>:</span> <span>false</span><span>,</span> <span>initComplete</span><span>:</span> <span>false</span><span>,</span> <span>benchMode</span><span>:</span> <span>false</span> <span>}</span><span>,</span>
		
		<span>tex</span><span>:</span> <span>{</span> <span>sdr</span><span>:</span> <span>null</span><span>,</span> <span>selfIllum</span><span>:</span> <span>null</span><span>,</span> <span>frame</span><span>:</span> <span>null</span><span>,</span> <span>frameFinal</span><span>:</span> <span>null</span> <span>}</span><span>,</span>
		
		<span>fb</span><span>:</span> <span>{</span> <span>scene</span><span>:</span> <span>null</span><span>,</span> <span>final</span><span>:</span> <span>null</span> <span>}</span><span>,</span>
		
		<span>shd</span><span>:</span> <span>{</span>
			<span>scene</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>offset</span><span>:</span> <span>null</span><span>,</span> <span>radius</span><span>:</span> <span>null</span> <span>}</span> <span>}</span><span>,</span>
			<span>blur</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>frameSizeRCP</span><span>:</span> <span>null</span><span>,</span> <span>samplePosMult</span><span>:</span> <span>null</span><span>,</span> <span>bloomStrength</span><span>:</span> <span>null</span> <span>}</span> <span>}</span><span>,</span>
			<span>bloom</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>offset</span><span>:</span> <span>null</span><span>,</span> <span>radius</span><span>:</span> <span>null</span><span>,</span> <span>texture</span><span>:</span> <span>null</span><span>,</span> <span>textureAdd</span><span>:</span> <span>null</span> <span>}</span> <span>}</span>
		<span>}</span>
	<span>}</span><span>;</span>

	
	<span>const</span> ui <span>=</span> <span>{</span>
		<span>display</span><span>:</span> <span>{</span>
			<span>spinner</span><span>:</span> canvas<span>.</span>parentElement<span>.</span><span>querySelector</span><span>(</span><span>&#39;svg&#39;</span><span>,</span> canvas<span>.</span>parentElement<span>)</span><span>,</span>
			<span>contextLoss</span><span>:</span> canvas<span>.</span>parentElement<span>.</span><span>querySelector</span><span>(</span><span>&#39;div&#39;</span><span>,</span> canvas<span>.</span>parentElement<span>)</span><span>,</span>
			<span>fps</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#fps&#39;</span><span>)</span><span>,</span>
			<span>ms</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#ms&#39;</span><span>)</span><span>,</span>
			<span>width</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#width&#39;</span><span>)</span><span>,</span>
			<span>height</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#height&#39;</span><span>)</span><span>,</span>
			<span>tapsCount</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#taps&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>blur</span><span>:</span> <span>{</span>
			<span>kernelSize</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#sizeRange&#39;</span><span>)</span><span>,</span>
			<span>samplePos</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#samplePosRange&#39;</span><span>)</span><span>,</span>
			<span>samplePosReset</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#samplePosRangeReset&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>rendering</span><span>:</span> <span>{</span>
			<span>animate</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#animateCheck&#39;</span><span>)</span><span>,</span>
			<span>modes</span><span>:</span> WebGLBox<span>.</span><span>querySelectorAll</span><span>(</span><span>&#39;input[type=&#34;radio&#34;]&#39;</span><span>)</span><span>,</span>
			<span>lightBrightness</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#lightBrightness&#39;</span><span>)</span><span>,</span>
			<span>lightBrightnessReset</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#lightBrightnessReset&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>benchmark</span><span>:</span> <span>{</span>
			<span>button</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#benchmark&#39;</span><span>)</span><span>,</span>
			<span>label</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#benchmarkLabel&#39;</span><span>)</span><span>,</span>
			<span>iterOut</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterOut&#39;</span><span>)</span><span>,</span>
			<span>renderer</span><span>:</span> WebGLBoxDetail<span>.</span><span>querySelector</span><span>(</span><span>&#39;#renderer&#39;</span><span>)</span><span>,</span>
			<span>iterTime</span><span>:</span> WebGLBoxDetail<span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterTime&#39;</span><span>)</span><span>,</span>
			<span>tapsCount</span><span>:</span> WebGLBoxDetail<span>.</span><span>querySelector</span><span>(</span><span>&#39;#tapsCountBench&#39;</span><span>)</span><span>,</span>
			<span>iterations</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterations&#39;</span><span>)</span>
		<span>}</span>
	<span>}</span><span>;</span>

	
	<span>const</span> circleAnimation <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/circleAnimation.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> simpleTexture <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/simpleTexture.fs&#34;</span><span>)</span><span>;</span>
	<span>const</span> bloomVert <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/bloom.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> bloomFrag <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/bloom.fs&#34;</span><span>)</span><span>;</span>
	<span>const</span> simpleQuad <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/simpleQuad.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> boxBlurFrag <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/boxBlur.fs&#34;</span><span>)</span><span>;</span>

	
	ui<span>.</span>blur<span>.</span>kernelSize<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>
	ui<span>.</span>blur<span>.</span>samplePos<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>
	ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>animate<span>.</span><span>addEventListener</span><span>(</span><span>&#34;change&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
			<span>startRendering</span><span>(</span><span>)</span><span>;</span>
		<span>else</span> <span>{</span>
			ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
			ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
			ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>false</span><span>;</span>
			<span>redraw</span><span>(</span><span>)</span>
		<span>}</span>
	<span>}</span><span>)</span><span>;</span>

	canvas<span>.</span><span>addEventListener</span><span>(</span><span>&#34;webglcontextlost&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ui<span>.</span>display<span>.</span>contextLoss<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	ui<span>.</span>blur<span>.</span>kernelSize<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>reCompileBlurShader</span><span>(</span>ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value<span>)</span><span>;</span>
		ui<span>.</span>blur<span>.</span>samplePos<span>.</span>disabled <span>=</span> ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>==</span> <span>0</span><span>;</span>
		ui<span>.</span>blur<span>.</span>samplePosReset<span>.</span>disabled <span>=</span> ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>==</span> <span>0</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>modes<span>.</span><span>forEach</span><span>(</span><span>radio</span> <span>=&gt;</span> <span>{</span>
		
		<span>if</span> <span>(</span>radio<span>.</span>value <span>===</span> <span>&#34;scene&#34;</span><span>)</span>
			radio<span>.</span>checked <span>=</span> <span>true</span><span>;</span>
		radio<span>.</span><span>addEventListener</span><span>(</span><span>&#39;change&#39;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
			ctx<span>.</span>mode <span>=</span> event<span>.</span>target<span>.</span>value<span>;</span>
			ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>disabled <span>=</span> ctx<span>.</span>mode <span>===</span> <span>&#34;scene&#34;</span><span>;</span>
			ui<span>.</span>rendering<span>.</span>lightBrightnessReset<span>.</span>disabled <span>=</span> ctx<span>.</span>mode <span>===</span> <span>&#34;scene&#34;</span><span>;</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	ui<span>.</span>benchmark<span>.</span>button<span>.</span><span>addEventListener</span><span>(</span><span>&#34;click&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ctx<span>.</span>flags<span>.</span>benchMode <span>=</span> <span>true</span><span>;</span>
		<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
		ui<span>.</span>benchmark<span>.</span>button<span>.</span>disabled <span>=</span> <span>true</span><span>;</span>

		
		<span>const</span> worker <span>=</span> <span>new</span> <span>Worker</span><span>(</span><span>&#34;./js/benchmark/boxBlurBenchmark.js&#34;</span><span>,</span> <span>{</span> <span>type</span><span>:</span> <span>&#34;module&#34;</span> <span>}</span><span>)</span><span>;</span>

		
		worker<span>.</span><span>postMessage</span><span>(</span><span>{</span>
			<span>iterations</span><span>:</span> ui<span>.</span>benchmark<span>.</span>iterOut<span>.</span>value<span>,</span>
			<span>blurShaderSrc</span><span>:</span> boxBlurFrag<span>,</span>
			<span>kernelSize</span><span>:</span> ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value<span>,</span>
			<span>samplePos</span><span>:</span> ui<span>.</span>blur<span>.</span>samplePos<span>.</span>value
		<span>}</span><span>)</span><span>;</span>

		
		worker<span>.</span><span>addEventListener</span><span>(</span><span>&#34;message&#34;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
			<span>if</span> <span>(</span>event<span>.</span>data<span>.</span>type <span>!==</span> <span>&#34;done&#34;</span><span>)</span> <span>return</span><span>;</span>

			ui<span>.</span>benchmark<span>.</span>label<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>benchText<span>;</span>
			ui<span>.</span>benchmark<span>.</span>tapsCount<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>tapsCount<span>;</span>
			ui<span>.</span>benchmark<span>.</span>iterTime<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>iterationText<span>;</span>
			ui<span>.</span>benchmark<span>.</span>renderer<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>renderer<span>;</span>

			worker<span>.</span><span>terminate</span><span>(</span><span>)</span><span>;</span>
			ui<span>.</span>benchmark<span>.</span>button<span>.</span>disabled <span>=</span> <span>false</span><span>;</span>
			ctx<span>.</span>flags<span>.</span>benchMode <span>=</span> <span>false</span><span>;</span>
			<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
				<span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>else</span>
				<span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	ui<span>.</span>benchmark<span>.</span>iterations<span>.</span><span>addEventListener</span><span>(</span><span>&#34;change&#34;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ui<span>.</span>benchmark<span>.</span>iterOut<span>.</span>value <span>=</span> event<span>.</span>target<span>.</span>value<span>;</span>
		ui<span>.</span>benchmark<span>.</span>label<span>.</span>textContent <span>=</span> <span>&#34;Benchmark&#34;</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>scene <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> circleAnimation<span>,</span> simpleTexture<span>,</span> <span>[</span><span>&#34;offset&#34;</span><span>,</span> <span>&#34;radius&#34;</span><span>]</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>bloom <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> bloomVert<span>,</span> bloomFrag<span>,</span> <span>[</span><span>&#34;texture&#34;</span><span>,</span> <span>&#34;textureAdd&#34;</span><span>,</span> <span>&#34;offset&#34;</span><span>,</span> <span>&#34;radius&#34;</span><span>]</span><span>)</span><span>;</span>

	
	<span>function</span> <span>reCompileBlurShader</span><span>(</span><span>blurSize</span><span>)</span> <span>{</span>
		ctx<span>.</span>shd<span>.</span>blur <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> simpleQuad<span>,</span> boxBlurFrag<span>,</span> <span>[</span><span>&#34;frameSizeRCP&#34;</span><span>,</span> <span>&#34;samplePosMult&#34;</span><span>,</span> <span>&#34;bloomStrength&#34;</span><span>]</span><span>,</span> <span>&#34;#define KERNEL_SIZE &#34;</span> <span>+</span> blurSize <span>+</span> <span>&#39;\n&#39;</span><span>)</span><span>;</span>
	<span>}</span>

	
	<span>reCompileBlurShader</span><span>(</span>ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value<span>)</span>

	
	util<span>.</span><span>bindUnitQuad</span><span>(</span>gl<span>)</span><span>;</span>

	<span>async</span> <span>function</span> <span>setupTextureBuffers</span><span>(</span><span>)</span> <span>{</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>buffersInitialized <span>=</span> <span>true</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>false</span><span>;</span>

		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>final<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>scene<span>,</span> ctx<span>.</span>tex<span>.</span>frame<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>final<span>,</span> ctx<span>.</span>tex<span>.</span>frameFinal<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>

		<span>let</span> <span>[</span>base<span>,</span> selfIllum<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>
			<span>fetch</span><span>(</span><span>&#34;/dual-kawase/img/SDR_No_Sprite.png&#34;</span><span>)</span><span>,</span>
			<span>fetch</span><span>(</span><span>&#34;/dual-kawase/img/Selfillumination.png&#34;</span><span>)</span>
		<span>]</span><span>)</span><span>;</span>
		<span>let</span> <span>[</span>baseBlob<span>,</span> selfIllumBlob<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>base<span>.</span><span>blob</span><span>(</span><span>)</span><span>,</span> selfIllum<span>.</span><span>blob</span><span>(</span><span>)</span><span>]</span><span>)</span><span>;</span>
		<span>let</span> <span>[</span>baseBitmap<span>,</span> selfIllumBitmap<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>
			<span>createImageBitmap</span><span>(</span>baseBlob<span>,</span> <span>{</span> <span>colorSpaceConversion</span><span>:</span> <span>&#39;none&#39;</span><span>,</span> <span>resizeWidth</span><span>:</span> canvas<span>.</span>width <span>*</span> <span>1.12</span><span>,</span> <span>resizeHeight</span><span>:</span> canvas<span>.</span>height <span>*</span> <span>1.12</span><span>,</span> <span>resizeQuality</span><span>:</span> <span>&#34;high&#34;</span> <span>}</span><span>)</span><span>,</span>
			<span>createImageBitmap</span><span>(</span>selfIllumBlob<span>,</span> <span>{</span> <span>colorSpaceConversion</span><span>:</span> <span>&#39;none&#39;</span><span>,</span> <span>resizeWidth</span><span>:</span> canvas<span>.</span>width <span>*</span> <span>1.12</span><span>,</span> <span>resizeHeight</span><span>:</span> canvas<span>.</span>height <span>*</span> <span>1.12</span><span>,</span> <span>resizeQuality</span><span>:</span> <span>&#34;high&#34;</span> <span>}</span><span>)</span>
		<span>]</span><span>)</span><span>;</span>

		ctx<span>.</span>tex<span>.</span>sdr <span>=</span> util<span>.</span><span>setupTexture</span><span>(</span>gl<span>,</span> <span>null</span><span>,</span> <span>null</span><span>,</span> ctx<span>.</span>tex<span>.</span>sdr<span>,</span> gl<span>.</span><span>LINEAR</span><span>,</span> baseBitmap<span>)</span><span>;</span>
		ctx<span>.</span>tex<span>.</span>selfIllum <span>=</span> util<span>.</span><span>setupTexture</span><span>(</span>gl<span>,</span> <span>null</span><span>,</span> <span>null</span><span>,</span> ctx<span>.</span>tex<span>.</span>selfIllum<span>,</span> gl<span>.</span><span>LINEAR</span><span>,</span> selfIllumBitmap<span>)</span><span>;</span>

		baseBitmap<span>.</span><span>close</span><span>(</span><span>)</span><span>;</span>
		selfIllumBitmap<span>.</span><span>close</span><span>(</span><span>)</span><span>;</span>

		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>true</span><span>;</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;none&#34;</span><span>;</span>
	<span>}</span>

	<span>let</span> prevNow <span>=</span> performance<span>.</span><span>now</span><span>(</span><span>)</span><span>;</span>
	<span>let</span> lastStatsUpdate <span>=</span> prevNow<span>;</span>
	<span>let</span> fpsEMA <span>=</span> <span>60</span><span>;</span>
	<span>let</span> msEMA <span>=</span> <span>16</span><span>;</span>

	<span>async</span> <span>function</span> <span>redraw</span><span>(</span><span>)</span> <span>{</span>
		<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>buffersInitialized<span>)</span>
			<span>await</span> <span>setupTextureBuffers</span><span>(</span><span>)</span><span>;</span>
		<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>initComplete<span>)</span>
			<span>return</span><span>;</span>

		
		<span>const</span> KernelSizeSide <span>=</span> ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>*</span> <span>2</span> <span>+</span> <span>1</span><span>;</span>
		<span>const</span> tapsNewText <span>=</span> <span>(</span>canvas<span>.</span>width <span>*</span> canvas<span>.</span>height <span>*</span> KernelSizeSide <span>*</span> KernelSizeSide <span>/</span> <span>1000000</span><span>)</span><span>.</span><span>toFixed</span><span>(</span><span>1</span><span>)</span> <span>+</span> <span>&#34; Million&#34;</span><span>;</span>
		ui<span>.</span>display<span>.</span>tapsCount<span>.</span>value <span>=</span> tapsNewText<span>;</span>
		ui<span>.</span>display<span>.</span>width<span>.</span>value <span>=</span> canvas<span>.</span>width<span>;</span>
		ui<span>.</span>display<span>.</span>height<span>.</span>value <span>=</span> canvas<span>.</span>height<span>;</span>

		
		<span>let</span> radiusSwitch <span>=</span> ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked <span>?</span> radius <span>:</span> <span>0.0</span><span>;</span>
		<span>let</span> speed <span>=</span> <span>(</span>performance<span>.</span><span>now</span><span>(</span><span>)</span> <span>/</span> <span>10000</span><span>)</span> <span>%</span> Math<span>.</span><span>PI</span> <span>*</span> <span>2</span><span>;</span>
		<span>const</span> offset <span>=</span> <span>[</span>radiusSwitch <span>*</span> Math<span>.</span><span>cos</span><span>(</span>speed<span>)</span><span>,</span> radiusSwitch <span>*</span> Math<span>.</span><span>sin</span><span>(</span>speed<span>)</span><span>]</span><span>;</span>
		gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>handle<span>)</span><span>;</span>
		<span>const</span> texture <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> ctx<span>.</span>tex<span>.</span>sdr <span>:</span> ctx<span>.</span>tex<span>.</span>selfIllum<span>;</span>
		gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
		gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> texture<span>)</span><span>;</span>
		gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>uniforms<span>.</span>offset<span>,</span> offset<span>)</span><span>;</span>
		gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>uniforms<span>.</span>radius<span>,</span> radiusSwitch<span>)</span><span>;</span>

		
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span>
		gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>

		
		gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>

		
		gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>handle<span>)</span><span>;</span>
		<span>const</span> finalFB <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;bloom&#34;</span> <span>?</span> ctx<span>.</span>fb<span>.</span>final <span>:</span> <span>null</span><span>;</span>
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> finalFB<span>)</span><span>;</span>
		gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
		gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>bloomStrength<span>,</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> <span>1.0</span> <span>:</span> ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>value<span>)</span><span>;</span>
		gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
		gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>frame<span>)</span><span>;</span>
		gl<span>.</span><span>uniform2f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>frameSizeRCP<span>,</span> <span>1.0</span> <span>/</span> canvas<span>.</span>width<span>,</span> <span>1.0</span> <span>/</span> canvas<span>.</span>height<span>)</span><span>;</span>
		gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>samplePosMult<span>,</span> ui<span>.</span>blur<span>.</span>samplePos<span>.</span>value<span>)</span><span>;</span>
		gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>

		<span>if</span> <span>(</span>ctx<span>.</span>mode <span>==</span> <span>&#34;bloom&#34;</span><span>)</span> <span>{</span>
			
			gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> <span>null</span><span>)</span><span>;</span>
			gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>handle<span>)</span><span>;</span>

			gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>offset<span>,</span> offset<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>radius<span>,</span> radiusSwitch<span>)</span><span>;</span>

			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>sdr<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1i</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>texture<span>,</span> <span>0</span><span>)</span><span>;</span>

			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE1</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>frameFinal<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1i</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>textureAdd<span>,</span> <span>1</span><span>)</span><span>;</span>

			gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
		<span>}</span>

		
		gl<span>.</span><span>finish</span><span>(</span><span>)</span><span>;</span>

		<span>const</span> now <span>=</span> performance<span>.</span><span>now</span><span>(</span><span>)</span><span>;</span>
		<span>let</span> dt <span>=</span> now <span>-</span> prevNow<span>;</span>

		<span>if</span> <span>(</span>dt <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
			<span>const</span> instFPS <span>=</span> <span>1000</span> <span>/</span> dt<span>;</span>
			<span>const</span> <span>ALPHA</span> <span>=</span> <span>0.05</span><span>;</span>
			fpsEMA <span>=</span> <span>ALPHA</span> <span>*</span> instFPS <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>ALPHA</span><span>)</span> <span>*</span> fpsEMA<span>;</span>
			msEMA <span>=</span> <span>ALPHA</span> <span>*</span> dt <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>ALPHA</span><span>)</span> <span>*</span> msEMA<span>;</span>
		<span>}</span>
		prevNow <span>=</span> now<span>;</span>

		<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked <span>&amp;&amp;</span> now <span>-</span> lastStatsUpdate <span>&gt;=</span> <span>1000</span><span>)</span> <span>{</span>
			ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> fpsEMA<span>.</span><span>toFixed</span><span>(</span><span>0</span><span>)</span><span>;</span>
			ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> msEMA<span>.</span><span>toFixed</span><span>(</span><span>2</span><span>)</span><span>;</span>
			lastStatsUpdate <span>=</span> now<span>;</span>
		<span>}</span>
	<span>}</span>

	<span>let</span> animationFrameId<span>;</span>

	
	<span>function</span> <span>nativeResize</span><span>(</span><span>)</span> <span>{</span>
		<span>const</span> <span>[</span>width<span>,</span> height<span>]</span> <span>=</span> util<span>.</span><span>getNativeSize</span><span>(</span>canvas<span>)</span><span>;</span>

		<span>if</span> <span>(</span>width <span>&amp;&amp;</span> canvas<span>.</span>width <span>!==</span> width <span>||</span> height <span>&amp;&amp;</span> canvas<span>.</span>height <span>!==</span> height<span>)</span> <span>{</span>
			canvas<span>.</span>width <span>=</span> width<span>;</span>
			canvas<span>.</span>height <span>=</span> height<span>;</span>

			<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>benchMode<span>)</span> <span>{</span>
				<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
				<span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
				<span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span>
	<span>}</span>

	
	<span>nativeResize</span><span>(</span><span>)</span><span>;</span>

	<span>let</span> resizePending <span>=</span> <span>false</span><span>;</span>
	window<span>.</span><span>addEventListener</span><span>(</span><span>&#39;resize&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>if</span> <span>(</span><span>!</span>resizePending<span>)</span> <span>{</span>
			resizePending <span>=</span> <span>true</span><span>;</span>
			<span>requestAnimationFrame</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
				resizePending <span>=</span> <span>false</span><span>;</span>
				<span>nativeResize</span><span>(</span><span>)</span><span>;</span>
			<span>}</span><span>)</span><span>;</span>
		<span>}</span>
	<span>}</span><span>)</span><span>;</span>

	<span>function</span> <span>renderLoop</span><span>(</span><span>)</span> <span>{</span>
		<span>if</span> <span>(</span>ctx<span>.</span>flags<span>.</span>isRendering <span>&amp;&amp;</span> ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>{</span>
			<span>redraw</span><span>(</span><span>)</span><span>;</span>
			animationFrameId <span>=</span> <span>requestAnimationFrame</span><span>(</span>renderLoop<span>)</span><span>;</span>
		<span>}</span>
	<span>}</span>

	<span>function</span> <span>startRendering</span><span>(</span><span>)</span> <span>{</span>
		
		ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>true</span><span>;</span>
		<span>renderLoop</span><span>(</span><span>)</span><span>;</span>
	<span>}</span>

	<span>function</span> <span>stopRendering</span><span>(</span><span>)</span> <span>{</span>
		
		ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>false</span><span>;</span>
		<span>cancelAnimationFrame</span><span>(</span>animationFrameId<span>)</span><span>;</span>
		
		gl<span>.</span><span>finish</span><span>(</span><span>)</span><span>;</span>

		
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>sdr<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>sdr <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>selfIllum<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>selfIllum <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>frame<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>frame <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>frameFinal<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>frameFinal <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>scene <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>final<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>final <span>=</span> <span>null</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>buffersInitialized <span>=</span> <span>false</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>false</span><span>;</span>
		ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
		ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
	<span>}</span>

	<span>function</span> <span>handleIntersection</span><span>(</span><span>entries</span><span>)</span> <span>{</span>
		entries<span>.</span><span>forEach</span><span>(</span><span>entry</span> <span>=&gt;</span> <span>{</span>
			<span>if</span> <span>(</span>entry<span>.</span>isIntersecting<span>)</span> <span>{</span>
				<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>isRendering <span>&amp;&amp;</span> <span>!</span>ctx<span>.</span>flags<span>.</span>benchMode<span>)</span> <span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span> <span>else</span> <span>{</span>
				<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span>

	
	<span>let</span> observer <span>=</span> <span>new</span> <span>IntersectionObserver</span><span>(</span>handleIntersection<span>)</span><span>;</span>
	observer<span>.</span><span>observe</span><span>(</span>canvas<span>)</span><span>;</span>
<span>}</span></code></pre></details></blockquote><p>Visually, the result doesn‚Äôt look very pleasing. The stronger the blur, the more ‚Äúboxy‚Äù features of the image become. This is due to us reading and averaging the texture in a square shape. Especially in bloom mode, with strong <code>lightBrightness</code> and big <code>kernelSize</code>, lights become literally squares.</p><p>Performance is also really bad. With bigger <code>kernelSizes</code>, our <code>Texture Taps</code> count skyrockets and performance drops. Mobile devices will come to a slog. Even the worlds fastest PC graphics cards will fall below screen refresh-rate by cranking <code>kernelSize</code> and zooming the article on PC, thus raising canvas resolution.</p><blockquote><p>We kinda failed on all fronts. It looks bad <strong>and</strong> runs bad.</p><img src="https://blog.frost.kiwi/assets/kiwis/facepalm.svg"/></blockquote><p>Then, there‚Äôs this <code>samplePosMultiplier</code>. It seems to <em>also</em> seemingly increase blur strength, <em>without</em> increasing textureTaps or lowering performance (or lowering performance just a little on certain devices). But if we crank <em>that</em> too much, we get artifacts in the form of repeating patterns. Let‚Äôs play with a schematic example:</p><ul><li>The white center square represents the output pixel</li><li>Grey squares are the pixels we would read, with the current <code>kernelSize</code>, with <code>samplePosMult</code> untouched</li><li>the black dots are our <em>actual</em> texture reads <em><strong>per-output-pixel</strong></em>, our ‚Äúsample‚Äù positions</li></ul><div id="SVGBox-kernelPreview"><svg></svg><table><tbody><tr><td colspan="4"><code>kernelSize</code></td></tr><tr><td><code>kernelSize</code></td><td></td><td><output>3√ó3</output></td><td></td></tr><tr><td colspan="4"><code>samplePosMult</code></td></tr><tr><td><code>samplePosMult</code></td><td></td><td><output>100</output>%</td><td></td></tr></tbody></table></div><p>On can say, that an image is a ‚Äúcontinous 2D signal‚Äù. When we texture tap at a specific coordinate, we are <em>sampling the ‚Äúimage signal‚Äù at that coordinate</em>. As previously mentioned, we use UV coordinates and are not bound by concepts like ‚Äúpixels position‚Äù. <em><strong>Where</strong></em> we place our samples is completely up to us.</p><p>A fundamental blur algorithm option is increasing the sample distance away from the center, thus increasing the amount of image we cover with our samples - more bang for your sample buck. This works by multiplying the offset distance. That is what <code>samplePosMult</code> does and is something you will have access to going forward.</p><p>Doing it too much, brings ugly repeating patterns. This of course leaves some fundamental questions, like where these artifacts come from and what it even means to read between two pixels. <em><strong>And</strong></em> on top of that we have to address performance and the boxyness of our blur! But first‚Ä¶</p><h2 id="what-even-is-a-kernel%3F" tabindex="-1">What even <em>is</em> a kernel? <a href="#what-even-is-a-kernel%3F">#</a></h2><p>What we have created with our for-loop, is a <a href="https://www.youtube.com/watch?v=KuXjwB4LzSA0" target="_blank">convolution</a>. Very simplified, in the context of image processing, it‚Äôs usually a square of numbers constructing an output pixel, by gathering and weighting pixels, that the square covers. The square is called a kernel and was the thing we visualized previously.</p><p>For blurs, the kernel weights must sum up to 1. If that were not the case, we would either brighten or darken the image. Ensuring that is the normalization step. In the box blur above, this happens by dividing the summed pixel color by <code>totalSamples</code>, the total amount of samples taken. A basic ‚Äúcalculate the average‚Äù expression.</p><p>The same can be expressed as weights of a kernel, a number multiplied with each sample at that position. Since the box blur weighs all sample the same regardless of position, all weights are the same. This is visualized next. The bigger the kernel size, the smaller the weights.</p><div id="SVGBox-kernelPreviewWithWeights"><svg></svg><table><tbody><tr><td colspan="4"><code>kernelSize</code></td></tr><tr><td><code>kernelSize</code></td><td></td><td><output>3√ó3</output></td><td></td></tr><tr><td colspan="4"><code>samplePosMult</code></td></tr><tr><td><code>samplePosMult</code></td><td></td><td><output>100</output>%</td><td></td></tr></tbody></table></div><p>Kernels applied at the edges of our image will read from areas ‚Äúoutside‚Äù the image, with UV coordinates smaller than <code>0,0</code> and bigger than <code>1,1</code>. Luckily, the GPU handles this for us and we are free to decide what happens to those outside samples, by setting the <a href="https://learnopengl.com/Getting-started/Textures#:~:text=Texture%20Wrapping" target="_blank">Texture Wrapping mode</a>.</p><figure><img src="https://blog.frost.kiwi/dual-kawase/img/WrappingModes.png" alt="Texture Wrapping Modes and results on blurring"/><figcaption>Texture Wrapping Modes and results on blurring (Note the color black bleeding-in)</figcaption></figure><p>Among others, we can define a solid color to be used, or to ‚Äúclamp‚Äù to the nearest edge‚Äôs color. If we choose a solid color, then we will get color bleeding at the edges. Thus for almost all post-processing use-cases, edge color clamping is used, as it prevents weird things happening at the edges. <a href="https://github.com/FrostKiwi/treasurechest/blob/main/posts/dual-kawase/js/utility.js#L49" target="_blank">This article does too</a>.</p><blockquote><p>You may have noticed a black &#34;blob&#34; streaking with stronger blur levels along the bottom. Specifically here, it happens because the lines between the floor tiles align with the bottom edge, extending black color to infinity</p><img src="https://blog.frost.kiwi/assets/kiwis/detective.svg"/></blockquote><p>Convolution as a mathematical concept is surprisingly deep and <a href="https://www.youtube.com/@3blue1brown" target="_blank">3blue1brown</a> has an excellent video on it, that even covers the image processing topic. Theoretically, we won‚Äôt depart from convolutions. We <em><strong>can</strong></em> dissect our code and express it as weights and kernels. With the for-loop box blur, that <em><strong>was</strong></em> quite easy!</p><figure><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="" frameborder="0" loading="lazy" src="https://www.youtube-nocookie.com/embed/KuXjwB4LzSA" title="YouTube video player" width="100%"></iframe><figcaption>But what is a convolution?</figcaption></figure><p>On a practical level though, understanding where the convolution is, how many there are and what kernels are at play will become more and more difficult, once we leave the realm of classical blurs and consider the wider implications of reading between pixel bounds. But for now, we stay with the classics:</p><h2 id="gaussian-blur" tabindex="-1">Gaussian Blur <a href="#gaussian-blur">#</a></h2><p>The most famous of blur algorithms is the Gaussian Blur. It uses the <a href="https://en.wikipedia.org/wiki/Normal_distribution" target="_blank">normal distribution</a>, also known as the <a href="https://en.wikipedia.org/wiki/Normal_distribution" target="_blank">bell Curve</a> to weight the samples inside the kernel, with a new variable <code>sigma œÉ</code> to control the flatness of the curve. Other than generating the kernel weights, the algorithm is identical to the box blur algorithm.</p><figure><svg viewBox="0 -1867.7 10104.3 2802.6" xmlns="http://www.w3.org/2000/svg" height="10rem" aria-labelledby="MathJax-SVG-1-Title" xmlns:xlink="http://www.w3.org/1999/xlink"><defs aria-hidden="true"><path d="M50 252q0 115 67 221t169 168 204 63q90 0 143-51 9-10 15-17t8-10l1-3q3 0 27 26 7 6 15 14t16 16 10 11l15 15h6q14 0 14-7 0-4-32-137-36-139-36-140-2-5-5-6t-18-2h-16q-6 6-6 9 0 1 1 7t2 20 1 32q0 71-32 124t-109 54q-18 0-39-3t-53-13-61-28-63-48-58-71-47-102-31-134q-2-18-2-39 0-48 14-85t36-57 50-34 52-17 45-4q54 0 99 23t62 59q3 8 15 55t12 53q0 8-13 10t-60 3h-37q-6 6-6 8t2 19q4 13 10 19h17q40-2 140-2h65q25 0 36 1t12 0q14 0 14-9 0-2-2-14-5-19-10-21-3-1-15-1-20 0-41-3-7-3-10-9t-14-51q-9-33-15-56Q589 6 586 3q-2-2-5-2-10 0-28 20t-23 31q0 1-2 0t-6-5q-74-69-200-69-121 0-196 77T50 252Z" id="gf-a" stroke-width="1"></path><path d="M94 250q0 69 10 131t23 107 37 88 38 67 42 52 33 34 25 21h17q14 0 14-9 0-3-17-21t-41-53-49-86-42-138-17-193 17-192 41-139 49-86 42-53 17-21q0-9-15-9h-16l-28 24q-94 85-137 212T94 250Z" id="gf-b" stroke-width="1"></path><path d="M52 289q7 42 54 97t116 56q35 0 64-18t43-45q42 63 101 63 37 0 64-22t28-59q0-29-14-47t-27-22-23-4q-19 0-31 11t-12 29q0 46 50 63-11 13-40 13-13 0-19-2-38-16-56-66-60-221-60-258 0-28 16-40t35-12q37 0 73 33t49 81q3 10 6 11t16 2h4q15 0 15-8 0-1-2-11-16-57-62-101T333-11q-70 0-106 63-41-62-94-62h-6q-49 0-70 26T35 71q0 32 19 52t45 20q43 0 43-42 0-20-12-35t-23-20-13-5l-3-1q0-1 6-4t16-7 19-3q36 0 62 45 9 16 23 68t28 108 16 66q5 27 5 39 0 28-15 40t-34 12q-40 0-75-32t-49-82q-2-9-5-10t-16-2H58q-6 6-6 11Z" id="gf-c" stroke-width="1"></path><path d="M78 35v25l16 43 43 18q28 0 50-25t23-88q0-35-9-68t-21-57-26-41-24-27-13-9q-4 0-13 9t-9 13q0 4 11 16t25 30 26 50 16 73V9l-1-1q-2-1-5-2t-6-3-9-2-12-1q-27 0-44 17Z" id="gf-d" stroke-width="1"></path><path d="M21 287q0 14 15 48t48 71 74 36q41 0 66-23t26-64q-2-19-3-21 0-3-16-46t-33-97-16-86q0-43 14-60t42-18q23 0 43 11t31 23 27 33q0 1 5 20t14 59 19 74q38 150 42 157 13 27 43 27 13 0 21-7t11-12 2-9q0-13-49-210T391-23q-28-83-97-132t-138-50q-45 0-79 22t-34 66q0 22 7 37t19 22 20 10 17 3q44 0 44-42 0-20-12-35t-23-20-13-5l-3-1q2-5 19-12t34-7h8q17 0 26 2 33 9 61 38t43 62 23 56 8 30l-6-4q-6-4-19-11T270-6q-20-5-39-5-46 0-81 22t-46 71q-1 7-1 31 0 57 35 149t35 117v14q0 3-4 7t-11 4h-4q-23 0-42-19t-30-41-17-42-8-22q-2-2-16-2H27q-6 6-6 9Z" id="gf-e" stroke-width="1"></path><path d="m60 749 4 1h22l28-24q94-85 137-212t43-264q0-68-10-131T261 12t-37-88-38-67-41-51-32-33-23-19l-4-4H63q-3 0-5 3t-3 9q1 1 11 13Q221-64 221 250T66 725q-10 12-11 13 0 8 5 11Z" id="gf-f" stroke-width="1"></path><path d="M56 347q0 13 14 20h637q15-8 15-20 0-11-14-19l-318-1H72q-16 5-16 20Zm0-194q0 15 16 20h636q14-10 14-20 0-13-15-20H70q-14 7-14 20Z" id="gf-g" stroke-width="1"></path><path d="m213 578-13-5q-14-5-40-10t-58-7H83v46h19q47 2 87 15t56 24 28 22q2 3 12 3 9 0 17-6V361l1-300q7-7 12-9t24-4 62-2h26V0h-11q-21 3-159 3-136 0-157-3H88v46h64q16 0 25 1t16 3 8 2 6 5 6 4v517Z" id="gf-h" stroke-width="1"></path><path d="M109 429q-27 0-43 18t-16 44q0 71 53 123t132 52q91 0 152-56t62-145q0-43-20-82t-48-68-80-74q-36-31-100-92l-59-56 76-1q157 0 167 5 7 2 24 89v3h40v-3q-1-3-13-91T421 3V0H50v31q0 7 6 15t30 35q29 32 50 56 9 10 34 37t34 37 29 33 28 34 23 30 21 32 15 29 13 32 7 30 3 33q0 63-34 109t-97 46q-33 0-58-17t-35-33-10-19q0-1 5-1 18 0 37-14t19-46q0-25-16-42t-45-18Z" id="gf-i" stroke-width="1"></path><path d="M132-11q-34 0-34 33v11l13 28q75 158 109 273l8 24h-32q-38 0-54-3t-39-19q-11-7-22-18t-19-21-9-12q-2-1-15-1-19 0-19 10 0 6 19 35t55 62 71 38q7 2 225 2 160 0 164-1 20-7 20-28 0-31-32-42-6-2-69-2h-64l-3-17q-12-72-12-119 0-52 9-93t19-64 10-28q0-17-14-32t-36-15q-11 0-18 3t-16 24-16 60q-1 9-1 44 0 49 9 105t18 92 10 40h-98l-1-4q0-3-19-79t-43-161-31-97q-11-28-43-28Z" id="gf-j" stroke-width="1"></path><path d="M184-11q-68 0-110 45T31 147q0 100 73 186t170 97q1 1 140 1h138q1-1 3-2t4-2 3-2 3-3 2-2 2-4 1-4 1-5 1-6q0-44-65-44h-17q-10 0-14 1h-60l5-10q18-38 18-85 0-110-80-192T184-11Zm177 289q0 80-85 80-124 0-161-174-1-4-1-6-8-37-8-61 0-50 25-70t57-21q54 0 99 47 29 30 47 80t22 80 5 45Z" id="gf-k" stroke-width="1"></path><path d="M39 168q0 57 19 104t49 78 67 52 70 31 63 9h3q45 0 78-22t33-65q0-90-111-118-49-13-134-14-37 0-38-2 0-2-6-35t-7-58q0-47 21-74t63-28 93 19 92 66q9 10 12 10 4 0 13-9t10-14-9-16-30-27-46-31-63-25-76-10q-79 0-122 53T39 168Zm334 185q-6 52-68 52-33 0-61-14t-45-34-29-41-16-36-5-19q0-1 20-1 113 0 158 24t46 69Z" id="gf-l" stroke-width="1"></path><path d="M84 237v13l14 20h581q15-8 15-20t-15-20H98q-14 7-14 20Z" id="gf-m" stroke-width="1"></path><path d="M56 237v13l14 20h299v150l1 150q10 13 19 13 13 0 20-15V270h298q15-8 15-20t-15-20H409V-68q-8-14-18-14h-4q-12 0-18 14v298H70q-14 7-14 20Z" id="gf-n" stroke-width="1"></path></defs><g transform="scale(1 -1)" aria-hidden="true" fill="currentColor" stroke="currentColor" stroke-width="0"><use xlink:href="#gf-a"></use><use xlink:href="#gf-b" x="786"></use><use xlink:href="#gf-c" x="1176"></use><use xlink:href="#gf-d" x="1748"></use><use xlink:href="#gf-e" x="2193"></use><use xlink:href="#gf-f" x="2691"></use><use xlink:href="#gf-g" x="3358"></use><g transform="translate(4534)"><path d="M0 220h2220v60H0z" stroke="none"></path><use xlink:href="#gf-h" x="860" y="676"></use><g transform="translate(60 -780)"><use xlink:href="#gf-i"></use><use xlink:href="#gf-j" x="500"></use><g transform="translate(1074)"><use xlink:href="#gf-k"></use><use xlink:href="#gf-i" x="810" y="408" transform="scale(.7)"></use></g></g></g><g transform="translate(6875)"><use xlink:href="#gf-l"></use><g transform="translate(466 681)"><use xlink:href="#gf-m" transform="scale(.7)"></use><path d="M670 146h1871v60H670z" stroke="none"></path><g transform="translate(730 489)"><use xlink:href="#gf-c" transform="scale(.6)"></use><use xlink:href="#gf-i" x="572" y="362" transform="scale(.6)"></use><use xlink:href="#gf-n" x="1173" transform="scale(.6)"></use><g transform="matrix(.6 0 0 .6 1120 0)"><use xlink:href="#gf-e"></use><use xlink:href="#gf-i" x="499" y="362"></use></g></g><g transform="translate(1125 -567)"><use xlink:href="#gf-i" transform="scale(.6)"></use><g transform="matrix(.6 0 0 .6 287 0)"><use xlink:href="#gf-k"></use><use xlink:href="#gf-i" x="572" y="288"></use></g></g></g></g></g></svg><figcaption>Gaussian blur weights formula for point <code>(x,y)</code> <a href="https://en.wikipedia.org/wiki/Gaussian_blur#Mathematics" target="_blank">(Source)</a></figcaption></figure><p>To calculate the weights for point <code>(x,y)</code>, the <a href="https://en.wikipedia.org/wiki/Gaussian_blur#Mathematics" target="_blank">above formula is used</a>. The gaussian formula has a weighting multiplier <code>1/‚àö(2œÄœÉ¬≤)</code>. In the code, there is no such thing though. The formula expresses the gaussian curve as a <em>continuous</em> function going to <em>infinity</em>. But our code and its for-loop are different - <em><strong>discrete</strong></em> and <em><strong>finite</strong></em>.</p><pre><code><span>float</span> <span>gaussianWeight</span><span>(</span><span>float</span> x<span>,</span> <span>float</span> y<span>,</span> <span>float</span> sigma<span>)</span>
<span>{</span>
	
	<span>return</span> <span>exp</span><span>(</span><span>-</span><span>(</span>x <span>*</span> x <span>+</span> y <span>*</span> y<span>)</span> <span>/</span> <span>(</span><span>2.0</span> <span>*</span> sigma <span>*</span> sigma<span>)</span><span>)</span><span>;</span>
<span>}</span></code></pre><blockquote><p>For clarity, the kernel is generated in the fragment shader. Normally, that should be avoided. Fragment shaders run per-output-pixel, but the kernel weights stay the same, making this inefficient.</p><img src="https://blog.frost.kiwi/assets/kiwis/teach.svg"/></blockquote><p>Just like with the box blur, weights are summed up and divided at the end, instead of the term <code>1/‚àö(2œÄœÉ¬≤)</code> precalculating weights. <code>sigma</code> controls the sharpness of the curve and thus the blur strength, but wasn‚Äôt that the job of <code>kernelSize</code>? Play around with all the values below and get a feel for how the various values behave.</p><div id="WebGLBox-GaussianBlur"><div><p><label> Scene</label> <label> Lights</label> <label> Bloom</label></p><p><label> Animate</label></p></div><div><canvas></canvas><p>‚ùå The browser killed this WebGL Context, please reload the page. If this happened as the result of a long benchmark, decrease the iteration count. On some platforms (iOS / iPad) you may have to restart the browser App completely, as the browser will temporarily refuse to allow this site to run WebGL again.</p><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" fill="transparent" r="10" stroke-width="2"></circle><rect height="7" rx="1" width="2" x="11" y="6"></rect><rect height="9" rx="1" width="2" x="11" y="11"></rect></svg></div><table><tbody><tr><td colspan="4"><p><span><strong>FPS:</strong><output id="fps">?</output>/<output id="ms">?</output>ms </span><span><strong>Resolution:</strong><output id="width">?</output>x<output id="height">?</output></span><span><strong>Texture Taps:</strong><output id="taps">?</output></span></p></td></tr><tr><td colspan="4"><code>kernelSize</code></td></tr><tr><td><code>kernelSize</code></td><td></td><td><output>7x7</output>¬†px</td><td></td></tr><tr><td colspan="4"><code>samplePosMultiplier</code></td></tr><tr><td><code>samplePosMultiplier</code></td><td></td><td><output>100</output>¬†%</td><td></td></tr><tr><td colspan="4"><code>lightBrightness</code></td></tr><tr><td><code>lightBrightness</code></td><td></td><td><output>100</output>¬†%</td><td></td></tr><tr><td colspan="4"><code>sigma</code></td></tr><tr><td><code>sigma</code></td><td></td><td>¬±<output>2.00</output>œÉ</td><td></td></tr></tbody></table></div><blockquote id="WebGLBox-GaussianBlurDetail"><details><summary>Blur Fragment Shader <a href="https://blog.frost.kiwi/dual-kawase/shader/gaussianBlur.fs" target="_blank">gaussianBlur.fs</a></summary><pre><code>
<span>precision</span> <span>highp</span> <span>float</span><span>;</span>

<span>varying</span> <span>vec2</span> uv<span>;</span>

<span>uniform</span> <span>vec2</span> frameSizeRCP<span>;</span> 
<span>uniform</span> <span>float</span> samplePosMult<span>;</span> 
<span>uniform</span> <span>float</span> sigma<span>;</span>

<span>uniform</span> <span>float</span> bloomStrength<span>;</span> 

<span>uniform</span> <span>sampler2D</span> texture<span>;</span>

<span>const</span> <span>int</span> kernel_size <span>=</span> KERNEL_SIZE<span>;</span>

<span>float</span> <span>gaussianWeight</span><span>(</span><span>float</span> x<span>,</span> <span>float</span> y<span>,</span> <span>float</span> sigma<span>)</span>
<span>{</span>
	
	<span>return</span> <span>exp</span><span>(</span><span>-</span><span>(</span>x <span>*</span> x <span>+</span> y <span>*</span> y<span>)</span> <span>/</span> <span>(</span><span>2.0</span> <span>*</span> sigma <span>*</span> sigma<span>)</span><span>)</span><span>;</span>
<span>}</span>

<span>void</span> <span>main</span><span>(</span><span>)</span> <span>{</span>
	
	<span>vec4</span> sum <span>=</span> <span>vec4</span><span>(</span><span>0.0</span><span>)</span><span>;</span>
	

	<span>float</span> weightSum <span>=</span> <span>0.0</span><span>;</span>
	
	<span>const</span> <span>int</span> size <span>=</span> <span>2</span> <span>*</span> kernel_size <span>+</span> <span>1</span><span>;</span>
	
	<span>const</span> <span>float</span> totalSamples <span>=</span> <span>float</span><span>(</span>size <span>*</span> size<span>)</span><span>;</span>

	
	<span>for</span> <span>(</span><span>int</span> y <span>=</span> <span>-</span>kernel_size<span>;</span> y <span>&lt;=</span> kernel_size<span>;</span> <span>++</span>y<span>)</span> <span>{</span>
	
		<span>for</span> <span>(</span><span>int</span> x <span>=</span> <span>-</span>kernel_size<span>;</span> x <span>&lt;=</span> kernel_size<span>;</span> <span>++</span>x<span>)</span> <span>{</span>

			
			<span>float</span> w <span>=</span> <span>gaussianWeight</span><span>(</span><span>float</span><span>(</span>x<span>)</span><span>,</span> <span>float</span><span>(</span>y<span>)</span><span>,</span> sigma<span>)</span><span>;</span>
			
			<span>vec2</span> offset  <span>=</span> <span>vec2</span><span>(</span>x<span>,</span> y<span>)</span> <span>*</span> samplePosMult <span>*</span> frameSizeRCP<span>;</span>

			
			sum <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> offset<span>)</span> <span>*</span> w<span>;</span>
			weightSum <span>+=</span> w<span>;</span>
		<span>}</span>
	<span>}</span>

	
	gl_FragColor <span>=</span> <span>(</span>sum <span>/</span> weightSum<span>)</span> <span>*</span> bloomStrength<span>;</span>
<span>}</span></code></pre></details><details><summary>WebGL Javascript <a href="https://blog.frost.kiwi/dual-kawase/js/blur/gaussianBlur.js" target="_blank">gaussianBlur.js</a></summary><pre><code><span>import</span> <span>*</span> <span>as</span> util <span>from</span> <span>&#39;../utility.js&#39;</span>

<span>export</span> <span>async</span> <span>function</span> <span>setupGaussianBlur</span><span>(</span><span>)</span> <span>{</span>
	
	<span>const</span> WebGLBox <span>=</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-GaussianBlur&#39;</span><span>)</span><span>;</span>
	<span>const</span> WebGLBoxDetail <span>=</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-GaussianBlurDetail&#39;</span><span>)</span><span>;</span>
	<span>const</span> canvas <span>=</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;canvas&#39;</span><span>)</span><span>;</span>

	
	<span>const</span> radius <span>=</span> <span>0.12</span><span>;</span>

	
	<span>const</span> gl <span>=</span> canvas<span>.</span><span>getContext</span><span>(</span><span>&#39;webgl&#39;</span><span>,</span> <span>{</span>
		<span>preserveDrawingBuffer</span><span>:</span> <span>false</span><span>,</span>
		<span>antialias</span><span>:</span> <span>false</span><span>,</span>
		<span>alpha</span><span>:</span> <span>false</span><span>,</span>
	<span>}</span><span>)</span><span>;</span>

	
	<span>const</span> ctx <span>=</span> <span>{</span>
		
		<span>mode</span><span>:</span> <span>&#34;scene&#34;</span><span>,</span>
		<span>flags</span><span>:</span> <span>{</span> <span>isRendering</span><span>:</span> <span>false</span><span>,</span> <span>buffersInitialized</span><span>:</span> <span>false</span><span>,</span> <span>initComplete</span><span>:</span> <span>false</span><span>,</span> <span>benchMode</span><span>:</span> <span>false</span> <span>}</span><span>,</span>
		
		<span>tex</span><span>:</span> <span>{</span> <span>sdr</span><span>:</span> <span>null</span><span>,</span> <span>selfIllum</span><span>:</span> <span>null</span><span>,</span> <span>frame</span><span>:</span> <span>null</span><span>,</span> <span>frameFinal</span><span>:</span> <span>null</span> <span>}</span><span>,</span>
		
		<span>fb</span><span>:</span> <span>{</span> <span>scene</span><span>:</span> <span>null</span><span>,</span> <span>final</span><span>:</span> <span>null</span> <span>}</span><span>,</span>
		
		<span>shd</span><span>:</span> <span>{</span>
			<span>scene</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>offset</span><span>:</span> <span>null</span><span>,</span> <span>radius</span><span>:</span> <span>null</span> <span>}</span> <span>}</span><span>,</span>
			<span>blur</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>frameSizeRCP</span><span>:</span> <span>null</span><span>,</span> <span>samplePosMult</span><span>:</span> <span>null</span><span>,</span> <span>sigma</span><span>:</span> <span>null</span><span>,</span> <span>bloomStrength</span><span>:</span> <span>null</span> <span>}</span> <span>}</span><span>,</span>
			<span>bloom</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>offset</span><span>:</span> <span>null</span><span>,</span> <span>radius</span><span>:</span> <span>null</span><span>,</span> <span>texture</span><span>:</span> <span>null</span><span>,</span> <span>textureAdd</span><span>:</span> <span>null</span> <span>}</span> <span>}</span>
		<span>}</span>
	<span>}</span><span>;</span>

	
	<span>const</span> ui <span>=</span> <span>{</span>
		<span>display</span><span>:</span> <span>{</span>
			<span>spinner</span><span>:</span> canvas<span>.</span>parentElement<span>.</span><span>querySelector</span><span>(</span><span>&#39;svg&#39;</span><span>,</span> canvas<span>.</span>parentElement<span>)</span><span>,</span>
			<span>contextLoss</span><span>:</span> canvas<span>.</span>parentElement<span>.</span><span>querySelector</span><span>(</span><span>&#39;div&#39;</span><span>,</span> canvas<span>.</span>parentElement<span>)</span><span>,</span>
			<span>fps</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#fps&#39;</span><span>)</span><span>,</span>
			<span>ms</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#ms&#39;</span><span>)</span><span>,</span>
			<span>width</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#width&#39;</span><span>)</span><span>,</span>
			<span>height</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#height&#39;</span><span>)</span><span>,</span>
			<span>tapsCount</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#taps&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>blur</span><span>:</span> <span>{</span>
			<span>kernelSize</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#sizeRange&#39;</span><span>)</span><span>,</span>
			<span>sigma</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#sigmaRange&#39;</span><span>)</span><span>,</span>
			<span>samplePos</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#samplePosRange&#39;</span><span>)</span><span>,</span>
			<span>samplePosReset</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#samplePosRangeReset&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>rendering</span><span>:</span> <span>{</span>
			<span>animate</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#animateCheck&#39;</span><span>)</span><span>,</span>
			<span>modes</span><span>:</span> WebGLBox<span>.</span><span>querySelectorAll</span><span>(</span><span>&#39;input[type=&#34;radio&#34;]&#39;</span><span>)</span><span>,</span>
			<span>lightBrightness</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#lightBrightness&#39;</span><span>)</span><span>,</span>
			<span>lightBrightnessReset</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#lightBrightnessReset&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>benchmark</span><span>:</span> <span>{</span>
			<span>button</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#benchmark&#39;</span><span>)</span><span>,</span>
			<span>label</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#benchmarkLabel&#39;</span><span>)</span><span>,</span>
			<span>iterOut</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterOut&#39;</span><span>)</span><span>,</span>
			<span>renderer</span><span>:</span> WebGLBoxDetail<span>.</span><span>querySelector</span><span>(</span><span>&#39;#renderer&#39;</span><span>)</span><span>,</span>
			<span>iterTime</span><span>:</span> WebGLBoxDetail<span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterTime&#39;</span><span>)</span><span>,</span>
			<span>tapsCount</span><span>:</span> WebGLBoxDetail<span>.</span><span>querySelector</span><span>(</span><span>&#39;#tapsCountBench&#39;</span><span>)</span><span>,</span>
			<span>iterations</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterations&#39;</span><span>)</span>
		<span>}</span>
	<span>}</span><span>;</span>

	
	<span>const</span> circleAnimation <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/circleAnimation.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> simpleTexture <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/simpleTexture.fs&#34;</span><span>)</span><span>;</span>
	<span>const</span> bloomVert <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/bloom.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> bloomFrag <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/bloom.fs&#34;</span><span>)</span><span>;</span>
	<span>const</span> simpleQuad <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/simpleQuad.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> gaussianBlurFrag <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/gaussianBlur.fs&#34;</span><span>)</span><span>;</span>

	
	ui<span>.</span>blur<span>.</span>kernelSize<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>
	ui<span>.</span>blur<span>.</span>sigma<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>
	ui<span>.</span>blur<span>.</span>samplePos<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>
	ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>animate<span>.</span><span>addEventListener</span><span>(</span><span>&#34;change&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
			<span>startRendering</span><span>(</span><span>)</span><span>;</span>
		<span>else</span> <span>{</span>
			ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
			ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
			ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>false</span><span>;</span>
			<span>redraw</span><span>(</span><span>)</span>
		<span>}</span>
	<span>}</span><span>)</span><span>;</span>

	canvas<span>.</span><span>addEventListener</span><span>(</span><span>&#34;webglcontextlost&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ui<span>.</span>display<span>.</span>contextLoss<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	ui<span>.</span>blur<span>.</span>kernelSize<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>reCompileBlurShader</span><span>(</span>ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value<span>)</span><span>;</span>
		ui<span>.</span>blur<span>.</span>samplePos<span>.</span>disabled <span>=</span> ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>==</span> <span>0</span><span>;</span>
		ui<span>.</span>blur<span>.</span>samplePosReset<span>.</span>disabled <span>=</span> ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>==</span> <span>0</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>modes<span>.</span><span>forEach</span><span>(</span><span>radio</span> <span>=&gt;</span> <span>{</span>
		
		<span>if</span> <span>(</span>radio<span>.</span>value <span>===</span> <span>&#34;scene&#34;</span><span>)</span>
			radio<span>.</span>checked <span>=</span> <span>true</span><span>;</span>
		radio<span>.</span><span>addEventListener</span><span>(</span><span>&#39;change&#39;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
			ctx<span>.</span>mode <span>=</span> event<span>.</span>target<span>.</span>value<span>;</span>
			ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>disabled <span>=</span> ctx<span>.</span>mode <span>===</span> <span>&#34;scene&#34;</span><span>;</span>
			ui<span>.</span>rendering<span>.</span>lightBrightnessReset<span>.</span>disabled <span>=</span> ctx<span>.</span>mode <span>===</span> <span>&#34;scene&#34;</span><span>;</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	ui<span>.</span>benchmark<span>.</span>button<span>.</span><span>addEventListener</span><span>(</span><span>&#34;click&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ctx<span>.</span>flags<span>.</span>benchMode <span>=</span> <span>true</span><span>;</span>
		<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
		ui<span>.</span>benchmark<span>.</span>button<span>.</span>disabled <span>=</span> <span>true</span><span>;</span>

		
		<span>const</span> worker <span>=</span> <span>new</span> <span>Worker</span><span>(</span><span>&#34;./js/benchmark/gaussianBlurBenchmark.js&#34;</span><span>,</span> <span>{</span> <span>type</span><span>:</span> <span>&#34;module&#34;</span> <span>}</span><span>)</span><span>;</span>

		
		worker<span>.</span><span>postMessage</span><span>(</span><span>{</span>
			<span>iterations</span><span>:</span> ui<span>.</span>benchmark<span>.</span>iterOut<span>.</span>value<span>,</span>
			<span>blurShaderSrc</span><span>:</span> gaussianBlurFrag<span>,</span>
			<span>kernelSize</span><span>:</span> ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value<span>,</span>
			<span>samplePos</span><span>:</span> ui<span>.</span>blur<span>.</span>samplePos<span>.</span>value<span>,</span>
			<span>sigma</span><span>:</span> ui<span>.</span>blur<span>.</span>sigma<span>.</span>value
		<span>}</span><span>)</span><span>;</span>

		
		worker<span>.</span><span>addEventListener</span><span>(</span><span>&#34;message&#34;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
			<span>if</span> <span>(</span>event<span>.</span>data<span>.</span>type <span>!==</span> <span>&#34;done&#34;</span><span>)</span> <span>return</span><span>;</span>

			ui<span>.</span>benchmark<span>.</span>label<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>benchText<span>;</span>
			ui<span>.</span>benchmark<span>.</span>tapsCount<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>tapsCount<span>;</span>
			ui<span>.</span>benchmark<span>.</span>iterTime<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>iterationText<span>;</span>
			ui<span>.</span>benchmark<span>.</span>renderer<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>renderer<span>;</span>

			worker<span>.</span><span>terminate</span><span>(</span><span>)</span><span>;</span>
			ui<span>.</span>benchmark<span>.</span>button<span>.</span>disabled <span>=</span> <span>false</span><span>;</span>
			ctx<span>.</span>flags<span>.</span>benchMode <span>=</span> <span>false</span><span>;</span>
			<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
				<span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>else</span>
				<span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	ui<span>.</span>benchmark<span>.</span>iterations<span>.</span><span>addEventListener</span><span>(</span><span>&#34;change&#34;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ui<span>.</span>benchmark<span>.</span>iterOut<span>.</span>value <span>=</span> event<span>.</span>target<span>.</span>value<span>;</span>
		ui<span>.</span>benchmark<span>.</span>label<span>.</span>textContent <span>=</span> <span>&#34;Benchmark&#34;</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>scene <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> circleAnimation<span>,</span> simpleTexture<span>,</span> <span>[</span><span>&#34;offset&#34;</span><span>,</span> <span>&#34;radius&#34;</span><span>]</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>bloom <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> bloomVert<span>,</span> bloomFrag<span>,</span> <span>[</span><span>&#34;texture&#34;</span><span>,</span> <span>&#34;textureAdd&#34;</span><span>,</span> <span>&#34;offset&#34;</span><span>,</span> <span>&#34;radius&#34;</span><span>]</span><span>)</span><span>;</span>


	
	<span>function</span> <span>reCompileBlurShader</span><span>(</span><span>blurSize</span><span>)</span> <span>{</span>
		ctx<span>.</span>shd<span>.</span>blur <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> simpleQuad<span>,</span> gaussianBlurFrag<span>,</span> <span>[</span><span>&#34;frameSizeRCP&#34;</span><span>,</span> <span>&#34;samplePosMult&#34;</span><span>,</span> <span>&#34;bloomStrength&#34;</span><span>,</span> <span>&#34;sigma&#34;</span><span>]</span><span>,</span> <span>&#34;#define KERNEL_SIZE &#34;</span> <span>+</span> blurSize <span>+</span> <span>&#39;\n&#39;</span><span>)</span><span>;</span>
	<span>}</span>

	
	<span>reCompileBlurShader</span><span>(</span>ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value<span>)</span>

	
	util<span>.</span><span>bindUnitQuad</span><span>(</span>gl<span>)</span><span>;</span>

	<span>async</span> <span>function</span> <span>setupTextureBuffers</span><span>(</span><span>)</span> <span>{</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>buffersInitialized <span>=</span> <span>true</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>false</span><span>;</span>

		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>final<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>scene<span>,</span> ctx<span>.</span>tex<span>.</span>frame<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>final<span>,</span> ctx<span>.</span>tex<span>.</span>frameFinal<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>


		<span>let</span> <span>[</span>base<span>,</span> selfIllum<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>
			<span>fetch</span><span>(</span><span>&#34;/dual-kawase/img/SDR_No_Sprite.png&#34;</span><span>)</span><span>,</span>
			<span>fetch</span><span>(</span><span>&#34;/dual-kawase/img/Selfillumination.png&#34;</span><span>)</span>
		<span>]</span><span>)</span><span>;</span>
		<span>let</span> <span>[</span>baseBlob<span>,</span> selfIllumBlob<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>base<span>.</span><span>blob</span><span>(</span><span>)</span><span>,</span> selfIllum<span>.</span><span>blob</span><span>(</span><span>)</span><span>]</span><span>)</span><span>;</span>
		<span>let</span> <span>[</span>baseBitmap<span>,</span> selfIllumBitmap<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>
			<span>createImageBitmap</span><span>(</span>baseBlob<span>,</span> <span>{</span> <span>colorSpaceConversion</span><span>:</span> <span>&#39;none&#39;</span><span>,</span> <span>resizeWidth</span><span>:</span> canvas<span>.</span>width <span>*</span> <span>1.12</span><span>,</span> <span>resizeHeight</span><span>:</span> canvas<span>.</span>height <span>*</span> <span>1.12</span><span>,</span> <span>resizeQuality</span><span>:</span> <span>&#34;high&#34;</span> <span>}</span><span>)</span><span>,</span>
			<span>createImageBitmap</span><span>(</span>selfIllumBlob<span>,</span> <span>{</span> <span>colorSpaceConversion</span><span>:</span> <span>&#39;none&#39;</span><span>,</span> <span>resizeWidth</span><span>:</span> canvas<span>.</span>width <span>*</span> <span>1.12</span><span>,</span> <span>resizeHeight</span><span>:</span> canvas<span>.</span>height <span>*</span> <span>1.12</span><span>,</span> <span>resizeQuality</span><span>:</span> <span>&#34;high&#34;</span> <span>}</span><span>)</span>
		<span>]</span><span>)</span><span>;</span>

		ctx<span>.</span>tex<span>.</span>sdr <span>=</span> util<span>.</span><span>setupTexture</span><span>(</span>gl<span>,</span> <span>null</span><span>,</span> <span>null</span><span>,</span> ctx<span>.</span>tex<span>.</span>sdr<span>,</span> gl<span>.</span><span>LINEAR</span><span>,</span> baseBitmap<span>)</span><span>;</span>
		ctx<span>.</span>tex<span>.</span>selfIllum <span>=</span> util<span>.</span><span>setupTexture</span><span>(</span>gl<span>,</span> <span>null</span><span>,</span> <span>null</span><span>,</span> ctx<span>.</span>tex<span>.</span>selfIllum<span>,</span> gl<span>.</span><span>LINEAR</span><span>,</span> selfIllumBitmap<span>)</span><span>;</span>

		baseBitmap<span>.</span><span>close</span><span>(</span><span>)</span><span>;</span>
		selfIllumBitmap<span>.</span><span>close</span><span>(</span><span>)</span><span>;</span>

		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>true</span><span>;</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;none&#34;</span><span>;</span>
	<span>}</span>

	<span>let</span> prevNow <span>=</span> performance<span>.</span><span>now</span><span>(</span><span>)</span><span>;</span>
	<span>let</span> lastStatsUpdate <span>=</span> prevNow<span>;</span>
	<span>let</span> fpsEMA <span>=</span> <span>60</span><span>;</span>
	<span>let</span> msEMA <span>=</span> <span>16</span><span>;</span>

	<span>async</span> <span>function</span> <span>redraw</span><span>(</span><span>)</span> <span>{</span>
		<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>buffersInitialized<span>)</span>
			<span>await</span> <span>setupTextureBuffers</span><span>(</span><span>)</span><span>;</span>
		<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>initComplete<span>)</span>
			<span>return</span><span>;</span>

		
		<span>const</span> KernelSizeSide <span>=</span> ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>*</span> <span>2</span> <span>+</span> <span>1</span><span>;</span>
		<span>const</span> tapsNewText <span>=</span> <span>(</span>canvas<span>.</span>width <span>*</span> canvas<span>.</span>height <span>*</span> KernelSizeSide <span>*</span> KernelSizeSide <span>/</span> <span>1000000</span><span>)</span><span>.</span><span>toFixed</span><span>(</span><span>1</span><span>)</span> <span>+</span> <span>&#34; Million&#34;</span><span>;</span>
		ui<span>.</span>display<span>.</span>tapsCount<span>.</span>value <span>=</span> tapsNewText<span>;</span>
		ui<span>.</span>display<span>.</span>width<span>.</span>value <span>=</span> canvas<span>.</span>width<span>;</span>
		ui<span>.</span>display<span>.</span>height<span>.</span>value <span>=</span> canvas<span>.</span>height<span>;</span>

		
		<span>let</span> radiusSwitch <span>=</span> ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked <span>?</span> radius <span>:</span> <span>0.0</span><span>;</span>
		<span>let</span> speed <span>=</span> <span>(</span>performance<span>.</span><span>now</span><span>(</span><span>)</span> <span>/</span> <span>10000</span><span>)</span> <span>%</span> Math<span>.</span><span>PI</span> <span>*</span> <span>2</span><span>;</span>
		<span>const</span> offset <span>=</span> <span>[</span>radiusSwitch <span>*</span> Math<span>.</span><span>cos</span><span>(</span>speed<span>)</span><span>,</span> radiusSwitch <span>*</span> Math<span>.</span><span>sin</span><span>(</span>speed<span>)</span><span>]</span><span>;</span>
		gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>handle<span>)</span><span>;</span>
		<span>const</span> texture <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> ctx<span>.</span>tex<span>.</span>sdr <span>:</span> ctx<span>.</span>tex<span>.</span>selfIllum<span>;</span>
		gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
		gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> texture<span>)</span><span>;</span>
		gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>uniforms<span>.</span>offset<span>,</span> offset<span>)</span><span>;</span>
		gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>uniforms<span>.</span>radius<span>,</span> radiusSwitch<span>)</span><span>;</span>

		
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span>
		gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>

		
		gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>

		
		gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>handle<span>)</span><span>;</span>
		<span>const</span> finalFB <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;bloom&#34;</span> <span>?</span> ctx<span>.</span>fb<span>.</span>final <span>:</span> <span>null</span><span>;</span>
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> finalFB<span>)</span><span>;</span>
		gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
		gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>bloomStrength<span>,</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> <span>1.0</span> <span>:</span> ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>value<span>)</span><span>;</span>
		gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
		gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>frame<span>)</span><span>;</span>
		gl<span>.</span><span>uniform2f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>frameSizeRCP<span>,</span> <span>1.0</span> <span>/</span> canvas<span>.</span>width<span>,</span> <span>1.0</span> <span>/</span> canvas<span>.</span>height<span>)</span><span>;</span>
		gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>samplePosMult<span>,</span> ui<span>.</span>blur<span>.</span>samplePos<span>.</span>value<span>)</span><span>;</span>
		gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>sigma<span>,</span> Math<span>.</span><span>max</span><span>(</span>ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>/</span> ui<span>.</span>blur<span>.</span>sigma<span>.</span>value<span>,</span> <span>0.001</span><span>)</span><span>)</span><span>;</span>
		gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>

		<span>if</span> <span>(</span>ctx<span>.</span>mode <span>==</span> <span>&#34;bloom&#34;</span><span>)</span> <span>{</span>
			
			gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> <span>null</span><span>)</span><span>;</span>
			gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>handle<span>)</span><span>;</span>

			gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>offset<span>,</span> offset<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>radius<span>,</span> radiusSwitch<span>)</span><span>;</span>

			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>sdr<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1i</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>texture<span>,</span> <span>0</span><span>)</span><span>;</span>

			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE1</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>frameFinal<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1i</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>textureAdd<span>,</span> <span>1</span><span>)</span><span>;</span>

			gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
		<span>}</span>

		
		gl<span>.</span><span>finish</span><span>(</span><span>)</span><span>;</span>

		<span>const</span> now <span>=</span> performance<span>.</span><span>now</span><span>(</span><span>)</span><span>;</span>
		<span>let</span> dt <span>=</span> now <span>-</span> prevNow<span>;</span>

		<span>if</span> <span>(</span>dt <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
			<span>const</span> instFPS <span>=</span> <span>1000</span> <span>/</span> dt<span>;</span>
			<span>const</span> <span>ALPHA</span> <span>=</span> <span>0.05</span><span>;</span>
			fpsEMA <span>=</span> <span>ALPHA</span> <span>*</span> instFPS <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>ALPHA</span><span>)</span> <span>*</span> fpsEMA<span>;</span>
			msEMA <span>=</span> <span>ALPHA</span> <span>*</span> dt <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>ALPHA</span><span>)</span> <span>*</span> msEMA<span>;</span>
		<span>}</span>
		prevNow <span>=</span> now<span>;</span>

		<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked <span>&amp;&amp;</span> now <span>-</span> lastStatsUpdate <span>&gt;=</span> <span>1000</span><span>)</span> <span>{</span>
			ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> fpsEMA<span>.</span><span>toFixed</span><span>(</span><span>0</span><span>)</span><span>;</span>
			ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> msEMA<span>.</span><span>toFixed</span><span>(</span><span>2</span><span>)</span><span>;</span>
			lastStatsUpdate <span>=</span> now<span>;</span>
		<span>}</span>
	<span>}</span>

	<span>let</span> animationFrameId<span>;</span>

	
	<span>function</span> <span>nativeResize</span><span>(</span><span>)</span> <span>{</span>
		<span>const</span> <span>[</span>width<span>,</span> height<span>]</span> <span>=</span> util<span>.</span><span>getNativeSize</span><span>(</span>canvas<span>)</span><span>;</span>

		<span>if</span> <span>(</span>width <span>&amp;&amp;</span> canvas<span>.</span>width <span>!==</span> width <span>||</span> height <span>&amp;&amp;</span> canvas<span>.</span>height <span>!==</span> height<span>)</span> <span>{</span>
			canvas<span>.</span>width <span>=</span> width<span>;</span>
			canvas<span>.</span>height <span>=</span> height<span>;</span>

			<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>benchMode<span>)</span> <span>{</span>
				<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
				<span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
				<span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span>
	<span>}</span>

	
	<span>nativeResize</span><span>(</span><span>)</span><span>;</span>

	<span>let</span> resizePending <span>=</span> <span>false</span><span>;</span>
	window<span>.</span><span>addEventListener</span><span>(</span><span>&#39;resize&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>if</span> <span>(</span><span>!</span>resizePending<span>)</span> <span>{</span>
			resizePending <span>=</span> <span>true</span><span>;</span>
			<span>requestAnimationFrame</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
				resizePending <span>=</span> <span>false</span><span>;</span>
				<span>nativeResize</span><span>(</span><span>)</span><span>;</span>
			<span>}</span><span>)</span><span>;</span>
		<span>}</span>
	<span>}</span><span>)</span><span>;</span>

	<span>function</span> <span>renderLoop</span><span>(</span><span>)</span> <span>{</span>
		<span>if</span> <span>(</span>ctx<span>.</span>flags<span>.</span>isRendering <span>&amp;&amp;</span> ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>{</span>
			<span>redraw</span><span>(</span><span>)</span><span>;</span>
			animationFrameId <span>=</span> <span>requestAnimationFrame</span><span>(</span>renderLoop<span>)</span><span>;</span>
		<span>}</span>
	<span>}</span>

	<span>function</span> <span>startRendering</span><span>(</span><span>)</span> <span>{</span>
		
		ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>true</span><span>;</span>
		<span>renderLoop</span><span>(</span><span>)</span><span>;</span>
	<span>}</span>

	<span>function</span> <span>stopRendering</span><span>(</span><span>)</span> <span>{</span>
		
		ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>false</span><span>;</span>
		<span>cancelAnimationFrame</span><span>(</span>animationFrameId<span>)</span><span>;</span>
		
		gl<span>.</span><span>finish</span><span>(</span><span>)</span><span>;</span>

		
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>sdr<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>sdr <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>selfIllum<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>selfIllum <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>frame<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>frame <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>frameFinal<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>frameFinal <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>scene <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>final<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>final <span>=</span> <span>null</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>buffersInitialized <span>=</span> <span>false</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>false</span><span>;</span>
		ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
		ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
	<span>}</span>

	<span>function</span> <span>handleIntersection</span><span>(</span><span>entries</span><span>)</span> <span>{</span>
		entries<span>.</span><span>forEach</span><span>(</span><span>entry</span> <span>=&gt;</span> <span>{</span>
			<span>if</span> <span>(</span>entry<span>.</span>isIntersecting<span>)</span> <span>{</span>
				<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>isRendering <span>&amp;&amp;</span> <span>!</span>ctx<span>.</span>flags<span>.</span>benchMode<span>)</span> <span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span> <span>else</span> <span>{</span>
				<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span>

	
	<span>let</span> observer <span>=</span> <span>new</span> <span>IntersectionObserver</span><span>(</span>handleIntersection<span>)</span><span>;</span>
	observer<span>.</span><span>observe</span><span>(</span>canvas<span>)</span><span>;</span>
<span>}</span></code></pre></details></blockquote><p>The blur looks way smoother than our previous box blur, with things generally taking on a ‚Äúrounder‚Äù appearance, due to the bell curve‚Äôs smooth signal response. That is, unless you move the <code>sigma</code> slider down. If you move <code>sigma</code> too low, you will get our previous box blur like artifacts again.</p><p>Let‚Äôs clear up what the values actually represent and how they interact. The following visualization shows the kernel with its weights expressed as height in an <a href="https://en.wikipedia.org/wiki/Isometric_projection" target="_blank"><s>Isometric</s></a> <a href="https://en.wikipedia.org/wiki/Axonometric_projection#Three_types" target="_blank">Dimetric</a> perspective projection. There are two different interaction modes with <code>sigma</code> when changing <code>kernelSize</code> and two ways to express <code>sigma</code>.</p><div id="SVGBox-kernelIsometric"><svg id="kernelIso"></svg><p><label> Absolute Sigma</label> <label> Relative Sigma</label></p><table><tbody><tr><td colspan="5"><code>kernelSize</code></td></tr><tr><td><code>kernelSize</code></td><td></td><td><output id="svgKernelIsoSize">7√ó7</output></td><td></td></tr><tr><td colspan="5"><code>sigma</code></td></tr><tr><td><code>sigma</code></td><td> </td><td><span><span>¬±<output id="sigmaIsoRelativeOut">3.00</output>œÉ </span><span><output id="sigmaIsoOut">1.00</output>px</span></span></td><td></td></tr></tbody></table></div><p><code>sigma</code> describes the flatness of our mathematical curve, a curve going to infinity. But our algorithm has a limited <code>kernelSize</code>. Where the kernel stops, no more pixel contributions occur, leading to box-blur-like artifacts due to the cut-off. In the context of image processing, there are two ways to setup a gaussian blur‚Ä¶</p><blockquote><p>A small sigma, thus a flat bell curve, paired with a small kernel size effectively <strong>is</strong> a box blur, with the weights making the kernel box-shaped.</p><img src="https://blog.frost.kiwi/assets/kiwis/think.svg"/></blockquote><p>‚Ä¶ way 1: <a href="https://www.youtube.com/watch?v=ueNY30Cs8Lk" target="_blank">Absolute Sigma</a>. <code>sigma</code> is an absolute value in pixels independent of <code>kernelSize</code>, with <code>kernelSize</code> acting as a ‚Äúwindow into the curve‚Äù or way 2: <code>sigma</code> is expressed <em><strong>relative</strong></em> to the current <code>kernelSize</code>. For practical reasons (finicky sliders) the relative to <code>kernelSize</code> mode is used everywhere.</p><p>Eitherway, the infinite gaussian curve <em><strong>will</strong></em> have a cut-off <em>somewhere</em>. <code>sigma</code> too small? - We get box blur like artifacts. <code>sigma</code> too big? - We waste blur efficiency, as the same perceived blur strength requires bigger kernels, thus bigger for-loops with lower performance. An artistic trade-off every piece of software has to make.</p><blockquote><p>An optimal kernel would be one, where the outer weights are almost zero. Thus, if we increased <code>kernelSize</code> in Absolute Sigma mode by one, it would make close to no more <strong>visual</strong> difference.</p><img src="https://blog.frost.kiwi/assets/kiwis/teach.svg"/></blockquote><p>There are other ways of creating blur kernels, with other properties. One way is to follow <a href="https://en.wikipedia.org/wiki/Pascal%27s_triangle" target="_blank">Pascal‚Äôs triangle</a> to get a set of predefined kernel sizes and weights. These are called <a href="https://bartwronski.com/2021/10/31/practical-gaussian-filter-binomial-filter-and-small-sigma-gaussians/" target="_blank">Binomial Filters</a> and lock us into specific ‚Äúkernel presets‚Äù, but solve the infinity vs cut-off dilemma, by moving weights to zero within the sampling window.</p><p>Binomial Kernels are also Gaussian-like in their frequency response. We won‚Äôt expand on these further, just know that we <em><strong>can</strong></em> choose kernels by different mathematical criteria, chasing different signal response characteristics. But speaking of which, what even <em>is</em> Gaussian Like? Why do we care?</p><h3 id="what-is-gaussian-like%3F" tabindex="-1">What is Gaussian-like? <a href="#what-is-gaussian-like%3F">#</a></h3><p>In Post-Processing Blur algorithms you generally find two categories. <a href="https://en.wikipedia.org/wiki/Bokeh" target="_blank">Bokeh</a> Blurs and Gaussian-Like Blurs. The gaussian is chosen for its natural appearance, its ability to smooth colors without ‚Äústandout features‚Äù. Gaussian Blurs are generally used as an ingredient in an overarching visual effect, be it frosted glass Interfaces or Bloom.</p><figure><img src="https://blog.frost.kiwi/dual-kawase/img/gaussianLike.png" alt="Bokeh blur, gaussian blur comparison"/><figcaption>Bokeh Blur and Gaussian Blur compared.</figcaption></figure><p>In contrast to that, when emulating lenses and or creating <a href="https://dev.epicgames.com/documentation/en-us/unreal-engine/depth-of-field-in-unreal-engine" target="_blank">Depth of Field</a>, is ‚Äú<a href="https://dev.epicgames.com/documentation/en-us/unreal-engine/cinematic-depth-of-field-method?application_version=4.27" target="_blank">Bokeh Blur</a>‚Äù - also known as ‚ÄúLens Blur‚Äù or ‚ÄúCinematic Blur‚Äù. This type of blur <em><strong>is</strong></em> the target visual effect. The challenges and approaches are very much related, but algorithms used differ.</p><p>Algorithms get really creative in this space, all with different trade-offs and visuals. Some sample using a <a href="https://mynameismjp.wordpress.com/2011/02/28/bokeh/" target="_blank">poission disk distribution</a> and some have cool out of the box thinking: Computerphile covered a comlex numbers based approach to creating Bokeh Blurs, a fascinating number theory cross-over.</p><figure><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="" frameborder="0" loading="lazy" src="https://www.youtube-nocookie.com/embed/vNG3ZAd8wCc" title="YouTube video player" width="100%"></iframe><figcaption>Video Game &amp; Complex Bokeh Blurs</figcaption></figure><p>This article though doesn‚Äôt care about these stylistics approaches. We are here to chase a basic building block of graphics programming and realtime visual effects, a ‚ÄúGaussian-Like‚Äù with good performance. Speaking of which!</p><h2 id="performance" tabindex="-1">Performance <a href="#performance">#</a></h2><p>The main motivator of our journey here, is the chase of realtime performance. Everything we do must happen within few milliseconds. The expected performance of an algorithm and the practical cost once placed in the graphics pipeline, are sometimes surprisingly different numbers though. Gotta measure!</p><blockquote><p>This chapter is about a very <strong>technical</strong> motivation. If you don&#39;t care about how fast a GPU does what it does, feel free to skip this section.</p><img src="https://blog.frost.kiwi/assets/kiwis/happy.svg"/></blockquote><p>With performance being such a driving motivator, it would be a shame if we couldn‚Äôt measure it in this article. Each WebGL Box has a benchmark function, which blurs random noise at a fixed resolution of <code>1600x1200</code> with the respective blur settings you chose and a fixed iteration count workload, a feature hidden so far.</p><blockquote><p>Realtime graphics programming is sometimes more about measuring than programming.</p><img src="https://blog.frost.kiwi/assets/kiwis/laugh.svg"/></blockquote><p>Benchmarking is best done by measuring shader execution time. This <a href="https://registry.khronos.org/webgl/extensions/EXT_disjoint_timer_query_webgl2/" target="_blank">can be done</a> in the browser reliably, but only on some platforms. No way exists to do so across all platforms. Luckily, there is the classic method of ‚Äústalling the graphics pipeline‚Äù, forcing a wait until all commands finish, a moment in time we can measure.</p><blockquote><p>Across all platforms a stall is guaranteed to occur on command <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/readPixels" target="_blank"><code>gl.readPixels()</code></a>. Interestingly, the standards conform command for this: <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/finish" target="_blank"><code>gl.finish()</code></a> is simply ignored by mobile apple devices.</p><img src="https://blog.frost.kiwi/assets/kiwis/book.svg"/></blockquote><p>Below is a button, that unlocks this benchmarking feature, unhiding a benchmark button and <code>Detailed Benchmark Results</code> section under each blur. This allows you to start a benchmark with a preset workload, on a separate <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers" target="_blank">Browser Worker</a>. There is only one issue: Browsers get <em><strong>very</strong></em> angry if you full-load the GPU this way.</p><p>If the graphics pipeline is doing work without reporting back (called ‚Äúyielding‚Äù) to the browser for too long, browsers will simply kill all GPU access for the whole page, until tab reload. If we yield back, then the measured results are useless and from inside WebGL, we can‚Äôt stop the GPU, once its commands are issued.</p><blockquote>‚ö†Ô∏è Especially on mobile: <strong>please</strong> increase <code>kernelSize</code> and iterations slowly. The previous algorithms have bad <code>kernelSize</code> performance scaling on purpose, be especially careful with them.</blockquote><blockquote><p>iOS and iPad OS are <strong>especially</strong> strict, will keep GPU access disabled, even on Tab Reload. You will have go to the App Switcher (Double Tap Home Button), Swipe Safari Up to close it and relaunch it from scratch.</p><img src="https://blog.frost.kiwi/assets/kiwis/miffed.svg"/></blockquote><h3 id="what-are-we-optimizing-for%3F" tabindex="-1">What are we optimizing for? <a href="#what-are-we-optimizing-for%3F">#</a></h3><p>With the <a href="#box-blur">above Box Blur</a> and <a href="#gaussian-blur">above Gaussian Blur</a>, you will measure performance scaling very badly with <code>kernelSize</code>. Expressed in the <a href="https://en.wikipedia.org/wiki/Big_O_notation" target="_blank">Big O notation</a>, it has a performance scaling of <code>O(pixelCount * kernelSize¬≤)</code>. Quadratic scaling of required texture taps in terms of <code>kernelSize</code>. We need to tackle this going forward.</p><blockquote><p>Especially dedicated Laptop GPUs are slow to get out of their lower power states. Pressing the benchmark button multiple times in a row may result in the performance numbers getting better.</p><img src="https://blog.frost.kiwi/assets/kiwis/detective.svg"/></blockquote><p>Despite the gaussian blur calculating the kernel <a href="https://github.com/FrostKiwi/treasurechest/blob/main/posts/dual-kawase/shader/gaussianBlur.fs#L18" target="_blank">completely from scratch on every single pixel in our implementation</a>, the performance of the box blur and gaussian blur are very close to each other at higher iteration counts. In fact, by precalculating the those kernels we could performance match both.</p><blockquote><p>But isn&#39;t gaussian blur a more complicated algorithm?</p><img src="https://blog.frost.kiwi/assets/kiwis/think.svg"/></blockquote><p>As opposed to chips from decades ago, modern graphics cards have very fast arithmetic, but comparatively slow memory access times. With workloads like these, the slowest thing becomes the memory access, in our case the texture taps. The more taps, the slower the algorithm.</p><blockquote><p>Our blurs perform a <strong>dependant texture read</strong>, a graphics programming sin. This is when texture coordinates are determined <strong>during</strong> shader execution, which opts out of a many automated shader optimizations.</p><img src="https://blog.frost.kiwi/assets/kiwis/teach.svg"/></blockquote><p>Especially on personal computers, you may also have noticed that increasing <code>samplePosMultiplier</code> will negatively impact performance (up to a point), even though the required texture taps stay the same.</p><p>This is due hardware texture caches accelerating texture reads which are spatially close together and not being able to do so effectively, if the texture reads are all too far apart. Platform dependant tools like <a href="https://developer.nvidia.com/blog/identifying-shader-limiters-with-the-shader-profiler-in-nvidia-nsight-graphics/" target="_blank">Nvidia NSight</a> can measure GPU cache utilization. The browser cannot.</p><p>These are key numbers graphics programmers chase when writing fragment shaders: <strong>Texture Taps</strong> and <strong>Cache Utilization</strong>. There is another one, we will get into in a moment. Clearly, our Blurs are <em><strong>slow</strong></em>. Time for a speed up!</p><h2 id="separable-gaussian-blur" tabindex="-1">Separable Gaussian Blur <a href="#separable-gaussian-blur">#</a></h2><p>We have not yet left the <em>classics</em> of blur algorithms. One fundamental concept left on the table is ‚Äúconvolution separability‚Äù. Certain Convolutions like our <a href="#box-blur">Box Blur</a>, <a href="#gaussian-blur">our Gaussian Blur</a> and the <a href="https://bartwronski.com/2021/10/31/practical-gaussian-filter-binomial-filter-and-small-sigma-gaussians/" target="_blank">Binominal filtering</a> mentioned in passing previously can all be performed in two separate passes, by two <em><strong>separate</strong></em> 1D Kernels.</p><figure><svg viewBox="0 -1796 9254.8 3017.9" xmlns="http://www.w3.org/2000/svg" height="10rem" aria-labelledby="MathJax-SVG-1-Title" xmlns:xlink="http://www.w3.org/1999/xlink"><defs aria-hidden="true"><path d="M50 252q0 115 67 221t169 168 204 63q90 0 143-51 9-10 15-17t8-10l1-3q3 0 27 26 7 6 15 14t16 16 10 11l15 15h6q14 0 14-7 0-4-32-137-36-139-36-140-2-5-5-6t-18-2h-16q-6 6-6 9 0 1 1 7t2 20 1 32q0 71-32 124t-109 54q-18 0-39-3t-53-13-61-28-63-48-58-71-47-102-31-134q-2-18-2-39 0-48 14-85t36-57 50-34 52-17 45-4q54 0 99 23t62 59q3 8 15 55t12 53q0 8-13 10t-60 3h-37q-6 6-6 8t2 19q4 13 10 19h17q40-2 140-2h65q25 0 36 1t12 0q14 0 14-9 0-2-2-14-5-19-10-21-3-1-15-1-20 0-41-3-7-3-10-9t-14-51q-9-33-15-56Q589 6 586 3q-2-2-5-2-10 0-28 20t-23 31q0 1-2 0t-6-5q-74-69-200-69-121 0-196 77T50 252Z" id="gfx-a" stroke-width="1"></path><path d="M52 289q7 42 54 97t116 56q35 0 64-18t43-45q42 63 101 63 37 0 64-22t28-59q0-29-14-47t-27-22-23-4q-19 0-31 11t-12 29q0 46 50 63-11 13-40 13-13 0-19-2-38-16-56-66-60-221-60-258 0-28 16-40t35-12q37 0 73 33t49 81q3 10 6 11t16 2h4q15 0 15-8 0-1-2-11-16-57-62-101T333-11q-70 0-106 63-41-62-94-62h-6q-49 0-70 26T35 71q0 32 19 52t45 20q43 0 43-42 0-20-12-35t-23-20-13-5l-3-1q0-1 6-4t16-7 19-3q36 0 62 45 9 16 23 68t28 108 16 66q5 27 5 39 0 28-15 40t-34 12q-40 0-75-32t-49-82q-2-9-5-10t-16-2H58q-6 6-6 11Z" id="gfx-b" stroke-width="1"></path><path d="M94 250q0 69 10 131t23 107 37 88 38 67 42 52 33 34 25 21h17q14 0 14-9 0-3-17-21t-41-53-49-86-42-138-17-193 17-192 41-139 49-86 42-53 17-21q0-9-15-9h-16l-28 24q-94 85-137 212T94 250Z" id="gfx-c" stroke-width="1"></path><path d="m60 749 4 1h22l28-24q94-85 137-212t43-264q0-68-10-131T261 12t-37-88-38-67-41-51-32-33-23-19l-4-4H63q-3 0-5 3t-3 9q1 1 11 13Q221-64 221 250T66 725q-10 12-11 13 0 8 5 11Z" id="gfx-d" stroke-width="1"></path><path d="M56 347q0 13 14 20h637q15-8 15-20 0-11-14-19l-318-1H72q-16 5-16 20Zm0-194q0 15 16 20h636q14-10 14-20 0-13-15-20H70q-14 7-14 20Z" id="gfx-e" stroke-width="1"></path><path d="m213 578-13-5q-14-5-40-10t-58-7H83v46h19q47 2 87 15t56 24 28 22q2 3 12 3 9 0 17-6V361l1-300q7-7 12-9t24-4 62-2h26V0h-11q-21 3-159 3-136 0-157-3H88v46h64q16 0 25 1t16 3 8 2 6 5 6 4v517Z" id="gfx-f" stroke-width="1"></path><path d="M109 429q-27 0-43 18t-16 44q0 71 53 123t132 52q91 0 152-56t62-145q0-43-20-82t-48-68-80-74q-36-31-100-92l-59-56 76-1q157 0 167 5 7 2 24 89v3h40v-3q-1-3-13-91T421 3V0H50v31q0 7 6 15t30 35q29 32 50 56 9 10 34 37t34 37 29 33 28 34 23 30 21 32 15 29 13 32 7 30 3 33q0 63-34 109t-97 46q-33 0-58-17t-35-33-10-19q0-1 5-1 18 0 37-14t19-46q0-25-16-42t-45-18Z" id="gfx-h" stroke-width="1"></path><path d="M132-11q-34 0-34 33v11l13 28q75 158 109 273l8 24h-32q-38 0-54-3t-39-19q-11-7-22-18t-19-21-9-12q-2-1-15-1-19 0-19 10 0 6 19 35t55 62 71 38q7 2 225 2 160 0 164-1 20-7 20-28 0-31-32-42-6-2-69-2h-64l-3-17q-12-72-12-119 0-52 9-93t19-64 10-28q0-17-14-32t-36-15q-11 0-18 3t-16 24-16 60q-1 9-1 44 0 49 9 105t18 92 10 40h-98l-1-4q0-3-19-79t-43-161-31-97q-11-28-43-28Z" id="gfx-i" stroke-width="1"></path><path d="M95 178q-6 0-14 8t-9 14 31 30 66 50 38 29q2 2 5 2h1q6 0 14-17t54-117q19-43 31-69l85-185q1 0 104 213t206 429 107 221q6 14 20 14 7 0 12-6t7-12v-6L620 293 385-193q-4-7-19-7-9 0-12 3-2 2-98 212l-96 210-16-11q-15-12-31-24t-18-12Z" id="gfx-g" stroke-width="1"></path><path d="M184-11q-68 0-110 45T31 147q0 100 73 186t170 97q1 1 140 1h138q1-1 3-2t4-2 3-2 3-3 2-2 2-4 1-4 1-5 1-6q0-44-65-44h-17q-10 0-14 1h-60l5-10q18-38 18-85 0-110-80-192T184-11Zm177 289q0 80-85 80-124 0-161-174-1-4-1-6-8-37-8-61 0-50 25-70t57-21q54 0 99 47 29 30 47 80t22 80 5 45Z" id="gfx-j" stroke-width="1"></path><path d="M39 168q0 57 19 104t49 78 67 52 70 31 63 9h3q45 0 78-22t33-65q0-90-111-118-49-13-134-14-37 0-38-2 0-2-6-35t-7-58q0-47 21-74t63-28 93 19 92 66q9 10 12 10 4 0 13-9t10-14-9-16-30-27-46-31-63-25-76-10q-79 0-122 53T39 168Zm334 185q-6 52-68 52-33 0-61-14t-45-34-29-41-16-36-5-19q0-1 20-1 113 0 158 24t46 69Z" id="gfx-k" stroke-width="1"></path><path d="M84 237v13l14 20h581q15-8 15-20t-15-20H98q-14 7-14 20Z" id="gfx-l" stroke-width="1"></path></defs><g transform="scale(1 -1)" aria-hidden="true" fill="currentColor" stroke="currentColor" stroke-width="0"><use xlink:href="#gfx-a"></use><use xlink:href="#gfx-b" x="1112" y="-213" transform="scale(.7)"></use><use xlink:href="#gfx-c" x="1291"></use><use xlink:href="#gfx-b" x="1680"></use><use xlink:href="#gfx-d" x="2253"></use><use xlink:href="#gfx-e" x="2920"></use><g transform="translate(4096)"><path d="M0 220h2600v60H0z" stroke="none"></path><use xlink:href="#gfx-f" x="1049" y="676"></use><g transform="translate(60 -915)"><use xlink:href="#gfx-g" y="33"></use><path d="M833 774h1074v60H833z" stroke="none"></path><g transform="translate(833)"><use xlink:href="#gfx-h"></use><use xlink:href="#gfx-i" x="500"></use></g><use xlink:href="#gfx-j" x="1907"></use></g></g><g transform="translate(6816)"><use xlink:href="#gfx-k"></use><g transform="translate(466 681)"><use xlink:href="#gfx-l" transform="scale(.7)"></use><path d="M670 146h1080v60H670z" stroke="none"></path><g transform="matrix(.6 0 0 .6 873 378)"><use xlink:href="#gfx-b"></use><use xlink:href="#gfx-h" x="572" y="362"></use></g><g transform="translate(730 -567)"><use xlink:href="#gfx-h" transform="scale(.6)"></use><g transform="matrix(.6 0 0 .6 287 0)"><use xlink:href="#gfx-j"></use><use xlink:href="#gfx-h" x="572" y="288"></use></g></g></g></g></g></svg> <svg viewBox="0 -1867.7 9126.8 3089.6" xmlns="http://www.w3.org/2000/svg" height="10rem" aria-labelledby="MathJax-SVG-1-Title" xmlns:xlink="http://www.w3.org/1999/xlink"><defs aria-hidden="true"><path d="M50 252q0 115 67 221t169 168 204 63q90 0 143-51 9-10 15-17t8-10l1-3q3 0 27 26 7 6 15 14t16 16 10 11l15 15h6q14 0 14-7 0-4-32-137-36-139-36-140-2-5-5-6t-18-2h-16q-6 6-6 9 0 1 1 7t2 20 1 32q0 71-32 124t-109 54q-18 0-39-3t-53-13-61-28-63-48-58-71-47-102-31-134q-2-18-2-39 0-48 14-85t36-57 50-34 52-17 45-4q54 0 99 23t62 59q3 8 15 55t12 53q0 8-13 10t-60 3h-37q-6 6-6 8t2 19q4 13 10 19h17q40-2 140-2h65q25 0 36 1t12 0q14 0 14-9 0-2-2-14-5-19-10-21-3-1-15-1-20 0-41-3-7-3-10-9t-14-51q-9-33-15-56Q589 6 586 3q-2-2-5-2-10 0-28 20t-23 31q0 1-2 0t-6-5q-74-69-200-69-121 0-196 77T50 252Z" id="gfy-a" stroke-width="1"></path><path d="M21 287q0 14 15 48t48 71 74 36q41 0 66-23t26-64q-2-19-3-21 0-3-16-46t-33-97-16-86q0-43 14-60t42-18q23 0 43 11t31 23 27 33q0 1 5 20t14 59 19 74q38 150 42 157 13 27 43 27 13 0 21-7t11-12 2-9q0-13-49-210T391-23q-28-83-97-132t-138-50q-45 0-79 22t-34 66q0 22 7 37t19 22 20 10 17 3q44 0 44-42 0-20-12-35t-23-20-13-5l-3-1q2-5 19-12t34-7h8q17 0 26 2 33 9 61 38t43 62 23 56 8 30l-6-4q-6-4-19-11T270-6q-20-5-39-5-46 0-81 22t-46 71q-1 7-1 31 0 57 35 149t35 117v14q0 3-4 7t-11 4h-4q-23 0-42-19t-30-41-17-42-8-22q-2-2-16-2H27q-6 6-6 9Z" id="gfy-b" stroke-width="1"></path><path d="M94 250q0 69 10 131t23 107 37 88 38 67 42 52 33 34 25 21h17q14 0 14-9 0-3-17-21t-41-53-49-86-42-138-17-193 17-192 41-139 49-86 42-53 17-21q0-9-15-9h-16l-28 24q-94 85-137 212T94 250Z" id="gfy-c" stroke-width="1"></path><path d="m60 749 4 1h22l28-24q94-85 137-212t43-264q0-68-10-131T261 12t-37-88-38-67-41-51-32-33-23-19l-4-4H63q-3 0-5 3t-3 9q1 1 11 13Q221-64 221 250T66 725q-10 12-11 13 0 8 5 11Z" id="gfy-d" stroke-width="1"></path><path d="M56 347q0 13 14 20h637q15-8 15-20 0-11-14-19l-318-1H72q-16 5-16 20Zm0-194q0 15 16 20h636q14-10 14-20 0-13-15-20H70q-14 7-14 20Z" id="gfy-e" stroke-width="1"></path><path d="m213 578-13-5q-14-5-40-10t-58-7H83v46h19q47 2 87 15t56 24 28 22q2 3 12 3 9 0 17-6V361l1-300q7-7 12-9t24-4 62-2h26V0h-11q-21 3-159 3-136 0-157-3H88v46h64q16 0 25 1t16 3 8 2 6 5 6 4v517Z" id="gfy-f" stroke-width="1"></path><path d="M109 429q-27 0-43 18t-16 44q0 71 53 123t132 52q91 0 152-56t62-145q0-43-20-82t-48-68-80-74q-36-31-100-92l-59-56 76-1q157 0 167 5 7 2 24 89v3h40v-3q-1-3-13-91T421 3V0H50v31q0 7 6 15t30 35q29 32 50 56 9 10 34 37t34 37 29 33 28 34 23 30 21 32 15 29 13 32 7 30 3 33q0 63-34 109t-97 46q-33 0-58-17t-35-33-10-19q0-1 5-1 18 0 37-14t19-46q0-25-16-42t-45-18Z" id="gfy-h" stroke-width="1"></path><path d="M132-11q-34 0-34 33v11l13 28q75 158 109 273l8 24h-32q-38 0-54-3t-39-19q-11-7-22-18t-19-21-9-12q-2-1-15-1-19 0-19 10 0 6 19 35t55 62 71 38q7 2 225 2 160 0 164-1 20-7 20-28 0-31-32-42-6-2-69-2h-64l-3-17q-12-72-12-119 0-52 9-93t19-64 10-28q0-17-14-32t-36-15q-11 0-18 3t-16 24-16 60q-1 9-1 44 0 49 9 105t18 92 10 40h-98l-1-4q0-3-19-79t-43-161-31-97q-11-28-43-28Z" id="gfy-i" stroke-width="1"></path><path d="M95 178q-6 0-14 8t-9 14 31 30 66 50 38 29q2 2 5 2h1q6 0 14-17t54-117q19-43 31-69l85-185q1 0 104 213t206 429 107 221q6 14 20 14 7 0 12-6t7-12v-6L620 293 385-193q-4-7-19-7-9 0-12 3-2 2-98 212l-96 210-16-11q-15-12-31-24t-18-12Z" id="gfy-g" stroke-width="1"></path><path d="M184-11q-68 0-110 45T31 147q0 100 73 186t170 97q1 1 140 1h138q1-1 3-2t4-2 3-2 3-3 2-2 2-4 1-4 1-5 1-6q0-44-65-44h-17q-10 0-14 1h-60l5-10q18-38 18-85 0-110-80-192T184-11Zm177 289q0 80-85 80-124 0-161-174-1-4-1-6-8-37-8-61 0-50 25-70t57-21q54 0 99 47 29 30 47 80t22 80 5 45Z" id="gfy-j" stroke-width="1"></path><path d="M39 168q0 57 19 104t49 78 67 52 70 31 63 9h3q45 0 78-22t33-65q0-90-111-118-49-13-134-14-37 0-38-2 0-2-6-35t-7-58q0-47 21-74t63-28 93 19 92 66q9 10 12 10 4 0 13-9t10-14-9-16-30-27-46-31-63-25-76-10q-79 0-122 53T39 168Zm334 185q-6 52-68 52-33 0-61-14t-45-34-29-41-16-36-5-19q0-1 20-1 113 0 158 24t46 69Z" id="gfy-k" stroke-width="1"></path><path d="M84 237v13l14 20h581q15-8 15-20t-15-20H98q-14 7-14 20Z" id="gfy-l" stroke-width="1"></path></defs><g transform="scale(1 -1)" aria-hidden="true" fill="currentColor" stroke="currentColor" stroke-width="0"><use xlink:href="#gfy-a"></use><use xlink:href="#gfy-b" x="1112" y="-213" transform="scale(.7)"></use><use xlink:href="#gfy-c" x="1238"></use><use xlink:href="#gfy-b" x="1627"></use><use xlink:href="#gfy-d" x="2125"></use><use xlink:href="#gfy-e" x="2792"></use><g transform="translate(3968)"><path d="M0 220h2600v60H0z" stroke="none"></path><use xlink:href="#gfy-f" x="1049" y="676"></use><g transform="translate(60 -915)"><use xlink:href="#gfy-g" y="33"></use><path d="M833 774h1074v60H833z" stroke="none"></path><g transform="translate(833)"><use xlink:href="#gfy-h"></use><use xlink:href="#gfy-i" x="500"></use></g><use xlink:href="#gfy-j" x="1907"></use></g></g><g transform="translate(6688)"><use xlink:href="#gfy-k"></use><g transform="translate(466 681)"><use xlink:href="#gfy-l" transform="scale(.7)"></use><path d="M670 146h1080v60H670z" stroke="none"></path><g transform="matrix(.6 0 0 .6 894 489)"><use xlink:href="#gfy-b"></use><use xlink:href="#gfy-h" x="499" y="362"></use></g><g transform="translate(730 -567)"><use xlink:href="#gfy-h" transform="scale(.6)"></use><g transform="matrix(.6 0 0 .6 287 0)"><use xlink:href="#gfy-j"></use><use xlink:href="#gfy-h" x="572" y="288"></use></g></g></g></g></g></svg><figcaption>Gaussian blur weights formula for, separated</figcaption></figure><p>Not all convolutions are separable. In the context of graphics programming: If you can express the kernel weights as a formula with axes <code>X, Y</code> and factor-out both <code>X</code> and <code>Y</code> into two separate formulas, then you have gained separability of a 2D kernel and can perform the convolution in two passes, massively saving on texture taps.</p><blockquote><p>Some big budget video games have used effects with kernels that are <strong>not</strong> separable, but did it anyway in two passes + 1D Kernel for the performance gain, with the resulting artifacts being deemed not too bad.</p><img src="https://blog.frost.kiwi/assets/kiwis/detective.svg"/></blockquote><p>Computerphile covered the concept of separability in the context of 2D image processing really well, if you are interested in a more formal explanation.</p><figure><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="" frameborder="0" loading="lazy" src="https://www.youtube-nocookie.com/embed/SiJpkucGa1o" title="YouTube video player" width="100%"></iframe><figcaption>Separable Filters and a Bauble</figcaption></figure><p>Here is our Gaussian Blur, but expressed as a separable Version. You can see just Pass 1 and Pass 2 in isolation or see the final result. Same visual quality as our Gaussian Blur, same dials, but massively faster, with no more quadratic scaling of required texture taps.</p><div id="WebGLBox-GaussianSeparableBlur"><div><p><label> Scene</label> <label> Lights</label> <label> Bloom</label></p><p><label> Animate</label></p></div><div><canvas></canvas><p>‚ùå The browser killed this WebGL Context, please reload the page. If this happened as the result of a long benchmark, decrease the iteration count. On some platforms (iOS / iPad) you may have to restart the browser App completely, as the browser will temporarily refuse to allow this site to run WebGL again.</p><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" fill="transparent" r="10" stroke-width="2"></circle><rect height="7" rx="1" width="2" x="11" y="6"></rect><rect height="9" rx="1" width="2" x="11" y="11"></rect></svg></div><p><label> Pass 1</label> <label> Pass 2</label> <label> Both</label></p><table><tbody><tr><td colspan="4"><p><span><strong>FPS:</strong><output id="fps">?</output>/<output id="ms">?</output>ms </span><span><strong>Resolution:</strong><output id="width">?</output>x<output id="height">?</output></span><span><strong>Texture Taps:</strong><output id="taps">?</output></span></p></td></tr><tr><td colspan="4"><code>kernelSize</code></td></tr><tr><td><code>kernelSize</code></td><td></td><td><output>7x7</output>¬†px</td><td></td></tr><tr><td colspan="4"><code>samplePosMultiplier</code></td></tr><tr><td><code>samplePosMultiplier</code></td><td></td><td><output>100</output>¬†%</td><td></td></tr><tr><td colspan="4"><code>lightBrightness</code></td></tr><tr><td><code>lightBrightness</code></td><td></td><td><output>100</output>¬†%</td><td></td></tr><tr><td colspan="4"><code>sigma</code></td></tr><tr><td><code>sigma</code></td><td></td><td>¬±<output>2.00</output>œÉ</td><td></td></tr></tbody></table></div><blockquote id="WebGLBox-GaussianSeparableBlurDetail"><details><summary>Blur Fragment Shader <a href="https://blog.frost.kiwi/dual-kawase/shader/gaussianBlurSeparable.fs" target="_blank">gaussianBlurSeparable.fs</a></summary><pre><code>
<span>precision</span> <span>highp</span> <span>float</span><span>;</span>

<span>varying</span> <span>vec2</span> uv<span>;</span>

<span>uniform</span> <span>vec2</span> frameSizeRCP<span>;</span> 
<span>uniform</span> <span>float</span> samplePosMult<span>;</span> 
<span>uniform</span> <span>float</span> sigma<span>;</span>
<span>uniform</span> <span>vec2</span> direction<span>;</span> 

<span>uniform</span> <span>float</span> bloomStrength<span>;</span> 

<span>uniform</span> <span>sampler2D</span> texture<span>;</span>

<span>const</span> <span>int</span> kernel_size <span>=</span> KERNEL_SIZE<span>;</span>

<span>float</span> <span>gaussianWeight</span><span>(</span><span>float</span> x<span>,</span> <span>float</span> sigma<span>)</span>
<span>{</span>
	
	<span>return</span> <span>exp</span><span>(</span><span>-</span><span>(</span>x <span>*</span> x<span>)</span> <span>/</span> <span>(</span><span>2.0</span> <span>*</span> sigma <span>*</span> sigma<span>)</span><span>)</span><span>;</span>
<span>}</span>

<span>void</span> <span>main</span><span>(</span><span>)</span> <span>{</span>
	
	<span>vec4</span> sum <span>=</span> <span>vec4</span><span>(</span><span>0.0</span><span>)</span><span>;</span>
	
	<span>float</span> weightSum <span>=</span> <span>0.0</span><span>;</span>
	
	
	<span>const</span> <span>int</span> size <span>=</span> <span>2</span> <span>*</span> kernel_size <span>+</span> <span>1</span><span>;</span>

	
	<span>for</span> <span>(</span><span>int</span> i <span>=</span> <span>-</span>kernel_size<span>;</span> i <span>&lt;=</span> kernel_size<span>;</span> <span>++</span>i<span>)</span> <span>{</span>
		
		<span>float</span> w <span>=</span> <span>gaussianWeight</span><span>(</span><span>float</span><span>(</span>i<span>)</span><span>,</span> sigma<span>)</span><span>;</span>
		
		
		<span>vec2</span> offset <span>=</span> <span>vec2</span><span>(</span>i<span>)</span> <span>*</span> direction <span>*</span> samplePosMult <span>*</span> frameSizeRCP<span>;</span>

		
		sum <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> offset<span>)</span> <span>*</span> w<span>;</span>
		weightSum <span>+=</span> w<span>;</span>
	<span>}</span>

	
	gl_FragColor <span>=</span> <span>(</span>sum <span>/</span> weightSum<span>)</span> <span>*</span> bloomStrength<span>;</span>
<span>}</span></code></pre></details><details><summary>WebGL Javascript <a href="https://blog.frost.kiwi/dual-kawase/js/blur/gaussianSeparableBlur.js" target="_blank">gaussianSeparableBlur.js</a></summary><pre><code><span>import</span> <span>*</span> <span>as</span> util <span>from</span> <span>&#39;../utility.js&#39;</span>

<span>export</span> <span>async</span> <span>function</span> <span>setupGaussianSeparableBlur</span><span>(</span><span>)</span> <span>{</span>
	
	<span>const</span> WebGLBox <span>=</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-GaussianSeparableBlur&#39;</span><span>)</span><span>;</span>
	<span>const</span> canvas <span>=</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;canvas&#39;</span><span>)</span><span>;</span>

	
	<span>const</span> radius <span>=</span> <span>0.12</span><span>;</span>

	
	<span>const</span> gl <span>=</span> canvas<span>.</span><span>getContext</span><span>(</span><span>&#39;webgl&#39;</span><span>,</span> <span>{</span>
		<span>preserveDrawingBuffer</span><span>:</span> <span>false</span><span>,</span>
		<span>antialias</span><span>:</span> <span>false</span><span>,</span>
		<span>alpha</span><span>:</span> <span>false</span><span>,</span>
	<span>}</span><span>)</span><span>;</span>

	
	<span>const</span> ctx <span>=</span> <span>{</span>
		
		<span>mode</span><span>:</span> <span>&#34;scene&#34;</span><span>,</span>
		<span>passMode</span><span>:</span> <span>&#34;pass1&#34;</span><span>,</span>
		<span>flags</span><span>:</span> <span>{</span> <span>isRendering</span><span>:</span> <span>false</span><span>,</span> <span>buffersInitialized</span><span>:</span> <span>false</span><span>,</span> <span>initComplete</span><span>:</span> <span>false</span><span>,</span> <span>benchMode</span><span>:</span> <span>false</span> <span>}</span><span>,</span>
		
		<span>tex</span><span>:</span> <span>{</span> <span>sdr</span><span>:</span> <span>null</span><span>,</span> <span>selfIllum</span><span>:</span> <span>null</span><span>,</span> <span>frame</span><span>:</span> <span>null</span><span>,</span> <span>frameIntermediate</span><span>:</span> <span>null</span><span>,</span> <span>frameFinal</span><span>:</span> <span>null</span> <span>}</span><span>,</span>
		
		<span>fb</span><span>:</span> <span>{</span> <span>scene</span><span>:</span> <span>null</span><span>,</span> <span>intermediate</span><span>:</span> <span>null</span><span>,</span> <span>final</span><span>:</span> <span>null</span> <span>}</span><span>,</span>
		
		<span>shd</span><span>:</span> <span>{</span>
			<span>scene</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>offset</span><span>:</span> <span>null</span><span>,</span> <span>radius</span><span>:</span> <span>null</span> <span>}</span> <span>}</span><span>,</span>
			<span>blur</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>frameSizeRCP</span><span>:</span> <span>null</span><span>,</span> <span>samplePosMult</span><span>:</span> <span>null</span><span>,</span> <span>sigma</span><span>:</span> <span>null</span><span>,</span> <span>bloomStrength</span><span>:</span> <span>null</span><span>,</span> <span>direction</span><span>:</span> <span>null</span> <span>}</span> <span>}</span><span>,</span>
			<span>bloom</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>offset</span><span>:</span> <span>null</span><span>,</span> <span>radius</span><span>:</span> <span>null</span><span>,</span> <span>texture</span><span>:</span> <span>null</span><span>,</span> <span>textureAdd</span><span>:</span> <span>null</span> <span>}</span> <span>}</span>
		<span>}</span>
	<span>}</span><span>;</span>

	
	<span>const</span> ui <span>=</span> <span>{</span>
		<span>display</span><span>:</span> <span>{</span>
			<span>spinner</span><span>:</span> canvas<span>.</span>parentElement<span>.</span><span>querySelector</span><span>(</span><span>&#39;svg&#39;</span><span>,</span> canvas<span>.</span>parentElement<span>)</span><span>,</span>
			<span>contextLoss</span><span>:</span> canvas<span>.</span>parentElement<span>.</span><span>querySelector</span><span>(</span><span>&#39;div&#39;</span><span>,</span> canvas<span>.</span>parentElement<span>)</span><span>,</span>
			<span>fps</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#fps&#39;</span><span>)</span><span>,</span>
			<span>ms</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#ms&#39;</span><span>)</span><span>,</span>
			<span>width</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#width&#39;</span><span>)</span><span>,</span>
			<span>height</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#height&#39;</span><span>)</span><span>,</span>
			<span>tapsCount</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#taps&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>blur</span><span>:</span> <span>{</span>
			<span>kernelSize</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#sizeRange&#39;</span><span>)</span><span>,</span>
			<span>sigma</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#sigmaRange&#39;</span><span>)</span><span>,</span>
			<span>samplePos</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#samplePosRange&#39;</span><span>)</span><span>,</span>
			<span>samplePosReset</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#samplePosRangeReset&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>rendering</span><span>:</span> <span>{</span>
			<span>animate</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#animateCheck&#39;</span><span>)</span><span>,</span>
			<span>modes</span><span>:</span> WebGLBox<span>.</span><span>querySelectorAll</span><span>(</span><span>&#39;input[name=&#34;modeGaussSep&#34;]&#39;</span><span>)</span><span>,</span>
			<span>passModes</span><span>:</span> WebGLBox<span>.</span><span>querySelectorAll</span><span>(</span><span>&#39;input[name=&#34;passMode&#34;]&#39;</span><span>)</span><span>,</span>
			<span>lightBrightness</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#lightBrightness&#39;</span><span>)</span><span>,</span>
			<span>lightBrightnessReset</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#lightBrightnessReset&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>benchmark</span><span>:</span> <span>{</span>
			<span>button</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#benchmark&#39;</span><span>)</span><span>,</span>
			<span>label</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#benchmarkLabel&#39;</span><span>)</span><span>,</span>
			<span>iterOut</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterOut&#39;</span><span>)</span><span>,</span>
			<span>renderer</span><span>:</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-GaussianSeparableBlurDetail&#39;</span><span>)</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;#renderer&#39;</span><span>)</span><span>,</span>
			<span>passMode</span><span>:</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-GaussianSeparableBlurDetail&#39;</span><span>)</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;#passMode&#39;</span><span>)</span><span>,</span>
			<span>iterTime</span><span>:</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-GaussianSeparableBlurDetail&#39;</span><span>)</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterTime&#39;</span><span>)</span><span>,</span>
			<span>tapsCount</span><span>:</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-GaussianSeparableBlurDetail&#39;</span><span>)</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;#tapsCountBench&#39;</span><span>)</span><span>,</span>
			<span>iterations</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterations&#39;</span><span>)</span>
		<span>}</span>
	<span>}</span><span>;</span>

	
	<span>const</span> circleAnimation <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/circleAnimation.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> simpleTexture <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/simpleTexture.fs&#34;</span><span>)</span><span>;</span>
	<span>const</span> bloomVert <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/bloom.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> bloomFrag <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/bloom.fs&#34;</span><span>)</span><span>;</span>
	<span>const</span> simpleQuad <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/simpleQuad.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> gaussianBlurFrag <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/gaussianBlurSeparable.fs&#34;</span><span>)</span><span>;</span>

	
	ui<span>.</span>blur<span>.</span>kernelSize<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>
	ui<span>.</span>blur<span>.</span>sigma<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>
	ui<span>.</span>blur<span>.</span>samplePos<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>
	ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>animate<span>.</span><span>addEventListener</span><span>(</span><span>&#34;change&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
			<span>startRendering</span><span>(</span><span>)</span><span>;</span>
		<span>else</span> <span>{</span>
			ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
			ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
			ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>false</span><span>;</span>
			<span>redraw</span><span>(</span><span>)</span>
		<span>}</span>
	<span>}</span><span>)</span><span>;</span>

	canvas<span>.</span><span>addEventListener</span><span>(</span><span>&#34;webglcontextlost&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ui<span>.</span>display<span>.</span>contextLoss<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	ui<span>.</span>blur<span>.</span>kernelSize<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>reCompileBlurShader</span><span>(</span>ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value<span>)</span><span>;</span>
		ui<span>.</span>blur<span>.</span>samplePos<span>.</span>disabled <span>=</span> ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>==</span> <span>0</span><span>;</span>
		ui<span>.</span>blur<span>.</span>samplePosReset<span>.</span>disabled <span>=</span> ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>==</span> <span>0</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>modes<span>.</span><span>forEach</span><span>(</span><span>radio</span> <span>=&gt;</span> <span>{</span>
		
		<span>if</span> <span>(</span>radio<span>.</span>value <span>===</span> <span>&#34;scene&#34;</span><span>)</span>
			radio<span>.</span>checked <span>=</span> <span>true</span><span>;</span>
		radio<span>.</span><span>addEventListener</span><span>(</span><span>&#39;change&#39;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
			ctx<span>.</span>mode <span>=</span> event<span>.</span>target<span>.</span>value<span>;</span>
			ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>disabled <span>=</span> ctx<span>.</span>mode <span>===</span> <span>&#34;scene&#34;</span><span>;</span>
			ui<span>.</span>rendering<span>.</span>lightBrightnessReset<span>.</span>disabled <span>=</span> ctx<span>.</span>mode <span>===</span> <span>&#34;scene&#34;</span><span>;</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>
	
	
	ui<span>.</span>rendering<span>.</span>passModes<span>.</span><span>forEach</span><span>(</span><span>radio</span> <span>=&gt;</span> <span>{</span>
		
		<span>if</span> <span>(</span>radio<span>.</span>value <span>===</span> <span>&#34;pass1&#34;</span><span>)</span>
			radio<span>.</span>checked <span>=</span> <span>true</span><span>;</span>
		radio<span>.</span><span>addEventListener</span><span>(</span><span>&#39;change&#39;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
			ctx<span>.</span>passMode <span>=</span> event<span>.</span>target<span>.</span>value<span>;</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	ui<span>.</span>benchmark<span>.</span>button<span>.</span><span>addEventListener</span><span>(</span><span>&#34;click&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ctx<span>.</span>flags<span>.</span>benchMode <span>=</span> <span>true</span><span>;</span>
		<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
		ui<span>.</span>benchmark<span>.</span>button<span>.</span>disabled <span>=</span> <span>true</span><span>;</span>

		
		<span>const</span> worker <span>=</span> <span>new</span> <span>Worker</span><span>(</span><span>&#34;./js/benchmark/gaussianSeparableBlurBenchmark.js&#34;</span><span>,</span> <span>{</span> <span>type</span><span>:</span> <span>&#34;module&#34;</span> <span>}</span><span>)</span><span>;</span>

		
		worker<span>.</span><span>postMessage</span><span>(</span><span>{</span>
			<span>iterations</span><span>:</span> ui<span>.</span>benchmark<span>.</span>iterOut<span>.</span>value<span>,</span>
			<span>blurShaderSrc</span><span>:</span> gaussianBlurFrag<span>,</span>
			<span>kernelSize</span><span>:</span> ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value<span>,</span>
			<span>samplePos</span><span>:</span> ui<span>.</span>blur<span>.</span>samplePos<span>.</span>value<span>,</span>
			<span>sigma</span><span>:</span> ui<span>.</span>blur<span>.</span>sigma<span>.</span>value<span>,</span>
			<span>passMode</span><span>:</span> ctx<span>.</span>passMode
		<span>}</span><span>)</span><span>;</span>

		
		worker<span>.</span><span>addEventListener</span><span>(</span><span>&#34;message&#34;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
			<span>if</span> <span>(</span>event<span>.</span>data<span>.</span>type <span>!==</span> <span>&#34;done&#34;</span><span>)</span> <span>return</span><span>;</span>

			ui<span>.</span>benchmark<span>.</span>label<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>benchText<span>;</span>
			ui<span>.</span>benchmark<span>.</span>tapsCount<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>tapsCount<span>;</span>
			ui<span>.</span>benchmark<span>.</span>iterTime<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>iterationText<span>;</span>
			ui<span>.</span>benchmark<span>.</span>renderer<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>renderer<span>;</span>
			ui<span>.</span>benchmark<span>.</span>passMode<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>passMode<span>;</span>

			worker<span>.</span><span>terminate</span><span>(</span><span>)</span><span>;</span>
			ui<span>.</span>benchmark<span>.</span>button<span>.</span>disabled <span>=</span> <span>false</span><span>;</span>
			ctx<span>.</span>flags<span>.</span>benchMode <span>=</span> <span>false</span><span>;</span>
			<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
				<span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>else</span>
				<span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	ui<span>.</span>benchmark<span>.</span>iterations<span>.</span><span>addEventListener</span><span>(</span><span>&#34;change&#34;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ui<span>.</span>benchmark<span>.</span>iterOut<span>.</span>value <span>=</span> event<span>.</span>target<span>.</span>value<span>;</span>
		ui<span>.</span>benchmark<span>.</span>label<span>.</span>textContent <span>=</span> <span>&#34;Benchmark&#34;</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>scene <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> circleAnimation<span>,</span> simpleTexture<span>,</span> <span>[</span><span>&#34;offset&#34;</span><span>,</span> <span>&#34;radius&#34;</span><span>]</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>bloom <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> bloomVert<span>,</span> bloomFrag<span>,</span> <span>[</span><span>&#34;texture&#34;</span><span>,</span> <span>&#34;textureAdd&#34;</span><span>,</span> <span>&#34;offset&#34;</span><span>,</span> <span>&#34;radius&#34;</span><span>]</span><span>)</span><span>;</span>


	
	<span>function</span> <span>reCompileBlurShader</span><span>(</span><span>blurSize</span><span>)</span> <span>{</span>
		ctx<span>.</span>shd<span>.</span>blur <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> simpleQuad<span>,</span> gaussianBlurFrag<span>,</span> <span>[</span><span>&#34;frameSizeRCP&#34;</span><span>,</span> <span>&#34;samplePosMult&#34;</span><span>,</span> <span>&#34;bloomStrength&#34;</span><span>,</span> <span>&#34;sigma&#34;</span><span>,</span> <span>&#34;direction&#34;</span><span>]</span><span>,</span> <span>&#34;#define KERNEL_SIZE &#34;</span> <span>+</span> blurSize <span>+</span> <span>&#39;\n&#39;</span><span>)</span><span>;</span>
	<span>}</span>

	
	<span>reCompileBlurShader</span><span>(</span>ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value<span>)</span>

	
	util<span>.</span><span>bindUnitQuad</span><span>(</span>gl<span>)</span><span>;</span>

	<span>async</span> <span>function</span> <span>setupTextureBuffers</span><span>(</span><span>)</span> <span>{</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>buffersInitialized <span>=</span> <span>true</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>false</span><span>;</span>

		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>intermediate<span>)</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>final<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>scene<span>,</span> ctx<span>.</span>tex<span>.</span>frame<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>intermediate<span>,</span> ctx<span>.</span>tex<span>.</span>frameIntermediate<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>final<span>,</span> ctx<span>.</span>tex<span>.</span>frameFinal<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>

		
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> ctx<span>.</span>fb<span>.</span>intermediate<span>)</span><span>;</span>
		gl<span>.</span><span>clearColor</span><span>(</span><span>0.0</span><span>,</span> <span>0.0</span><span>,</span> <span>0.0</span><span>,</span> <span>1.0</span><span>)</span><span>;</span>
		gl<span>.</span><span>clear</span><span>(</span>gl<span>.</span><span>COLOR_BUFFER_BIT</span><span>)</span><span>;</span>


		<span>let</span> <span>[</span>base<span>,</span> selfIllum<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>
			<span>fetch</span><span>(</span><span>&#34;/dual-kawase/img/SDR_No_Sprite.png&#34;</span><span>)</span><span>,</span>
			<span>fetch</span><span>(</span><span>&#34;/dual-kawase/img/Selfillumination.png&#34;</span><span>)</span>
		<span>]</span><span>)</span><span>;</span>
		<span>let</span> <span>[</span>baseBlob<span>,</span> selfIllumBlob<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>base<span>.</span><span>blob</span><span>(</span><span>)</span><span>,</span> selfIllum<span>.</span><span>blob</span><span>(</span><span>)</span><span>]</span><span>)</span><span>;</span>
		<span>let</span> <span>[</span>baseBitmap<span>,</span> selfIllumBitmap<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>
			<span>createImageBitmap</span><span>(</span>baseBlob<span>,</span> <span>{</span> <span>colorSpaceConversion</span><span>:</span> <span>&#39;none&#39;</span><span>,</span> <span>resizeWidth</span><span>:</span> canvas<span>.</span>width <span>*</span> <span>1.12</span><span>,</span> <span>resizeHeight</span><span>:</span> canvas<span>.</span>height <span>*</span> <span>1.12</span><span>,</span> <span>resizeQuality</span><span>:</span> <span>&#34;high&#34;</span> <span>}</span><span>)</span><span>,</span>
			<span>createImageBitmap</span><span>(</span>selfIllumBlob<span>,</span> <span>{</span> <span>colorSpaceConversion</span><span>:</span> <span>&#39;none&#39;</span><span>,</span> <span>resizeWidth</span><span>:</span> canvas<span>.</span>width <span>*</span> <span>1.12</span><span>,</span> <span>resizeHeight</span><span>:</span> canvas<span>.</span>height <span>*</span> <span>1.12</span><span>,</span> <span>resizeQuality</span><span>:</span> <span>&#34;high&#34;</span> <span>}</span><span>)</span>
		<span>]</span><span>)</span><span>;</span>

		ctx<span>.</span>tex<span>.</span>sdr <span>=</span> util<span>.</span><span>setupTexture</span><span>(</span>gl<span>,</span> <span>null</span><span>,</span> <span>null</span><span>,</span> ctx<span>.</span>tex<span>.</span>sdr<span>,</span> gl<span>.</span><span>LINEAR</span><span>,</span> baseBitmap<span>)</span><span>;</span>
		ctx<span>.</span>tex<span>.</span>selfIllum <span>=</span> util<span>.</span><span>setupTexture</span><span>(</span>gl<span>,</span> <span>null</span><span>,</span> <span>null</span><span>,</span> ctx<span>.</span>tex<span>.</span>selfIllum<span>,</span> gl<span>.</span><span>LINEAR</span><span>,</span> selfIllumBitmap<span>)</span><span>;</span>

		baseBitmap<span>.</span><span>close</span><span>(</span><span>)</span><span>;</span>
		selfIllumBitmap<span>.</span><span>close</span><span>(</span><span>)</span><span>;</span>

		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>true</span><span>;</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;none&#34;</span><span>;</span>
	<span>}</span>

	<span>let</span> prevNow <span>=</span> performance<span>.</span><span>now</span><span>(</span><span>)</span><span>;</span>
	<span>let</span> lastStatsUpdate <span>=</span> prevNow<span>;</span>
	<span>let</span> fpsEMA <span>=</span> <span>60</span><span>;</span>
	<span>let</span> msEMA <span>=</span> <span>16</span><span>;</span>

	<span>async</span> <span>function</span> <span>redraw</span><span>(</span><span>)</span> <span>{</span>
		<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>buffersInitialized<span>)</span>
			<span>await</span> <span>setupTextureBuffers</span><span>(</span><span>)</span><span>;</span>
		<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>initComplete<span>)</span>
			<span>return</span><span>;</span>

		
		<span>const</span> KernelSizeSide <span>=</span> ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>*</span> <span>2</span> <span>+</span> <span>1</span><span>;</span>
		
		<span>const</span> samplesPerPixel <span>=</span> ctx<span>.</span>passMode <span>==</span> <span>&#34;combined&#34;</span> <span>?</span> KernelSizeSide <span>*</span> <span>2</span> <span>:</span> KernelSizeSide<span>;</span>
		<span>const</span> tapsNewText <span>=</span> <span>(</span>canvas<span>.</span>width <span>*</span> canvas<span>.</span>height <span>*</span> samplesPerPixel <span>/</span> <span>1000000</span><span>)</span><span>.</span><span>toFixed</span><span>(</span><span>1</span><span>)</span> <span>+</span> <span>&#34; Million&#34;</span><span>;</span>
		ui<span>.</span>display<span>.</span>tapsCount<span>.</span>value <span>=</span> tapsNewText<span>;</span>
		ui<span>.</span>display<span>.</span>width<span>.</span>value <span>=</span> canvas<span>.</span>width<span>;</span>
		ui<span>.</span>display<span>.</span>height<span>.</span>value <span>=</span> canvas<span>.</span>height<span>;</span>

		
		<span>let</span> radiusSwitch <span>=</span> ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked <span>?</span> radius <span>:</span> <span>0.0</span><span>;</span>
		<span>let</span> speed <span>=</span> <span>(</span>performance<span>.</span><span>now</span><span>(</span><span>)</span> <span>/</span> <span>10000</span><span>)</span> <span>%</span> Math<span>.</span><span>PI</span> <span>*</span> <span>2</span><span>;</span>
		<span>const</span> offset <span>=</span> <span>[</span>radiusSwitch <span>*</span> Math<span>.</span><span>cos</span><span>(</span>speed<span>)</span><span>,</span> radiusSwitch <span>*</span> Math<span>.</span><span>sin</span><span>(</span>speed<span>)</span><span>]</span><span>;</span>
		gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>handle<span>)</span><span>;</span>
		<span>const</span> texture <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> ctx<span>.</span>tex<span>.</span>sdr <span>:</span> ctx<span>.</span>tex<span>.</span>selfIllum<span>;</span>
		gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
		gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> texture<span>)</span><span>;</span>
		gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>uniforms<span>.</span>offset<span>,</span> offset<span>)</span><span>;</span>
		gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>uniforms<span>.</span>radius<span>,</span> radiusSwitch<span>)</span><span>;</span>

		
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span>
		gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>

		
		gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>

		
		gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>handle<span>)</span><span>;</span>
		
		<span>if</span> <span>(</span>ctx<span>.</span>passMode <span>==</span> <span>&#34;pass1&#34;</span><span>)</span> <span>{</span>
			
			<span>const</span> finalFB <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;bloom&#34;</span> <span>?</span> ctx<span>.</span>fb<span>.</span>final <span>:</span> <span>null</span><span>;</span>
			gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> finalFB<span>)</span><span>;</span>
			gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>bloomStrength<span>,</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> <span>1.0</span> <span>:</span> ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>value<span>)</span><span>;</span>
			gl<span>.</span><span>uniform2f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>direction<span>,</span> <span>1.0</span><span>,</span> <span>0.0</span><span>)</span><span>;</span> 
			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>frame<span>)</span><span>;</span>
			gl<span>.</span><span>uniform2f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>frameSizeRCP<span>,</span> <span>1.0</span> <span>/</span> canvas<span>.</span>width<span>,</span> <span>1.0</span> <span>/</span> canvas<span>.</span>height<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>samplePosMult<span>,</span> ui<span>.</span>blur<span>.</span>samplePos<span>.</span>value<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>sigma<span>,</span> Math<span>.</span><span>max</span><span>(</span>ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>/</span> ui<span>.</span>blur<span>.</span>sigma<span>.</span>value<span>,</span> <span>0.001</span><span>)</span><span>)</span><span>;</span>
			gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
		<span>}</span> <span>else</span> <span>if</span> <span>(</span>ctx<span>.</span>passMode <span>==</span> <span>&#34;pass2&#34;</span><span>)</span> <span>{</span>
			
			<span>const</span> finalFB <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;bloom&#34;</span> <span>?</span> ctx<span>.</span>fb<span>.</span>final <span>:</span> <span>null</span><span>;</span>
			gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> finalFB<span>)</span><span>;</span>
			gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>bloomStrength<span>,</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> <span>1.0</span> <span>:</span> ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>value<span>)</span><span>;</span>
			gl<span>.</span><span>uniform2f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>direction<span>,</span> <span>0.0</span><span>,</span> <span>1.0</span><span>)</span><span>;</span> 
			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>frame<span>)</span><span>;</span>
			gl<span>.</span><span>uniform2f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>frameSizeRCP<span>,</span> <span>1.0</span> <span>/</span> canvas<span>.</span>width<span>,</span> <span>1.0</span> <span>/</span> canvas<span>.</span>height<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>samplePosMult<span>,</span> ui<span>.</span>blur<span>.</span>samplePos<span>.</span>value<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>sigma<span>,</span> Math<span>.</span><span>max</span><span>(</span>ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>/</span> ui<span>.</span>blur<span>.</span>sigma<span>.</span>value<span>,</span> <span>0.001</span><span>)</span><span>)</span><span>;</span>
			gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
		<span>}</span> <span>else</span> <span>{</span>
			
			
			gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> ctx<span>.</span>fb<span>.</span>intermediate<span>)</span><span>;</span>
			gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>bloomStrength<span>,</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> <span>1.0</span> <span>:</span> ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>value<span>)</span><span>;</span>
			gl<span>.</span><span>uniform2f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>direction<span>,</span> <span>1.0</span><span>,</span> <span>0.0</span><span>)</span><span>;</span> 
			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>frame<span>)</span><span>;</span>
			gl<span>.</span><span>uniform2f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>frameSizeRCP<span>,</span> <span>1.0</span> <span>/</span> canvas<span>.</span>width<span>,</span> <span>1.0</span> <span>/</span> canvas<span>.</span>height<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>samplePosMult<span>,</span> ui<span>.</span>blur<span>.</span>samplePos<span>.</span>value<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>sigma<span>,</span> Math<span>.</span><span>max</span><span>(</span>ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>/</span> ui<span>.</span>blur<span>.</span>sigma<span>.</span>value<span>,</span> <span>0.001</span><span>)</span><span>)</span><span>;</span>
			gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
			
			
			<span>const</span> finalFB <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;bloom&#34;</span> <span>?</span> ctx<span>.</span>fb<span>.</span>final <span>:</span> <span>null</span><span>;</span>
			gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> finalFB<span>)</span><span>;</span>
			gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>bloomStrength<span>,</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> <span>1.0</span> <span>:</span> ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>value<span>)</span><span>;</span>
			gl<span>.</span><span>uniform2f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>direction<span>,</span> <span>0.0</span><span>,</span> <span>1.0</span><span>)</span><span>;</span> 
			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>frameIntermediate<span>)</span><span>;</span>
			gl<span>.</span><span>uniform2f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>frameSizeRCP<span>,</span> <span>1.0</span> <span>/</span> canvas<span>.</span>width<span>,</span> <span>1.0</span> <span>/</span> canvas<span>.</span>height<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>samplePosMult<span>,</span> ui<span>.</span>blur<span>.</span>samplePos<span>.</span>value<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>sigma<span>,</span> Math<span>.</span><span>max</span><span>(</span>ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>/</span> ui<span>.</span>blur<span>.</span>sigma<span>.</span>value<span>,</span> <span>0.001</span><span>)</span><span>)</span><span>;</span>
			gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
		<span>}</span>

		<span>if</span> <span>(</span>ctx<span>.</span>mode <span>==</span> <span>&#34;bloom&#34;</span><span>)</span> <span>{</span>
			
			gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> <span>null</span><span>)</span><span>;</span>
			gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>handle<span>)</span><span>;</span>

			gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>offset<span>,</span> offset<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>radius<span>,</span> radiusSwitch<span>)</span><span>;</span>

			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>sdr<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1i</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>texture<span>,</span> <span>0</span><span>)</span><span>;</span>

			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE1</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>frameFinal<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1i</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>textureAdd<span>,</span> <span>1</span><span>)</span><span>;</span>

			gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
		<span>}</span>

		
		gl<span>.</span><span>finish</span><span>(</span><span>)</span><span>;</span>

		<span>const</span> now <span>=</span> performance<span>.</span><span>now</span><span>(</span><span>)</span><span>;</span>
		<span>let</span> dt <span>=</span> now <span>-</span> prevNow<span>;</span>

		<span>if</span> <span>(</span>dt <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
			<span>const</span> instFPS <span>=</span> <span>1000</span> <span>/</span> dt<span>;</span>
			<span>const</span> <span>ALPHA</span> <span>=</span> <span>0.05</span><span>;</span>
			fpsEMA <span>=</span> <span>ALPHA</span> <span>*</span> instFPS <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>ALPHA</span><span>)</span> <span>*</span> fpsEMA<span>;</span>
			msEMA <span>=</span> <span>ALPHA</span> <span>*</span> dt <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>ALPHA</span><span>)</span> <span>*</span> msEMA<span>;</span>
		<span>}</span>
		prevNow <span>=</span> now<span>;</span>

		<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked <span>&amp;&amp;</span> now <span>-</span> lastStatsUpdate <span>&gt;=</span> <span>1000</span><span>)</span> <span>{</span>
			ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> fpsEMA<span>.</span><span>toFixed</span><span>(</span><span>0</span><span>)</span><span>;</span>
			ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> msEMA<span>.</span><span>toFixed</span><span>(</span><span>2</span><span>)</span><span>;</span>
			lastStatsUpdate <span>=</span> now<span>;</span>
		<span>}</span>
	<span>}</span>

	<span>let</span> animationFrameId<span>;</span>

	
	<span>function</span> <span>nativeResize</span><span>(</span><span>)</span> <span>{</span>
		<span>const</span> <span>[</span>width<span>,</span> height<span>]</span> <span>=</span> util<span>.</span><span>getNativeSize</span><span>(</span>canvas<span>)</span><span>;</span>

		<span>if</span> <span>(</span>width <span>&amp;&amp;</span> canvas<span>.</span>width <span>!==</span> width <span>||</span> height <span>&amp;&amp;</span> canvas<span>.</span>height <span>!==</span> height<span>)</span> <span>{</span>
			canvas<span>.</span>width <span>=</span> width<span>;</span>
			canvas<span>.</span>height <span>=</span> height<span>;</span>

			<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>benchMode<span>)</span> <span>{</span>
				<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
				<span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
				<span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span>
	<span>}</span>

	
	<span>nativeResize</span><span>(</span><span>)</span><span>;</span>

	<span>let</span> resizePending <span>=</span> <span>false</span><span>;</span>
	window<span>.</span><span>addEventListener</span><span>(</span><span>&#39;resize&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>if</span> <span>(</span><span>!</span>resizePending<span>)</span> <span>{</span>
			resizePending <span>=</span> <span>true</span><span>;</span>
			<span>requestAnimationFrame</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
				resizePending <span>=</span> <span>false</span><span>;</span>
				<span>nativeResize</span><span>(</span><span>)</span><span>;</span>
			<span>}</span><span>)</span><span>;</span>
		<span>}</span>
	<span>}</span><span>)</span><span>;</span>

	<span>function</span> <span>renderLoop</span><span>(</span><span>)</span> <span>{</span>
		<span>if</span> <span>(</span>ctx<span>.</span>flags<span>.</span>isRendering <span>&amp;&amp;</span> ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>{</span>
			<span>redraw</span><span>(</span><span>)</span><span>;</span>
			animationFrameId <span>=</span> <span>requestAnimationFrame</span><span>(</span>renderLoop<span>)</span><span>;</span>
		<span>}</span>
	<span>}</span>

	<span>function</span> <span>startRendering</span><span>(</span><span>)</span> <span>{</span>
		
		ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>true</span><span>;</span>
		<span>renderLoop</span><span>(</span><span>)</span><span>;</span>
	<span>}</span>

	<span>function</span> <span>stopRendering</span><span>(</span><span>)</span> <span>{</span>
		
		ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>false</span><span>;</span>
		<span>cancelAnimationFrame</span><span>(</span>animationFrameId<span>)</span><span>;</span>
		
		gl<span>.</span><span>finish</span><span>(</span><span>)</span><span>;</span>

		
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>sdr<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>sdr <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>selfIllum<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>selfIllum <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>frame<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>frame <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>frameIntermediate<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>frameIntermediate <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>frameFinal<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>frameFinal <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>scene <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>intermediate<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>intermediate <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>final<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>final <span>=</span> <span>null</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>buffersInitialized <span>=</span> <span>false</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>false</span><span>;</span>
		ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
		ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
	<span>}</span>

	<span>function</span> <span>handleIntersection</span><span>(</span><span>entries</span><span>)</span> <span>{</span>
		entries<span>.</span><span>forEach</span><span>(</span><span>entry</span> <span>=&gt;</span> <span>{</span>
			<span>if</span> <span>(</span>entry<span>.</span>isIntersecting<span>)</span> <span>{</span>
				<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>isRendering <span>&amp;&amp;</span> <span>!</span>ctx<span>.</span>flags<span>.</span>benchMode<span>)</span> <span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span> <span>else</span> <span>{</span>
				<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span>

	
	<span>let</span> observer <span>=</span> <span>new</span> <span>IntersectionObserver</span><span>(</span>handleIntersection<span>)</span><span>;</span>
	observer<span>.</span><span>observe</span><span>(</span>canvas<span>)</span><span>;</span>
<span>}</span></code></pre></details></blockquote><p>If you benchmark the performance, you will see a massive performance uplift, as compared to our Gaussian Blur! But there <em>is</em> a trade-off made, that‚Äôs not quite obvious. In order to have two passes, we are writing out a new framebuffer. Remember the ‚Äúmodern chips are fast but memory access in relation is not‚Äù thing?</p><p>With a modern High-res 4k screen video game, multi-pass anything implies writing out 8.2 Million Pixels to memory, just to read them back in. With smaller kernels on high-res displays, a separable kernel may not always be faster. But with bigger kernels, it almost always is. With a massive speed-up gained, how much faster can we go?</p><h2 id="the-magic-of-frequency-space" tabindex="-1">The magic of frequency space <a href="#the-magic-of-frequency-space">#</a></h2><p>‚Ä¶how about blurs that happen so fast, that they are considered free! We are doing a bit of a detour into <em><strong>Frequency Space</strong></em> image manipulation.</p><p>Any 2D image can be converted and edited in frequency space, which unlocks a whole new sort of image manipulation. To blur an image in this paradigm, we perform an <a href="https://usage.imagemagick.org/fourier/#introduction" target="_blank">image Fast Fourier Transform</a>, then <a href="https://usage.imagemagick.org/fourier/#blurring" target="_blank">mask high frequency areas to perform the blur</a> and finally do the inverse transformation.</p><p>A Fourier Transform decomposes a signal into its underlying Sine Frequencies. The output of an <em>image Fast Fourier Transform</em> are ‚ÄúMagnitude‚Äù and ‚ÄúPhase‚Äù component images. These images can be combined back together with the inverse image FFT to produce the original image again‚Ä¶</p><figure><img src="https://blog.frost.kiwi/dual-kawase/img/256ScreenOverlay.png" alt="FFT Viz Input image"/><figcaption>Input image for the following interactive FFT example</figcaption></figure><p>‚Ä¶but before doing so, we can manipulate the frequency representation of the image in various ways. <a href="https://www.youtube.com/watch?v=qHvdLwSZmF8" target="_blank">Less reading, more interaction!</a> In the following interactive visualization you have the magnitude image, brightness boosted into a human visible representation on the left and the reconstructed image on the right.</p><p>For now, play around with removing energy. You can paint on the magnitude image with your fingers or with the mouse. The output image will be reconstructed accordingly. Also, play around with the circular mask and the feathering sliders. Try to build intuition for what‚Äôs happening.</p><div id="FFTBox"><div><p><label><p> Upload <span>Image</span></p><svg viewBox="0 0 640 640" xmlns="http://www.w3.org/2000/svg"><!--!Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M352 173.3L352 384C352 401.7 337.7 416 320 416C302.3 416 288 401.7 288 384L288 173.3L246.6 214.7C234.1 227.2 213.8 227.2 201.3 214.7C188.8 202.2 188.8 181.9 201.3 169.4L297.3 73.4C309.8 60.9 330.1 60.9 342.6 73.4L438.6 169.4C451.1 181.9 451.1 202.2 438.6 214.7C426.1 227.2 405.8 227.2 393.3 214.7L352 173.3zM320 464C364.2 464 400 428.2 400 384L480 384C515.3 384 544 412.7 544 448L544 480C544 515.3 515.3 544 480 544L160 544C124.7 544 96 515.3 96 480L96 448C96 412.7 124.7 384 160 384L240 384C240 428.2 275.8 464 320 464zM464 488C477.3 488 488 477.3 488 464C488 450.7 477.3 440 464 440C450.7 440 440 450.7 440 464C440 477.3 450.7 488 464 488z" fill="currentColor"></path></svg></label></p><p><label> Remove<span>Frequency Energy</span></label> <label> Add<span>Frequency Energy</span></label></p><p><label> Reset<span>Magnitude</span></label></p></div><table><tbody><tr><td colspan="4"><code>frequencyCutRadius</code></td></tr><tr><td><code>frequencyCutRadius</code></td><td></td><td><output>off</output></td><td></td></tr><tr><td colspan="4"><code>feather</code></td></tr><tr><td><code>feather</code></td><td></td><td><output id="featherVal">0</output></td><td></td></tr></tbody></table></div><p>The magnitude image represents the frequency make-up of the image, with the lowest frequencies in the middle and higher at the edges. Horizontal frequencies (vertical features in the image) follow the X Axis and vertical frequencies (Horizontal features in the image) follow the Y Axis, with in-betweens being the diagonals.</p><p>Repeating patterns in the image lighten up as bright-points in the magnitude representation. Or rather, their frequencies have high energy: E.g. the green grid I added. Removing it in photoshop wouldn‚Äôt be easy! But in frequency space it <em><strong>is</strong></em> easy! Just paint over the blueish 3 diagonal streaks.</p><blockquote><p>Removing repeating features by finger-painting black over frequencies still blows me away.</p><img src="https://blog.frost.kiwi/assets/kiwis/surprised.svg"/></blockquote><p>As you may have noticed, the Magnitude representation holds mirrored information. This is due to the FFT being a complex number analysis and our image having only ‚Äúreal‚Äù component pixels, leaving redundant information. The underlying number theory was covered in great detail by 3Blue1Brown:</p><figure><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="" frameborder="0" loading="lazy" src="https://www.youtube-nocookie.com/embed/spUNpyF58BY" title="YouTube video player" width="100%"></iframe><figcaption>But what is the Fourier Transform? A visual introduction.</figcaption></figure><p>The underlying code this time is not written by me, but is from <a href="https://github.com/turbomaze/" target="_blank">@turbomaze</a>‚Äôs repo <a href="https://github.com/turbomaze/JS-Fourier-Image-Analysis" target="_blank">JS-Fourier-Image-Analysis</a>. There is no standard on how you are supposed to plot the magnitude information and how the quadrants are layed out. I changed the implementation by <a href="https://github.com/turbomaze/" target="_blank">@turbomaze</a> to follow the <a href="https://usage.imagemagick.org/fourier/#introduction" target="_blank">convention used by ImageMagick</a>.</p><p>We can blur the image by painting the frequency energy black in a radius around the center, thus eliminating higher frequencies and blurring the image. If we do so with a pixel perfect circle, then we get ringing artifacts - The <a href="https://en.wikipedia.org/wiki/Gibbs_phenomenon" target="_blank">Gibbs phenomenon</a>. By feathering the circle, we lessen this ringing and the blur cleans up.</p><blockquote><p>Drawing a circle like this? That&#39;s essentially free on the GPU! We get the equivalent of get super big kernels for free!</p><img src="https://blog.frost.kiwi/assets/kiwis/party.svg"/></blockquote><p>But not everything is gold that glitters. First of all, performance. Yes, the ‚Äúblur‚Äù in frequency space is essentially free, but the trip to frequency space, is everything but. The main issue comes down to <a href="https://en.wikipedia.org/wiki/Butterfly_diagram" target="_blank">FFT transformations</a> performing writes to exponentially many pixels per input pixel, a performance killer.</p><blockquote><p><strong>And</strong> then there&#39;s still the inverse conversion!</p><img src="https://blog.frost.kiwi/assets/kiwis/facepalm.svg"/></blockquote><p>But our shaders work the other way around, expressing the ‚Äúinstructions to construct an output pixel‚Äù. There <em>are</em> <a href="https://github.com/rreusser/glsl-fft" target="_blank">fragment shader based GPU implementations</a>, but they rely on many passes for calculation, a lot of memory access back and forth. Furthermore, non-power of two images <a href="https://rocm.docs.amd.com/projects/rocFFT/en/latest/design/bluestein.html" target="_blank">require a slower algorithm</a>.</p><p>This article is in the realm of fragment shaders and the graphics pipeline a GPU is part of, but there are also <a href="https://en.wikipedia.org/wiki/General-purpose_computing_on_graphics_processing_units" target="_blank">GPGPU</a> and <a href="https://github.com/bane9/OpenGLFFT" target="_blank">compute shader implementations</a> with no fragment shader specific limitations. Unfortunately the situation remains: Conversion of high-res images to frequency space is too costly in the context of realtime graphics.</p><blockquote><p>Deleting the frequencies of that grid is magical, but leaves artifacts. In reality it&#39;s worse, as my example is idealized. Click <strong>Upload Image</strong>, take a photo of a repeating pattern and see how cleanly you can get rid of it.</p><img src="https://blog.frost.kiwi/assets/kiwis/detective.svg"/></blockquote><p>Then there are the artifacts I have glossed over. The FFT transformation considers the image as an infinite 2D signal. By blurring, we are bleeding through color from the neighbor copies. And that‚Äôs not to mention various ringing artifacts that happen. <em><strong>None</strong></em> of this is unsolvable! But there a more underlying issue‚Ä¶</p><h3 id="what-is-a-low-pass-filter%3F" tabindex="-1">What is a Low-Pass filter? <a href="#what-is-a-low-pass-filter%3F">#</a></h3><blockquote><p>It&#39;s a filter that removes high frequencies and leaves the low ones, easy!</p><img src="https://blog.frost.kiwi/assets/kiwis/happy.svg"/></blockquote><p>Try the FFT Example again and decrease the <code>frequencyCutRadius</code> to blur. At some point the green lines disappear, right? It <em><strong>is</strong></em> a low pass filter, one where high frequencies are literally annihilated. Small bright lights in the distance? Also annihilated‚Ä¶</p><div id="FFTBox2"><div><p><label><p> Upload <span>Image</span></p><svg viewBox="0 0 640 640" xmlns="http://www.w3.org/2000/svg"><!--!Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M352 173.3L352 384C352 401.7 337.7 416 320 416C302.3 416 288 401.7 288 384L288 173.3L246.6 214.7C234.1 227.2 213.8 227.2 201.3 214.7C188.8 202.2 188.8 181.9 201.3 169.4L297.3 73.4C309.8 60.9 330.1 60.9 342.6 73.4L438.6 169.4C451.1 181.9 451.1 202.2 438.6 214.7C426.1 227.2 405.8 227.2 393.3 214.7L352 173.3zM320 464C364.2 464 400 428.2 400 384L480 384C515.3 384 544 412.7 544 448L544 480C544 515.3 515.3 544 480 544L160 544C124.7 544 96 515.3 96 480L96 448C96 412.7 124.7 384 160 384L240 384C240 428.2 275.8 464 320 464zM464 488C477.3 488 488 477.3 488 464C488 450.7 477.3 440 464 440C450.7 440 440 450.7 440 464C440 477.3 450.7 488 464 488z" fill="currentColor"></path></svg></label></p><p><label> Remove<span>Frequency Energy</span></label> <label> Add<span>Frequency Energy</span></label></p><p><label> Reset<span>Magnitude</span></label></p></div><table><tbody><tr><td colspan="4"><code>frequencyCutRadius</code></td></tr><tr><td><code>frequencyCutRadius</code></td><td></td><td><output>off</output></td><td></td></tr><tr><td colspan="4"><code>feather</code></td></tr><tr><td><code>feather</code></td><td></td><td><output id="featherVal">0</output></td><td></td></tr></tbody></table></div><p>If we were to use this to build an effect like bloom, it would remove small lights that are meant to bloom as well! Our gaussian blur on the other hand, <a href="https://en.wikipedia.org/wiki/Gaussian_blur#Low-pass_filter" target="_blank">also a low-pass filter</a>, samples and weights <em><strong>every</strong></em> pixel. In a way it ‚Äú<em>takes the high frequency energy and spreads it into low frequency energy</em>‚Äù.</p><p>So Low Pass Filter ‚â† Low Pass Filter, it depends on context as to what is meant by that word and the reason the article didn‚Äôt use it until now. Frequency Space energy attenuations are simply not the correct tool for our goal of a ‚Äúbasic graphics programming building block‚Äù for visual effects.</p><blockquote><p>This is a <strong>deep misunderstanding</strong> I held for year, as in why <strong>didn&#39;t</strong> video games such a powerful tool?<output></output></p><img src="https://blog.frost.kiwi/assets/kiwis/speak.svg"/></blockquote><p>There are other frequency space image representations, not just FFT Magnitude + Phase. Another famous one is <a href="https://en.wikipedia.org/wiki/Discrete_cosine_transform" target="_blank">Discrete cosine transform</a>. Again, computerphile covered it in great detail in a video. As for realtime hires images, no. DCT conversion is multiple magnitudes slower. Feel free to dive deeper into frequency space‚Ä¶</p><figure><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="" frameborder="0" loading="lazy" src="https://www.youtube-nocookie.com/embed/Q2aEzeMDHMA" title="YouTube video player" width="100%"></iframe><figcaption>JPEG DCT, Discrete Cosine Transform (JPEG Pt2)</figcaption></figure><p>‚Ä¶as for this article, it‚Äôs the end of our frequency space detour. We talked so much about what‚Äôs slow on the GPU. Let‚Äôs talk about something that‚Äôs not just fast, but free:</p><h2 id="bilinear-interpolation" tabindex="-1">Bilinear Interpolation <a href="#bilinear-interpolation">#</a></h2><p>Reading from textures comes with a freebie. When reading between pixels, the closet four pixel are interpolated <a href="https://en.wikipedia.org/wiki/Bilinear_interpolation" target="_blank">bilinearly</a> to create the final read, unless you switch to <a href="https://learnopengl.com/Getting-started/Textures#:~:text=Texture%20Filtering" target="_blank">Nearest Neightbor mode</a>. Below you can drag the color sample with finger touch or the mouse. Take note of how and when the color changes in the respective modes.</p><div id="SVGBox-bilinearPreview"><div><p><label> Nearest Neighbor</label> <label> Bilinear</label></p><p><label> Animate</label></p></div><svg></svg></div><p>Since reading between pixels gets a linear mix of pixel neighbors, we can <a href="https://www.rastergrid.com/blog/2010/09/efficient-gaussian-blur-with-linear-sampling/" target="_blank">linearly interpolate part of our gaussian kernel</a>, sometimes called a <a href="https://www.rastergrid.com/blog/2010/09/efficient-gaussian-blur-with-linear-sampling/" target="_blank">Linear Gaussian</a>. By tweaking gaussian weights and reducing the amount of samples we could do a 7 √ó 7 gaussian kernel worth of information with only a 4 √ó 4 kernel, as shown in the <a href="https://www.rastergrid.com/blog/2010/09/efficient-gaussian-blur-with-linear-sampling/" target="_blank">linked article</a>.</p><blockquote><p>Though mathematically not the same, visually the result is very close. There are a lot of hand-crafted variations on this, different mixes of kernel sizes and interpolation amounts.</p><img src="https://blog.frost.kiwi/assets/kiwis/speak.svg"/></blockquote><p>Bilinear interpolation allows us to resize an image by reading from it at lower resolution. In a way, it‚Äôs a free bilinear resize built into every graphics chip, zero performance impact. But there <em>is</em> a limit - the bilinear interpolation is limited to a 2 √ó 2 sample square. Try to resize the kiwi below in different modes.</p><blockquote><p>To make this more obvious, the following canvas renders at 25% of <a href="https://en.wikipedia.org/wiki/1:1_pixel_mapping" target="_blank">native resolution</a>.</p><img src="https://blog.frost.kiwi/assets/kiwis/teach.svg"/></blockquote><div id="WebGLBox-Bilinear"><div><p><label> Nearest Neighbor</label> <label> Bilinear</label></p><p><label> Animate</label></p></div><div><canvas></canvas><p>‚ùå The browser killed this WebGL Context, please reload the page. If this happened as the result of a long benchmark, decrease the iteration count. On some platforms (iOS / iPad) you may have to restart the browser App completely, as the browser will temporarily refuse to allow this site to run WebGL again.</p><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" fill="transparent" r="10" stroke-width="2"></circle><rect height="7" rx="1" width="2" x="11" y="6"></rect><rect height="9" rx="1" width="2" x="11" y="11"></rect></svg></div></div><blockquote><details><summary>WebGL Vertex Shader <a href="https://blog.frost.kiwi/dual-kawase/shader/circleAnimationSize.vs" target="_blank">circleAnimationSize.vs</a></summary><pre><code>
<span>attribute</span> <span>vec2</span> vtx<span>;</span>
<span>varying</span> <span>vec2</span> uv<span>;</span>


<span>uniform</span> <span>vec2</span> offset<span>;</span>
<span>uniform</span> <span>float</span> kiwiSize<span>;</span>

<span>void</span> <span>main</span><span>(</span><span>)</span>
<span>{</span>
	
	uv <span>=</span> vtx <span>*</span> <span>vec2</span><span>(</span><span>0.5</span><span>,</span> <span>-</span><span>0.5</span><span>)</span> <span>+</span> <span>0.5</span><span>;</span>
	
	
	gl_Position <span>=</span> <span>vec4</span><span>(</span>vtx <span>*</span> kiwiSize <span>+</span> offset<span>,</span> <span>0.0</span><span>,</span> <span>1.0</span><span>)</span><span>;</span>
<span>}</span></code></pre></details><details><summary>WebGL Fragment Shader <a href="https://blog.frost.kiwi/dual-kawase/shader/simpleTexture.fs" target="_blank">simpleTexture.fs</a></summary><pre><code><span>precision</span> <span>highp</span> <span>float</span><span>;</span>
<span>varying</span> <span>vec2</span> uv<span>;</span>

<span>uniform</span> <span>sampler2D</span> texture<span>;</span>

<span>void</span> <span>main</span><span>(</span><span>)</span> <span>{</span>
	gl_FragColor <span>=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv<span>)</span><span>;</span>
<span>}</span></code></pre></details><details><summary>WebGL Javascript <a href="https://blog.frost.kiwi/dual-kawase/js/bilinear.js" target="_blank">bilinear.js</a></summary><pre><code><span>import</span> <span>*</span> <span>as</span> util <span>from</span> <span>&#39;./utility.js&#39;</span>

<span>export</span> <span>async</span> <span>function</span> <span>setupBilinear</span><span>(</span><span>)</span> <span>{</span>
	
	<span>const</span> WebGLBox <span>=</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-Bilinear&#39;</span><span>)</span><span>;</span>
	<span>const</span> canvas <span>=</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;canvas&#39;</span><span>)</span><span>;</span>

	
	<span>const</span> radius <span>=</span> <span>0.12</span><span>;</span>
	
	
	<span>const</span> resDiv <span>=</span> <span>4</span><span>;</span> 
	<span>let</span> renderFramebuffer<span>,</span> renderTexture<span>;</span>
	<span>let</span> buffersInitialized <span>=</span> <span>false</span><span>;</span>

	
	<span>const</span> gl <span>=</span> canvas<span>.</span><span>getContext</span><span>(</span><span>&#39;webgl&#39;</span><span>,</span> <span>{</span>
		<span>preserveDrawingBuffer</span><span>:</span> <span>false</span><span>,</span>
		<span>antialias</span><span>:</span> <span>false</span><span>,</span>
		<span>alpha</span><span>:</span> <span>true</span><span>,</span>
	<span>}</span><span>)</span><span>;</span>

	
	<span>const</span> ctx <span>=</span> <span>{</span>
		<span>mode</span><span>:</span> <span>&#34;nearest&#34;</span><span>,</span>
		<span>flags</span><span>:</span> <span>{</span> <span>isRendering</span><span>:</span> <span>false</span><span>,</span> <span>initComplete</span><span>:</span> <span>false</span> <span>}</span><span>,</span>
		
		<span>tex</span><span>:</span> <span>{</span> <span>sdr</span><span>:</span> <span>null</span> <span>}</span><span>,</span>
		
		<span>shd</span><span>:</span> <span>{</span>
			<span>kiwi</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>offset</span><span>:</span> <span>null</span><span>,</span> <span>kiwiSize</span><span>:</span> <span>null</span> <span>}</span> <span>}</span><span>,</span>
			<span>blit</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>texture</span><span>:</span> <span>null</span> <span>}</span> <span>}</span>
		<span>}</span>
	<span>}</span><span>;</span>

	
	<span>const</span> ui <span>=</span> <span>{</span>
		<span>display</span><span>:</span> <span>{</span>
			<span>spinner</span><span>:</span> canvas<span>.</span>parentElement<span>.</span><span>querySelector</span><span>(</span><span>&#39;svg&#39;</span><span>)</span><span>,</span>
			<span>contextLoss</span><span>:</span> canvas<span>.</span>parentElement<span>.</span><span>querySelector</span><span>(</span><span>&#39;div&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>rendering</span><span>:</span> <span>{</span>
			<span>modes</span><span>:</span> WebGLBox<span>.</span><span>querySelectorAll</span><span>(</span><span>&#39;input[type=&#34;radio&#34;]&#39;</span><span>)</span><span>,</span>
			<span>animate</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#animateCheck&#39;</span><span>)</span><span>,</span>
			<span>kiwiSize</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#kiwiSize&#39;</span><span>)</span><span>,</span>
		<span>}</span>
	<span>}</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>modes<span>.</span><span>forEach</span><span>(</span><span>radio</span> <span>=&gt;</span> <span>{</span>
		
		<span>if</span> <span>(</span>radio<span>.</span>value <span>===</span> <span>&#34;nearest&#34;</span><span>)</span>
			radio<span>.</span>checked <span>=</span> <span>true</span><span>;</span>
		radio<span>.</span><span>addEventListener</span><span>(</span><span>&#39;change&#39;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
			ctx<span>.</span>mode <span>=</span> event<span>.</span>target<span>.</span>value<span>;</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>


	
	<span>const</span> circleAnimationSize <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/circleAnimationSize.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> simpleTexture <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/simpleTexture.fs&#34;</span><span>)</span><span>;</span>
	<span>const</span> simpleQuad <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/simpleQuad.vs&#34;</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>kiwiSize<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>animate<span>.</span><span>addEventListener</span><span>(</span><span>&#34;change&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
			<span>startRendering</span><span>(</span><span>)</span><span>;</span>
		<span>else</span> <span>{</span>
			ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>false</span><span>;</span>
			<span>redraw</span><span>(</span><span>)</span>
		<span>}</span>
	<span>}</span><span>)</span><span>;</span>

	canvas<span>.</span><span>addEventListener</span><span>(</span><span>&#34;webglcontextlost&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ui<span>.</span>display<span>.</span>contextLoss<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>kiwi <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> circleAnimationSize<span>,</span> simpleTexture<span>,</span> <span>[</span><span>&#34;offset&#34;</span><span>,</span> <span>&#34;kiwiSize&#34;</span><span>]</span><span>)</span><span>;</span>
	
	
	ctx<span>.</span>shd<span>.</span>blit <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> simpleQuad<span>,</span> simpleTexture<span>,</span> <span>[</span><span>&#34;texture&#34;</span><span>]</span><span>)</span><span>;</span>
	
	
	gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>kiwi<span>.</span>handle<span>)</span><span>;</span>

	
	util<span>.</span><span>bindUnitQuad</span><span>(</span>gl<span>)</span><span>;</span>

	
	<span>function</span> <span>loadSVGAsImage</span><span>(</span><span>blob</span><span>)</span> <span>{</span>
		<span>return</span> <span>new</span> <span>Promise</span><span>(</span><span>(</span><span>resolve</span><span>)</span> <span>=&gt;</span> <span>{</span>
			<span>const</span> img <span>=</span> <span>new</span> <span>Image</span><span>(</span><span>)</span><span>;</span>
			<span>const</span> url <span>=</span> <span>URL</span><span>.</span><span>createObjectURL</span><span>(</span>blob<span>)</span><span>;</span>
			
			img<span>.</span><span>onload</span> <span>=</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
				<span>URL</span><span>.</span><span>revokeObjectURL</span><span>(</span>url<span>)</span><span>;</span>
				<span>resolve</span><span>(</span>img<span>)</span><span>;</span>
			<span>}</span><span>;</span>
			
			img<span>.</span>src <span>=</span> url<span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span>

	<span>async</span> <span>function</span> <span>setupTextureBuffers</span><span>(</span><span>)</span> <span>{</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
		buffersInitialized <span>=</span> <span>true</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>false</span><span>;</span>

		
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>renderFramebuffer<span>)</span><span>;</span>
		renderFramebuffer <span>=</span> gl<span>.</span><span>createFramebuffer</span><span>(</span><span>)</span><span>;</span>
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> renderFramebuffer<span>)</span><span>;</span>

		
		gl<span>.</span><span>deleteTexture</span><span>(</span>renderTexture<span>)</span><span>;</span>
		renderTexture <span>=</span> gl<span>.</span><span>createTexture</span><span>(</span><span>)</span><span>;</span>
		gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> renderTexture<span>)</span><span>;</span>
		gl<span>.</span><span>texParameteri</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> gl<span>.</span><span>TEXTURE_MIN_FILTER</span><span>,</span> gl<span>.</span><span>NEAREST</span><span>)</span><span>;</span>
		gl<span>.</span><span>texParameteri</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> gl<span>.</span><span>TEXTURE_MAG_FILTER</span><span>,</span> gl<span>.</span><span>NEAREST</span><span>)</span><span>;</span>
		gl<span>.</span><span>texParameteri</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> gl<span>.</span><span>TEXTURE_WRAP_S</span><span>,</span> gl<span>.</span><span>CLAMP_TO_EDGE</span><span>)</span><span>;</span>
		gl<span>.</span><span>texParameteri</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> gl<span>.</span><span>TEXTURE_WRAP_T</span><span>,</span> gl<span>.</span><span>CLAMP_TO_EDGE</span><span>)</span><span>;</span>
		gl<span>.</span><span>texImage2D</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> <span>0</span><span>,</span> gl<span>.</span><span>RGBA</span><span>,</span> canvas<span>.</span>width <span>/</span> resDiv<span>,</span> canvas<span>.</span>height <span>/</span> resDiv<span>,</span> <span>0</span><span>,</span> gl<span>.</span><span>RGBA</span><span>,</span> gl<span>.</span><span>UNSIGNED_BYTE</span><span>,</span> <span>null</span><span>)</span><span>;</span>
		gl<span>.</span><span>framebufferTexture2D</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> gl<span>.</span><span>COLOR_ATTACHMENT0</span><span>,</span> gl<span>.</span><span>TEXTURE_2D</span><span>,</span> renderTexture<span>,</span> <span>0</span><span>)</span><span>;</span>
		buffersInitialized <span>=</span> <span>true</span><span>;</span>

		
		<span>let</span> base <span>=</span> <span>await</span> <span>fetch</span><span>(</span><span>&#34;img/kiwi4by3.svg&#34;</span><span>)</span><span>;</span>
		<span>let</span> baseBlob <span>=</span> <span>await</span> base<span>.</span><span>blob</span><span>(</span><span>)</span><span>;</span>
		<span>let</span> baseImage <span>=</span> <span>await</span> <span>loadSVGAsImage</span><span>(</span>baseBlob<span>)</span><span>;</span>
		<span>let</span> baseBitmap <span>=</span> <span>await</span> <span>createImageBitmap</span><span>(</span>baseImage<span>,</span> <span>{</span> <span>resizeWidth</span><span>:</span> canvas<span>.</span>width <span>/</span> resDiv<span>,</span> <span>resizeHeight</span><span>:</span> canvas<span>.</span>height <span>/</span> resDiv<span>,</span> <span>colorSpaceConversion</span><span>:</span> <span>&#39;none&#39;</span><span>,</span> <span>resizeQuality</span><span>:</span> <span>&#34;high&#34;</span> <span>}</span><span>)</span><span>;</span>

		ctx<span>.</span>tex<span>.</span>sdr <span>=</span> util<span>.</span><span>setupTexture</span><span>(</span>gl<span>,</span> <span>null</span><span>,</span> <span>null</span><span>,</span> ctx<span>.</span>tex<span>.</span>sdr<span>,</span> gl<span>.</span><span>NEAREST</span><span>,</span> baseBitmap<span>,</span> <span>4</span><span>)</span><span>;</span>

		baseBitmap<span>.</span><span>close</span><span>(</span><span>)</span><span>;</span>

		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>true</span><span>;</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;none&#34;</span><span>;</span>
	<span>}</span>

	<span>async</span> <span>function</span> <span>redraw</span><span>(</span><span>)</span> <span>{</span>
		<span>if</span> <span>(</span><span>!</span>buffersInitialized<span>)</span>
			<span>await</span> <span>setupTextureBuffers</span><span>(</span><span>)</span><span>;</span>
		<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>initComplete<span>)</span>
			<span>return</span><span>;</span>

		
		gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width <span>/</span> resDiv<span>,</span> canvas<span>.</span>height <span>/</span> resDiv<span>)</span><span>;</span>
		<span>if</span> <span>(</span><span>!</span>renderFramebuffer<span>)</span> <span>return</span><span>;</span>
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> renderFramebuffer<span>)</span><span>;</span>
		gl<span>.</span><span>clear</span><span>(</span>gl<span>.</span><span>COLOR_BUFFER_BIT</span><span>)</span><span>;</span>
		
		
		gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>kiwi<span>.</span>handle<span>)</span><span>;</span>
		
		
		gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>sdr<span>)</span><span>;</span>
		gl<span>.</span><span>texParameteri</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> gl<span>.</span><span>TEXTURE_MIN_FILTER</span><span>,</span> ctx<span>.</span>mode <span>==</span> <span>&#34;nearest&#34;</span> <span>?</span> gl<span>.</span><span>NEAREST</span> <span>:</span> gl<span>.</span><span>LINEAR</span><span>)</span><span>;</span>
		gl<span>.</span><span>texParameteri</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> gl<span>.</span><span>TEXTURE_MAG_FILTER</span><span>,</span> ctx<span>.</span>mode <span>==</span> <span>&#34;nearest&#34;</span> <span>?</span> gl<span>.</span><span>NEAREST</span> <span>:</span> gl<span>.</span><span>LINEAR</span><span>)</span><span>;</span>

		
		<span>let</span> radiusSwitch <span>=</span> ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked <span>?</span> radius <span>:</span> <span>0.0</span><span>;</span>
		<span>let</span> speed <span>=</span> <span>(</span>performance<span>.</span><span>now</span><span>(</span><span>)</span> <span>/</span> <span>10000</span><span>)</span> <span>%</span> Math<span>.</span><span>PI</span> <span>*</span> <span>2</span><span>;</span>
		<span>const</span> offset <span>=</span> <span>[</span>radiusSwitch <span>*</span> Math<span>.</span><span>cos</span><span>(</span>speed<span>)</span><span>,</span> radiusSwitch <span>*</span> Math<span>.</span><span>sin</span><span>(</span>speed<span>)</span><span>]</span><span>;</span>
		
		gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>kiwi<span>.</span>uniforms<span>.</span>offset<span>,</span> offset<span>)</span><span>;</span>
		gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>kiwi<span>.</span>uniforms<span>.</span>kiwiSize<span>,</span> ui<span>.</span>rendering<span>.</span>kiwiSize<span>.</span>value<span>)</span><span>;</span>

		
		gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>

		gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> <span>null</span><span>)</span><span>;</span>
		
		
		gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>blit<span>.</span>handle<span>)</span><span>;</span>
		
		
		<span>if</span> <span>(</span><span>!</span>renderTexture<span>)</span> <span>return</span><span>;</span>
		gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> renderTexture<span>)</span><span>;</span>
		
		
		gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
	<span>}</span>

	<span>let</span> animationFrameId<span>;</span>

	
	<span>function</span> <span>nativeResize</span><span>(</span><span>)</span> <span>{</span>
		<span>const</span> <span>[</span>width<span>,</span> height<span>]</span> <span>=</span> util<span>.</span><span>getNativeSize</span><span>(</span>canvas<span>)</span><span>;</span>

		<span>if</span> <span>(</span>width <span>&amp;&amp;</span> canvas<span>.</span>width <span>!==</span> width <span>||</span> height <span>&amp;&amp;</span> canvas<span>.</span>height <span>!==</span> height<span>)</span> <span>{</span>
			canvas<span>.</span>width <span>=</span> width<span>;</span>
			canvas<span>.</span>height <span>=</span> height<span>;</span>
			gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>

			<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
			<span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
				<span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span>
	<span>}</span>

	
	<span>nativeResize</span><span>(</span><span>)</span><span>;</span>

	<span>let</span> resizePending <span>=</span> <span>false</span><span>;</span>
	window<span>.</span><span>addEventListener</span><span>(</span><span>&#39;resize&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>if</span> <span>(</span><span>!</span>resizePending<span>)</span> <span>{</span>
			resizePending <span>=</span> <span>true</span><span>;</span>
			<span>requestAnimationFrame</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
				resizePending <span>=</span> <span>false</span><span>;</span>
				<span>nativeResize</span><span>(</span><span>)</span><span>;</span>
			<span>}</span><span>)</span><span>;</span>
		<span>}</span>
	<span>}</span><span>)</span><span>;</span>

	<span>function</span> <span>renderLoop</span><span>(</span><span>)</span> <span>{</span>
		<span>if</span> <span>(</span>ctx<span>.</span>flags<span>.</span>isRendering <span>&amp;&amp;</span> ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>{</span>
			<span>redraw</span><span>(</span><span>)</span><span>;</span>
			animationFrameId <span>=</span> <span>requestAnimationFrame</span><span>(</span>renderLoop<span>)</span><span>;</span>
		<span>}</span>
	<span>}</span>

	<span>function</span> <span>startRendering</span><span>(</span><span>)</span> <span>{</span>
		
		ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>true</span><span>;</span>
		<span>renderLoop</span><span>(</span><span>)</span><span>;</span>
	<span>}</span>

	<span>function</span> <span>stopRendering</span><span>(</span><span>)</span> <span>{</span>
		
		ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>false</span><span>;</span>
		<span>cancelAnimationFrame</span><span>(</span>animationFrameId<span>)</span><span>;</span>
		
		gl<span>.</span><span>finish</span><span>(</span><span>)</span><span>;</span>

		
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>sdr<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>sdr <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>renderTexture<span>)</span><span>;</span> renderTexture <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>renderFramebuffer<span>)</span><span>;</span> renderFramebuffer <span>=</span> <span>null</span><span>;</span>
		buffersInitialized <span>=</span> <span>false</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>false</span><span>;</span>
	<span>}</span>

	<span>function</span> <span>handleIntersection</span><span>(</span><span>entries</span><span>)</span> <span>{</span>
		entries<span>.</span><span>forEach</span><span>(</span><span>entry</span> <span>=&gt;</span> <span>{</span>
			<span>if</span> <span>(</span>entry<span>.</span>isIntersecting<span>)</span> <span>{</span>
				<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>isRendering<span>)</span> <span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span> <span>else</span> <span>{</span>
				<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span>

	
	<span>let</span> observer <span>=</span> <span>new</span> <span>IntersectionObserver</span><span>(</span>handleIntersection<span>)</span><span>;</span>
	observer<span>.</span><span>observe</span><span>(</span>canvas<span>)</span><span>;</span>
<span>}</span></code></pre></details></blockquote><p>Nearest Neightbor looks pixelated, if the size is not at 100% size, which is equivalent to 1:1 pixel mapping. At 100% it moves ‚Äújittery‚Äù, as it ‚Äúsnaps‚Äù to the nearest neighbor. Bilinear keeps things smooth, but going below 50%, especially below 25%, we get exactly the same kind of aliasing, as we would get from nearest neighbor!</p><blockquote><p>You may have noticed similar aliasing when playing YouTube Videos at a very high manually selected video resolution, but in a small window. Same thing!</p><img src="https://blog.frost.kiwi/assets/kiwis/detective.svg"/></blockquote><p>With 2 √ó 2 samples, we start skipping over color information, if the underlying pixels are smaller than half a pixel in size. Below 50% size, our bilinear interpolation starts to act like nearest neighbor interpolation. So as a result, we can shrink image in steps of 50%, without ‚Äúskipping over information‚Äù and creating aliasing. Let‚Äôs use that!</p><h2 id="downsampling" tabindex="-1">Downsampling <a href="#downsampling">#</a></h2><p>One fundamental thing thing you can do in post-processing is to shrink ‚Äúdownsample‚Äù first, perform the processing at a lower resolution and upsample again. With the idea being, that you wouldn‚Äôt notice the lowered resolution. Below is the <a href="#separable-gaussian-blur">Separable Gaussian Blur</a> again, with a variable downsample / upsample chain.</p><p>Each increase of <code>downSample</code> adds a 50% scale step. Let‚Äôs visualize the framebuffers in play, as it gets quite complex. Here is an example of a square 1024 px¬≤ image, a <code>downSample</code> of <code>2</code> and our two pass separable Gaussian blur.</p><figure><img src="https://blog.frost.kiwi/dual-kawase/img/framebuffer.svg" alt="Downsample and Blur Framebuffers"/><figcaption>Framebuffers and their sizes, as used during the downsample + blur chain</figcaption></figure><blockquote><p>One unused optimization is that the blur can read straight from the 512 px¬≤ framebuffer and output the 256 px¬≤ directly, skipping one downsample step.</p><img src="https://blog.frost.kiwi/assets/kiwis/detective.svg"/></blockquote><p>Below you have the option to skip part of the downsample or part of the upsample chain, if you have <code>downSample</code> set to higher than 1. What may not be quite obvious is why we also upsample in steps. Play around with all the dials and modes, to get a feel for what‚Äôs happening.</p><div id="WebGLBox-GaussianDownsampleBlur"><div><p><label> Scene</label> <label> Lights</label> <label> Bloom</label></p><p><label> Animate</label></p></div><div><canvas></canvas><p>‚ùå The browser killed this WebGL Context, please reload the page. If this happened as the result of a long benchmark, decrease the iteration count. On some platforms (iOS / iPad) you may have to restart the browser App completely, as the browser will temporarily refuse to allow this site to run WebGL again.</p><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" fill="transparent" r="10" stroke-width="2"></circle><rect height="7" rx="1" width="2" x="11" y="6"></rect><rect height="9" rx="1" width="2" x="11" y="11"></rect></svg></div><p><label> Normal</label> <label> Skip Down-steps</label> <label> Skip Up-steps</label></p><table><tbody><tr><td colspan="4"><p><span><strong>FPS:</strong><output id="fps">?</output>/<output id="ms">?</output>ms </span><span><strong>Resolution:</strong><output id="width">?</output>x<output id="height">?</output></span><span><strong>Texture Taps:</strong><output id="taps">?</output></span></p></td></tr><tr><td colspan="4"><code>kernelSize</code></td></tr><tr><td><code>kernelSize</code></td><td></td><td><output>7x7</output>¬†px</td><td></td></tr><tr><td colspan="4"><code>samplePosMultiplier</code></td></tr><tr><td><code>samplePosMultiplier</code></td><td></td><td><output>100</output>¬†%</td><td></td></tr><tr><td colspan="4"><code>downSample</code></td></tr><tr><td><code>downSample</code></td><td></td><td><output>0</output></td><td></td></tr><tr><td colspan="4"><code>lightBrightness</code></td></tr><tr><td><code>lightBrightness</code></td><td></td><td><output>100</output>¬†%</td><td></td></tr><tr><td colspan="4"><code>sigma</code></td></tr><tr><td><code>sigma</code></td><td></td><td>¬±<output>2.00</output>œÉ</td><td></td></tr></tbody></table></div><blockquote id="WebGLBox-GaussianDownsampleBlurDetail"><details><summary>Blur Fragment Shader <a href="https://blog.frost.kiwi/dual-kawase/shader/gaussianSeparableBlur.fs" target="_blank">gaussianSeparableBlur.fs</a></summary><pre><code>
<span>precision</span> <span>highp</span> <span>float</span><span>;</span>

<span>varying</span> <span>vec2</span> uv<span>;</span>

<span>uniform</span> <span>vec2</span> frameSizeRCP<span>;</span> 
<span>uniform</span> <span>float</span> samplePosMult<span>;</span> 
<span>uniform</span> <span>float</span> sigma<span>;</span>
<span>uniform</span> <span>vec2</span> direction<span>;</span> 

<span>uniform</span> <span>float</span> bloomStrength<span>;</span> 

<span>uniform</span> <span>sampler2D</span> texture<span>;</span>

<span>const</span> <span>int</span> kernel_size <span>=</span> KERNEL_SIZE<span>;</span>

<span>float</span> <span>gaussianWeight</span><span>(</span><span>float</span> x<span>,</span> <span>float</span> sigma<span>)</span>
<span>{</span>
	
	<span>return</span> <span>exp</span><span>(</span><span>-</span><span>(</span>x <span>*</span> x<span>)</span> <span>/</span> <span>(</span><span>2.0</span> <span>*</span> sigma <span>*</span> sigma<span>)</span><span>)</span><span>;</span>
<span>}</span>

<span>void</span> <span>main</span><span>(</span><span>)</span> <span>{</span>
	
	<span>vec4</span> sum <span>=</span> <span>vec4</span><span>(</span><span>0.0</span><span>)</span><span>;</span>
	
	<span>float</span> weightSum <span>=</span> <span>0.0</span><span>;</span>
	
	
	<span>const</span> <span>int</span> size <span>=</span> <span>2</span> <span>*</span> kernel_size <span>+</span> <span>1</span><span>;</span>

	
	<span>for</span> <span>(</span><span>int</span> i <span>=</span> <span>-</span>kernel_size<span>;</span> i <span>&lt;=</span> kernel_size<span>;</span> <span>++</span>i<span>)</span> <span>{</span>
		
		<span>float</span> w <span>=</span> <span>gaussianWeight</span><span>(</span><span>float</span><span>(</span>i<span>)</span><span>,</span> sigma<span>)</span><span>;</span>
		
		
		<span>vec2</span> offset <span>=</span> <span>vec2</span><span>(</span>i<span>)</span> <span>*</span> direction <span>*</span> samplePosMult <span>*</span> frameSizeRCP<span>;</span>

		
		sum <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> offset<span>)</span> <span>*</span> w<span>;</span>
		weightSum <span>+=</span> w<span>;</span>
	<span>}</span>

	
	gl_FragColor <span>=</span> <span>(</span>sum <span>/</span> weightSum<span>)</span> <span>*</span> bloomStrength<span>;</span>
<span>}</span></code></pre></details><details><summary>WebGL Javascript <a href="https://blog.frost.kiwi/dual-kawase/js/blur/downsample.js" target="_blank">downsample.js</a></summary><pre><code><span>import</span> <span>*</span> <span>as</span> util <span>from</span> <span>&#39;../utility.js&#39;</span>



<span>export</span> <span>async</span> <span>function</span> <span>setupGaussianDownsampleBlur</span><span>(</span><span>)</span> <span>{</span>
	
	<span>const</span> WebGLBox <span>=</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-GaussianDownsampleBlur&#39;</span><span>)</span><span>;</span>
	<span>const</span> canvas <span>=</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;canvas&#39;</span><span>)</span><span>;</span>

	
	<span>const</span> radius <span>=</span> <span>0.12</span><span>;</span>

	
	<span>const</span> gl <span>=</span> canvas<span>.</span><span>getContext</span><span>(</span><span>&#39;webgl&#39;</span><span>,</span> <span>{</span>
		<span>preserveDrawingBuffer</span><span>:</span> <span>false</span><span>,</span>
		<span>antialias</span><span>:</span> <span>false</span><span>,</span>
		<span>alpha</span><span>:</span> <span>false</span><span>,</span>
	<span>}</span><span>)</span><span>;</span>

	
	<span>const</span> ctx <span>=</span> <span>{</span>
		
		<span>mode</span><span>:</span> <span>&#34;scene&#34;</span><span>,</span>
		<span>skipMode</span><span>:</span> <span>&#34;normal&#34;</span><span>,</span>
		<span>flags</span><span>:</span> <span>{</span> <span>isRendering</span><span>:</span> <span>false</span><span>,</span> <span>buffersInitialized</span><span>:</span> <span>false</span><span>,</span> <span>initComplete</span><span>:</span> <span>false</span><span>,</span> <span>benchMode</span><span>:</span> <span>false</span> <span>}</span><span>,</span>
		
		<span>tex</span><span>:</span> <span>{</span> <span>sdr</span><span>:</span> <span>null</span><span>,</span> <span>selfIllum</span><span>:</span> <span>null</span><span>,</span> <span>frame</span><span>:</span> <span>null</span><span>,</span> <span>frameFinal</span><span>:</span> <span>null</span><span>,</span> <span>down</span><span>:</span> <span>[</span><span>]</span><span>,</span> <span>intermediate</span><span>:</span> <span>[</span><span>]</span><span>,</span> <span>nativeIntermediate</span><span>:</span> <span>null</span> <span>}</span><span>,</span>
		
		<span>fb</span><span>:</span> <span>{</span> <span>scene</span><span>:</span> <span>null</span><span>,</span> <span>final</span><span>:</span> <span>null</span><span>,</span> <span>down</span><span>:</span> <span>[</span><span>]</span><span>,</span> <span>intermediate</span><span>:</span> <span>[</span><span>]</span><span>,</span> <span>nativeIntermediate</span><span>:</span> <span>null</span> <span>}</span><span>,</span>
		
		<span>shd</span><span>:</span> <span>{</span>
			<span>scene</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>offset</span><span>:</span> <span>null</span><span>,</span> <span>radius</span><span>:</span> <span>null</span> <span>}</span> <span>}</span><span>,</span>
			<span>passthrough</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span> <span>}</span><span>,</span>
			<span>blur</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>frameSizeRCP</span><span>:</span> <span>null</span><span>,</span> <span>samplePosMult</span><span>:</span> <span>null</span><span>,</span> <span>sigma</span><span>:</span> <span>null</span><span>,</span> <span>bloomStrength</span><span>:</span> <span>null</span> <span>}</span> <span>}</span><span>,</span>
			<span>bloom</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>offset</span><span>:</span> <span>null</span><span>,</span> <span>radius</span><span>:</span> <span>null</span><span>,</span> <span>texture</span><span>:</span> <span>null</span><span>,</span> <span>textureAdd</span><span>:</span> <span>null</span> <span>}</span> <span>}</span>
		<span>}</span>
	<span>}</span><span>;</span>

	
	<span>const</span> ui <span>=</span> <span>{</span>
		<span>display</span><span>:</span> <span>{</span>
			<span>spinner</span><span>:</span> canvas<span>.</span>parentElement<span>.</span><span>querySelector</span><span>(</span><span>&#39;svg&#39;</span><span>,</span> canvas<span>.</span>parentElement<span>)</span><span>,</span>
			<span>contextLoss</span><span>:</span> canvas<span>.</span>parentElement<span>.</span><span>querySelector</span><span>(</span><span>&#39;div&#39;</span><span>,</span> canvas<span>.</span>parentElement<span>)</span><span>,</span>
			<span>fps</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#fps&#39;</span><span>)</span><span>,</span>
			<span>ms</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#ms&#39;</span><span>)</span><span>,</span>
			<span>width</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#width&#39;</span><span>)</span><span>,</span>
			<span>height</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#height&#39;</span><span>)</span><span>,</span>
			<span>tapsCount</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#taps&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>blur</span><span>:</span> <span>{</span>
			<span>kernelSize</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#sizeRange&#39;</span><span>)</span><span>,</span>
			<span>sigma</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#sigmaRange&#39;</span><span>)</span><span>,</span>
			<span>samplePos</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#samplePosRange&#39;</span><span>)</span><span>,</span>
			<span>samplePosReset</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#samplePosRangeReset&#39;</span><span>)</span><span>,</span>
			<span>downSample</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#downSampleRange&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>rendering</span><span>:</span> <span>{</span>
			<span>animate</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#animateCheck&#39;</span><span>)</span><span>,</span>
			<span>modes</span><span>:</span> WebGLBox<span>.</span><span>querySelectorAll</span><span>(</span><span>&#39;input[type=&#34;radio&#34;]&#39;</span><span>)</span><span>,</span>
			<span>skipModes</span><span>:</span> WebGLBox<span>.</span><span>querySelectorAll</span><span>(</span><span>&#39;input[name=&#34;skipMode&#34;]&#39;</span><span>)</span><span>,</span>
			<span>lightBrightness</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#lightBrightness&#39;</span><span>)</span><span>,</span>
			<span>lightBrightnessReset</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#lightBrightnessReset&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>benchmark</span><span>:</span> <span>{</span>
			<span>button</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#benchmark&#39;</span><span>)</span><span>,</span>
			<span>label</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#benchmarkLabel&#39;</span><span>)</span><span>,</span>
			<span>iterOut</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterOut&#39;</span><span>)</span><span>,</span>
			<span>renderer</span><span>:</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-GaussianDownsampleBlurDetail&#39;</span><span>)</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;#renderer&#39;</span><span>)</span><span>,</span>
			<span>skipMode</span><span>:</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-GaussianDownsampleBlurDetail&#39;</span><span>)</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;#skipMode&#39;</span><span>)</span><span>,</span>
			<span>iterTime</span><span>:</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-GaussianDownsampleBlurDetail&#39;</span><span>)</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterTime&#39;</span><span>)</span><span>,</span>
			<span>tapsCount</span><span>:</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-GaussianDownsampleBlurDetail&#39;</span><span>)</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;#tapsCountBench&#39;</span><span>)</span><span>,</span>
			<span>iterations</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterations&#39;</span><span>)</span>
		<span>}</span>
	<span>}</span><span>;</span>

	
	<span>const</span> circleAnimation <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/circleAnimation.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> simpleTexture <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/simpleTexture.fs&#34;</span><span>)</span><span>;</span>
	<span>const</span> bloomVert <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/bloom.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> bloomFrag <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/bloom.fs&#34;</span><span>)</span><span>;</span>
	<span>const</span> simpleQuad <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/simpleQuad.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> gaussianBlurFrag <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/gaussianBlurSeparable.fs&#34;</span><span>)</span><span>;</span>

	
	ui<span>.</span>blur<span>.</span>kernelSize<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>
	ui<span>.</span>blur<span>.</span>sigma<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>
	ui<span>.</span>blur<span>.</span>samplePos<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>
	ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>
	ui<span>.</span>blur<span>.</span>downSample<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> 
		<span>updateSkipModeControls</span><span>(</span><span>)</span><span>;</span>
		<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> 
	<span>}</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>animate<span>.</span><span>addEventListener</span><span>(</span><span>&#34;change&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
			<span>startRendering</span><span>(</span><span>)</span><span>;</span>
		<span>else</span> <span>{</span>
			ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
			ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
			ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>false</span><span>;</span>
			<span>redraw</span><span>(</span><span>)</span>
		<span>}</span>
	<span>}</span><span>)</span><span>;</span>

	canvas<span>.</span><span>addEventListener</span><span>(</span><span>&#34;webglcontextlost&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ui<span>.</span>display<span>.</span>contextLoss<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	ui<span>.</span>blur<span>.</span>kernelSize<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>reCompileBlurShader</span><span>(</span>ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value<span>)</span><span>;</span>
		ui<span>.</span>blur<span>.</span>samplePos<span>.</span>disabled <span>=</span> ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>==</span> <span>0</span><span>;</span>
		ui<span>.</span>blur<span>.</span>samplePosReset<span>.</span>disabled <span>=</span> ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>==</span> <span>0</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>modes<span>.</span><span>forEach</span><span>(</span><span>radio</span> <span>=&gt;</span> <span>{</span>
		
		<span>if</span> <span>(</span>radio<span>.</span>name <span>===</span> <span>&#34;skipMode&#34;</span><span>)</span> <span>return</span><span>;</span>
		
		
		<span>if</span> <span>(</span>radio<span>.</span>value <span>===</span> <span>&#34;scene&#34;</span><span>)</span>
			radio<span>.</span>checked <span>=</span> <span>true</span><span>;</span>
		radio<span>.</span><span>addEventListener</span><span>(</span><span>&#39;change&#39;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
			ctx<span>.</span>mode <span>=</span> event<span>.</span>target<span>.</span>value<span>;</span>
			ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>disabled <span>=</span> ctx<span>.</span>mode <span>===</span> <span>&#34;scene&#34;</span><span>;</span>
			ui<span>.</span>rendering<span>.</span>lightBrightnessReset<span>.</span>disabled <span>=</span> ctx<span>.</span>mode <span>===</span> <span>&#34;scene&#34;</span><span>;</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>skipModes<span>.</span><span>forEach</span><span>(</span><span>radio</span> <span>=&gt;</span> <span>{</span>
		
		<span>if</span> <span>(</span>radio<span>.</span>value <span>===</span> <span>&#34;normal&#34;</span><span>)</span>
			radio<span>.</span>checked <span>=</span> <span>true</span><span>;</span>
		radio<span>.</span><span>addEventListener</span><span>(</span><span>&#39;change&#39;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
			ctx<span>.</span>skipMode <span>=</span> event<span>.</span>target<span>.</span>value<span>;</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	
	<span>function</span> <span>updateSkipModeControls</span><span>(</span><span>)</span> <span>{</span>
		<span>const</span> hasIntermediarySteps <span>=</span> ui<span>.</span>blur<span>.</span>downSample<span>.</span>value <span>&gt;</span> <span>1</span><span>;</span>
		ui<span>.</span>rendering<span>.</span>skipModes<span>.</span><span>forEach</span><span>(</span><span>radio</span> <span>=&gt;</span> <span>{</span>
			radio<span>.</span>disabled <span>=</span> <span>!</span>hasIntermediarySteps<span>;</span>
		<span>}</span><span>)</span><span>;</span>
		
		<span>if</span> <span>(</span><span>!</span>hasIntermediarySteps <span>&amp;&amp;</span> ctx<span>.</span>skipMode <span>!==</span> <span>&#34;normal&#34;</span><span>)</span> <span>{</span>
			ctx<span>.</span>skipMode <span>=</span> <span>&#34;normal&#34;</span><span>;</span>
		<span>}</span>
		
		ui<span>.</span>rendering<span>.</span>skipModes<span>.</span><span>forEach</span><span>(</span><span>radio</span> <span>=&gt;</span> <span>{</span>
			radio<span>.</span>checked <span>=</span> <span>(</span>radio<span>.</span>value <span>===</span> ctx<span>.</span>skipMode<span>)</span><span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span>

	
	<span>updateSkipModeControls</span><span>(</span><span>)</span><span>;</span>

	ui<span>.</span>benchmark<span>.</span>button<span>.</span><span>addEventListener</span><span>(</span><span>&#34;click&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ctx<span>.</span>flags<span>.</span>benchMode <span>=</span> <span>true</span><span>;</span>
		<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
		ui<span>.</span>benchmark<span>.</span>button<span>.</span>disabled <span>=</span> <span>true</span><span>;</span>

		
		<span>const</span> worker <span>=</span> <span>new</span> <span>Worker</span><span>(</span><span>&#34;./js/benchmark/downsampleBenchmark.js&#34;</span><span>,</span> <span>{</span> <span>type</span><span>:</span> <span>&#34;module&#34;</span> <span>}</span><span>)</span><span>;</span>

		
		worker<span>.</span><span>postMessage</span><span>(</span><span>{</span>
			<span>iterations</span><span>:</span> ui<span>.</span>benchmark<span>.</span>iterOut<span>.</span>value<span>,</span>
			<span>blurShaderSrc</span><span>:</span> gaussianBlurFrag<span>,</span>
			<span>kernelSize</span><span>:</span> ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value<span>,</span>
			<span>samplePos</span><span>:</span> ui<span>.</span>blur<span>.</span>samplePos<span>.</span>value<span>,</span>
			<span>sigma</span><span>:</span> ui<span>.</span>blur<span>.</span>sigma<span>.</span>value<span>,</span>
			<span>downSample</span><span>:</span> ui<span>.</span>blur<span>.</span>downSample<span>.</span>value<span>,</span>
			<span>skipMode</span><span>:</span> ctx<span>.</span>skipMode
		<span>}</span><span>)</span><span>;</span>

		
		worker<span>.</span><span>addEventListener</span><span>(</span><span>&#34;message&#34;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
			<span>if</span> <span>(</span>event<span>.</span>data<span>.</span>type <span>!==</span> <span>&#34;done&#34;</span><span>)</span> <span>return</span><span>;</span>

			ui<span>.</span>benchmark<span>.</span>label<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>benchText<span>;</span>
			ui<span>.</span>benchmark<span>.</span>tapsCount<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>tapsCount<span>;</span>
			ui<span>.</span>benchmark<span>.</span>iterTime<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>iterationText<span>;</span>
			ui<span>.</span>benchmark<span>.</span>renderer<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>renderer<span>;</span>
			ui<span>.</span>benchmark<span>.</span>skipMode<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>skipMode<span>;</span>

			worker<span>.</span><span>terminate</span><span>(</span><span>)</span><span>;</span>
			ui<span>.</span>benchmark<span>.</span>button<span>.</span>disabled <span>=</span> <span>false</span><span>;</span>
			ctx<span>.</span>flags<span>.</span>benchMode <span>=</span> <span>false</span><span>;</span>
			<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
				<span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>else</span>
				<span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	ui<span>.</span>benchmark<span>.</span>iterations<span>.</span><span>addEventListener</span><span>(</span><span>&#34;change&#34;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ui<span>.</span>benchmark<span>.</span>iterOut<span>.</span>value <span>=</span> event<span>.</span>target<span>.</span>value<span>;</span>
		ui<span>.</span>benchmark<span>.</span>label<span>.</span>textContent <span>=</span> <span>&#34;Benchmark&#34;</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>scene <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> circleAnimation<span>,</span> simpleTexture<span>,</span> <span>[</span><span>&#34;offset&#34;</span><span>,</span> <span>&#34;radius&#34;</span><span>]</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>bloom <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> bloomVert<span>,</span> bloomFrag<span>,</span> <span>[</span><span>&#34;texture&#34;</span><span>,</span> <span>&#34;textureAdd&#34;</span><span>,</span> <span>&#34;offset&#34;</span><span>,</span> <span>&#34;radius&#34;</span><span>]</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>passthrough <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> simpleQuad<span>,</span> simpleTexture<span>)</span><span>;</span>

	
	<span>function</span> <span>reCompileBlurShader</span><span>(</span><span>blurSize</span><span>)</span> <span>{</span>
		ctx<span>.</span>shd<span>.</span>blur <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> simpleQuad<span>,</span> gaussianBlurFrag<span>,</span> <span>[</span><span>&#34;frameSizeRCP&#34;</span><span>,</span> <span>&#34;samplePosMult&#34;</span><span>,</span> <span>&#34;bloomStrength&#34;</span><span>,</span> <span>&#34;sigma&#34;</span><span>,</span> <span>&#34;direction&#34;</span><span>]</span><span>,</span> <span>&#34;#define KERNEL_SIZE &#34;</span> <span>+</span> blurSize <span>+</span> <span>&#39;\n&#39;</span><span>)</span><span>;</span>
	<span>}</span>

	
	<span>reCompileBlurShader</span><span>(</span>ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value<span>)</span>

	
	util<span>.</span><span>bindUnitQuad</span><span>(</span>gl<span>)</span><span>;</span>

	<span>async</span> <span>function</span> <span>setupTextureBuffers</span><span>(</span><span>)</span> <span>{</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>buffersInitialized <span>=</span> <span>true</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>false</span><span>;</span>

		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>final<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>scene<span>,</span> ctx<span>.</span>tex<span>.</span>frame<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>final<span>,</span> ctx<span>.</span>tex<span>.</span>frameFinal<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
		
		
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>nativeIntermediate<span>)</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>nativeIntermediate<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>nativeIntermediate<span>,</span> ctx<span>.</span>tex<span>.</span>nativeIntermediate<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>

		<span>const</span> maxDown <span>=</span> ui<span>.</span>blur<span>.</span>downSample<span>.</span>max<span>;</span>
		<span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> ui<span>.</span>blur<span>.</span>downSample<span>.</span>max<span>;</span> <span>++</span>i<span>)</span> <span>{</span>
			gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>down<span>[</span>i<span>]</span><span>)</span><span>;</span>
			gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>down<span>[</span>i<span>]</span><span>)</span><span>;</span>
			gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>intermediate<span>[</span>i<span>]</span><span>)</span><span>;</span>
			gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>intermediate<span>[</span>i<span>]</span><span>)</span><span>;</span>
		<span>}</span>
		ctx<span>.</span>fb<span>.</span>down <span>=</span> <span>[</span><span>]</span><span>;</span>
		ctx<span>.</span>tex<span>.</span>down <span>=</span> <span>[</span><span>]</span><span>;</span>
		ctx<span>.</span>fb<span>.</span>intermediate <span>=</span> <span>[</span><span>]</span><span>;</span>
		ctx<span>.</span>tex<span>.</span>intermediate <span>=</span> <span>[</span><span>]</span><span>;</span>

		<span>let</span> w <span>=</span> canvas<span>.</span>width<span>,</span> h <span>=</span> canvas<span>.</span>height<span>;</span>
		<span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> maxDown<span>;</span> <span>++</span>i<span>)</span> <span>{</span>
			w <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> w <span>&gt;&gt;</span> <span>1</span><span>)</span><span>;</span>
			h <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> h <span>&gt;&gt;</span> <span>1</span><span>)</span><span>;</span>
			<span>const</span> <span>[</span>fb<span>,</span> tex<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> w<span>,</span> h<span>)</span><span>;</span>
			ctx<span>.</span>fb<span>.</span>down<span>.</span><span>push</span><span>(</span>fb<span>)</span><span>;</span>
			ctx<span>.</span>tex<span>.</span>down<span>.</span><span>push</span><span>(</span>tex<span>)</span><span>;</span>
			<span>const</span> <span>[</span>intermediateFb<span>,</span> intermediateTex<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> w<span>,</span> h<span>)</span><span>;</span>
			ctx<span>.</span>fb<span>.</span>intermediate<span>.</span><span>push</span><span>(</span>intermediateFb<span>)</span><span>;</span>
			ctx<span>.</span>tex<span>.</span>intermediate<span>.</span><span>push</span><span>(</span>intermediateTex<span>)</span><span>;</span>
		<span>}</span>

		<span>let</span> <span>[</span>base<span>,</span> selfIllum<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>
			<span>fetch</span><span>(</span><span>&#34;/dual-kawase/img/SDR_No_Sprite.png&#34;</span><span>)</span><span>,</span>
			<span>fetch</span><span>(</span><span>&#34;/dual-kawase/img/Selfillumination.png&#34;</span><span>)</span>
		<span>]</span><span>)</span><span>;</span>
		<span>let</span> <span>[</span>baseBlob<span>,</span> selfIllumBlob<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>base<span>.</span><span>blob</span><span>(</span><span>)</span><span>,</span> selfIllum<span>.</span><span>blob</span><span>(</span><span>)</span><span>]</span><span>)</span><span>;</span>
		<span>let</span> <span>[</span>baseBitmap<span>,</span> selfIllumBitmap<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>
			<span>createImageBitmap</span><span>(</span>baseBlob<span>,</span> <span>{</span> <span>colorSpaceConversion</span><span>:</span> <span>&#39;none&#39;</span><span>,</span> <span>resizeWidth</span><span>:</span> canvas<span>.</span>width <span>*</span> <span>1.12</span><span>,</span> <span>resizeHeight</span><span>:</span> canvas<span>.</span>height <span>*</span> <span>1.12</span><span>,</span> <span>resizeQuality</span><span>:</span> <span>&#34;high&#34;</span> <span>}</span><span>)</span><span>,</span>
			<span>createImageBitmap</span><span>(</span>selfIllumBlob<span>,</span> <span>{</span> <span>colorSpaceConversion</span><span>:</span> <span>&#39;none&#39;</span><span>,</span> <span>resizeWidth</span><span>:</span> canvas<span>.</span>width <span>*</span> <span>1.12</span><span>,</span> <span>resizeHeight</span><span>:</span> canvas<span>.</span>height <span>*</span> <span>1.12</span><span>,</span> <span>resizeQuality</span><span>:</span> <span>&#34;high&#34;</span> <span>}</span><span>)</span>
		<span>]</span><span>)</span><span>;</span>

		ctx<span>.</span>tex<span>.</span>sdr <span>=</span> util<span>.</span><span>setupTexture</span><span>(</span>gl<span>,</span> <span>null</span><span>,</span> <span>null</span><span>,</span> ctx<span>.</span>tex<span>.</span>sdr<span>,</span> gl<span>.</span><span>LINEAR</span><span>,</span> baseBitmap<span>)</span><span>;</span>
		ctx<span>.</span>tex<span>.</span>selfIllum <span>=</span> util<span>.</span><span>setupTexture</span><span>(</span>gl<span>,</span> <span>null</span><span>,</span> <span>null</span><span>,</span> ctx<span>.</span>tex<span>.</span>selfIllum<span>,</span> gl<span>.</span><span>LINEAR</span><span>,</span> selfIllumBitmap<span>)</span><span>;</span>

		baseBitmap<span>.</span><span>close</span><span>(</span><span>)</span><span>;</span>
		selfIllumBitmap<span>.</span><span>close</span><span>(</span><span>)</span><span>;</span>

		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>true</span><span>;</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;none&#34;</span><span>;</span>
	<span>}</span>

	
	<span>function</span> <span>performSeparableBlur</span><span>(</span><span>srcTexture<span>,</span> targetFB<span>,</span> width<span>,</span> height<span>,</span> intermediateFB<span>,</span> intermediateTex<span>,</span> bloomStrength</span><span>)</span> <span>{</span>
		gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>handle<span>)</span><span>;</span>
		
		
		gl<span>.</span><span>uniform2f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>frameSizeRCP<span>,</span> <span>1.0</span> <span>/</span> width<span>,</span> <span>1.0</span> <span>/</span> height<span>)</span><span>;</span>
		gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>samplePosMult<span>,</span> ui<span>.</span>blur<span>.</span>samplePos<span>.</span>value<span>)</span><span>;</span>
		gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>sigma<span>,</span> Math<span>.</span><span>max</span><span>(</span>ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>/</span> ui<span>.</span>blur<span>.</span>sigma<span>.</span>value<span>,</span> <span>0.001</span><span>)</span><span>)</span><span>;</span>
		gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>bloomStrength<span>,</span> bloomStrength<span>)</span><span>;</span>
		
		
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> intermediateFB<span>)</span><span>;</span>
		gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> width<span>,</span> height<span>)</span><span>;</span>
		gl<span>.</span><span>uniform2f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>direction<span>,</span> <span>1.0</span><span>,</span> <span>0.0</span><span>)</span><span>;</span> 
		gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
		gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> srcTexture<span>)</span><span>;</span>
		gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
		
		
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> targetFB<span>)</span><span>;</span>
		gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> width<span>,</span> height<span>)</span><span>;</span>
		gl<span>.</span><span>uniform2f</span><span>(</span>ctx<span>.</span>shd<span>.</span>blur<span>.</span>uniforms<span>.</span>direction<span>,</span> <span>0.0</span><span>,</span> <span>1.0</span><span>)</span><span>;</span> 
		gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
		gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> intermediateTex<span>)</span><span>;</span>
		gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
	<span>}</span>

	<span>let</span> prevNow <span>=</span> performance<span>.</span><span>now</span><span>(</span><span>)</span><span>;</span>
	<span>let</span> lastStatsUpdate <span>=</span> prevNow<span>;</span>
	<span>let</span> fpsEMA <span>=</span> <span>60</span><span>;</span>
	<span>let</span> msEMA <span>=</span> <span>16</span><span>;</span>

	<span>async</span> <span>function</span> <span>redraw</span><span>(</span><span>)</span> <span>{</span>
		<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>buffersInitialized<span>)</span>
			<span>await</span> <span>setupTextureBuffers</span><span>(</span><span>)</span><span>;</span>
		<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>initComplete<span>)</span>
			<span>return</span><span>;</span>

		
		<span>const</span> KernelSizeSide <span>=</span> ui<span>.</span>blur<span>.</span>kernelSize<span>.</span>value <span>*</span> <span>2</span> <span>+</span> <span>1</span><span>;</span>
		<span>const</span> effectiveRes <span>=</span> <span>[</span>Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> canvas<span>.</span>width <span>&gt;&gt;</span> <span>+</span>ui<span>.</span>blur<span>.</span>downSample<span>.</span>value<span>)</span><span>,</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> canvas<span>.</span>height <span>&gt;&gt;</span> <span>+</span>ui<span>.</span>blur<span>.</span>downSample<span>.</span>value<span>)</span><span>]</span><span>;</span>
		<span>const</span> tapsNewText <span>=</span> <span>(</span>effectiveRes<span>[</span><span>0</span><span>]</span> <span>*</span> effectiveRes<span>[</span><span>1</span><span>]</span> <span>*</span> KernelSizeSide <span>*</span> <span>2</span> <span>/</span> <span>1000000</span><span>)</span><span>.</span><span>toFixed</span><span>(</span><span>1</span><span>)</span> <span>+</span> <span>&#34; Million&#34;</span><span>;</span>
		ui<span>.</span>display<span>.</span>tapsCount<span>.</span>value <span>=</span> tapsNewText<span>;</span>
		ui<span>.</span>display<span>.</span>width<span>.</span>value <span>=</span> canvas<span>.</span>width<span>;</span>
		ui<span>.</span>display<span>.</span>height<span>.</span>value <span>=</span> canvas<span>.</span>height<span>;</span>

		
		<span>let</span> radiusSwitch <span>=</span> ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked <span>?</span> radius <span>:</span> <span>0.0</span><span>;</span>
		<span>let</span> speed <span>=</span> <span>(</span>performance<span>.</span><span>now</span><span>(</span><span>)</span> <span>/</span> <span>10000</span><span>)</span> <span>%</span> Math<span>.</span><span>PI</span> <span>*</span> <span>2</span><span>;</span>
		<span>const</span> offset <span>=</span> <span>[</span>radiusSwitch <span>*</span> Math<span>.</span><span>cos</span><span>(</span>speed<span>)</span><span>,</span> radiusSwitch <span>*</span> Math<span>.</span><span>sin</span><span>(</span>speed<span>)</span><span>]</span><span>;</span>
		gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>handle<span>)</span><span>;</span>
		<span>const</span> texture <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> ctx<span>.</span>tex<span>.</span>sdr <span>:</span> ctx<span>.</span>tex<span>.</span>selfIllum<span>;</span>
		gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
		gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> texture<span>)</span><span>;</span>
		gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>uniforms<span>.</span>offset<span>,</span> offset<span>)</span><span>;</span>
		gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>uniforms<span>.</span>radius<span>,</span> radiusSwitch<span>)</span><span>;</span>

		
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span>
		gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>

		
		gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>

		
		<span>const</span> levels <span>=</span> ui<span>.</span>blur<span>.</span>downSample<span>.</span>value<span>;</span>
		<span>let</span> srcTex <span>=</span> ctx<span>.</span>tex<span>.</span>frame<span>;</span>
		<span>let</span> w <span>=</span> canvas<span>.</span>width<span>,</span> h <span>=</span> canvas<span>.</span>height<span>;</span>

		<span>if</span> <span>(</span>levels <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
			<span>if</span> <span>(</span>ctx<span>.</span>skipMode <span>===</span> <span>&#34;skipDown&#34;</span><span>)</span> <span>{</span>
				
				<span>const</span> lastDownsampleFB <span>=</span> ctx<span>.</span>fb<span>.</span>down<span>[</span>levels <span>-</span> <span>1</span><span>]</span><span>;</span>
				<span>const</span> lastIntermediateFB <span>=</span> ctx<span>.</span>fb<span>.</span>intermediate<span>[</span>levels <span>-</span> <span>1</span><span>]</span><span>;</span>
				<span>const</span> lastIntermediateTex <span>=</span> ctx<span>.</span>tex<span>.</span>intermediate<span>[</span>levels <span>-</span> <span>1</span><span>]</span><span>;</span>
				
				w <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> canvas<span>.</span>width <span>&gt;&gt;</span> levels<span>)</span><span>;</span>
				h <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> canvas<span>.</span>height <span>&gt;&gt;</span> levels<span>)</span><span>;</span>
				<span>const</span> bloomStrength <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> <span>1.0</span> <span>:</span> ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>value<span>;</span>
				
				<span>performSeparableBlur</span><span>(</span>srcTex<span>,</span> lastDownsampleFB<span>,</span> w<span>,</span> h<span>,</span> lastIntermediateFB<span>,</span> lastIntermediateTex<span>,</span> bloomStrength<span>)</span><span>;</span>
				srcTex <span>=</span> ctx<span>.</span>tex<span>.</span>down<span>[</span>levels <span>-</span> <span>1</span><span>]</span><span>;</span>
			<span>}</span> <span>else</span> <span>{</span>
				
				gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>passthrough<span>.</span>handle<span>)</span><span>;</span>
				<span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> levels <span>-</span> <span>1</span><span>;</span> <span>++</span>i<span>)</span> <span>{</span>
					<span>const</span> fb <span>=</span> ctx<span>.</span>fb<span>.</span>down<span>[</span>i<span>]</span><span>;</span>
					w <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> w <span>&gt;&gt;</span> <span>1</span><span>)</span><span>;</span>
					h <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> h <span>&gt;&gt;</span> <span>1</span><span>)</span><span>;</span>

					gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> fb<span>)</span><span>;</span>
					gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> w<span>,</span> h<span>)</span><span>;</span>

					gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
					gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> srcTex<span>)</span><span>;</span>
					gl<span>.</span><span>uniform1i</span><span>(</span>gl<span>.</span><span>getUniformLocation</span><span>(</span>ctx<span>.</span>shd<span>.</span>passthrough<span>.</span>handle<span>,</span> <span>&#34;texture&#34;</span><span>)</span><span>,</span> <span>0</span><span>)</span><span>;</span>
					gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
					srcTex <span>=</span> ctx<span>.</span>tex<span>.</span>down<span>[</span>i<span>]</span><span>;</span>
				<span>}</span>

				
				<span>const</span> lastDownsampleFB <span>=</span> ctx<span>.</span>fb<span>.</span>down<span>[</span>levels <span>-</span> <span>1</span><span>]</span><span>;</span>
				<span>const</span> lastIntermediateFB <span>=</span> ctx<span>.</span>fb<span>.</span>intermediate<span>[</span>levels <span>-</span> <span>1</span><span>]</span><span>;</span>
				<span>const</span> lastIntermediateTex <span>=</span> ctx<span>.</span>tex<span>.</span>intermediate<span>[</span>levels <span>-</span> <span>1</span><span>]</span><span>;</span>
				w <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> w <span>&gt;&gt;</span> <span>1</span><span>)</span><span>;</span>
				h <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> h <span>&gt;&gt;</span> <span>1</span><span>)</span><span>;</span>
				<span>const</span> bloomStrength <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> <span>1.0</span> <span>:</span> ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>value<span>;</span>
				
				<span>performSeparableBlur</span><span>(</span>srcTex<span>,</span> lastDownsampleFB<span>,</span> w<span>,</span> h<span>,</span> lastIntermediateFB<span>,</span> lastIntermediateTex<span>,</span> bloomStrength<span>)</span><span>;</span>
				srcTex <span>=</span> ctx<span>.</span>tex<span>.</span>down<span>[</span>levels <span>-</span> <span>1</span><span>]</span><span>;</span>
			<span>}</span>
		<span>}</span> <span>else</span> <span>{</span>
			
			<span>const</span> bloomStrength <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> <span>1.0</span> <span>:</span> ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>value<span>;</span>
			
			<span>performSeparableBlur</span><span>(</span>srcTex<span>,</span> ctx<span>.</span>fb<span>.</span>final<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>,</span> ctx<span>.</span>fb<span>.</span>nativeIntermediate<span>,</span> ctx<span>.</span>tex<span>.</span>nativeIntermediate<span>,</span> bloomStrength<span>)</span><span>;</span>
			srcTex <span>=</span> ctx<span>.</span>tex<span>.</span>frameFinal<span>;</span>
		<span>}</span>

		
		<span>if</span> <span>(</span>levels <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
			<span>if</span> <span>(</span>ctx<span>.</span>skipMode <span>===</span> <span>&#34;skipUp&#34;</span><span>)</span> <span>{</span>
				
				
			<span>}</span> <span>else</span> <span>{</span>
				
				gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>passthrough<span>.</span>handle<span>)</span><span>;</span>
				<span>for</span> <span>(</span><span>let</span> i <span>=</span> levels <span>-</span> <span>2</span><span>;</span> i <span>&gt;=</span> <span>0</span><span>;</span> i<span>--</span><span>)</span> <span>{</span>
					<span>const</span> fb <span>=</span> ctx<span>.</span>fb<span>.</span>down<span>[</span>i<span>]</span><span>;</span>
					<span>let</span> upsampleW <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> canvas<span>.</span>width <span>&gt;&gt;</span> <span>(</span>i <span>+</span> <span>1</span><span>)</span><span>)</span><span>;</span>
					<span>let</span> upsampleH <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> canvas<span>.</span>height <span>&gt;&gt;</span> <span>(</span>i <span>+</span> <span>1</span><span>)</span><span>)</span><span>;</span>
					gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> fb<span>)</span><span>;</span>
					gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> upsampleW<span>,</span> upsampleH<span>)</span><span>;</span>
					gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
					gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> srcTex<span>)</span><span>;</span>
					gl<span>.</span><span>uniform1i</span><span>(</span>gl<span>.</span><span>getUniformLocation</span><span>(</span>ctx<span>.</span>shd<span>.</span>passthrough<span>.</span>handle<span>,</span> <span>&#34;texture&#34;</span><span>)</span><span>,</span> <span>0</span><span>)</span><span>;</span>
					gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
					srcTex <span>=</span> ctx<span>.</span>tex<span>.</span>down<span>[</span>i<span>]</span><span>;</span>
				<span>}</span>
			<span>}</span>
		<span>}</span>

		
		
		<span>if</span> <span>(</span><span>!</span><span>(</span>ctx<span>.</span>mode <span>==</span> <span>&#34;bloom&#34;</span> <span>&amp;&amp;</span> levels <span>==</span> <span>0</span><span>)</span><span>)</span> <span>{</span>
			<span>const</span> finalFB <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;bloom&#34;</span> <span>?</span> ctx<span>.</span>fb<span>.</span>final <span>:</span> <span>null</span><span>;</span>
			gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> finalFB<span>)</span><span>;</span>
			gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
			gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>passthrough<span>.</span>handle<span>)</span><span>;</span>
			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> srcTex<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1i</span><span>(</span>gl<span>.</span><span>getUniformLocation</span><span>(</span>ctx<span>.</span>shd<span>.</span>passthrough<span>.</span>handle<span>,</span> <span>&#34;texture&#34;</span><span>)</span><span>,</span> <span>0</span><span>)</span><span>;</span>
			gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
		<span>}</span>

		<span>if</span> <span>(</span>ctx<span>.</span>mode <span>==</span> <span>&#34;bloom&#34;</span><span>)</span> <span>{</span>
			
			gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> <span>null</span><span>)</span><span>;</span>
			gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>handle<span>)</span><span>;</span>

			gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>offset<span>,</span> offset<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>radius<span>,</span> radiusSwitch<span>)</span><span>;</span>

			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>sdr<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1i</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>texture<span>,</span> <span>0</span><span>)</span><span>;</span>

			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE1</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>frameFinal<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1i</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>textureAdd<span>,</span> <span>1</span><span>)</span><span>;</span>

			gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
		<span>}</span>

		
		gl<span>.</span><span>finish</span><span>(</span><span>)</span><span>;</span>

		<span>const</span> now <span>=</span> performance<span>.</span><span>now</span><span>(</span><span>)</span><span>;</span>
		<span>let</span> dt <span>=</span> now <span>-</span> prevNow<span>;</span>

		<span>if</span> <span>(</span>dt <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
			<span>const</span> instFPS <span>=</span> <span>1000</span> <span>/</span> dt<span>;</span>
			<span>const</span> <span>ALPHA</span> <span>=</span> <span>0.05</span><span>;</span>
			fpsEMA <span>=</span> <span>ALPHA</span> <span>*</span> instFPS <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>ALPHA</span><span>)</span> <span>*</span> fpsEMA<span>;</span>
			msEMA <span>=</span> <span>ALPHA</span> <span>*</span> dt <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>ALPHA</span><span>)</span> <span>*</span> msEMA<span>;</span>
		<span>}</span>
		prevNow <span>=</span> now<span>;</span>

		<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked <span>&amp;&amp;</span> now <span>-</span> lastStatsUpdate <span>&gt;=</span> <span>1000</span><span>)</span> <span>{</span>
			ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> fpsEMA<span>.</span><span>toFixed</span><span>(</span><span>0</span><span>)</span><span>;</span>
			ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> msEMA<span>.</span><span>toFixed</span><span>(</span><span>2</span><span>)</span><span>;</span>
			lastStatsUpdate <span>=</span> now<span>;</span>
		<span>}</span>
	<span>}</span>

	<span>let</span> animationFrameId<span>;</span>

	
	<span>function</span> <span>nativeResize</span><span>(</span><span>)</span> <span>{</span>
		<span>const</span> <span>[</span>width<span>,</span> height<span>]</span> <span>=</span> util<span>.</span><span>getNativeSize</span><span>(</span>canvas<span>)</span><span>;</span>

		<span>if</span> <span>(</span>width <span>&amp;&amp;</span> canvas<span>.</span>width <span>!==</span> width <span>||</span> height <span>&amp;&amp;</span> canvas<span>.</span>height <span>!==</span> height<span>)</span> <span>{</span>
			canvas<span>.</span>width <span>=</span> width<span>;</span>
			canvas<span>.</span>height <span>=</span> height<span>;</span>

			<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>benchMode<span>)</span> <span>{</span>
				<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
				<span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
				<span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span>
	<span>}</span>

	
	<span>nativeResize</span><span>(</span><span>)</span><span>;</span>

	<span>let</span> resizePending <span>=</span> <span>false</span><span>;</span>
	window<span>.</span><span>addEventListener</span><span>(</span><span>&#39;resize&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>if</span> <span>(</span><span>!</span>resizePending<span>)</span> <span>{</span>
			resizePending <span>=</span> <span>true</span><span>;</span>
			<span>requestAnimationFrame</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
				resizePending <span>=</span> <span>false</span><span>;</span>
				<span>nativeResize</span><span>(</span><span>)</span><span>;</span>
			<span>}</span><span>)</span><span>;</span>
		<span>}</span>
	<span>}</span><span>)</span><span>;</span>

	<span>function</span> <span>renderLoop</span><span>(</span><span>)</span> <span>{</span>
		<span>if</span> <span>(</span>ctx<span>.</span>flags<span>.</span>isRendering <span>&amp;&amp;</span> ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>{</span>
			<span>redraw</span><span>(</span><span>)</span><span>;</span>
			animationFrameId <span>=</span> <span>requestAnimationFrame</span><span>(</span>renderLoop<span>)</span><span>;</span>
		<span>}</span>
	<span>}</span>

	<span>function</span> <span>startRendering</span><span>(</span><span>)</span> <span>{</span>
		
		ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>true</span><span>;</span>
		<span>renderLoop</span><span>(</span><span>)</span><span>;</span>
	<span>}</span>

	<span>function</span> <span>stopRendering</span><span>(</span><span>)</span> <span>{</span>
		
		ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>false</span><span>;</span>
		<span>cancelAnimationFrame</span><span>(</span>animationFrameId<span>)</span><span>;</span>
		
		gl<span>.</span><span>finish</span><span>(</span><span>)</span><span>;</span>

		
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>sdr<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>sdr <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>selfIllum<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>selfIllum <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>frame<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>frame <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>frameFinal<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>frameFinal <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>scene <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>final<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>final <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>nativeIntermediate<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>nativeIntermediate <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>nativeIntermediate<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>nativeIntermediate <span>=</span> <span>null</span><span>;</span>
		<span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> ui<span>.</span>blur<span>.</span>downSample<span>.</span>max<span>;</span> <span>++</span>i<span>)</span> <span>{</span>
			gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>down<span>[</span>i<span>]</span><span>)</span><span>;</span>
			gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>down<span>[</span>i<span>]</span><span>)</span><span>;</span>
			gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>intermediate<span>[</span>i<span>]</span><span>)</span><span>;</span>
			gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>intermediate<span>[</span>i<span>]</span><span>)</span><span>;</span>
		<span>}</span>
		ctx<span>.</span>tex<span>.</span>down <span>=</span> <span>[</span><span>]</span><span>;</span>
		ctx<span>.</span>fb<span>.</span>down <span>=</span> <span>[</span><span>]</span><span>;</span>
		ctx<span>.</span>tex<span>.</span>intermediate <span>=</span> <span>[</span><span>]</span><span>;</span>
		ctx<span>.</span>fb<span>.</span>intermediate <span>=</span> <span>[</span><span>]</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>buffersInitialized <span>=</span> <span>false</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>false</span><span>;</span>
		ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
		ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
	<span>}</span>

	<span>function</span> <span>handleIntersection</span><span>(</span><span>entries</span><span>)</span> <span>{</span>
		entries<span>.</span><span>forEach</span><span>(</span><span>entry</span> <span>=&gt;</span> <span>{</span>
			<span>if</span> <span>(</span>entry<span>.</span>isIntersecting<span>)</span> <span>{</span>
				<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>isRendering <span>&amp;&amp;</span> <span>!</span>ctx<span>.</span>flags<span>.</span>benchMode<span>)</span> <span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span> <span>else</span> <span>{</span>
				<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span>

	
	<span>let</span> observer <span>=</span> <span>new</span> <span>IntersectionObserver</span><span>(</span>handleIntersection<span>)</span><span>;</span>
	observer<span>.</span><span>observe</span><span>(</span>canvas<span>)</span><span>;</span>
<span>}</span></code></pre></details></blockquote><p>With each downsample step, our kernel covers more and more area, thus increasing the blur radius. Performance is again, a massive lift up, as we quadratically get less and less pixels to blur with each step. We get bigger blurs with the same <code>kernelSize</code> and with stronger blurs in <code>Scene</code> mode, the resolution drop is not visible.</p><p>With smaller blurs you will get ‚Äúshimmering‚Äù, as aliasing artifacts begin, even with our bilinear filtering in place. Small blurs and lower resolution don‚Äôt mix. This is <em><strong>especially</strong></em> painful in bloom mode with strong <code>lightBrightness</code>, as lights will start to ‚Äúturn on and off‚Äù as they are not resolved correctly at lower resolutions.</p><blockquote><p>There must be some kind of sweet spot of low resolution and blur strong enough to hide the the low resolution.</p><img src="https://blog.frost.kiwi/assets/kiwis/think.svg"/></blockquote><p>Skipping Downsample steps will bring obviously horrible aliasing. As for upsampling, there is a deep misunderstanding I held for years, until I read the SIGGRAPH 2014 presentation <a href="https://www.iryoku.com/next-generation-post-processing-in-call-of-duty-advanced-warfare/" target="_blank">Next Generation Post Processing in Call of Duty: Advanced Warfare</a> by graphics magician <a href="https://www.iryoku.com/" target="_blank">Jorge Jimenez</a>. One page stuck out to me:</p><figure><img src="https://blog.frost.kiwi/dual-kawase/img/jimenez2014.png" alt="Page 159 from presentation Next Generation Post Processing in Call of Duty: Advanced Warfare by Jorge Jimenez"/><figcaption>Page 159 from presentation <a href="https://www.iryoku.com/next-generation-post-processing-in-call-of-duty-advanced-warfare/" target="_blank">Next Generation Post Processing in Call of Duty: Advanced Warfare</a> by <a href="https://www.iryoku.com/" target="_blank">Jorge Jimenez</a></figcaption></figure><p>With upsampling, even when going from low res to high res in one jump, we aren‚Äôt ‚Äúskipping‚Äù any information, right? Nothing is missed. But if you look closely at the above demo with larger <code>downSample</code> chains with <code>Skip Upsample Steps</code> mode, then you will see a vague grid like artifact appearing, especially with strong blurs. <a href="#addendum">This point was expanded in the addendum</a>.</p><figure><p><img src="https://blog.frost.kiwi/dual-kawase/img/Interpolation-nearest.svg" alt="Nearest Neightbor Interpolation"/> <img src="https://blog.frost.kiwi/dual-kawase/img/Interpolation-bilinear.svg" alt="Bilinear Neightbor Interpolation"/></p><figcaption>Visualization of the bilinear interpolation (<a href="https://en.wikipedia.org/wiki/Bicubic_interpolation" target="_blank">Source</a>)</figcaption></figure><p>How to keeps things smooth when upsampling is the field of ‚ÄúReconstruction filters‚Äù. By skipping intermediate upsampling steps we are performing a 2 √ó 2 sample bilinear reconstruction of very small pixels. As a result we get the bilinear filtering characteristic pyramid shaped hot spots. <em><strong>How</strong></em> we upscale matters.</p><h3 id="smooth-blur-animation" tabindex="-1">Smooth Blur Animation <a href="#smooth-blur-animation">#</a></h3><p>One fundamental challenge with advanced blur algorithms is that it becomes challenging to get smooth blur sliders and smooth blur strength animations. Eg. with our separable gaussian blur, you could set <code>kernelSize</code> to the maximum required and adjust <code>samplePosMultiplier</code> smoothly between 0% and 100%.</p><p>With downsampling in the picture, this becomes more difficult and solutions to this are very context dependant, so we won‚Äôt dive into it. One approach you see from time to time is to simply give up on animating blur strength and blend between a blurred and unblurred version of the scene, as shown below. Visually, not very pleasing.</p><div><p><img src="https://blog.frost.kiwi/dual-kawase/img/blurSliderDemo1.png"/> <img src="https://blog.frost.kiwi/dual-kawase/img/blurSliderDemo2.png" id="overlayImage"/></p></div><h2 id="kawase-blur" tabindex="-1">Kawase Blur <a href="#kawase-blur">#</a></h2><p>Now we get away from the classical blur approaches. It‚Äôs the early 2000s and graphics programmer <a href="https://www.siliconstudio.co.jp/middleware/yebis/en/" target="_blank">Masaki Kawase</a>, today senior graphics programmer at Tokyo based company <a href="https://www.siliconstudio.co.jp/" target="_blank">Silicon Studio</a>, is programming the Xbox video game <a href="https://www.youtube.com/watch?v=JjR9VugWoHY" target="_blank">DOUBLE-S.T.E.A.L</a>, a game with vibrant post-processing effects.</p><p>During the creation of those visual effects, <a href="https://www.siliconstudio.co.jp/middleware/yebis/en/" target="_blank">Masaki Kawase</a> used a new blurring technique that he presented in the 2003 Game Developers Conference talk <a href="https://gdcvault.com/browse?keyword=Frame+Buffer+Postprocessing+Effects" target="_blank">Frame Buffer Postprocessing Effects in DOUBLE-S.T.E.A.L (Wreckless)</a>. This technique became later referred to as the ‚ÄúKawase Blur‚Äù. Let‚Äôs take a look at it:</p><figure><p><img src="https://blog.frost.kiwi/dual-kawase/img/kawase1.png" alt="kawase blur filter pattern"/> <img src="https://blog.frost.kiwi/dual-kawase/img/kawase2.png" alt="kawase blur filter pattern"/></p><figcaption>Sample placement in what later become known as the &#34;Kawase Blur&#34;</figcaption></figure><p>This technique does not have a <code>kernelSize</code> parameter anymore. It works in passes of 4 equally weighted samples, placed diagonally from the center output pixel, in the middle where the corners of 4 pixels touch. These samples get color contributions equally from their neighbors, due to bilinear filtering.</p><blockquote><p>This is new, there is no center pixel sample and, except for the required normalization, no explicit weights! The weighting happens as a result of bilinear filtering.</p><img src="https://blog.frost.kiwi/assets/kiwis/teach.svg"/></blockquote><p>After a pass is complete, that pass is used as the input to the next pass, where the outer 4 diagonal samples increase in distance by one pixel length. With each pass, this distance grows. Two framebuffers are required for this, which switch between being input and output between passes. This setup is often called ‚Äúping-ponging‚Äù.</p><div id="WebGLBox-KawaseBlur"><div><p><label> Scene</label> <label> Lights</label> <label> Bloom</label></p><p><label> Animate</label></p></div><div><canvas></canvas><p>L The browser killed this WebGL Context, please reload the page. If this happened as the result of a long benchmark, decrease the iteration count. On some platforms (iOS / iPad) you may have to restart the browser App completely, as the browser will temporarily refuse to allow this site to run WebGL again.</p><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" fill="transparent" r="10" stroke-width="2"></circle><rect height="7" rx="1" width="2" x="11" y="6"></rect><rect height="9" rx="1" width="2" x="11" y="11"></rect></svg></div><table><tbody><tr><td colspan="4"><p><span><strong>FPS:</strong><output id="fps">?</output>/<output id="ms">?</output>ms </span><span><strong>Resolution:</strong><output id="width">?</output>x<output id="height">?</output></span><span><strong>Texture Taps:</strong><output id="taps">?</output></span></p></td></tr><tr><td colspan="4"><code>iterations</code></td></tr><tr><td><code>iterations</code></td><td></td><td><output>3</output></td><td></td></tr><tr><td colspan="4"><code>samplePosMultiplier</code></td></tr><tr><td><code>samplePosMultiplier</code></td><td></td><td><output>100</output>%</td><td></td></tr><tr><td colspan="4"><code>lightBrightness</code></td></tr><tr><td><code>lightBrightness</code></td><td></td><td><output>100</output>%</td><td></td></tr></tbody></table></div><blockquote id="WebGLBox-KawaseBlurDetail"><details><summary>WebGL Fragment Shader <a href="https://blog.frost.kiwi/dual-kawase/shader/kawase.fs" target="_blank">kawase.fs</a></summary><pre><code>
<span>precision</span> <span>highp</span> <span>float</span><span>;</span>

<span>varying</span> <span>vec2</span> uv<span>;</span>

<span>uniform</span> <span>vec2</span> frameSizeRCP<span>;</span> 
<span>uniform</span> <span>float</span> samplePosMult<span>;</span> 
<span>uniform</span> <span>float</span> pixelOffset<span>;</span> 
<span>uniform</span> <span>float</span> bloomStrength<span>;</span> 

<span>uniform</span> <span>sampler2D</span> texture<span>;</span>

<span>void</span> <span>main</span><span>(</span><span>)</span> <span>{</span>
	
	<span>vec2</span> o <span>=</span> <span>vec2</span><span>(</span>pixelOffset <span>+</span> <span>0.5</span><span>)</span> <span>*</span> samplePosMult <span>*</span> frameSizeRCP<span>;</span>
	
	
	<span>vec4</span> color <span>=</span> <span>vec4</span><span>(</span><span>0.0</span><span>)</span><span>;</span>
	color <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> <span>vec2</span><span>(</span> o<span>.</span>x<span>,</span>  o<span>.</span>y<span>)</span><span>)</span><span>;</span> 
	color <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> <span>vec2</span><span>(</span><span>-</span>o<span>.</span>x<span>,</span>  o<span>.</span>y<span>)</span><span>)</span><span>;</span> 
	color <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> <span>vec2</span><span>(</span><span>-</span>o<span>.</span>x<span>,</span> <span>-</span>o<span>.</span>y<span>)</span><span>)</span><span>;</span> 
	color <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> <span>vec2</span><span>(</span> o<span>.</span>x<span>,</span> <span>-</span>o<span>.</span>y<span>)</span><span>)</span><span>;</span> 
	color <span>/=</span> <span>4.0</span><span>;</span>
	
	
	gl_FragColor <span>=</span> color <span>*</span> bloomStrength<span>;</span>
<span>}</span></code></pre></details><details><summary>WebGL Javascript <a href="https://blog.frost.kiwi/dual-kawase/js/blur/kawase.js" target="_blank">kawase.js</a></summary><pre><code><span>import</span> <span>*</span> <span>as</span> util <span>from</span> <span>&#39;../utility.js&#39;</span>

<span>export</span> <span>async</span> <span>function</span> <span>setupKawaseBlur</span><span>(</span><span>)</span> <span>{</span>
	
	<span>const</span> WebGLBox <span>=</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-KawaseBlur&#39;</span><span>)</span><span>;</span>
	<span>const</span> canvas <span>=</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;canvas&#39;</span><span>)</span><span>;</span>

	
	<span>const</span> radius <span>=</span> <span>0.12</span><span>;</span>

	
	<span>const</span> gl <span>=</span> canvas<span>.</span><span>getContext</span><span>(</span><span>&#39;webgl&#39;</span><span>,</span> <span>{</span>
		<span>preserveDrawingBuffer</span><span>:</span> <span>false</span><span>,</span>
		<span>antialias</span><span>:</span> <span>false</span><span>,</span>
		<span>alpha</span><span>:</span> <span>false</span><span>,</span>
	<span>}</span><span>)</span><span>;</span>

	
	<span>const</span> ctx <span>=</span> <span>{</span>
		
		<span>mode</span><span>:</span> <span>&#34;scene&#34;</span><span>,</span>
		<span>flags</span><span>:</span> <span>{</span> <span>isRendering</span><span>:</span> <span>false</span><span>,</span> <span>buffersInitialized</span><span>:</span> <span>false</span><span>,</span> <span>initComplete</span><span>:</span> <span>false</span><span>,</span> <span>benchMode</span><span>:</span> <span>false</span> <span>}</span><span>,</span>
		
		<span>tex</span><span>:</span> <span>{</span> <span>sdr</span><span>:</span> <span>null</span><span>,</span> <span>selfIllum</span><span>:</span> <span>null</span><span>,</span> <span>frame</span><span>:</span> <span>null</span><span>,</span> <span>frameIntermediate1</span><span>:</span> <span>null</span><span>,</span> <span>frameIntermediate2</span><span>:</span> <span>null</span><span>,</span> <span>frameFinal</span><span>:</span> <span>null</span> <span>}</span><span>,</span>
		
		<span>fb</span><span>:</span> <span>{</span> <span>scene</span><span>:</span> <span>null</span><span>,</span> <span>intermediate1</span><span>:</span> <span>null</span><span>,</span> <span>intermediate2</span><span>:</span> <span>null</span><span>,</span> <span>final</span><span>:</span> <span>null</span> <span>}</span><span>,</span>
		
		<span>shd</span><span>:</span> <span>{</span>
			<span>scene</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>offset</span><span>:</span> <span>null</span><span>,</span> <span>radius</span><span>:</span> <span>null</span> <span>}</span> <span>}</span><span>,</span>
			<span>kawase</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>frameSizeRCP</span><span>:</span> <span>null</span><span>,</span> <span>samplePosMult</span><span>:</span> <span>null</span><span>,</span> <span>bloomStrength</span><span>:</span> <span>null</span><span>,</span> <span>pixelOffset</span><span>:</span> <span>null</span> <span>}</span> <span>}</span><span>,</span>
			<span>bloom</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>offset</span><span>:</span> <span>null</span><span>,</span> <span>radius</span><span>:</span> <span>null</span><span>,</span> <span>texture</span><span>:</span> <span>null</span><span>,</span> <span>textureAdd</span><span>:</span> <span>null</span> <span>}</span> <span>}</span>
		<span>}</span>
	<span>}</span><span>;</span>

	
	<span>const</span> ui <span>=</span> <span>{</span>
		<span>display</span><span>:</span> <span>{</span>
			<span>spinner</span><span>:</span> canvas<span>.</span>parentElement<span>.</span><span>querySelector</span><span>(</span><span>&#39;svg&#39;</span><span>,</span> canvas<span>.</span>parentElement<span>)</span><span>,</span>
			<span>contextLoss</span><span>:</span> canvas<span>.</span>parentElement<span>.</span><span>querySelector</span><span>(</span><span>&#39;div&#39;</span><span>,</span> canvas<span>.</span>parentElement<span>)</span><span>,</span>
			<span>fps</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#fps&#39;</span><span>)</span><span>,</span>
			<span>ms</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#ms&#39;</span><span>)</span><span>,</span>
			<span>width</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#width&#39;</span><span>)</span><span>,</span>
			<span>height</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#height&#39;</span><span>)</span><span>,</span>
			<span>tapsCount</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#taps&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>blur</span><span>:</span> <span>{</span>
			<span>iterations</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterationsRange&#39;</span><span>)</span><span>,</span>
			<span>samplePos</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#samplePosRange&#39;</span><span>)</span><span>,</span>
			<span>samplePosReset</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#samplePosRangeReset&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>rendering</span><span>:</span> <span>{</span>
			<span>animate</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#animateCheck&#39;</span><span>)</span><span>,</span>
			<span>modes</span><span>:</span> WebGLBox<span>.</span><span>querySelectorAll</span><span>(</span><span>&#39;input[name=&#34;modeKawase&#34;]&#39;</span><span>)</span><span>,</span>
			<span>lightBrightness</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#lightBrightness&#39;</span><span>)</span><span>,</span>
			<span>lightBrightnessReset</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#lightBrightnessReset&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>benchmark</span><span>:</span> <span>{</span>
			<span>button</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#benchmark&#39;</span><span>)</span><span>,</span>
			<span>label</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#benchmarkLabel&#39;</span><span>)</span><span>,</span>
			<span>iterOut</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterOut&#39;</span><span>)</span><span>,</span>
			<span>renderer</span><span>:</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-KawaseBlurDetail&#39;</span><span>)</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;#renderer&#39;</span><span>)</span><span>,</span>
			<span>kawaseIterations</span><span>:</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-KawaseBlurDetail&#39;</span><span>)</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;#kawaseIterations&#39;</span><span>)</span><span>,</span>
			<span>iterTime</span><span>:</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-KawaseBlurDetail&#39;</span><span>)</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterTime&#39;</span><span>)</span><span>,</span>
			<span>tapsCount</span><span>:</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-KawaseBlurDetail&#39;</span><span>)</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;#tapsCountBench&#39;</span><span>)</span><span>,</span>
			<span>iterations</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterations&#39;</span><span>)</span>
		<span>}</span>
	<span>}</span><span>;</span>

	
	<span>const</span> circleAnimation <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/circleAnimation.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> simpleTexture <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/simpleTexture.fs&#34;</span><span>)</span><span>;</span>
	<span>const</span> bloomVert <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/bloom.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> bloomFrag <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/bloom.fs&#34;</span><span>)</span><span>;</span>
	<span>const</span> simpleQuad <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/simpleQuad.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> kawaseFrag <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/kawase.fs&#34;</span><span>)</span><span>;</span>

	
	ui<span>.</span>blur<span>.</span>iterations<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> 
		
		<span>const</span> iterations <span>=</span> <span>parseInt</span><span>(</span>ui<span>.</span>blur<span>.</span>iterations<span>.</span>value<span>)</span><span>;</span>
		ui<span>.</span>blur<span>.</span>samplePos<span>.</span>disabled <span>=</span> iterations <span>===</span> <span>0</span><span>;</span>
		ui<span>.</span>blur<span>.</span>samplePosReset<span>.</span>disabled <span>=</span> iterations <span>===</span> <span>0</span><span>;</span>
		<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> 
	<span>}</span><span>)</span><span>;</span>
	ui<span>.</span>blur<span>.</span>samplePos<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>
	ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>animate<span>.</span><span>addEventListener</span><span>(</span><span>&#34;change&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
			<span>startRendering</span><span>(</span><span>)</span><span>;</span>
		<span>else</span> <span>{</span>
			ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
			ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
			ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>false</span><span>;</span>
			<span>redraw</span><span>(</span><span>)</span>
		<span>}</span>
	<span>}</span><span>)</span><span>;</span>

	canvas<span>.</span><span>addEventListener</span><span>(</span><span>&#34;webglcontextlost&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ui<span>.</span>display<span>.</span>contextLoss<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>modes<span>.</span><span>forEach</span><span>(</span><span>radio</span> <span>=&gt;</span> <span>{</span>
		
		<span>if</span> <span>(</span>radio<span>.</span>value <span>===</span> <span>&#34;scene&#34;</span><span>)</span>
			radio<span>.</span>checked <span>=</span> <span>true</span><span>;</span>
		radio<span>.</span><span>addEventListener</span><span>(</span><span>&#39;change&#39;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
			ctx<span>.</span>mode <span>=</span> event<span>.</span>target<span>.</span>value<span>;</span>
			ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>disabled <span>=</span> ctx<span>.</span>mode <span>===</span> <span>&#34;scene&#34;</span><span>;</span>
			ui<span>.</span>rendering<span>.</span>lightBrightnessReset<span>.</span>disabled <span>=</span> ctx<span>.</span>mode <span>===</span> <span>&#34;scene&#34;</span><span>;</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	ui<span>.</span>benchmark<span>.</span>button<span>.</span><span>addEventListener</span><span>(</span><span>&#34;click&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ctx<span>.</span>flags<span>.</span>benchMode <span>=</span> <span>true</span><span>;</span>
		<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
		ui<span>.</span>benchmark<span>.</span>button<span>.</span>disabled <span>=</span> <span>true</span><span>;</span>

		
		<span>const</span> worker <span>=</span> <span>new</span> <span>Worker</span><span>(</span><span>&#34;./js/benchmark/kawaseBenchmark.js&#34;</span><span>,</span> <span>{</span> <span>type</span><span>:</span> <span>&#34;module&#34;</span> <span>}</span><span>)</span><span>;</span>

		
		worker<span>.</span><span>postMessage</span><span>(</span><span>{</span>
			<span>iterations</span><span>:</span> ui<span>.</span>benchmark<span>.</span>iterOut<span>.</span>value<span>,</span>
			<span>kawaseShaderSrc</span><span>:</span> kawaseFrag<span>,</span>
			<span>kawaseIterations</span><span>:</span> ui<span>.</span>blur<span>.</span>iterations<span>.</span>value<span>,</span>
			<span>samplePos</span><span>:</span> ui<span>.</span>blur<span>.</span>samplePos<span>.</span>value
		<span>}</span><span>)</span><span>;</span>

		
		worker<span>.</span><span>addEventListener</span><span>(</span><span>&#34;message&#34;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
			<span>if</span> <span>(</span>event<span>.</span>data<span>.</span>type <span>!==</span> <span>&#34;done&#34;</span><span>)</span> <span>return</span><span>;</span>

			ui<span>.</span>benchmark<span>.</span>label<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>benchText<span>;</span>
			ui<span>.</span>benchmark<span>.</span>tapsCount<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>tapsCount<span>;</span>
			ui<span>.</span>benchmark<span>.</span>iterTime<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>iterationText<span>;</span>
			ui<span>.</span>benchmark<span>.</span>renderer<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>renderer<span>;</span>
			ui<span>.</span>benchmark<span>.</span>kawaseIterations<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>kawaseIterations<span>;</span>

			worker<span>.</span><span>terminate</span><span>(</span><span>)</span><span>;</span>
			ui<span>.</span>benchmark<span>.</span>button<span>.</span>disabled <span>=</span> <span>false</span><span>;</span>
			ctx<span>.</span>flags<span>.</span>benchMode <span>=</span> <span>false</span><span>;</span>
			<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
				<span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>else</span>
				<span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	ui<span>.</span>benchmark<span>.</span>iterations<span>.</span><span>addEventListener</span><span>(</span><span>&#34;change&#34;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ui<span>.</span>benchmark<span>.</span>iterOut<span>.</span>value <span>=</span> event<span>.</span>target<span>.</span>value<span>;</span>
		ui<span>.</span>benchmark<span>.</span>label<span>.</span>textContent <span>=</span> <span>&#34;Benchmark&#34;</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>scene <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> circleAnimation<span>,</span> simpleTexture<span>,</span> <span>[</span><span>&#34;offset&#34;</span><span>,</span> <span>&#34;radius&#34;</span><span>]</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>bloom <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> bloomVert<span>,</span> bloomFrag<span>,</span> <span>[</span><span>&#34;texture&#34;</span><span>,</span> <span>&#34;textureAdd&#34;</span><span>,</span> <span>&#34;offset&#34;</span><span>,</span> <span>&#34;radius&#34;</span><span>]</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>kawase <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> simpleQuad<span>,</span> kawaseFrag<span>,</span> <span>[</span><span>&#34;frameSizeRCP&#34;</span><span>,</span> <span>&#34;samplePosMult&#34;</span><span>,</span> <span>&#34;pixelOffset&#34;</span><span>,</span> <span>&#34;bloomStrength&#34;</span><span>]</span><span>)</span><span>;</span>

	
	util<span>.</span><span>bindUnitQuad</span><span>(</span>gl<span>)</span><span>;</span>

	<span>async</span> <span>function</span> <span>setupTextureBuffers</span><span>(</span><span>)</span> <span>{</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>buffersInitialized <span>=</span> <span>true</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>false</span><span>;</span>

		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>intermediate1<span>)</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>intermediate2<span>)</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>final<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>scene<span>,</span> ctx<span>.</span>tex<span>.</span>frame<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>intermediate1<span>,</span> ctx<span>.</span>tex<span>.</span>frameIntermediate1<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>intermediate2<span>,</span> ctx<span>.</span>tex<span>.</span>frameIntermediate2<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>final<span>,</span> ctx<span>.</span>tex<span>.</span>frameFinal<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>

		
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> ctx<span>.</span>fb<span>.</span>intermediate1<span>)</span><span>;</span>
		gl<span>.</span><span>clearColor</span><span>(</span><span>0.0</span><span>,</span> <span>0.0</span><span>,</span> <span>0.0</span><span>,</span> <span>1.0</span><span>)</span><span>;</span>
		gl<span>.</span><span>clear</span><span>(</span>gl<span>.</span><span>COLOR_BUFFER_BIT</span><span>)</span><span>;</span>
		
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> ctx<span>.</span>fb<span>.</span>intermediate2<span>)</span><span>;</span>
		gl<span>.</span><span>clearColor</span><span>(</span><span>0.0</span><span>,</span> <span>0.0</span><span>,</span> <span>0.0</span><span>,</span> <span>1.0</span><span>)</span><span>;</span>
		gl<span>.</span><span>clear</span><span>(</span>gl<span>.</span><span>COLOR_BUFFER_BIT</span><span>)</span><span>;</span>

		<span>let</span> <span>[</span>base<span>,</span> selfIllum<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>
			<span>fetch</span><span>(</span><span>&#34;/dual-kawase/img/SDR_No_Sprite.png&#34;</span><span>)</span><span>,</span>
			<span>fetch</span><span>(</span><span>&#34;/dual-kawase/img/Selfillumination.png&#34;</span><span>)</span>
		<span>]</span><span>)</span><span>;</span>
		<span>let</span> <span>[</span>baseBlob<span>,</span> selfIllumBlob<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>base<span>.</span><span>blob</span><span>(</span><span>)</span><span>,</span> selfIllum<span>.</span><span>blob</span><span>(</span><span>)</span><span>]</span><span>)</span><span>;</span>
		<span>let</span> <span>[</span>baseBitmap<span>,</span> selfIllumBitmap<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>
			<span>createImageBitmap</span><span>(</span>baseBlob<span>,</span> <span>{</span> <span>colorSpaceConversion</span><span>:</span> <span>&#39;none&#39;</span><span>,</span> <span>resizeWidth</span><span>:</span> canvas<span>.</span>width <span>*</span> <span>1.12</span><span>,</span> <span>resizeHeight</span><span>:</span> canvas<span>.</span>height <span>*</span> <span>1.12</span><span>,</span> <span>resizeQuality</span><span>:</span> <span>&#34;high&#34;</span> <span>}</span><span>)</span><span>,</span>
			<span>createImageBitmap</span><span>(</span>selfIllumBlob<span>,</span> <span>{</span> <span>colorSpaceConversion</span><span>:</span> <span>&#39;none&#39;</span><span>,</span> <span>resizeWidth</span><span>:</span> canvas<span>.</span>width <span>*</span> <span>1.12</span><span>,</span> <span>resizeHeight</span><span>:</span> canvas<span>.</span>height <span>*</span> <span>1.12</span><span>,</span> <span>resizeQuality</span><span>:</span> <span>&#34;high&#34;</span> <span>}</span><span>)</span>
		<span>]</span><span>)</span><span>;</span>

		ctx<span>.</span>tex<span>.</span>sdr <span>=</span> util<span>.</span><span>setupTexture</span><span>(</span>gl<span>,</span> <span>null</span><span>,</span> <span>null</span><span>,</span> ctx<span>.</span>tex<span>.</span>sdr<span>,</span> gl<span>.</span><span>LINEAR</span><span>,</span> baseBitmap<span>)</span><span>;</span>
		ctx<span>.</span>tex<span>.</span>selfIllum <span>=</span> util<span>.</span><span>setupTexture</span><span>(</span>gl<span>,</span> <span>null</span><span>,</span> <span>null</span><span>,</span> ctx<span>.</span>tex<span>.</span>selfIllum<span>,</span> gl<span>.</span><span>LINEAR</span><span>,</span> selfIllumBitmap<span>)</span><span>;</span>

		baseBitmap<span>.</span><span>close</span><span>(</span><span>)</span><span>;</span>
		selfIllumBitmap<span>.</span><span>close</span><span>(</span><span>)</span><span>;</span>

		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>true</span><span>;</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;none&#34;</span><span>;</span>
	<span>}</span>

	<span>let</span> prevNow <span>=</span> performance<span>.</span><span>now</span><span>(</span><span>)</span><span>;</span>
	<span>let</span> lastStatsUpdate <span>=</span> prevNow<span>;</span>
	<span>let</span> fpsEMA <span>=</span> <span>60</span><span>;</span>
	<span>let</span> msEMA <span>=</span> <span>16</span><span>;</span>

	<span>async</span> <span>function</span> <span>redraw</span><span>(</span><span>)</span> <span>{</span>
		<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>buffersInitialized<span>)</span>
			<span>await</span> <span>setupTextureBuffers</span><span>(</span><span>)</span><span>;</span>
		<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>initComplete<span>)</span>
			<span>return</span><span>;</span>

		
		<span>const</span> iterations <span>=</span> <span>parseInt</span><span>(</span>ui<span>.</span>blur<span>.</span>iterations<span>.</span>value<span>)</span><span>;</span>
		
		<span>const</span> samplesPerPixel <span>=</span> iterations <span>===</span> <span>0</span> <span>?</span> <span>1</span> <span>:</span> iterations <span>*</span> <span>4</span><span>;</span>
		<span>const</span> tapsNewText <span>=</span> <span>(</span>canvas<span>.</span>width <span>*</span> canvas<span>.</span>height <span>*</span> samplesPerPixel <span>/</span> <span>1000000</span><span>)</span><span>.</span><span>toFixed</span><span>(</span><span>1</span><span>)</span> <span>+</span> <span>&#34; Million&#34;</span><span>;</span>
		ui<span>.</span>display<span>.</span>tapsCount<span>.</span>value <span>=</span> tapsNewText<span>;</span>
		ui<span>.</span>display<span>.</span>width<span>.</span>value <span>=</span> canvas<span>.</span>width<span>;</span>
		ui<span>.</span>display<span>.</span>height<span>.</span>value <span>=</span> canvas<span>.</span>height<span>;</span>

		
		<span>let</span> radiusSwitch <span>=</span> ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked <span>?</span> radius <span>:</span> <span>0.0</span><span>;</span>
		<span>let</span> speed <span>=</span> <span>(</span>performance<span>.</span><span>now</span><span>(</span><span>)</span> <span>/</span> <span>10000</span><span>)</span> <span>%</span> Math<span>.</span><span>PI</span> <span>*</span> <span>2</span><span>;</span>
		<span>const</span> offset <span>=</span> <span>[</span>radiusSwitch <span>*</span> Math<span>.</span><span>cos</span><span>(</span>speed<span>)</span><span>,</span> radiusSwitch <span>*</span> Math<span>.</span><span>sin</span><span>(</span>speed<span>)</span><span>]</span><span>;</span>
		gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>handle<span>)</span><span>;</span>
		<span>const</span> texture <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> ctx<span>.</span>tex<span>.</span>sdr <span>:</span> ctx<span>.</span>tex<span>.</span>selfIllum<span>;</span>
		gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
		gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> texture<span>)</span><span>;</span>
		gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>uniforms<span>.</span>offset<span>,</span> offset<span>)</span><span>;</span>
		gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>uniforms<span>.</span>radius<span>,</span> radiusSwitch<span>)</span><span>;</span>

		
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span>
		gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>

		
		gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>

		
		<span>if</span> <span>(</span>iterations <span>===</span> <span>0</span><span>)</span> <span>{</span>
			
			<span>const</span> finalFB <span>=</span> ctx<span>.</span>mode <span>===</span> <span>&#34;bloom&#34;</span> <span>?</span> ctx<span>.</span>fb<span>.</span>final <span>:</span> <span>null</span><span>;</span> 
			gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> finalFB<span>)</span><span>;</span>
			gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
			
			
			gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>kawase<span>.</span>handle<span>)</span><span>;</span>
			gl<span>.</span><span>uniform2f</span><span>(</span>ctx<span>.</span>shd<span>.</span>kawase<span>.</span>uniforms<span>.</span>frameSizeRCP<span>,</span> <span>1.0</span> <span>/</span> canvas<span>.</span>width<span>,</span> <span>1.0</span> <span>/</span> canvas<span>.</span>height<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>kawase<span>.</span>uniforms<span>.</span>samplePosMult<span>,</span> <span>0.0</span><span>)</span><span>;</span> 
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>kawase<span>.</span>uniforms<span>.</span>pixelOffset<span>,</span> <span>0.0</span><span>)</span><span>;</span> 
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>kawase<span>.</span>uniforms<span>.</span>bloomStrength<span>,</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> <span>1.0</span> <span>:</span> ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>value<span>)</span><span>;</span>
			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>frame<span>)</span><span>;</span>
			gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
		<span>}</span> <span>else</span> <span>{</span>
			
			gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>kawase<span>.</span>handle<span>)</span><span>;</span>
			gl<span>.</span><span>uniform2f</span><span>(</span>ctx<span>.</span>shd<span>.</span>kawase<span>.</span>uniforms<span>.</span>frameSizeRCP<span>,</span> <span>1.0</span> <span>/</span> canvas<span>.</span>width<span>,</span> <span>1.0</span> <span>/</span> canvas<span>.</span>height<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>kawase<span>.</span>uniforms<span>.</span>samplePosMult<span>,</span> ui<span>.</span>blur<span>.</span>samplePos<span>.</span>value<span>)</span><span>;</span>
			
			

			<span>let</span> currentInputTex <span>=</span> ctx<span>.</span>tex<span>.</span>frame<span>;</span>
			<span>let</span> currentInputFB <span>=</span> ctx<span>.</span>fb<span>.</span>scene<span>;</span>
			
			<span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> iterations<span>;</span> i<span>++</span><span>)</span> <span>{</span>
			
			<span>let</span> outputFB<span>,</span> outputTex<span>;</span>
			<span>if</span> <span>(</span>i <span>===</span> iterations <span>-</span> <span>1</span><span>)</span> <span>{</span>
				
				outputFB <span>=</span> ctx<span>.</span>mode <span>===</span> <span>&#34;bloom&#34;</span> <span>?</span> ctx<span>.</span>fb<span>.</span>final <span>:</span> <span>null</span><span>;</span> 
			<span>}</span> <span>else</span> <span>{</span>
				
				<span>if</span> <span>(</span>i <span>%</span> <span>2</span> <span>===</span> <span>0</span><span>)</span> <span>{</span>
					outputFB <span>=</span> ctx<span>.</span>fb<span>.</span>intermediate1<span>;</span>
					outputTex <span>=</span> ctx<span>.</span>tex<span>.</span>frameIntermediate1<span>;</span>
				<span>}</span> <span>else</span> <span>{</span>
					outputFB <span>=</span> ctx<span>.</span>fb<span>.</span>intermediate2<span>;</span>
					outputTex <span>=</span> ctx<span>.</span>tex<span>.</span>frameIntermediate2<span>;</span>
				<span>}</span>
			<span>}</span>

			
			gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> outputFB<span>)</span><span>;</span>
			gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>

			
			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> currentInputTex<span>)</span><span>;</span>

			
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>kawase<span>.</span>uniforms<span>.</span>pixelOffset<span>,</span> i<span>)</span><span>;</span>

			
			<span>const</span> finalBrightness <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> <span>1.0</span> <span>:</span> ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>value<span>;</span>
			<span>const</span> distributedBrightness <span>=</span> Math<span>.</span><span>pow</span><span>(</span>finalBrightness<span>,</span> <span>1.0</span> <span>/</span> iterations<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>kawase<span>.</span>uniforms<span>.</span>bloomStrength<span>,</span> distributedBrightness<span>)</span><span>;</span>

			
			gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>

			
			<span>if</span> <span>(</span>i <span>&lt;</span> iterations <span>-</span> <span>1</span><span>)</span> <span>{</span>
				<span>if</span> <span>(</span>i <span>%</span> <span>2</span> <span>===</span> <span>0</span><span>)</span> <span>{</span>
					currentInputTex <span>=</span> ctx<span>.</span>tex<span>.</span>frameIntermediate1<span>;</span>
				<span>}</span> <span>else</span> <span>{</span>
					currentInputTex <span>=</span> ctx<span>.</span>tex<span>.</span>frameIntermediate2<span>;</span>
				<span>}</span>
			<span>}</span>
		<span>}</span>
		<span>}</span>

		<span>if</span> <span>(</span>ctx<span>.</span>mode <span>==</span> <span>&#34;bloom&#34;</span><span>)</span> <span>{</span>
			
			gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> <span>null</span><span>)</span><span>;</span>
			gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>handle<span>)</span><span>;</span>

			gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>offset<span>,</span> offset<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>radius<span>,</span> radiusSwitch<span>)</span><span>;</span>

			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>sdr<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1i</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>texture<span>,</span> <span>0</span><span>)</span><span>;</span>

			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE1</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>frameFinal<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1i</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>textureAdd<span>,</span> <span>1</span><span>)</span><span>;</span>

			gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
		<span>}</span>

		
		gl<span>.</span><span>finish</span><span>(</span><span>)</span><span>;</span>

		<span>const</span> now <span>=</span> performance<span>.</span><span>now</span><span>(</span><span>)</span><span>;</span>
		<span>let</span> dt <span>=</span> now <span>-</span> prevNow<span>;</span>

		<span>if</span> <span>(</span>dt <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
			<span>const</span> instFPS <span>=</span> <span>1000</span> <span>/</span> dt<span>;</span>
			<span>const</span> <span>ALPHA</span> <span>=</span> <span>0.05</span><span>;</span>
			fpsEMA <span>=</span> <span>ALPHA</span> <span>*</span> instFPS <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>ALPHA</span><span>)</span> <span>*</span> fpsEMA<span>;</span>
			msEMA <span>=</span> <span>ALPHA</span> <span>*</span> dt <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>ALPHA</span><span>)</span> <span>*</span> msEMA<span>;</span>
		<span>}</span>
		prevNow <span>=</span> now<span>;</span>

		<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked <span>&amp;&amp;</span> now <span>-</span> lastStatsUpdate <span>&gt;=</span> <span>1000</span><span>)</span> <span>{</span>
			ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> fpsEMA<span>.</span><span>toFixed</span><span>(</span><span>0</span><span>)</span><span>;</span>
			ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> msEMA<span>.</span><span>toFixed</span><span>(</span><span>2</span><span>)</span><span>;</span>
			lastStatsUpdate <span>=</span> now<span>;</span>
		<span>}</span>
	<span>}</span>

	<span>let</span> animationFrameId<span>;</span>

	
	<span>function</span> <span>nativeResize</span><span>(</span><span>)</span> <span>{</span>
		<span>const</span> <span>[</span>width<span>,</span> height<span>]</span> <span>=</span> util<span>.</span><span>getNativeSize</span><span>(</span>canvas<span>)</span><span>;</span>

		<span>if</span> <span>(</span>width <span>&amp;&amp;</span> canvas<span>.</span>width <span>!==</span> width <span>||</span> height <span>&amp;&amp;</span> canvas<span>.</span>height <span>!==</span> height<span>)</span> <span>{</span>
			canvas<span>.</span>width <span>=</span> width<span>;</span>
			canvas<span>.</span>height <span>=</span> height<span>;</span>

			<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>benchMode<span>)</span> <span>{</span>
				<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
				<span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
				<span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span>
	<span>}</span>

	
	<span>nativeResize</span><span>(</span><span>)</span><span>;</span>

	<span>let</span> resizePending <span>=</span> <span>false</span><span>;</span>
	window<span>.</span><span>addEventListener</span><span>(</span><span>&#39;resize&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>if</span> <span>(</span><span>!</span>resizePending<span>)</span> <span>{</span>
			resizePending <span>=</span> <span>true</span><span>;</span>
			<span>requestAnimationFrame</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
				resizePending <span>=</span> <span>false</span><span>;</span>
				<span>nativeResize</span><span>(</span><span>)</span><span>;</span>
			<span>}</span><span>)</span><span>;</span>
		<span>}</span>
	<span>}</span><span>)</span><span>;</span>

	<span>function</span> <span>renderLoop</span><span>(</span><span>)</span> <span>{</span>
		<span>if</span> <span>(</span>ctx<span>.</span>flags<span>.</span>isRendering <span>&amp;&amp;</span> ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>{</span>
			<span>redraw</span><span>(</span><span>)</span><span>;</span>
			animationFrameId <span>=</span> <span>requestAnimationFrame</span><span>(</span>renderLoop<span>)</span><span>;</span>
		<span>}</span>
	<span>}</span>

	<span>function</span> <span>startRendering</span><span>(</span><span>)</span> <span>{</span>
		
		ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>true</span><span>;</span>
		<span>renderLoop</span><span>(</span><span>)</span><span>;</span>
	<span>}</span>

	<span>function</span> <span>stopRendering</span><span>(</span><span>)</span> <span>{</span>
		
		ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>false</span><span>;</span>
		<span>cancelAnimationFrame</span><span>(</span>animationFrameId<span>)</span><span>;</span>
		
		gl<span>.</span><span>finish</span><span>(</span><span>)</span><span>;</span>

		
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>sdr<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>sdr <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>selfIllum<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>selfIllum <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>frame<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>frame <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>frameIntermediate1<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>frameIntermediate1 <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>frameIntermediate2<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>frameIntermediate2 <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>frameFinal<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>frameFinal <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>scene <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>intermediate1<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>intermediate1 <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>intermediate2<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>intermediate2 <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>final<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>final <span>=</span> <span>null</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>buffersInitialized <span>=</span> <span>false</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>false</span><span>;</span>
		ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
		ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
	<span>}</span>

	<span>function</span> <span>handleIntersection</span><span>(</span><span>entries</span><span>)</span> <span>{</span>
		entries<span>.</span><span>forEach</span><span>(</span><span>entry</span> <span>=&gt;</span> <span>{</span>
			<span>if</span> <span>(</span>entry<span>.</span>isIntersecting<span>)</span> <span>{</span>
				<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>isRendering <span>&amp;&amp;</span> <span>!</span>ctx<span>.</span>flags<span>.</span>benchMode<span>)</span> <span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span> <span>else</span> <span>{</span>
				<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span>

	
	<span>const</span> initialIterations <span>=</span> <span>parseInt</span><span>(</span>ui<span>.</span>blur<span>.</span>iterations<span>.</span>value<span>)</span><span>;</span>
	ui<span>.</span>blur<span>.</span>samplePos<span>.</span>disabled <span>=</span> initialIterations <span>===</span> <span>0</span><span>;</span>
	ui<span>.</span>blur<span>.</span>samplePosReset<span>.</span>disabled <span>=</span> initialIterations <span>===</span> <span>0</span><span>;</span>

	
	<span>let</span> observer <span>=</span> <span>new</span> <span>IntersectionObserver</span><span>(</span>handleIntersection<span>)</span><span>;</span>
	observer<span>.</span><span>observe</span><span>(</span>canvas<span>)</span><span>;</span>
<span>}</span></code></pre></details></blockquote><p>Akin to the <a href="https://en.wikipedia.org/wiki/Central_limit_theorem" target="_blank">Central Limit Theorem</a> making repeated passes of a box-blur approach a gaussian blur, our Kawase blur provides a smooth gaussian-like results, due to the iterative convolution at play. Technically, there are two convolutions happening at the same time - bilinear filtering and the diagonal samples with increasing distance.</p><blockquote><p>Two different origins: The Gaussian blur came from a mathematical concept entering graphics programming. The Kawase blur was born to get the most out of what hardware provides for free.</p><img src="https://blog.frost.kiwi/assets/kiwis/book.svg"/></blockquote><p>It is not a separable convolution, due to its diagonal sampling nature. As no downsampling is used, this means that we write all pixels out to memory, each pass. Even if we could separate, the cost of writing out twice as many passes to memory would outweigh the benefit of going from 4 samples per-pass to 2.</p><blockquote><p>With so few samples, you cannot increase <code>samplePosMultiplier</code> without instantly getting artifacts. We mess up the sample pattern.</p><img src="https://blog.frost.kiwi/assets/kiwis/detective.svg"/></blockquote><p>Take note of textures taps: They grow linearly, with increasing blur radius. In DOUBLE-S.T.E.A.L, Masaki Kawase used it to create the bloom effect, calculated at a lower resolution. But there is one more evolution coming up - We have blur, we have downsampling. Two separate concepts. What if we ‚Äúfused‚Äù them?</p><h2 id="dual-kawase-blur" tabindex="-1">Dual Kawase Blur <a href="#dual-kawase-blur">#</a></h2><p><a href="https://theorg.com/org/arm/org-chart/marius-bjorge" target="_blank">Marius Bj√∏rge</a>, principal graphics architect at <a href="https://www.arm.com/" target="_blank">ARM</a> took this thought to its logical conclusion, when he was optimizing mobile graphics rendering with ARM graphics chips. In a SIGGRAPH 2015 <a href="https://dl.acm.org/doi/10.1145/2776880.2787664" target="_blank">talk</a> he presented an algorithm, that would later become knows as the ‚ú® Dual Kawase Blur üåü, this article‚Äôs final destination.</p><figure><img src="https://blog.frost.kiwi/dual-kawase/img/dualKawasePattern.jpg" alt="Dual Kawase sampling patterns"/><figcaption>Dual Kawase sampling patterns</figcaption></figure><p>This blur works with the idea of Masaki Kawase‚Äôs ‚Äúplacing diagonal samples at increasing distance‚Äù, but does so in conjunction with downsampling, which effectively performs this ‚Äúincrease in distance‚Äù. There is also a dedicated upsample filter. I‚Äôll let Marius Bj√∏rge explain this one, an excerpt <a href="https://dl.acm.org/doi/suppl/10.1145/2776880.2787664/suppl_file/a184.mp4" target="_blank">from his talk mentioned above</a></p><blockquote><strong>Marius Bj√∏rge</strong>: For lack for a better name, dual filter is something I come up with when playing with different downsampling and upsampling patterns. It&#39;s sort of a derivative of the Kawase filter, but instead of ping-ponging between two equally sized textures, this filter works by having the same filter for down sampling and having another filter for upsampling.</blockquote><p>Let‚Äôs try it. This time, there are two blur shaders, as there is an upsample and downsample stage. Again, there is no <code>kernelSize</code>. Instead there are <code>downsampleLevels</code>, which performs the blur in conjunction with the down sampling. Play around with all the slider and get a feel for it.</p><div id="WebGLBox-DualKawaseBlur"><div><p><label> Scene</label> <label> Lights</label> <label> Bloom</label></p><p><label> Animate</label></p></div><div><canvas></canvas><p>L The browser killed this WebGL Context, please reload the page. If this happened as the result of a long benchmark, decrease the iteration count. On some platforms (iOS / iPad) you may have to restart the browser App completely, as the browser will temporarily refuse to allow this site to run WebGL again.</p><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" fill="transparent" r="10" stroke-width="2"></circle><rect height="7" rx="1" width="2" x="11" y="6"></rect><rect height="9" rx="1" width="2" x="11" y="11"></rect></svg></div><table><tbody><tr><td colspan="4"><p><span><strong>FPS:</strong><output id="fps">?</output>/<output id="ms">?</output>ms </span><span><strong>Resolution:</strong><output id="width">?</output>x<output id="height">?</output></span><span><strong>Texture Taps:</strong><output id="taps">?</output></span></p></td></tr><tr><td colspan="4"><code>downsampleLevels</code></td></tr><tr><td><code>downsampleLevels</code></td><td></td><td><output>2</output></td><td></td></tr><tr><td colspan="4"><code>samplePosMultiplier</code></td></tr><tr><td><code>samplePosMultiplier</code></td><td></td><td><output>100</output>%</td><td></td></tr><tr><td colspan="4"><code>lightBrightness</code></td></tr><tr><td><code>lightBrightness</code></td><td></td><td><output>100</output>%</td><td></td></tr></tbody></table></div><blockquote id="WebGLBox-DualKawaseBlurDetail"><details><summary>WebGL Fragment Shader <a href="https://blog.frost.kiwi/dual-kawase/shader/dual-kawase-down.fs" target="_blank">dual-kawase-down.fs</a></summary><pre><code>
<span>precision</span> <span>highp</span> <span>float</span><span>;</span>

<span>varying</span> <span>vec2</span> uv<span>;</span>

<span>uniform</span> <span>vec2</span> frameSizeRCP<span>;</span> 
<span>uniform</span> <span>float</span> offset<span>;</span> 
<span>uniform</span> <span>float</span> bloomStrength<span>;</span> 

<span>uniform</span> <span>sampler2D</span> texture<span>;</span>

<span>void</span> <span>main</span><span>(</span><span>)</span> <span>{</span>
	
	<span>vec2</span> halfpixel <span>=</span> frameSizeRCP <span>*</span> <span>0.5</span><span>;</span>
	<span>vec2</span> o <span>=</span> halfpixel <span>*</span> offset<span>;</span>
	
	
	<span>vec4</span> color <span>=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv<span>)</span> <span>*</span> <span>4.0</span><span>;</span>
	
	
	color <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> <span>vec2</span><span>(</span><span>-</span>o<span>.</span>x<span>,</span> <span>-</span>o<span>.</span>y<span>)</span><span>)</span><span>;</span> 
	color <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> <span>vec2</span><span>(</span> o<span>.</span>x<span>,</span> <span>-</span>o<span>.</span>y<span>)</span><span>)</span><span>;</span> 
	color <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> <span>vec2</span><span>(</span><span>-</span>o<span>.</span>x<span>,</span>  o<span>.</span>y<span>)</span><span>)</span><span>;</span> 
	color <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> <span>vec2</span><span>(</span> o<span>.</span>x<span>,</span>  o<span>.</span>y<span>)</span><span>)</span><span>;</span> 
	
	
	gl_FragColor <span>=</span> <span>(</span>color <span>/</span> <span>8.0</span><span>)</span> <span>*</span> bloomStrength<span>;</span>
<span>}</span></code></pre></details><details><summary>WebGL Fragment Shader <a href="https://blog.frost.kiwi/dual-kawase/shader/dual-kawase-up.fs" target="_blank">dual-kawase-up.fs</a></summary><pre><code>
<span>precision</span> <span>highp</span> <span>float</span><span>;</span>

<span>varying</span> <span>vec2</span> uv<span>;</span>

<span>uniform</span> <span>vec2</span> frameSizeRCP<span>;</span> 
<span>uniform</span> <span>float</span> offset<span>;</span> 
<span>uniform</span> <span>float</span> bloomStrength<span>;</span> 

<span>uniform</span> <span>sampler2D</span> texture<span>;</span>

<span>void</span> <span>main</span><span>(</span><span>)</span> <span>{</span>
	
	<span>vec2</span> halfpixel <span>=</span> frameSizeRCP <span>*</span> <span>0.5</span><span>;</span>
	<span>vec2</span> o <span>=</span> halfpixel <span>*</span> offset<span>;</span>
	
	<span>vec4</span> color <span>=</span> <span>vec4</span><span>(</span><span>0.0</span><span>)</span><span>;</span>
	
	
	color <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> <span>vec2</span><span>(</span><span>-</span>o<span>.</span>x <span>*</span> <span>2.0</span><span>,</span> <span>0.0</span><span>)</span><span>)</span><span>;</span> 
	color <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> <span>vec2</span><span>(</span> o<span>.</span>x <span>*</span> <span>2.0</span><span>,</span> <span>0.0</span><span>)</span><span>)</span><span>;</span> 
	color <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span> <span>-</span>o<span>.</span>y <span>*</span> <span>2.0</span><span>)</span><span>)</span><span>;</span> 
	color <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span>  o<span>.</span>y <span>*</span> <span>2.0</span><span>)</span><span>)</span><span>;</span> 
	
	
	color <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> <span>vec2</span><span>(</span><span>-</span>o<span>.</span>x<span>,</span>  o<span>.</span>y<span>)</span><span>)</span> <span>*</span> <span>2.0</span><span>;</span> 
	color <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> <span>vec2</span><span>(</span> o<span>.</span>x<span>,</span>  o<span>.</span>y<span>)</span><span>)</span> <span>*</span> <span>2.0</span><span>;</span> 
	color <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> <span>vec2</span><span>(</span><span>-</span>o<span>.</span>x<span>,</span> <span>-</span>o<span>.</span>y<span>)</span><span>)</span> <span>*</span> <span>2.0</span><span>;</span> 
	color <span>+=</span> <span>texture2D</span><span>(</span>texture<span>,</span> uv <span>+</span> <span>vec2</span><span>(</span> o<span>.</span>x<span>,</span> <span>-</span>o<span>.</span>y<span>)</span><span>)</span> <span>*</span> <span>2.0</span><span>;</span> 
	
	
	gl_FragColor <span>=</span> <span>(</span>color <span>/</span> <span>12.0</span><span>)</span> <span>*</span> bloomStrength<span>;</span>
<span>}</span></code></pre></details><details><summary>WebGL Javascript <a href="https://blog.frost.kiwi/dual-kawase/js/blur/dual-kawase.js" target="_blank">dual-kawase.js</a></summary><pre><code><span>import</span> <span>*</span> <span>as</span> util <span>from</span> <span>&#39;../utility.js&#39;</span>

<span>export</span> <span>async</span> <span>function</span> <span>setupDualKawaseBlur</span><span>(</span><span>)</span> <span>{</span>
	
	<span>const</span> WebGLBox <span>=</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-DualKawaseBlur&#39;</span><span>)</span><span>;</span>
	<span>const</span> canvas <span>=</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;canvas&#39;</span><span>)</span><span>;</span>

	
	<span>const</span> radius <span>=</span> <span>0.12</span><span>;</span>

	
	<span>const</span> gl <span>=</span> canvas<span>.</span><span>getContext</span><span>(</span><span>&#39;webgl&#39;</span><span>,</span> <span>{</span>
		<span>preserveDrawingBuffer</span><span>:</span> <span>false</span><span>,</span>
		<span>antialias</span><span>:</span> <span>false</span><span>,</span>
		<span>alpha</span><span>:</span> <span>false</span><span>,</span>
	<span>}</span><span>)</span><span>;</span>

	
	<span>const</span> ctx <span>=</span> <span>{</span>
		
		<span>mode</span><span>:</span> <span>&#34;scene&#34;</span><span>,</span>
		<span>flags</span><span>:</span> <span>{</span> <span>isRendering</span><span>:</span> <span>false</span><span>,</span> <span>buffersInitialized</span><span>:</span> <span>false</span><span>,</span> <span>initComplete</span><span>:</span> <span>false</span><span>,</span> <span>benchMode</span><span>:</span> <span>false</span> <span>}</span><span>,</span>
		
		<span>tex</span><span>:</span> <span>{</span> <span>sdr</span><span>:</span> <span>null</span><span>,</span> <span>selfIllum</span><span>:</span> <span>null</span><span>,</span> <span>frame</span><span>:</span> <span>null</span><span>,</span> <span>frameFinal</span><span>:</span> <span>null</span><span>,</span> <span>down</span><span>:</span> <span>[</span><span>]</span> <span>}</span><span>,</span>
		
		<span>fb</span><span>:</span> <span>{</span> <span>scene</span><span>:</span> <span>null</span><span>,</span> <span>final</span><span>:</span> <span>null</span><span>,</span> <span>down</span><span>:</span> <span>[</span><span>]</span> <span>}</span><span>,</span>
		
		<span>shd</span><span>:</span> <span>{</span>
			<span>scene</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>offset</span><span>:</span> <span>null</span><span>,</span> <span>radius</span><span>:</span> <span>null</span> <span>}</span> <span>}</span><span>,</span>
			<span>passthrough</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span> <span>}</span><span>,</span>
			<span>downsample</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>frameSizeRCP</span><span>:</span> <span>null</span><span>,</span> <span>offset</span><span>:</span> <span>null</span><span>,</span> <span>bloomStrength</span><span>:</span> <span>null</span> <span>}</span> <span>}</span><span>,</span>
			<span>upsample</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>frameSizeRCP</span><span>:</span> <span>null</span><span>,</span> <span>offset</span><span>:</span> <span>null</span><span>,</span> <span>bloomStrength</span><span>:</span> <span>null</span> <span>}</span> <span>}</span><span>,</span>
			<span>bloom</span><span>:</span> <span>{</span> <span>handle</span><span>:</span> <span>null</span><span>,</span> <span>uniforms</span><span>:</span> <span>{</span> <span>offset</span><span>:</span> <span>null</span><span>,</span> <span>radius</span><span>:</span> <span>null</span><span>,</span> <span>texture</span><span>:</span> <span>null</span><span>,</span> <span>textureAdd</span><span>:</span> <span>null</span> <span>}</span> <span>}</span>
		<span>}</span>
	<span>}</span><span>;</span>

	
	<span>const</span> ui <span>=</span> <span>{</span>
		<span>display</span><span>:</span> <span>{</span>
			<span>spinner</span><span>:</span> canvas<span>.</span>parentElement<span>.</span><span>querySelector</span><span>(</span><span>&#39;svg&#39;</span><span>,</span> canvas<span>.</span>parentElement<span>)</span><span>,</span>
			<span>contextLoss</span><span>:</span> canvas<span>.</span>parentElement<span>.</span><span>querySelector</span><span>(</span><span>&#39;div&#39;</span><span>,</span> canvas<span>.</span>parentElement<span>)</span><span>,</span>
			<span>fps</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#fps&#39;</span><span>)</span><span>,</span>
			<span>ms</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#ms&#39;</span><span>)</span><span>,</span>
			<span>width</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#width&#39;</span><span>)</span><span>,</span>
			<span>height</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#height&#39;</span><span>)</span><span>,</span>
			<span>tapsCount</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#taps&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>blur</span><span>:</span> <span>{</span>
			<span>downsample</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#downsampleRange&#39;</span><span>)</span><span>,</span>
			<span>samplePos</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#samplePosRange&#39;</span><span>)</span><span>,</span>
			<span>samplePosReset</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#samplePosRangeReset&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>rendering</span><span>:</span> <span>{</span>
			<span>animate</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#animateCheck&#39;</span><span>)</span><span>,</span>
			<span>modes</span><span>:</span> WebGLBox<span>.</span><span>querySelectorAll</span><span>(</span><span>&#39;input[type=&#34;radio&#34;]&#39;</span><span>)</span><span>,</span>
			<span>lightBrightness</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#lightBrightness&#39;</span><span>)</span><span>,</span>
			<span>lightBrightnessReset</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#lightBrightnessReset&#39;</span><span>)</span><span>,</span>
		<span>}</span><span>,</span>
		<span>benchmark</span><span>:</span> <span>{</span>
			<span>button</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#benchmark&#39;</span><span>)</span><span>,</span>
			<span>label</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#benchmarkLabel&#39;</span><span>)</span><span>,</span>
			<span>iterOut</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterOut&#39;</span><span>)</span><span>,</span>
			<span>renderer</span><span>:</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-DualKawaseBlurDetail&#39;</span><span>)</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;#renderer&#39;</span><span>)</span><span>,</span>
			<span>downsampleLevels</span><span>:</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-DualKawaseBlurDetail&#39;</span><span>)</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;#downsampleLevels&#39;</span><span>)</span><span>,</span>
			<span>iterTime</span><span>:</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-DualKawaseBlurDetail&#39;</span><span>)</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterTime&#39;</span><span>)</span><span>,</span>
			<span>tapsCount</span><span>:</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;WebGLBox-DualKawaseBlurDetail&#39;</span><span>)</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;#tapsCountBench&#39;</span><span>)</span><span>,</span>
			<span>iterations</span><span>:</span> WebGLBox<span>.</span><span>querySelector</span><span>(</span><span>&#39;#iterations&#39;</span><span>)</span>
		<span>}</span>
	<span>}</span><span>;</span>

	
	<span>const</span> circleAnimation <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/circleAnimation.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> simpleTexture <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/simpleTexture.fs&#34;</span><span>)</span><span>;</span>
	<span>const</span> bloomVert <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/bloom.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> bloomFrag <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/bloom.fs&#34;</span><span>)</span><span>;</span>
	<span>const</span> simpleQuad <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/simpleQuad.vs&#34;</span><span>)</span><span>;</span>
	<span>const</span> dualKawaseDown <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/dual-kawase-down.fs&#34;</span><span>)</span><span>;</span>
	<span>const</span> dualKawaseUp <span>=</span> <span>await</span> util<span>.</span><span>fetchShader</span><span>(</span><span>&#34;shader/dual-kawase-up.fs&#34;</span><span>)</span><span>;</span>

	
	ui<span>.</span>blur<span>.</span>downsample<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>
	ui<span>.</span>blur<span>.</span>samplePos<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>
	ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>animate<span>.</span><span>addEventListener</span><span>(</span><span>&#34;change&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
			<span>startRendering</span><span>(</span><span>)</span><span>;</span>
		<span>else</span> <span>{</span>
			ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
			ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
			ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>false</span><span>;</span>
			<span>redraw</span><span>(</span><span>)</span>
		<span>}</span>
	<span>}</span><span>)</span><span>;</span>

	canvas<span>.</span><span>addEventListener</span><span>(</span><span>&#34;webglcontextlost&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ui<span>.</span>display<span>.</span>contextLoss<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	ui<span>.</span>blur<span>.</span>downsample<span>.</span><span>addEventListener</span><span>(</span><span>&#39;input&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ui<span>.</span>blur<span>.</span>samplePos<span>.</span>disabled <span>=</span> ui<span>.</span>blur<span>.</span>downsample<span>.</span>value <span>==</span> <span>0</span><span>;</span>
		ui<span>.</span>blur<span>.</span>samplePosReset<span>.</span>disabled <span>=</span> ui<span>.</span>blur<span>.</span>downsample<span>.</span>value <span>==</span> <span>0</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	
	ui<span>.</span>rendering<span>.</span>modes<span>.</span><span>forEach</span><span>(</span><span>radio</span> <span>=&gt;</span> <span>{</span>
		
		<span>if</span> <span>(</span>radio<span>.</span>value <span>===</span> <span>&#34;scene&#34;</span><span>)</span>
			radio<span>.</span>checked <span>=</span> <span>true</span><span>;</span>
		radio<span>.</span><span>addEventListener</span><span>(</span><span>&#39;change&#39;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
			ctx<span>.</span>mode <span>=</span> event<span>.</span>target<span>.</span>value<span>;</span>
			ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>disabled <span>=</span> ctx<span>.</span>mode <span>===</span> <span>&#34;scene&#34;</span><span>;</span>
			ui<span>.</span>rendering<span>.</span>lightBrightnessReset<span>.</span>disabled <span>=</span> ctx<span>.</span>mode <span>===</span> <span>&#34;scene&#34;</span><span>;</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	ui<span>.</span>benchmark<span>.</span>button<span>.</span><span>addEventListener</span><span>(</span><span>&#34;click&#34;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ctx<span>.</span>flags<span>.</span>benchMode <span>=</span> <span>true</span><span>;</span>
		<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
		ui<span>.</span>benchmark<span>.</span>button<span>.</span>disabled <span>=</span> <span>true</span><span>;</span>

		
		<span>const</span> worker <span>=</span> <span>new</span> <span>Worker</span><span>(</span><span>&#34;./js/benchmark/dualKawaseBenchmark.js&#34;</span><span>,</span> <span>{</span> <span>type</span><span>:</span> <span>&#34;module&#34;</span> <span>}</span><span>)</span><span>;</span>

		
		worker<span>.</span><span>postMessage</span><span>(</span><span>{</span>
			<span>iterations</span><span>:</span> ui<span>.</span>benchmark<span>.</span>iterOut<span>.</span>value<span>,</span>
			<span>downShaderSrc</span><span>:</span> dualKawaseDown<span>,</span>
			<span>upShaderSrc</span><span>:</span> dualKawaseUp<span>,</span>
			<span>downsampleLevels</span><span>:</span> ui<span>.</span>blur<span>.</span>downsample<span>.</span>value<span>,</span>
			<span>samplePos</span><span>:</span> ui<span>.</span>blur<span>.</span>samplePos<span>.</span>value
		<span>}</span><span>)</span><span>;</span>

		
		worker<span>.</span><span>addEventListener</span><span>(</span><span>&#34;message&#34;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
			<span>if</span> <span>(</span>event<span>.</span>data<span>.</span>type <span>!==</span> <span>&#34;done&#34;</span><span>)</span> <span>return</span><span>;</span>

			ui<span>.</span>benchmark<span>.</span>label<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>benchText<span>;</span>
			ui<span>.</span>benchmark<span>.</span>tapsCount<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>tapsCount<span>;</span>
			ui<span>.</span>benchmark<span>.</span>iterTime<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>iterationText<span>;</span>
			ui<span>.</span>benchmark<span>.</span>renderer<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>renderer<span>;</span>
			ui<span>.</span>benchmark<span>.</span>downsampleLevels<span>.</span>textContent <span>=</span> event<span>.</span>data<span>.</span>downsampleLevels<span>;</span>

			worker<span>.</span><span>terminate</span><span>(</span><span>)</span><span>;</span>
			ui<span>.</span>benchmark<span>.</span>button<span>.</span>disabled <span>=</span> <span>false</span><span>;</span>
			ctx<span>.</span>flags<span>.</span>benchMode <span>=</span> <span>false</span><span>;</span>
			<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
				<span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>else</span>
				<span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	ui<span>.</span>benchmark<span>.</span>iterations<span>.</span><span>addEventListener</span><span>(</span><span>&#34;change&#34;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>{</span>
		ui<span>.</span>benchmark<span>.</span>iterOut<span>.</span>value <span>=</span> event<span>.</span>target<span>.</span>value<span>;</span>
		ui<span>.</span>benchmark<span>.</span>label<span>.</span>textContent <span>=</span> <span>&#34;Benchmark&#34;</span><span>;</span>
	<span>}</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>scene <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> circleAnimation<span>,</span> simpleTexture<span>,</span> <span>[</span><span>&#34;offset&#34;</span><span>,</span> <span>&#34;radius&#34;</span><span>]</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>bloom <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> bloomVert<span>,</span> bloomFrag<span>,</span> <span>[</span><span>&#34;texture&#34;</span><span>,</span> <span>&#34;textureAdd&#34;</span><span>,</span> <span>&#34;offset&#34;</span><span>,</span> <span>&#34;radius&#34;</span><span>]</span><span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>passthrough <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> simpleQuad<span>,</span> simpleTexture<span>)</span><span>;</span>

	
	ctx<span>.</span>shd<span>.</span>downsample <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> simpleQuad<span>,</span> dualKawaseDown<span>,</span> <span>[</span><span>&#34;frameSizeRCP&#34;</span><span>,</span> <span>&#34;offset&#34;</span><span>,</span> <span>&#34;bloomStrength&#34;</span><span>]</span><span>)</span><span>;</span>
	ctx<span>.</span>shd<span>.</span>upsample <span>=</span> util<span>.</span><span>compileAndLinkShader</span><span>(</span>gl<span>,</span> simpleQuad<span>,</span> dualKawaseUp<span>,</span> <span>[</span><span>&#34;frameSizeRCP&#34;</span><span>,</span> <span>&#34;offset&#34;</span><span>,</span> <span>&#34;bloomStrength&#34;</span><span>]</span><span>)</span><span>;</span>

	
	util<span>.</span><span>bindUnitQuad</span><span>(</span>gl<span>)</span><span>;</span>

	<span>async</span> <span>function</span> <span>setupTextureBuffers</span><span>(</span><span>)</span> <span>{</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;block&#34;</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>buffersInitialized <span>=</span> <span>true</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>false</span><span>;</span>

		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>final<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>scene<span>,</span> ctx<span>.</span>tex<span>.</span>frame<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
		<span>[</span>ctx<span>.</span>fb<span>.</span>final<span>,</span> ctx<span>.</span>tex<span>.</span>frameFinal<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>

		<span>const</span> maxDown <span>=</span> <span>parseInt</span><span>(</span>ui<span>.</span>blur<span>.</span>downsample<span>.</span>max<span>)</span><span>;</span>
		<span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> maxDown<span>;</span> <span>++</span>i<span>)</span> <span>{</span>
			gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>down<span>[</span>i<span>]</span><span>)</span><span>;</span>
			gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>down<span>[</span>i<span>]</span><span>)</span><span>;</span>
		<span>}</span>
		ctx<span>.</span>fb<span>.</span>down <span>=</span> <span>[</span><span>]</span><span>;</span>
		ctx<span>.</span>tex<span>.</span>down <span>=</span> <span>[</span><span>]</span><span>;</span>

		<span>let</span> w <span>=</span> canvas<span>.</span>width<span>,</span> h <span>=</span> canvas<span>.</span>height<span>;</span>
		<span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> maxDown<span>;</span> <span>++</span>i<span>)</span> <span>{</span>
			w <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> w <span>&gt;&gt;</span> <span>1</span><span>)</span><span>;</span>
			h <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> h <span>&gt;&gt;</span> <span>1</span><span>)</span><span>;</span>
			<span>const</span> <span>[</span>fb<span>,</span> tex<span>]</span> <span>=</span> util<span>.</span><span>setupFramebuffer</span><span>(</span>gl<span>,</span> w<span>,</span> h<span>)</span><span>;</span>
			ctx<span>.</span>fb<span>.</span>down<span>.</span><span>push</span><span>(</span>fb<span>)</span><span>;</span>
			ctx<span>.</span>tex<span>.</span>down<span>.</span><span>push</span><span>(</span>tex<span>)</span><span>;</span>
		<span>}</span>

		<span>let</span> <span>[</span>base<span>,</span> selfIllum<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>
			<span>fetch</span><span>(</span><span>&#34;/dual-kawase/img/SDR_No_Sprite.png&#34;</span><span>)</span><span>,</span>
			<span>fetch</span><span>(</span><span>&#34;/dual-kawase/img/Selfillumination.png&#34;</span><span>)</span>
		<span>]</span><span>)</span><span>;</span>
		<span>let</span> <span>[</span>baseBlob<span>,</span> selfIllumBlob<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>base<span>.</span><span>blob</span><span>(</span><span>)</span><span>,</span> selfIllum<span>.</span><span>blob</span><span>(</span><span>)</span><span>]</span><span>)</span><span>;</span>
		<span>let</span> <span>[</span>baseBitmap<span>,</span> selfIllumBitmap<span>]</span> <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span><span>[</span>
			<span>createImageBitmap</span><span>(</span>baseBlob<span>,</span> <span>{</span> <span>colorSpaceConversion</span><span>:</span> <span>&#39;none&#39;</span><span>,</span> <span>resizeWidth</span><span>:</span> canvas<span>.</span>width <span>*</span> <span>1.12</span><span>,</span> <span>resizeHeight</span><span>:</span> canvas<span>.</span>height <span>*</span> <span>1.12</span><span>,</span> <span>resizeQuality</span><span>:</span> <span>&#34;high&#34;</span> <span>}</span><span>)</span><span>,</span>
			<span>createImageBitmap</span><span>(</span>selfIllumBlob<span>,</span> <span>{</span> <span>colorSpaceConversion</span><span>:</span> <span>&#39;none&#39;</span><span>,</span> <span>resizeWidth</span><span>:</span> canvas<span>.</span>width <span>*</span> <span>1.12</span><span>,</span> <span>resizeHeight</span><span>:</span> canvas<span>.</span>height <span>*</span> <span>1.12</span><span>,</span> <span>resizeQuality</span><span>:</span> <span>&#34;high&#34;</span> <span>}</span><span>)</span>
		<span>]</span><span>)</span><span>;</span>

		ctx<span>.</span>tex<span>.</span>sdr <span>=</span> util<span>.</span><span>setupTexture</span><span>(</span>gl<span>,</span> <span>null</span><span>,</span> <span>null</span><span>,</span> ctx<span>.</span>tex<span>.</span>sdr<span>,</span> gl<span>.</span><span>LINEAR</span><span>,</span> baseBitmap<span>)</span><span>;</span>
		ctx<span>.</span>tex<span>.</span>selfIllum <span>=</span> util<span>.</span><span>setupTexture</span><span>(</span>gl<span>,</span> <span>null</span><span>,</span> <span>null</span><span>,</span> ctx<span>.</span>tex<span>.</span>selfIllum<span>,</span> gl<span>.</span><span>LINEAR</span><span>,</span> selfIllumBitmap<span>)</span><span>;</span>

		baseBitmap<span>.</span><span>close</span><span>(</span><span>)</span><span>;</span>
		selfIllumBitmap<span>.</span><span>close</span><span>(</span><span>)</span><span>;</span>

		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>true</span><span>;</span>
		ui<span>.</span>display<span>.</span>spinner<span>.</span>style<span>.</span>display <span>=</span> <span>&#34;none&#34;</span><span>;</span>
	<span>}</span>

	<span>let</span> prevNow <span>=</span> performance<span>.</span><span>now</span><span>(</span><span>)</span><span>;</span>
	<span>let</span> lastStatsUpdate <span>=</span> prevNow<span>;</span>
	<span>let</span> fpsEMA <span>=</span> <span>60</span><span>;</span>
	<span>let</span> msEMA <span>=</span> <span>16</span><span>;</span>

	<span>async</span> <span>function</span> <span>redraw</span><span>(</span><span>)</span> <span>{</span>
		<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>buffersInitialized<span>)</span>
			<span>await</span> <span>setupTextureBuffers</span><span>(</span><span>)</span><span>;</span>
		<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>initComplete<span>)</span>
			<span>return</span><span>;</span>

		
		<span>const</span> levels <span>=</span> <span>parseInt</span><span>(</span>ui<span>.</span>blur<span>.</span>downsample<span>.</span>value<span>)</span><span>;</span>
		
		<span>let</span> totalTaps <span>=</span> <span>0</span><span>;</span>
		<span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> levels<span>;</span> i<span>++</span><span>)</span> <span>{</span>
			<span>const</span> levelW <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> canvas<span>.</span>width <span>&gt;&gt;</span> <span>(</span>i <span>+</span> <span>1</span><span>)</span><span>)</span><span>;</span>
			<span>const</span> levelH <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> canvas<span>.</span>height <span>&gt;&gt;</span> <span>(</span>i <span>+</span> <span>1</span><span>)</span><span>)</span><span>;</span>
			totalTaps <span>+=</span> levelW <span>*</span> levelH <span>*</span> <span>5</span><span>;</span> 
			<span>if</span> <span>(</span>i <span>&lt;</span> levels <span>-</span> <span>1</span><span>)</span> totalTaps <span>+=</span> levelW <span>*</span> levelH <span>*</span> <span>8</span><span>;</span> 
		<span>}</span>
		<span>if</span> <span>(</span>levels <span>&gt;</span> <span>0</span><span>)</span> totalTaps <span>+=</span> canvas<span>.</span>width <span>*</span> canvas<span>.</span>height <span>*</span> <span>8</span><span>;</span> 
		<span>const</span> tapsNewText <span>=</span> <span>(</span>totalTaps <span>/</span> <span>1000000</span><span>)</span><span>.</span><span>toFixed</span><span>(</span><span>1</span><span>)</span> <span>+</span> <span>&#34; Million&#34;</span><span>;</span>
		ui<span>.</span>display<span>.</span>tapsCount<span>.</span>value <span>=</span> tapsNewText<span>;</span>
		
		ui<span>.</span>display<span>.</span>width<span>.</span>value <span>=</span> canvas<span>.</span>width<span>;</span>
		ui<span>.</span>display<span>.</span>height<span>.</span>value <span>=</span> canvas<span>.</span>height<span>;</span>

		
		<span>let</span> radiusSwitch <span>=</span> ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked <span>?</span> radius <span>:</span> <span>0.0</span><span>;</span>
		<span>let</span> speed <span>=</span> <span>(</span>performance<span>.</span><span>now</span><span>(</span><span>)</span> <span>/</span> <span>10000</span><span>)</span> <span>%</span> Math<span>.</span><span>PI</span> <span>*</span> <span>2</span><span>;</span>
		<span>const</span> offset <span>=</span> <span>[</span>radiusSwitch <span>*</span> Math<span>.</span><span>cos</span><span>(</span>speed<span>)</span><span>,</span> radiusSwitch <span>*</span> Math<span>.</span><span>sin</span><span>(</span>speed<span>)</span><span>]</span><span>;</span>
		gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>handle<span>)</span><span>;</span>
		<span>const</span> texture <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> ctx<span>.</span>tex<span>.</span>sdr <span>:</span> ctx<span>.</span>tex<span>.</span>selfIllum<span>;</span>
		gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
		gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> texture<span>)</span><span>;</span>
		gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>uniforms<span>.</span>offset<span>,</span> offset<span>)</span><span>;</span>
		gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>scene<span>.</span>uniforms<span>.</span>radius<span>,</span> radiusSwitch<span>)</span><span>;</span>

		
		gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span>
		gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>

		
		gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>

		<span>const</span> downsampleLevels <span>=</span> <span>parseInt</span><span>(</span>ui<span>.</span>blur<span>.</span>downsample<span>.</span>value<span>)</span><span>;</span>
		<span>let</span> srcTex <span>=</span> ctx<span>.</span>tex<span>.</span>frame<span>;</span>

		<span>if</span> <span>(</span>downsampleLevels <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
			
			<span>const</span> finalBrightness <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> <span>1.0</span> <span>:</span> ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>value<span>;</span>
			<span>const</span> totalPasses <span>=</span> <span>2</span> <span>*</span> downsampleLevels<span>;</span>
			<span>const</span> distributedBrightness <span>=</span> Math<span>.</span><span>pow</span><span>(</span>finalBrightness<span>,</span> <span>1.0</span> <span>/</span> totalPasses<span>)</span><span>;</span>
			
			
			gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>downsample<span>.</span>handle<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>downsample<span>.</span>uniforms<span>.</span>offset<span>,</span> ui<span>.</span>blur<span>.</span>samplePos<span>.</span>value<span>)</span><span>;</span>
			
			<span>let</span> w <span>=</span> canvas<span>.</span>width<span>,</span> h <span>=</span> canvas<span>.</span>height<span>;</span>
			<span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> downsampleLevels<span>;</span> <span>++</span>i<span>)</span> <span>{</span>
				<span>const</span> fb <span>=</span> ctx<span>.</span>fb<span>.</span>down<span>[</span>i<span>]</span><span>;</span>
				w <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> w <span>&gt;&gt;</span> <span>1</span><span>)</span><span>;</span>
				h <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> h <span>&gt;&gt;</span> <span>1</span><span>)</span><span>;</span>

				gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> fb<span>)</span><span>;</span>
				gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> w<span>,</span> h<span>)</span><span>;</span>

				<span>const</span> frameSizeRCP <span>=</span> <span>[</span><span>1.0</span> <span>/</span> w<span>,</span> <span>1.0</span> <span>/</span> h<span>]</span><span>;</span>
				gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>downsample<span>.</span>uniforms<span>.</span>frameSizeRCP<span>,</span> frameSizeRCP<span>)</span><span>;</span>
				gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>downsample<span>.</span>uniforms<span>.</span>bloomStrength<span>,</span> distributedBrightness<span>)</span><span>;</span>

				gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
				gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> srcTex<span>)</span><span>;</span>
				gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
				srcTex <span>=</span> ctx<span>.</span>tex<span>.</span>down<span>[</span>i<span>]</span><span>;</span>
			<span>}</span>

			
			gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>upsample<span>.</span>handle<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>upsample<span>.</span>uniforms<span>.</span>offset<span>,</span> ui<span>.</span>blur<span>.</span>samplePos<span>.</span>value<span>)</span><span>;</span>
			
			<span>for</span> <span>(</span><span>let</span> i <span>=</span> downsampleLevels <span>-</span> <span>2</span><span>;</span> i <span>&gt;=</span> <span>0</span><span>;</span> i<span>--</span><span>)</span> <span>{</span>
				<span>const</span> fb <span>=</span> ctx<span>.</span>fb<span>.</span>down<span>[</span>i<span>]</span><span>;</span>
				w <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> canvas<span>.</span>width <span>&gt;&gt;</span> <span>(</span>i <span>+</span> <span>1</span><span>)</span><span>)</span><span>;</span>
				h <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> canvas<span>.</span>height <span>&gt;&gt;</span> <span>(</span>i <span>+</span> <span>1</span><span>)</span><span>)</span><span>;</span>

				gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> fb<span>)</span><span>;</span>
				gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> w<span>,</span> h<span>)</span><span>;</span>

				<span>const</span> srcW <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> canvas<span>.</span>width <span>&gt;&gt;</span> <span>(</span>i <span>+</span> <span>2</span><span>)</span><span>)</span><span>;</span>
				<span>const</span> srcH <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> canvas<span>.</span>height <span>&gt;&gt;</span> <span>(</span>i <span>+</span> <span>2</span><span>)</span><span>)</span><span>;</span>
				<span>const</span> frameSizeRCP <span>=</span> <span>[</span><span>1.0</span> <span>/</span> srcW<span>,</span> <span>1.0</span> <span>/</span> srcH<span>]</span><span>;</span>
				gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>upsample<span>.</span>uniforms<span>.</span>frameSizeRCP<span>,</span> frameSizeRCP<span>)</span><span>;</span>
				gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>upsample<span>.</span>uniforms<span>.</span>bloomStrength<span>,</span> distributedBrightness<span>)</span><span>;</span>

				gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
				gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> srcTex<span>)</span><span>;</span>
				gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
				srcTex <span>=</span> ctx<span>.</span>tex<span>.</span>down<span>[</span>i<span>]</span><span>;</span>
			<span>}</span>

			
			<span>const</span> finalFB <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;bloom&#34;</span> <span>?</span> ctx<span>.</span>fb<span>.</span>final <span>:</span> <span>null</span><span>;</span>
			gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> finalFB<span>)</span><span>;</span>
			gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>

			<span>const</span> srcW <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> canvas<span>.</span>width <span>&gt;&gt;</span> <span>1</span><span>)</span><span>;</span>
			<span>const</span> srcH <span>=</span> Math<span>.</span><span>max</span><span>(</span><span>1</span><span>,</span> canvas<span>.</span>height <span>&gt;&gt;</span> <span>1</span><span>)</span><span>;</span>
			<span>const</span> frameSizeRCP <span>=</span> <span>[</span><span>1.0</span> <span>/</span> srcW<span>,</span> <span>1.0</span> <span>/</span> srcH<span>]</span><span>;</span>
			gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>upsample<span>.</span>uniforms<span>.</span>frameSizeRCP<span>,</span> frameSizeRCP<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>upsample<span>.</span>uniforms<span>.</span>bloomStrength<span>,</span> distributedBrightness<span>)</span><span>;</span>

			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> srcTex<span>)</span><span>;</span>
			gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
			
			<span>if</span> <span>(</span>ctx<span>.</span>mode <span>!=</span> <span>&#34;bloom&#34;</span><span>)</span> <span>{</span>
				srcTex <span>=</span> ctx<span>.</span>tex<span>.</span>frameFinal<span>;</span>
			<span>}</span>
		<span>}</span> <span>else</span> <span>{</span>
			
			<span>const</span> finalFB <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;bloom&#34;</span> <span>?</span> ctx<span>.</span>fb<span>.</span>final <span>:</span> <span>null</span><span>;</span>
			gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> finalFB<span>)</span><span>;</span>
			gl<span>.</span><span>viewport</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>
			gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>passthrough<span>.</span>handle<span>)</span><span>;</span>
			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> srcTex<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1i</span><span>(</span>gl<span>.</span><span>getUniformLocation</span><span>(</span>ctx<span>.</span>shd<span>.</span>passthrough<span>.</span>handle<span>,</span> <span>&#34;texture&#34;</span><span>)</span><span>,</span> <span>0</span><span>)</span><span>;</span>
			<span>const</span> bloomStrength <span>=</span> ctx<span>.</span>mode <span>==</span> <span>&#34;scene&#34;</span> <span>?</span> <span>1.0</span> <span>:</span> ui<span>.</span>rendering<span>.</span>lightBrightness<span>.</span>value<span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>gl<span>.</span><span>getUniformLocation</span><span>(</span>ctx<span>.</span>shd<span>.</span>passthrough<span>.</span>handle<span>,</span> <span>&#34;bloomStrength&#34;</span><span>)</span><span>,</span> bloomStrength<span>)</span><span>;</span>
			gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
			
			<span>if</span> <span>(</span>ctx<span>.</span>mode <span>!=</span> <span>&#34;bloom&#34;</span><span>)</span> <span>{</span>
				srcTex <span>=</span> ctx<span>.</span>tex<span>.</span>frameFinal<span>;</span>
			<span>}</span>
		<span>}</span>

		<span>if</span> <span>(</span>ctx<span>.</span>mode <span>==</span> <span>&#34;bloom&#34;</span><span>)</span> <span>{</span>
			
			gl<span>.</span><span>bindFramebuffer</span><span>(</span>gl<span>.</span><span>FRAMEBUFFER</span><span>,</span> <span>null</span><span>)</span><span>;</span>
			gl<span>.</span><span>useProgram</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>handle<span>)</span><span>;</span>

			gl<span>.</span><span>uniform2fv</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>offset<span>,</span> offset<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1f</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>radius<span>,</span> radiusSwitch<span>)</span><span>;</span>

			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE0</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>sdr<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1i</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>texture<span>,</span> <span>0</span><span>)</span><span>;</span>

			gl<span>.</span><span>activeTexture</span><span>(</span>gl<span>.</span><span>TEXTURE1</span><span>)</span><span>;</span>
			gl<span>.</span><span>bindTexture</span><span>(</span>gl<span>.</span><span>TEXTURE_2D</span><span>,</span> ctx<span>.</span>tex<span>.</span>frameFinal<span>)</span><span>;</span>
			gl<span>.</span><span>uniform1i</span><span>(</span>ctx<span>.</span>shd<span>.</span>bloom<span>.</span>uniforms<span>.</span>textureAdd<span>,</span> <span>1</span><span>)</span><span>;</span>

			gl<span>.</span><span>drawArrays</span><span>(</span>gl<span>.</span><span>TRIANGLE_FAN</span><span>,</span> <span>0</span><span>,</span> <span>4</span><span>)</span><span>;</span>
		<span>}</span>

		
		gl<span>.</span><span>finish</span><span>(</span><span>)</span><span>;</span>

		<span>const</span> now <span>=</span> performance<span>.</span><span>now</span><span>(</span><span>)</span><span>;</span>
		<span>let</span> dt <span>=</span> now <span>-</span> prevNow<span>;</span>

		<span>if</span> <span>(</span>dt <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
			<span>const</span> instFPS <span>=</span> <span>1000</span> <span>/</span> dt<span>;</span>
			<span>const</span> <span>ALPHA</span> <span>=</span> <span>0.05</span><span>;</span>
			fpsEMA <span>=</span> <span>ALPHA</span> <span>*</span> instFPS <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>ALPHA</span><span>)</span> <span>*</span> fpsEMA<span>;</span>
			msEMA <span>=</span> <span>ALPHA</span> <span>*</span> dt <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>ALPHA</span><span>)</span> <span>*</span> msEMA<span>;</span>
		<span>}</span>
		prevNow <span>=</span> now<span>;</span>

		<span>if</span> <span>(</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked <span>&amp;&amp;</span> now <span>-</span> lastStatsUpdate <span>&gt;=</span> <span>1000</span><span>)</span> <span>{</span>
			ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> fpsEMA<span>.</span><span>toFixed</span><span>(</span><span>0</span><span>)</span><span>;</span>
			ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> msEMA<span>.</span><span>toFixed</span><span>(</span><span>2</span><span>)</span><span>;</span>
			lastStatsUpdate <span>=</span> now<span>;</span>
		<span>}</span>
	<span>}</span>

	<span>let</span> animationFrameId<span>;</span>

	
	<span>function</span> <span>nativeResize</span><span>(</span><span>)</span> <span>{</span>
		<span>const</span> <span>[</span>width<span>,</span> height<span>]</span> <span>=</span> util<span>.</span><span>getNativeSize</span><span>(</span>canvas<span>)</span><span>;</span>

		<span>if</span> <span>(</span>width <span>&amp;&amp;</span> canvas<span>.</span>width <span>!==</span> width <span>||</span> height <span>&amp;&amp;</span> canvas<span>.</span>height <span>!==</span> height<span>)</span> <span>{</span>
			canvas<span>.</span>width <span>=</span> width<span>;</span>
			canvas<span>.</span>height <span>=</span> height<span>;</span>

			<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>benchMode<span>)</span> <span>{</span>
				<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
				<span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span>
			<span>if</span> <span>(</span><span>!</span>ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span>
				<span>redraw</span><span>(</span><span>)</span><span>;</span>
		<span>}</span>
	<span>}</span>

	
	<span>nativeResize</span><span>(</span><span>)</span><span>;</span>

	<span>let</span> resizePending <span>=</span> <span>false</span><span>;</span>
	window<span>.</span><span>addEventListener</span><span>(</span><span>&#39;resize&#39;</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
		<span>if</span> <span>(</span><span>!</span>resizePending<span>)</span> <span>{</span>
			resizePending <span>=</span> <span>true</span><span>;</span>
			<span>requestAnimationFrame</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
				resizePending <span>=</span> <span>false</span><span>;</span>
				<span>nativeResize</span><span>(</span><span>)</span><span>;</span>
			<span>}</span><span>)</span><span>;</span>
		<span>}</span>
	<span>}</span><span>)</span><span>;</span>

	<span>function</span> <span>renderLoop</span><span>(</span><span>)</span> <span>{</span>
		<span>if</span> <span>(</span>ctx<span>.</span>flags<span>.</span>isRendering <span>&amp;&amp;</span> ui<span>.</span>rendering<span>.</span>animate<span>.</span>checked<span>)</span> <span>{</span>
			<span>redraw</span><span>(</span><span>)</span><span>;</span>
			animationFrameId <span>=</span> <span>requestAnimationFrame</span><span>(</span>renderLoop<span>)</span><span>;</span>
		<span>}</span>
	<span>}</span>

	<span>function</span> <span>startRendering</span><span>(</span><span>)</span> <span>{</span>
		
		ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>true</span><span>;</span>
		<span>renderLoop</span><span>(</span><span>)</span><span>;</span>
	<span>}</span>

	<span>function</span> <span>stopRendering</span><span>(</span><span>)</span> <span>{</span>
		
		ctx<span>.</span>flags<span>.</span>isRendering <span>=</span> <span>false</span><span>;</span>
		<span>cancelAnimationFrame</span><span>(</span>animationFrameId<span>)</span><span>;</span>
		
		gl<span>.</span><span>finish</span><span>(</span><span>)</span><span>;</span>

		
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>sdr<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>sdr <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>selfIllum<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>selfIllum <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>frame<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>frame <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>frameFinal<span>)</span><span>;</span> ctx<span>.</span>tex<span>.</span>frameFinal <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>scene<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>scene <span>=</span> <span>null</span><span>;</span>
		gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>final<span>)</span><span>;</span> ctx<span>.</span>fb<span>.</span>final <span>=</span> <span>null</span><span>;</span>
		<span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>parseInt</span><span>(</span>ui<span>.</span>blur<span>.</span>downsample<span>.</span>max<span>)</span><span>;</span> <span>++</span>i<span>)</span> <span>{</span>
			gl<span>.</span><span>deleteTexture</span><span>(</span>ctx<span>.</span>tex<span>.</span>down<span>[</span>i<span>]</span><span>)</span><span>;</span>
			gl<span>.</span><span>deleteFramebuffer</span><span>(</span>ctx<span>.</span>fb<span>.</span>down<span>[</span>i<span>]</span><span>)</span><span>;</span>
		<span>}</span>
		ctx<span>.</span>tex<span>.</span>down <span>=</span> <span>[</span><span>]</span><span>;</span>
		ctx<span>.</span>fb<span>.</span>down <span>=</span> <span>[</span><span>]</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>buffersInitialized <span>=</span> <span>false</span><span>;</span>
		ctx<span>.</span>flags<span>.</span>initComplete <span>=</span> <span>false</span><span>;</span>
		ui<span>.</span>display<span>.</span>fps<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
		ui<span>.</span>display<span>.</span>ms<span>.</span>value <span>=</span> <span>&#34;-&#34;</span><span>;</span>
	<span>}</span>

	<span>function</span> <span>handleIntersection</span><span>(</span><span>entries</span><span>)</span> <span>{</span>
		entries<span>.</span><span>forEach</span><span>(</span><span>entry</span> <span>=&gt;</span> <span>{</span>
			<span>if</span> <span>(</span>entry<span>.</span>isIntersecting<span>)</span> <span>{</span>
				<span>if</span> <span>(</span><span>!</span>ctx<span>.</span>flags<span>.</span>isRendering <span>&amp;&amp;</span> <span>!</span>ctx<span>.</span>flags<span>.</span>benchMode<span>)</span> <span>startRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span> <span>else</span> <span>{</span>
				<span>stopRendering</span><span>(</span><span>)</span><span>;</span>
			<span>}</span>
		<span>}</span><span>)</span><span>;</span>
	<span>}</span>

	
	<span>let</span> observer <span>=</span> <span>new</span> <span>IntersectionObserver</span><span>(</span>handleIntersection<span>)</span><span>;</span>
	observer<span>.</span><span>observe</span><span>(</span>canvas<span>)</span><span>;</span>
<span>}</span></code></pre></details></blockquote><p>It‚Äôs also a gaussian-like blur. Remember our first gaussian Blur? Its performance tanked exponentially, as we increased kernel radius. But now, with each downsample step, the required texture taps grow slower and slower. The stronger our blur, the less <em>additional</em> samples we require!</p><p>This was of special interest to Marius Bj√∏rge, as his goal was to reduce memory access, which is especially slow on mobile devices, and still produce a motion-stable non shimmering blur. Speaking of which, go into bloom mode, crank <code>lightBrightness</code> and compare it to our <a href="#downsampling">downsample</a> example.</p><p>Even though the resolution is reduced to the same <code>downSample</code> level, no shimmering! That‚Äôs the Dual Kawase Blur for you - A gaussian-like post-processing blur, with good performance, no heavy repeated memory writes and motion stable output. This makes it ideal as a basic building block for visual effects like bloom.</p><h2 id="what-are-the-big-boys-doing%3F" tabindex="-1">What are the big boys doing? <a href="#what-are-the-big-boys-doing%3F">#</a></h2><p>The Dual Kawase Blur has found its way into game engines and user interfaces alike. For instance the Linux Desktop Environment <a href="https://kde.org/" target="_blank">KDE</a> uses it as the frosted backdrop effect <a href="https://web.archive.org/web/20220427124712/https://phabricator.kde.org/D9848" target="_blank">since in 2018</a>, where it remains the <a href="https://invent.kde.org/plasma/kwin/-/tree/master/src/plugins/blur" target="_blank">algorithm of choice to this day</a>. I used KDE‚Äôs implementation as a guide when creating my demo above.</p><figure><img src="https://blog.frost.kiwi/dual-kawase/img/kdeBlur.png" alt="KDE Plasma&#39;s Blur with noise at max strength"/><figcaption>KDE Plasma&#39;s Blur with noise at max strength (<a href="https://web.archive.org/web/20220427124712/https://phabricator.kde.org/D9848" target="_blank">Source</a>)</figcaption></figure><p>Of course, graphics programming didn‚Äôt stop in 2015 and there have been new developments. The previously mentioned talk <a href="https://www.iryoku.com/next-generation-post-processing-in-call-of-duty-advanced-warfare/" target="_blank">Next Generation Post Processing in Call of Duty: Advanced Warfare</a> by <a href="https://www.iryoku.com/" target="_blank">Jorge Jimenez</a> showcased an evolution on the ‚Äúdownsample while blurring‚Äù idea to handle far-away and very bright lights at high blur strengths better.</p><figure><video controls="" playsinline="" poster="img/jimenezBlurThumb.jpg"><source src="img/jimenezBlur.mp4" type="video/mp4"/></video><figcaption>Uneven interpolation of bright, small light sources (Left), Page 156 from presentation</figcaption></figure><p>In turn, this technique got picked up two years later by graphics programmer <a href="https://x.com/pixelmager" target="_blank">Mikkel Gjoel</a>, when working on the video game <a href="https://en.wikipedia.org/wiki/Inside_(video_game)" target="_blank">INSIDE</a> by Studio <a href="https://playdead.com/" target="_blank">Playdead</a>. In the GDC 2016 talk <a href="https://gdcvault.com/play/1023304/Low-Complexity-High-Fidelity-INSIDE" target="_blank">Low Complexity, High Fidelity - INSIDE Rendering</a> he showcased a further optimization, reducing the number of texture reads required.</p><figure><video controls="" playsinline="" poster="img/gdcInsideThumb.jpg"><source src="img/gdcInside.mp4" type="video/mp4"/></video><figcaption>Blur algorithm used for Bloom in video game Inside</figcaption></figure><p>I showcased the bloom use-case a lot. The technique used in my demos is rather primitive, akin to the time of video game <a href="https://gangles.ca/2008/07/18/bloom-disasters/" target="_blank">bloom disasters</a>, where some many games had radioactive levels of bloom, showing off a then novel technique. In this older style an extra lights pass or the scene after <a href="https://en.wikipedia.org/wiki/Thresholding_(image_processing)" target="_blank">thresholding</a>, was blurred and added on top.</p><figure><img src="https://blog.frost.kiwi/dual-kawase/img/bloom-oblivion.jpg" alt="Bloom in Video game "/><figcaption>Bloom in Video game <a href="https://en.wikipedia.org/wiki/The_Elder_Scrolls_IV:_Oblivion" target="_blank">The Elder Scrolls IV: Oblivion</a>, from article by <a href="https://gangles.ca/2008/07/18/bloom-disasters/" target="_blank">Bloom Disasters</a></figcaption></figure><p>These days 3D engines follow a <a href="https://learnopengl.com/PBR/Theory" target="_blank">Physically based shading</a> model, with HDR framebuffers capturing pixels in an <a href="https://learnopengl.com/Getting-started/Textures#:~:text=Energy%20conservation" target="_blank">energy conserving</a> manner. Specular light reflections preserve the super bright pixels from the lamp they originated from.</p><p>With such a wide range of energy values, light that should bloom doesn‚Äôt need special selection anymore. Instead of defining what to blur, everything is blurred and the bright parts naturally start glowing, without predefined ‚Äúparts to blur‚Äù.</p><figure><img src="https://blog.frost.kiwi/dual-kawase/img/bloom.png" alt="Physically Based Blur"/><figcaption>Multiple blurs stacked to create a natural light fall-off</figcaption></figure><p>The result isn‚Äôt just blurred once, but rather multiple blur strengths are stacked on top of each other, for a more natural light fall-off, as shown in the previously mentioned talk by Jorge Jimenez. This isn‚Äôt an article about bloom, but the underlying building block. The Blur.</p><p>This was a journey through blurs and I hope you enjoyed the ride! If you are a new visitor from the <a href="https://some.3b1b.co/" target="_blank">Summer of Math Exposition</a> and enjoyed this article, you‚Äôll enjoy my other graphics programming deep-dives on this blog. Also during SoME 3, my submission was a WebApp + Video Adventure into Mirrorballs:</p><figure><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="" frameborder="0" loading="lazy" src="https://www.youtube-nocookie.com/embed/rJPKTCdk-WI" title="YouTube video player" width="100%"></iframe><figcaption>Mathematical Magic Mirrorball #SoME3</figcaption></figure><h2 id="addendum" tabindex="-1">Addendum <a href="#addendum">#</a></h2><p>Additional things that came to light as a result of discussions around this article.</p><h3 id="upsample-skip-steps-technique" tabindex="-1">Upsample skip steps technique <a href="#upsample-skip-steps-technique">#</a></h3><p>In the <a href="#downsampling">downsampling</a> chapter I mentioned, that skipping upsample steps will result in ‚Äú<em>a vague grid like artifact appearing</em>‚Äù. In an E-Mail, Masaki Kawase expanded on this with a reference to his <a href="https://www.siliconstudio.co.jp/rd/presentations/#CEDEC2009" target="_blank">2009 CEDEC</a> talk <a href="https://www.siliconstudio.co.jp/rd/presentations/files/CEDEC2009/CEDEC2009_Anti-DownsizedBufferArtifacts.ppt" target="_blank">Anti-Downsized Buffer Artifacts</a>, that there is an in-between path, when the Downscale - Upsample chain is a bit longer.</p><figure><p><img src="https://blog.frost.kiwi/dual-kawase/img/2Times2009_2.jpg"/> <img src="https://blog.frost.kiwi/dual-kawase/img/2Times2009_1.jpg"/></p><figcaption>Skipping Upsample steps and the resulting artifacts (Left) vs performing one intermediary upsample step with 4-Tap Blur, before going on to skipping the remaining intermediary up-sample steps with reduced artifacts (Right)</figcaption></figure><p>This involves performing a slight 4 Texture-Tap blur on the very first upsample from the smallest to 2nd smallest framebuffer size and then skipping all the remaining upscample steps, a technique explained in the above linked talk from page 72 onwards. A balance of a longer upsample chain vs the appearance of artifacts.</p><h3 id="multiple-blurs-stacked" tabindex="-1">Multiple blurs stacked <a href="#multiple-blurs-stacked">#</a></h3><p>I was surprised to learn that the ‚ÄúMultiple blurs stacked to create a natural light fall-off‚Äù thing was <em>also</em> presented by Masaki Kawase in the 2004 GDC talk <a href="https://gdcvault.com/play/1015174/Practical-Implementation-of-High-Dynamic" target="_blank">Practical Implementation of High Dynamic Range Rendering</a>. Those couple of years in particular were quite eventful for graphics programming!</p><figure><video controls="" playsinline="" poster="vid/2004-Gdc-Kawase-Practical-Hdr_thjumb.jpg"><source src="vid/2004-Gdc-Kawase-Practical-Hdr.mp4" type="video/mp4"/></video><figcaption>Use of Multiple Gaussian Filters, Excerpt from the 2004 GDC Talk</figcaption></figure><blockquote><p>Didn&#39;t even know about this connection, truly a graphics programmer idol of mine</p><img src="https://blog.frost.kiwi/assets/kiwis/love.svg"/></blockquote><p>Here are the 3 slides mentioned in the excerpt from the talk:</p><figure><p><img src="https://blog.frost.kiwi/dual-kawase/img/kawase2004_1.jpg"/> <img src="https://blog.frost.kiwi/dual-kawase/img/kawase2004_2.jpg"/> <img src="https://blog.frost.kiwi/dual-kawase/img/kawase2004_3.jpg"/></p><figcaption>Page 31 - 33 from the 2004 GDC Talk</figcaption></figure></div></div>
  </body>
</html>
