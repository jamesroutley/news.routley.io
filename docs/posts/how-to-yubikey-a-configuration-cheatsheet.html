<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://debugging.works/blog/yubikey-cheatsheet/">Original</a>
    <h1>How to Yubikey: A Configuration Cheatsheet</h1>
    
    <div id="readability-page-1" class="page"><div>
        <p>This post shows different use cases for a Yubikey. There are also command line examples in a cheatsheet like manner. I‚Äôm using a Yubikey 5C on Arch Linux. If you run into issues, try to use a newer version of <code>ykman</code> (part of <a href="https://archlinux.org/packages/community/any/yubikey-manager/">yubikey-manager</a> package on Arch).</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>kmille@linbox:~ ykman --version
</span></span><span><span>YubiKey Manager (ykman) version: 4.0.9
</span></span></code></pre></div><p>Some features depend on the firmware version of the Yubikey. The tooling (like the wording) around the Yubikey is sometimes a bit confusing. I use this guide as a reference if I need to reconfigure something after a long time. It helped me in the past, so I made a clean rewrite. I hope it helps you too. Please get in contact with me if something is wrong/missing (<a href="https://news.ycombinator.com/item?id=35091768">Hacker News discussion</a>).</p>



<p>To check if your Yubikey was detected successfully and find out which modes are enabled, use:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>kmille@linbox:~ ykman list
</span></span><span><span>YubiKey <span>5</span> NFC (5.1.2) [OTP+FIDO+CCID] Serial: <span>1312</span>
</span></span><span><span>
</span></span><span><span>kmille@linbox:yubikey ykman info
</span></span><span><span>Device type: YubiKey <span>5</span> NFC
</span></span><span><span>Serial number: <span>1312</span>
</span></span><span><span>Firmware version: 5.1.2
</span></span><span><span>Form factor: Keychain (USB-A)
</span></span><span><span>Enabled USB interfaces: OTP, FIDO, CCID
</span></span><span><span>NFC transport is enabled.
</span></span><span><span>
</span></span><span><span>Applications    USB             NFC
</span></span><span><span>FIDO2           Enabled         Enabled
</span></span><span><span>OTP             Enabled         Enabled
</span></span><span><span>FIDO U2F        Enabled         Enabled
</span></span><span><span>OATH            Enabled         Enabled
</span></span><span><span>YubiHSM Auth    Not available   Not available
</span></span><span><span>OpenPGP         Enabled         Enabled
</span></span><span><span>PIV             Enabled         Enabled
</span></span><span><span>
</span></span><span><span>ykman config nfc --disable PIV
</span></span><span><span>ykman config usb --enable-all
</span></span></code></pre></div>
<p>In general, TOTP (time based one time password) is used for 2FA (two-factor authentication). It gives you a 6 (sometimes 8) digit token you have to enter during login. The secret key is formatted in base32 (e. g. <code>H7TTOPOIDLOXGT4E</code>). You can add 32 of these secrets to a Yubikey device. If you prefer a GUI application, you can use Yubico Authenticator (part of the <a href="https://archlinux.org/packages/community/x86_64/yubioath-desktop/">yubioath-desktop</a> package). Yubico Authenticator does not store the secret, it asks the Yubikey device for the token. There is also the <a href="https://play.google.com/store/apps/details?id=com.yubico.yubioath&amp;hl=fr&amp;gl=US">Yubico Authenticator</a> with NFC support for Android.</p>
<figure><img src="https://www.sourencho.com/images/yubikey/yubioath-desktop.png"/>
</figure>

<p>Command line tooling with <code>ykman</code>:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>kmille@linbox:~ ykman oath accounts add test --touch
</span></span><span><span>Enter a secret key (base32): H7TTOPOIDLOXGT4E
</span></span><span><span>kmille@linbox:~ ykman oath accounts list
</span></span><span><span>test
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman oath accounts code
</span></span><span><span>Touch your YubiKey...
</span></span><span><span>test  <span>629211</span>
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman oath accounts code -s Hetzner
</span></span><span><span>Touch your YubiKey...
</span></span><span><span><span>940658</span>
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman oath accounts delete test
</span></span><span><span>Delete account: test ? [y/N]: y
</span></span><span><span>Deleted test.
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman oath accounts list
</span></span><span><span>kmille@linbox:~
</span></span></code></pre></div><p>It‚Äôs important to backup the secret. If your Yubikey is lost, you can still login by adding the secret to other tools like the Google Authenticator or by using a  few lines of python code. <a href="https://archlinux.org/packages/community/x86_64/keepassxc/">KeepassXC</a> also has a neat feature for TOTP. But please don‚Äôt save it in the same Keepass database you use daily.</p>
<div><pre tabindex="0"><code data-lang="python"><span><span><span>import</span> time
</span></span><span><span><span>import</span> pyotp
</span></span><span><span>
</span></span><span><span>otp = pyotp.totp.TOTP(<span>&#34;H7TTOPOIDLOXGT4E&#34;</span>)
</span></span><span><span><span>while</span> <span>1</span>:
</span></span><span><span>    print(otp.now())
</span></span><span><span>    time.sleep(<span>2</span>)
</span></span></code></pre></div><p>This prints the 6-digit token every two seconds (needs <code>pip install --user pyotp</code>).</p>

<p>Sometimes <a href="https://en.wikipedia.org/wiki/Universal_2nd_Factor">U2F</a> is also called FIDO2 or <a href="https://en.wikipedia.org/wiki/WebAuthn">WebAuthn</a>. Like TOTP tokens, U2F can be used during web logins for two-factor authentication. The TOTP variant is prone to phishing attacks, as users enter their tokens also on phishing sites. U2F solves this problem by using a challenge response mechanism that includes the SSL Channel ID and the browser url of the login page (<a href="https://developers.yubico.com/U2F/Protocol_details/Overview.html">docs</a>). If you use U2F, the browser speaks directly to the Yubikey device, no special drivers or tools are necessary. All major browsers <a href="https://caniuse.com/?search=webauth">support U2F</a>. On Arch Linux, you have to install the <a href="https://archlinux.org/packages/extra/x86_64/libfido2/">libfido2</a> package. If you use <a href="https://wiki.archlinux.org/title/firejail">Firejail</a> sandbox, you need to set <code>browser-disable-u2f no</code> in <code>/etc/firejail/firejail.config</code>.</p>
<p>U2F is very easy to use. During setup, you pair an online account with a Yubikey device. During login, you only have to touch the Yubikey. Watch this <a href="https://youtu.be/O8yYUMfjMBg?t=275">demo</a> on Youtube to get a feeling for it. You can test U2F on the <a href="https://demo.yubico.com/webauthn-technical/registration">Yubico demo website</a>. It‚Äôs also very nice to use it on Android with NFC.</p>
<p>Backup strategy: You can‚Äôt make a backup as you don‚Äôt have a secret you can backup. So you have to add multiple U2F devices to your account or add TOTP as additional 2FA method. A backup can also be your IT department, if they can give you access again. Google deployed U2F to their <a href="https://fidoalliance.org/case-study-series-google-security-keys-work/">50,000 employees</a>.</p>
<h2 id="ssh-with-fido2-u2f">
  SSH with FIDO2 (U2F)
  <a href="#ssh-with-fido2-u2f">
    <i aria-hidden="true"></i>
  </a>
</h2>
<p>I don‚Äôt use this feature, because my Yubikey firmware is too old for my needs. I can‚Äôt use ed25519 (only the <a href="https://nbeguier.medium.com/a-real-world-comparison-of-the-ssh-key-algorithms-b26b0b31bfd9">NSA curve sk-ecdsa-sha2-nistp256</a>) and the resident feature works only on firmware 5.2.3 or higher. If you are interested, here are good  reads:</p>
<ul>
<li><a href="https://www.stavros.io/posts/u2f-fido2-with-ssh/">https://www.stavros.io/posts/u2f-fido2-with-ssh/</a></li>
<li><a href="https://developers.yubico.com/SSH/Securing_SSH_with_FIDO2.html">https://developers.yubico.com/SSH/Securing_SSH_with_FIDO2.html</a></li>
<li><a href="https://gist.github.com/reanim8ed/35a998b018f976e1189fe7266b2d1a43">https://gist.github.com/reanim8ed/35a998b018f976e1189fe7266b2d1a43</a></li>
</ul>
<div><pre tabindex="0"><code data-lang="bash"><span><span>kmille@linbox:~ ssh-keygen -t ed25519-sk
</span></span><span><span>Generating public/private ed25519-sk key pair.
</span></span><span><span>You may need to touch your authenticator to authorize key generation.
</span></span><span><span>Key enrollment failed: requested feature not supported
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ssh-keygen -t ecdsa-sk -O resident
</span></span><span><span>Generating public/private ecdsa-sk key pair.
</span></span><span><span>You may need to touch your authenticator to authorize key generation.
</span></span><span><span>Key enrollment failed: requested feature not supported
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ssh-keygen -t ecdsa-sk
</span></span><span><span>Generating public/private ecdsa-sk key pair.
</span></span><span><span>You may need to touch your authenticator to authorize key generation.
</span></span><span><span>Enter file in which to save the key (/home/kmille/.ssh/id_ecdsa_sk):
</span></span><span><span>Enter passphrase (empty <span>for</span> no passphrase):
</span></span><span><span>Enter same passphrase again:
</span></span><span><span>Your identification has been saved in /home/kmille/.ssh/id_ecdsa_sk
</span></span><span><span>Your public key has been saved in /home/kmille/.ssh/id_ecdsa_sk.pub
</span></span></code></pre></div>
<p>You can use the Yubikey to simulate a keyboard (HID - Human Interface Device) to enter a static password. For the YubiKey 5 NFC, there are two slots you can use (a short touch triggers slot 1, long touch triggers slot 2). I don‚Äôt see any use case or security benefits by using the static password feature. Even if you enter a password manually and concatenate it with the password of the Yubikey, a keylogger still gets both parts (assumption: You don‚Äôt reuse passwords). The only advantage would be that you don‚Äôt have to remember the complex password.
This is how you can use it:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>kmille@linbox:~ ykman otp static --keyboard-layout de <span>1</span>
</span></span><span><span>Enter a static password: hello world
</span></span><span><span>Slot <span>1</span> is already configured. Overwrite configuration? [y/N]: y
</span></span><span><span>
</span></span><span><span><span># touch the Yubikey</span>
</span></span><span><span>kmille@linbox:~ hello world
</span></span><span><span>zsh: command not found: hello
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman otp delete <span>1</span>
</span></span><span><span>Do you really want to delete the configuration of slot 1? [y/N]: y
</span></span><span><span>Deleting the configuration in slot 1...
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman otp info
</span></span><span><span>Slot 1: empty
</span></span><span><span>Slot 2: programmed
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman otp static --generate <span>2</span> --length <span>32</span>
</span></span><span><span>Slot <span>2</span> is already configured. Overwrite configuration? [y/N]: y
</span></span><span><span>
</span></span><span><span><span># touch the Yubikey</span>
</span></span><span><span>kmille@linbox:~ FiNIFRNhbDRhKEbFLrDNLbkJedkiELhn
</span></span><span><span>zsh: command not found: FiNIFRNhbDRhKEbFLrDNLbkJedkiELhn
</span></span><span><span>kmille@linbox:~
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman otp swap
</span></span><span><span>Swap the two slots of the YubiKey? [y/N]: y
</span></span><span><span>Swapping slots...
</span></span></code></pre></div><p>If you prefer a GUI tool, you can use the <a href="https://archlinux.org/packages/community/x86_64/yubikey-personalization-gui/">YubiKey Personalization Tool</a>. Steps are</p>
<ol>
<li>Go to ‚Äòstatic password mode‚Äô</li>
<li>Scan code</li>
<li>Choose configuration slot 1/2 (short/long press)</li>
<li>You have to choose a keyboard layout before you can enter a password (usability is meh)</li>
<li>Enter password</li>
<li>Write configuration</li>
<li>Test it an a text editor</li>
</ol>

<p>To be precise, the Yubikey is not a true second factor. KeepassXC uses the challenge-response mechanism of the Yubikey. The challenge (and therefore the response) is not unique for every authentication attempt (decrypting the database). So the challenge/response can be sniffed via USB by an attacker. For more information read <a href="https://security.stackexchange.com/a/258414">this answer on StackExchange</a> and also check the <a href="https://keepassxc.org/docs/#faq-yubikey-2fa">FAQs</a> of KeepassXC about the use of Yubikey. For the setup, you first have to enable the challenge-response feature and add/generate a secret for a slot:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>kmille@linbox:~ ykman otp info
</span></span><span><span>Slot 1: empty
</span></span><span><span>Slot 2: empty
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman otp chalresp --touch --generate <span>2</span>
</span></span><span><span>Using a randomly generated key (hex): 874352e9f826d9c0cbc497113cbf7921fb962d76
</span></span><span><span>Program a challenge-response credential in slot 2? [y/N]: y
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman otp info
</span></span><span><span>Slot 1: empty
</span></span><span><span>Slot 2: programmed
</span></span></code></pre></div><p>To pair your Keepass database with the Yubikey, open your database (I use KeePassXC) and go to: Database -&gt; Database Security -&gt; Change Password -&gt; add additional protection -&gt; Add Challenge-Response -&gt; Refresh</p>
<figure><img src="https://www.sourencho.com/images/yubikey/Keepass.png"/>
</figure>

<p>This also works nice with NFC on Android using the <a href="https://play.google.com/store/apps/details?id=keepass2android.keepass2android&amp;hl=fr&amp;gl=US">Keepass2Android</a> app (needs <a href="https://github.com/pp3345/ykDroid">ykdroid</a>, choose ‚ÄúPassword + Challenge-Response for KeepassXC‚Äù). If you want to have a backup for your Yubikey, use another device with the same secret.</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>kmille@linbox:~ ykman otp chalresp --touch <span>2</span>
</span></span><span><span>Enter a secret key: 874352e9f826d9c0cbc497113cbf7921fb962d76
</span></span><span><span>Program a challenge-response credential in slot 2? [y/N]: y
</span></span></code></pre></div><p>Keep in mind that this feature uses the same slots as the static password functionality. If your Keepass is sandboxed with firejail, you need the following lines in <code>~/.config/firejail/keepassxc.local</code>:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>protocol netlink,unix
</span></span><span><span>ignore private-dev
</span></span></code></pre></div>
<p>You can use the challenge-response feature of the Yubikey to enable 2FA for full disk encryption (<code>luks</code>). There is a project for <a href="https://github.com/cornelinux/yubikey-luks">Debian</a> and one for <a href="https://github.com/agherzan/yubikey-full-disk-encryption">Arch Linux</a>. Both work basically the same. What happens under the hood is:</p>
<ol>
<li>initialization: add a secret to the Yubikey (HMAC-SHA1 Challenge-Response)</li>
<li>factor one is the challenge you need to enter manually during boot (<a href="https://github.com/agherzan/yubikey-full-disk-encryption/blob/5894916901b9ecfbe8bbe35e8a63023c84bd48f5/src/ykfde-enroll#L136">it gets <code>sha256sumed</code> before sending it to the Yubikey</a>)</li>
<li>the second factor is the response calculated by the Yubikey (<a href="https://github.com/agherzan/yubikey-full-disk-encryption/blob/5894916901b9ecfbe8bbe35e8a63023c84bd48f5/src/ykfde-enroll#L149">code</a>)</li>
<li>challenge and response are concatenated (<a href="https://github.com/agherzan/yubikey-full-disk-encryption/blob/5894916901b9ecfbe8bbe35e8a63023c84bd48f5/src/ykfde-enroll#L155">code</a>) and added as a password to a luks key slot (<a href="https://github.com/agherzan/yubikey-full-disk-encryption/blob/5894916901b9ecfbe8bbe35e8a63023c84bd48f5/src/ykfde-enroll#L220">code</a>)</li>
</ol>
<p>You can also write the challenge to a config file. Then you can decrypt the disk during boot only with the Yubikey, you don‚Äôt have to enter a password (challenge). There are tools which make the usage pretty simple (<code>ykfde-format</code>, <code>ykfde-enroll</code>, <code>ykfde-open</code>). This is how you can use it:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>kmille@linbox:~ ykman otp chalresp <span>2</span>
</span></span><span><span>Enter a secret key: supersecret2
</span></span><span><span>Program a challenge-response credential in slot 2? [y/N]: y
</span></span><span><span>kmille@linbox:~
</span></span><span><span>
</span></span><span><span><span># create a test disk</span>
</span></span><span><span>kmille@linbox:~ truncate -s 20M disk
</span></span><span><span><span># Hint: I set YKFDE_CHALLENGE_PASSWORD_NEEDED=&#34;1&#34; and DBG=&#34;1&#34; in /etc/ykfde.conf</span>
</span></span><span><span>kmille@linbox:~ ykfde-format disk
</span></span><span><span> &gt; ~ slot status <span>&#39;ykinfo -q -2&#39;</span>: <span>1</span>
</span></span><span><span>WARNING: This script will run <span>&#39;cryptsetup luksFormat disk&#39;</span>.  If this is not what you intended, please abort.
</span></span><span><span> &gt; Please provide the challenge.
</span></span><span><span>   Enter challenge: <span>123</span>
</span></span><span><span> &gt; Please repeat the challenge.
</span></span><span><span>   Enter challenge: <span>123</span>
</span></span><span><span>   Running: <span>&#39;ykchalresp -2 a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3&#39;</span>...
</span></span><span><span>   Remember to touch the device <span>if</span> necessary.
</span></span><span><span>   Received response: <span>&#39;0c66dacbf9155c6f48b774ca7c2520735b3dce7c&#39;</span>
</span></span><span><span> &gt; Passing <span>&#39;a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae30c66dacbf9155c6f48b774ca7c2520735b3dce7c&#39;</span> to <span>&#39;cryptsetup&#39;</span>
</span></span><span><span>   New LUKS device successfully formatted
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="bash"><span><span><span># Let&#39;s reprodcue it manually:</span>
</span></span><span><span><span># Step 1: sha256 of the challenge &#34;123&#34;</span>
</span></span><span><span>kmille@linbox:~ echo -n <span>123</span> | sha256sum
</span></span><span><span>a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3  -
</span></span><span><span>
</span></span><span><span><span># Step 2: Use the challenge-response feature (slot 2). Input: sha256(&#34;123&#34;)</span>
</span></span><span><span>kmille@linbox:~ ykchalresp -2 a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3
</span></span><span><span>0c66dacbf9155c6f48b774ca7c2520735b3dce7c
</span></span><span><span>
</span></span><span><span><span># Step 3: concat challenge|respone and use it as password to decrypt the luks device</span>
</span></span><span><span>kmille@linbox:~ echo <span>&#34;a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae30c66dacbf9155c6f48b774ca7c2520735b3dce7c&#34;</span> | sudo cryptsetup open disk test-disk
</span></span><span><span>[sudo] password <span>for</span> kmille:
</span></span><span><span>kmille@linbox:~ sudo cryptsetup close test-disk
</span></span><span><span>kmille@linbox:~ rm disk
</span></span></code></pre></div><p>As a backup, you only need to store the challenge-response secret of the Yubikey at a save place. If you don‚Äôt have a backup device, you can use this small challenge-response implementation in python (it‚Äôs just SHA-1 HMAC following <a href="https://www.rfc-editor.org/rfc/rfc2104">RFC2104</a>):</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>kmille@linbox:~ ykman otp chalresp --touch --generate <span>2</span>
</span></span><span><span>Using a randomly generated key (hex): 00b96ec0a15fe9c6d752d2d89793b434ef7c49c5
</span></span><span><span>Program a challenge-response credential in slot 2? [y/N]: y
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ echo -n test | ykchalresp -2 -i-
</span></span><span><span>bcfb0464611a4b29444d0288c9e4ba91db13ed72
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ cat test.py
</span></span><span><span>from hashlib import sha1
</span></span><span><span>from binascii import unhexlify
</span></span><span><span>import hmac
</span></span><span><span>
</span></span><span><span><span>key</span> = unhexlify(<span>&#34;00b96ec0a15fe9c6d752d2d89793b434ef7c49c5&#34;</span>)
</span></span><span><span><span>message</span> = b<span>&#34;test&#34;</span>
</span></span><span><span>
</span></span><span><span><span>hashed</span> = hmac.new(key, message, sha1)
</span></span><span><span><span>mac</span> = hashed.hexdigest()
</span></span><span><span>print(mac)
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ python test.py
</span></span><span><span>bcfb0464611a4b29444d0288c9e4ba91db13ed72
</span></span><span><span>kmille@linbox:~ 
</span></span></code></pre></div>
<p>I use the PIV functionality for SSH public key authentication. Unfortunately, only one keypair can be stored on the Yubikey 5C for ssh authentication (using the PIV method). Also, the maximum RSA key size is limited to 2048. To get PIV working, a service called <code>pcscd</code> (PC/SC Smart Card Daemon) needs to be running. On Arch Linux, install the <a href="https://archlinux.org/packages/community/x86_64/opensc/">opensc</a> package, for a Debian based OS install <a href="https://packages.debian.org/en/bullseye/pcscd">pcscd</a>. Then, start/enable the service:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>systemctl enable --now pcscd.service
</span></span><span><span>systemctl status pcscd.service
</span></span></code></pre></div><h2 id="pins-for-piv-the-why-and-how">
  PINs for PIV: the why and how
  <a href="#pins-for-piv-the-why-and-how">
    <i aria-hidden="true"></i>
  </a>
</h2>
<p>A PIV-enabled YubiKey has a PIN, a PUK and a Management Key. The PIN is used during normal operation to authorize an action such as creating a digital signature for any of the loaded certificates. The PUK can be used to reset the PIN if it is ever lost or becomes blocked after the maximum number of incorrect attempts. If an incorrect PIN is given 3 times consecutively, the PIN will become disabled. If you‚Äôve set a PUK, then you can use that PUK to reset the PIN to a new value, and it will become enabled and usable again. If an incorrect PUK is given 3 times consecutively, it will become blocked as well. When both the PIN and the PUK are blocked, the device can be reset. This returns the PIV functionality of the YubiKey to a factory setting, setting the default PIN, PUK and Management Key values, as well as removing any stored keys and certificates. Once reset, the device is ready to be re-initialized.</p>
<p>All PIV management operation of the YubiKey require a 24 byte 3DES key, known as the Management Key. You can either explicitly set a 24 byte key (the YubiKey PIV Manager can generate one for you), or you can choose to not set a Management Key, instead using the PIN for these operations. If so, you will be asked to provide your PIN instead of your Management Key whenever you perform a management operation, such as importing a new certificate, or generating a new key pair. Please check the considerations on the <a href="https://developers.yubico.com/yubikey-piv-manager/PIN_and_Management_Key.html">website</a> when using a PIN for PIV management.</p>
<p>The previous text was copied from the <a href="https://developers.yubico.com/yubikey-piv-manager/PIN_and_Management_Key.html">Yubico website</a>. The most important thing: You can reset the PIV configuration if something goes wrong:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>kmille@linbox:~ ykman piv reset
</span></span><span><span>WARNING! This will delete all stored PIV data and restore factory settings. Proceed? [y/N]: y
</span></span><span><span>Resetting PIV data...
</span></span><span><span>Success! All PIV data have been cleared from the YubiKey.
</span></span><span><span>Your YubiKey now has the default PIN, PUK and Management Key:
</span></span><span><span>        PIN:    <span>123456</span>
</span></span><span><span>        PUK:    <span>12345678</span>
</span></span><span><span>        Management Key: <span>010203040506070801020304050607080102030405060708</span>
</span></span></code></pre></div><p>To change the management key, use:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>kmille@linbox:~ cat gen-mgmt-key.py
</span></span><span><span>import os
</span></span><span><span>from binascii import hexlify
</span></span><span><span>print(hexlify(os.urandom(24)).decode())
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ python gen-mgmt-key.py
</span></span><span><span>faf6bf013ed8fc473e0b47e5502d0c75fda8e40ece5bce24
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman piv access change-management-key
</span></span><span><span>Enter PIN: 
</span></span><span><span>Enter the new management key: 
</span></span><span><span>Repeat <span>for</span> confirmation: 
</span></span></code></pre></div><p>To change PIN/PUK or unblock the device, use:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>kmille@linbox:~ ykman piv access change-pin
</span></span><span><span>Enter the current PIN: 
</span></span><span><span>Enter the new PIN: 
</span></span><span><span>Repeat <span>for</span> confirmation: 
</span></span><span><span>New PIN set.
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman piv access change-puk
</span></span><span><span>Enter the current PUK: 
</span></span><span><span>Enter the new PUK: 
</span></span><span><span>Repeat <span>for</span> confirmation: 
</span></span><span><span>New PUK set.
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman piv info                                            
</span></span><span><span>PIV version: 5.1.2
</span></span><span><span>PIN tries remaining: <span>0</span>
</span></span><span><span>...
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman piv access unblock-pin
</span></span><span><span>Enter PUK: 
</span></span><span><span>Enter a new PIN: 
</span></span><span><span>PIN unblocked
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman piv access set-retries <span>5</span> <span>5</span>
</span></span><span><span>Enter a management key [blank to use default key]: 
</span></span><span><span>Enter PIN: 
</span></span><span><span>WARNING: This will reset the PIN and PUK to the factory defaults!
</span></span><span><span>Set the number of PIN and PUK retry attempts to: <span>5</span> 5? [y/N]: y
</span></span><span><span>Default PINs are set:
</span></span><span><span>        PIN:    <span>123456</span>
</span></span><span><span>        PUK:    <span>12345678</span>
</span></span></code></pre></div><h2 id="ssh-with-piv-generate-private-key-on-yubikey">
  SSH with PIV: generate private key on Yubikey
  <a href="#ssh-with-piv-generate-private-key-on-yubikey">
    <i aria-hidden="true"></i>
  </a>
</h2>
<p>In the following, you can see how to generate a private key on the Yubikey. The private key will never leave the Yubikey, so you can‚Äôt export/backup it. I don‚Äôt recommend using <a href="https://nbeguier.medium.com/a-real-world-comparison-of-the-ssh-key-algorithms-b26b0b31bfd9">ECDSA (P-256 or P-384)</a> and use 2048 bit RSA, which is the default.</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span><span># Hint: 9a is the key slot, pubkey.pem the file where the public key will be stored</span>
</span></span><span><span>kmille@linbox:~ ykman piv keys generate 9a pubkey.pem
</span></span><span><span>Enter a management key [blank to use default key]:
</span></span><span><span><span># Hint: the generate command supports some useful parameters</span>
</span></span><span><span><span>#  --algorithm RSA1024|RSA2048|ECCP256|ECCP384   Algorithm to use in key generation</span>
</span></span><span><span><span>#  --pin-policy [DEFAULT|NEVER|ONCE|ALWAYS]      PIN policy for slot.</span>
</span></span><span><span><span>#  --touch-policy [DEFAULT|NEVER|ALWAYS|CACHED]  Touch policy for slot.</span>
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman piv certificates generate --subject <span>&#34;CN=yubico&#34;</span> 9a pubkey.pem
</span></span><span><span>Enter a management key [blank to use default key]:
</span></span><span><span>Enter PIN:
</span></span><span><span>kmille@linbox:~
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman piv info
</span></span><span><span>PIV version: 5.1.2
</span></span><span><span>PIN tries remaining: <span>3</span>
</span></span><span><span>Management key algorithm: TDES
</span></span><span><span>CHUID:  3019d4e739da739ced39ce739d836858210842108421c84210c3eb3410aeab759a2258a6311edece0f51cb8fb1350832303330303130313e00fe00
</span></span><span><span>CCC:    No data available.
</span></span><span><span>Slot 9a:
</span></span><span><span>        Algorithm:      RSA2048
</span></span><span><span>        Subject DN:     <span>CN</span>=yubico
</span></span><span><span>        Issuer DN:      <span>CN</span>=yubico
</span></span><span><span>        Serial:         <span>271029653146178331059499985773756430831562756416</span>
</span></span><span><span>        Fingerprint:    dd721071c21e2c5b2a4b2d34025ab8ce57124fd66368c2e01656c653971db350
</span></span><span><span>        Not before:     2023-02-07 13:32:41
</span></span><span><span>        Not after:      2024-02-07 13:32:41
</span></span><span><span>
</span></span><span><span><span># Hint: show public key</span>
</span></span><span><span>kmille@linbox:~ ssh-keygen -D /usr/lib64/pkcs11/opensc-pkcs11.so -e
</span></span><span><span>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC+uLBEfTF6XRTetzZ7MtxlK4yrPZnp13PGmTeSW5qwO36ycORDylR8P3bfaK/v4kuSYSzaumgGZTQ7tUO14r8vZhCzimX0oCSjy3RhaKEb0Dpk2yFxQyeqCdTOygBle8QzvVqBhOFNtjTUtzl8Tmr8AVEl/zMWk/N76ilhbp5fm4ywAwIOY66m5nttEG3ykTc98DzS/+aY5YgpsiADADAE38E7rlMHHVAQQ8cwUIyIHPplQZlbdjOH2FFroxhf8vUDjDLWnHAU2Chr7tV+f9p/IN812pOcejCtBlCyAS72JjuC0K9QEIXvfuQqkFJ7tUdvRcR38wcA0w1tWhsWoko9 PIV AUTH pubkey
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ssh-keygen -D /usr/lib64/pkcs11/opensc-pkcs11.so -e &gt;&gt; ~/.ssh/authorized_keys
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ssh -I /usr/lib64/pkcs11/opensc-pkcs11.so localhost
</span></span><span><span>Enter PIN <span>for</span> <span>&#39;yubico&#39;</span>:
</span></span><span><span>Last login: Tue Feb  <span>7</span> 13:31:13 <span>2023</span> from ::1
</span></span><span><span>kmille@linbox:~
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ rm pubkey.pem
</span></span><span><span>kmille@linbox:~
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman piv certificates delete 9a
</span></span><span><span>Enter a management key [blank to use default key]:
</span></span></code></pre></div><p>Using it with ssh-agent</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>kmille@linbox:~ ssh-add -s /usr/lib64/pkcs11/opensc-pkcs11.so
</span></span><span><span>Enter passphrase <span>for</span> PKCS#11:
</span></span><span><span>Card added: /usr/lib64/pkcs11/opensc-pkcs11.so
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ssh-add -l
</span></span><span><span><span>2048</span> SHA256:WhnjNX3z7qfJdr4aNFlK//StX6hOXx7oA33yCVbjn7Q PIV AUTH pubkey (RSA)
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ssh localhost
</span></span><span><span>Last login: Tue Feb  <span>7</span> 14:33:19 <span>2023</span> from ::1
</span></span><span><span>kmille@linbox:~
</span></span></code></pre></div><p>You can also use <code>PKCS11Provider /usr/lib64/pkcs11/opensc-pkcs11.so</code> in <code>~/.ssh/config</code>.</p>
<h2 id="ssh-with-piv-import-existing-private-key-to-yubikey">
  SSH with PIV: import existing private key to Yubikey
  <a href="#ssh-with-piv-import-existing-private-key-to-yubikey">
    <i aria-hidden="true"></i>
  </a>
</h2>
<p>To import an existing ssh key to the Yubikey, the private key must be converted in a proper format. You also have to create a file with the public key. Exporting it from the Yubikey only works with  firmware 5.3 or later (see <a href="https://github.com/Yubico/yubikey-manager/issues/540">this Github issue</a>).</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span><span># Hint: -P means no password, ssh-keygen uses 3072 bit as default on Arch</span>
</span></span><span><span><span># Yubikey supports only 2048 bit max</span>
</span></span><span><span>kmille@linbox:tmp ssh-keygen -f existing  -b <span>2048</span> -P <span>&#34;&#34;</span>
</span></span><span><span>Generating public/private rsa key pair.
</span></span><span><span>Your identification has been saved in existing
</span></span><span><span>Your public key has been saved in existing.pub
</span></span><span><span>
</span></span><span><span><span># Hint: the private key must be converted first</span>
</span></span><span><span>kmille@linbox:tmp head -n <span>1</span> existing         
</span></span><span><span>-----BEGIN OPENSSH PRIVATE KEY-----
</span></span><span><span>
</span></span><span><span>kmille@linbox:tmp ssh-keygen -p -m pem -f existing
</span></span><span><span>Key has comment <span>&#39;kmille@linbox&#39;</span>
</span></span><span><span>Enter new passphrase (empty <span>for</span> no passphrase): 
</span></span><span><span>Enter same passphrase again: 
</span></span><span><span>Your identification has been saved with the new passphrase.
</span></span><span><span>
</span></span><span><span>kmille@linbox:tmp head -n <span>1</span> existing
</span></span><span><span>-----BEGIN RSA PRIVATE KEY-----
</span></span><span><span>
</span></span><span><span>kmille@linbox:tmp ykman piv keys import 9a existing
</span></span><span><span>Enter a management key [blank to use default key]:
</span></span><span><span>
</span></span><span><span>kmille@linbox:tmp openssl rsa -in existing -pubout &gt; testpub.pem
</span></span><span><span>writing RSA key
</span></span><span><span>kmille@linbox:tmp head -n <span>1</span> testpub.pem
</span></span><span><span>-----BEGIN PUBLIC KEY-----
</span></span><span><span>
</span></span><span><span>kmille@linbox:tmp ykman piv certificates generate --subject <span>&#34;CN=yubico&#34;</span> 9a testpub.pem
</span></span><span><span>Enter a management key [blank to use default key]:
</span></span><span><span>Enter PIN:
</span></span><span><span>kmille@linbox:
</span></span><span><span>
</span></span><span><span>kmille@linbox:tmp ykman piv info
</span></span><span><span>PIV version: 5.1.2
</span></span><span><span>PIN tries remaining: <span>3</span>
</span></span><span><span>Management key algorithm: TDES
</span></span><span><span>CHUID:  3019d4e739da739ced39ce739d836858210842108421c84210c3eb34108897deb27c93ec8f6ebd0aa44d1139ef350832303330303130313e00fe00
</span></span><span><span>CCC:    No data available.
</span></span><span><span>Slot 9a:
</span></span><span><span>        Algorithm:      RSA2048
</span></span><span><span>        Subject DN:     <span>CN</span>=yubico
</span></span><span><span>        Issuer DN:      <span>CN</span>=yubico
</span></span><span><span>        Serial:         <span>476405504585636348134209109957833992452830001643</span>
</span></span><span><span>        Fingerprint:    d723fce0a85c0105e4485d01fe264a6dd5e6677465410f1f90b0446f62b1bf8c
</span></span><span><span>        Not before:     2023-02-26 19:25:46
</span></span><span><span>        Not after:      2024-02-26 19:25:46
</span></span></code></pre></div>
<p><a href="https://github.com/FiloSottile/age">age</a> is a simple, modern and secure file encryption tool, format, and Go library. There is also <a href="https://github.com/str4d/age-plugin-yubikey">age-plugin-yubikey</a>, a plugin for age clients like age and <a href="https://archlinux.org/packages/community/x86_64/rust-rage/">rage</a>, which enables files to be encrypted to age identities (an age identity is like a pgp public key) stored on a YubiKey. To use it on Arch Linux, install the <a href="https://archlinux.org/packages/community/x86_64/age-plugin-yubikey/">age-plugin-yubikey</a> package. There is also a .deb package on the <a href="https://github.com/str4d/age-plugin-yubikey/releases">Github release page</a>. <code>age-plugin-yubikey</code> currently only supports the ECCP256 curve (<a href="https://github.com/str4d/age-plugin-yubikey/issues/62">source</a>, <a href="https://github.com/str4d/age-plugin-yubikey/issues/70">source</a>).</p>
<p>In terms of backup: The private key is stored on the Yubikey and can not be extracted. To protect yourself from a broken/stolen/lost Yubikey, use a second Yubikey device and encrypt everything a second time with the identity of the backup Yubikey (<a href="https://github.com/str4d/age-plugin-yubikey/issues/75">see also this Github issue</a>). It‚Äôs not possible to import a key (<a href="https://github.com/str4d/age-plugin-yubikey/issues/75#issuecomment-1418246507">issue</a>).</p>
<p>Below are the commands to generate a new private key on the Yubikey and encrypt/decrypt data with the identity. I think slot 82 to 94 can be used to store identities (<a href="https://docs.yubico.com/yesdk/users-manual/application-piv/slots.html">source</a>). You can just run <code>age-plugin-yubikey</code> to get an interactive setup for a new identity. The tool also supports <code>--touch-policy</code> (always, cached, never) and <code>--pin-policy</code> (always, once, never).</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>kmille@linbox:~ age-plugin-yubikey --generate --name test123
</span></span><span><span>Enter PIN <span>for</span> YubiKey with serial <span>1312</span> (default is 123456): [hidden]
</span></span><span><span>üëÜ Please touch the YubiKey
</span></span><span><span><span>#       Serial: 1312, Slot: 1</span>
</span></span><span><span><span>#         Name: test123</span>
</span></span><span><span><span>#      Created: Sun, 05 Feb 2023 18:17:32 +0000</span>
</span></span><span><span><span>#   PIN policy: Once   (A PIN is required once per session, if set)</span>
</span></span><span><span><span># Touch policy: Always (A physical touch is required for every decryption)</span>
</span></span><span><span><span>#    Recipient: age1yubikey1q228ff7yqw9pfducrzseqfsk8epg9lgluwetkdd0u48c0v9vg4t6gqkak3r</span>
</span></span><span><span>AGE-PLUGIN-YUBIKEY-1YELEWQYZ6DNC07QXHA5AW
</span></span><span><span>
</span></span><span><span><span># Hint: --list shows metadata and public key of all slots stored on Yubikey</span>
</span></span><span><span>kmille@linbox:~ age-plugin-yubikey -l
</span></span><span><span><span>#       Serial: 1312, Slot: 1</span>
</span></span><span><span><span>#         Name: test123</span>
</span></span><span><span><span>#      Created: Sun, 05 Feb 2023 18:17:32 +0000</span>
</span></span><span><span><span>#   PIN policy: Once   (A PIN is required once per session, if set)</span>
</span></span><span><span><span># Touch policy: Always (A physical touch is required for every decryption)</span>
</span></span><span><span>age1yubikey1q228ff7yqw9pfducrzseqfsk8epg9lgluwetkdd0u48c0v9vg4t6gqkak3r
</span></span><span><span>
</span></span><span><span><span># Hint: --identity returns a string on stdout which you can use for</span>
</span></span><span><span><span># &#39;age -d -i &lt;here&gt;&#39;. It  tells age which private key to use for decryption</span>
</span></span><span><span>kmille@linbox:~ age-plugin-yubikey -i --slot <span>1</span> &gt; identity-1.txt
</span></span><span><span>Recipient: age1yubikey1q228ff7yqw9pfducrzseqfsk8epg9lgluwetkdd0u48c0v9vg4t6gqkak3r
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ cat identity-1.txt
</span></span><span><span><span>#       Serial: 1312, Slot: 1</span>
</span></span><span><span><span>#         Name: test123</span>
</span></span><span><span><span>#      Created: Sun, 05 Feb 2023 18:17:32 +0000</span>
</span></span><span><span><span>#   PIN policy: Once   (A PIN is required once per session, if set)</span>
</span></span><span><span><span># Touch policy: Always (A physical touch is required for every decryption)</span>
</span></span><span><span><span>#    Recipient: age1yubikey1q228ff7yqw9pfducrzseqfsk8epg9lgluwetkdd0u48c0v9vg4t6gqkak3r</span>
</span></span><span><span>AGE-PLUGIN-YUBIKEY-1YELEWQYZ6DNC07QXHA5AW
</span></span><span><span>
</span></span><span><span><span># Hint: encrypt tmp/test.txt with an identity/public key and write it to tmp/test.txt.age</span>
</span></span><span><span>kmille@linbox:~ cat tmp/test.txt | age -r age1yubikey1q228ff7yqw9pfducrzseqfsk8epg9lgluwetkdd0u48c0v9vg4t6gqkak3r &gt; tmp/test.txt.age
</span></span><span><span>
</span></span><span><span><span># Hint: decrypt it with the Yubikey (I have to touch it)</span>
</span></span><span><span>kmille@linbox:~ cat tmp/test.txt.age | age -d -i identity-1.txt &gt; tmp/test.txt
</span></span><span><span>kmille@linbox:~
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman piv info
</span></span><span><span>PIV version: 5.1.2
</span></span><span><span>PIN tries remaining: <span>3</span>
</span></span><span><span>Management key algorithm: TDES
</span></span><span><span>Management key is stored on the YubiKey, protected by PIN.
</span></span><span><span>CHUID:  3019d4e739da739ced39ce739d836858210842108421c84210c3eb3410c0a9799579cbe476887b1f7ea5a74a6c350832303330303130313e00fe00
</span></span><span><span>CCC:    No data available.
</span></span><span><span>Slot 82:
</span></span><span><span>        Algorithm:      ECCP256
</span></span><span><span>        Subject DN:     <span>CN</span>=test123,OU=0.3.2,O=age-plugin-yubikey
</span></span><span><span>        Issuer DN:      <span>CN</span>=test123,OU=0.3.2,O=age-plugin-yubikey
</span></span><span><span>        Serial:         <span>875428878573667959096445206907039728936329227404</span>
</span></span><span><span>        Fingerprint:    82ac5b1bc7f640ad58e29096b68c39507f80c335dd69a95971a6fe7f4a2c33c7
</span></span><span><span>        Not before:     2023-02-05 18:17:32
</span></span><span><span>        Not after:      9999-12-31 23:59:59
</span></span><span><span>...
</span></span><span><span>
</span></span><span><span>kmille@linbox:~ ykman piv certificates delete <span>82</span>
</span></span><span><span>Enter PIN:
</span></span><span><span>kmille@linbox:~ age-plugin-yubikey -l
</span></span><span><span>kmille@linbox:~
</span></span></code></pre></div>
<h2 id="openpgp-with-yubikey">
  OpenPGP with Yubikey
  <a href="#openpgp-with-yubikey">
    <i aria-hidden="true"></i>
  </a>
</h2>
<ul>
<li><a href="https://gist.github.com/xirkus/20552a9b026413cc84191131bbeeb48a">https://gist.github.com/xirkus/20552a9b026413cc84191131bbeeb48a</a></li>
<li><a href="https://github.com/drduh/YubiKey-Guide">https://github.com/drduh/YubiKey-Guide</a></li>
</ul>
<h2 id="openvpn-with-yubikey">
  OpenVPN with Yubikey
  <a href="#openvpn-with-yubikey">
    <i aria-hidden="true"></i>
  </a>
</h2>
<ul>
<li><a href="https://forum.yubico.com/viewtopic6aa2.html?p=8070">https://forum.yubico.com/viewtopic6aa2.html?p=8070</a></li>
</ul>

<ul>
<li>Arch wiki: <a href="https://wiki.archlinux.org/title/YubiKey">https://wiki.archlinux.org/title/YubiKey</a></li>
<li>Yubikey Cheatsheet: <a href="https://nbari.com/yubikey/">https://nbari.com/yubikey/</a></li>
<li>Yubikey and SSH in general: <a href="https://developers.yubico.com/SSH/">https://developers.yubico.com/SSH/</a></li>
<li>PIV + SSH
<ul>
<li><a href="https://github.com/fredxinfan/ykman-piv-ssh">https://github.com/fredxinfan/ykman-piv-ssh</a></li>
<li><a href="https://blog.rchapman.org/posts/Import_an_existing_ssh_key_into_Yubikey_NEO_applet/">https://blog.rchapman.org/posts/Import_an_existing_ssh_key_into_Yubikey_NEO_applet/</a></li>
</ul>
</li>
<li>Overview Yubikey slots: <a href="https://docs.yubico.com/yesdk/users-manual/application-piv/slots.html">https://docs.yubico.com/yesdk/users-manual/application-piv/slots.html</a></li>
<li>Websites with 2FA Support:
<ul>
<li><a href="https://2fa.directory/fr/">https://2fa.directory/fr/</a></li>
<li><a href="https://www.dongleauth.com/">https://www.dongleauth.com/</a></li>
</ul>
</li>
</ul>

      </div></div>
  </body>
</html>
