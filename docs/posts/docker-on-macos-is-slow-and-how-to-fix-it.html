<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.paolomainardi.com/posts/docker-performance-macos/">Original</a>
    <h1>Docker on MacOS is slow and how to fix it</h1>
    
    <div id="readability-page-1" class="page"><div><p><img src="https://www.paolomainardi.com/images/posts/3-docker/docker-dalle-container-macbook.webp" alt="Featured image"/></p><p>Thanks to the <a href="https://openai.com/dall-e-2/"><strong>DALL¬∑E 2</strong></a>, we finally have a very nice graphic representation of
<strong>the feelings</strong> of a Docker container inside a macOS environment, I will try with this article to make this poor container safe to the coast.</p><h2 id="tldr">TL;DR
<a href="#tldr"><i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span></a></h2><p>At the time of writing, the only viable option to have a <em>decent performance</em>
and a <em>good DX</em> are:</p><ol><li><strong>VirtioFS</strong> to share the filesystem (<a href="https://www.docker.com/blog/speed-boost-achievement-unlocked-on-docker-desktop-4-6-for-mac/">Docker Desktop</a>, <a href="https://github.com/rancher-sandbox/rancher-desktop/issues/3488">Rancher Desktop</a>, <a href="https://github.com/drud/ddev/issues/3750">Colima</a>) - <a href="https://github.com/docker/roadmap/issues/7#issuecomment-1360243730">There are still some issues</a>.</li><li>Use <strong>named volumes</strong> and if you use VSCode you can rely on things like <a href="https://code.visualstudio.com/docs/devcontainers/containers">DevContainers</a> to have a good DX - üöÄ <strong>BONUS</strong>: <a href="https://github.com/paolomainardi/docker-backstage-devcontainers">PoC project</a> with Backstage and DevContainers.</li><li>Use <a href="https://ddev.com">DDEV</a> + <a href="https://ddev.readthedocs.io/en/latest/users/install/performance/">Mutagen</a> for PHP projects (JS coming soon).</li><li>If you are <strong>VI/Emacs</strong> user, all you need is your editor and tools in a container, or if you want a minimal Linux GUI env, <a href="https://github.com/mitchellh/nixos-config">take some inspiration here</a>.</li></ol><h2 id="how-does-docker-work-on-macos">How does Docker work on macOS?
<a href="#how-does-docker-work-on-macos"><i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span></a></h2><figure><img src="https://collabnix.com/wp-content/uploads/2018/05/Screen-Shot-2018-05-07-at-8.13.29-AM.png" alt="Docker architecture on macOS - Source https://collabnix.com/how-docker-for-mac-works-under-the-hood"/><figcaption><p>Docker architecture on macOS - Source <a href="https://collabnix.com/how-docker-for-mac-works-under-the-hood">https://collabnix.com/how-docker-for-mac-works-under-the-hood</a></p></figcaption></figure><p><strong>Docker engine</strong>, on macOS and Windows, needs a <strong>Linux Kernel</strong>; there aren‚Äôt any exceptions here, you do not see it, but it is there to do all the dirty jobs <em>(HN:</em> <a href="https://news.ycombinator.com/item?id=11352594"><em>https://news.ycombinator.com/item?id=11352594</em></a><em>)</em></p><p>Instead, <strong>Docker CLI</strong> and <strong>docker-compose</strong> are <strong>native binaries</strong> for <strong>all</strong> <strong>operating systems</strong>.</p><p><strong>Two things</strong> are worth mentioning here regarding Microsoft; <strong>the first one</strong> is that Windows (and this sometimes can lead to some confusion) <strong>natively support</strong> <a href="https://learn.microsoft.com/en-us/virtualization/windowscontainers/about/">Docker to run Windows containers</a>.</p><p>This implementation has been possible thanks to the joint effort of <strong>Microsoft and Docker</strong> <a href="https://www.docker.com/blog/dockerforws2016/"><strong>in 2016</strong></a> to create a container engine implementing the Docker specification on Windows; kudos to you, MS.</p><p>The <strong>second one</strong> is that Microsoft tried in the past to <strong>natively support Linux processes</strong> by real-time converting syscalls to run unmodified Linux processes on the Windows kernel (WSL1).</p><p><a href="https://subscription.packtpub.com/book/cloud-and-networking/9781800562448/2/ch02lvl1sec04/exploring-the-differences-between-wsl-1-and-2">You can find here</a> a very detailed deep dive into this brilliant technology; even though Microsoft still supports it, <a href="https://en.wikipedia.org/wiki/Windows_Subsystem_for_Linux#:~:text=WSL%201%20is%20not%20capable,device%20drivers%2C%20cannot%20be%20run.">it has significant limitations</a> in terms of performance and compatibility. This is why Microsoft released a new engine, <strong>WSL2,</strong> which is based on a more traditional approach of a lightweight virtual machine running an unmodified Linux kernel plus some kernel modules to better integrate on Windows.</p><p>Anyway, let‚Äôs go back to the topic.</p><p><a href="https://docs.docker.com/desktop/install/mac-install/">Docker for Mac</a> is the official Docker inc. product made to run most seamlessly Docker containers on macOS; they even support Kubernetes.</p><p>Some <strong>notable features</strong> of Docker for Mac:</p><ul><li>Docker for Mac <strong>runs</strong> in a <a href="https://github.com/linuxkit/linuxkit/blob/master/examples/docker-for-mac.md">LinuxKit VM</a> and <a href="https://github.com/docker/for-mac/issues/6578">recently switched</a> to the <a href="https://developer.apple.com/documentation/virtualization">Virtualization Framework</a> instead of <a href="https://github.com/docker/HyperKit/">HyperKit</a>.</li><li><strong>Filesystem sharing</strong> is implemented on a <em>proprietary technology</em> called <a href="https://docker-docs.netlify.app/docker-for-mac/osxfs/">OSXFS</a>. <a href="https://www.google.com/search?q=osxfs+slow&amp;ie=utf-8&amp;oe=utf-8&amp;aq=t">Since it is slow</a> for most of the use cases where tons and tons of files are involved <em>(yes, I am looking at you, Node, and PHP)</em>, a new player is slowly ramping up from the labs; I am talking about <a href="https://virtio-fs.gitlab.io/">VirtioFS</a> - <a href="https://www.docker.com/blog/speed-boost-achievement-unlocked-on-docker-desktop-4-6-for-mac/">which seems very promising</a>.</li><li><strong>Networking</strong> is based on <a href="https://github.com/moby/vpnkit">VPNKit</a>.</li><li>It can run <a href="https://docs.docker.com/desktop/kubernetes/"><strong>Kubernetes</strong></a>.</li><li>It is a <strong>closed-source</strong> product, and if conditions matches require a <a href="https://www.docker.com/legal/docker-subscription-service-agreement/">paid subscription</a> (at the time of writing: <em>‚ÄúCompanies with more than 250 employees OR more than $10 million in annual revenue‚Äù</em>)</li></ul><p>There are two valid OSS alternatives:</p><ul><li><a href="https://rancherdesktop.io/">Rancher desktop</a></li><li><a href="https://github.com/abiosoft/colima/">Colima</a></li></ul><p>They both use <a href="https://github.com/lima-vm/lima">Lima</a>, filesystem-sharing <a href="https://github.com/lima-vm/lima/issues/20">issues are tracked here</a>, and VirtioFS has <a href="https://github.com/lima-vm/lima/issues/20#issuecomment-1323111870">just landed</a>. It is interesting to see that the consensus around <a href="https://gitlab.com/virtio-fs">VirtioFS</a> is confirmed, and once again, open source sets the rules.</p><p>So, <strong>to sum up</strong>:</p><ol><li>Docker containers are still <strong>Linux processes</strong> and need a <strong>Virtual Machine</strong> to run on other operating systems.</li><li>Docker-cli and docker-compose are <strong>native binaries.</strong></li><li>As Docker runs in a virtual machine, <strong>something to share the host filesystem with the VM is required</strong>; we can choose between <em><strong>OSXFS</strong></em> <em>(proprietary and deprecated),</em> <a href="https://www.docker.com/blog/speed-boost-achievement-unlocked-on-docker-desktop-4-6-for-mac/"><em><strong>gRCP FUSE</strong></em></a><em>, or</em> <em><strong>VirtioFS</strong></em>. They all come with issues, and <a href="https://www.jeffgeerling.com/blog/2022/new-docker-mac-virtiofs-file-sync-4x-faster"><strong>VirtioFS is the most promising one</strong></a>.</li><li>To run <strong>Docker containers on Mac</strong>, you can choose between <a href="https://docs.docker.com/desktop/install/mac-install/"><strong>Docker for Mac</strong></a> (closed-source), <a href="https://rancherdesktop.io/"><strong>Rancher Desktop</strong></a> (OSS), and <a href="https://github.com/abiosoft/colima"><strong>Colima</strong></a> (OSS).</li></ol><h2 id="what-is-a-docker-volume">What is a Docker volume?
<a href="#what-is-a-docker-volume"><i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span></a></h2><p>Now that we know how the underlying things work, we can quickly dive into another confusion-leading topic: <a href="https://docs.docker.com/storage/volumes/"><strong>Docker Volumes</strong></a>.</p><p>Docker containers are <em>ephemeral</em>, and this means that files exist inside the containers as long as the container exists, let‚Äôs see a an example:</p><div><pre tabindex="0"><code data-lang="shell"><span><span> 1</span><span>‚ûú  ~ <span># Run a container and keep it running for 300 seconds.</span>
</span></span><span><span> 2</span><span>
</span></span><span><span> 3</span><span>‚ûú  ~ docker run -d --name ephemeral busybox sh -c <span>&#34;sleep 300&#34;</span>
</span></span><span><span> 4</span><span>d0b02322a9eef184ab00d6eee34cbd22466e7f7c1de209390eaaacaa32a48537
</span></span><span><span> 5</span><span>
</span></span><span><span> 6</span><span>‚ûú  ~ <span># Inspect a container to find the host PID.</span>
</span></span><span><span> 7</span><span>‚ûú  ~ docker inspect --format <span>&#39;{{ .State.Pid }}&#39;</span> d0b02322a9eef184ab00d6eee3
</span></span><span><span> 8</span><span>4cbd22466e7f7c1de209390eaaacaa32a48537
</span></span><span><span> 9</span><span><span>515584</span>
</span></span><span><span>10</span><span>
</span></span><span><span>11</span><span>‚ûú  ~ <span># Find the host path of the container filesystem (in this case is a btrfs volume)</span>
</span></span><span><span>12</span><span>‚ûú  ~ sudo cat /proc/515584/mountinfo | grep subvolumes
</span></span><span><span>13</span><span><span>906</span> <span>611</span> 0:23 /@/var/lib/docker/btrfs/subvolumes/b237a173b0ba81eb0a60d35b59b0cc5ed<span>[</span>truncated<span>]</span>
</span></span><span><span>14</span><span>
</span></span><span><span>15</span><span>‚ûú  ~ <span># Read the container filesystem from the host.</span>
</span></span><span><span>16</span><span>‚ûú  ~ sudo ls -ltr /var/lib/docker/btrfs/subvolumes/b237a173b0ba81eb0a60d35
</span></span><span><span>17</span><span>b59b0cc5ed7247423bed4b4dcbb5af57a1c3318eb
</span></span><span><span>18</span><span>total <span>4</span>
</span></span><span><span>19</span><span>lrwxrwxrwx <span>1</span> root   root      <span>3</span> Nov <span>17</span> 21:00 lib64 -&gt; lib
</span></span><span><span>20</span><span>drwxr-xr-x <span>1</span> root   root    <span>270</span> Nov <span>17</span> 21:00 lib
</span></span><span><span>21</span><span>drwxr-xr-x <span>1</span> root   root   <span>4726</span> Nov <span>17</span> 21:00 bin
</span></span><span><span>22</span><span>drwxrwxrwt <span>1</span> root   root      <span>0</span> Dec  <span>5</span> 22:00 tmp
</span></span><span><span>23</span><span>drwx------ <span>1</span> root   root      <span>0</span> Dec  <span>5</span> 22:00 root
</span></span><span><span>24</span><span>drwxr-xr-x <span>1</span> root   root     <span>16</span> Dec  <span>5</span> 22:00 var
</span></span><span><span>25</span><span>drwxr-xr-x <span>1</span> root   root      <span>8</span> Dec  <span>5</span> 22:00 usr
</span></span><span><span>26</span><span>drwxr-xr-x <span>1</span> nobody nobody    <span>0</span> Dec  <span>5</span> 22:00 home
</span></span><span><span>27</span><span>drwxr-xr-x <span>1</span> root   root      <span>0</span> Dec <span>10</span> 18:37 proc
</span></span><span><span>28</span><span>drwxr-xr-x <span>1</span> root   root      <span>0</span> Dec <span>10</span> 18:37 sys
</span></span><span><span>29</span><span>drwxr-xr-x <span>1</span> root   root    <span>148</span> Dec <span>10</span> 18:37 etc
</span></span><span><span>30</span><span>drwxr-xr-x <span>1</span> root   root     <span>26</span> Dec <span>10</span> 18:37 dev
</span></span><span><span>31</span><span>
</span></span><span><span>32</span><span>‚ûú  ~ <span># Now write something from the container and see if it&#39;s reflected on the host filesystem.</span>
</span></span><span><span>33</span><span>‚ûú  ~ docker ps -l
</span></span><span><span>34</span><span>CONTAINER ID   IMAGE     COMMAND               CREATED         STATUS         PORTS     NAMES
</span></span><span><span>35</span><span>d0b02322a9ee   busybox   <span>&#34;sh -c &#39;sleep 300&#39;&#34;</span>   <span>4</span> minutes ago   Up <span>4</span> minutes             ephemeral
</span></span><span><span>36</span><span>‚ûú  ~ docker <span>exec</span> -it d0b02322a9ee touch hello-from-container
</span></span><span><span>37</span><span>‚ûú  ~ sudo ls -ltr /var/lib/docker/btrfs/subvolumes/b237a173b0ba81eb0a60d35b59b0cc5ed7247
</span></span><span><span>38</span><span>423bed4b4dcbb5af57a1c3318eb | grep hello
</span></span><span><span>39</span><span>-rw-r--r-- <span>1</span> root   root      <span>0</span> Dec <span>10</span> 18:42 hello-from-container
</span></span><span><span>40</span><span>
</span></span><span><span>41</span><span>‚ûú  ~ <span># Now write something from the host to see reflected on the container.</span>
</span></span><span><span>42</span><span>‚ûú  ~ sudo touch /var/lib/docker/btrfs/subvolumes/b237a173b0ba81eb0a60d35b59b0cc5ed72474
</span></span><span><span>43</span><span>23bed4b4dcbb5af57a1c3318eb/hello-from-the-host
</span></span><span><span>44</span><span>‚ûú  ~ docker <span>exec</span> -it d0b02322a9ee sh -c <span>&#34;ls  | grep hello-from-the-host&#34;</span>
</span></span><span><span>45</span><span>hello-from-the-host
</span></span><span><span>46</span><span>
</span></span><span><span>47</span><span>‚ûú  ~ <span># Stop the container.</span>
</span></span><span><span>48</span><span>‚ûú  ~ docker stop d0b02322a9ee
</span></span><span><span>49</span><span>‚ûú  ~ sudo ls -ltr /var/lib/docker/btrfs/subvolumes/b237a173b0ba81e
</span></span><span><span>50</span><span>b0a60d35b59b0cc5ed7247423bed4b4dcbb5af57a1c3318eb
</span></span><span><span>51</span><span>total <span>4</span>
</span></span><span><span>52</span><span>lrwxrwxrwx <span>1</span> root   root      <span>3</span> Nov <span>17</span> 21:00 lib64 -&gt; lib
</span></span><span><span>53</span><span>drwxr-xr-x <span>1</span> root   root    <span>270</span> Nov <span>17</span> 21:00 lib
</span></span><span><span>54</span><span>drwxr-xr-x <span>1</span> root   root   <span>4726</span> Nov <span>17</span> 21:00 bin
</span></span><span><span>55</span><span>drwxrwxrwt <span>1</span> root   root      <span>0</span> Dec  <span>5</span> 22:00 tmp
</span></span><span><span>56</span><span>drwx------ <span>1</span> root   root      <span>0</span> Dec  <span>5</span> 22:00 root
</span></span><span><span>57</span><span>drwxr-xr-x <span>1</span> root   root     <span>16</span> Dec  <span>5</span> 22:00 var
</span></span><span><span>58</span><span>drwxr-xr-x <span>1</span> root   root      <span>8</span> Dec  <span>5</span> 22:00 usr
</span></span><span><span>59</span><span>drwxr-xr-x <span>1</span> nobody nobody    <span>0</span> Dec  <span>5</span> 22:00 home
</span></span><span><span>60</span><span>drwxr-xr-x <span>1</span> root   root      <span>0</span> Dec <span>10</span> 18:44 sys
</span></span><span><span>61</span><span>drwxr-xr-x <span>1</span> root   root      <span>0</span> Dec <span>10</span> 18:44 proc
</span></span><span><span>62</span><span>drwxr-xr-x <span>1</span> root   root    <span>148</span> Dec <span>10</span> 18:44 etc
</span></span><span><span>63</span><span>drwxr-xr-x <span>1</span> root   root     <span>26</span> Dec <span>10</span> 18:44 dev
</span></span><span><span>64</span><span>-rw-r--r-- <span>1</span> root   root      <span>0</span> Dec <span>10</span> 18:45 hello-from-the-host
</span></span><span><span>65</span><span>
</span></span><span><span>66</span><span>‚ûú  ~ <span># Filesystem still exists until it is just stopped, but now let&#39;s remove it.</span>
</span></span><span><span>67</span><span>‚ûú  ~ docker rm ephemeral
</span></span><span><span>68</span><span>ephemeral
</span></span><span><span>69</span><span>‚ûú  ~ sudo ls -ltr /var/lib/docker/btrfs/subvolumes/b237a173b0ba81eb0a
</span></span><span><span>70</span><span>60d35b59b0cc5ed7247423bed4b4dcbb5af57a1c3318eb
</span></span><span><span>71</span><span>ls: cannot access <span>&#39;/var/lib/docker/btrfs/subvolumes/b237a173b0ba81eb0
</span></span></span><span><span>72</span><span><span>a60d35b59b0cc5ed7247423bed4b4dcbb5af57a1c3318eb&#39;</span>: No such file or directory
</span></span></code></pre></div><p>So, what happened here:</p><ol><li>While <strong>running</strong> and <strong>stopping state</strong>, the container has an <strong>allocated filesystem</strong> on the host.</li><li><strong>Removing</strong> a container <strong>removes</strong> the <strong>associated filesystem</strong> too.</li></ol><p>If you want to deep-dive more into this subject, I cannot recommend more those excellent readings:</p><ol><li><a href="https://martinheinz.dev/blog/44">Deep Dive into Docker Internals‚Ää-‚ÄäUnion Filesystem</a></li><li><a href="https://blog.px.dev/container-filesystems/">Where are my container‚Äôs files? Inspecting container filesystems</a></li></ol><p>Now that we have a clearer understanding of how Docker manages the filesystem, it is easily understandable <strong>how risky</strong> it can be to use a <strong>container without proper data persistency</strong> layer. This is exactly where docker volumes come in handy.</p><figure><img src="https://docs.docker.com/storage/images/types-of-mounts-bind.png" alt="Docker volumes and bind mounts"/><figcaption><p>Docker volumes and bind mounts</p></figcaption></figure><h3 id="bind-mounts">Bind mounts
<a href="#bind-mounts"><i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span></a></h3><div><p><i aria-hidden="true"></i>Warning</p><p>Bind mounting is the core of all problems of bad filesystem performance.</p></div><p>As the <a href="https://docs.docker.com/storage/bind-mounts/">documentation</a> states: <em>‚ÄúBind mounts have been around since the early days of Docker. Bind mounts have limited functionality compared to</em> <a href="https://docs.docker.com/storage/volumes/"><em>volumes</em></a><em>. A file or directory on the host machine is mounted into a container when you use a bind mount. The file or directory is referenced by its absolute path on the host machine. By contrast, when you use a volume, a new directory is created within Docker‚Äôs storage directory on the host machine, and Docker manages that directory‚Äôs contents.‚Äù</em></p><p>This <strong>is all you need</strong> to bind mount a host directory inside a container:</p><p><code>‚ûú docker run -v &lt;host-path&gt;:&lt;container-path&gt; &lt;container&gt;</code></p><p>Let‚Äôs see a quick real-world example of how bind mounts work:</p>
<p>And yes, this is precisely <strong>where all the problem begins</strong>.</p><p>A bind mount is a way to mount the host filesystem inside a container, and you can imagine if a VM is in the middle of us and the container, everything gets more complicated.</p><p>From 10 thousand feet, it works like this:</p><figure><img src="https://www.paolomainardi.com/images/posts/3-docker/docker-mac-diagram.excalidraw-black.webp" alt="Docker bind mount diagram"/><figcaption><p>Docker bind mount diagram</p></figcaption></figure><p>So, when you <strong>mount a path from your Mac</strong>, you are just <strong>asking the Linux VM</strong> to <strong>mount the path</strong> of the <strong>network-shared filesystem</strong> of your Mac.</p><p>Usually, you do not need to configure this tedious part manually; the tools automatically do it for you.</p><p>You can find it what is mounted on Docker Desktop under:</p><p>Preferences -&gt; Resources -&gt; File sharing</p><figure><img src="https://www.paolomainardi.com/images/posts/3-docker/docker-mac-bind-mounts.webp" alt="Docker Desktop bind mount settings"/><figcaption><p>Docker Desktop bind mount settings</p></figcaption></figure><p>As you can see from the image, we are mounting local paths like <code>/Users</code> as mount path on the Linux VM, and thanks to this, we can mount Mac directories as they were local:</p><div><pre tabindex="0"><code data-lang="shell"><span><span> 1</span><span>‚ûú  ~ docker run --rm -it -v /Users/paolomainardi:<span>$(</span><span>pwd</span><span>)</span> alpine ash
</span></span><span><span> 2</span><span>/ <span># ls -ltr</span>
</span></span><span><span> 3</span><span>total <span>60</span>
</span></span><span><span> 4</span><span>drwxr-xr-x   <span>12</span> root     root          <span>4096</span> May <span>23</span>  <span>2022</span> var
</span></span><span><span> 5</span><span>drwxr-xr-x    <span>7</span> root     root          <span>4096</span> May <span>23</span>  <span>2022</span> usr
</span></span><span><span> 6</span><span>drwxrwxrwt    <span>2</span> root     root          <span>4096</span> May <span>23</span>  <span>2022</span> tmp
</span></span><span><span> 7</span><span>drwxr-xr-x    <span>2</span> root     root          <span>4096</span> May <span>23</span>  <span>2022</span> srv
</span></span><span><span> 8</span><span>drwxr-xr-x    <span>2</span> root     root          <span>4096</span> May <span>23</span>  <span>2022</span> run
</span></span><span><span> 9</span><span>drwxr-xr-x    <span>2</span> root     root          <span>4096</span> May <span>23</span>  <span>2022</span> opt
</span></span><span><span>10</span><span>drwxr-xr-x    <span>2</span> root     root          <span>4096</span> May <span>23</span>  <span>2022</span> mnt
</span></span><span><span>11</span><span>drwxr-xr-x    <span>5</span> root     root          <span>4096</span> May <span>23</span>  <span>2022</span> media
</span></span><span><span>12</span><span>drwxr-xr-x    <span>7</span> root     root          <span>4096</span> May <span>23</span>  <span>2022</span> lib
</span></span><span><span>13</span><span>drwxr-xr-x    <span>2</span> root     root          <span>4096</span> May <span>23</span>  <span>2022</span> home
</span></span><span><span>14</span><span>drwxr-xr-x    <span>2</span> root     root          <span>4096</span> May <span>23</span>  <span>2022</span> sbin
</span></span><span><span>15</span><span>drwxr-xr-x    <span>2</span> root     root          <span>4096</span> May <span>23</span>  <span>2022</span> bin
</span></span><span><span>16</span><span>dr-xr-xr-x   <span>13</span> root     root             <span>0</span> Dec <span>11</span> 14:33 sys
</span></span><span><span>17</span><span>dr-xr-xr-x  <span>260</span> root     root             <span>0</span> Dec <span>11</span> 14:33 proc
</span></span><span><span>18</span><span>drwxr-xr-x    <span>1</span> root     root          <span>4096</span> Dec <span>11</span> 14:33 etc
</span></span><span><span>19</span><span>drwxr-xr-x    <span>5</span> root     root           <span>360</span> Dec <span>11</span> 14:33 dev
</span></span><span><span>20</span><span>drwxr-xr-x    <span>3</span> root     root          <span>4096</span> Dec <span>11</span> 14:33 Users
</span></span><span><span>21</span><span>drwx------    <span>1</span> root     root          <span>4096</span> Dec <span>11</span> 14:33 root
</span></span><span><span>22</span><span>/ <span># ls -ltr /Users/paolomainardi/</span>
</span></span><span><span>23</span><span>total <span>4</span>
</span></span><span><span>24</span><span>drwxr-xr-x    <span>4</span> root     root           <span>128</span> Dec <span>18</span>  <span>2021</span> Public
</span></span><span><span>25</span><span>drwx------    <span>4</span> root     root           <span>128</span> Dec <span>18</span>  <span>2021</span> Music
</span></span><span><span>26</span><span>drwx------    <span>5</span> root     root           <span>160</span> Dec <span>18</span>  <span>2021</span> Pictures
</span></span><span><span>27</span><span>drwx------    <span>4</span> root     root           <span>128</span> Dec <span>18</span>  <span>2021</span> Movies
</span></span><span><span>28</span><span>drwxr-xr-x    <span>4</span> root     root           <span>128</span> Dec <span>18</span>  <span>2021</span> bin
</span></span><span><span>29</span><span>drwxr-xr-x    <span>4</span> root     root           <span>128</span> Dec <span>31</span>  <span>2021</span> go
</span></span><span><span>30</span><span>-rw-r--r--    <span>1</span> root     root            <span>98</span> Apr  <span>1</span>  <span>2022</span> README.md
</span></span><span><span>31</span><span>drwxr-xr-x    <span>5</span> root     root           <span>160</span> Apr  <span>3</span>  <span>2022</span> webapps
</span></span><span><span>32</span><span>drwx------    <span>6</span> root     root           <span>192</span> Nov <span>12</span> 16:50 Applications
</span></span><span><span>33</span><span>drwxr-xr-x    <span>3</span> root     root            <span>96</span> Nov <span>28</span> 21:23 Sites
</span></span><span><span>34</span><span>drwxr-xr-x   <span>14</span> root     root           <span>448</span> Nov <span>28</span> 22:22 temp
</span></span><span><span>35</span><span>drwx------  <span>105</span> root     root          <span>3360</span> Dec  <span>5</span> 09:16 Library
</span></span><span><span>36</span><span>drwx------  <span>164</span> root     root          <span>5248</span> Dec  <span>8</span> 01:16 Downloads
</span></span><span><span>37</span><span>drwx------    <span>5</span> root     root           <span>160</span> Dec  <span>8</span> 01:27 Desktop
</span></span><span><span>38</span><span>drwx------   <span>26</span> root     root           <span>832</span> Dec  <span>8</span> 01:37 Documents
</span></span></code></pre></div><h3 id="volumes">Volumes
<a href="#volumes"><i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span></a></h3><p>As the <a href="https://docs.docker.com/storage/volumes/">documentation</a> says:</p><blockquote><p>Volumes are the preferred mechanism for persisting data generated by and used by Docker containers. While <a href="https://docs.docker.com/storage/bind-mounts/">bind mounts</a> depend on the host machine‚Äôs directory structure and OS, volumes are completely managed by Docker. Volumes have several advantages over bind mounts:</p></blockquote><blockquote><p>Volumes have several advantages:</p><ul><li><em>Volumes are easier to back up or migrate than bind mounts.</em></li><li><em>You can manage volumes using Docker CLI commands or the Docker API.</em></li><li><em>Volumes work on both Linux and Windows containers.</em></li><li><em>Volumes can be more safely shared among multiple containers.</em></li><li><em>Volume drivers let you store volumes on remote hosts or cloud providers, to encrypt the contents of volumes, or to add other functionality.</em></li><li><em>New volumes can have their content pre-populated by a container.</em></li><li>Volumes on Docker Desktop have <strong>much higher performance</strong> <strong>than bind mounts</strong> from <strong>Mac</strong> and <strong>Windows hosts</strong>.</li></ul></blockquote><p>Well, there‚Äôs nothing to add here; the <strong>advantages</strong> of volumes vs. bind mounts are apparent, especially the last point.</p><p>But the biggest <strong>drawback</strong> is the <strong>developer experience</strong>; they are not meant to satisfy this requirement from the beginning, and using them for coding is counterintuitive or not usable.</p><p>Let me demonstrate in practice how they work; I‚Äôll show you in order:</p><ol><li>A javascript node API up and running on localhost</li><li>Development lifecycle on the host</li><li>Create a Docker Volume</li><li>Create a container using the docker volume</li><li>Developing workflow inside a container with a volume</li></ol><p><em>(I am the king of typos, I‚Äôve tried to record this asciinema without errors ten times, and this is the best I‚Äôve finally achieved üèÜüèÜüèÜ)</em></p><p>As you have noted, the <strong>biggest drawback</strong> here is that <strong>any changes</strong> I am doing outside the container must be copied inside the container with <code>docker cp</code>.</p><p>I <strong>could have mitigated</strong> this issue by <strong>installing VI inside the container</strong>, but I would <strong>have lost all my dotfiles,</strong> and usually, for Javascript, I prefer to use VSCode.</p><h2 id="volumes-vs-bind-mounts">Volumes vs. bind-mounts
<a href="#volumes-vs-bind-mounts"><i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span></a></h2><p>Well, a long journey so far, and still not yet a solution üòé</p><p>At least we have learned two things:</p><ol><li>Bind mounts are the most natural way to move our files inside a container, but they suffer severe performance issues caused by file system sharing when the Docker engine runs in a VM.</li><li>Volumes are way faster than bind mounts, but they lack the basics of the development experience (e.g., You and your local editor cannot see the files outside the container)</li></ol><h3 id="benchmarks">Benchmarks
<a href="#benchmarks"><i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span></a></h3><p>To demonstrate how much the performance is affected based on different scenarios (bind, volumes), I‚Äôve created a simple <a href="https://github.com/paolomainardi/docker-for-mac-bench">test suite</a>, nothing super fancy, just running some <code>npm install</code> tests on an empty <a href="https://create-react-app.dev/">create-react-app</a> project.</p><p>Let‚Äôs see them in action:</p><p><strong>Environments</strong>:</p><ol><li>Pane top: macOS - Docker Desktop - virtioFS enabled</li><li>Pane bottom: Linux</li></ol><p><strong>Tests (npm install)</strong>:</p><ol><li>Native node on the host</li><li>Docker without bind/volumes</li><li>Docker with a bind mount + a volume just for node_modules</li><li>Docker with a bind mount</li></ol><h4 id="syntethic-results">Syntethic results
<a href="#syntethic-results"><i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span></a></h4><table><thead><tr><th>Test</th><th>Operating system</th><th>Time (s)</th></tr></thead><tbody><tr><td>Native</td><td>Linux</td><td>5,73</td></tr><tr><td>Docker</td><td>Linux</td><td>5.64</td></tr><tr><td>Docker - Bind Mount</td><td>Linux</td><td>6.81</td></tr><tr><td><strong>Docker - Bind Mount + Volume</strong></td><td>Linux</td><td>6,18</td></tr><tr><td>Native</td><td>macOS</td><td>4.09</td></tr><tr><td>Docker</td><td>macOS</td><td>6.80</td></tr><tr><td>Docker - Bind Mount</td><td>macOS</td><td>7.65</td></tr><tr><td><strong>Docker - Bind Mount + Volume</strong></td><td>macOS</td><td><strong>21.05</strong> üèÜ</td></tr></tbody></table><p>And finally, we can see the performance impact results; macOS is more or less x3.5 times slower (<a href="https://github.com/sparkfabrik/sparkdock/issues/61">10x times slower when using gRPC Fuse</a>) when using just the bind mount, and the culprit here is the <code>node\_modules</code> directory <em>[328M and 37k files just for an empty React app].</em></p><p>Moving this directory (node_modules) in a Volume makes the timing on par with Linux: 7.65s.</p><p>I‚Äôve just taken Node as an example. Still, other development ecosystems are affected by the same issue <em>(yes, PHP, I am looking at you and your <code>vendor</code>üëÄ)</em>, or more generic directories with hundreds of thousands of small files are devilish for performance.</p><h2 id="fixes">Fixes
<a href="#fixes"><i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span></a></h2><p>Now that we have a general overview of the moving pieces, how they work, and can be combined, the next question is:</p><p><strong>What is the recommended method for decent performance and a good DX with Docker on Mac?</strong></p><p>This is an excellent question!</p><figure><img src="https://www.paolomainardi.com/images/posts/3-docker/docker-desktop-virtiofs.webp" alt="Use VirtioFS"/><figcaption><p>Use VirtioFS</p></figcaption></figure><p>The short answer for now is: <strong>Docker Desktop for Mac with VirtioFS</strong>, is a good compromise between <strong>performance and DX</strong>, even if it is slower than Linux; for most cases, it is a <strong>negligible difference</strong>.</p><p>When developing a new project in Node or PHP, you‚Äôre not going to <strong>reinstall your node_modules/vendor</strong> from scratch every time, it is rare, and in that rare cases, you‚Äôll spend a bit more seconds.</p><p>Just keep in mind that:</p><ol><li>It is a closed-source product</li><li>It requires a license depending on the usage</li><li>Since it is a pretty recent technology, <a href="https://github.com/docker/roadmap/issues/7#issuecomment-1356808914">many issues and regressions remain.</a></li></ol><p>So, what are the alternatives?</p><h3 id="bind-mounts--volume">Bind mounts + Volume
<a href="#bind-mounts--volume"><i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span></a></h3><p>As the results below show, this is the best approach to <strong>have almost native performance</strong>, but it comes with significant <strong>DX issues</strong>.</p><p>Let‚Äôs see an example:</p><p>We cannot see from our host the files being written by the container, and this is a big issue that can
impact how we write the software and how our IDE will be capable of understanding the codebase we are working on.</p><p>How we can fix it ? Well depends on how you are used to develop.</p><h4 id="terminal-editors-users">Terminal editor‚Äôs users
<a href="#terminal-editors-users"><i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span></a></h4><p>The only thing you need here is a container with the editor and the tools you need; mount your <strong>dotfiles</strong> and your <strong>code</strong>, and that‚Äôs it; you‚Äôll enjoy an almost <strong>native experience</strong>.</p><p><code>&gt; docker run --rm -v $HOME/.vimrc:/home/node/.vimrc -v $PWD:/usr/src/app node:lts bash</code></p><h4 id="gui-editors--ide-users">GUI Editors / IDE users
<a href="#gui-editors--ide-users"><i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span></a></h4><p>Here things <strong>become more complicated</strong>.</p><p><strong>Desktop applications</strong> are bound to the operating system they are designed for, and they usually cannot understand much of the underlying abstractions, like a filesystem inside a Docker container.</p><p>As the problem is that we cannot read or write files from and to the docker volume, we need a tool capable of this two-way syncing.</p><p>One of the most <strong>prominent solutions</strong> is <a href="https://mutagen.io/documentation/synchronization">Mutagen</a>.</p><p><strong>Mutagen</strong> allows <strong>syncing the files in both directions</strong> from/to the host/container when they happen.
You can find here <a href="https://mutagen.io/documentation/synchronization">how to install it</a> and how to configure it.</p><p>Not very easy to grasp at the beginning since it is composed of a <strong>daemon</strong>, a <strong>CLI tool</strong>, and some <strong>configuration files</strong>.
It natively supports Composer and has also been a part of the Docker Desktop experimental feature, <a href="https://github.com/mutagen-io/mutagen/issues/235">then deprecated</a> and then again by the Mutagen authors as a <a href="https://mutagen.io/documentation/docker-desktop-extension#license-and-pricing">Docker Desktop extension</a>.</p><p>The last worth mentions, it is also supported and integrated by the <a href="https://ddev.readthedocs.io/en/latest/users/install/performance/">DDEV project</a>.</p><p><strong>DDEV</strong> is a tool to manage local development environments for <strong>PHP projects</strong> (it started with Drupal ‚ù§Ô∏è) and then extended to many more frameworks.
This is the best <strong>plug-and-play</strong> and <strong>battery-included</strong> choice to manage your PHP project with Docker, no matter the operating system you run.</p><p><strong>Well, what if we want to avoid installing other moving parts? Can we run our GUI Editor as a Docker container so we can access the files?</strong></p><p><a href="https://github.com/89luca89/distrobox">You can run them quite easily</a> on Linux, but there isn‚Äôt a comparable straightforward solution to run Linux GUI applications on macOS; unless you install <a href="https://www.xquartz.org/">XQuartz</a> (Xorg for macOS) and <a href="https://gist.github.com/sorny/969fe55d85c9b0035b0109a31cbcb088">do some tricks</a>.</p><p>Microsoft here did a very cool thing instead; they implemented a Wayland compositor for Windows capable of natively running Linux GUI applications: <a href="https://github.com/microsoft/wslg">WSLg</a></p><p>Anyway, this is not a very practical way to use an editor, which will always be very limited and poorly integrated with the operating system.</p><p>The best solution would be to have an IDE capable of running on your local system while simultaneously being capable of using Docker Containers, having the best of both worlds.</p><p>Should we invent it? Luckily for us, no, we shouldn‚Äôt because someone already did it, and I am talking about <a href="https://containers.dev/">Development Containers</a></p><h4 id="development-containers">Development Containers
<a href="#development-containers"><i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span></a></h4><blockquote><p>An <a href="https://containers.dev/implementors/spec/">open specification</a> for enriching containers with development specific content and settings.</p></blockquote><p>A Development Container (or Dev Container for short) allows you to use a container as a full-featured development environment. It can be used to run an application, to separate tools, libraries, or runtimes needed for working with a codebase, and to aid in continuous integration and testing. Dev containers can be run locally or remotely, in a private or public cloud.</p><p>Not more to add here; the intent and the specs are very straightforward and clear about the goals.</p><p>Microsoft <a href="https://github.com/devcontainers/spec">created this project</a>, and the spec is released under the <a href="https://creativecommons.org/licenses/by/4.0/legalcode">CC4</a> license.</p><p><a href="https://github.com/devcontainers/spec/blob/main/docs/specs/supporting-tools.md">Here</a> you can find a list of <em>‚Äúsupporting tools‚Äù</em> for the moment is almost ‚Äúall Microsoft‚Äù for the editors part and cloud services; we have, of course, Visual Studio Code and GitHub Codespaces.</p><p>However, the project is slowly getting attraction, even tho there are several competitors and compelling standards in this area.</p><p>Cloud companies and developer-focused startups envision a world made of cloud-based development environments, which have pros and cons. I‚Äôll debate this topic in another post.</p><p>The most significant competitors now are:</p><ul><li>Gitpod</li><li>GCP Cloud Workstations</li><li>AWS Cloud9</li><li>Docker Development Environment</li></ul><h4 id="how-it-works">How it works
<a href="#how-it-works"><i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span></a></h4><p>You need to create a <code>.devcontainer/devcontainer.json</code> file inside the project‚Äôs root, and a supporting editor (AKA VsCode) will just run it.</p><figure><img src="https://code.visualstudio.com/assets/docs/devcontainers/containers/architecture-containers.png" alt="Developing inside a container"/><figcaption><p>Developing inside a container</p></figcaption></figure><p>You can find here <a href="https://code.visualstudio.com/docs/devcontainers/tutorial">a very good quick start</a>. It covers almost all aspects, including using it with Docker Compose.</p><p>There is also a <a href="https://code.visualstudio.com/remote/advancedcontainers/improve-performance">very nice guide on how to</a> use it to improve the performance of macOS using Volumes instead of just bind mounts, which we have already discussed.</p><p>To make it easily understandable (at least for me), I‚Äôve created a PoC project to connect all the wires;
the project lives here: <a href="https://github.com/paolomainardi/docker-backstage-devcontainers">https://github.com/paolomainardi/docker-backstage-devcontainers</a> and it‚Äôs an empty
<a href="https://backstage.io/">Backstage</a> application to test the entire development workflow using the VSCode Dev Containers integration.</p><p>To conclude, the overall idea is excellent, and since it is an open standard, it could be easily adopted by other vendors, and there are yet some efforts ongoing:</p><ol><li><a href="https://github.com/gitpod-io/gitpod/issues/7721">Gitpod</a></li><li><a href="https://youtrack.jetbrains.com/issue/IDEA-202267">Jetbrains</a></li><li><a href="https://codeberg.org/esensar/nvim">nVIM</a></li></ol><p>To summarize the key points, i like much:</p><ol><li>Everything is Container-based.</li><li>I can define custom VSCode extensions: I can define a shared development environment between team members.</li><li>Thanks to the <a href="https://github.com/devcontainers/features">Development containers features.</a>, I can use Docker and Docker-compose inside the container.</li><li>SSH works out of the box (you must have the ssh-agent up and running)/</li><li>I can reuse the very same configuration locally or in the cloud.</li></ol><h2 id="conclusions">Conclusions
<a href="#conclusions"><i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span></a></h2><p>This post started with the intent to quickly explain how to improve the performance of Docker on macOS, but at the same time, I felt the need to leave nothing behind of the basic concepts that are fundamentals to understand and get out the max from your system.</p><p>The big question here is, <strong>why not just use Linux?</strong></p><p>This <strong>isn‚Äôt</strong> a <strong>trivial question</strong>; I use Linux as my <a href="https://github.com/paolomainardi/archlinux-ansible-provisioner">daily driver</a> (I‚Äôm writing this post on Linux), and I consider it the best development environment you can use.</p><p>But the <strong>hardware ecosystem</strong> must be taken into account, especially since the <strong>Apple Silicon</strong> machines are in the market; they are so great in terms of <strong>performance, battery life, and service</strong>.</p><p>So why don‚Äôt you get the <strong>best of both worlds</strong>? Machines are powerful enough today to run them seamlessly.
There are other creative ways to combine them, as <strong>Michal Hashimoto</strong> did, <a href="https://github.com/mitchellh/nixos-config">merging macOS and NixOS</a>, lovely.</p><p>Use what you like and what you find better for your workflow and, why not, <strong>what makes you happy</strong> today.</p><p>This is also a gift for the future me; next time, I should explain to someone how Docker works on Linux and outside, and I‚Äôll use this guide as a general reference.</p><p>Thanks for reading all of this, and if you find something wrong or want to discuss some topics further, get in touch with me.</p></div></div>
  </body>
</html>
