<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.totaltypescript.com/typescript-5-2-new-keyword-using">Original</a>
    <h1>TypeScript 5.2&#39;s New Keyword: &#39;using&#39;</h1>
    
    <div id="readability-page-1" class="page"><div><p>TypeScript 5.2 will introduce a new keyword - &#39;using&#39; - that you can use to dispose of anything with a <code>Symbol.dispose</code> function when it leaves scope.</p>
<pre null="true"><p>typescript</p><p><code><p><span>{</span></p><p><span>  </span><span>const</span><span> </span><span>getResource</span><span> = () </span><span>=&gt;</span><span> {</span></p><p><span>    </span><span>return</span><span> {</span></p><p><span>      </span><span>[</span><span>Symbol</span><span>.dispose]:</span><span> () </span><span>=&gt;</span><span> {</span></p><p><span>        </span><span>console</span><span>.</span><span>log</span><span>(</span><span>&#39;Hooray!&#39;</span><span>)</span></p><p><span>      }</span></p><p><span>    }</span></p><p><span>  }</span></p><p><span>  </span><span>using</span><span> </span><span>resource</span><span> = </span><span>getResource</span><span>();</span></p><p><span>} </span><span>// &#39;Hooray!&#39; logged to console</span></p></code></p></pre>

<p>This is based on the <a href="https://github.com/tc39/proposal-explicit-resource-management">TC39 proposal</a>, which recently reached Stage 3, indicating that it is coming to JavaScript.</p>
<p><code>using</code> will be extremely useful for managing resources like file handles, database connections, and more.</p>
<h2><code>Symbol.dispose</code></h2>
<p><code>Symbol.dispose</code> is a new global symbol in JavaScript. Anything with a function assigned to <code>Symbol.dispose</code> will be considered a &#39;resource&#39; - <a href="https://github.com/tc39/proposal-explicit-resource-management#definitions">&#34;an object with a specific lifetime&#34;</a> - and can be used with the <code>using</code> keyword.</p>
<pre null="true"><p>typescript</p><p><code><p><span>const</span><span> </span><span>resource</span><span> = {</span></p><p><span>  </span><span>[</span><span>Symbol</span><span>.dispose]:</span><span> () </span><span>=&gt;</span><span> {</span></p><p><span>    </span><span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;Hooray!&#34;</span><span>);</span></p><p><span>  },</span></p><p><span>};</span></p></code></p></pre>

<h2><code>await using</code></h2>
<p>You can also use <code>Symbol.asyncDispose</code> and <code>await using</code> to handle resources which need to be disposed asynchronously.</p>
<pre null="true"><p>typescript</p><p><code><p><span>const</span><span> </span><span>getResource</span><span> = () </span><span>=&gt;</span><span> ({</span></p><p><span>  </span><span>[</span><span>Symbol</span><span>.asyncDispose]:</span><span> </span><span>async</span><span> () </span><span>=&gt;</span><span> {</span></p><p><span>    </span><span>await</span><span> </span><span>someAsyncFunc</span><span>();</span></p><p><span>  },</span></p><p><span>});</span></p><p><span>{</span></p><p><span>  </span><span>await</span><span> </span><span>using</span><span> </span><span>resource</span><span> = </span><span>getResource</span><span>();</span></p><p><span>}</span></p></code></p></pre>

<p>This will await the <code>Symbol.asyncDispose</code> function before continuing.</p>
<p>This will be useful for resources such as database connections, where you want to ensure that the connection is closed before the program continues.</p>
<h2>Use cases</h2>
<h3>File handles</h3>
<p>Accessing the file system via file handlers in node could be a lot easier with <code>using</code>.</p>
<p>Without <code>using</code>:</p>
<pre null="true"><p>typescript</p><p><code><p><span>import</span><span> { </span><span>open</span><span> } </span><span>from</span><span> </span><span>&#34;node:fs/promises&#34;</span><span>;</span></p><p><span>let</span><span> </span><span>filehandle</span><span>;</span></p><p><span>try</span><span> {</span></p><p><span>  </span><span>filehandle</span><span> = </span><span>await</span><span> </span><span>open</span><span>(</span><span>&#34;thefile.txt&#34;</span><span>, </span><span>&#34;r&#34;</span><span>);</span></p><p><span>} </span><span>finally</span><span> {</span></p><p><span>  </span><span>await</span><span> </span><span>filehandle</span><span>?.</span><span>close</span><span>();</span></p><p><span>}</span></p></code></p></pre>

<p>With <code>using</code>:</p>
<pre null="true"><p>typescript</p><p><code><p><span>import</span><span> { </span><span>open</span><span> } </span><span>from</span><span> </span><span>&#34;node:fs/promises&#34;</span><span>;</span></p><p><span>const</span><span> </span><span>getFileHandle</span><span> = </span><span>async</span><span> (</span><span>path</span><span>: </span><span>string</span><span>) </span><span>=&gt;</span><span> {</span></p><p><span>  </span><span>const</span><span> </span><span>filehandle</span><span> = </span><span>await</span><span> </span><span>open</span><span>(</span><span>path</span><span>, </span><span>&#34;r&#34;</span><span>);</span></p><p><span>  </span><span>return</span><span> {</span></p><p><span>    </span><span>filehandle</span><span>,</span></p><p><span>    </span><span>[</span><span>Symbol</span><span>.asyncDispose]:</span><span> </span><span>async</span><span> () </span><span>=&gt;</span><span> {</span></p><p><span>      </span><span>await</span><span> </span><span>filehandle</span><span>.</span><span>close</span><span>();</span></p><p><span>    },</span></p><p><span>  };</span></p><p><span>};</span></p><p><span>{</span></p><p><span>  </span><span>await</span><span> </span><span>using</span><span> </span><span>file</span><span> = </span><span>getFileHandle</span><span>(</span><span>&#34;thefile.txt&#34;</span><span>);</span></p><p><span>  </span><span>// Do stuff with file.filehandle</span></p><p><span>} </span><span>// Automatically disposed!</span></p></code></p></pre>

<h3>Database connections</h3>
<p>Managing database connections is a common use case for <code>using</code> in C#.</p>
<p>Without <code>using</code>:</p>
<pre null="true"><p>typescript</p><p><code><p><span>const</span><span> </span><span>connection</span><span> = </span><span>await</span><span> </span><span>getDb</span><span>();</span></p><p><span>try</span><span> {</span></p><p><span>  </span><span>// Do stuff with connection</span></p><p><span>} </span><span>finally</span><span> {</span></p><p><span>  </span><span>await</span><span> </span><span>connection</span><span>.</span><span>close</span><span>();</span></p><p><span>}</span></p></code></p></pre>

<p>With <code>using</code>:</p>
<pre null="true"><p>typescript</p><p><code><p><span>const</span><span> </span><span>getConnection</span><span> = </span><span>async</span><span> () </span><span>=&gt;</span><span> {</span></p><p><span>  </span><span>const</span><span> </span><span>connection</span><span> = </span><span>await</span><span> </span><span>getDb</span><span>();</span></p><p><span>  </span><span>return</span><span> {</span></p><p><span>    </span><span>connection</span><span>,</span></p><p><span>    </span><span>[</span><span>Symbol</span><span>.asyncDispose]:</span><span> </span><span>async</span><span> () </span><span>=&gt;</span><span> {</span></p><p><span>      </span><span>await</span><span> </span><span>connection</span><span>.</span><span>close</span><span>();</span></p><p><span>    },</span></p><p><span>  };</span></p><p><span>};</span></p><p><span>{</span></p><p><span>  </span><span>await</span><span> </span><span>using</span><span> { </span><span>connection</span><span> } = </span><span>getConnection</span><span>();</span></p><p><span>  </span><span>// Do stuff with connection</span></p><p><span>} </span><span>// Automatically closed!</span></p></code></p></pre>

<section><div><a target="_blank" rel="noopener" href="https://res.cloudinary.com/total-typescript/image/upload/v1687173860/await-using_lalzrw.jpg"><img src="https://res.cloudinary.com/total-typescript/image/upload/v1687173860/await-using_lalzrw.jpg" alt="" aria-hidden="true"/></a></div></section><p>â€”<span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27154%27%20height=%2734%27/%3e"/></span><img alt="Matt&#39;s signature" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span></p></div></div>
  </body>
</html>
