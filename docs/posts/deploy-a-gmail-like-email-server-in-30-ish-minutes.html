<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://andycallaghan.com/posts/deploy-a-gmail-like-email-server-in-30-minutes/">Original</a>
    <h1>Deploy a Gmail-like email server in 30 (ish) minutes</h1>
    
    <div id="readability-page-1" class="page"><div>
<p><a href="https://news.ycombinator.com/item?id=29672846">A recent HN discussion</a> got me thinking - why don’t I try and run my own email infrastructure? Some of the main reasons I hadn’t previously tried might come naturally:</p>
<ul>
<li>Email servers are a pain to set up</li>
<li>They’re open to attack</li>
<li>Hosted email is fairly inexpensive and easy to set up</li>
</ul>
<p>I recently expanded to having three different domains for email - one for general web logins &amp; CVs, one I give to just family &amp; friends, and the last for my company <a href="https://jammed.app">Jammed</a>. To make things worse, each of these domains is hosted by different providers, so consolidating them all to use one email server would be a fairly good reason to bother.</p>
<p>Well, given I had a Christmas Eve to myself, I decided to try… and it was actually quite a bit easier than I thought it would be.</p>
<p>I’m a bit of a privacy geek, but it wasn’t the driving force behind me owning the infra - but still the thought of all of my business email touching a Google server was always a bit of a sting.</p>
<p>From the off, I had some reasonable requirements:</p>
<ul>
<li>It had to use IMAP, SSL/TLS</li>
<li>I had to be able to use mulltiple email accounts with the same server</li>
<li>It kinda just had to look after itself once created</li>
<li>Be reasonably cheap, but not any cheaper than my current three hosted email subsciptions</li>
</ul>

<p>At first I found a few github projects that were stale, but eventually came across the excellent <a href="https://github.com/docker-mailserver/docker-mailserver/">Docker Mailserver</a> which is a simple Docker Compose container setup that runs a fully fledged mail server.</p>
<p>The blog article is the setup to make Docker Mailserver act like a Gmail server - if you don’t really care about Archive/Junk/All Mail working, you can just use the default setup and be reasonably happy. I’m sure you could go further with this setup, with Kubernetes, but I’m not going to bother as it’s overkill for a single email server.</p>
<p>For this you need</p>
<ul>
<li>A Digital Ocean (or similar) account</li>
<li>A domain name to host it on</li>
<li>A DNS setup to point the domain to the server (I use Cloudflare)</li>
</ul>
<h2 id="step-i-digital-ocean-vm">Step I: Digital Ocean VM</h2>
<h3 id="2gb-ram-droplet">2GB ram Droplet</h3>
<p>I spun up a small <a href="https://m.do.co/c/1ecc21b66a25">Digital Ocean droplet</a> with using the ‘Docker’ marketplace image. Docker Mailserver needs at least 2GB of RAM to run - this can be less if you disable virus scanning (which loads the full signature database in memory at boot).</p>
<p>I set mine up in the London region, but anywhere that’s close to you physically is fine.</p>
<h3 id="attach-a-volume">Attach a volume</h3>
<p>This is the most important part - you attach a block storage volume to the droplet, so you have the option later of scaling up the storage, independently of the droplet size. The volume is attached to the droplet at boot, and is then mounted on the host machine.</p>
<p>I added a 50GB volume to mine, because it’s easy to scale later.</p>
<h3 id="enable-backups">Enable backups</h3>
<p>This should be pretty self-explanatory - email is pretty important data, so it’s important to keep it backed up.</p>
<h2 id="step-ii-ssh-rootdroplet-ip">Step II: <code>ssh <a href="https://andycallaghan.com/cdn-cgi/l/email-protection" data-cfemail="10627f7f645074627f607c75643d7960">[email protected]</a></code></h2>
<p>Login to your droplet, and run the following commands:</p>
<div><p><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
</pre></td><td><pre><span>mkdir </span>mail
<span>cd </span>mail
<span>DMS_GITHUB_URL</span><span>=</span><span>&#39;https://raw.githubusercontent.com/docker-mailserver/docker-mailserver/master&#39;</span>
wget <span>&#34;</span><span>${</span><span>DMS_GITHUB_URL</span><span>}</span><span>/docker-compose.yml&#34;</span>
wget <span>&#34;</span><span>${</span><span>DMS_GITHUB_URL</span><span>}</span><span>/mailserver.env&#34;</span>
wget <span>&#34;</span><span>${</span><span>DMS_GITHUB_URL</span><span>}</span><span>/setup.sh&#34;</span>

<span>chmod </span>a+x ./setup.sh
./setup.sh <span>help</span>
</pre></td></tr></tbody></table></code></p></div>
<p><code>setup.sh</code> is the main script that configures the mail server.</p>
<h2 id="step-iii-mount-the-block-volume">Step III: Mount the block volume</h2>
<p>Head to ‘Volumes’ in the Digital Ocean dashboard, and attach the volume to your droplet (unless it already has done so). Next, find the ‘configure your volume’ section, and follow the instructions to mount the volume.</p>
<p>After this point, the droplet will always mount the volume at boot, and the volume will be mounted on the host machine for us to use as the data store for email, config files, etc.</p>
<h2 id="step-iv-add-the-mount-points--change-domain-name-in-docker-composeyml">Step IV: Add the mount points &amp; change domain name in <code>docker-compose.yml</code></h2>
<h3 id="domain">Domain</h3>
<p>First, at the top of the file, add your full domain name in as the <code>hostname</code> variable.</p>
<div><p><code><table><tbody><tr><td><pre>1
2
3
</pre></td><td><pre><span>...</span>
    <span>hostname</span><span>:</span> <span>mail.example.com</span>
<span>...</span>
</pre></td></tr></tbody></table></code></p></div>
<h3 id="volumes">Volumes</h3>
<p>Now we have a persistent block volume, we can change the mount points in the <code>docker-compose.yml</code> file to point to the volume.</p>
<p>Mine looks like this:</p>
<div><p><code><table><tbody><tr><td><pre>1
2
3
4
5
6
</pre></td><td><pre><span>volumes</span><span>:</span>
    <span>-</span> <span>/mnt/volume_lon1_01/mail-data/:/var/mail/</span>
    <span>-</span> <span>/mnt/volume_lon1_01/mail-state/:/var/mail-state/</span>
    <span>-</span> <span>/mnt/volume_lon1_01/mail-logs/:/var/log/mail/</span>
    <span>-</span> <span>/mnt/volume_lon1_01/config/:/tmp/docker-mailserver/</span>
    <span>-</span> <span>/etc/localtime:/etc/localtime:ro</span>
</pre></td></tr></tbody></table></code></p></div>
<p><code>mnt/volume_lon1_01</code> is my Digital Ocean block volume, and setting these will mount the Docker volumes on the host machine in the right places.</p>
<h2 id="step-v-configure-letsencrypt">Step V: Configure letsencrypt</h2>
<p>Follow the instructions to setup <a href="https://github.com/certbot/certbot">Certbot</a> to automatically provision and renew the certificate for the domain you want to use. For Cloudflare, you can use their DNS provisioning plugin using an API key that verifies the domain you want to use without needing to set up a nginx server to serve the challenge.</p>
<p>Make sure you provision a certificate for the subdomain you are using, and it needs to exactly match the host you use for the mailserver. For example, if you are using <code>mail.example.com</code> as the host, you need to provision a certificate for <code>mail.example.com</code> and not <code>example.com</code> or you’ll get IMAP TLS auth errors when you try to connect to the server.</p>
<p>You run certbot on the droplet itself, not in Docker. Once the certificate is provisioned, you then just add the /etc/letsencrypt volume into the <code>docker-compose.yml</code> file so that the host machine certificates are available to the containers.</p>
<div><p><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
</pre></td><td><pre><span>volumes</span><span>:</span>
    <span>-</span> <span>/mnt/volume_lon1_01/mail-data/:/var/mail/</span>
    <span>-</span> <span>/mnt/volume_lon1_01/mail-state/:/var/mail-state/</span>
    <span>-</span> <span>/mnt/volume_lon1_01/mail-logs/:/var/log/mail/</span>
    <span>-</span> <span>/mnt/volume_lon1_01/config/:/tmp/docker-mailserver/</span>
    <span>-</span> <span>/etc/letsencrypt/:/etc/letsencrypt/</span>
    <span>-</span> <span>/etc/localtime:/etc/localtime:ro</span>
</pre></td></tr></tbody></table></code></p></div>
<h2 id="step-vi-configure-imap-folders">Step VI: Configure IMAP folders</h2>
<p>By default, <code>docker-mailserver</code> only provides <a href="https://docker-mailserver.github.io/docker-mailserver/edge/examples/uses-cases/imap-folders/">‘Inbox’, ‘Sent’, ‘Drafts’ folders for IMAP</a>. These are termed ‘Special folders’, and most clients now support ones like ‘Archive’ and ‘Junk’ as well. I really like this feature, and I’m not sure why it’s not in the default, but hey ho! I’ll add it:</p>
<p>To make changes here, we need to configure <code>dovecot</code> to add these new folders to the IMAP server.</p>
<p>First, grab the <code>dovecot.conf</code> file from the master branch of the <code>docker-mailserver</code> repo.</p>
<div><p><code><table><tbody><tr><td><pre>1
2
</pre></td><td><pre><span>cd</span> /root/mail
wget https://raw.githubusercontent.com/docker-mailserver/docker-mailserver/master/target/dovecot/15-mailboxes.conf
</pre></td></tr></tbody></table></code></p></div>
<p>Now open it and edit it to uncomment the lines about ‘Archive’ &amp; ‘Junk’. I’ll leave this part as your choice. Once you’ve made your changes, modify the <code>docker-compose.yml</code> file to mount the new <code>.conf</code> file for <code>dovecot</code>.</p>
<div><p><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
</pre></td><td><pre><span>volumes</span><span>:</span>
    <span>-</span> <span>/mnt/volume_lon1_01/mail-data/:/var/mail/</span>
    <span>-</span> <span>/mnt/volume_lon1_01/mail-state/:/var/mail-state/</span>
    <span>-</span> <span>/mnt/volume_lon1_01/mail-logs/:/var/log/mail/</span>
    <span>-</span> <span>/mnt/volume_lon1_01/config/:/tmp/docker-mailserver/</span>
    <span>-</span> <span>/root/mail/15-mailboxes.conf:/etc/dovecot/conf.d/15-mailboxes.conf:ro</span>
    <span>-</span> <span>/etc/letsencrypt/:/etc/letsencrypt/:ro</span>
    <span>-</span> <span>/etc/localtime:/etc/localtime:ro</span>
</pre></td></tr></tbody></table></code></p></div>
<h2 id="step-vii-modify-the-mailserverenv-file">Step VII: Modify the <code>mailserver.env</code> file</h2>
<p>A few things we need to do here:</p>
<ul>
<li>Make sure ClamAV is enabled <code>ENABLE_CLAMAV=1</code></li>
<li>Make sure fail2ban is enabled <code>ENABLE_FAIL2BAN=1</code></li>
<li>Make sure letsecrypt is enable <code>SSL_TYPE=letsencrypt</code></li>
</ul>
<p>Otherwise read</p>
<h2 id="step-viii-create-the-first-email-account">Step VIII: Create the first email account</h2>
<p>We can’t start the docker compose yet, as we don’t yet have an initial email account. Instead, spin up a copy of <code>docker-mailserver</code> with the following command:</p>
<div><p><code><table><tbody><tr><td><pre>1
</pre></td><td><pre>docker run <span>--rm</span> <span>-v</span> <span>&#34;/mnt/volume_lon1_01/config/:/tmp/docker-mailserver/&#34;</span> docker.io/mailserver/docker-mailserver setup email add &lt;<a href="https://andycallaghan.com/cdn-cgi/l/email-protection" data-cfemail="750006100735111a18141c1b">[email protected]</a>&gt;
</pre></td></tr></tbody></table></code></p></div>
<p>Change <code>/mnt/volume_lon1_01/config</code> for your block volume mount point. You’ll be prompted to create a password for the email account.</p>
<h2 id="step-ix-boot-the-containers-in-the-foreground">Step IX: Boot the containers in the foreground</h2>
<p>One mistake I made initially was to start the containers in the background. This is because I was using the <code>docker-compose up -d mailserver</code> command to start the containers. This is the recommended way to start containers once everything is ready, but to make sure everything is working, use <code>docker-compose up</code> command to start the containers in the foreground.</p>
<p>Any letencrypt errors may be due to DNS not propogating, or the /etc/letsencrypt/ directory not being mounted correctly.</p>
<h2 id="step-x-configure-dkim">Step X: Configure DKIM</h2>
<p>DKIM is the way to sign emails with your domain’s public key. It’s really important this step is done, as it is one big way to prevent spam from being sent to your email account and a huge signal that this mail server is legit.</p>

<p>Add these as a TXT DNS record to the domain you want to use.</p>
<h2 id="step-xi-test-imap--smtp">Step XI: Test IMAP &amp; SMTP</h2>
<p>Create a new mailbox locally to your machine, and use the IMAP server, email, password you just created to connect to the server. You should see a list of folders, and you should be able to send an email to the mailbox. I found the OSX’s Mail has a Connection Doctor that will tell you if you’re connected to the server, and if not, what error actually occurred. Test send, receive, and delete emails.</p>
<h2 id="step-xii-add-other-accounts-dmarc">Step XII: Add other accounts, DMARC</h2>
<p>A big one for me was to add a second email account. I’m using a different domain, so I need to create a new mailbox for that domain. I’ll do this by running the following command:</p>

<p>DMARC is the method to allow spam and abuse reports to be sent and handled by the email server. I won’t go into it here, but Docker Webserver handles this for you transparently - you just need to add the DNS TXT record to your domain &amp; the email server will do the rest.</p>
<h2 id="conclusion">Conclusion</h2>
<p>It was easier than I thought to create a mail server that works as well as Gmail’s, and now really happy that I’m one of those weirdos that hosts their own mail server.</p>
<blockquote>
<p>Andy Callaghan makes <a href="https://jammed.app">Jammed</a> - booking software for music rehearsal studios and recording studios</p>
</blockquote>
</div></div>
  </body>
</html>
