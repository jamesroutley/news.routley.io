<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.industrialempathy.com/posts/high-performance-web-font-loading/">Original</a>
    <h1>More than you ever wanted to know about font loading on the web (2021)</h1>
    
    <div id="readability-page-1" class="page"><div><p>When I started thinking about writing a post about web font loading my intention was to propose relatively sophisticated ideas that I&#39;ve been playing with for a while. However, as I was trying to use them in real-world websites I realized that deployment of the more advanced techniques is de-facto impossible without the creation of new web standards.</p><p>With that the TL;dr of this post is: Use <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face/font-display"><code>font-display: optional</code></a>. However, I and many others really like our custom fonts. See the rest of the post for how we can get our cake and eat it, tooâ€“with a <a href="https://www.industrialempathy.com/perfect-ish-font-fallback/?font=Montserrat">tool</a> that automatically makes fallback fonts behave like their respective custom font counterpart.</p><h2 id="web-fonts-and-core-web-vitals">Web fonts and Core Web Vitals <a href="#web-fonts-and-core-web-vitals">#</a></h2><p>2 metrics in <a href="https://web.dev/vitals/">Google&#39;s Core Web Vitals</a> are directly impacted by font loading:</p><ol><li><a href="https://web.dev/lcp/">Largest Contentful Paint (LCP)</a> measures (among other things) when text renders. With text rendering blocked behind the web font download, LCP may be delayed.</li><li><a href="https://web.dev/cls/">Cumulative Layout Shift (CLS)</a> measures the document shifting around as the browser loads additional data. A browser switching from fallback font to a custom font leads to layout shift if fallback and custom font flow differently.</li></ol><p>The following video is showing the layout-shift created by font-loading.</p><h3 id="cls-and-invisible-text">CLS and invisible text <a href="#cls-and-invisible-text">#</a></h3><p>Font-based layout shift doesn&#39;t require the fallback font ever having displayed. If the page renders without the custom font having loaded but the fallback text remains invisible (this happens with <code>font-display: auto</code>, the default) then the space that is reserved for the invisible text depends on the space that <em>would</em> be taken up by the <em>fallback text</em>. Once the custom font comes in and the text becomes visible, there is a layout shift as the space taken up for text changes.</p><h2 id="stop-worrying-and-use-font-display%3A-optional">Stop worrying and use <code>font-display: optional</code> <a href="#stop-worrying-and-use-font-display%3A-optional">#</a></h2><p>With <code>font-display: optional</code> the browser only renders the custom font if it is available extremely quickly. In most scenarios that requires it being cached locally.</p><p>This leads to the best possible LCP: Your text always renders quickly, independent of network speed.</p><p>And it leads to the best possible CLS: Your custom font loading never causes layout shift because it is only used when it is available for the first text paint.</p><h3 id="when-not-to-use-font-display%3A-optional">When not to use <code>font-display: optional</code> <a href="#when-not-to-use-font-display%3A-optional">#</a></h3><p>The one reason that makes usage of <code>font-display: optional</code> impossible is if there is no viable fallback font: You need the custom font to load to make sense of the content. Generally that is the case for icon fonts. You probably shouldn&#39;t use these in the first place as they are bad for accessibility: You need to see the icons to comprehend them, and you cannot assign them alt-text.</p><h3 id="using-preload-with-font-display%3A-optional">Using preload with <code>font-display: optional</code> <a href="#using-preload-with-font-display%3A-optional">#</a></h3><p>Browsers will only download a font for a web page when CSS evaluation completes and it is determined that it is actually used on the page. That is much later than e.g. when image downloads are initiated which are done by the so-called pre-parser that does a quick scan of the HTML document as soon as it is available to the browser (and without blocking on synchronous scripts, stylesheets, etc.).</p><p>The common work-around is to use a link-preload element like this which explicitly instructs the browser to start the font download as soon as it discovers the element.</p><pre><code><span><span><span>&lt;</span>link</span></span></code></pre><p>The question is: Should you use these together with <code>font-display: optional</code>? The conventional wisdom is: No. The reason being that with <code>font-display: optional</code> either your font is already in cache in which case this doesn&#39;t do anything, or the font download is likely not fast enough to make the short deadline and the browser would render the fallback font anyway. In the latter case you give bandwidth at the most urgent time to the font which will never render and that bandwidth could be used to download other critical resources instead.</p><h4 id="when-disk-caching-isn&#39;t-enough">When disk caching isn&#39;t enough <a href="#when-disk-caching-isn&#39;t-enough">#</a></h4><p>However, with <code>font-display: optional</code> even users who have the font cached to disk might see the fallback font for the first page view of a new session because the custom font hasn&#39;t been loaded into the memory cache (Note, that while you might be developing your website on a laptop or phone with a very fast SSD, many of your users will have degraded storage devices with cache performance worse than a fast network). At least Chrome has a heuristic that if you preload the font, then it will hold painting for a few 100 of milliseconds and give the client a chance to fetch the font from disk or through a very fast internet connection. Whether you have a &#34;budget&#34; to spend those extra 100s milliseconds depends on your overall load performance.</p><h2 id="fonts-and-cdns">Fonts and CDNs <a href="#fonts-and-cdns">#</a></h2><p>One of the big changes in the web ecosystem over the last few years is that browsers no longer cache resources across top level sites. That means if your site and my site both load the exact same Roboto from Google Fonts, the browser will download it twice as opposed to only once like they used to do. This is very sad. It is, however, also the right call in the short-term from a privacy &amp; security perspective. In the long-term, maybe we can define web standards that eliminate the privacy &amp; security threats from cross-origin caching for heavily shared resources like fonts.</p><p>So, what are the consequences of this change in browser caching behavior? The main change is that font CDNs like Google Fonts and Adobe TypeKit now strictly make your site slower. They used to help with cross-site caching, but that benefit is gone. Instead they add expensive cross-origin requests (and their DNS lookups, TLS negotiations, etc.) into the critical path of loading your website.</p><p>With that it is clear that we should self-host all fonts on our primary domain for maximum performance. With fonts this can sometimes be problematic for licensing reasons, etc. but there is a good middle ground: Instead of self-hosting the fonts, self-host the loading code. For all common Font CDNs (<a href="https://blog.typekit.com/2017/10/11/advanced-web-font-loading-with-typekits-css-embed-code/">even TypeKit with some digging</a>, they default to JS based loading) this is simply a CSS file. Just download that CSS file. It won&#39;t bite ðŸ˜„. Or, if your font provider likes to sometimes change it, just fetch the CSS file once during your build process. Then inline the CSS file into your HTML and you completely eliminate the expensive cross-origin request from your critical path. While this approach still downloads the fonts themselves from the CDNs this doesn&#39;t hurt when you are using our friend <code>font-display: optional</code>.</p><h2 id="what-if-i-really-don&#39;t-want-to-use-font-display%3A-optional">What if I really don&#39;t want to use <code>font-display: optional</code> <a href="#what-if-i-really-don&#39;t-want-to-use-font-display%3A-optional">#</a></h2><p>So, I have a solution for you. It works remarkably well. This is based on <a href="https://meowni.ca/font-style-matcher/">an idea/tool by Monica Dinculescu</a> that she published in 2016. It allows tweaking your fallback font such that it uses approximately as much space as the custom font.</p><p>This is an awesome idea as it avoids the layout shift issues associated with loading the custom font: With the fallback already taking up the right amount of space, the custom font just swaps back into the same space when it loads.</p><h3 id="tool%3A-perfect-ish-font-fallbacks">Tool: Perfect-ish font fallbacks <a href="#tool%3A-perfect-ish-font-fallbacks">#</a></h3><p>My contribution over Monica&#39;s idea is that <a href="https://www.industrialempathy.com/perfect-ish-font-fallback/?font=Montserrat">I made a tool</a> that <em>automatically</em> matches the fallback font to the custom fontâ€“because computers are good at that stuff. <a href="https://www.industrialempathy.com/perfect-ish-font-fallback/?font=Montserrat">Try it out here.</a></p><p>The tool allows you to select every Google Font from a select menu. If you aren&#39;t using a Google Fonts, you can <a href="https://glitch.com/edit/#!/perfect-ish-font-fallback">remix this Glitch</a> for a custom solution.</p><h4 id="samples">Samples <a href="#samples">#</a></h4><p>The fallback-to-custom-font matching works really well in most cases. Here the left font is the custom font and on the right side is Arial:</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Z1kjMzm-1920w.avif 1920w, /img/remote/Z1kjMzm-1280w.avif 1280w, /img/remote/Z1kjMzm-640w.avif 640w, /img/remote/Z1kjMzm-320w.avif 320w" type="image/avif"/><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Z1kjMzm-1920w.webp 1920w, /img/remote/Z1kjMzm-1280w.webp 1280w, /img/remote/Z1kjMzm-640w.webp 640w, /img/remote/Z1kjMzm-320w.webp 320w" type="image/webp"/><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Z1kjMzm-1920w.jpg 1920w, /img/remote/Z1kjMzm-1280w.jpg 1280w, /img/remote/Z1kjMzm-640w.jpg 640w, /img/remote/Z1kjMzm-320w.jpg 320w" type="image/jpeg"/><img alt="Comparison of rendering of Montserrat and Arial" height="450" src="https://www.industrialempathy.com/img/remote/Z1kjMzm-1920w.jpg" width="1556" decoding="async" loading="lazy"/></picture></p><p>However, the whole thing is just an approximation. It definitely happens that things do not match 100%. (The screenshot shows the same text/font as before, but uses a different viewport width). The solution works most of the time. It isn&#39;t perfect but better than always having a major layout jump.</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/1JBfb6-1920w.avif 1920w, /img/remote/1JBfb6-1280w.avif 1280w, /img/remote/1JBfb6-640w.avif 640w, /img/remote/1JBfb6-320w.avif 320w" type="image/avif"/><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/1JBfb6-1920w.webp 1920w, /img/remote/1JBfb6-1280w.webp 1280w, /img/remote/1JBfb6-640w.webp 640w, /img/remote/1JBfb6-320w.webp 320w" type="image/webp"/><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/1JBfb6-1920w.jpg 1920w, /img/remote/1JBfb6-1280w.jpg 1280w, /img/remote/1JBfb6-640w.jpg 640w, /img/remote/1JBfb6-320w.jpg 320w" type="image/jpeg"/><img alt="Same fonts as in previous image but showing that Arial flows one line shorter" height="508" src="https://www.industrialempathy.com/img/remote/1JBfb6-1920w.jpg" width="1352" decoding="async" loading="lazy"/></picture></p><p>Finally, your mileage may vary with more extreme fonts. For very narrow fonts the fallback font may become unreadable. Having said that, for fonts that are commonly used this is not a problem.</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Z2sOknd-1920w.avif 1920w, /img/remote/Z2sOknd-1280w.avif 1280w, /img/remote/Z2sOknd-640w.avif 640w, /img/remote/Z2sOknd-320w.avif 320w" type="image/avif"/><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Z2sOknd-1920w.webp 1920w, /img/remote/Z2sOknd-1280w.webp 1280w, /img/remote/Z2sOknd-640w.webp 640w, /img/remote/Z2sOknd-320w.webp 320w" type="image/webp"/><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Z2sOknd-1920w.jpg 1920w, /img/remote/Z2sOknd-1280w.jpg 1280w, /img/remote/Z2sOknd-640w.jpg 640w, /img/remote/Z2sOknd-320w.jpg 320w" type="image/jpeg"/><img alt="Text with negative letter spacing that has the characters flow into each other" height="332" src="https://www.industrialempathy.com/img/remote/Z2sOknd-1920w.jpg" width="1354" decoding="async" loading="lazy"/></picture></p><h4 id="deploying-fallback-corrections-to-the-website">Deploying fallback corrections to the website <a href="#deploying-fallback-corrections-to-the-website">#</a></h4><p>Just add CSS like this:</p><pre><code><span><span><span>&lt;</span>style</span><span>&gt;</span></span><span><span></span></span><span><span><span>&lt;/</span>style</span><span>&gt;</span></span></code></pre><p>â€¦and that is it. This is possible as of July 2021</p><h3 id="a-new-web-standard">A new web standard <a href="#a-new-web-standard">#</a></h3><p>With the <code>@font-face</code> property <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face/size-adjust"><code>size-adjust</code></a> a web standard solution is coming for the font-matching problem space. The tool in this article<a href="https://www.industrialempathy.com/perfect-ish-font-fallback/?font=Judson">(requires Chrome 92+ or Firefox 92+) here</a> has been updated to rely on <code>size-adjust</code>.</p><p>Note, that there are additional related CSS properties <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face/ascent-override"><code>ascent-override</code></a> and <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face/descent-override"><code>descent-override</code></a>. However, you do not need to worry about these if you set a <code>line-height</code> of any non-default value for all text.</p><h2 id="summary">Summary <a href="#summary">#</a></h2><p>Using <code>font-display: optional</code> together with self-hosting the CSS for your web fonts gets you in really good shape with respect to LCP and CLS. However, with new web standards support for <code>size-adjust</code> there is a feasible way to avoid CLS while still always eventually switching to the custom font.</p></div></div>
  </body>
</html>
