<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://drobinin.com/posts/you-cant-curl-a-border/">Original</a>
    <h1>You can&#39;t cURL a Border</h1>
    
    <div id="readability-page-1" class="page"><div>
                    <p>An error fare to Iceland pops up. It&#39;s cheap enough to feel like a typo and most likely will be gone in minutes. I&#39;m moderately obsessed with ways to travel on budget, so I keep an eye on these.</p>
<figure>
  <p><img src="https://drobinin.com/assets/curl-expired_fare.png" width="300" alt="Edinburgh, Scotland to Reykjavik, Iceland for only £62 roundtrip"/>
  </p>
</figure>
<p>It isn’t one check, it’s a stack of small unfriendly ones, and takes around 20 minutes to process. Some bits are fun, like hunting for a seat upgrade, but mostly it’s counting midnights and expiry dates so a cheap weekend doesn’t become an expensive lesson.</p>
<p>I&#39;ve been doing this dance for a decade now. In 2015 I made a spreadsheet for a US visa application that wanted ten years of travel history, down to the day. The spreadsheet grew: UK work visa, Indefinite Leave to Remain and citizenship applications, Canadian work permits. Any government form that asked &#34;where have you been?&#34; got its answer from the same battered CSV. It worked well enough, in the sense that I was never detained.</p>
<p>It also made me think that this was a solvable problem I was solving badly. I built a ledger to answer “where was I on 15 March 2023?” Instead, I ran simulations to check, “if I book this, what breaks later?”</p>
<p>The only question is whether the computer can answer all of faster than I do, and leave December, the next border control, and the end of the tax year blissfully uneventful.</p>
<h2 id="does-this-trip-compile%3F">Does this trip compile? <a href="#does-this-trip-compile%3F">¶</a></h2>
<p>That twenty-minute panic before buying a flight comes from one basic problem: none of the systems that judge you will tell you your state.</p>
<p>Schengen is running one check. The UK is running another. Tax residency is running a third. Your passport is running its own quiet clock in the background. None of them explain themselves, and none of them agree on what “a day” even is.</p>
<p>Schengen cares about presence across rolling windows. The UK counts how many midnights you were physically in the country in a tax year that, for historical reasons , starts on 6 April out of all options. Some countries track how many days you’ve spent in certain places and change the medical paperwork they expect from you once you cross a threshold. Meanwhile your passport might fail you with its expiry date, validity rules that may apply on arrival or departure depending on routing, and a finite number of blank facing pages that some countries require.</p>
<p>None of that is easily exposed. The officer at the desk can see it but you can’t. That&#39;s parsing the <em>State</em>—both kinds. The government&#39;s view of you, and the state machine that tracks it.</p>
<h3 id="the-bureaucratic-edge-cases">The bureaucratic edge cases <a href="#the-bureaucratic-edge-cases">¶</a></h3>
<p>The rules aren&#39;t just complex—they&#39;re occasionally specific in ways that make you regret leaving the house in the first place.</p>
<p>To apply for British citizenship, you need to prove you were physically in the UK on your application date but five years ago. Not approximately five years, not that week—that exact day when you press &#34;submit&#34; on the form minus five years. Miss it by 24 hours and your application is reject after months of waiting, and you have to pay a hefty fee to re-apply.</p>
<p>Transiting through a UK airport? Leaving the terminal doesn&#39;t count as presence unless you do something &#34;unrelated to your travel&#34;—buy a sausage roll at Greggs, see a play in West End, meet a friend. The guidance doesn&#39;t even specify a minimum spend.</p>
<figure>
  <p><img src="https://drobinin.com/assets/curl-theatre_test.png" width="500" alt="Quote from gov.uk explaining how tax residency on transit is counted"/>
  </p>
  <figcaption>RFIG20730, <a href="https://www.gov.uk/hmrc-internal-manuals/residence-and-fig-regime-manual/rfig20730">see on gov.uk</a></figcaption>
</figure>
<p>Morocco runs on UTC+1 most of the year but switches to UTC during Ramadan to shorten the fasting day. Which means &#34;days spent in Morocco&#34; depends on your timezone database version and whether you remembered to update it.</p>
<p>It would be alright with a single source of truth, but all these facts are scattered across (semi)official websites and PDFs, and you&#39;re supposed to figure it out yourself.</p>
<p>So the job isn&#39;t &#34;log trips&#34; (I already did that for ten years in a spreadsheet). The job is: given what I&#39;ve already done and what I&#39;m about to do, does this plan quietly break anything, and if so, where, and by how much.</p>
<p>&#34;You&#39;re at 56 days because Amsterdam contributed 12, Prague 3, Barcelona 10, Iceland would add a month, and February doesn&#39;t count anymore&#34; is something I can trust, argue with, or fix. &#34;You&#39;re fine&#34; isn&#39;t.</p>
<p>That&#39;s where this stops being a spreadsheet and starts being a linter. Apparently I want the compiler warning before I press Buy.</p>
<h2 id="counting-the-right-midnight">Counting the right midnight <a href="#counting-the-right-midnight">¶</a></h2>
<p>If I want a compiler warning I trust, the compiler has to agree with the officer about what a day is.</p>
<p>For the past five years I&#39;ve been working on an app for people with epilepsy, managing timezones, medication reminders, and edge cases. We juggled multiple sources of truth and multiple storage styles (some records in UTC, some in local time with timezones stored separately—historical reasons, obviously).</p>
<p>This time, I tried to learn from that: facts are stored as instants, reasoning happens in local days of the jurisdiction that cares.</p>
<figure>
  <p><img src="https://drobinin.com/assets/curl-sensible_flight.png" width="500" alt="A very sensible flight itinerary with a few stops (DUB → EWR → MEX → LHR → TFS)"/>
  </p>
  <figcaption>DUB → EWR → MEX → LHR → TFS is a decent way to get from Dublin to Tenerife, don&#39;t @ me</figcaption>
</figure>
<p>Take this routing: depart Dublin morning of November the 17th, brief Newark layover, a longer one in Mexico City, 23-hour Heathrow stop, then Tenerife. Ask five immigration systems &#34;how many tax residency days?&#34; and you get five answers:</p>
<ul>
<li>Ireland: zero (under 30 days/year threshold).</li>
<li>US: zero (foreign-to-foreign transit under 24 hours).</li>
<li>Mexico: two (you cross midnight twice).</li>
<li>UK: zero (even though you cross midnight once), unless you went landside for non-travel reasons, then one.</li>
<li>Schengen: one (entry day counts, exit day will count too, even if both are only for 15 minutes).</li>
</ul>
<p>Each stop has same or similar conditions, but different state machines are asking different questions. I pin the timezone database version that produced each result, and when rules or clocks shift, I recompute so I could show both answers if needed. Yesterday should stay reproducible even when tomorrow disagrees.</p>
<h2 id="parsing-the-state">Parsing the State <a href="#parsing-the-state">¶</a></h2>
<p>In other words, the linter is meant to answer the same question in various disguises: &#34;what happens if I do this?&#34;</p>
<p>Can I book Christmas in the Alps with three summer weekends planned in Europe? Does it matter if I leave UK before the tax year ends? What passport should I travel on? Does anything expire between booking and boarding?</p>
<p>Every question has the same shape: simulate forward, find what breaks, decide if you care. The goal isn&#39;t to convince border officers—it&#39;s to not make mistakes they&#39;d catch. Trips get assembled from whatever I can verify later: geotagged photos, background location, manual entries. A resolver turns that into &#34;present on this local day&#34; and keeps track of why.</p>
<p>I don&#39;t hardcode rules, I ship interpretations instead: each jurisdiction has a small versioned blob that says what counts, how the window is measured, where that reading came from.</p>
<p>The paperwork gets the same treatment because documents are state machines too. A passport isn’t just means of identity; it has constraints and timers. Some requirements, like six months validity are legacy and usually exist to keep deportations possible without issuing emergency documents, but still need to be checked. </p>
<figure>
  <p><img src="https://drobinin.com/assets/curl-dashboard.png" width="200" alt="Residency app preview with dashboard featuring multiple tracked goals and alerts"/>
    <img src="https://drobinin.com/assets/curl-canada_lint.png" width="200" alt="Residency app preview with `compiler warnings` for an upcoming trip to Canada"/>
    <img src="https://drobinin.com/assets/curl-canada_goals.png" width="200" alt="Residency app preview with the list of goals tracked for Canada"/>
  </p>
</figure>
<p>Before I buy anything the linter should tell me that I don&#39;t have the correct flavour of IDP (and man, getting those in Scotland since they delegated it from Post Offices to corner shops is tough), that a Dubai connection flips a “valid on arrival” buffer into “invalid on departure”. Quiet warnings, early enough to change dates or renew the right booklet, and clear enough that I won&#39;t have to improvise at a counter.</p>
<p>If the world changes—new examples, revised guidance, a delayed system finally launches—I don’t rewrite history. I version the assumption, keep both answers recorded, and move on.</p>
<p>Keeping all those rules up-to-date is hard, so rather than maintaining rules for every country, I parse a few databases, then let users configure their own tracking goals. A user emailed about Cyprus&#39;s fast-tracked tax residency scheme; another pointed out I&#39;d missed a few countries entirely. The app gets better as people use it, which feels more honest than pretending to be a global authority on 195 countries&#39; immigration rules.</p>
<h2 id="making-things-public">Making things public <a href="#making-things-public">¶</a></h2>
<p>The app is local by default. Calculations happen on-device, and if you&#39;re in airplane mode, it still works. Network is always the bottleneck, and I&#39;m the person who <a href="https://drobinin.com/posts/how-i-accidentally-became-puregyms-unofficial-apple-wallet-developer/">spent a weekend reverse-engineering gym entry to save 44 seconds</a>. I&#39;m not adding server round-trips when you&#39;re standing at a gate.</p>
<p>Being local also means no liability. Personal immigration history is exactly the kind of data governments might want. Keeping it off my servers means nobody can demand I hand it over. Some friends asked about cloud sync: I keep saying no. Not because sync is hard—it is, though surely Claude Code can do that for me —but because the moment you add a server you add retention policies, jurisdiction questions, and a magnet for legal demands. If you want it on another device, export a file and move it yourself like the ancestors did it.</p>
<p>The first version just counted Schengen days, then I added the UK&#39;s midnight arithmetic because I needed it for my own calculations. Then documents with their expiry rules because I was tired of manually looking them up. Then the what-if layer because adding and deleting trips to see impact felt like manually diffing state. Then visa requirements and IDP rules: none of this was planned, it accumulated from use, the same way <a href="https://drobinin.com/posts/designing-software-for-things-that-rot/">my fermentation tracker grew from &#34;can I eat this?&#34; to HACCP compliance documents</a>.</p>
<p>I shipped it because keeping it private felt unfinished, and because I&#39;d like fewer people spending twenty minutes researching whether a £62 return flight will cause problems six months later.</p>
<figure>
  <p><img src="https://drobinin.com/assets/curl_iceland_3.jpg" width="220" alt="Views of Iceland during my recent trip"/>
    <img src="https://drobinin.com/assets/curl_iceland_1.jpg" width="220" alt="Views of Iceland during my recent trip"/>
    <img src="https://drobinin.com/assets/curl_iceland_2.jpg" width="220" alt="Views of Iceland during my recent trip"/>
  </p>
</figure>
<p>That Iceland error fare? I bought it. The app told me I wouldn&#39;t need an IDP, that the trip wouldn&#39;t push me over any Schengen threshold, that I&#39;d leave with 34 days of margin in my 90/180 window, and—importantly—that booking it would mean I&#39;d stop being a UK tax resident given my upcoming Canada move. Useful things to know before clicking purchase. The officer at Keflavík looked at his screen, agreed with his systems, and waved me through.</p>
<p>I called the app Residency and <a href="https://apps.apple.com/us/app/residency-days-tracker/id6749048224">you can get it here</a>. No subscriptions, costs less than an airport martini, and you&#39;ll likely regret it less a few hours later.</p>
<p>You can&#39;t <code>cURL</code> a border. But you can track your own state carefully enough that when the governments know the answer, so do you.</p>
<hr/>
<p>Working on problems where rules are complex and official documentation is <s>garbage</s> contradictory? I build systems that handle state when the state won&#39;t tell you your state. <a href="mailto:work@drobinin.com">work@drobinin.com</a></p>



                </div></div>
  </body>
</html>
