<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.imraniqbal.org/learning-to-boot-from-pxe/">Original</a>
    <h1>Learning to Boot from PXE</h1>
    
    <div id="readability-page-1" class="page"><article>
  

  
    <p>Posted on <time datetime="2025-11-17T00:00:00+00:00">November 17, 2025</time></p>
  

  <p>I bought a new laptop, the GPD Pocket 4.
It came with windows installed by default, and I wanted to install nix on it.</p>
<p>I grabbed a usb, <code>dd</code>&#39;d the nixos iso image on it and tried to boot.
The laptop did not recognize the drive.
Turns out, the drive crapped out, no computer would boot off it.</p>
<p>The normal thing to do would&#39;ve been to just go get a new usb and install off of and go about setting the laptop up.
That meant I would either have to go outside or wait for a new usb to arrive.
I don&#39;t want to outside and I don&#39;t want to wait to setup my laptop. I have free time now and I have no clue when I will have free time next.</p>
<p>The menu had two other boot options. Something about PXE over ipv4 or ipv6.
I only knew that PXE allowed networked boot.
So hey, let&#39;s use this time to learn something new.</p>
<h3 id="dhcp"><a href="#dhcp" aria-label="Anchor link for: dhcp">
    #
</a>
DHCP</h3>
<p>As I&#39;ve learned, the first half of this process is DHCP.
When a device is connected to the network it sends out a &#34;HEY GIVE ME AN IP&#34; message (I don&#39;t actually know how it works and didn&#39;t bother to look it up).
Then your DHCP service see&#39;s this message and responds back with an IP. As part of these requests the client and server can set &#34;options&#34; on these requests which can send additional information.
I don&#39;t know what the client sets first, but I do know the server needs to set a boot file name and location of a TFTP server.
TFTP sort of like FTP.</p>
<p>PXE reads the boot file (usually something.pxe) from the TFTP server and then executes its code.
Other boot files are then retrieved as needed from the TFTP server.</p>
<p>While learning this, folks on the internet dont seem too fond of TFTP, saying it could be slow.
There exists <a href="https://ipxe.org/">iPXE</a> which is supposed to be a better PXE.
PXE (like bioses), tend to be manufacturer specific and are not created equal.
iPXE tries to be better and supports a bunch of other stuff like (like booting from an ISO, and talking in HTTP).
So if this all goes well i get iPXE going, point it to the iso I&#39;ve already downloaded and I&#39;m off to the races!</p>
<p>Spoiler alert, I didn&#39;t get to the races.</p>
<p>To get iPXE running, the iPXE.pxe executable needs to be served by TFTP.
I am running an OPNsense box for my router/firewall and it as enough disk space and ram that I should be able to do this whole process of it.
Setting the DHCP stuff is easy enough via the UI.
the iPXE client sets a client option on its DHCP requests, so you want to create a tag in OPNsense off it&#39;s user-class (iPXE) and respond with a DHCP boot (what the tab in the UI is called) value of the http server.</p>
<p>The flow should be:</p>
<p>PXE -&gt; Gets TFTP Address -&gt; Downloads and run iPXE
iPXE -&gt; Gets HTTP address -&gt; Does iPXE stuff like run our iso</p>
<p>The DHCP stuff can be done through the UI so it was.
The TFTP stuff was not availble the web ui so has to be done through ssh.</p>
<h3 id="tftp"><a href="#tftp" aria-label="Anchor link for: tftp">
    #
</a>
TFTP</h3>
<p>This was my first time shelling into a BSD box.
After this whole process I was left feeling that (Free)BSD is oddly cozy.
I can&#39;t explain how or why, but it just does. The login prompt from opnsense, the simple shell prompt (csh?), the man pages, the disk layout, the programs. Like even if I didn&#39;t have access to all the new version of tools (nvim / rg vs vim / grep) I still got what I wanted done and it just felt cute and cozy.</p>
<p>Anyway, OPNsense ships with dnsmasq and dnsmasq can also act as a TFTP server.
I found this out when trying to search for a TFTP program to install via the UI.
I don&#39;t know how to enable it, nor did I want to look it up (via the internet), so I just read the man page.</p>
<pre><code><span>man dnsmasq
</span></code></pre>
<p>Reading the man page was a pleasant experience (or maybe it was just my first time reading something from section 8).
It told me exactly what the program could do and how to configure it (just searched for tftp).
The conf files were listed in at the bottom, the first being <code>/etc/dnsmasq.conf</code> which did not exist on my system but <code>/usr/local/etc/dnsmasq.conf</code> did.</p>
<p>The first line of that file warns you not to manually edit the file and near the bottom you see the conf-dir option set to <code>/usr/local/etc/dnsmasq.conf.d</code>
I saw a README in that conf dir and, doing a cat resulted in this message:</p>
<pre><code><span>cat /usr/local/etc/dnsmasq.conf.d/README
</span><span># Dnsmasq plugin directory:
</span><span># Add your *.conf files here, read in alphabetical order
</span></code></pre>
<p>Well sure why not lets do that</p>
<pre><code><span>vim /usr/local/etc/dnsmasq.conf.d/10-tftp.conf
</span><span>enable-tftp
</span><span>tftp-root=/srv/tftp
</span><span>:x
</span><span>mkdir -p /srv/tftp
</span><span>fetch -r https://boot.ipxe.org/ipxe.efi -o /srv/tftp/
</span></code></pre>
<p>I used the web ui to restart dnsmasq, but you can also use <code>configctl</code> to do it via shell.
Now when I boot up the laptop I see it load up iPXE but then fail as the http server does not exist. That is progress though, now we just need to serve our iso over http.</p>
<p>One thing to note is that nearly all the instructions online focus on legacy/bios boot. All my devices boot via UEFI (which is why we downloaded the efi above instead of the .kpxe file).
There are ways to setup DHCP to respond with the appropriate files for both uefi or bios boot, but I dont care enough.
There are also other things that try to simplify this whole process like pixieboot and netboot.xyz but I am not interested in them.</p>
<h3 id="http"><a href="#http" aria-label="Anchor link for: http">
    #
</a>
HTTP</h3>
<p>OPNsense runs lighttpd for serving its web ui and I would like to piggy back off it for the iPXE stuff.</p>
<p>The trickest part here was finding out the web ui configuration lives at <code>/usr/local/etc/lighttpd_webgui/</code> via <code>ps</code>.
I had to disable the ssl redirect option from the web ui and instead add it myself to end of my conf file, due how the confs are loaded. I could not think of a different way of getting the 443 port redirect disabled just for the ipxe paths</p>
<pre><code><span>cat /usr/local/etc/lighttpd_webgui/conf.d/00-ipxe.conf
</span><span># Serve /srv/tftp under http://&lt;ip&gt;/ipxe/
</span><span>alias.url += ( &#34;/ipxe/&#34; =&gt; &#34;/srv/tftp/&#34; )
</span><span>url.redirect += ( &#34;^/ipxe$&#34; =&gt; &#34;/ipxe/&#34; )
</span><span>
</span><span>$SERVER[&#34;socket&#34;] == &#34;0.0.0.0:80&#34; {
</span><span>    ssl.engine = &#34;disable&#34;
</span><span>    $HTTP[&#34;url&#34;] !~ &#34;^/ipxe(?:/|$)&#34; {
</span><span>        $HTTP[&#34;host&#34;] =~ &#34;(.*)&#34; {
</span><span>            url.redirect = ( &#34;^/(.*)&#34; =&gt; &#34;https://%1/$1&#34; )
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span>$SERVER[&#34;socket&#34;] == &#34;[::]:80&#34; {
</span><span>    ssl.engine = &#34;disable&#34;
</span><span>    $HTTP[&#34;url&#34;] !~ &#34;^/ipxe(?:/|$)&#34; {
</span><span>        $HTTP[&#34;host&#34;] =~ &#34;(.*)&#34; {
</span><span>            url.redirect = ( &#34;^/(.*)&#34; =&gt; &#34;https://%1/$1&#34; )
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre>
<p>I started off with a basic boot.ixpe file</p>
<pre><code><span>#!ipxe
</span><span>menu Choose an ISO
</span><span>item nix-minmal NixOS 25.04 Minimal
</span><span>item nix-gui   NixOS 25.04 GUI
</span><span>choose target &amp;&amp; goto ${target}
</span><span>
</span><span>:nix-minimal
</span><span>sanboot http://10.0.0.1/ipxe/nixos-minimal-25.05.812242.3de8f8d73e35-x86_64-linux.iso
</span><span>goto menu
</span><span>
</span><span>:nix-gui
</span><span>sanboot http://10.0.0.1/ipxe/nixos-graphical-25.05.812242.3de8f8d73e35-x86_64-linux.iso
</span><span>goto menu
</span></code></pre>
<p>And here is what I spoiled eariler, it didnt work.</p>
<p>I would get a boot but then nixos would complain about <code>/mnt/iso</code> or something being missing and failing to go further.</p>
<p>This discussion has better information on why it doesn&#39;t work: <a href="https://github.com/ipxe/ipxe/discussions/962">https://github.com/ipxe/ipxe/discussions/962</a></p>
<h3 id="proper-netboot-files"><a href="#proper-netboot-files" aria-label="Anchor link for: proper-netboot-files">
    #
</a>
Proper netboot files</h3>
<p>So my dreams of network booting off an iso are crushed, so where do I go from here?</p>
<p>Well it turns out the ISO comes with a bootloader, which contains instructions on how to boot a kernel with an initial ram disk (hint this when I learned what <code>initrd</code> means).
So can&#39;t we do the same?
The answer is yes! (or so I think).
I didnt try to extract the files out the iso, but use nix&#39;s built in <a href="https://nlewo.github.io/nixos-manual-sphinx/installation/installing-pxe.xml.html">netboot image generator</a> which builds the necessary files.</p>
<p>I only had to tweak the generated .ixpe file to include the http urls but everything worked out in the end.</p>
<pre><code><span>cat netboot.ipxe
</span><span>#!ipxe
</span><span># Use the cmdline variable to allow the user to specify custom kernel params
</span><span># when chainloading this script from other iPXE scripts like netboot.xyz
</span><span>kernel http://10.0.0.1/ipxe/bzImage init=/nix/store/hrgkskx4jqdz4nl3p1f4m1dvrr9b3lij-nixos-system-nixos-kexec-25.11pre708350.gfedcba/init initrd=initrd nohibernate loglevel=4 lsm=landlock,yama,bpf ${cmdline}
</span><span>initrd http://10.0.0.1/ipxe/initrd
</span><span>boot
</span></code></pre>
<p>I still wonder if I can extract the files from the graphical installer and boot KDE off the network, but now that the OS is installed my interest has waned.
Maybe one day I will revisit</p>

</article></div>
  </body>
</html>
