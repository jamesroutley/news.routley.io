<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://fzakaria.com/2025/10/29/nix-derivation-madness">Original</a>
    <h1>Nix Derivation Madness</h1>
    
    <div id="readability-page-1" class="page"><article><p>I‚Äôve written <em>a bit</em> about <a href="https://nixos.org">Nix</a> and I still face moments where foundational aspects of the package system confounds and surprises me.</p>

<p>Recently I hit an issue that stumped me as it break some basic comprehension I had on how Nix works. I wanted to produce the build and runtime graph for the Ruby interpreter.</p>

<div><div><pre><code><span>&gt;</span> nix-shell <span>-p</span> ruby

<span>&gt;</span> which ruby
/nix/store/mp4rpz283gw3abvxyb4lbh4vp9pmayp2-ruby-3.3.9/bin/ruby

<span>&gt;</span> nix-store <span>--query</span> <span>--include-outputs</span> <span>--graph</span> <span>\</span>
  <span>$(</span>nix-store <span>--query</span> <span>--deriver</span> <span>$(</span>which ruby<span>))</span>
error: path <span>&#39;/nix/store/24v9wpp393ib1gllip7ic13aycbi704g-ruby-3.3.9.drv&#39;</span> is not valid

<span>&gt;</span> <span>ls</span> /nix/store/24v9wpp393ib1gllip7ic13aycbi704g-ruby-3.3.9.drv
<span>ls</span>: cannot access <span>&#39;/nix/store/24v9wpp393ib1gllip7ic13aycbi704g-ruby-3.3.9.drv&#39;</span>:
No such file or directory
</code></pre></div></div>

<p>Huh. ü§î</p>

<p>I have Ruby but I don‚Äôt seem to have the derivation, <code>24v9wpp393ib1gllip7ic13aycbi704g</code>, file present on my machine.</p>

<p>No worries, I think I can <code>--realize</code> it and download it from the NixOS cache.</p>

<div><div><pre><code><span>&gt;</span> nix-store <span>--realize</span> /nix/store/24v9wpp393ib1gllip7ic13aycbi704g-ruby-3.3.9.drv
don<span>&#39;t know how to build these paths:
  /nix/store/24v9wpp393ib1gllip7ic13aycbi704g-ruby-3.3.9.drv
error: cannot build missing derivation &#39;</span>/nix/store/24v9wpp393ib1gllip7ic13aycbi704g-ruby-3.3.9.drv<span>&#39;
</span></code></pre></div></div>

<p>I guess the NixOS cache doesn‚Äôt seem to have it. ü§∑</p>

<blockquote>
  <p>This was actually perplexing me at this moment. In fact there are <a href="https://discourse.nixos.org/t/how-to-get-a-missing-drv-file-for-a-derivation-from-nixpkgs/2300/1">multiple</a> <a href="https://discourse.nixos.org/t/why-isnt-deriver-and-realize-identity-functions-see-example/47490/1">discourse</a> posts about it.</p>
</blockquote>

<p>My mental model however of Nix though is that I must have first evaluated the derivation (drv) in order to determine the output path to even substitute. How could the NixOS cache not have it present?</p>

<p>Is this derivation wrong somehow? Nope. This is the derivation Nix believes that produced this Ruby binary from the <code>sqlite</code> database. ü§®</p>

<div><div><pre><code><span>&gt;</span> sqlite3 <span>&#34;/nix/var/nix/db/db.sqlite&#34;</span> 
    <span>&#34;select deriver from ValidPaths where path = 
    &#39;/nix/store/mp4rpz283gw3abvxyb4lbh4vp9pmayp2-ruby-3.3.9&#39;&#34;</span>
/nix/store/24v9wpp393ib1gllip7ic13aycbi704g-ruby-3.3.9.drv
</code></pre></div></div>

<p>What does the binary cache itself say? Even the cache itself thinks this particular derivation, <code>24v9wpp393ib1gllip7ic13aycbi704g</code>, produced this particular Ruby output.</p>

<div><div><pre><code><span>&gt;</span> curl <span>-s</span> https://cache.nixos.org/mp4rpz283gw3abvxyb4lbh4vp9pmayp2.narinfo |<span>\</span>
  <span>grep </span>Deriver
Deriver: 24v9wpp393ib1gllip7ic13aycbi704g-ruby-3.3.9.drv
</code></pre></div></div>

<p>What if I try a different command?</p>

<div><div><pre><code><span>&gt;</span> nix derivation show <span>$(</span>which ruby<span>)</span> | jq <span>-r</span> <span>&#34;keys[0]&#34;</span>
/nix/store/kmx8kkggm5i2r17s6l67v022jz9gc4c5-ruby-3.3.9.drv

<span>&gt;</span> <span>ls</span> /nix/store/kmx8kkggm5i2r17s6l67v022jz9gc4c5-ruby-3.3.9.drv
/nix/store/kmx8kkggm5i2r17s6l67v022jz9gc4c5-ruby-3.3.9.drv
</code></pre></div></div>

<p>So I seem to have a completely different derivation, <code>kmx8kkggm5i2r17s6l67v022jz9gc4c5</code>, that resulted in the same output which <em>is not</em> what the binary cache announces. WTF? ü´†</p>

<p>Thinking back to a previous post, I remember touching on <a href="https://fzakaria.com/2025/03/28/what-s-in-a-nix-store-path">modulo fixed-output derivations</a>. Is that what‚Äôs going on? Let‚Äôs investigate from first principles. ü§ì</p>

<p>Let‚Äôs first create <code>fod.nix</code> which is our <em>fixed-output derivation</em>.</p>

<div><div><pre><code><span>let</span>
  <span>system</span> <span>=</span> <span>builtins</span><span>.</span><span>currentSystem</span><span>;</span>
<span>in</span> <span>derivation</span> <span>{</span>
  <span>name</span> <span>=</span> <span>&#34;hello-world-fixed&#34;</span><span>;</span>
  <span>builder</span> <span>=</span> <span>&#34;/bin/sh&#34;</span><span>;</span>
  <span>system</span> <span>=</span> <span>system</span><span>;</span>
  <span>args</span> <span>=</span> <span>[</span> <span>&#34;-c&#34;</span> <span>&#39;&#39;</span><span>
</span><span>    echo -n &#34;hello world&#34; &gt; &#34;$out&#34;</span><span>
</span><span>  &#39;&#39;</span> <span>];</span>
  <span>outputHashMode</span> <span>=</span> <span>&#34;flat&#34;</span><span>;</span>
  <span>outputHashAlgo</span> <span>=</span> <span>&#34;sha256&#34;</span><span>;</span>
  <span>outputHash</span> <span>=</span> <span>&#34;b94d27b9934d3e08a52e52d7da7dabfac484efe37a5380ee9088f7ace2efcde9&#34;</span><span>;</span>
<span>}</span>
</code></pre></div></div>

<p>‚òùÔ∏è Since this is a <em>fixed-output derivation</em> (FOD) the produced <code>/nix/store</code> path will not be affected to changes to the derivation beyond the contents of <code>$out</code>.</p>

<div><div><pre><code><span>&gt;</span> nix-instantiate fod.nix
/nix/store/k2wjpwq43685j6vlvaarrfml4gl4196n-hello-world-fixed.drv

<span>&gt;</span> nix-build fod.nix
/nix/store/ajk19jb8h5h3lmz20yz6wj9vif18lhp1-hello-world-fixed
</code></pre></div></div>

<p>Now we will create a derivation that uses this FOD.</p>

<div><div><pre><code><span>{</span> <span>fodDrv</span> <span>?</span> <span>import</span> <span>./fod.nix</span> <span>}:</span>

<span>let</span>
  <span>system</span> <span>=</span> <span>builtins</span><span>.</span><span>currentSystem</span><span>;</span>
<span>in</span>
<span>builtins</span><span>.</span><span>derivation</span> <span>{</span>
  <span>name</span> <span>=</span> <span>&#34;uses-fod&#34;</span><span>;</span>
  <span>inherit</span> <span>system</span><span>;</span>
  <span>builder</span> <span>=</span> <span>&#34;/bin/sh&#34;</span><span>;</span>
  <span>args</span> <span>=</span> <span>[</span> <span>&#34;-c&#34;</span> <span>&#39;&#39;</span><span>
</span><span>    echo </span><span>${</span><span>fodDrv</span><span>}</span><span> &gt; $out</span><span>
</span><span>    echo &#34;Good bye world&#34; &gt;&gt; $out</span><span>
</span><span>  &#39;&#39;</span> <span>];</span>
<span>}</span>
</code></pre></div></div>

<p>The <code>/nix/store</code> for the output for this derivation <em>will change</em> on changes to the derivation <strong>except</strong> if the derivation path for the FOD changes. This is in fact what makes it ‚Äúmodulo‚Äù the fixed-output derivations.</p>

<div><div><pre><code><span>&gt;</span> nix-instantiate uses-fod.nix
/nix/store/85d15y7irq7x4fxv4nc7k1cw2rlfp3ag-uses-fod.drv

<span>&gt;</span> nix-build uses-fod.nix
/nix/store/sd12qjak7rlxhdprj10187f9an787lk3-uses-fod
</code></pre></div></div>

<p>Let‚Äôs test this all out by changing our <code>fod.nix</code> derivation.
Let‚Äôs do this by just adding some <em>garbage</em> attribute to the derivation.</p>

<div><div><pre><code><span>@@ -4,6 +4,7 @@</span>
   name = &#34;hello-world-fixed&#34;;
   builder = &#34;/bin/sh&#34;;
   system = system;
<span>+  garbage = 123;
</span>   args = [ &#34;-c&#34; &#39;&#39;
     echo -n &#34;hello world&#34; &gt; &#34;$out&#34;
   &#39;&#39; ];
</code></pre></div></div>

<p>What happens now?</p>

<div><div><pre><code><span>&gt;</span> nix-instantiate fod.nix
/nix/store/yimff0d4zr4krwx6cvdiqlin0y6vkis0-hello-world-fixed.drv

<span>&gt;</span> nix-build fod.nix
/nix/store/ajk19jb8h5h3lmz20yz6wj9vif18lhp1-hello-world-fixed
</code></pre></div></div>

<p>The path of the derivation itself, <code>.drv</code>, has changed but the output path <code>ajk19jb8h5h3lmz20yz6wj9vif18lhp1</code> remains consistent.</p>

<p>What about the derivation that leverages it?</p>

<div><div><pre><code><span>&gt;</span> nix-instantiate uses-fod.nix
/nix/store/85wkdaaq6q08f71xn420v4irll4a8g8v-uses-fod.drv

<span>&gt;</span> nix-build uses-fod.nix
/nix/store/sd12qjak7rlxhdprj10187f9an787lk3-uses-fod
</code></pre></div></div>

<p>It also got a new derivation path but the output path remained unchanged. üòÆ</p>

<p>That means changes to <em>fixed-output-derivations</em> didn‚Äôt cause new outputs in either derivation <em>but</em> it did create a complete new tree of <code>.drv</code> files. ü§Ø</p>

<p>That means in <a href="https://github.com/NixOS/nixpkgs">nixpkgs</a> changes to <em>fixed-output</em> derivations can cause them to have new store paths for their <code>.drv</code> but result in dependent derivations to have the same output path. If the output path had already been stored in the NixOS cache, then we lose the link between the new <code>.drv</code> and this output path. üí•</p>

<!--

digraph NixDerivationMadness {

    // Global Styling for consistency
    node [shape=box, style="filled"];

    // Subgraph for the original, cached state (V1)
    subgraph cluster_v1 {
        label = "1: Initial Build & Cache Upload";
        bgcolor = "#E6F4EA"; // Light Green Background

        // V1 Nodes
        FOD_V1 [label="FOD drv V1\n(k2wjpwq43685j6vlvaarrfml4gl4196n-hello-world-fixed.drv)", fillcolor="#B3E0C9"];
        USES_FOD_V1 [label="Uses-FOD Drv V1\n(85d15y7irq7x4fxv4nc7k1cw2rlfp3ag-uses-fod.drv)", fillcolor="#80CBC4"];
        OUTPUT [label="Uses-FOD Output\n(sd12qjak7rlxhdprj10187f9an787lk3-uses-fod)", fillcolor="#FFD54F", color=black];
        CACHE [label="Nix Cache", shape=cylinder, fillcolor="#90CAF9"];

        // V1 Edges
        FOD_V1 -> USES_FOD_V1 [label="Input"];
        USES_FOD_V1 -> OUTPUT [label="Produces output path"];
        OUTPUT -> CACHE [label="Output cached", penwidth=1];
    }

    // Subgraph for the changed state (V2)
    subgraph cluster_v2 {
        label = "2: FOD Changed (i.e. garbage added)";
        bgcolor = "#FCE4EC"; // Light Pink/Red Background

        // V2 Nodes
        FOD_V2 [label="FOD drv V2\n(yimff0d4zr4krwx6cvdiqlin0y6vkis0-hello-world-fixed.drv)", fillcolor="#F48FB1"];
        USES_FOD_V2 [label="Uses-FOD Drv V2\n(85wkdaaq6q08f71xn420v4irll4a8g8v-uses-fod.drv)", fillcolor="#E57373"];

        // V2 Edges
        FOD_V2 -> USES_FOD_V2 [label="Input"];
        USES_FOD_V2 -> OUTPUT [label="Produces SAME Output Hash", style=bold, color=darkgreen];
    }
    
    // Connection between subgraphs
    // The link from the new derivation (V2) to the existing cache entry is MISSING.
    USES_FOD_V2 -> CACHE [label="Missing Cache Mapping for V2", color=red, style=dashed, penwidth=2, arrowhead=cross];
}

 -->
<p><img src="https://fzakaria.com/assets/images/derivation_madness.svg" alt="Derivation graphic"/></p>

<p>The amount of churn that we are creating in derivations was unbeknownst to me.</p>

<p>It can get even weirder! This example came from <a href="https://github.com/ericson2314">@ericson2314</a>.</p>

<p>We will duplicate the <code>fod.nix</code> to another file <code>fod2.nix</code> whose only difference is the value of the garbage.</p>

<div><div><pre><code><span>@@ -4,7 +4,7 @@</span>
   name = &#34;hello-world-fixed&#34;;
   builder = &#34;/bin/sh&#34;;
   system = system;
<span>-  garbage = 123;
</span><span>+  garbage = 124;
</span>   args = [ &#34;-c&#34; &#39;&#39;
     echo -n &#34;hello world&#34; &gt; &#34;$out&#34;
   &#39;&#39; ];
</code></pre></div></div>

<p>Let‚Äôs now use both of these in our derivation.</p>

<div><div><pre><code><span>{</span> <span>fodDrv</span> <span>?</span> <span>import</span> <span>./fod.nix</span><span>,</span>
  <span>fod2Drv</span> <span>?</span> <span>import</span> <span>./fod2.nix</span>
<span>}:</span>
<span>let</span>
  <span>system</span> <span>=</span> <span>builtins</span><span>.</span><span>currentSystem</span><span>;</span>
<span>in</span>
<span>builtins</span><span>.</span><span>derivation</span> <span>{</span>
  <span>name</span> <span>=</span> <span>&#34;uses-fod&#34;</span><span>;</span>
  <span>inherit</span> <span>system</span><span>;</span>
  <span>builder</span> <span>=</span> <span>&#34;/bin/sh&#34;</span><span>;</span>
  <span>args</span> <span>=</span> <span>[</span> <span>&#34;-c&#34;</span> <span>&#39;&#39;</span><span>
</span><span>    echo </span><span>${</span><span>fodDrv</span><span>}</span><span> &gt; $out</span><span>
</span><span>    echo </span><span>${</span><span>fod2Drv</span><span>}</span><span> &gt;&gt; $out</span><span>
</span><span>    echo &#34;Good bye world&#34; &gt;&gt; $out</span><span>
</span><span>  &#39;&#39;</span> <span>];</span>
<span>}</span>
</code></pre></div></div>

<p>We can now instantiate and build this as normal.</p>

<div><div><pre><code><span>&gt;</span> nix-instantiate uses-fod.nix
/nix/store/z6nr2k2hy982fiynyjkvq8dliwbxklwf-uses-fod.drv

<span>&gt;</span> nix-build uses-fod.nix
/nix/store/211nlyx2ga7mh5fdk76aggb04y1wsgkj-uses-fod
</code></pre></div></div>

<p>What is weird about that?</p>

<p>Well, let‚Äôs take the JSON representation of the derivation and remove one of the inputs.</p>

<div><div><pre><code><span>&gt;</span> nix derivation show <span>\</span>
    /nix/store/z6nr2k2hy982fiynyjkvq8dliwbxklwf-uses-fod.drv <span>\</span>
    jq <span>&#39;values[].inputDrvs | keys[]&#39;</span>
<span>&#34;/nix/store/6p93r6x0bwyd8gngf5n4r432n6l380ry-hello-world-fixed.drv&#34;</span>
<span>&#34;/nix/store/yimff0d4zr4krwx6cvdiqlin0y6vkis0-hello-world-fixed.drv&#34;</span>
</code></pre></div></div>

<p>We can do this because although there are two input derivations, we know they both produce the same output!</p>

<div><div><pre><code><span>@@ -12,12 +12,6 @@</span>
       &#34;system&#34;: &#34;x86_64-linux&#34;
     },
     &#34;inputDrvs&#34;: {
<span>-      &#34;/nix/store/6p93r6x0bwyd8gngf5n4r432n6l380ry-hello-world-fixed.drv&#34;: {
-        &#34;dynamicOutputs&#34;: {},
-        &#34;outputs&#34;: [
-          &#34;out&#34;
-        ]
-      },
</span>       &#34;/nix/store/yimff0d4zr4krwx6cvdiqlin0y6vkis0-hello-world-fixed.drv&#34;: {
         &#34;dynamicOutputs&#34;: {},
         &#34;outputs&#34;: [
</code></pre></div></div>

<p>Let‚Äôs load this modified derivation back into our <code>/nix/store</code> and build it again!</p>

<div><div><pre><code><span>&gt;</span> nix derivation add &lt; derivation.json
/nix/store/s4qrdkq3a85gxmlpiay334vd1ndg8hm1-uses-fod.drv

<span>&gt;</span> nix-build /nix/store/s4qrdkq3a85gxmlpiay334vd1ndg8hm1-uses-fod.drv
/nix/store/211nlyx2ga7mh5fdk76aggb04y1wsgkj-uses-fod
</code></pre></div></div>

<p>We got the same output <code>211nlyx2ga7mh5fdk76aggb04y1wsgkj</code>. Not only do we have a <code>1:N</code> trait for our output paths to derivations but we can also take certain derivations and completely change them by removing inputs and still get the same output! üòπ</p>

<p>The road to Nix enlightenment is no joke and full of dragons.</p>

</article></div>
  </body>
</html>
