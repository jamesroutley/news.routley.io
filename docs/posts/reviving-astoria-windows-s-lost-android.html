<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://trungnt2910.com/astoria-windows-android/">Original</a>
    <h1>Reviving Astoria â€“ Windows&#39;s Lost Android</h1>
    
    <div id="readability-page-1" class="page"><div id="__blog-post-container">
<p>Are you a die-hard fan of <em>Project Astoria</em>, Microsoft&#39;s former solution to bridging the app gap on
Windows 10 Mobile? Or are you just tired of your average sluggish, resource-hogging Android
emulator?</p>
<p>This post, exploring the method to bring Astoria to various unsupported Windows versions, from
different platforms like Desktop to higher builds like the Anniversary Update (RS1) and beyond, is
just for <em>you</em>.</p>
<figure><img src="https://trungnt2910.com/assets/images/lost_android-f3ba3235afc8b3bbef8548330bdf443b.png" alt="Android from a lost window"/><figcaption><p>Generated by Microsoft Copilot.</p></figcaption></figure>
<h2 id="introduction">Introduction<a href="#introduction" aria-label="Direct link to Introduction" title="Direct link to Introduction">â€‹</a></h2>
<p><em>Project Astoria</em>, (a.k.a <em>Windows Bridge for Android</em>), was an attempt to allow Android apps to
run on early prerelease builds of Windows 10 Mobile. It was available exclusively to Mobile builds
and canceled before the public release of Windows version 1511 (&#34;Thresold 2&#34;).</p>
<p>The solution features an Android 4.4 environment running on a compatibility layer (<code>lxcore.sys</code>)
that translates Linux syscalls issued by the Android runtime to equivalent Windows NT calls. With
the help of more glue services, Astoria allowed many Android applications to run alongside with
native Windows apps and seamlessly integrate into the environment with little performance penalty,
unlike existing solutions which spawns a full virtual machine.</p>
<p>While only released for mobile, the design of Astoria theoretically also supports other variants of
Windows 10. After its demise, the project had a second life as the <em>Windows Subsystem for Linux</em>,
created to run console Linux applications, before being abandoned in favor of a brute-force Hyper-V
solution in 2020.</p>
<h2 id="prerequisites">Prerequisites<a href="#prerequisites" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">â€‹</a></h2>
<ul>
<li>General Windows power user techniques (e.g. modifying the registry and system files).</li>
<li>Using Project Astoria to install APKs on supported Windows 10 Mobile versions. A general guide
can be found
<a href="https://www.wpxbox.com/this-tool-lets-you-run-android-apks-on-windows-10-mobile" target="_blank" rel="noopener noreferrer">here</a>.</li>
</ul>
<h2 id="preparing">Preparing<a href="#preparing" aria-label="Direct link to Preparing" title="Direct link to Preparing">â€‹</a></h2>
<p>Being a complex component, Astoria involves multiple files and expects the system to have certain
features and configurations available.</p>
<figure><p><img decoding="async" loading="lazy" alt="Overview of Components of Project Astoria." src="https://trungnt2910.com/assets/images/aow_components-37866373cd52f924e7b055b80fa62b6a.svg" width="890" height="650"/></p><figcaption><p>Overview of Components of Project Astoria.</p></figcaption></figure>
<h3 id="windows-10-version">Windows 10 Version<a href="#windows-10-version" aria-label="Direct link to Windows 10 Version" title="Direct link to Windows 10 Version">â€‹</a></h3>
<p>This guide is tested on Windows 10 x86 build 10563.</p>
<p><strong>32-bit</strong> Windows 10 variants up to build 10572 should work.</p>
<p>Some features may work on early Redstone 1 preview <strong>32-bit</strong> builds (builds 14251 - 14346).</p>
<p>Full access to the filesystem and registry is expected. This is generally true for <code>Administrators</code>
on normal Windows, but may require additional setup on Windows 10 Mobile.</p>
<details data-collapsed="true"><summary>Why?</summary><div><div><p>As shown on the diagram above, the core driver of Astoria requires a specific kernel function,
<code>PsRegisterPicoProvider</code>.</p><p>Windows TH2 builds starting from 10575 are known to block this function entirely, returning an
error code in all cases. This function got unblocked in the RS1 branch to pave the way for WSL,
but experienced an ABI break starting from build 14347, preventing Astoria drivers to load on
newer versions of Windows.</p><p>Since Windows 10 Mobile is 32-bit only (<code>arm32</code> for native devices and <code>x86</code> for emulators),
and Astoria is only published for Windows 10 Mobile, the component is exclusive to 32-bit
Windows editions.</p><p>While early RS1 builds possess the necessary kernel facilities, breaking changes have been made
to userland services handling AppX packages and UWP apps, preventing the deployment of Astoria-
based AppX files. For Mobile variants, the latest known fully functional build is
<a href="https://empyreal96.github.io/ProjectAstoria/installation.html" target="_blank" rel="noopener noreferrer">14320</a>, while on Desktop, none
of the RS1 builds can deploy Astoria packages correctly, despite having correctly launched the
Android container.</p></div></div></details>
<details data-collapsed="true"><summary>Overcoming the Time Bomb</summary><div><div><p>All of the listed supported builds are Windows Insider Preview builds with a fixed expiration
date long long ago.</p><p>Before installing or booting, make sure your hardware clock is set to some time in 2015 and any
time synchronization mechanism is disabled. Otherwise, installation will fail and/or Windows
will refuse to boot (hence, the &#34;Time Bomb&#34;).</p><p>If you are using VMWare, adding these lines to your <code>.vmx</code> configuration might help:</p><div><div><pre tabindex="0"><code><span><span>rtc.startTime = &#34;1450962000&#34;</span><br/></span><span><span>tools.syncTime = &#34;FALSE&#34;</span><br/></span><span><span>time.synchronize.continue = &#34;FALSE&#34;</span><br/></span><span><span>time.synchronize.restore = &#34;FALSE&#34;</span><br/></span><span><span>time.synchronize.resume.disk = &#34;FALSE&#34;</span><br/></span><span><span>time.synchronize.shrink = &#34;FALSE&#34;</span><br/></span><span><span>time.synchronize.tools.startup = &#34;FALSE&#34;</span><br/></span><span><span>time.synchronize.tools.enable = &#34;FALSE&#34;</span><br/></span><span><span>time.synchronize.resume.host = &#34;FALSE&#34;</span><br/></span></code></pre></div></div></div></div></details>
<h3 id="files">Files<a href="#files" aria-label="Direct link to Files" title="Direct link to Files">â€‹</a></h3>
<p>The following files should be extracted from a Windows 10 Mobile image with a close build number.
Files for late TH2 builds (builds 105xx) should work for supported RS1 installations (builds 14xxx).</p>
<p>The guide includes files and registry values extracted from Windows 10 Mobile Emulator Build 10563.
Registry keys and deployment tools can be shared across architectures, but drivers, core AoW files,
and security catalogs must match the architecture of your target system.</p>
<p>You can download all the files used in this guide in this
<a href="https://github.com/trungnt2910/trungnt2910.github.io/releases/download/v0.0.0/Astoria.zip" target="_blank" rel="noopener noreferrer">big zip file</a>.</p>
<h4 id="core-drivers-cwindowssystem32drivers">Core Drivers (<code>C:\Windows\System32\drivers</code>)<a href="#core-drivers-cwindowssystem32drivers" aria-label="Direct link to core-drivers-cwindowssystem32drivers" title="Direct link to core-drivers-cwindowssystem32drivers">â€‹</a></h4>
<p>Two files are required: <a href="https://trungnt2910.com/assets/files/adss-c21df058381de9aa5a4001f5faa68e9f.sys" target="_blank"><code>adss.sys</code></a> and <a href="https://trungnt2910.com/assets/files/lxcore-c34a6c292d16ca1932ad236449570739.sys" target="_blank"><code>lxcore.sys</code></a>.</p>
<details data-collapsed="true"><summary>What are they?</summary><div><p>These are the core drivers responsible for translating Linux system calls to Windows NT
equivalents. They are the lowest level components of Astoria.</p></div></details>
<h4 id="aow-files-cwindowssystem32aow">AoW Files (<code>C:\Windows\System32\aow</code>)<a href="#aow-files-cwindowssystem32aow" aria-label="Direct link to aow-files-cwindowssystem32aow" title="Direct link to aow-files-cwindowssystem32aow">â€‹</a></h4>
<p>The whole
<a href="https://github.com/trungnt2910/trungnt2910.github.io/releases/download/v0.0.0/aow.zip" target="_blank" rel="noopener noreferrer"><code>aow</code></a>
directory is required.</p>
<details data-collapsed="true"><summary>What are they?</summary><div><div><p>The folder name, <code>aow</code> - Android on Windows - should be self-explanatory.</p><p>It contains a full Android image (<code>aow.wim</code>), Windows services used to start and communicate
with the Android container, and some other libraries used by Astoria components.</p></div></div></details>
<h4 id="registry-keys">Registry Keys<a href="#registry-keys" aria-label="Direct link to Registry Keys" title="Direct link to Registry Keys">â€‹</a></h4>
<p>Several registry keys need to be imported.</p>
<p>Registry entries should be the same for both ARM32 and x86 versions of Windows.</p>
<h5 id="drivers">Drivers<a href="#drivers" aria-label="Direct link to Drivers" title="Direct link to Drivers">â€‹</a></h5>
<p>Apply <a href="https://trungnt2910.com/assets/files/adss-84a512c36bb93fc3aa305571dfb76e55.reg" target="_blank"><code>adss.reg</code></a> to register the core Astoria drivers.</p>
<details data-collapsed="true"><summary>Keys involved</summary><div><div><div><div><pre tabindex="0"><code><span><span>[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\adss]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\ManufacturingMode\Default\Services\adss]</span><br/></span></code></pre></div></div><p>The first key is essential for all Windows driver registrations.</p></div></div></details>
<h5 id="services">Services<a href="#services" aria-label="Direct link to Services" title="Direct link to Services">â€‹</a></h5>
<p>Apply <a href="https://trungnt2910.com/assets/files/AoWSM-cce4cbaf072b9cf22ca712ed7d3fc283.reg" target="_blank"><code>AoWSM.reg</code></a> to register the AoW Session Manager service. This is the main
userland component of Astoria.</p>
<details data-collapsed="true"><summary>Keys involved</summary><div><div><div><div><pre tabindex="0"><code><span><span>[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\AoWSM]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\AoWSM\parameters]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\AoWSM\Security]</span><br/></span></code></pre></div></div></div></div></details>
<p>Also, run <a href="https://trungnt2910.com/assets/files/AoWSM-a76c3a00268d1a6c9f5125c6fbc40b32.cmd" target="_blank"><code>AoWSM.cmd</code></a> as Administrator to add the service to the correct service
user.</p>
<details data-collapsed="true"><summary>Keys involved</summary><div><div><div><div><pre tabindex="0"><code><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost]</span><br/></span></code></pre></div></div></div></div></details>
<details data-collapsed="true"><summary>Why a script?</summary><div><div><p>The installation process involves updating a <code>REG_MULTI_SZ</code> value by appending the service name
(<code>AoWSM</code>) to an existing list. The list of services may be different in each build and each
Windows installation.</p><p>Windows <code>.reg</code> files only support replacing whole values, not appending a new entry to a
<code>REG_MULTI_SZ</code>. Therefore, commands are used to read the whole list, add the required value,
and write the list back again.</p><div><div><pre tabindex="0"><code><span><span>SET ContentsToBeAppended=\0AoWSM</span><br/></span><span><span>FOR /F &#34;tokens=2,3*&#34; %%G IN (&#39;REG QUERY &#34;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost&#34; /v netsvcs&#39;) DO SET EntryContents=%%H</span><br/></span><span><span>SET NewEntryContents=%EntryContents%%ContentsToBeAppended%</span><br/></span><span><span></span><br/></span><span><span>REG ADD &#34;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost&#34; /v netsvcs /t REG_MULTI_SZ /d &#34;%NewEntryContents%&#34; /f</span><br/></span></code></pre></div></div></div></div></details>
<h5 id="certificates">Certificates<a href="#certificates" aria-label="Direct link to Certificates" title="Direct link to Certificates">â€‹</a></h5>
<p>Apply <a href="https://trungnt2910.com/assets/files/MicrosoftTestRootAuthority-01f703151668c788e4914c4c4993dd97.reg" target="_blank"><code>MicrosoftTestRootAuthority.reg</code></a> to register the
<code>Microsoft Test Root Authority</code>. This is the authority for certificates found in Astoria and other
test components in Win10M preview builds.</p>
<details data-collapsed="true"><summary>Keys involved</summary><div><div><div><div><pre tabindex="0"><code><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\SystemCertificates\ROOT\Certificates\2BD63D28D7BCD0E251195AEB519243C13142EBC3]</span><br/></span></code></pre></div></div></div></div></details>
<h5 id="policies">Policies<a href="#policies" aria-label="Direct link to Policies" title="Direct link to Policies">â€‹</a></h5>
<p>Apply
<a href="https://trungnt2910.com/assets/files/AllowWindowsBridgeForAndroidAppExecution-286da6260cfed1bd51dc8d89f0f48b7f.reg" target="_blank"><code>AllowWindowsBridgeForAndroidAppExecution.reg</code></a>
to enable a hidden policy allowing AoW apps to run. Without this policy set to enabled, Astoria
services simply refuse to start.</p>
<details data-collapsed="true"><summary>Keys involved</summary><div><div><div><div><pre tabindex="0"><code><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\PolicyManager\default\ApplicationManagement\AllowWindowsBridgeForAndroidAppExecution]</span><br/></span></code></pre></div></div></div></div></details>
<h5 id="aow-configuration">AoW Configuration<a href="#aow-configuration" aria-label="Direct link to AoW Configuration" title="Direct link to AoW Configuration">â€‹</a></h5>
<p>Apply <a href="https://trungnt2910.com/assets/files/AoWCOM-8c08d56d80702c9d242a7ba2ebc43f09.reg" target="_blank"><code>AoWCOM.reg</code></a> to register necessary COM interfaces used by Astoria.</p>
<details data-collapsed="true"><summary>Keys involved</summary><div><div><div><div><pre tabindex="0"><code><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\AppId\{86a8127c-3121-4879-bef7-08df0ed05a76}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\AppId\{a4557610-bef7-40d6-844d-83dc4e1ea6f2}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\{4abf46cc-e506-434c-afa4-9927f3668e60}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\{4abf46cc-e506-434c-afa4-9927f3668e60}\InProcServer32]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\{7930ac88-f36c-44fd-8202-8b95b5b06acb}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\{7930ac88-f36c-44fd-8202-8b95b5b06acb}\InProcServer32]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\{86a8127c-3121-4879-bef7-08df0ed05a76}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\{86a8127c-3121-4879-bef7-08df0ed05a76}\LocalServer32]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\{910065f3-db2c-41c8-a50a-aa258afac2e8}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\{da3739a3-46a5-4e9b-b2b5-9545eeea93e6}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\{da3739a3-46a5-4e9b-b2b5-9545eeea93e6}\InProcServer32]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\{e213b5d9-4ee5-4e2d-945e-6508c1d050fb}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\{e213b5d9-4ee5-4e2d-945e-6508c1d050fb}\InProcServer32]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{292997c8-fa0d-4fb6-8bc5-366f9382cc81}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{292997c8-fa0d-4fb6-8bc5-366f9382cc81}\ProxyStubClsid32]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{355C3D14-8434-4F35-8377-FDD880F5758A}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{355C3D14-8434-4F35-8377-FDD880F5758A}\ProxyStubClsid32]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{38530252-eb81-4164-8854-89e763e44514}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{38530252-eb81-4164-8854-89e763e44514}\ProxyStubClsid32]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{623bbb59-1aa9-46b2-a2e6-e4a749305fcd}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{623bbb59-1aa9-46b2-a2e6-e4a749305fcd}\ProxyStubClsid32]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{75888062-7a77-46c0-9494-e59f2dd4df0f}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{75888062-7a77-46c0-9494-e59f2dd4df0f}\ProxyStubClsid32]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{782b2d14-179c-4540-bfc8-3599213f764e}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{782b2d14-179c-4540-bfc8-3599213f764e}\ProxyStubClsid32]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{8ab860cb-32ff-4903-8f2a-5ca76ed80301}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{8ab860cb-32ff-4903-8f2a-5ca76ed80301}\ProxyStubClsid32]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{a0c5d6c2-48ce-4429-a73c-5c4df8cc2a54}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{a0c5d6c2-48ce-4429-a73c-5c4df8cc2a54}\ProxyStubClsid32]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{a1411706-05ec-4f1a-914a-31f7e8b12a9e}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{a1411706-05ec-4f1a-914a-31f7e8b12a9e}\ProxyStubClsid32]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{b65c0692-57f8-472d-b3e4-cd754ccdcc6a}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{b65c0692-57f8-472d-b3e4-cd754ccdcc6a}\ProxyStubClsid32]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{c60b7e58-8fe7-4a9c-a86e-42ca6926cc40}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{c60b7e58-8fe7-4a9c-a86e-42ca6926cc40}\ProxyStubClsid32]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{e6521960-71d3-4e9f-8ecd-bb87a99313f9}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{e6521960-71d3-4e9f-8ecd-bb87a99313f9}\ProxyStubClsid32]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\SecurityManager\FullTrust]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\SecurityManager\FullTrust\AowHost]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AOW]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AOW\Instance]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\WindowsRuntime\AllowedCOMCLSIDs\{da3739a3-46a5-4e9b-b2b5-9545eeea93e6}]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\WindowsRuntime\AllowedCOMCLSIDs\{e213b5d9-4ee5-4e2d-945e-6508c1d050fb}]</span><br/></span></code></pre></div></div></div></div></details>
<h5 id="host-configuration">Host Configuration<a href="#host-configuration" aria-label="Direct link to Host Configuration" title="Direct link to Host Configuration">â€‹</a></h5>
<p>Apply <a href="https://trungnt2910.com/assets/files/ArcadiaEvents-ab4e3145b96e2bed182c1727c1a52de4.reg" target="_blank">ArcadiaEvents.reg</a> to allow certain features of Arcadia, the UWP
application host component of Astoria, to run correctly.</p>
<details data-collapsed="true"><summary>Keys involved</summary><div><div><div><div><pre tabindex="0"><code><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\BackgroundModel\EventSettings\719]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\BackgroundModel\EventSettings\720]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\BackgroundModel\EventSettings\721]</span><br/></span><span><span>[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\BackgroundModel\EventSettings\722]</span><br/></span></code></pre></div></div></div></div></details>
<h4 id="certificates-1">Certificates<a href="#certificates-1" aria-label="Direct link to Certificates" title="Direct link to Certificates">â€‹</a></h4>
<p>Two catalog files should be copied to
<code>C:\Windows\System32\CatRoot\{F750E6C3-38EE-11D1-85E5-00C04FC295EE}</code>, the system security catalog
store:</p>
<p><a href="https://trungnt2910.com/assets/files/Microsoft.MS_PROJECTA.MainOS~628844477771337a~x86~~8.15.13030.68-b5f642b8620dd7134d80a6d65b45da1d.cat" target="_blank"><code>Microsoft.MS_PROJECTA.MainOS</code></a></p>
<p><a href="https://trungnt2910.com/assets/files/Microsoft.MobileCore.Prod.MainOS~628844477771337a~x86~~8.20.10563.11786-8899bd3c7b03829965f0121901a8701e.cat" target="_blank"><code>Microsoft.MobileCore.Prod.MainOS</code></a></p>
<details data-collapsed="true"><summary>What are they?</summary><div><div><p>On Windows, security catalogs (files with <code>.cat</code> extension) provide signatures to files that are
otherwise not signed.</p><p><code>Microsoft.MS_PROJECTA.MainOS</code> covers items deployed with Project Astoria (most, but not all, of
the <code>aow</code> folder), and <code>Microsoft.MobileCore.Prod.MainOS</code> covers the rest.</p><p>Missing these catalogs prevents Windows from verifying the signature of some service binaries,
resulting in a <code>0x80070241</code> - <code>Windows cannot verify the digital signature...</code> error.</p><p>For more information on Windows security catalogs, check out this
<a href="https://www.youtube.com/watch?v=eo1b33NrGts" target="_blank" rel="noopener noreferrer">video</a>.</p></div></div></details>
<h4 id="tools">Tools<a href="#tools" aria-label="Direct link to Tools" title="Direct link to Tools">â€‹</a></h4>
<p>A patched version of <a href="https://trungnt2910.com/assets/files/WConnectAgent-f1a427860847fac3e3211df6b2bfbb0e.zip" target="_blank"><code>WConnectAgent</code></a> needs to be run on the machine
with Project Astoria.</p>
<p>The other machine should have a copy of ADB. The official copy included with the Android SDK should
suffice.</p>
<details data-collapsed="true"><summary>What does it do?</summary><div><div><p>The normal procedure of deploying APKs to Windows 10 Mobile involves a tool called
<code>wconnect.exe</code> pairing to the mobile device through Device Discovery. This tool would
communicate with its counterpart on the mobile, which emulates the ADB protocol and allows
APK deployment.</p><p>Since Device Discovery does not work on early Windows 10 Desktop builds, <code>wconnect.exe</code> cannot
be used to establish a connection. Instead, the guide uses <code>WConnectAgent</code>, a tool bundled with
the <code>wconnect</code> suite, to start an ADB protocol server directly on the target machine.</p></div></div></details>
<details data-collapsed="true"><summary>What are the patches?</summary><div><div><p>Without patches, <code>WConnectAgent</code> would fail to start on many devices with this error:</p><div><div><pre tabindex="0"><code><span><span>80070542 Either a required impersonation level was not provided, or the provided impersonation level is invalid.</span><br/></span></code></pre></div></div><p>Turns out, to work around this error, a call to
<a href="https://learn.microsoft.com/en-us/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity" target="_blank" rel="noopener noreferrer"><code>CoInitializeSecurity</code></a>
needs to be issued before creating any COM objects, similar to how CLI projects dealing with WSL
<a href="https://github.com/Biswa96/WslReverse/blob/3df27253c3f84d7c5290719581d5fd6959ec6bd5/wslcli/WslClient.c#L27" target="_blank" rel="noopener noreferrer">function</a>.</p><p>The patch adds this line at the start of <code>Program.Main</code>:</p><div><div><pre tabindex="0"><code><span><span>NativeMethods</span><span>.</span><span>CoInitializeSecurity</span><span>(</span><span></span><br/></span><span><span>    IntPtr</span><span>.</span><span>Zero</span><span>,</span><span> </span><span>-</span><span>1</span><span>,</span><span> IntPtr</span><span>.</span><span>Zero</span><span>,</span><span> IntPtr</span><span>.</span><span>Zero</span><span>,</span><span></span><br/></span><span><span>    NativeMethods</span><span>.</span><span>RPC_C_AUTHN_LEVEL</span><span>.</span><span>DEFAULT</span><span>,</span><span></span><br/></span><span><span>    NativeMethods</span><span>.</span><span>RPC_C_IMP_LEVEL</span><span>.</span><span>IMPERSONATE</span><span>,</span><span></span><br/></span><span><span>    IntPtr</span><span>.</span><span>Zero</span><span>,</span><span></span><br/></span><span><span>    NativeMethods</span><span>.</span><span>EOAC_STATIC_CLOAKING</span><span>,</span><span></span><br/></span><span><span>    IntPtr</span><span>.</span><span>Zero</span><br/></span><span><span></span><span>)</span><span>;</span><br/></span></code></pre></div></div></div></div></details>
<h2 id="installing-astoria">Installing Astoria<a href="#installing-astoria" aria-label="Direct link to Installing Astoria" title="Direct link to Installing Astoria">â€‹</a></h2>
<h3 id="copying-files">Copying Files<a href="#copying-files" aria-label="Direct link to Copying Files" title="Direct link to Copying Files">â€‹</a></h3>
<p>Start off by copying all the files mentioned above to your target Windows device.</p>
<p>Files belonging to <code>C:\Windows\System32</code> should be put to the same path as where they were extracted
from.</p>
<p>Registry keys and the <code>WConnectAgent</code> tool can be put anywhere.</p>
<h3 id="importing-registry-keys">Importing Registry Keys<a href="#importing-registry-keys" aria-label="Direct link to Importing Registry Keys" title="Direct link to Importing Registry Keys">â€‹</a></h3>
<p>Click on each of the files in the <code>Keys</code> section to import the key.</p>
<p>The <code>.cmd</code> script should be run as Administrator.</p>
<h3 id="verifying">Verifying<a href="#verifying" aria-label="Direct link to Verifying" title="Direct link to Verifying">â€‹</a></h3>
<p>After copying all the files and importing all the required keys, restart your device.</p>
<p>Then, launch a Command Prompt window as Administrator, then run this command:</p>

<p>If you get this response, the core Astoria drivers have been set up correctly and are running.</p>
<div><div><pre tabindex="0"><code><span><span>SERVICE_NAME: adss</span><br/></span><span><span>        TYPE               : 1  KERNEL_DRIVER</span><br/></span><span><span>        STATE              : 4  RUNNING</span><br/></span><span><span>                                (STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)</span><br/></span><span><span>        WIN32_EXIT_CODE    : 0  (0x0)</span><br/></span><span><span>        SERVICE_EXIT_CODE  : 0  (0x0)</span><br/></span><span><span>        CHECKPOINT         : 0x0</span><br/></span><span><span>        WAIT_HINT          : 0x0</span><br/></span></code></pre></div></div>
<p>To ensure that the Astoria <em>userland</em> services are running, run:</p>

<p>Since AoWSM only starts on demand, you might get an error status of <code>1077</code>:</p>
<div><div><pre tabindex="0"><code><span><span>SERVICE_NAME: AoWSM</span><br/></span><span><span>        TYPE               : 20  WIN32_SHARE_PROCESS</span><br/></span><span><span>        STATE              : 1  STOPPED</span><br/></span><span><span>        WIN32_EXIT_CODE    : 1077  (0x435)</span><br/></span><span><span>        SERVICE_EXIT_CODE  : 0  (0x0)</span><br/></span><span><span>        CHECKPOINT         : 0x0</span><br/></span><span><span>        WAIT_HINT          : 0x0</span><br/></span></code></pre></div></div>
<p>In that case, just start the service manually by running:</p>

<p>Run the query command again. You should get this response, indicating that the services and Android
container are up and running on your target machine:</p>
<div><div><pre tabindex="0"><code><span><span>SERVICE_NAME: AoWSM</span><br/></span><span><span>        TYPE               : 20  WIN32_SHARE_PROCESS</span><br/></span><span><span>        STATE              : 4  RUNNING</span><br/></span><span><span>                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_PRESHUTDOWN)</span><br/></span><span><span>        WIN32_EXIT_CODE    : 0  (0x0)</span><br/></span><span><span>        SERVICE_EXIT_CODE  : 0  (0x0)</span><br/></span><span><span>        CHECKPOINT         : 0x0</span><br/></span><span><span>        WAIT_HINT          : 0x0</span><br/></span></code></pre></div></div>
<h2 id="android-apps">Android Apps<a href="#android-apps" aria-label="Direct link to Android Apps" title="Direct link to Android Apps">â€‹</a></h2>
<p>With Astoria up, let&#39;s install some Android apps!</p>
<h3 id="preparing-the-environment">Preparing the environment<a href="#preparing-the-environment" aria-label="Direct link to Preparing the environment" title="Direct link to Preparing the environment">â€‹</a></h3>
<h4 id="enabling-developer-mode">Enabling Developer Mode<a href="#enabling-developer-mode" aria-label="Direct link to Enabling Developer Mode" title="Direct link to Enabling Developer Mode">â€‹</a></h4>
<p>Go to the Windows Settings app and enable <code>Developer Mode</code> on your device to be able to sideload
applications.</p>
<p>Searching for the keyword <code>Developer</code> should guide you to the correct page in most versions of
Windows.</p>
<h4 id="adding-environment-variables">Adding Environment Variables<a href="#adding-environment-variables" aria-label="Direct link to Adding Environment Variables" title="Direct link to Adding Environment Variables">â€‹</a></h4>
<p>On your target device, in an Administrator Command Prompt window, run:</p>
<div><div><pre tabindex="0"><code><span><span>setx /M ARCADIA_APPX_PACKAGE_TYPE tablet</span><br/></span></code></pre></div></div>
<details data-collapsed="true"><summary>What does this do?</summary><div><div><p>This environment variable instructs the bridge (<code>WConnectAgent</code>) to convert APK files into
tablet (a.k.a. universal) AppX files instead of mobile-specific ones.</p><p>Without this set, <code>WConnectAgent</code> in the following steps will fail, unless you are following
this guide on a Win10M installation.</p></div></div></details>
<h3 id="bridging-to-android">Bridging to Android<a href="#bridging-to-android" aria-label="Direct link to Bridging to Android" title="Direct link to Bridging to Android">â€‹</a></h3>
<p>On your target device, start <code>WConnectAgent</code> by opening a Command Prompt window at the tool&#39;s folder
and running:</p>
<div><div><pre tabindex="0"><code><span><span>WConnectAgent -v -bindAll</span><br/></span></code></pre></div></div>
<details data-collapsed="true"><summary>What do these parameters mean?</summary><div><div><p><code>-v</code>: Put <code>WConnectAgent</code> in verbose mode. This allows us to collect diagnostic messages should
the app deployment fail.</p><p><code>-bindAll</code>: Listen to requests from external network devices as well. This switch is important
for the reasons explained later.</p></div></div></details>
<p>You should get the following screen:</p>
<p><img decoding="async" loading="lazy" alt="WConnectAgent running" src="https://trungnt2910.com/assets/images/wconnectagent-7661be5027c42689f3e69355fb28c21a.png" width="1103" height="641"/></p>
<p>indicating that an ADB proxy server has started on port <strong><code>50505</code></strong>.</p>
<h3 id="deploying-apks">Deploying APKs<a href="#deploying-apks" aria-label="Direct link to Deploying APKs" title="Direct link to Deploying APKs">â€‹</a></h3>
<p>On a <strong>different</strong> device connected to the same local network, run:</p>
<div><div><pre tabindex="0"><code><span><span>adb connect [YOUR_TARGET_DEVICE_IP]:50505</span><br/></span></code></pre></div></div>
<details data-collapsed="true"><summary>Why do I need a different device?</summary><div><div><p>If you try to use <code>adb</code> directly on the target machine, <code>adb connect</code> would simply bypass the
proxy by <code>WConnectAgent</code> and connect directly to the <code>adbd</code> in the Android container listening
at port <code>5555</code> (the default ADB port).</p><p>APK installation will succeed, but the Windows environment will have no idea that the package
has been added. There will not be a corresponding UWP package for the app, and there will be no
way to access this app from the Start Menu.</p></div></div></details>
<p>You should get this prompt, confirming that your device is connected:</p>
<div><div><pre tabindex="0"><code><span><span>connected to [YOUR_TARGET_DEVICE_IP]:50505</span><br/></span></code></pre></div></div>
<p>With the connection up, you can deploy your APK using:</p>
<div><div><pre tabindex="0"><code><span><span>adb install [PATH_TO_YOUR_APK]</span><br/></span></code></pre></div></div>
<p>If the procedure succeeds, you should see the app appearing in your Start Menu. Launch it like any
normal UWP application.</p>
<p><img decoding="async" loading="lazy" alt="Deploy Success" src="https://trungnt2910.com/assets/images/deploysuccess-166c5e9edbffb1c0dc69c2b4fcd96266.png" width="1920" height="1080"/></p>
<p>Behold, Android <a href="https://www.cpuid.com/downloads/cpu-z/android/cpu-z_1.07.apk" target="_blank" rel="noopener noreferrer">CPU-Z 1.07</a> running
on Windows 10!</p>
<p><img decoding="async" loading="lazy" alt="CPU-Z 1.07" src="https://trungnt2910.com/assets/images/cpuz-18a45325510d52d6c3689424e3c72a4a.png" width="1920" height="1080"/></p>
<h2 id="whats-next">What&#39;s Next<a href="#whats-next" aria-label="Direct link to What&#39;s Next" title="Direct link to What&#39;s Next">â€‹</a></h2>
<p>While Project Astoria now works, it is only available on very old beta builds. In the near future,
some work will be done in <a href="https://github.com/trungnt2910/lxmonika/tree/master/lxmonika" target="_blank" rel="noopener noreferrer"><code>lxmonika</code></a>
to handle different versions of the <code>PsRegisterPicoProvider</code> function, allowing it to act as a shim
between the core Windows kernel and Project Astoria drivers. This may bring Astoria to the lastest
Windows 10 Mobile build, or even Windows 10 22H2 x86.</p>
<p>In the long run, to gain access to more modern Android apps, and to support 64-bit OSes, <code>lxmonika</code>
aims to port a full Linux kernel <em>without</em> yielding to the WSL2 VM-based architecture, allowing
Linux-based Android solutions like Anbox to run natively on Windows. This solution would involve
replacing the entire Astoria stack with open-source and easy-to-maintain components while still
upholding the project&#39;s original spirit.</p>
<p>Having been abandoned by Microsoft, the future of Astoria relies on
<a href="https://github.com/trungnt2910/lxmonika" target="_blank" rel="noopener noreferrer"><code>lxmonika</code></a>, so don&#39;t forget to give this repo a visit,
and, if possible, a star! âœ¨</p>
<h2 id="acknowledgements">Acknowledgements<a href="#acknowledgements" aria-label="Direct link to Acknowledgements" title="Direct link to Acknowledgements">â€‹</a></h2>
<p>A huge thanks to <a href="https://github.com/Empyreal96" target="_blank" rel="noopener noreferrer">@empyreal96</a> and my other friends on the
<a href="https://t.me/WindowsPhoneCommunity" target="_blank" rel="noopener noreferrer">Windows Phone Community Telegram</a> for providing me with
invaluable resources and feedback during my journey digging ancient beta Windows builds!</p>
<p>This blog post marks the <strong>5</strong>-year anniversary of the
<a href="https://github.com/trungnt2910" target="_blank" rel="noopener noreferrer">@trungnt2910</a> GitHub account. I would like to thank my
<a href="https://github.com/trungnt2910?tab=followers" target="_blank" rel="noopener noreferrer"><strong>93+</strong></a> followers for giving me <strong>200+</strong> stars and
supporting my first steps on the journey of learning and contributing to open source! ðŸš€</p>
<p>I hope you enjoy this blog, and stay tuned for more updates from Project Reality! ðŸ‘€</p></div></div>
  </body>
</html>
