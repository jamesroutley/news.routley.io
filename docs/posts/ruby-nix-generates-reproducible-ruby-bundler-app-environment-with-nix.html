<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/sagittaros/ruby-nix">Original</a>
    <h1>Ruby-Nix: Generates reproducible Ruby/bundler app environment with Nix</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">This is technically a fork of <code>bundlerEnv</code> that attempts to better meet the needs of ruby app developers instead of package maintainers.</p>
<p dir="auto">This flake exports a function <code>rubyNix</code> that is suitable for local development (eg. Rails).</p>
<h2 dir="auto"><a id="user-content-features" aria-hidden="true" href="#features"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Features</h2>
<ol dir="auto">
<li>supports local, path-based gems</li>
<li>supports pre-compiled native gems on multiple platforms (see <a href="https://github.com/nix-community/bundix/pull/68" data-hovercard-type="pull_request" data-hovercard-url="/nix-community/bundix/pull/68/hovercard">this discussion</a>)</li>
<li>bundix and bundler out of the box</li>
<li>Two starter templates based on flakes</li>
</ol>
<h2 dir="auto"><a id="user-content-how-is-it-different-from-bundlerenv" aria-hidden="true" href="#how-is-it-different-from-bundlerenv"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>How is it different from bundlerEnv?</h2>
<ol dir="auto">
<li>it does not track the entire directory as <code>inputSrc</code> when <code>gemDir</code> is specified, requiring only the <code>gemset.nix</code>.</li>
<li>it does not use <code>BUNDLE_GEMFILE</code> variable.</li>
<li>it works without <code>Gemfile</code> and <code>Gemfile.lock</code>.</li>
</ol>
<h2 dir="auto"><a id="user-content-the-gist" aria-hidden="true" href="#the-gist"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>The gist</h2>
<div dir="auto" data-snippet-clipboard-copy-content="let
    pkgs = import nixpkgs { inherit system; };
    rubyNix = ruby-nix.lib pkgs;

    inherit (rubyNix {
        name = &#34;simple-ruby-app&#34;;
        gemset = ./gemset.nix;
        # run `bundle platform` to find your platform
        gemPlatforms = [ &#34;ruby&#34; &#34;arm64-darwin-20&#34; &#34;x86_64-linux&#34; ];
    }) env envMinimal; 
in
{
    devShells = rec {
        default = dev;
        dev = pkgs.mkShell {
            buildInputs = [ env ];
        };
    };
}"><pre><span>let</span>
    <span>pkgs</span> <span>=</span> <span>import</span> <span>nixpkgs</span> { <span>inherit</span> <span>system</span>; };
    <span>rubyNix</span> <span>=</span> <span>ruby-nix</span><span>.</span><span>lib</span> <span>pkgs</span>;

    <span>inherit</span> (<span>rubyNix</span> {
        <span>name</span> <span>=</span> <span><span>&#34;</span>simple-ruby-app<span>&#34;</span></span>;
        <span>gemset</span> <span>=</span> <span>./gemset.nix</span>;
        <span># run `bundle platform` to find your platform</span>
        <span>gemPlatforms</span> <span>=</span> [ <span><span>&#34;</span>ruby<span>&#34;</span></span> <span><span>&#34;</span>arm64-darwin-20<span>&#34;</span></span> <span><span>&#34;</span>x86_64-linux<span>&#34;</span></span> ];
    }) <span>env</span> <span>envMinimal</span>; 
<span>in</span>
{
    <span>devShells</span> <span>=</span> <span>rec</span> {
        <span>default</span> <span>=</span> <span>dev</span>;
        <span>dev</span> <span>=</span> <span>pkgs</span><span>.</span><span>mkShell</span> {
            <span>buildInputs</span> <span>=</span> [ <span>env</span> ];
        };
    };
}</pre></div>
<h2 dir="auto"><a id="user-content-usage" aria-hidden="true" href="#usage"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Usage</h2>
<p dir="auto">With nix <a href="https://github.com/sagittaros/ruby-nix/blob/main/docs/nix-installation.md">installed</a> and optionally <a href="https://github.com/sagittaros/ruby-nix/blob/main/docs/direnv.md">direnv</a>, you can run:</p>
<h4 dir="auto"><a id="user-content-1-initialize-flake" aria-hidden="true" href="#1-initialize-flake"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>1. Initialize flake</h4>
<div dir="auto" data-snippet-clipboard-copy-content="cd myapp
nix flake init -t github:sagittaros/ruby-nix"><pre><span>cd</span> myapp
nix flake init -t github:sagittaros/ruby-nix</pre></div>
<h4 dir="auto"><a id="user-content-2-enter-nix-shell" aria-hidden="true" href="#2-enter-nix-shell"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>2. Enter nix shell</h4>
<p dir="auto">If you are a <a href="https://github.com/sagittaros/ruby-nix/blob/main/docs/direnv.md">direnv</a> user, add the following content to <code>.envrc</code> and run <code>direnv allow</code>. Otherwise, run <code>nix develop -c zsh</code>.</p>
<div data-snippet-clipboard-copy-content="if ! has nix_direnv_version || ! nix_direnv_version 2.2.0; then
  source_url &#34;https://raw.githubusercontent.com/nix-community/nix-direnv/2.2.0/direnvrc&#34; &#34;sha256-5EwyKnkJNQeXrRkYbwwRBcXbibosCJqyIUuz9Xq+LRc=&#34;
fi
use flake"><pre><code>if ! has nix_direnv_version || ! nix_direnv_version 2.2.0; then
  source_url &#34;https://raw.githubusercontent.com/nix-community/nix-direnv/2.2.0/direnvrc&#34; &#34;sha256-5EwyKnkJNQeXrRkYbwwRBcXbibosCJqyIUuz9Xq+LRc=&#34;
fi
use flake
</code></pre></div>
<h4 dir="auto"><a id="user-content-3-in-nix-shell" aria-hidden="true" href="#3-in-nix-shell"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>3. In nix shell</h4>
<p dir="auto">Replace <code>Gemfile</code> and <code>Gemfile.lock</code> with your own and run <code>generate-gemset</code>. Otherwise, use <code>relock-gems</code> to generate both <code>Gemfile.lock</code> and <code>gemset.nix</code>.</p>
<h2 dir="auto"><a id="user-content-building-a-docker-image" aria-hidden="true" href="#building-a-docker-image"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Building a Docker image</h2>
<div dir="auto" data-snippet-clipboard-copy-content="cd someapp
nix flake init -t github:sagittaros/ruby-nix#docker-app
nix build
docker load &lt; result
docker images"><pre><span>cd</span> someapp
nix flake init -t github:sagittaros/ruby-nix#docker-app
nix build
docker load <span>&lt;</span> result
docker images</pre></div>
<h2 dir="auto"><a id="user-content-screencast-wip" aria-hidden="true" href="#screencast-wip"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Screencast (WIP)</h2>
<div dir="auto" data-snippet-clipboard-copy-content="/tmp
▲ mkdir t1

/tmp
▲ cd t1

/tmp/t1
▲ nix flake init -t github:sagittaros/ruby-nix

wrote: /tmp/t1/gemset.nix
wrote: /tmp/t1/Gemfile
wrote: /tmp/t1/Gemfile.lock
wrote: /tmp/t1/flake.nix

/tmp/t1
▲ ls
flake.nix  Gemfile  Gemfile.lock  gemset.nix

/tmp/t1
▲ nix develop -c zsh
warning: creating lock file &#39;/tmp/t1/flake.lock&#39;
/tmp/t1
nix-shell ▲ irb
irb(main):001:0&gt; require &#39;puma&#39;
=&gt; true
irb(main):002:0&gt;

/tmp/t1 6s
nix-shell ▲ rails
Usage:
  rails new APP_PATH [options]"><pre>/tmp
▲ mkdir t1

/tmp
▲ <span>cd</span> t1

/tmp/t1
▲ nix flake init -t github:sagittaros/ruby-nix

wrote: /tmp/t1/gemset.nix
wrote: /tmp/t1/Gemfile
wrote: /tmp/t1/Gemfile.lock
wrote: /tmp/t1/flake.nix

/tmp/t1
▲ ls
flake.nix  Gemfile  Gemfile.lock  gemset.nix

/tmp/t1
▲ nix develop -c zsh
warning: creating lock file <span><span>&#39;</span>/tmp/t1/flake.lock<span>&#39;</span></span>
/tmp/t1
nix-shell ▲ irb
irb(main):001:<span>0&gt;</span> require <span><span>&#39;</span>puma<span>&#39;</span></span>
=<span>&gt;</span> <span>true</span>
irb(main):002:<span>0&gt;</span>

/tmp/t1 6s
nix-shell ▲ rails
Usage:
  rails new APP_PATH [options]</pre></div>
<h2 dir="auto"><a id="user-content-credits" aria-hidden="true" href="#credits"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Credits</h2>
<p dir="auto">All credits goes to the original authors of <code>buildRubyGem</code>, <code>bundlerEnv</code>, and <code>bundix</code> (@manveru, @lavoiesl, @jdelStrother). This is only a thin layer with a different take on top of these solid foundation.</p>
<p dir="auto">PRs welcomed :)</p>
</article>
          </div></div>
  </body>
</html>
