<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jvns.ca/blog/2023/02/28/some-notes-on-using-nix/">Original</a>
    <h1>Some notes on using nix</h1>
    
    

<p>Recently I started using a Mac for the first time. The biggest downside I&rsquo;ve
noticed so far is that the package management is much worse than on Linux.
At some point I got frustrated with homebrew because I felt like it was
spending too much time upgrading when I installed new packages, and so I
thought &ndash; maybe I&rsquo;ll try the <a href="https://nixos.org/">nix</a> package manager!</p>

<p>nix has a reputation for being confusing (it has its whole
own programming language!), so I&rsquo;ve been trying to figure out how to use nix in
a way that&rsquo;s as simple as possible and does not involve managing any
configuration files or learning a new programming language. Here&rsquo;s what I&rsquo;ve
figured out so far! We&rsquo;ll talk about how to:</p>

<ol>
<li>install packages with nix</li>
<li>build a custom nix package for a C++ program called <a href="https://mj.ucw.cz/sw/paperjam/">paperjam</a></li>
<li>install a 5-year-old version of <a href="https://github.com/gohugoio/hugo/">hugo</a> with nix</li>
</ol>

<p>As usual I&rsquo;ve probably gotten some stuff wrong in this post since I&rsquo;m still
pretty new to nix. I&rsquo;m also still not sure how much I like nix &ndash; it&rsquo;s very
confusing! But it&rsquo;s helped me compile some software that I was struggling to
compile otherwise, and in general it seems to install things faster than
homebrew.</p>

<h3 id="what-s-interesting-about-nix">what&rsquo;s interesting about nix?</h3>

<p>People often describe nix as &ldquo;declarative package management&rdquo;. I don&rsquo;t
care that much about declarative package management, so here are two things
that I appreciate about nix:</p>

<ol>
<li>It provides binary packages (hosted at <a href="https://cache.nixos.org/">https://cache.nixos.org/</a>) that you can quickly download and install</li>
<li>For packages which don&rsquo;t have binary packages, it makes it easier to compile them</li>
</ol>

<p>I think that the reason nix is good at compiling software is that:</p>

<ul>
<li>you can have multiple versions of the same library or program installed at a time (you could have 2 different versions of libc for instance). For example I have two versions of node on my computer right now, one at <code>/nix/store/4ykq0lpvmskdlhrvz1j3kwslgc6c7pnv-nodejs-16.17.1</code> and one at <code>/nix/store/5y4bd2r99zhdbir95w5pf51bwfg37bwa-nodejs-18.9.1</code>.</li>
<li>when nix builds a package, it builds it in isolation, using only the
specific versions of its dependencies that you explicitly declared. So
there&rsquo;s no risk that the package secretly depends on another package on your
system that you don&rsquo;t know about. No more fighting with <code>LD_LIBRARY_PATH</code>!</li>
<li>a lot of people have put a lot of work into writing down all of the
dependencies of packages</li>
</ul>

<p>I&rsquo;ll give a couple of examples later in this post of two times nix made it easier for me to compile software.</p>

<h3 id="how-i-got-started-with-nix">how I got started with nix</h3>

<p>here&rsquo;s how I got started with nix:</p>

<ol>
<li>Install nix. I forget exactly how I did this, but it looks like there&rsquo;s an <a href="https://nixos.org/download">official installer</a> and an <a href="https://zero-to-nix.com/concepts/nix-installer">unofficial installer from zero-to-nix.com</a>. The <a href="https://nixos.org/manual/nix/stable/installation/installing-binary.html#macos">instructions for uninstalling nix on MacOS with the standard multi-user install</a> are a bit complicated, so it might be worth choosing an installation method with simpler uninstall instructions.</li>
<li>Put <code>~/.nix-profile/bin</code> on my PATH</li>
<li>Install packages with <code>nix-env -iA nixpkgs.NAME</code></li>
<li>That&rsquo;s it.</li>
</ol>

<p>Basically the idea is to treat <code>nix-env -iA</code> like <code>brew install</code> or <code>apt-get install</code>.</p>

<p>For example, if I want to install <code>fish</code>, I can do that like this:</p>

<pre><code>nix-env -iA nixpkgs.fish
</code></pre>

<p>This seems to just download some binaries from <a href="https://cache.nixos.org">https://cache.nixos.org</a> &ndash; pretty simple.</p>

<p>Some people use nix to install their Node and Python and Ruby packages, but I haven&rsquo;t
been doing that &ndash; I just use <code>npm install</code> and <code>pip install</code> the same way I
always have.</p>

<h3 id="some-nix-features-i-m-not-using">some nix features I&rsquo;m not using</h3>

<p>There are a bunch of nix features/tools that I&rsquo;m not using, but that I&rsquo;ll
mention. I originally thought that you <em>had</em> to use these features to use nix,
because most of the nix tutorials I&rsquo;ve read talk about them. But you don&rsquo;t have to use them.</p>

<ul>
<li>NixOS (a Linux distribution)</li>
<li><a href="https://nixos.org/guides/nix-pills/developing-with-nix-shell.html">nix-shell</a></li>
<li><a href="https://nixos.wiki/wiki/Flakes">nix flakes</a></li>
<li><a href="https://github.com/nix-community/home-manager">home-manager</a></li>
<li><a href="https://devenv.sh/">devenv.sh</a></li>
</ul>

<p>I won&rsquo;t go into these because I haven&rsquo;t really used them and there are lots of
explanations out there.</p>

<h3 id="where-are-nix-packages-defined">where are nix packages defined?</h3>

<p>I think packages in the main nix package repository are defined in <a href="https://github.com/NixOS/nixpkgs/">https://github.com/NixOS/nixpkgs/</a></p>

<p>It looks like you can search for packages at <a href="https://search.nixos.org/packages">https://search.nixos.org/packages</a>. The two official ways to search packages seem to be:</p>

<ul>
<li><code>nix-env -qaP NAME</code>, which is very extremely slow and which I haven&rsquo;t been able to get to actually work</li>
<li><code>nix --extra-experimental-features 'nix-command flakes' search nixpkgs NAME</code>, which does seem to work but is kind of a mouthful. Also all of the packages it prints out start with <code>legacyPackages</code> for some reason</li>
</ul>

<p>I found a way to search nix packages from the command line that I liked better:</p>

<ol>
<li>Run <code>nix-env -qa '*' &gt; nix-packages.txt</code> to get a list of every package in the Nix repository</li>
<li>Write a short <code>nix-search</code> script that just greps <code>packages.txt</code> (<code>cat ~/bin/nix-packages.txt | awk '{print $1}' | rg &quot;$1&quot;</code>)</li>
</ol>

<h3 id="everything-is-installed-with-symlinks">everything is installed with symlinks</h3>

<p>One of nix&rsquo;s major design choices is that there isn&rsquo;t one single <code>bin</code> with all
your packages, instead you use symlinks.  There are a lot of layers of symlinks. A few examples of symlinks:</p>

<ul>
<li><code>~/.nix-profile</code> on my machine is (indirectly) a symlink to <code>/nix/var/nix/profiles/per-user/bork/profile-111-link/</code></li>
<li><code>~/.nix-profile/bin/fish</code> is a symlink to <code>/nix/store/afkwn6k8p8g97jiqgx9nd26503s35mgi-fish-3.5.1/bin/fish</code></li>
</ul>

<p>When I install something, it creates a new <code>profile-112-link</code> directory with new symlinks and updates my <code>~/.nix-profile</code> to point to that directory.</p>

<p>I think this means that if I install a new version of <code>fish</code> and I don&rsquo;t like it, I can
easily go back just by running <code>nix-env --rollback</code> &ndash; it&rsquo;ll move me to my previous profile directory.</p>

<h3 id="uninstalling-packages-doesn-t-delete-them">uninstalling packages doesn&rsquo;t delete them</h3>

<p>If I uninstall a nix package like this, it doesn&rsquo;t actually free any hard drive space, it just removes the symlinks.</p>

<pre><code>$ nix-env --uninstall oil
</code></pre>

<p>I&rsquo;m still not sure how to actually delete the package &ndash; I ran a garbage collection like this, which seemed to delete some things:</p>

<pre><code>$ nix-collect-garbage
...
85 store paths deleted, 74.90 MiB freed
</code></pre>

<p>But I still have <code>oil</code> on my system at <code>/nix/store/8pjnk6jr54z77jiq5g2dbx8887dnxbda-oil-0.14.0</code>.</p>

<p>There&rsquo;s a more aggressive version of <code>nix-collect-garbage</code> that also deletes old versions of your profiles (so that you can&rsquo;t rollback)</p>

<pre><code>$ nix-collect-garbage -d --delete-old
</code></pre>

<p>That doesn&rsquo;t delete <code>/nix/store/8pjnk6jr54z77jiq5g2dbx8887dnxbda-oil-0.14.0</code> either though and I&rsquo;m not sure why.</p>

<h3 id="upgrading">upgrading</h3>

<p>It looks like you can upgrade nix packages like this:</p>

<pre><code>nix-channel --update
nix-env --upgrade
</code></pre>

<p>(similar to <code>apt-get update &amp;&amp; apt-get upgrade</code>)</p>

<p>I haven&rsquo;t really upgraded anything yet. I think that if something goes wrong with an upgrade, you can roll back (because everything is immutable in nix!) with</p>

<pre><code>nix-env --rollback
</code></pre>

<p>Someone linked me to <a href="https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/">this post from Ian Henry</a> that
talks about some confusing problems with <code>nix-env --upgrade</code> &ndash; maybe it
doesn&rsquo;t work the way you&rsquo;d expect? I guess I&rsquo;ll be wary around upgrades.</p>

<h3 id="next-goal-make-a-custom-package-of-paperjam">next goal: make a custom package of <code>paperjam</code></h3>

<p>After a few months of installing existing packages, I wanted to make a custom package with nix for a program called <a href="https://mj.ucw.cz/sw/paperjam/">paperjam</a> that wasn&rsquo;t already packaged.</p>

<p>I was actually struggling to compile <code>paperjam</code> at all even without nix  because the version I had
of <code>libiconv</code> I has on my system was wrong. I thought it might be easier to
compile it with nix even though I didn&rsquo;t know how to make nix packages yet. And
it actually was!</p>

<p>But figuring out how to get there was VERY confusing, so here are some notes about how I did it.</p>

<h3 id="how-to-build-an-example-package">how to build an example package</h3>

<p>Before I started working on my <code>paperjam</code> package, I wanted to build an example existing package just to
make sure I understood the process for building a package. I was really
struggling to figure out how to do this, but I asked in Discord and someone
explained to me how I could get a working package from <a href="https://github.com/NixOS/nixpkgs/">https://github.com/NixOS/nixpkgs/</a> and build it. So here
are those instructions:</p>

<p><strong>step 1:</strong> Download some arbitrary package from <a href="https://github.com/NixOS/nixpkgs/">nixpkgs</a> on github, for example the <code>dash</code> package:</p>

<pre><code>wget https://raw.githubusercontent.com/NixOS/nixpkgs/47993510dcb7713a29591517cb6ce682cc40f0ca/pkgs/shells/dash/default.nix -O dash.nix
</code></pre>

<p><strong>step 2</strong>: Replace the first statement (<code>{ lib , stdenv , buildPackages , autoreconfHook , pkg-config , fetchurl , fetchpatch , libedit , runCommand , dash }:</code> with <code>with import &lt;nixpkgs&gt; {};</code> I don&rsquo;t know why you have to do this,
but it works.</p>

<p><strong>step 3</strong>: Run <code>nix-build dash.nix</code></p>

<p>This compiles the package</p>

<p><strong>step 4</strong>: Run <code>nix-env -i -f dash.nix</code></p>

<p>This installs the package into my <code>~/.nix-profile</code></p>

<p>That&rsquo;s all! Once I&rsquo;d done that, I felt like I could modify the <code>dash</code> package and make my own package.</p>

<h3 id="how-i-made-my-own-package">how I made my own package</h3>

<p><code>paperjam</code> has one dependency (<code>libpaper</code>) that also isn&rsquo;t packaged yet, so I needed to build <code>libpaper</code> first.</p>

<p>Here&rsquo;s <code>libpaper.nix</code>. I basically just wrote this by copying and pasting from
other packages in the <a href="https://github.com/NixOS/nixpkgs/">nixpkgs</a> repository.
My guess is what&rsquo;s happening here is that nix has some default rules for
compiling C packages (like &ldquo;run <code>make install</code>&rdquo;), so the <code>make install</code> happens
default and I don&rsquo;t need to configure it explicitly.</p>

<pre><code>with import &lt;nixpkgs&gt; {};

stdenv.mkDerivation rec {
  pname = &quot;libpaper&quot;;
  version = &quot;0.1&quot;;

  src = fetchFromGitHub {
    owner = &quot;naota&quot;;
    repo = &quot;libpaper&quot;;
    rev = &quot;51ca11ec543f2828672d15e4e77b92619b497ccd&quot;;
    hash = &quot;sha256-S1pzVQ/ceNsx0vGmzdDWw2TjPVLiRgzR4edFblWsekY=&quot;;
  };

  buildInputs = [ ];

  meta = with lib; {
    homepage = &quot;https://github.com/naota/libpaper&quot;;
    description = &quot;libpaper&quot;;
    platforms = platforms.unix;
    license = with licenses; [ bsd3 gpl2 ];
  };
}
</code></pre>

<p>Basically this just tells nix how to download the source from GitHub.</p>

<p>I built this by running <code>nix-build libpaper.nix</code></p>

<p>Next, I needed to compile <code>paperjam</code>. Here&rsquo;s a link to the <a href="https://github.com/jvns/nixpkgs/blob/22b70a48a797538c76b04261b3043165896d8f69/paperjam.nix">nix package I wrote</a>. The main things I needed to do other than telling it where to download the source were:</p>

<ol>
<li>add some extra build dependencies (like <code>asciidoc</code>)</li>
<li>set some environment variables for the install (<code>installFlags = [ &quot;PREFIX=$(out)&quot; ];</code>) so that it installed in the correct directory instead of <code>/usr/local/bin</code>.</li>
</ol>

<p>I set the hashes by first leaving the hash empty, then running <code>nix-build</code> to get an error message complaining about a mismatched hash. Then I copied the correct hash out of the error message.</p>

<p>I figured out how to set <code>installFlags</code> just by running <code>rg PREFIX</code>
in the nixpkgs repository &ndash; I figured that needing to set a <code>PREFIX</code> was
pretty common and someone had probably done it before, and I was right. So I
just copied and pasted that line from another package.</p>

<p>Then I ran:</p>

<pre><code>nix-build paperjam.nix
nix-env -i -f paperjam.nix
</code></pre>

<p>and then everything worked and I had <code>paperjam</code> installed! Hooray!</p>

<h3 id="next-goal-install-a-5-year-old-version-of-hugo">next goal: install a 5-year-old version of <code>hugo</code></h3>

<p>Right now I build this blog using Hugo 0.40, from 2018. I don&rsquo;t need any new
features so I haven&rsquo;t felt a need to upgrade. On Linux this is easy: Hugo&rsquo;s
releases are a static binary, so I can just download the 5-year-old binary from
the <a href="https://github.com/gohugoio/hugo/releases/tag/v0.40">releases page</a> and
run it. Easy!</p>

<p>But on this Mac I ran into some complications. Mac hardware has changed in the
last 5 years, so the Mac Hugo binary I downloaded crashed. And when I tried to
build it from source with <code>go build</code>, that didn&rsquo;t work either because Go build
norms have changed in the last 5 years as well.</p>

<p>I was working around this by running Hugo in a Linux docker container, but I
didn&rsquo;t love that: it was kind of slow and it felt silly. It shouldn&rsquo;t be that
hard to compile one Go program!</p>

<p>Nix to the rescue! Here&rsquo;s what I did to install the old version of Hugo with
nix.</p>

<h3 id="installing-hugo-0-40-with-nix">installing Hugo 0.40 with nix</h3>

<p>I wanted to install Hugo 0.40 and put it in my PATH as <code>hugo-0.40</code>. Here&rsquo;s how
I did it. I did this in a kind of weird way, but it worked (<a href="https://lazamar.github.io/download-specific-package-version-with-nix/">Searching and installing old versions of Nix packages</a>
describes a probably more normal method).</p>

<p><strong>step 1</strong>: Search through the nixpkgs repo to find Hugo 0.40</p>

<p>I found the <code>.nix</code> file here <a href="https://github.com/NixOS/nixpkgs/blob/17b2ef2/pkgs/applications/misc/hugo/default.nix">https://github.com/NixOS/nixpkgs/blob/17b2ef2/pkgs/applications/misc/hugo/default.nix</a></p>

<p><strong>step 2</strong>: Download that file and build it</p>

<p>I downloaded that file (and another file called <code>deps.nix</code> in the same directory), replaced the first line with <code>with import &lt;nixpkgs&gt; {};</code>, and built it with <code>nix-build hugo.nix</code>.</p>

<p>That almost worked without any changes, but I had to make two changes:</p>

<ul>
<li>replace <code>with stdenv.lib</code> to <code>with lib</code> for some reason.</li>
<li>rename the package to <code>hugo040</code> so that it wouldn&rsquo;t conflict with the other version of <code>hugo</code> that I had installed</li>
</ul>

<p><strong>step 3</strong>: Rename <code>hugo</code> to <code>hugo-0.40</code></p>

<p>I write a little post install script to rename the Hugo binary.</p>

<pre><code>  postInstall = ''
    mv $out/bin/hugo $out/bin/hugo-0.40
  '';
</code></pre>

<p>I figured out how to run this by running <code>rg 'mv '</code> in the nixpkgs repository and just copying and modifying something that seemed related.</p>

<p><strong>step 4</strong>: Install it</p>

<p>I installed into my <code>~/.nix-profile/bin</code> by running <code>nix-env -i -f hugo.nix</code>.</p>

<p>And it all works! I put the final <code>.nix</code> file into my own personal <a href="https://github.com/jvns/nixpkgs/">nixpkgs repo</a> so that I can use it again later if I
want.</p>

<h3 id="reproducible-builds-aren-t-magic-they-re-really-hard">reproducible builds aren&rsquo;t magic, they&rsquo;re really hard</h3>

<p>I think it&rsquo;s worth noting here that this <code>hugo.nix</code> file isn&rsquo;t magic &ndash; the
reason I can easily compile Hugo 0.40 today is that many people worked for a long time to make it possible to
package that version of Hugo in a reproducible way.</p>

<h3 id="that-s-all">that&rsquo;s all!</h3>

<p>Installing <code>paperjam</code> and this 5-year-old version of Hugo were both
surprisingly painless and actually much easier than compiling it without nix,
because nix made it much easier for me to compile the <code>paperjam</code> package with
the right version of <code>libiconv</code>, and because someone 5 years ago had already
gone to the trouble of listing out the exact dependencies for Hugo.</p>

<p>I don&rsquo;t have any plans to get much more complicated with nix (and it&rsquo;s still
very possible I&rsquo;ll get frustrated with it and go back to homebrew!), but we&rsquo;ll
see what happens! I&rsquo;ve found it much easier to start in a simple way and then
start using more features if I feel the need instead of adopting a whole bunch
of complicated stuff all at once.</p>

<p>I probably won&rsquo;t use nix on Linux &ndash; I&rsquo;ve always been happy enough with <code>apt</code>
(on Debian-based distros) and <code>pacman</code> (on Arch-based distros), and they&rsquo;re
much less confusing. But on a Mac it seems like it might be worth it. We&rsquo;ll
see!</p>

  </body>
</html>
