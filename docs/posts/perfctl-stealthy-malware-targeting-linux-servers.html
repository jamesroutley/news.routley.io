<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.aquasec.com/blog/perfctl-a-stealthy-malware-targeting-millions-of-linux-servers/">Original</a>
    <h1>Perfctl: Stealthy malware targeting Linux servers</h1>
    
    <div id="readability-page-1" class="page"><div>
				<div>
					
					<p aria-level="2">In this blog post, Aqua Nautilus researchers aim to shed light on a Linux malware that, over the past 3-4 years, has actively sought more than 20,000 types of misconfigurations in order to target and exploit Linux servers. If you have a Linux server connected to the internet, you could be at risk. In fact, given the scale, we strongly believe the attackers targeted millions worldwide with a potential number of victims of thousands, it appears that with this malware any Linux server could be at risk.</p>

<p aria-level="2"><span data-contrast="auto">We discovered numerous incident reports in community forums, all describing indicators of compromise linked to this malware. The community has widely referred to it as the “perfctl malware,” and we have adopted this name.</span><span data-ccp-props="{&#34;134245418&#34;:true,&#34;134245529&#34;:true,&#34;201341983&#34;:0,&#34;335559738&#34;:40,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p aria-level="2"><span data-contrast="auto">This post will explore the malware’s architecture, components, defense evasion tactics, persistence mechanisms, and how we managed to detect it. Perfctl is particularly elusive and persistent, employing several sophisticated techniques, including:</span><span data-ccp-props="{&#34;134245418&#34;:true,&#34;134245529&#34;:true,&#34;201341983&#34;:0,&#34;335559738&#34;:40,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<ul>
<li data-leveltext="-" data-font="Calibri" data-listid="33" data-list-defn-props="{&#34;335551671&#34;:0,&#34;335552541&#34;:1,&#34;335559685&#34;:720,&#34;335559991&#34;:360,&#34;469769226&#34;:&#34;Calibri&#34;,&#34;469769242&#34;:[8226],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;-&#34;,&#34;469777815&#34;:&#34;hybridMultilevel&#34;}" aria-setsize="-1" data-aria-posinset="0" data-aria-level="1"><span data-contrast="auto">It utilizes rootkits to hide its presence.</span><span data-ccp-props="{&#34;134245418&#34;:true,&#34;134245529&#34;:true,&#34;201341983&#34;:0,&#34;335559685&#34;:426,&#34;335559738&#34;:40,&#34;335559739&#34;:0,&#34;335559740&#34;:240,&#34;335559991&#34;:426}"> </span></li>
</ul>
<ul>
<li data-leveltext="-" data-font="Calibri" data-listid="33" data-list-defn-props="{&#34;335551671&#34;:0,&#34;335552541&#34;:1,&#34;335559685&#34;:720,&#34;335559991&#34;:360,&#34;469769226&#34;:&#34;Calibri&#34;,&#34;469769242&#34;:[8226],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;-&#34;,&#34;469777815&#34;:&#34;hybridMultilevel&#34;}" aria-setsize="-1" data-aria-posinset="1" data-aria-level="1"><span data-contrast="auto">When a new user logs into the server, it immediately stops all “noisy” activities, lying dormant until the server is idle again.</span><span data-ccp-props="{&#34;134245418&#34;:true,&#34;134245529&#34;:true,&#34;201341983&#34;:0,&#34;335559685&#34;:426,&#34;335559738&#34;:40,&#34;335559739&#34;:0,&#34;335559740&#34;:240,&#34;335559991&#34;:426}"> </span></li>
</ul>
<ul>
<li data-leveltext="-" data-font="Calibri" data-listid="33" data-list-defn-props="{&#34;335551671&#34;:0,&#34;335552541&#34;:1,&#34;335559685&#34;:720,&#34;335559991&#34;:360,&#34;469769226&#34;:&#34;Calibri&#34;,&#34;469769242&#34;:[8226],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;-&#34;,&#34;469777815&#34;:&#34;hybridMultilevel&#34;}" aria-setsize="-1" data-aria-posinset="2" data-aria-level="1"><span data-contrast="auto">It utilizes Unix socket for internal communication and TOR for external communication.</span><span data-ccp-props="{&#34;134245418&#34;:true,&#34;134245529&#34;:true,&#34;201341983&#34;:0,&#34;335559685&#34;:426,&#34;335559738&#34;:40,&#34;335559739&#34;:0,&#34;335559740&#34;:240,&#34;335559991&#34;:426}"> </span></li>
</ul>
<ul>
<li data-leveltext="-" data-font="Calibri" data-listid="33" data-list-defn-props="{&#34;335551671&#34;:0,&#34;335552541&#34;:1,&#34;335559685&#34;:720,&#34;335559991&#34;:360,&#34;469769226&#34;:&#34;Calibri&#34;,&#34;469769242&#34;:[8226],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;-&#34;,&#34;469777815&#34;:&#34;hybridMultilevel&#34;}" aria-setsize="-1" data-aria-posinset="3" data-aria-level="1"><span data-contrast="auto">After execution, it deletes its binary and continues to run quietly in the background as a service.</span><span data-ccp-props="{&#34;134245418&#34;:true,&#34;134245529&#34;:true,&#34;201341983&#34;:0,&#34;335559685&#34;:426,&#34;335559738&#34;:40,&#34;335559739&#34;:0,&#34;335559740&#34;:240,&#34;335559991&#34;:426}"> </span></li>
</ul>
<ul>
<li data-leveltext="-" data-font="Calibri" data-listid="33" data-list-defn-props="{&#34;335551671&#34;:0,&#34;335552541&#34;:1,&#34;335559685&#34;:720,&#34;335559991&#34;:360,&#34;469769226&#34;:&#34;Calibri&#34;,&#34;469769242&#34;:[8226],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;-&#34;,&#34;469777815&#34;:&#34;hybridMultilevel&#34;}" aria-setsize="-1" data-aria-posinset="4" data-aria-level="1"><span data-contrast="auto">It copies itself from memory to various locations on the disk, using deceptive names.</span><span data-ccp-props="{&#34;134245418&#34;:true,&#34;134245529&#34;:true,&#34;201341983&#34;:0,&#34;335559685&#34;:426,&#34;335559738&#34;:40,&#34;335559739&#34;:0,&#34;335559740&#34;:240,&#34;335559991&#34;:426}"> </span></li>
</ul>
<ul>
<li data-leveltext="-" data-font="Calibri" data-listid="33" data-list-defn-props="{&#34;335551671&#34;:0,&#34;335552541&#34;:1,&#34;335559685&#34;:720,&#34;335559991&#34;:360,&#34;469769226&#34;:&#34;Calibri&#34;,&#34;469769242&#34;:[8226],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;-&#34;,&#34;469777815&#34;:&#34;hybridMultilevel&#34;}" aria-setsize="-1" data-aria-posinset="5" data-aria-level="1"><span data-contrast="auto">It opens a backdoor on the server and listens for TOR communications.</span><span data-ccp-props="{&#34;134245418&#34;:true,&#34;134245529&#34;:true,&#34;201341983&#34;:0,&#34;335559685&#34;:426,&#34;335559738&#34;:40,&#34;335559739&#34;:0,&#34;335559740&#34;:240,&#34;335559991&#34;:426}"> </span></li>
</ul>
<ul>
<li data-leveltext="-" data-font="Calibri" data-listid="33" data-list-defn-props="{&#34;335551671&#34;:0,&#34;335552541&#34;:1,&#34;335559685&#34;:720,&#34;335559991&#34;:360,&#34;469769226&#34;:&#34;Calibri&#34;,&#34;469769242&#34;:[8226],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;-&#34;,&#34;469777815&#34;:&#34;hybridMultilevel&#34;}" aria-setsize="-1" data-aria-posinset="6" data-aria-level="1"><span data-contrast="auto">It attempts to exploit the Polkit vulnerability (CVE-2021-4043) to escalate privileges.</span><span data-ccp-props="{&#34;134245418&#34;:true,&#34;134245529&#34;:true,&#34;201341983&#34;:0,&#34;335559685&#34;:426,&#34;335559738&#34;:40,&#34;335559739&#34;:0,&#34;335559740&#34;:240,&#34;335559991&#34;:426}"> </span></li>
</ul>
<p aria-level="2"><span data-contrast="auto">In all the attacks observed, the malware was used to run a cryptominer, and in some cases, we also detected the execution of proxy-jacking software. During one of our sandbox tests, the threat actor utilized one of the malware’s backdoors to access the honeypot and started deploying some new utilities to better understand the nature of our server, trying to understand what exactly we are doing to its malware.</span><span data-ccp-props="{&#34;134245418&#34;:true,&#34;134245529&#34;:true,&#34;201341983&#34;:0,&#34;335559738&#34;:40,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>

<div id="section_wrap_1">
<h3 aria-level="2"><span lang="EN-US" xml:lang="EN-US" data-contrast="none"><span data-ccp-parastyle="heading 2">Elusive Malware Dominates Developer Forums</span></span><span data-ccp-props="{&#34;134245418&#34;:true,&#34;134245529&#34;:true,&#34;201341983&#34;:0,&#34;335559738&#34;:40,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></h3>
<p><span data-contrast="auto">Our story begins with an attack we monitored on one of our honeypots. Typically, we check if anyone has already documented the attack, as this allows us to analyze it more thoroughly and compare our findings with those of other researchers. However, in this case, we found no report about the malware that had targeted our honeypot.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto"><span>What we did</span><span> fi</span><span>nd, though, were </span><span>numerous</span><span> references to </span><span>a </span></span><code>perfctl</code><span data-contrast="auto"><span> malware</span><span>, this </span><span>imm</span><span>ediately</span><span> drew our attention, as this was one of the names of our </span><span>malware. These are</span> i<span>n various languages</span> <span>across several developer communities and forums</span><span>,</span> <span>w</span><span>e carefully reviewed these posts and found that the i</span><span>ndicators </span><span>of compromise mentioned in them are the same as the ones </span><span>we’ve</span><span> seen in our attack.</span> Usually in some of these posts you can find replies with links to reports about the malware written by researchers. But in this case, however, none of these had links to such reports. Here are some of the posts we came across: </span><a href="https://www.reddit.com/r/CentOS/comments/12ef76l/need_help_in_removal_perfcc_and_perfctl_coin/" target="_blank" rel="noopener"><span data-contrast="none">Reddit</span></a><span data-contrast="auto">, </span><a href="https://www.freelancer.com/projects/linux/remove-perfctl-malware-from-vps" target="_blank" rel="noopener"><span data-contrast="none">freelancer</span></a><span data-contrast="auto">, </span><a href="https://es.stackoverflow.com/questions/580957/perfctl-usa-el-100-de-los-recursos-del-cpu" target="_blank" rel="noopener"><span data-contrast="none">Stack Overflow </span></a><span data-contrast="auto">(Spanish), </span><a href="https://forobeta.com/temas/como-eliminar-el-malware-perfctl-del-servidor-vps-ubuntu-20-04.961444/?amp=1" target="_blank" rel="noopener"><span data-contrast="none">forobeta</span></a><span data-contrast="auto"> (Spanish), </span><a href="https://community.brainycp.com/viewtopic.php?t=5264" target="_blank" rel="noopener"><span data-contrast="none">brainycp</span></a><span data-contrast="auto"> (Russian), </span><a href="https://www.natanetwork.com/portal/knowledgebase/383/Menghapus-maleware-perfctl-di-VPS-Linux.html?language=english" target="_blank" rel="noopener"><span data-contrast="none">natnetwork</span></a><span data-contrast="auto"> (Indonesian), </span><a href="https://forum.proxmox.com/threads/cpu-auslastung-bei-100-trotz-niedriger-last.125196/" target="_blank" rel="noopener"><span data-contrast="none">Proxmox</span></a><span data-contrast="auto"> (Deutsch), </span><a href="https://blog.camel2243.com/posts/security-perfctl-malware-cpu-memory/" target="_blank" rel="noopener"><span data-contrast="none">Camel2243</span></a><span data-contrast="auto"> (Chinese), </span><a href="https://svrforum.com/software/1680420" target="_blank" rel="noopener"><span data-contrast="none">svrforum</span></a><span data-contrast="auto"> (Korean), </span><a href="https://support.exabytes.co.id/en/support/solutions/articles/14000146571-guide-on-how-to-remove-perfctl-maleware-on-linux-vps" target="_blank" rel="noopener"><span data-contrast="none">exabytes</span></a><span data-contrast="auto">, </span><a href="https://forum.virtualmin.com/t/perfctl-uses-100-cpu-usage/117873" target="_blank" rel="noopener"><span data-contrast="none">virtualmin</span></a><span data-contrast="auto">, </span><a href="https://serverfault.com/questions/1095192/100-cpu-load-caused-by-service-perfctl" target="_blank" rel="noopener"><span data-contrast="none">serverfault</span></a><span data-contrast="auto"> and many others.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">The name <code>perfctl</code> comes from the cryptominer process that drains the system’s resources, causing significant issues for many Linux developers. By combining “perf” (a Linux performance monitoring tool) with “ctl” (commonly used to indicate control in command-line tools), the malware authors crafted a name that appears legitimate. This makes it easier for users or administrators to overlook during initial investigations, as it blends in with typical system processes.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">Towards the end of our research, we saw the first </span><a href="https://www.cadosecurity.com/blog/from-automation-to-exploitation-the-growing-misuse-of-selenium-grid-for-cryptomining-and-proxyjacking" target="_blank" rel="noopener"><span data-contrast="none">report</span></a><span data-contrast="auto"> covered by the researchers of Cado Security, but they only tell a very small part of the story of perfctl malware.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span>
</p></div>

<div id="section_wrap_2">
<h3 aria-level="2"><span data-contrast="none">The Attack Flow</span><span data-ccp-props="{&#34;134245418&#34;:true,&#34;134245529&#34;:true,&#34;201341983&#34;:0,&#34;335559738&#34;:40,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></h3>
<p><span data-contrast="auto">After exploiting a vulnerability (as in our case) or a misconfiguration, the main payload is downloaded from an HTTP server controlled by the attacker.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">In our case, the main payload was named <code>httpd</code>, and it demonstrated multiple layers of execution, showcasing a deliberate design to ensure persistence and evade detection. Once executed, the main payload copies itself from memory to a new location in the ‘/tmp’ directory, runs the new binary from there, terminates the original process, and then deletes the initial binary to cover its tracks.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">The main payload is now executed from the <code>/tmp</code> directory under a different name. Based on what we’ve seen the malware chose the name of the process that originally executed it, thus it looks less suspicious, if the system is examined.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">In our case the malware was executed by <code>sh</code>, thus the name of the malware was changed from <code>httpd</code> to <code>sh</code>. At this point, it functions as both a dropper and a local command-and-control (C2) process. The malware contains an exploit to CVE-2021-4043, which it is trying to run in order to gain root privilege on the server.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">The malware continues to copy itself from memory to half a dozen other locations, with names that appear as conventional system files. It also drops a rootkit and a few popular Linux utilities that were modified to serve as user land rootkits (i.e. ldd, lsof). A cryptominer is also dropped and in some executions, we also observed some proxy-jacking software transferred from a remote server and executed. </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">As part of its command-and-control operation, the malware opens a Unix socket, creates two directories under the <code>/tmp</code> directory, and stores data there that influences its operation. This data includes host events, locations of the copies of itself, process names, communication logs, tokens, and additional log information. Additionally, the malware uses environment variables to store data that further affects its execution and behavior.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">All the binaries are packed, stripped, and encrypted, indicating significant efforts to bypass defense mechanisms and hinder reverse engineering attempts. The malware also uses advanced evasion techniques, such as suspending its activity when it detects a new user in the <code>btmp</code> or <code>utmp</code> files and terminating any competing malware to maintain control over the infected system.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">Below is the complete attack flow:</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22907"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_1-3.jpg"><img fetchpriority="high" decoding="async" aria-describedby="caption-attachment-22907" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_1-3.jpg" alt=" The entire attack flow" width="1000" height="673" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_1-3.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_1-3-300x202.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_1-3-1024x689.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_1-3-768x517.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_1-3-140x94.jpg 140w" sizes="(max-width: 1000px) 100vw, 1000px"/></a></p><p id="caption-attachment-22907">Figure 1: The entire attack flow</p></div>
<p><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span>As noted earlier, </span><span>numerous</span><span> files are written to disk</span><span> or </span><span>modified</span><span>, primarily in the <code>/</code></span><code><span>tmp</span></code><span>,</span><span> <code>/</code></span><code><span>usr</span></code><span>,</span><span> and <code>/root</code> directories, as shown in the diagram below.</span></span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22820"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_2-1.jpg"><img decoding="async" aria-describedby="caption-attachment-22820" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_2-1.jpg" alt="Files dropped or written to disk " width="1000" height="448" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_2-1.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_2-1-300x134.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_2-1-1024x459.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_2-1-768x344.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_2-1-140x63.jpg 140w" sizes="(max-width: 1000px) 100vw, 1000px"/></a></p><p id="caption-attachment-22820">Figure 2: Files dropped or written to disk</p></div>
<p><span data-contrast="auto">In this blog and its appendices, we will explain the purpose of these files and the role each plays in the attack flow.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span>
</p></div>

<div id="section_wrap_3">
<h3 aria-level="2"><span data-contrast="none">Perfctl Attack Highlights</span><span data-ccp-props="{&#34;134245418&#34;:true,&#34;134245529&#34;:true,&#34;201341983&#34;:0,&#34;335559738&#34;:40,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></h3>
<p><span data-contrast="auto">The main binary <code>httpd</code> is a packed, stripped and obfuscated <code>ELF (MD5: 656e22c65bf7c04d87b5afbe52b8d800)</code>. If you type the download url in the browser the integer <code>1</code> is printed to screen. If you try downloading the <code>.php</code> file without a specific user agent, you will receive a file with the integer <code>1</code>. This response indicates that this file is completely innocent. But if you use the correct user agent it will drop the malware (size of ~9mb). This is a clever way to conceal the malware.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">After it is downloaded and executed the malware copies itself from memory using another running process name, and it saves the process ID of that running process under <code>/tmp/.apid</code>.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22821"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_3-1.jpg"><img decoding="async" aria-describedby="caption-attachment-22821" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_3-1.jpg" alt="httpd is copying itself from memory" width="1400" height="68" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_3-1.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_3-1-300x15.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_3-1-1024x50.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_3-1-768x37.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_3-1-140x7.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22821">Figure 3: httpd is copying itself from memory</p></div>
<p><span data-contrast="auto"><code>Httpd</code> then stops and deletes itself. This technique is called ‘process masquerading’ or ‘process replacement’ and it’s done for defense evasion and obfuscation. It can make security researchers life a bit harder to follow the malware execution flow.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">The new Httpd binary is now saved in the <code>/tmp</code> directory under the name of the process that executed it <code>sh</code> in our case, but we’ve also seen other names when we used other processes to run it. The binary <code>sh</code> is also copying itself from memory to various locations, as it saves itself as </span><code>libpprocps.so</code><span data-contrast="auto"> and also as <code>/root/.config/cron/perfcc</code>,  <code>/usr/bin/perfcc</code>, and </span><code>/usr/lib/libfsnkdev.so</code><span data-contrast="auto">. In annex 3 – The main payload below, we discuss in detail about this and explain our hypothesis to why the threat actor chose these names. This shows of a thought in regard to persistence as the malware author creates a lot of locations to which the malware is copied.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<h4 aria-level="3">Persistence<span data-ccp-props="{&#34;134245418&#34;:true,&#34;134245529&#34;:true,&#34;201341983&#34;:0,&#34;335559738&#34;:40,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></h4>
<p><span data-contrast="auto">The attacker modifies the <code>~/.profile</code> script, which sets up the environment during user login. This script is designed to execute the malware first, followed by the legitimate workload expected to run on the server. It checks if <code>/root/.config/cron/perfcc</code> is an executable file, and if so, it runs the malware. </span></p>
<p><span data-contrast="auto">Additionally, the script ensures that in Bash environments, the <code>~/.bashrc</code> file is executed, applying user-specific configurations such as aliases and environment variables—likely to maintain normal server operations while the malware runs. Finally, the script suppresses <code>mesg</code> errors to avoid any visible warnings during execution.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">The binary <code>wizlmsh</code> is dropped to <code>/usr/bin</code> (MD5: ba120e9c7f8896d9148ad37f02b0e3cb). It is a very small binary (12kb), that runs as a service in the background. Initially, it receives argc, and argv, and verify the execution of main payload (httpd) after it is written into <code>/tmp</code> either as <code>sh</code> or <code>bash</code> or any other name. It is responsible for the persistence of perfctl malware.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22822"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_4-1.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22822" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_4-1.jpg" alt="wizlmsh main function " width="1000" height="876" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_4-1.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_4-1-300x263.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_4-1-1024x897.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_4-1-768x673.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_4-1-140x123.jpg 140w" sizes="(max-width: 1000px) 100vw, 1000px"/></a></p><p id="caption-attachment-22822">Figure 4: wizlmsh main function</p></div>
<h4 aria-level="3">Defense Evasion</h4>
<p><span data-contrast="auto">The rootkit has several purposes. One of the main purposes is to hook various functions and modify their functionality. The rootkit itself is an ELF 64-bit LSB shared object (.so) file named <code>libgcwrap.so</code> (MD5: 835a9a6908409a67e51bce69f80dd58a). The rootkit is using LD_PRELOAD to load itself before other libraries. </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22823"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_5-1.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22823" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_5-1.jpg" alt="The revised LD_Preload content" width="1400" height="68" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_5-1.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_5-1-300x15.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_5-1-1024x50.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_5-1-768x37.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_5-1-140x7.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22823">Figure 5: The revised LD_Preload content</p></div>
<p><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span>It does various interesting manipulations, including hooking to </span><span>Libpam</span><span> symbols. Specifically, to the function </span><code><span>pam_authenticate</span></code><span>, which is used by PAM to authenticate users. Hooking or overwriting this function could allow unauthorized actions during the authentication process, such as bypassing password checks, logging credentials, or </span><span>modifying</span><span> the behavior of authentication mechanisms.</span></span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22824"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_6-1.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22824" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_6-1-685x1024.jpg" alt="Functions the rootkit hooks " width="685" height="1024" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_6-1-685x1024.jpg 685w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_6-1-201x300.jpg 201w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_6-1-768x1148.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_6-1-1027x1536.jpg 1027w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_6-1-1370x2048.jpg 1370w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_6-1-94x140.jpg 94w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_6-1.jpg 1400w" sizes="(max-width: 685px) 100vw, 685px"/></a></p><p id="caption-attachment-22824">Figure 6: Functions the rootkit hooks</p></div>
<p><span data-contrast="auto"><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span>Libpcap</span><span> symbols, specifically to the function </span><code><span>pcap_loop</span></code><span>, which is widely used for capturing network </span></span><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span>traffic</span><span>. </span><span>This is used to </span><span>prevent recording of the malware traffic.</span></span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span> </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">The threat actors are also using a few user land rootkits. They drop a few legitimate utilities such as <code>ldd</code>. These utilities were modified to hide specific attack elements. So, if the rigged crontab is used, for instance, it won’t show cron jobs created during the attack. </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">In the first step the malware replaces the <code>/etc/profile</code> so the path will be set on <code>/bin/.local/bin:$PATH</code>. In this path the threat actor is bypassing the directory where the utilities are called from. We’ve seen in some malware runs 2 binaries and in other 4 binaries, depending on which utilities exist originally on the server. </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">In our attacks the malware dropped <code>crontab</code>, <code>lsof</code>, <code>ldd</code> and <code>top</code>. These tweaked binaries will hide malicious activities, in case someone is using them. </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22825"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_7-1.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22825" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_7-1.jpg" alt="The new content inserted by the threat actor to ‘/etc/profile’ " width="1400" height="64" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_7-1.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_7-1-300x14.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_7-1-1024x47.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_7-1-768x35.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_7-1-140x6.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22825">Figure 7: The new content inserted by the threat actor to ‘/etc/profile’</p></div>
<p><span data-contrast="auto">In appendix 5 – User land rootkits we explain in detail why we think these utilities were chosen by the threat actor.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<h4 aria-level="3">Main Impact</h4>
<p><span data-contrast="auto">The main impact of the attack is resource hijacking. In all cases we observed a monero cryptominer (XMRIG) executed and exhausting the server’s CPU resources. The cryptominer is also packed and encrypted. Once unpacked and decrypted it communicates with cryptomining pools.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">As reflected in Figure 8 below, the cryptomining pools are accessed via TOR.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22826"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_8-1.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22826" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_8-1.jpg" alt="Cryptomining traffic " width="1400" height="217" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_8-1.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_8-1-300x47.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_8-1-1024x159.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_8-1-768x119.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_8-1-140x22.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22826">Figure 8: Cryptomining traffic</p></div>
<p><span data-contrast="auto">Moreover, in some of the attacks we’ve seen </span><code><a href="https://www.aquasec.com/blog/cryptojacking-cloud-network-bandwidth/"><span data-contrast="none">proxy-jacking</span></a></code><span data-contrast="auto"> via various vendors. We’ve seen the communication with the following domains: <code>bitping.com</code>, <code>earn.fm</code>, <code>speedshare.app</code>, and <code>repocket.com</code>.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">The domain repocket.com, for instance, is associated with the Repocket platform, which is a service that allows users to earn money by sharing their unused internet bandwidth. </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">In addition, we can observe the usage of the bitping daemon usage, which provide similar bandwidth payment services.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22910"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_9-1.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22910" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_9-1.jpg" alt="Logging in to bitping " width="1002" height="68" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_9-1.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_9-1-300x20.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_9-1-1024x69.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_9-1-768x52.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_9-1-140x10.jpg 140w" sizes="(max-width: 1002px) 100vw, 1002px"/></a></p><p id="caption-attachment-22910">Figure 9: Logging in to bitping</p></div>
<h4 aria-level="3">TOR communication</h4>
<p><span data-contrast="auto">The binary <code>sh</code> is also initiating communication via Tor with few servers (i.e. 80.67.172.162, 176.10.107.180, 78.47.18.110, 95.217.109.36, 145.239.41.102).</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">While the communication is encrypted, you can observe the TOR log left on our honeypot.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22827"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_10-1.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22827" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_10-1.jpg" alt="TOR sessions log" width="999" height="309" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_10-1.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_10-1-300x93.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_10-1-1024x317.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_10-1-768x238.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_10-1-140x43.jpg 140w" sizes="(max-width: 999px) 100vw, 999px"/></a></p><p id="caption-attachment-22827">Figure 10: TOR sessions log</p></div>
</div>

<div id="section_wrap_4">
<h3 aria-level="2"><span data-contrast="none">Additional Threat Intelligence</span><span data-ccp-props="{&#34;134245418&#34;:true,&#34;134245529&#34;:true,&#34;201341983&#34;:0,&#34;335559738&#34;:40,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></h3>
<p><span data-contrast="auto">We recorded several dozen attacks of perfctl. We saw 3 download servers involved in these attacks (46.101.139.173, 104.183.100.189 and 198.211.126.180). </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">The first two IP addresses seem to be linked to vulnerable servers that were previously hacked by the threat actor and the third one could be owned by the threat actor. All 3 IP addresses store and hide artifacts used in this campaign. </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">In most of the attacks we see that the binaries were dropped from IP address 46.101.139.173. An inspection of this IP address showed that this is a compromised webserver.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22829"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_12-1.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22829" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_12-1.jpg" alt="Compromised website serves as download server " width="999" height="489" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_12-1.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_12-1-300x147.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_12-1-1024x501.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_12-1-768x376.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_12-1-140x69.jpg 140w" sizes="(max-width: 999px) 100vw, 999px"/></a></p><p id="caption-attachment-22829">Figure 11: Compromised website serves as download server</p></div>
<p><span data-contrast="auto">Iterating over this download server, we see a compromised site on a server in Germany.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">We noticed some artifacts, well-hidden between the site’s scripts. We see 3 main payloads. One is avatar.php, which was used as part of the attack on our honeypot. When using the browser to reach to the webpage with avatar.php or downloading it without a specific user agent leads to <code>1</code> being displayed of screen or a <code>.php</code> file with the digit <code>1</code>. </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">In addition, there is another file named <code>aoip</code>, which was uploaded 2 months later and two others <code>dark.css</code> and <code>csdark.css</code> which were uploaded later.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22831"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_13-1.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22831" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_13-1-851x1024.jpg" alt="Files hosted on the webserver " width="600" height="722" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_13-1-851x1024.jpg 851w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_13-1-249x300.jpg 249w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_13-1-768x924.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_13-1-1277x1536.jpg 1277w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_13-1-116x140.jpg 116w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_13-1.jpg 1400w" sizes="(max-width: 600px) 100vw, 600px"/></a></p><p id="caption-attachment-22831">Figure 12: Files hosted on the webserver</p></div>

<div id="attachment_22832"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_14-1.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22832" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_14-1-1024x915.jpg" alt="Files hosted on the webserver " width="600" height="536" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_14-1-1024x915.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_14-1-300x268.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_14-1-768x686.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_14-1-140x125.jpg 140w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_14-1.jpg 1400w" sizes="(max-width: 600px) 100vw, 600px"/></a></p><p id="caption-attachment-22832">Figure 13: Files hosted on the webserver</p></div>

<div id="attachment_22830"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_15.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22830" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_15-1024x829.jpg" alt="Files hosted on the webserver " width="601" height="486" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_15-1024x829.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_15-300x243.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_15-768x622.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_15-140x113.jpg 140w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_15.jpg 1400w" sizes="(max-width: 601px) 100vw, 601px"/></a></p><p id="caption-attachment-22830">Figure 14: Files hosted on the webserver</p></div>
<p><span data-contrast="auto">The binary aoip is a replication of the main payload (<code>sh</code>/<code>httpd</code>).</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">Csdark.css and dark.css weren’t analyzed during this research but look very interesting.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">On IP address 198.211.126.180 we found just the file <code>checklist.php</code> which is the main payload (<code>sh</code>/<code>httpd</code>).</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22833"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_16.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22833" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_16.jpg" alt="Compromised website serves as download server " width="999" height="576" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_16.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_16-300x173.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_16-1024x590.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_16-768x443.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_16-140x81.jpg 140w" sizes="(max-width: 999px) 100vw, 999px"/></a></p><p id="caption-attachment-22833">Figure 15: Compromised website serves as download server</p></div>
<p><span data-contrast="auto">On IP address 104.183.100.189 we found another innocent compromised website.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22834"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_17.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22834" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_17.jpg" alt="Compromised website serves as download server " width="1000" height="579" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_17.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_17-300x174.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_17-1024x593.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_17-768x445.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_17-140x81.jpg 140w" sizes="(max-width: 1000px) 100vw, 1000px"/></a></p><p id="caption-attachment-22834">Figure 16: Compromised website serves as download server</p></div>
<p><span data-contrast="auto">It looks like this website stores this XML file which when decoded (base64) is actually the <code>rconf</code> script. </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22836"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_18.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22836" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_18.jpg" alt="malicious XML " width="1001" height="203" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_18.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_18-300x61.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_18-1024x208.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_18-768x156.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_18-140x28.jpg 140w" sizes="(max-width: 1001px) 100vw, 1001px"/></a></p><p id="caption-attachment-22836">Figure 17: malicious XML</p></div>
<p><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span>From what we see </span><span>on</span><span> th</span><span>ese</span><span> website</span><span>s</span><span>, there </span><span>are few artifacts used to execute the </span><span>exploitation of </span><span>misconfigured and vulnerable (in our recorded attacks) Linux servers.</span><span> We </span><span>identified</span> <span>a</span><span> very long</span><span> list of almost 20K </span><span>directory traversal fuzzing list</span><span>, </span><span>seeking</span><span> for </span><span>mistakenly exposed configuration files and secrets</span><span>.</span><span> There are also a couple of</span><span> follo</span><span>w-up files </span><span>(such as </span><span>the XML</span><span>) the attacker </span> <span>t</span><span>o</span><span> exploit </span><span>the </span><span>misconfiguration</span><span>. </span><span>In the table </span><span>below you can see the analysis of the paths, which shows that </span><span>perfctl</span><span> is </span><span>mainly looking</span><span> to exploit misconfigurations.</span> </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<table>
<tbody>
<tr aria-rowindex="1">
<td data-celllook="0"><b><span data-contrast="auto">Category</span></b><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335551550&#34;:2,&#34;335551620&#34;:2,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
<td data-celllook="0"><b><span data-contrast="auto">Count of Paths</span></b><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335551550&#34;:2,&#34;335551620&#34;:2,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
<td data-celllook="0"><b><span data-contrast="auto">Example Paths</span></b><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335551550&#34;:2,&#34;335551620&#34;:2,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
<td data-celllook="0"><b><span data-contrast="auto">Potential Vulnerability</span></b><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335551550&#34;:2,&#34;335551620&#34;:2,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
</tr>
<tr aria-rowindex="2">
<td data-celllook="0"><span data-contrast="auto">Credentials</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
<td data-celllook="0"><span data-contrast="auto">1,717</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
<td data-celllook="0"><span data-contrast="auto">/access_credentials.json, /access_keys.json, /accesskeys.php</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
<td data-celllook="0"><span data-contrast="auto">Potential for unauthorized access to credentials, sensitive token or key exposure</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
</tr>
<tr aria-rowindex="3">
<td data-celllook="0"><span data-contrast="auto">Configuration</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
<td data-celllook="0"><span data-contrast="auto">12,196</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
<td data-celllook="0"><span data-contrast="auto">Typical files include .conf, .ini, .json, .xml configurations</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
<td data-celllook="0"><span data-contrast="auto">Misconfigurations could lead to security weaknesses</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
</tr>
<tr aria-rowindex="4">
<td data-celllook="0"><span data-contrast="auto">Login</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
<td data-celllook="0"><span data-contrast="auto">1,362</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
<td data-celllook="0"><span data-contrast="auto">Paths include login, auth, signin, admin related files</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
<td data-celllook="0"><span data-contrast="auto">Risks of unauthorized access through login interfaces</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
</tr>
<tr aria-rowindex="5">
<td data-celllook="0"><span data-contrast="auto">Unknown</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
<td data-celllook="0"><span data-contrast="auto">4,647</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
<td data-celllook="0"><span data-contrast="auto">Paths not fitting the above categories</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
<td data-celllook="0"><span data-contrast="auto">Unknown, requires further investigation</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></td>
</tr>
</tbody>
</table>
</div>

<div id="section_wrap_5">
<h3><span data-contrast="none">Detection of “Perfctl” Malware</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></h3>
<p><span data-contrast="auto">To detect Perfctl malware you look for unusual spikes in CPU usage, or system slowdown if the rootkit has been deployed on your server. These may indicate cryptomining activities, especially during idle times.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<h4 aria-level="3">Monitoring Suspicious System Behavior</h4>
<ol>
<li><span data-contrast="auto">Inspect <code>/tmp</code>, <code>/usr</code>, and <code>/root</code> directories for suspicious binaries, especially hidden or masquerading as system files (e.g., <code>perfctl</code>, <code>sh</code>, <code>libpprocps.so</code>, <code>perfcc</code>, <code>libfsnkdev.so</code>). Inspect your <code>/home</code> directory, look for <code>/.local/bin</code> directory with various utilities installed such as <code>ldd</code>, <code>top</code> etc.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></li>
<li data-leveltext="%1." data-font="Calibri" data-listid="34" data-list-defn-props="{&#34;335552541&#34;:0,&#34;335559685&#34;:360,&#34;335559991&#34;:360,&#34;469769242&#34;:[65533,0],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;%1.&#34;,&#34;469777815&#34;:&#34;multilevel&#34;,&#34;469778510&#34;:&#34;default&#34;}" aria-setsize="-1" data-aria-posinset="2" data-aria-level="1"><span data-contrast="auto">Monitor processes for high resource usage, such as binaries like <code>httpd</code> or <code>sh</code> behaving unusually or running from unexpected locations like <code>/tmp</code>.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></li>
<li data-leveltext="%1." data-font="Calibri" data-listid="34" data-list-defn-props="{&#34;335552541&#34;:0,&#34;335559685&#34;:360,&#34;335559991&#34;:360,&#34;469769242&#34;:[65533,0],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;%1.&#34;,&#34;469777815&#34;:&#34;multilevel&#34;,&#34;469778510&#34;:&#34;default&#34;}" aria-setsize="-1" data-aria-posinset="2" data-aria-level="1"><span data-contrast="auto">Check system logs for modifications to <code>~/.profile</code>, and <code>/etc/ld.so.preload</code> files.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></li>
</ol>
<h4 aria-level="3">Network Traffic Analysis</h4>
<ol>
<li data-leveltext="%1." data-font="Calibri" data-listid="35" data-list-defn-props="{&#34;335552541&#34;:0,&#34;335559685&#34;:360,&#34;335559991&#34;:360,&#34;469769242&#34;:[65533,0],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;%1.&#34;,&#34;469777815&#34;:&#34;multilevel&#34;,&#34;469778510&#34;:&#34;default&#34;}" aria-setsize="-1" data-aria-posinset="1" data-aria-level="1"><span data-contrast="auto">Capture network traffic to detect TOR-based communication to external IPs like <code>80.67.172.162</code>, <code>176.10.107.180</code>, etc.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></li>
<li data-leveltext="%1." data-font="Calibri" data-listid="35" data-list-defn-props="{&#34;335552541&#34;:0,&#34;335559685&#34;:360,&#34;335559991&#34;:360,&#34;469769242&#34;:[65533,0],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;%1.&#34;,&#34;469777815&#34;:&#34;multilevel&#34;,&#34;469778510&#34;:&#34;default&#34;}" aria-setsize="-1" data-aria-posinset="1" data-aria-level="1"><span data-contrast="auto">Look for outbound connections to cryptomining pools or proxy-jacking services.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></li>
<li data-leveltext="%1." data-font="Calibri" data-listid="35" data-list-defn-props="{&#34;335552541&#34;:0,&#34;335559685&#34;:360,&#34;335559991&#34;:360,&#34;469769242&#34;:[65533,0],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;%1.&#34;,&#34;469777815&#34;:&#34;multilevel&#34;,&#34;469778510&#34;:&#34;default&#34;}" aria-setsize="-1" data-aria-posinset="1" data-aria-level="1"><span data-contrast="auto">Monitor traffic to known malicious hosts or IPs (e.g., <code>46.101.139.173</code>, <code>104.183.100.189</code>, and <code>198.211.126.180</code>).</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></li>
</ol>
<h4 aria-level="3">File and Process Integrity Monitoring</h4>
<p><span data-contrast="auto">Detect modifications in key system utilities like <code>ldd</code>, <code>top</code>, <code>lsof</code>, and <code>crontab</code>, which might have been replaced with trojanized versions.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<h4 aria-level="3">Log Analysis</h4>
<p><span data-contrast="auto">Review logs for unauthorized use of system binaries, presence of suspicious cron jobs, and errors in <code>mesg</code> to detect possible tampering.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span>
</p></div>

<div id="section_wrap_6">
<h2><span data-contrast="none">Detection of “Perfctl” Malware with Aqua Security</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></h2>
<p><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span>First</span><span>,</span> <span>we can see some runtime incidents</span></span><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span>. Below you can see </span><span>alerts </span><span>indicating</span><span> some new binaries were dropped and executed, meaning a drift in our container, in addition to shared object dropped during runtime. These are the </span><span>a</span><span>dditional</span><span> httpd malware files and the rootkit.</span></span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22837"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22837" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19.jpg" alt="Incidents screen on Aqua Security Platform " width="1000" height="628" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19-300x188.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19-1024x643.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19-768x482.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19-140x88.jpg 140w" sizes="(max-width: 1000px) 100vw, 1000px"/></a></p><p id="caption-attachment-22837">Figure 18: Incidents screen on Aqua Security Platform</p></div>
<p><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span>We can continue the investigation of this attack by examining the audit logs of these incidents.</span> <span>During this incident there were a</span><span>bove 22K audit </span><span>events, thus we will need to </span><span>search for specific events, </span><span>namely,</span><span> to investigate the attack.</span><span> </span></span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22882"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19a.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22882" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19a.jpg" alt="Audit logs screen on Aqua Security Platform " width="1001" height="629" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19a.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19a-300x189.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19a-1024x644.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19a-768x483.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19a-140x88.jpg 140w" sizes="(max-width: 1001px) 100vw, 1001px"/></a></p><p id="caption-attachment-22882">Figure 19: Audit logs screen on Aqua Security Platform</p></div>
<p><span lang="EN-US" xml:lang="EN-US" data-contrast="auto">We can filter on specific hosts, containers, enforce groups, cloud resources or even pods. We decided to search for specific events based on the MITRE framework. We used the masquerading technique which is used to describe dropped and executed events. There were 465 incidents, we can now go over all the files that were dropped (or modified) during the attack.</span></p>
<div id="attachment_22883"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19b.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22883" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19b.jpg" alt="Audit logs screen on Aqua Security Platform " width="1000" height="593" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19b.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19b-300x178.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19b-1024x607.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19b-768x455.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19b-140x83.jpg 140w" sizes="(max-width: 1000px) 100vw, 1000px"/></a></p><p id="caption-attachment-22883">Figure 20: Audit logs screen on Aqua Security Platform</p></div>
<p><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span>We can learn for instance about the swapping of </span><span>some binaries with user land rootkits.</span><span> </span></span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22884"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19c.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22884" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19c.jpg" alt="Audit logs screen on Aqua Security Platform " width="999" height="277" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19c.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19c-300x83.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19c-1024x284.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19c-768x213.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19c-140x39.jpg 140w" sizes="(max-width: 999px) 100vw, 999px"/></a></p><p id="caption-attachment-22884">Figure 21: Audit logs screen on Aqua Security Platform</p></div>
<p><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span>You can also learn about inbound traffic or </span><span>setting up port listening.</span></span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22885"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19d.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22885" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19d.jpg" alt="Audit logs screen on Aqua Security Platform " width="1000" height="593" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19d.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19d-300x178.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19d-1024x607.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19d-768x455.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_19d-140x83.jpg 140w" sizes="(max-width: 1000px) 100vw, 1000px"/></a></p><p id="caption-attachment-22885">Figure 22: Audit logs screen on Aqua Security Platform</p></div>
</div>

<div id="section_wrap_7">
<h3><span data-contrast="none">Mitigation of “Perfctl” Malware</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></h3>
<ol>
<li><span data-contrast="auto">Patch Vulnerabilities: Ensure that all vulnerabilities are patched. Particularly internet facing applications such as RocketMQ servers and CVE-2021-4043 (Polkit). Keep all software and system libraries up to date.</span></li>
<li>Restrict File Execution: Set <b><i><span data-contrast="auto">noexec</span></i></b><span data-contrast="auto"> on <code><span>/</span><span>tmp</span></code><span>, <code>/dev/</code></span><code><span>shm</span></code> and other writable directories to prevent malware from executing binaries directly from these locations.</span></li>
<li>Disable Unused Services: Disable any services that aren’t required, particularly those that may expose the system to external attackers, such as HTTP services.</li>
<li>Implement Strict Privilege Management: Restrict root access to critical files and directories. Use Role-Based Access Control (RBAC) to limit what users and processes can access or modify.</li>
<li>Network Segmentation: Isolate critical servers from the internet or use firewalls to restrict outbound communication, especially TOR traffic or connections to cryptomining pools.<span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></li>
<li><span data-contrast="auto">Deploy Runtime Protection: Use advanced anti-malware and behavioral detection tools that can detect rootkits, cryptominers, and fileless malware like <code>perfctl</code>.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></li>
</ol>
</div>

<div id="section_wrap_8">
<h3><span data-ccp-props="{&#34;134245418&#34;:true,&#34;134245529&#34;:true,&#34;201341983&#34;:0,&#34;335551550&#34;:2,&#34;335551620&#34;:2,&#34;335559738&#34;:40,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"><span lang="EN-US" xml:lang="EN-US" data-contrast="none"><span data-ccp-parastyle="heading 2">Appendices</span></span><span data-ccp-props="{&#34;134245418&#34;:true,&#34;134245529&#34;:true,&#34;201341983&#34;:0,&#34;335551550&#34;:2,&#34;335551620&#34;:2,&#34;335559738&#34;:40,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span> </span></h3>
<h4 aria-level="3">Appendix 1: Initial Access</h4>
<p><span data-contrast="auto">CVE-2023-33246 is a vulnerability found in <code>RocketMQ</code>, which is a software that manages messages. This vulnerability allows unauthorized execution of commands on systems where <code>RocketMQ</code> is installed. This issue occurs because RocketMQ does not adequately check who is trying to access it, which means anyone, even without permission, can make changes or execute commands. The problem is made worse because the parts of <code>RocketMQ</code> that handle storing and delivering messages were not designed to be directly accessible over the internet, and they don’t require authentication for performing sensitive operations like updating settings. This makes it relatively easy for attackers to exploit this vulnerability.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">The initial access was gained via this vulnerability (CVE-2023-33246), led to download and execution of the shell script <code>rconf</code> with the following command: </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22838"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_20.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22838" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_20.jpg" alt="Execution script " width="1400" height="84" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_20.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_20-300x18.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_20-1024x61.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_20-768x46.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_20-140x8.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22838">Figure 23: Execution script</p></div>
<p><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span>In Figure </span><span>24</span><span> below, you can </span><span>observe</span><span> the entire </span><code><span>rconf</span></code><span> script, next we will do a breakdown and explanation of the content. </span></span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22886"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_21.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22886" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_21.jpg" alt="The rconf script " width="1400" height="1946" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_21.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_21-216x300.jpg 216w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_21-737x1024.jpg 737w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_21-768x1068.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_21-1105x1536.jpg 1105w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_21-101x140.jpg 101w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22886">Figure 24: The rconf script</p></div>
<h4 aria-level="3">Appendix 2: Execution Script Analysis</h4>
<p><span data-contrast="auto">As depicted in Figure </span><span data-contrast="auto">25</span><span data-contrast="auto"> below, the script starts with a function that appears to perform a simplified HTTP GET request using a TCP socket directly, mimicking some basic behavior of the </span><span data-contrast="auto">curl</span><span data-contrast="auto"> command. The threat actor is using this, in case the targeted server doesn’t contain curl or wget.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22887"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_22.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22887" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_22.jpg" alt="A snippet from the rconf script, illustrating implementation of a HHTP get request command " width="1400" height="404" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_22.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_22-300x87.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_22-1024x295.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_22-768x222.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_22-140x40.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22887">Figure 25: A snippet from the rconf script, illustrating implementation of a HHTP get request command</p></div>
<p><span>As you can see in Figure </span><span>26</span><span> below, the script continues with a simple if condition, that will ensure that the targeted attacked server OS architecture is x86_64. This shows that the threat actor is targeting specific architecture and </span><span>won’t</span><span> run on arm for instance.</span></p>
<div id="attachment_22888"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_23.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22888" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_23.jpg" alt="A snippet from the rconf script, illustrating inspection of the targeted host architecture " width="1400" height="104" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_23.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_23-300x22.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_23-1024x76.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_23-768x57.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_23-140x10.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22888">Figure 26: A snippet from the rconf script, illustrating inspection of the targeted host architecture</p></div>
<p><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span>Next, the threat actor verifies that the <code>/</code></span><code><span>tmp</span></code><span> directory exists and has read, write, and execute permissions. This directory will be used later to </span><span>store</span><span> logs, which the malware will update and from which the malware will read instructions or system status.</span></span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22890"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_24.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22890" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_24.jpg" alt="A snippet from the ‘rconf’ script, illustrating inspection the ‘/tmp’ path " width="1400" height="144" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_24.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_24-300x31.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_24-1024x105.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_24-768x79.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_24-140x14.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22890">Figure 27: A snippet from the ‘rconf’ script, illustrating inspection the ‘/tmp’ path</p></div>
<p><span data-contrast="auto">As illustrated in Figure 28 below, the threat actor also verifies that the <code>/tmp</code> directory is mounted with executable permissions. If the noexec option is found in the mount options (no execution permissions), it remounts <code>/tmp</code> with the exec option, allowing execution of binaries from the <code>/tmp</code> directory. This might be necessary for scripts or applications that require executing temporary files stored in <code>/tmp</code>.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22891"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_25.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22891" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_25.jpg" alt="A snippet from the ‘rconf’ script, illustrating further inspection of the ‘/tmp’ directory " width="1400" height="104" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_25.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_25-300x22.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_25-1024x76.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_25-768x57.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_25-140x10.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22891">Figure 28: A snippet from the ‘rconf’ script, illustrating further inspection of the ‘/tmp’ directory</p></div>
<p><span data-contrast="auto">In addition, the threat actor is creating two directories under <code>/tmp</code> path, which will be used later as auxiliary when running the main payload.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22892"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_26.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22892" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_26.jpg" alt=" A snippet from the ‘rconf’ script, illustrating creation of directories under the ‘/tmp’ path " width="1400" height="84" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_26.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_26-300x18.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_26-1024x61.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_26-768x46.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_26-140x8.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22892">Figure 29: A snippet from the ‘rconf’ script, illustrating creation of directories under the ‘/tmp’ path</p></div>
<p><span data-contrast="auto">Next the threat actor is setting the environment variable </span><code><span data-contrast="auto">A2ZNODE</span></code><span data-contrast="auto"> to </span><code><span data-contrast="auto">localhost</span></code><span data-contrast="auto">, if it is not already defined. </span></p>
<div id="attachment_22893"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_27.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22893" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_27.jpg" alt="A snippet from the ‘rconf’ script, illustrating inspection of the environment variables " width="1400" height="144" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_27.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_27-300x31.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_27-1024x105.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_27-768x79.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_27-140x14.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22893">Figure 30: A snippet from the ‘rconf’ script, illustrating inspection of the environment variables</p></div>
<p><span data-contrast="auto">In addition, the threat actor is also setting the environment variable VEI to <code>rmq</code> which can stand for vulnerability exploited index to RocketMQ or something similar. Next, this script processes the </span><code><span data-contrast="auto">/tmp/.xdiag/vei</span></code><span data-contrast="auto"> file by appending the value of the </span><span data-contrast="auto">VEI</span><span data-contrast="auto"> variable (</span><code><span data-contrast="auto">rmq</span></code><span data-contrast="auto">) to it. If the file </span><code><span data-contrast="auto">/tmp/.xdiag/vei</span></code><span data-contrast="auto"> does not exist or is empty, it checks if a secondary file </span><code><span data-contrast="auto">/tmp/.xdiag/vei.1</span></code><span data-contrast="auto"> exists. If it does, the script processes the contents of </span><code><span data-contrast="auto">/tmp/.xdiag/vei</span></code><span data-contrast="auto">, sorts and removes duplicates, and appends the value of </span><span data-contrast="auto">VEI</span><span data-contrast="auto">. If </span><code><span data-contrast="auto">/tmp/.xdiag/vei.1</span></code><span data-contrast="auto"> does not exist, it directly writes the value of </span><span data-contrast="auto">VEI</span><span data-contrast="auto"> to </span><code><span data-contrast="auto">/tmp/.xdiag/vei</span></code><span data-contrast="auto">. Finally, it unsets the </span><span data-contrast="auto">VEI</span><span data-contrast="auto"> variable</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22894"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_28.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22894" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_28.jpg" alt="A snippet from the ‘rconf’ script, illustrating preparation of the ‘/tmp’ directory for the malware operation and logging " width="1400" height="344" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_28.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_28-300x74.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_28-1024x252.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_28-768x189.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_28-140x34.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22894">Figure 31: A snippet from the ‘rconf’ script, illustrating preparation of the ‘/tmp’ directory for the malware operation and logging</p></div>
<p><span data-contrast="auto">Finally, this script manages the installation of the main payload by ensuring no other instances are running, downloading the necessary file, and starting a web server. It uses either </span><span data-contrast="auto">curl</span><span data-contrast="auto">, </span><span data-contrast="auto">wget</span><span data-contrast="auto">, or the custom download function (mentioned above), verifies the downloaded file, and runs it if valid. The script also includes safeguards to prevent multiple installations from occurring simultaneously. This is important because the initial curl of this script <code>rconf</code> runs iteratively various times throughout the attack.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22895"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_29.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22895" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_29.jpg" alt="A snippet from the ‘rconf’ script, illustrating download and installation of the malware under the name ‘httpd’ " width="1400" height="825" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_29.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_29-300x177.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_29-1024x603.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_29-768x453.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_29-140x83.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22895">Figure 32: A snippet from the ‘rconf’ script, illustrating download and installation of the malware under the name ‘httpd’</p></div>
<p><span data-contrast="auto">Now the main payload <code>avatar.php</code> was downloaded, renamed to <code>httpd</code> and executed, we can focus on this binary.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<h4 aria-level="3">Appendix 3: The main payload (‘httpd’ and ‘sh’) analysis</h4>
<p><b><span data-contrast="auto">Analysis of httpd</span></b><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">The binary <code>httpd</code> is a packed ELF (<code>MD5: 656e22c65bf7c04d87b5afbe52b8d800</code>) bears many detections in VirusTotal, including general Linux Trojan, Coinminer, Exploitation tool for CVE-2021-4034, malware dropper etc.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">Our analysis shows that in a way all these detections are correct, as in a nutshell this is a multipurpose malware-dropper that contains all the above. Its operation is very interesting as it incorporates dozens of techniques to remain hidden and persistent. Based on our analysis below we speculate the campaign with this malware started about a year ago, and it remained quite anonymous and undetected.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">As per the main payload, it is named in the download server as avatar.php, after it is downloaded, it’s renamed to <code>httpd</code>. The machine is fingerprinted by various commands such as <code>uname −a</code>, then it starts unpacking itself. </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">Next, the <code>httpd</code> executable is copied from the running process into to <code>/tmp</code> directory, as illustrated in Figure 33 below. What’s interesting is that it finds the name of the process name that ran it, and saves itself under the <code>/tmp</code> directory with the same name. It also saves the pid under the <code>/tmp/.apid</code>. Lastly, <code>httpd</code> deletes itself.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22896"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_30.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22896" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_30.jpg" alt="httpd copies itself from memory " width="1400" height="64" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_30.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_30-300x14.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_30-1024x47.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_30-768x35.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_30-140x6.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22896">Figure 33: httpd copies itself from memory</p></div>
<p><span data-contrast="auto">This technique is called “process masquerading” or “process replacement”. It is often done for the following reasons:</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<ol>
<li data-leveltext="%1." data-font="Calibri" data-listid="27" data-list-defn-props="{&#34;335552541&#34;:0,&#34;335559685&#34;:360,&#34;335559991&#34;:360,&#34;469769242&#34;:[65533,0],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;%1.&#34;,&#34;469777815&#34;:&#34;multilevel&#34;,&#34;469778510&#34;:&#34;default&#34;}" aria-setsize="-1" data-aria-posinset="1" data-aria-level="1"><b><span data-contrast="auto">Defense Evasion</span></b><span data-contrast="auto">: By deleting the original binary and copying itself to another location, the malware avoids detection from static file-based security measures that might be monitoring the original location. The <code>/tmp</code> directory is a common target because it is typically writable and frequently used for temporary files, making it less suspicious.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></li>
<li data-leveltext="%1." data-font="Calibri" data-listid="27" data-list-defn-props="{&#34;335552541&#34;:0,&#34;335559685&#34;:360,&#34;335559991&#34;:360,&#34;469769242&#34;:[65533,0],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;%1.&#34;,&#34;469777815&#34;:&#34;multilevel&#34;,&#34;469778510&#34;:&#34;default&#34;}" aria-setsize="-1" data-aria-posinset="1" data-aria-level="1"><b><span data-contrast="auto">Obfuscation</span></b><span data-contrast="auto">: Deleting the original binary and killing itself can make it harder for security analysts to trace back the activity to the original payload, thereby complicating forensic analysis.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></li>
</ol>
<p><b><span data-contrast="auto">Analysis of sh</span></b><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">The binary <code>sh</code> (MD5: 656e22c65bf7c04d87b5afbe52b8d800) is an exact copy of <code>httpd</code>. After <code>sh</code> is executed, it sleeps for 10 minutes. Next it collects information about the OS. </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">Next, <code>sh</code> drops nine binaries. Four are exact duplication of <code>sh</code>/<code>httpd</code>. A cryptominer and a rootkit (discussed below in </span><span data-contrast="auto">‘The Rootkit’</span><span data-contrast="auto"> section). There are 3 lean binaries <code>ldd</code>, <code>top</code> and <code>wizlmsh</code>. <span dir="ltr">The first 2 are user land rootkits, in some executions we also saw <code>lsof</code> and <code>crontab</code>. <code>Wizlmsh</code> is used to ensure the malware is running.</span></span></p>
<p><span data-contrast="auto">The malware opens a Unix socket to communicate with all the process it will run in the future. Via <code>/tmp/.xdiag/int/.per.s</code>, it writes logs, which will later be used by other dropped components as part of the attack. </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">The malware is also running various operations such as shutting down security controls, as seen in the example below:</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22897"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_31.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22897" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_31.jpg" alt="Shutting down security controls " width="1400" height="64" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_31.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_31-300x14.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_31-1024x47.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_31-768x35.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_31-140x6.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22897">Figure 34: Shutting down security controls</p></div>
<p><span data-contrast="auto">The binary <code>sh</code> is also copying itself from memory to various location, as illustrated below it saves itself as <code>libpprocps.so</code> and also as <code>/root/.config/cron/perfcc</code>, <code>/usr/bin/perfcc</code>, and <code>/usr/lib/libfsnkdev.so</code>.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22898"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_32.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22898" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_32.jpg" alt="sh copying itself from memory " width="1400" height="64" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_32.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_32-300x14.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_32-1024x47.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_32-768x35.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_32-140x6.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22898">Figure 35: sh copying itself from memory<span> </span></p></div>
<p><span data-contrast="auto">This is a tactic used for persistence, stealth, and possibly for privilege escalation. Below we discuss the various path chosen:</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<ol>
<li data-leveltext="%1." data-font="Calibri" data-listid="28" data-list-defn-props="{&#34;335552541&#34;:0,&#34;335559685&#34;:360,&#34;335559991&#34;:360,&#34;469769242&#34;:[65533,0],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;%1.&#34;,&#34;469777815&#34;:&#34;multilevel&#34;,&#34;469778510&#34;:&#34;default&#34;}" aria-setsize="-1" data-aria-posinset="1" data-aria-level="1"><b><span data-contrast="auto">The path </span></b><strong><code>/root/.config/cron/perfcc</code></strong><span data-contrast="auto">: This path is quite deceptive because it mimics a configuration directory under the root user, which might be overlooked by security scans assuming it’s a legitimate config file. The inclusion of <code>cron</code> in the path suggests an attempt to associate the malware with cron jobs.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></li>
<li data-leveltext="%1." data-font="Calibri" data-listid="28" data-list-defn-props="{&#34;335552541&#34;:0,&#34;335559685&#34;:360,&#34;335559991&#34;:360,&#34;469769242&#34;:[65533,0],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;%1.&#34;,&#34;469777815&#34;:&#34;multilevel&#34;,&#34;469778510&#34;:&#34;default&#34;}" aria-setsize="-1" data-aria-posinset="1" data-aria-level="1"><b><span data-contrast="auto">The path <code>/usr/bin/perfcc</code></span></b><span data-contrast="auto">: The path <code>/usr/bin</code> is a standard directory for executable programs accessible to all users. Placing malware here could allow it to be executed like a normal system command, making detection harder. Naming the malware <code>perfcc</code> might be an attempt to masquerade as a legitimate system utility or command, reducing suspicion.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></li>
<li data-leveltext="%1." data-font="Calibri" data-listid="28" data-list-defn-props="{&#34;335552541&#34;:0,&#34;335559685&#34;:360,&#34;335559991&#34;:360,&#34;469769242&#34;:[65533,0],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;%1.&#34;,&#34;469777815&#34;:&#34;multilevel&#34;,&#34;469778510&#34;:&#34;default&#34;}" aria-setsize="-1" data-aria-posinset="1" data-aria-level="1"><b><span data-contrast="auto">The binaries <code>/usr/lib/libpprocps.so</code> and <code>/usr/lib/libfsnldev.so</code></span></b><span data-contrast="auto">: These paths suggest the malware is impersonating shared libraries. <code>/usr/lib</code> is commonly used for storing shared libraries required by installed applications. The path <code>libpprocps.so</code> might be intended to appear related to the legitimate <code>procps</code>, a library and set of commands that includes utilities like <code>ps</code>, <code>top</code>, etc., which are used to display information about currently running processes. </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></li>
</ol>
<p><span data-contrast="auto">The choice of these paths generally reflects a strategy to blend in with normal system operations, either by appearing as a utility or library that might regularly be executed or loaded by other processes.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<h4 aria-level="3">Appendix 4: The main rootkit (libgcwrap.so)</h4>
<p><span data-contrast="auto">The rootkit has several purposes. One of the main purposes is to hook various functions and modify their functionality. The rootkit itself is an <code>ELF 64-bit LSB</code> shared object (<code>.so</code>) file named <code>libgcwrap.so</code>. The rootkit is using <code>LD_PRELOAD</code> to load itself before other libraries. </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span>As illustrated in Figure </span><span>3</span><span>6</span><span> below, </span></span><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span>rootkit </span><span>str</span><span>ings </span><span>are </span><span>encrypted</span></span><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span> with <code>XOR</code> and this function is iterating through an array, while performing <code>XOR</code> decryption on each element in the array. </span></span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22839"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_33.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22839" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_33.jpg" alt=" XOR decrypt array " width="1000" height="1104" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_33.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_33-272x300.jpg 272w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_33-927x1024.jpg 927w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_33-768x848.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_33-1391x1536.jpg 1391w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_33-127x140.jpg 127w" sizes="(max-width: 1000px) 100vw, 1000px"/></a></p><p id="caption-attachment-22839">Figure 36: XOR decrypt array</p></div>
<p><span data-contrast="auto">You can see in Figure 37 below the </span><code><span data-contrast="auto">xor_decrypt</span></code><span data-contrast="auto"> function responsible to decrypt a string by iterating over each byte of the input string, doing XOR with the key </span><span data-contrast="auto">0xAC</span><span data-contrast="auto">.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22840"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_34.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22840" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_34.jpg" alt="XOR decrypt " width="1000" height="1463" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_34.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_34-205x300.jpg 205w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_34-700x1024.jpg 700w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_34-768x1123.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_34-1050x1536.jpg 1050w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_34-96x140.jpg 96w" sizes="(max-width: 1000px) 100vw, 1000px"/></a></p><p id="caption-attachment-22840">Figure 37: XOR decrypt <span> </span></p></div>
<p><span data-contrast="auto">It does various interesting manipulations, including hooking to Libpam symbols. Specifically, to the function <code>pam_authenticate</code>, which is used by PAM to authenticate users. Hooking or overwriting this function could allow unauthorized actions during the authentication process, such as bypassing password checks, logging credentials, or modifying the behavior of authentication mechanisms.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">In addition, the rootkit is also designed to hook Libpcap symbols, specifically to the function <code>pcap_loop</code>, which is widely used for capturing network traffic. </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">Below we discuss what the attacker is trying to do with these hookings:</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<ol>
<li data-leveltext="%1." data-font="Calibri" data-listid="29" data-list-defn-props="{&#34;335552541&#34;:0,&#34;335559685&#34;:360,&#34;335559991&#34;:360,&#34;469769242&#34;:[65533,0],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;%1.&#34;,&#34;469777815&#34;:&#34;multilevel&#34;,&#34;469778510&#34;:&#34;default&#34;}" aria-setsize="-1" data-aria-posinset="1" data-aria-level="1"><b><span data-contrast="auto">Network Traffic Manipulation</span></b><span data-contrast="auto">: By hooking pcap_loop, an attacker could alter the behavior of applications that rely on libpcap for capturing network traffic. This could include security monitoring tools, network analyzers, and other systems that perform packet analysis. Manipulating this function could lead to missed detections, altered traffic logs, or leakage of sensitive data.</span><span data-ccp-props="{&#34;134233117&#34;:true,&#34;134233118&#34;:true,&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></li>
<li data-leveltext="%1." data-font="Calibri" data-listid="29" data-list-defn-props="{&#34;335552541&#34;:0,&#34;335559685&#34;:360,&#34;335559991&#34;:360,&#34;469769242&#34;:[65533,0],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;%1.&#34;,&#34;469777815&#34;:&#34;multilevel&#34;,&#34;469778510&#34;:&#34;default&#34;}" aria-setsize="-1" data-aria-posinset="1" data-aria-level="1"><b><span data-contrast="auto">Data Eavesdropping</span></b><span data-contrast="auto">: The hooked function might be modified to stealthily copy certain data passing through the network to a location controlled by an attacker, effectively creating a data exfiltration pathway.</span><span data-ccp-props="{&#34;134233117&#34;:true,&#34;134233118&#34;:true,&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></li>
<li data-leveltext="%1." data-font="Calibri" data-listid="29" data-list-defn-props="{&#34;335552541&#34;:0,&#34;335559685&#34;:360,&#34;335559991&#34;:360,&#34;469769242&#34;:[65533,0],&#34;469777803&#34;:&#34;left&#34;,&#34;469777804&#34;:&#34;%1.&#34;,&#34;469777815&#34;:&#34;multilevel&#34;,&#34;469778510&#34;:&#34;default&#34;}" aria-setsize="-1" data-aria-posinset="1" data-aria-level="1"><b><span data-contrast="auto">Persistence and Evasion</span></b><span data-contrast="auto">: Placing malicious code in <code>/tmp</code> and hooking critical functions like <code>pcap_loop</code> can be part of a strategy to maintain persistence on a host with minimal detection. This setup allows an attacker to continue malicious activities even after primary payloads are detected and removed.</span><span data-ccp-props="{&#34;134233117&#34;:true,&#34;134233118&#34;:true,&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></li>
</ol>
<h4 aria-level="3">Appendix 5: User Land Rootkits ‘top’, ‘ldd’, ‘crontab’ and ‘lsof’</h4>
<p><span data-contrast="auto">The malware Perfctl is dropping in the path <code>/home/???/.local/bin/</code> 4 binaries. In our case top, ldd, lsof and crontab. </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">Below is the snippet executing top:</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22900"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_36.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22900" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_36.jpg" alt="top execution " width="1400" height="485" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_36.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_36-300x104.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_36-1024x355.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_36-768x266.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_36-140x49.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22900">Figure 38: top execution</p></div>
<p><span data-contrast="auto">As seen in Figure 38 above, in the first row the script checks if the environment variable <code>ABWTRX</code> is set, if it exists this shell script won’t run. This is probably to check if the binary originally exists on the server or not.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">Next the variables r and m are defined as top and perfctl accordingly. We assume that <code>perfctl</code> in this case is the object to hide which is the cryptominer.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">Next the script iterates over the </span><span data-contrast="auto">/.local/bin</span><span data-contrast="auto"> binaries to save them in the environment variable PATH. Now the script checks if the environment variable <code>AAZHDE</code> is set. Just a reminder. The initial script, when the server is first compromised, sets the environment variable <code>AAZHDE</code>. This is an inspection to verify that the “normal” course of the execution of this malware remains. Probably to evade sandbox execution.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">If <code>AAZHDE</code> is set, the binary top is executed passing all the arguments that were passed during the script execution.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><code><span>AAZHDE </span></code><span>isn’t set, </span><span>the script executes </span><span>various commands. Including, </span><span>2 trap commands</span><span>. </span><span>These trap commands execute </span><span>deletion</span><span> of</span><span> the </span><span>directory </span></span><code><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span data-ccp-charstyle="HTML Code">/</span><span data-ccp-charstyle="HTML Code">tmp</span><span data-ccp-charstyle="HTML Code">/</span><span data-ccp-charstyle="HTML Code">smpr</span></span></code><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"> <span>when the script exists or if it is interrupted by a user. </span><span>It </span><span>then</span><span> recreates </span></span><code><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span data-ccp-charstyle="HTML Code">/</span><span data-ccp-charstyle="HTML Code">tmp</span><span data-ccp-charstyle="HTML Code">/</span><span data-ccp-charstyle="HTML Code">smpr</span> </span></code><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span>than</span><span> it sets the environment variable <code>AAZHDE</code> as <code>1</code>.</span> </span></p>
<p><span data-contrast="auto">Next, the cryptominer is stopped, and the file </span><code><span data-contrast="auto">/tmp/.apid</span></code><span data-contrast="auto"> is deleted. Finally, <code>AAZHDE</code> is unset and top is executed.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">Lastly, the environment variable <code>AAZHDE</code> is unset and the binary top is executed.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">Below is the snippet executing ldd:</span></p>
<div id="attachment_22902"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_37.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22902" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_37.jpg" alt=" ldd execution " width="1400" height="324" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_37.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_37-300x69.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_37-1024x237.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_37-768x178.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_37-140x32.jpg 140w" sizes="(max-width: 1400px) 100vw, 1400px"/></a></p><p id="caption-attachment-22902">Figure 39: ldd execution</p></div>
<p><span data-contrast="auto">This snippet is very similar to the one of <code>top</code>. As seen in Figure 37 above, in the first row the script checks if the environment variable <code>ABWTRX</code> is set, if it exists this shell script won’t run. This is probably to check if the cryptominer is running or not (we will get to that next), if the cryptominer is running this script exits, otherwise it runs and executes the cryptominer.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">The binary </span><i><span data-contrast="auto"><code>top</code></span></i><span data-contrast="auto"> receives 2 parameters, as pointer to an executable and a pointer to the argv. It performs multiple steps including initialization, environment setup, cryptographic operations, data manipulation, and eventually executing another program. It also runs infinite loop to keep the process running in the background.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22911"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_38.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22911" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_38.jpg" alt="Top binary" width="1000" height="418" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_38.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_38-300x125.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_38-1024x428.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_38-768x321.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_38-140x59.jpg 140w" sizes="(max-width: 1000px) 100vw, 1000px"/></a></p><p id="caption-attachment-22911">Figure 40: top binary</p></div>
<p><span data-contrast="auto">You can see two functions <code>modify_lookup_table_with_offset</code> and <code>libc_xor_cipher</code>, which are used to de-obfuscate various sections in memory. Next, there are several checks of the environment variables and errors.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">Lastly, if all conditions are met, we see and execution of a binary (provided as argument during top execution).</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22841"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_39.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22841" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_39.jpg" alt="Top binary " width="1000" height="299" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_39.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_39-300x90.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_39-1024x306.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_39-768x229.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_39-140x42.jpg 140w" sizes="(max-width: 1000px) 100vw, 1000px"/></a></p><p id="caption-attachment-22841">Figure 41: top binary</p></div>
<p><span data-contrast="auto">Top is used for real-time monitoring of system performance and processes. Thus, if a developer encounters a slowdown in the system corresponding to cryptomining activity and asks to check the cpu of all running processes, the new tempered with <code>top</code> will not show the cryptominer’s cpu consumption.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">Ldd is used to display the shared libraries (dynamic dependencies) required by an executable or a shared library. It shows which libraries an application depends on, as well as the paths to those libraries. The threat actor wants to hide malicious libraries and dependencies used by the malware, preventing detection during inspections. </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">Crontab is used to schedule and manage recurring tasks (cron jobs) to run at specified times on Linux/Unix systems.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">lsof Lists open files and shows which processes are using them, including files, sockets, and network connections.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">This makes perfect sense that the threat actor is trying to modify the results of these utilities as they may be used by developers or security engineers to evaluate the server and understand what is attacking the machine.   </span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<h4 aria-level="3">Appendix 6: Unix Socket Communication</h4>
<p><span data-contrast="auto">The binary <code>sh</code> is opening a Unix socket to write and read from various files in the <code>/tmp</code> directory.</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<p><span data-contrast="auto">In the table below we review these files:</span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<table>
<tbody>
<tr aria-rowindex="1">
<td data-celllook="65536"><strong>#</strong></td>
<td data-celllook="65536"><strong>Path</strong></td>
<td data-celllook="65536"><strong>Use</strong></td>
</tr>
<tr aria-rowindex="2">
<td data-celllook="0">1</td>
<td data-celllook="0"><code>/tmp/.xdiag/cp</code></td>
<td data-celllook="0">Malware pathname</td>
</tr>
<tr aria-rowindex="3">
<td data-celllook="0">2</td>
<td data-celllook="0"><code>/tmp/.xdiag/exi</code></td>
<td data-celllook="0">victim’s IP address</td>
</tr>
<tr aria-rowindex="4">
<td data-celllook="0">3</td>
<td data-celllook="0"><code>/tmp/.xdiag/p</code></td>
<td data-celllook="0">Malware Int marker</td>
</tr>
<tr aria-rowindex="5">
<td data-celllook="0">4</td>
<td data-celllook="0"><code>/tmp/.xdiag/elog</code></td>
<td data-celllook="0">Events log</td>
</tr>
<tr aria-rowindex="6">
<td data-celllook="0">5</td>
<td data-celllook="0"><code>/tmp/.xdiag/ver</code></td>
<td data-celllook="0">Malware version (string)</td>
</tr>
<tr aria-rowindex="7">
<td data-celllook="0">6</td>
<td data-celllook="0"><code>/tmp/.xdiag/uid</code></td>
<td data-celllook="0">User ID</td>
</tr>
<tr aria-rowindex="8">
<td data-celllook="0">7</td>
<td data-celllook="0"><code>/tmp/.xdiag/int/.e.lock</code></td>
<td data-celllook="0">Malware Int marker</td>
</tr>
<tr aria-rowindex="9">
<td data-celllook="0">8</td>
<td data-celllook="0"><code>/tmp/.xdiag/hroot/cp</code></td>
<td data-celllook="0">Malware pathname</td>
</tr>
<tr aria-rowindex="10">
<td data-celllook="0">9</td>
<td data-celllook="0"><code>/tmp/.xdiag/hroot/hscheck</code></td>
<td data-celllook="0">Heartbeat check</td>
</tr>
<tr aria-rowindex="11">
<td data-celllook="0">10</td>
<td data-celllook="0"><code>/tmp/.xdiag/tordata/control_auth_cookie.tmp</code></td>
<td data-celllook="0">Cookie</td>
</tr>
<tr aria-rowindex="12">
<td data-celllook="0">11</td>
<td data-celllook="0"><code>/tmp/.xdiag/tordata/cached-certs.tmp</code></td>
<td data-celllook="0">Certificates cache</td>
</tr>
<tr aria-rowindex="13">
<td data-celllook="0">12</td>
<td data-celllook="0">/<code>tmp/.xdiag/tordata/cached-microdesc-consensus.tmp</code></td>
<td data-celllook="0">Tor data</td>
</tr>
<tr aria-rowindex="14">
<td data-celllook="0">13</td>
<td data-celllook="0"><code>/tmp/.xdiag/tordata/state.tmp</code></td>
<td data-celllook="0">State of TOR logs</td>
</tr>
</tbody>
</table>
<p><span lang="EN-US" xml:lang="EN-US" data-contrast="auto"><span>For instance, as illustrated in Figure </span><span>40</span><span> below, in the file below the malware inserted the result of <code>ls</code> on the <code>/</code></span><code><span>tmp</span></code><span> directory.</span></span><span data-ccp-props="{&#34;201341983&#34;:0,&#34;335559739&#34;:0,&#34;335559740&#34;:240}"> </span></p>
<div id="attachment_22913"><p><a href="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_40.jpg"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-22913" src="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_40.jpg" alt="lgctr file content " width="1001" height="304" srcset="https://www.aquasec.com/wp-content/uploads/2024/09/Figure_40.jpg 1400w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_40-300x91.jpg 300w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_40-1024x311.jpg 1024w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_40-768x233.jpg 768w, https://www.aquasec.com/wp-content/uploads/2024/09/Figure_40-140x43.jpg 140w" sizes="(max-width: 1001px) 100vw, 1001px"/></a></p><p id="caption-attachment-22913">Figure 42: lgctr file content</p></div>
<h4>Appendix 7:</h4>
</div>
					


					
											
						<div>
							<!-- ioc table starts -->
															<h3>Indications of Compromise (IOCs)</h3>
							
								<table>
																		<thead>
										<tr>
																							<th scope="col">Type</th>
																																		<th scope="col">Value</th>
																																		<th scope="col">Comment</th>
																																</tr>
									</thead>
									<tbody>


																							<tr>
														<td scope="row" colspan="3">IP Addresses</td>
													</tr>
												
													<tr>
														<td scope="row" data-label="Type">IP Addresses</td>
														<td data-label="Value">211.234.111.116 </td>
																													<td scope="row" data-label="Comment">Attacker IP </td>
																																									</tr>
												
													<tr>
														<td scope="row" data-label="Type">IP Addresses</td>
														<td data-label="Value">46.101.139.173 </td>
																													<td scope="row" data-label="Comment">Download server </td>
																																									</tr>
												
													<tr>
														<td scope="row" data-label="Type">IP Addresses</td>
														<td data-label="Value">104.183.100.189 </td>
																													<td scope="row" data-label="Comment">Download server </td>
																																									</tr>
												
													<tr>
														<td scope="row" data-label="Type">IP Address</td>
														<td data-label="Value">198.211.126.180 </td>
																													<td scope="row" data-label="Comment">Download server</td>
																																									</tr>
																									<tr>
														<td scope="row" colspan="3">Domains </td>
													</tr>
												
													<tr>
														<td scope="row" data-label="Type">Domains </td>
														<td data-label="Value">bitping.com </td>
																													<td scope="row" data-label="Comment">Proxy-jacking service </td>
																																									</tr>
												
													<tr>
														<td scope="row" data-label="Type">Domains </td>
														<td data-label="Value">earn.fm </td>
																													<td scope="row" data-label="Comment">Proxy-jacking service </td>
																																									</tr>
												
													<tr>
														<td scope="row" data-label="Type">Domains </td>
														<td data-label="Value">speedshare.app </td>
																													<td scope="row" data-label="Comment">Proxy-jacking service </td>
																																									</tr>
												
													<tr>
														<td scope="row" data-label="Type">Domains </td>
														<td data-label="Value">repocket.com </td>
																													<td scope="row" data-label="Comment">Proxy-jacking service </td>
																																									</tr>
																									<tr>
														<td scope="row" colspan="3">Files </td>
													</tr>
												
													<tr>
														<td scope="row" data-label="Type">Binary file </td>
														<td data-label="Value">MD5: 656e22c65bf7c04d87b5afbe52b8d800 </td>
																													<td scope="row" data-label="Comment">Malware </td>
																																									</tr>
												
													<tr>
														<td scope="row" data-label="Type">Binary file </td>
														<td data-label="Value">MD5: 6e7230dbe35df5b46dcd08975a0cc87f </td>
																													<td scope="row" data-label="Comment">Cryptominer </td>
																																									</tr>
												
													<tr>
														<td scope="row" data-label="Type">Binary file </td>
														<td data-label="Value">MD5: 835a9a6908409a67e51bce69f80dd58a </td>
																													<td scope="row" data-label="Comment">Rootkit </td>
																																									</tr>
												
													<tr>
														<td scope="row" data-label="Type">Binary file </td>
														<td data-label="Value">MD5: cf265a3a3dd068d0aa0c70248cd6325d </td>
																													<td scope="row" data-label="Comment">Idd</td>
																																									</tr>
												
													<tr>
														<td scope="row" data-label="Type">Binary file </td>
														<td data-label="Value">MD5: da006a0b9b51d56fa3f9690cf204b99f </td>
																													<td scope="row" data-label="Comment">top</td>
																																									</tr>
												
													<tr>
														<td scope="row" data-label="Type">Binary file </td>
														<td data-label="Value">MD5: ba120e9c7f8896d9148ad37f02b0e3cb </td>
																													<td scope="row" data-label="Comment">wizlmsh</td>
																																									</tr>
												
													<tr>
														<td scope="row" data-label="Type"></td>
														<td data-label="Value"></td>
																													<td scope="row" data-label="Comment"></td>
																																									</tr>
																					</tbody>
								</table><!-- ioc_table -->
							

						</div><!-- ioc_table_wrap -->


					

					



				</div><!-- content -->

						
			</div><div>
			

	<div>

			
		
						<div><p>Assaf is the Director of Threat Intelligence at Aqua Nautilus, where is responsible of acquiring threat intelligence related to software development life cycle in cloud native environments, supporting the team&#39;s data needs, and helping Aqua and the broader industry remain at the forefront of emerging threats and protective methodologies. His research has been featured in leading information security publications and journals worldwide, and he has presented at leading cybersecurity conferences. Notably, Assaf has also contributed to the development of the new MITRE ATT&amp;CK Container Framework.</p></div><!-- author_bio -->
	
			<!-- author_social_links -->
		
</div><!-- author_card -->






	<div>

			
		
						<p><a href="https://www.aquasec.com/authors/idan-revivo/">Idan Revivo</a></p><p>Idan is the Head of Security Research at Aqua Security. He manages a team of researchers who are focused on threat hunting and vulnerability research in containers, serverless, and cloud native technologies.</p><!-- author_bio -->
	
			<!-- author_social_links -->
		
</div><!-- author_card -->




			</div></div>
  </body>
</html>
