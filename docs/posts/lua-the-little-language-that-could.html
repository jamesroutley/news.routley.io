<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://matt.blwt.io/post/lua-the-little-language-that-could/">Original</a>
    <h1>Lua: The Little Language That Could</h1>
    
    <div id="readability-page-1" class="page"><article>
		
	    <div>
	        <p><a href="https://www.lua.org/about.html">Lua</a> is probably my favourite “little language” - a language designed to have low cognitive load, and be easy to learn and use. It’s embedded in a lot of software, such as <a href="https://redis.io/docs/manual/programmability/eval-intro/">Redis</a>, <a href="https://openresty.org/en/">NGINX via OpenResty</a> and <a href="https://wiki.wireshark.org/Lua">Wireshark</a>. It’s also used as a scripting language in games such as <a href="https://wow.gamepedia.com/Lua">World of Warcraft</a> and <a href="https://luau-lang.org">Roblox via Luau</a>. This post is a brief love letter to the language, with some examples of why I like it so much.</p>
<h2 id="simplicity">Simplicity</h2>
<p>Lua is not a complicated language, with relatively few features and not a lot of syntax to learn. There are eight types:</p>
<ul>
<li><code>nil</code></li>
<li><code>boolean</code></li>
<li><code>number</code></li>
<li><code>string</code></li>
<li><code>userdata</code> (used to represent C data structures, or blocks of raw memory)</li>
<li><code>function</code></li>
<li><code>thread</code> (used for <a href="https://www.lua.org/manual/5.4/manual.html#2.6">coroutines</a>)</li>
<li><code>table</code> (an associative array, and the sole data structure in Lua)</li>
</ul>
<p>There is no need to worry about <code>float</code>, <code>int</code>, <code>usize</code>. No need to worry about discrete structures to differentiate between arrays, dictionaries or structs. Even classes are “just” tables with a <em>metatable</em>. This simplicity makes it easy to learn and use, while providing enough power to do most things you need to do.</p>
<p>For example, let’s implement a simple <a href="https://en.wikipedia.org/wiki/Binary_search_algorithm">binary search</a> in Lua:</p>
<div><pre tabindex="0"><code data-lang="lua"><span><span><span>function</span> <span>binary_search</span>(array, value)
</span></span><span><span>    <span>local</span> low = <span>1</span>
</span></span><span><span>    <span>local</span> high = #array <span>-- # is the length operator</span>
</span></span><span><span>
</span></span><span><span>    <span>while</span> low &lt;= high <span>do</span>
</span></span><span><span>        <span>-- library functions are accessed via the global table</span>
</span></span><span><span>        <span>local</span> mid = math.floor((low + high) / <span>2</span>)
</span></span><span><span>        <span>local</span> mid_value = array[mid]
</span></span><span><span>
</span></span><span><span>        <span>if</span> mid_value &lt; value <span>then</span>
</span></span><span><span>            low = mid + <span>1</span>
</span></span><span><span>        <span>elseif</span> mid_value &gt; value <span>then</span>
</span></span><span><span>            high = mid - <span>1</span>
</span></span><span><span>        <span>else</span>
</span></span><span><span>            <span>return</span> mid
</span></span><span><span>        <span>end</span>
</span></span><span><span>    <span>end</span>
</span></span><span><span>
</span></span><span><span>    <span>return</span> <span>nil</span>
</span></span><span><span><span>end</span>
</span></span><span><span>
</span></span><span><span>res = binary_search({<span>2</span>, <span>4</span>, <span>6</span>, <span>8</span>, <span>9</span>}, <span>6</span>)
</span></span><span><span>print(res)
</span></span></code></pre></div><p>All this should be relatively familiar to look at, even if you’ve never seen Lua before. The only thing that might be unfamiliar is the <code>local</code> keyword, which is used to declare variables. Variables are global by default, so <code>local</code> is used to declare a variable as local to the current scope.</p>
<h2 id="compilability">Compilability</h2>
<p>Lua is an excellent target to compile to, due to its simplicity and easy C interop. This makes it a great choice for <a href="https://en.wikipedia.org/wiki/Domain-specific_language">domain-specific languages</a> (DSLs), such as <a href="http://terralang.org/">Terra</a>, <a href="https://moonscript.org/">MoonScript</a> and <a href="https://fennel-lang.org/">Fennel</a>. As a quick example, here is that same binary search implemented in MoonScript and Fennel:</p>
<pre tabindex="0"><code data-lang="moonscript">binary_search = (array, value) -&gt;
    low = 1
    high = #array

    while low &lt;= high
        mid = math.floor((low + high) / 2)
        mid_value = array[mid]

        if mid_value &lt; value
            low = mid + 1
        else if mid_value &gt; value
            high = mid - 1
        else
            return mid

    return nil

print binary_search {2, 4, 6, 8, 9}, 6
</code></pre><div><pre tabindex="0"><code data-lang="fennel"><span><span>(<span>fn </span><span>binary-search</span><span> </span>[<span>array</span><span> </span><span>value</span>]<span>
</span></span></span><span><span><span>  </span>(<span>var </span><span>low</span><span> </span><span>1</span>)<span>
</span></span></span><span><span><span>  </span>(<span>var </span><span>high</span><span> </span>(<span>length </span><span>array</span>))<span>
</span></span></span><span><span><span>  </span>(<span>var </span><span>ret</span><span> </span><span>nil</span>)<span>
</span></span></span><span><span><span>  </span>(<span>while </span>(<span>&lt;= </span><span>low</span><span> </span><span>high</span>)<span>
</span></span></span><span><span><span>    </span>(<span>local </span><span>mid</span><span> </span>(<span>math.floor </span>(<span>/ </span>(<span>+ </span><span>low</span><span> </span><span>high</span>)<span> </span><span>2</span>)))<span>
</span></span></span><span><span><span>    </span>(<span>local </span><span>mid-value</span><span> </span>(<span>. </span><span>array</span><span> </span><span>mid</span>))<span>
</span></span></span><span><span><span>    </span>(<span>if </span>(<span>&lt; </span><span>mid-value</span><span> </span><span>value</span>)<span> </span>(<span>set </span><span>low</span><span> </span>(<span>+ </span><span>mid</span><span> </span><span>1</span>))<span>
</span></span></span><span><span><span>        </span>(<span>&gt; </span><span>mid-value</span><span> </span><span>value</span>)<span> </span>(<span>set </span><span>high</span><span> </span>(<span>- </span><span>mid</span><span> </span><span>1</span>))<span>
</span></span></span><span><span><span>        </span>(<span>do</span><span>
</span></span></span><span><span><span>          </span>(<span>set </span><span>ret</span><span> </span><span>mid</span>)<span>
</span></span></span><span><span><span>          </span>(<span>set </span><span>low</span><span> </span><span>high</span>))))<span> </span><span>; no early returns in Fennel</span><span>
</span></span></span><span><span><span>  </span><span>ret</span>)<span>
</span></span></span><span><span><span></span>(<span>local </span><span>res</span><span> </span>(<span>binary-search</span><span> </span>[<span>2</span><span> </span><span>4</span><span> </span><span>6</span><span> </span><span>8</span><span> </span><span>9</span>]<span> </span><span>6</span>))<span>
</span></span></span><span><span><span></span>(<span>print </span><span>res</span>)<span>
</span></span></span></code></pre></div><h2 id="embeddability">Embeddability</h2>
<p>Really, the true strength of Lua is that you can embed it almost anywhere - Lua is implemented as a library for a host program, like Redis. Traditionally, this was a C program, but there are implementations of a Lua VM in many languages, such as <a href="https://fengari.io/">JavaScript via Fengari</a> or <a href="https://github.com/yuin/gopher-lua">Go via GopherLua</a>. However, it has perhaps achieved most success as the primary scripting language for <a href="https://create.roblox.com/docs/scripting/luau">Roblox</a>.</p>
<p>Perhaps one of my favourite uses is through HAProxy, harkening back to the days of <code>Apache</code> + <code>mod_php</code> scripting. Let’s set up a HAProxy configuration to respond to requests on a particular path with a random fortune:</p>
<div><pre tabindex="0"><code data-lang="lua"><span><span><span>local</span> <span>function</span> <span>fortune</span>(applet)
</span></span><span><span>    <span>local</span> responses = {
</span></span><span><span>        {
</span></span><span><span>            quote = <span>&#34;The only people who never fail are those who never try.&#34;</span>,
</span></span><span><span>            author = <span>&#34;Ilka Chase&#34;</span>
</span></span><span><span>        },
</span></span><span><span>        {
</span></span><span><span>            quote = <span>&#34;The mind that is anxious about future events is miserable.&#34;</span>,
</span></span><span><span>            author = <span>&#34;Seneca&#34;</span>
</span></span><span><span>        },
</span></span><span><span>        {
</span></span><span><span>            quote = <span>&#34;A leader is a dealer in hope.&#34;</span>,
</span></span><span><span>            author = <span>&#34;Napoleon Bonaparte&#34;</span>
</span></span><span><span>        },
</span></span><span><span>        {
</span></span><span><span>            quote = <span>&#34;Do not wait to strike until the iron is hot; but make it hot by striking.&#34;</span>,
</span></span><span><span>            author = <span>&#34;William B. Sprague&#34;</span>
</span></span><span><span>        },
</span></span><span><span>        {
</span></span><span><span>            quote = <span>&#34;You have power over your mind - not outside events. Realize this, and you will find strength.&#34;</span>,
</span></span><span><span>            author = <span>&#34;Marcus Aurelius&#34;</span>
</span></span><span><span>        }
</span></span><span><span>    }
</span></span><span><span>
</span></span><span><span>    <span>local</span> response = responses[math.random(#responses)]
</span></span><span><span>    <span>local</span> resp = string.format(<span>[[
</span></span></span><span><span><span>        &lt;html&gt;
</span></span></span><span><span><span>            &lt;body&gt;
</span></span></span><span><span><span>                &lt;p&gt;%s&lt;br&gt;&amp;nbsp;&amp;nbsp;--%s&lt;/p&gt;
</span></span></span><span><span><span>            &lt;/body&gt;
</span></span></span><span><span><span>        &lt;/html&gt;
</span></span></span><span><span><span>    ]]</span>, response.quote, response.author)
</span></span><span><span>
</span></span><span><span>    applet:set_status(<span>200</span>)
</span></span><span><span>    applet:add_header(<span>&#34;content-length&#34;</span>, string.len(resp))
</span></span><span><span>    applet:add_header(<span>&#34;content-type&#34;</span>, <span>&#34;text/html&#34;</span>)
</span></span><span><span>    applet:start_response()
</span></span><span><span>    applet:send(resp)
</span></span><span><span><span>end</span>
</span></span><span><span>
</span></span><span><span>core.register_service(<span>&#34;fortune&#34;</span>, <span>&#34;http&#34;</span>, fortune)
</span></span></code></pre></div><pre tabindex="0"><code data-lang="haproxy">global
    lua-load fortune.lua

defaults
    retries                 3
    timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 10s
    timeout check           10s

frontend fe_main
    bind :8080
    mode http
    http-request use-service lua.fortune if { path /fortune }
</code></pre><p>And then we can run it:</p>
<pre tabindex="0"><code>$ haproxy -f haproxy.cfg
</code></pre><pre tabindex="0"><code>$ curl localhost:8080/fortune
        &lt;html&gt;
            &lt;body&gt;
                &lt;p&gt;Do not wait to strike until the iron is hot; but make it hot by striking.&lt;br&gt;&amp;nbsp;&amp;nbsp;--William B. Sprague&lt;/p&gt;
            &lt;/body&gt;
        &lt;/html&gt;
</code></pre><p>Why might we want to do this? It’s pretty easy to imagine wanting some small application logic on top of a web server, but not wanting to write a full web application. It can even be used to extend functionality on top of existing applications, like adding a small health endpoint to a Redis server:</p>
<div><pre tabindex="0"><code data-lang="lua"><span><span><span>-- this is a custom fork of redis-lua to support TLS</span>
</span></span><span><span><span>local</span> redis = require(<span>&#34;redis-tls&#34;</span>)
</span></span><span><span>
</span></span><span><span><span>local</span> settings = {
</span></span><span><span>	host = <span>&#34;127.0.0.1&#34;</span>,
</span></span><span><span>	port = <span>6379</span>,
</span></span><span><span>	database = <span>14</span>,
</span></span><span><span>	password = <span>nil</span>,
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span><span>local</span> utils = {
</span></span><span><span>	create_client = <span>function</span>(params)
</span></span><span><span>		<span>local</span> client = redis.connect(params.host, params.port, <span>1</span>, <span>false</span>)
</span></span><span><span>		<span>if</span> params.password <span>then</span>
</span></span><span><span>			client:auth(params.password)
</span></span><span><span>		<span>end</span>
</span></span><span><span>		<span>return</span> client
</span></span><span><span>	<span>end</span>,
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span><span>local</span> <span>function</span> <span>redis_health</span>(applet)
</span></span><span><span>    <span>-- pcall is like try/catch, takes a func and func args</span>
</span></span><span><span>    <span>-- returns true/false and the return value of the func</span>
</span></span><span><span>	<span>local</span> ok, client = pcall(utils.create_client, settings)
</span></span><span><span>	<span>if</span> <span>not</span> ok <span>then</span>
</span></span><span><span>		<span>local</span> string_resp = <span>&#39;{&#34;ok&#34;:false}</span><span>\n</span><span>&#39;</span>
</span></span><span><span>		applet:set_status(<span>500</span>)
</span></span><span><span>		applet:add_header(<span>&#34;content-length&#34;</span>, string.len(string_resp))
</span></span><span><span>		applet:add_header(<span>&#34;content-type&#34;</span>, <span>&#34;application/json&#34;</span>)
</span></span><span><span>		applet:start_response()
</span></span><span><span>		applet:send(string_resp)
</span></span><span><span>		<span>return</span>
</span></span><span><span>	<span>end</span>
</span></span><span><span>
</span></span><span><span>	<span>local</span> resp = client:ping()
</span></span><span><span>	<span>local</span> string_resp = string.format(<span>&#39;{&#34;ok&#34;:%s}</span><span>\n</span><span>&#39;</span>, resp)
</span></span><span><span>	applet:set_status(<span>200</span>)
</span></span><span><span>	applet:add_header(<span>&#34;content-length&#34;</span>, string.len(string_resp))
</span></span><span><span>	applet:add_header(<span>&#34;content-type&#34;</span>, <span>&#34;application/json&#34;</span>)
</span></span><span><span>	applet:start_response()
</span></span><span><span>	applet:send(string_resp)
</span></span><span><span><span>end</span>
</span></span><span><span>
</span></span><span><span>core.register_service(<span>&#34;redis_health&#34;</span>, <span>&#34;http&#34;</span>, redis_health)
</span></span></code></pre></div><pre tabindex="0"><code data-lang="haproxy">global
    lua-load redis.lua

frontend fe_main
    bind :8080
    mode http
    http-request use-service lua.redis_health if { path /redis_health }
</code></pre><pre tabindex="0"><code>$ curl 127.0.0.1:8080/redis_health
{&#34;ok&#34;:false}

## start redis
$ curl 127.0.0.1:8080/redis_health
{&#34;ok&#34;:true}
</code></pre><p>This can be expanded even beyond this with <code>register_action</code> and <code>register_fetches</code> (see the <a href="https://manpages.ubuntu.com/manpages/impish/man1/haproxy-lua.1.html">docs</a>) to intercept request information and modify it, or add additional auth capabilities to software that doesn’t support it natively.</p>

<p>The Lua community is not particularly large, but there is a lot of excellent development occuring, with may libraries available through the Lua package manager, <a href="https://luarocks.org/">LuaRocks</a>. From libraries for <a href="https://luarocks.org/modules/openresty/lua-cjson">fast JSON parsing and encoding</a> to an <a href="https://luarocks.org/modules/tieske/penlight">extended standard library</a>, there is a little something for everyone.</p>
<p>A special mention must go to <a href="https://leafo.net/">Leaf Corcoran</a>, who wrote <a href="https://leafo.net/lapis/">Lapis</a> - a fantastic little web framework for the OpenResty distribution, which powers the LuaRocks website.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Is there really a conclusion? Lua is great, you can pick it up in a weekend and start taking advantage of it to write auth layers in HAProxy, World of Warcraft addons, a game in Roblox or just small libraries that make you happy.</p>
		</div>
	</article></div>
  </body>
</html>
