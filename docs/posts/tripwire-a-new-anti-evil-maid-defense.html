<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/fr33-sh/Tripwire">Original</a>
    <h1>Show HN: Tripwire: A new anti evil maid defense</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<div dir="auto"><h2 tabindex="-1" dir="auto">What are Evil Maid Attacks?</h2><a id="user-content-what-are-evil-maid-attacks" aria-label="Permalink: What are Evil Maid Attacks?" href="#what-are-evil-maid-attacks"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Evil maid attacks, first defined by Joanna Rutkowska (<a href="https://blog.invisiblethings.org/2009/10/15/evil-maid-goes-after-truecrypt.html" rel="nofollow">source</a>), has been a difficult threat to people who care about their device security and personal privacy. In an evil maid attack, the attacker gets physical access to the target device when the user left it at home or in a hotel room. They secretly compromise the device in order to spy on the user&#39;s past <strong>and future</strong> activities, without the user ever noticing. Because physical access gives the attacker so much control, currently there is no software or firmware solution that effectively defends against evil maid attacks. Even though there are Secure Boot and Trusted Platform Modules (TPM), it is still possible for the attacker to install something like a hardware keylogger to bypass those defenses.</p>

<p dir="auto">Tripwire is a robust monitoring system <strong>that defends against sophisticated adversaries</strong>. In comparison, traditional home monitoring products can only defend against burglars, who are not technically-sophisticated and only want to steal money. For higher-profile users, such as:</p>
<ul dir="auto">
<li>Developers of critical software (recall the xz backdoor)</li>
<li>High-ranking officials in businesses/organizations</li>
<li>Investigative journalists</li>
<li>Attorneys with high-profile clients</li>
<li>...</li>
</ul>
<p dir="auto">Traditional monitoring systems can&#39;t help them defend against strong adversaries (e.g. professional spies and criminal hackers). A strong adversary will likely disable/jam the network on the premise, and then compromise the target device <strong>and the monitoring system</strong> so that it looks like no intrusion was detected. Additionally, because most of the home monitoring products are for-profit and closed-source, it&#39;s possible that they have undiscovered security vulnerabilities. In general, the companies that develop those monitoring products cannot be much trusted either, given past cases where employees in those companies spied on the users. See: <a href="https://www.justice.gov/usao-ndtx/pr/adt-technician-pleads-guilty-hacking-home-security-footage" rel="nofollow">https://www.justice.gov/usao-ndtx/pr/adt-technician-pleads-guilty-hacking-home-security-footage</a></p>
<p dir="auto">Tripwire&#39;s solution is simple. Before the user deploys Tripwire, the server at home, which runs on a Raspberry Pi 5, shares some random secrets with the web client on user&#39;s mobile device. After Tripwire is deployed and the user leaves home, they can view a stream of photos which are captured by RPi&#39;s camera module and sent to the web client. If any motion is detected by RPi&#39;s camera module or motion sensor, the server will delete those secrets immediately, in addition to sending push notifications to the web client. This way, even when the attacker gets physical access to both the target device and the RPi and compromise both of them, they can&#39;t restore those secrets. And when the user sees a mismatch between the secrets on the web client and the ones sent from the server, they know that there has been a detection. Here is a demo video for this concept:</p>
<details open="">
  <summary>
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path d="M16 3.75v8.5a.75.75 0 0 1-1.136.643L11 10.575v.675A1.75 1.75 0 0 1 9.25 13h-7.5A1.75 1.75 0 0 1 0 11.25v-6.5C0 3.784.784 3 1.75 3h7.5c.966 0 1.75.784 1.75 1.75v.675l3.864-2.318A.75.75 0 0 1 16 3.75Zm-6.5 1a.25.25 0 0 0-.25-.25h-7.5a.25.25 0 0 0-.25.25v6.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-6.5ZM11 8.825l3.5 2.1v-5.85l-3.5 2.1Z"></path>
</svg>
    <span>test.mp4</span>
    <span></span>
  </summary>

  <video src="https://private-user-images.githubusercontent.com/208796637/474095866-2e8fbde4-8e36-4e81-9c1b-c86268d02e73.mp4?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjU1NjczMjcsIm5iZiI6MTc2NTU2NzAyNywicGF0aCI6Ii8yMDg3OTY2MzcvNDc0MDk1ODY2LTJlOGZiZGU0LThlMzYtNGU4MS05YzFiLWM4NjI2OGQwMmU3My5tcDQ_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUxMjEyJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MTIxMlQxOTE3MDdaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT04NjQ3MGU4ZjE1MTI2ZjI3MmMxYmU2OTEyOTRlMTBhNWE1NjE4ZDFhMzA4ZWNjY2E1ODRhOThlZTdmZWRmNWJjJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.y9nW7OO2Iic04UfJhm5ayK6EtMDg-CtHhx92-TF6sEg" data-canonical-src="https://private-user-images.githubusercontent.com/208796637/474095866-2e8fbde4-8e36-4e81-9c1b-c86268d02e73.mp4?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjU1NjczMjcsIm5iZiI6MTc2NTU2NzAyNywicGF0aCI6Ii8yMDg3OTY2MzcvNDc0MDk1ODY2LTJlOGZiZGU0LThlMzYtNGU4MS05YzFiLWM4NjI2OGQwMmU3My5tcDQ_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUxMjEyJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MTIxMlQxOTE3MDdaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT04NjQ3MGU4ZjE1MTI2ZjI3MmMxYmU2OTEyOTRlMTBhNWE1NjE4ZDFhMzA4ZWNjY2E1ODRhOThlZTdmZWRmNWJjJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.y9nW7OO2Iic04UfJhm5ayK6EtMDg-CtHhx92-TF6sEg" controls="controls" muted="muted">

  </video>
</details>

<p dir="auto">Other than the secrets, the server also has a separate cryptographic key pair. The public key is shared with the web client before deployment, and the private key is used to sign all photos before any detection, <strong>and the first few seconds of photos after detection</strong> before the key pair is deleted. The deletion of the key pair prevents the attacker from seizing it and forging signatures. This way the user can unmistakably see the brief moment after detection, which either catches a glimpse of the intruder, or shows a false positive, in which case the user can remotely re-arm Tripwire (generating new secrets and key pair). If the user sets up full-disk encryption (FDE) on the RPi, it will make it difficult to tamper with the photo log on the disk as well.</p>
<p dir="auto">Because of Tripwire&#39;s sharing and deletion of the random secrets, the attacker can&#39;t cover their track left by the intrusion, even if they temporarily disable the network. It is slightly more challenging if the attacker persistently disables the network, which prevents the user from comparing secrets. But in this case the user can enter the deployment area, power off the RPi, and takes out the SD card. After plugging the SD card on another computer (e.g. a friend&#39;s laptop, a random computer at a library), if they see that the photo log has been signed up until the time when they come back and enter the deployment area, then it means Tripwire didn&#39;t detect any intrusion other than the user&#39;s return. If the signing of the photo log stopped a while before the user&#39;s return, then it must mean that Tripwire detected intrusion before the user returns.</p>
<p dir="auto">In summary, Tripwire is a robust monitoring system that is also tamper-evident by itself. It survives network outage by design, and can also survive power outage if plugged into an uninterrupted power supply (UPS). False positives and false negatives are also easier to identify by reasoning about Tripwire&#39;s logic and the artifacts. Those properties will be discussed in more details later on.</p>

<p dir="auto">In order to use Tripwire, you will need:</p>
<ul dir="auto">
<li>Basic familiarity with technology.
<ul dir="auto">
<li>If not, this document will still show you most of the steps for hardware and software. You may need to look up a few Linux commands or RPi docs though.</li>
<li>You can open an issue on this GitHub if you run into difficulty at a certain step.</li>
</ul>
</li>
<li>Hardware:
<ul dir="auto">
<li><a href="https://www.raspberrypi.com/products/raspberry-pi-5/" rel="nofollow">A Raspberry Pi 5</a>
<ul dir="auto">
<li>Older models haven&#39;t been tested at all.</li>
</ul>
</li>
<li><a href="https://www.raspberrypi.com/products/27w-power-supply/" rel="nofollow">Raspberry Pi&#39;s official 27W USB-C power supply</a>
<ul dir="auto">
<li>Lower-wattage power supplies have caused the RPi to randomly power off during tests.</li>
<li>You don&#39;t want to risk security with unsupported and non-official products.</li>
</ul>
</li>
<li>A microSD card.
<ul dir="auto">
<li>At least 128GB of storage for the hours or even days of photos.</li>
</ul>
</li>
<li><a href="https://www.raspberrypi.com/products/camera-module-3/" rel="nofollow">The official Camera Module 3 for Raspberry Pi</a></li>
<li>A ribbon connector that works with RPi 5 and the camera module.
<ul dir="auto">
<li>RPi 5 uses a new connector for the camera module which is <strong>narrower on one side</strong>. Older connectors won&#39;t fit!</li>
<li>Probably <a href="https://www.raspberrypi.com/products/camera-cable/" rel="nofollow">this one</a>.</li>
</ul>
</li>
<li>A passive infrared (PIR) motion sensor.
<ul dir="auto">
<li>Note that it has to be a PIR motion sensor, which is very cheap (a few dollars), and not a prepackaged motion sensor product, which is more expensive (tens of dollars).</li>
<li><a href="https://projects.raspberrypi.org/en/projects/parent-detector/1" rel="nofollow">This page</a> has a good description of what a PIR motion sensor is, what it looks like, and how to connect it to the RPi (except that we are using GPIO pin #17 and not GPIO pin #4 on the RPi).</li>
</ul>
</li>
<li>A breadboard to sit the PIR sensor straight, and a batch of male-to-female jump wires to connect the RPi 5 GPIO pins with the breadboard.
<ul dir="auto">
<li>You may also need a batch of male-to-male jumpers if you are putting the PIR further on the breadboard.</li>
</ul>
</li>
<li>(Strongly recommended) A camera holder that is compatible with the camera module so that it can be held up and not flop around with the ribbon connector.
<ul dir="auto">
<li>You can either buy it somewhere or 3D-print one using open-source designs.</li>
<li><strong>WARNING: Some camera holders have broken my camera modules after a while, possibly because the pressure from the screws stretched the camera module. Be careful with those, or try to not tighten the screws too far!</strong></li>
</ul>
</li>
<li>(Strongly recommended) An uninterrupted power supply (UPS) for when there is a temporary power outage or if the attacker cuts the power.</li>
</ul>
</li>
<li>A domain name.
<ul dir="auto">
<li>So that you can get TLS certificates for Tripwire&#39;s web traffic to be encrypted. Otherwise, Tripwire is trivial to compromise.</li>
<li>You should probably get a domain from one of the listed providers in this repository: <a href="https://github.com/orgs/caddy-dns/repositories">https://github.com/orgs/caddy-dns/repositories</a>
<ul dir="auto">
<li>This is to ensure that dynamic DNS will work later on.</li>
</ul>
</li>
</ul>
</li>
<li>Port forwarding on your home router, or a VPS.
<ul dir="auto">
<li>Since you will be self-hosting Tripwire at your home and accessing it when you are away from home, port forwarding needs to be set up so that traffic between your client device and the Tripwire server can go through.</li>
<li>You can forward a non-standard port (any port between 1024-65535) from the router to the RPi, so that your log won&#39;t be filled with random script kiddies trying to attack common ports.</li>
<li>As an example, on my router, I configure the router&#39;s port 12345 to be forwarded to the internal IP address of my RPi, on port 12345 as well.</li>
<li>If you plan to use Tripwire in a hotel, or other networks that you don&#39;t control, port forwarding won&#39;t work. In this case, you need to rent a VPS (virtual private server) from a cloud provider to run Tripwire&#39;s relay server, which relays data between the RPi server and the web client.
<ul dir="auto">
<li><strong>This isn&#39;t implemented yet.</strong></li>
</ul>
</li>
</ul>
</li>
</ul>

<div dir="auto"><h3 tabindex="-1" dir="auto">Choose your deployment area</h3><a id="user-content-choose-your-deployment-area" aria-label="Permalink: Choose your deployment area" href="#choose-your-deployment-area"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This is where you place the device you want to protect along with the whole RPi. There can only be one entrance, so that the attacker can&#39;t enter and compromise the devices from behind. Very importantly, the room should have no window, so that the difference in ambient light can&#39;t trigger false positives with the camera module. There can&#39;t be any moving objects at all, so make sure your pets can&#39;t enter this area either. The place should also be well lit, probably with room lights, because camera-based motion detection is harder in the dark. If possible, a light source that can survive power outage is highly preferable. Finally, there shouldn&#39;t be heat sources in the area either to prevent false positives with the PIR sensor, which detects motion using infrared and heat change.</p>

<p dir="auto">Set up your Raspberry Pi 5 <em>as a headless computer</em> following official docs: <a href="https://www.raspberrypi.com/documentation/computers/getting-started.html#installing-the-operating-system" rel="nofollow">https://www.raspberrypi.com/documentation/computers/getting-started.html#installing-the-operating-system</a></p>
<ul dir="auto">
<li>In the imager, make sure you go into &#34;Raspberry Pi OS (other)&#34; and choose &#34;Raspberry Pi OS Lite (64-bit)&#34;.</li>
</ul>
<p dir="auto">Connect the PIR sensor and the camera module. <a href="https://projects.raspberrypi.org/en/projects/parent-detector/0" rel="nofollow">This tutorial</a> has a pretty good walkthrough for both.</p>
<ul dir="auto">
<li>Connect the OUT pin of the PIR sensor to GPIO pin #17 on the RPi instead of #4. Refer to RPi&#39;s <a href="https://www.raspberrypi.com/documentation/computers/raspberry-pi.html#gpio" rel="nofollow">pin layout</a> to see where it is.</li>
<li>The orientation of the ribbon connector may be different. Double check which side should you plug it in. Generally speaking, the metal pins on the ribbon should touch the metal pins in the socket.</li>
<li><span><strong>NEVER PLUG/UNPLUG THE CAMERA MODULE, THE PIR SENSOR, OR WIRES WHEN THE RPi IS POWERED ON!!!</strong></span></li>
</ul>
<p dir="auto">After you have set up the headless RPi with PIR sensor and camera module, power it on and SSH into it.</p>

<p dir="auto">Clone this repository and its submodules:</p>
<div data-snippet-clipboard-copy-content="git clone --recurse-submodules git@github.com:fr33-sh/Tripwire.git"><pre><code>git clone --recurse-submodules git@github.com:fr33-sh/Tripwire.git
</code></pre></div>
<p dir="auto">Enter the repo&#39;s directory:</p>


<p dir="auto">Install Picamera2 from <strong>APT</strong>:</p>
<div data-snippet-clipboard-copy-content="sudo apt install python3-picamera2 --no-install-recommends"><pre><code>sudo apt install python3-picamera2 --no-install-recommends
</code></pre></div>
<p dir="auto">Note: Installing picamera2 from pip probably won&#39;t work due to some compatibility issues. See section 2.2 of this <a href="https://datasheets.raspberrypi.com/camera/picamera2-manual.pdf" rel="nofollow">manual</a>.</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Python virtual environment and dependencies</h3><a id="user-content-python-virtual-environment-and-dependencies" aria-label="Permalink: Python virtual environment and dependencies" href="#python-virtual-environment-and-dependencies"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Create and activate a Python virtual environment with system Python packages included, so that picamera2 will also be available in the virtual environment.</p>
<div data-snippet-clipboard-copy-content="python3 -m venv --system-site-packages venv
source venv/bin/activate"><pre><code>python3 -m venv --system-site-packages venv
source venv/bin/activate
</code></pre></div>
<p dir="auto">Install Tripwire&#39;s dependencies specified in <code>requirements.txt</code>:</p>
<div data-snippet-clipboard-copy-content="pip install -r requirements.txt"><pre><code>pip install -r requirements.txt
</code></pre></div>
<p dir="auto">Install pywebpush and Python VAPID tool. Run the following commands after <code>cd</code>ing into <code>pywebpush/</code>. Do the same for <code>vapid/python/</code>.</p>
<div data-snippet-clipboard-copy-content="pip install -r requirements.txt
pip install -e ."><pre><code>pip install -r requirements.txt
pip install -e .
</code></pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">Checking and tuning the camera module</h3><a id="user-content-checking-and-tuning-the-camera-module" aria-label="Permalink: Checking and tuning the camera module" href="#checking-and-tuning-the-camera-module"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Tripwire&#39;s camera-based motion detection uses a metric called <a href="https://scikit-image.org/docs/stable/api/skimage.metrics.html#skimage.metrics.structural_similarity" rel="nofollow">Structural Similarity Index (SSIM)</a>, which compares a type of difference between photos. If the SSIM value falls below a pre-configured value, then it considers that motion is detected.</p>
<p dir="auto">Check if the OS sees the camera:</p>
<div data-snippet-clipboard-copy-content="rpicam-still --list-cameras"><pre><code>rpicam-still --list-cameras
</code></pre></div>
<p dir="auto">It should show the camera module.</p>
<p dir="auto">Check that the camera module works by running:</p>
<div data-snippet-clipboard-copy-content="rpicam-still --width 800 --height 800 -o test.jpg"><pre><code>rpicam-still --width 800 --height 800 -o test.jpg
</code></pre></div>
<p dir="auto">It should capture a photo using the camera module and save to <code>test.jpg</code>. Make sure that <code>test.jpg</code> is a photo of reasonable quality.</p>
<p dir="auto">Next, put the whole RPi at your planned deployment area, and point the camera module toward the only entrance. Set up the area to be similar to when Tripwire is deployed by turning the lights on, closing the door (if any), and so on. Run:</p>

<p dir="auto">The script will capture a series of photos and compare the SSIM between the first photo and the latest photo, and the SSIM between each adjacent pair. It will report the minimal SSIMs from these two comparisons. These two minimal SSIMs should be pretty close to each other, and should be preferably above 0.8 and at the very least 0.7. Write down those two values because they will be used later when editing the config.</p>
<p dir="auto">If the two SSIMs are low, then the area may not be well lit, the camera module may be too close to the door, or the camera module may be faulty. It&#39;s also possible that the image of the entrance is too simpmle (e.g. having a uniform color). Maybe putting a paper printed with something colorful and complicated on the door will help.</p>

<p dir="auto">Install xcaddy (not Caddy) following the instruction on its GitHub: <a href="https://github.com/caddyserver/xcaddy">https://github.com/caddyserver/xcaddy</a></p>
<p dir="auto">Note: If you built it from source with <code>go install ...</code>, the built xcaddy binary will probably be located at <code>/home/pi/go/bin/xcaddy</code>, or <code>$GOBIN/xcaddy</code>. See <code>go help install</code>.</p>
<p dir="auto">Note: As of Aug 17, 2025, the latest version of Caddy and the two DNS plugins don&#39;t work. The command below specifies earlier versions that work.</p>
<p dir="auto">Using xcaddy, build Caddy with these two plugins:</p>
<ol dir="auto">
<li>The dynamic DNS plugin.</li>
<li>The specific DNS provider plugin for the domain registrar you are using.</li>
</ol>
<div data-snippet-clipboard-copy-content="xcaddy build v2.9.1 --with github.com/mholt/caddy-dynamicdns@v0.0.0-20250414204016-f8b471835a9f --with github.com/caddy-dns/[YOUR DNS PROVIDER]"><pre><code>xcaddy build v2.9.1 --with github.com/mholt/caddy-dynamicdns@v0.0.0-20250414204016-f8b471835a9f --with github.com/caddy-dns/[YOUR DNS PROVIDER]
</code></pre></div>
<p dir="auto">Replace [YOUR DNS PROVIDER] with the name of your DNS provider. If you don&#39;t know who your DNS provider is, then it is probably the same as your domain registrar (where you get the domain). All available DNS provider plugins can be found here: <a href="https://caddyserver.com/docs/modules/" rel="nofollow">https://caddyserver.com/docs/modules/</a>. Their names start with a prefix of &#34;dns.providers&#34;. The description of each plugin shows the exact URL to be used for the second <code>--with</code> in the command. You can also find the GitHub repositories of these DNS provider plugins here: <a href="https://github.com/orgs/caddy-dns/repositories">https://github.com/orgs/caddy-dns/repositories</a></p>
<p dir="auto">So, if your DNS provider is Duck DNS, then you should run this command:</p>
<div data-snippet-clipboard-copy-content="xcaddy build v2.9.1 --with github.com/mholt/caddy-dynamicdns@v0.0.0-20250414204016-f8b471835a9f --with github.com/caddy-dns/duckdns"><pre><code>xcaddy build v2.9.1 --with github.com/mholt/caddy-dynamicdns@v0.0.0-20250414204016-f8b471835a9f --with github.com/caddy-dns/duckdns
</code></pre></div>
<p dir="auto">The built Caddy custom binary <code>caddy</code> will be located at whichever directory this command is run. For convenience, move it into a directory on <code>$PATH</code>. From here on, it is assumed to be put under <code>/home/pi/.local/bin/</code>.</p>
<p dir="auto">For Caddy to be able to bind to the system ports (0-1023), it needs to have the corresponding capabilities. Otherwise, running Caddy will result in a permission error.</p>
<div data-snippet-clipboard-copy-content="sudo setcap CAP_NET_BIND_SERVICE=+eip ~/.local/bin/caddy"><pre><code>sudo setcap CAP_NET_BIND_SERVICE=+eip ~/.local/bin/caddy
</code></pre></div>
<p dir="auto">Note: This is still necessary even if you are serving the web app on non-system ports, because Caddy by default tries to listen to port 80 for automatic HTTPS redirection.</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Setup the instance directory</h3><a id="user-content-setup-the-instance-directory" aria-label="Permalink: Setup the instance directory" href="#setup-the-instance-directory"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Each instance of Tripwire deployment needs its own instance directory. You can use the provided example instance directory. You just need to rename it:</p>
<div data-snippet-clipboard-copy-content="mv example_instance instance"><pre><code>mv example_instance instance
</code></pre></div>

<p dir="auto">The <code>instance/config.yaml</code> file contains both server and client configs.</p>
<p dir="auto">Server parameters:</p>
<ul dir="auto">
<li>The <code>MIN_SSIM_VS_INIT</code> and <code>MIN_SSIM_VS_NEXT</code> should be set at about 0.5 to 1 below the two minimal SSIMs acquired when tuning the camera previously.</li>
<li><code>POST_DETECTION.SECS_DEL_KEYS</code> is the number of seconds before server deletes its private key after detecting motion.
<ul dir="auto">
<li>This parameter refers to the private key and not the secrets. The secrets are deleted immediately upon detection.</li>
<li>The value should be determined by the distance between where your protected device and Tripwire are, and where the attacker will enter the area. The keys should be deleted shortly before the attacker can run to the RPi and compromise it. Assume they can compromise it instantly after reaching the RPi.
<ul dir="auto">
<li>For example, if you estimate the attacker to spend 0.5 seconds opening the door (which triggers detection), and 3 seconds to run to the RPi, then 2 seconds may be a safe value for this parameter.</li>
</ul>
</li>
</ul>
</li>
<li><code>KEEPS_PHOTOS_IN_MEM_FOR</code>: The number of seconds server will keep a photo in memory before moving it to disk.
<ul dir="auto">
<li>This should be determined by how big the RAM is and how big each photo is.</li>
</ul>
</li>
<li><code>KEEPS_PHOTOS_IN_DISK_FOR</code>: The number of seconds server will keep a photo on disk before deleting it.
<ul dir="auto">
<li>This should be determined by how big the microSD card is and how big each photo is.</li>
</ul>
</li>
</ul>
<p dir="auto">Client parameters:</p>
<ul dir="auto">
<li><code>MAX_NUM_PHOTOS_IN_MEM</code>: The maximal number of photos client will keep in memory before moving older ones into IndexedDB or deleting them.</li>
<li><code>SECS_PHOTOS_TO_MOVE_TO_FREE_MEM</code>: How many seconds worth of photos to move to IndexedDB or to delete when <code>MAX_NUM_PHOTOS_IN_MEM</code> is reached.</li>
</ul>

<p dir="auto">A VAPID key pair is needed for Tripwire&#39;s Flask server to send out web push notifications. Run this command under <code>instance/vapid/</code>.</p>

<p dir="auto">Note: Do not rename the generated keys.</p>

<p dir="auto">Create a shell script named <code>tripwire.caddy.env.sh</code> that exports some environment variables upon execution. These variables will be automatically plugged into Caddy&#39;s config file <code>Caddyfile</code>. It is recommended to put this script outside of Tripwire&#39;s directory to avoid accidentally committing and leaking it to Git. The content of the shell script should be:</p>
<div data-snippet-clipboard-copy-content="export TRIPWIRE_DOM_REG=&#39;...&#39;
export TRIPWIRE_DOM_REG_TOK=&#39;...&#39;
export TRIPWIRE_DOM=&#39;...&#39;
export TRIPWIRE_USER=&#39;...&#39;
export TRIPWIRE_PW=&#39;...&#39;"><pre><code>export TRIPWIRE_DOM_REG=&#39;...&#39;
export TRIPWIRE_DOM_REG_TOK=&#39;...&#39;
export TRIPWIRE_DOM=&#39;...&#39;
export TRIPWIRE_USER=&#39;...&#39;
export TRIPWIRE_PW=&#39;...&#39;
</code></pre></div>
<p dir="auto">Note: The single quotes around the ... are necessary, especially for <code>TRIPWIRE_PW</code>. The script will break without them.</p>
<p dir="auto">Here is an explanation for these environment variables:</p>
<ul dir="auto">
<li><code>TRIPWIRE_DOM_REG</code> should be the name of your domain registrar or DNS provider.</li>
<li><code>TRIPWIRE_DOM_REG_TOK</code> should be the API token provided by your domain registrar or DNS provider.
<ul dir="auto">
<li>Research online to see how you can get an API token with the domain registrar that you use.</li>
</ul>
</li>
<li><code>TRIPWIRE_DOM</code> should be the domain name you got for Tripwire.</li>
<li><code>TRIPWIRE_USER</code> should be the username you want to use for Caddy&#39;s Basic Auth.</li>
<li><code>TRIPWIRE_PW</code> should be the <strong>HASHED AND ENCODED</strong> passphrase you want to use for Caddy&#39;s Basic Auth. To generate the hashed and encoded passphrase:
<ul dir="auto">
<li>First, generate a secure random passphrase using tools like KeePassXC. You probably want a &#34;passphrase&#34; made with several (at least 6) English words, rather than a &#34;password&#34; made with a long string of random character, so that you can actually type it when you are accessing Tripwire on a mobile device when you are away from home.</li>
<li>Second, run <code>caddy hash-password</code>. At the prompt, paste in your plaintext passphrase. It will return the hashed and encoded passphrase, which you can paste after <code>TRIPWIRE_PW</code>.</li>
</ul>
</li>
</ul>
<p dir="auto">An example of <code>tripwire.caddy.env.sh</code>:</p>
<div data-snippet-clipboard-copy-content="export TRIPWIRE_DOM_REG=&#39;duckdns&#39;
export TRIPWIRE_DOM_REG_TOK=&#39;5a3916e346e0b5a0&#39;
export TRIPWIRE_DOM=&#39;my-tripwire.com&#39;
export TRIPWIRE_USER=&#39;Alice&#39;
export TRIPWIRE_PW=&#39;$2a$14$.lGj0kTww2Mi1Z0daBbd9eG/WxHzNjQ6Feo/it5IWPODFtYYFhg2e&#39;"><pre><code>export TRIPWIRE_DOM_REG=&#39;duckdns&#39;
export TRIPWIRE_DOM_REG_TOK=&#39;5a3916e346e0b5a0&#39;
export TRIPWIRE_DOM=&#39;my-tripwire.com&#39;
export TRIPWIRE_USER=&#39;Alice&#39;
export TRIPWIRE_PW=&#39;$2a$14$.lGj0kTww2Mi1Z0daBbd9eG/WxHzNjQ6Feo/it5IWPODFtYYFhg2e&#39;
</code></pre></div>
<p dir="auto">Note: If you are running the server on a custom port, e.g. 12345, and have configured port forwarding for it on the router, then in the example, <code>TRIPWIRE_DOM</code> should be set as <code>my-tripwire.com:12345</code></p>
<p dir="auto">Create another shell script named <code>tripwire.flask.env.sh</code> with the content as:</p>
<div data-snippet-clipboard-copy-content="export TRIPWIRE_VAPID_APP_SERVER_KEY=&#39;...&#39;"><pre><code>export TRIPWIRE_VAPID_APP_SERVER_KEY=&#39;...&#39;
</code></pre></div>
<p dir="auto">The value here can be obtained by running <code>vapid --applicationServerKey</code> under <code>instance/vapid/</code>. It will output &#34;Application Server Key = ...&#34; The value after the equal sign is what you want.</p>

<p dir="auto">Now you should be able to start Tripwire. Spawn one terminal for Gunicorn and Flask:</p>
<div data-snippet-clipboard-copy-content="source tripwire.flask.env.sh
source venv/bin/activate
gunicorn -c gunicorn_config.py &#39;tripwire:create_app()&#39;"><pre><code>source tripwire.flask.env.sh
source venv/bin/activate
gunicorn -c gunicorn_config.py &#39;tripwire:create_app()&#39;
</code></pre></div>
<p dir="auto">Spawn another terminal for Caddy:</p>
<div data-snippet-clipboard-copy-content="caddy run --config Caddyfile"><pre><code>caddy run --config Caddyfile
</code></pre></div>
<p dir="auto">See if there are any errors from either terminal. If not, you can browse to https://[your-domain] on your phone, or https://[your-domain]:[port] if you forwarded a different port on your router, enter the credentials you&#39;ve set up for Caddy&#39;s Basic Auth, and get to Tripwire&#39;s web client! It should look similar to the demo video above.</p>

<p dir="auto">The first thing you need to do is installing Tripwire as a Progressive Web App (PWA), especially on iPhones. This enables Tripwire to send you web push notifications, which is crucial when Tripwire detects intrusion. After installing and opening the PWA, you need to click &#34;Enable Push Notification&#34; to enable it, at least on iPhones.</p>
<p dir="auto">When you are about to deploy Tripwire, start by adjusting the angle of the camera module until it covers the entrance properly. You can click the &#34;Preview&#34; button under the &#34;Live Photos&#34; section to see where the camera module currently captures. Note that the preview is just a static photo so you will need to click &#34;Preview&#34; again after every adjustment. If the device you want to protect is the same one which you use to access Tripwire&#39;s server, make the adjustment before you shut down the device.</p>
<p dir="auto">When you are happy with the camera angle, you can put your target device into the deployment area. Make sure it doesn&#39;t change the camera&#39;s view, so that the pre-configured SSIM thresholds won&#39;t be affected. For example, you can put the protected device behind the camera module and the PIR sensor. After you left the deployment area and closed the door, click the &#34;Arm&#34; button, and Tripwire will start detecting any intrusion. If you need to make further adjustment to the deployment area, or want to test the intrusion detection, you can do it and then click &#34;Re-arm&#34; to reactivate the deployment.</p>
<p dir="auto">After Tripwire&#39;s deployment starts, you will see one secret for the PIR sensor and one secret for the camera module under the &#34;Secrets&#34; section. The &#34;Stored&#34; secret is what the server first shared with the web client, and the &#34;Received&#34; secret is what the server sends every second. Although the web client compares the stored and received secrets automatically, you still need to save the two secrets somewhere (e.g. on your phone or on a piece of paper) because sometimes the web client loses the stored secret after reloading itself. Never let anyone else know what the secrets are.</p>
<p dir="auto">You also need to save the server&#39;s public key in PEM format below, if you need to manually verify the signatures on the microSD card in case of persistent network outage.</p>
<p dir="auto">As the photo stream comes in, each photo has a header bar showing its metadata, which includes:</p>
<ul dir="auto">
<li>The time of when the camera module captures the photo</li>
<li>Whether the photo is stored in the client&#39;s memory (MEM), retrieved from the client&#39;s IndexedDB (DB), or re-acquired from the server (REGET)</li>
<li>Whether the PIR and camera secrets were good when this photo was captured
<ul dir="auto">
<li>If the PIR secret was good at time of capture, it will show the text &#34;PIR&#34; with a green background. Otherwise, it will show the text &#34;Bad PIR with a red background. Same with the camera secret.</li>
</ul>
</li>
<li>Whether the photo comes with no signature (NO SIG), with a signature but the browser doesn&#39;t support signature verification (CANT SIG), with a bad signature (BAD SIG), or with a good signature (GOOD SIG).</li>
</ul>
<p dir="auto">Most other features are self-explanatory. Click the &#34;Re-acquire Missing Photos&#34; button to re-request photos lost during past temporary network outages. Click &#34;Freeze&#34; button to freeze the photo grid so that you can examine certain photos. Pagination is set up conveniently so that if you want to see the photos from 5 minutes ago and &#34;Photos Per Page&#34; is set to 60, you can just go to page number 5, because photos are captured every second.</p>

<p dir="auto">When Tripwire detects intrusion, the server will send web push notifications to the client, if the network is available. The server will also immediately delete the secret of the sensor that made detection. The web client will initially show &#34;null&#34; as the received secrets, until the attacker compromises the server and sends back fake secrets. Any of these should mismatch with the ones you previously saved. Starting from this point, the header bar of each photo will show a red background with the text &#34;BAD&#34; for the sensor that detected intrusion.</p>
<p dir="auto">The only time server will send back photo signatures is after the detection but before the key pair is deleted. This is because before detection, the integrity of the photos is guaranteed by the secrets. And after the key pair is deleted, the server can&#39;t sign. During this time window, if the web client successfully verified the signatures, the header bar of these photos will show &#34;GOOD SIG&#34; in a blue background. You should use these photos to determine if the detection is a true or false positive. If it&#39;s a false positive, click the &#34;Re-arm&#34; button to remotely restart the deployment, and new secrets and new public key will be exchanged. If the browser doesn&#39;t support verifying the signature, which is using the ed25519 algorithm, then the header bar will show &#34;CANT SIG&#34; in orange. If the web client verified that these signatures are invalid, then the header bar will show &#34;BAD SIG&#34; in red. Theoretically it means that an attacker must be tampering with the server. But in practice, some browser may show &#34;BAD SIG&#34; when in fact its signature verification mechanism is faulty. <strong>Make sure you avoid using these browsers that doesn&#39;t support ed25519 signature verification, or has faulty ed25519 signature verification. So far this includes the Brave Browser on Linux Desktop.</strong></p>
<p dir="auto"><strong>It is strongly recommended that you test the intrusion detection with yourself a few times to get familiar with Tripwire&#39;s user interface.</strong></p>

<p dir="auto">If the network is temporarily disabled, then you can simply click &#34;Re-acquire Missing Photos&#34; after the network is up again. Secrets comparison and signature verification will still work. If the network is persistently disabled, then you can&#39;t compare the secrets from the web client. In this case, you will need to enter the deployment area, note down your time of entry, power off the RPi, and take out the microSD card. Plug the microSD card into a computer other than the device you were protecting, because you can&#39;t trust that it wasn&#39;t compromised yet. You can use a friend&#39;s laptop or a random computer in a random public library.</p>
<p dir="auto">On the new computer, copy the <code>instance/captures/</code> directory (which is located under Tripwire&#39;s root directory) from the microSD card onto the hard drive. Assume it is named <code>captures/</code>. Create a file named <code>photo_pubkey.pem</code> and paste in the server public key PEM that you saved earlier. Then, download the script named <code>verify_photo_log.sh</code> from Tripwire&#39;s GitHub repository, and run:</p>
<div data-snippet-clipboard-copy-content="./verify_photo_log.sh photo_pubkey.pem captures/"><pre><code>./verify_photo_log.sh photo_pubkey.pem captures/
</code></pre></div>
<p dir="auto">The script will verify all photos that have signatures. If any signature is verified to be invalid, then an attacker has probably tampered with the photos. If the photos stopped having signatures a while before the user returns to the deployment area, then an attacker has probably been detected.</p>
<p dir="auto">Note: For the new computer, either boot it into a Linux distro, or use things like git bash if you are on Windows. This process hasn&#39;t been tested on Windows or Mac yet.</p>

<p dir="auto">Tripwire should only be one tool in your defense-in-depth. Another very effective layer of defense is called Random Mosaic, which means storing your device into a pile of beads or beans and comparing the pattern after you return. Check out the section about Random Mosaic (not glitter nail polish) on <a href="https://dys2p.com/en/2021-12-tamper-evident-protection.html#kurzzeitige-lagerung" rel="nofollow">this website</a>.</p>
<p dir="auto">If you deploy Tripwire, Random Mosaic, and also TPM + Secure Boot, you will have three layers of defense, a true defense-in-depth against evil maid attacks!</p>

<p dir="auto">Tripwire&#39;s current limitations include:</p>
<ul dir="auto">
<li>It is unclear how to securely delete a piece of data (in our case: the secrets) from the disk and the memory, so that it cannot be recovered. Suggestions are welcome.</li>
<li>If the attacker can deliberately trigger a false positive, they can disable the network, trigger the false positive first, then enter the deployment area and compromise the target devices and Tripwire. Because the false positive will cause Tripwire to delete its signing key for the photo log, and the attacker will only be captured in the unsigned photos after the false positive, this means the attacker can replace the legitimate unsigned photos with forged ones that don&#39;t show their appearance.
<ul dir="auto">
<li>Tripwire still makes things harder for the attacker because they have to figure out a way to trigger a false positive, without it turning into a true positive.</li>
<li>A false positive and a network outage happening at the same time may be enough to alert some users.</li>
</ul>
</li>
<li>Tripwire&#39;s web-based architecure makes it easier to work at the user&#39;s home or on other networks that they control. For hotels, which are generally places of concern for evil maid attacks, currently the user can&#39;t run Tripwire because they probably can&#39;t do port-forwarding on hotel networks. This is an obstacle for HTTPS, and HTTPS is critical for Tripwire.
<ul dir="auto">
<li>A solution is to run a relay server on a cloud service and let it relay communication between Tripwire&#39;s server and client. The relay server is on the roadmap.</li>
</ul>
</li>
</ul>

<p dir="auto">Tripwire is inspired by <a href="https://github.com/guardianproject/haven">Haven</a>, which is a previous anti evil maid system that also detects intrusion with sensors. In comparison, Tripwire is more robust and has more features, while Haven is easier to set up. Unfortunately, Haven has been broken due to difficulty with sending notifications to the user and other problems (See their latest issues <a href="https://github.com/guardianproject/haven/issues">here</a>).</p>
</article></div></div>
  </body>
</html>
