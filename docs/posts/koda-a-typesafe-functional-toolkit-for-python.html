<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://pypi.org/project/koda/">Original</a>
    <h1>Show HN: Koda, a typesafe functional toolkit for Python</h1>
    
    <div id="readability-page-1" class="page"><div>
            
<p>Koda is a collection of practical type-safe tools for Python.</p>
<p>At it&#39;s core are a number of datatypes that are common in functional programming.</p>
<h2>Maybe</h2>
<p><code>Maybe</code> is similar to Python&#39;s <code>Optional</code> type. It has two variants: <code>Nothing</code> and <code>Just</code>, and they work in similar ways
to what you may have seen in other languages.</p>
<pre><span>from</span> <span>koda</span> <span>import</span> <span>Maybe</span><span>,</span> <span>Just</span><span>,</span> <span>nothing</span>

<span>a</span><span>:</span> <span>Maybe</span><span>[</span><span>int</span><span>]</span> <span>=</span> <span>Just</span><span>(</span><span>5</span><span>)</span>
<span>b</span><span>:</span> <span>Maybe</span><span>[</span><span>int</span><span>]</span> <span>=</span> <span>nothing</span>
</pre>
<p>To know if a <code>Maybe</code> is a <code>Just</code> or a <code>Nothing</code>, you&#39;ll need to inspect it.</p>
<pre><span>from</span> <span>koda</span> <span>import</span> <span>Just</span><span>,</span> <span>Maybe</span>

<span>maybe_str</span><span>:</span> <span>Maybe</span><span>[</span><span>str</span><span>]</span> <span>=</span> <span>function_returning_maybe_str</span><span>()</span>

<span># unwrap by checking instance type</span>
<span>if</span> <span>isinstance</span><span>(</span><span>maybe_str</span><span>,</span> <span>Just</span><span>):</span>
    <span>print</span><span>(</span><span>maybe_str</span><span>.</span><span>val</span><span>)</span>
<span>else</span><span>:</span>
    <span>print</span><span>(</span><span>&#34;No value!&#34;</span><span>)</span>

<span># unwrap with structural pattern matching (python 3.10 +)</span>
<span>match</span> <span>maybe_str</span><span>:</span>
    <span>case</span> <span>Just</span><span>(</span><span>val</span><span>):</span>
        <span>print</span><span>(</span><span>val</span><span>)</span>
    <span>case</span> <span>Nothing</span><span>:</span>
        <span>print</span><span>(</span><span>&#34;No value!&#34;</span><span>)</span>
</pre>
<p><code>Maybe</code> has methods for conveniently stringing logic together.</p>
<h4>Maybe.map</h4>
<pre><span>from</span> <span>koda</span> <span>import</span> <span>Just</span><span>,</span> <span>nothing</span>

<span>Just</span><span>(</span><span>5</span><span>)</span><span>.</span><span>map</span><span>(</span><span>lambda</span> <span>x</span><span>:</span> <span>x</span> <span>+</span> <span>10</span><span>)</span>  <span># Just(15)</span>
<span>nothing</span><span>.</span><span>map</span><span>(</span><span>lambda</span> <span>x</span><span>:</span> <span>x</span> <span>+</span> <span>10</span><span>)</span>  <span># Nothing</span>
<span>Just</span><span>(</span><span>5</span><span>)</span><span>.</span><span>map</span><span>(</span><span>lambda</span> <span>x</span><span>:</span> <span>x</span> <span>+</span> <span>10</span><span>)</span><span>.</span><span>map</span><span>(</span><span>lambda</span> <span>x</span><span>:</span> <span>f</span><span>&#34;abc</span><span>{</span><span>x</span><span>}</span><span>&#34;</span><span>)</span>  <span># Just(&#34;abc15&#34;)</span>
</pre>
<h4>Maybe.flat_map</h4>
<pre><span>from</span> <span>koda</span> <span>import</span> <span>Maybe</span><span>,</span> <span>Just</span><span>,</span> <span>nothing</span>


<span>def</span> <span>safe_divide</span><span>(</span><span>dividend</span><span>:</span> <span>int</span><span>,</span> <span>divisor</span><span>:</span> <span>int</span><span>)</span> <span>-&gt;</span> <span>Maybe</span><span>[</span><span>float</span><span>]:</span>
    <span>if</span> <span>divisor</span> <span>!=</span> <span>0</span><span>:</span>
        <span>return</span> <span>Just</span><span>(</span><span>dividend</span> <span>/</span> <span>divisor</span><span>)</span>
    <span>else</span><span>:</span>
        <span>return</span> <span>nothing</span>

<span>Just</span><span>(</span><span>5</span><span>)</span><span>.</span><span>flat_map</span><span>(</span><span>lambda</span> <span>x</span><span>:</span> <span>safe_divide</span><span>(</span><span>10</span><span>,</span> <span>x</span><span>))</span>  <span># Just(2)</span>
<span>Just</span><span>(</span><span>0</span><span>)</span><span>.</span><span>flat_map</span><span>(</span><span>lambda</span> <span>x</span><span>:</span> <span>safe_divide</span><span>(</span><span>10</span><span>,</span> <span>x</span><span>))</span>  <span># Nothing</span>
<span>nothing</span><span>.</span><span>flat_map</span><span>(</span><span>lambda</span> <span>x</span><span>:</span> <span>safe_divide</span><span>(</span><span>10</span><span>,</span> <span>x</span><span>))</span>  <span># Nothing</span>
</pre>
<h2>Result</h2>
<p><code>Result</code> provides a means of representing whether a computation succeeded or failed. To represent success, we can use <code>OK</code>;
for failures we can use <code>Err</code>. Compared to <code>Maybe</code>, <code>Result</code> is perhaps most useful in that the &#34;failure&#34; case also returns data,
whereas <code>Nothing</code> contains no data.</p>
<pre><span>from</span> <span>koda</span> <span>import</span> <span>Ok</span><span>,</span> <span>Err</span><span>,</span> <span>Result</span> 


<span>def</span> <span>safe_divide_result</span><span>(</span><span>dividend</span><span>:</span> <span>int</span><span>,</span> <span>divisor</span><span>:</span> <span>int</span><span>)</span> <span>-&gt;</span> <span>Result</span><span>[</span><span>float</span><span>,</span> <span>str</span><span>]:</span>
    <span>if</span> <span>divisor</span> <span>!=</span> <span>0</span><span>:</span>
        <span>return</span> <span>Ok</span><span>(</span><span>dividend</span> <span>/</span> <span>divisor</span><span>)</span>
    <span>else</span><span>:</span>
        <span>return</span> <span>Err</span><span>(</span><span>&#34;cannot divide by zero!&#34;</span><span>)</span>


<span>Ok</span><span>(</span><span>5</span><span>)</span><span>.</span><span>flat_map</span><span>(</span><span>lambda</span> <span>x</span><span>:</span> <span>safe_divide_result</span><span>(</span><span>10</span><span>,</span> <span>x</span><span>))</span>  <span># Ok(2)</span>
<span>Ok</span><span>(</span><span>0</span><span>)</span><span>.</span><span>flat_map</span><span>(</span><span>lambda</span> <span>x</span><span>:</span> <span>safe_divide_result</span><span>(</span><span>10</span><span>,</span> <span>x</span><span>))</span>  <span># Err(&#34;cannot divide by zero!&#34;) </span>
<span>Err</span><span>(</span><span>&#34;some other error&#34;</span><span>)</span><span>.</span><span>map</span><span>(</span><span>lambda</span> <span>x</span><span>:</span> <span>safe_divide_result</span><span>(</span><span>10</span><span>,</span> <span>x</span><span>))</span>  <span># Err(&#34;some other error&#34;)</span>
</pre>
<p><code>Result</code> can be convenient with <code>try</code>/<code>except</code> logic.</p>
<pre><span>from</span> <span>koda</span> <span>import</span> <span>Result</span><span>,</span> <span>Ok</span><span>,</span> <span>Err</span>

<span>def</span> <span>divide_by</span><span>(</span><span>dividend</span><span>:</span> <span>int</span><span>,</span> <span>divisor</span><span>:</span> <span>int</span><span>)</span> <span>-&gt;</span> <span>Result</span><span>[</span><span>float</span><span>,</span> <span>ZeroDivisionError</span><span>]:</span>
    <span>try</span><span>:</span>
        <span>return</span> <span>Ok</span><span>(</span><span>dividend</span> <span>/</span> <span>divisor</span><span>)</span>
    <span>except</span> <span>ZeroDivisionError</span> <span>as</span> <span>exc</span><span>:</span>
        <span>return</span> <span>Err</span><span>(</span><span>exc</span><span>)</span>


<span>divided</span><span>:</span> <span>Result</span><span>[</span><span>float</span><span>,</span> <span>ZeroDivisionError</span><span>]</span> <span>=</span> <span>divide_by</span><span>(</span><span>10</span><span>,</span> <span>0</span><span>)</span>  <span># Err(ZeroDivisionError(&#34;division by zero&#34;))</span>
</pre>
<p>Another way to perform the same computation would be to use <code>safe_try</code>:</p>
<pre><span>from</span> <span>koda</span> <span>import</span> <span>Result</span><span>,</span> <span>safe_try</span>


<span># not safe on its own!</span>
<span>def</span> <span>divide</span><span>(</span><span>dividend</span><span>:</span> <span>int</span><span>,</span> <span>divisor</span><span>:</span> <span>int</span><span>)</span> <span>-&gt;</span> <span>float</span><span>:</span>
    <span>return</span> <span>dividend</span> <span>/</span> <span>divisor</span>

<span># safe if used with `safe_try`</span>
<span>divided_ok</span><span>:</span> <span>Result</span><span>[</span><span>float</span><span>,</span> <span>ZeroDivisionError</span><span>]</span> <span>=</span> <span>safe_try</span><span>(</span><span>divide</span><span>,</span> <span>10</span><span>,</span> <span>2</span><span>)</span>  <span># Ok(5)</span>
<span>divided_err</span><span>:</span> <span>Result</span><span>[</span><span>float</span><span>,</span> <span>ZeroDivisionError</span><span>]</span> <span>=</span> <span>safe_try</span><span>(</span><span>divide</span><span>,</span> <span>10</span><span>,</span> <span>0</span><span>)</span>  <span># Err(ZeroDivisionError(&#34;division by zero&#34;))</span>
</pre>
<h2>More</h2>
<p>There are many other functions and datatypes included. Some examples:</p>
<h3>compose</h3>
<p>Combine functions by sequencing.</p>
<pre><span>from</span> <span>koda</span> <span>import</span> <span>compose</span>
<span>from</span> <span>typing</span> <span>import</span> <span>Callable</span>

<span>def</span> <span>int_to_str</span><span>(</span><span>val</span><span>:</span> <span>int</span><span>)</span> <span>-&gt;</span> <span>str</span><span>:</span>
    <span>return</span> <span>str</span><span>(</span><span>val</span><span>)</span>

<span>def</span> <span>prepend_str_abc</span><span>(</span><span>val</span><span>:</span> <span>str</span><span>)</span> <span>-&gt;</span> <span>str</span><span>:</span>
    <span>return</span> <span>f</span><span>&#34;abc</span><span>{</span><span>val</span><span>}</span><span>&#34;</span>    

<span>combined_func</span><span>:</span> <span>Callable</span><span>[[</span><span>int</span><span>],</span> <span>str</span><span>]</span> <span>=</span> <span>compose</span><span>(</span><span>int_to_str</span><span>,</span> <span>prepend_str_abc</span><span>)</span>
<span>assert</span> <span>combined_func</span><span>(</span><span>10</span><span>)</span> <span>==</span> <span>&#34;abc10&#34;</span>
</pre>
<h3>mapping_get</h3>
<p>Try to get a value from a <code>Mapping</code> object, and return an unambiguous result.</p>
<pre><span>from</span> <span>koda</span> <span>import</span> <span>mapping_get</span><span>,</span> <span>Just</span><span>,</span> <span>Maybe</span><span>,</span> <span>nothing</span>

<span>example_dict</span><span>:</span> <span>dict</span><span>[</span><span>str</span><span>,</span> <span>Maybe</span><span>[</span><span>int</span><span>]]</span> <span>=</span> <span>{</span><span>&#34;a&#34;</span><span>:</span> <span>Just</span><span>(</span><span>1</span><span>),</span> <span>&#34;b&#34;</span><span>:</span> <span>nothing</span><span>}</span>

<span>assert</span> <span>mapping_get</span><span>(</span><span>example_dict</span><span>,</span> <span>&#34;a&#34;</span><span>)</span> <span>==</span> <span>Just</span><span>(</span><span>Just</span><span>(</span><span>1</span><span>))</span>
<span>assert</span> <span>mapping_get</span><span>(</span><span>example_dict</span><span>,</span> <span>&#34;b&#34;</span><span>)</span> <span>==</span> <span>Just</span><span>(</span><span>nothing</span><span>)</span>
<span>assert</span> <span>mapping_get</span><span>(</span><span>example_dict</span><span>,</span> <span>&#34;c&#34;</span><span>)</span> <span>==</span> <span>nothing</span>
</pre>
<p>As a comparison, note that <code>dict.get</code> can return ambiguous results:</p>
<pre><span>from</span> <span>typing</span> <span>import</span> <span>Optional</span>

<span>example_dict</span><span>:</span> <span>dict</span><span>[</span><span>str</span><span>,</span> <span>Optional</span><span>[</span><span>int</span><span>]]</span> <span>=</span> <span>{</span><span>&#34;a&#34;</span><span>:</span> <span>1</span><span>,</span> <span>&#34;b&#34;</span><span>:</span> <span>None</span><span>}</span>

<span>assert</span> <span>example_dict</span><span>.</span><span>get</span><span>(</span><span>&#34;b&#34;</span><span>)</span> <span>is</span> <span>None</span>
<span>assert</span> <span>example_dict</span><span>.</span><span>get</span><span>(</span><span>&#34;c&#34;</span><span>)</span> <span>is</span> <span>None</span>
</pre>
<p>We can&#39;t tell from the resulting value whether the <code>None</code> was the
value for a key, or whether the key was not present in the <code>dict</code></p>
<h3>load_once</h3>
<p>Create a lazy function, which will only call the passed-in function
the first time it is called. After it is called, the value is cached.
The cached value is returned on each successive call.</p>
<pre><span>from</span> <span>random</span> <span>import</span> <span>random</span>
<span>from</span> <span>koda</span> <span>import</span> <span>load_once</span>

<span>call_random_once</span> <span>=</span> <span>load_once</span><span>(</span><span>random</span><span>)</span>  <span># has not called random yet</span>

<span>retrieved_val</span><span>:</span> <span>float</span> <span>=</span> <span>call_random_once</span><span>()</span>
<span>assert</span> <span>retrieved_val</span> <span>==</span> <span>call_random_once</span><span>()</span>
</pre>
<h3>maybe_to_result</h3>
<p>Convert a <code>Maybe</code> to a <code>Result</code> type.</p>
<pre><span>from</span> <span>koda</span> <span>import</span> <span>maybe_to_result</span><span>,</span> <span>Just</span><span>,</span> <span>nothing</span><span>,</span> <span>Ok</span><span>,</span> <span>Err</span>

<span>assert</span> <span>maybe_to_result</span><span>(</span><span>&#34;value if nothing&#34;</span><span>,</span> <span>nothing</span><span>)</span> <span>==</span> <span>Err</span><span>(</span><span>&#34;value if nothing&#34;</span><span>)</span>
<span>assert</span> <span>maybe_to_result</span><span>(</span><span>&#34;value if nothing&#34;</span><span>,</span> <span>Just</span><span>(</span><span>5</span><span>))</span> <span>==</span> <span>Ok</span><span>(</span><span>5</span><span>)</span>
</pre>
<h3>result_to_maybe</h3>
<p>Convert a <code>Result</code> to a <code>Maybe</code> type.</p>
<pre><span>from</span> <span>koda</span> <span>import</span> <span>result_to_maybe</span><span>,</span> <span>Just</span><span>,</span> <span>nothing</span><span>,</span> <span>Ok</span><span>,</span> <span>Err</span>

<span>assert</span> <span>result_to_maybe</span><span>(</span><span>Ok</span><span>(</span><span>5</span><span>))</span> <span>==</span> <span>Just</span><span>(</span><span>5</span><span>)</span>
<span>assert</span> <span>result_to_maybe</span><span>(</span><span>Err</span><span>(</span><span>&#34;any error&#34;</span><span>))</span> <span>==</span> <span>nothing</span> 
</pre>
<h2>Intent</h2>
<p>Koda is intended to focus on a small set of practical data types and utility functions for Python. It will not
grow to encompass every possible functional or typesafe concept. Similarly, the intent of this library is to avoid
requiring extra plugins (beyond a type-checker like mypy or pyright) or specific typchecker settings. As such,
it is unlikely that things like Higher Kinded Types emulation or extended type inference will be implemented in this
library.</p>

          </div></div>
  </body>
</html>
