<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.highgo.ca/2023/12/18/new-in-postgresql-16-bi-directional-logical-replication/">Original</a>
    <h1>PostgreSQL 16 Bi-Directional Logical Replication</h1>
    
    <div id="readability-page-1" class="page"><div>
                        
<h2>Introduction</h2>



<p>In this blog, we’ll be going over some more advanced topics new in Postgres 16. Having some experience with Linux, Postgres, and SQL is necessary as we’ll not only be going over these new features but also how to implement them. This blog was written using PostgreSQL 16 (Development Version) running on Ubuntu 23.04. First I’ll go over some background and a brief introduction to what Bi-Directional Replication is, and why it’s important, then finish off with how we implement Bi-Directional Logical Replication.</p>



<h2>Background</h2>



<p>Before we can start learning about Bi-Directional Logical Replication we first have to understand Logical Replication.</p>



<h3>Basics of Logical Replication</h3>



<p>Logical replication has been supported since PostgreSQL 10 and has received numerous updates and improvements in the following years. Logical Replication is the process of copying (ie. replicating) data objects represented as their changes. This way we can copy only specific changes of objects like tables rather than whole databases, and stream these changes across different platforms and versions. This is all in contrast to Physical replication which uses exact block addresses and as a result, is limited to only copying entire databases and cannot stream across platforms or versions since the data must match in both.</p>



<figure><img decoding="async" loading="lazy" width="701" height="231" src="https://www.highgo.ca/wp-content/uploads/2023/12/logical-replication-1.png" alt="" srcset="https://www.highgo.ca/wp-content/uploads/2023/12/logical-replication-1.png 701w, https://www.highgo.ca/wp-content/uploads/2023/12/logical-replication-1-300x99.png 300w" sizes="(max-width: 701px) 100vw, 701px"/><figcaption>Fig 1: Logical Replication Architecture Overview</figcaption></figure>



<p>Logical replication also introduces two very important elements necessary for understanding its Bi-Directional counterpart. These are Publishers and Subscribers, you can think of them as a leader node (Publisher) and a follower node (Subscriber). The Publisher will gather up its recent changes and send them as an ordered list of commands to the Subscriber. Once received the Subscriber takes this series of commands and applies it to its data. If both databases started with the same data, then the Subscriber will be up-to-date with the Publisher.</p>



<h3>Bi-Directional Replication</h3>



<p>Now that we understand what Logical Replication is, what is Bi-Directional Replication doing differently? In short, Bi-Directional Logical Replication is when all nodes in the replication are both Publisher and Subscriber. Each database can now handle read and write requests, and all the changes will be streamed to one another. This is the Bi-Directional aspect, as rather than changes flowing in one direction as before, they flow in both directions.</p>



<figure><img decoding="async" loading="lazy" src="https://www.highgo.ca/wp-content/uploads/2023/12/unnamed.png" alt="" width="434" height="218" srcset="https://www.highgo.ca/wp-content/uploads/2023/12/unnamed.png 401w, https://www.highgo.ca/wp-content/uploads/2023/12/unnamed-300x150.png 300w" sizes="(max-width: 434px) 100vw, 434px"/><figcaption>Fig. 2: Bi-Directional Replication Architecture Overview</figcaption></figure>



<p>What Postgres 16 adds is a new parameter to the WITH statement that filters out replication from certain nodes. Bi-Directional Logical Replication uses this parameter WITH(ORIGIN = NONE), this filters out all replication from connections with origins that are not NONE. Essentially, this only allows newly added data to be replicated, you can probably see why this is the case. If one database inserts new data and replicates it to a second, this second database will replicate the data also inserting it thus triggering another replication to the original database. We quickly get an infinite loop of replication, which is why this option is necessary to keep everything finite.</p>



<h4>Benefits</h4>



<p>The main benefit of Bi-Direction Logical Replication is that it allows more availability for both read and write requests since we have two Primary nodes. This can be extremely beneficial for a wide range of applications where writing is especially needed.</p>



<h4>Drawbacks</h4>



<p>Bi-Directional Logical Replication requires a few preconditions to operate correctly, as such many of its drawbacks are from these specific conditions. For example, when setting up replication the tables in each database must follow the same schema. Same name and columns, otherwise the Subscriber will not be able to find the table. Until Logical Replication can support replication of the Data Definition Language (DDL) used to create the tables, the user must do this manually to ensure consistency.</p>



<h2>Setting Up</h2>



<p>Now that we understand the basics of Bi-Directional Logical Replication, we can look into how we implement it between two databases. The beginning will be quite similar to setting up regular Logical Replication, but with a very important difference when we are creating the Publishers and Subscribers.</p>



<p>First, we will create the two primary databases which will follow each other:</p>



<pre><code>$ initdb -D database1
$ initdb -D database2</code></pre>



<p>In each database’s postgres.conf file set each’s way_level to logical and give each one a unique port number:</p>



<h4>postgres.conf database1</h4>



<pre><code>port = 5432
wal_level = logical</code></pre>



<h4>postgres.conf database2</h4>



<pre><code>port = 5433
wal_level = logical</code></pre>



<p>Start both databases:</p>



<pre><code>pg_ctl -D database1 -l database1.log start
pg_ctl -D database2 -l database2.log start</code></pre>



<p>Create the Publishers for each Database:</p>



<pre><code># CREATE PUBLICATION mypub1 FOR TABLE mytable;
# CREATE PUBLICATION mypub2 FOR TABLE mytable;</code></pre>



<p>Create the Subscribers for each Database:</p>



<pre><code># CREATE SUBSCRIPTION mysub1 CONNECTION &#39;host=127.0.0.1 port=5433 user=postgres dbname=postgres&#39; PUBLICATION mypub2 WITH(ORIGIN = NONE);

# CREATE SUBSCRIPTION mysub2 CONNECTION &#39;host=127.0.0.1 port=5432 user=postgres dbname=postgres&#39; PUBLICATION mypub1 WITH(ORIGIN = NONE); </code></pre>



<p>Note the order we created the publishers and subscribers, it is very important to first create the Publishers and then the Subscribers. You can refer to Figure 2 if you want a more visual representation, the number in the corner of each component denotes the order of their creation.</p>



<p>Now, when any data is inserted into either database, it should be replicated across both nodes.</p>



<h2>Conclusion</h2>



<p>In this blog, we went over the new Bi-Directional Logical Replication feature in PostgreSQL 16. To start, we went over a brief background on Logical Replication and the Publisher/Subscriber model used for synchronizing data. We then went over how Bi-Directional Logical Replication works and the new parameter that allows it to function without triggering infinite replication loops. Finally, we looked at how to set up Bi-Directional Replication with two primary PostgreSQL databases. With support for synchronization between primary nodes, increasing availability and data persistence should be a breeze for any of your database applications.</p>



<h2>References</h2>



<ul>
<li>C, Vigneshwaran. <em>Bi-Directional Replication Using Origin Filtering in PostgreSQL</em>, Fujitsu, 31 Aug. 2023, www.postgresql.fastware.com/blog/bi-directional-replication-using-origin-filtering-in-postgresql.</li>
</ul>
<div itemtype="http://schema.org/Person" itemscope="" itemprop="author"><div><p><img alt="Tristen Raab" src="https://secure.gravatar.com/avatar/dc00783f1bcdc3fc1c905031e7fd9373?s=100&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/dc00783f1bcdc3fc1c905031e7fd9373?s=200&amp;d=mm&amp;r=g 2x" height="100" width="100" itemprop="image" loading="lazy" decoding="async"/></p><div><p>Tristen received his Bachelor of Applied Science in Computer Engineering from the University of British Columbia in May 2023. He joined HighGo Software Inc. as a Software Engineer fresh out of university and is very excited for his engineering journey to begin. His main interests include Machine Learning, Embedded Systems, and Database Management Systems. With experience in C/C++ and advanced relational databases, Tristen hopes to contribute significantly to the PostgreSQL community as he continues to learn and grow his expertise.</p></div></div></div>                                                                    </div></div>
  </body>
</html>
