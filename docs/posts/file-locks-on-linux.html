<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/FlockFcntlAndNFS">Original</a>
    <h1>File Locks on Linux</h1>
    
    <div id="readability-page-1" class="page"><div><h2>Flock() and fcntl() file locks and Linux NFS (v3)</h2>

	<p><small>May  4, 2023</small></p>
</div><div><p>Unix broadly and Linux specifically has long had three functions
that can do file locks, <a href="https://man7.org/linux/man-pages/man2/flock.2.html">flock()</a>, <a href="https://man7.org/linux/man-pages/man2/fcntl.2.html">fcntl()</a>, and <a href="https://man7.org/linux/man-pages/man3/lockf.3.html">lockf()</a>. The latter
two are collectively known as &#39;POSIX&#39; file locks because they appear
in the POSIX specification (and on Linux lockf() is just a layer
over fcntl()), while flock() is a separate thing with somewhat
different semantics (<a href="https://utcc.utoronto.ca/~cks/space/blog/linux/FlockFcntlChange">cf</a>), as it originated in
BSD Unix. In <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/ProcLocksNotesII">/proc/locks</a>, flock() locks are
type &#39;FLOCK&#39; and fcntl()/lockf() locks are type &#39;POSIX&#39;, and you
can see both on a local system.</p>

<p>(In one of those amusing things, in Ubuntu 22.04 crond takes a
flock() lock on /run/crond.pid while atd takes a POSIX lock on
/run/atd.pid.)</p>

<p>Because they&#39;re different types of locks, you can normally obtain
both an exclusive flock() lock and an exclusive fcntl() POSIX lock
on the same file. As a result of this, some programs adopted the
habit of normally obtaining both sorts of locks, just to cover their
bases for interacting with other unknown programs who might lock
the file.</p>

<p>In the beginning on Linux (before 2005), flock() locks didn&#39;t work
at all over NFS (on Linux); they were strictly local to the current
machine, so two programs on two different machines could obtain
&#39;exclusive&#39; flock locks on the same file. Then 2.6.12&#39;s NFS client
code was modified to accept flock() locks and silently change them
into POSIX locks (that did work over NFS, in NFS v3 through the NLM
protocol). <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/NFSSambaLockingII">This caused heartburn for programs and setups that
were obtaining both sorts of (exclusive) locks on the same file</a>, because obviously two POSIX locks conflict
with each other and your NFS server will not let you have conflicting
locks like that. This change is effectively invisible to the NFS
client&#39;s kernel, so flock() locks on a NFS mounted filesystem will
show up in the client&#39;s /proc/locks (and <a href="https://man7.org/linux/man-pages/man8/lslocks.8.html">lslocks</a>) as type
&#39;FLOCK&#39;. However, on your NFS server all locks from NFS clients are
listed as type &#39;POSIX&#39; in /proc/locks (and <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/ProcLocksNotesII">these days they&#39;re all
&#39;owned&#39; by lockd</a>), because that is what they
are.</p>

<p>(One reason for this is that the NFS v3 NLM protocol doesn&#39;t have
an idea of different types of locks, apart from exclusive or
non-exclusive.)</p>

<p>Unfortunately, this change creates another surprising situation,
which is that <strong>the NFS server and a NFS client can both obtain an
exclusive flock() lock on the same file</strong>. Two NFS clients trying
to exclusively flock() the same file will conflict with each other
and only one will succeed, but the NFS server and an NFS client
won&#39;t, and both will &#39;win&#39; the lock (and everyone loses). This is
the inevitable but surprising consequence of client side flock()
locks being changed to POSIX locks on the NFS server, and POSIX
locks not conflicting with flock() locks. From the NFS server&#39;s
perspective, it&#39;s not two flock() exclusive locks on a file; it&#39;s
one exclusive POSIX lock (from a NFS client) and one exclusive local
flock() lock, and that&#39;s nominally fine.</p>

<p>In my opinion, this makes using flock() locking dangerous in general,
which is unfortunate since <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/FlockUsageNotes">the flock command uses flock() and
it&#39;s pretty much your best bet for locking in shell scripts</a> (see also <a href="https://man7.org/linux/man-pages/man1/flock.1.html">flock(1)</a>). Flock() is
only safe as a potentially cross-machine locking mechanism if you
can be confident that your NFS server will never be doing anything
except serving files via NFS. If things may be running locally on
the NFS server, for example <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/LocalVarMailImprovement">because you moved a very active NFS
filesystem to the primary machine that uses it</a>, then flock() becomes dangerous.</p>

<p>It also means that if you have a lock testing program, <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/TestTheObvious">as I do</a>, you should make it default to either
fcntl() or lockf() locks, whichever you find easier, rather than
flock() locks. <a href="https://man7.org/linux/man-pages/man2/flock.2.html">Flock()</a> has the easiest
API out of the three locking functions, but it may give you results
that are between misleading and wrong if you&#39;re trying to use it
in <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/NFSServerBreakingLocks">a situation where you want to check locking behavior between
a NFS server and a NFS client</a>, as I did
recently.</p>

<p>(Per <a href="https://man7.org/linux/man-pages/man5/nfs.5.html">nfs(5)</a>,
you can use the <code>local_lock</code> mount option to make flock() locks
purely local again on NFS v3 clients, but this doesn&#39;t exactly solve
the problem.)</p>

<p>PS: Given the server flock() issue, I kind of wish there was a generic
mount option to change flock() locks to POSIX locks, so that you could
force this to happen to NFS exported filesystems even on your NFS
fileserver. That would at least make the behavior the same on clients
and the server.</p>

<p>(This elaborates on <a href="https://mastodon.social/@cks/110307942997483067">a learning experience I mentioned on the
Fediverse</a>.)</p>
</div></div>
  </body>
</html>
