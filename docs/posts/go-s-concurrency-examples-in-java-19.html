<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mccue.dev/pages/5-2-22-go-concurrency-in-java">Original</a>
    <h1>Go&#39;s Concurrency Examples in Java 19</h1>
    
    <div id="readability-page-1" class="page">

<p> by:  <b> Ethan McCue</b></p>

<h2 id="preface">Preface</h2>
<p>Threads are usually expensive.</p>
<p>There is no way for your operating system to know exactly how much stack space a thread will need so it allocates an amount on the order of around a kilobyte initially and then around a megabyte once the thread starts to be used. You only have around a bakers dozen gigabytes of RAM, so you can only have give or take 10,000 active threads.</p>
<p>The way around this is to implement a some mechanism that takes a limited number of operating system threads and juggles a much larger number of &#34;logical threads&#34; on top of them.</p>
<p>For most languages, this means adding some form of <code>async/await</code> syntax. Where you put an <code>await</code> the language knows it can switch to handling another task. You can only put <code>await</code>s inside of code marked <code>async</code>. This <a href="https://journal.stuffwithstuff.com/2015/02/01/what-color-is-your-function/">has problems</a>.</p>
<p>The Go programming language is different than most in that it implemented this juggling &#34;non-cooperatively&#34;. You don&#39;t explicitly mark your code with <code>async</code> and <code>await</code>, the runtime slices it up for you. They call these cheap threads &#34;goroutines.&#34;</p>
<p>The Java Virtual Machine is going to get an analogous feature called &#34;Virtual Threads.&#34;</p>
<p>This won&#39;t just benefit Java, but every language on the JVM including Clojure, Groovy, Kotlin, and Scala.</p>
<p>Virtual Threads are slated to appear as a &#34;Preview&#34; feature in Java 19 on September 20, 2022. This means that the implementation of the underlying feature is complete and tested, but the public API is subject to breaking changes and must be opted into explicitly.</p>
<p>Many of Go&#39;s patterns around concurrency arise from the conceit that you can create threads with abandon.</p>
<p>Since Java is about to join that club, it seems a good time to go through some of the Go concurrency examples and see what they might look like translated over.</p>
<p>If you want to follow along, you can get an early access build <a href="https://jdk.java.net/loom/">here</a>. Unzip the files and add the <code>bin/</code> directory to your path.</p>
<p>All the examples can be followed in sequence by using <a href="https://docs.oracle.com/en/java/javase/18/docs/specs/man/jshell.html"><code>jshell</code></a>.</p>
<div id="cb1"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span>$</span> java <span>--version</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span>openjdk</span> 19-loom 2022-09-20</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span>OpenJDK</span> Runtime Environment <span>(</span><span>build</span> 19-loom+6-625<span>)</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span>OpenJDK</span> 64-Bit Server VM <span>(</span><span>build</span> 19-loom+6-625, mixed mode, sharing<span>)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span>$</span> jshell <span>--enable-preview</span> <span>--add-modules</span><span>=</span>jdk.incubator.concurrent</span></code></pre></div>
<h2 id="example-1-goroutines">Example 1. Goroutines</h2>
<p><a href="https://go.dev/tour/concurrency/1">https://go.dev/tour/concurrency/1</a></p>
<div id="cb2"><pre><code><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span>package</span> main</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>(</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span>&#34;fmt&#34;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span>&#34;time&#34;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span>)</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span>func</span> say<span>(</span>s <span>string</span><span>)</span> <span>{</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span>for</span> i <span>:=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>5</span><span>;</span> i<span>++</span> <span>{</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        time<span>.</span>Sleep<span>(</span><span>100</span> <span>*</span> time<span>.</span>Millisecond<span>)</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        fmt<span>.</span>Println<span>(</span>s<span>)</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span>func</span> main<span>()</span> <span>{</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span>go</span> say<span>(</span><span>&#34;world&#34;</span><span>)</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    say<span>(</span><span>&#34;hello&#34;</span><span>)</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>This is a pretty classic example, and frankly can be done with operating system threads just as well.</p>
<div id="cb3"><pre><code><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>time</span><span>.</span><span>Duration</span><span>;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>Executors</span><span>;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span>public</span> <span>final</span> <span>class</span> VirtualThreads <span>{</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>VirtualThreads</span><span>()</span> <span>{}</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span>static</span> <span>void</span> <span>say</span><span>(</span><span>String</span> s<span>)</span> <span>{</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>{</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>            <span>for</span> <span>(</span><span>int</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>5</span><span>;</span> i<span>++)</span> <span>{</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>                <span>Thread</span><span>.</span><span>sleep</span><span>(</span><span>Duration</span><span>.</span><span>ofMillis</span><span>(</span><span>100</span><span>));</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span>s<span>);</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>            <span>}</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        <span>}</span> <span>catch</span> <span>(</span><span>InterruptedException</span> e<span>)</span> <span>{</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>            <span>throw</span> <span>new</span> <span>RuntimeException</span><span>(</span>e<span>);</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>String</span><span>[]</span> args<span>)</span> <span>{</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>(</span>var executor <span>=</span> </span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>                <span>Executors</span><span>.</span><span>newVirtualThreadPerTaskExecutor</span><span>())</span> <span>{</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>submit</span><span>(()</span> <span>-&gt;</span> <span>say</span><span>(</span><span>&#34;world&#34;</span><span>));</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>            <span>say</span><span>(</span><span>&#34;hello&#34;</span><span>);</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<div id="cb4"><pre><code><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>VirtualThreads<span>.</span><span>main</span><span>(</span><span>new</span> <span>String</span><span>[]{});</span></span></code></pre></div>
<p>A few key things to notice.</p>
<ol type="1">
<li>There is some noise in the <code>say</code> method around handling what will happen if the thread is interrupted.</li>
</ol>
<p>In this case we just choose to throw a <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/lang/RuntimeException.html"><code>RuntimeException</code></a> to indicate we just want to crash.</p>
<p>In Go there is less noise, but also there no way to interrupt Go&#39;s <a href="https://pkg.go.dev/time#Sleep"><code>time.Sleep</code></a>.</p>
<p>It is also an option to propagate the <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/lang/InterruptedException.html"><code>InterruptedException</code></a> up if we add a <code>return null;</code> to target the <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/Callable.html"><code>Callable</code></a> overload.</p>
<div id="cb5"><pre><code><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span>public</span> <span>final</span> <span>class</span> VirtualThreads <span>{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>VirtualThreads</span><span>()</span> <span>{}</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span>static</span> <span>void</span> <span>say</span><span>(</span><span>String</span> s<span>)</span> <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span>for</span> <span>(</span><span>int</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>5</span><span>;</span> i<span>++)</span> <span>{</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>            <span>Thread</span><span>.</span><span>sleep</span><span>(</span><span>Duration</span><span>.</span><span>ofMillis</span><span>(</span><span>100</span><span>));</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>            <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span>s<span>);</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>String</span><span>[]</span> args<span>)</span> </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>            <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>(</span>var executor <span>=</span> </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>                <span>Executors</span><span>.</span><span>newVirtualThreadPerTaskExecutor</span><span>())</span> <span>{</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>submit</span><span>(()</span> <span>-&gt;</span> <span>{</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>                <span>say</span><span>(</span><span>&#34;world&#34;</span><span>);</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>                <span>return</span> <span>null</span><span>;</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>            <span>});</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>            <span>say</span><span>(</span><span>&#34;hello&#34;</span><span>);</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<ol start="2" type="1">
<li>You need more than <code>go say(&#34;world&#34;)</code></li>
</ol>
<p><code>Executors.newVirtualThreadPerTaskExecutor()</code> creates an <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/ExecutorService.html"><code>ExecutorService</code></a>. This is a thing which you can submit tasks to and it will run them &#34;somehow&#34;.</p>
<p>Today most <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/ExecutorService.html"><code>ExecutorService</code></a>s are backed by some pool of threads. The purpose of the interface is to be able to write code without needing to know about the underlying strategy for maintaining that pool.</p>
<p>Virtual Threads are cheap, so you don&#39;t need to pool them. The interface still serves a use though. <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/ExecutorService.html"><code>ExecutorService</code></a>s will extend <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/lang/AutoCloseable.html"><code>AutoClosable</code></a>, so when used with the &#34;try-with-resources&#34; syntax you can make a block of code where you wait until all tasks have completed before moving on.</p>
<p>If you wanted to do the same creating threads directly it would look like this.</p>
<div id="cb6"><pre><code><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span>public</span> <span>final</span> <span>class</span> VirtualThreads <span>{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>VirtualThreads</span><span>()</span> <span>{}</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span>static</span> <span>void</span> <span>say</span><span>(</span><span>String</span> s<span>)</span> <span>{</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>{</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>            <span>for</span> <span>(</span><span>int</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>5</span><span>;</span> i<span>++)</span> <span>{</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>                <span>Thread</span><span>.</span><span>sleep</span><span>(</span><span>Duration</span><span>.</span><span>ofMillis</span><span>(</span><span>100</span><span>));</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>                <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span>s<span>);</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>            <span>}</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span>}</span> <span>catch</span> <span>(</span><span>InterruptedException</span> e<span>)</span> <span>{</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>            <span>throw</span> <span>new</span> <span>RuntimeException</span><span>(</span>e<span>);</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>String</span><span>[]</span> args<span>)</span> </span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>            <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        var worldThread <span>=</span> <span>Thread</span><span>.</span><span>startVirtualThread</span><span>(</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>            <span>()</span> <span>-&gt;</span> <span>say</span><span>(</span><span>&#34;world&#34;</span><span>)</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        <span>);</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span>say</span><span>(</span><span>&#34;hello&#34;</span><span>);</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        <span>// Explicitly join to wait for the other thread.</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        worldThread<span>.</span><span>join</span><span>();</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<h2 id="example-2-channels">Example 2. Channels</h2>
<p><a href="https://go.dev/tour/concurrency/2">https://go.dev/tour/concurrency/2</a></p>
<div id="cb7"><pre><code><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span>package</span> main</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>&#34;fmt&#34;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span>func</span> sum<span>(</span>s <span>[]</span><span>int</span><span>,</span> c <span>chan</span> <span>int</span><span>)</span> <span>{</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    sum <span>:=</span> <span>0</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span>for</span> _<span>,</span> v <span>:=</span> <span>range</span> s <span>{</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        sum <span>+=</span> v</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    c <span>&lt;-</span> sum <span>// send sum to c</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span>func</span> main<span>()</span> <span>{</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    s <span>:=</span> <span>[]</span><span>int</span><span>{</span><span>7</span><span>,</span> <span>2</span><span>,</span> <span>8</span><span>,</span> <span>-</span><span>9</span><span>,</span> <span>4</span><span>,</span> <span>0</span><span>}</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    c <span>:=</span> <span>make</span><span>(</span><span>chan</span> <span>int</span><span>)</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span>go</span> sum<span>(</span>s<span>[:</span><span>len</span><span>(</span>s<span>)/</span><span>2</span><span>],</span> c<span>)</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span>go</span> sum<span>(</span>s<span>[</span><span>len</span><span>(</span>s<span>)/</span><span>2</span><span>:],</span> c<span>)</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    x<span>,</span> y <span>:=</span> <span>&lt;-</span>c<span>,</span> <span>&lt;-</span>c <span>// receive from c</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    fmt<span>.</span>Println<span>(</span>x<span>,</span> y<span>,</span> x<span>+</span>y<span>)</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>Go has the concept of a &#34;channel.&#34; This is a lightweight pipe along which values can be sent between <a href="https://www.cs.cmu.edu/~crary/819-f09/Hoare78.pdf">&#34;Communicating Sequential Processes&#34;</a>.</p>
<p>Java does not have this concept in its standard library. There are <a href="https://clojure.github.io/core.async/#clojure.core.async/chan">similar constructs</a> in libraries and it <a href="https://cr.openjdk.java.net/~rpressler/loom/loom/sol1_part2.html#channels">may come in the future</a>, but for now no dice.</p>
<p>A somewhat close analogue is a <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/BlockingQueue.html"><code>BlockingQueue</code></a>, so that is what I am going to use for the purposes of these examples.</p>
<div id="cb8"><pre><code><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>ArrayBlockingQueue</span><span>;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>BlockingQueue</span><span>;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>Executors</span><span>;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span>public</span> <span>final</span> <span>class</span> Queues <span>{</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>Queues</span><span>()</span> <span>{}</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span>static</span> <span>void</span> <span>sum</span><span>(</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        <span>int</span><span>[]</span> s<span>,</span> </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        <span>int</span> start<span>,</span> </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span>int</span> end<span>,</span> </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span>BlockingQueue</span><span>&lt;</span><span>Integer</span><span>&gt;</span> queue</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span>)</span> <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span>int</span> sum <span>=</span> <span>0</span><span>;</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span>for</span> <span>(</span><span>int</span> i <span>=</span> start<span>;</span> i <span>&lt;</span> end<span>;</span> i<span>++)</span> <span>{</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>            sum <span>+=</span> s<span>[</span>i<span>];</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        queue<span>.</span><span>put</span><span>(</span>sum<span>);</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>String</span><span>[]</span> args<span>)</span> </span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        <span>int</span><span>[]</span> s <span>=</span> <span>{</span> <span>7</span><span>,</span> <span>2</span><span>,</span> <span>8</span><span>,</span> <span>-</span><span>9</span><span>,</span> <span>4</span><span>,</span> <span>0</span> <span>};</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>(</span>var executor <span>=</span> </span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>                <span>Executors</span><span>.</span><span>newVirtualThreadPerTaskExecutor</span><span>())</span> <span>{</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>            var queue <span>=</span> <span>new</span> <span>ArrayBlockingQueue</span><span>&lt;</span><span>Integer</span><span>&gt;(</span><span>1</span><span>);</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>submit</span><span>(()</span> <span>-&gt;</span> <span>{</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>                <span>sum</span><span>(</span>s<span>,</span> <span>0</span><span>,</span> s<span>.</span><span>length</span> <span>/</span> <span>2</span><span>,</span> queue<span>);</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>                <span>return</span> <span>null</span><span>;</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>            <span>});</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>submit</span><span>(()</span> <span>-&gt;</span> <span>{</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>                <span>sum</span><span>(</span>s<span>,</span> s<span>.</span><span>length</span> <span>/</span> <span>2</span><span>,</span> s<span>.</span><span>length</span><span>,</span> queue<span>);</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>                <span>return</span> <span>null</span><span>;</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>            <span>});</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>            <span>int</span> x <span>=</span> queue<span>.</span><span>take</span><span>();</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>            <span>int</span> y <span>=</span> queue<span>.</span><span>take</span><span>();</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>            <span>System</span><span>.</span><span>out</span><span>.</span><span>printf</span><span>(</span><span>&#34;</span><span>%d</span><span> </span><span>%d</span><span> </span><span>%d\n</span><span>&#34;</span><span>,</span> x<span>,</span> y<span>,</span> x <span>+</span> y<span>);</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<div id="cb9"><pre><code><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>Queues<span>.</span><span>main</span><span>(</span><span>new</span> <span>String</span><span>[]{});</span></span></code></pre></div>
<p>Instead of Go&#39;s syntax for making slices of arrays, I opted to instead pass the indexes that each <code>sum</code> call was expected to work on.</p>
<p>It is only safe to share the memory for the array like this because no other threads are changing its contents. If there was we would have summoned Gorslax. This would be true in both Go and Java.</p>
<p>In both cases the way this works is each worker sends the results of its computation to a logical queue. Once we have read two values off the shared queue we implicitly know that the two tasks we started have finished.</p>
<p>For &#34;one shot&#34; use cases such as this, you could also use Java&#39;s <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a> for the same purpose.</p>
<div id="cb10"><pre><code><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>CompletableFuture</span><span>;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>ExecutionException</span><span>;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>Executors</span><span>;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span>public</span> <span>final</span> <span>class</span> Queues <span>{</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>Queues</span><span>()</span> <span>{}</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span>static</span> <span>void</span> <span>sum</span><span>(</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span>int</span><span>[]</span> s<span>,</span> </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        <span>int</span> start<span>,</span> </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span>int</span> end<span>,</span> </span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        CompletableFuture<span>&lt;</span><span>Integer</span><span>&gt;</span> future</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span>)</span> <span>{</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        <span>int</span> sum <span>=</span> <span>0</span><span>;</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span>for</span> <span>(</span><span>int</span> i <span>=</span> start<span>;</span> i <span>&lt;</span> end<span>;</span> i<span>++)</span> <span>{</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>            sum <span>+=</span> s<span>[</span>i<span>];</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        future<span>.</span><span>complete</span><span>(</span>sum<span>);</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>String</span><span>[]</span> args<span>)</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        <span>throws</span> <span>InterruptedException</span><span>,</span> <span>ExecutionException</span> <span>{</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        <span>int</span><span>[]</span> s <span>=</span> <span>{</span> <span>7</span><span>,</span> <span>2</span><span>,</span> <span>8</span><span>,</span> <span>-</span><span>9</span><span>,</span> <span>4</span><span>,</span> <span>0</span> <span>};</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>(</span>var executor <span>=</span> </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>                <span>Executors</span><span>.</span><span>newVirtualThreadPerTaskExecutor</span><span>())</span> <span>{</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>            var futureOne <span>=</span> <span>new</span> CompletableFuture<span>&lt;</span><span>Integer</span><span>&gt;();</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>            var futureTwo <span>=</span> <span>new</span> CompletableFuture<span>&lt;</span><span>Integer</span><span>&gt;();</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>submit</span><span>(()</span> <span>-&gt;</span> <span>{</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>                <span>sum</span><span>(</span>s<span>,</span> <span>0</span><span>,</span> s<span>.</span><span>length</span> <span>/</span> <span>2</span><span>,</span> futureOne<span>);</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>                <span>return</span> <span>null</span><span>;</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>            <span>});</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>submit</span><span>(()</span> <span>-&gt;</span> <span>{</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>                <span>sum</span><span>(</span>s<span>,</span> s<span>.</span><span>length</span> <span>/</span> <span>2</span><span>,</span> s<span>.</span><span>length</span><span>,</span> futureTwo<span>);</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>                <span>return</span> <span>null</span><span>;</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>            <span>});</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>            <span>int</span> x <span>=</span> futureOne<span>.</span><span>get</span><span>();</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>            <span>int</span> y <span>=</span> futureTwo<span>.</span><span>get</span><span>();</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>            <span>System</span><span>.</span><span>out</span><span>.</span><span>printf</span><span>(</span><span>&#34;</span><span>%d</span><span> </span><span>%d</span><span> </span><span>%d\n</span><span>&#34;</span><span>,</span> x<span>,</span> y<span>,</span> x <span>+</span> y<span>);</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>This adds <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/ExecutionException.html"><code>ExecutionException</code></a> to the explicit list of things that can go wrong, but is a more direct api for a task that will run and produce one value as a result.</p>
<p>In fact, if we were to change <code>sum</code> to return its result directly then we could eliminate its awareness that it is being run asynchronously.</p>
<div id="cb11"><pre><code><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>CompletableFuture</span><span>;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>ExecutionException</span><span>;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>Executors</span><span>;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span>public</span> <span>final</span> <span>class</span> Queues <span>{</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>Queues</span><span>()</span> <span>{}</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span>static</span> <span>int</span> <span>sum</span><span>(</span><span>int</span><span>[]</span> s<span>,</span> <span>int</span> start<span>,</span> <span>int</span> end<span>)</span>  <span>{</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>        <span>int</span> sum <span>=</span> <span>0</span><span>;</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        <span>for</span> <span>(</span><span>int</span> i <span>=</span> start<span>;</span> i <span>&lt;</span> end<span>;</span> i<span>++)</span> <span>{</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>            sum <span>+=</span> s<span>[</span>i<span>];</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        <span>return</span> sum<span>;</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>String</span><span>[]</span> args<span>)</span> </span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        <span>throws</span> <span>InterruptedException</span><span>,</span> <span>ExecutionException</span> <span>{</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        <span>int</span><span>[]</span> s <span>=</span> <span>{</span> <span>7</span><span>,</span> <span>2</span><span>,</span> <span>8</span><span>,</span> <span>-</span><span>9</span><span>,</span> <span>4</span><span>,</span> <span>0</span> <span>};</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>(</span>var executor <span>=</span> </span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>                <span>Executors</span><span>.</span><span>newVirtualThreadPerTaskExecutor</span><span>())</span> <span>{</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>            var futureOne <span>=</span> CompletableFuture</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>                    <span>.</span><span>supplyAsync</span><span>(</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>                        <span>()</span> <span>-&gt;</span>  <span>sum</span><span>(</span>s<span>,</span> <span>0</span><span>,</span> s<span>.</span><span>length</span> <span>/</span> <span>2</span><span>),</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>                        executor</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>                    <span>);</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>            var futureTwo <span>=</span> CompletableFuture</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>                    <span>.</span><span>supplyAsync</span><span>(</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>                        <span>()</span> <span>-&gt;</span>  <span>sum</span><span>(</span>s<span>,</span> s<span>.</span><span>length</span> <span>/</span> <span>2</span><span>,</span> s<span>.</span><span>length</span><span>),</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>                        executor</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>                    <span>);</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>            <span>int</span> x <span>=</span> futureOne<span>.</span><span>get</span><span>();</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>            <span>int</span> y <span>=</span> futureTwo<span>.</span><span>get</span><span>();</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>            <span>System</span><span>.</span><span>out</span><span>.</span><span>printf</span><span>(</span><span>&#34;</span><span>%d</span><span> </span><span>%d</span><span> </span><span>%d\n</span><span>&#34;</span><span>,</span> x<span>,</span> y<span>,</span> x <span>+</span> y<span>);</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>And if we don&#39;t need any of the fancier capabilities of <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a>, then the plain <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/Future.html"><code>Future</code></a> objects returned by submitting directly to the <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/ExecutorService.html"><code>ExecutorService</code></a> are also an option.</p>
<div id="cb12"><pre><code><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>ExecutionException</span><span>;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>Executors</span><span>;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span>public</span> <span>final</span> <span>class</span> Queues <span>{</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>Queues</span><span>()</span> <span>{}</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span>static</span> <span>int</span> <span>sum</span><span>(</span><span>int</span><span>[]</span> s<span>,</span> <span>int</span> start<span>,</span> <span>int</span> end<span>)</span>  <span>{</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span>int</span> sum <span>=</span> <span>0</span><span>;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span>for</span> <span>(</span><span>int</span> i <span>=</span> start<span>;</span> i <span>&lt;</span> end<span>;</span> i<span>++)</span> <span>{</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>            sum <span>+=</span> s<span>[</span>i<span>];</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span>return</span> sum<span>;</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>String</span><span>[]</span> args<span>)</span> </span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span>throws</span> <span>InterruptedException</span><span>,</span> <span>ExecutionException</span> <span>{</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        <span>int</span><span>[]</span> s <span>=</span> <span>{</span> <span>7</span><span>,</span> <span>2</span><span>,</span> <span>8</span><span>,</span> <span>-</span><span>9</span><span>,</span> <span>4</span><span>,</span> <span>0</span> <span>};</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>(</span>var executor <span>=</span> </span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>                <span>Executors</span><span>.</span><span>newVirtualThreadPerTaskExecutor</span><span>())</span> <span>{</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>            var futureOne <span>=</span> executor<span>.</span><span>submit</span><span>(</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>                <span>()</span> <span>-&gt;</span>  <span>sum</span><span>(</span>s<span>,</span> <span>0</span><span>,</span> s<span>.</span><span>length</span> <span>/</span> <span>2</span><span>)</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>            <span>);</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>            var futureTwo <span>=</span> executor<span>.</span><span>submit</span><span>(</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>                <span>()</span> <span>-&gt;</span>  <span>sum</span><span>(</span>s<span>,</span> s<span>.</span><span>length</span> <span>/</span> <span>2</span><span>,</span> s<span>.</span><span>length</span><span>)</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>            <span>);</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>            <span>int</span> x <span>=</span> futureOne<span>.</span><span>get</span><span>();</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>            <span>int</span> y <span>=</span> futureTwo<span>.</span><span>get</span><span>();</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>            <span>System</span><span>.</span><span>out</span><span>.</span><span>printf</span><span>(</span><span>&#34;</span><span>%d</span><span> </span><span>%d</span><span> </span><span>%d\n</span><span>&#34;</span><span>,</span> x<span>,</span> y<span>,</span> x <span>+</span> y<span>);</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<h2 id="example-3-buffered-channels">Example 3. Buffered Channels</h2>
<p><a href="https://go.dev/tour/concurrency/3">https://go.dev/tour/concurrency/3</a></p>
<div id="cb13"><pre><code><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span>package</span> main</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>&#34;fmt&#34;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span>func</span> main<span>()</span> <span>{</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    ch <span>:=</span> <span>make</span><span>(</span><span>chan</span> <span>int</span><span>,</span> <span>2</span><span>)</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    ch <span>&lt;-</span> <span>1</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    ch <span>&lt;-</span> <span>2</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    fmt<span>.</span>Println<span>(&lt;-</span>ch<span>)</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    fmt<span>.</span>Println<span>(&lt;-</span>ch<span>)</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>There isn&#39;t much to this one. Go&#39;s channels can be &#34;buffered&#34;, meaning they can accept multiple values before they will be &#34;full&#34;. If a channel is full then any thread that wants to put a value onto that channel will have to wait until another thread takes a value off.</p>
<p>The <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/ArrayBlockingQueue.html"><code>ArrayBlockingQueue</code></a> class we&#39;ve been using works the same way.</p>
<div id="cb14"><pre><code><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>ArrayBlockingQueue</span><span>;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span>public</span> <span>final</span> <span>class</span> BufferedQueue <span>{</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>BufferedQueue</span><span>()</span> <span>{}</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>String</span><span>[]</span> args<span>)</span> </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        var queue <span>=</span> <span>new</span> <span>ArrayBlockingQueue</span><span>&lt;</span><span>Integer</span><span>&gt;(</span><span>2</span><span>);</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        queue<span>.</span><span>put</span><span>(</span><span>1</span><span>);</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        queue<span>.</span><span>put</span><span>(</span><span>2</span><span>);</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span>queue<span>.</span><span>take</span><span>());</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span>queue<span>.</span><span>take</span><span>());</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<div id="cb15"><pre><code><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>BufferedQueue<span>.</span><span>main</span><span>(</span><span>new</span> <span>String</span><span>[]{});</span></span></code></pre></div>
<h2 id="example-4-range-and-close">Example 4. Range and Close</h2>
<p><a href="https://go.dev/tour/concurrency/4">https://go.dev/tour/concurrency/4</a></p>
<div id="cb16"><pre><code><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span>package</span> main</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>(</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span>&#34;fmt&#34;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span>)</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span>func</span> fibonacci<span>(</span>n <span>int</span><span>,</span> c <span>chan</span> <span>int</span><span>)</span> <span>{</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    x<span>,</span> y <span>:=</span> <span>0</span><span>,</span> <span>1</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span>for</span> i <span>:=</span> <span>0</span><span>;</span> i <span>&lt;</span> n<span>;</span> i<span>++</span> <span>{</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>        c <span>&lt;-</span> x</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        x<span>,</span> y <span>=</span> y<span>,</span> x<span>+</span>y</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span>close</span><span>(</span>c<span>)</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span>func</span> main<span>()</span> <span>{</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    c <span>:=</span> <span>make</span><span>(</span><span>chan</span> <span>int</span><span>,</span> <span>10</span><span>)</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span>go</span> fibonacci<span>(</span><span>cap</span><span>(</span>c<span>),</span> c<span>)</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    <span>for</span> i <span>:=</span> <span>range</span> c <span>{</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        fmt<span>.</span>Println<span>(</span>i<span>)</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>Here is where the differences between a Java <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/BlockingQueue.html"><code>BlockingQueue</code></a> and a Go <code>chan</code> start to manifest themselves.</p>
<p>There is no ability to &#34;close&#34; a <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/BlockingQueue.html"><code>BlockingQueue</code></a>. One way around this is to send a special &#34;sentinel&#34; value over the queue to indicate that a reader should stop reading. This only works cleanly when we have a single reader though.</p>
<p>There is also no equivalent to the <code>range</code> operator. We need to write a normal <code>while</code> loop.</p>
<div id="cb17"><pre><code><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>ArrayBlockingQueue</span><span>;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>BlockingQueue</span><span>;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>Executors</span><span>;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>sealed <span>interface</span> TakeResult<span>&lt;</span>T<span>&gt;</span> <span>{</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    record GotValue<span>&lt;</span>T<span>&gt;(</span>T value<span>)</span> <span>implements</span> TakeResult<span>&lt;</span>T<span>&gt;</span> <span>{}</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    record NoValue<span>&lt;</span>T<span>&gt;()</span> <span>implements</span> TakeResult<span>&lt;</span>T<span>&gt;</span> <span>{}</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span>public</span> <span>final</span> <span>class</span> Fibonacci <span>{</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>Fibonacci</span><span>()</span> <span>{}</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span>static</span> <span>void</span> <span>fibonacci</span><span>(</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        <span>int</span> n<span>,</span> </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        <span>BlockingQueue</span><span>&lt;</span>TakeResult<span>&lt;</span><span>Integer</span><span>&gt;&gt;</span> queue</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span>)</span> <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        <span>int</span> x <span>=</span> <span>0</span><span>;</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        <span>int</span> y <span>=</span> <span>1</span><span>;</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        <span>for</span> <span>(</span><span>int</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> n<span>;</span> i<span>++)</span> <span>{</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>            queue<span>.</span><span>put</span><span>(</span><span>new</span> TakeResult<span>.</span><span>GotValue</span><span>&lt;&gt;(</span>x<span>));</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>            <span>int</span> temp <span>=</span> x<span>;</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>            x <span>=</span> y<span>;</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>            y <span>=</span> temp <span>+</span> x<span>;</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        queue<span>.</span><span>put</span><span>(</span><span>new</span> TakeResult<span>.</span><span>NoValue</span><span>&lt;&gt;());</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>String</span><span>[]</span> args<span>)</span> </span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>        <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>(</span>var executor <span>=</span> </span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>                <span>Executors</span><span>.</span><span>newVirtualThreadPerTaskExecutor</span><span>())</span> <span>{</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>            var queue <span>=</span> </span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>                <span>new</span> <span>ArrayBlockingQueue</span><span>&lt;</span>TakeResult<span>&lt;</span><span>Integer</span><span>&gt;&gt;(</span><span>10</span><span>);</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>submit</span><span>(()</span> <span>-&gt;</span> <span>{</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>                <span>fibonacci</span><span>(</span>queue<span>.</span><span>remainingCapacity</span><span>(),</span> queue<span>);</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>                <span>return</span> <span>null</span><span>;</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>            <span>});</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>            <span>while</span> <span>(</span>queue<span>.</span><span>take</span><span>()</span> <span>instanceof</span> </span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>                    GotValue<span>&lt;</span><span>Integer</span><span>&gt;</span> gotValue<span>)</span> <span>{</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>                <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span>gotValue<span>.</span><span>value</span><span>());</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>            <span>}</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<div id="cb18"><pre><code><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>Fibonacci<span>.</span><span>main</span><span>(</span><span>new</span> <span>String</span><span>[]{});</span></span></code></pre></div>
<p>This snippet makes use of sealed interfaces, a relatively recent addition to Java, for modeling getting either a legitimate value over the queue or a signal to stop consuming.</p>
<p>The other options for the same result would be to drop the generic types from the <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/BlockingQueue.html"><code>BlockingQueue</code></a> and use a special sentinel instance of <code>Object</code> or disallow <code>null</code> values for normal use and have that indicate that the queue is closed.</p>
<h2 id="example-5-select">Example 5. Select</h2>
<p><a href="https://go.dev/tour/concurrency/5">https://go.dev/tour/concurrency/5</a></p>
<div id="cb19"><pre><code><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span>package</span> main</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>&#34;fmt&#34;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span>func</span> fibonacci<span>(</span>c<span>,</span> quit <span>chan</span> <span>int</span><span>)</span> <span>{</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    x<span>,</span> y <span>:=</span> <span>0</span><span>,</span> <span>1</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span>for</span> <span>{</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        <span>select</span> <span>{</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        <span>case</span> c <span>&lt;-</span> x<span>:</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>            x<span>,</span> y <span>=</span> y<span>,</span> x<span>+</span>y</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        <span>case</span> <span>&lt;-</span>quit<span>:</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>            fmt<span>.</span>Println<span>(</span><span>&#34;quit&#34;</span><span>)</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>            <span>return</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span>func</span> main<span>()</span> <span>{</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    c <span>:=</span> <span>make</span><span>(</span><span>chan</span> <span>int</span><span>)</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    quit <span>:=</span> <span>make</span><span>(</span><span>chan</span> <span>int</span><span>)</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span>go</span> <span>func</span><span>()</span> <span>{</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>        <span>for</span> i <span>:=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>10</span><span>;</span> i<span>++</span> <span>{</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>            fmt<span>.</span>Println<span>(&lt;-</span>c<span>)</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>        quit <span>&lt;-</span> <span>0</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    <span>}()</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    fibonacci<span>(</span>c<span>,</span> quit<span>)</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>There is also no equivalent to <code>select</code> for <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/BlockingQueue.html"><code>BlockingQueue</code></a>s. We have to implement that logic in a hand rolled loop.</p>
<div id="cb20"><pre><code><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>ArrayBlockingQueue</span><span>;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>BlockingQueue</span><span>;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>Executors</span><span>;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span>public</span> <span>final</span> <span>class</span> SelectQueues <span>{</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>SelectQueues</span><span>()</span> <span>{}</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span>static</span> <span>void</span> <span>fibonacci</span><span>(</span><span>BlockingQueue</span><span>&lt;</span><span>Integer</span><span>&gt;</span> queue<span>,</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>                          <span>BlockingQueue</span><span>&lt;</span><span>Integer</span><span>&gt;</span> quit<span>)</span> <span>{</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        <span>int</span> x <span>=</span> <span>0</span><span>;</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        <span>int</span> y <span>=</span> <span>1</span><span>;</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        <span>while</span> <span>(</span><span>true</span><span>)</span> <span>{</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>            <span>if</span> <span>(</span>queue<span>.</span><span>offer</span><span>(</span>x<span>))</span> <span>{</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>                <span>int</span> temp <span>=</span> x<span>;</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>                x <span>=</span> y<span>;</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>                y <span>=</span> temp <span>+</span> x<span>;</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>            <span>}</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>            <span>if</span> <span>(</span>quit<span>.</span><span>poll</span><span>()</span> <span>!=</span> <span>null</span><span>)</span> <span>{</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>                <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span><span>&#34;quit&#34;</span><span>);</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>                <span>break</span><span>;</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>            <span>}</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>String</span><span>[]</span> args<span>)</span> <span>{</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>        var queue <span>=</span> <span>new</span> <span>ArrayBlockingQueue</span><span>&lt;</span><span>Integer</span><span>&gt;(</span><span>1</span><span>);</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>        var quit <span>=</span> <span>new</span> <span>ArrayBlockingQueue</span><span>&lt;</span><span>Integer</span><span>&gt;(</span><span>1</span><span>);</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>(</span>var executor <span>=</span> </span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>                <span>Executors</span><span>.</span><span>newVirtualThreadPerTaskExecutor</span><span>())</span> <span>{</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>submit</span><span>(()</span> <span>-&gt;</span> <span>{</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>                <span>for</span> <span>(</span><span>int</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>10</span><span>;</span> i<span>++)</span> <span>{</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>                    <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span>queue<span>.</span><span>take</span><span>());</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>                <span>}</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>                quit<span>.</span><span>put</span><span>(</span><span>0</span><span>);</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>                <span>return</span> <span>null</span><span>;</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>            <span>});</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>            <span>fibonacci</span><span>(</span>queue<span>,</span> quit<span>);</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<div id="cb21"><pre><code><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>SelectQueues<span>.</span><span>main</span><span>(</span><span>new</span> <span>String</span><span>[]{});</span></span></code></pre></div>
<p>I&#39;m unsure for what purpose the Go version uses a channel of integers as its quit mechanism. In Java it is more natural to use something like a shared <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/atomic/AtomicBoolean.html"><code>AtomicBoolean</code></a> as a signal for shutdowwn.</p>
<div id="cb22"><pre><code><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>ArrayBlockingQueue</span><span>;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>BlockingQueue</span><span>;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>Executors</span><span>;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>atomic</span><span>.</span><span>AtomicBoolean</span><span>;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span>public</span> <span>final</span> <span>class</span> SelectQueues <span>{</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>SelectQueues</span><span>()</span> <span>{}</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span>static</span> <span>void</span> <span>fibonacci</span><span>(</span><span>BlockingQueue</span><span>&lt;</span><span>Integer</span><span>&gt;</span> queue<span>,</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>                          <span>AtomicBoolean</span> quit<span>)</span> <span>{</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        <span>int</span> x <span>=</span> <span>0</span><span>;</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        <span>int</span> y <span>=</span> <span>1</span><span>;</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        <span>while</span> <span>(!</span>quit<span>.</span><span>get</span><span>())</span> <span>{</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>            <span>if</span> <span>(</span>queue<span>.</span><span>offer</span><span>(</span>x<span>))</span> <span>{</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>                <span>int</span> temp <span>=</span> x<span>;</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>                x <span>=</span> y<span>;</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>                y <span>=</span> temp <span>+</span> x<span>;</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>            <span>}</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span><span>&#34;quit&#34;</span><span>);</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>String</span><span>[]</span> args<span>)</span> <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        var queue <span>=</span> <span>new</span> <span>ArrayBlockingQueue</span><span>&lt;</span><span>Integer</span><span>&gt;(</span><span>1</span><span>);</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        var quit <span>=</span> <span>new</span> <span>AtomicBoolean</span><span>(</span><span>false</span><span>);</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>(</span>var executor <span>=</span> <span>Executors</span><span>.</span><span>newVirtualThreadPerTaskExecutor</span><span>())</span> <span>{</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>submit</span><span>(()</span> <span>-&gt;</span> <span>{</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>                <span>for</span> <span>(</span><span>int</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>10</span><span>;</span> i<span>++)</span> <span>{</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>                    <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span>queue<span>.</span><span>take</span><span>());</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>                <span>}</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>                quit<span>.</span><span>set</span><span>(</span><span>true</span><span>);</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>                <span>return</span> <span>null</span><span>;</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>            <span>});</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>            <span>fibonacci</span><span>(</span>queue<span>,</span> quit<span>);</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>If it were a situation with multiple &#34;one shot&#34; queues then <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/CompletableFuture.html#anyOf(java.util.concurrent.CompletableFuture...)"><code>CompletableFuture#anyOf</code></a> and similar methods might suffice.</p>
<h2 id="example-6-default-selection">Example 6. Default Selection</h2>
<p><a href="https://go.dev/tour/concurrency/6">https://go.dev/tour/concurrency/6</a></p>
<div id="cb23"><pre><code><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span>package</span> main</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>(</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span>&#34;fmt&#34;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span>&#34;time&#34;</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span>)</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span>func</span> main<span>()</span> <span>{</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    tick <span>:=</span> time<span>.</span>Tick<span>(</span><span>100</span> <span>*</span> time<span>.</span>Millisecond<span>)</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    boom <span>:=</span> time<span>.</span>After<span>(</span><span>500</span> <span>*</span> time<span>.</span>Millisecond<span>)</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span>for</span> <span>{</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        <span>select</span> <span>{</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        <span>case</span> <span>&lt;-</span>tick<span>:</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>            fmt<span>.</span>Println<span>(</span><span>&#34;tick.&#34;</span><span>)</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        <span>case</span> <span>&lt;-</span>boom<span>:</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>            fmt<span>.</span>Println<span>(</span><span>&#34;BOOM!&#34;</span><span>)</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>            <span>return</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        <span>default</span><span>:</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>            fmt<span>.</span>Println<span>(</span><span>&#34;    .&#34;</span><span>)</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>            time<span>.</span>Sleep<span>(</span><span>50</span> <span>*</span> time<span>.</span>Millisecond<span>)</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>There isn&#39;t a novel transformation of this default case syntax, but it is worth noting how Go&#39;s time library directly returns its channels as the mechanism for handling delays.</p>
<div id="cb24"><pre><code><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>time</span><span>.</span><span>Duration</span><span>;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>time</span><span>.</span><span>Instant</span><span>;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>ArrayBlockingQueue</span><span>;</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>Executors</span><span>;</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span>public</span> <span>final</span> <span>class</span> GreenThreadDress <span>{</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>GreenThreadDress</span><span>()</span> <span>{}</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>String</span><span>[]</span> args<span>)</span> </span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>            <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        var executor <span>=</span> </span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>                <span>Executors</span><span>.</span><span>newVirtualThreadPerTaskExecutor</span><span>();</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>{</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>            var tick <span>=</span> <span>new</span> <span>ArrayBlockingQueue</span><span>&lt;</span>Instant<span>&gt;(</span><span>1</span><span>);</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>            var boom <span>=</span> <span>new</span> <span>ArrayBlockingQueue</span><span>&lt;</span>Instant<span>&gt;(</span><span>1</span><span>);</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>submit</span><span>(()</span> <span>-&gt;</span> <span>{</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>                <span>while</span> <span>(</span><span>true</span><span>)</span> <span>{</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>                    <span>Thread</span><span>.</span><span>sleep</span><span>(</span><span>Duration</span><span>.</span><span>ofMillis</span><span>(</span><span>100</span><span>));</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>                    tick<span>.</span><span>put</span><span>(</span>Instant<span>.</span><span>now</span><span>());</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>                <span>}</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>            <span>});</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>submit</span><span>(()</span> <span>-&gt;</span> <span>{</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>                <span>Thread</span><span>.</span><span>sleep</span><span>(</span><span>500</span><span>);</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>                boom<span>.</span><span>put</span><span>(</span>Instant<span>.</span><span>now</span><span>());</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>                <span>return</span> <span>null</span><span>;</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>            <span>});</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>            <span>while</span> <span>(</span><span>true</span><span>)</span> <span>{</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>                <span>if</span> <span>(</span>tick<span>.</span><span>poll</span><span>()</span> <span>!=</span> <span>null</span><span>)</span> <span>{</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>                    <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span><span>&#34;tick.&#34;</span><span>);</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>                <span>}</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>                <span>else</span> <span>if</span> <span>(</span>boom<span>.</span><span>poll</span><span>()</span> <span>!=</span> <span>null</span><span>)</span> <span>{</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>                    <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span><span>&#34;BOOM!&#34;</span><span>);</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>                    <span>break</span><span>;</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>                <span>}</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>                <span>else</span> <span>{</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>                    <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span><span>&#34;    .&#34;</span><span>);</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>                    <span>Thread</span><span>.</span><span>sleep</span><span>(</span><span>Duration</span><span>.</span><span>ofMillis</span><span>(</span><span>50</span><span>));</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>                <span>}</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>            <span>}</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>        <span>}</span> <span>finally</span> <span>{</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>shutdownNow</span><span>();</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>close</span><span>();</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<div id="cb25"><pre><code><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>GreenThreadDress<span>.</span><span>main</span><span>(</span><span>new</span> <span>String</span><span>[]{});</span></span></code></pre></div>
<p>Here we rely on the behavior of <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/ExecutorService.html#shutdownNow()"><code>ExecutorService#shutdownNow</code></a> to interrupt the task pushing to the <code>tick</code> queue. Unlike with the built in Go <a href="https://pkg.go.dev/time#Tick"><code>time.Tick</code></a> where the underlying goroutine is never cancelled and is a &#34;leak.&#34;</p>
<h2 id="example-7-equivalent-binary-trees">Example 7: Equivalent Binary Trees</h2>
<p><a href="https://go.dev/tour/concurrency/7">https://go.dev/tour/concurrency/7</a> <a href="https://go.dev/tour/concurrency/8">https://go.dev/tour/concurrency/8</a></p>
<div id="cb26"><pre><code><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span>package</span> main</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>&#34;golang.org/x/tour/tree&#34;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span>// Walk walks the tree t sending all values</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span>// from the tree to the channel ch.</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span>func</span> Walk<span>(</span>t <span>*</span>tree<span>.</span>Tree<span>,</span> ch <span>chan</span> <span>int</span><span>)</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span>// Same determines whether the trees</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span>// t1 and t2 contain the same values.</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span>func</span> Same<span>(</span>t1<span>,</span> t2 <span>*</span>tree<span>.</span>Tree<span>)</span> <span>bool</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span>func</span> main<span>()</span> <span>{</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>This one is a little bit different since its not a straight example, but instead a challenge you are meant to complete.</p>
<p>A full solution can be found on <a href="https://stackoverflow.com/questions/12224042/go-tour-exercise-7-binary-trees-equivalence">this StackOverflow question</a>.</p>
<div id="cb27"><pre><code><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span>package</span> main</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>&#34;fmt&#34;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>&#34;golang.org/x/tour/tree&#34;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span>// Walk walks the tree t sending all values</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span>// from the tree to the channel ch.</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span>func</span> Walk<span>(</span>t <span>*</span>tree<span>.</span>Tree<span>,</span> ch <span>chan</span> <span>int</span><span>)</span> <span>{</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span>var</span> walker <span>func</span><span>(</span>t <span>*</span>tree<span>.</span>Tree<span>)</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    walker <span>=</span> <span>func</span> <span>(</span>t <span>*</span>tree<span>.</span>Tree<span>)</span> <span>{</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>        <span>if</span> <span>(</span>t <span>==</span> <span>nil</span><span>)</span> <span>{</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>            <span>return</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>        walker<span>(</span>t<span>.</span>Left<span>)</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        ch <span>&lt;-</span> t<span>.</span>Value</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>        walker<span>(</span>t<span>.</span>Right<span>)</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    walker<span>(</span>t<span>)</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    <span>close</span><span>(</span>ch<span>)</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span>// Same determines whether the trees</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a><span>// t1 and t2 contain the same values.</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a><span>func</span> Same<span>(</span>t1<span>,</span> t2 <span>*</span>tree<span>.</span>Tree<span>)</span> <span>bool</span> <span>{</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>    ch1<span>,</span> ch2 <span>:=</span> <span>make</span><span>(</span><span>chan</span> <span>int</span><span>),</span> <span>make</span><span>(</span><span>chan</span> <span>int</span><span>)</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    <span>go</span> Walk<span>(</span>t1<span>,</span> ch1<span>)</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>    <span>go</span> Walk<span>(</span>t2<span>,</span> ch2<span>)</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    <span>for</span> <span>{</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>        v1<span>,</span>ok1 <span>:=</span> <span>&lt;-</span> ch1</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>        v2<span>,</span>ok2 <span>:=</span> <span>&lt;-</span> ch2</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>        <span>if</span> v1 <span>!=</span> v2 <span>||</span> ok1 <span>!=</span> ok2 <span>{</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>            <span>return</span> <span>false</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>        <span>if</span> <span>!</span>ok1 <span>{</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>            <span>break</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>    <span>return</span> <span>true</span></span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a><span>func</span> main<span>()</span> <span>{</span></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>    fmt<span>.</span>Println<span>(</span><span>&#34;1 and 1 same: &#34;</span><span>,</span> Same<span>(</span>tree<span>.</span>New<span>(</span><span>1</span><span>),</span> tree<span>.</span>New<span>(</span><span>1</span><span>)))</span></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>    fmt<span>.</span>Println<span>(</span><span>&#34;1 and 2 same: &#34;</span><span>,</span> Same<span>(</span>tree<span>.</span>New<span>(</span><span>1</span><span>),</span> tree<span>.</span>New<span>(</span><span>2</span><span>)))</span></span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>Where the <code>Tree</code> type is defined seperately <a href="https://cs.opensource.google/go/x/tour/+/master:tree/tree.go">here</a>.</p>
<div id="cb28"><pre><code><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span>// Copyright 2011 The Go Authors.  All rights reserved.</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span>// Use of this source code is governed by a BSD-style</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span>// license that can be found in the LICENSE file.</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span>package</span> tree <span>// import &#34;golang.org/x/tour/tree&#34;</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>(</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span>&#34;fmt&#34;</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span>&#34;math/rand&#34;</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span>)</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span>// A Tree is a binary tree with integer values.</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span>type</span> Tree <span>struct</span> <span>{</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    Left  <span>*</span>Tree</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    Value <span>int</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    Right <span>*</span>Tree</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span>// New returns a new, random binary tree holding the values k, 2k, ..., 10k.</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span>func</span> New<span>(</span>k <span>int</span><span>)</span> <span>*</span>Tree <span>{</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    <span>var</span> t <span>*</span>Tree</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    <span>for</span> _<span>,</span> v <span>:=</span> <span>range</span> rand<span>.</span>Perm<span>(</span><span>10</span><span>)</span> <span>{</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>        t <span>=</span> insert<span>(</span>t<span>,</span> <span>(</span><span>1</span><span>+</span>v<span>)*</span>k<span>)</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    <span>return</span> t</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span>func</span> insert<span>(</span>t <span>*</span>Tree<span>,</span> v <span>int</span><span>)</span> <span>*</span>Tree <span>{</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    <span>if</span> t <span>==</span> <span>nil</span> <span>{</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>        <span>return</span> <span>&amp;</span>Tree<span>{</span><span>nil</span><span>,</span> v<span>,</span> <span>nil</span><span>}</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    <span>if</span> v <span>&lt;</span> t<span>.</span>Value <span>{</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>        t<span>.</span>Left <span>=</span> insert<span>(</span>t<span>.</span>Left<span>,</span> v<span>)</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    <span>}</span> <span>else</span> <span>{</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>        t<span>.</span>Right <span>=</span> insert<span>(</span>t<span>.</span>Right<span>,</span> v<span>)</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>    <span>return</span> t</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a><span>func</span> <span>(</span>t <span>*</span>Tree<span>)</span> String<span>()</span> <span>string</span> <span>{</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>    <span>if</span> t <span>==</span> <span>nil</span> <span>{</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>        <span>return</span> <span>&#34;()&#34;</span></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>    s <span>:=</span> <span>&#34;&#34;</span></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>    <span>if</span> t<span>.</span>Left <span>!=</span> <span>nil</span> <span>{</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>        s <span>+=</span> t<span>.</span>Left<span>.</span>String<span>()</span> <span>+</span> <span>&#34; &#34;</span></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>    s <span>+=</span> fmt<span>.</span>Sprint<span>(</span>t<span>.</span>Value<span>)</span></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>    <span>if</span> t<span>.</span>Right <span>!=</span> <span>nil</span> <span>{</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>        s <span>+=</span> <span>&#34; &#34;</span> <span>+</span> t<span>.</span>Right<span>.</span>String<span>()</span></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>    <span>return</span> <span>&#34;(&#34;</span> <span>+</span> s <span>+</span> <span>&#34;)&#34;</span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>So before touching the concurrency bits we need to translate this <code>Tree</code> type.</p>
<div id="cb29"><pre><code><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>Collections</span><span>;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>stream</span><span>.</span><span>Collectors</span><span>;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>stream</span><span>.</span><span>IntStream</span><span>;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span>public</span> sealed <span>interface</span> Tree <span>{</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    Tree <span>insert</span><span>(</span><span>int</span> v<span>);</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    record <span>NotEmpty</span><span>(</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>            Tree left<span>,</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>            <span>int</span> value<span>,</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>            Tree right</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    <span>)</span> <span>implements</span> Tree <span>{</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>        <span>@Override</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>        <span>public</span> Tree <span>insert</span><span>(</span><span>int</span> v<span>)</span> <span>{</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>            <span>if</span> <span>(</span>v <span>&lt;</span> <span>this</span><span>.</span><span>value</span><span>)</span> <span>{</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>                <span>return</span> <span>new</span> <span>NotEmpty</span><span>(</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>                        <span>this</span><span>.</span><span>left</span><span>.</span><span>insert</span><span>(</span>v<span>),</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>                        <span>this</span><span>.</span><span>value</span><span>,</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>                        <span>this</span><span>.</span><span>right</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>                <span>);</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>            <span>}</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>            <span>else</span> <span>{</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>                <span>return</span> <span>new</span> <span>NotEmpty</span><span>(</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>                        <span>this</span><span>.</span><span>left</span><span>,</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>                        <span>this</span><span>.</span><span>value</span><span>,</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>                        <span>this</span><span>.</span><span>right</span><span>.</span><span>insert</span><span>(</span>v<span>)</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>                <span>);</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>            <span>}</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>        <span>@Override</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>        <span>public</span> <span>String</span> <span>toString</span><span>()</span> <span>{</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>            <span>return</span> <span>&#34;( &#34;</span> <span>+</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>                <span>this</span><span>.</span><span>left</span> <span>+</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>                <span>this</span><span>.</span><span>value</span> <span>+</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>                <span>this</span><span>.</span><span>right</span> <span>+</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>                <span>&#34; )&#34;</span><span>;</span></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>    record <span>Empty</span><span>()</span> <span>implements</span> Tree <span>{</span></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>        <span>@Override</span></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>        <span>public</span> Tree <span>insert</span><span>(</span><span>int</span> v<span>)</span> <span>{</span></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>            <span>return</span> <span>new</span> <span>NotEmpty</span><span>(</span><span>new</span> <span>Empty</span><span>(),</span> v<span>,</span> <span>new</span> <span>Empty</span><span>());</span></span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>        <span>@Override</span></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>        <span>public</span> <span>String</span> <span>toString</span><span>()</span> <span>{</span></span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>            <span>return</span> <span>&#34;&#34;</span><span>;</span></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>    <span>static</span> Tree <span>random</span><span>(</span><span>int</span> k<span>)</span> <span>{</span></span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>        var vs <span>=</span> IntStream<span>.</span><span>range</span><span>(</span><span>0</span><span>,</span> <span>10</span><span>)</span></span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>                <span>.</span><span>boxed</span><span>()</span></span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>                <span>.</span><span>collect</span><span>(</span>Collectors<span>.</span><span>toList</span><span>());</span></span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>        <span>Collections</span><span>.</span><span>shuffle</span><span>(</span>vs<span>);</span></span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>        Tree t <span>=</span> <span>new</span> <span>Empty</span><span>();</span></span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>        <span>for</span> <span>(</span><span>int</span> v <span>:</span> vs<span>)</span> <span>{</span></span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>            t <span>=</span> t<span>.</span><span>insert</span><span>((</span><span>1</span> <span>+</span> v<span>)</span> <span>*</span> k<span>);</span></span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>        <span>return</span> t<span>;</span></span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>A 1-1 translation of the Go wouldn&#39;t be fun Java, so I opted to translate it instead to an immutable sum type. This won&#39;t affect the concurrent part other than a stronger conceptual guarentee that we can safely share the tree across multiple threads.</p>
<p>With this version the Go maps pretty straight forwardly to this.</p>
<div id="cb30"><pre><code><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>ArrayBlockingQueue</span><span>;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>BlockingQueue</span><span>;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>Executors</span><span>;</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>sealed <span>interface</span> TakeResult<span>&lt;</span>T<span>&gt;</span> <span>{</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    record GotValue<span>&lt;</span>T<span>&gt;(</span>T value<span>)</span> <span>implements</span> TakeResult<span>&lt;</span>T<span>&gt;</span> <span>{}</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    record NoValue<span>&lt;</span>T<span>&gt;()</span> <span>implements</span> TakeResult<span>&lt;</span>T<span>&gt;</span> <span>{}</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span>public</span> <span>final</span> <span>class</span> TreeWalker <span>{</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>TreeWalker</span><span>()</span> <span>{}</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>static</span> <span>void</span> <span>walkHelper</span><span>(</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>            Tree tree<span>,</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>            <span>BlockingQueue</span><span>&lt;</span>TakeResult<span>&lt;</span><span>Integer</span><span>&gt;&gt;</span> queue</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span>)</span> <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>        <span>if</span> <span>(</span>tree <span>==</span> <span>null</span><span>)</span> <span>{</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>            <span>return</span><span>;</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>        <span>walkHelper</span><span>(</span>tree<span>.</span><span>left</span><span>,</span> queue<span>);</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>        queue<span>.</span><span>put</span><span>(</span><span>new</span> TakeResult<span>.</span><span>GotValue</span><span>&lt;&gt;(</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>                tree<span>.</span><span>value</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>        <span>));</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>        <span>walkHelper</span><span>(</span>tree<span>.</span><span>right</span><span>,</span> queue<span>);</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    <span>static</span> <span>void</span> <span>walk</span><span>(</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>            Tree tree<span>,</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>            <span>BlockingQueue</span><span>&lt;</span>TakeResult<span>&lt;</span><span>Integer</span><span>&gt;&gt;</span> queue</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    <span>)</span> <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>        <span>walkHelper</span><span>(</span>tree<span>,</span> queue<span>);</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>        queue<span>.</span><span>put</span><span>(</span><span>new</span> TakeResult<span>.</span><span>NoValue</span><span>&lt;&gt;());</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>    <span>static</span> <span>boolean</span> <span>same</span><span>(</span>Tree t1<span>,</span> Tree t2<span>)</span> </span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>            <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>        var queue1 <span>=</span> <span>new</span> <span>ArrayBlockingQueue</span><span>&lt;</span>TakeResult<span>&lt;</span><span>Integer</span><span>&gt;&gt;(</span><span>1</span><span>);</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>        var queue2 <span>=</span> <span>new</span> <span>ArrayBlockingQueue</span><span>&lt;</span>TakeResult<span>&lt;</span><span>Integer</span><span>&gt;&gt;(</span><span>1</span><span>);</span></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>        var executor <span>=</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>                <span>Executors</span><span>.</span><span>newVirtualThreadPerTaskExecutor</span><span>();</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>{</span></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>submit</span><span>(()</span> <span>-&gt;</span> <span>{</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>                <span>walk</span><span>(</span>t1<span>,</span> queue1<span>);</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>                <span>return</span> <span>null</span><span>;</span></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>            <span>});</span></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>submit</span><span>(()</span> <span>-&gt;</span> <span>{</span></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>                <span>walk</span><span>(</span>t2<span>,</span> queue2<span>);</span></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>                <span>return</span> <span>null</span><span>;</span></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>            <span>});</span></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>            <span>while</span> <span>(</span><span>true</span><span>)</span> <span>{</span></span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>                var result1 <span>=</span> queue1<span>.</span><span>take</span><span>();</span></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>                var result2 <span>=</span> queue2<span>.</span><span>take</span><span>();</span></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>                <span>if</span> <span>(!</span>result1<span>.</span><span>equals</span><span>(</span>result2<span>))</span> <span>{</span></span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>                    <span>return</span> <span>false</span><span>;</span></span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>                <span>}</span></span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>                <span>if</span> <span>(</span>result1 <span>instanceof</span> TakeResult<span>.</span><span>NoValue</span><span>&lt;</span><span>Integer</span><span>&gt;)</span> <span>{</span></span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>                    <span>break</span><span>;</span></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>                <span>}</span></span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>            <span>}</span></span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>            <span>return</span> <span>true</span><span>;</span></span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>        <span>}</span> <span>finally</span> <span>{</span></span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>shutdownNow</span><span>();</span></span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>close</span><span>();</span></span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>String</span><span>[]</span> args<span>)</span> </span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>            <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>        <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span></span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>            <span>&#34;1 and 1 same: &#34;</span> <span>+</span> </span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>            <span>same</span><span>(</span>Tree<span>.</span><span>random</span><span>(</span><span>1</span><span>),</span> Tree<span>.</span><span>random</span><span>(</span><span>1</span><span>))</span></span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a>        <span>);</span></span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a>        <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span></span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>            <span>&#34;1 and 2 same: &#34;</span> <span>+</span> </span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a>            <span>same</span><span>(</span>Tree<span>.</span><span>random</span><span>(</span><span>1</span><span>),</span> Tree<span>.</span><span>random</span><span>(</span><span>2</span><span>))</span></span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a>        <span>);</span></span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<div id="cb31"><pre><code><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>TreeWalker<span>.</span><span>main</span><span>(</span><span>new</span> <span>String</span><span>[]{});</span></span></code></pre></div>
<p>We use the same tricks as before to emulate a closable queue with <code>TakeResult</code>. Then we translate the <code>select</code> statement to a loop calling <code>offer</code> and <code>poll</code>.</p>
<p>The example Go solution had a recursive local closure for walk. While technically possible via some wizardry, its more straight forward in Java to make a helper method.</p>
<p>There is also a reliance on the walk tasks responding correctly to <code>shutdownNow</code>. If they did not, <code>executor.close()</code> would hang and the scope wouldn&#39;t exit.</p>
<h2 id="example-8-syncmutex">Example 8: sync.Mutex</h2>
<p><a href="https://go.dev/tour/concurrency/9">https://go.dev/tour/concurrency/9</a></p>
<div id="cb32"><pre><code><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span>package</span> main</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>(</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span>&#34;fmt&#34;</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span>&#34;sync&#34;</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span>&#34;time&#34;</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span>)</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span>// SafeCounter is safe to use concurrently.</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span>type</span> SafeCounter <span>struct</span> <span>{</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    mu sync<span>.</span>Mutex</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    v  <span>map</span><span>[</span><span>string</span><span>]</span><span>int</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span>// Inc increments the counter for the given key.</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span>func</span> <span>(</span>c <span>*</span>SafeCounter<span>)</span> Inc<span>(</span>key <span>string</span><span>)</span> <span>{</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    c<span>.</span>mu<span>.</span>Lock<span>()</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    <span>// Lock so only one goroutine at a time can access the map c.v.</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    c<span>.</span>v<span>[</span>key<span>]++</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    c<span>.</span>mu<span>.</span>Unlock<span>()</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span>// Value returns the current value of the counter for the given key.</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span>func</span> <span>(</span>c <span>*</span>SafeCounter<span>)</span> Value<span>(</span>key <span>string</span><span>)</span> <span>int</span> <span>{</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    c<span>.</span>mu<span>.</span>Lock<span>()</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    <span>// Lock so only one goroutine at a time can access the map c.v.</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    <span>defer</span> c<span>.</span>mu<span>.</span>Unlock<span>()</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>    <span>return</span> c<span>.</span>v<span>[</span>key<span>]</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a><span>func</span> main<span>()</span> <span>{</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>    c <span>:=</span> SafeCounter<span>{</span>v<span>:</span> <span>make</span><span>(</span><span>map</span><span>[</span><span>string</span><span>]</span><span>int</span><span>)}</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>    <span>for</span> i <span>:=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>1000</span><span>;</span> i<span>++</span> <span>{</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>        <span>go</span> c<span>.</span>Inc<span>(</span><span>&#34;somekey&#34;</span><span>)</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>    time<span>.</span>Sleep<span>(</span>time<span>.</span>Second<span>)</span></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>    fmt<span>.</span>Println<span>(</span>c<span>.</span>Value<span>(</span><span>&#34;somekey&#34;</span><span>))</span></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>Java has a direct analogue to <a href="https://pkg.go.dev/sync#Mutex"><code>sync.Mutex</code></a> in <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/locks/ReentrantLock.html"><code>ReentrantLock</code></a>. We can make this same program without much issue.</p>
<div id="cb33"><pre><code><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>time</span><span>.</span><span>Duration</span><span>;</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>HashMap</span><span>;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>Map</span><span>;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>concurrent</span><span>.</span><span>locks</span><span>.</span><span>ReentrantLock</span><span>;</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span>final</span> <span>class</span> SafeCounter <span>{</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>final</span> <span>Map</span><span>&lt;</span><span>String</span><span>,</span> <span>Integer</span><span>&gt;</span> v<span>;</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>final</span> <span>ReentrantLock</span> lock<span>;</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>SafeCounter</span><span>()</span> <span>{</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>        <span>this</span><span>.</span><span>v</span> <span>=</span> <span>new</span> <span>HashMap</span><span>&lt;&gt;();</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>        <span>this</span><span>.</span><span>lock</span> <span>=</span> <span>new</span> <span>ReentrantLock</span><span>();</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span>void</span> <span>inc</span><span>(</span><span>String</span> key<span>)</span> <span>{</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>        lock<span>.</span><span>lock</span><span>();</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>{</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>            v<span>.</span><span>put</span><span>(</span>key<span>,</span> v<span>.</span><span>getOrDefault</span><span>(</span>key<span>,</span> <span>0</span><span>)</span> <span>+</span> <span>1</span><span>);</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>        <span>}</span> <span>finally</span> <span>{</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>            lock<span>.</span><span>unlock</span><span>();</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span>int</span> <span>value</span><span>(</span><span>String</span> key<span>)</span> <span>{</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>        lock<span>.</span><span>lock</span><span>();</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>{</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>            <span>return</span> v<span>.</span><span>getOrDefault</span><span>(</span>key<span>,</span> <span>0</span><span>);</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>        <span>}</span> <span>finally</span> <span>{</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>            lock<span>.</span><span>unlock</span><span>();</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a><span>public</span> <span>final</span> <span>class</span> Mutex <span>{</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>Mutex</span><span>()</span> <span>{}</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>String</span><span>[]</span> args<span>)</span> </span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>            <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>        var c <span>=</span> <span>new</span> <span>SafeCounter</span><span>();</span></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>        <span>for</span> <span>(</span><span>int</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>1000</span><span>;</span> i<span>++)</span> <span>{</span></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>            <span>Thread</span><span>.</span><span>startVirtualThread</span><span>(</span></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>                    <span>()</span> <span>-&gt;</span> c<span>.</span><span>inc</span><span>(</span><span>&#34;somekey&#34;</span><span>)</span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>            <span>);</span></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>        <span>Thread</span><span>.</span><span>sleep</span><span>(</span><span>Duration</span><span>.</span><span>ofSeconds</span><span>(</span><span>1</span><span>));</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>        <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span>c<span>.</span><span>value</span><span>(</span><span>&#34;somekey&#34;</span><span>));</span></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<div id="cb34"><pre><code><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>Mutex<span>.</span><span>main</span><span>(</span><span>new</span> <span>String</span><span>[]{});</span></span></code></pre></div>
<p>The only thing of note is that unlike Go where you can <code>defer</code> some arbitrary action like releasing your hold on a lock, in Java the general mechanism for &#34;cleanup that must happen&#34; is using the <code>finally</code> clause of a <code>try</code> block.</p>
<p>For Java <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/locks/ReentrantLock.html"><code>ReentrantLock</code></a> is special in that its locks can &#34;escape&#34; a lexical scope. You can lock before entering a method and unlock in a totally unrelated one.</p>
<p>If you don&#39;t need this ability then you can use the fact that every &#34;identity&#34; having object in Java can be used as a lock with <code>synchronized</code>.</p>
<div id="cb35"><pre><code><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span>final</span> <span>class</span> SafeCounter <span>{</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>final</span> <span>Map</span><span>&lt;</span><span>String</span><span>,</span> <span>Integer</span><span>&gt;</span> v<span>;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>SafeCounter</span><span>()</span> <span>{</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>        <span>this</span><span>.</span><span>v</span> <span>=</span> <span>new</span> <span>HashMap</span><span>&lt;&gt;();</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span>void</span> <span>inc</span><span>(</span><span>String</span> key<span>)</span> <span>{</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        <span>synchronized</span> <span>(</span><span>this</span><span>)</span> <span>{</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>            v<span>.</span><span>put</span><span>(</span>key<span>,</span> v<span>.</span><span>getOrDefault</span><span>(</span>key<span>,</span> <span>0</span><span>)</span> <span>+</span> <span>1</span><span>);</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span>int</span> <span>value</span><span>(</span><span>String</span> key<span>)</span> <span>{</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>        <span>synchronized</span> <span>(</span><span>this</span><span>)</span> <span>{</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>            <span>return</span> v<span>.</span><span>getOrDefault</span><span>(</span>key<span>,</span> <span>0</span><span>);</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>If the thing being synchronized on is just <code>this</code> and that synchronization lasts the entire scope of the method, we can just mark the method as <code>synchronized</code> for the same effect.</p>
<div id="cb36"><pre><code><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span>final</span> <span>class</span> SafeCounter <span>{</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>final</span> <span>Map</span><span>&lt;</span><span>String</span><span>,</span> <span>Integer</span><span>&gt;</span> v<span>;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>SafeCounter</span><span>()</span> <span>{</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>        <span>this</span><span>.</span><span>v</span> <span>=</span> <span>new</span> <span>HashMap</span><span>&lt;&gt;();</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span>synchronized</span> <span>void</span> <span>inc</span><span>(</span><span>String</span> key<span>)</span> <span>{</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>        v<span>.</span><span>put</span><span>(</span>key<span>,</span> v<span>.</span><span>getOrDefault</span><span>(</span>key<span>,</span> <span>0</span><span>)</span> <span>+</span> <span>1</span><span>);</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    <span>synchronized</span> <span>int</span> <span>value</span><span>(</span><span>String</span> key<span>)</span> <span>{</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>        <span>return</span> v<span>.</span><span>getOrDefault</span><span>(</span>key<span>,</span> <span>0</span><span>);</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<h2 id="example-9-web-crawler">Example 9: Web Crawler</h2>
<p><a href="https://go.dev/tour/concurrency/10">https://go.dev/tour/concurrency/10</a></p>
<div id="cb37"><pre><code><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span>package</span> main</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>(</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span>&#34;fmt&#34;</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span>)</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span>type</span> Fetcher <span>interface</span> <span>{</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span>// Fetch returns the body of URL and</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span>// a slice of URLs found on that page.</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    Fetch<span>(</span>url <span>string</span><span>)</span> <span>(</span>body <span>string</span><span>,</span> urls <span>[]</span><span>string</span><span>,</span> err <span>error</span><span>)</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span>// Crawl uses fetcher to recursively crawl</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span>// pages starting with url, to a maximum of depth.</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span>func</span> Crawl<span>(</span>url <span>string</span><span>,</span> depth <span>int</span><span>,</span> fetcher Fetcher<span>)</span> <span>{</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span>// </span><span>TODO</span><span>: Fetch URLs in parallel.</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    <span>// </span><span>TODO</span><span>: Don&#39;t fetch the same URL twice.</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    <span>// This implementation doesn&#39;t do either:</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    <span>if</span> depth <span>&lt;=</span> <span>0</span> <span>{</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>        <span>return</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    body<span>,</span> urls<span>,</span> err <span>:=</span> fetcher<span>.</span>Fetch<span>(</span>url<span>)</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span>if</span> err <span>!=</span> <span>nil</span> <span>{</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>        fmt<span>.</span>Println<span>(</span>err<span>)</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>        <span>return</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    fmt<span>.</span>Printf<span>(</span><span>&#34;found: %s %q</span><span>\n</span><span>&#34;</span><span>,</span> url<span>,</span> body<span>)</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    <span>for</span> _<span>,</span> u <span>:=</span> <span>range</span> urls <span>{</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>        Crawl<span>(</span>u<span>,</span> depth<span>-1</span><span>,</span> fetcher<span>)</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>    <span>return</span></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a><span>func</span> main<span>()</span> <span>{</span></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>    Crawl<span>(</span><span>&#34;https://golang.org/&#34;</span><span>,</span> <span>4</span><span>,</span> fetcher<span>)</span></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a><span>// fakeFetcher is Fetcher that returns canned results.</span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a><span>type</span> fakeFetcher <span>map</span><span>[</span><span>string</span><span>]*</span>fakeResult</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a><span>type</span> fakeResult <span>struct</span> <span>{</span></span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>    body <span>string</span></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>    urls <span>[]</span><span>string</span></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a><span>func</span> <span>(</span>f fakeFetcher<span>)</span> Fetch<span>(</span>url <span>string</span><span>)</span> <span>(</span><span>string</span><span>,</span> <span>[]</span><span>string</span><span>,</span> <span>error</span><span>)</span> <span>{</span></span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>    <span>if</span> res<span>,</span> ok <span>:=</span> f<span>[</span>url<span>];</span> ok <span>{</span></span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>        <span>return</span> res<span>.</span>body<span>,</span> res<span>.</span>urls<span>,</span> <span>nil</span></span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>    <span>return</span> <span>&#34;&#34;</span><span>,</span> <span>nil</span><span>,</span> fmt<span>.</span>Errorf<span>(</span><span>&#34;not found: %s&#34;</span><span>,</span> url<span>)</span></span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a><span>// fetcher is a populated fakeFetcher.</span></span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a><span>var</span> fetcher <span>=</span> fakeFetcher<span>{</span></span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a>    <span>&#34;https://golang.org/&#34;</span><span>:</span> <span>&amp;</span>fakeResult<span>{</span></span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>        <span>&#34;The Go Programming Language&#34;</span><span>,</span></span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>        <span>[]</span><span>string</span><span>{</span></span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>            <span>&#34;https://golang.org/pkg/&#34;</span><span>,</span></span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>            <span>&#34;https://golang.org/cmd/&#34;</span><span>,</span></span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>        <span>},</span></span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>    <span>},</span></span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a>        <span>&#34;https://golang.org/pkg/&#34;</span><span>:</span> <span>&amp;</span>fakeResult<span>{</span></span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a>            <span>&#34;Packages&#34;</span><span>,</span></span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a>            <span>[]</span><span>string</span><span>{</span></span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a>                <span>&#34;https://golang.org/&#34;</span><span>,</span></span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a>                <span>&#34;https://golang.org/cmd/&#34;</span><span>,</span></span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a>                <span>&#34;https://golang.org/pkg/fmt/&#34;</span><span>,</span></span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a>                <span>&#34;https://golang.org/pkg/os/&#34;</span><span>,</span></span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a>            <span>},</span></span>
<span id="cb37-70"><a href="#cb37-70" aria-hidden="true" tabindex="-1"></a>        <span>},</span></span>
<span id="cb37-71"><a href="#cb37-71" aria-hidden="true" tabindex="-1"></a>        <span>&#34;https://golang.org/pkg/fmt/&#34;</span><span>:</span> <span>&amp;</span>fakeResult<span>{</span></span>
<span id="cb37-72"><a href="#cb37-72" aria-hidden="true" tabindex="-1"></a>            <span>&#34;Package fmt&#34;</span><span>,</span></span>
<span id="cb37-73"><a href="#cb37-73" aria-hidden="true" tabindex="-1"></a>            <span>[]</span><span>string</span><span>{</span></span>
<span id="cb37-74"><a href="#cb37-74" aria-hidden="true" tabindex="-1"></a>                <span>&#34;https://golang.org/&#34;</span><span>,</span></span>
<span id="cb37-75"><a href="#cb37-75" aria-hidden="true" tabindex="-1"></a>                <span>&#34;https://golang.org/pkg/&#34;</span><span>,</span></span>
<span id="cb37-76"><a href="#cb37-76" aria-hidden="true" tabindex="-1"></a>            <span>},</span></span>
<span id="cb37-77"><a href="#cb37-77" aria-hidden="true" tabindex="-1"></a>        <span>},</span></span>
<span id="cb37-78"><a href="#cb37-78" aria-hidden="true" tabindex="-1"></a>        <span>&#34;https://golang.org/pkg/os/&#34;</span><span>:</span> <span>&amp;</span>fakeResult<span>{</span></span>
<span id="cb37-79"><a href="#cb37-79" aria-hidden="true" tabindex="-1"></a>            <span>&#34;Package os&#34;</span><span>,</span></span>
<span id="cb37-80"><a href="#cb37-80" aria-hidden="true" tabindex="-1"></a>            <span>[]</span><span>string</span><span>{</span></span>
<span id="cb37-81"><a href="#cb37-81" aria-hidden="true" tabindex="-1"></a>                <span>&#34;https://golang.org/&#34;</span><span>,</span></span>
<span id="cb37-82"><a href="#cb37-82" aria-hidden="true" tabindex="-1"></a>                <span>&#34;https://golang.org/pkg/&#34;</span><span>,</span></span>
<span id="cb37-83"><a href="#cb37-83" aria-hidden="true" tabindex="-1"></a>            <span>},</span></span>
<span id="cb37-84"><a href="#cb37-84" aria-hidden="true" tabindex="-1"></a>        <span>},</span></span>
<span id="cb37-85"><a href="#cb37-85" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>Another challenge problem. Before going to a reference solution, I am going to translate the synchronous example.</p>
<p>Go has a pattern of returning an error as a conditionally filled in extra return value. This isn&#39;t super idiomatic in Java, so instead I am going to model the error case as an <code>Exception</code>.</p>
<p>The Go version also returns both a body and an array of urls from a single call. For Java we can accomplish this by making an aggregate containing both values.</p>
<div id="cb38"><pre><code><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span>final</span> <span>class</span> FetcherException <span>extends</span> <span>Exception</span> <span>{</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span>FetcherException</span><span>(</span><span>String</span> message<span>)</span> <span>{</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>        <span>super</span><span>(</span>message<span>);</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span>interface</span> Fetcher <span>{</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    record <span>Result</span><span>(</span><span>String</span> body<span>,</span> <span>String</span><span>[]</span> urls<span>)</span> <span>{</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span>Result</span> <span>fetch</span><span>(</span><span>String</span> url<span>)</span> <span>throws</span> FetcherException<span>;</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>We can make a &#34;fake&#34; implementation of fetcher using the same technique as Go by backing it with an in-memory map.</p>
<div id="cb39"><pre><code><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>Map</span><span>;</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span>final</span> <span>class</span> FakeFetcher <span>implements</span> Fetcher <span>{</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>final</span> <span>Map</span><span>&lt;</span><span>String</span><span>,</span> <span>Result</span><span>&gt;</span> results<span>;</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>FakeFetcher</span><span>(</span><span>Map</span><span>&lt;</span><span>String</span><span>,</span> <span>Result</span><span>&gt;</span> results<span>)</span> <span>{</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>        <span>this</span><span>.</span><span>results</span> <span>=</span> results<span>;</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span>@Override</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>Result</span> <span>fetch</span><span>(</span><span>String</span> url<span>)</span> <span>throws</span> FetcherException <span>{</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>        var result <span>=</span> <span>this</span><span>.</span><span>results</span><span>.</span><span>get</span><span>(</span>url<span>);</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>        <span>if</span> <span>(</span>result <span>==</span> <span>null</span><span>)</span> <span>{</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>            <span>throw</span> <span>new</span> <span>FetcherException</span><span>(</span><span>&#34;Not Found: &#34;</span> <span>+</span> url<span>);</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>        <span>}</span> <span>else</span> <span>{</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>            <span>return</span> result<span>;</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> Fetcher <span>example</span><span>()</span> <span>{</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>        <span>return</span> <span>new</span> <span>FakeFetcher</span><span>(</span><span>Map</span><span>.</span><span>of</span><span>(</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>                <span>&#34;https://golang.org/&#34;</span><span>,</span> <span>new</span> Fetcher<span>.</span><span>Result</span><span>(</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>                        <span>&#34;The Go Programming Language&#34;</span><span>,</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>                        <span>new</span> <span>String</span><span>[]{</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>                                <span>&#34;https://golang.org/pkg/&#34;</span><span>,</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>                                <span>&#34;https://golang.org/cmd/&#34;</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>                        <span>}</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>                <span>),</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>                <span>&#34;https://golang.org/pkg/&#34;</span><span>,</span> <span>new</span> Fetcher<span>.</span><span>Result</span><span>(</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>                        <span>&#34;Packages&#34;</span><span>,</span></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>                        <span>new</span> <span>String</span><span>[]{</span></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>                                <span>&#34;https://golang.org/&#34;</span><span>,</span></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>                                <span>&#34;https://golang.org/cmd/&#34;</span><span>,</span></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>                                <span>&#34;https://golang.org/pkg/fmt/&#34;</span><span>,</span></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>                                <span>&#34;https://golang.org/pkg/os/&#34;</span><span>,</span></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>                        <span>}</span></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>                <span>),</span></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>                <span>&#34;https://golang.org/pkg/fmt/&#34;</span><span>,</span> <span>new</span> Fetcher<span>.</span><span>Result</span><span>(</span></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>                        <span>&#34;Package fmt&#34;</span><span>,</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>                        <span>new</span> <span>String</span><span>[]{</span></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>                                <span>&#34;https://golang.org/&#34;</span><span>,</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>                                <span>&#34;https://golang.org/pkg/&#34;</span><span>,</span></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>                        <span>}</span></span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>                <span>),</span></span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>                <span>&#34;https://golang.org/pkg/os/&#34;</span><span>,</span> <span>new</span> Fetcher<span>.</span><span>Result</span><span>(</span></span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>                        <span>&#34;Package os&#34;</span><span>,</span></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>                        <span>new</span> <span>String</span><span>[]{</span></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>                                <span>&#34;https://golang.org/&#34;</span><span>,</span></span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>                                <span>&#34;https://golang.org/pkg/&#34;</span><span>,</span></span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>                        <span>}</span></span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a>                <span>)</span></span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a>        <span>));</span></span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>Then the synchronous fetcher is just a regular recursive function as it was in Go.</p>
<div id="cb40"><pre><code><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span>public</span> <span>final</span> <span>class</span> WebCrawler <span>{</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>WebCrawler</span><span>()</span> <span>{</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span>static</span> <span>void</span> <span>crawl</span><span>(</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>        <span>String</span> url<span>,</span> </span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>        <span>int</span> depth<span>,</span> </span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>        Fetcher fetcher</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span>)</span> <span>{</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>        <span>if</span> <span>(</span>depth <span>&lt;=</span> <span>0</span><span>)</span> <span>{</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>            <span>return</span><span>;</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>        Fetcher<span>.</span><span>Result</span> result<span>;</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>{</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>            result <span>=</span> fetcher<span>.</span><span>fetch</span><span>(</span>url<span>);</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>        <span>}</span> <span>catch</span> <span>(</span>FetcherException e<span>)</span> <span>{</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>            <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span>e<span>.</span><span>getMessage</span><span>());</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>            <span>return</span><span>;</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>        var body <span>=</span> result<span>.</span><span>body</span><span>();</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>        var urls <span>=</span> result<span>.</span><span>urls</span><span>();</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>        <span>System</span><span>.</span><span>out</span><span>.</span><span>printf</span><span>(</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>            <span>&#34;Found: </span><span>%s</span><span> </span><span>%s\n</span><span>&#34;</span><span>,</span> </span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>            body<span>,</span> </span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>            <span>Arrays</span><span>.</span><span>toString</span><span>(</span>urls<span>)</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>        <span>);</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>        <span>for</span> <span>(</span>var u <span>:</span> urls<span>)</span> <span>{</span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>            <span>crawl</span><span>(</span>u<span>,</span> depth <span>-</span> <span>1</span><span>,</span> fetcher<span>);</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>String</span><span>[]</span> args<span>)</span> <span>{</span></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>        var fetcher <span>=</span> FakeFetcher<span>.</span><span>example</span><span>();</span></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>        <span>crawl</span><span>(</span><span>&#34;https://golang.org/&#34;</span><span>,</span> <span>4</span><span>,</span> fetcher<span>);</span></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<div id="cb41"><pre><code><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>WebCrawler<span>.</span><span>main</span><span>(</span><span>new</span> <span>String</span><span>[]{});</span></span></code></pre></div>
<p>Now I am going to pull an answer to the exercise from <a href="https://stackoverflow.com/questions/13217547/tour-of-go-exercise-10-crawler">this StackOverflow post</a>.</p>
<div id="cb42"><pre><code><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span>// SafeUrlMap is safe to use concurrently.</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span>type</span> SafeUrlMap <span>struct</span> <span>{</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    v   <span>map</span><span>[</span><span>string</span><span>]</span><span>string</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    mux sync<span>.</span>Mutex</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span>func</span> <span>(</span>c <span>*</span>SafeUrlMap<span>)</span> Set<span>(</span>key <span>string</span><span>,</span> body <span>string</span><span>)</span> <span>{</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    c<span>.</span>mux<span>.</span>Lock<span>()</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span>// Lock so only one goroutine at a time can access the map c.v.</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    c<span>.</span>v<span>[</span>key<span>]</span> <span>=</span> body</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    c<span>.</span>mux<span>.</span>Unlock<span>()</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span>// Value returns mapped value for the given key.</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a><span>func</span> <span>(</span>c <span>*</span>SafeUrlMap<span>)</span> Value<span>(</span>key <span>string</span><span>)</span> <span>(</span><span>string</span><span>,</span> <span>bool</span><span>)</span> <span>{</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    c<span>.</span>mux<span>.</span>Lock<span>()</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>    <span>// Lock so only one goroutine at a time can access the map c.v.</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    <span>defer</span> c<span>.</span>mux<span>.</span>Unlock<span>()</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    val<span>,</span> ok <span>:=</span> c<span>.</span>v<span>[</span>key<span>]</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>    <span>return</span> val<span>,</span> ok</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a><span>// Crawl uses fetcher to recursively crawl</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a><span>// pages starting with url, to a maximum of depth.</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a><span>func</span> Crawl<span>(</span>url <span>string</span><span>,</span> depth <span>int</span><span>,</span> fetcher Fetcher<span>,</span> urlMap SafeUrlMap<span>)</span> <span>{</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>    <span>defer</span> wg<span>.</span>Done<span>()</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>    urlMap<span>.</span>Set<span>(</span>url<span>,</span> body<span>)</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>    <span>if</span> depth <span>&lt;=</span> <span>0</span> <span>{</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>        <span>return</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>    body<span>,</span> urls<span>,</span> err <span>:=</span> fetcher<span>.</span>Fetch<span>(</span>url<span>)</span></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>    <span>if</span> err <span>!=</span> <span>nil</span> <span>{</span></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>        fmt<span>.</span>Println<span>(</span>err<span>)</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>        <span>return</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>    <span>for</span> _<span>,</span> u <span>:=</span> <span>range</span> urls <span>{</span></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>        <span>if</span> _<span>,</span> ok <span>:=</span> urlMap<span>.</span>Value<span>(</span>u<span>);</span> <span>!</span>ok <span>{</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>            wg<span>.</span>Add<span>(</span><span>1</span><span>)</span></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>            <span>go</span> Crawl<span>(</span>u<span>,</span> depth<span>-1</span><span>,</span> fetcher<span>,</span> urlMap<span>)</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>    <span>return</span></span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a><span>var</span> wg sync<span>.</span>WaitGroup</span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a><span>func</span> main<span>()</span> <span>{</span></span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>    urlMap <span>:=</span> SafeUrlMap<span>{</span>v<span>:</span> <span>make</span><span>(</span><span>map</span><span>[</span><span>string</span><span>]</span><span>string</span><span>)}</span></span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>    wg<span>.</span>Add<span>(</span><span>1</span><span>)</span></span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>    <span>go</span> Crawl<span>(</span><span>&#34;http://golang.org/&#34;</span><span>,</span> <span>4</span><span>,</span> fetcher<span>,</span> urlMap<span>)</span></span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>    wg<span>.</span>Wait<span>()</span></span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>    <span>for</span> url <span>:=</span> <span>range</span> urlMap<span>.</span>v <span>{</span></span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>        body<span>,</span> _ <span>:=</span> urlMap<span>.</span>Value<span>(</span>url<span>)</span></span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>        fmt<span>.</span>Printf<span>(</span><span>&#34;found: %s %q</span><span>\n</span><span>&#34;</span><span>,</span> url<span>,</span> body<span>)</span></span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>This solution makes use of a <a href="https://pkg.go.dev/sync#WaitGroup"><code>sync.WaitGroup</code></a>. There is no direct analogue in Java, but we can pretty easily make something that has similar semantics.</p>
<p>I am taking the implementation <a href="https://stackoverflow.com/questions/29655531/what-is-the-java-equivalent-of-golangs-waitgroup">from this StackOverflow question</a>.</p>
<div id="cb43"><pre><code><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span>final</span> <span>class</span> WaitGroup <span>{</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>int</span> jobs <span>=</span> <span>0</span><span>;</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>synchronized</span> <span>void</span> <span>add</span><span>(</span><span>int</span> i<span>)</span> <span>{</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>        jobs <span>+=</span> i<span>;</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>synchronized</span> <span>void</span> <span>done</span><span>()</span> <span>{</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>        <span>if</span> <span>(--</span>jobs <span>==</span> <span>0</span><span>)</span> <span>{</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>            <span>notifyAll</span><span>();</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>synchronized</span> <span>void</span> <span>await</span><span>()</span> </span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>            <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>        <span>while</span> <span>(</span>jobs <span>&gt;</span> <span>0</span><span>)</span> <span>{</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>            <span>wait</span><span>();</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>The <code>SafeUrlMap</code> type is also fairly trivial to assemble, but instead of that I am going to pass around a normal <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/HashSet.html"><code>HashSet</code></a> and manually synchronize on it.</p>
<p>There are many other options, including using <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/Collections.html#synchronizedSet(java.util.Set)"><code>Collections#synchronizedSet</code></a> or wrapping a <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/ConcurrentHashMap.html"><code>ConcurrentHashMap</code></a>, but I think this will be the easiest to follow.</p>
<div id="cb44"><pre><code><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span>public</span> <span>final</span> <span>class</span> WebCrawler <span>{</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>WebCrawler</span><span>()</span> <span>{</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span>static</span> <span>void</span> <span>crawlTask</span><span>(</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>            <span>String</span> url<span>,</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>            <span>int</span> depth<span>,</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>            Fetcher fetcher<span>,</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>            <span>ExecutorService</span> executor<span>,</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>            <span>Set</span><span>&lt;</span><span>String</span><span>&gt;</span> seen<span>,</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>            WaitGroup waitGroup</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span>)</span> <span>{</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>{</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>            <span>if</span> <span>(</span>depth <span>&lt;=</span> <span>0</span><span>)</span> <span>{</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>                <span>return</span><span>;</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>            <span>}</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>            Fetcher<span>.</span><span>Result</span> result<span>;</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>            <span>try</span> <span>{</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>                result <span>=</span> fetcher<span>.</span><span>fetch</span><span>(</span>url<span>);</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>            <span>}</span> <span>catch</span> <span>(</span>FetcherException e<span>)</span> <span>{</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>                <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span>e<span>.</span><span>getMessage</span><span>());</span></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>                <span>return</span><span>;</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>            <span>}</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>            var body <span>=</span> result<span>.</span><span>body</span><span>();</span></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>            var urls <span>=</span> result<span>.</span><span>urls</span><span>();</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>            <span>System</span><span>.</span><span>out</span><span>.</span><span>printf</span><span>(</span></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>                <span>&#34;Found: </span><span>%s</span><span> </span><span>%s\n</span><span>&#34;</span><span>,</span> </span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>                body<span>,</span> </span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>                <span>Arrays</span><span>.</span><span>toString</span><span>(</span>urls<span>)</span></span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>            <span>);</span></span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>            <span>for</span> <span>(</span>var u <span>:</span> urls<span>)</span> <span>{</span></span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>                <span>synchronized</span> <span>(</span>seen<span>)</span> <span>{</span></span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>                    <span>if</span> <span>(!</span>seen<span>.</span><span>contains</span><span>(</span>u<span>))</span> <span>{</span></span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>                        seen<span>.</span><span>add</span><span>(</span>u<span>);</span></span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>                        waitGroup<span>.</span><span>add</span><span>(</span><span>1</span><span>);</span></span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>                        executor<span>.</span><span>submit</span><span>(()</span> <span>-&gt;</span> <span>crawlTask</span><span>(</span></span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>                                u<span>,</span></span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>                                depth <span>-</span> <span>1</span><span>,</span></span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>                                fetcher<span>,</span></span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>                                executor<span>,</span></span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>                                seen<span>,</span></span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>                                waitGroup</span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>                        <span>));</span></span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a>                    <span>}</span></span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a>                <span>}</span></span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a>            <span>}</span></span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a>        <span>}</span> <span>finally</span> <span>{</span></span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a>            waitGroup<span>.</span><span>done</span><span>();</span></span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-56"><a href="#cb44-56" aria-hidden="true" tabindex="-1"></a>    <span>static</span> <span>void</span> <span>crawl</span><span>(</span><span>String</span> url<span>,</span> <span>int</span> depth<span>,</span> Fetcher fetcher<span>)</span></span>
<span id="cb44-57"><a href="#cb44-57" aria-hidden="true" tabindex="-1"></a>            <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb44-58"><a href="#cb44-58" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>(</span>var executor <span>=</span></span>
<span id="cb44-59"><a href="#cb44-59" aria-hidden="true" tabindex="-1"></a>                     <span>Executors</span><span>.</span><span>newVirtualThreadPerTaskExecutor</span><span>())</span> <span>{</span></span>
<span id="cb44-60"><a href="#cb44-60" aria-hidden="true" tabindex="-1"></a>            var waitGroup <span>=</span> <span>new</span> <span>WaitGroup</span><span>();</span></span>
<span id="cb44-61"><a href="#cb44-61" aria-hidden="true" tabindex="-1"></a>            waitGroup<span>.</span><span>add</span><span>(</span><span>1</span><span>);</span></span>
<span id="cb44-62"><a href="#cb44-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-63"><a href="#cb44-63" aria-hidden="true" tabindex="-1"></a>            executor<span>.</span><span>submit</span><span>(()</span> <span>-&gt;</span> <span>crawlTask</span><span>(</span></span>
<span id="cb44-64"><a href="#cb44-64" aria-hidden="true" tabindex="-1"></a>                    url<span>,</span></span>
<span id="cb44-65"><a href="#cb44-65" aria-hidden="true" tabindex="-1"></a>                    depth<span>,</span></span>
<span id="cb44-66"><a href="#cb44-66" aria-hidden="true" tabindex="-1"></a>                    fetcher<span>,</span></span>
<span id="cb44-67"><a href="#cb44-67" aria-hidden="true" tabindex="-1"></a>                    executor<span>,</span></span>
<span id="cb44-68"><a href="#cb44-68" aria-hidden="true" tabindex="-1"></a>                    <span>new</span> <span>HashSet</span><span>&lt;&gt;(),</span></span>
<span id="cb44-69"><a href="#cb44-69" aria-hidden="true" tabindex="-1"></a>                    waitGroup</span>
<span id="cb44-70"><a href="#cb44-70" aria-hidden="true" tabindex="-1"></a>            <span>));</span></span>
<span id="cb44-71"><a href="#cb44-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-72"><a href="#cb44-72" aria-hidden="true" tabindex="-1"></a>            waitGroup<span>.</span><span>await</span><span>();</span></span>
<span id="cb44-73"><a href="#cb44-73" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb44-74"><a href="#cb44-74" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb44-75"><a href="#cb44-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-76"><a href="#cb44-76" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>String</span><span>[]</span> args<span>)</span> </span>
<span id="cb44-77"><a href="#cb44-77" aria-hidden="true" tabindex="-1"></a>            <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb44-78"><a href="#cb44-78" aria-hidden="true" tabindex="-1"></a>        var fetcher <span>=</span> FakeFetcher<span>.</span><span>example</span><span>();</span></span>
<span id="cb44-79"><a href="#cb44-79" aria-hidden="true" tabindex="-1"></a>        <span>crawl</span><span>(</span><span>&#34;https://golang.org/&#34;</span><span>,</span> <span>4</span><span>,</span> fetcher<span>);</span></span>
<span id="cb44-80"><a href="#cb44-80" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb44-81"><a href="#cb44-81" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<div id="cb45"><pre><code><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>WebCrawler<span>.</span><span>main</span><span>(</span><span>new</span> <span>String</span><span>[]{});</span></span></code></pre></div>
<p>We could stop there, but there is one api that is in an incubator module in the early access builds that can replace our home rolled <code>WaitGroup</code>.</p>
<p>This is why I had <code>--add-modules=jdk.incubator.concurrent</code> in the jshell command up top.</p>
<p>A <code>StructuredTaskScope.ShutdownOnFailure</code> lets us submit an arbitrary number of tasks to the scope recursively and will only close after either all those tasks are complete. There is another implementation <code>StructuredTaskScope.ShutdownOnSuccess</code> that will finish after a single task succeeds.</p>
<p>This obviates the need to manually count up and down with a <code>WaitGroup</code>.</p>
<div id="cb46"><pre><code><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>Arrays</span><span>;</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>HashSet</span><span>;</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>java</span><span>.</span><span>util</span><span>.</span><span>Set</span><span>;</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>jdk</span><span>.</span><span>incubator</span><span>.</span><span>concurrent</span><span>.</span><span>StructuredTaskScope</span><span>;</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span>public</span> <span>final</span> <span>class</span> WebCrawler <span>{</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    <span>private</span> <span>WebCrawler</span><span>()</span> <span>{</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    <span>static</span> <span>void</span> <span>crawlTask</span><span>(</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>            <span>String</span> url<span>,</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>            <span>int</span> depth<span>,</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>            Fetcher fetcher<span>,</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>            StructuredTaskScope<span>.</span><span>ShutdownOnFailure</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>                    structuredTaskScope<span>,</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>            <span>Set</span><span>&lt;</span><span>String</span><span>&gt;</span> seen</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    <span>)</span> <span>{</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>        <span>if</span> <span>(</span>depth <span>&lt;=</span> <span>0</span><span>)</span> <span>{</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>            <span>return</span><span>;</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>        Fetcher<span>.</span><span>Result</span> result<span>;</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>{</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>            result <span>=</span> fetcher<span>.</span><span>fetch</span><span>(</span>url<span>);</span></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>        <span>}</span> <span>catch</span> <span>(</span>FetcherException e<span>)</span> <span>{</span></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>            <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span>e<span>.</span><span>getMessage</span><span>());</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>            <span>return</span><span>;</span></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>        var body <span>=</span> result<span>.</span><span>body</span><span>();</span></span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>        var urls <span>=</span> result<span>.</span><span>urls</span><span>();</span></span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>        <span>System</span><span>.</span><span>out</span><span>.</span><span>printf</span><span>(</span></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>            <span>&#34;Found: </span><span>%s</span><span> </span><span>%s\n</span><span>&#34;</span><span>,</span> </span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>            body<span>,</span> </span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>            <span>Arrays</span><span>.</span><span>toString</span><span>(</span>urls<span>)</span></span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a>        <span>);</span></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>        <span>for</span> <span>(</span>var u <span>:</span> urls<span>)</span> <span>{</span></span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>            <span>synchronized</span> <span>(</span>seen<span>)</span> <span>{</span></span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>                <span>if</span> <span>(!</span>seen<span>.</span><span>contains</span><span>(</span>u<span>))</span> <span>{</span></span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>                    seen<span>.</span><span>add</span><span>(</span>u<span>);</span></span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>                    structuredTaskScope<span>.</span><span>fork</span><span>(()</span> <span>-&gt;</span> <span>{</span></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>                        <span>crawlTask</span><span>(</span></span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>                                u<span>,</span></span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>                                depth <span>-</span> <span>1</span><span>,</span></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>                                fetcher<span>,</span></span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>                                structuredTaskScope<span>,</span></span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>                                seen</span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>                        <span>);</span></span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>                        <span>return</span> <span>null</span><span>;</span></span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>                    <span>});</span></span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a>                <span>}</span></span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a>            <span>}</span></span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a>    <span>static</span> <span>void</span> <span>crawl</span><span>(</span><span>String</span> url<span>,</span> <span>int</span> depth<span>,</span> Fetcher fetcher<span>)</span></span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a>            <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a>        <span>try</span> <span>(</span>var structuredTaskScope <span>=</span></span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a>                     <span>new</span> StructuredTaskScope<span>.</span><span>ShutdownOnFailure</span><span>())</span> <span>{</span></span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a>            structuredTaskScope<span>.</span><span>fork</span><span>(()</span> <span>-&gt;</span> <span>{</span></span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a>                <span>crawlTask</span><span>(</span></span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a>                        url<span>,</span></span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a>                        depth<span>,</span></span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a>                        fetcher<span>,</span></span>
<span id="cb46-69"><a href="#cb46-69" aria-hidden="true" tabindex="-1"></a>                        structuredTaskScope<span>,</span></span>
<span id="cb46-70"><a href="#cb46-70" aria-hidden="true" tabindex="-1"></a>                        <span>new</span> <span>HashSet</span><span>&lt;&gt;()</span></span>
<span id="cb46-71"><a href="#cb46-71" aria-hidden="true" tabindex="-1"></a>                <span>);</span></span>
<span id="cb46-72"><a href="#cb46-72" aria-hidden="true" tabindex="-1"></a>                <span>return</span> <span>null</span><span>;</span></span>
<span id="cb46-73"><a href="#cb46-73" aria-hidden="true" tabindex="-1"></a>            <span>});</span></span>
<span id="cb46-74"><a href="#cb46-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-75"><a href="#cb46-75" aria-hidden="true" tabindex="-1"></a>            structuredTaskScope<span>.</span><span>join</span><span>();</span></span>
<span id="cb46-76"><a href="#cb46-76" aria-hidden="true" tabindex="-1"></a>        <span>}</span></span>
<span id="cb46-77"><a href="#cb46-77" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb46-78"><a href="#cb46-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-79"><a href="#cb46-79" aria-hidden="true" tabindex="-1"></a>    <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>String</span><span>[]</span> args<span>)</span> </span>
<span id="cb46-80"><a href="#cb46-80" aria-hidden="true" tabindex="-1"></a>            <span>throws</span> <span>InterruptedException</span> <span>{</span></span>
<span id="cb46-81"><a href="#cb46-81" aria-hidden="true" tabindex="-1"></a>        var fetcher <span>=</span> FakeFetcher<span>.</span><span>example</span><span>();</span></span>
<span id="cb46-82"><a href="#cb46-82" aria-hidden="true" tabindex="-1"></a>        <span>crawl</span><span>(</span><span>&#34;https://golang.org/&#34;</span><span>,</span> <span>4</span><span>,</span> fetcher<span>);</span></span>
<span id="cb46-83"><a href="#cb46-83" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb46-84"><a href="#cb46-84" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<div id="cb47"><pre><code><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>WebCrawler<span>.</span><span>main</span><span>(</span><span>new</span> <span>String</span><span>[]{});</span></span></code></pre></div>
<p>This combines the role of the <code>ExecutorService</code> and the <code>WorkGroup</code> into one object which at the least makes for one less point of coordination and slightly cleaner code.</p>
<p>The exact shape the <code>StructuredTaskScope</code> api will take is very much in flux so if you are reading this a year or so in the future this snippet might not work.</p>
<h2 id="wrapping-up">Wrapping up</h2>
<p>Hopefully this was informative. If not thats fine too.</p>
<p>Leave questions, comments, and suggestions in the comments.</p>
<hr/>
<h4 id="--index"><a href="https://mccue.dev/">&lt;- Index</a></h4>
</div>
  </body>
</html>
