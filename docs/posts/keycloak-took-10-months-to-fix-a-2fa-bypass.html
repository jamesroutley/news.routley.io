<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://security.humanativaspa.it/an-analysis-of-the-keycloak-authentication-system/">Original</a>
    <h1>Keycloak took 10 months to fix a 2FA bypass</h1>
    
    <div id="readability-page-1" class="page"><div>
	<div>

		<!-- Article -->
		<div>

		
		<article id="post-4341">
			<!-- .entry-header -->

			<!---->

					<div>
						<p>Earlier this year, I was working with my colleague Ema on a <strong>source-assisted application and architecture assessment</strong> for a client who was using <a href="https://www.keycloak.org/">Keycloak</a> to implement <strong>single sign-on</strong> on their applications. The purpose of the assessment was not to audit Keycloak itself. However, being it at the core of the authentication system, we took a look at it.</p>
<p>Keycloak is described as a solution for <em>“Open Source Identity and Access Management. Add authentication to applications and secure services with minimum effort. No need to deal with storing users or authenticating users. Keycloak provides user federation, strong authentication, user management, fine-grained authorization, and more.”</em></p>
<p>The relationship between Keycloak and Red Hat is not entirely clear to me, but the former is definitely supported by the latter:</p>
<ul>
<li><a href="https://www.redhat.com/en/blog/getting-started-keycloak-single-sign-operator">https://www.redhat.com/en/blog/getting-started-keycloak-single-sign-operator</a></li>
<li><a href="https://access.redhat.com/products/red-hat-build-of-keycloak">https://access.redhat.com/products/red-hat-build-of-keycloak</a></li>
</ul>
<p>During our analysis we identified some security issues and, therefore, we looked into how to report them to the developers:</p>
<p><img fetchpriority="high" decoding="async" src="https://security.humanativaspa.it/sec/wp-content/uploads/2024/10/Pasted-image-20240820165225.png" alt="Pasted image 20240820165225.png" width="1027" height="349"/></p>
<p>Let’s see what vulnerabilities we have discovered and reported.</p>
<h3>OTP bypass</h3>
<p>In the <a href="https://www.keycloak.org/docs/latest/server_admin/index.html#step-up-flow">step-up-flow guide</a>, a mechanism is described for defining different levels of security depending on the level of authentication (LOA), allowing for applications to use a first level (only username + password) or a second level (username + password + OTP). An administrator who follows this guide is led to make the “step-up flow” the default flow for the “browser flow” so that it is used for all applications.</p>
<p>The security issue is caused by the fact that <strong>the default “account” and “account-console” applications are considered as LOA1, therefore access is possible with only a username and a password</strong>, also if all other applications require an OTP (LOA2). <strong>This allows an attacker to completely bypass the OTP request</strong> with only a username and a password, as follows:</p>
<ol>
<li>The attacker tries to access one of the applications configured to login with Keycloak in LOA2.</li>
<li>The application redirects to Keycloak for authentication.</li>
<li>The attacker provides the correct username and password. At this point, Keycloak requests the OTP.</li>
<li>The attacker does not provide the OTP and instead goes to <a href="https://keycloak_url/realms/myrealm/account">https://keycloak_url/realms/myrealm/account</a> (the URL of the “account” default application, which requires username and password). Here the attacker can add a new OTP method without even being asked for a currently configured OTP, even if it’s present.</li>
<li>At this point, the attacker can return to the application and will know both the credentials and the OTP, thus being able to access it.</li>
</ol>
<p>Essentially, <strong>it is possible to completely bypass the second factor of authentication with only a username and a password</strong>.</p>
<p>The communication timeline follows:</p>
<p>28/03/2024 – First communication sent with all details and a proposed fix.</p>
<p>Further details are available at:</p>
<ul>
<li><a href="https://github.com/keycloak/keycloak/security/advisories/GHSA-4f53-xh3v-g8x4">https://github.com/keycloak/keycloak/security/advisories/GHSA-4f53-xh3v-g8x4</a></li>
<li><a href="https://github.com/advisories/GHSA-4f53-xh3v-g8x4">https://github.com/advisories/GHSA-4f53-xh3v-g8x4</a></li>
</ul>
<p>In hindsight, by analyzing the details available at <a href="https://bugzilla.redhat.com/show_bug.cgi?id=2221760">https://bugzilla.redhat.com/show_bug.cgi?id=2221760</a>, it is possible to see how <strong>the vulnerability was known to the developers since July 2023 and the fix therefore took 10 months</strong>.</p>
<p><img decoding="async" src="https://security.humanativaspa.it/sec/wp-content/uploads/2024/10/Pasted-image-20240820170144.png" alt="Pasted image 20240820170144.png"/></p>
<h3>Multiple security issues in authentication and authorization</h3>
<p>Multiple issues have been identified regarding the authentication and authorization of certain endpoints in the Keycloak software.</p>
<p>It has been observed that <strong>certain functionalities within Keycloak, specifically the <em>/metrics</em> and <em>/health</em> endpoints, are accessible without proper authentication</strong>. Even though those endpoints do not provide sensitive information, it is preferable that they are accessible only to authenticated individuals with the correct privileges.</p>
<p>Additionally, <strong>users with low privileges could access administrative functionalities in the Keycloak admin interface</strong>. This issue presents a significant security risk as it allows unauthorized users to perform actions reserved for administrators, potentially leading to data breaches or system compromise. The affected endpoints are:</p>
<ul>
<li>/admin/realms/myrealm/client-registration-policy/providers</li>
<li>/admin/myrealm/console/whoami</li>
<li>/admin/realms/myrealm/testLDAPConnection</li>
</ul>
<p>In particular, the last functionality (<em>testLDAPConnection</em>), in the event that an AD authentication system has been configured, allows to modify application data, <strong>enabling the submission of an LDAP request (and consequently LDAP access credentials) to a malicious endpoint that can steal the credentials</strong>.</p>
<p>An attacker with access to a non-administrative user account can invoke the “<em>testLDAPConnection</em> functionality by modifying the <em>connectionUrl</em> parameter with an arbitrary value, and the LDAP credentials will be sent to the attacker-controller server. To successfully execute this attack, it’s also necessary to know the <em>componentId</em> related to the domain authentication, which is retrievable in the cookies <em>KEYCLOAK_SESSION</em>, <em>KEYCLOAK_SESSION_LEGACY</em>, and in the responses returned by the <em>/admin/myrealm/console/whoami</em> endpoint.</p>
<p>The communication timeline follows:</p>
<p>04/04/2024 – First communication sent with all details.</p>
<p>Further details are available at:</p>
<ul>
<li><a href="https://github.com/keycloak/keycloak/security/advisories/GHSA-2cww-fgmg-4jqc">https://github.com/keycloak/keycloak/security/advisories/GHSA-2cww-fgmg-4jqc</a></li>
<li><a href="https://github.com/advisories/GHSA-2cww-fgmg-4jqc">https://github.com/advisories/GHSA-2cww-fgmg-4jqc</a></li>
</ul>
<h3>Multiple race conditions in anti-brute force mechanism</h3>
<p>Keycloak implements an <a href="https://www.keycloak.org/docs/latest/server_admin/#password-guess-brute-force-attacks">anti-brute force mechanism</a> (which is not enabled by default) which should limit the attack attempts by locking out user accounts after a configured number of incorrect login attempts.</p>
<p>Based on our analysis, the software <strong>didn’t implement mechanisms to prevent concurrent access</strong> to security-critical resources, such as the number of failed authentication attempts. Therefore, it’s possible to <strong>send multiple requests that are processed simultaneously by different threads, allowing the attacker to perform many more login attempts than allowed, and consequently partially bypassing the anti-brute-force mechanism</strong>. Furthermore, when the account is locked out, active sessions are not invalidated.</p>
<p>The issue has been verified both on the username and password-based login and on the OTP request. No checks have been performed on the “Quick Login Check Milliseconds” functionality, but we expect it to be affected by the same issue. The configuration used for testing was set to lockout accounts after 3 incorrect login attempts.</p>
<p>The communication timeline follows:</p>
<p>18/04/2024 – First communication with details.</p>
<p>Further details on the technique used are available at:</p>
<ul>
<li><a href="https://portswigger.net/research/smashing-the-state-machine">https://portswigger.net/research/smashing-the-state-machine</a></li>
<li><a href="https://portswigger.net/research/the-single-packet-attack-making-remote-race-conditions-local">https://portswigger.net/research/the-single-packet-attack-making-remote-race-conditions-local</a></li>
<li><a href="https://portswigger.net/research/turbo-intruder-embracing-the-billion-request-attack">https://portswigger.net/research/turbo-intruder-embracing-the-billion-request-attack</a></li>
</ul>
<h3>Some final considerations</h3>
<p><strong>Authentication is one of the fundamental mechanisms to ensure the security of applications</strong> and Keycloak is considered to be one of the standard open source software on which many organizations rely for their authentication needs.</p>
<p>I am a strong proponent of open source. However, I believe that <strong>those who develop important projects should carefully consider the impact that their work can have</strong>. I think that for a centralized authentication system, a bypass of the two-factor authentication should be solved or at least mitigated in a timely manner: 10 months is a lot of time to fix a core feature of a security product.</p>
<p>Furthermore, communication with security researchers and, crucially, product users should be as clear and explicit as possible. Keycloak’s advisories are very generic and do not allow users to understand what the actual impacts of the vulnerabilities are. <strong>Attackers can easily look at the code, understand it, and exploit any vulnerability, but the poor system administrator who needs to figure out if it’s important to quickly update certainly will not do that…</strong></p>
<p>Advisories with full details are downloadable at:</p>
<ul>
<li><a href="https://github.com/hnsecurity/vulns/blob/main/HNS-2024-08-Keycloak.md">https://github.com/hnsecurity/vulns/blob/main/HNS-2024-08-Keycloak.md</a></li>
<li><a href="https://github.com/hnsecurity/vulns/blob/main/HNS-2024-09-Keycloak.md">https://github.com/hnsecurity/vulns/blob/main/HNS-2024-09-Keycloak.md</a></li>
</ul>
					</div><!-- .entry-content -->
			
					</article><!-- #post-4341 -->

					

		</div>


		<!-- Sidenav -->
		

	</div>
</div></div>
  </body>
</html>
