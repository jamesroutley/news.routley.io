<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://akselmo.dev/posts/plasma-desktop-icons-positioning-refactor/">Original</a>
    <h1>Desktop icons are surprisingly hard</h1>
    
    <div id="readability-page-1" class="page"><section>
            <p>I spent past three weeks working on refactoring and fixing legacy code (the oldest of which was from 2013)
that handled positioning Plasma desktop icons, and how this data was saved and loaded.</p>
<p>Here&#39;s the merge request if you&#39;re curious: <a href="https://invent.kde.org/plasma/plasma-desktop/-/merge_requests/2607">plasma-desktop: Refactor icon positioner saving and loading</a></p>
<p>The existing code worked sometimes, but there were some oddities like race conditions (icon positioning happens in weird order)
and backend code mixed in with frontend code.</p>
<p>Now I am not blaming anyone for this. Code has tendency to get a bit weird, especially over long periods of time,
and <em>especially</em> in open source projects where anyone can tinker with it.</p>
<p>You know how wired earbuds always, <em>always</em> get tangled when you place them in a drawer or your pocket
or something for few seconds? Codebases do the exact same thing, when there are multiple
people writing on things, fixing each others&#39; bugs. Everyone has a different way of thinking,
so it&#39;s only natural that things over time get a bit tangled up.</p>
<p>So sometimes you need someone to look at the tangled codebase and try to clear it up a bit.</p>

<p>When going through old code, especially some that has barely any comments, it can take a
very long time to understand what is actually going on. I honestly spent most of my time
trying to understand how the thing even works, what is called when, where the icons positions are updated,
and so on.</p>
<p>When I finally had some understanding of what was happening, I could start cleaning things up.
I renamed a lot of the old methods to be hopefully more descriptive, and moved backend code — like saving
icon positions — from the frontend back to backend.</p>

<p>Every screen (PC monitor, TV…) tends to have it&#39;s own quirks. 
Some, when connected with display-port adapter, tell your PC it&#39;s disconnected if your PC goes to
screen saving mode. Some stay connected, but show a blank screen. </p>
<p>One big issue with the icon positions was that when screen got turned off,
it thought there was no screen anymore and started removing items from the desktop.</p>
<p>That&#39;s fair. Why show desktop icons on a screen that is non-existent? But 
when you have a monitor that tells your PC, &#34;Okay I&#39;m disconnecting now!&#34; when the PC
says it&#39;s time to sleep, wrong things would happen.</p>
<p>This condition is now handled by having a check that if the screen is in use or not.
Now when screen is not in use, we just do nothing with the icons. No need to touch them
at all.</p>

<p>Our icon positioning algorithm uses something called &#34;stripes.&#34; </p>
<p>Every resolution has it&#39;s amount of stripes. Stripes contain an array of icons,
or blank spots.</p>
<p>So if your screen resolution is, let&#39;s say, <code>1920x1080</code>, we calculate
how many stripes and how many items per stripe will fit on that screen.</p>
<pre><code><span>Stripe1: 1 2 3 4 5 6 7
</span><span>Stripe2: 1 2 3 4 5 6 7
</span><span>Stripe3: 1 2 3 4 5 6 7
</span><span>
</span><span>And so on..
</span></code></pre>
<p>But when you change your screen resolution or scale factor, how many icon stripes you have and how
many icons fit on each stripe will change.</p>
<p>So if you have one of those screens that looks to the system like it&#39;s been unplugged when it goes into
sleep mode, previously the stripe amount would change to 1 row, 1 column. And the icon positioner would
panics and shove all icons in that <code>1,1</code> slot.</p>
<p>Then when you&#39;d turn the screen back on, the icon positioner would wonder what just happened and restore
the proper stripe number and size. But by that point it would have lost all our positioning coordinate
data during the shoving of icons in that one miniscule place, so instead it would reset the icon positions…
and this leaves users wondering why their desktop icon arrangement is now gone.</p>
<p>Here we have to also check for the screen being in use or not. But there were other problems.</p>

<p>The prior code saved the icon positions every time the positions changed.
Makes sense. </p>
<p>But it didn&#39;t account for the screen being off… so the icon positions would
get saved while the desktop was in a faulty state. This also causes frustration because someone arranges the icons
how they wish, but then screen does something weird and they&#39;re now saved in wrong places again.</p>
<p>Our icon positions were updated after almost every draw call, if the positions changed. 
So this would mean the saving would happen rather often and no matter what moved them.</p>
<p>We had to separate the user action from computer action. If computer moves the icons,
we ideally do not save their positions, unless something drastic has happened like
resolution change. </p>
<p>The icon positions are saved per resolution, so if you move
icons around while they&#39;re displayed on a <code>3440x1440</code> screen and then change the resolution to <code>1920x1080</code>,
both will have their own arrangements.
This part of the codebase did not previously work, and it would always override the old configuration,
which caused headache.</p>
<p>So now we only save icon positions when:</p>
<ul>
<li>The user adds or removes a desktop icon</li>
<li>The user moves a desktop icon</li>
<li>The user changes the desktop resolution</li>
</ul>
<p>This makes the icon position saving much less random, since it&#39;s done only after explicit user actions.</p>

<p>The last thing that caused headaches with the icon positioning was that the area available on the desktop
for icons was determined before panels were loaded. When the panels loaded, they would reduce the amount of
space for desktop icons, and that area would constantly resize until everything is ready.</p>
<p>In previous code, this would cause icons to move, which updates positions, which then saves their positions.</p>
<p>So let&#39;s say you arrange your icons nicely, but the next time you boot into plasma, your panels start shoving
the poor icon area around and the icons have to move out of the way… and now they&#39;re all in the wrong places.</p>
<p>This was already partially fixed by not saving when the computer moves the icons around: we just load the icon
positions when the screen is in use and we are done with listing the icons on the desktop. Part of the margin changes
happen when screen is off.</p>
<p>We still need to fix the loading part; ideally we load the icon area last, so that it gets the margins 
it expects and doesn&#39;t shuffle around while panels are still appearing. But it was out of scope for this merge request.</p>

<p>It may not sound like much, but this was a lot of work. I spent days just thinking about this
problem, trying to understand what is happening now and how to improve it.</p>
<p>Luckily with a lot of help from reviewers and testers I got things to work 
much better than it used to. I am quite &#34;all-over-the-place&#34; when I solve problems
so I appreciate the patience they had with me and my questions. :D</p>
<p>What I mostly wished for when working on this were more inline code comments. You don&#39;t need to 
comment the obvious things, but everything else could use something. It&#39;s hard to gauge
what is obvious and what is not, but that kind of answers the question: If you don&#39;t know
if it&#39;s obvious or not, it&#39;s likely not, so add some comment about it.</p>
<p>I do hope that the desktop icons act more reliably after all these changes. If you spot bugs, do
report them at <a href="https://bugs.kde.org/enter_bug.cgi?product=plasmashell">https://bugs.kde.org</a>.</p>
<p>Thanks for reading! :)</p>
<p><em>PS. The funniest thing to me about all of this is that I do not like having any icons on my desktop. :&#39;D</em></p>

        </section></div>
  </body>
</html>
