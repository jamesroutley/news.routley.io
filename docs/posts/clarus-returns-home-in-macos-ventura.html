<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://shadowfacts.net/2022/clarus/">Original</a>
    <h1>Clarus returns home in macOS Ventura</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
<figure>
<p><img src="https://shadowfacts.net/2022/clarus//clarus-kare.png" alt="Susan Kare&#39;s pixel art dogcow icon"/>
<img src="https://shadowfacts.net/2022/clarus//clarus-smooth.png" alt="The high resolution dogcow icon that ships with macOS Ventura"/>
</p>
<figcaption>How it started / How it&#39;s going</figcaption>
</figure>
<p>Did you know that with macOS Ventura, Clarus the Dogcow has at long last returned home? Recently, while doing something else, I accidentally hit Cmd+Shift+P which opened the Page Setup dialog. I was greeted, surprisingly, with a new high-resolution version of the classic Clarus icon that I’d never seen before. I looked at it briefly, and then closed the dialog and went back to whatever I was doing before. I had assumed that becuase I’d been in a 3rd-party app at the time, that the Clarus icon was just some easter egg the developer had left. But a little while later, I got to thinking. What were the chances that someone went to the trouble of customizing the Page Setup dialog, of all things, just for an easter egg? Zero, it turns out. That dialog shows Clarus on the page preview in every app.</p>

<p><img src="https://shadowfacts.net/2022/clarus//page-setup.png" alt="The Page Setup dialog. The page preview on the left shows the high-resolution Clarus icon."/></p><p>I don’t have a Monterey machine to test it at the moment (I, er, <a href="https://social.shadowfacts.net/notice/AKGSrBOxnVDVO0ueem" data-link="social.shadowfacts.net/notice/AKGSrBOxnV...">accidentally</a> updated my laptop to the beta), but I <em>believe</em> this is a new change with Ventura.</p>
<p><strong>Updated:</strong> I installed Monterey in a virtual machine to check, and, indeed, the Page Setup dialog there bears no sign of Clarus.</p>
<p>The next step, then—having been thoroughly nerd-sniped by this—was to figure out where the icon was coming from and if I could pull it out of whatever nook it was hidden in.</p>
<p>The first stop was <a href="https://developer.apple.com/documentation/appkit/nspagelayout" data-link="developer.apple.com/documentation/appkit..."><code>NSPageLayout</code></a>, the panel object that is responsible for displaying the panel. It was unlikely that the class would actually contain the implementation of the panel, but it was at least a starting point.</p>
<p>In order to actually look at the disassembled implementation of this AppKit class, I needed the actual AppKit framework binary. Since macOS Big Sur, all system framework binaries are stored merged in the <code>dyld</code> shared cache, rather than in separate files. But, I need them as separate files in order to actually inspect them.</p>
<p>Since the <a href="https://shadowfacts.net/2021/scrollswitcher/" data-link="/2021/scrollswitcher/">last time</a> I wrote about this, a couple things have changed. Before, I built the Apple <code>dyld_shared_cache_util</code> from one of the periodic <code>dyld</code> source dumps. This is annoying because you have to make a bunch of changes to the source code to get it to compile outside of an Apple-internal environment. It also may break whenever there’s an OS update. So, I’ve switched to using <a href="https://github.com/keith/dyld-shared-cache-extractor" data-link="github.com/keith/dyld-shared-cache-extra...">this utility</a> which uses the <code>dyld_extractor.bundle</code> that ships with Xcode. The other difference since before is a minor one: the dyld shared cache has moved. Wheras before it was in <code>/System/Library/dyld/</code>, in the Ventura beta it’s moved to <code>/System/Cryptexes/OS/System/Library/dyld/</code> (the Cryptex seems to be part of the <a href="https://threedots.ovh/blog/2022/06/a-quick-look-at-macos-rapid-security-response/" data-link="threedots.ovh/blog/2022/06/a-quick-look-...">Rapid Security Response</a> feature Apple announced).</p>
<p>With the shared cache extracted, I could load the AppKit binary into Hopper (I had to disable the Objective-C analysis, otherwise the app crashed when trying to load the binary) and start poking around. I searched for the <code>NSPageLayout</code> class that I’m interested in, and looked at the <code>runModalWithPrintInfo:</code> method, since that sounded like a good candidate for something that would lead to the bulk of the implementation. And, indeed, it was. The method appears to be a fairly simple wrapper around the <code>PMPrepare...</code> function that sounds like it lives in a separate private framework.</p>
<p><img src="https://shadowfacts.net/2022/clarus//appkit.png" alt="Hopper window with AppKit showing the runModalWithPrintInfo: method"/>
</p>

<p>The next step was figuring out where that prepare function is actually implemented. Running <code>otool -L</code> on the AppKit binary doesn’t reveal anything obviously useful, but in the PrivateFrameworks directory extracted from the dyld shared cache, there’s something called <code>PrintingPrivate.framework</code>, which sounds promising. Opening it up in Hopper, I saw that this is indeed the framework I was looking for.</p>
<p><img src="https://shadowfacts.net/2022/clarus//printingprivate.png" alt="PrintingPrivate in Hopper showing the _PMPrepareAppKitPageSetupDialogWithPrintInfoPrivate function"/>
</p>
<p>Looking at the implementation of the prepare function, what immediately jumps out is the call to <code>_LoadAndGetPrintingUIBundle</code>. This seems to be yet another layer of indirection with the actual thing implemented in a different bundle. There’s also a call in the else branch to the similarly-named <code>_LoadAndGetPrintCocoaUIBundle</code>, but let’s start with the first one in hopes that it’s more common.</p>
<p>The implementation of that function goes through another helper function and it ends up loading a <code>PrintingUI.bundle</code> plugin from inside the PrintingPrivate framework bundle. This one isn’t part of the dyld shared cache, so I can just open it right up in Hopper without any fuss.</p>
<p>If you look for the function PrintingPrivate calls, it turns out it winds up in a method on <code>PMPageSetupController</code>. This sounds promising, let’s see what else that class can do.</p>
<p>What’s this? A method called <code>updateClarus</code>? Could it be? Have we finally reached it?</p>
<p><img src="https://shadowfacts.net/2022/clarus//printingui.png" alt="The PrintingUI binary in Hopper with the search panel showing a bunch of methods with &#39;clarus&#39; in the name"/>
</p>
<p>Yes! Clarus, I’m coming! One method that sounds particularly encouraging is <code>-[PMPageSetupController setClarusImageView:]</code>. If I can find out what’s setting the image view, maybe that’ll lead to where it’s being configured with the image.</p>
<p>Unfortunately, the setter for that property isn’t referenced anywhere in the PrintingUI binary. Nor is the getter. I was stuck here for a while, until I realized that the setter not being called anywhere was probably a sign that the UI was defined in a Nib and that an outlet was added from Interface Builder, even though it was never used.</p>
<p>Sure enough, in the plugin bundle’s resources, there is a <code>PMPageSetup.nib</code>. And if the page setup UI is defined in a Nib, and Clarus is being shown in a image view, the image itself is probably located in the asset catalog.</p>
<p>Using the system <code>assetutil</code> program, one can list all of the files in a compiled asset catalog. And sure enough, there she is:</p>
<pre><code><span>$</span><span> assetutil --info /System/Library/PrivateFrameworks/PrintingPrivate.framework/Versions/A/Plugins/PrintingUI.bundle/Contents/Resources/Assets.car | grep -i clarus</span>
    &#34;Name&#34; : &#34;Clarus&#34;,
    &#34;RenditionName&#34; : &#34;ClarusSmooth2.pdf&#34;,
    &#34;Name&#34; : &#34;Clarus&#34;,
    &#34;RenditionName&#34; : &#34;ClarusSmooth2.pdf&#34;,
    &#34;Name&#34; : &#34;Clarus&#34;,
    &#34;RenditionName&#34; : &#34;ClarusSmooth2.pdf&#34;,
</code></pre>
<p>To actually extract the image from the asset catalog, I needed to use a third-party tool. <a href="https://github.com/bartoszj/acextract" data-link="github.com/bartoszj/acextract">acextract</a> worked perfectly on the first try, though it did need couple of additional <code>@import</code>s to compile on Ventura since <a href="https://twitter.com/illian/status/1534014772848365568" data-link="twitter.com/illian/status/15340147728483...">Foundation no-longer re-exports CoreGraphics</a>.</p>

<p>And with that, I finally gazed upon the 512 × 512px beauty that is Smooth Clarus:</p>
<figure>
<img src="https://shadowfacts.net/2022/clarus//clarus-smooth.png" alt="Smooth Clarus"/>
</figure>
<p>The version shown here I’ve added a white background to, so it’s not invisible in dark mode. The <a href="https://shadowfacts.net/2022/clarus//Clarus256x256@2x.png" data-link="/2022/clarus/Clarus256x256@2x.png">original image</a> has a transparent background.</p>

<p>Lastly, if you’re writing a Mac app and would like to hide Clarus somewhere, you can load the bundle yourself and then pull the image out like so:</p>
<pre><code><span>let</span> bundle <span>=</span> <span>Bundle</span>(path: <span>&#34;/System/Library/PrivateFrameworks/PrintingPrivate.framework/Versions/A/Plugins/PrintingUI.bundle&#34;</span>)<span>!</span>
<span>try!</span> bundle.loadAndReturnError()
<span>let</span> image <span>=</span> bundle.image(forResource: <span>&#34;Clarus&#34;</span>)
</code></pre>
<p>I’m not sure if the Mac App Store would consider that using private SPI, so use it at your own risk.</p>
<p>It would be very cool to see Clarus return as an SF Symbol some day. If hundreds of icons for various Apple products can go in, so too can everyone’s favorite dogcow.</p>
</div></div>
  </body>
</html>
