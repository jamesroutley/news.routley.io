<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://nothings.org/gamedev/ssao/">Original</a>
    <h1>Corners Don&#39;t Look Like That: Regarding Screenspace Ambient Occlusion</h1>
    
    <div id="readability-page-1" class="page">

<h3>Sean Barrett</h3>
<h4>2012-12-13</h4>
<div>
<p><img src="http://nothings.org/gamedev/ssao/cornell.jpg"/></p></div>
<p>
<i>Please, feel free to gather better data yourself and prove me wrong.
If you do so I&#39;ll link to it!</i>
</p><p>
Game developers are in love with screenspace ambient occlusion (SSAO). They&#39;re so in love
with it that they do all sorts of crazy things. Amateur developers post screenshots
where convex corners get brighter near the corner. Professional developers release
games with <a href="http://backslashn.com/post/37712343299/this-is-not-how-ambient-occlusion-works">bizarre
halos</a> and <a href="http://nothings.org/gamedev/ssao/udk_ao_artifact.jpg">ugly artifacts</a> (look at the floor behind
the railing).
</p><p>
Even when they avoid those flaws, games with SSAO often still look wrong. And
an easy thing to pull out from it: corners of rooms look weirdly dark.
</p><p>
I believe this is because <a href="http://en.wikipedia.org/wiki/Radiosity_%28computer_graphics%29#Reducing_computation_time">people
think the corners of rooms actually <i>are</i> dark</a>,
and they&#39;ve allowed this belief to let them write code that produces unrealistic
results.
</p><p>
More specifically, I attribute the failure of SSAO in these cases to some combination of four factors:
</p><ul>
<li>Approximation errors due to using SSAO rather than AO
</li><li>Approximation errors due to using AO rather than radiosity
</li><li>Errors in applying the SSAO darkening to all lighting, not just ambient lighting
</li><li>Tuning errors, where the heuristic weighting of the AO effect is too strong
</li></ul>
<p>
I am not an active graphics researcher, so I&#39;m not going to set up a framework
and show where these things went wrong. That&#39;s the job of people publishing SSAO
papers and shipping SSAO in games.
</p><p>
For the same reason, the following discussion is not the most scientific nor
at all thorough. Perhaps collecting more data would suggest I am wrong. But
my personal visual experience doesn&#39;t match what people are rendering
with SSAO, so I wanted to share that experience; to which end I collected
some data.
</p><hr/>
<h2>Corners Don&#39;t Look Like That (most of the time)</h2>
<p>
In the following, everything is a photograph, not a rendering.
</p><p>
Photographs were taken using a Canon 5D Mk II, exported as JPEGs, using exposures
ranging from a 1/80 to 1/8 a second. The original large JPEGs were downsampled
by a factor of about four in each dimension using Adobe Photoshop. All images had their
chroma channels blurred with a 16-wide gaussian in Photoshop (before downsampling)
to reduce chroma noise artifacts in the long exposure images.
</p><p>
The ceiling of the apartment is a lighter, whiter color than the walls, so don&#39;t attribute
that incorrectly to lighting.
</p><p>
Let&#39;s start with a photograph that actually looks something like a common
AO/SSAO rendering.
</p><h3>A Dramatically Darkened Corner</h3>
<p><img src="http://nothings.org/gamedev/ssao/IMG_0050.JPG"/></p><p>
I had to search my apartment quite a while to find a corner which looked like
a typical SSAO rendered image. The thing is, that&#39;s not <i>really</i> what&#39;s
going on here. Wall (c) cannot see the light,
but wall (d) is quite exposed to it. The darkening on the left edge of
the wall (d) isn&#39;t primarily due to AO (i.e. due to interreflection/radiosity effects); it&#39;s
mostly due to a soft shadow from the light, which is just off the screen to
the top left. The corner on the left, between wall (b) and wall (c),
is casting a shadow, but it&#39;s very close to the light so
it spreads out into a big soft shadow.
</p><p>
There are other edges that are getting darker as well, though. What about them?
</p><p>
The top edge of wall (d) is another shadow -- look at the top edge of
the bright wall. The light source is recessed, so all of the light here is
actually reflected light from the recession, and the lip of that recession
causes the topmost parts of the wall to not receive that light. (All light
falling on the
ceiling is indirect, from the walls and floor and other objects in the room.)
</p><p>
What about the darkening-towards-the-edge effect on wall (c) as it reaches
the right edge, or ceiling (a) as it reaches the edge along wall (d)? That appears to
be an indirect lighting effect caused primarily by the Lambertian dot product;
as a point approaches the center edge on wall (c), the bright portions of wall (d)
wall become more and more edge-on, and the point darkens. I guess this is the primary
thing that AO is supposed to capture, but it&#39;s exaggerated here; if wall (d)
were lit more evenly (without the soft shadow), even as you approached the
edge from the left you would still have a large portion of your &#34;view&#34; filled
with <i>bright</i> surface. Only because the soft shadow darkens wall (d)
in the perfect way is the effect this significant.
</p><p>
There&#39;s still one edge left; the edge between wall (c) and ceiling (a). This
edge <i>also</i> shows darkening as you approach the edge from either side,
and shouldn&#39;t be affected by soft shadows from the light. The question is,
how much is it really darkening, and how much is just a psychological effect
from the contrast with all the other lighting effects? 
</p><h3>A Camera May Not Be Perceptual, But At Least We Can Graph It</h3>
<p>
Ideally, these photographs are in a known colorspace. The photographs claim
to be in sRGB, but given the results I don&#39;t think it&#39;s true that if we take
the numbers, run them through the sRGB curve we get back linear light values
(or clamped values); I think there&#39;s some more complex tone mapping going on.
So we can&#39;t really know to what degree these pictures reflect reality.
</p><p>
But we can at least understand how we&#39;re perceiving the pictures, since they&#39;re
being displayed as (hopefully) sRGB. They may not reflect reality that well,
but we can at least determine the degree to which the numbers in the pictures
actually are darkening, and the degree to which it&#39;s a perceptual effect we
get.
</p><p>
If we just look at the numbers from a point on one side of the edge to a point on the other side,
we can see in a single graph how the surfaces on either side of the edge darken
as they approach it.
</p><p>
For example, if we sample pixels on a line crossing the edge between (c) and (d)
and then graph them, we get:
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0050_1.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0050_1.png"/>
</p><p><small>The code used to generate the above graph appears in Appendix A.</small>
</p><p>
Note that this is a graph of pixel values (actually 5x5 box filter averaged over all three channels),
so this is a graph of sRGB brightness (or whatever it really is; I&#39;ll just say
sRGB henceforth), not linear light values. All graphs are 0-based, so you can
judge ratios of brightness values by the ratios of their height above the baseline. (You
can mentally square those ratios to get an approximate light-linear ratio.
I&#39;m begging off on doing light-linear graphs just because this is already way
more work than I should have ever done on something I&#39;m never going to work on
myself.)
</p><p>
On the left we can see the lighting darkens more quickly as we approach the edge,
whereas the righthand side shows a much more linear climb (because it&#39;s traversing
through the soft shadow, presumably). There&#39;s also a very pronounced dip at the very
edge, but it&#39;s unclear what this is due to. (It might not even be a lighting effect;
perhaps the corner is dirtier.)
</p><p>
The edge between (a) and (d) looks similar when graphed.
</p><p>
But let&#39;s look at the edge between (a) and (c), which is in theory less exaggerated,
and more like a &#34;real world AO&#34; effect, in that it has the most-indirected lighting.
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0050_2.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0050_2.png"/>
</p><p>
Again we can see a clear darkening towards the edge, but the effect is significantly
reduced in magnitude. There&#39;s no downward dip at the center.
</p><p>
Some care must be exercised in comparing graphs. Ideally, the line segments would
be split in two and each half would be perpendicular to the edge in world space,
and we would
account for foreshortening. Instead I&#39;m using a single line which may foreshorten
differently, and the graph is autoscaled to however many pixels are covered, which
may not always be consistent. In particular, the second line above definitely looks
less perpendicular than the first, but I&#39;m not sure how big an effect this is.
</p><p>
By the way, to help understand scale: wall (c) is 13.5 inches wide. So the green
line segment on it (displayed in the left half of the graph) is probably around 4 inches long,
and the same range of brightness
it traverses in those 4 inches would probably only take 3 inches if the line were
perpendicular to the edge.
</p><p>
Again, someone else who&#39;s actually working in this area should do it more properly.
I just want to call attention to the issue.
</p><h3>A Sampling Of Corners Without Dominating Soft Shadows</h3>
<p>
Let&#39;s take a look at three corners visible in the following image:
</p><p><img src="http://nothings.org/gamedev/ssao/IMG_0060.JPG"/></p><p>
I&#39;ve taken separate photographs that are zoomed in for closer shots, which we&#39;ll
use to actually sample the edges.
</p><h4>Left corner</h4>
<p><img src="http://nothings.org/gamedev/ssao/IMG_0060_1.jpg"/></p><p><img src="http://nothings.org/gamedev/ssao/IMG_0055.JPG"/></p><p>
The only truly direct light on this is from the left; the principal lighting appears to
be lighting from the same recessed lamp on the ceiling; I&#39;m not sure how indirect it is.
In real life the area is moderately dark. (Note also that the image corners are darkened
due to camera lens vignetting due to the large zoom factor.)
</p><p>
Here&#39;s what the pixels between the wall and the ceiling look like:
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0055_10.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0055_10.png"/>
</p><p>
The ceiling darkens slightly as it approaches the edge, but the wall is still
brightening).
</p><h4>Middle corner</h4>
<p><img src="http://nothings.org/gamedev/ssao/IMG_0060_2.jpg"/></p><p>
Here&#39;s a longer exposure of this corner which is moderately lit although
almost entirely indirectly lit,  as you can see from
the shadows above.
</p><p><img src="http://nothings.org/gamedev/ssao/IMG_0059.JPG"/></p><p>
This doesn&#39;t really look to me like it&#39;s just brighter version of the above image;
it seems like the walls darken a lot less significantly. Fortunately, we can check
the numbers.
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0059_14.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0059_14.png"/>
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0059_15.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0059_15.png"/>
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0059_16.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0059_16.png"/>
</p><p>
These are much flatter than I expected; it looks like while there&#39;s some
darkening of the left wall, I guess a lot of the darkening I&#39;m &#34;seeing&#34; is
really just Mach banding. (But don&#39;t forget the difference between sRGB
and linear light, which means the linear light darkening is more significant
than the graph shows.)
</p><p>
But now let&#39;s go back to the long shot and measure the numbers there:
</p><p>
<img src="http://nothings.org/gamedev/ssao/highlight_IMG_0060_18.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0060_18.png"/>
</p><p>
<img src="http://nothings.org/gamedev/ssao/highlight_IMG_0060_19.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0060_19.png"/>
</p><p>
<img src="http://nothings.org/gamedev/ssao/highlight_IMG_0060_17.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0060_17.png"/>
</p><p>
And sure enough, the darkening is way less prominent here than I
think it is visually. I have no idea why it looks like it&#39;s a more
significant darkening factor to me. Maybe going to light-linear
would make it clearer.
</p><h4>Right corner</h4>
<p><img src="http://nothings.org/gamedev/ssao/IMG_0060_3.jpg"/></p><p><img src="http://nothings.org/gamedev/ssao/IMG_0057.JPG"/></p><p>
This space above the cabinet above the refrigerator seems
to be predominantly indirectly lit. However, note that the
left wall and ceiling are <i>severely</i> foreshortened and
significantly foreshortened respectively, so
the rapid darkening we see here is actually much more gradual
in worldspace.
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0057_11.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0057_11.png"/>
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0057_12.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0057_12.png"/>
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0057_13.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0057_13.png"/>
</p><p>
Again, the effect on the back wall is extremely mild (the mach
band effect is much stronger), while the effect on the left wall
and ceiling is very clear (although enchanced by the
foreshortening). Note that the Mach band effect only happens
because the other wall is brighter; if the back wall were painted
a brighter color than the other walls it probably wouldn&#39;t happen
at all (as it didn&#39;t in the &#34;left corner&#34; above).
</p><p>
(BTW, you can verify that things are Mach banding effects by covering
up one side of the edge and seeing if the edge-darkening effect
goes away. This is definitely going on for me with the back wall.)
</p><p>
By the way, I
also tested graphing the output of a 3x3 box-filter isntead of 5x5, and the
results looked similar.
</p><h4>The Darkest Room in the House</h4>
<p>
Here we&#39;ll peek into a dark bathroom.
</p><p>
<img src="http://nothings.org/gamedev/ssao/IMG_0061.JPG"/>
</p><p>
That sure looks like some darkening along the edges.
</p><p>
Zooming in, with a 1/8th of a second exposure, gives us:
</p><p>
<img src="http://nothings.org/gamedev/ssao/IMG_0062.JPG"/>
</p><p>
Where&#39;d the darkening go? We run the numbers:
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0062_23.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0062_23.png"/>
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0062_24.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0062_24.png"/>
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0062_25.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0062_25.png"/>
</p><p>
There&#39;s some darkening going on, but it ain&#39;t much.
Once again, let&#39;s
go back to the original image and pull the numbers from
those and compare.
</p><p><img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0061_20.jpg"/>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0061_21.jpg"/>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0061_22.jpg"/>
</p><p>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0061_20.png"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0062_23.png"/>
</p><p>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0061_21.png"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0062_24.png"/>
</p><p>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0061_22.png"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0062_25.png"/>
</p><p>
The first two seem a bit different, but this could
be due to the difference of the length of the line
segments in worldspace. Hmm.
</p><h4>More Corners</h4>
Here&#39;s a corner pretty close to a light.
<p>
<img src="http://nothings.org/gamedev/ssao/IMG_0064.JPG"/>
</p><p>
Obviously some of the fall-off towards the edges
will be due to direct lighting fall-off. But is
there some more &#34;extra&#34; fall-off towards the edge
that we should simulate using SSAO?
</p><p>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0064_26.png"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0064_28.png"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0064_29.png"/>
</p><p>
I say no.
</p><p>
Here&#39;s a corner above where I&#39;m typing this right now.
</p><p>
<img src="http://nothings.org/gamedev/ssao/IMG_0067.JPG"/>
</p><p>
This is the first corner I look at when I&#39;m sitting at my
computer and I think &#34;what does a corner really look like?&#34;
</p><p>
Answer: not like crappy AO darkening!
</p><p>
The primary light is a floor lamp far to the left; because
the right wall is facing it the right wall is brighter.
</p><p>
There&#39;s an obvious darkening of the left wall above the
boundary between the monitors; this is a shadow from a second
light (everything right of it, meaning all the lines sampled
below, are in shadow from that second light).
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0067_37.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0067_37.png"/>
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0067_38.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0067_38.png"/>
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0067_39.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0067_39.png"/>
</p><p>
Note that there is basically no corner-darkening effect. The ceiling actually
brightens as it approaches the right wall, presumably because the right wall
is brighter at the top because of the direct lighting on it.
</p><p>
Only the line along the left wall as it approaches the ceiling shows
any significant darkening that might be best simulated by AO. But
while AO might make that part of the line look more realistic, it
will make the other five look less realistic.
</p><p>
Just for reference, here&#39;s a closeup of the corner.
</p><p>
<img src="http://nothings.org/gamedev/ssao/IMG_0068.JPG"/>
</p><p>
And the graphs are still pretty similar (although noisier due to the
visible texture, and these cover a slightly smaller region, though
I used longer lines to try to compensate):
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0068_40.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0068_40.png"/>
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0068_41.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0068_41.png"/>
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0068_42.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0068_42.png"/>
</p><p>
Again I invite you to cover the brighter side of each edge to see
whether the edge darkening is real or a perceptual artifact.
</p><h4>One Last Thing</h4>
Let&#39;s look at a single edge between the ceiling and a wall.
<p>
<img src="http://nothings.org/gamedev/ssao/IMG_0071.JPG"/>
</p><p>
The light is on the right. As you go left, it gets darker, and the
contribution due to ambient light should become a larger and larger
fraction. Can we see an increasing effect of AO-esque darkening?
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0071_43.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0071_43.png"/>
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0071_44.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0071_44.png"/>
</p><p>
<img src="http://nothings.org/gamedev/ssao/thumb_highlight_IMG_0071_45.jpg"/>
<img src="http://nothings.org/gamedev/ssao/graph_IMG_0071_45.png"/>
</p><p>
The vertical axis of the graph is autoscaled (the baseline is always 0).
So if there were a meaningful edge-darkening of &#34;ambient&#34; light going on
(by which I mean if the AO corner-darkening model was at all a reasonable
approximation of the real world), we&#39;d expect to see an increasing amount
of darkening towards the edge as the measured region goes into darkness.
What I see in the above graph is that the ceiling&#39;s edge-darkening does
increase (it goes from getting slightly brighter at the edge in the first
graph to getting slight darker in the last), but the wall seems to show an
an essentially opposite effect (going from just barely darkening at the edge
on the first graph, to increasing in the second, to being flat in the third).
</p><h2>What I Think</h2>
<p>
There is an edge-darkening effect along concave boundaries between walls (surfaces),
but it is subtle and only happens some of the time. The only time a strongly
prominent edge-darkening occurs is when the facing surface is itself already
significantly darkening at the edge for another reason (such as soft shadows).
</p><p>
And that&#39;s probably not what your SSAO is doing.
</p><hr/>
<h2>Appendix A</h2>
<p>
Here&#39;s the code used to generate the graphs from a list of points and image filenames.
</p><pre>#define STB_IMAGE_WRITE_IMPLEMENTATION
#include &#34;stb_image_write.h&#34;
#define STBI_NO_WRITE  // disable writer in old version of stb_image
#include &#34;stb_image.c&#34;
#define STB_PLOT_IMPLEMENTATION
#include &#34;stb_plot.h&#34; // unfinished, unreleased line graph library
#define STB_DEFINE
#include &#34;stb.h&#34;

int main(int argc, char **argv)
{
   int i,n;
   char **data = stb_stringfile(&#34;c:/imv_log.txt&#34;, &amp;n);
   for (i=0; i &lt; n; i += 2) {
      int w,h;
      int x0,y0,x1,y1,j,len;
      uint8 *pixels;
      char file1[999], file2[999], name[999];

      stbplot_dataset *ds = stbplot_dataset_create();
      stbplot_variable *v = stbplot_dependent_variable(ds, &#34;brightness&#34;);

      if (  sscanf(data[i  ], &#34;%d%d%s&#34;, &amp;x0,&amp;y0, file1) != 3
         || sscanf(data[i+1], &#34;%d%d%s&#34;, &amp;x1,&amp;y1, file2) != 3)
         stb_fatal(&#34;Error on line %d\n&#34;, i+1);
      if (strcmp(file1, file2)) stb_fatal(&#34;Mismatch %1 vs %2\n&#34;, i+1, i+2);

      pixels = stbi_load(file1, &amp;w, &amp;h, NULL, 3);
      if (x0 &gt;= w || y0 &gt;= h || x1 &gt;= w || y1 &gt;= h) stb_fatal(&#34;Bad point in %d/%d&#34;, i+1,i+2);

      len = max(abs(x1-x0),abs(y1-y0));
      for (j=0; j &lt;= len; ++j) {
         int dx,dy,c,sum=0;
         int x = (int) stb_linear_remap(j,0,len,x0,x1);
         int y = (int) stb_linear_remap(j,0,len,y0,y1);
         for (dx = -2; dx &lt;= 2; ++dx)
            for (dy = -2; dy &lt;= 2; ++dy)
               for (c=0; c &lt; 3; ++c)
                  sum += pixels[(y+dy)*3*w + (x+dx)*3 + c];
         stbplot_add_value(j, v, (double) sum / (9*3));
      }

      stb_splitpath(name, file1, STB_FILE);
      stbplot_plot(stb_sprintf(&#34;c:/temp2/graph_%s_%d.bmp&#34;, name, i/2+1),
                   ds, &#34;Pixel brightness&#34;, 600, 400, 1);
      stbplot_dataset_destroy(ds);

      // overdraw the highlight
      for (j=0; j &lt;= len; ++j) {
         int dx, dy, c, color[3] = { 128,255,128 };
         int x = (int) stb_linear_remap(j,0,len,x0,x1);
         int y = (int) stb_linear_remap(j,0,len,y0,y1);
         for (dx = -2; dx &lt;= 2; ++dx)
            for (dy = -2; dy &lt;= 2; ++dy)
               for (c=0; c &lt; 3; ++c)
                  pixels[(y+dy)*3*w + (x+dx)*3 + c] = color[c];
      }
      stbi_write_png(stb_sprintf(&#34;c:/temp2/highlight_%s_%d.png&#34;, name, i/2+1),
                     w,h,3,pixels,w*3);
   }
   return 0;
}
</pre>
I got lucky and it worked correctly on after the first successful compile. It never hit the error cases.
Does that mean I shouldn&#39;t have bothered writing the error cases for such a small,
single-use program? Hmm.
<hr/>
<a href="http://nothings.org/">home</a>


</div>
  </body>
</html>
