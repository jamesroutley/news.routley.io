<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://danpalmer.me/2023-01-08-activitypub-vs-web-frameworks/">Original</a>
    <h1>Activity Pub vs. Web Frameworks</h1>
    
    <div id="readability-page-1" class="page"><article><header><p><time>08 January, 2023</time></p></header><section><p>In an attempt to self-host a low-cost fediverse node, I started with <a href="https://gotosocial.org/" target="_blank" rel="nofollow noopener noreferrer">GoToSocial</a>, but later decided to switch to <a href="https://joinmastodon.org/" target="_blank" rel="nofollow noopener noreferrer">Mastodon</a> for better compatibility. This transition presented some challenges and got me thinking about whether existing web frameworks are well designed for linked data services.</p>
<p>Activity Pub, the underlying protocol for the fediverse, necessitates storing URIs to resources on other nodes in the network, and as such, even after running GoToSocial for 24 hours, there were already many links to the node. Fully preserving these links when moving from GoToSocial to Mastodon would require significant work to migrate and transform data, extend Mastodon, and/or add manual redirects to the frontend webserver.</p>
<h2 id="background-on-linked-data"><a href="#background-on-linked-data" aria-label="background on linked data permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Background on linked data</h2>
<p>Rather than numbers or strings used as identifiers, a core concept in linked data, and by extension, Activity Pub, is that all identifiers are URIs, that when resolved, return the identified content. In practice this means that when one piece of data (e.g. a social media post) references another piece (e.g. a user), that reference is by URI, rather than by some arbitrary identifier, and by following that URI the entity it points to is returned.</p>
<h5 id="example"><a href="#example" aria-label="example permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Example</h5>
<p>In a typical web application we might see the following:</p>
<pre data-language="json" data-index="0"><code><span><span><span>// Post</span></span></span>
<span><span><span>{</span></span></span>
<span><span><span>    </span><span>&#34;id&#34;</span><span>: </span><span>38274923842</span><span>,</span></span></span>
<span><span><span>    </span><span>&#34;content&#34;</span><span>: </span><span>&#34;Lorem ipsum dolor sit amet&#34;</span><span>,</span></span></span>
<span><span><span>    </span><span>&#34;user&#34;</span><span>: </span><span>1024</span><span>,</span></span></span>
<span><span><span>}</span></span></span>
<span><span></span></span>
<span><span><span>// User 1024</span></span></span>
<span><span><span>{</span></span></span>
<span><span><span>    </span><span>&#34;id&#34;</span><span>: </span><span>1024</span><span>,</span></span></span>
<span><span><span>    </span><span>&#34;name&#34;</span><span>: </span><span>&#34;Dan Palmer&#34;</span></span></span>
<span><span><span>}</span></span></span></code></pre>
<p>In a linked data application, this would instead look like…</p>
<pre data-language="json" data-index="1"><code><span><span><span>// Post</span></span></span>
<span><span><span>{</span></span></span>
<span><span><span>    </span><span>&#34;id&#34;</span><span>: </span><span>&#34;https://example.social/posts/38274923842&#34;</span><span>,</span></span></span>
<span><span><span>    </span><span>&#34;content&#34;</span><span>: </span><span>&#34;Lorem ipsum dolor sit amet&#34;</span><span>,</span></span></span>
<span><span><span>    </span><span>&#34;user&#34;</span><span>: </span><span>&#34;https://example.social/users/1024&#34;</span><span>,</span></span></span>
<span><span><span>}</span></span></span>
<span><span></span></span>
<span><span><span>// User 1024</span></span></span>
<span><span><span>{</span></span></span>
<span><span><span>    </span><span>&#34;id&#34;</span><span>: </span><span>&#34;https://example.social/users/1024&#34;</span><span>,</span></span></span>
<span><span><span>    </span><span>&#34;name&#34;</span><span>: </span><span>&#34;Dan Palmer&#34;</span></span></span>
<span><span><span>}</span></span></span></code></pre>
<p>The main benefit of this is that following a relationship requires no additional knowledge. It’s just a link, and links have well-defined semantics. The client does not need to know how to build a URI for the content it’s seeking. This is of particular benefit in federated systems, where the servers are heterogenous, but all implementing the same spec.</p>
<p>This is a powerful design that has existed for many years with other forms of linked data, and it’s great to see it take off in a new way with Activity Pub.</p>
<h2 id="uris-in-rest-ish-and-linked-data-applications"><a href="#uris-in-rest-ish-and-linked-data-applications" aria-label="uris in rest ish and linked data applications permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>URIs in REST-ish and linked data applications</h2>
<p>Inherent in linked data specifications is that <em>parts</em> of the URI have no semantics. In other words, there’s no difference between <code>/users/dan</code> and <code>/929ee2ad/6a4f/42a3/b2af/4a739599c340</code>.</p>
<p>This is in direct contrast to typical REST-ish APIs that may use arbitrary identifiers. In these systems, clients <em>must</em> understand the identifiers and how they compose into paths to be used as URIs to request content.</p>
<p>There are advantages to URIs such as <code>/users/123</code> – they are inherently debuggable, building monitoring based on the structure can provide insight into performance or usage analytics, and they’re developer friendly. For these reasons they may still be appropriate for linked data systems, as long as they are not the source of truth for routing.</p>
<p>Unfortunately almost all web frameworks are designed for the REST-<em>ish</em> applications where the client constructs URIs, and have the concept of a router based on path segments. A segment like <code>/users/:int</code> would route to a controller for the users collection, and then match an integer typically for querying from a database. This works well for REST-<em>ish</em> APIs, but falls down when it comes to federated linked data systems.</p>
<h2 id="challenges-in-for-linked-data-applications"><a href="#challenges-in-for-linked-data-applications" aria-label="challenges in for linked data applications permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Challenges in for linked data applications</h2>
<p>When migrating between systems, this difference presents a problem. Because the semantics of the URI structure differs between systems, a migration is not as simple as moving the data, because external systems will still have pointers to the old URI structure.</p>
<p>This issue is not limited to migrating between entire systems, but can crop up as requirements change within an existing system. It’s also not limited to linked data applications, but is an old and well known issue on the web<sup id="fnref-1"><a href="#fn-1">1</a></sup> – <a href="https://www.w3.org/Provider/Style/URI.html" target="_blank" rel="nofollow noopener noreferrer">cool URIs don’t change</a>.</p>
<p>For engineers working with the code itself this is a pain point, but not insurmountable. However for non-engineers working with applications and configuration – such as the average Mastodon or Wordpress admin – this is nearly impossible to achieve.</p>
<p>As Activity Pub requires the storing of URIs as identifiers on federated servers (i.e. servers storing data pointing to content on other servers), a single instance can’t simply change its URI structure. Doing so would break the federation, causing data to become inconsistent. Posts would be unavailable at their identifying URI, but perhaps still cached. Users would disappear from the network, but others may still be following them. Chaos would ensue.</p>
<h2 id="traditional-solutions-wont-work"><a href="#traditional-solutions-wont-work" aria-label="traditional solutions wont work permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Traditional solutions won’t work</h2>
<p>There are three standard solutions to preserving URIs after a structural change.</p>
<ol>
<li>Do nothing, breaking links. Unfortunately common for blogs and smaller websites.</li>
<li>Hard-coded redirects. Quick and easy to do, but doesn’t scale. Often requires editing code or configuration for a frontend webserver, not something in the skillset of all operators.</li>
<li>Redirects stored in a database. Often built into blogging platforms, but higher cost. Can scale far, but can be expensive to compute for every single request, and can be tricky to integrate nicely<sup id="fnref-2"><a href="#fn-2">2</a></sup>,</li>
</ol>
<p>As <em>everything</em> is a linked data object in Activity Pub – every post, user, photo, poll, link, follow, etc – there are just too many to handle. A typical single user may generate tens of thousands of these links every year.</p>
<p>In order to not break federation, rendering users unable to interact with the fediverse, (1) is not an option. (2) would be unlikely to be workable for any scale, and (3) would require significant engineering effort to make a reality.</p>
<h2 id="alternative-solutions"><a href="#alternative-solutions" aria-label="alternative solutions permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Alternative solutions</h2>
<p>If current web frameworks aren’t ideal for linked data applications such as Activity Pub servers, perhaps there’s room for a framework that addresses these issues. The main aim of a framework for linked data would be to treat URIs as atomic identifiers, potentially even with fully opaque identifiers.</p>
<p>For such a system there would likely be two litmus tests:</p>
<ol>
<li>Can the framework function in most of the ways we’d expect from a modern web framework, but with every URI being a UUID?</li>
<li>Can arbitrary documents be imported into the framework and supported on an ongoing basis (“cool URIs don’t change”).</li>
</ol>
<p>These requirements suggest that the framework would likely be <em>content based</em>, rather than <em>route based</em> – looking up content by URI and then calling code to act on that content, rather than looking up code based on a route, and that code potentially looking up content.</p>
<p>Being content based implies database queries for every request as in the previously mentioned option (3), but by raising this functionality to the framework level, more optimisations may be implemented, and correctness ensured, in one place, likely resulting in a lower impact of those additional queries.</p>
<p>This has some knock-on effects. It would make it hard to create RPC-style APIs, but perhaps this is a benefit? There may be issues around paginated collections (how do pagination control parameters work?), but this is already a problem with specifications such as Activity Pub, where there is <em>no</em> defined way to do pagination other than URIs to first/last/next/previous pages, and leaking the details of how query parameters work for pagination would go against the idea of opaque URIs anyway. (I’m exploring what a framework in this style would look like and the challenges associated with it.)</p>
<h5 id="existing-solutions"><a href="#existing-solutions" aria-label="existing solutions permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Existing solutions?</h5>
<p>Perhaps a new framework would be re-inventing the wheel. One of the conclusions that is often reached when working through the impacts of this is that the server is necessarily relatively simple, at least compared to a typical web application. Perhaps then, the focus should be on smart <em>clients</em>, and servers should be mostly a data store.</p>
<p>One possible solution would be using a <a href="https://en.wikipedia.org/wiki/Triplestore" target="_blank" rel="nofollow noopener noreferrer">triple-store</a> as a source of truth (likely with metadata for permissions). An Activity Pub implementation may be little more than a triple-store with rewrites from the URI being served to a query to execute. The structure of the data could be mostly defined by the specification. (This is an area I have not dug deep into or used in production however so there may be more to it in practice.)</p>
<h2 id="conclusion"><a href="#conclusion" aria-label="conclusion permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h2>
<p>Current web frameworks work in ways that are often ill-suited to linked data applications. This presents challenges in building, maintaining, migrating, and administrating these systems.</p>
<p>As Activity Pub hits the mainstream, the effects of this will become noticeable by end users, as broken links in the fediverse graph become broken user experiences in the social network.</p>
<p>A linked data approach to building frameworks may alleviate these issues, but more work is needed to understand the full impacts of such a framework and whether it would be a good way to build such applications.</p>

</section></article></div>
  </body>
</html>
