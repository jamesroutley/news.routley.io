<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.collabora.com/news-and-blog/blog/2021/11/26/venus-on-qemu-enabling-new-virtual-vulkan-driver/">Original</a>
    <h1>Venus on QEMU: Enabling the new virtual Vulkan driver</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>With virtualization we can create multiple virtual machines over a single physical computer. The benefits of virtualization are countless, from being able to create virtual representation of different machines, to efficiently use the currently available hardware. Clearly a virtual machine, like any real computer, needs an operating system (OS). In this context it is called a Guest OS, as opposed to the one running on real hardware, called Host OS.</p>
<p>Running graphics applications in a Guest OS can be annoying as they are generally greedy of computing resources, and that can slow you down or give you a bad experience in terms of graphics performance. Being able to accelerate all this by offloading the workload to the hardware can be a great deal. The VirtIO-GPU virtual GPU device comes into play here, allowing a Guest OS to send graphics commands to it through <a href="https://www.khronos.org/opengl/" target="_blank" rel="noopener noreferrer">OpenGL</a> or <a href="https://www.vulkan.org/" target="_blank" rel="noopener noreferrer">Vulkan</a>. While <a href="https://notebook.wesleyac.com/reactionary/news-and-blog/blog/2019/08/28/virglrenderer-state-of-virtualized-virtual-worlds/" target="_blank" rel="noopener noreferrer">we are already there with OpenGL</a>, we can not say the same for Vulkan. Well, until now.</p>

<p><strong>Jump to a section: </strong><a href="https://notebook.wesleyac.com/reactionary/news-and-blog/blog/2021/11/26/venus-on-qemu-enabling-new-virtual-vulkan-driver#overview">Overview</a> | <a href="https://notebook.wesleyac.com/reactionary/news-and-blog/blog/2021/11/26/venus-on-qemu-enabling-new-virtual-vulkan-driver#definitions">Definitions</a> | <a href="https://notebook.wesleyac.com/reactionary/news-and-blog/blog/2021/11/26/venus-on-qemu-enabling-new-virtual-vulkan-driver#prerequisites">Prerequisites</a> | <a href="https://notebook.wesleyac.com/reactionary/news-and-blog/blog/2021/11/26/venus-on-qemu-enabling-new-virtual-vulkan-driver#creatingqemu">Create an image for QEMU</a> | <a href="https://notebook.wesleyac.com/reactionary/news-and-blog/blog/2021/11/26/venus-on-qemu-enabling-new-virtual-vulkan-driver#runningqemu">Running QEMU</a> | <a href="https://notebook.wesleyac.com/reactionary/news-and-blog/blog/2021/11/26/venus-on-qemu-enabling-new-virtual-vulkan-driver#testingvenus">Testing Venus</a> | <a href="https://notebook.wesleyac.com/reactionary/news-and-blog/blog/2021/11/26/venus-on-qemu-enabling-new-virtual-vulkan-driver#troubleshooting">Troubleshooting</a> | <a href="https://notebook.wesleyac.com/reactionary/news-and-blog/blog/2021/11/26/venus-on-qemu-enabling-new-virtual-vulkan-driver#conclusions">Conclusions</a></p>
<hr/>
<h3>Overview</h3>
<p>This blog post describes how to enable 3D acceleration of Vulkan applications in <a href="https://www.qemu.org/" target="_blank" rel="nofollow noopener noreferrer">QEMU</a> through the <a href="https://docs.mesa3d.org/drivers/venus.html" target="_blank" rel="noopener noreferrer">Venus</a> experimental Vulkan driver for VirtIO-GPU with a local development environment.</p>
<p>As an alternative you could cherry-pick <a href="https://gitlab.freedesktop.org/Fahien/qemu/-/commit/19059007407dcc00fd9c0690310acc9cb9a4d1c9" target="_blank" rel="noopener noreferrer">this commit</a> which contains a set of scripts you could use to set up a Docker development environment.</p>
<p><iframe src="https://www.youtube.com/embed/4lroa1dYLz0" width="100%" height="380" frameborder="0" allowfullscreen="allowfullscreen"></iframe></p>

<h3>Definitions</h3>
<p>Let us start with a brief description of the projects mentioned in this post:</p>
<ul>
<li><a href="https://www.qemu.org/" target="_blank" rel="noopener noreferrer">QEMU</a> is an open-source machine emulator, and we will use it to run an <a href="https://ubuntu.com/download/desktop" target="_blank" rel="noopener noreferrer">Ubuntu</a> guest operating system and take advantage of the <a href="https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/virtio-v1.1-cs01.html#x1-3200007" target="_blank" rel="nofollow noopener noreferrer">VirtIO-GPU</a> device available in the virtual machine.</li>
<li><a href="https://virgil3d.github.io/" target="_blank" rel="noopener noreferrer">VirGL</a> is an OpenGL driver for VirtIO-GPU, available in <a href="https://www.mesa3d.org/" target="_blank" rel="nofollow noopener noreferrer">Mesa</a>.</li>
<li><a href="https://docs.mesa3d.org/drivers/venus.html" target="_blank" rel="noopener noreferrer">Venus</a> is an experimental Vulkan driver for VirtIO-GPU, also available in Mesa.</li>
<li><a href="https://gitlab.freedesktop.org/virgl/virglrenderer" target="_blank" rel="nofollow noopener noreferrer">Virglrenderer</a> is a library that enables hardware acceleration to VM guests, effectively translating commands from the two drivers just mentioned to either OpenGL or Vulkan.</li>
</ul>

<h3>Prerequisites</h3>
<p>The following snippets are prefixed by either <code>(host)</code> or <code>(guest)</code> to specify where they should run. Of course, in order to run something in the guest, you should have QEMU and an image already in place.</p>
<h4>Host</h4>
<ol>
<li>
<p>Venus requires BLOB resources support in QEMU, which in turns requires <code>/dev/udmabuf</code>. This is not enabled in the default Debian kernel, so make sure your kernel was built with <code>CONFIG_UDMABUF</code>.</p>
<blockquote>
<p data-sourcepos="41:6-41:142">Please note that you could encounter the following error with kvm on AMD when enabling BLOB support: <code>error: kvm run failed Bad address</code>.</p>
</blockquote>
</li>
<li>
<p>Clone virglrenderer <code>res-sharing</code> branch from <a href="https://gitlab.freedesktop.org/Fahien/virglrenderer" target="_blank" rel="nofollow noopener noreferrer">FDO/fahien</a> and compile it with:</p>
<pre>(host)

git clone -b res-sharing https://gitlab.freedesktop.org/Fahien/virglrenderer.git

cd virglrenderer

meson build \
    -Dprefix=$HOME/.local \
    -Dplatforms=egl \
    -Dvenus-experimental=true \
    -Dminigbm_allocation=false \
    -Dbuildtype=debugoptimized

ninja -C build install
</pre>
</li>
<li>Clone QEMU branch <code>venus-dev</code> from <a href="https://gitlab.freedesktop.org/Fahien/qemu" target="_blank" rel="nofollow noopener noreferrer">FDO/fahien</a>. Then configure and compile it enabling OpenGL, VirGL, GTK (or SDL if you prefer this frontend):
<pre>(host)

git clone -b venus-dev https://gitlab.freedesktop.org/Fahien/qemu.git

cd mesa

mkdir build &amp;&amp; cd build

../configure                   \
  --prefix=$HOME/.local        \
  --target-list=x86_64-softmmu \
  --enable-kvm                 \
  --disable-werror             \
  --enable-opengl              \
  --enable-virglrenderer       \
  --enable-gtk                 \
  --enable-sdl

make -j4 qemu-system-x86_64 &amp;&amp; make install
</pre>
</li>
</ol>
<h4>Guest</h4>
<ul>
<li>
<p>Linux kernel <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?h=v5.16-rc1" target="_blank" rel="nofollow noopener noreferrer"><code>v5.16-rc1</code></a>+.</p>
</li>
<li>
<p>Mesa version <code>21.1+</code>, configured with <code>meson -Dvulkan-drivers=virtio-experimental</code>. Please note that to enable Vulkan headless you will need to apply <a href="https://gitlab.freedesktop.org/Fahien/mesa/-/commit/f4c426422b1be8d8d6e9b3e328b8a87ed46af0b1" target="_blank" rel="nofollow noopener noreferrer">this patch</a>.</p>
</li>
<li>
<p>Install <code>vulkan-utils</code> and run <code>vulkaninfo | grep driver</code> to get some info on the available vulkan drivers.</p>
</li>
<li>
<p>Test <a href="https://github.com/krh/vkcube" target="_blank" rel="nofollow noopener noreferrer">vkcube</a>.</p>
</li>
</ul>

<h3>Create an image for QEMU</h3>
<p>You will need to provide QEMU an image. Here is an example of how to make one.</p>
<pre>(host)

ISO=ubuntu-21.04-desktop-amd64.iso
wget https://releases.ubuntu.com/21.04/$ISO

IMG=ubuntu.qcow2
qemu-img create -f qcow2 $IMG 16G

# Start ubuntu installation by booting from CD-ROM.
# No need for graphics acceleration at the moment.
qemu-system-x86_64                  \
    -enable-kvm                     \
    -M q35                          \
    -smp 1                          \
    -m 4G                           \
    -net nic,model=virtio           \
    -net user,hostfwd=tcp::2222-:22 \
    -hda $IMG                       \
    -display gtk                    \
    -boot d -cdrom $ISO
</pre>

<h3>Running QEMU</h3>
<p>Running with <code>-d guest_errors</code> will show error messages from the guest.</p>
<pre>(host)

qemu-system-x86_64                                               \
    -enable-kvm                                                  \
    -M q35                                                       \
    -smp 1                                                       \
    -m 4G                                                        \
    -cpu host                                                    \
    -net nic,model=virtio                                        \
    -net user,hostfwd=tcp::2222-:22                              \
    -hda $IMG                                                    \
    -device virtio-vga-gl,context_init=true,blob=true,hostmem=4G \
    -vga none                                                    \
    -initrd /image/rootfs.cpio.gz                                \
    -kernel /kernel/arch/x86_64/boot/bzImage                     \
    -append &#34;root=/dev/sda3 nokaslr&#34;                             \
    -display gtk,gl=on,show-cursor=on                            \
    -usb -device usb-tablet                                      \
    -object memory-backend-memfd,id=mem1,size=4G                 \
    -machine memory-backend=mem1                                 \
    -d guest_errors
</pre>
<h4>OpenGL-enabled GTK3 display</h4>
<p>VirtIO VGA GL (<code>-device virtio-vga-gl</code>) requires OpenGL support by the current QEMU display, which can be enabled with the following cli option <code>-display gtk,gl=on</code>.</p>
<p>For some reason, we hit a GTK assertion due to a failure in <code>gtk_widget_get_realized()</code>. The solution is to run QEMU with <code>-vga none</code> to avoid having two scanouts, one for VGA and another for virtio-vga-gl.</p>
<h4>Build the kernel</h4>
<p>I made a custom config (<a href="https://gitlab.freedesktop.org/Fahien/qemu/-/raw/50823913c09b4d2f3eddfb69f1b6f321073e3004/tests/vulkan/docker/guest/x86_64.config" target="_blank" rel="nofollow noopener noreferrer">x86_64.config</a>) to build VirtIO-GPU and DRM within the kernel with debug info.</p>
<pre>(host)

git clone --depth 1 -b v5.16-rc1 https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git kernel

cd kernel

./scripts/kconfig/merge_config.sh arch/x86/configs/x86_64_defconfig x86_64.config

make -j12 vmlinux bzImage
</pre>
<p>Starting Qemu with our custom kernel can be done by setting the current command line options:</p>
<pre>-kernel arch/x86_64/boot/bzImage \
-inintrd ramdisk.img \
-append &#34;root=/dev/sda3&#34; \
</pre>
<blockquote>
<p>You can create <code>ramdisk.img</code> by running <code>mkinitramfs -o ramdisk.img</code></p>
</blockquote>

<h3>Testing Venus</h3>
<p>Make sure VirGL is correctly detected and used by running the following:</p>
<pre>(guest) glxinfo -B
</pre>
<p>If it outputs <code>llvmpipe</code> instead, build mesa with this configuration:</p>
<pre>(guest)

git clone -b qemu-venus https://gitlab.freedesktop.org/Fahien/mesa.git

cd mesa

meson build                                   \
  -Dprefix=/usr                               \
  -Ddri3=enabled                              \
  -Dglx=dri                                   \
  -Degl=enabled                               \
  -Dgbm=enabled                               \
  -Dgallium-vdpau=disabled                    \
  -Dgallium-vs=disabled                       \
  -Dvalgrind=disabled                         \
  -Dbuildtype=debugoptimized                  \
  -Ddri-drivers=[]                            \
  -Dgallium-drivers=swrast,virgl              \
  -Dvulkan-drivers=swrast,virtio-experimental \
  -Dvulkan-layers=device-select

ninja -C build install
</pre>
<p>Then compile and and run vkcube to test Venus, making sure to tell mesa the correct Vulkan ICD file name:</p>
<pre>(guest)

sudo apt install meson build-essential libdrm-dev libgbm-dev libpng-devibwayland-dev libxcb1-dev libvulkan-dev

git clone https://github.com/krh/vkcube.git

cd vkcube

meson build &amp;&amp; meson compile -C build

VK_ICD_FILENAMES=/usr/shared/vulkan/icd.d/virtio_icd.x86_64.json build/vkcube
</pre>

<h3>Troubleshooting</h3>
<p>At this point the venus driver should be correctly loaded, and debug messages can be enabled by setting the <code>VN_DEBUG</code> environment variable to one of the following: <code>init</code>, <code>result</code>, <code>vtest</code>, or <code>wsi</code>.</p>
<h4>Debugging the kernel</h4>
<ol>
<li>Run QEMU with arguments <code>-s -S</code>:
<ul>
<li><code>-S</code> stops qemu waiting for gdb</li>
<li><code>-s</code> starts a gdb server at <code>localhost:1234</code></li>
</ul>
</li>
<li>
<p>Your <code>~/.gdbinit</code> should contain this (make sure it does <strong>not</strong> point directly to <code>scripts/gdb/vmlinux-gdb.py</code>):</p>
<pre>add-auto-load-safe-path /path/to/linux/vmlinux-gdb.py
</pre>
</li>
<li>
<p>Run gdb and attach to QEMU gdb server:</p>
<pre>(host)

gdb vmlinux
(gdb) target remote :1234
(gdb) hbreak start_kernel
(gdb) c
</pre>
</li>
</ol>
<h5><a id="user-content-vscode-debugger" href="#vscode-debugger"><br/></a>VsCode debugger</h5>
<p>You can use VSCode Debug UI thanks to the <em>Native Debug</em> extension, attaching to gdbserver target <code>:1234</code>, and <code>autorun: [ &#34;hbreak kernel_init&#34; ]</code>.</p>
<h5><a id="user-content-gdb" href="#gdb"><br/></a>GDB</h5>
<p>Sometimes your only choice is to debug with GDB, therefore here are some useful commands to keep in mind.</p>
<table dir="auto">
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>bt</code></td>
<td>Print backtrace</td>
</tr>
<tr>
<td><code>f</code></td>
<td>Print the current frame</td>
</tr>
<tr>
<td><code>f &lt;n&gt;</code></td>
<td>Change to frame number</td>
</tr>
<tr>
<td><code>list</code></td>
<td>Print out a bunch of lines of code around the current instruction pointer</td>
</tr>
<tr>
<td><code>b &lt;func_name&gt;</code></td>
<td>Set a breakpoint</td>
</tr>
<tr>
<td><code>stepi</code></td>
<td>Step into a function</td>
</tr>
<tr>
<td><code>n</code></td>
<td>Step over to the next instruction within the current function</td>
</tr>
<tr>
<td><code>fin</code></td>
<td>Step out of a function</td>
</tr>
<tr>
<td><code>delete</code></td>
<td>Delete all breakpoints</td>
</tr>
<tr>
<td><code>delete &lt;n&gt;</code></td>
<td>Delete breakpoint number</td>
</tr>
<tr>
<td><code>info sharedlibrary</code></td>
<td>Show list of loaded library</td>
</tr>
</tbody>
</table>
<h4>Vulkan loader</h4>
<p>If your <code>libvulkan.so</code> fails with a segmentation fault, it would be a good idea to build it from source and debug it with gdb. Make sure to checkout a version in line with your <code>libvulkan-dev</code>.</p>
<pre>(guest)

git clone https://github.com/KhronosGroup/Vulkan-Loader.git vulkan-loader
cd vulkan-loader
git checkout v1.2.162
</pre>

<h3>Conclusions</h3>
<p>While you can enable Vulkan hardware acceleration by checking out the development branches following this guide, there is still further work to do on Virglrenderer and QEMU for proper upstreaming, which might need some time to complete. Virgilrenderer needs to <a href="https://gitlab.freedesktop.org/virgl/virglrenderer/-/merge_requests/647" target="_blank" rel="noopener noreferrer">fix resource import/export between OpenGL and Vulkan contexts</a>, and QEMU needs various patches currently under review:</p>
<ul>
<li><a href="https://www.mail-archive.com/qemu-devel@nongnu.org/msg850952.html" target="_blank" rel="noopener noreferrer">virtio-gpu: Shared memory capability</a></li>
<li><a href="https://www.mail-archive.com/qemu-devel@nongnu.org/msg839968.html" target="_blank" rel="noopener noreferrer">virtio-gpu: CONTEXT_INIT feature</a></li>
<li><a href="https://www.mail-archive.com/qemu-devel@nongnu.org/msg826897.html" target="_blank" rel="noopener noreferrer">virtio-gpu: Support Venus Vulkan driver</a></li>
</ul>
<p>To sum up, if you need assistance with graphics virtualization, we would be happy to help, so please do not hesitate to <a href="https://notebook.wesleyac.com/reactionary/contact-us.html">contact us</a>.</p>
<p>On the other hand, if you are a developer and would be thrilled to work on the open source Linux graphics stack, check out our <a href="https://notebook.wesleyac.com/reactionary/careers.html" target="_blank" rel="noopener noreferrer">careers page</a>!</p>


</div></div>
  </body>
</html>
