<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.sacredheartsc.com/blog/building-a-personal-voip-system/">Original</a>
    <h1>Building a Personal VoIP System</h1>
    
    <div id="readability-page-1" class="page">

<nav>
  [<a href="https://reserialised.routley.io/">home</a>] 
  [<a href="https://reserialised.routley.io/blog/">blog</a>] 
  [<a href="https://git.sacredheartsc.com/">git</a>] 
  [<a href="mailto:stonewall@sacredheartsc.com">email</a>] 
  [<a href="https://reserialised.routley.io/blog/feed.xml">rss</a>]
  <span>JMJ</span>
<hr/>
</nav>

<header>
  
<p>May 25, 2023 AD</p>
</header>


<p>I’ve always been a big <a href="https://github.com/sacredheartsc/selfhosted">self-hoster</a>, but had never attempted anything related to VoIP. I recently purchased some IP phones and set up a personal home phone network using <a href="https://www.asterisk.org/">Asterisk</a>. This guide will help you set up your own digital telephone system using open-source tools.</p>
<p>This guide is written for those who are experienced with self-hosting, but are totally unfamiliar with VoIP. Therefore, I’m going to gloss over certain uninteresting technicalities for the sake of brevity.</p>
<h2 id="sip-a-brief-introduction">SIP: A Brief Introduction</h2>
<p>Before getting your hands dirty with phone configuration and Asterisk dialplans, it’s worth taking some time to understand the underlying network protocols involved. This will pay dividends later on when you’re debugging the inevitable connectivity issues with your voice calls (trust me).</p>
<p>The <a href="https://www.ietf.org/rfc/rfc3261.txt">Session Initialization Protocol</a>, or SIP, is a signaling protocol used by basically every digital telephony device produced in the last two decades. VoIP phones, softphones, office conferencing devices…they all use SIP. SIP can use either TCP or UDP, and usually listens on port 5060.</p>
<p>There are two really important things you need to know about about SIP.</p>
<ol type="1">
<li><p>SIP does <strong>not</strong> carry the voice data. It’s just a signaling protocol, and it’s only used to negotiate which IP address, port, and audio format should be used to carry the audio stream.</p></li>
<li><p>SIP was initially released in 1999, and was designed with the assumption that each device has its own globally routable public IP address. After all, the IPv6 standard was released back in 1995, and NAT would soon be a thing of the past…right? Unforunately, this did not end up being the case.</p></li>
</ol>
<p>For example, let’s say we have a standard home network with two VoIP phones in the local 192.168.1.0/24 subnet. Consider what happens when these two phones want to call each other. In plain English, the SIP handshake will go something like this:</p>
<blockquote>
<p>Hello 192.168.1.6.</p>
</blockquote>
<blockquote>
<p>Hi there, 192.168.1.5!</p>
</blockquote>
<p>Each phone randomly chooses an unused UDP port on which to receive the other party’s audio stream. After the SIP negotiation, they will both send voice data to each other using the <a href="https://www.rfc-editor.org/rfc/rfc3550">Real-Time Transport Protocol</a>, or RTP. Since they are both on the same local network, this works fine.</p>
<h3 id="nat-problems">NAT Problems</h3>
<p>Now consider what happens when we call someone <em>outside</em> of our local network. Let’s say our router has a public IP of 203.0.113.8, and our friend Alice has address 198.51.100.7.</p>
<blockquote>
<p>Hello 198.51.100.7. Is Alice there?</p>
</blockquote>
<blockquote>
<p>Hi there, <q>192.168.1.5</q>. I see you have source IP 203.0.113.8…strange!</p>
</blockquote>
<p>Thanks to <a href="https://en.wikipedia.org/wiki/Network_address_translation">network address translation</a>, or NAT, we are able to make the SIP connection to Alice. Unfortunately, you will probably find that audio only works in one direction!</p>
<p>We’ve got two problems. First, we’ve asked Alice to send her audio to our <em>local</em> IP address, which won’t route over the Internet. Luckily, most devices are smart enough to use the source address of the incoming packet when these don’t match up. So Alice’s audio stream will probably end up at our router.</p>
<p>But second, our router will still block all of her audio traffic! When it receives a UDP packet from Alice’s audio stream, there’s no stateful NAT connection to match it back to an internal client, so it’s silently dropped. Sad!</p>
<h3 id="nat-solutions">NAT Solutions</h3>
<p>There are three ways to solve this problem.</p>
<ol type="1">
<li><p>Give each of your SIP devices its own public IP (probably not feasible).</p></li>
<li><p>Use a SIP <a href="https://www.voip-info.org/routers-sip-alg/">Application Layer Gateway</a>. This is a horrible feature offered by some routers. Basically, it deep-packet-inspects your SIP traffic, rewrites the headers, and creates port forwards on-the-fly to make sure the inbound audio stream makes its way to your device.</p>
<p>SIP ALGs are a total hack and notoriously buggy. In addition, when you decide to encrypt your SIP traffic using TLS, they quit working altogether.</p></li>
<li><p>Configure a fixed RTP port range on each of your SIP devices, then create static port forwarding rules on your router for each device. This is really the only decent option.</p>
<p>Note that since we’ll be using Asterisk, you also have the option of <q>proxying</q> all your audio streams through the Asterisk box–then you only have one port forward to set up (we’ll get to that later).</p></li>
</ol>
<h2 id="asterisk-what-is-it">Asterisk: What <em>is</em> it?</h2>
<p><a href="https://www.asterisk.org/">Asterisk</a> is an open-source implementation of a <a href="https://en.wikipedia.org/wiki/Business_telephone_system#Private_branch_exchange">private branch exchange</a>, or PBX. If you’re a VoIP novice like I was, this is probably meaningless to you.</p>
<p>A PBX is the central brain of any private telephone network. The general idea is this: You plug a bunch of dumb telephones into one side of the PBX, and you plug one or more uplinks to the <a href="https://en.wikipedia.org/wiki/Public_switched_telephone_network" title="Public Switched Telephone Network">PSTN</a> into the other side. The PBX lets the internal phones dial each other using private internal extensions, while multiplexing calls to and from the PSTN. It also handles advanced features like voicemail, call queues, hunt groups, and interactive menus for callers.</p>
<p>In the old days, the PBX would be a huge box down in the server room with a rat’s nest of of RJ-11 telephone cables sprawling out, connecting it to every single phone in the office. These monstrosities have since been replaced with software-based PBXes that talk SIP over standard Ethernet networks. Asterisk is the de-facto open source PBX.</p>
<h2 id="jargon-glossary">Jargon Glossary</h2>
<p>Before we get started, you need to know some lingo. Asterisk is an <em>old</em> project, with an unintuitive configuration. Hopefully this section will help you decipher some of the documentation and setup guides you find out there.</p>
<dl>
<dt>Extensions</dt>
<dd>Technically, in Asterisk parlance, any dialed number is an extension. In practice though, an <em>extension</em> typically refers to a <em>local</em> phone number (like 6001) with an associated SIP account. While extensions can be alphanumeric, virtually no one does this–most people use 3- or 4-digit numbers.
</dd>
<dt>Queues</dt>
<dd>Asterisk <a href="https://www.voip-info.org/asterisk-call-queues/">queues</a> are a mechanism for managing incoming callers. You can configure which local extensions should ring for each queue, and even play custom music while callers are waiting.
</dd>
<dt>SIP Trunk</dt>
<dd>A <q>SIP Trunk</q> is just a fancy term for your upstream telephone provider. For example, if you subscribe to a provider like <a href="https://voip.ms/en/invite/MzU5Nzc4">VOIP.ms</a>, they’ll give you a public phone number and a SIP server to connect to, along with a username and password. This is your <q>SIP Trunk.</q>
</dd>
<dt>DID</dt>
<dd>A DID, or <q>Direct Inward Dial,</q> is the technical term for a public phone number.
</dd>
<dt>Contexts</dt>
<dd>In Asterisk, every call is assigned a <em>context</em>. The context is simply a name of your choosing, and you specify it when you configure each extension or SIP trunk. For example, I give all my internal phones a context called <code>from-home</code>, and I give my SIP trunk a context called <code>from-pstn</code>.
</dd>
<dt>Dialplan</dt>
<dd>The Asterisk <a href="https://wiki.asterisk.org/wiki/display/AST/Dialplan">dialplan</a> is an arcane scripting language where you define what happens when you dial a number or an incoming call is received. The dialplan is the glue between the <em>extensions</em> and <em>contexts</em> described above. The syntax is fairly unintuitive, but don’t worry! We’ll walk through it in a later section.
</dd>
<dt>Codecs</dt>
<dd>A codec is a type of digital encoding used for the audio stream over the wire. Every VoIP device supports one or more codecs, and you need at least one common codec with the other party to make calls. When no shared codecs are supported, Asterisk has the ability to do man-in-the-middle transcoding. </dd>
<dt>BLF / Presence</dt>
<dd>The BLF, or busy lamp field, is a little LED on your VoIP phone that lights up when one of your contacts is using their line. In Asterisk, this functionality is enabled by something called a <a href="https://wiki.asterisk.org/wiki/display/AST/Configuring+res_pjsip+for+Presence+Subscriptions">presence subscription</a>.
</dd>
<dt>SIP / PJSIP</dt>
<dd>On some guides online, you will see references to the <code>chan_sip</code> and <code>chan_pjsip</code> modules. <code>chan_sip</code> is the legacy Asterisk SIP implementation. You should be using PJSIP for everything these days.
</dd>
</dl>
<h2 id="step-1-acquire-an-ip-phone">Step 1: Acquire an IP Phone</h2>
<p>First, you will need one or more VoIP phones. Any device that supports SIP calling should work fine with Asterisk, so this mostly comes down to personal preference.</p>
<p>As a beginner, you’ll probably want to select for ease of configuration. Most modern VoIP phones expose a friendly web GUI where you configure all your SIP accounts, ring settings, etc. I’d also recommend avoiding any devices that rely on proprietary setup tools.</p>
<p>Personally, I’ve had zero problems with Yealink devices. I recommend the <a href="https://www.yealink.com/en/product-detail/ip-phone-t54w">T54W</a> model for a desk phone, or the <a href="https://www.yealink.com/en/product-detail/dect-phone-w73p">W73P</a> if you prefer a cordless model. You can buy these new at the usual online retailers, but eBay often has used models for sale if you want to save some money.</p>
<p>If you don’t want to buy a physical device, you can also use a softphone app like <a href="https://f-droid.org/en/packages/org.linphone/">Linphone</a>. I use it on my Android phone running <a href="https://grapheneos.org/">GrapheneOS</a>, and it works well with the right settings. I’ll cover Linphone in a later section.</p>
<h2 id="step-2-subscribe-to-a-voip-provider">Step 2: Subscribe to a VoIP Provider</h2>
<p>Next, you need to subscribe to a VoIP service so you can make and receive calls over the PSTN. You’ll often see people call this a <q>SIP Trunk.</q></p>
<p>Basically, you pay a VoIP company a small monthly fee, usually $3-$5 per month for a single DID. In exchange, they give you a public telephone number, along with credentials for their SIP server. After configuring Asterisk to connect to that SIP server, you can make and receive calls via the PSTN with that number.</p>
<p>I can personally recommend two providers.</p>
<ol type="1">
<li><p><a href="https://voip.ms/en/invite/MzU5Nzc4">VOIP.ms</a> is an inexpensive provider with servers in the USA, Canada, and western Europe. You can get <q>unlimited</q> inbound calls with a single DID for about $5 a month, or less if you pay by the minute.</p>
<p>VOIP.ms also supports call encryption via TLS/SRTP, which is nice.</p></li>
<li><p><a href="https://jmp.chat/">JMP.chat</a> (USA/Canada only) is an XMPP-based service that lets you make and receive voice calls and SMS/MMS messages using your existing XMPP account. I especially like JMP because there’s already tons of high-quality native XMPP apps for both desktop and mobile devices. In addition, their entire stack is open source.</p>
<p>While JMP is primarily focused on XMPP calling, they also provide you with a SIP account that you can use with Asterisk.</p></li>
</ol>
<p>There are <em>tons</em> of other VoIP providers out there, so shop around.</p>
<h2 id="step-3-configure-asterisk">Step 3: Configure Asterisk</h2>
<p>Now you’re ready to set up Asterisk. These instructions are written for RHEL-based distributions, but should be applicable to other Unixen.</p>
<h3 id="installation">Installation</h3>
<p>First, install Asterisk:</p>
<div id="cb1"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span>dnf</span> install asterisk asterisk-pjsip asterisk-voicemail-plain</span></code></pre></div>
<p>You’ll also need the sound files. Some distributions include these with their Asterisk package (EPEL does not).</p>
<div id="cb2"><pre><code><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span>for</span> codec <span>in</span> g722 g729 gsm sln16 ulaw wav<span>;</span> <span>do</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span>curl</span> <span>-sL</span> <span>&#34;https://downloads.asterisk.org/pub/telephony/sounds/asterisk-core-sounds-en-</span><span>${codec}</span><span>-current.tar.gz&#34;</span> <span>\</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span>|</span> <span>tar</span> xvz <span>-C</span> /usr/share/asterisk/sounds</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span>done</span></span></code></pre></div>
<h3 id="network-configuration">Network Configuration</h3>
<p>Now we’re ready to edit some config files. If you’re behind a NAT (likely), you’ll need to start by telling Asterisk about your local network. Edit <code>/etc/asterisk/pjsip.conf</code> and add some transport templates.</p>
<div id="cb3"><pre><code><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span>; /etc/asterisk/pjsip.conf</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span>; This template contains default settings for all transports. </span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>[transport-defaults](!)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span>type</span> <span>=</span> transport</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>bind <span>=</span> <span>0</span>.<span>0</span>.<span>0.0</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span>; For communication to any addresses within local_nets, Asterisk will not apply</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span>; NAT-related workarounds.</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>local_net <span>=</span> <span>127</span>.<span>0</span>.<span>0.0</span>/<span>8</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>local_net <span>=</span> <span>10</span>.<span>0</span>.<span>0.0</span>/<span>8</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>local_net <span>=</span> <span>172</span>.<span>16</span>.<span>0.0</span>/<span>12</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>local_net <span>=</span> <span>192</span>.<span>168</span>.<span>0.0</span>/<span>16</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span>; If you have a public static IP for your Asterisk server, set it here.</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>external_media_address     <span>=</span> <span>203</span>.<span>0</span>.<span>113.8</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>external_signaling_address <span>=</span> <span>203</span>.<span>0</span>.<span>113.8</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span>; The following UDP and TCP transports will inherit from the defaults.</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>[transport-udp](transport-defaults)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>protocol <span>=</span> udp</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>[transport-tcp](transport-defaults)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>protocol <span>=</span> tcp</span></code></pre></div>
<p>Remember our discussion about NAT and RTP audio streams above? We also need to set up a static port range for incoming UDP audio traffic. Choose a suitable range for your Asterisk server in <code>rtp.conf</code>. Then, set up port forwarding on your router/firewall to forward all incoming UDP traffic within that range to the internal IP of your Asterisk server.</p>
<p><strong>If your Asterisk server is behind NAT and you forget to do this, you’ll experience one-way audio in your phone calls.</strong></p>
<div id="cb4"><pre><code><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span>; /etc/asterisk/rtp.conf</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>[general]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>rtpstart=<span>20000</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>rtpend=<span>20999</span></span></code></pre></div>
<h3 id="sip-trunks">SIP Trunks</h3>
<p>Next, we’ll configure our SIP trunk(s). I’ll be using <code>pjsip_wizard.conf</code>, since the PJSIP Wizard configuration style eliminates a ton of boilerplate. For this step, you’ll need a server hostname and port, along with the username and password provided by your upstream SIP provider.</p>
<div id="cb5"><pre><code><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span>; /etc/asterisk/pjsip_wizard.conf</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span>; This template contains default settings for all SIP trunks.</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>[trunk-defaults](!)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span>type</span> <span>=</span> wizard</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span>; Require SIP authentication.</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>sends_auth <span>=</span> yes</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span>; Require SIP registration.</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>sends_registrations <span>=</span> yes</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span>; Send media to the address and port on the incoming packet, regardless of what</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span>; the SIP headers say (NAT workaround).</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>endpoint/rtp_symmetric <span>=</span> yes</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span>; Rewrite the SIP contact to the address and port of the request (NAT workaround).</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>endpoint/rewrite_contact <span>=</span> yes</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span>; Send the Remote-Party-ID SIP header. Some providers need this.</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>endpoint/send_rpid <span>=</span> yes</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span>; Force the ulaw codec, which should work for everything in North America.</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>endpoint/allow <span>=</span> !all,ulaw</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span>; Call encryption is out of scope for this guide. </span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>endpoint/media_encryption <span>=</span> no</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span>; If registration fails, keep trying ~forever.</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>registration/max_retries <span>=</span> <span>4294967295</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span>; Don&#39;t assume an authentication failure is permanent.</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>registration/auth_rejection_permanent <span>=</span> no</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span>; Perform a connectivity check every 30 seconds.</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>aor/qualify_frequency <span>=</span> <span>30</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span>; Your SIP trunks go here. For this example, we&#39;ll assume you&#39;re using VOIP.ms.</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span>; You can pick whatever section name you like, as long as its unique.</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>[voipms](trunk-defaults)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a><span>; You almost certainly want to use TCP.</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>transport <span>=</span> transport-tcp</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a><span>; Hostname and port for your SIP provider.</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>remote_hosts <span>=</span> atlanta2.voip.ms:<span>5060</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a><span>; Choose a context name for incoming calls from this account. You&#39;ll use this</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a><span>; name in your dialplan.</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>endpoint/context <span>=</span> from-pstn</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span>; Your SIP provider will give you these credentials.</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>outbound_auth/username <span>=</span> <span>555555</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>outbound_auth/password <span>=</span> s3cret</span></code></pre></div>
<h3 id="local-sip-extensions">Local SIP Extensions</h3>
<p>In the same file, we’ll also configure our local extensions. You’ll need an extension for each VoIP handset or softphone within your network. I’ll be using a prefix of <code>6XXX</code> for local extensions, but feel free to use whatever convention you prefer.</p>
<p>The following example has three extensions: two dedicated VoIP handsets, and one Android softphone. Note that if you want to use a softphone outside of your local network, you’ll need to either open your Asterisk instance to the world (not recommended, unless you know what you’re doing) or set up some kind of VPN.</p>
<div id="cb6"><pre><code><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span>; /etc/asterisk/pjsip_wizard.conf</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span>; This template contains default settings for all local extensions.</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>[extension-defaults](!)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span>type</span> <span>=</span> wizard</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span>; Require clients to register.</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>accepts_registrations <span>=</span> yes</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span>; Require clients to authenticate.</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>accepts_auth <span>=</span> yes</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span>; When simultaneous logins from the same account exceed max_contacts, disconnect</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span>; the oldest session.</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>aor/remove_existing <span>=</span> yes</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span>; For internal phones, allow the higher quality g722 codec in addition to ulaw.</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>endpoint/allow <span>=</span> !all,g722,ulaw</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span>; Context name for BLF/presence subscriptions. This can be any string of your</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span>; choosing, but I&#39;m using &#34;subscribe&#34;. We&#39;ll use this in the dialplan later.</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>endpoint/subscribe_context <span>=</span> subscribe</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span>;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span>; Extension 6001 - VoIP phone</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span>;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>[<span>6001</span>](extension-defaults)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span>; Dialplan context name for calls originating from this account.</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>endpoint/context <span>=</span> from-home</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span>; Voicemail address (note: I&#39;m using the same voicemail address for all extensions)</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>endpoint/mailboxes <span>=</span> <span>6000</span>@default</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span>; Internal Caller ID string for this device.</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>endpoint/callerid <span>=</span> Living Room &lt;<span>6001</span>&gt;</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a><span>; Username for SIP account. By convention, this should be the extension number.</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>inbound_auth/username <span>=</span> <span>6001</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span>; Password for SIP account (you can choose whatever password you like).</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>inbound_auth/password <span>=</span> s3cret</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a><span>; Maximum number of simultaneous logins for this account.</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>aor/max_contacts <span>=</span> <span>1</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a><span>; Check connectivity every 30 seconds.</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>aor/qualify_frequency <span>=</span> <span>30</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a><span>; Set connectivity check timeout to 3 seconds.</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>aor/qualify_timeout <span>=</span> <span>3.0</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a><span>; IMPORTANT! This setting determines whether the audio stream will be proxied</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a><span>; through the Asterisk server.</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a><span>;</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a><span>; If this device is directly reachable by the internet (either by a publicly</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a><span>; routable IP, or static port mappings on your router), choose YES.</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a><span>;</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a><span>; Otherwise, if this device is hidden behind NAT, choose NO.</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>endpoint/direct_media <span>=</span> yes</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a><span>;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a><span>; Extension 6002 - VoIP phone</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a><span>;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a><span>; (Same settings as above, except for the extension number and password.)</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>[<span>6002</span>](extension-defaults)</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>endpoint/context      <span>=</span> from-home</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>endpoint/mailboxes    <span>=</span> <span>6000</span>@default</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>endpoint/callerid     <span>=</span> Kitchen &lt;<span>6002</span>&gt;</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>inbound_auth/username <span>=</span> <span>6002</span></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>inbound_auth/password <span>=</span> s3cret2</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>aor/max_contacts      <span>=</span> <span>1</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>aor/qualify_frequency <span>=</span> <span>30</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>aor/qualify_timeout   <span>=</span> <span>3.0</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>endpoint/direct_media <span>=</span> yes</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a><span>;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a><span>; Extension 6003 - Linphone app on Android device</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a><span>;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>[<span>6003</span>](extension-defaults)</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>endpoint/context      <span>=</span> from-home</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>endpoint/mailboxes    <span>=</span> <span>6000</span>@default</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>endpoint/callerid     <span>=</span> Smartphone &lt;<span>6003</span>&gt;</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>inbound_auth/username <span>=</span> <span>6003</span></span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>inbound_auth/password <span>=</span> s3cret3</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>aor/max_contacts      <span>=</span> <span>1</span></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>endpoint/direct_media <span>=</span> no</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a><span>; For mobile devices, connectivity checks should be disabled.</span></span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a><span>; Two reasons for this:</span></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a><span>;   1. Poor cellular signal often causes the connectivity check to time out,</span></span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a><span>;      even when nothing is actually wrong.</span></span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a><span>;   2. Frequent traffic on the TCP session causes constant wakeups and kills</span></span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a><span>;      battery life.</span></span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>aor/qualify_frequency <span>=</span> <span>0</span></span></code></pre></div>
<h3 id="voicemail">Voicemail</h3>
<p>Voicemail recordings are stored on the local filesystem of the Asterisk server. You can access them by dialing a special voicemail extension from a local phone (configured in your dialplan). In addition, if you have a local <a href="https://en.wikipedia.org/wiki/Message_transfer_agent" title="Mail Transfer Agent">MTA</a> running, Asterisk can dispatch an email to an address of your choice whenever new voicemails arrive.</p>
<p>In the previous section, we referenced a voicemail address called <code>6000@default</code> for our internal extensions. We’ll create the actual voicemail box in <code>voicemail.conf</code>.</p>
<div id="cb7"><pre><code><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span>; /etc/asterisk/voicemail.conf</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span>; This section contains global voicemail options.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>[general]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span>; Audio formats to store voicemail files.</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>format=wav49|gsm|wav</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span>; &#34;From:&#34; address used for sending voicemail emails.</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>serveremail=asterisk-noreply@example.com</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span>; Whether to attach the voicemail audio file to notification emails.</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>attach=yes</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span>; Maximum number of messages per mailbox.</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>maxmsg=<span>100</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span>; Maximum length of a voicemail message in seconds.</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>maxsecs=<span>300</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span>; Maximum length of a voicemail greeting in seconds.</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>maxgreet=<span>60</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span>; How many milliseconds to skip forward/back when rew/ff in message playback.</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>skipms=<span>3000</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span>; How many seconds of silence before we end the recording.</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>maxsilence=<span>10</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span>; Silence threshold (what we consider silence: the lower, the more sensitive).</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>silencethreshold=<span>128</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span>; Maximum number of failed login attempts.</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>maxlogins=<span>3</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span>; Email template for voicemail notifications.</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>emailsubject=New voicemail ${VM_MSGNUM} in mailbox ${VM_MAILBOX}</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>emailbody=Hi ${VM_NAME},\n\nYou have a new voicemail in mailbox ${VM_MAILBOX}.\n\nFrom: ${VM_CALLERID}\nDate: ${VM_DATE}\nDuration: ${VM_DUR}\nMessage Number: ${VM_MSGNUM}</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>emaildateformat=%A, %B %d, %Y at %r</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a><span>; Default timezone for mailboxes (defined in zonemessages section below).</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>tz=myzone</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a><span>; Locale for generating date/time strings.</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>locale=en_US.UTF<span>-8</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a><span>; Minimum voicemail password length.</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>minpassword=<span>4</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a><span>; Custom timezone definitions go in this section.</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>[zonemessages]</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>myzone=America/New_York|&#39;vm-received&#39; Q &#39;digits/at&#39; IMp</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a><span>;;;;;;;;;;;;;;;;;</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a><span>; Voicemail Boxes</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a><span>;;;;;;;;;;;;;;;;;</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a><span>; Each of the following sections describe a voicemail &#34;context,&#34; which is a</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a><span>; a collection of voicemail boxes. If you don&#39;t need multiple contexts, you</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a><span>; can specify &#34;default&#34;.</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a><span>;</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a><span>; The format is as follows:</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a><span>;   VOICEMAIL_NUMBER =&gt; INITIAL_PASSWORD,REAL_NAME,EMAIL_ADDRESS,,,</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a><span>;</span></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a><span>; The last three fields aren&#39;t relevant for simple configurations.</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>[default]</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a><span>6000</span> <span>=&gt;</span> <span>1234</span>,John Doe,johndoe@example.com,,,</span></code></pre></div>
<h3 id="queues">Queues</h3>
<p>When someone calls our phone number, we’d like all our phones to ring simultaneously (similar to a traditional landline phone). We can emulate this behavior in Asterisk using a <code>ringall</code> queue.</p>
<p>Queues are configured in <code>queues.conf</code>.</p>
<div id="cb8"><pre><code><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span>; /etc/asterisk/queues.conf</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span>; Global queue settings go in this section.</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>[general]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span>; Persist dynamic member lists in the astdb.</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>persistentmembers <span>=</span> yes</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span>; Some options for more intuitive queue behavior.</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>autofill                <span>=</span> yes</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>monitor-type            <span>=</span> MixMonitor</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>shared_lastcall         <span>=</span> yes</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>log_membername_as_agent <span>=</span> yes</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span>;;;;;;;;;;;;;;;;;;;</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span>; Queue Definitions</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span>;;;;;;;;;;;;;;;;;;;</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span>; The &#34;home-phones&#34; queue is for incoming calls to our home phone line.</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>[home-phones]</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span>; For each incoming call, ring all members of the queue.</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>strategy <span>=</span> ringall</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span>; Max number of seconds a caller waits in the queue.</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>timeout <span>=</span> <span>30</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span>; Don&#39;t announce estimated hold time, etc.</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>announce-frequency          <span>=</span> <span>0</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>announce-holdtime           <span>=</span> no</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>announce-position           <span>=</span> no</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>periodic-announce-frequency <span>=</span> <span>0</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span>; Allow ringing even when no queue members are present.</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>joinempty      <span>=</span> yes</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>leavewhenempty <span>=</span> no</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span>; Ring member phones even when they are on another call.</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>ringinuse <span>=</span> yes</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span>; Queue Members</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span>;</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a><span>; Each member is specified with the following format:</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span>;  member =&gt; INTERFACE,PENALTY,FRIENDLY_NAME,PRESENCE_INTERFACE</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span>;</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a><span>; The &#34;penalty&#34; value is not interesting for our use case.</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span>; With PJSIP, the BLF/Presence interface is identical to the standard interface name.</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span>member</span> <span>=&gt;</span> PJSIP/<span>6001</span>,<span>0</span>,Living Room,PJSIP/<span>6001</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a><span>member</span> <span>=&gt;</span> PJSIP/<span>6002</span>,<span>0</span>,Kitchen,PJSIP/<span>6002</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a><span>member</span> <span>=&gt;</span> PJSIP/<span>6003</span>,<span>0</span>,Smartphone,PJSIP/<span>6003</span></span></code></pre></div>
<h3 id="the-dialplan">The Dialplan</h3>
<p>At this point, we’ve configured our upstream SIP trunks, created SIP accounts for some local phone extensions, and even defined a queue for incoming calls. All that’s left is to glue all this together in a <a href="https://wiki.asterisk.org/wiki/display/AST/Dialplan">dialplan</a>!</p>
<p>The dialplan is configured in <code>extensions.conf</code>, and it’s definitely the least intuitive aspect of Asterisk. You’ll most likely find its syntax to be confusing at first glance.</p>
<p>The thing to remember is that in the dialplan, everything is an <em>application</em>. Hanging up is performed by the <code>Hangup()</code> application, and voicemail prompts are handled by the <code>Voicemail()</code> application. Dialing a phone number is handled by (you guessed it) the <code>Dial()</code> application. Each application can take one or more comma-separated arguments.</p>
<p>Now, for the syntax. Each dialplan context is marked by square brackets. Each line within the context is (confusingly) called an <em>extension</em>, and has the following format:</p>
<div id="cb9"><pre><code><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>[context-name]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> NAME,PRIORITY,APPLICATION()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> NAME,PRIORITY,APPLICATION()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span>; etc...</span></span></code></pre></div>
<p>The <em>name</em> is the number (or pattern) of the extension.</p>
<p>The <em>priority</em> defines the order in which the step should be executed.</p>
<p>Finally, the <em>application</em> performs some action on the call.</p>
<p>A simple context definition might look something like this:</p>
<div id="cb10"><pre><code><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>[from-home]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span>; ${EXTEN} is a macro which expands to the currently dialed number.</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> _6XXX,<span>1</span>,Dial(PJSIP/${EXTEN})</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> _6XXX,<span>2</span>,Hangup()</span></code></pre></div>
<p>This dialplan section allows internal phones to call each other. The <code>_6XXX</code> is an extension pattern. When a device in the <code>from-home</code> context dials a 4-digit extension beginning with <code>6</code>, Asterisk will ring the corresponding PJSIP account.</p>
<p>Because it gets tedious repeating the same extension name over and over, Asterisk provides some syntactic sugar. The exact same dialplan could also be written as the following:</p>
<div id="cb11"><pre><code><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>[from-home]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> _6XXX,<span>1</span>,Dial(PJSIP/${EXTEN})</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Hangup()</span></code></pre></div>
<p>Below, I’ve provided a complete Asterisk dialplan for our example VoIP network. It supports the following features:</p>
<ol type="1">
<li><p>Internal phones can dial each other via their 4-digit extension.</p></li>
<li><p>Internal phones can dial out to the PSTN via standard 10-digit numbers.</p></li>
<li><p>Internal phones can access the voicemail menu by dialing <code>*99</code>.</p></li>
<li><p>Internal phones can show BLF/line status for all other phones.</p></li>
<li><p>Incoming calls from the PSTN will ring all internal phones simultaneously. Callers will be sent to voicemail if no one answers within 25 seconds.</p></li>
<li><p>If your phones support the <q>auto answer</q> header, you can initiate a whole-house intercom by dialing <code>6000</code>.</p></li>
</ol>
<p>I’ll provide plenty of comments to help you understand the arcane syntax. Hopefully it will be enough to bootstrap your own dialplan!</p>
<div id="cb12"><pre><code><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span>; /etc/asterisk/extensions.conf</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span>; Remember, context names for each SIP account are specified in pjsip_wizard.conf.</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span>; First, some safeguards against abuse of the built-in contexts.</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>[public]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> _X.,<span>1</span>,Hangup(<span>3</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>[default]</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> _X.,<span>1</span>,Hangup(<span>3</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span>; Next, some global variables. You&#39;ll need to change some of these.</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>[globals]</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span>; Your local area code.</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>MY_AREA_CODE <span>=</span> <span>555</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span>; Your real name and public phone number. This will be used for outgoing calls</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span>; to the PSTN.</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>MY_CALLER_ID <span>=</span> John Doe &lt;+<span>5555555555</span>&gt;</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span>; Dial this number from a local phone to access the voicemail menu.</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>VOICEMAIL_NUMBER <span>=</span> *<span>99</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span>; Voicemail address (configured in voicemail.conf)</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>VOICEMAIL_BOX <span>=</span> <span>6000</span>@default</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span>; Ring for this many seconds before forwarding the caller to voicemail.</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>VOICEMAIL_RING_TIMEOUT <span>=</span> <span>25</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span>; Name of the &#39;ringall&#39; queue for local phones.</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>HOME_QUEUE <span>=</span> home-phones</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span>; Number to dial for local intercom.</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>INTERCOM   <span>=</span> <span>6000</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span>; Dial pattern for local extensions.</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>LOCAL_EXTS <span>=</span> _6XXX</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span>; Boilerplate to enable BLF/presence subscriptions. Note that the context name</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a><span>; corresponds to the &#34;endpoint/subscribe_context&#34; value in pjsip_wizard.conf.</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>[subscribe]</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> _XXXX,hint,PJSIP/${EXTEN}</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a><span>; This context handles incoming calls from our SIP trunk provider. Each call is</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a><span>; is placed into a ringall queue. If there is no answer, the caller is forwarded</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a><span>; to voicemail.</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>[from-pstn]</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> _X.,<span>1</span>,Queue(${HOME_QUEUE},nr,,,${VOICEMAIL_RING_TIMEOUT})</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Answer(<span>500</span>)</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Voicemail(${VOICEMAIL_BOX},su)</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Hangup()</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a><span>; This is a function (or &#34;gosub&#34; in Asterisk lingo) that sets the &#34;auto answer&#34;</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a><span>; SIP header on an outgoing call.</span></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>[gosub-intercom]</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> s,<span>1</span>,Set(PJSIP_HEADER(add,Alert-Info)=auto answer)</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Return()</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a><span>; This context handles incoming calls from local phones.</span></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>[from-home]</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a><span>; When the INTERCOM number is dialed, page all members of the &#34;home-phones&#34; queue</span></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a><span>; into a conference call.</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> ${INTERCOM},<span>1</span>,Set(CALLERID(all)=Intercom &lt;${EXTEN}<span>&gt;</span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Page(${STRREPLACE(QUEUE_MEMBER_LIST(${HOME_QUEUE}),<span>&#34;,&#34;</span>,<span>&#34;&amp;&#34;</span>)},db(gosub-intercom^s^<span>1</span>),<span>10</span>)</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Hangup()</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a><span>; For local-to-local calls, ring indefinitely.</span></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> ${LOCAL_EXTS},<span>1</span>,Dial(PJSIP/${EXTEN})</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Hangup()</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a><span>; When the voicemail number is dialed, dump the caller into the voicemail menu.</span></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> ${VOICEMAIL_NUMBER},<span>1</span>,Answer(<span>500</span>)</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,VoiceMailMain(${VOICEMAIL_BOX},s)</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Hangup()</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a><span>; The following extensions are used to dial out to the PSTN via our SIP trunk,</span></span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a><span>; using a personalized caller ID string.</span></span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a><span>;</span></span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a><span>; Recall that we named our SIP trunk &#34;voipms&#34; in pjsip_wizard.conf.</span></span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a><span>;</span></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a><span>; N matches any digit 2-9</span></span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a><span>; X matches any digit 1-9</span></span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a><span>; For numbers formatted as +1xxxxxxxxxx, dial as-is.</span></span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> _+1NXXNXXXXXX,<span>1</span>,Set(CALLERID(all)=${MY_CALLER_ID})</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Dial(PJSIP/${EXTEN}@voipms)</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Hangup()</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a><span>; For numbers like 1xxxxxxxxxx, add a leading &#34;+&#34;.</span></span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> _1NXXNXXXXXX,<span>1</span>,Set(CALLERID(all)=${MY_CALLER_ID})</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Dial(PJSIP/+${EXTEN}@voipms)</span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Hangup()</span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a><span>; For numbers without a country code, add a &#34;+1&#34;. </span></span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> _NXXNXXXXXX,<span>1</span>,Set(CALLERID(all)=${MY_CALLER_ID})</span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Dial(PJSIP/+<span>1</span>${EXTEN}@voipms)</span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Hangup()</span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a><span>; For 7-digit numbers, add the local area code.</span></span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> _NXXXXXX,<span>1</span>,Set(CALLERID(all)=${MY_CALLER_ID})</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Dial(PJSIP/+<span>1</span>${MY_AREA_CODE}${EXTEN}@voipms)</span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Hangup()</span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a><span>; For 3-digit numbers, like 311, 411, 911 (UNTESTED!!!), dial as-is.</span></span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a>exten <span>=&gt;</span> _N11,<span>1</span>,Set(CALLERID(all)=${MY_CALLER_ID})</span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Dial(PJSIP/${EXTEN}@voipms)</span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a> same <span>=&gt;</span> n,Hangup()</span></code></pre></div>
<h3 id="troubleshooting">Troubleshooting</h3>
<p>Once you’ve got all your configs in place, give Asterisk a kick:</p>
<div id="cb13"><pre><code><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span>systemctl</span> restart asterisk</span></code></pre></div>
<p>On RedHat-based distributions, you can check <code>/var/log/asterisk/messages</code> for errors. You can also check the systemd journal:</p>

<p>You can also get lots of real-time information from the Asterisk console. To try it out, run the following command as root:</p>

<p>If you’re experiencing connectivity issues with your voice calls, you can enable SIP debugging in the console using the following command:</p>

<h2 id="step-4-configure-your-ip-phones">Step 4: Configure your IP Phones</h2>
<p>The final step is to configure your VoIP phones to connect to your Asterisk server, and make a few test calls! The instructions here are for Yealink phones, but they should easily translate to other manufacturers.</p>
<h3 id="sip-account">SIP Account</h3>
<p>Navigate to the IP address of the VoIP phone in your web browser, and log in with the default username and password (usually <code>admin/admin</code>). From here, you should be able to add a SIP account. In the Yealink interface, this is found under <em>Account→Register</em>.</p>
<p>For the <q>Living Room</q> extension we created above, you would set the following:</p>
<ul>
<li><strong>Register Name:</strong> 6001</li>
<li><strong>Username:</strong> 6001</li>
<li><strong>Password</strong>: s3cret</li>
<li><strong>Server Host:</strong> <em>IP/hostname of your Asterisk server</em></li>
<li><strong>Server Port:</strong> 5060</li>
<li><strong>Transport:</strong> UDP</li>
</ul>
<h3 id="codecs">Codecs</h3>
<p>You should also make sure the appropriate codecs are enabled on the device. In the Yealink web interface, you’ll find them under <em>Account→Codec</em>. I recommend enabling these codecs in the following priority:</p>
<ol type="1">
<li><strong>G722</strong>, for high-quality local calls</li>
<li><strong>PCMU</strong> (<em>ulaw</em>), for dialing out to the PSTN</li>
</ol>
<p>Asterisk will automatically transcode G722 down to <em>ulaw</em> if the other side doesn’t support it. You can mess around with even higher quality codecs like Opus, but in my experience they are not well supported nor easy to transcode.</p>
<h3 id="rtp-port-range">RTP Port Range</h3>
<p>To reduce load on the Asterisk server, you may want your VoIP phone to send and receive audio streams directly to and from the other party. To do this, you’ll need to configure your router/firewall to forward all incoming RTP traffic for the device.</p>
<p>First, give the device a static IP on your local network. Then, configure your router to port-forward all UDP traffic on your chosen RTP port range to that IP.</p>
<p>In the Yealink web interface, you can configure a static RTP port range under <em>Network→Advanced→Local RTP Port</em>.</p>
<p>If you <em>don’t</em> do all this, then make sure <code>endpoint/direct_media</code> is set to <code>no</code> for the SIP account in <code>pjsip_wizard.conf</code>!</p>
<h3 id="voicemail-number">Voicemail Number</h3>
<p>You’ll also want to configure which number the phone should dial when you press the voicemail button. In the Yealink web interface, set <em>Account→Advanced→Voice Mail</em> to <code>*99</code> (or whatever you number you chose for <code>VOICEMAIL_NUMBER</code> above).</p>
<h3 id="busy-lamp-field-blf">Busy Lamp Field (BLF)</h3>
<p>You may want to have your phone’s LED light up when a given line is on a call. In the Yealink web interface, you can configure this under <em>Dsskey→Line Key</em>.</p>
<p>For each line you’re interested in, set <strong>Type</strong> to <em>BLF</em> and <strong>Value</strong> to the other party’s extension number.</p>
<h3 id="intercom">Intercom</h3>
<p>For the intercom functionality described in the dialplan above, make sure the phone is configured to allow auto-answer. In the Yealink web interface, you can configure this by setting <em>Features→Intercom→Intercom Allow</em> to <em>on</em>.</p>
<h2 id="voip-on-android-linphone">VoIP on Android: Linphone</h2>
<p>In the past, Android provided a built-in SIP client. Sadly, <a href="https://www.xda-developers.com/android-12-killing-native-sip-calling/">as of Android 12</a>, this has been removed.</p>
<p>After trying all of the SIP apps available in F-Droid, I’m only able to recommend <a href="https://f-droid.org/en/packages/org.linphone/">Linphone</a>. It works with bluetooth devices, has an intuitive interface, and reliably delivers calls.</p>
<p>To keep Android from killing the app, you’ll need to make sure battery optimizations are disabled. Go to <em>Settings→Apps→See All Apps→Linphone→App Battery Usage</em> and select <em>Unrestricted</em>.</p>
<p>When configuring the SIP account in Linphone, use the following settings:</p>
<ul>
<li><strong>Username:</strong> 6003 <em>(or your chosen mobile extension)</em></li>
<li><strong>Password:</strong> <em>your chosen SIP account password</em></li>
<li><strong>Domain:</strong> <em>IP/hostname of your Asterisk server</em></li>
<li><strong>Transport:</strong> TCP</li>
<li><strong>Expire:</strong> 3600</li>
<li><strong>Apply prefix for outgoing calls:</strong> <em>enabled</em></li>
</ul>
<p>You’ll definitely want to use the TCP transport for a mobile device. Smartphone radios are exceedingly efficient at keeping a long-running TCP connection open, and TCP will reliably deliver your SIP packets even with a poor cellular signal.</p>
<p>With <em>Expire</em> set to 3600, your phone will wake up every hour to re-establish the SIP connection. I’ve never had any connectivity issues with the TCP transport, but if you’re paranoid, you might want to set this to a lower value.</p>
<p>I’ve also found the following Linphone settings useful:</p>
<ul>
<li><strong>Settings→Audio→Echo cancellation:</strong> <em>disabled</em> (most phones have hardware-level echo cancellation)</li>
<li><strong>Settings→Audio→Adaptive rate control:</strong> <em>enabled</em></li>
<li><strong>Settings→Audio→Codec bitrate limit:</strong> 128 kbits/s</li>
<li><strong>Settings→Audio→Codecs:</strong> <em>enable PCMU and G722</em></li>
<li><strong>Settings→Call→Improve interactions with bluetooth devices:</strong> <em>enabled</em></li>
<li><strong>Settings→Call→Voice mail URI:</strong> *99</li>
<li><strong>Settings→Advanced→Start at boot time:</strong> <em>enabled</em></li>
</ul>
<p>You may be tempted to hide the persistent notification icon while Linphone is running. Don’t do it! Whenever I’ve tried to hide this icon, I get tons of missed calls, and Asterisk reports the device as offline for minutes at a time. As long I keep the icon visible in the notification area, I don’t have any issues.</p>
<h2 id="closing-thoughts">Closing Thoughts</h2>
<p>For the past few months, I’ve used this exact setup for my primary phone number, and I’ve been pleased with the results.</p>
<p>If you decide to self-host your own VoIP infrastructure, you’ll definitely want to configure some type of QoS on your router or firewall to prioritize voice traffic. Otherwise, you’ll experience lags and poor audio quality whenever your network is congested.</p>
<p>In addition, you may want to investigate encrypting your calls via STRP and SIP TLS. I don’t personally do this, because voice calls are totally in the clear as soon as you connect to the PSTN anyway.</p>
<p>If you’d like to check out the configs required for encrypting your calls, or if you just want to get some ideas for automating your Asterisk configuration, check out my Ansible role on <a href="https://github.com/sacredheartsc/selfhosted/tree/master/roles/asterisk">GitHub</a>.</p>



</div>
  </body>
</html>
