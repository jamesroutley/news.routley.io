<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://martincmartin.com/2024/06/14/how-i-found-a-55-year-old-bug-in-the-first-lunar-lander-game/">Original</a>
    <h1>I found a 55 year old bug in the first Lunar Lander game</h1>
    
    <div id="readability-page-1" class="page"><div>
						
<p>Just months after Neil Armstrong’s historic moonwalk, <a href="https://www.cs.brandeis.edu/~storer/">Jim Storer</a>, a Lexington High School student in Massachusetts, wrote the first <a href="https://www.cs.brandeis.edu/~storer/LunarLander/LunarLander.html">Lunar Landing</a> game. By 1973, it <a href="http://www.bitsavers.org/pdf/dec/_Books/101_BASIC_Computer_Games_Mar75.pdf">had become</a> “by far and away the single most popular computer game.” A simple text game, you pilot a moon lander, aiming for a gentle touch down on the moon. All motion is vertical and you decide every 10 simulated seconds how much fuel to burn.</p>



<p>I recently explored the optimal fuel burn schedule to land as gently as possible and with maximum remaining fuel. Surprisingly, the theoretical best strategy didn’t work. The game falsely thinks the lander doesn’t touch down on the surface when in fact it does. Digging in, I was amazed by the sophisticated physics and numerical computing in the game. Eventually I found a bug: a missing “divide by two” that had seemingly gone unnoticed for nearly 55 years.</p>



<h2>Landing with Maximum Fuel</h2>



<p>To use the least fuel while landing, you need to land in the shortest time possible. Initially you maximize your speed by keeping your engine off, then at the last possible second you burn full throttle, reducing your speed to zero just as you touch the surface. The Kerbal Space Program community calls this a “suicide burn”, since getting the timing right is hard and it leaves no room for error.</p>



<p>With some trial and error and a bit of (manual) binary search, you can find the schedule that just barely has you landing.  You burn nothing for 70 seconds, then 164.31426784 lbs/sec for the next 10 seconds, then the max 200 lbs/sec after that:</p>



<figure><img data-attachment-id="656" data-permalink="https://martincmartin.com/2024/06/14/how-i-found-a-55-year-old-bug-in-the-first-lunar-lander-game/lunarlanderoriginallands/" data-orig-file="https://martincmartin.com/wp-content/uploads/2024/06/lunarlanderoriginallands.png" data-orig-size="1120,694" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="LunarLanderOriginalLands" data-image-description="" data-image-caption="" data-medium-file="https://martincmartin.com/wp-content/uploads/2024/06/lunarlanderoriginallands.png?w=300" data-large-file="https://martincmartin.com/wp-content/uploads/2024/06/lunarlanderoriginallands.png?w=640" width="1120" height="694" src="https://martincmartin.com/wp-content/uploads/2024/06/lunarlanderoriginallands.png" alt=""/></figure>



<p>The game considers a perfect landing to be less than 1 MPH, but here we land at over 3.5 MPH and are told we “could be better.”  Yet burn even 0.00000001 more lbs/sec, and you miss the surface entirely, ascending at 114 MPH:</p>



<figure><img data-attachment-id="657" data-permalink="https://martincmartin.com/2024/06/14/how-i-found-a-55-year-old-bug-in-the-first-lunar-lander-game/screenshot-2024-06-13-at-1-22-51-pm/" data-orig-file="https://martincmartin.com/wp-content/uploads/2024/06/screenshot-2024-06-13-at-1.22.51e280afpm.png" data-orig-size="1112,586" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="Screenshot 2024-06-13 at 1.22.51 PM" data-image-description="" data-image-caption="" data-medium-file="https://martincmartin.com/wp-content/uploads/2024/06/screenshot-2024-06-13-at-1.22.51e280afpm.png?w=300" data-large-file="https://martincmartin.com/wp-content/uploads/2024/06/screenshot-2024-06-13-at-1.22.51e280afpm.png?w=640" width="1112" height="586" src="https://martincmartin.com/wp-content/uploads/2024/06/screenshot-2024-06-13-at-1.22.51e280afpm.png" alt=""/></figure>



<p>How did we go from a hard landing to not landing at all, without a soft landing in between?</p>



<h2>Physics Simulation: One Smart Kid</h2>



<p>I expected to see the simple Euler integration that’s common in video games even today.  That’s where you compute the forces at the start of each time step, then use <em>F=ma</em> to compute the acceleration, then assume the acceleration is constant over a time step of <img src="https://s0.wp.com/latex.php?latex=%5CDelta+t&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002" srcset="https://s0.wp.com/latex.php?latex=%5CDelta+t&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002 1x, https://s0.wp.com/latex.php?latex=%5CDelta+t&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002&amp;zoom=4.5 4x" alt="\Delta t"/> seconds:</p>


<p><img src="https://s0.wp.com/latex.php?latex=%5CDelta+v+%3D+a+%5CDelta+t&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002" srcset="https://s0.wp.com/latex.php?latex=%5CDelta+v+%3D+a+%5CDelta+t&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002 1x, https://s0.wp.com/latex.php?latex=%5CDelta+v+%3D+a+%5CDelta+t&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002&amp;zoom=4.5 4x" alt="\Delta v = a \Delta t"/></p>



<p>Because the mass is changing over the timestep, the acceleration will change too, so assuming it’s constant is only approximate.  But surprisingly, Jim used the exact solution, the <a href="https://en.wikipedia.org/wiki/Tsiolkovsky_rocket_equation">Tsiolkovsky rocket equation</a>, with a Taylor series expansion for the logarithm. He also used some algebra to simplify it and reduce the amount of round off error.  Very impressive for a high school senior in 1969.  When I asked him about it:</p>



<blockquote>
<p>“I was skilled at calculus at the time and familiar with concepts like a Taylor series, but also my recollection is that my father, who was a physicist, helped me in the derivation of the equations.” – Jim Storer, personal communication</p>
</blockquote>



<p>The rocket equation is what gives rise to the suicide burn being optimal, and the five terms he uses of the Taylor series, where the argument is at most 0.1212, makes it accurate to over six decimal places. So that’s not the problem we’re looking for.</p>



<h2>Assumptions Go Out The Window When We Hit The Ground</h2>



<p>The rocket equation works well until you hit the ground. In general, collisions between solid objects is a really hard part of dynamics engines, and what separates the great ones from the good ones, as I discovered when contributing to <a href="https://www.ode.org/">Open Dynamics Engine</a> as a postdoc at MIT.</p>



<p>And this is where the Lunar Landing Game faces its biggest challenge. Imagine the lander descending at the start of a 10-second turn but ascending by the end. Simply verifying that it’s above the surface at both points isn’t enough. It might have dipped below the surface somewhere in between. When this happens, the program has to rewind and examine an earlier moment.</p>



<p>An obvious place is to look at the lowest point of the trajectory, where the velocity is zero. For the rocket equation, it turns out, there’s no closed form expression for that lowest point that involves only basic mathematical functions.<sup data-fn="636f2ae6-d817-49bc-a1ca-6c07b4cee9c6"><a href="#636f2ae6-d817-49bc-a1ca-6c07b4cee9c6" id="636f2ae6-d817-49bc-a1ca-6c07b4cee9c6-link">1</a></sup> So instead, we can use the physicists favourite technique, and take only the first few terms of the Taylor series. If you use only the first two terms of the logarithm, the problem simplifies to a quadratic equation and you can use the good old <a href="https://en.wikipedia.org/wiki/Quadratic_formula">quadratic formula</a> from high school. And the approximation should be pretty good over the space of a 10 second turn, accurate to within 0.1% or so.</p>



<p>But that’s not what Jim did. His formula has a square root in the denominator, not the numerator. It also had an error 30 times bigger.</p>



<h2>How To Know When You’ve Hit Rock Bottom</h2>



<figure><img data-attachment-id="626" data-permalink="https://martincmartin.com/?attachment_id=626" data-orig-file="https://martincmartin.com/wp-content/uploads/2024/06/screenshot-2024-06-07-at-10.12.51e280afam.png" data-orig-size="1016,986" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="screenshot-2024-06-07-at-10.12.51e280afam" data-image-description="" data-image-caption="" data-medium-file="https://martincmartin.com/wp-content/uploads/2024/06/screenshot-2024-06-07-at-10.12.51e280afam.png?w=300" data-large-file="https://martincmartin.com/wp-content/uploads/2024/06/screenshot-2024-06-07-at-10.12.51e280afam.png?w=640" width="1016" height="986" src="https://martincmartin.com/wp-content/uploads/2024/06/screenshot-2024-06-07-at-10.12.51e280afam.png" alt=""/></figure>



<p>What could he possibly be doing? I stared at this for a long time, wracking my brain for any other approach to approximate the bottom of the trajectory that would still only use addition, subtraction, multiplication, division and square root. Taking only the first term of the logarithm would give an approximation worse than the quadratic, but wouldn’t involve a square root. Taking a third term and we need to solve a cubic, which in general would need a lot more code and in our case it doesn’t seem to be of any special form that has a simple solution<sup data-fn="809751a5-4c07-42d1-9eb3-892e999bd451"><a href="#809751a5-4c07-42d1-9eb3-892e999bd451" id="809751a5-4c07-42d1-9eb3-892e999bd451-link">2</a></sup>. There are many approximations to <img src="https://s0.wp.com/latex.php?latex=%5Clog%28x%29&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002" srcset="https://s0.wp.com/latex.php?latex=%5Clog%28x%29&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002 1x, https://s0.wp.com/latex.php?latex=%5Clog%28x%29&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002&amp;zoom=4.5 4x" alt="\log(x)"/>, but the non-Taylor ones involve advanced functions like <img src="https://s0.wp.com/latex.php?latex=x%5Ex&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002" srcset="https://s0.wp.com/latex.php?latex=x%5Ex&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002 1x, https://s0.wp.com/latex.php?latex=x%5Ex&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002&amp;zoom=4.5 4x" alt="x^x"/> that are hard to invert.</p>



<p>Until I looked a little more closely at his square root. It’s of the form:</p>


<p><img src="https://s0.wp.com/latex.php?latex=%5Csqrt%7B+%5Cleft%28+%5Cdfrac%7Bb%7D%7B2%7D+%5Cright%29+%5E2+-+a+c%7D+&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002" srcset="https://s0.wp.com/latex.php?latex=%5Csqrt%7B+%5Cleft%28+%5Cdfrac%7Bb%7D%7B2%7D+%5Cright%29+%5E2+-+a+c%7D+&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002 1x, https://s0.wp.com/latex.php?latex=%5Csqrt%7B+%5Cleft%28+%5Cdfrac%7Bb%7D%7B2%7D+%5Cright%29+%5E2+-+a+c%7D+&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002&amp;zoom=4.5 4x" alt="\sqrt{ \left( \dfrac{b}{2} \right) ^2 - a c} "/></p>



<p>Which looks a awful lot like the quadratic formula where we’ve divided by 4 inside the square root. It <em>has to</em> be related. But why is it in the denominator? Did he find a quadratic in <img src="https://s0.wp.com/latex.php?latex=1%2Ft&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002" srcset="https://s0.wp.com/latex.php?latex=1%2Ft&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002 1x, https://s0.wp.com/latex.php?latex=1%2Ft&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002&amp;zoom=4.5 4x" alt="1/t"/> ? No, because <em>t</em> can be very close to zero, so his formula would need to be approximated over a wide range of very large values, and a quadratic isn’t good for that. Did he make a quadratic approximation to log, <em>then</em> substitute <img src="https://s0.wp.com/latex.php?latex=T%3D1%2Ft&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002" srcset="https://s0.wp.com/latex.php?latex=T%3D1%2Ft&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002 1x, https://s0.wp.com/latex.php?latex=T%3D1%2Ft&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002&amp;zoom=4.5 4x" alt="T=1/t"/>, solve for <em>T</em>, then substitute back? Playing around with that, I re-discovered an <a href="https://en.wikipedia.org/wiki/Quadratic_formula#Square_root_in_the_denominator">alternate form</a> of the quadratic formula with the square root on the bottom! And indeed, this matches the formula in Jim’s code.</p>



<p>I don’t know why 18 year old Jim was using the alternate form. Perhaps he re-derived the quadratic formula rather than looking it up, and ended up deriving that form. Perhaps he was worried about <a href="https://en.wikipedia.org/wiki/Catastrophic_cancellation">catastrophic cancellation</a> and wanted a form where he’d add positive numbers, rather than subtract them.<sup data-fn="2e932716-93ea-4b84-b03e-a6fb66e4764b"><a href="#2e932716-93ea-4b84-b03e-a6fb66e4764b" id="2e932716-93ea-4b84-b03e-a6fb66e4764b-link">3</a></sup></p>



<h2>Let’s Double Check The Derivation</h2>



<p>But if his formula is equivalent, then why is the approximation error 30 times higher? Deriving the formula ourselves, we get:</p>


<p><img src="https://s0.wp.com/latex.php?latex=%5Ctext%7BLet+%7D+W+%5Cequiv+%5Cdfrac%7B1+-+%5Cfrac%7BMG%7D%7BZK%7D%7D%7B2%7D&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002" srcset="https://s0.wp.com/latex.php?latex=%5Ctext%7BLet+%7D+W+%5Cequiv+%5Cdfrac%7B1+-+%5Cfrac%7BMG%7D%7BZK%7D%7D%7B2%7D&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002 1x, https://s0.wp.com/latex.php?latex=%5Ctext%7BLet+%7D+W+%5Cequiv+%5Cdfrac%7B1+-+%5Cfrac%7BMG%7D%7BZK%7D%7D%7B2%7D&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002&amp;zoom=4.5 4x" alt="\text{Let } W \equiv \dfrac{1 - \frac{MG}{ZK}}{2}"/></p>
<p><img src="https://s0.wp.com/latex.php?latex=t%3D%5Cdfrac%7BMV%7D%7BZK+%5Cleft%28+W%2B%5Csqrt%7BW%5E2+%2B+%5Cdfrac%7BV%7D%7B2Z%7D%7D+%5Cright%29+%7D&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002" srcset="https://s0.wp.com/latex.php?latex=t%3D%5Cdfrac%7BMV%7D%7BZK+%5Cleft%28+W%2B%5Csqrt%7BW%5E2+%2B+%5Cdfrac%7BV%7D%7B2Z%7D%7D+%5Cright%29+%7D&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002 1x, https://s0.wp.com/latex.php?latex=t%3D%5Cdfrac%7BMV%7D%7BZK+%5Cleft%28+W%2B%5Csqrt%7BW%5E2+%2B+%5Cdfrac%7BV%7D%7B2Z%7D%7D+%5Cright%29+%7D&amp;bg=ffffff&amp;fg=333333&amp;s=0&amp;c=20201002&amp;zoom=4.5 4x" alt="t=\dfrac{MV}{ZK \left( W+\sqrt{W^2 + \dfrac{V}{2Z}} \right) }"/></p>



<p>Which is identical to Jim’s code, except … he’s missing the 2 in the denominator inside the square root! It was probably a simple error, either when deriving the formula or typing it into the computer.  After all, the computer algebra system <a href="https://en.wikipedia.org/wiki/Macsyma">MACSYMA</a> had only started a year before, and wouldn’t be available at a high school, so he would have had to do everything using pencil and paper.</p>



<p>With this bug, he consistently <em>under</em>estimates the time to the lowest point. He compensates for this two ways: adding 0.05 sec, and then re-estimating from his new, closer location. And this explains why it misses the time of landing: the first estimate is while the lander is above the surface and still descending, then the second one is after reaching the bottom and ascending again, which takes less than 0.05 sec.</p>



<p>If we add the missing factor of two and remove the 0.05, what happens? Now the best we can do with a suicide burn is:</p>



<figure><img data-attachment-id="659" data-permalink="https://martincmartin.com/2024/06/14/how-i-found-a-55-year-old-bug-in-the-first-lunar-lander-game/screenshot-2024-06-13-at-1-24-32-pm/" data-orig-file="https://martincmartin.com/wp-content/uploads/2024/06/screenshot-2024-06-13-at-1.24.32e280afpm.png" data-orig-size="1112,686" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="Screenshot 2024-06-13 at 1.24.32 PM" data-image-description="" data-image-caption="" data-medium-file="https://martincmartin.com/wp-content/uploads/2024/06/screenshot-2024-06-13-at-1.24.32e280afpm.png?w=300" data-large-file="https://martincmartin.com/wp-content/uploads/2024/06/screenshot-2024-06-13-at-1.24.32e280afpm.png?w=640" loading="lazy" width="1112" height="686" src="https://martincmartin.com/wp-content/uploads/2024/06/screenshot-2024-06-13-at-1.24.32e280afpm.png" alt=""/></figure>



<p>Our velocity is down to 1.66 MPH, almost three quarters of the way to the perfect landing at 1 MPH.  It’s not perfect because w’re still only using the first two terms of the Taylor series.  Also, once you’ve decided your lowest point is under the surface, you then need to find the time where you first hit the surface, which involves a similar approximation.  Another iteration would help, although with the bug fixed we <em>over</em>estimate the time, so we’d need to go back in time, which might mean we have to pick the other solution to the quadratic. You could simplify that by using only a single term from the Taylor series, and is what’s done in <a href="https://en.wikipedia.org/wiki/Newton%27s_method">Newton’s method</a>. You could then stop when the magnitude of the velocity is below some threshold, and use the altitude there to decide whether or not you landed.  But this is all more work, and the game was fun to play as it is, so why complicate the code?</p>



<p>It’s also possible to land gently, you just need to end your 14th turn with a low altitude and velocity, and then use low thrust in your 15th turn, landing somewhere after 150 seconds.  It’s just the theoretical full-thrust-on-landing suicide burn, that takes around 148 seconds, that eludes us.</p>



<h2>CAPCOM We’re <a href="https://youtu.be/BHIo6qwJarI?t=45s">Go</a> For Powered Descent</h2>



<p>Overall, this is very impressive work for an 18 year hold high school student in 1969 on a PDP-8.  This was long before Computer Science was taught in high school.  The numerical computing aspects, such as iteratively improving the estimate using Newton’s method or worrying about catastrophic cancellation, weren’t well known back then.  I didn’t learn them until I was studying for a Ph.D. in robotics.</p>



<p>It is also surprising that, as far as I can tell, this bug has been there for almost 55 years and nobody has noticed it before.  That’s probably because, even with the bug, it was a fun game, both difficult and possible to land gently.  The quest to not just win, but find the optimal strategy, can certainly lead to trying to understand small discrepancies.  I suspect everybody else was just happy to play the game and have fun.</p>


											</div></div>
  </body>
</html>
