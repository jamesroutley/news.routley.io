<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/konigsoftware/konig-kontext">Original</a>
    <h1>gRPC request context which caries values across microservice boundaries</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto"><a href="https://github.com/konigsoftware/konig-kontext/actions/workflows/build.yaml?query=branch%3Amain"><img src="https://github.com/konigsoftware/konig-kontext/actions/workflows/build.yaml/badge.svg?query=branch=main" alt="Gradle Build Status"/></a></p>
<p dir="auto"><a href="https://central.sonatype.com/search?q=com.konigsoftware%3Akonig-kontext&amp;smo=true" rel="nofollow"><img src="https://camo.githubusercontent.com/c4b3349eac442c3d9d0ffca95f1d978989918a290d240b8c1be957368fc79994/68747470733a2f2f696d672e736869656c64732e696f2f6d6176656e2d63656e7472616c2f762f636f6d2e6b6f6e6967736f6674776172652f6b6f6e69672d6b6f6e746578742e7376673f6c6162656c3d6b6f6e69672d6b6f6e74657874" alt="konig-kontext" data-canonical-src="https://img.shields.io/maven-central/v/com.konigsoftware/konig-kontext.svg?label=konig-kontext"/></a></p>
<p dir="auto">A request context propagation framework which can carry values across gRPC microservice boundaries. Example context values might include:</p>
<ul dir="auto">
<li>Security principals, or user credentials and identifiers. Add a user credential to the KonigKontext early in a request lifetime, and later access the credential from a different microservice.</li>
<li>Distributed tracing information. Add a request trace id to the KonigKontext upon receiving a request and later access that id in any downstream microservice.</li>
</ul>
<p dir="auto">Konig Kontext is built to support any type of context value, so it can be extended to fit <em>your</em> specific use cases as well.</p>
<h2 tabindex="-1" id="user-content-installation" dir="auto"><a href="#installation">Installation<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<h3 tabindex="-1" id="user-content-gradle" dir="auto"><a href="#gradle">Gradle:<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<details open="">
<summary>Kotlin</summary>
</details>
<details>
<summary>Groovy</summary>
</details>
<h3 tabindex="-1" id="user-content-maven" dir="auto"><a href="#maven">Maven:<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">Add the following to your <code>pom.xml</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="&lt;dependency&gt;
    &lt;groupId&gt;com.konigsoftware&lt;/groupId&gt;
    &lt;artifactId&gt;konig-kontext&lt;/artifactId&gt;
    &lt;version&gt;1.1.0&lt;/version&gt;
&lt;/dependency&gt;"><pre>&lt;<span>dependency</span>&gt;
    &lt;<span>groupId</span>&gt;com.konigsoftware&lt;/<span>groupId</span>&gt;
    &lt;<span>artifactId</span>&gt;konig-kontext&lt;/<span>artifactId</span>&gt;
    &lt;<span>version</span>&gt;1.1.0&lt;/<span>version</span>&gt;
&lt;/<span>dependency</span>&gt;</pre></div>
<h2 tabindex="-1" id="user-content-setup" dir="auto"><a href="#setup">Setup<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<h3 tabindex="-1" id="user-content-1-create-konigkontextkey" dir="auto"><a href="#1-create-konigkontextkey">1. Create KonigKontextKey<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">KonigKontext values are indexed by a <code>KonigKontextKey</code>. To define a key, create an object that extends <code>KonigKontextKey</code> and implement the interface. This object should live in a shared package
accessible to all of your microservices.</p>
<p dir="auto">The following examples define a key with a value of type <code>String</code> in both Kotlin and Java, although you can use <em>any</em> type you like instead:</p>
<details open="">
<summary>Kotlin</summary>
<div dir="auto" data-snippet-clipboard-copy-content="object MyContextKey : KonigKontextKey&lt;String&gt;() {
    override val defaultValue: String = &#34;&#34;

    override fun valueFromBinary(binaryValue: ByteArray): String = String(binaryValue)

    override fun valueToBinary(value: String): ByteArray = value.toByteArray()
}"><pre><span>object</span> <span>MyContextKey</span> <span>:</span> <span>KonigKontextKey</span>&lt;<span>String</span>&gt;() {
    <span>override</span> <span>val</span> defaultValue<span>:</span> <span>String</span> <span>=</span> <span><span>&#34;</span><span>&#34;</span></span>

    <span>override</span> <span>fun</span> <span>valueFromBinary</span>(<span>binaryValue</span><span>:</span> <span>ByteArray</span>): <span>String</span> <span>=</span> <span>String</span>(binaryValue)

    <span>override</span> <span>fun</span> <span>valueToBinary</span>(<span>value</span><span>:</span> <span>String</span>): <span>ByteArray</span> <span>=</span> value.toByteArray()
}</pre></div>
</details>
<details>
<summary>Java</summary>
<div dir="auto" data-snippet-clipboard-copy-content="public class GlobalContextKeys {
    public static final KonigKontextKey&lt;String&gt; MY_CONTEXT_KEY = new KonigKontextKey&lt;&gt;() {
        @Override
        public String getDefaultValue() {
            return &#34;&#34;;
        }

        @Override
        public byte[] valueToBinary(String s) {
            return s.getBytes(StandardCharsets.UTF_8);
        }

        @Override
        public String valueFromBinary(byte[] bytes) {
            return new String(bytes, StandardCharsets.UTF_8);
        }
    };
}"><pre><span>public</span> <span>class</span> <span>GlobalContextKeys</span> {
    <span>public</span> <span>static</span> <span>final</span> <span>KonigKontextKey</span>&lt;<span>String</span>&gt; <span>MY_CONTEXT_KEY</span> = <span>new</span> <span>KonigKontextKey</span>&lt;&gt;() {
        <span>@</span><span>Override</span>
        <span>public</span> <span>String</span> <span>getDefaultValue</span>() {
            <span>return</span> <span>&#34;&#34;</span>;
        }

        <span>@</span><span>Override</span>
        <span>public</span> <span>byte</span>[] <span>valueToBinary</span>(<span>String</span> <span>s</span>) {
            <span>return</span> <span>s</span>.<span>getBytes</span>(<span>StandardCharsets</span>.<span>UTF_8</span>);
        }

        <span>@</span><span>Override</span>
        <span>public</span> <span>String</span> <span>valueFromBinary</span>(<span>byte</span>[] <span>bytes</span>) {
            <span>return</span> <span>new</span> <span>String</span>(<span>bytes</span>, <span>StandardCharsets</span>.<span>UTF_8</span>);
        }
    };
}</pre></div>
</details>
<h4 tabindex="-1" id="user-content-protobuf-message-based-type" dir="auto"><a href="#protobuf-message-based-type">Protobuf Message Based Type:<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h4>
<p dir="auto">Using a protobuf message to type your Konig Kontext value is a good practice, as it allows for type changes in a backwards-compatible way.
There&#39;s a helper class, <code>KonigKontextProtobufKey</code>, that makes this easier. The following examples define a key with a
value of type <code>MyContextMessage</code>, where <code>MyContextMessage</code> extends <code>com.google.protobuf.Message</code>:</p>
<details open="">
<summary>Kotlin</summary>
<div dir="auto" data-snippet-clipboard-copy-content="object MyContextKey : KonigKontextProtobufKey&lt;MyContextMessage&gt;(MyContextMessage::class)"><pre><span>object</span> <span>MyContextKey</span> <span>:</span> <span>KonigKontextProtobufKey</span>&lt;<span>MyContextMessage</span>&gt;(<span>MyContextMessage</span>::<span>class</span>)</pre></div>
</details>
<details>
<summary>Java</summary>
<div dir="auto" data-snippet-clipboard-copy-content="public class GlobalContextKeys {
    public static final KonigKontextProtobufKey&lt;MyContextMessage&gt; MY_CONTEXT_KEY = KonigKontextProtobufKey.fromJavaClass(MyContextMessage.class);
};"><pre><span>public</span> <span>class</span> <span>GlobalContextKeys</span> {
    <span>public</span> <span>static</span> <span>final</span> <span>KonigKontextProtobufKey</span>&lt;<span>MyContextMessage</span>&gt; <span>MY_CONTEXT_KEY</span> = <span>KonigKontextProtobufKey</span>.<span>fromJavaClass</span>(<span>MyContextMessage</span>.<span>class</span>);
};</pre></div>
</details>
<h3 tabindex="-1" id="user-content-2-client-side-setup" dir="auto"><a href="#2-client-side-setup">2. Client side setup:<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">Include the <code>KonigKontextClientInterceptor</code> in all gRPC clients where you want to propagate the current <code>KonigKontext</code>.
Provide your previously defined <code>KonigKontextKey</code> to the constructor:</p>
<details open="">
<summary>Kotlin</summary>
<div dir="auto" data-snippet-clipboard-copy-content="val myServiceClient = MyServiceCoroutineStub(myManagedChannel)
    .withInterceptors(KonigKontextClientInterceptor(MyContextKey))

// Or for a slightly more succinct way you can optionally use the Kotlin idiomatic helper function instead:
val myServiceClient = MyServiceCoroutineStub(myManagedChannel)
    .withKonigKontextInterceptor(MyContextKey)"><pre><span>val</span> myServiceClient <span>=</span> <span>MyServiceCoroutineStub</span>(myManagedChannel)
    .withInterceptors(<span>KonigKontextClientInterceptor</span>(<span>MyContextKey</span>))

<span><span>//</span> Or for a slightly more succinct way you can optionally use the Kotlin idiomatic helper function instead:</span>
<span>val</span> myServiceClient <span>=</span> <span>MyServiceCoroutineStub</span>(myManagedChannel)
    .withKonigKontextInterceptor(<span>MyContextKey</span>)</pre></div>
</details>
<details>
<summary>Java</summary>
<div dir="auto" data-snippet-clipboard-copy-content="MyServiceBlockingStub myServiceClient = MyServiceGrpc
        .newBlockingStub(ManagedChannelBuilder.forTarget(&#34;port here&#34;).usePlaintext().build())
        .withInterceptors(new KonigKontextClientInterceptor&lt;&gt;(GlobalContextKeys.MY_CONTEXT_KEY));"><pre><span>MyServiceBlockingStub</span> <span>myServiceClient</span> = <span>MyServiceGrpc</span>
        .<span>newBlockingStub</span>(<span>ManagedChannelBuilder</span>.<span>forTarget</span>(<span>&#34;port here&#34;</span>).<span>usePlaintext</span>().<span>build</span>())
        .<span>withInterceptors</span>(<span>new</span> <span>KonigKontextClientInterceptor</span>&lt;&gt;(<span>GlobalContextKeys</span>.<span>MY_CONTEXT_KEY</span>));</pre></div>
</details>
<h3 tabindex="-1" id="user-content-3-server-side-setup" dir="auto"><a href="#3-server-side-setup">3. Server side setup:<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">Include the <code>KonigKontextServerInterceptor</code> in all gRPC servers that require access to the <code>KonigKontext</code>. Provide your
previously defined <code>KonigKontextKey</code> to the constructor.</p>
<details open="">
<summary>Kotlin</summary>
<div dir="auto" data-snippet-clipboard-copy-content="val myServer = ServerBuilder
    .forPort(&lt;port here&gt;)
    .addService(MyService())
    .intercept(KonigKontextServerInterceptor(MyContextKey))
    .build()

// Or for a slightly more succinct way you can optionally use the Kotlin idiomatic helper function instead:
val myServer = ServerBuilder
    .forPort(&lt;port here&gt;)
    .addService(MyService())
    .withKonigKontextInterceptor(MyContextKey)
    .build() "><pre><span>val</span> myServer <span>=</span> <span>ServerBuilder</span>
    .forPort(<span>&lt;</span>port here<span>&gt;</span>)
    .addService(<span>MyService</span>())
    .intercept(<span>KonigKontextServerInterceptor</span>(<span>MyContextKey</span>))
    .build()

<span><span>//</span> Or for a slightly more succinct way you can optionally use the Kotlin idiomatic helper function instead:</span>
<span>val</span> myServer <span>=</span> <span>ServerBuilder</span>
    .forPort(<span>&lt;</span>port here<span>&gt;</span>)
    .addService(<span>MyService</span>())
    .withKonigKontextInterceptor(<span>MyContextKey</span>)
    .build() </pre></div>
</details>
<details>
<summary>Java</summary>
<div dir="auto" data-snippet-clipboard-copy-content="Server myServer = ServerBuilder
        .forPort(&lt;port here&gt;)
        .addService(new MyService())
        .intercept(new KonigKontextServerInterceptor&lt;&gt;(GlobalContextKeys.MY_CONTEXT_KEY))
        .build();"><pre><span>Server</span> <span>myServer</span> = <span>ServerBuilder</span>
        .<span>forPort</span>(&lt;<span>port</span> <span>here</span>&gt;)
        .<span>addService</span>(<span>new</span> <span>MyService</span>())
        .<span>intercept</span>(<span>new</span> <span>KonigKontextServerInterceptor</span>&lt;&gt;(<span>GlobalContextKeys</span>.<span>MY_CONTEXT_KEY</span>))
        .<span>build</span>();</pre></div>
</details>
<h2 tabindex="-1" id="user-content-usage" dir="auto"><a href="#usage">Usage<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">To set and get <code>KonigKontext</code> values, follow these steps:</p>
<h3 tabindex="-1" id="user-content-setting-value" dir="auto"><a href="#setting-value">Setting value:<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<details open="">
<summary>Kotlin</summary>
<div dir="auto" data-snippet-clipboard-copy-content="withKonigKontext(KonigKontext.withValue(MyContextKey, /* ADD VALUE HERE */)) {
    // Remaining code path that will have access to the updated KonigKontext

    // Any client stub RPC called from within this lambda will automatically give that RPC
    // access to the current KonigKontext. 
}"><pre>withKonigKontext(<span>KonigKontext</span>.withValue(<span>MyContextKey</span>, <span><span>/*</span> ADD VALUE HERE <span>*/</span></span>)) {
    <span><span>//</span> Remaining code path that will have access to the updated KonigKontext</span>

    <span><span>//</span> Any client stub RPC called from within this lambda will automatically give that RPC</span>
    <span><span>//</span> access to the current KonigKontext. </span>
}</pre></div>
</details>
<details>
<summary>Java</summary>
<div dir="auto" data-snippet-clipboard-copy-content="KonigKontext.withValue(GlobalContextKeys.MY_CONTEXT_KEY, /* set value here */).run(() -&gt; {
    // Remaining code path that will have access to the updated KonigKontext
    
    // Any client stub RPC called from within this lambda will automatically give that RPC
    // access to the current KonigKontext.    
})"><pre><span>KonigKontext</span>.<span>withValue</span>(<span>GlobalContextKeys</span>.<span>MY_CONTEXT_KEY</span>, <span>/* set value here */</span>).<span>run</span>(() -&gt; {
    <span>// Remaining code path that will have access to the updated KonigKontext</span>
    
    <span>// Any client stub RPC called from within this lambda will automatically give that RPC</span>
    <span>// access to the current KonigKontext.    </span>
})</pre></div>
</details>
<h3 tabindex="-1" id="user-content-getting-value" dir="auto"><a href="#getting-value">Getting value:<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">Any KonigKontext scoped closure (see <code>withKonigKontext</code> and <code>run</code> above) will have access to get a KonigKontext value. Any
downstream microservice RPC called from within a KonigKontext scoped closure can also access a previously set KonigKontext value.</p>
<p dir="auto">Access a KonigKontext value:</p>
<details open="">
<summary>Kotlin</summary>
<div dir="auto" data-snippet-clipboard-copy-content="KonigKontext.getValue(MyContextKey)"><pre><span>KonigKontext</span>.getValue(<span>MyContextKey</span>)</pre></div>
</details>
<details>
<summary>Java</summary>
<div dir="auto" data-snippet-clipboard-copy-content="KonigKontext.getValue(GlobalContextKeys.MY_CONTEXT_KEY)"><pre><span>KonigKontext</span>.<span>getValue</span>(<span>GlobalContextKeys</span>.<span>MY_CONTEXT_KEY</span>)</pre></div>
</details>
<h3 tabindex="-1" id="user-content-usage-example" dir="auto"><a href="#usage-example">Usage Example:<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">Let&#39;s consider two services, ServiceA and ServiceB, running in separate containers. ServiceA handles an incoming request and then calls ServiceB:</p>
<details open="">
<summary>Kotlin</summary>
<div dir="auto" data-snippet-clipboard-copy-content="// Service A:
class ServiceA {
    val serviceBClient = ServiceBCoroutineStub(myManagedChannel)
        .withInterceptors(KonigKontextClientInterceptor(MyContextKey)) 
    
    suspend fun handleRequest(userId: String): Response {
        return withKonigKontext(KonigKontext.withValue(MyKontextKey, userId)) {
            println(&#34;USER ID: ${KonigKontext.getValue(MyContextKey)}&#34;)
            
            val serviceBResponse = serviceBClient.doSomething(doSomethingRequest { })
            
            Response(serviceBResponse)
        }
    }
}"><pre><span><span>//</span> Service A:</span>
<span>class</span> <span>ServiceA</span> {
    <span>val</span> serviceBClient <span>=</span> <span>ServiceBCoroutineStub</span>(myManagedChannel)
        .withInterceptors(<span>KonigKontextClientInterceptor</span>(<span>MyContextKey</span>)) 
    
    <span>suspend</span> <span>fun</span> <span>handleRequest</span>(<span>userId</span><span>:</span> <span>String</span>): <span>Response</span> {
        <span>return</span> withKonigKontext(<span>KonigKontext</span>.withValue(<span>MyKontextKey</span>, userId)) {
            <span>println</span>(<span><span>&#34;</span>USER ID: <span>${<span>KonigKontext</span>.getValue(<span>MyContextKey</span>)}</span><span>&#34;</span></span>)
            
            <span>val</span> serviceBResponse <span>=</span> serviceBClient.doSomething(doSomethingRequest { })
            
            <span>Response</span>(serviceBResponse)
        }
    }
}</pre></div>
<div dir="auto" data-snippet-clipboard-copy-content="// Service B:
class ServiceB : ServiceBCoroutineImplBase() {
    override suspend fun doSomething(DoSomethingRequest: request): Response {
        val userId = KonigKontext.getValue(MyContextKey)
        
        println(&#34;USER ID: $userId&#34;)
        
        return Response()
    }
}"><pre><span><span>//</span> Service B:</span>
<span>class</span> <span>ServiceB</span> : <span>ServiceBCoroutineImplBase</span>() {
    <span>override</span> <span>suspend</span> <span>fun</span> <span>doSomething</span>(<span>DoSomethingRequest</span><span>:</span> request): <span>Response</span> {
        <span>val</span> userId <span>=</span> <span>KonigKontext</span>.getValue(<span>MyContextKey</span>)
        
        <span>println</span>(<span><span>&#34;</span>USER ID: <span>$userId</span><span>&#34;</span></span>)
        
        <span>return</span> <span>Response</span>()
    }
}</pre></div>
</details>
<details>
<summary>Java</summary>
<div dir="auto" data-snippet-clipboard-copy-content="// Service A:
public class ServiceA {
    var serviceBClient = ServiceBGrpc.newBlockingStub(myManagedChannel)
        .withInterceptors(new KonigKontextClientInterceptor&lt;&gt;(GlobalContextKeys.MY_CONTEXT_KEY)) 
    
    public Response handleRequest(String userId) {
        var responseBuilder = Response.builder();
        
        KonigKontext.withValue(GlobalContextKeys.MY_CONTEXT_KEY, userId).run(() -&gt; {
            System.out.println(&#34;USER ID: &#34; + userId);
            
            var getBalanceResponse = serviceBClient.doSomething(DoSomethingRequest.newBuilder().build());
            
            responseBuilder.setResponse(getBalanceResponse);
        });
        
        return responseBuilder.build(); 
    }
}"><pre><span>// Service A:</span>
<span>public</span> <span>class</span> <span>ServiceA</span> {
    <span>var</span> <span>serviceBClient</span> = <span>ServiceBGrpc</span>.<span>newBlockingStub</span>(<span>myManagedChannel</span>)
        .<span>withInterceptors</span>(<span>new</span> <span>KonigKontextClientInterceptor</span>&lt;&gt;(<span>GlobalContextKeys</span>.<span>MY_CONTEXT_KEY</span>)) 
    
    <span>public</span> <span>Response</span> <span>handleRequest</span>(<span>String</span> <span>userId</span>) {
        <span>var</span> <span>responseBuilder</span> = <span>Response</span>.<span>builder</span>();
        
        <span>KonigKontext</span>.<span>withValue</span>(<span>GlobalContextKeys</span>.<span>MY_CONTEXT_KEY</span>, <span>userId</span>).<span>run</span>(() -&gt; {
            <span>System</span>.<span>out</span>.<span>println</span>(<span>&#34;USER ID: &#34;</span> + <span>userId</span>);
            
            <span>var</span> <span>getBalanceResponse</span> = <span>serviceBClient</span>.<span>doSomething</span>(<span>DoSomethingRequest</span>.<span>newBuilder</span>().<span>build</span>());
            
            <span>responseBuilder</span>.<span>setResponse</span>(<span>getBalanceResponse</span>);
        });
        
        <span>return</span> <span>responseBuilder</span>.<span>build</span>(); 
    }
}</pre></div>
<div dir="auto" data-snippet-clipboard-copy-content="// Service B:
public class ServiceB extends ServiceBImplBase {
    @Override
    public void doSomething(DoSomethingRequest request, StreamObserver&lt;DoSomethingResponse&gt; responseObserver) {
        var userId = KonigKontext.getValue(MyContextKey);
        
        println(&#34;USER ID: &#34; + userId);

        responseObserver.onNext(DoSomethinResponse.newBuilder().build());
        responseObserver.onCompleted();
    }
}"><pre><span>// Service B:</span>
<span>public</span> <span>class</span> <span>ServiceB</span> <span>extends</span> <span>ServiceBImplBase</span> {
    <span>@</span><span>Override</span>
    <span>public</span> <span>void</span> <span>doSomething</span>(<span>DoSomethingRequest</span> <span>request</span>, <span>StreamObserver</span>&lt;<span>DoSomethingResponse</span>&gt; <span>responseObserver</span>) {
        <span>var</span> <span>userId</span> = <span>KonigKontext</span>.<span>getValue</span>(<span>MyContextKey</span>);
        
        <span>println</span>(<span>&#34;USER ID: &#34;</span> + <span>userId</span>);

        <span>responseObserver</span>.<span>onNext</span>(<span>DoSomethinResponse</span>.<span>newBuilder</span>().<span>build</span>());
        <span>responseObserver</span>.<span>onCompleted</span>();
    }
}</pre></div>
</details>
<p dir="auto">Calling <code>ServiceA.handleRequest(&#34;some_user_id&#34;)</code> would first print: <code>USER ID: some_user_id</code> in ServiceA and then also in ServiceB.
Since <code>serviceBClient.doSomething()</code> is called from within a KonigKontext scoped closure, the current KonigKontext is automatically propagated
to ServiceB, even though the two services are running in entirely separate containers.</p>
<h3 tabindex="-1" id="user-content-full-examples" dir="auto"><a href="#full-examples">Full Examples:<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">See full example implementations in:</p>
<ul dir="auto">
<li><a href="https://github.com/konigsoftware/konig-kontext/tree/main/examples/example-kotlin">Kotlin</a></li>
<li><a href="https://github.com/konigsoftware/konig-kontext/tree/main/examples/example-java">Java</a></li>
</ul>
</article>
          </div></div>
  </body>
</html>
