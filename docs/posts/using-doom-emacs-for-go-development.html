<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://nayak.io/posts/golang-development-doom-emacs/">Original</a>
    <h1>Using Doom Emacs for Go Development</h1>
    
    <div id="readability-page-1" class="page"><div>
<section>
<article>
<header>

<div>
<p><span>
<i aria-hidden="true"></i>
<time datetime="2023-01-09T23:07:40+01:00">
January 9, 2023
</time>
</span>
<span>
<i aria-hidden="true"></i>
4-minute read
</span>
</p>

</div>
</header>
<div>
<p>I’ve been Emacs user since around ~2014, I used to maintain my own Emacs config and publish it (I also would flash custom roms on my android phones). With time, I yearned more for stability. So I switched to an Emacs framework: <a href="https://github.com/seagle0128/.Emacs.d">Centaur Emacs</a>. This allowed me to continue using Emacs without having to worry about a broken config, as it was well maintained.</p>
<p>With time, I realized I was adding a lot more on top of Centaur Emacs as my own config. So again, I switched to <a href="https://github.com/doomEmacs/doomEmacs">Doom Emacs</a>, which supported a lot more modules than Centaur and also saw more community contributions (chicken-egg problem). Today let’s go (pun! hehe) over the additional config I have written over the defaults provided by Doom Emacs for Go development.</p>
<p><em>Do you see the pattern here?</em> While one perspective is that Emacs always requires tinkering. The more <em>realistic</em> perspective is that Emacs is all about customization, even when using a framework like Doom Emacs, users can always modify it to their requirements and preferences.</p>
<h2 id="go-in-doom-emacs">
Go in Doom Emacs
<a href="#go-in-doom-emacs">
<i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span>
</a>
</h2>
<p>Doom Emacs comes with pre-built modules for Go, to <a href="https://github.com/doomEmacs/doomEmacs/blob/master/docs/getting_started.org#modules">enable it</a> all we need to do is add the following to your <code>doom/init.el</code> file:</p>
<p>The README in the Go modules folder, lists the <a href="https://github.com/doomEmacs/doomEmacs/tree/master/modules/lang/go#dependencies">pre-requisites</a> to be installed. It also recommends using <code>gopls</code>. gopls is the <a href="https://github.com/golang/tools/tree/master/gopls">official Go language server</a> developed by the Go team.</p>
<p>LSP is an editor agnostic protocol, which allows editors to be linked to language servers and utilize them for features such as syntax checks, code-navigation, linting and so on. Before editors used to implement each of these functionalities from scratch for different languages/frameworks, with LSP, they could simply make RPC calls to the language server installed on the users system.</p>
<p>To install <code>gopls</code>, we can simply use <code>go install</code>:</p>
<p>This is already a fully usable setup. This will provide all the functionality you expect from a modern editor (code completion, code navigation, syntax checking, linting). But we can fine tune some things to make it better for Go development.</p>
<h3 id="format-buffer">
Format Buffer
<a href="#format-buffer">
<i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span>
</a>
</h3>
<p>Go projects follow <code>gofmt</code> for formatting. So it’d be nice if we could get Emacs to auto-format before saving. Both <code>gopls</code> and Emacs’s <a href="https://Emacs-lsp.github.io/lsp-mode/">lsp-mode</a> support buffer formatting via the <code>lsp-format-buffer</code> command. Doom Emacs abstracts this for us behind the <code>+format/buffer-or-region</code> command.</p>
<p>Either of these commands can be used or we could also add the <code>+format-buffer-h</code> command to the <code>before-save-hook</code> hook, so it automatically does this before saving. The simplest option is to add to the following to <code>~/.doom.d/init.el</code>:</p>
<p>This automatically formats buffers before saving. _<em>Note: This applies for all major modes and not just Go.</em></p>
<h4 id="organize-imports">
Organize Imports
<a href="#organize-imports">
<i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span>
</a>
</h4>
<p>To organize imports one could manually run <code>lsp-organize-imports</code>. I prefer running this automatically as a hook just before saving a file. To do this, add the following to your <code>~/.doom.d/config.el</code>:</p>
<div><pre tabindex="0"><code data-lang="elisp"><span><span>(add-hook <span>&#39;go-mode-hook</span> <span>#&#39;</span>lsp-deferred)
</span></span><span><span><span>;; Make sure you don&#39;t have other goimports hooks enabled.</span>
</span></span><span><span>(defun lsp-go-install-save-hooks ()
</span></span><span><span>    (add-hook <span>&#39;before-save-hook</span> <span>#&#39;</span>lsp-organize-imports <span>t</span> <span>t</span>))
</span></span><span><span>(add-hook <span>&#39;go-mode-hook</span> <span>#&#39;</span>lsp-go-install-save-hooks)
</span></span></code></pre></div><h4 id="gofumpt">
Gofumpt
<a href="#gofumpt">
<i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span>
</a>
</h4>
<p>I prefer using <a href="https://github.com/mvdan/gofumpt">gofumpt</a> over the standard gofmt, if you do so too, then you can simply ask lsp to use gofumpt by adding this to your <code>~/.doom.d/config.el</code>:</p>
<div><div>
<table><tbody><tr><td>
<pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span></code></pre></td>
<td>
<pre tabindex="0"><code data-lang="elisp"><span><span>(after! lsp-mode
</span></span><span><span>  (setq  lsp-go-use-gofumpt <span>t</span>)
</span></span><span><span>  )
</span></span></code></pre></td></tr></tbody></table>
</div>
</div><h3 id="analyzers">
Analyzers
<a href="#analyzers">
<i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span>
</a>
</h3>
<p>By default, <code>gopls</code> doesn’t enable all analyzers. You can find the list of analyzers and their default values <a href="https://github.com/golang/tools/blob/master/gopls/doc/analyzers.md">here</a>. Some of the analyzers I manually enable are:</p>
<ul>
<li>fieldalignment: find structs that would use less memory if their fields were sorted</li>
<li>nilness: check for redundant or impossible nil comparisons</li>
<li>shadow: check for possible unintended shadowing of variables</li>
<li>unusedparams: check for unused parameters of functions</li>
<li>unusedwrite: checks for unused writes</li>
<li>useany: check for constraints that could be simplified to “any”</li>
<li>unusedvariable: check for unused variables</li>
</ul>
<p>To enable these, we add the following to <code>~/.doom.d/config.el</code>:</p>
<div><pre tabindex="0"><code data-lang="elisp"><span><span>(after! lsp-mode
</span></span><span><span>  (setq  lsp-go-analyses <span>&#39;</span>((fieldalignment <span>.</span> <span>t</span>)
</span></span><span><span>                           (nilness <span>.</span> <span>t</span>)
</span></span><span><span>                           (shadow <span>.</span> <span>t</span>)
</span></span><span><span>                           (unusedparams <span>.</span> <span>t</span>)
</span></span><span><span>                           (unusedwrite <span>.</span> <span>t</span>)
</span></span><span><span>                           (useany <span>.</span> <span>t</span>)
</span></span><span><span>                           (unusedvariable <span>.</span> <span>t</span>)))
</span></span><span><span>)
</span></span></code></pre></div><h3 id="tree-sitter">
Tree-sitter
<a href="#tree-sitter">
<i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span>
</a>
</h3>
<p><a href="https://www.youtube.com/watch?v=ZwibVdNtFjs">Emacs generally uses regular expressions for parsing languages</a>, this is slow and inaccurate at times. <a href="https://tree-sitter.github.io/tree-sitter/">Tree-sitter</a> is a parser generator tool and an incremental parsing library. It was also <a href="https://lists.gnu.org/archive/html/Emacs-devel/2022-11/msg01443.html">merged into Emacs 29</a>. To use tree-sitter in Emacs, first add the following to <code>~/.doom.d/config.el</code> file’s <code>:tools</code> section:</p>
<p>Also modify Go to use tree-sitter by modifying <code>~/.doom.d/config.el</code>:</p>
<h3 id="summary">
Summary
<a href="#summary">
<i aria-hidden="true" title="Link to heading"></i>
<span>Link to heading</span>
</a>
</h3>
<p>That’s it! Not much configuration over the default doom setup. Certain changes I would be looking forward to:</p>
<ol>
<li>Some of the analyzer being set to default true, so we can skip them.</li>
<li>Since tree-sitter is merged into Emacs, we shouldn’t be required to enable it anymore.</li>
<li>elgot, which is an alternative for lsp-mode also got merged into Emacs, curious how this will all play out.</li>
</ol>
<hr/>
<p>This is post 003 of <a href="https://100daystooffload.com/">#100DaysToOffload</a>.</p>
</div>

</article>
</section>
</div></div>
  </body>
</html>
