<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://nibblestew.blogspot.com/2025/05/writing-your-own-c-standard-library.html">Original</a>
    <h1>Writing your own C&#43;&#43; standard library part 2</h1>
    
    <div id="readability-page-1" class="page"><div id="post-body-6784007741860106849" itemprop="description articleBody">
<p><a href="https://nibblestew.blogspot.com/2025/03/writing-your-own-c-standard-library.html">This blog post</a> talked about the &#34;self written C++ standard library&#34; I wrote for the fun of it (<a href="https://nibblestew.blogspot.com/2025/03/writing-your-own-c-standard-library.html">code here</a>).</p><p>The post got linked by Hackernews and Reddit. As is usual the majority of comments did not talk about the actual content but instead were focused on two tangential things. The first one being &#34;this is not a full implementation of the C++ standard library as specified by the ISO standard, therefore the author is an idiot&#34;. I am, in actual fact, an idiot, but not due to project scope but because I assumed people on the Internet to have elementary reading comprehension skills. To make things clear: no, this is not an implementation of the ISO standard library. At no point was such a thing claimed. There is little point in writing one of those, there are several high quality implementations available. &#34;Standard library&#34; in this context means &#34;a collection of low level functions and types that would be needed by most applications&#34;.</p><p>The second discussion was around the fact that calling the C++ standard library &#34;STL&#34; was both wrong and proof that the person saying that does not understand the C++ language. This was followed by several &#34;I am a C++ standard library implementer and everyone I know calls it the STL&#34;. Things deteriorated from there.</p><p>Existing container implementations are complex by necessity. They need to handle things like types that can not be noexcept moved or copied. The amount of rollback code needed explodes very quickly and needs to be processed every time the header is included (because of templates). A reasonable point against writing your own containers is that eventually you need to support all the same complexity as existing ones because people will insert &#34;bad&#34; types into your container and complain when things fail. Thus you need to have all the same nasty, complex and brittle code as an STL implementation, only lacking decades of hardening to shake out all the bugs.</p><p>That is true, but the beauty of having zero existing users is that you can do something like this:</p><p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjHnzalf3ku3pnatODqLs6qwd3fRsKIfpTTOTuV2O6Jaw4ceN_ISzLOna_7W-5xSGTX7g-CYLVrW4kbFIndCeJwfoYYI-j-qJ4bFhjxCse1Od4Pqa2JimIiPkejj-8YY8ebBE1fp6fTbAY-T3iMKQhwSMAfhm41qOrEM79dPgqB0rqP_ex7Fupagyp_bfw/s964/Screenshot%20From%202025-05-02%2022-49-16.png"><img data-original-height="474" data-original-width="964" height="157" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjHnzalf3ku3pnatODqLs6qwd3fRsKIfpTTOTuV2O6Jaw4ceN_ISzLOna_7W-5xSGTX7g-CYLVrW4kbFIndCeJwfoYYI-j-qJ4bFhjxCse1Od4Pqa2JimIiPkejj-8YY8ebBE1fp6fTbAY-T3iMKQhwSMAfhm41qOrEM79dPgqB0rqP_ex7Fupagyp_bfw/s320/Screenshot%20From%202025-05-02%2022-49-16.png" width="320"/></a></p><p>This is basically a concept that requires the type given to be noexcept-movable (and some other things that could arguably be removed). Now, instead of allowing any type under the sun, <i>all</i> containers require <i>all</i> types they get instantiated with to be <span>WellBehaved</span>. This means that the library <i>does not have to care at all</i> about types behaving badly because trying to use those results in a compiler error. A massive amount of complexity is thus eliminated in a single stroke.</p><p>There are of course cases when you need to deal with types that are not well behaved. If you can tolerate a memory allocation per object, the simple solution is to use <span>unique_ptr</span>. OTOH if you have types that can&#39;t be reliably moved and which are so performance critical that you can&#39;t afford memory allocations, then you are probably going to write your own container code anyway. If you are in the position that you have badly behaved types that you can&#39;t update, can&#39;t tolerate an allocation and can&#39;t write your own containers, then <i>that is your problem</i>.</p><p>One of the most common things I do with strings in Python is to split them on whitespace. In Python this is simple as there is only one string type, but in native code things are more complicated. What should the return type of <span>mystring.split()</span> be?</p><ul><li><span>vector&lt;string&gt;</span></li><li><span>vector&lt;string_view&gt;</span></li><li>A coroutine handle</li><li>The method should be a full template so you can customize it to output any custom string type (as every C++ code base has at least three of them)</li><li>Something ranges something something</li></ul><p>There is probably not a single correct answer. All of the options have different tradeoffs. Thus I implemented this in two ways. The first returns a <span>vector&lt;string&gt;</span> as you would get in Python. The second one was a fully general, lazy and allocation-free method that uses the most unloved of language features: the void pointer.</p><p>So given that you have a callback function like this:</p><p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh2Qm3mDv-zwzpbHsVOxM-wQOyVEV39WjUOo95F_bSx_Z-TvQOYX5HWb4L3kjdcOATmm4vRM_u7cpAloPlm6_NXmTk5cfe-laA7dRHiGuK3d8HIv9MvrIFmwaStIGAesHCR8C1v8gLlseORVJT6Zuw_H_czmYgOSo8eQZpAXe3cyUrqUwTGamBteNXWJwc/s1028/Screenshot%20From%202025-05-02%2023-28-27.png"><img data-original-height="57" data-original-width="1028" height="18" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh2Qm3mDv-zwzpbHsVOxM-wQOyVEV39WjUOo95F_bSx_Z-TvQOYX5HWb4L3kjdcOATmm4vRM_u7cpAloPlm6_NXmTk5cfe-laA7dRHiGuK3d8HIv9MvrIFmwaStIGAesHCR8C1v8gLlseORVJT6Zuw_H_czmYgOSo8eQZpAXe3cyUrqUwTGamBteNXWJwc/s320/Screenshot%20From%202025-05-02%2023-28-27.png" width="320"/></a></p><p>the split function becomes:</p><p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgm29mnx07rxNFPKNR5QCiaMJHSCZfGZcG4n79-ZSfUtU2ii5MYhokznTXQjlvDmH5sEIE0jDVbOqahf8iLQEyX3L4xWnyVrJbSf9zoUBg7VFhu3oVWvMLs1d9z5e2fuB89o20_MeRSX_fhU7bNKGZJhiXacfaMBo84WXuzCMrV9qlvEa34mvLTsR8X-t0/s742/Screenshot%20From%202025-05-02%2023-31-18.png"><img data-original-height="43" data-original-width="742" height="19" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgm29mnx07rxNFPKNR5QCiaMJHSCZfGZcG4n79-ZSfUtU2ii5MYhokznTXQjlvDmH5sEIE0jDVbOqahf8iLQEyX3L4xWnyVrJbSf9zoUBg7VFhu3oVWvMLs1d9z5e2fuB89o20_MeRSX_fhU7bNKGZJhiXacfaMBo84WXuzCMrV9qlvEa34mvLTsR8X-t0/s320/Screenshot%20From%202025-05-02%2023-31-18.png" width="320"/></a></p><p>This is as fully general as you can get without needing to muck about with templates, coroutines or monads (I don&#39;t actually know what monads are, I&#39;m just counting on the fact that mentioning them makes you look cool). The cost is that the end user needs to write a small adapter lambda to use it.</p><p>The Python iteration protocol is surprisingly simple. The object being iterated needs to provide a <span>.next()</span> method that either returns the next value or throws a <span>StopIteration</span> exception. Obviously exceptions can&#39;t be used in native code because they are too slow, but the same effect can be achieved by returning an <span>optional&lt;T&gt;</span> instead. Here&#39;s a unit test for an implementation of Python&#39;s <span>range</span> function.</p><p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjm-rHXbGLA5aahtaLPpAe3ah7GJZcH19S3h82WJpYt0C2f-WUJqXNWwnVpR3US3eHckhW8VXlBkfIxrJCLZxGgm2U3T3ewCUnkxWiXaKAgyuyJDxyzOJVTZRCZHfuN-iGGyZ7IgLvK-OOMg2ZoExKzgqtOvPv7liBUFaqROMhwUYn535PTHWOCe-GhdD4/s432/Screenshot%20From%202025-05-02%2023-43-10.png"><img data-original-height="432" data-original-width="388" height="320" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjm-rHXbGLA5aahtaLPpAe3ah7GJZcH19S3h82WJpYt0C2f-WUJqXNWwnVpR3US3eHckhW8VXlBkfIxrJCLZxGgm2U3T3ewCUnkxWiXaKAgyuyJDxyzOJVTZRCZHfuN-iGGyZ7IgLvK-OOMg2ZoExKzgqtOvPv7liBUFaqROMhwUYn535PTHWOCe-GhdD4/s320/Screenshot%20From%202025-05-02%2023-43-10.png" width="287"/></a></p></div></div>
  </body>
</html>
