<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://wejick.wordpress.com/2022/01/29/can-i-have-a-smaller-prometheus/">Original</a>
    <h1>More than 70% of prometheus executable are unused by most people</h1>
    
    <div id="readability-page-1" class="page"><div>
		
<div><figure><img src="https://wejick.files.wordpress.com/2022/01/644a8-cf93e2_c52dcfd44ea84f01b64cef91b4e54b98mv2.webp" alt="Prometheus | Power Devops" width="240" height="180"/></figure></div>



<p>For the past few weeks, I’ve been thinking about having a time series DB and visualization tool that is easy to use and light on resources, so it can be used locally for development. Tried several times to find it with keywords such as “Grafana alternative”, “Prometheus alternative”, nothing to be seen as an alternative close to my liking. At one stage I almost write my own tools, which will be too big an undertaking for me.</p>



<p>So why not just use Prometheus? Well not until you see the binary size of it, a whopping <strong>103.93 MB</strong>. Not surprising for a statically linked executable, but still, it’s big. Yesterday morning I told myself, why not make it smaller? How hard it can be right? Well at least smaller on the binary size, as I’m not yet informed enough to do a runtime utilization measurement on it.</p>



<p>The first thing I did after getting access to the code is to just remove whatever code I deemed not necessary. Like one time I completely remove tracing and alerting functionality, but that’s only reducing a maximum of 2MB. This comes with a lot bunch of modified files and breaking test cases. Definitely not the right way, we need to do it smarter.</p>



<h2 id="the-weight">The weight</h2>



<p>After browsing for a binary size analysis tool I found <a href="https://github.com/jondot/goweight">goweight</a>. It helps to determine what’s contributing to the binary size : </p>



<div><figure><a href="https://wejick.files.wordpress.com/2022/01/gambar.png"><img data-attachment-id="1950" data-permalink="https://wejick.wordpress.com/gambar-2/" data-orig-file="https://wejick.files.wordpress.com/2022/01/gambar-edited.png" data-orig-size="1384,586" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="gambar" data-image-description="" data-image-caption="" data-medium-file="https://wejick.files.wordpress.com/2022/01/gambar-edited.png?w=300" data-large-file="https://wejick.files.wordpress.com/2022/01/gambar-edited.png?w=630" src="https://wejick.files.wordpress.com/2022/01/gambar-edited.png" alt=""/></a></figure></div>



<p>No surprise to see that the main contributors are cloud provider SDKs, but it’s still disappointing. At this stage, it is just a matter of finding where those are being used. A simple text search revealed that all the SDKs are mainly for Service Discovery (SD), for local development file-SD are more than enough.</p>



<figure><a href="https://wejick.files.wordpress.com/2022/01/gambar-5.png"><img data-attachment-id="1959" data-permalink="https://wejick.wordpress.com/gambar-5/" data-orig-file="https://wejick.files.wordpress.com/2022/01/gambar-5.png" data-orig-size="1174,206" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="gambar-5" data-image-description="" data-image-caption="" data-medium-file="https://wejick.files.wordpress.com/2022/01/gambar-5.png?w=300" data-large-file="https://wejick.files.wordpress.com/2022/01/gambar-5.png?w=630" src="https://wejick.files.wordpress.com/2022/01/gambar-5.png?w=1024" alt="" srcset="https://wejick.files.wordpress.com/2022/01/gambar-5.png?w=1024 1024w, https://wejick.files.wordpress.com/2022/01/gambar-5.png?w=150 150w, https://wejick.files.wordpress.com/2022/01/gambar-5.png?w=300 300w, https://wejick.files.wordpress.com/2022/01/gambar-5.png?w=768 768w, https://wejick.files.wordpress.com/2022/01/gambar-5.png 1174w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<p>After tinkering here and there, the very minimum change to exclude all unused SD is to comment them out in the in <em>discovery/install/install.go</em> . With this change, all tests are passed except one test related to zookeeper initialization. The binary got reduced to just 35.69 MB, just 34% from the original one.</p>



<div><figure><a href="https://wejick.files.wordpress.com/2022/01/gambar-6.png"><img loading="lazy" data-attachment-id="1960" data-permalink="https://wejick.wordpress.com/gambar-6/" data-orig-file="https://wejick.files.wordpress.com/2022/01/gambar-6.png" data-orig-size="1452,878" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="gambar-6" data-image-description="" data-image-caption="" data-medium-file="https://wejick.files.wordpress.com/2022/01/gambar-6.png?w=300" data-large-file="https://wejick.files.wordpress.com/2022/01/gambar-6.png?w=630" src="https://wejick.files.wordpress.com/2022/01/gambar-6.png?w=1024" alt="" width="477" height="288" srcset="https://wejick.files.wordpress.com/2022/01/gambar-6.png?w=477 477w, https://wejick.files.wordpress.com/2022/01/gambar-6.png?w=954 954w, https://wejick.files.wordpress.com/2022/01/gambar-6.png?w=150 150w, https://wejick.files.wordpress.com/2022/01/gambar-6.png?w=300 300w, https://wejick.files.wordpress.com/2022/01/gambar-6.png?w=768 768w" sizes="(max-width: 477px) 100vw, 477px"/></a></figure></div>



<h2 id="wrap-up">Wrap Up</h2>



<p>After stripping the debugging info using <code>-ldflags=&#34;-s -w&#34;</code>, the size got reduced quite bit more. At the end we reduced the size to 28.30% of the original file to just <b>29.42 MB</b>.</p>



<div><figure><a href="https://wejick.files.wordpress.com/2022/01/gambar-8.png"><img loading="lazy" data-attachment-id="1963" data-permalink="https://wejick.wordpress.com/gambar-8/" data-orig-file="https://wejick.files.wordpress.com/2022/01/gambar-8.png" data-orig-size="1200,538" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="gambar-8" data-image-description="" data-image-caption="" data-medium-file="https://wejick.files.wordpress.com/2022/01/gambar-8.png?w=300" data-large-file="https://wejick.files.wordpress.com/2022/01/gambar-8.png?w=630" src="https://wejick.files.wordpress.com/2022/01/gambar-8.png?w=1024" alt="" width="441" height="197" srcset="https://wejick.files.wordpress.com/2022/01/gambar-8.png?w=439 439w, https://wejick.files.wordpress.com/2022/01/gambar-8.png?w=879 879w, https://wejick.files.wordpress.com/2022/01/gambar-8.png?w=150 150w, https://wejick.files.wordpress.com/2022/01/gambar-8.png?w=300 300w, https://wejick.files.wordpress.com/2022/01/gambar-8.png?w=768 768w" sizes="(max-width: 441px) 100vw, 441px"/></a></figure></div>



<p>It’s crazy when you think that more than 50% (I’m being generous) of the size is something most people will not use, maybe this is the price of modern computation where 50MB means nothing. To be fair Prometheus developers are kinda aware of this and putting the discussion in the <a href="https://github.com/prometheus/prometheus/blob/main/discovery/README.md">readme</a> of service discovery, however, the binary size is not discussed there.</p>



<p>There are several potential ways to reduce the file size, like by using upx to package the file. However it’s not readily available on brew, so I just skipped it. Another way is just to cut more functionality like tracing, alert and remote storage, however, it will take more effort to maintain and make sure all the tests will be passed.</p>



<p>The related changes can be found here<a href="https://github.com/wejick/prometheus/commit/6dd776019a315764a9f70147f83f1235b9b13189"> https://github.com/wejick/prometheus/commit/6dd776019a315764a9f70147f83f1235b9b13189</a></p>
			
			
						</div></div>
  </body>
</html>
