<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://insanity.industries/post/simple-networking/">Original</a>
    <h1>Simple Networking in Linux</h1>
    
    <div id="readability-page-1" class="page"><section>
			<p>It is time to revisit of the <a href="https://insanity.industries/post/simple-wifi/">simple wifi setup</a> as much has changed since.
This time, however, we will not only cover wifi, but also wired connections as well as DNS.</p>

<p>This wired setup is based on <code>systemd-networkd</code>, which typically comes with systemd. If you use a systemd-based Linux, you should be ready to go right away.
It further assumes that acquiring an IP address via DHCP once a cable is plugged in the typical usecase.<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup></p>
<p>Create the file <code>/etc/systemd/network/cable.network</code><sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup>:</p>
<pre><code>[Match]
Name=&lt;name of the wired network device&gt; &lt;second one if applicable&gt; [&lt;more ...&gt;]

[Network]
DHCP=yes
IPv6PrivacyExtensions=true

[DHCP]
Anonymize=true
</code></pre>
<p>Then <code>systemctl enable --now systemd-networkd</code> and plug in a cable, wired networking with DHCP is up and running.</p>

<p>The wireless setup is based on <a href="https://iwd.wiki.kernel.org/">iwd</a>, the currently vastly superior tool for wireless networking on Linux compared to existing alternatives such as <code>wpa_supplicant</code> (the effectively only other contender in this game) and software using it such as <code>NetworkManager</code> and <code>netctl</code>.
It requires <code>iwd</code> as well as <code>Linux &gt;= 4.20</code> for full operation.</p>
<p>Create the file <code>/etc/iwd/main.conf</code>:</p>
<pre><code>[General]
# uncomment for setting the wifi interface name yourself
# see https://iwd.wiki.kernel.org/interface_lifecycle
#UseDefaultInterface=true

# enable builtin DHCP-client within iwd for wifi
EnableNetworkConfiguration=true

# randomizes mac-address every time iwd starts or the hardware is initially detected
AddressRandomization=once
</code></pre>
<p>Then <code>systemctl enable --now iwd</code>, wireless networking with DHCP is up and running, blazingly fast and stable.</p>
<p>You might want to take a look at the <a href="https://insanity.industries/post/racefree-iwd/">previous post</a> to deal with race conditions that might be introduced due to iwd being significantly faster than other wifi-solutions on Linux.</p>
<h2 id="frontends">Frontends</h2>
<p><code>iwd</code> stores its known networks in <code>/var/lib/iwd</code>. To add, modify or delete them, several options are available:</p>
<h3 id="iwctl">iwctl</h3>
<p>You can now connect to simple PSK wifi networks in the <code>iwctl</code> shell:</p>
<pre><code>[iwctl] station &lt;devicename&gt; get-networks
…
[iwctl] station &lt;devicename&gt; connect &lt;network-name&gt;
</code></pre>
<p><code>iwctl</code> will ask you for the password, <code>iwd</code> will memorize it for later connections and autoconnect the next time the network appears.
Currently, <code>iwctl</code> only supports creating simple password-only network connections, for more complex network setups, instead of <code>iwctl</code> asking you all the nifty details of an enterprise connection, use the file-based config instead.
For everything else, just type <code>help</code> within <code>iwctl</code>.</p>
<h3 id="file-based-config">file-based config</h3>
<p>If you have more complex wifi-setups, you can simply drop a network configuration file in <code>/var/lib/iwd</code>.
The files must be named as <code>networkname.protocol</code>.
You can find the protocol listed in the output of <code>get-networks</code> in the iwctl-shell.
To fill the file, take a look to the <a href="https://iwd.wiki.kernel.org/networkconfigurationsettings">network configuration settings</a> in the iwd documentation or the <code>iwd.network</code> <a href="https://man.archlinux.org/man/community/iwd/iwd.network.5.en">manpage</a>.</p>
<p>For example, to use the University Heidelberg’s eduroam network, create the file <code>/var/lib/iwd/eduroam.8021x</code> containing</p>
<pre><code>[Security]
EAP-Method=TTLS
EAP-Identity=&lt;anonymous-identity&gt;
EAP-TTLS-CACert=/etc/ssl/certs/T-TeleSec_GlobalRoot_Class_2.pem
EAP-TTLS-Phase2-Method=MSCHAPV2
EAP-TTLS-Phase2-Identity=&lt;uni-id&gt;@uni-heidelberg.de
EAP-TTLS-Phase2-Password=&lt;your University account password&gt;
</code></pre>
<p>For other institutions, the details in the method might vary, of course. See <code>man iwd.network</code> for details. It also includes several examples for almost all possible configurations.</p>
<h3 id="network-manager">Network Manager</h3>
<p>You can also use Network Manager for a more graphical experience, you just have to <a href="https://iwd.wiki.kernel.org/networkmanager">enable the iwd-backend</a> for NetworkManager to use it.
In addition to that, double check if you have the right <a href="https://iwd.wiki.kernel.org/networkmanager">NetworkManager version</a> for your <code>iwd</code> version, just as a precaution.</p>

<p>For modern domain name resolution, you can use <code>systemd-resolved</code>, which provides statistics, automated caching of DNS requests, DNSSEC validation and much more.
To use it, ensure systemd-resolved is installed<sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup> and <code>systemctl enable --now systemd-resolved</code>.
Ensure that <code>/etc/resolv.conf</code> is symlinked to <code>/run/systemd/resolve/stub-resolv.conf</code>, if not</p>
<pre><code>ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf
</code></pre>
<p>takes care of it.
Afterwards, you can change the default fallback DNS servers and other things in <code>/etc/systemd/resolved.conf</code>, if desired and otherwise enjoy <code>resolvectl</code> and <code>resolvectl statistics</code>.</p>

<h2 id="binding-iwd-to-the-wifi-device">Binding iwd to the wifi-device</h2>
<p>To disable iwd when the wifi is not present (and iwd therefore not needed) create the file <code>/etc/udev/rules.d/wifi.rules</code> containing</p>
<pre><code># bind iwd to wifi
SUBSYSTEM==&#34;rfkill&#34;, ENV{RFKILL_NAME}==&#34;phy0&#34;, ENV{RFKILL_TYPE}==&#34;wlan&#34;, ACTION==&#34;change&#34;, ENV{RFKILL_STATE}==&#34;1&#34;, RUN+=&#34;/usr/bin/systemctl --no-block start iwd.service&#34;
SUBSYSTEM==&#34;rfkill&#34;, ENV{RFKILL_NAME}==&#34;phy0&#34;, ENV{RFKILL_TYPE}==&#34;wlan&#34;, ACTION==&#34;change&#34;, ENV{RFKILL_STATE}==&#34;0&#34;, RUN+=&#34;/usr/bin/systemctl --no-block stop iwd.service&#34;
</code></pre>
<p>If <code>AddressRamdomization=once</code> is set in the configuration, this udev rule has the nice side-effect that, as <code>iwd</code> starts nanew when the wifi is un-rfkilled, the MAC address of the interface is randomized again.</p>
<h2 id="persistent-device-naming">Persistent device naming</h2>
<p>If you want to have persistent device names, for example for devices showing up in a status bar or something similar, this ist easiest achieved by creating a <code>link</code>-file<sup id="fnref:4"><a href="#fn:4" role="doc-noteref">4</a></sup> <code>/etc/systemd/network</code>. To persistently name the wireless device <code>wifi</code>, create <code>/etc/systemd/network/00-wifi.link</code> containing</p>
<pre><code>[Match]
MACAddress=ab:cd:ef:12:34:56  # wifi&#39;s original MAC address

[Link]
Name=wifi  # can be used for matching in the according *.network-file
</code></pre>
<p>If you do this for any device operated by iwd, ensure you have <code>UseDefaultInterface=true</code> set in section <code>[General]</code> in <code>/etc/iwd/main.conf</code>.</p>
<h2 id="setting-specific-mac-addresses-for-specific-wifi-networks-and-randomizing-on-every-connect">Setting specific MAC addresses for specific wifi networks and randomizing on every connect</h2>
<p>In case you need to set a specific address for a specific wireless network, <code>iwd&gt;=1.6</code> allows using <code>AddressOverride=</code> inside a network configuration file. For this to take effect, however, <code>AddressRandomization=once</code> must be dropped from <code>/etc/iwd/main.conf</code>. This makes <code>iwd</code> generate persistent MAC addresses per network (generated from its SSID and real hardware address) by default and allows <code>AddressOverride</code> to take effect.
Additionally, a network file can contain <code>AlwaysRandomizeAddress=true</code>, which randomizes the MAC address on each connect for this network (also only takes effect when <code>AddressRandomization</code> is not set or set do its default value in <code>main.conf</code>.
However, due to kernel limitations, each change of a MAC address requires powercyling the card. This leads to (for <code>iwd</code> standards) singificantly prolonged connection times (by ≈300-400ms).
Given that, as long as you do not require <code>AddressOverride</code>, <code>AddressRandomization=once</code> gives you fast connection times while still randomizing your card’s MAC address regularly enough.</p>
<p><em><sub>Thanks to rixx for proofreading and helpful suggestions.</sub></em></p>


		</section></div>
  </body>
</html>
