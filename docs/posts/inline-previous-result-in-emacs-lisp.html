<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://xenodium.com/inline-previous-result-and-why-you-should-edebug/">Original</a>
    <h1>Inline previous result in Emacs Lisp</h1>
    
    <div id="readability-page-1" class="page"><div id="text-inline-previous-result-and-why-you-should-edebug">
<p>
Artur Malabarba&#39;s <a href="https://endlessparentheses.com/debugging-emacs-lisp-part-1-earn-your-independence.html">Debugging Elisp Part 1: Earn your independence</a> is nearly a decade old, yet it rings just as true today.
</p>

<p>
Learning to Edebug really <i>&#34;is the right decision for anyone who doesn&#39;t know how to Edebug.&#34;</i> Why, you may ask? He best puts it as <i>&#34;running into errors is not only a consequence of tinkering with your editor, it is the only road to graduating in Emacs.&#34;</i>
</p>

<p>
For me personally, it <i>earned me that independence</i> to bend Emacs my way. Don&#39;t like how something works? Pull up the debugger to help me understand how a package or function works. I&#39;ve done this countless of times to bend things my way.
</p>

<p>
Speaking of edebug, I had been meaning to tweak edebug&#39;s result display behaviour for quite some time. As you step through code, edbug prints the result of previous expressions to the minibuffer. This works well, but I couldn&#39;t help but feel like my eyes were constantly jumping between the code and the minibuffer at the bottom of the window.
</p>


<p><img src="https://xenodium.com/images/inline-previous-result-and-why-you-should-edebug/edebug-minibuffer.gif" alt="edebug-minibuffer.gif" width="70%"/>
</p>

<p>
I wanted to minimize the eye jumping experience, so I figured I could likely bend things my way and print the result at point. How did I go about it? The same way I often do. Figure out what function is called for a given key binding via <a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Key-Help.html">describe-key</a> or my favourite replacement helpful-key from <a href="https://github.com/Wilfred/helpful">helpful.el</a>. This led me to <code>edebug-next-mode</code> in <code>edebug.el</code>. At that point, I could have set a breakpoint in <code>edebug-next-mode</code> and eventually step into the relevant code, but hey we had a better clue. We knew that all output started with &#34;Result:&#34;, so we could just search for that string in <code>edebug.el</code> instead. Jackpot! <code>edebug-compute-previous-result</code> and its adjacent <code>edebug-previous-result</code> are just the right functions:
</p>

<div>
<pre>(<span>defun</span> <span>edebug-compute-previous-result</span> (previous-value)
  (<span>if</span> edebug-unwrap-results
      (<span>setq</span> previous-value
            (edebug-unwrap* previous-value)))
  (<span>setq</span> edebug-previous-result
        (concat <span>&#34;Result: &#34;</span>
                (edebug-safe-prin1-to-string previous-value)
                (eval-expression-print-format previous-value))))

(<span>defun</span> <span>edebug-previous-result</span> ()
  <span>&#34;Print the previous result.&#34;</span>
  (<span>interactive</span>)
  (message <span>&#34;%s&#34;</span> edebug-previous-result))
</pre>
</div>

<p>
We can see that <code>edebug-previous-result</code> invokes <code>message</code> which is responsible for displaying the debugged expression&#39;s result in the minibuffer. Modifying this functions behaviour would be enough to achieve inline display, but I also want to remove &#34;Result:&#34; from the displayed message. Neither of these functions offer configurability, so we&#39;ll resort to advising both functions. That is, <a href="https://en.wikipedia.org/wiki/Monkey_patch">monkey patch</a> them (errm I knowâ€¦ lovely).
</p>

<div>
<pre>(<span>defun</span> <span>adviced:edebug-compute-previous-result</span> (_ <span>&amp;rest</span> r)
  <span>&#34;Adviced `</span><span>edebug-compute-previous-result</span><span>&#39;.&#34;</span>
  (<span>let</span> ((previous-value (nth 0 r)))
    (<span>if</span> edebug-unwrap-results
        (<span>setq</span> previous-value
              (edebug-unwrap* previous-value)))
    (<span>setq</span> edebug-previous-result
          (edebug-safe-prin1-to-string previous-value))))

(advice-add #&#39;edebug-compute-previous-result
            <span>:around</span>
            #&#39;adviced:edebug-compute-previous-result)
</pre>
</div>

<p>
<code>adviced:edebug-compute-previous-result</code> removes &#34;Result:&#34; in addition to dropping <code>(eval-expression-print-format previous-value)</code>, which I don&#39;t typically rely on.
</p>

<div>
<pre>(<span>require</span> &#39;<span>eros</span>)

(<span>defun</span> <span>adviced:edebug-previous-result</span> (_ <span>&amp;rest</span> r)
  <span>&#34;Adviced `</span><span>edebug-previous-result</span><span>&#39;.&#34;</span>
  (eros--make-result-overlay edebug-previous-result
    <span>:where</span> (point)
    <span>:duration</span> eros-eval-result-duration))

(advice-add #&#39;edebug-previous-result
            <span>:around</span>
            #&#39;adviced:edebug-previous-result)
</pre>
</div>

<p>
<code>adviced:edebug-previous-result</code> is in charge of display via <code>message</code>, so all we need is some replacement. I initially played with <a href="https://github.com/auto-complete/popup-el">popup-tip</a> and that <a href="https://indieweb.social/@xenodium/111008598580447299">did the job just fine</a>, but <a href="https://emacs.ch/@fosskers">Colin</a> led me to a better path while <a href="https://emacs.ch/@fosskers/111009811997698187">pointing to Clojure and Common Lisp</a>. This reminded me of <a href="https://github.com/xiongtx/eros">eros: Evaluation Result OverlayS for Emacs Lisp</a>, which I already used. Swapping <code>message</code> for <code>eros--make-result-overlay</code> did the trick. Yes, this is a private function, but I can live with that. This code is only an <code>advice-remove</code> away from disabling, but hey look at those <i>inline results</i>!
</p>


<p><img src="https://xenodium.com/images/inline-previous-result-and-why-you-should-edebug/edebug-inline.gif" alt="edebug-inline.gif" width="90%"/>
</p>
</div></div>
  </body>
</html>
