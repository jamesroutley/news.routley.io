<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/pgdogdev/pgdog">Original</a>
    <h1>Show HN: PgDog â€“ Shard Postgres without extensions</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text"><p dir="auto">
    <a target="_blank" rel="noopener noreferrer" href="https://github.com/pgdogdev/pgdog/blob/main/.github/logo2-white.png"><img src="https://github.com/pgdogdev/pgdog/raw/main/.github/logo2-white.png" height="128" width="auto"/></a>
</p>
<p dir="auto"><a href="https://github.com/levkk/pgdog/actions/workflows/ci.yml"><img src="https://github.com/levkk/pgdog/actions/workflows/ci.yml/badge.svg" alt="CI"/></a></p>
<p dir="auto">PgDog is a transaction pooler and logical replication manager that can shard PostgreSQL. Written in Rust, PgDog is fast, secure and can manage hundreds of databases and hundreds of thousands of connections.</p>

<p dir="auto">ðŸ“˜ PgDog documentation can be <strong><a href="https://docs.pgdog.dev/" rel="nofollow">found here</a></strong>. Any questions? Join our <strong><a href="https://discord.com/invite/CcBZkjSJdd" rel="nofollow">Discord</a></strong>.</p>


<p dir="auto">Helm chart is <strong><a href="https://github.com/pgdogdev/helm">here</a></strong>. To install it, run:</p>
<div dir="auto" data-snippet-clipboard-copy-content="git clone https://github.com/pgdogdev/helm &amp;&amp; \
cd helm &amp;&amp; \
helm install -f values.yaml pgdog ./"><pre>git clone https://github.com/pgdogdev/helm <span>&amp;&amp;</span> \
<span>cd</span> helm <span>&amp;&amp;</span> \
helm install -f values.yaml pgdog ./</pre></div>

<p dir="auto">You can try PgDog quickly using Docker. Install <a href="https://docs.docker.com/compose/" rel="nofollow">Docker Compose</a> and run:</p>

<p dir="auto">It will take a few minutes to build PgDog from source and launch the containers. Once started, you can connect to PgDog with psql (or any other PostgreSQL client):</p>
<div data-snippet-clipboard-copy-content="PGPASSWORD=postgres psql -h 127.0.0.1 -p 6432 -U postgres"><pre><code>PGPASSWORD=postgres psql -h 127.0.0.1 -p 6432 -U postgres
</code></pre></div>
<p dir="auto">The demo comes with 3 shards and 2 sharded tables:</p>
<div dir="auto" data-snippet-clipboard-copy-content="INSERT INTO users (id, email) VALUES (1, &#39;admin@acme.com&#39;);
INSERT INTO payments (id, user_id, amount) VALUES (1, 1, 100.0);

SELECT * FROM users WHERE id = 1;
SELECT * FROM payments WHERE user_id = 1;"><pre><span>INSERT INTO</span> users (id, email) <span>VALUES</span> (<span>1</span>, <span><span>&#39;</span>admin@acme.com<span>&#39;</span></span>);
<span>INSERT INTO</span> payments (id, user_id, amount) <span>VALUES</span> (<span>1</span>, <span>1</span>, <span>100</span>.<span>0</span>);

<span>SELECT</span> <span>*</span> <span>FROM</span> users <span>WHERE</span> id <span>=</span> <span>1</span>;
<span>SELECT</span> <span>*</span> <span>FROM</span> payments <span>WHERE</span> user_id <span>=</span> <span>1</span>;</pre></div>

<p dir="auto">PgDog exposes both the standard PgBouncer-style admin database and an OpenMetrics endpoint. The admin database isn&#39;t 100% compatible,
so we recommend you use OpenMetrics for monitoring. Example Datadog configuration and dashboard are <a href="https://github.com/pgdogdev/pgdog/blob/main/examples/datadog">included</a>.</p>


<p dir="auto">PgDog is an application layer (OSI Level 7) load balancer for PostgreSQL. It can proxy multiple replicas (and primary) and distribute transactions evenly between databases. It supports multiple strategies, including round robin, random, least active connections, etc. PgDog can also inspect queries and send <code>SELECT</code> queries to replicas, and all others to the primary. This allows to proxy all databases behind a single PgDog deployment.</p>
<p dir="auto">ðŸ“˜ <strong><a href="https://docs.pgdog.dev/features/load-balancer" rel="nofollow">Load balancer</a></strong></p>
<div dir="auto"><h4 tabindex="-1" dir="auto">Healthchecks and failover</h4><a id="user-content-healthchecks-and-failover" aria-label="Permalink: Healthchecks and failover" href="#healthchecks-and-failover"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">PgDog maintains a real-time list of healthy hosts. When a host fails a healthcheck, it&#39;s removed from active rotation and queries are rerouted to other databases. This is similar to HTTP load balancing, except it&#39;s at the database layer.</p>
<p dir="auto">Failover maximizes database availability and protects against bad network connections, temporary hardware failures or misconfiguration.</p>
<p dir="auto">ðŸ“˜ <strong><a href="https://docs.pgdog.dev/features/healthchecks" rel="nofollow">Healthchecks</a></strong></p>

<p dir="auto">Like PgBouncer, PgDog supports transaction (and session) pooling, allowing
100,000s of clients to use just a few PostgreSQL server connections.</p>
<p dir="auto">ðŸ“˜ <strong><a href="https://docs.pgdog.dev/features/transaction-mode" rel="nofollow">Transactions</a></strong></p>

<p dir="auto">PgDog is able to handle databases with multiple shards by routing queries automatically to one or more shards. Using the native PostgreSQL parser, PgDog understands queries, extracts sharding keys and determines the best routing strategy. For cross-shard queries, PgDog assembles results in memory and sends them all to the client transparently.</p>

<p dir="auto">PgDog comes with a CSV parser and can split COPY commands between all shards automatically. This allows clients to ingest data into sharded PostgreSQL without preprocessing.</p>

<p dir="auto">PgDog understands the PostgreSQL logical replication protocol and can split data between databases in the background and without downtime. This allows to shard existing databases and add more shards to existing clusters in production, without impacting database operations.</p>
<p dir="auto">ðŸ“˜ <strong><a href="https://docs.pgdog.dev/features/sharding/" rel="nofollow">Sharding</a></strong></p>

<p dir="auto">PgDog is highly configurable and many aspects of its operation can be tweaked at runtime, without having
to restart the process and break PostgreSQL connections. If you&#39;ve used PgBouncer (or PgCat) before, the options
will be familiar. If not, they are documented with examples.</p>


<p dir="auto">Install the latest version of the Rust compiler from <a href="https://rust-lang.org" rel="nofollow">rust-lang.org</a>.
Clone this repository and build the project in release mode:</p>

<p dir="auto">It&#39;s important to use the release profile if you&#39;re deploying to production or want to run
performance benchmarks.</p>

<p dir="auto">PgDog has two configuration files:</p>
<ul dir="auto">
<li><code>pgdog.toml</code> which contains general settings and PostgreSQL servers information</li>
<li><code>users.toml</code> for users and passwords</li>
</ul>
<p dir="auto">Most options have reasonable defaults, so a basic configuration for a single user
and database running on the same machine is pretty short:</p>
<p dir="auto"><strong><code>pgdog.toml</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="[general]
host = &#34;0.0.0.0&#34;
port = 6432

[[databases]]
name = &#34;pgdog&#34;
host = &#34;127.0.0.1&#34;"><pre>[<span>general</span>]
<span>host</span> = <span><span>&#34;</span>0.0.0.0<span>&#34;</span></span>
<span>port</span> = <span>6432</span>

[[<span>databases</span>]]
<span>name</span> = <span><span>&#34;</span>pgdog<span>&#34;</span></span>
<span>host</span> = <span><span>&#34;</span>127.0.0.1<span>&#34;</span></span></pre></div>
<p dir="auto"><strong><code>users.toml</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="[[users]]
name = &#34;pgdog&#34;
password = &#34;pgdog&#34;
database = &#34;pgdog&#34;"><pre>[[<span>users</span>]]
<span>name</span> = <span><span>&#34;</span>pgdog<span>&#34;</span></span>
<span>password</span> = <span><span>&#34;</span>pgdog<span>&#34;</span></span>
<span>database</span> = <span><span>&#34;</span>pgdog<span>&#34;</span></span></pre></div>
<p dir="auto">If you&#39;d like to try this out, you can set it up like so:</p>
<div data-snippet-clipboard-copy-content="CREATE DATABASE pgdog;
CREATE USER pgdog PASSWORD &#39;pgdog&#39; LOGIN;"><pre lang="postgresql"><code>CREATE DATABASE pgdog;
CREATE USER pgdog PASSWORD &#39;pgdog&#39; LOGIN;
</code></pre></div>

<p dir="auto">The configuration files for a sharded database are provided in the repository. To make it work locally, create the required databases:</p>
<div data-snippet-clipboard-copy-content="CREATE DATABASE shard_0;
CREATE DATABASE shard_1;

GRANT ALL ON DATABASE shard_0 TO pgdog;
GRANT ALL ON DATABASE shard_1 TO pgdog;"><pre lang="postgresql"><code>CREATE DATABASE shard_0;
CREATE DATABASE shard_1;

GRANT ALL ON DATABASE shard_0 TO pgdog;
GRANT ALL ON DATABASE shard_1 TO pgdog;
</code></pre></div>

<p dir="auto">Running PgDog can be done with Cargo:</p>

<p dir="auto">You can connect to PgDog with psql or any other PostgreSQL client:</p>
<div dir="auto" data-snippet-clipboard-copy-content="psql postgres://pgdog:pgdog@127.0.0.1:6432/pgdog"><pre>psql postgres://pgdog:pgdog@127.0.0.1:6432/pgdog</pre></div>

<p dir="auto">This project is just getting started and early adopters are welcome to try PgDog internally. Status on features stability will be <a href="https://docs.pgdog.dev/features/" rel="nofollow">updated regularly</a>. Most features have tests and are benchmarked regularly for performance regressions.</p>

<p dir="auto">PgDog does its best to minimize its impact on overall database performance. Using Rust and Tokio is a great start for a fast network proxy, but additional care is also taken to perform as few operations as possible while moving data between client and server sockets. Some benchmarks are provided to help set a baseline.</p>
<p dir="auto">ðŸ“˜ <strong><a href="https://docs.pgdog.dev/architecture/" rel="nofollow">Architecture &amp; benchmarks</a></strong></p>

<p dir="auto">PgDog is free and open source software, licensed under the AGPL v3. While often misunderstood, this license is very permissive
and allows the following without any additional requirements from you or your organization:</p>
<ul dir="auto">
<li>Internal use</li>
<li>Private modifications for internal use without sharing any source code</li>
</ul>
<p dir="auto">You can freely use PgDog to power your PostgreSQL databases without having to
share any source code, including proprietary work product or any PgDog modifications you make.</p>
<p dir="auto">AGPL was written specifically for organizations that offer PgDog <em>as a public service</em> (e.g. database cloud providers) and require
those organizations to share any modifications they make to PgDog, including new features and bug fixes.</p>

<p dir="auto">Please read our <a href="https://github.com/pgdogdev/pgdog/blob/main/CONTRIBUTING.md">Contribution Guidelines</a>.</p>
</article></div></div>
  </body>
</html>
