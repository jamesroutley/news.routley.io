<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://grayduck.mn/2024/11/21/handling-cookies-is-a-minefield/">Original</a>
    <h1>Handling cookies is a minefield</h1>
    
    <div id="readability-page-1" class="page"><div>
      <content>
  <article>

    <h2>Handling Cookies is a Minefield</h2>

    <p><time datetime="2024-11-21T10:00:00-06:00" pubdate="">Thursday, November 21, 2024</time>, in <a href="https://grayduck.mn/categories/#standards">Standards</a>
    </p>

    <div role="alert">
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"></path>
  <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"></path>
</svg><p> If you&#39;re mostly here to read about how things are broken, hop on down to <a href="#why-this-matters">why this matters</a>.
</p></div>

<p>HTTP cookies are a small piece of data set by either <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/cookie">Javascript</a> or HTTP servers, and which are essential for maintaining state on the otherwise stateless system known as the World Wide Web. Once set, web browsers will continue to forward them along for every properly scoped HTTP request until they expire.</p>
<p>I had been more than content to ignore the vagaries of how cookies function until the end of time, except that one day I stumbled across this innocuous piece of Javascript:</p>
<div><pre><span></span><code><span>const</span><span> </span><span>favoriteCookies</span><span> </span><span>=</span><span> </span><span>JSON</span><span>.</span><span>stringify</span><span>({</span>
<span>  </span><span>ginger</span><span>:</span><span> </span><span>&#34;snap&#34;</span><span>,</span>
<span>  </span><span>peanutButter</span><span>:</span><span> </span><span>&#34;chocolate chip&#34;</span><span>,</span>
<span>  </span><span>snicker</span><span>:</span><span> </span><span>&#34;doodle&#34;</span><span>,</span>
<span>});</span>

<span>document</span><span>.</span><span>cookie</span><span> </span><span>=</span><span> </span><span>` cookieNames=</span><span>${</span><span>favoriteCookies</span><span>}</span><span>`</span><span> </span><span>;</span>
</code></pre></div>

<p>This code functioned completely fine, as far as browsers were concerned. It took a piece of boring (but tasty) JSON and saved the value into a session cookie. While this was slightly unusual — most code will serialize JSON to base64 prior to setting them as a cookie, there was nothing here that browsers had any issue with. They happily allowed the cookie to be set and sent along to the backend web server in the HTTP header:</p>
<div><pre><span></span><code><span>GET</span> <span>/</span> <span>HTTP</span><span>/</span><span>1.1</span>
<span>Accept</span><span>:</span> <span>text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span>Accept-Encoding</span><span>:</span> <span>gzip, deflate</span>
<span>Accept-Language</span><span>:</span> <span>en-US,en;q=0.9</span>
<span>Connection</span><span>:</span> <span>keep-alive</span>
<span>Cookie</span><span>:</span> <span>cookieNames={&#34;ginger&#34;:&#34;snap&#34;,&#34;peanutButter&#34;:&#34;chocolate chip&#34;,&#34;snicker&#34;:&#34;doodle&#34;}</span>
<span>Host</span><span>:</span> <span>example.com</span>
</code></pre></div>

<p>Which was all well and good, until it got passed along to some code that used the <a href="https://pkg.go.dev/github.com/go-http-utils/cookie">Go standard library</a>. The Go standard library couldn&#39;t parse the cookie, leading to cascading failures all the way up the stack. So what happened?</p>
<h2>The Specification</h2>
<p>Cookies were initially defined in <a href="https://www.rfc-editor.org/rfc/rfc2109">RFC 2109</a> (1997), and subsequently updated in <a href="https://www.rfc-editor.org/rfc/rfc2965">RFC 2965</a> (2000) and <a href="https://www.rfc-editor.org/rfc/rfc6265">RFC 6265</a> (2011), with a <a href="https://httpwg.org/http-extensions/draft-ietf-httpbis-rfc6265bis.html">draft version</a> that is in the process of being updated (and is what this article uses).</p>
<p>There are two sections of the RFC that pertain to cookie values:</p>
<p><strong>Section 4.1.1</strong> <em>(on how servers should send cookies)</em></p>
<div><pre><span></span><code>Informally, the Set-Cookie response header field contains a cookie,
which begins with a name-value-pair, followed by zero or more
attribute-value pairs. Servers SHOULD NOT send Set-Cookie header
fields that fail to conform to the following grammar:

set-cookie        = set-cookie-string
set-cookie-string = BWS cookie-pair *( BWS &#34;;&#34; OWS cookie-av )
cookie-pair       = cookie-name BWS &#34;=&#34; BWS cookie-value
cookie-name       = 1*cookie-octet
cookie-value      = *cookie-octet / ( DQUOTE *cookie-octet DQUOTE )
cookie-octet      = %x21 / %x23-2B / %x2D-3A / %x3C-5B / %x5D-7E
                      ; US-ASCII characters excluding CTLs,
                      ; whitespace DQUOTE, comma, semicolon,
                      ; and backslash
</code></pre></div>

<p><strong>Section 5.6</strong> <em>(on how browsers should accept cookies)</em></p>
<div><pre><span></span><code>A user agent MUST use an algorithm equivalent to the following algorithm
to parse a set-cookie-string:

1. If the set-cookie-string contains a %x00-08 / %x0A-1F / %x7F character
   (CTL characters excluding HTAB):
     Abort these steps and ignore the set-cookie-string entirely.

2. If the set-cookie-string contains a %x3B (&#34;;&#34;) character:
   The name-value-pair string consists of the characters up to, but not
   including, the first %x3B (&#34;;&#34;), and the unparsed-attributes consist
   of the remainder of the set-cookie-string (including the %x3B (&#34;;&#34;)
   in question).

Otherwise:

1. The name-value-pair string consists of all the characters contained in
   the set-cookie-string, and the unparsed-attributes is the empty string.
</code></pre></div>

<p>There are three things that should immediately jump out to you:</p>
<ol>
<li>What servers <strong>SHOULD</strong> send and what browsers <strong>MUST</strong> accept are not aligned, a classic example of the <a href="https://datatracker.ietf.org/doc/html/draft-thomson-postel-was-wrong-03">tragedy of following Postel&#39;s Law</a>.</li>
<li>There is nothing here that limits what cookie values are acceptable for browsers to send to servers, aside from the semicolon delimiter. This might be fine if servers only received cookies they themselves had set, but cookies can also come from <code>document.cookie</code> and contain values outside the <code>%x21</code>, <code>%x23-2B</code>, <code>%x2D-3A</code>, <code>%x3C-5B</code>, and <code>%x5D-7E</code> characters as allowed by <code>Set-Cookie</code>.</li>
<li>It doesn&#39;t acknowledge how standard libraries that handle <code>Cookie</code> headers should behave: should they act like user agents or like servers? Should they be permissive or proscriptive? Should they behave differently in different contexts?</li>
</ol>
<p>And herein lies the very crux of the resulting issue I ran into: everything behaves differently, and it&#39;s a miracle that cookies work at all.</p>
<h2>Web Browsers</h2>
<p>First, let&#39;s start with how web browsers behave. The teams behind Gecko (Firefox), Chromium, and WebKit (Safari) work together constantly, so it would be reasonable to expect them to all behave the same… right?</p>
<p>Before we dig in, remember that the RFC contradictorily says that <code>Set-Cookie</code> headers may contain any ASCII character besides control characters, double quotes, commas, semicolons, and backslashes, but that browsers should accept any cookie value that does not contain control characters.</p>

<p>Firefox&#39;s <a href="https://searchfox.org/mozilla-central/source/netwerk/cookie/CookieCommons.cpp">code for valid cookie values</a> looks like this:</p>
<div><pre><span></span><code><span>bool</span><span> </span><span>CookieCommons</span><span>::</span><span>CheckValue</span><span>(</span><span>const</span><span> </span><span>CookieStruct</span><span>&amp;</span><span> </span><span>aCookieData</span><span>)</span><span> </span><span>{</span>
<span>  </span><span>//</span><span> </span><span>reject</span><span> </span><span>cookie</span><span> </span><span>if</span><span> </span><span>value</span><span> </span><span>contains</span><span> </span><span>an</span><span> </span><span>RFC</span><span> </span><span>6265</span><span> </span><span>disallowed</span><span> </span><span>character</span><span> </span><span>-</span><span> </span><span>see</span>
<span>  </span><span>//</span><span> </span><span>https</span><span>:</span><span>//</span><span>bugzilla</span><span>.</span><span>mozilla</span><span>.</span><span>org</span><span>/</span><span>show_bug</span><span>.</span><span>cgi</span><span>?</span><span>id</span><span>=</span><span>1191423</span>
<span>  </span><span>//</span><span> </span><span>NOTE</span><span>:</span><span> </span><span>this</span><span> </span><span>is</span><span> </span><span>not</span><span> </span><span>the</span><span> </span><span>full</span><span> </span><span>set</span><span> </span><span>of</span><span> </span><span>characters</span><span> </span><span>disallowed</span><span> </span><span>by</span><span> </span><span>6265</span><span> </span><span>-</span><span> </span><span>notably</span>
<span>  </span><span>//</span><span> </span><span>0x09</span><span>,</span><span> </span><span>0x20</span><span>,</span><span> </span><span>0x22</span><span>,</span><span> </span><span>0x2C</span><span>,</span><span> </span><span>and</span><span> </span><span>0x5C</span><span> </span><span>are</span><span> </span><span>missing</span><span> </span><span>from</span><span> </span><span>this</span><span> </span><span>list</span><span>.</span>
<span>  </span><span>const</span><span> </span><span>char</span><span> </span><span>illegalCharacters</span><span>[]</span><span> </span><span>=</span><span> </span><span>{</span>
<span>      </span><span>0x01</span><span>,</span><span> </span><span>0x02</span><span>,</span><span> </span><span>0x03</span><span>,</span><span> </span><span>0x04</span><span>,</span><span> </span><span>0x05</span><span>,</span><span> </span><span>0x06</span><span>,</span><span> </span><span>0x07</span><span>,</span><span> </span><span>0x08</span><span>,</span><span> </span><span>0x0A</span><span>,</span><span> </span><span>0x0B</span><span>,</span><span> </span><span>0x0C</span><span>,</span>
<span>      </span><span>0x0D</span><span>,</span><span> </span><span>0x0E</span><span>,</span><span> </span><span>0x0F</span><span>,</span><span> </span><span>0x10</span><span>,</span><span> </span><span>0x11</span><span>,</span><span> </span><span>0x12</span><span>,</span><span> </span><span>0x13</span><span>,</span><span> </span><span>0x14</span><span>,</span><span> </span><span>0x15</span><span>,</span><span> </span><span>0x16</span><span>,</span><span> </span><span>0x17</span><span>,</span>
<span>      </span><span>0x18</span><span>,</span><span> </span><span>0x19</span><span>,</span><span> </span><span>0x1A</span><span>,</span><span> </span><span>0x1B</span><span>,</span><span> </span><span>0x1C</span><span>,</span><span> </span><span>0x1D</span><span>,</span><span> </span><span>0x1E</span><span>,</span><span> </span><span>0x1F</span><span>,</span><span> </span><span>0x3B</span><span>,</span><span> </span><span>0x7F</span><span>,</span><span> </span><span>0x00</span><span>};</span>

<span>  </span><span>const</span><span> </span><span>auto</span><span>*</span><span> </span><span>start</span><span> </span><span>=</span><span> </span><span>aCookieData</span><span>.</span><span>value</span><span>()</span><span>.</span><span>BeginReading</span><span>();</span>
<span>  </span><span>const</span><span> </span><span>auto</span><span>*</span><span> </span><span>end</span><span> </span><span>=</span><span> </span><span>aCookieData</span><span>.</span><span>value</span><span>()</span><span>.</span><span>EndReading</span><span>();</span>

<span>  </span><span>auto</span><span> </span><span>charFilter</span><span> </span><span>=</span><span> </span><span>[</span><span>&amp;</span><span>](</span><span>unsigned</span><span> </span><span>char</span><span> </span><span>c</span><span>)</span><span> </span><span>{</span>
<span>    </span><span>if</span><span> </span><span>(</span><span>StaticPrefs</span><span>::</span><span>network_cookie_blockUnicode</span><span>()</span><span> </span><span>&amp;&amp;</span><span> </span><span>c</span><span> </span><span>&gt;=</span><span> </span><span>0x80</span><span>)</span><span> </span><span>{</span>
<span>      </span><span>return</span><span> </span><span>true</span><span>;</span>
<span>    </span><span>}</span>
<span>    </span><span>return</span><span> </span><span>std</span><span>::</span><span>find</span><span>(</span><span>std</span><span>::</span><span>begin</span><span>(</span><span>illegalCharacters</span><span>),</span><span> </span><span>std</span><span>::</span><span>end</span><span>(</span><span>illegalCharacters</span><span>),</span>
<span>                     </span><span>c</span><span>)</span><span> </span><span>!=</span><span> </span><span>std</span><span>::</span><span>end</span><span>(</span><span>illegalCharacters</span><span>);</span>
<span>  </span><span>};</span>

<span>  </span><span>return</span><span> </span><span>std</span><span>::</span><span>find_if</span><span>(</span><span>start</span><span>,</span><span> </span><span>end</span><span>,</span><span> </span><span>charFilter</span><span>)</span><span> </span><span>==</span><span> </span><span>end</span><span>;</span>
<span>}</span>
</code></pre></div>

<figure><figcaption>†accepting <code>0x7F</code> was fixed in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1797235">bug 1797235</a> (Firefox 108)</figcaption></figure>

<p>Firefox accepts five characters which RFC recommends that servers not send:</p>
<ul>
<li><code>0x09</code> (horizontal tab)</li>
<li><code>0x20</code> (spaces)</li>
<li><code>0x22</code> (double quotes)</li>
<li><code>0x2C</code> (commas)</li>
<li><code>0x5C</code> (backslashes)</li>
</ul>
<p>This was initially done to <a href="https://hg.mozilla.org/mozilla-central/annotate/02b7641683b049e8ba551d04318a5d985f36e504/netwerk/cookie/CookieCommons.cpp#l210">provide parity with Chrome</a> in some long-ago era and lingers on in both codebases.</p>
<p>Astute observers might note that Firefox has a <code>network.cookie.blockUnicode</code> setting that this code checks against, and which rejects all values above <code>0x80</code>. That groundwork was laid as a result of this research and can be tracked in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1797231">bug 1797231</a>.</p>

<p>The Chromium <a href="https://source.chromium.org/chromium/chromium/src/+/main:net/cookies/parsed_cookie.cc">code for valid cookie values</a> looks like so:</p>
<div><pre><span></span><code><span>bool</span><span> </span><span>ParsedCookie::IsValidCookieValue</span><span>(</span><span>const</span><span> </span><span>std</span><span>::</span><span>string</span><span>&amp;</span><span> </span><span>value</span><span>)</span><span> </span><span>{</span>
<span>  </span><span>// IsValidCookieValue() returns whether a string matches the following</span>
<span>  </span><span>// grammar:</span>
<span>  </span><span>//</span>
<span>  </span><span>// cookie-value       = *cookie-value-octet</span>
<span>  </span><span>// cookie-value-octet = %x20-3A / %x3C-7E / %x80-FF</span>
<span>  </span><span>//                       ; octets excluding CTLs and &#34;;&#34;</span>
<span>  </span><span>//</span>
<span>  </span><span>// This can be used to determine whether cookie values contain any invalid</span>
<span>  </span><span>// characters.</span>
<span>  </span><span>//</span>
<span>  </span><span>// Note that RFC6265bis section 4.1.1 suggests a stricter grammar for</span>
<span>  </span><span>// parsing cookie values, but we choose to allow a wider range of characters</span>
<span>  </span><span>// than what&#39;s allowed by that grammar (while still conforming to the</span>
<span>  </span><span>// requirements of the parsing algorithm defined in section 5.2).</span>
<span>  </span><span>//</span>
<span>  </span><span>// For reference, see:</span>
<span>  </span><span>//  - https://crbug.com/238041</span>
<span>  </span><span>for</span><span> </span><span>(</span><span>char</span><span> </span><span>i</span><span> </span><span>:</span><span> </span><span>value</span><span>)</span><span> </span><span>{</span>
<span>    </span><span>if</span><span> </span><span>(</span><span>HttpUtil</span><span>::</span><span>IsControlChar</span><span>(</span><span>i</span><span>)</span><span> </span><span>||</span><span> </span><span>i</span><span> </span><span>==</span><span> </span><span>&#39;;&#39;</span><span>)</span>
<span>      </span><span>return</span><span> </span><span>false</span><span>;</span>
<span>  </span><span>}</span>
<span>  </span><span>return</span><span> </span><span>true</span><span>;</span>
<span>}</span>

<span>// Whether the character is a control character (CTL) as defined in RFC 5234</span>
<span>// Appendix B.1.</span>
<span>static</span><span> </span><span>inline</span><span> </span><span>bool</span><span> </span><span>IsControlChar</span><span>(</span><span>char</span><span> </span><span>c</span><span>)</span><span> </span><span>{</span>
<span>  </span><span>return</span><span> </span><span>(</span><span>c</span><span> </span><span>&gt;=</span><span> </span><span>0x00</span><span> </span><span>&amp;&amp;</span><span> </span><span>c</span><span> </span><span>&lt;=</span><span> </span><span>0x1F</span><span>)</span><span> </span><span>||</span><span> </span><span>c</span><span> </span><span>==</span><span> </span><span>0x7F</span><span>;</span>
<span>}</span>
</code></pre></div>

<p>Chrome is slightly more restrictive than Firefox, refusing to accept the <code>0x09</code> (horizontal tab) in its cookie values.</p>
<p>Nevertheless (and contrary to the RFC), it is perfectly happy to receive and send spaces, double quotes, commas, backslashes, and unicode characters.</p>

<p>I&#39;m not able to get access to the code for cookie storage, as it is buried inside the closed source <code>CFNetwork</code>. That said, we can nevertheless examine its internals by running this piece of Javascript:</p>
<div><pre><span></span><code><span>for</span><span> </span><span>(</span><span>i</span><span>=</span><span>0</span><span>;</span><span> </span><span>i</span><span>&lt;</span><span>256</span><span>;</span><span> </span><span>i</span><span>++</span><span>)</span><span> </span><span>{</span>
<span>  </span><span>let</span><span> </span><span>paddedIndex</span><span> </span><span>=</span><span> </span><span>i</span><span>.</span><span>toString</span><span>().</span><span>padStart</span><span>(</span><span>3</span><span>,</span><span> </span><span>&#39;0&#39;</span><span>)</span><span> </span><span>+</span>
<span>    </span><span>&#39;_&#39;</span><span> </span><span>+</span><span> </span><span>&#39;0x&#39;</span><span> </span><span>+</span><span> </span><span>i</span><span>.</span><span>toString</span><span>(</span><span>16</span><span>).</span><span>padStart</span><span>(</span><span>2</span><span>,</span><span> </span><span>&#39;0&#39;</span><span>);</span>

<span>  </span><span>// set a cookie with name of &#34;cookie&#34; + decimal char + hex char</span>
<span>  </span><span>// and a value of the character surrounded by a space and two dashes</span>
<span>  </span><span>document</span><span>.</span><span>cookie</span><span>=</span><span>` cookie</span><span>${</span><span>paddedIndex</span><span>}</span><span>=-- </span><span>${</span><span>String</span><span>.</span><span>fromCharCode</span><span>(</span><span>i</span><span>)</span><span>}</span><span> --`</span><span> </span><span>;</span>
<span>}</span>

<span>document</span><span>.</span><span>cookie</span><span>=</span><span>&#39;cookieUnicode=🍪&#39;</span><span>;</span>

<span>:::</span><span>text</span>
<span>cookie007_0x07</span><span>   </span><span>--</span><span>           </span><span>localhost</span><span>   </span><span>/</span><span>   </span><span>Session</span><span>   </span><span>16</span><span> </span><span>B</span>
<span>cookie008_0x08</span><span>   </span><span>--</span><span>           </span><span>localhost</span><span>   </span><span>/</span><span>   </span><span>Session</span><span>   </span><span>16</span><span> </span><span>B</span>
<span>cookie009_0x09</span><span>   </span><span>--</span><span>      </span><span>--</span><span>   </span><span>localhost</span><span>   </span><span>/</span><span>   </span><span>Session</span><span>   </span><span>21</span><span> </span><span>B</span>
<span>cookie010_0x0a</span><span>   </span><span>--</span><span>           </span><span>localhost</span><span>   </span><span>/</span><span>   </span><span>Session</span><span>   </span><span>16</span><span> </span><span>B</span>
<span>cookie011_0x0b</span><span>   </span><span>--</span><span>           </span><span>localhost</span><span>   </span><span>/</span><span>   </span><span>Session</span><span>   </span><span>16</span><span> </span><span>B</span>
<span>                   </span><span>(</span><span>snip</span><span> </span><span>for</span><span> </span><span>brevity</span><span>)</span>
<span>cookie030_0x1e</span><span>   </span><span>--</span><span>           </span><span>localhost</span><span>   </span><span>/</span><span>   </span><span>Session</span><span>   </span><span>16</span><span> </span><span>B</span>
<span>cookie031_0x1f</span><span>   </span><span>--</span><span>           </span><span>localhost</span><span>   </span><span>/</span><span>   </span><span>Session</span><span>   </span><span>16</span><span> </span><span>B</span>
<span>cookie032_0x20</span><span>   </span><span>--</span><span>   </span><span>--</span><span>      </span><span>localhost</span><span>   </span><span>/</span><span>   </span><span>Session</span><span>   </span><span>21</span><span> </span><span>B</span>
<span>cookie033_0x21</span><span>   </span><span>--</span><span> </span><span>!</span><span> </span><span>--</span><span>      </span><span>localhost</span><span>   </span><span>/</span><span>   </span><span>Session</span><span>   </span><span>21</span><span> </span><span>B</span>
<span>cookie034_0x22</span><span>   </span><span>--</span><span> </span><span>&#34;</span><span> </span><span>--</span><span>      </span><span>localhost</span><span>   </span><span>/</span><span>   </span><span>Session</span><span>   </span><span>21</span><span> </span><span>B</span>
<span>cookie035_0x23</span><span>   </span><span>--</span><span> </span><span>#</span><span> </span><span>--</span><span>      </span><span>localhost</span><span>   </span><span>/</span><span>   </span><span>Session</span><span>   </span><span>21</span><span> </span><span>B</span>
<span>                   </span><span>(</span><span>snip</span><span> </span><span>for</span><span> </span><span>brevity</span><span>)</span>
<span>cookie042_0x2a</span><span>   </span><span>--</span><span> </span><span>*</span><span> </span><span>--</span><span>      </span><span>localhost</span><span>   </span><span>/</span><span>   </span><span>Session</span><span>   </span><span>21</span><span> </span><span>B</span>
<span>cookie043_0x2b</span><span>   </span><span>--</span><span> </span><span>+</span><span> </span><span>--</span><span>      </span><span>localhost</span><span>   </span><span>/</span><span>   </span><span>Session</span><span>   </span><span>21</span><span> </span><span>B</span>
<span>cookie044_0x2c</span><span>   </span><span>--</span><span>,</span><span>--</span><span>        </span><span>localhost</span><span>   </span><span>/</span><span>   </span><span>Session</span><span>   </span><span>19</span><span> </span><span>B</span>
<span>                   </span><span>(</span><span>snip</span><span> </span><span>for</span><span> </span><span>brevity</span><span>)</span>
<span>cookie044_0x5c</span><span>   </span><span>--</span><span> </span><span>\</span><span> </span><span>--</span><span>          </span><span>localhost</span><span>   </span><span>/</span><span>   </span><span>Session</span><span>   </span><span>19</span><span> </span><span>B</span>
</code></pre></div>

<p>As Safari stops processing a cookie once it sees a disallowed character, it&#39;s easy to see that <code>0x09</code> (horizontal tab), <code>0x20</code> (space), <code>0x22</code> (double quote), and <code>0x5C</code> (backslash) are okay, but <code>0x7F</code> (delete), <code>0x80-FF</code> (high ASCII / Unicode) characters are disallowed.</p>
<p>Unlike Firefox and Chrome which follow the instructions in the RFC to <em>“abort these steps and ignore the cookie entirely”</em> when encountering a cookie with a control character, Safari does not ignore the cookie but instead accepts the cookie value for everything up until that character.</p>
<p>Oddly enough, this quest has uncovered a bizarre Safari bug — setting a cookie with a value of <code>-- , --</code> seems to result in it trimming the whitespace around the comma.</p>
<h2>Standard Libraries</h2>
<p><strong>Golang</strong></p>
<p>Let&#39;s start with <a href="https://cs.opensource.google/go/go/+/master:src/net/http/cookie.go">Golang&#39;s cookie code</a>, which is where I ran into the problem in the first place.</p>
<div><pre><span></span><code><span>// sanitizeCookieValue produces a suitable cookie-value from v.</span>
<span>// https://tools.ietf.org/html/rfc6265#section-4.1.1</span>
<span>//</span>
<span>// We loosen this as spaces and commas are common in cookie values</span>
<span>// but we produce a quoted cookie-value if and only if v contains</span>
<span>// commas or spaces.</span>
<span>// See https://golang.org/issue/7243 for the discussion.</span>
<span>func</span><span> </span><span>sanitizeCookieValue</span><span>(</span><span>v</span><span> </span><span>string</span><span>)</span><span> </span><span>string</span><span> </span><span>{</span>
<span>    </span><span>v</span><span> </span><span>=</span><span> </span><span>sanitizeOrWarn</span><span>(</span><span>&#34;Cookie.Value&#34;</span><span>,</span><span> </span><span>validCookieValueByte</span><span>,</span><span> </span><span>v</span><span>)</span>
<span>    </span><span>if</span><span> </span><span>len</span><span>(</span><span>v</span><span>)</span><span> </span><span>==</span><span> </span><span>0</span><span> </span><span>{</span>
<span>        </span><span>return</span><span> </span><span>v</span>
<span>    </span><span>}</span>
<span>    </span><span>if</span><span> </span><span>strings</span><span>.</span><span>ContainsAny</span><span>(</span><span>v</span><span>,</span><span> </span><span>&#34; ,&#34;</span><span>)</span><span> </span><span>{</span>
<span>        </span><span>return</span><span> </span><span>`&#34;`</span><span> </span><span>+</span><span> </span><span>v</span><span> </span><span>+</span><span> </span><span>`&#34;`</span>
<span>    </span><span>}</span>
<span>    </span><span>return</span><span> </span><span>v</span>
<span>}</span>

<span>func</span><span> </span><span>validCookieValueByte</span><span>(</span><span>b</span><span> </span><span>byte</span><span>)</span><span> </span><span>bool</span><span> </span><span>{</span>
<span>    </span><span>return</span><span> </span><span>0x20</span><span> </span><span>&lt;=</span><span> </span><span>b</span><span> </span><span>&amp;&amp;</span><span> </span><span>b</span><span> </span><span>&lt;</span><span> </span><span>0x7f</span><span> </span><span>&amp;&amp;</span><span> </span><span>b</span><span> </span><span>!=</span><span> </span><span>&#39;&#34;&#39;</span><span> </span><span>&amp;&amp;</span><span> </span><span>b</span><span> </span><span>!=</span><span> </span><span>&#39;;&#39;</span><span> </span><span>&amp;&amp;</span><span> </span><span>b</span><span> </span><span>!=</span><span> </span><span>&#39;\\&#39;</span>
<span>}</span>
</code></pre></div>

<p>Golang falls relatively close to what the RFC&#39;s wording on how servers should behave with <code>Set-Cookie</code>, only differing by allowing <code>0x20</code> (space) and <code>0x2C</code> (comma) due to them <a href="https://golang.org/issue/7243">commonly occurring</a> in the wild.</p>
<p>You can already see the struggles that programming languages have to deal with — they have to both receive values from browsers in line with Section 5, but also send cookies as per Section 4.1.1.</p>
<p>This can have pretty serious consequences, as you can see from running <a href="https://go.dev/play/p/6UX3Beem2Go">this code</a>:</p>
<div><pre><span></span><code><span>package</span><span> </span><span>main</span>

<span>import</span><span> </span><span>(</span>
<span>  </span><span>&#34;fmt&#34;</span>
<span>  </span><span>&#34;net/http&#34;</span>
<span>)</span>

<span>func</span><span> </span><span>main</span><span>()</span><span> </span><span>{</span>
<span>  </span><span>rawCookies</span><span> </span><span>:=</span>
<span>    </span><span>` cookie1=foo; `</span><span> </span><span>+</span>
<span>    </span><span>` cookie2={&#34;ginger&#34;:&#34;snap&#34;,&#34;peanutButter&#34;:&#34;chocolate chip&#34;,&#34;snicker&#34;:&#34;doodle&#34;}; `</span><span> </span><span>+</span>
<span>    </span><span>` cookie3=bar`</span>

<span>    </span><span>header</span><span> </span><span>:=</span><span> </span><span>http</span><span>.</span><span>Header</span><span>{}</span>
<span>    </span><span>header</span><span>.</span><span>Add</span><span>(</span><span>&#34;Cookie&#34;</span><span>,</span><span> </span><span>rawCookies</span><span>)</span>
<span>    </span><span>request</span><span> </span><span>:=</span><span> </span><span>http</span><span>.</span><span>Request</span><span>{</span><span>Header</span><span>:</span><span> </span><span>header</span><span>}</span>

<span>    </span><span>fmt</span><span>.</span><span>Println</span><span>(</span><span>request</span><span>.</span><span>Cookies</span><span>())</span>
<span>}</span>
</code></pre></div>

<p>Which outputs only:</p>
<div><pre><span></span><code><span>[</span><span>cookie1</span><span>=</span><span>foo</span><span> </span><span>cookie3</span><span>=</span><span>bar</span><span>]</span>
</code></pre></div>

<p>Invisibly dropping a cookie that all major browsers accept, without any sort of exception to the effect that this is happening. Still, dropping a cookie it didn&#39;t understand without any other side effects isn&#39;t as bad as it could be.</p>

<p>Many languages, such as PHP, don&#39;t have native functions for parsing cookies, which makes it somewhat difficult to definitively say what it allows and does not allow.</p>
<p>That said, we can set cookies using the code below and see how PHP responds:</p>
<div><pre><span></span><code><span>[</span><span>0x09</span><span>,</span><span> </span><span>0x0D</span><span>,</span><span> </span><span>0x10</span><span>,</span><span> </span><span>0x20</span><span>,</span><span> </span><span>0x22</span><span>,</span><span> </span><span>0x2C</span><span>,</span><span> </span><span>0x5C</span><span>,</span><span> </span><span>0x7F</span><span>,</span><span> </span><span>0xFF</span><span>].</span><span>forEach</span><span>(</span><span>i</span><span> </span><span>=&gt;</span><span> </span><span>{</span>
<span>  </span><span>let</span><span> </span><span>paddedIndex</span><span> </span><span>=</span><span> </span><span>i</span><span>.</span><span>toString</span><span>().</span><span>padStart</span><span>(</span><span>3</span><span>,</span><span> </span><span>&#39;0&#39;</span><span>)</span><span> </span><span>+</span><span> </span><span>&#39;_&#39;</span><span> </span><span>+</span>
<span>    </span><span>&#39;0x&#39;</span><span> </span><span>+</span><span> </span><span>i</span><span>.</span><span>toString</span><span>(</span><span>16</span><span>).</span><span>padStart</span><span>(</span><span>2</span><span>,</span><span> </span><span>&#39;0&#39;</span><span>);</span>

<span>  </span><span>document</span><span>.</span><span>cookie</span><span>=</span><span>` cookie</span><span>${</span><span>paddedIndex</span><span>}</span><span>=-- </span><span>${</span><span>String</span><span>.</span><span>fromCharCode</span><span>(</span><span>i</span><span>)</span><span>}</span><span> --`</span><span> </span><span>;</span>
<span>});</span>

<span>document</span><span>.</span><span>cookie</span><span>=</span><span>&#39;cookieUnicode=🍪&#39;</span><span>;</span>
</code></pre></div>

<p>Output:</p>
<div><pre><span></span><code>cookie009_0x09: -- --
cookie009_0x10: -- --
cookie009_0x0d: -- --
cookie032_0x20: -- --
cookie034_0x22: -- &#34; --
cookie044_0x2c: -- , --
cookie092_0x5c: -- \ --
cookie255_0x7f: -- --
cookie255_0xff: -- ÿ --
cookieUnicode: 🍪
</code></pre></div>

<p>When it comes to control characters, PHP&#39;s behavior is all over the place. <code>0x00-0x09</code> all work fine, as do things like <code>0x0D</code> (carriage return), but if you use <code>0x10</code> (data link escape) or <code>0x7F</code> (delete), PHP will completely error out with a <strong>400 Bad Request</strong> error.</p>

<div><pre><span></span><code><span>import</span> <span>http.cookies</span>

<span>raw_cookies</span> <span>=</span> <span>(</span>
    <span>&#39;cookie1=foo; &#39;</span>
    <span>&#39;cookie2={&#34;ginger&#34;:&#34;snap&#34;,&#34;peanutButter&#34;:&#34;chocolate chip&#34;,&#34;snicker&#34;:&#34;doodle&#34;}; &#39;</span>
    <span>&#39;cookie3=bar&#39;</span>
<span>)</span>

<span>c</span> <span>=</span> <span>http</span><span>.</span><span>cookies</span><span>.</span><span>SimpleCookie</span><span>()</span>
<span>c</span><span>.</span><span>load</span><span>(</span><span>raw_cookies</span><span>)</span>

<span>print</span><span>(</span><span>c</span><span>)</span>
</code></pre></div>

<p>Output:</p>
<div><pre><span></span><code>&gt;&gt;&gt; Set-Cookie: cookie1=foo
</code></pre></div>

<p>Python invisibly aborts the loading of additional cookies inside <code>SimpleCookie.load()</code> as soon as it encounters one it doesn&#39;t understand. This can be very dangerous when you consider that a subdomain could feasibly set a cookie on the base domain which would completely break all cookies for all domains of a given site.</p>
<p>It&#39;s even messier it comes to control characters:</p>
<div><pre><span></span><code><span>import</span> <span>http.cookies</span>

<span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>0</span><span>,</span> <span>32</span><span>):</span>
    <span>raw_cookie</span> <span>=</span> <span>f</span><span>&#34;cookie</span><span>{</span><span>hex</span><span>(</span><span>i</span><span>)</span><span>}</span><span>=</span><span>{</span><span>chr</span><span>(</span><span>i</span><span>)</span><span>}</span><span>&#34;</span>

    <span>c</span> <span>=</span> <span>http</span><span>.</span><span>cookies</span><span>.</span><span>SimpleCookie</span><span>()</span>
    <span>c</span><span>.</span><span>load</span><span>(</span><span>raw_cookie</span><span>)</span>

    <span>for</span> <span>name</span><span>,</span> <span>morsel</span> <span>in</span> <span>c</span><span>.</span><span>items</span><span>():</span>
        <span>print</span><span>(</span><span>f</span><span>&#34;</span><span>{</span><span>name</span><span>}</span><span>: value: </span><span>{</span><span>repr</span><span>(</span><span>morsel</span><span>.</span><span>value</span><span>)</span><span>}</span><span>, length: </span><span>{</span><span>len</span><span>(</span><span>morsel</span><span>.</span><span>value</span><span>)</span><span>}</span><span>&#34;</span><span>)</span>
</code></pre></div>

<p>Output:</p>
<div><pre><span></span><code>&gt;&gt;&gt; cookie0x9: value: &#39;&#39;, length: 0
&gt;&gt;&gt; cookie0xa: value: &#39;&#39;, length: 0
&gt;&gt;&gt; cookie0xb: value: &#39;&#39;, length: 0
&gt;&gt;&gt; cookie0xc: value: &#39;&#39;, length: 0
&gt;&gt;&gt; cookie0xd: value: &#39;&#39;, length: 0
</code></pre></div>

<p>Here we can see that Python invisibly drops a lot of cookies with control characters, and loads others improperly. Note that if you guard those values with something like:</p>
<div><pre><span></span><code><span>raw_cookie</span> <span>=</span> <span>f</span><span>&#34;cookie</span><span>{</span><span>hex</span><span>(</span><span>i</span><span>)</span><span>}</span><span>=aa</span><span>{</span><span>chr</span><span>(</span><span>i</span><span>)</span><span>}</span><span>aa&#34;</span>
</code></pre></div>

<p>Then none of the control character cookies will load. Overall, Python is extremely inconsistent and unpredictable in its behavior when it comes to loading cookies.</p>

<div><pre><span></span><code><span>require</span><span> </span><span>&#34;cgi&#34;</span>

<span>raw_cookie</span><span> </span><span>=</span><span> </span><span>&#39;ginger=snap; &#39;</span><span> </span><span>+</span>
<span>&#34;cookie=chocolate </span><span>\x13</span><span> </span><span>\t</span><span> </span><span>\&#34;</span><span> , </span><span>\\</span><span> </span><span>\x7f</span><span> 🍪 chip; &#34;</span><span> </span><span>+</span>
<span>&#39;snicker=doodle&#39;</span>

<span>cookies</span><span> </span><span>=</span><span> </span><span>CGI</span><span>::</span><span>Cookie</span><span>.</span><span>parse</span><span>(</span><span>raw_cookie</span><span>)</span>

<span>puts</span><span> </span><span>cookies</span>
<span>puts</span><span> </span><span>cookies</span><span>[</span><span>&#34;cookie&#34;</span><span>].</span><span>value</span><span>()</span>
<span>puts</span><span> </span><span>cookies</span><span>[</span><span>&#34;cookie&#34;</span><span>].</span><span>value</span><span>()</span><span>.</span><span>to_s</span><span>()</span>
</code></pre></div>

<p>Output:</p>
<div><pre><span></span><code>{&#34;ginger&#34;=&gt;#&lt;CGI::Cookie: &#34;ginger=snap; path=&#34;&gt;, &#34;cookie&#34;=&gt;#&lt;CGI::Cookie: &#34;cookie=chocolate+%13+%09+%22+%2C+%5C+%7F+%F0%9F%8D%AA+chip; path=&#34;&gt;, &#34;snicker&#34;=&gt;#&lt;CGI::Cookie: &#34;snicker=doodle; path=&#34;&gt;}
chocolate    &#34; , \  🍪 chip
cookie=chocolate+%13+%09+%22+%2C+%5C+%7F+%F0%9F%8D%AA+chip; path=
</code></pre></div>

<p>The Ruby library appears pretty permissive, seeming to accept every character during parsing and then <a href="https://developer.mozilla.org/en-US/docs/Glossary/percent-encoding">percent-encoding</a> it when being pulled from the cookie jar.</p>
<p>This may well be the optimal behavior (if such a thing can be said to exist with cookies), but I can certainly see cases where code setting a cookie via <code>document.cookie</code> would not expect to see it reflected back in percent-encoded form.</p>

<div><pre><span></span><code><span>use</span><span> </span><span>cookie</span>::<span>Cookie</span><span>;</span>

<span>fn</span> <span>main</span><span>()</span><span> </span><span>{</span>
<span>    </span><span>let</span><span> </span><span>c</span><span> </span><span>=</span><span> </span><span>Cookie</span>::<span>parse</span><span>(</span><span>&#34;cookie=chocolate , </span><span>\&#34;</span><span> </span><span>\t</span><span> foo </span><span>\x13</span><span> ñ 🍪 chip;&#34;</span><span>).</span><span>unwrap</span><span>();</span>
<span>    </span><span>println!</span><span>(</span><span>&#34;{:?}&#34;</span><span>,</span><span> </span><span>c</span><span>.</span><span>name_value</span><span>());</span>
<span>}</span>
</code></pre></div>

<p>Output:</p>
<div><pre><span></span><code>(&#34;cookie&#34;, &#34;chocolate , \&#34; \t foo \u{13} ñ 🍪 chip&#34;)
</code></pre></div>

<p>Rust doesn&#39;t ship any cookie handling facilities by default, so this is looking at the popular <code>cookie</code> crate. As configured by default, it appears to be the most permissive of the programming languages, accepting any UTF-8 string tossed at it.</p>

<h2>The World Wide Web, aka Why This Matters</h2>
<p>The wildly differing behavior between browsers and languages certainly makes for some <a href="#summary-table">riveting tables</a>, but how does all this play out in the real world?</p>
<p>When I first discovered this in the real world, it was only through sheer luck that it wasn&#39;t a catastrophe. A manual tester was playing around with a third-party library update and had run into a strange set of errors on our testing site. Without bringing it to my attention, this update — doing something unlikely to be caught in automated testing — would have certainly been pushed to production. As a result, every future website visitor would have received a broken cookie and been locked out with an inscrutable error until the update was reverted and the cookies were cleared out.</p>
<p>And that&#39;s exactly the problem with this specification ambiguity — it&#39;s such an easy mistake to make that millions of websites and companies are only an intern away from a complete meltdown. And it doesn&#39;t only affect tiny websites on obscure frameworks, as major websites such as Facebook, Netflix, WhatsApp, and Apple are affected.</p>
<p>You can see for yourself how easy of a mistake this is to make by pasting this simple code fragment into your browser console, substituting <code>.grayduck.mn</code> for the domain you&#39;re testing, e.g. <code>.facebook.com</code>:</p>
<div><pre><span></span><code><span>document</span><span>.</span><span>cookie</span><span>=</span><span>&#34;unicodeCookie=🍪; domain=.grayduck.mn; Path=/; SameSite=Lax&#34;</span>
</code></pre></div>

<p>websites hate this one weird trick</p>

<p><strong>Facebook</strong></p>
<figure><img src="https://grayduck.mn/2024/11/21/handling-cookies-is-a-minefield/facebook.jpg"/><figcaption>facebook error page has images the cookie also breaks</figcaption></figure>

<p><strong>Instagram &amp; Threads</strong></p>
<figure><img src="https://grayduck.mn/2024/11/21/handling-cookies-is-a-minefield/instagram.jpg"/><figcaption>instagram produces this spartan 500 error</figcaption></figure>
<figure><img src="https://grayduck.mn/2024/11/21/handling-cookies-is-a-minefield/threads.jpg"/><figcaption>no surprise that threads is much the same</figcaption></figure>

<p><strong>Netflix</strong></p>
<figure><img src="https://grayduck.mn/2024/11/21/handling-cookies-is-a-minefield/netflix.jpg"/><figcaption>netflix returns a NSES-500 error</figcaption></figure>
<figure><img src="https://grayduck.mn/2024/11/21/handling-cookies-is-a-minefield/netflix-help.jpg"/><figcaption>and unfortunately the help page is broken too</figcaption></figure>

<p><strong>Okta</strong></p>
<figure><img src="https://grayduck.mn/2024/11/21/handling-cookies-is-a-minefield/okta.jpg"/><figcaption>every okta login page returns a 400 error</figcaption></figure>

<p><strong>WhatsApp</strong></p>
<figure><img src="https://grayduck.mn/2024/11/21/handling-cookies-is-a-minefield/whatsapp.png"/><figcaption>whatsapp&#39;s descriptively named “whatsapp error”</figcaption></figure>

<p><strong>Amazon</strong></p>
<figure><img src="https://grayduck.mn/2024/11/21/handling-cookies-is-a-minefield/amazon-ratings.jpg"/><figcaption>most parts of amazon work, but pieces of it are randomly broken</figcaption></figure>

<p><strong>Amazon Web Services</strong></p>
<figure><img src="https://grayduck.mn/2024/11/21/handling-cookies-is-a-minefield/aws-login.jpg"/><figcaption>the AWS login console returns a 400 error and crashes out</figcaption></figure>

<p><strong>Apple Support</strong></p>
<figure><img src="https://grayduck.mn/2024/11/21/handling-cookies-is-a-minefield/apple-support.jpg"/><figcaption>apple support is unable to load your devices</figcaption></figure>

<p><strong>Best Buy</strong></p>
<figure><img src="https://grayduck.mn/2024/11/21/handling-cookies-is-a-minefield/bestbuy.jpg"/><figcaption>navigation works, but the search functionality does not</figcaption></figure>

<p><strong>eBay</strong></p>
<figure><img src="https://grayduck.mn/2024/11/21/handling-cookies-is-a-minefield/ebay.jpg"/><figcaption>mostly fixed, but pieces of eBay still error out with a 400 error</figcaption></figure>

<p><strong>Home Depot</strong></p>
<figure><img src="https://grayduck.mn/2024/11/21/handling-cookies-is-a-minefield/homedepot.jpg"/><figcaption>home depot will be fixing it</figcaption></figure>

<p><strong>Intuit</strong></p>
<figure><img src="https://grayduck.mn/2024/11/21/handling-cookies-is-a-minefield/intuit.jpg"/><figcaption>intuit was the only site to identify the cause of the error</figcaption></figure>

<p><strong>Outlook</strong></p>
<figure><img src="https://grayduck.mn/2024/11/21/handling-cookies-is-a-minefield/outlook.jpg"/><figcaption>another 400 error shows how systematic the problem is</figcaption></figure>

<h3>How do we fix this?</h3>
<p>It&#39;s probably not much of a surprise that fixing problems in 30-year-old foundational specifications is really, <em>really</em> hard. And for this problem, it&#39;s unlikely that there is a good fix.</p>
<p>Blocking these cookies on the browser side was considered and worked on by both Mozilla and Google:</p>
<ul>
<li>Mozilla: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1797235">bug 1797235</a> aka <a href="https://nvd.nist.gov/vuln/detail/cve-2023-5723">CVE-2023-5723</a>, and <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1797231">bug 1797231</a></li>
<li>Google: <a href="https://issues.chromium.org/issues/40061459#comment24">bug 40061459</a></li>
</ul>
<p>But it turns out unilateral blocking is quite complicated because while non-ASCII cookies aren&#39;t super common overall, affecting only a bit under 0.01% of all cookies, telemetry has found they are <a href="https://issues.chromium.org/issues/40061459#comment24">considerably more common</a> in countries like Argentina, Mexico, and Finland. While Mozilla did implement a preference that could be toggled quickly (<code>network.cookie.blockUnicode</code>), it hasn&#39;t been enabled due to behavioral compatibility issues with Chromium.</p>
<p>Fixing it on the server-side is potentially feasible, but it affects millions of websites and most of the errors caused by this problem are buried deep in programming languages and web frameworks. It might be possible for places like Facebook and Netflix to mitigate the issue, but the average website operator is not going to have the time or ability to resolve the issue.</p>
<p>In truth, the true fix for this issue almost certainly lies in the <a href="https://httpwg.org/">IETF HTTP Working Group</a> updating the cookie specification to both align with itself and to be strict on how systems handling cookies should behave. Whether non-ASCII characters should be allowed should be identical regardless of whether server-side or on user agents.</p>
<p>And regardless, the steps around how browsers, programming languages, and frameworks should handle cookie processing need to be explicit, in much the way that modern W3C standards such as <a href="https://www.w3.org/TR/CSP3/#html-integration">Content Security Policy</a> do. Aborting the processing of other cookies because one cookie is malformed is unacceptable when such behavior can lead to a wide variety of unexpected behavior.</p>
<p>These processing steps should probably look like something like:</p>
<div><pre><span></span><code>• Start with field-value
• Split on ; and ,, giving list of &#34;raw-cookie-pair&#34;. Comma is NOT treated a synonym for semicolon in order to support combining headers, despite RFC7230 section 3.2.2.

For each raw-cookie-pair:
  ◦ If the pair does not contain =, then skip to next raw-cookie-pair
  ◦ Remove leading and trailing whitespace
  ◦ Treat portion before first = as cookie-name-octets
  ◦ Treat portion after first = as cookie-value-octets
  ◦ If cookie-value-octets starts with DQUOTE, then:
    ‣ Remove one DQUOTE at start
    ‣ Remove one DQUOTE at end, if present
  ◦ If resulting cookie-name-octets, cookie-value-octets, or both are unacceptable to server, then skip to next raw-cookie-pair
  ◦ Process resulting [cookie-name-octets, cookie-value-octets] tuple in server defined manner

Servers SHOULD further process cookie-name-octets and reject any tuple where the cookie-name-octets are not a token.  Servers SHOULD further process and cookie-value-octets and reject any tuple where cookie-value-octets contains octets not in cookie-octet.
</code></pre></div>


<h3>Summary Table</h3>
<div>
    <table id="cookie-table-summary">
        <thead>
            <tr>
                <th></th>
                <th>CTLs<sup>1</sup></th>
                <th>htab</th>
                <th>space</th>
                <th>dquote</th>
                <th>comma</th>
                <th>backslash</th>
                <th>delete</th>
                <th>0x80-FF</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><a href="https://httpwg.org/http-extensions/draft-ietf-httpbis-rfc6265bis.html#name-set-cookie">RFC 6235 (Section 4.1.1)</a></td>
                <td>No</td>
                <td>No</td>
                <td>No</td>
                <td>No</td>
                <td>No</td>
                <td>No</td>
                <td>No</td>
                <td>No</td>
            </tr>
                <tr><td><a href="https://httpwg.org/http-extensions/draft-ietf-httpbis-rfc6265bis.html#name-the-set-cookie-header-field">RFC 6265 (Section 5.6)</a></td>
                <td>No</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>No</td>
                <td>??</td>
            </tr>
            <tr><td colspan="9"></td></tr>
            
                <tr><td>Firefox</td>
                <td>No<sup>2</sup></td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
            </tr>
            
                <tr><td>Chromium</td>
                <td>No</td>
                <td>No</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>No</td>
                <td>Yes</td>
            </tr>
            
                <tr><td>Safari</td>
                <td>No<sup>3</sup></td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes<sup>4</sup></td>
                <td>Yes</td>
                <td>No</td>
                <td>No</td>
            </tr>
            <tr><td colspan="9"></td></tr>
            
                <tr><td>Golang</td>
                <td>??</td>
                <td>No</td>
                <td>Yes</td>
                <td>No</td>
                <td>Yes</td>
                <td>No</td>
                <td>No</td>
                <td>No</td>
            </tr>
            
                <tr><td>Python</td>
                <td>Yes<sup>5</sup></td>
                <td>No</td>
                <td>No</td>
                <td>No</td>
                <td>Yes</td>
                <td>No</td>
                <td>No</td>
                <td>No</td>
            </tr>
            <tr>
                <td>Ruby (CGI)</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
            </tr>
            <tr>
                <td>Rust</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
                <td>Yes</td>
            </tr>
        </tbody>
    </table>
</div>

<ol>
<li>not as defined as in <a href="https://www.rfc-editor.org/rfc/rfc5234">RFC 5234</a>, but instead as <code>\x00-08</code> and <code>\x0A-x1F</code> (e.g. CTLs minus htab and delete)</li>
<li>Mozilla <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1797235">stopped allowing CTLs</a> in <code>document.cookie</code> as of Firefox 108</li>
<li>does not abort processing and ignore the cookie as the RFC requires</li>
<li>seems to remove whitespace around commas in some conditions</li>
<li>sometimes allows <code>0x0A-0D</code> but fails to store them in the cookie value, aborts at other times</li>
</ol>
<h3>Thanks</h3>
<p>I couldn&#39;t have written this article without a bunch of help along the way. I&#39;d like to thank:</p>
<ul>
<li>Po-Ning Tseng, for helping me investigate this issue in the first place</li>
<li>Dan Veditz at Mozilla, for his inexhaustible knowledge and endless kindness</li>
<li><a href="https://frederikbraun.de/">Frederik Braun</a>, for his helpful early feedback</li>
<li>Steven Bingler at Google, for pushing on getting this issue fixed</li>
<li>Peter Bowen, for his thoughts on how cookie processing probably should happen</li>
<li>Chris Palmer and David Schinazi, for their insightful proofreading</li>
<li>Stefan Bühler, who stumbled across some of this stuff <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=858215">over a decade ago</a></li>
<li>kibwen on HackerNews, for pointing out the Rust crate situation</li>
</ul>

    <p>
    [Category: <a href="http://tinylogger.com/categories/#Standards">Standards</a>]
    [Tags: <a href="https://grayduck.mn/tags/#browser">Browser</a>, <a href="https://grayduck.mn/tags/#programming">Programming</a>, <a href="https://grayduck.mn/tags/#security">Security</a>]
    </p>

  </article>

      </content>
  </div></div>
  </body>
</html>
