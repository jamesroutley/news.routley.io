<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://labs.quansight.org/blog/dataframe-group-by">Original</a>
    <h1>Non-elementary group-by aggregations in Polars vs pandas</h1>
    
    <div id="readability-page-1" class="page"><div>

<p>I attended PyData Berlin 2024 in April, and it was a blast! I met so many colleagues, collaborators, and friends.
There was quite some talk of Polars - some people even gathered together for a Polars-themed dinner!
It&#39;s certainly nice to see people talking about it, and the focus tends to be on features such as:</p>
<ul>
<li>lazy execution</li>
<li>Rust</li>
<li>consistent handling of null values</li>
<li>multithreading</li>
<li>query optimisation</li>
</ul>
<p>Yet there&#39;s one innovation which barely ever gets a mention: non-elementary group-by aggregations.</p>
<p>I&#39;ll start by introducing the group-by operation. We&#39;ll then take a look at elementary aggregations
with both the pandas and Polars APIs. Finally, we&#39;ll look at non-elementary aggregations, and see
how the Polars API enables so much more than the pandas one.</p>
<h2 id="whats-a-group-by">What&#39;s a group-by?</h2>
<p>Suppose we start with a (Polars) dataframe such as:</p>
<div data-ch-theme="solarized-dark"></div>
<p>A group-by operation produces a single row per group:</p>
<div data-ch-theme="solarized-dark"></div>
<div data-ch-theme="solarized-dark"></div>
<p>If we want a single scalar value per group, we can use a reduction (&#39;mean&#39;, &#39;sum&#39;, &#39;std&#39;, ...):</p>
<div data-ch-theme="solarized-dark"></div>
<div data-ch-theme="solarized-dark"></div>
<h3 id="group-by-in-pandas">Group-by in pandas</h3>
<p>If you&#39;re coming from a pandas-like library, you may have been used to writing the above example as</p>
<div data-ch-theme="solarized-dark"></div>
<p>And indeed, for such a simple task as this one, the pandas API is quite nice. All we had to do was:</p>
<ol>
<li>select which columns we&#39;re grouping by</li>
<li>select the column(s) we want to aggregate</li>
<li>specify an elementary aggregation function</li>
</ol>
<p>Let&#39;s try something else: &#34;find the maximum value of &#39;views&#39;, where &#39;sales&#39; is greater than its mean, per
&#39;id&#39;&#34;.</p>
<p>Unfortunately, the pandas API has no way to express this, meaning
that no library which copies the pandas API can truly optimise such an
operation in the general case.</p>
<p>You might be wondering whether we can just do the following:</p>
<div data-ch-theme="solarized-dark"></div>
<p>However, that uses a Python <code>lambda</code> function and so is generally going to be inefficient.</p>
<p>Another solution one might come up with is this one:</p>
<div data-ch-theme="solarized-dark"></div>
<p>It&#39;s not as bad as the <code>apply</code> solution above, but it still looks overly complicated and requires
two group-bys.</p>
<p>There&#39;s actually a third solution, which:</p>
<ul>
<li>relies on <code>GroupBy</code> caching its groups</li>
<li>performs in-place mutation of the original dataframe</li>
<li>uses the fact that <code>&#39;max&#39;</code> skips over missing values</li>
</ul>
<p>Realistically, few users would come up with it (most would jump straight to <code>apply</code>), but for
completeness, we present it:</p>
<div data-ch-theme="solarized-dark"></div>
<p>Surely it&#39;s possible to do better?</p>
<h2 id="non-elementary-group-bys-in-polars">Non-elementary group-bys in Polars</h2>
<p>The Polars API lets us pass <a href="https://docs.pola.rs/user-guide/expressions/">expressions</a> to <code>GroupBy.agg</code>.
So long as you can express your aggregation as
an expression, you can use it in a group-by setting. In this case, we can express &#34;the maximum value
of &#39;views&#39; where &#39;sales&#39; is greater than its mean&#34; as</p>
<div data-ch-theme="solarized-dark"></div>
<p>Then, all we need to do is pass this expression to <code>GroupBy.agg</code>:</p>
<div data-ch-theme="solarized-dark"></div>
<p>Wonderful! Like this, we can express the operation cleanly and without hacks, meaning that any dataframe
implementation which follows the Polars API has the possibility to evaluate this efficiently.</p>

<p>We&#39;ve learned about the group-by operation, elementary aggregations in both pandas and Polars, and how
Polars&#39; syntax enables users to cleanly express non-elementary aggregations.</p>
<p>pandas is a wonderful tool which solves a lot of real problems for a lot of real people.
However, when new dataframe libraries insist on copying its API, they are stunting their own potential.
If an API doesn&#39;t allow for an operation to be expressed and users end up using <code>apply</code> with custom
Python lambda functions, then no amount of acceleration is going to make up for that.</p>
<p>On the other hand, innovation on the API side can enable new possibilities. There&#39;s a reason
that</p>
<blockquote>
<p>I came for the speed, but stayed for the syntax</p>
</blockquote>
<p>is a common refrain among Polars users.</p>
<p>If you&#39;d like to learn about how to use Polars effectively, or how to solve problems in your organisation
using Polars, Quansight is here to help - <a href="https://quansight.com/about-us/#bookacallform">please get in touch</a> -
we&#39;d love to hear from you.</p></div></div>
  </body>
</html>
