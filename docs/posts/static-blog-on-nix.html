<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.scannedinavian.com/static-blog-on-nix.html">Original</a>
    <h1>Static blog on Nix</h1>
    
    <div id="readability-page-1" class="page"><div id="content">
	    
	    <p>
    Posted on 2024-04-15
    
</p>

<p><img src="https://www.scannedinavian.com/images/brynslustafirA.png"/></p>
<p>NixOS, yay! Nix causes me so frustration, and I’m so happy when it works!</p>
<p>I’ve been idly fixing my NixOS server, and now it’s all working. I can quickly and easily push up blog posts, w00t!</p>

<p>One thing Nix does well is fetching an already finished result from a cache.</p>
<p>I wanted to do something similar by locally building my static blog on my beefy laptop and then pushing only the result to my wimpy rented server.</p>
<p>I already had a configuration.nix file describing everything on my virtual private server, and I wanted the root of my website to be described in another file.</p>
<p>I ended up with this stanza:</p>
<div id="cb1"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>virtualHosts = <span>{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span>&#34;</span>scannedinavian.com<span>&#34;</span> <span>=</span> <span>{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span>enableACME</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span>forceSSL</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span>root</span> <span>=</span> <span>&#34;</span><span>${</span>pkgs.callPackage <span>./shaesite.nix</span> <span>{}</span> <span>}</span><span>/dist&#34;</span><span>;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span>};</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span>}</span>;</span></code></pre></div>
<p>This is nifty because the result of the <code>shaesite.nix</code> is substituted in as the contents of the root directory of the webserver.</p>
<p>The contents of shaesite.nix are:</p>
<div id="cb2"><pre><code><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span>{</span> <span>fetchFromGitHub</span><span>}</span>:</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span>let</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span>src</span> <span>=</span> fetchFromGitHub <span>{</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span>owner</span> <span>=</span> <span>&#34;shapr&#34;</span><span>;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span>repo</span> <span>=</span> <span>&#34;hakyll-nix-something&#34;</span><span>;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span>rev</span> <span>=</span> <span>&#34;e14b0c3bba59e33ca3157d0f460e1193f0886d9b&#34;</span><span>;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span>sha256</span> <span>=</span> <span>&#34;13n6zzcgb51zx21vmlsm4s7jy6lf863zm08wdj3inffpfq3g75mp&#34;</span><span>;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span># date = &#34;2024-04-15T14:59:06-04:00&#34;;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a> <span>};</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span>wrappedFlake</span> <span>=</span> <span>import</span> <span>&#34;</span><span>${</span>src<span>}</span><span>&#34;</span><span>;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span>in</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>wrappedFlake.outputs.packages.x86_64<span>-</span>linux.website</span></code></pre></div>

<p>This is how I deploy my blog: <code>nixos-rebuild switch -I nixpkgs=/home/shae/build/nixpkgs -I nixos-config=./configuration.nix --target-host root@surtr.scannedinavian.com</code></p>
<p>That says the system configuration is in a file in this directory called <code>./configuration.nix</code> and the result will be pushed to <code>root@surtr.scannedinavian.com</code></p>
<p>I’m explicitly pointing nixpkgs to a local checkout because this all worked great when I was running NixOS 22.11 locally and on the server, and it didn’t work at all when I upgraded my laptop from NixOS 22.11 to NixOS 23.05.</p>
<p>I finally figured out that this command looks in the environment for the value of nixpkgs, and I hadn’t upgraded my server!</p>
<p>Because this didn’t match, nixos-rebuild tried to copy up so much stuff that my server ran out of disk space, it was a huge mess that took me days to track down.</p>
<p>This got especially interesting because the symptom I saw was “can’t deploy blog, server doesn’t have enough space”.</p>
<p>My first thought was that I had somehow changed the build to include all of the build tools instead of only the result.</p>
<p>This led to a fun digression into learning about <a href="https://github.com/utdemir/nix-tree">nix-tree</a> for investigating dependencies in a closure, and also led me to getting help from <a href="https://mastodon.social/@puffnfresh">Brian McKenna</a> on how to convert a system configuration into a result that can be inspected.</p>
<p>I ended up checking out a local copy of nixpkgs 22.11 and explicitly pointing the build command to that nixpkgs.</p>
<p>Pinning dependencies is exactly the use case for Nix flakes, and that’s one of my next steps for improving this, switch to flakes!</p>

<p>Last week I changed the value of the git hash in the <code>rev</code> value but I didn’t get a new result for my website, nothing was built. What was happening?</p>
<p>Turns out I needed to change the sha256 value as well, otherwise nix assumes the hash matches the existing result and nothing is built.</p>
<p>I swapped two of the characters in the sha256, started a rebuild, and nix would complain that the hash was wrong, and tell me the correct value. Then I would copy in the correct value.</p>
<p>I kinda consider this a bug, I wish nix would keep track of the git hash and sha256 hash pair.</p>

<p>I got tired of the extra steps and wanted to use John Wiegley’s <a href="https://github.com/jwiegley/nix-update-el">nix-update.el</a> to magically update the hash for me.
After some confusion and debugging, I had to add <code>nix-prefetch-git</code> to my system packages, and move the point to <strong>before</strong> the fetchFromGitHub, then it worked!</p>

<p>I don’t like the extra steps of finding the git revision of my blog repository after making changes, maybe I’ll move the whole thing into the same repo with the system configuration?</p>
<p>Like I said before, I also want to move this to a flake.</p>

	</div></div>
  </body>
</html>
