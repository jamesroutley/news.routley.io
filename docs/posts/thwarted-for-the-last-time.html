<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mclare.blog/posts/thwarted-for-the-last-time">Original</a>
    <h1>Thwarted for the last time!</h1>
    
    <div id="readability-page-1" class="page"><div id="observablehq-main">
<p>I can always tell when I haven&#39;t written a blog in a while, because inevitably on running <code>gatsby develop</code>, I will get a pile of inscrutable errors (despite not touching anything for months).</p>
<pre data-language="shell"><code>⠋ compile gatsby files
node(52176,0x1709bf000) malloc: Incorrect checksum for freed object 0x12110aa00: probably modified after being freed.
Corrupt value: 0x0
node(52176,0x170dcb000) malloc: Incorrect checksum for freed object 0x1221f8400: probably modified after being freed.
Corrupt value: 0x0
node(52176,0x1709bf000) malloc: *** set a breakpoint in malloc_error_break to debug
⠦ compile gatsby files
</code></pre>
<p><em>When you&#39;re getting memory allocation errors on npm start, it&#39;s time to step away from the computer</em></p>
<p>Well that ends today (I hope).</p>
<p>Part of my issue was that I was using a custom <code>mdx</code> fork of <a href="https://github.com/alxshelepenok/gatsby-starter-lumen" target="_blank" rel="noopener noreferrer">gatsby-starter-lumen</a>, which is a theme that doesn&#39;t seem to be maintained anymore. What&#39;s worse, <code>mdx</code> support in <a href="https://www.gatsbyjs.com/" target="_blank" rel="noopener noreferrer">Gatsby</a> also seems to be.... less than great. The current <a href="https://github.com/gatsbyjs/gatsby/issues/38928" target="_blank" rel="noopener noreferrer">solution</a> to the inevitable <code>npm i</code> dependency hell is to pass <code>--legacy-peer-deps</code> when using <code>gatsby-plugin-mdx</code>, which seems broken for an officially supported mode (that you toggle on when you start a new Gatsby project!)</p>
<p>I&#39;d chosen Gatsby/MDX initially because I work with React on a daily basis, and I wanted to include Observable Notebook components in blog posts (and there was a nice little <a href="https://observablehq.com/documentation/embeds/how-to-embed-a-notebook-in-a-react-app" target="_blank" rel="noopener noreferrer">export function</a> you could run to achieve this). I did this in a <a href="https://mclare.blog/posts/is-the-structural-engineering-profession-growing/" target="_blank" rel="noopener noreferrer">few</a> <a href="https://mclare.blog/posts/from-structural-to-software/" target="_blank" rel="noopener noreferrer">places</a> for some interactive visualizations, which suited my blogging style. However, the Gatsby headache kept mounting, introducing additional friction to something that I <em>should</em> enjoy doing, and <em>should</em> be much more seamless. (I spend enough time debugging React for $$; it&#39;s not something I want to do in my free time).</p>
<h2 id="the-approach" tabindex="-1"><a href="#the-approach">The Approach</a></h2>
<p>I started with the <a href="https://observablehq.com/framework/getting-started" target="_blank" rel="noopener noreferrer">recommended create script</a>:</p>
<pre data-language="shell"><code>npx @observablehq/framework@latest create
</code></pre>
<h2 id="markdown-files" tabindex="-1"><a href="#markdown-files">Markdown Files</a></h2>
<p>Since many of my blog posts were already in boring markdown, I just dumped the directories from gatsby into my <code>src</code> directory to see what would happen.</p>
<pre><code>/Users/mclare/
  ── workspaces/
      └── mclare-blog/
         ├── dist/
         └── posts/
            └── 2020-09-18---Building-Blender-As-A-Python-module
         
</code></pre>
<p>Posts with <code>.md</code> extensions were immediately navigable and viewable at <code>/posts/2020-09-18---Building-Blender-As-A-Python-module</code>. I needed to adjust the paths on the image files, but that was the only main change needed to the files.</p>
<p>However, Gatsby had previously processed these directories to automatically appear at a nicer slug like <code>/posts/building-blender-as-a-python-module</code>, so I ended up just bulk renaming the directories to match their slugs in the frontmatter rather than finding a similar workaround.</p>
<h2 id="mdx-files" tabindex="-1"><a href="#mdx-files">MDX Files</a></h2>
<p>The posts that were in <code>.mdx</code> had the aforementioned Observable/React components. Importing and calling them in a mdx file looked something like this:</p>
<pre data-language="md"><code>import {
  SoftwareEngineerInterviews,
  WeekByWeekInterviews,
  GroupedInterviewType,
} from &#34;./observable/softwareInterview.js&#34;;

<span><span>&lt;<span>SoftwareEngineerInterviews</span> /&gt;</span></span>
</code></pre>
<p>Observable has a helpful <a href="https://observablehq.com/framework/convert" target="_blank" rel="noopener noreferrer">guide</a> for converting notebooks, so that&#39;s what I used as a reference here. I can definitely go back and clean up the code at this point (possibly make these into components), but it worked as is with a few tweaks. I removed the small amount of React I was using to just have pure D3 in the JS cells.</p>
<h2 id="sorting-pages" tabindex="-1"><a href="#sorting-pages">Sorting Pages</a></h2>
<p>It&#39;s a bit confusing to figure out where to troubleshoot things with Observable Framework, as it appears most folks have moved to <a href="https://github.com/observablehq/framework/discussions" target="_blank" rel="noopener noreferrer">GitHub discussions</a> rather than the previous iteration on <a href="https://talk.observablehq.com/" target="_blank" rel="noopener noreferrer">Observable Talk</a>. However, it turns out that there&#39;s an enthusiastic group in the Observable community already tackling the problem of <a href="https://github.com/observablehq/framework/discussions/1199" target="_blank" rel="noopener noreferrer">blogging with Observable Framework</a>. I was able to adapt a <code>load-posts.js</code> <a href="https://github.com/observablehq/framework/discussions/1199#discussioncomment-10738633" target="_blank" rel="noopener noreferrer">script</a> from <a href="https://github.com/jamesking" target="_blank" rel="noopener noreferrer">James King</a> to automatically update my sidebar pages within my home page and at <code>/posts</code> in descending date order thanks to the existing <code>date</code> field on the front matter:</p>
<pre data-language="js"><code><span>import</span> fs <span>from</span> <span>&#34;fs&#34;</span>;
<span>import</span> path <span>from</span> <span>&#34;path&#34;</span>;
<span>import</span> matter <span>from</span> <span>&#34;gray-matter&#34;</span>;
<span>import</span> { fileURLToPath } <span>from</span> <span>&#34;url&#34;</span>;
<span>import</span> { dirname } <span>from</span> <span>&#34;path&#34;</span>;


<span>const</span> __filename = <span>fileURLToPath</span>(<span>import</span>.<span>meta</span>.<span>url</span>);
<span>const</span> __dirname = <span>dirname</span>(__filename);


<span>const</span> postsDirectory = path.<span>join</span>(__dirname, <span>&#34;..&#34;</span>, <span>&#34;src&#34;</span>, <span>&#34;posts&#34;</span>);


<span>function</span> <span>loadMarkdownFiles</span>(<span></span>) {
  <span>const</span> postFolders = fs
    .<span>readdirSync</span>(postsDirectory, { <span>withFileTypes</span>: <span>true</span> })
    .<span>filter</span>(<span>(<span>dirent</span>) =&gt;</span> dirent.<span>isDirectory</span>())
    .<span>map</span>(<span>(<span>dirent</span>) =&gt;</span> dirent.<span>name</span>);

  <span>const</span> postsData = postFolders
    .<span>map</span>(<span>(<span>folder</span>) =&gt;</span> {
      <span>const</span> fullPath = path.<span>join</span>(postsDirectory, folder, <span>&#34;index.md&#34;</span>);

      <span>try</span> {
        <span>const</span> fileContent = fs.<span>readFileSync</span>(fullPath, <span>&#34;utf8&#34;</span>);

        
        <span>const</span> { <span>data</span>: frontMatter, content } = <span>matter</span>(fileContent);

        <span>return</span> {
          <span>slug</span>: folder,
          frontMatter,
          <span>fileName</span>: folder,
          content,
        };
      } <span>catch</span> (error) {
        <span>console</span>.<span>warn</span>(
          <span>`Warning: Could not read file for post &#34;<span>${folder}</span>&#34;. Skipping this post.`</span>
        );
        <span>return</span> <span>null</span>;
      }
    })
    .<span>filter</span>(<span>(<span>post</span>) =&gt;</span> post !== <span>null</span>)
    .<span>filter</span>(<span>(<span>post</span>) =&gt;</span> post?.<span>frontMatter</span>?.<span>draft</span> !== <span>true</span>)
    .<span>filter</span>(<span>(<span>post</span>) =&gt;</span> post?.<span>frontMatter</span>?.<span>title</span> !== <span>undefined</span>);

  <span>const</span> outputData = postsData.<span>sort</span>(<span>(<span>a, b</span>) =&gt;</span> {
    <span>const</span> dateA = <span>new</span> <span>Date</span>(a.<span>frontMatter</span>.<span>date</span>);
    <span>const</span> dateB = <span>new</span> <span>Date</span>(b.<span>frontMatter</span>.<span>date</span>);
    <span>return</span> dateB - dateA; 
  });

  <span>return</span> outputData;
}


<span>const</span> posts = <span>loadMarkdownFiles</span>();
<span>export</span> <span>default</span> posts;

</code></pre>
<h2 id="css" tabindex="-1"><a href="#css">CSS</a></h2>
<p>The lumen theme used CSS modules and <a href="https://sass-lang.com/" target="_blank" rel="noopener noreferrer">Sass</a>. I think it&#39;s likely that Observable will at some point support CSS modules (it might already, tbh), but I&#39;ll doubt they&#39;ll go in on all the different CSS management frameworks. I ended up using a lot of <code>sass ${lumen-dir} ${framework-dir}</code> to extract all the CSS I needed to get the same feel in my post feed and posts themselves, and just dumped the results into a <code>style.css</code> at the root of the project as per <a href="https://observablehq.com/framework/config#style" target="_blank" rel="noopener noreferrer">the Observable instructions</a>. I also did some not so great things with the page loader to get the right DOM structure for a custom sidebar on the home page that I&#39;d like to clean up later (there are definitely some layout issues).</p>
<h3 id="before-gatsby" tabindex="-1"><a href="#before-gatsby">Before (Gatsby)</a></h3>
<p><img src="https://mclare.blog/_file/posts/thwarted-for-the-last-time/media/gatsby_homepage.724666ab.png" alt="Gatsby Home Page"/></p>
<h3 id="after-observable-framework" tabindex="-1"><a href="#after-observable-framework">After (Observable Framework)</a></h3>
<p><img src="https://mclare.blog/_file/posts/thwarted-for-the-last-time/media/of_homepage.16c1520b.png" alt="Observable Framework Home Page"/></p>

<p>Turns out in addition to solving the page listing problem, James King has already also tackled the <a href="https://github.com/observablehq/framework/discussions/1199#discussioncomment-10878796" target="_blank" rel="noopener noreferrer">RSS feed issue</a>. I had a few minor modifications due to differences in how we structured our directories, but this was pretty straightforward to add and then run post build.</p>
<h2 id="future-work" tabindex="-1"><a href="#future-work">Future Work</a></h2>
<h3 id="things-that-are-currently-missing" tabindex="-1"><a href="#things-that-are-currently-missing">Things that are currently missing:</a></h3>
<ul>
<li>Avatar (sad things happened with images when I tried to directly copy the node into html)</li>
<li>Tags pages</li>
<li>Categories pages</li>
<li>pagination on these pages and others (currently the home page and <code>/posts</code> just have a full link list)</li>
<li>fixing the favicon (minor)</li>
</ul>
<h3 id="things-i-need-a-better-way-of-handling" tabindex="-1"><a href="#things-i-need-a-better-way-of-handling">Things I need a better way of handling:</a></h3>
<ul>
<li>All the css (I have a single style file :grimace:) - hoping I can figure out how to use CSS modules (if not SASS, which is what my Gatsby theme used)</li>
<li>Footers. I&#39;m currently abusing CSS to hide the next entry button on the home page. I&#39;d like to not be doing that.</li>
<li>html &#34;components&#34;. Again, this is a time/search thing based on direct mapping from the Gatsby theme. I was able to shove the DOM hierarchy and styles I needed into my <a href="https://observablehq.com/framework/page-loaders" target="_blank" rel="noopener noreferrer">page loader</a> (and I need to better understand what exactly I can do with these loaders)</li>
</ul>
<h3 id="things-i-ll-probably-omit" tabindex="-1"><a href="#things-i-ll-probably-omit">Things I&#39;ll probably omit:</a></h3>
<ul>
<li>Comments. I&#39;m a woman in tech; ain&#39;t nobody got time for that.</li>
</ul>
<h3 id="new-features-i-m-liking" tabindex="-1"><a href="#new-features-i-m-liking">New features I&#39;m liking:</a></h3>
<ul>
<li>Built in post navigation
<img src="https://mclare.blog/_file/posts/thwarted-for-the-last-time/media/post_nav.10b7f6cc.png" alt="Post navigation"/></li>
</ul>
<p>What I&#39;m most excited about with this approach is that I&#39;ll be able to update some of my visualizations automatically via data loaders to maintain current data. It would be particularly interesting to have a live view on my <a href="https://mclare.dev/soft-stories/" target="_blank" rel="noopener noreferrer">Los Angeles&#39; Soft Story Retrofits</a> and the previous work I did on tracking <a href="https://mclare.blog/posts/is-the-structural-engineering-profession-growing/" target="_blank" rel="noopener noreferrer">structural engineering licensure</a>.</p>
<p>Onwards and upwards!</p>
</div></div>
  </body>
</html>
