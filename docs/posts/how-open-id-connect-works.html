<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.digger.dev/how-open-id-connect-works-illustrated/">Original</a>
    <h1>How Open ID Connect Works</h1>
    
    <div id="readability-page-1" class="page"><div id="site-main">
<article>

    <header>

        

        


        <div>
        <section>

            <ul>
                <li>
                    <a href="https://blog.digger.dev/author/mohamed/">
                        <img src="https://blog.digger.dev/content/images/size/w100/2022/03/WhatsApp-Image-2020-11-08-at-20.17.24.jpeg" alt="Mohamed Habib"/>
                    </a>
                </li>
            </ul>

            <div>
                
                <p><time datetime="2024-01-04">Jan 4, 2024</time>
                        <span><span>•</span> 3 min read</span>
                </p>
            </div>

        </section>
        </div>

            <figure>
                <img srcset="/content/images/size/w300/2024/01/Screenshot-2024-01-04-at-21.19.33.png 300w,
                            /content/images/size/w600/2024/01/Screenshot-2024-01-04-at-21.19.33.png 600w,
                            /content/images/size/w1000/2024/01/Screenshot-2024-01-04-at-21.19.33.png 1000w,
                            /content/images/size/w2000/2024/01/Screenshot-2024-01-04-at-21.19.33.png 2000w" sizes="(min-width: 1400px) 1400px, 92vw" src="https://blog.digger.dev/content/images/size/w2000/2024/01/Screenshot-2024-01-04-at-21.19.33.png" alt="How Open ID Connect works (illustrated)"/>
            </figure>

    </header>

    <section>
        <p>I first learned about Open ID Connect (OIDC) while working on digger, an IaC automation tool. The main component of <a href="https://github.com/diggerhq/digger?ref=blog.digger.dev">Digger</a> is a cli which integrates directly in your CI system of choice.</p><p>The first time we approached implementing oidc we were lazy and decided to leverage the github action <code>setup-aws</code> which does it for us under the hood. Then later we had some extra requirements which meant that OIDC needed to be implemented as a part of digger which meant that I needed to understand how OIDC works on a deeper level. Going through the official draft of OIDC to me was similar to reading an official spec for OAuth - too many abstract terms that make it difficult to understand. Through some trial and error as well as relying on github’s docs for implementing OIDC, and reverse engineering the setup-aws typescript code I got a <a href="https://github.com/diggerhq/digger/pull/906?ref=blog.digger.dev">working version</a> for OIDC within digger using the aws sdk.</p><p>Over here I want to explain my learnings in a simplified way so that you too can understand how all this voodoo magic works under the hood. This article will focus on AWS services, but it works very similarly in other cloud providers as well.</p><p><strong>It all started with keys:</strong></p><p>Traditionally the easiest way to authenticate on AWS was via keys. you created a pair of keys and used those to authenticate in your application code and in your CI systems to whatever services you needed. This was the simplest way to authenticate and access the cloud services.</p><figure><img src="https://blog.digger.dev/content/images/2024/01/Screenshot-2024-01-04-at-15.47.18.png" alt="IMG_6861.HEIC" loading="lazy" width="1834" height="972" srcset="https://blog.digger.dev/content/images/size/w600/2024/01/Screenshot-2024-01-04-at-15.47.18.png 600w, https://blog.digger.dev/content/images/size/w1000/2024/01/Screenshot-2024-01-04-at-15.47.18.png 1000w, https://blog.digger.dev/content/images/size/w1600/2024/01/Screenshot-2024-01-04-at-15.47.18.png 1600w, https://blog.digger.dev/content/images/2024/01/Screenshot-2024-01-04-at-15.47.18.png 1834w" sizes="(min-width: 720px) 720px"/></figure><p><strong>long lived keys are not secure</strong></p><p>From a security perspective, long-lived passwords, tokens and keys are not secure to be stored. Instead you should rely on rotating keys periodically and ideally never storing them. This is where the role of AWS roles came handy. Now within EC2, lambda, codebuild and other services where your code ran you were able to assume a role and access other aws cloud services. Actually, under the hood the proccess of “assuming a role” generates a temporary set of AWS key, AWS secret and a session token for accessing these services. These keys are valid for an hour and can be set to expire sooner. Now as a developer you no longer needed to store any keys in your application code or worry about having them as secrets or rotating them, great!</p><figure><img src="https://blog.digger.dev/content/images/2024/01/Screenshot-2024-01-04-at-15.47.38.png" alt="IMG_6859.HEIC" loading="lazy" width="2000" height="785" srcset="https://blog.digger.dev/content/images/size/w600/2024/01/Screenshot-2024-01-04-at-15.47.38.png 600w, https://blog.digger.dev/content/images/size/w1000/2024/01/Screenshot-2024-01-04-at-15.47.38.png 1000w, https://blog.digger.dev/content/images/size/w1600/2024/01/Screenshot-2024-01-04-at-15.47.38.png 1600w, https://blog.digger.dev/content/images/size/w2400/2024/01/Screenshot-2024-01-04-at-15.47.38.png 2400w" sizes="(min-width: 720px) 720px"/></figure><p><strong>How do I access my AWS from the outside world?</strong></p><p>But, how do we gain keyless access from outside AWS, for example in my github actions CI system? Do I need to use AWS keys and hardcode them in my secrets store, then manually rotate them periodically?</p><p>This is where OIDC comes into play. At first it seems like blackmagic how it works. due to how much of the flow is abstracted away from the user. The steps to use OIDC with AWS+github actions are as follows:</p><ul><li>Create a role on AWS, add trust policy specifying which github org+repo are allowed to access this AWS role</li><li>Create an identity provider for github actions</li><li>use the setup-aws action, specify the role and it will take care of the rest</li></ul><p>Alot is hidden away from how it works, and you might guess there is some key exchange going on between AWS and github or something like that. Actually its much simpler if you look at how it really works. If you wanted to implement OIDC without relying on any other code this is how you would do it:</p><ul><li>Github spins up an Action with your pipeline code</li><li>Every action job comes with a token as an envirionment variable for authenticated calls to github</li><li>You send a post request to github, asking for a “web identity token“</li><li>You send this token to AWS, exchanging it for (you guest it) a pair of keys and session token</li><li>You use this set of keys to authenticate with AWS services as normal</li></ul><figure><img src="https://blog.digger.dev/content/images/2024/01/Screenshot-2024-01-04-at-15.47.56.png" alt="IMG_6860.HEIC" loading="lazy" width="2000" height="1277" srcset="https://blog.digger.dev/content/images/size/w600/2024/01/Screenshot-2024-01-04-at-15.47.56.png 600w, https://blog.digger.dev/content/images/size/w1000/2024/01/Screenshot-2024-01-04-at-15.47.56.png 1000w, https://blog.digger.dev/content/images/size/w1600/2024/01/Screenshot-2024-01-04-at-15.47.56.png 1600w, https://blog.digger.dev/content/images/size/w2400/2024/01/Screenshot-2024-01-04-at-15.47.56.png 2400w" sizes="(min-width: 720px) 720px"/></figure><p>The key point here is that the “web identity token” is a JWT token signed by github and who’s contents can be verified by AWS using github’s public key. Therefore AWS can verify the key and use the data within the JWT token to verify access only using the token alone. Since the token also contains “scopes” such as organisation, repo, branch, AWS can either grant or deny access based on these scopes within the verified JWT token.</p><p>So there you have it, an illustrated guide to OIDC with AWS and Github actions. Other CIs and cloud providers also work in a similar way.</p>
    </section>


</article>
</div></div>
  </body>
</html>
