<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://news.alvaroduran.com/p/cringey-but-true-how-uber-tests-payments">Original</a>
    <h1>Uber tests its payment systems in production</h1>
    
    <div id="readability-page-1" class="page"><div><div dir="auto"><p>You are wasting most of the time you spend testing.</p><p>And I get it. You’d rather test things in staging, because it gives you a sense of control. Most engineers even cringe at the idea of testing in production. But I think that&#39;s because they think it’s either/or. It’s not.</p><p>You can test before deployment as much as you’d like. And then, you can test in production as much as you can. The trick is when to switch. </p><p><strong>You aren’t testing in production early enough.</strong></p><p>That’s why what Uber does is so intriguing.</p><p>But first, why is testing in production even necessary? Can’t we just try to write code as correctly as we can inside a no-stakes environment, rather than risking real money and real impact on real users?</p><p><span>You could. But </span><strong>if you’re doing your job right, you’ll quickly run out of bugs</strong><span> to find in such an environment. The easy ones. If you haven’t already.</span></p><p>Look, the systems you maintain, that most of us maintain, have been around for a few years. Some, even decades. That is because software is not like other machines. Most machines, in time, rot and decay. But software is just information: if it’s correct, it stays that way. Hardware does need replacement, but the correct software that runs on it keeps running.</p><p>Software, if you’re doing your job right, gets better over time.</p><p>What an amazing machine.</p><p><span>You probably call those systems </span><em>legacy</em><span> with disdain, because software gets more difficult to maintain over time. But there’s a reason legacy software is scary to change. We want it to keep doing what it&#39;s currently doing.</span></p><p><span>Hate it all you want, but </span><strong>legacy software works, even when it’s a mess</strong><span>.</span></p><p>There’s pretty much one way to produce high quality software. Use it, and fix all the bugs you can find in it. In time, the easy bugs are gone. </p><p>Unlike the human body, old software is so healthy. If that’s the only way to produce high quality software, the only illnesses you’re going to find are the exotic ones.</p><p><span>Payment systems are an extreme version of this. Moving money has always been </span><strong>the most obvious business use case for computers</strong><span>. And so, money software has been around for a long time.</span></p><p>That’s the kind of software that Uber, or any other merchant, has to deal with. What I find fascinating is that Uber is doing it in a way that makes many engineers cringe.</p><p><strong>Uber tests its payment systems in production</strong><span>. And in this article, I’m going to tell you how they do it, and why it’s a great idea.</span></p><p><span>I’m </span><a href="https://www.linkedin.com/in/alvaroduranbarata/" rel="">Alvaro Duran</a><span>, and this is </span><em>The Payments Engineer Playbook</em><span>. Scroll for five minutes on Youtube and you’ll find tons of tutorials that show you payment system designs that’ll help you pass interviews. But there’s not much that teaches you how to build this critical software for real users and real money.</span></p><p>The reason I know this is because I’ve built and maintained systems that handle close to 100,000 payments a day. And I’ve been able to see all types of interesting conversations about what works and what doesn&#39;t for payment systems behind closed doors.</p><p>These conversations are what inspired this newsletter.</p><p><span>In </span><em>The Payments Engineer Playbook</em><span>, we investigate the technology that transfers money. And we do that by cutting off one sliver of it and extract tactics from it.</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa77d5215-a5c5-4b71-b783-57e26c261a9f_1600x1097.jpeg" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa77d5215-a5c5-4b71-b783-57e26c261a9f_1600x1097.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa77d5215-a5c5-4b71-b783-57e26c261a9f_1600x1097.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa77d5215-a5c5-4b71-b783-57e26c261a9f_1600x1097.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa77d5215-a5c5-4b71-b783-57e26c261a9f_1600x1097.jpeg 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa77d5215-a5c5-4b71-b783-57e26c261a9f_1600x1097.jpeg" width="1456" height="998" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/a77d5215-a5c5-4b71-b783-57e26c261a9f_1600x1097.jpeg&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:998,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:null,&#34;alt&#34;:&#34;A Tour of Uber&#39;s New San Francisco Office - Officelovin&#34;,&#34;title&#34;:null,&#34;type&#34;:null,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="A Tour of Uber&#39;s New San Francisco Office - Officelovin" title="A Tour of Uber&#39;s New San Francisco Office - Officelovin" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa77d5215-a5c5-4b71-b783-57e26c261a9f_1600x1097.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa77d5215-a5c5-4b71-b783-57e26c261a9f_1600x1097.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa77d5215-a5c5-4b71-b783-57e26c261a9f_1600x1097.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa77d5215-a5c5-4b71-b783-57e26c261a9f_1600x1097.jpeg 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>Uber offices in San Francisco</figcaption></figure></div><p>If you don’t want to test payments in production, your only choice is to use a staging environment.</p><p>And what do you have to do to set up a good one? Two things.</p><p>First, you have to copy all production data. It’s expensive, and a reckless breach in privacy and security, but it’s doable. And second, you must emulate all user activity. Staging must become a believable version of your production systems.</p><p><span>That reminds me of a </span><a href="https://en.wikipedia.org/wiki/Potemkin_village" rel="">Potemkin village</a><span>.</span></p><p><span>Staging environments are not as useful as you think they are. </span><strong>It is unrealistic to try to erect sophisticated replicas of the real world</strong><span>. Your tests will only be as good as your ability to do the job completely.</span></p><p><span>I really like </span><a href="https://www.youtube.com/watch?v=DfAwKS1NShs" rel="">how Charity Majors put it</a><span>: “</span><strong>staging is just a glorified laptop</strong><span>”. Only production is production.</span></p><p><span>In fact, payment providers only do so much in their sandbox environments. As soon as you start digging deeper, </span><strong>you’ll notice a big gap between how sandbox behaves and all the surprises that production has for you</strong><span>.</span></p><p>But the lesson isn’t to demand better sandbox applications from your provider. They’re not going to comply, because it just doesn’t make a business difference to them.</p><p><span>Instead, the lesson should be this: </span><strong>to test your payment systems in sandbox for an amount of time that’s reasonable</strong><span>. And not a second more.</span></p><p>That’s how Uber does it.</p><p>Uber has outgrown the idea that defects can be completely solved at staging.</p><p>Rather than stressing out over a perfect release, Uber has put in place tools to detect production failures as early as possible, and to roll back to a known safe state quickly and easily.</p><p><span>These tools correspond to </span><strong>three key concepts</strong><span>: To roll out against business metrics, to carefully select a first rollout region, and to make these rollouts progressively.</span></p><p><span>Before he started </span><a href="https://newsletter.pragmaticengineer.com/" rel="">The Pragmatic Engineer</a><span>, Gergely Orosz worked as an engineer manager at Uber Money. In 2018, he gave a talk on </span><a href="https://www.youtube.com/watch?v=yooCE5B0SRA" rel="">how Uber rolled out new payment methods</a><span>.</span></p><p><span>For Orosz, </span><strong>building and rolling out a new payment method are two sides of the same coin</strong><span>.</span></p><p>Sandbox testing is something you do early on, because it speeds up development. But as soon as you can, you move into real payments with real cards.</p><p>And for that, the right debugging tools are critical.</p><p>Orosz mentions Uber’s internal tools, Cerberus and Deputy, which are responsible for two important tasks when testing in production</p><ul><li><p>Making requests to real systems in a transparent way</p></li><li><p>Channeling the responses into your own laptop</p></li></ul><p>But to me, the most important point of his talk is this:</p><p>For Uber, every deployment is an experiment</p><p>What Orosz means is that Uber recognizes that nobody really knows how any deployment is really going to turn out. Every time out there is a guess, and your job is to make it an educated one.</p><p>Therefore, every deployment is a hypothesis on how certain business metrics will look like from the moment it goes live.</p><p><span>Which metrics to measure, and which monitors to put in place to do that varies from company to company. But </span><strong>a payment method that doesn’t help your company earn more or spend less is a wasted effort</strong><span>.</span></p><blockquote><p>I’m not going to name names but some large successful unicorns in this city still deploy all their Java WAR files to production at once. At once. And they have a reputation for going down a bunch. I have no idea why.</p><p><span>— Charity Majors, </span><a href="https://www.youtube.com/watch?v=DfAwKS1NShs" rel="">Engineering Large Systems When You&#39;re Not Google Or Facebook</a></p></blockquote><p>Brazilians always get the new stuff from Facebook first.</p><p>This is by design. One of the corollaries of “every deployment is an experiment” is that you should mitigate any potential problems by exposing it to the smallest, but significant, subset of users possible. Only when you don’t see anything wrong, you expose it to more users.</p><p><span>The first experiment region is how you do that in the beginning. </span><strong>A way to contain the impact of a potential screw up</strong><span>.</span></p><p>When Uber rolled out GooglePay, they decided to focus their monitoring on Portugal.</p><p>It was a country</p><ul><li><p><strong>Small, but not tiny</strong><span>: Rolling out incrementally to 100% of the country’s traffic would be a significant number already</span></p></li><li><p><strong>In a close time region</strong><span> to where the team was based (Amsterdam): This made live monitoring so much convenient for them.</span></p></li><li><p><strong>With representative users</strong><span>: Most Portuguese pay on Uber through the Authorize flow, just like pretty much everyone globally.</span></p></li><li><p><strong>Where the provider’s dependencies are minimized</strong><span>: In Portugal, the old Android Pay had close to no penetration.</span></p></li></ul><p>Selecting a first experiment region can do wonders if you accept payments globally.</p><p>Done well, canary deployments make rollbacks more frequent, not less.</p><p>Like canaries in a coalmine, deploying to a subset of users is meant to be done frequently. You assume that the moment something doesn’t look good, you will pull back fast.</p><p><span>No deployment strategy is going to make each individual deployment safer. </span><strong>What canary deployments give you is the opportunity to trade SEV-1 outages for a few SEV-3 and SEV-4</strong><span>.</span></p><p>And guess what? That’s exactly what happened to Uber when they were rolling out GooglePay. Numbers didn’t add up in the beginning!</p><p>Rolling out cautiously in Portugal was a smart decision. It surfaced bugs in Google Pay.</p><blockquote><p>Our uncollected rate was huge. And we first just said “all right, are we stupid? Are we missing something here?” But no, everything seemed fine. Seemed like no mistakes.</p><p>So we searched it all with Google. First, we rolled back and we talked with Google. And, you know, It turns out there were some issues on their end, and there were some issues on our end, and we certainly fixed it. But it took quite a while.</p><p><span>— Gergely Orosz, </span><a href="https://www.youtube.com/watch?v=yooCE5B0SRA" rel="">Payments Integration at Uber: A Case Study</a></p></blockquote><p>How on Earth are you going to find bugs in GooglePay from a staging environment?</p><p>You can’t. You just can’t.</p><p><span>And that’s what’s fascinating to me. On the one hand, you’ve got engineers who take every precaution possible </span><em>before rolling out</em><span> because payments are something you should never break.</span></p><p><span>And on the other hand, you’ve got companies like Uber, who take every precaution possible </span><em>after rolling out</em><span> because they understand that </span><strong>the game is resiliency</strong><span>, not never failing at anything.</span></p><p><span>That’s the lesson that I’m taking away from how Uber does things. </span><strong>Testing before production is fine, but returns diminish sharply</strong><span>.</span></p><p>At some point, you’re better off checking your work against real users, and real money.</p><p>This reminds me of algorithmic trading. You can develop a strategy that performs great with backtest data, in a no stakes environment. But the real test is the real thing with real stakes. Nothing else compares to it.</p><p>You should think of deployments as experiments. Only production is production. Anything else is a prelude.</p><p><span>All right, that’s it for this article of </span><em>The Payments Engineer Playbook</em><span>. See you next week.</span></p><p><strong>PS</strong><span>: Before you go, I have to be completely honest with you: this article and </span><a href="https://news.alvaroduran.com/p/stripe-made-the-obvious-choice-when" rel="">the one on Stripe</a><span> took A LOT of work. I’m not sure if I’m going to keep making these kind of articles anymore.</span></p><p>I need to know from you.</p><p>Are these articles useful? Then, you can do two things.</p><p>First, I want you to leave a comment, no matter if it’s negative or positive. Either way, I want you to let me know: do you want me to keep making these articles?</p><p>It’s a lot of work, but I’ll keep doing it if I know it’s making an impact on you. Otherwise, these ideas will stay private inside of my team.</p><p>The second thing I need from you is to tell a colleague. If you’re reading this, you probably work with someone who builds payments for a living. And you’ve been reading this newsletter long enough to tell if it’s going to be useful for them too.</p><p>And if you got this article from a colleague, do me a favor and subscribe. It’s a flex to be a reader of a well-known publication before it was cool.</p><p>I bet that’s how it feels to be a VC who led a series A on a startup at IPO day.</p><p><span>Make a bet on </span><em>The Payments Engineer Playbook</em><span>. I’ll see you around.</span></p></div></div></div>
  </body>
</html>
