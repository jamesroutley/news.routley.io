<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.tylermw.com/posts/rayverse/displacement-mapping.html">Original</a>
    <h1>Visualizing Data on a Mesh with Displacement Mapping in R</h1>
    
    <div id="readability-page-1" class="page"><div id="quarto-content">






<main id="quarto-document-content">

<p><img src="https://www.tylermw.com/posts/images/2024/moon_preview.jpg"/></p>


<blockquote>
<p>We like the moon</p>
</blockquote>
<p>— The Spongmonkies, 2002</p>
<section id="introduction">
<h2 data-anchor-id="introduction">Introduction</h2>
<div>

<div id="callout-1">
<p>In this post, we explore subdivision surfaces and displacement mapping within the rayverse, using the <code>rayvertex</code>, <code>rayimage</code>, and <code>rayrender</code> packages. We demonstrate how to create detailed and smooth 3D models by subdividing meshes and applying displacement textures. These techniques enhance both artistic and data visualization projects by providing realistic and intricate surface details.</p>
</div>
</div>
<div><p>Bumpy objects and smooth objects. These are the two demons you must slay if you want to be successful in 3D rendering. </p><p><span>Just kidding! There are thousands of demons you must slay. The princess is always in another castle.</span></p></div>
<div><p>Triangles, the primary building blocks of computer graphics, don’t directly lend themselves to either extremely smooth or realistically bumpy objects. Since triangles are flat primitives, borders between non-coplanar adjacent triangles will always have sharp edges. You can introduce approximations to work around this (such as per-vertex normals), but approximations always have failure modes, particularly with certain rendering algorithms. Bumpy objects suffer from the same issue: approximating a rough surface using a bump map or a normal map (which change the underlying surface normal without actually changing the geometry) can lead to non-physically accurate results.</p><p><span>There’s also NURBS, quadratic surfaces, curves, and more exotic objects</span></p></div>
<div><p>Historically, renderers worked around this by subdividing meshes into “micropolygons”: polygons smaller than a single pixel. This means triangle edges were not visible, as they only existed a on sub-pixel scale. This subdivision enabled the rendering of smooth objects and the rendered image no longer had visible discontinuities in the surface normal due to geometry. This subdivision process allowed for bumpy surfaces as well: by displacing the vertices of these micropolygons, you could easily generate highly detailed surfaces given a basic low-resolution mesh and a displacement texture. It can be significantly easier to work with displacement information in 2D form and use it to displace a low-resolution 3D mesh, rather than try to construct a fully-detailed 3D mesh directly. </p><p><span>The Reyes rendering algorithm–which brought us Toy Story and Star Trek II: Wrath of Khan–actually works off of quadrilaterals, not triangles, but the idea is the same</span><span>Rayshader has always performed a basic version of displacement mapping when generating meshes, but it’s been limited to displacing a flat surface.</span></p></div>
<div><p>This brings us to why I implemented subdivision surfaces and displacement mapping in the rayverse: there’s plenty of 2D data out there and not all of it lives on a flat, Cartesian plane. If you’re plotting data that spans the entire planet (or moon!), there’s always a struggle to pick the right projection, knowing that there’s no ideal way to transform a sphere to 2D without warping the data in some way. Expressing the data in its native curved space avoids those issues entirely.</p><p><span>While 3D plotting has its own set of issues, it also has many advantages–see <a href="https://www.tylermw.com/posts/data_visualization/3d-ggplots-with-rayshader.html">this blog post</a> for more information</span></p></div>
<p>So let’s dive into subdivision surfaces and displacement mapping! What is it, how it was implemented, things to keep in mind when using it, and what you can do with it in the rayverse.</p>

</section>
<section id="subdivision">
<h2 data-anchor-id="subdivision">Subdivision</h2>
<p>We’ll start by loading three useful rayverse packages: <code>rayvertex</code> to construct <code>raymesh</code> objects and manipulate them directly, <code>rayimage</code> to manipulate displacement textures and load a variety of image files, and <code>rayrender</code> to visualize these meshes in a high-quality pathtracer.</p>
<div>
<div id="cb1"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span>library</span>(rayvertex)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span>library</span>(rayimage)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span>library</span>(rayrender)</span></code></pre></div>
</div>
<div><p>Now, let’s render an image of some shapes with Loop subdivision. We’ll be using <code>rayvertex</code> because it renders faster and has more fine-grained control over the meshing process. Note here the new (as of <code>rayvertex</code> v0.11.0) print output showing a command-line preview of the materials, as well as a preview of the scene information.</p><p><span>Fun fact: Loop subdivision is not named after some cyclical mesh property or iterative process that the name might suggest: it’s actually named after the graphics researcher Charles Loop.</span></p></div>
<div>
<div id="annotated-cell-2"><pre><code><span id="annotated-cell-2-1"><a href="#annotated-cell-2-1" aria-hidden="true" tabindex="-1"></a>base_material <span>=</span> <span>material_list</span>(<span>diffuse=</span><span>&#34;red&#34;</span>, <span>ambient =</span> <span>&#34;red&#34;</span>,</span>
<span id="annotated-cell-2-2"><a href="#annotated-cell-2-2" aria-hidden="true" tabindex="-1"></a>                              <span>type =</span> <span>&#34;phong&#34;</span>, <span>shininess =</span> <span>5</span>,</span>
<span id="annotated-cell-2-3"><a href="#annotated-cell-2-3" aria-hidden="true" tabindex="-1"></a>                              <span>diffuse_intensity =</span> <span>0.8</span>, <span>ambient_intensity =</span> <span>0.2</span>)</span>
<span id="annotated-cell-2-4"><a href="#annotated-cell-2-4" aria-hidden="true" tabindex="-1"></a>base_material</span></code></pre></div>
<div>
<dl>
<dt data-target-cell="annotated-cell-2" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="1,2,3,4" data-code-annotation="1">Create and print the red cube material</span>
</dd>
</dl>
</div>
<pre><code><span>• rayvertex_material</span>
<span>•</span> <span>type:</span> phong
<span>•</span> <span>diffuse:</span> #ff0000 <span> </span> <span>| intensity:</span> 0.8
<span>•</span> <span>ambient:</span> #ff0000 <span> </span> <span>| intensity:</span> 0.2
<span>•</span> <span>shininess:</span> 5
</code></pre>
</div>
<div>
<div id="annotated-cell-3"><pre><code><span id="annotated-cell-3-1"><a href="#annotated-cell-3-1" aria-hidden="true" tabindex="-1"></a>base_material2 <span>=</span> <span>material_list</span>(<span>diffuse=</span><span>&#34;purple&#34;</span>, <span>ambient =</span> <span>&#34;purple&#34;</span>,</span>
<span id="annotated-cell-3-2"><a href="#annotated-cell-3-2" aria-hidden="true" tabindex="-1"></a>                               <span>type =</span> <span>&#34;phong&#34;</span>, <span>shininess =</span> <span>5</span>,</span>
<span id="annotated-cell-3-3"><a href="#annotated-cell-3-3" aria-hidden="true" tabindex="-1"></a>                               <span>diffuse_intensity =</span> <span>0.8</span>, <span>ambient_intensity =</span> <span>0.2</span>)</span>
<span id="annotated-cell-3-4"><a href="#annotated-cell-3-4" aria-hidden="true" tabindex="-1"></a>base_material2</span></code></pre></div>
<div>
<dl>
<dt data-target-cell="annotated-cell-3" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="1,2,3,4" data-code-annotation="1">Create and print the purple sphere material</span>
</dd>
</dl>
</div>
<pre><code><span>• rayvertex_material</span>
<span>•</span> <span>type:</span> phong
<span>•</span> <span>diffuse:</span> #a020f0 <span> </span> <span>| intensity:</span> 0.8
<span>•</span> <span>ambient:</span> #a020f0 <span> </span> <span>| intensity:</span> 0.2
<span>•</span> <span>shininess:</span> 5
</code></pre>
</div>
<p>Note how the materials print a preview of the actual colors and relevant (i.e. non-default) material settings. This is due to <code>rayvertex</code>’s new integration with the <code>cli</code> package and a whole collection of new pretty-print functions.</p>
<div>
<div id="annotated-cell-4"><pre><code><span id="annotated-cell-4-1"><a href="#annotated-cell-4-1" aria-hidden="true" tabindex="-1"></a>scene <span>=</span> <span>cube_mesh</span>(<span>material =</span> base_material, <span>scale =</span> <span>0.8</span>) <span>|&gt;</span></span>
<span id="annotated-cell-4-2"><a href="#annotated-cell-4-2" aria-hidden="true" tabindex="-1"></a>  <span>add_shape</span>(<span>sphere_mesh</span>(<span>radius=</span><span>0.5</span>,<span>position =</span> <span>c</span>(<span>-</span><span>1.2</span>,<span>0</span>,<span>0</span>), <span>low_poly =</span> <span>TRUE</span>,</span>
<span id="annotated-cell-4-3"><a href="#annotated-cell-4-3" aria-hidden="true" tabindex="-1"></a>                        <span>normals =</span> <span>TRUE</span>,</span>
<span id="annotated-cell-4-4"><a href="#annotated-cell-4-4" aria-hidden="true" tabindex="-1"></a>                        <span>material =</span> base_material2)) <span>|&gt;</span></span>
<span id="annotated-cell-4-5"><a href="#annotated-cell-4-5" aria-hidden="true" tabindex="-1"></a>  <span>add_shape</span>(<span>obj_mesh</span>(<span>r_obj</span>(), <span>position=</span><span>c</span>(<span>1.2</span>,<span>0</span>,<span>0</span>)))</span>
<span id="annotated-cell-4-6"><a href="#annotated-cell-4-6" aria-hidden="true" tabindex="-1"></a>scene</span></code></pre></div>
<div>
<dl>
<dt data-target-cell="annotated-cell-4" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="1,2,3,4,5" data-code-annotation="1">Create the 3D scene</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="6" data-code-annotation="2">Print the scene information</span>
</dd>
</dl>
</div>
<div>
<pre><code>── Scene Description ───────────────────────────────────────────────────────────</code></pre>
</div>
<pre><code><span>•</span> Summary - <span>Meshes</span>: <span>3</span> | <span>Unique Materials</span>: <span>4</span>
<span>ℹ</span> XYZ Bounds - <span>Min</span>: <span>c(-1.69, -0.51, -0.49)</span> | <span>Max</span>: <span>c(1.70, 0.49, 0.51)</span>
             shapes  vertices texcoords   normals materials
          <span>&lt;ray_shp&gt;</span> <span>&lt;ray_dat&gt;</span> <span>&lt;ray_dat&gt;</span> <span>&lt;ray_dat&gt;</span> <span>&lt;ray_mat&gt;</span>
<span>1</span>   <span>&lt;</span>T:<span>12</span><span>|</span><span>UV</span><span>|</span><span>N</span><span>|</span>M:<span>1</span><span>&gt;</span>     <span>&lt;</span><span>8</span><span>x</span><span>3</span><span>&gt;</span>     <span>&lt;</span><span>4</span><span>x</span><span>2</span><span>&gt;</span>     <span>&lt;</span><span>6</span><span>x</span><span>3</span><span>&gt;</span>   <span>&lt;</span><span>phong</span><span>&gt;</span>
<span>2</span>   <span>&lt;</span>T:<span>48</span><span>|</span><span>UV</span><span>|</span><span>N</span><span>|</span>M:<span>1</span><span>&gt;</span>    <span>&lt;</span><span>26</span><span>x</span><span>3</span><span>&gt;</span>    <span>&lt;</span><span>34</span><span>x</span><span>2</span><span>&gt;</span>    <span>&lt;</span><span>26</span><span>x</span><span>3</span><span>&gt;</span>   <span>&lt;</span><span>phong</span><span>&gt;</span>
<span>3</span> <span>&lt;</span>T:<span>2280</span><span>|</span><span>UV</span><span>|N|</span>M:<span>6</span><span>&gt;</span>  <span>&lt;</span><span>1520</span><span>x</span><span>3</span><span>&gt;</span>  <span>&lt;</span><span>1520</span><span>x</span><span>2</span><span>&gt;</span>    <span>&lt;none&gt;</span>      <span>&lt;</span><span>6x</span><span>&gt;</span>
</code></pre>
</div>
<p>The <code>rayvertex</code> scene information now also includes a dense, readable tabular summary of each individual mesh that makes up the scene. Rather than looking at a verbose print-out of lists of vertex data and material information, now you can get a sense of the scene at a glance.</p>
<div>
<div id="annotated-cell-5"><pre><code><span id="annotated-cell-5-1"><a href="#annotated-cell-5-1" aria-hidden="true" tabindex="-1"></a><span>rasterize_scene</span>(scene, <span>lookfrom =</span> <span>c</span>(<span>-</span><span>4</span>,<span>3</span>,<span>10</span>), <span>lookat=</span><span>c</span>(<span>-</span><span>0.05</span>,<span>0</span>,<span>0</span>),</span>
<span id="annotated-cell-5-2"><a href="#annotated-cell-5-2" aria-hidden="true" tabindex="-1"></a>                <span>fov=</span><span>9</span>, <span>height =</span> <span>550</span>, <span>width=</span><span>1100</span>,</span>
<span id="annotated-cell-5-3"><a href="#annotated-cell-5-3" aria-hidden="true" tabindex="-1"></a>                <span>light_info =</span> <span>directional_light</span>(<span>c</span>(<span>1</span>,<span>1</span>,<span>2</span>)))</span></code></pre></div>

<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/render_basic_scene-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>We’ve now rendered some basic low-polygon shapes. Low-polygon here means that you can clearly see lighting artifacts from the chunky triangles that make up the mesh: there are discontinuities on the sphere from the vertex normal interpolation, resulting in unphysical “lines” of light that run along the edges of the triangles.</p>
<p>Let’s subdivide the meshes with the new <code>subdivide_mesh()</code> function and determine how many subdivisions renders any individual triangle too small to see. Each subdivision level increases the number of triangles by a factor of four. We won’t initially add vertex normals so we can see exactly what’s going on with the geometry.</p>
<div>
<div id="annotated-cell-6"><pre><code><span id="annotated-cell-6-1"><a href="#annotated-cell-6-1" aria-hidden="true" tabindex="-1"></a>scene <span>|&gt;</span> </span>
<span id="annotated-cell-6-2"><a href="#annotated-cell-6-2" aria-hidden="true" tabindex="-1"></a>  <span>subdivide_mesh</span>(<span>subdivision_levels =</span> <span>2</span>, <span>normals =</span> <span>FALSE</span>) <span>|&gt;</span></span>
<span id="annotated-cell-6-3"><a href="#annotated-cell-6-3" aria-hidden="true" tabindex="-1"></a>  <span>rasterize_scene</span>(<span>lookfrom =</span> <span>c</span>(<span>-</span><span>4</span>,<span>3</span>,<span>10</span>), <span>lookat=</span><span>c</span>(<span>-</span><span>0.05</span>,<span>0</span>,<span>0</span>),</span>
<span id="annotated-cell-6-4"><a href="#annotated-cell-6-4" aria-hidden="true" tabindex="-1"></a>                  <span>fov=</span><span>9</span>, <span>height =</span> <span>550</span>, <span>width=</span><span>1100</span>,</span>
<span id="annotated-cell-6-5"><a href="#annotated-cell-6-5" aria-hidden="true" tabindex="-1"></a>                  <span>light_info =</span> <span>directional_light</span>(<span>c</span>(<span>0.2</span>,<span>1</span>,<span>2</span>)))</span></code></pre></div>

<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/subdivide2-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Note how the cube has shrunk considerably and the sharp edges of the letter R have collapsed in on themselves. This phenomenon occurs because subdivision algorithms, like Loop subdivision, work by averaging the positions of vertices to create a smoother surface. Sharp edges consisting of large triangles will be much more affected by this process. To fix this, we can turn off vertex interpolation and first apply a non-interpolated simple subdivision step and then follow it up with regular Loop subdivision step to more accurately maintain the initial shape of the object.</p>
<div>
<div id="annotated-cell-7"><pre><code><span id="annotated-cell-7-1"><a href="#annotated-cell-7-1" aria-hidden="true" tabindex="-1"></a>scene <span>|&gt;</span> </span>
<span id="annotated-cell-7-2"><a href="#annotated-cell-7-2" aria-hidden="true" tabindex="-1"></a>  <span>subdivide_mesh</span>(<span>normals =</span> <span>FALSE</span>, <span>simple =</span> <span>TRUE</span>) <span>|&gt;</span></span>
<span id="annotated-cell-7-3"><a href="#annotated-cell-7-3" aria-hidden="true" tabindex="-1"></a>  <span>subdivide_mesh</span>(<span>subdivision_levels =</span> <span>2</span>, <span>normals =</span> <span>FALSE</span>) <span>|&gt;</span></span>
<span id="annotated-cell-7-4"><a href="#annotated-cell-7-4" aria-hidden="true" tabindex="-1"></a>  <span>rasterize_scene</span>(<span>lookfrom =</span> <span>c</span>(<span>-</span><span>4</span>,<span>3</span>,<span>10</span>), <span>lookat=</span><span>c</span>(<span>-</span><span>0.05</span>,<span>0</span>,<span>0</span>),</span>
<span id="annotated-cell-7-5"><a href="#annotated-cell-7-5" aria-hidden="true" tabindex="-1"></a>                  <span>fov=</span><span>9</span>, <span>height =</span> <span>550</span>, <span>width=</span><span>1100</span>,</span>
<span id="annotated-cell-7-6"><a href="#annotated-cell-7-6" aria-hidden="true" tabindex="-1"></a>                  <span>light_info =</span> <span>directional_light</span>(<span>c</span>(<span>0.2</span>,<span>1</span>,<span>2</span>)))</span></code></pre></div>
<div>
<dl>
<dt data-target-cell="annotated-cell-7" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="2" data-code-annotation="1">Subdivide the scene but don’t smooth the mesh</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="3" data-code-annotation="2">Subdivide the scene normally, but don’t calculate normals to better show the triangle faces</span>
</dd>
</dl>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/subdivide_basic-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Note how the cube is still cube-ish, but with nicely curved edges! The R logo looks nicer here too, as the large corner that makes up the R didn’t collapse. The only problem is the low-poly sphere is now more like a 20-sided D&amp;D die, which isn’t great if you’d like the limit of the subdivision process to result in an identical (but smoothed) version of the original mesh. But it’s nice to have a workflow for adding rounded bevels to models, which adding a simple subdivision step provides. Let’s get back to trying to trying to subdivide until we can’t tell the mesh is made of individual triangles anymore. How about three subdivisions?</p>
<div>
<div id="annotated-cell-8"><pre><code><span id="annotated-cell-8-1"><a href="#annotated-cell-8-1" aria-hidden="true" tabindex="-1"></a>scene <span>|&gt;</span> </span>
<span id="annotated-cell-8-2"><a href="#annotated-cell-8-2" aria-hidden="true" tabindex="-1"></a>  <span>subdivide_mesh</span>(<span>subdivision_levels =</span> <span>3</span>, <span>normals =</span> <span>FALSE</span>) <span>|&gt;</span></span>
<span id="annotated-cell-8-3"><a href="#annotated-cell-8-3" aria-hidden="true" tabindex="-1"></a>  <span>rasterize_scene</span>(<span>lookfrom =</span> <span>c</span>(<span>-</span><span>4</span>,<span>3</span>,<span>10</span>), <span>lookat=</span><span>c</span>(<span>-</span><span>0.05</span>,<span>0</span>,<span>0</span>),</span>
<span id="annotated-cell-8-4"><a href="#annotated-cell-8-4" aria-hidden="true" tabindex="-1"></a>                  <span>fov=</span><span>9</span>, <span>height =</span> <span>550</span>, <span>width=</span><span>1100</span>,</span>
<span id="annotated-cell-8-5"><a href="#annotated-cell-8-5" aria-hidden="true" tabindex="-1"></a>                  <span>light_info =</span> <span>directional_light</span>(<span>c</span>(<span>0.2</span>,<span>1</span>,<span>2</span>)))</span></code></pre></div>
<div>
<dl>
<dt data-target-cell="annotated-cell-8" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="2" data-code-annotation="1">Subdivide the objects three times</span>
</dd>
</dl>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/subdivide3-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Not yet. Still visible. Let’s subdivide again.</p>
<div>
<div id="annotated-cell-9"><pre><code><span id="annotated-cell-9-1"><a href="#annotated-cell-9-1" aria-hidden="true" tabindex="-1"></a>scene <span>|&gt;</span> </span>
<span id="annotated-cell-9-2"><a href="#annotated-cell-9-2" aria-hidden="true" tabindex="-1"></a>  <span>subdivide_mesh</span>(<span>subdivision_levels =</span> <span>4</span>, <span>normals =</span> <span>FALSE</span>) <span>|&gt;</span></span>
<span id="annotated-cell-9-3"><a href="#annotated-cell-9-3" aria-hidden="true" tabindex="-1"></a>  <span>rasterize_scene</span>(<span>lookfrom =</span> <span>c</span>(<span>-</span><span>4</span>,<span>3</span>,<span>10</span>), <span>lookat=</span><span>c</span>(<span>-</span><span>0.05</span>,<span>0</span>,<span>0</span>),</span>
<span id="annotated-cell-9-4"><a href="#annotated-cell-9-4" aria-hidden="true" tabindex="-1"></a>                  <span>fov=</span><span>9</span>, <span>height =</span> <span>550</span>, <span>width=</span><span>1100</span>,</span>
<span id="annotated-cell-9-5"><a href="#annotated-cell-9-5" aria-hidden="true" tabindex="-1"></a>                  <span>light_info =</span> <span>directional_light</span>(<span>c</span>(<span>0.2</span>,<span>1</span>,<span>2</span>)))</span></code></pre></div>
<div>
<dl>
<dt data-target-cell="annotated-cell-9" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="2" data-code-annotation="1">Subdivide the objects four times</span>
</dd>
</dl>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/subdivide4-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Almost! But no cigar.</p>
<div>
<div id="annotated-cell-10"><pre><code><span id="annotated-cell-10-1"><a href="#annotated-cell-10-1" aria-hidden="true" tabindex="-1"></a>scene <span>|&gt;</span></span>
<span id="annotated-cell-10-2"><a href="#annotated-cell-10-2" aria-hidden="true" tabindex="-1"></a>  <span>subdivide_mesh</span>(<span>subdivision_levels =</span> <span>5</span>, <span>normals =</span> <span>FALSE</span>) <span>-&gt;</span></span>
<span id="annotated-cell-10-3"><a href="#annotated-cell-10-3" aria-hidden="true" tabindex="-1"></a>scene_5x</span>
<span id="annotated-cell-10-4"><a href="#annotated-cell-10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-5"><a href="#annotated-cell-10-5" aria-hidden="true" tabindex="-1"></a><span>rasterize_scene</span>(scene_5x, <span>lookfrom =</span> <span>c</span>(<span>-</span><span>4</span>,<span>3</span>,<span>10</span>), <span>lookat=</span><span>c</span>(<span>-</span><span>0.05</span>,<span>0</span>,<span>0</span>),</span>
<span id="annotated-cell-10-6"><a href="#annotated-cell-10-6" aria-hidden="true" tabindex="-1"></a>                <span>fov=</span><span>9</span>, <span>height =</span> <span>550</span>, <span>width=</span><span>1100</span>,</span>
<span id="annotated-cell-10-7"><a href="#annotated-cell-10-7" aria-hidden="true" tabindex="-1"></a>                <span>light_info =</span> <span>directional_light</span>(<span>c</span>(<span>0.2</span>,<span>1</span>,<span>2</span>)))</span></code></pre></div>
<div>
<dl>
<dt data-target-cell="annotated-cell-10" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="1,2,3" data-code-annotation="1">Render the scene</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="5,6,7" data-code-annotation="2">Subdivide the mesh five times and save it to an object</span>
</dd>
</dl>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/subdivide5-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>There we go. We can compare the before and after mesh sizes to see how mary more triangles this required to reach continuity. Note the number of vertices and the <code>T:</code> field in the <code>shapes</code> column indicating the number of triangles.</p>
<div>

<div>
<dl>
<dt data-target-cell="annotated-cell-11" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="1" data-code-annotation="1">Printing the scene information before subdivision</span>
</dd>
</dl>
</div>
<div>
<pre><code>── Scene Description ───────────────────────────────────────────────────────────</code></pre>
</div>
<pre><code><span>•</span> Summary - <span>Meshes</span>: <span>3</span> | <span>Unique Materials</span>: <span>4</span>
<span>ℹ</span> XYZ Bounds - <span>Min</span>: <span>c(-1.69, -0.51, -0.49)</span> | <span>Max</span>: <span>c(1.70, 0.49, 0.51)</span>
             shapes  vertices texcoords   normals materials
          <span>&lt;ray_shp&gt;</span> <span>&lt;ray_dat&gt;</span> <span>&lt;ray_dat&gt;</span> <span>&lt;ray_dat&gt;</span> <span>&lt;ray_mat&gt;</span>
<span>1</span>   <span>&lt;</span>T:<span>12</span><span>|</span><span>UV</span><span>|</span><span>N</span><span>|</span>M:<span>1</span><span>&gt;</span>     <span>&lt;</span><span>8</span><span>x</span><span>3</span><span>&gt;</span>     <span>&lt;</span><span>4</span><span>x</span><span>2</span><span>&gt;</span>     <span>&lt;</span><span>6</span><span>x</span><span>3</span><span>&gt;</span>   <span>&lt;</span><span>phong</span><span>&gt;</span>
<span>2</span>   <span>&lt;</span>T:<span>48</span><span>|</span><span>UV</span><span>|</span><span>N</span><span>|</span>M:<span>1</span><span>&gt;</span>    <span>&lt;</span><span>26</span><span>x</span><span>3</span><span>&gt;</span>    <span>&lt;</span><span>34</span><span>x</span><span>2</span><span>&gt;</span>    <span>&lt;</span><span>26</span><span>x</span><span>3</span><span>&gt;</span>   <span>&lt;</span><span>phong</span><span>&gt;</span>
<span>3</span> <span>&lt;</span>T:<span>2280</span><span>|</span><span>UV</span><span>|N|</span>M:<span>6</span><span>&gt;</span>  <span>&lt;</span><span>1520</span><span>x</span><span>3</span><span>&gt;</span>  <span>&lt;</span><span>1520</span><span>x</span><span>2</span><span>&gt;</span>    <span>&lt;none&gt;</span>      <span>&lt;</span><span>6x</span><span>&gt;</span>
</code></pre>
</div>
<div>

<div>
<dl>
<dt data-target-cell="annotated-cell-12" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="1" data-code-annotation="1">Printing the scene information after subdivision</span>
</dd>
</dl>
</div>
<div>
<pre><code>── Scene Description ───────────────────────────────────────────────────────────</code></pre>
</div>
<pre><code><span>•</span> Summary - <span>Meshes</span>: <span>3</span> | <span>Unique Materials</span>: <span>4</span>
<span>ℹ</span> XYZ Bounds - <span>Min</span>: <span>c(-1.63, -0.45, -0.45)</span> | <span>Max</span>: <span>c(1.70, 0.46, 0.45)</span>
                shapes    vertices   texcoords   normals materials
             <span>&lt;ray_shp&gt;</span>   <span>&lt;ray_dat&gt;</span>   <span>&lt;ray_dat&gt;</span> <span>&lt;ray_dat&gt;</span> <span>&lt;ray_mat&gt;</span>
<span>1</span>   <span>&lt;</span>T:<span>12288</span><span>|</span><span>UV</span><span>|N|</span>M:<span>1</span><span>&gt;</span>    <span>&lt;</span><span>6146</span><span>x</span><span>3</span><span>&gt;</span>    <span>&lt;</span><span>6146</span><span>x</span><span>2</span><span>&gt;</span>    <span>&lt;none&gt;</span>   <span>&lt;</span><span>phong</span><span>&gt;</span>
<span>2</span>   <span>&lt;</span>T:<span>49152</span><span>|</span><span>UV</span><span>|N|</span>M:<span>1</span><span>&gt;</span>   <span>&lt;</span><span>24578</span><span>x</span><span>3</span><span>&gt;</span>   <span>&lt;</span><span>24578</span><span>x</span><span>2</span><span>&gt;</span>    <span>&lt;none&gt;</span>   <span>&lt;</span><span>phong</span><span>&gt;</span>
<span>3</span> <span>&lt;</span>T:<span>2334720</span><span>|</span><span>UV</span><span>|N|</span>M:<span>6</span><span>&gt;</span> <span>&lt;</span><span>1167360</span><span>x</span><span>3</span><span>&gt;</span> <span>&lt;</span><span>1167360</span><span>x</span><span>2</span><span>&gt;</span>    <span>&lt;none&gt;</span>      <span>&lt;</span><span>6x</span><span>&gt;</span>
</code></pre>
</div>
<p>Yikes! We can see it grew by a lot: Five subdivision levels resulted in a <span>\(4^5 = 1024\)</span>x increase in the mesh size. Of course, we can turn the <code>normals</code> option back on, which then calculates smoothed vertex normals. With vertex normals, we only need three subdivision levels to achieve the same visual fidelity as the 5x subdivided mesh. Since the triangles are relatively small compared to the low-poly original, we won’t see the same sort of lighting discontinuities noted in the first render.</p>
<div>
<div id="cb5"><pre><code><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span>translate_mesh</span>(<span>subdivide_mesh</span>(scene, <span>subdivision_levels =</span> <span>3</span>) ,<span>position=</span><span>c</span>(<span>0</span>,<span>1.1</span>,<span>0</span>)) <span>|&gt;</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span>add_shape</span>(scene_5x) <span>|&gt;</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span>add_shape</span>(<span>translate_mesh</span>(scene,<span>position=</span><span>c</span>(<span>0</span>,<span>2.2</span>,<span>0</span>))) <span>|&gt;</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span>rasterize_scene</span>(<span>lookfrom =</span> <span>c</span>(<span>-</span><span>4</span>,<span>3</span>,<span>10</span>), <span>lookat=</span><span>c</span>(<span>-</span><span>0.05</span>,<span>1.1</span>,<span>0</span>),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                  <span>fov=</span><span>18</span>, <span>height =</span> <span>1100</span>, <span>width=</span><span>1100</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                  <span>light_info =</span> <span>directional_light</span>(<span>c</span>(<span>0.2</span>,<span>1</span>,<span>2</span>)))</span></code></pre></div>
<div>
<div id="fig-subdivide_both">
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/fig-subdivide_both-1.png" width="1100"/>
</p>
<figcaption id="fig-subdivide_both-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 1: Top Row: Original low-poly meshes. Middle Row: Highly subdivided (1024x triangles) scene without vertex normals. Bottom Row: 3x subdivided scene (64x triangles) with vertex normals.
</figcaption>
</figure>
</div>
</div>
</div>
<p>And that’s it for subdivision surfaces, at least for now!</p>
</section>
<section id="displacement-mapping">
<h2 data-anchor-id="displacement-mapping">Displacement Mapping</h2>
<div><p>We just subdivided a low-red mesh to make it smooth–how do we make it bumpy? We can do that by applying a displacement texture, which offsets each vertex via its vertex normal. Here’s an example of a displacement texture of the moon:</p><p><span>If there aren’t any vertex normals in the mesh, it first calculates them by averaging the directions of all the faces connected to a single vertex. This interface also supports vector displacement, but I’m not going to get into that in this post</span></p></div>
<div>
<div id="cb6"><pre><code><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>disp_moon <span>=</span> <span>ray_read_image</span>(<span>&#34;../images/2024/ldem_3_8bit.jpg&#34;</span>) </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span>plot_image</span>(disp_moon)</span></code></pre></div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/moon_disp_image-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Higher regions are lighter, and depressions are darker. If you’ve used worked in GIS software or with <code>rayshader</code> before, you might ask: isn’t this just a digital elevation model (DEM)? Sure is! Let’s check out the Monterey Bay data included in <code>rayshader</code> to see:</p>
<div>
<div id="annotated-cell-15"><pre><code><span id="annotated-cell-15-1"><a href="#annotated-cell-15-1" aria-hidden="true" tabindex="-1"></a><span>library</span>(rayshader) </span>
<span id="annotated-cell-15-2"><a href="#annotated-cell-15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-15-3"><a href="#annotated-cell-15-3" aria-hidden="true" tabindex="-1"></a>montereybay <span>|&gt;</span></span>
<span id="annotated-cell-15-4"><a href="#annotated-cell-15-4" aria-hidden="true" tabindex="-1"></a>  <span>height_shade</span>(<span>texture =</span> <span>colorRampPalette</span>(<span>c</span>(<span>&#34;black&#34;</span>,<span>&#34;white&#34;</span>))(<span>100</span>)) <span>|&gt;</span></span>
<span id="annotated-cell-15-5"><a href="#annotated-cell-15-5" aria-hidden="true" tabindex="-1"></a>  <span>plot_map</span>()</span></code></pre></div>
<div>
<dl>
<dt data-target-cell="annotated-cell-15" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="3,4,5" data-code-annotation="1">Use rayshader to plot the black to white color mapping of the Monterey Bay DEM</span>
</dd>
</dl>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/mont_bay-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>What displacement mapping does is allow this type of transformation to be applied to any 3D surface, rather than just a 2D plane (as in <code>rayshader</code>). So displacement mapping allows us to apply these displacements to a sphere. In a universe full of spheres and ellipsoids, this capability can be quite useful. Our image data ranges from 0-1 in this case, and the difference (from the mean elevation) between the highest point on the moon (6.7 miles) and the lowest (-5.4 miles) is 12.1 miles, which when compared to the moon’s radius (1,079.6 miles) is about a 1.1 percent variation. So with a unit sphere representing the moon, our displacement scale is 0.011.</p>
<div><p>Let’s visualize the displacement on a basic small sphere mesh. :</p><p><span>I have to call <code>smooth_normals_mesh()</code> and <code>add_sphere_uv_mesh()</code> because the displacement algorithm here requires one UV coordinate/normal per vertex</span></p></div>
<div>
<div id="annotated-cell-16"><pre><code><span id="annotated-cell-16-1"><a href="#annotated-cell-16-1" aria-hidden="true" tabindex="-1"></a>lights <span>=</span> <span>directional_light</span>(<span>c</span>(<span>1</span>,<span>0</span>,<span>0</span>)) <span>|&gt;</span></span>
<span id="annotated-cell-16-2"><a href="#annotated-cell-16-2" aria-hidden="true" tabindex="-1"></a>  <span>add_light</span>(<span>directional_light</span>(<span>c</span>(<span>-</span><span>1</span>,<span>0</span>,<span>0</span>),</span>
<span id="annotated-cell-16-3"><a href="#annotated-cell-16-3" aria-hidden="true" tabindex="-1"></a>                              <span>color=</span><span>&#34;dodgerblue&#34;</span>,</span>
<span id="annotated-cell-16-4"><a href="#annotated-cell-16-4" aria-hidden="true" tabindex="-1"></a>                              <span>intensity=</span><span>1</span>))</span>
<span id="annotated-cell-16-5"><a href="#annotated-cell-16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-16-6"><a href="#annotated-cell-16-6" aria-hidden="true" tabindex="-1"></a>white_material <span>=</span> <span>material_list</span>(<span>diffuse =</span> <span>&#34;white&#34;</span>,</span>
<span id="annotated-cell-16-7"><a href="#annotated-cell-16-7" aria-hidden="true" tabindex="-1"></a>                               <span>ambient =</span> <span>&#34;white&#34;</span>,</span>
<span id="annotated-cell-16-8"><a href="#annotated-cell-16-8" aria-hidden="true" tabindex="-1"></a>                               <span>diffuse_intensity =</span> <span>0.9</span>,</span>
<span id="annotated-cell-16-9"><a href="#annotated-cell-16-9" aria-hidden="true" tabindex="-1"></a>                               <span>ambient_intensity =</span> <span>0.1</span>)</span>
<span id="annotated-cell-16-10"><a href="#annotated-cell-16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-16-11"><a href="#annotated-cell-16-11" aria-hidden="true" tabindex="-1"></a><span>sphere_mesh</span>(<span>material =</span> white_material) <span>|&gt;</span></span>
<span id="annotated-cell-16-12"><a href="#annotated-cell-16-12" aria-hidden="true" tabindex="-1"></a>  <span>smooth_normals_mesh</span>() <span>|&gt;</span></span>
<span id="annotated-cell-16-13"><a href="#annotated-cell-16-13" aria-hidden="true" tabindex="-1"></a>  <span>add_sphere_uv_mesh</span>(<span>override_existing =</span> <span>TRUE</span>) <span>-&gt;</span></span>
<span id="annotated-cell-16-14"><a href="#annotated-cell-16-14" aria-hidden="true" tabindex="-1"></a>basic_sphere_uv</span>
<span id="annotated-cell-16-15"><a href="#annotated-cell-16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-16-16"><a href="#annotated-cell-16-16" aria-hidden="true" tabindex="-1"></a>basic_sphere_uv <span>|&gt;</span></span>
<span id="annotated-cell-16-17"><a href="#annotated-cell-16-17" aria-hidden="true" tabindex="-1"></a>  <span>displace_mesh</span>(disp_moon, <span>displacement_scale =</span> <span>0.011</span>) <span>|&gt;</span></span>
<span id="annotated-cell-16-18"><a href="#annotated-cell-16-18" aria-hidden="true" tabindex="-1"></a>  <span>rasterize_scene</span>(<span>light_info =</span> lights, <span>width =</span> <span>1100</span>, <span>height =</span> <span>550</span>, <span>fov=</span><span>13</span>)</span></code></pre></div>
<div>
<dl>
<dt data-target-cell="annotated-cell-16" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="1,2,3,4" data-code-annotation="1">Generate the lighting for the scene</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="6,7,8,9" data-code-annotation="2">Generate the basic white material for the sphere</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="11,12,13,14" data-code-annotation="3">Create a smooth sphere and add unique normals and UV coordinates for each vertex</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="16,17,18" data-code-annotation="4">Displace the sphere with the moon data, scaled by 0.011, and render it</span>
</dd>
</dl>
</div>
<div>
<pre><code>Displacing mesh with 512x1024 texture</code></pre>
</div>
<div>
<pre><code>Setting `lookat` to: c(-0.00, -0.00, 0.00)</code></pre>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/moon_disp-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Wait–nothing happened? What went wrong? Well, let’s look at the mesh info and compare the number of vertices in the mesh to the resolution of the image:</p>
<div>

<div>
<pre><code>── Scene Description ───────────────────────────────────────────────────────────</code></pre>
</div>
<pre><code><span>•</span> Summary - <span>Meshes</span>: <span>1</span> | <span>Unique Materials</span>: <span>1</span>
<span>ℹ</span> XYZ Bounds - <span>Min</span>: <span>c(-1.00, -1.00, -1.00)</span> | <span>Max</span>: <span>c(1.00, 1.00, 1.00)</span>
            shapes  vertices texcoords   normals materials
         <span>&lt;ray_shp&gt;</span> <span>&lt;ray_dat&gt;</span> <span>&lt;ray_dat&gt;</span> <span>&lt;ray_dat&gt;</span> <span>&lt;ray_mat&gt;</span>
<span>1</span> <span>&lt;</span>T:<span>960</span><span>|</span><span>UV</span><span>|</span><span>N</span><span>|</span>M:<span>1</span><span>&gt;</span>   <span>&lt;</span><span>482</span><span>x</span><span>3</span><span>&gt;</span>   <span>&lt;</span><span>482</span><span>x</span><span>2</span><span>&gt;</span>   <span>&lt;</span><span>482</span><span>x</span><span>3</span><span>&gt;</span> <span>&lt;</span><span>diffuse</span><span>&gt;</span>
</code></pre>
</div>
<div>
<div id="annotated-cell-18"><pre><code><span id="annotated-cell-18-1"><a href="#annotated-cell-18-1" aria-hidden="true" tabindex="-1"></a><span>dim</span>(disp_moon)</span>
<span id="annotated-cell-18-2"><a href="#annotated-cell-18-2" aria-hidden="true" tabindex="-1"></a><span>prod</span>(<span>dim</span>(disp_moon)[<span>1</span><span>:</span><span>2</span>])</span></code></pre></div>
<div>
<dl>
<dt data-target-cell="annotated-cell-18" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="2" data-code-annotation="1">Multiply the dimensions of the texture together to get the number of pixels</span>
</dd>
</dl>
</div>
<div>
<pre><code>[1]  512 1024    3
[1] 524288</code></pre>
</div>
</div>
<p>So there’s half a million points, but only about 500 total vertices. Let’s write a function to show ourselves exactly where and how much of the displacement map we’re sampling. The green pixels are the places in the elevation model we are actually using to displace out mesh.</p>
<div>
<div id="annotated-cell-19"><pre><code><span id="annotated-cell-19-1"><a href="#annotated-cell-19-1" aria-hidden="true" tabindex="-1"></a>get_displacement_access_info <span>=</span> <span>function</span>(mesh, image) {</span>
<span id="annotated-cell-19-2"><a href="#annotated-cell-19-2" aria-hidden="true" tabindex="-1"></a>  image_coords <span>=</span> <span>round</span>(<span>matrix</span>(<span>dim</span>(image)[<span>2</span><span>:</span><span>1</span>]<span>-</span><span>1</span>,<span>ncol=</span><span>2</span>,</span>
<span id="annotated-cell-19-3"><a href="#annotated-cell-19-3" aria-hidden="true" tabindex="-1"></a>                         <span>nrow=</span><span>nrow</span>(mesh<span>$</span>texcoords[[<span>1</span>]]),</span>
<span id="annotated-cell-19-4"><a href="#annotated-cell-19-4" aria-hidden="true" tabindex="-1"></a>                         <span>byrow=</span><span>TRUE</span>) <span>*</span> mesh<span>$</span>texcoords[[<span>1</span>]])</span>
<span id="annotated-cell-19-5"><a href="#annotated-cell-19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-19-6"><a href="#annotated-cell-19-6" aria-hidden="true" tabindex="-1"></a>  <span>for</span>(i <span>in</span> <span>seq_len</span>(<span>nrow</span>(image_coords))) {</span>
<span id="annotated-cell-19-7"><a href="#annotated-cell-19-7" aria-hidden="true" tabindex="-1"></a>    image[<span>1</span><span>+</span>image_coords[i,<span>2</span>],<span>1</span><span>+</span>image_coords[i,<span>1</span>],<span>1</span><span>:</span><span>3</span>] <span>=</span> <span>c</span>(<span>0</span>,<span>1</span>,<span>0</span>)</span>
<span id="annotated-cell-19-8"><a href="#annotated-cell-19-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="annotated-cell-19-9"><a href="#annotated-cell-19-9" aria-hidden="true" tabindex="-1"></a>  total_pixels <span>=</span> <span>as.integer</span>(<span>prod</span>(<span>dim</span>(image)[<span>1</span><span>:</span><span>2</span>]))</span>
<span id="annotated-cell-19-10"><a href="#annotated-cell-19-10" aria-hidden="true" tabindex="-1"></a>  total_pixels_sampled <span>=</span> <span>as.integer</span>(<span>sum</span>(image[,,<span>1</span>] <span>==</span> <span>0</span> <span>&amp;</span> image[,,<span>2</span>] <span>==</span> <span>1</span> <span>&amp;</span> image[,,<span>3</span>] <span>==</span> <span>0</span>))</span>
<span id="annotated-cell-19-11"><a href="#annotated-cell-19-11" aria-hidden="true" tabindex="-1"></a>  <span>message</span>(<span>sprintf</span>(<span>&#34;Total pixels sampled: %i/%i (%0.5f%%)&#34;</span>,</span>
<span id="annotated-cell-19-12"><a href="#annotated-cell-19-12" aria-hidden="true" tabindex="-1"></a>                  total_pixels_sampled, total_pixels, total_pixels_sampled<span>/</span>total_pixels<span>*</span><span>100</span>))</span>
<span id="annotated-cell-19-13"><a href="#annotated-cell-19-13" aria-hidden="true" tabindex="-1"></a>  <span>plot_image</span>(image)</span>
<span id="annotated-cell-19-14"><a href="#annotated-cell-19-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-19-15"><a href="#annotated-cell-19-15" aria-hidden="true" tabindex="-1"></a><span>get_displacement_access_info</span>(basic_sphere_uv, disp_moon )</span></code></pre></div>
<div>
<dl>
<dt data-target-cell="annotated-cell-19" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="2,3,4" data-code-annotation="1">Take the UV coordinates (which range from 0-1) and map them to the pixel coordinates by multiplying the number of rows and columns by each UV pair.</span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="6,7,8" data-code-annotation="2">Loop over the image and set each accessed pixel to green.</span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="9" data-code-annotation="3">Calculate the total number of pixels.</span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="10" data-code-annotation="4">Calculate the total number of accessed (green) pixels.</span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="11,12" data-code-annotation="5">Print the access information.</span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="13" data-code-annotation="6">Plot the image with green pixels marking data used to displace the mesh.</span>
</dd>
</dl>
</div>
<div>
<pre><code>Total pixels sampled: 482/524288 (0.09193%)</code></pre>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/mesh_show_uv-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>So, we’re sampling 0.092% of the pixels in the image–no wonder it’s such a poor approximation! Let’s use subdivision to increase the size of our mesh, which should sample more of the underlying displacement texture and thus give us a better approximation.</p>
<div>
<div id="annotated-cell-20"><pre><code><span id="annotated-cell-20-1"><a href="#annotated-cell-20-1" aria-hidden="true" tabindex="-1"></a>generate_moon_mesh <span>=</span> <span>function</span>(subdivision_levels, displacement_texture, displacement_scale) {</span>
<span id="annotated-cell-20-2"><a href="#annotated-cell-20-2" aria-hidden="true" tabindex="-1"></a>  <span>sphere_mesh</span>(<span>material =</span> white_material) <span>|&gt;</span> </span>
<span id="annotated-cell-20-3"><a href="#annotated-cell-20-3" aria-hidden="true" tabindex="-1"></a>    <span>smooth_normals_mesh</span>() <span>|&gt;</span> </span>
<span id="annotated-cell-20-4"><a href="#annotated-cell-20-4" aria-hidden="true" tabindex="-1"></a>    <span>subdivide_mesh</span>(<span>subdivision_levels =</span> subdivision_levels) <span>|&gt;</span></span>
<span id="annotated-cell-20-5"><a href="#annotated-cell-20-5" aria-hidden="true" tabindex="-1"></a>    <span>add_sphere_uv_mesh</span>(<span>override_existing =</span> <span>TRUE</span>) <span>|&gt;</span></span>
<span id="annotated-cell-20-6"><a href="#annotated-cell-20-6" aria-hidden="true" tabindex="-1"></a>    <span>displace_mesh</span>(displacement_texture, displacement_scale) <span>|&gt;</span></span>
<span id="annotated-cell-20-7"><a href="#annotated-cell-20-7" aria-hidden="true" tabindex="-1"></a>    <span>rotate_mesh</span>(<span>c</span>(<span>0</span>,<span>90</span>,<span>0</span>))</span>
<span id="annotated-cell-20-8"><a href="#annotated-cell-20-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-20-9"><a href="#annotated-cell-20-9" aria-hidden="true" tabindex="-1"></a>moon_subdivided_2 <span>=</span> <span>generate_moon_mesh</span>(<span>2</span>, disp_moon, <span>0.011</span>)</span></code></pre></div>
<div>
<dl>
<dt data-target-cell="annotated-cell-20" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="4" data-code-annotation="1">Subdivide the moon</span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="5" data-code-annotation="2">Add new UV coords with a spherical mapping</span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="6" data-code-annotation="3">Displace with the displacement texture</span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="7" data-code-annotation="4">Rotate the mesh to orient it at the camera</span>
</dd>
</dl>
</div>
<div>
<pre><code>Displacing mesh with 512x1024 texture</code></pre>
</div>
<div id="cb14"><pre><code><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span>rasterize_scene</span>(moon_subdivided_2, <span>light_info =</span> lights,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                <span>width =</span> <span>1100</span>, <span>height =</span> <span>550</span>, <span>fov=</span><span>13</span>)</span></code></pre></div>
<div>
<pre><code>Setting `lookat` to: c(-0.00, -0.00, -0.00)</code></pre>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/subdivide_displace2-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Still looks nothing like the moon. Let’s check out the displacement texture access pattern.</p>
<div>
<div id="cb16"><pre><code><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span>get_displacement_access_info</span>(moon_subdivided_2, disp_moon )</span></code></pre></div>
<div>
<pre><code>Total pixels sampled: 7682/524288 (1.46523%)</code></pre>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/mesh_show_uv2-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Better, but still extremely sparse. What about three subdivision levels?</p>
<div>
<div id="cb18"><pre><code><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>moon_subdivided_3 <span>=</span> <span>generate_moon_mesh</span>(<span>3</span>, disp_moon, <span>0.011</span>)</span></code></pre></div>
<div>
<pre><code>Displacing mesh with 512x1024 texture</code></pre>
</div>
<div id="cb20"><pre><code><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span>rasterize_scene</span>(moon_subdivided_3, <span>light_info =</span> lights,</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                <span>width =</span> <span>1100</span>, <span>height =</span> <span>550</span>, <span>fov=</span><span>13</span>)</span></code></pre></div>
<div>
<pre><code>Setting `lookat` to: c(-0.00, -0.00, -0.00)</code></pre>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/subdivide_displace3-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Maybe some hints of craters? If you squint. Time to check the UV coords.</p>
<div>
<div id="cb22"><pre><code><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span>get_displacement_access_info</span>(moon_subdivided_3 , disp_moon )</span></code></pre></div>
<div>
<pre><code>Total pixels sampled: 30722/524288 (5.85976%)</code></pre>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/mesh_show_uv3-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Alright, so we’re sampling the big craters with a decent density of points. I’ll note here that at a resolution of 512x1024 and about 500 vertices in our original mesh, we’ll need about a factor of 1000x more vertices to densely sample from our UV texture. Let’s march on and see if that’s the case.</p>
<div>
<div id="cb24"><pre><code><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>moon_subdivided_4 <span>=</span> <span>generate_moon_mesh</span>(<span>4</span>, disp_moon, <span>0.011</span>)</span></code></pre></div>
<div>
<pre><code>Displacing mesh with 512x1024 texture</code></pre>
</div>
<div id="cb26"><pre><code><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span>rasterize_scene</span>(moon_subdivided_4, <span>light_info =</span> lights,</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>                <span>width =</span> <span>1100</span>, <span>height =</span> <span>550</span>, <span>fov=</span><span>13</span>)</span></code></pre></div>
<div>
<pre><code>Setting `lookat` to: c(-0.00, -0.00, -0.00)</code></pre>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/subdivide_displace4-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Okay, so we’re definitely starting to see distinct craters.</p>
<div>
<div id="cb28"><pre><code><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span>get_displacement_access_info</span>(moon_subdivided_4 , disp_moon )</span></code></pre></div>
<div>
<pre><code>Total pixels sampled: 122840/524288 (23.42987%)</code></pre>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/mesh_show_uv4-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Much denser, but not connected. So indeed, we shall proceed to five subdivision levels.</p>
<div>
<div id="cb30"><pre><code><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>moon_subdivided_5 <span>=</span> <span>generate_moon_mesh</span>(<span>5</span>, disp_moon, <span>0.011</span>)</span></code></pre></div>
<div>
<pre><code>Displacing mesh with 512x1024 texture</code></pre>
</div>
<div id="cb32"><pre><code><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span>rasterize_scene</span>(moon_subdivided_5, <span>light_info =</span> lights,</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>                <span>width =</span> <span>1100</span>, <span>height =</span> <span>550</span>, <span>fov=</span><span>13</span>)</span></code></pre></div>
<div>
<pre><code>Setting `lookat` to: c(-0.00, -0.00, -0.00)</code></pre>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/subdivide_displace5-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Look at that! Definite improvement over four. And the UV texcoord access?</p>
<div>
<div id="cb34"><pre><code><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span>get_displacement_access_info</span>(moon_subdivided_5, disp_moon )</span></code></pre></div>
<div>
<pre><code>Total pixels sampled: 467649/524288 (89.19697%)</code></pre>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/mesh_show_uv5-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Definitely lots of densely interconnected green, along with some interesting patterns from what I can only assume are interpolation and sampling artifacts related to the original mesh structure. We’ll do six levels and see if there’s any difference.</p>
<div>
<div id="cb36"><pre><code><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>moon_subdivided_6 <span>=</span> <span>generate_moon_mesh</span>(<span>6</span>, disp_moon, <span>0.011</span>)</span></code></pre></div>
<div>
<pre><code>Displacing mesh with 512x1024 texture</code></pre>
</div>
<div id="cb38"><pre><code><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span>rasterize_scene</span>(moon_subdivided_6, <span>light_info =</span> lights,</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>                <span>width =</span> <span>1100</span>, <span>height =</span> <span>550</span>, <span>fov=</span><span>13</span>)</span></code></pre></div>
<div>
<pre><code>Setting `lookat` to: c(-0.00, -0.00, -0.00)</code></pre>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/subdivide_displace6-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Everything’s a little sharper! But up close you can start to make out the individual pixels from the displacement mesh. Five is probably good enough.</p>
<div>

<div>
<pre><code>── Scene Description ───────────────────────────────────────────────────────────</code></pre>
</div>
<pre><code><span>•</span> Summary - <span>Meshes</span>: <span>1</span> | <span>Unique Materials</span>: <span>1</span>
<span>ℹ</span> XYZ Bounds - <span>Min</span>: <span>c(-0.99, -1.00, -0.99)</span> | <span>Max</span>: <span>c(0.99, 1.00, 0.99)</span>
                shapes    vertices   texcoords     normals materials
             <span>&lt;ray_shp&gt;</span>   <span>&lt;ray_dat&gt;</span>   <span>&lt;ray_dat&gt;</span>   <span>&lt;ray_dat&gt;</span> <span>&lt;ray_mat&gt;</span>
<span>1</span> <span>&lt;</span>T:<span>3932160</span><span>|</span><span>UV</span><span>|</span><span>N</span><span>|</span>M:<span>1</span><span>&gt;</span> <span>&lt;</span><span>1966082</span><span>x</span><span>3</span><span>&gt;</span> <span>&lt;</span><span>1966082</span><span>x</span><span>2</span><span>&gt;</span> <span>&lt;</span><span>1966082</span><span>x</span><span>3</span><span>&gt;</span> <span>&lt;</span><span>diffuse</span><span>&gt;</span>
</code></pre>
<div id="cb42"><pre><code><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span>get_displacement_access_info</span>(moon_subdivided_6, disp_moon )</span></code></pre></div>
<div>
<pre><code>Total pixels sampled: 504426/524288 (96.21162%)</code></pre>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/mesh_show_uv6-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>However, 2 million vertices is a lot of wasted memory to sample our half million pixel image. Let’s use the new <code>displacement_sphere()</code> function to generate a sphere that has exactly one vertex per pixel in our texture. That way we aren’t under or oversampling our image.</p>
<div>
<div id="cb44"><pre><code><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>moon_displacement_sphere <span>=</span> <span>displacement_sphere</span>(disp_moon, <span>displacement_scale =</span> <span>0.011</span>) <span>|&gt;</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span>set_material</span>(<span>material =</span> white_material) <span>|&gt;</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span>rotate_mesh</span>(<span>c</span>(<span>0</span>,<span>90</span>,<span>0</span>))</span></code></pre></div>
<div>
<pre><code>Displacing mesh with 512x1024 texture</code></pre>
</div>
<div id="cb46"><pre><code><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span>rasterize_scene</span>(moon_displacement_sphere, <span>light_info =</span> lights,</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>                <span>lookat=</span><span>c</span>(<span>0</span>,<span>0</span>,<span>0</span>), <span>lookfrom=</span><span>c</span>(<span>0</span>,<span>0</span>,<span>10</span>),</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                <span>width =</span> <span>1100</span>, <span>height =</span> <span>550</span>, <span>fov=</span><span>13</span>)</span></code></pre></div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/subdivide_displace_sphere-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Great! Let’s check out how much of the displacement texture was used to generate this mesh.</p>
<div>

<div>
<pre><code>── Scene Description ───────────────────────────────────────────────────────────</code></pre>
</div>
<pre><code><span>•</span> Summary - <span>Meshes</span>: <span>1</span> | <span>Unique Materials</span>: <span>1</span>
<span>ℹ</span> XYZ Bounds - <span>Min</span>: <span>c(-1.01, -1.01, -1.01)</span> | <span>Max</span>: <span>c(1.00, 1.01, 1.00)</span>
                shapes   vertices  texcoords    normals materials
             <span>&lt;ray_shp&gt;</span>  <span>&lt;ray_dat&gt;</span>  <span>&lt;ray_dat&gt;</span>  <span>&lt;ray_dat&gt;</span> <span>&lt;ray_mat&gt;</span>
<span>1</span> <span>&lt;</span>T:<span>1045506</span><span>|</span><span>UV</span><span>|</span><span>N</span><span>|</span>M:<span>1</span><span>&gt;</span> <span>&lt;</span><span>524288</span><span>x</span><span>3</span><span>&gt;</span> <span>&lt;</span><span>524288</span><span>x</span><span>2</span><span>&gt;</span> <span>&lt;</span><span>524288</span><span>x</span><span>3</span><span>&gt;</span> <span>&lt;</span><span>diffuse</span><span>&gt;</span>
</code></pre>
<div id="cb49"><pre><code><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span>get_displacement_access_info</span>(moon_displacement_sphere, disp_moon)</span></code></pre></div>
<div>
<pre><code>Total pixels sampled: 524288/524288 (100.00000%)</code></pre>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/disp_ideal-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>All green! Exactly as many vertices as pixels in the image, by construction. While this might sound good, this type of mesh can actually lead to visual artifacts. Let’s say we really cared about accurately visualizing the north and south poles. We’ll zoom in and see what they look like with this perfectly mapped mesh.</p>
<div>
<div id="cb51"><pre><code><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span>rasterize_scene</span>(moon_displacement_sphere, </span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>                <span>light_info =</span> <span>directional_light</span>(<span>c</span>(<span>0</span>,<span>1</span>,<span>-</span><span>1</span>)),</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>                <span>lookat=</span><span>c</span>(<span>0</span>,<span>1</span>,<span>0</span>), <span>lookfrom=</span><span>c</span>(<span>5</span>,<span>5</span>,<span>5</span>),</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>                <span>width =</span> <span>1100</span>, <span>height =</span> <span>550</span>, <span>fov=</span><span>2</span>) </span></code></pre></div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/poles-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Pucker up! We see here what’s referred to as “texture pinching” at the poles, which happens due to the convergence of the longitudinal lines and the corresponding increasing density of vertices. Not great for texturing if you have any interesting phenomena at the poles you want to accurately display. But there’s a better way to represent displaced data on a sphere: let’s take a cube object and subdivide it.</p>
<div>
<div id="annotated-cell-41"><pre><code><span id="annotated-cell-41-1"><a href="#annotated-cell-41-1" aria-hidden="true" tabindex="-1"></a><span>cube_mesh</span>(<span>material =</span> white_material) <span>|&gt;</span></span>
<span id="annotated-cell-41-2"><a href="#annotated-cell-41-2" aria-hidden="true" tabindex="-1"></a>  <span>subdivide_mesh</span>(<span>subdivision_levels =</span> <span>4</span>) <span>-&gt;</span></span>
<span id="annotated-cell-41-3"><a href="#annotated-cell-41-3" aria-hidden="true" tabindex="-1"></a>cube_low_res</span>
<span id="annotated-cell-41-4"><a href="#annotated-cell-41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-41-5"><a href="#annotated-cell-41-5" aria-hidden="true" tabindex="-1"></a><span>rasterize_scene</span>(cube_low_res, <span>light_info =</span> lights,</span>
<span id="annotated-cell-41-6"><a href="#annotated-cell-41-6" aria-hidden="true" tabindex="-1"></a>                <span>lookat=</span><span>c</span>(<span>0</span>,<span>0</span>,<span>0</span>), <span>lookfrom=</span><span>c</span>(<span>0</span>,<span>0</span>,<span>10</span>),</span>
<span id="annotated-cell-41-7"><a href="#annotated-cell-41-7" aria-hidden="true" tabindex="-1"></a>                <span>width =</span> <span>1100</span>, <span>height =</span> <span>550</span>, <span>fov=</span><span>6</span>)</span></code></pre></div>
<div>
<dl>
<dt data-target-cell="annotated-cell-41" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-41" data-code-lines="1,2,3" data-code-annotation="1">Subdivide a basic 8 vertex sphere</span>
</dd>
<dt data-target-cell="annotated-cell-41" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-41" data-code-lines="5,6,7" data-code-annotation="2">Render the subdivided sphere.</span>
</dd>
</dl>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/cube_example-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>This obviously isn’t a sphere, but we can fix that. Let’s project the vertices to a sphere centered at the origin. We’ll also remap the UV coordinates using the <code>add_sphere_uv_mesh()</code> function, and recalculate the normals post-projection using <code>smooth_normals_mesh()</code>.</p>
<div>
<div id="annotated-cell-42"><pre><code><span id="annotated-cell-42-1"><a href="#annotated-cell-42-1" aria-hidden="true" tabindex="-1"></a>map_cube_to_sphere <span>=</span> <span>function</span>(mesh) {</span>
<span id="annotated-cell-42-2"><a href="#annotated-cell-42-2" aria-hidden="true" tabindex="-1"></a>  project_vertex_to_sphere <span>=</span> <span>function</span>(x) {</span>
<span id="annotated-cell-42-3"><a href="#annotated-cell-42-3" aria-hidden="true" tabindex="-1"></a>    x<span>/</span><span>sqrt</span>(<span>sum</span>(x<span>*</span>x))</span>
<span id="annotated-cell-42-4"><a href="#annotated-cell-42-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="annotated-cell-42-5"><a href="#annotated-cell-42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-42-6"><a href="#annotated-cell-42-6" aria-hidden="true" tabindex="-1"></a>  mesh<span>$</span>vertices[[<span>1</span>]] <span>=</span> <span>t</span>(<span>apply</span>(mesh<span>$</span>vertices[[<span>1</span>]],<span>1</span>,project_vertex_to_sphere))</span>
<span id="annotated-cell-42-7"><a href="#annotated-cell-42-7" aria-hidden="true" tabindex="-1"></a>  <span>add_sphere_uv_mesh</span>(mesh, <span>override_existing =</span> <span>TRUE</span>) <span>|&gt;</span></span>
<span id="annotated-cell-42-8"><a href="#annotated-cell-42-8" aria-hidden="true" tabindex="-1"></a>    <span>smooth_normals_mesh</span>()</span>
<span id="annotated-cell-42-9"><a href="#annotated-cell-42-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-42-10"><a href="#annotated-cell-42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-42-11"><a href="#annotated-cell-42-11" aria-hidden="true" tabindex="-1"></a><span>cube_mesh</span>(<span>material =</span> white_material) <span>|&gt;</span></span>
<span id="annotated-cell-42-12"><a href="#annotated-cell-42-12" aria-hidden="true" tabindex="-1"></a>  <span>subdivide_mesh</span>(<span>subdivision_levels =</span> <span>9</span>) <span>|&gt;</span></span>
<span id="annotated-cell-42-13"><a href="#annotated-cell-42-13" aria-hidden="true" tabindex="-1"></a>  <span>map_cube_to_sphere</span>()  <span>-&gt;</span></span>
<span id="annotated-cell-42-14"><a href="#annotated-cell-42-14" aria-hidden="true" tabindex="-1"></a>spherized_cube</span>
<span id="annotated-cell-42-15"><a href="#annotated-cell-42-15" aria-hidden="true" tabindex="-1"></a>spherized_cube</span></code></pre></div>
<div>
<dl>
<dt data-target-cell="annotated-cell-42" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-42" data-code-lines="1" data-code-annotation="1">Define a function to transform a mesh to a sphere</span>
</dd>
<dt data-target-cell="annotated-cell-42" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-42" data-code-lines="2,3,4" data-code-annotation="2">Define helper function to map vertices (centered at zero) to a sphere by dividing by their length, measured from the origin.</span>
</dd>
<dt data-target-cell="annotated-cell-42" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-42" data-code-lines="6" data-code-annotation="3">Apply the helper function to all the vertices in the mesh</span>
</dd>
<dt data-target-cell="annotated-cell-42" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-42" data-code-lines="7,8" data-code-annotation="4">Add UV coords and normals</span>
</dd>
<dt data-target-cell="annotated-cell-42" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-42" data-code-lines="11,12,13,14" data-code-annotation="5">Subdivide the cube nine times to get approximately half a million vertices (to match the resolution of the displacement texture)</span>
</dd>
<dt data-target-cell="annotated-cell-42" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-42" data-code-lines="15" data-code-annotation="6">Print the new subdivided cube-to-sphere mesh info</span>
</dd>
</dl>
</div>
<div>
<pre><code>── Scene Description ───────────────────────────────────────────────────────────</code></pre>
</div>
<pre><code><span>•</span> Summary - <span>Meshes</span>: <span>1</span> | <span>Unique Materials</span>: <span>1</span>
<span>ℹ</span> XYZ Bounds - <span>Min</span>: <span>c(-1.00, -1.00, -1.00)</span> | <span>Max</span>: <span>c(1.00, 1.00, 1.00)</span>
                shapes    vertices   texcoords     normals materials
             <span>&lt;ray_shp&gt;</span>   <span>&lt;ray_dat&gt;</span>   <span>&lt;ray_dat&gt;</span>   <span>&lt;ray_dat&gt;</span> <span>&lt;ray_mat&gt;</span>
<span>1</span> <span>&lt;</span>T:<span>3145728</span><span>|</span><span>UV</span><span>|</span><span>N</span><span>|</span>M:<span>1</span><span>&gt;</span> <span>&lt;</span><span>1572866</span><span>x</span><span>3</span><span>&gt;</span> <span>&lt;</span><span>1572866</span><span>x</span><span>2</span><span>&gt;</span> <span>&lt;</span><span>1572866</span><span>x</span><span>3</span><span>&gt;</span> <span>&lt;</span><span>diffuse</span><span>&gt;</span>
</code></pre>
</div>
<div>
<div id="annotated-cell-43"><pre><code><span id="annotated-cell-43-1"><a href="#annotated-cell-43-1" aria-hidden="true" tabindex="-1"></a><span>rasterize_scene</span>(spherized_cube, <span>light_info =</span> lights,</span>
<span id="annotated-cell-43-2"><a href="#annotated-cell-43-2" aria-hidden="true" tabindex="-1"></a>                <span>lookat=</span><span>c</span>(<span>0</span>,<span>0</span>,<span>0</span>), <span>lookfrom=</span><span>c</span>(<span>0</span>,<span>0</span>,<span>10</span>),</span>
<span id="annotated-cell-43-3"><a href="#annotated-cell-43-3" aria-hidden="true" tabindex="-1"></a>                <span>width =</span> <span>1100</span>, <span>height =</span> <span>550</span>, <span>fov=</span><span>13</span>)</span></code></pre></div>

<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/unnamed-chunk-4-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<div><p>Looks like… a sphere. There’s nothing indicating this used to be a cube! And the nice thing about this mesh is it has no extreme convergence at the poles. Let’s displace the subdivided mesh and see how the moon looks.</p><p><span>“On the internet, no one knows you’re a cube.”</span></p></div>
<div>
<div id="annotated-cell-44"><pre><code><span id="annotated-cell-44-1"><a href="#annotated-cell-44-1" aria-hidden="true" tabindex="-1"></a>spherized_cube <span>|&gt;</span></span>
<span id="annotated-cell-44-2"><a href="#annotated-cell-44-2" aria-hidden="true" tabindex="-1"></a>  <span>displace_mesh</span>(disp_moon, <span>0.011</span>) <span>|&gt;</span></span>
<span id="annotated-cell-44-3"><a href="#annotated-cell-44-3" aria-hidden="true" tabindex="-1"></a>  <span>rotate_mesh</span>(<span>c</span>(<span>0</span>,<span>90</span>,<span>0</span>)) <span>-&gt;</span></span>
<span id="annotated-cell-44-4"><a href="#annotated-cell-44-4" aria-hidden="true" tabindex="-1"></a>cube_moon</span></code></pre></div>
<div>
<dl>
<dt data-target-cell="annotated-cell-44" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-44" data-code-lines="1,2,3,4" data-code-annotation="1">Displace the spherized cube</span>
</dd>
</dl>
</div>
<div>
<pre><code>Displacing mesh with 512x1024 texture</code></pre>
</div>
</div>
<div>
<div id="annotated-cell-45"><pre><code><span id="annotated-cell-45-1"><a href="#annotated-cell-45-1" aria-hidden="true" tabindex="-1"></a><span>rasterize_scene</span>(cube_moon, <span>light_info =</span> lights,</span>
<span id="annotated-cell-45-2"><a href="#annotated-cell-45-2" aria-hidden="true" tabindex="-1"></a>                <span>lookat=</span><span>c</span>(<span>0</span>,<span>0</span>,<span>0</span>), <span>lookfrom=</span><span>c</span>(<span>0</span>,<span>0</span>,<span>10</span>),</span>
<span id="annotated-cell-45-3"><a href="#annotated-cell-45-3" aria-hidden="true" tabindex="-1"></a>                <span>width =</span> <span>1100</span>, <span>height =</span> <span>550</span>, <span>fov=</span><span>13</span>)</span></code></pre></div>
<div>
<dl>
<dt data-target-cell="annotated-cell-45" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-45" data-code-lines="1,2,3" data-code-annotation="1">Render the displaced mesh</span>
</dd>
</dl>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/cube_moon_render-1.png" width="1100"/></p>
</figure>
</div>
</div>
</div>
<p>Looks good to me. Let’s compare the two polar meshes. Note that the initial poor rectangle-to-sphere mapping we did above is referred to as a “UV sphere” in 3D graphics.</p>
<div>
<div id="annotated-cell-46"><pre><code><span id="annotated-cell-46-1"><a href="#annotated-cell-46-1" aria-hidden="true" tabindex="-1"></a>moon_displacement_sphere <span>|&gt;</span></span>
<span id="annotated-cell-46-2"><a href="#annotated-cell-46-2" aria-hidden="true" tabindex="-1"></a>  <span>rasterize_scene</span>(<span>light_info =</span> <span>directional_light</span>(<span>c</span>(<span>0</span>,<span>1</span>,<span>-</span><span>1</span>)),</span>
<span id="annotated-cell-46-3"><a href="#annotated-cell-46-3" aria-hidden="true" tabindex="-1"></a>                  <span>lookat=</span><span>c</span>(<span>0</span>,<span>1</span>,<span>0</span>), <span>lookfrom=</span><span>c</span>(<span>5</span>,<span>5</span>,<span>5</span>),</span>
<span id="annotated-cell-46-4"><a href="#annotated-cell-46-4" aria-hidden="true" tabindex="-1"></a>                  <span>width =</span> <span>550</span>, <span>height =</span> <span>550</span>, <span>fov=</span><span>2</span>, <span>plot =</span> <span>FALSE</span>) <span>-&gt;</span></span>
<span id="annotated-cell-46-5"><a href="#annotated-cell-46-5" aria-hidden="true" tabindex="-1"></a>polar_image</span>
<span id="annotated-cell-46-6"><a href="#annotated-cell-46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-46-7"><a href="#annotated-cell-46-7" aria-hidden="true" tabindex="-1"></a>cube_moon <span>|&gt;</span></span>
<span id="annotated-cell-46-8"><a href="#annotated-cell-46-8" aria-hidden="true" tabindex="-1"></a>  <span>rasterize_scene</span>(<span>light_info =</span>  <span>directional_light</span>(<span>c</span>(<span>0</span>,<span>1</span>,<span>-</span><span>1</span>)),</span>
<span id="annotated-cell-46-9"><a href="#annotated-cell-46-9" aria-hidden="true" tabindex="-1"></a>                <span>lookat=</span><span>c</span>(<span>0</span>,<span>1</span>,<span>0</span>), <span>lookfrom=</span><span>c</span>(<span>5</span>,<span>5</span>,<span>5</span>),</span>
<span id="annotated-cell-46-10"><a href="#annotated-cell-46-10" aria-hidden="true" tabindex="-1"></a>                <span>width =</span> <span>550</span>, <span>height =</span> <span>550</span>, <span>fov=</span><span>2</span>, <span>plot =</span> <span>FALSE</span>) <span>-&gt;</span></span>
<span id="annotated-cell-46-11"><a href="#annotated-cell-46-11" aria-hidden="true" tabindex="-1"></a>polar_image_cube</span>
<span id="annotated-cell-46-12"><a href="#annotated-cell-46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-46-13"><a href="#annotated-cell-46-13" aria-hidden="true" tabindex="-1"></a><span>plot_image_grid</span>(<span>list</span>(polar_image,polar_image_cube),<span>dim =</span> <span>c</span>(<span>1</span>,<span>2</span>))</span></code></pre></div>
<div>
<dl>
<dt data-target-cell="annotated-cell-46" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-46" data-code-lines="1,2,3,4,5" data-code-annotation="1">Render and save the UV sphere displacement map to an image array</span>
</dd>
<dt data-target-cell="annotated-cell-46" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-46" data-code-lines="7,8,9,10,11" data-code-annotation="2">Render and save the spherized cube displacement map to an image array</span>
</dd>
<dt data-target-cell="annotated-cell-46" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-46" data-code-lines="13" data-code-annotation="3">Plot the images side by side using rayimage.</span>
</dd>
</dl>
</div>
<div>
<div>
<figure>
<p><img src="https://www.tylermw.com/posts/rayverse/displacement-mapping_files/figure-html/compare_polar_images-1.png" width="1100"/></p>
<figcaption>Left: UV sphere. Right: Spherized cube.</figcaption>
</figure>
</div>
</div>
</div>
<p>No celestial b-hole! This option is included in the <code>displacement_sphere()</code> function by setting <code>use_cube = TRUE</code>.</p>
<p>And that’s it for the new features in <code>rayvertex</code> and <code>rayrender</code>! <code>rayrender</code> has both of these features, but they aren’t standalone functions: they are built-in to the mesh functions that support textures (e.g. <code>mesh3d_model()</code>, <code>obj_model()</code>, and <code>raymesh_model()</code>. You can install the latest development versions of both packages from r-universe or github via the following:</p>
<div>
<div id="cb54"><pre><code><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span>install.packages</span>(<span>c</span>(<span>&#34;rayvertex&#34;</span>,<span>&#34;rayrender&#34;</span>), <span>repos =</span> <span>&#34;https://tylermorganwall.r-universe.dev&#34;</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span>#or</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>remotes<span>::</span><span>install_github</span>(<span>&#34;tylermorganwall/rayvertex&#34;</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>remotes<span>::</span><span>install_github</span>(<span>&#34;tylermorganwall/rayrender&#34;</span>)</span></code></pre></div>
</div>
</section>
<section id="summary">
<h2 data-anchor-id="summary">Summary</h2>
<p>In this post, we’ve explored the concepts of subdivision surfaces and displacement mapping. We began by discussing the fundamental challenges in 3D rendering, such as the difficulty of representing smooth and bumpy objects using flat, planar triangles. We then delved into historical solutions, like the use of micropolygons, and how modern techniques, including Loop subdivision, allow for the creation of detailed and smooth 3D models.</p>
<p>I demonstrated how to implement these techniques using the rayvertex, rayimage, and rayrender packages. I showed you how subdividing a mesh can significantly increase its resolution, allowing for smoother and more detailed surfaces. Additionally, we examined how displacement mapping can be used to add realistic texture to 3D models by manipulating vertex positions based on a 2D texture map.</p>
</section>
</main> 

</div></div>
  </body>
</html>
