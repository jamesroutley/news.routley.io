<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/srush/Tensor-Puzzles">Original</a>
    <h1>Tensor Puzzles</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<ul dir="auto">
<li>by <a href="http://rush-nlp.com" rel="nofollow">Sasha Rush</a> - <a href="https://twitter.com/srush_nlp" rel="nofollow">srush_nlp</a> (with Marcos Treviso)</li>
</ul>
<p dir="auto">When learning a tensor programming language like PyTorch or Numpy it
is tempting to rely on the standard library (or more honestly
StackOverflow) to find a magic function for everything.  But in
practice, the tensor language is extremely expressive, and you can
do most things from first principles and clever use of broadcasting.</p>
<p dir="auto">This is a collection of 21 tensor puzzles. Like chess puzzles these are
not meant to simulate the complexity of a real program, but to practice
in a simplified environment. Each puzzle asks you to reimplement one
function in the NumPy standard library without magic.</p>
<p dir="auto">I recommend running in Colab. Click here and copy the notebook to get start.</p>
<p dir="auto"><a href="https://colab.research.google.com/github/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers.ipynb" rel="nofollow"><img src="https://camo.githubusercontent.com/f5e0d0538a9c2972b5d413e0ace04cecd8efd828d133133933dfffec282a4e1b/68747470733a2f2f636f6c61622e72657365617263682e676f6f676c652e636f6d2f6173736574732f636f6c61622d62616467652e737667" alt="Open In Colab" data-canonical-src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<p dir="auto">If you are interested, there is also a youtube walkthrough of the puzzles</p>
<p dir="auto"><a href="https://youtu.be/Hafo7hIl8MU" rel="nofollow"><img src="https://camo.githubusercontent.com/a62a17dee8e8fdd46067516f6f292604608be2bd465c4a5a9cf27462fc2212e7/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f53697754417979767435732f64656661756c742e6a7067" alt="Watch the video" data-canonical-src="https://img.youtube.com/vi/SiwTAyyvt5s/default.jpg"/></a></p>
<div dir="auto" data-snippet-clipboard-copy-content="!pip install -qqq torchtyping hypothesis pytest git+https://github.com/danoneata/chalk@srush-patch-1
!wget -q https://github.com/srush/Tensor-Puzzles/raw/main/lib.py"><pre>!p<span>ip</span> <span>install</span> <span>-</span><span>qqq</span> <span>torchtyping</span> <span>hypothesis</span> <span>pytest</span> <span>git</span><span>+</span><span>https</span>:<span>//</span><span>github</span>.<span>com</span><span>/</span><span>danoneata</span><span>/</span><span>chalk</span>@<span>srush</span><span>-</span><span>patch</span><span>-</span><span>1</span>
!w<span>get</span> <span>-</span><span>q</span> <span>https</span>:<span>//</span><span>github</span>.<span>com</span><span>/</span><span>srush</span><span>/</span><span>Tensor</span><span>-</span><span>Puzzles</span><span>/</span><span>raw</span><span>/</span><span>main</span><span>/</span><span>lib</span>.<span>py</span></pre></div>
<div dir="auto" data-snippet-clipboard-copy-content="from lib import draw_examples, make_test, run_test
import torch
import numpy as np
from torchtyping import TensorType as TT
tensor = torch.tensor"><pre><span>from</span> <span>lib</span> <span>import</span> <span>draw_examples</span>, <span>make_test</span>, <span>run_test</span>
<span>import</span> <span>torch</span>
<span>import</span> <span>numpy</span> <span>as</span> <span>np</span>
<span>from</span> <span>torchtyping</span> <span>import</span> <span>TensorType</span> <span>as</span> <span>TT</span>
<span>tensor</span> <span>=</span> <span>torch</span>.<span>tensor</span></pre></div>

<ol dir="auto">
<li>These puzzles are about <em>broadcasting</em>. Know this rule.</li>
</ol>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/75af16f9099f8473e04eedb662376447802133951618c181d20023f443197b8e/68747470733a2f2f7062732e7477696d672e636f6d2f6d656469612f465179776f723057594173736e37593f666f726d61743d706e67266e616d653d6c61726765"><img src="https://camo.githubusercontent.com/75af16f9099f8473e04eedb662376447802133951618c181d20023f443197b8e/68747470733a2f2f7062732e7477696d672e636f6d2f6d656469612f465179776f723057594173736e37593f666f726d61743d706e67266e616d653d6c61726765" alt="" data-canonical-src="https://pbs.twimg.com/media/FQywor0WYAssn7Y?format=png&amp;name=large"/></a></p>
<ol start="2" dir="auto">
<li>
<p dir="auto">Each puzzle needs to be solved in 1 line (&lt;80 columns) of code.</p>
</li>
<li>
<p dir="auto">You are allowed @, arithmetic, comparison, <code>shape</code>, any indexing (e.g. <code>a[:j], a[:, None], a[arange(10)]</code>), and previous puzzle functions.</p>
</li>
<li>
<p dir="auto">You are <em>not allowed</em> anything else. No <code>view</code>, <code>sum</code>, <code>take</code>, <code>squeeze</code>, <code>tensor</code>.</p>
</li>
<li>
<p dir="auto">You can start with these two functions:</p>
</li>
</ol>
<div dir="auto" data-snippet-clipboard-copy-content="def arange(i: int):
    &#34;Use this function to replace a for-loop.&#34;
    return torch.tensor(range(i))

draw_examples(&#34;arange&#34;, [{&#34;&#34; : arange(i)} for i in [5, 3, 9]])"><pre><span>def</span> <span>arange</span>(<span>i</span>: <span>int</span>):
    <span>&#34;Use this function to replace a for-loop.&#34;</span>
    <span>return</span> <span>torch</span>.<span>tensor</span>(<span>range</span>(<span>i</span>))

<span>draw_examples</span>(<span>&#34;arange&#34;</span>, [{<span>&#34;&#34;</span> : <span>arange</span>(<span>i</span>)} <span>for</span> <span>i</span> <span>in</span> [<span>5</span>, <span>3</span>, <span>9</span>]])</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_7_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_7_0.svg" alt="svg"/></a></p>
<div dir="auto" data-snippet-clipboard-copy-content="# Example of broadcasting.
examples = [(arange(4), arange(5)[:, None]) ,
            (arange(3)[:, None], arange(2))]
draw_examples(&#34;broadcast&#34;, [{&#34;a&#34;: a, &#34;b&#34;:b, &#34;ret&#34;: a + b} for a, b in examples])"><pre><span># Example of broadcasting.</span>
<span>examples</span> <span>=</span> [(<span>arange</span>(<span>4</span>), <span>arange</span>(<span>5</span>)[:, <span>None</span>]) ,
            (<span>arange</span>(<span>3</span>)[:, <span>None</span>], <span>arange</span>(<span>2</span>))]
<span>draw_examples</span>(<span>&#34;broadcast&#34;</span>, [{<span>&#34;a&#34;</span>: <span>a</span>, <span>&#34;b&#34;</span>:<span>b</span>, <span>&#34;ret&#34;</span>: <span>a</span> <span>+</span> <span>b</span>} <span>for</span> <span>a</span>, <span>b</span> <span>in</span> <span>examples</span>])</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_8_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_8_0.svg" alt="svg"/></a></p>
<div dir="auto" data-snippet-clipboard-copy-content="def where(q, a, b):
    &#34;Use this function to replace an if-statement.&#34;
    return (q * a) + (~q) * b

# In diagrams, orange is positive/True, where is zero/False, and blue is negative.

examples = [(tensor([False]), tensor([10]), tensor([0])),
            (tensor([False, True]), tensor([1, 1]), tensor([-10, 0])),
            (tensor([False, True]), tensor([1]), tensor([-10, 0])),
            (tensor([[False, True], [True, False]]), tensor([1]), tensor([-10, 0])),
            (tensor([[False, True], [True, False]]), tensor([[0], [10]]), tensor([-10, 0])),
           ]
draw_examples(&#34;where&#34;, [{&#34;q&#34;: q, &#34;a&#34;:a, &#34;b&#34;:b, &#34;ret&#34;: where(q, a, b)} for q, a, b in examples])"><pre><span>def</span> <span>where</span>(<span>q</span>, <span>a</span>, <span>b</span>):
    <span>&#34;Use this function to replace an if-statement.&#34;</span>
    <span>return</span> (<span>q</span> <span>*</span> <span>a</span>) <span>+</span> (<span>~</span><span>q</span>) <span>*</span> <span>b</span>

<span># In diagrams, orange is positive/True, where is zero/False, and blue is negative.</span>

<span>examples</span> <span>=</span> [(<span>tensor</span>([<span>False</span>]), <span>tensor</span>([<span>10</span>]), <span>tensor</span>([<span>0</span>])),
            (<span>tensor</span>([<span>False</span>, <span>True</span>]), <span>tensor</span>([<span>1</span>, <span>1</span>]), <span>tensor</span>([<span>-</span><span>10</span>, <span>0</span>])),
            (<span>tensor</span>([<span>False</span>, <span>True</span>]), <span>tensor</span>([<span>1</span>]), <span>tensor</span>([<span>-</span><span>10</span>, <span>0</span>])),
            (<span>tensor</span>([[<span>False</span>, <span>True</span>], [<span>True</span>, <span>False</span>]]), <span>tensor</span>([<span>1</span>]), <span>tensor</span>([<span>-</span><span>10</span>, <span>0</span>])),
            (<span>tensor</span>([[<span>False</span>, <span>True</span>], [<span>True</span>, <span>False</span>]]), <span>tensor</span>([[<span>0</span>], [<span>10</span>]]), <span>tensor</span>([<span>-</span><span>10</span>, <span>0</span>])),
           ]
<span>draw_examples</span>(<span>&#34;where&#34;</span>, [{<span>&#34;q&#34;</span>: <span>q</span>, <span>&#34;a&#34;</span>:<span>a</span>, <span>&#34;b&#34;</span>:<span>b</span>, <span>&#34;ret&#34;</span>: <span>where</span>(<span>q</span>, <span>a</span>, <span>b</span>)} <span>for</span> <span>q</span>, <span>a</span>, <span>b</span> <span>in</span> <span>examples</span>])</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_9_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_9_0.svg" alt="svg"/></a></p>

<p dir="auto">Compute <a href="https://numpy.org/doc/stable/reference/generated/numpy.ones.html" rel="nofollow">ones</a> - the vector of all ones.</p>
<div dir="auto" data-snippet-clipboard-copy-content="def ones_spec(out):
    for i in range(len(out)):
        out[i] = 1
        
def ones(i: int) -&gt; TT[&#34;i&#34;]:
    raise NotImplementedError

test_ones = make_test(&#34;one&#34;, ones, ones_spec, add_sizes=[&#34;i&#34;])"><pre><span>def</span> <span>ones_spec</span>(<span>out</span>):
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>len</span>(<span>out</span>)):
        <span>out</span>[<span>i</span>] <span>=</span> <span>1</span>
        
<span>def</span> <span>ones</span>(<span>i</span>: <span>int</span>) <span>-&gt;</span> <span>TT</span>[<span>&#34;i&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>

<span>test_ones</span> <span>=</span> <span>make_test</span>(<span>&#34;one&#34;</span>, <span>ones</span>, <span>ones_spec</span>, <span>add_sizes</span><span>=</span>[<span>&#34;i&#34;</span>])</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_11_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_11_0.svg" alt="svg"/></a></p>


<p dir="auto">Compute <a href="https://numpy.org/doc/stable/reference/generated/numpy.sum.html" rel="nofollow">sum</a> - the sum of a vector.</p>
<div dir="auto" data-snippet-clipboard-copy-content="def sum_spec(a, out):
    out[0] = 0
    for i in range(len(a)):
        out[0] += a[i]
        
def sum(a: TT[&#34;i&#34;]) -&gt; TT[1]:
    raise NotImplementedError


test_sum = make_test(&#34;sum&#34;, sum, sum_spec)"><pre><span>def</span> <span>sum_spec</span>(<span>a</span>, <span>out</span>):
    <span>out</span>[<span>0</span>] <span>=</span> <span>0</span>
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>len</span>(<span>a</span>)):
        <span>out</span>[<span>0</span>] <span>+=</span> <span>a</span>[<span>i</span>]
        
<span>def</span> <span>sum</span>(<span>a</span>: <span>TT</span>[<span>&#34;i&#34;</span>]) <span>-&gt;</span> <span>TT</span>[<span>1</span>]:
    <span>raise</span> <span>NotImplementedError</span>


<span>test_sum</span> <span>=</span> <span>make_test</span>(<span>&#34;sum&#34;</span>, <span>sum</span>, <span>sum_spec</span>)</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_14_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_14_0.svg" alt="svg"/></a></p>


<p dir="auto">Compute <a href="https://numpy.org/doc/stable/reference/generated/numpy.outer.html" rel="nofollow">outer</a> - the outer product of two vectors.</p>
<div dir="auto" data-snippet-clipboard-copy-content="def outer_spec(a, b, out):
    for i in range(len(out)):
        for j in range(len(out[0])):
            out[i][j] = a[i] * b[j]
            
def outer(a: TT[&#34;i&#34;], b: TT[&#34;j&#34;]) -&gt; TT[&#34;i&#34;, &#34;j&#34;]:
    raise NotImplementedError
    
test_outer = make_test(&#34;outer&#34;, outer, outer_spec)"><pre><span>def</span> <span>outer_spec</span>(<span>a</span>, <span>b</span>, <span>out</span>):
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>len</span>(<span>out</span>)):
        <span>for</span> <span>j</span> <span>in</span> <span>range</span>(<span>len</span>(<span>out</span>[<span>0</span>])):
            <span>out</span>[<span>i</span>][<span>j</span>] <span>=</span> <span>a</span>[<span>i</span>] <span>*</span> <span>b</span>[<span>j</span>]
            
<span>def</span> <span>outer</span>(<span>a</span>: <span>TT</span>[<span>&#34;i&#34;</span>], <span>b</span>: <span>TT</span>[<span>&#34;j&#34;</span>]) <span>-&gt;</span> <span>TT</span>[<span>&#34;i&#34;</span>, <span>&#34;j&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>
    
<span>test_outer</span> <span>=</span> <span>make_test</span>(<span>&#34;outer&#34;</span>, <span>outer</span>, <span>outer_spec</span>)</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_17_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_17_0.svg" alt="svg"/></a></p>


<p dir="auto">Compute <a href="https://numpy.org/doc/stable/reference/generated/numpy.diag.html" rel="nofollow">diag</a> - the diagonal vector of a square matrix.</p>
<div dir="auto" data-snippet-clipboard-copy-content="def diag_spec(a, out):
    for i in range(len(a)):
        out[i] = a[i][i]
        
def diag(a: TT[&#34;i&#34;, &#34;i&#34;]) -&gt; TT[&#34;i&#34;]:
    raise NotImplementedError


test_diag = make_test(&#34;diag&#34;, diag, diag_spec)"><pre><span>def</span> <span>diag_spec</span>(<span>a</span>, <span>out</span>):
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>len</span>(<span>a</span>)):
        <span>out</span>[<span>i</span>] <span>=</span> <span>a</span>[<span>i</span>][<span>i</span>]
        
<span>def</span> <span>diag</span>(<span>a</span>: <span>TT</span>[<span>&#34;i&#34;</span>, <span>&#34;i&#34;</span>]) <span>-&gt;</span> <span>TT</span>[<span>&#34;i&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>


<span>test_diag</span> <span>=</span> <span>make_test</span>(<span>&#34;diag&#34;</span>, <span>diag</span>, <span>diag_spec</span>)</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_20_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_20_0.svg" alt="svg"/></a></p>


<p dir="auto">Compute <a href="https://numpy.org/doc/stable/reference/generated/numpy.eye.html" rel="nofollow">eye</a> - the identity matrix.</p>
<div dir="auto" data-snippet-clipboard-copy-content="def eye_spec(out):
    for i in range(len(out)):
        out[i][i] = 1
        
def eye(j: int) -&gt; TT[&#34;j&#34;, &#34;j&#34;]:
    raise NotImplementedError
    
test_eye = make_test(&#34;eye&#34;, eye, eye_spec, add_sizes=[&#34;j&#34;])"><pre><span>def</span> <span>eye_spec</span>(<span>out</span>):
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>len</span>(<span>out</span>)):
        <span>out</span>[<span>i</span>][<span>i</span>] <span>=</span> <span>1</span>
        
<span>def</span> <span>eye</span>(<span>j</span>: <span>int</span>) <span>-&gt;</span> <span>TT</span>[<span>&#34;j&#34;</span>, <span>&#34;j&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>
    
<span>test_eye</span> <span>=</span> <span>make_test</span>(<span>&#34;eye&#34;</span>, <span>eye</span>, <span>eye_spec</span>, <span>add_sizes</span><span>=</span>[<span>&#34;j&#34;</span>])</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_23_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_23_0.svg" alt="svg"/></a></p>


<p dir="auto">Compute <a href="https://numpy.org/doc/stable/reference/generated/numpy.triu.html" rel="nofollow">triu</a> - the upper triangular matrix.</p>
<div dir="auto" data-snippet-clipboard-copy-content="def triu_spec(out):
    for i in range(len(out)):
        for j in range(len(out)):
            if i &lt;= j:
                out[i][j] = 1
            else:
                out[i][j] = 0
                
def triu(j: int) -&gt; TT[&#34;j&#34;, &#34;j&#34;]:
    raise NotImplementedError


test_triu = make_test(&#34;triu&#34;, triu, triu_spec, add_sizes=[&#34;j&#34;])"><pre><span>def</span> <span>triu_spec</span>(<span>out</span>):
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>len</span>(<span>out</span>)):
        <span>for</span> <span>j</span> <span>in</span> <span>range</span>(<span>len</span>(<span>out</span>)):
            <span>if</span> <span>i</span> <span>&lt;=</span> <span>j</span>:
                <span>out</span>[<span>i</span>][<span>j</span>] <span>=</span> <span>1</span>
            <span>else</span>:
                <span>out</span>[<span>i</span>][<span>j</span>] <span>=</span> <span>0</span>
                
<span>def</span> <span>triu</span>(<span>j</span>: <span>int</span>) <span>-&gt;</span> <span>TT</span>[<span>&#34;j&#34;</span>, <span>&#34;j&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>


<span>test_triu</span> <span>=</span> <span>make_test</span>(<span>&#34;triu&#34;</span>, <span>triu</span>, <span>triu_spec</span>, <span>add_sizes</span><span>=</span>[<span>&#34;j&#34;</span>])</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_26_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_26_0.svg" alt="svg"/></a></p>


<p dir="auto">Compute <a href="https://numpy.org/doc/stable/reference/generated/numpy.cumsum.html" rel="nofollow">cumsum</a> - the cumulative sum.</p>
<div dir="auto" data-snippet-clipboard-copy-content="def cumsum_spec(a, out):
    total = 0
    for i in range(len(out)):
        out[i] = total + a[i]
        total += a[i]

def cumsum(a: TT[&#34;i&#34;]) -&gt; TT[&#34;i&#34;]:
    raise NotImplementedError

test_cumsum = make_test(&#34;cumsum&#34;, cumsum, cumsum_spec)"><pre><span>def</span> <span>cumsum_spec</span>(<span>a</span>, <span>out</span>):
    <span>total</span> <span>=</span> <span>0</span>
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>len</span>(<span>out</span>)):
        <span>out</span>[<span>i</span>] <span>=</span> <span>total</span> <span>+</span> <span>a</span>[<span>i</span>]
        <span>total</span> <span>+=</span> <span>a</span>[<span>i</span>]

<span>def</span> <span>cumsum</span>(<span>a</span>: <span>TT</span>[<span>&#34;i&#34;</span>]) <span>-&gt;</span> <span>TT</span>[<span>&#34;i&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>

<span>test_cumsum</span> <span>=</span> <span>make_test</span>(<span>&#34;cumsum&#34;</span>, <span>cumsum</span>, <span>cumsum_spec</span>)</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_29_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_29_0.svg" alt="svg"/></a></p>


<p dir="auto">Compute <a href="https://numpy.org/doc/stable/reference/generated/numpy.diff.html" rel="nofollow">diff</a> - the running difference.</p>
<div dir="auto" data-snippet-clipboard-copy-content="def diff_spec(a, out):
    out[0] = a[0]
    for i in range(1, len(out)):
        out[i] = a[i] - a[i - 1]

def diff(a: TT[&#34;i&#34;], i: int) -&gt; TT[&#34;i&#34;]:
    raise NotImplementedError

test_diff = make_test(&#34;diff&#34;, diff, diff_spec, add_sizes=[&#34;i&#34;])"><pre><span>def</span> <span>diff_spec</span>(<span>a</span>, <span>out</span>):
    <span>out</span>[<span>0</span>] <span>=</span> <span>a</span>[<span>0</span>]
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>1</span>, <span>len</span>(<span>out</span>)):
        <span>out</span>[<span>i</span>] <span>=</span> <span>a</span>[<span>i</span>] <span>-</span> <span>a</span>[<span>i</span> <span>-</span> <span>1</span>]

<span>def</span> <span>diff</span>(<span>a</span>: <span>TT</span>[<span>&#34;i&#34;</span>], <span>i</span>: <span>int</span>) <span>-&gt;</span> <span>TT</span>[<span>&#34;i&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>

<span>test_diff</span> <span>=</span> <span>make_test</span>(<span>&#34;diff&#34;</span>, <span>diff</span>, <span>diff_spec</span>, <span>add_sizes</span><span>=</span>[<span>&#34;i&#34;</span>])</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_32_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_32_0.svg" alt="svg"/></a></p>


<p dir="auto">Compute <a href="https://numpy.org/doc/stable/reference/generated/numpy.vstack.html" rel="nofollow">vstack</a> - the matrix of two vectors</p>
<div dir="auto" data-snippet-clipboard-copy-content="def vstack_spec(a, b, out):
    for i in range(len(out[0])):
        out[0][i] = a[i]
        out[1][i] = b[i]

def vstack(a: TT[&#34;i&#34;], b: TT[&#34;i&#34;]) -&gt; TT[2, &#34;i&#34;]:
    raise NotImplementedError


test_vstack = make_test(&#34;vstack&#34;, vstack, vstack_spec)"><pre><span>def</span> <span>vstack_spec</span>(<span>a</span>, <span>b</span>, <span>out</span>):
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>len</span>(<span>out</span>[<span>0</span>])):
        <span>out</span>[<span>0</span>][<span>i</span>] <span>=</span> <span>a</span>[<span>i</span>]
        <span>out</span>[<span>1</span>][<span>i</span>] <span>=</span> <span>b</span>[<span>i</span>]

<span>def</span> <span>vstack</span>(<span>a</span>: <span>TT</span>[<span>&#34;i&#34;</span>], <span>b</span>: <span>TT</span>[<span>&#34;i&#34;</span>]) <span>-&gt;</span> <span>TT</span>[<span>2</span>, <span>&#34;i&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>


<span>test_vstack</span> <span>=</span> <span>make_test</span>(<span>&#34;vstack&#34;</span>, <span>vstack</span>, <span>vstack_spec</span>)</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_35_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_35_0.svg" alt="svg"/></a></p>


<p dir="auto">Compute <a href="https://numpy.org/doc/stable/reference/generated/numpy.roll.html" rel="nofollow">roll</a> - the vector shifted 1 circular position.</p>
<div dir="auto" data-snippet-clipboard-copy-content="def roll_spec(a, out):
    for i in range(len(out)):
        if i + 1 &lt; len(out):
            out[i] = a[i + 1]
        else:
            out[i] = a[i + 1 - len(out)]
            
def roll(a: TT[&#34;i&#34;], i: int) -&gt; TT[&#34;i&#34;]:
    raise NotImplementedError


test_roll = make_test(&#34;roll&#34;, roll, roll_spec, add_sizes=[&#34;i&#34;])"><pre><span>def</span> <span>roll_spec</span>(<span>a</span>, <span>out</span>):
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>len</span>(<span>out</span>)):
        <span>if</span> <span>i</span> <span>+</span> <span>1</span> <span>&lt;</span> <span>len</span>(<span>out</span>):
            <span>out</span>[<span>i</span>] <span>=</span> <span>a</span>[<span>i</span> <span>+</span> <span>1</span>]
        <span>else</span>:
            <span>out</span>[<span>i</span>] <span>=</span> <span>a</span>[<span>i</span> <span>+</span> <span>1</span> <span>-</span> <span>len</span>(<span>out</span>)]
            
<span>def</span> <span>roll</span>(<span>a</span>: <span>TT</span>[<span>&#34;i&#34;</span>], <span>i</span>: <span>int</span>) <span>-&gt;</span> <span>TT</span>[<span>&#34;i&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>


<span>test_roll</span> <span>=</span> <span>make_test</span>(<span>&#34;roll&#34;</span>, <span>roll</span>, <span>roll_spec</span>, <span>add_sizes</span><span>=</span>[<span>&#34;i&#34;</span>])</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_38_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_38_0.svg" alt="svg"/></a></p>


<p dir="auto">Compute <a href="https://numpy.org/doc/stable/reference/generated/numpy.flip.html" rel="nofollow">flip</a> - the reversed vector</p>
<div dir="auto" data-snippet-clipboard-copy-content="def flip_spec(a, out):
    for i in range(len(out)):
        out[i] = a[len(out) - i - 1]
        
def flip(a: TT[&#34;i&#34;], i: int) -&gt; TT[&#34;i&#34;]:
    raise NotImplementedError


test_flip = make_test(&#34;flip&#34;, flip, flip_spec, add_sizes=[&#34;i&#34;])"><pre><span>def</span> <span>flip_spec</span>(<span>a</span>, <span>out</span>):
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>len</span>(<span>out</span>)):
        <span>out</span>[<span>i</span>] <span>=</span> <span>a</span>[<span>len</span>(<span>out</span>) <span>-</span> <span>i</span> <span>-</span> <span>1</span>]
        
<span>def</span> <span>flip</span>(<span>a</span>: <span>TT</span>[<span>&#34;i&#34;</span>], <span>i</span>: <span>int</span>) <span>-&gt;</span> <span>TT</span>[<span>&#34;i&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>


<span>test_flip</span> <span>=</span> <span>make_test</span>(<span>&#34;flip&#34;</span>, <span>flip</span>, <span>flip_spec</span>, <span>add_sizes</span><span>=</span>[<span>&#34;i&#34;</span>])</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_41_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_41_0.svg" alt="svg"/></a></p>


<p dir="auto">Compute <a href="https://numpy.org/doc/stable/reference/generated/numpy.compress.html" rel="nofollow">compress</a> - keep only masked entries (left-aligned).</p>
<div dir="auto" data-snippet-clipboard-copy-content="def compress_spec(g, v, out):
    j = 0
    for i in range(len(g)):
        if g[i]:
            out[j] = v[i]
            j += 1
            
def compress(g: TT[&#34;i&#34;, bool], v: TT[&#34;i&#34;], i:int) -&gt; TT[&#34;i&#34;]:
    raise NotImplementedError


test_compress = make_test(&#34;compress&#34;, compress, compress_spec, add_sizes=[&#34;i&#34;])"><pre><span>def</span> <span>compress_spec</span>(<span>g</span>, <span>v</span>, <span>out</span>):
    <span>j</span> <span>=</span> <span>0</span>
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>len</span>(<span>g</span>)):
        <span>if</span> <span>g</span>[<span>i</span>]:
            <span>out</span>[<span>j</span>] <span>=</span> <span>v</span>[<span>i</span>]
            <span>j</span> <span>+=</span> <span>1</span>
            
<span>def</span> <span>compress</span>(<span>g</span>: <span>TT</span>[<span>&#34;i&#34;</span>, <span>bool</span>], <span>v</span>: <span>TT</span>[<span>&#34;i&#34;</span>], <span>i</span>:<span>int</span>) <span>-&gt;</span> <span>TT</span>[<span>&#34;i&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>


<span>test_compress</span> <span>=</span> <span>make_test</span>(<span>&#34;compress&#34;</span>, <span>compress</span>, <span>compress_spec</span>, <span>add_sizes</span><span>=</span>[<span>&#34;i&#34;</span>])</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_44_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_44_0.svg" alt="svg"/></a></p>
<div dir="auto" data-snippet-clipboard-copy-content="# run_test(test_compress)"><pre><span># run_test(test_compress)</span></pre></div>

<p dir="auto">Compute pad_to - eliminate or add 0s to change size of vector.</p>
<div dir="auto" data-snippet-clipboard-copy-content="def pad_to_spec(a, out):
    for i in range(min(len(out), len(a))):
        out[i] = a[i]


def pad_to(a: TT[&#34;i&#34;], i: int, j: int) -&gt; TT[&#34;j&#34;]:
    raise NotImplementedError


test_pad_to = make_test(&#34;pad_to&#34;, pad_to, pad_to_spec, add_sizes=[&#34;i&#34;, &#34;j&#34;])"><pre><span>def</span> <span>pad_to_spec</span>(<span>a</span>, <span>out</span>):
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>min</span>(<span>len</span>(<span>out</span>), <span>len</span>(<span>a</span>))):
        <span>out</span>[<span>i</span>] <span>=</span> <span>a</span>[<span>i</span>]


<span>def</span> <span>pad_to</span>(<span>a</span>: <span>TT</span>[<span>&#34;i&#34;</span>], <span>i</span>: <span>int</span>, <span>j</span>: <span>int</span>) <span>-&gt;</span> <span>TT</span>[<span>&#34;j&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>


<span>test_pad_to</span> <span>=</span> <span>make_test</span>(<span>&#34;pad_to&#34;</span>, <span>pad_to</span>, <span>pad_to_spec</span>, <span>add_sizes</span><span>=</span>[<span>&#34;i&#34;</span>, <span>&#34;j&#34;</span>])</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_47_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_47_0.svg" alt="svg"/></a></p>

<div dir="auto"><h2 tabindex="-1" dir="auto">Puzzle 14 - sequence_mask</h2><a id="user-content-puzzle-14---sequence_mask" aria-label="Permalink: Puzzle 14 - sequence_mask" href="#puzzle-14---sequence_mask"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Compute <a href="https://www.tensorflow.org/api_docs/python/tf/sequence_mask" rel="nofollow">sequence_mask</a> - pad out to length per batch.</p>
<div dir="auto" data-snippet-clipboard-copy-content="def sequence_mask_spec(values, length, out):
    for i in range(len(out)):
        for j in range(len(out[0])):
            if j &lt; length[i]:
                out[i][j] = values[i][j]
            else:
                out[i][j] = 0
    
def sequence_mask(values: TT[&#34;i&#34;, &#34;j&#34;], length: TT[&#34;i&#34;, int]) -&gt; TT[&#34;i&#34;, &#34;j&#34;]:
    raise NotImplementedError


def constraint_set_length(d):
    d[&#34;length&#34;] = d[&#34;length&#34;] % d[&#34;values&#34;].shape[1]
    return d


test_sequence = make_test(&#34;sequence_mask&#34;,
    sequence_mask, sequence_mask_spec, constraint=constraint_set_length
)"><pre><span>def</span> <span>sequence_mask_spec</span>(<span>values</span>, <span>length</span>, <span>out</span>):
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>len</span>(<span>out</span>)):
        <span>for</span> <span>j</span> <span>in</span> <span>range</span>(<span>len</span>(<span>out</span>[<span>0</span>])):
            <span>if</span> <span>j</span> <span>&lt;</span> <span>length</span>[<span>i</span>]:
                <span>out</span>[<span>i</span>][<span>j</span>] <span>=</span> <span>values</span>[<span>i</span>][<span>j</span>]
            <span>else</span>:
                <span>out</span>[<span>i</span>][<span>j</span>] <span>=</span> <span>0</span>
    
<span>def</span> <span>sequence_mask</span>(<span>values</span>: <span>TT</span>[<span>&#34;i&#34;</span>, <span>&#34;j&#34;</span>], <span>length</span>: <span>TT</span>[<span>&#34;i&#34;</span>, <span>int</span>]) <span>-&gt;</span> <span>TT</span>[<span>&#34;i&#34;</span>, <span>&#34;j&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>


<span>def</span> <span>constraint_set_length</span>(<span>d</span>):
    <span>d</span>[<span>&#34;length&#34;</span>] <span>=</span> <span>d</span>[<span>&#34;length&#34;</span>] <span>%</span> <span>d</span>[<span>&#34;values&#34;</span>].<span>shape</span>[<span>1</span>]
    <span>return</span> <span>d</span>


<span>test_sequence</span> <span>=</span> <span>make_test</span>(<span>&#34;sequence_mask&#34;</span>,
    <span>sequence_mask</span>, <span>sequence_mask_spec</span>, <span>constraint</span><span>=</span><span>constraint_set_length</span>
)</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_50_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_50_0.svg" alt="svg"/></a></p>
<div dir="auto" data-snippet-clipboard-copy-content="# run_test(test_sequence)"><pre><span># run_test(test_sequence)</span></pre></div>

<p dir="auto">Compute <a href="https://numpy.org/doc/stable/reference/generated/numpy.bincount.html" rel="nofollow">bincount</a> - count number of times an entry was seen.</p>
<div dir="auto" data-snippet-clipboard-copy-content="def bincount_spec(a, out):
    for i in range(len(a)):
        out[a[i]] += 1
        
def bincount(a: TT[&#34;i&#34;], j: int) -&gt; TT[&#34;j&#34;]:
    raise NotImplementedError


def constraint_set_max(d):
    d[&#34;a&#34;] = d[&#34;a&#34;] % d[&#34;return&#34;].shape[0]
    return d


test_bincount = make_test(&#34;bincount&#34;,
    bincount, bincount_spec, add_sizes=[&#34;j&#34;], constraint=constraint_set_max
)"><pre><span>def</span> <span>bincount_spec</span>(<span>a</span>, <span>out</span>):
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>len</span>(<span>a</span>)):
        <span>out</span>[<span>a</span>[<span>i</span>]] <span>+=</span> <span>1</span>
        
<span>def</span> <span>bincount</span>(<span>a</span>: <span>TT</span>[<span>&#34;i&#34;</span>], <span>j</span>: <span>int</span>) <span>-&gt;</span> <span>TT</span>[<span>&#34;j&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>


<span>def</span> <span>constraint_set_max</span>(<span>d</span>):
    <span>d</span>[<span>&#34;a&#34;</span>] <span>=</span> <span>d</span>[<span>&#34;a&#34;</span>] <span>%</span> <span>d</span>[<span>&#34;return&#34;</span>].<span>shape</span>[<span>0</span>]
    <span>return</span> <span>d</span>


<span>test_bincount</span> <span>=</span> <span>make_test</span>(<span>&#34;bincount&#34;</span>,
    <span>bincount</span>, <span>bincount_spec</span>, <span>add_sizes</span><span>=</span>[<span>&#34;j&#34;</span>], <span>constraint</span><span>=</span><span>constraint_set_max</span>
)</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_53_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_53_0.svg" alt="svg"/></a></p>
<div dir="auto" data-snippet-clipboard-copy-content="# run_test(test_bincount)"><pre><span># run_test(test_bincount)</span></pre></div>

<p dir="auto">Compute <a href="https://pytorch-scatter.readthedocs.io/en/1.3.0/functions/add.html" rel="nofollow">scatter_add</a> - add together values that link to the same location.</p>
<div dir="auto" data-snippet-clipboard-copy-content="def scatter_add_spec(values, link, out):
    for j in range(len(values)):
        out[link[j]] += values[j]
        
def scatter_add(values: TT[&#34;i&#34;], link: TT[&#34;i&#34;], j: int) -&gt; TT[&#34;j&#34;]:
    raise NotImplementedError


def constraint_set_max(d):
    d[&#34;link&#34;] = d[&#34;link&#34;] % d[&#34;return&#34;].shape[0]
    return d


test_scatter_add = make_test(&#34;scatter_add&#34;,
    scatter_add, scatter_add_spec, add_sizes=[&#34;j&#34;], constraint=constraint_set_max
)"><pre><span>def</span> <span>scatter_add_spec</span>(<span>values</span>, <span>link</span>, <span>out</span>):
    <span>for</span> <span>j</span> <span>in</span> <span>range</span>(<span>len</span>(<span>values</span>)):
        <span>out</span>[<span>link</span>[<span>j</span>]] <span>+=</span> <span>values</span>[<span>j</span>]
        
<span>def</span> <span>scatter_add</span>(<span>values</span>: <span>TT</span>[<span>&#34;i&#34;</span>], <span>link</span>: <span>TT</span>[<span>&#34;i&#34;</span>], <span>j</span>: <span>int</span>) <span>-&gt;</span> <span>TT</span>[<span>&#34;j&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>


<span>def</span> <span>constraint_set_max</span>(<span>d</span>):
    <span>d</span>[<span>&#34;link&#34;</span>] <span>=</span> <span>d</span>[<span>&#34;link&#34;</span>] <span>%</span> <span>d</span>[<span>&#34;return&#34;</span>].<span>shape</span>[<span>0</span>]
    <span>return</span> <span>d</span>


<span>test_scatter_add</span> <span>=</span> <span>make_test</span>(<span>&#34;scatter_add&#34;</span>,
    <span>scatter_add</span>, <span>scatter_add_spec</span>, <span>add_sizes</span><span>=</span>[<span>&#34;j&#34;</span>], <span>constraint</span><span>=</span><span>constraint_set_max</span>
)</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_56_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_56_0.svg" alt="svg"/></a></p>
<div dir="auto" data-snippet-clipboard-copy-content="# run_test(test_scatter_add)"><pre><span># run_test(test_scatter_add)</span></pre></div>

<p dir="auto">Compute <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.flatten.html" rel="nofollow">flatten</a></p>
<div dir="auto" data-snippet-clipboard-copy-content="def flatten_spec(a, out):
    k = 0
    for i in range(len(a)):
        for j in range(len(a[0])):
            out[k] = a[i][j]
            k += 1

def flatten(a: TT[&#34;i&#34;, &#34;j&#34;], i:int, j:int) -&gt; TT[&#34;i * j&#34;]:
    raise NotImplementedError

test_flatten = make_test(&#34;flatten&#34;, flatten, flatten_spec, add_sizes=[&#34;i&#34;, &#34;j&#34;])"><pre><span>def</span> <span>flatten_spec</span>(<span>a</span>, <span>out</span>):
    <span>k</span> <span>=</span> <span>0</span>
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>len</span>(<span>a</span>)):
        <span>for</span> <span>j</span> <span>in</span> <span>range</span>(<span>len</span>(<span>a</span>[<span>0</span>])):
            <span>out</span>[<span>k</span>] <span>=</span> <span>a</span>[<span>i</span>][<span>j</span>]
            <span>k</span> <span>+=</span> <span>1</span>

<span>def</span> <span>flatten</span>(<span>a</span>: <span>TT</span>[<span>&#34;i&#34;</span>, <span>&#34;j&#34;</span>], <span>i</span>:<span>int</span>, <span>j</span>:<span>int</span>) <span>-&gt;</span> <span>TT</span>[<span>&#34;i * j&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>

<span>test_flatten</span> <span>=</span> <span>make_test</span>(<span>&#34;flatten&#34;</span>, <span>flatten</span>, <span>flatten_spec</span>, <span>add_sizes</span><span>=</span>[<span>&#34;i&#34;</span>, <span>&#34;j&#34;</span>])</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_59_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_59_0.svg" alt="svg"/></a></p>


<p dir="auto">Compute <a href="https://numpy.org/doc/stable/reference/generated/numpy.linspace.html" rel="nofollow">linspace</a></p>
<div dir="auto" data-snippet-clipboard-copy-content="def linspace_spec(i, j, out):
    for k in range(len(out)):
        out[k] = float(i + (j - i) * k / max(1, len(out) - 1))

def linspace(i: TT[1], j: TT[1], n: int) -&gt; TT[&#34;n&#34;, float]:
    raise NotImplementedError

test_linspace = make_test(&#34;linspace&#34;, linspace, linspace_spec, add_sizes=[&#34;n&#34;])"><pre><span>def</span> <span>linspace_spec</span>(<span>i</span>, <span>j</span>, <span>out</span>):
    <span>for</span> <span>k</span> <span>in</span> <span>range</span>(<span>len</span>(<span>out</span>)):
        <span>out</span>[<span>k</span>] <span>=</span> <span>float</span>(<span>i</span> <span>+</span> (<span>j</span> <span>-</span> <span>i</span>) <span>*</span> <span>k</span> <span>/</span> <span>max</span>(<span>1</span>, <span>len</span>(<span>out</span>) <span>-</span> <span>1</span>))

<span>def</span> <span>linspace</span>(<span>i</span>: <span>TT</span>[<span>1</span>], <span>j</span>: <span>TT</span>[<span>1</span>], <span>n</span>: <span>int</span>) <span>-&gt;</span> <span>TT</span>[<span>&#34;n&#34;</span>, <span>float</span>]:
    <span>raise</span> <span>NotImplementedError</span>

<span>test_linspace</span> <span>=</span> <span>make_test</span>(<span>&#34;linspace&#34;</span>, <span>linspace</span>, <span>linspace_spec</span>, <span>add_sizes</span><span>=</span>[<span>&#34;n&#34;</span>])</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_62_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_62_0.svg" alt="svg"/></a></p>
<div dir="auto" data-snippet-clipboard-copy-content="# run_test(test_linspace)"><pre><span># run_test(test_linspace)</span></pre></div>

<p dir="auto">Compute <a href="https://numpy.org/doc/stable/reference/generated/numpy.heaviside.html" rel="nofollow">heaviside</a></p>
<div dir="auto" data-snippet-clipboard-copy-content="def heaviside_spec(a, b, out):
    for k in range(len(out)):
        if a[k] == 0:
            out[k] = b[k]
        else:
            out[k] = int(a[k] &gt; 0)

def heaviside(a: TT[&#34;i&#34;], b: TT[&#34;i&#34;]) -&gt; TT[&#34;i&#34;]:
    raise NotImplementedError

test_heaviside = make_test(&#34;heaviside&#34;, heaviside, heaviside_spec)"><pre><span>def</span> <span>heaviside_spec</span>(<span>a</span>, <span>b</span>, <span>out</span>):
    <span>for</span> <span>k</span> <span>in</span> <span>range</span>(<span>len</span>(<span>out</span>)):
        <span>if</span> <span>a</span>[<span>k</span>] <span>==</span> <span>0</span>:
            <span>out</span>[<span>k</span>] <span>=</span> <span>b</span>[<span>k</span>]
        <span>else</span>:
            <span>out</span>[<span>k</span>] <span>=</span> <span>int</span>(<span>a</span>[<span>k</span>] <span>&gt;</span> <span>0</span>)

<span>def</span> <span>heaviside</span>(<span>a</span>: <span>TT</span>[<span>&#34;i&#34;</span>], <span>b</span>: <span>TT</span>[<span>&#34;i&#34;</span>]) <span>-&gt;</span> <span>TT</span>[<span>&#34;i&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>

<span>test_heaviside</span> <span>=</span> <span>make_test</span>(<span>&#34;heaviside&#34;</span>, <span>heaviside</span>, <span>heaviside_spec</span>)</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_65_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_65_0.svg" alt="svg"/></a></p>
<div dir="auto" data-snippet-clipboard-copy-content="# run_test(test_heaviside)"><pre><span># run_test(test_heaviside)</span></pre></div>

<p dir="auto">Compute <a href="https://pytorch.org/docs/stable/generated/torch.Tensor.repeat.html" rel="nofollow">repeat</a></p>
<div dir="auto" data-snippet-clipboard-copy-content="def repeat_spec(a, d, out):
    for i in range(d[0]):
        for k in range(len(a)):
            out[i][k] = a[k]

def constraint_set(d):
    d[&#34;d&#34;][0] = d[&#34;return&#34;].shape[0]
    return d

            
def repeat(a: TT[&#34;i&#34;], d: TT[1]) -&gt; TT[&#34;d&#34;, &#34;i&#34;]:
    raise NotImplementedError

test_repeat = make_test(&#34;repeat&#34;, repeat, repeat_spec, constraint=constraint_set)"><pre><span>def</span> <span>repeat_spec</span>(<span>a</span>, <span>d</span>, <span>out</span>):
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>d</span>[<span>0</span>]):
        <span>for</span> <span>k</span> <span>in</span> <span>range</span>(<span>len</span>(<span>a</span>)):
            <span>out</span>[<span>i</span>][<span>k</span>] <span>=</span> <span>a</span>[<span>k</span>]

<span>def</span> <span>constraint_set</span>(<span>d</span>):
    <span>d</span>[<span>&#34;d&#34;</span>][<span>0</span>] <span>=</span> <span>d</span>[<span>&#34;return&#34;</span>].<span>shape</span>[<span>0</span>]
    <span>return</span> <span>d</span>

            
<span>def</span> <span>repeat</span>(<span>a</span>: <span>TT</span>[<span>&#34;i&#34;</span>], <span>d</span>: <span>TT</span>[<span>1</span>]) <span>-&gt;</span> <span>TT</span>[<span>&#34;d&#34;</span>, <span>&#34;i&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>

<span>test_repeat</span> <span>=</span> <span>make_test</span>(<span>&#34;repeat&#34;</span>, <span>repeat</span>, <span>repeat_spec</span>, <span>constraint</span><span>=</span><span>constraint_set</span>)</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_68_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_68_0.svg" alt="svg"/></a></p>

<p dir="auto">Compute <a href="https://pytorch.org/docs/stable/generated/torch.bucketize.html" rel="nofollow">bucketize</a></p>
<div dir="auto" data-snippet-clipboard-copy-content="def bucketize_spec(v, boundaries, out):
    for i, val in enumerate(v):
        out[i] = 0
        for j in range(len(boundaries)-1):
            if val &gt;= boundaries[j]:
                out[i] = j + 1
        if val &gt;= boundaries[-1]:
            out[i] = len(boundaries)


def constraint_set(d):
    d[&#34;boundaries&#34;] = np.abs(d[&#34;boundaries&#34;]).cumsum()
    return d

            
def bucketize(v: TT[&#34;i&#34;], boundaries: TT[&#34;j&#34;]) -&gt; TT[&#34;i&#34;]:
    raise NotImplementedError

test_bucketize = make_test(&#34;bucketize&#34;, bucketize, bucketize_spec,
                           constraint=constraint_set)"><pre><span>def</span> <span>bucketize_spec</span>(<span>v</span>, <span>boundaries</span>, <span>out</span>):
    <span>for</span> <span>i</span>, <span>val</span> <span>in</span> <span>enumerate</span>(<span>v</span>):
        <span>out</span>[<span>i</span>] <span>=</span> <span>0</span>
        <span>for</span> <span>j</span> <span>in</span> <span>range</span>(<span>len</span>(<span>boundaries</span>)<span>-</span><span>1</span>):
            <span>if</span> <span>val</span> <span>&gt;=</span> <span>boundaries</span>[<span>j</span>]:
                <span>out</span>[<span>i</span>] <span>=</span> <span>j</span> <span>+</span> <span>1</span>
        <span>if</span> <span>val</span> <span>&gt;=</span> <span>boundaries</span>[<span>-</span><span>1</span>]:
            <span>out</span>[<span>i</span>] <span>=</span> <span>len</span>(<span>boundaries</span>)


<span>def</span> <span>constraint_set</span>(<span>d</span>):
    <span>d</span>[<span>&#34;boundaries&#34;</span>] <span>=</span> <span>np</span>.<span>abs</span>(<span>d</span>[<span>&#34;boundaries&#34;</span>]).<span>cumsum</span>()
    <span>return</span> <span>d</span>

            
<span>def</span> <span>bucketize</span>(<span>v</span>: <span>TT</span>[<span>&#34;i&#34;</span>], <span>boundaries</span>: <span>TT</span>[<span>&#34;j&#34;</span>]) <span>-&gt;</span> <span>TT</span>[<span>&#34;i&#34;</span>]:
    <span>raise</span> <span>NotImplementedError</span>

<span>test_bucketize</span> <span>=</span> <span>make_test</span>(<span>&#34;bucketize&#34;</span>, <span>bucketize</span>, <span>bucketize_spec</span>,
                           <span>constraint</span><span>=</span><span>constraint_set</span>)</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/srush/Tensor-Puzzles/blob/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_69_0.svg"><img src="https://github.com/srush/Tensor-Puzzles/raw/main/Tensor%20Puzzlers_files/Tensor%20Puzzlers_69_0.svg" alt="svg"/></a></p>

<p dir="auto">What is the smallest you can make each of these?</p>
<div dir="auto" data-snippet-clipboard-copy-content="import inspect
fns = (ones, sum, outer, diag, eye, triu, cumsum, diff, vstack, roll, flip,
       compress, pad_to, sequence_mask, bincount, scatter_add)

for fn in fns:
    lines = [l for l in inspect.getsource(fn).split(&#34;\n&#34;) if not l.strip().startswith(&#34;#&#34;)]
    
    if len(lines) &gt; 3:
        print(fn.__name__, len(lines[2]), &#34;(more than 1 line)&#34;)
    else:
        print(fn.__name__, len(lines[1]))"><pre><span>import</span> <span>inspect</span>
<span>fns</span> <span>=</span> (<span>ones</span>, <span>sum</span>, <span>outer</span>, <span>diag</span>, <span>eye</span>, <span>triu</span>, <span>cumsum</span>, <span>diff</span>, <span>vstack</span>, <span>roll</span>, <span>flip</span>,
       <span>compress</span>, <span>pad_to</span>, <span>sequence_mask</span>, <span>bincount</span>, <span>scatter_add</span>)

<span>for</span> <span>fn</span> <span>in</span> <span>fns</span>:
    <span>lines</span> <span>=</span> [<span>l</span> <span>for</span> <span>l</span> <span>in</span> <span>inspect</span>.<span>getsource</span>(<span>fn</span>).<span>split</span>(<span>&#34;<span>\n</span>&#34;</span>) <span>if</span> <span>not</span> <span>l</span>.<span>strip</span>().<span>startswith</span>(<span>&#34;#&#34;</span>)]
    
    <span>if</span> <span>len</span>(<span>lines</span>) <span>&gt;</span> <span>3</span>:
        <span>print</span>(<span>fn</span>.<span>__name__</span>, <span>len</span>(<span>lines</span>[<span>2</span>]), <span>&#34;(more than 1 line)&#34;</span>)
    <span>else</span>:
        <span>print</span>(<span>fn</span>.<span>__name__</span>, <span>len</span>(<span>lines</span>[<span>1</span>]))</pre></div>
<div data-snippet-clipboard-copy-content="ones 29
sum 29
outer 29
diag 29
eye 29
triu 29
cumsum 29
diff 29
vstack 29
roll 29
flip 29
compress 29
pad_to 29
sequence_mask 29
bincount 29
scatter_add 29"><pre><code>ones 29
sum 29
outer 29
diag 29
eye 29
triu 29
cumsum 29
diff 29
vstack 29
roll 29
flip 29
compress 29
pad_to 29
sequence_mask 29
bincount 29
scatter_add 29
</code></pre></div>
</article></div></div>
  </body>
</html>
