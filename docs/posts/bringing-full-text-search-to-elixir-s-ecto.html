<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://moosie.us/paradex">Original</a>
    <h1>Bringing full text search to Elixir&#39;s Ecto</h1>
    
    <div id="readability-page-1" class="page"><div>


<article>
  <header>
    <div>
      
      <p>
        Posted: <span id="created_at">2024-10-19T19:46:10Z</span>
      </p>
      <p>
        Updated: <span id="modified_at">2024-10-21T15:52:11Z</span>
      </p>
      
      <hr/>
    </div>
  </header>
  <section><p><em>Author&#39;s note: I originally published this on October 19th. I then grew dissatisfied and wrote a post v2. This is perhaps the reason I failed English courses and became a software engineer.</em></p><p><img src="https://moosie.us/assets/paradex/mosquito_nf_mark_xiii.jpg" alt="Mosquito PR MK XVI"/></p><h2>Introducing ParadeDB for the uninitiated</h2><p><a href="https://www.paradedb.com/">ParadeDB</a> is an alternative to ElasticSearch built on Postgres. More technically, it&#39;s a trio of extensions that fulfill the same purpose:</p><ul><li><a href="https://github.com/paradedb/paradedb/tree/dev/pg_search">pg_search</a> which embeds a BM25 full text search engine (<a href="https://github.com/quickwit-oss/tantivy">Tantivy</a>), and extends SQL to allow for composing search queries.</li><li><a href="https://github.com/paradedb/pg_analytics">pg_analytics</a> which embeds <a href="https://duckdb.org/">DuckDB</a>, allowing Postgres to query datalakes on S3 in formats like Parquet.</li><li><a href="https://github.com/pgvector/pgvector">pgvector</a>, a standalone extension which implements vector data storage and similarity search.</li></ul><p><strong>It&#39;s all Postgres extensions! MWAHAHAHAHA</strong></p><h2>Last week&#39;s update</h2><p>ParadeDB <code>0.11.0</code> <a href="https://docs.paradedb.com/changelog/0.11.0">dropped last week</a> with lots of improvements, including an overhauled API. The syntax is far more viable for database access layers (DBALs) to accommodate.</p><p>In my <a href="https://moosie.us/parade_db_ecto">prior attempt</a> to support ParadeDB in Elixir, I had to completely fork <a href="https://github.com/elixir-ecto/ecto">Ecto</a> to support search query composition. This is because previous versions of ParadeDB embedded search queries entirely in the <code>FROM</code> expression like so:</p><pre><code>SELECT * FROM calls_search_idx.search(
  query =&gt; paradedb.boolean(
    must =&gt; ARRAY[
      paradedb.parse(field =&gt; &#39;transcript&#39;, value =&gt; &#39;mechanical OR &#34;broke down&#34; OR &#34;tow truck&#34;&#39;),
      paradedb.range(field =&gt; &#39;call_length&#39;, range =&gt; int4range(5, NULL, &#39;[)&#39;))
    ]
  ),
  order_by_field =&gt; &#39;start_time&#39;,
  order_by_direction =&gt; &#39;desc&#39;,
  limit_rows =&gt; 15
);</code></pre><p>Search queries had a very visible start with <code>call_search_idx.search(</code> and ending at <code>)</code>. This simplified parsing and planning but posed several downsides:</p><ul><li>The search query added a de facto <code>SEARCH</code> clause to PSQL, similar-to-but-distinct-from <code>WHERE</code>. DBALs were effectively responsible for providing composition for that <code>SEARCH</code> clause in addition to <code>WHERE</code> -- In fact, <em>I had to fork Ecto to quite literally implement a <code>search:</code> clause.</em></li><li>The <code>.search</code> function reimplemented bits of SQL with properties like <code>order_by_field</code> and <code>limit_rows</code>, which required special handling regardless of approach.</li><li>While simple, this approach also precluded lots of optimization.</li></ul><p><code>0.11.0</code> replaces the <code>.search()</code> syntax entirely with an infix <code>@@@</code> operator. Here&#39;s a workalike query for comparison:</p><pre><code>SELECT * FROM calls
WHERE
  calls.transcript @@@ &#39;mechanical OR &#34;broke down&#34; OR &#34;tow truck&#34;&#39; AND 
  calls.id @@@ paradedb.range(&#39;call_length&#39;, int4range(5, NULL, &#39;[)&#39;))
ORDER BY calls.start_time DESC
LIMIT 15;</code></pre><p>With this new API, ParadeDB&#39;s much more involved with query planning and execution, and DBALs have an easier go of things:</p><ul><li>Most DBALs already compose <code>WHERE</code> clauses, so the only overhead now is adding the query functions and <code>@@@</code> operator.</li><li>Clauses like <code>ORDER BY</code> and <code>LIMIT</code> are now transparently pushed down to Tantivy as well.</li><li>As an aside there&#39;s room for performance gains on orders of magnitudes.</li></ul><h2>Introducing Paradex</h2><p>I&#39;ve published a package called <a href="https://hexdocs.pm/paradex/readme.html">Paradex</a> that provides <a href="https://hexdocs.pm/ecto/Ecto.Query.html#module-fragments">Ecto fragments</a> for ParadeDB. The implementation&#39;s now <a href="https://github.com/Moosieus/paradex/tree/main/lib">a single file of trivial macros</a>, compared to the prior fork.</p><p>Altogether I think this makes for a really compelling search solution:</p><ul><li>There&#39;s no need to synchronize or Extract Transform &amp; Load (ETL) data from Postgres to external services like ElasticSearch or Apache Solr.</li><li>You can compose search queries like you would any other Ecto query, and leverage Ecto&#39;s query caching.</li><li>The results of your search queries map to the Ecto schemas and associations you&#39;ve already defined in your project. There&#39;s no need to marshall or re-query things from json.</li><li>Changes to your search index can be handled in your existing migration workflow.</li></ul><p>Here&#39;s a workalike query from the example above:</p><pre><code><span>import</span><span> </span><span>Ecto.Query</span><span>
</span><span>import</span><span> </span><span>Paradex</span><span>

</span><span>alias</span><span> </span><span>ParadexApp.Call</span><span>
</span><span>alias</span><span> </span><span>ParadexApp.Repo</span><span>

</span><span>search</span><span> </span><span>=</span><span> </span><span>~s&#39;mechanical OR &#34;broke down&#34; OR &#34;tow truck&#34;&#39;</span><span>
</span><span>min_length</span><span> </span><span>=</span><span> </span><span>5</span><span>
</span><span>page_size</span><span> </span><span>=</span><span> </span><span>15</span><span>

</span><span>query</span><span> </span><span>=</span><span>
  </span><span>from</span><span data-group-id="0412878154-1">(</span><span>
    </span><span>c</span><span> </span><span>in</span><span> </span><span>Call</span><span>,</span><span>
    </span><span>select</span><span>:</span><span> </span><span data-group-id="0412878154-2">%{</span><span>id</span><span>:</span><span> </span><span>c</span><span>.</span><span>id</span><span>,</span><span> </span><span>score</span><span>:</span><span> </span><span>score</span><span data-group-id="0412878154-3">(</span><span>c</span><span>.</span><span>id</span><span data-group-id="0412878154-3">)</span><span>,</span><span> </span><span>time</span><span>:</span><span> </span><span>c</span><span>.</span><span>start_time</span><span>,</span><span> </span><span>text</span><span>:</span><span> </span><span>c</span><span>.</span><span>transcript</span><span data-group-id="0412878154-2">}</span><span>,</span><span>
    </span><span>where</span><span>:</span><span> </span><span>c</span><span>.</span><span>transcript</span><span> </span><span>~&gt;</span><span> </span><span>^</span><span>search</span><span>,</span><span>
    </span><span>order_by</span><span>:</span><span> </span><span data-group-id="0412878154-4">[</span><span>desc</span><span>:</span><span> </span><span>c</span><span>.</span><span>start_time</span><span data-group-id="0412878154-4">]</span><span>,</span><span>
    </span><span>limit</span><span>:</span><span> </span><span>^</span><span>page_size</span><span>
  </span><span data-group-id="0412878154-1">)</span><span>

</span><span># composition :D</span><span>
</span><span>query</span><span> </span><span>=</span><span>
  </span><span>if</span><span> </span><span>some_condition</span><span> </span><span data-group-id="0412878154-5">do</span><span>
    </span><span>where</span><span data-group-id="0412878154-6">(</span><span>query</span><span>,</span><span> </span><span data-group-id="0412878154-7">[</span><span>c</span><span data-group-id="0412878154-7">]</span><span>,</span><span> </span><span>c</span><span>.</span><span>id</span><span> </span><span>~&gt;</span><span> </span><span>int4range</span><span data-group-id="0412878154-8">(</span><span>&#34;call_length&#34;</span><span>,</span><span> </span><span>^</span><span>min_length</span><span>,</span><span> </span><span>nil</span><span>,</span><span> </span><span>&#34;[)&#34;</span><span data-group-id="0412878154-8">)</span><span data-group-id="0412878154-6">)</span><span>
  </span><span data-group-id="0412878154-5">else</span><span>
    </span><span>query</span><span>
  </span><span data-group-id="0412878154-5">end</span><span>

</span><span>Repo</span><span>.</span><span>all</span><span data-group-id="0412878154-9">(</span><span>query</span><span data-group-id="0412878154-9">)</span></code></pre><p>Here&#39;s the results!</p><pre><code><span data-group-id="2294202325-1">[</span><span>
  </span><span data-group-id="2294202325-2">%{</span><span>
    </span><span>id</span><span>:</span><span> </span><span>23579</span><span>,</span><span>
    </span><span>score</span><span>:</span><span> </span><span>9.265514373779297</span><span>,</span><span>
    </span><span>time</span><span>:</span><span> </span><span>~N[2024-10-11 10:42:48]</span><span>,</span><span>
    </span><span>text</span><span>:</span><span> </span><span>&#34;I&#39;m 10-5 at Medical Center Drive in Great Seneca. There is an accident. They haven&#39;t blocked any of the roads yet, but they might have to block it once the tow truck is here. I&#39;ll just stick around.&#34;</span><span>
  </span><span data-group-id="2294202325-2">}</span><span>,</span><span>
  </span><span data-group-id="2294202325-3">%{</span><span>
    </span><span>id</span><span>:</span><span> </span><span>23104</span><span>,</span><span>
    </span><span>score</span><span>:</span><span> </span><span>10.1517333984375</span><span>,</span><span>
    </span><span>time</span><span>:</span><span> </span><span>~N[2024-10-11 09:25:43]</span><span>,</span><span>
    </span><span>text</span><span>:</span><span> </span><span>&#34;Please, could you send the coordinator or someone? Are you broke down right before Watkins, ma&#39;am?&#34;</span><span>
  </span><span data-group-id="2294202325-3">}</span><span>,</span><span>
  </span><span>#...</span><span>
</span><span data-group-id="2294202325-1">]</span></code></pre><p>Hybrid search is also possible with pgvector, which I&#39;ve included a guide for <a href="https://hexdocs.pm/paradex/hybrid_search.html">here</a>.</p><p>Overall I&#39;m quite happy with the results! ParadeDB&#39;s operationally much more simple than ElasticSearch, and when combined with Ecto, a much more cohesive solution at that.</p><h2>Looking Forward</h2><p><code>0.11.0</code> has really opened up a grimoire of possibilities. I&#39;m excited to see the gaps in capabilities close with ElasticSearch, especially with analytical queries.</p><p>I hope ORMs and DBAL contributors in other languages will look into supporting ParadeDB, especially now that the amount of work necessary has been significantly reduced.</p><p>On a final note, I really think Postgres is the best database for most software service businesses operating today. Technical decision makers would do well to evaluate Postgres&#39; capabilities before introducing multiple disparate storage technologies:</p><ul><li>If you need a key-value store, look at <a href="https://www.postgresql.org/docs/current/hstore.html">hstore</a>. Ruby on Rails 8 <a href="https://fly.io/ruby-dispatch/the-plan-for-rails-8/#less-moving-parts-in-production">won&#39;t even ship with Redis</a> b/c databases on NVME SSDs are fast enough.</li><li>If you need to store JSON documents, check out Postgres <a href="https://www.postgresql.org/docs/current/datatype-json.html">JSON Types</a> and the new <code>JSON_TABLE</code> feature in <a href="https://www.postgresql.org/about/news/postgresql-17-released-2936/">Postgres 17</a>.</li><li>If you need a columnar database for lakehouse analytics, consider ParadeDB and <a href="https://github.com/paradedb/pg_analytics">pg_analytics</a>.</li><li>If you need a search engine, <em>see the above article!</em></li><li>If you need a vector store and similarity search, <a href="https://github.com/pgvector/pgvector">pgvector</a> has you covered.</li><li>For graph data, I don&#39;t have as great an answer until <a href="http://peter.eisentraut.org/blog/2023/04/04/sql-2023-is-finished-here-is-whats-new#property-graph-queries">Property Graph Queries</a> drop in Postgres.</li></ul><h2>Further Reading</h2><p>A few months ago, database luminaries Michael Stonebraker and Andrew Pavlo published <a href="https://db.cs.cmu.edu/papers/2024/whatgoesaround-sigmodrec2024.pdf">What Goes Around Comes Around... And Around...</a> They don&#39;t pull any punches, so if you&#39;re a fan of Hadoop or MongoDB, probably don&#39;t read this.</p></section>
  <hr/>
</article>
  </div></div>
  </body>
</html>
