<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/26816">Original</a>
    <h1>AMD&#39;s 22 year old GPUs are still getting updates</h1>
    
    <div id="readability-page-1" class="page">





<header data-testid="navbar">
<a href="#content-body">Skip to content</a>

</header>

<div>


<div>



<div>
<main id="content-body" itemscope="" itemtype="http://schema.org/SoftwareSourceCode">





<div data-lock-version="2" data-mr-action="show" data-project-path="/mesa/mesa" data-url="/mesa/mesa/-/merge_requests/26816.json">



<div data-id="176">



<div id="diff-notes-app">

<div id="notes">
<div>
<section>

<div>
<div>
<div>
<div data-testid="description-content">
<div>
<p data-sourcepos="1:1-1:286" dir="auto">This MR moves the most of the remaining backend lowering into NIR. Specifically, ftrunc, fcsel (when suitable) and flrp. The backend lowering paths are removed. This is a prerequisite for more backend cleanups, for example I have a MR ready to get rid of backend DCE for vertex shaders.</p>
<p data-sourcepos="3:1-3:1047" dir="auto">To be honest I tried to get this right like five times already, initially even before nir_to_rc and I always failed to make it work reasonably. The reason why this is more tricky than the usual lowering is the required pass order. In fact all the opcodes that we are lowering comes either from integer lowering (ftrunc) or bool lowering. We can&#39;t do bool lowering in the main loop in finalize nir (most notably because peephole select expects bools for ifs) and while early integer lowering is OK in tests and seems to work, Emma voiced some opposition to it previously. Therefore all of this now happens when translating to the backend IR. For the same reason there are some custom algebraic passes doing the same lowering that we would normally used the common nir_opt_algebraic. In an ideal world we would do the lowering before late algebraic, so if we lower the fcsels all all the way to add+muls we can optimally generate ffmas, but I couln&#39;d get this right so we just emit ffmas directly when lowering the flrps that come from the fcsels...</p>
<p data-sourcepos="5:1-5:530" dir="auto">Doing the fcsel lowering in NIR on R500 (we have a native CMP but the vertex engine has the limitation that it can&#39;t read from three different TMP registers) is also unfortunately much more complex than doing it in the backend, one needs to look through the fneg and fabs and also check whether constant and inputs will be copy propagated or not. In the end this is a lot of code, so in total this series is mostly even (NIR fcsel lwoering vs the TRUNC, LRP and CMP backend removal), but opens a way for more cleanups in a future.</p>
<p data-sourcepos="7:1-7:276" dir="auto">Shader-db-wise this is a bit of a win for R500 (by doing the fcsel lowering in nir, we still have info if this is fcsel_lt/ge or fcsel and we can save the comparison for the later case if we have to lower it), and mostly even on R300 see individual commits for detailed stats.</p>
</div>

</div>
<small>Edited <time title="Dec 29, 2023 8:24am" datetime="2023-12-29T08:24:09Z" data-toggle="tooltip" data-placement="bottom" data-container="body">Dec 29, 2023</time> by <a data-user-id="36302" data-username="ondracka" data-name="Pavel Ondračka" href="https://gitlab.freedesktop.org/ondracka"><span>Pavel Ondračka</span></a></small>
</div>

</div>






</div>
</section>


</div>

</div>




</div>

</div>
</div>




</main>
</div>


</div>
</div>










</div>
  </body>
</html>
