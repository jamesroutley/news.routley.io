<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.maximeheckel.com/posts/real-time-cloudscapes-with-volumetric-raymarching/">Original</a>
    <h1>Real-time dreamy Cloudscapes with Volumetric Raymarching</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>I spent the past few months diving into the realm of Raymarching and studying some of its applications that may come in handy for future 3D projects, and while I managed to build a pretty diverse set of scenes, all of them consisted of rendering <em>surfaces or solid objects</em>. <a href="https://thewitchofendor.com/posts/painting-with-math-a-gentle-study-of-raymarching/">My blog post on Raymarching</a> covered some of the many impressive capabilities of this rendering technique, and as I mentioned at the end of that post, that was only the tip of the iceberg; there is <em>a lot more</em> we can do with it.</p>
<p>One fascinating aspect of Raymarching I quickly encountered in my study was its capacity to be tweaked to render <strong>volumes</strong>. Instead of stopping the raymarched loop once the ray hits a surface, we <em>push through</em> and continue the process to sample the <em>inside</em> of an object. That is where my obsession with volumetric clouds started, and I think the countless hours
I spent exploring the many Sky Islands in Zelda Tears of the Kingdom contributed a lot to my curiosity to learn more about how they work. I thus studied <a href="https://www.shadertoy.com/view/3dlfWs">a lot</a> <a href="https://www.shadertoy.com/view/3sffzj">of Shadertoy</a> <a href="https://www.shadertoy.com/view/tsScDG">scenes</a> leveraging many Volumetric Raymarching techniques to render smoke, clouds, and cloudscapes, which I obviously couldn&#39;t resist giving a try rebuilding myself:</p>

<p>I spent a great deal of time exploring the different ways I could use Raymarching to render clouds, from fully wrapping my head around <strong>the basics of Volumetric Raymarching</strong> to <strong>leveraging physically based properties of clouds</strong> to try getting a more realistic output while also trying to squeeze as much performance out of my scenes with neat <strong>performance improvement tips</strong> I learned along the way. I cover all of that in this article, which I hope can serve you as a field guide for your own volumetric rendering experiments and learnings.</p>


<section id="volumetric-rendering-raymarching-with-a-twist-section"><h2 id="volumetric-rendering-raymarching-with-a-twist"><a href="#volumetric-rendering-raymarching-with-a-twist" aria-hidden="true" tabindex="-1"><span></span></a>Volumetric rendering: Raymarching with a twist</h2><p>In my previous blog post on Raymarching, we saw that the technique relied on:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><strong>Signed Distance Fields</strong>: functions that return the distance of a given point in space to the surface of an object</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><strong>A Raymarching loop</strong> where we <strong>march step-by-step</strong> alongside rays cast <strong>from an origin point</strong> (a camera, the observer&#39;s eye) <strong>through each pixel of an output image</strong>, and we calculate the distance to the object&#39;s surface using our SDF. Once that distance is small enough, we can draw a pixel.</p></li>
</ul><p>If you&#39;ve practiced this technique on some of your own scenes, you&#39;re in luck: Volumetric Raymarching relies on <em>the same principles</em>: there&#39;s a loop, rays cast from an origin, and SDFs. However, since we&#39;re rendering volumes instead of surfaces, there&#39;s a tiny twist to the technique 👀.</p><h3 id="how-to-sample-a-volume"><a href="#how-to-sample-a-volume" aria-hidden="true" tabindex="-1"><span></span></a>How to sample a volume</h3><p>The first time we got introduced to the concept of SDF, we learned that it was important <em>not to step inside</em> the object during our Raymarching loop to have a beautiful render. I even emphasized that fact in one of my diagrams showcasing 3 points relative to an object:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>P1</code> is located far from the surface, in green, representing a <em>positive</em> distance to the surface.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>P2</code> is located at a close distance ε to the surface, in orange,</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>P3</code> positioned <strong>inside</strong> the object, in red, representing a <strong>negative</strong> distance to the surface.</p></li>
</ul><div data-fullbleed="true"><div><figure><span><span></span><img alt="Diagram showcasing 3 points, P1, P2, and P3, being respectively, at a positive distance, small distance, and inside a sphere." src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="responsive"/></span><figcaption>Diagram showcasing 3 points, P1, P2, and P3, being respectively, at a positive distance, small distance, and inside a sphere.</figcaption></figure></div></div><p>When sampling a volume, we&#39;ll need to actually <strong>raymarch inside our object</strong> and reframe how we think of SDF: instead of representing the distance to the surface, we will now use it as the <em>density</em> of our volume.</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>When raymarching outside, the density is null, or <code>0</code>.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Once we raymarch inside, it is positive.</p></li>
</ul><p>To illustrate this new way of thinking about Raymarching in the context of volume, here&#39;s a modified version of the widget I introduced in my blog post on the topic earlier this year.</p><!--$--><div><div><div><p><span role="presentation">-0.5<!-- -->,<!-- -->0.5</span></p><p><span role="presentation">0.5<!-- -->,<!-- -->0.5</span></p><p><span role="presentation">-0.5<!-- -->,<!-- -->-0.5</span></p><p><span role="presentation">0.5<!-- -->,<!-- -->-0.5</span></p></div></div></div><!--/$--><p>That reframing of what an SDF represents ends up changing two core principles in our Raymarching technique that will have to be reflected in our code:</p><ol>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We have to march step-by-step with a <strong>constant step size</strong> along our rays. We no longer use the distance returned by the SDF.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Our SDF now returns the <strong>opposite</strong> of the distance to the surface to properly represent the density of our object (positive on the inside, <code>0</code> on the outside)</p></li>
</ol><div data-fullbleed="true"><div><figure><span><span></span><img alt="Diagram showcasing 3 points, P1, P2, and P3, being respectively, at a positive distance, small distance, and inside a sphere. Only P3 is considered &#39;valid&#39; in the context of Volumetric Raymarching" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="responsive"/></span><figcaption>Diagram showcasing 3 points, P1, P2, and P3, being respectively, at a positive distance, small distance, and inside a sphere. Only P3 is considered &#39;valid&#39; in the context of Volumetric Raymarching</figcaption></figure></div></div><h3 id="our-first-volumetric-raymarching-scene"><a href="#our-first-volumetric-raymarching-scene" aria-hidden="true" tabindex="-1"><span></span></a>Our first Volumetric Raymarching scene</h3><p>Now that we have a grasp of sampling volumes using what we know about Raymarching, we can try implementing it by modifying an existing scene. For brevity, I&#39;m not detailing the setup of a basic of
Raymarching scenes. If you want a good starting point you can head to <a href="https://thewitchofendor.com/posts/painting-with-math-a-gentle-study-of-raymarching#our-first-raymarched-scene">my Raymarching setup</a> I already introduced in a previous article.</p><p>The setup of the scene is quite similar to what we&#39;re familiar with in classic Raymarching; the modifications we&#39;ll need to do are located in:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Our SDF functions: we&#39;ll need to return the opposite of the distance: <code>-d</code> instead of <code>d</code>.</p></li>
</ul><!--$--><div><div><p data-testid="codesnippet-title">Example of SDF used in Volumetric Raymarching</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">sdSphere</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line"> p</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> radius</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>2</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">length</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> radius</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> distance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sdSphere</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><!--/$--><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Our <code>raymarch</code> function: we&#39;ll need to march at a <strong>constant step size</strong> and start drawing only once <strong>the density is over 0</strong>.</p></li>
</ul><!--$--><div><div><p data-testid="codesnippet-title">Volumetric Raymarching loop with constant step size</p></div><pre><div data-testid="highlight-line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">const</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> MARCH_SIZE </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.08</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">vec3</span><span data-testid="content-line"> p </span><span data-testid="content-line">=</span><span data-testid="content-line"> rayOrigin </span><span data-testid="content-line">+</span><span data-testid="content-line"> depth </span><span data-testid="content-line">*</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> i </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> i </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> MAX_STEPS</span><span data-testid="content-line">;</span><span data-testid="content-line"> i</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> density </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">scene</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>18</p><p><span><span data-testid="content-line">  p </span><span data-testid="content-line">=</span><span data-testid="content-line"> rayOrigin </span><span data-testid="content-line">+</span><span data-testid="content-line"> depth </span><span data-testid="content-line">*</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><!--/$--><p>Now comes another question: <em>what shall we draw once our density is positive to represent a volume?</em>
For this first example, we can keep things simple and play with the <code>alpha</code> channel of our colors to make it proportional to the density of our volume: the denser our object gets as we march into it, the more opaque/darker it will be.</p><!--$--><div><div><p data-testid="codesnippet-title">Simple Volumetric Raymarching loop</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">const</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> MARCH_SIZE </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.08</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">vec4</span><span data-testid="content-line"> </span><span data-testid="content-line">raymarch</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line"> rayOrigin</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>5</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> p </span><span data-testid="content-line">=</span><span data-testid="content-line"> rayOrigin </span><span data-testid="content-line">+</span><span data-testid="content-line"> depth </span><span data-testid="content-line">*</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> i </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> i </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> MAX_STEPS</span><span data-testid="content-line">;</span><span data-testid="content-line"> i</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> density </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">scene</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>14</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line">(</span><span data-testid="content-line">mix</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> density</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> density </span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>16</p><p><span><span data-testid="content-line">      res </span><span data-testid="content-line">+=</span><span data-testid="content-line"> color </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> res</span><span data-testid="content-line">.</span><span data-testid="content-line">a</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>20</p><p><span><span data-testid="content-line">    p </span><span data-testid="content-line">=</span><span data-testid="content-line"> rayOrigin </span><span data-testid="content-line">+</span><span data-testid="content-line"> depth </span><span data-testid="content-line">*</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><!--/$--><p>If we try to render this code in our React Three Fiber canvas, we should get the following result 👀</p><!--$--><!--/$--></section>
<section id="drawing-fluffy-raymarched-clouds-section"><h2 id="drawing-fluffy-raymarched-clouds"><a href="#drawing-fluffy-raymarched-clouds" aria-hidden="true" tabindex="-1"><span></span></a>Drawing Fluffy Raymarched Clouds</h2><p>We now know and applied the basics of Volumetric Raymarching. So far, we only rendered a simple volumetric sphere with constant density as we march through the volume, which is a good start. We can now try using that simple scene as a foundation to render something more interesting: <strong>clouds!</strong></p><h3 id="noisy-volume"><a href="#noisy-volume" aria-hidden="true" tabindex="-1"><span></span></a>Noisy Volume</h3><p>Going from our simple SDF of a sphere to a cloud consists of drawing it with <em>a bit more noise</em>. Clouds don&#39;t have a uniform shape nor do they have a uniform density, thus we need to introduce some organic randomness through noise in our Raymarching loop. If you read <a href="https://thewitchofendor.com/posts/the-study-of-shaders-with-react-three-fiber/">some of</a> <a href="https://thewitchofendor.com/posts/painting-with-math-a-gentle-study-of-raymarching/">my previous articles</a>, you should already be familiar with the concept of:</p><ol>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Noise, Perlin noise, and value noise derivative</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Fractal Brownian Motion, or FBM.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Texture based noise.</p></li>
</ol><p>To generate raymarched landscapes, we used a noise texture, noise derivatives, and FBM to get a detailed organic result. We&#39;ll rely on some of those concepts to create organic randomness and obtain a cloud from our SDF ☁️.</p><!--$--><div><div><p data-testid="codesnippet-title">Noise function for Raymarched landscape</p></div><pre><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> u </span><span data-testid="content-line">=</span><span data-testid="content-line"> f </span><span data-testid="content-line">*</span><span data-testid="content-line"> f </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">3.</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">2.</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> f</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> a </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">textureLod</span><span data-testid="content-line">(</span><span data-testid="content-line">uTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">p </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">.0</span><span data-testid="content-line">,</span><span data-testid="content-line">.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">256.</span><span data-testid="content-line">,</span><span data-testid="content-line">0.</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">x</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> b </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">textureLod</span><span data-testid="content-line">(</span><span data-testid="content-line">uTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">p </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line">.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">256.</span><span data-testid="content-line">,</span><span data-testid="content-line">0.</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">x</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>8</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> c </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">textureLod</span><span data-testid="content-line">(</span><span data-testid="content-line">uTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">p </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">.0</span><span data-testid="content-line">,</span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">256.</span><span data-testid="content-line">,</span><span data-testid="content-line">0.</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">x</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> d </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">textureLod</span><span data-testid="content-line">(</span><span data-testid="content-line">uTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">p </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">256.</span><span data-testid="content-line">,</span><span data-testid="content-line">0.</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">x</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> noiseValue </span><span data-testid="content-line">=</span><span data-testid="content-line"> a </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">b</span><span data-testid="content-line">-</span><span data-testid="content-line">a</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> u</span><span data-testid="content-line">.</span><span data-testid="content-line">x </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">c</span><span data-testid="content-line">-</span><span data-testid="content-line">a</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> u</span><span data-testid="content-line">.</span><span data-testid="content-line">y </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">a </span><span data-testid="content-line">-</span><span data-testid="content-line"> b </span><span data-testid="content-line">-</span><span data-testid="content-line"> c </span><span data-testid="content-line">+</span><span data-testid="content-line"> d</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> u</span><span data-testid="content-line">.</span><span data-testid="content-line">x </span><span data-testid="content-line">*</span><span data-testid="content-line"> u</span><span data-testid="content-line">.</span><span data-testid="content-line">y</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> noiseDerivative </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">6.</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> f </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">1.</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> f</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">b </span><span data-testid="content-line">-</span><span data-testid="content-line"> a</span><span data-testid="content-line">,</span><span data-testid="content-line"> c </span><span data-testid="content-line">-</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">a </span><span data-testid="content-line">-</span><span data-testid="content-line"> b </span><span data-testid="content-line">-</span><span data-testid="content-line"> c </span><span data-testid="content-line">+</span><span data-testid="content-line"> d</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> u</span><span data-testid="content-line">.</span><span data-testid="content-line">yx</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>14</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">noiseValue</span><span data-testid="content-line">,</span><span data-testid="content-line"> noiseDerivative</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><!--/$--><p>For clouds, our <code>noise</code> function looks a bit different:</p><!--$--><div><div><p data-testid="codesnippet-title">Noise function for Volumetric clouds</p></div><pre><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> u </span><span data-testid="content-line">=</span><span data-testid="content-line"> f </span><span data-testid="content-line">*</span><span data-testid="content-line"> f </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">3.</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">2.</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> f</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> uv </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">.</span><span data-testid="content-line">xy </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">37.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">239.0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> p</span><span data-testid="content-line">.</span><span data-testid="content-line">z</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> u</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> tex </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">textureLod</span><span data-testid="content-line">(</span><span data-testid="content-line">uNoise</span><span data-testid="content-line">,</span><span data-testid="content-line">(</span><span data-testid="content-line">uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">256.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">yx</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">mix</span><span data-testid="content-line">(</span><span data-testid="content-line"> tex</span><span data-testid="content-line">.</span><span data-testid="content-line">x</span><span data-testid="content-line">,</span><span data-testid="content-line"> tex</span><span data-testid="content-line">.</span><span data-testid="content-line">y</span><span data-testid="content-line">,</span><span data-testid="content-line"> u</span><span data-testid="content-line">.</span><span data-testid="content-line">z </span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">2.0</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><!--/$--><p>To tell you the truth, I saw this function in many <a href="https://www.shadertoy.com/view/WdXGRj">Shadertoy demos</a> without necessarily seeing a credited author or even a link to an explanation; I kept using it throughout my work as it still yielded a convincing cloud noise pattern. Here&#39;s an attempt at gathering together some of its specificities from my own understanding:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Clouds are 3D structures, so our function takes in a <code>vec3</code> as input: a point in space within our cloud.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>The texture lookup differs from its landscape counterpart: we&#39;re sampling it as a 2D slice from a 3D position. The <code>vec2(37.0, 239.0) * p.z</code> seems a bit arbitrary to me, but from what I gathered, it allows for more variation in the resulting noise.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We then mix two noise values from our texture lookup based on the <code>z</code> value to generate a smooth noise pattern and rescale it within the <code>[-1, 1]</code> range.</p></li>
</ul><p>Applying this noise along with a Fractal Brownian motion is pretty similar to what we&#39;re used to with Raymarched landscapes:</p><!--$--><div><div><p data-testid="codesnippet-title">Fractal Brownian Motion applied to our Volumetric Raymarching scene</p></div><pre><div data-testid="line"><p>2</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> q </span><span data-testid="content-line">=</span><span data-testid="content-line"> p </span><span data-testid="content-line">+</span><span data-testid="content-line"> uTime </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">0.2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> i </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> i </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> </span><span data-testid="content-line">6</span><span data-testid="content-line">;</span><span data-testid="content-line"> i</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line">      f </span><span data-testid="content-line">+=</span><span data-testid="content-line"> scale </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">noise</span><span data-testid="content-line">(</span><span data-testid="content-line">q</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>20</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> distance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sdSphere</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><!--/$--><p>If we apply the code above to our previous demo, we do get something that starts to look like a cloud 👀:</p><!--$--><!--/$--><h3 id="adding-light"><a href="#adding-light" aria-hidden="true" tabindex="-1"><span></span></a>Adding light</h3><p>Once again, we&#39;re just &#34;starting&#34; to see something approaching our goal, but a crucial element is missing to make our cloud feel more <em>cloudy</em>: <strong>light</strong>.</p><p>The demo we just saw in the previous part lacks depth and shadows and thus doesn&#39;t feel very realistic overall, and that&#39;s due to the lack of diffuse light.</p><p>To add light to our cloud and consequentially obtain better shadows, one may want to apply the same lighting we used in standard Raymarching scenes:</p><ol>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Calculate the normal of each sample point using our <code>scene</code> function</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Use the dot product of the normal and the light direction</p></li>
</ol><!--$--><div><div><p data-testid="codesnippet-title">Diffuse lighting in Raymarched scene using normals</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">vec3</span><span data-testid="content-line"> </span><span data-testid="content-line">getNormal</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line"> p</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> n </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">scene</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>15</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> ro </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">5.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> rd </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">normalize</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">uv</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>17</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> lightPosition </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>19</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> d </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">raymarch</span><span data-testid="content-line">(</span><span data-testid="content-line">ro</span><span data-testid="content-line">,</span><span data-testid="content-line"> rd</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>23</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>26</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> normal </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">getNormal</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>27</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> lightDirection </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">normalize</span><span data-testid="content-line">(</span><span data-testid="content-line">lightPosition </span><span data-testid="content-line">-</span><span data-testid="content-line"> p</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>29</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> diffuse </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">max</span><span data-testid="content-line">(</span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">normal</span><span data-testid="content-line">,</span><span data-testid="content-line"> lightDirection</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>30</p><p><span><span data-testid="content-line">    color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> diffuse</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>33</p><p><span><span data-testid="content-line">  gl_FragColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line">(</span><span data-testid="content-line">color</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><!--/$--><p>That would work in theory, but it&#39;s not the optimal choice for Volumetric Raymarching:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>The <code>getNormal</code> function requires a lot of sample points to estimate the &#34;gradient&#34; in every direction. In the code above, we need 4, but there are code snippets that require 6 for a more accurate result.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Our volumetric raymarching loop is more resource-intensive: we&#39;re walking at a constant step size along our ray to sample the density of our volume.</p></li>
</ul><p>Thus, we need another method or approximation for our diffuse light. Luckily, Inigo Quilez presents a technique to solve this problem in <a href="https://iquilezles.org/articles/derivative/">his article on directional derivatives</a>. Instead of having to sample our density in every direction like <code>getNormal</code>, this method simplifies the problem by sampling the density at our sampling point <code>p</code> and at an offset <strong>in the direction of the light</strong> and getting the difference between those values to approximate how the light scatters roughly inside our volume.</p><figure><span><span></span><img alt="Diagram showcasing 2 sampled points P1 and P2 with both their diffuse lighting calculated by sampling extra points P1&#39; and P2&#39; in the direction of the light" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="responsive"/></span><figcaption>Diagram showcasing 2 sampled points P1 and P2 with both their diffuse lighting calculated by sampling extra points P1&#39; and P2&#39; in the direction of the light</figcaption></figure><p>In the diagram above, you can see that we&#39;re sampling our density at <code>p1</code> and at another point <code>p1&#39;</code> that&#39;s a bit further along the light ray:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>If the density increases along that path, that means the volume gets denser, and light will scatter more</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>If the density gets smaller, our cloud is less thick, and thus, the light will scatter less.</p></li>
</ul><p>This method only requires 2 sampling points and consequentially requires fewer resources to give us a good approximation of how the light behaves with the volume <em>around</em> <code>p1</code>.</p><p>We can apply this diffuse formula to our demo as follows:</p><!--$--><div><div><p data-testid="codesnippet-title">Diffuse lighting using directional derivatives</p></div><pre><div data-testid="highlight-line"><p>5</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> diffuse </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">clamp</span><span data-testid="content-line">(</span><span data-testid="content-line">(</span><span data-testid="content-line">scene</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">scene</span><span data-testid="content-line">(</span><span data-testid="content-line">p </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">0.3</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> sunDirection</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">0.3</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line"> </span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>7</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> lin </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.60</span><span data-testid="content-line">,</span><span data-testid="content-line">0.60</span><span data-testid="content-line">,</span><span data-testid="content-line">0.75</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">1.1</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">0.8</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line">0.6</span><span data-testid="content-line">,</span><span data-testid="content-line">0.3</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> diffuse</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>8</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line">(</span><span data-testid="content-line">mix</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> density</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> density </span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">  res </span><span data-testid="content-line">+=</span><span data-testid="content-line"> color </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> res</span><span data-testid="content-line">.</span><span data-testid="content-line">a</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><!--/$--><p>That is, once again, very similar to what we were doing in standard Raymarching, except that now, we have to include it <em>inside the Raymarching loop</em> as we&#39;re sampling a volume and thus have to run the calculation multiple times throughout the volume as the density may vary whereas a surface required only one diffuse lighting computation (at the surface).</p><p>You can observe the difference between our cloud without lighting and with diffuse lighting below 👇</p><figure><div tabindex="0" role="slider" aria-label="Before/After comparison of our Volumetric cloud without and with diffuse lighting." aria-valuemin="0" aria-valuemax="100" aria-valuenow="40"><p><img alt="Before" loading="eager" src="https://res.cloudinary.com/dg5nsedzw/image/upload/v1698192589/blog/diffuse-before.png" width="700" height="511"/></p><p><img alt="After" loading="eager" src="https://res.cloudinary.com/dg5nsedzw/image/upload/v1698192589/blog/diffuse-after.png" width="700" height="511"/></p><div id="slider-line"><p><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" style="transform:rotate(180deg)"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></p></div></div><figcaption>Before/After comparison of our Volumetric cloud without and with diffuse lighting.</figcaption></figure><p>And here&#39;s the demo featuring the concept and code we just introduced 👀:</p><!--$--><!--/$--><h3 id="morphing-clouds"><a href="#morphing-clouds" aria-hidden="true" tabindex="-1"><span></span></a>Morphing clouds</h3><p>Let&#39;s take a little break to tweak our scene and have some fun with what we built so far! Despite the differences between the standard Raymarching and its volumetric counterpart, there are still a lot of SDF-related concepts you can apply when building cloudscapes.</p><p>You can try to make a cloud in fun shapes like a cross or a torus, or even better, try to make it morph from one form to another over time:</p><!--$--><div><div><p data-testid="codesnippet-title">Mixing SDF to morph volumetric clouds into different shapes</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">mat2</span><span data-testid="content-line"> </span><span data-testid="content-line">rotate2D</span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">mat2</span><span data-testid="content-line">(</span><span data-testid="content-line">c</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">s</span><span data-testid="content-line">,</span><span data-testid="content-line"> s</span><span data-testid="content-line">,</span><span data-testid="content-line"> c</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">nextStep</span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> t</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> len</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> smo</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>8</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> tt </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mod</span><span data-testid="content-line">(</span><span data-testid="content-line">t </span><span data-testid="content-line">+=</span><span data-testid="content-line"> smo</span><span data-testid="content-line">,</span><span data-testid="content-line"> len</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> stp </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">floor</span><span data-testid="content-line">(</span><span data-testid="content-line">t </span><span data-testid="content-line">/</span><span data-testid="content-line"> len</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">smoothstep</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> smo</span><span data-testid="content-line">,</span><span data-testid="content-line"> tt</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> stp</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>15</p><p><span><span data-testid="content-line">  p1</span><span data-testid="content-line">.</span><span data-testid="content-line">xz </span><span data-testid="content-line">*=</span><span data-testid="content-line"> </span><span data-testid="content-line">rotate2D</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">PI </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.1</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">  p1</span><span data-testid="content-line">.</span><span data-testid="content-line">yz </span><span data-testid="content-line">*=</span><span data-testid="content-line"> </span><span data-testid="content-line">rotate2D</span><span data-testid="content-line">(</span><span data-testid="content-line">PI </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.3</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>18</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> s1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sdTorus</span><span data-testid="content-line">(</span><span data-testid="content-line">p1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">1.3</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.9</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>19</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> s2 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sdCross</span><span data-testid="content-line">(</span><span data-testid="content-line">p1 </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">2.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.6</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>20</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> s3 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sdSphere</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.5</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>21</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> s4 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sdCapsule</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">2.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1.5</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">2.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.5</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>23</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> t </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mod</span><span data-testid="content-line">(</span><span data-testid="content-line">nextStep</span><span data-testid="content-line">(</span><span data-testid="content-line">uTime</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">3.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.2</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">4.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>25</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> distance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mix</span><span data-testid="content-line">(</span><span data-testid="content-line">s1</span><span data-testid="content-line">,</span><span data-testid="content-line"> s2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">clamp</span><span data-testid="content-line">(</span><span data-testid="content-line">t</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>26</p><p><span><span data-testid="content-line">  distance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mix</span><span data-testid="content-line">(</span><span data-testid="content-line">distance</span><span data-testid="content-line">,</span><span data-testid="content-line"> s3</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">clamp</span><span data-testid="content-line">(</span><span data-testid="content-line">t </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>27</p><p><span><span data-testid="content-line">  distance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mix</span><span data-testid="content-line">(</span><span data-testid="content-line">distance</span><span data-testid="content-line">,</span><span data-testid="content-line"> s4</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">clamp</span><span data-testid="content-line">(</span><span data-testid="content-line">t </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">2.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>28</p><p><span><span data-testid="content-line">  distance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mix</span><span data-testid="content-line">(</span><span data-testid="content-line">distance</span><span data-testid="content-line">,</span><span data-testid="content-line"> s1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">clamp</span><span data-testid="content-line">(</span><span data-testid="content-line">t </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">3.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><!--/$--><!--$--><!--/$--><p>This demo is a reproduction of <a href="https://www.shadertoy.com/view/mljyzw">this volumetric rendering related Shadertoy scene</a>. I really like this creation because the result is very organic, and it gives the impression that the cloud is <em>rolling</em> into its next shape naturally.</p><p>You can also try to render:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Clouds merging together using the <code>min</code> and <code>smoothmin</code> of two SDFs</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Repeating clouds through space using the <code>mod</code> function</p></li>
</ul><p>There are a lot of creative compositions to try!</p></section>
<section id="performance-optimization-section"><h2 id="performance-optimization"><a href="#performance-optimization" aria-hidden="true" tabindex="-1"><span></span></a>Performance optimization</h2><p>You may notice that running the scenes we built so far may make your computer sound like a jet engine at high resolution or at least not look as smooth as they could. Luckily, we can do something about it and use some <strong>performance optimization techniques to strike the right balance between FPS count and output quality</strong>.</p><h3 id="blue-noise-dithering"><a href="#blue-noise-dithering" aria-hidden="true" tabindex="-1"><span></span></a>Blue noise dithering</h3><p>One of the main performance pitfalls of our current raymarched cloudscape scene is due to:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>the number of steps we have to perform to sample our volume and the small <code>marchSize</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>some heavy computation we have to do within our loop, like our directional derivative or FBM.</p></li>
</ul><p>This issue will only worsen as we attempt to make more computations to achieve a more physically accurate output in the next part of this article.</p><p>One of the first things we could do to make this scene more efficient would be to <em>reduce the amount of steps</em> we perform when sampling our cloud and <em>increase the step size</em>. However, if we attempt this on some of our previous examples (I invite you to try), some <em>layering</em> will be visible, and our volume will look more like some kind of milk soup than a fluffy cloud.</p><figure><span><span></span><img alt="Screenshot of our rendered Volumetric cloud with a low max step count and higher step size. Notice how those optimizations have degraded the output quality." src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="responsive"/></span><figcaption>Screenshot of our rendered Volumetric cloud with a low max step count and higher step size. Notice how those optimizations have degraded the output quality.</figcaption></figure><p>You might have encountered the concept of dithering or some images using dithering styles before.
This process can create the illusion of more colors or shades in an image than available or purely used for artistic ends.
I recommend reading <a href="http://alex-charlton.com/posts/Dithering_on_the_GPU/">Dithering on the GPU</a> from Alex Charlton if you
want a quick introduction.</p><p>In <a href="https://blog.demofox.org/2020/05/10/ray-marching-fog-with-blue-noise/">Ray marching fog with blue noise</a>, the author showcases how you can leverage blue noise dithering in your raymarched scene to erase the <em>banding</em> or <em>layering</em> effect due to a lower step count or less granular loop.
This technique leverages a blue noise pattern, which has fewer patterns or clumps than other noises and is less visible to the human eye, to obtain a random number each time our fragment shader runs. We then introduce that number as an <em>offset</em> at the beginning of the raymarched loop, moving our sampling start point along our ray for each pixel of our output.</p><figure><span><span></span><img alt="Blue noise texture" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="responsive"/></span><figcaption>Blue noise texture</figcaption></figure><figure><span><span></span><img alt="Diagram showcasing the difference between our cloud being sampled without and with blue noise dithering. Notice how each ray is offset when blue noise is introduced and how that &#39;erases&#39; any obvious layering in the final render." src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="responsive"/></span><figcaption>Diagram showcasing the difference between our cloud being sampled without and with blue noise dithering. Notice how each ray is offset when blue noise is introduced and how that &#39;erases&#39; any obvious layering in the final render.</figcaption></figure><!--$--><div><div><p data-testid="codesnippet-title">Blue noise dithering introducing an offset in our Raymarching loop</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">uniform</span><span data-testid="content-line"> </span><span data-testid="content-line">sampler2D</span><span data-testid="content-line"> uBlueNoise</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>5</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">vec4</span><span data-testid="content-line"> </span><span data-testid="content-line">raymarch</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line"> rayOrigin</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> offset</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>7</p><p><span><span data-testid="content-line">  depth </span><span data-testid="content-line">+=</span><span data-testid="content-line"> MARCH_SIZE </span><span data-testid="content-line">*</span><span data-testid="content-line"> offset</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>8</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> p </span><span data-testid="content-line">=</span><span data-testid="content-line"> rayOrigin </span><span data-testid="content-line">+</span><span data-testid="content-line"> depth </span><span data-testid="content-line">*</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>14</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> blueNoise </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">uBlueNoise</span><span data-testid="content-line">,</span><span data-testid="content-line"> gl_FragCoord</span><span data-testid="content-line">.</span><span data-testid="content-line">xy </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">1024.0</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">r</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>15</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> offset </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">fract</span><span data-testid="content-line">(</span><span data-testid="content-line">blueNoise</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>17</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> res </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">raymarch</span><span data-testid="content-line">(</span><span data-testid="content-line">ro</span><span data-testid="content-line">,</span><span data-testid="content-line"> rd</span><span data-testid="content-line">,</span><span data-testid="content-line"> offset</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><!--/$--><p>By introducing some <strong>blue noise dithering</strong> in our fragment shader, we can erase those artifacts and get a high-quality output while maintaining the Raymarching step count low!</p><p>However, under some circumstances, the dithering pattern can be pretty noticeable. By looking at some other <a href="https://www.shadertoy.com/view/WsfBDf">Shadertoy examples</a>, I discovered that introducing a <em>temporal</em> aspect to the blue noise can attenuate this issue.</p><!--$--><div><div><p data-testid="codesnippet-title">Temporal blue noise dithering offset</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">float</span><span data-testid="content-line"> offset </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">fract</span><span data-testid="content-line">(</span><span data-testid="content-line">blueNoise </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">uFrame</span><span data-testid="content-line">%</span><span data-testid="content-line">32</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">sqrt</span><span data-testid="content-line">(</span><span data-testid="content-line">0.5</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span></span></p></div></pre></div><!--/$--><p>Here&#39;s a before/after comparison of our single frame of our raymarched cloud. I guess the results speak for themselves here 😄.</p><figure><div tabindex="0" role="slider" aria-label="Before/After comparison of our Volumetric cloud with fewer Raymarching steps and without and with Blue Noise dithering." aria-valuemin="0" aria-valuemax="100" aria-valuenow="40"><p><img alt="Before" loading="eager" src="https://res.cloudinary.com/dg5nsedzw/image/upload/v1698193254/blog/blue-noise-dithering-before.png" width="700" height="511"/></p><p><img alt="After" loading="eager" src="https://res.cloudinary.com/dg5nsedzw/image/upload/v1698193254/blog/blue-noise-dithering-after.png" width="700" height="511"/></p><div id="slider-line"><p><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" style="transform:rotate(180deg)"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></p></div></div><figcaption>Before/After comparison of our Volumetric cloud with fewer Raymarching steps and without and with Blue Noise dithering.</figcaption></figure><p>And here&#39;s the demo showcasing our blue noise dithering in action giving us a softer cloud ⛅:</p><!--$--><!--/$--><h3 id="upscaling-with-bicubic-filtering"><a href="#upscaling-with-bicubic-filtering" aria-hidden="true" tabindex="-1"><span></span></a>Upscaling with Bicubic filtering</h3><p>This second improvement recommended by <a href="https://twitter.com/N8Programs">@N8Programs</a> aims to fix some remaining noise artifacts that remain following the introduction of the blue noise dithering to our raymarched scene.</p><p><strong>Bicubic filtering</strong> is used in upscaling and allows smoothing out some noise patterns while retaining details by calculating the value of a new pixel by considering 16 neighboring pixels through a cubic polynomial (<a href="https://en.wikipedia.org/wiki/Bicubic_interpolation">Sources</a>).</p><p>I was lucky to find <a href="https://www.shadertoy.com/view/Dl2SDW">an implementation of bicubic filtering on Shadertoy</a> made by N8Programs himself! Applying it directly to our existing work however, is not that straightforward. We have to add this improvement as its own step or pass in the rendering process, almost as a post-processing effect.</p><p>I introduced an easy way to build this kind of pipeline in my article titled <a href="https://thewitchofendor.com/posts/beautiful-and-mind-bending-effects-with-webgl-render-targets#an-alternative-to-effectcomposer-for-post-processing-effects">Beautiful and mind-bending effects with WebGL Render Targets</a> where I showcase how you can use Frame Buffer Objects (FBO) to apply some post-processing effects on an entire scene which we can use for this use case:</p><ol>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We render our main raymarched canvas in a <strong>portal</strong>.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>The default scene only contains a <strong>fullscreen triangle</strong>.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We render our main scene in a render target.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We pass <strong>the texture of the main scene&#39;s render target as a uniform</strong> of our bicubic filtering material.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We use the bicubic filtering material as the material for our fullscreen triangle.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Our bicubic filtering will take our noisy raymarched scene as a texture uniform and output the smoothed out scene.</p></li>
</ol><div data-fullbleed="true"><div><figure><span><span></span><img alt="Diagram showcasing how the bicubic filtering is applied as a post-processing effect to the original scene using Render Targets." src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="responsive"/></span><figcaption>Diagram showcasing how the bicubic filtering is applied as a post-processing effect to the original scene using Render Targets.</figcaption></figure></div></div><p>Here&#39;s a quick comparison of our scene before and after applying the bicubic
filtering:</p><figure><div tabindex="0" role="slider" aria-label="Before/After comparison of our Volumetric cloud with without and with Bicubic Filtering. Notice the noise around at the edges and less dense region of the cloud being smoothed out when the effect is applied." aria-valuemin="0" aria-valuemax="100" aria-valuenow="40"><p><img alt="Before" loading="eager" src="https://res.cloudinary.com/dg5nsedzw/image/upload/v1698193254/blog/bicubic-before.png" width="700" height="555"/></p><p><img alt="After" loading="eager" src="https://res.cloudinary.com/dg5nsedzw/image/upload/v1698193254/blog/bicubic-after.png" width="700" height="555"/></p><div id="slider-line"><p><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" style="transform:rotate(180deg)"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></p></div></div><figcaption>Before/After comparison of our Volumetric cloud with without and with Bicubic Filtering. Notice the noise around at the edges and less dense region of the cloud being smoothed out when the effect is applied.</figcaption></figure><p>The full implementation is a bit long, and features concepts I already went through in my render target focused blog post, so I invite you to look at it on your own time in the demo below:</p><!--$--><!--/$--><p>Leveraging render targets allowed me to play more with the resolution of the original raymarched scene. You can see a little selector that lets you pick at which resolution we render our raymarched cloud. You can notice that there are not a lot of differences between <code>1x</code> and <code>0.5x</code> which is great: <strong>we can squeeze more FPS without sacrificing the output quality 🎉</strong>.</p></section>
<section id="physically-accurate-clouds-section"><h2 id="physically-accurate-clouds"><a href="#physically-accurate-clouds" aria-hidden="true" tabindex="-1"><span></span></a>Physically accurate Clouds</h2><p>So far, we&#39;ve managed to build really <em>beautiful cloudscapes</em> with Volumetric Raymarching using some simple techniques and mixing the right colors. The resulting scenes are satisfying enough and give the illusion of large, dense clouds, but what if we wanted a more <em>realistic</em> output?</p><p>I spent quite some time digging through talks, videos, and articles on how game engines solve the problem of physically accurate clouds and all the techniques involved in them. It&#39;s been a journey, and I wanted to dedicate this last section to this topic because I find the subject fascinating: from a couple of physical principles of actual real-life clouds, we can render clouds in WebGL using Volumetric Raymarching!</p><h3 id="beers-law"><a href="#beers-law" aria-hidden="true" tabindex="-1"><span></span></a>Beer&#39;s Law</h3><p>I already introduced the concept of <a href="https://en.wikipedia.org/wiki/Beer%E2%80%93Lambert_law">Beer&#39;s Law</a> in my <a href="https://thewitchofendor.com/posts/painting-with-math-a-gentle-study-of-raymarching#sky-fog-and-martian-landscape">Raymarching blog post</a> as a way to render fog in the distance of a scene. It states that the intensity of light passing through a transparent medium is exponentially related to the distance it travels. <strong>The further to the medium light propagates, the more it is being absorbed</strong>. The formula for Beer&#39;s Law is as follows:</p><p><code>I = I0​ * exp(−α * d)</code>, where <code>α</code> is the absorption or attenuation coefficient describing how &#34;thick&#34; or &#34;dense&#34; the medium is. In our demos, we&#39;ll consider an absorption coefficient of <code>0.9</code>, although I&#39;d invite you to try different values so you can see the impact of this number on the resulting render.</p><figure><span><span></span><img alt="Diagram showcasing how Beer&#39;s Law can be used to represent how much light gets absorbed through a volume" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="responsive"/></span><figcaption>Diagram showcasing how Beer&#39;s Law can be used to represent how much light gets absorbed through a volume</figcaption></figure><p>We can use this formula in our GLSL code and modify the Raymarching loop to use it instead of the &#34;hacky&#34; transparency hack we used in the first part:</p><!--$--><div><div><p data-testid="codesnippet-title">Using Beer&#39;s Law to calculate and return the accumulated light energy going through the cloud</p></div><pre><div data-testid="line"><p>2</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">#</span><span data-testid="content-line">define</span><span data-testid="content-line"> </span><span data-testid="content-line">ABSORPTION_COEFFICIENT</span><span data-testid="content-line"> </span><span data-testid="content-line">0.9</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">BeersLaw</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> dist</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> absorption</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">exp</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">dist </span><span data-testid="content-line">*</span><span data-testid="content-line"> absorption</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">const</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> SUN_POSITION </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">const</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> MARCH_SIZE </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.16</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>13</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">raymarch</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line"> rayOrigin</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> offset</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>15</p><p><span><span data-testid="content-line">  depth </span><span data-testid="content-line">+=</span><span data-testid="content-line"> MARCH_SIZE </span><span data-testid="content-line">*</span><span data-testid="content-line"> offset</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> p </span><span data-testid="content-line">=</span><span data-testid="content-line"> rayOrigin </span><span data-testid="content-line">+</span><span data-testid="content-line"> depth </span><span data-testid="content-line">*</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>17</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> sunDirection </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">normalize</span><span data-testid="content-line">(</span><span data-testid="content-line">SUN_POSITION</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>19</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> totalTransmittance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>20</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> lightEnergy </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>22</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> i </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> i </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> MAX_STEPS</span><span data-testid="content-line">;</span><span data-testid="content-line"> i</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>23</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> density </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">scene</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>26</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">float</span><span data-testid="content-line"> transmittance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">BeersLaw</span><span data-testid="content-line">(</span><span data-testid="content-line">density </span><span data-testid="content-line">*</span><span data-testid="content-line"> MARCH_SIZE</span><span data-testid="content-line">,</span><span data-testid="content-line"> ABSORPTION_COEFFICIENT</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>27</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">float</span><span data-testid="content-line"> luminance </span><span data-testid="content-line">=</span><span data-testid="content-line"> density</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>29</p><p><span><span data-testid="content-line">      totalTransmittance </span><span data-testid="content-line">*=</span><span data-testid="content-line"> transmittance</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>30</p><p><span><span data-testid="content-line">      lightEnergy </span><span data-testid="content-line">+=</span><span data-testid="content-line"> totalTransmittance </span><span data-testid="content-line">*</span><span data-testid="content-line"> luminance</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>34</p><p><span><span data-testid="content-line">    p </span><span data-testid="content-line">=</span><span data-testid="content-line"> rayOrigin </span><span data-testid="content-line">+</span><span data-testid="content-line"> depth </span><span data-testid="content-line">*</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><!--/$--><p>In the code snippet above:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We gutted the raymarching loop, so it now relies on a more physically based property: <strong>Beer&#39;s Law</strong>.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We changed the interface of our function: instead of returning a full color, it now returns a <code>float</code> representing the <em>amount of light</em> or <em>light energy</em> going through the cloud.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>As we march through the volume, we accumulate the obtained <code>transmittance</code>. The deeper we go, the less light we add.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We return the resulting <code>lightEnergy</code></p></li>
</ul><p>The demo below showcases what using Beers Law yields in our Raymarching loop 👀</p><!--$--><!--/$--><p>The resulting cloud is a bit strange:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>its edges do indeed behave like a cloud</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>the center is just a white blob</p></li>
</ul><p>all of which is, once again, due to the lack of a proper lighting model.</p><h3 id="sampling-light"><a href="#sampling-light" aria-hidden="true" tabindex="-1"><span></span></a>Sampling light</h3><p>Our new cloud does not interact with light right now. You can try changing the <code>SUN_POSITION</code> vector: the resulting render will remain the same. We not only need a lighting model but also a physically accurate one.</p><p>For that, we can try to compute how much light has been absorbed for each sample point of our Raymarching loop by:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Start a dedicated nested Raymarching loop that goes from the current sample point to the light source (direction of the light)</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Sample the density and apply Beer&#39;s Law like we just did</p></li>
</ul><p>The diagram below illustrates this technique to make it a bit easier to understand:</p><figure><span><span></span><img alt="Diagram showcasing how we sample multiple points of lights in the direction of the light through our volume for each sampled point in the Raymarching loop." src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="responsive"/></span><figcaption>Diagram showcasing how we sample multiple points of lights in the direction of the light through our volume for each sampled point in the Raymarching loop.</figcaption></figure><p>The code snippet below is one of many implementations of this technique. We&#39;ll use this one going forward:</p><!--$--><div><div><p data-testid="codesnippet-title">Dedicated nested raymarching loop to sample the light received at a given sampled point</p></div><pre><div data-testid="line"><p>2</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">#</span><span data-testid="content-line">define</span><span data-testid="content-line"> </span><span data-testid="content-line">MAX_STEPS_LIGHTS</span><span data-testid="content-line"> </span><span data-testid="content-line">6</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">#</span><span data-testid="content-line">define</span><span data-testid="content-line"> </span><span data-testid="content-line">ABSORPTION_COEFFICIENT</span><span data-testid="content-line"> </span><span data-testid="content-line">0.9</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">const</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> SUN_POSITION </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>8</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">const</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> MARCH_SIZE </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.16</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">lightmarch</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line"> position</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> lightDirection </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">normalize</span><span data-testid="content-line">(</span><span data-testid="content-line">SUN_POSITION</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> totalDensity </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>13</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> marchSize </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.03</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>15</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> step </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> step </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> MAX_STEPS_LIGHTS</span><span data-testid="content-line">;</span><span data-testid="content-line"> step</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>16</p><p><span><span data-testid="content-line">      position </span><span data-testid="content-line">+=</span><span data-testid="content-line"> lightDirection </span><span data-testid="content-line">*</span><span data-testid="content-line"> marchSize </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">step</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>18</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">float</span><span data-testid="content-line"> lightSample </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">scene</span><span data-testid="content-line">(</span><span data-testid="content-line">position</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">true</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>19</p><p><span><span data-testid="content-line">      totalDensity </span><span data-testid="content-line">+=</span><span data-testid="content-line"> lightSample</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>22</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> transmittance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">BeersLaw</span><span data-testid="content-line">(</span><span data-testid="content-line">totalDensity</span><span data-testid="content-line">,</span><span data-testid="content-line"> ABSORPTION_COEFFICIENT</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>26</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">raymarch</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line"> rayOrigin</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> offset</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>28</p><p><span><span data-testid="content-line">  depth </span><span data-testid="content-line">+=</span><span data-testid="content-line"> MARCH_SIZE </span><span data-testid="content-line">*</span><span data-testid="content-line"> offset</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>29</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> p </span><span data-testid="content-line">=</span><span data-testid="content-line"> rayOrigin </span><span data-testid="content-line">+</span><span data-testid="content-line"> depth </span><span data-testid="content-line">*</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>30</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> sunDirection </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">normalize</span><span data-testid="content-line">(</span><span data-testid="content-line">SUN_POSITION</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>32</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> totalTransmittance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>33</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> lightEnergy </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>35</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> i </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> i </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> MAX_STEPS</span><span data-testid="content-line">;</span><span data-testid="content-line"> i</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>36</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> density </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">scene</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">false</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>40</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">float</span><span data-testid="content-line"> lightTransmittance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">lightmarch</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">,</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>41</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">float</span><span data-testid="content-line"> luminance </span><span data-testid="content-line">=</span><span data-testid="content-line"> density</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>43</p><p><span><span data-testid="content-line">      totalTransmittance </span><span data-testid="content-line">*=</span><span data-testid="content-line"> lightTransmittance</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>44</p><p><span><span data-testid="content-line">      lightEnergy </span><span data-testid="content-line">+=</span><span data-testid="content-line"> totalTransmittance </span><span data-testid="content-line">*</span><span data-testid="content-line"> luminance</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>48</p><p><span><span data-testid="content-line">    p </span><span data-testid="content-line">=</span><span data-testid="content-line"> rayOrigin </span><span data-testid="content-line">+</span><span data-testid="content-line"> depth </span><span data-testid="content-line">*</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><!--/$--><p>Because of this nested loop, the algorithmic complexity of our Raymarching loop just increased, so we&#39;ll need to define a relatively low number of steps to sample our light while also calculating a less precise density by reducing the number of Octaves in our FBM to preserve a decent frame-rate (that&#39;s one easy <em>win</em> I implemented to avoid dropping too many frames).</p><p>All these little tweaks and performance considerations have been taken into account in the demo below:</p><!--$--><!--/$--><h3 id="anisotropic-scattering-and-phase-function"><a href="#anisotropic-scattering-and-phase-function" aria-hidden="true" tabindex="-1"><span></span></a>Anisotropic scattering and phase function</h3><p>Until now, we assumed that light gets distributed equally in every direction as it propagates through the cloud. In reality, the light gets scattered in different directions with different intensities due to water droplets. This phenomenon is called <strong>Anisotropic scattering</strong> (vs. Isotropic when light scatters evenly), and to have a realistic cloud, we can try to take this into account within our Raymarching loop.</p><figure><span><span></span><img alt="Diagram showcasing the difference between isotropic scattering and anisotropic scattering when sampling our light energy." src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="responsive"/></span><figcaption>Diagram showcasing the difference between isotropic scattering and anisotropic scattering when sampling our light energy.</figcaption></figure><p>To simulate Anisotropic scattering in our cloud scene for each sampling point for a given light source, we can use a <em>phase function</em>. A common one is the <strong>Henyey-Greenstein phase function</strong>, which I encountered in pretty much all the examples I could find on physically accurate Volumetric Raymarching.</p><p>The GLSL implementation of this phase function looks as follows:</p><!--$--><div><div><p data-testid="codesnippet-title">Implementation of the Henyey-Greenstein phase function</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">HenyeyGreenstein</span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> g</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> mu</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line">	</span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">4.0</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> PI</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">  </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> gg</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">pow</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> gg </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">2.0</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> g </span><span data-testid="content-line">*</span><span data-testid="content-line"> mu</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.5</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><!--/$--><p>We now have to introduce the result of this new function in our Raymarching loop by multiplying it by the density at a given sampled point, and what we obtain is more realistic lighting for our cloud, especially if the light source moves around.</p><!--$--><div><div><p data-testid="codesnippet-title">Introducing the Henyey-Greenstein phase function inside our Raymarching loop</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">raymarch</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line"> rayOrigin</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> offset</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line">  depth </span><span data-testid="content-line">+=</span><span data-testid="content-line"> MARCH_SIZE </span><span data-testid="content-line">*</span><span data-testid="content-line"> offset</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> p </span><span data-testid="content-line">=</span><span data-testid="content-line"> rayOrigin </span><span data-testid="content-line">+</span><span data-testid="content-line"> depth </span><span data-testid="content-line">*</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>5</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> sunDirection </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">normalize</span><span data-testid="content-line">(</span><span data-testid="content-line">SUN_POSITION</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> totalTransmittance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>8</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> lightEnergy </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>10</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> phase </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">HenyeyGreenstein</span><span data-testid="content-line">(</span><span data-testid="content-line">SCATTERING_ANISO</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">rayDirection</span><span data-testid="content-line">,</span><span data-testid="content-line"> sunDirection</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> i </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> i </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> MAX_STEPS</span><span data-testid="content-line">;</span><span data-testid="content-line"> i</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>13</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> density </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">scene</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">false</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>17</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">float</span><span data-testid="content-line"> lightTransmittance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">lightmarch</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">,</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>18</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">float</span><span data-testid="content-line"> luminance </span><span data-testid="content-line">=</span><span data-testid="content-line"> density </span><span data-testid="content-line">*</span><span data-testid="content-line"> phase</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>20</p><p><span><span data-testid="content-line">      totalTransmittance </span><span data-testid="content-line">*=</span><span data-testid="content-line"> lightTransmittance</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>21</p><p><span><span data-testid="content-line">      lightEnergy </span><span data-testid="content-line">+=</span><span data-testid="content-line"> totalTransmittance </span><span data-testid="content-line">*</span><span data-testid="content-line"> luminance</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>25</p><p><span><span data-testid="content-line">    p </span><span data-testid="content-line">=</span><span data-testid="content-line"> rayOrigin </span><span data-testid="content-line">+</span><span data-testid="content-line"> depth </span><span data-testid="content-line">*</span><span data-testid="content-line"> rayDirection</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><!--/$--><figure><div tabindex="0" role="slider" aria-label="Comparison of our physically accurate Volumetric cloud with and without applying the Henyey-Greenstein phase function." aria-valuemin="0" aria-valuemax="100" aria-valuenow="40"><p><img alt="Before" loading="eager" src="https://res.cloudinary.com/dg5nsedzw/image/upload/v1698193254/blog/phase-before.png" width="700" height="511"/></p><p><img alt="After" loading="eager" src="https://res.cloudinary.com/dg5nsedzw/image/upload/v1698193254/blog/phase-after.png" width="700" height="511"/></p><div id="slider-line"><p><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" style="transform:rotate(180deg)"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></p></div></div><figcaption>Comparison of our physically accurate Volumetric cloud with and without applying the Henyey-Greenstein phase function.</figcaption></figure><p>The final demo of this article below showcases our scene with:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Blue noise dithering</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Bicubic filtering</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Beer&#39;s law</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Our more realistic light sampling</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Henyey-Greenstein phase function</p></li>
</ul><!--$--><!--/$--><p>The result is looks really good, although I&#39;ll admit I had to add an extra value term to my light energy formula so the cloud wouldn&#39;t simply &#34;fade away&#34; when dense parts would end up in the shade.</p><!--$--><div><div><p data-testid="codesnippet-title">Extra value added to the luminance formula</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">float</span><span data-testid="content-line"> luminance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.025</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> density </span><span data-testid="content-line">*</span><span data-testid="content-line"> phase</span><span data-testid="content-line">;</span></span></p></div></pre></div><!--/$--><p>The need for a hack probably highlights some issues with my code, most likely due to how I use the resulting light energy value returned by the Raymarching loop or an absorption coefficient that&#39;s a bit too high. Not sure. If you find any blatantly wrong assumptions in my code, please let me know so I can make the necessary edits.</p><p>Some other optimizations are possible to make the cloud look fluffier and denser, like using the <a href="https://www.guerrilla-games.com/media/News/Files/The-Real-time-Volumetric-Cloudscapes-of-Horizon-Zero-Dawn.pdf">Beer&#39;s Powder approximation (page 64)</a>, but it was mentioned to me that those are just used for aesthetic reasons and are not actually physically based (I also honestly couldn&#39;t figure out how to apply it without altering significantly my <code>MAX_STEPS</code>, <code>MAX_STEPS_LIGHTS</code>, and <code>marchSize</code> variables 😅 and the result was still not great).</p><div><div><div><p><a href="https://twitter.com/Cody_J_Bennett" target="_blank" rel="noopener noreferrer"><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2746%27%20height=%2746%27/%3e"/></span><img alt="Cody_J_Bennett" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span></a></p></div><a href="https://twitter.com/Cody_J_Bennett/status/1710675662904709611" target="_blank" rel="noopener noreferrer" aria-label="@Cody_J_Bennett&#39;s Twitter profile"><svg viewBox="328 355 335 276" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M 630, 425 A 195, 195 0 0 1 331, 600 A 142, 142 0 0 0 428, 570 A 70, 70 0 0 1 370, 523 A 70, 70 0 0 0 401, 521 A 70, 70 0 0 1 344, 455 A 70, 70 0 0 0 372, 460 A 70, 70 0 0 1 354, 370 A 195, 195 0 0 0 495, 442 A 67, 67 0 0 1 611, 380 A 117, 117 0 0 0 654, 363 A 65, 65 0 0 1 623, 401 A 117, 117 0 0 0 662, 390 A 65, 65 0 0 1 630, 425 Z" style="fill:#3BA9EE"></path></svg></a></div><p>@MaximeHeckel Note that beer-powder is a non-physical approximation. Maybe see:

https://t.co/LlHxW5x5sb</p></div></section>
<section id="conclusion-section"><h2 id="conclusion"><a href="#conclusion" aria-hidden="true" tabindex="-1"><span></span></a>Conclusion</h2><p>We learned several ways to render cloud-like volumes with Raymarching throughout this article, and considering that a few weeks prior to that, I wasn&#39;t even able to wrap my head around the concept of Volumetric Raymarching, <em>I&#39;m happy with the result and proud of myself</em> given how complex and daunting this subject can be. I was also pleasantly surprised by the ability to apply some physics principles and port techniques commonly used in triple-A video game productions to WebGL to achieve realistic looking clouds.</p><p>With that, I&#39;m excited to attempt combining raymarched clouds with terrain, like the ones introduced in my Raymarching article, or even more complex challenges like rendering a planet with realistic atmospheric scattering. Another idea I had was to build a raymarched galaxy; since we can simplify it to a massive cloud in space and that some of the physics principles introduced in this article should still apply and yield beautiful renders.</p><p>I hope this article will inspire you in your own Raymarching endeavors and that it helped make this seemingly hard-to-grasp concept of Volumetric rendering a bit more welcoming 🙂.</p></section></div></div></div>
  </body>
</html>
