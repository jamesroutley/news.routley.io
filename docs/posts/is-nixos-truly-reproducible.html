<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://luj.fr/blog/is-nixos-truly-reproducible.html">Original</a>
    <h1>Is NixOS truly reproducible?</h1>
    
    <div id="readability-page-1" class="page"><div>
            <p>Build reproducibility is often considered as a <em>de facto</em> feature provided by functional package managers like Nix. Although the functional package manager model has important assets in the quest for build reproducibility (like reproducibility of build environments for example<a href="#fn1" id="fnref1" role="doc-noteref"><sup>1</sup></a>), it is clear among practitioners that Nix does <strong>not</strong> guarantee that all its builds achieve <em>bitwise reproducibility</em>. In fact, it is not complicated to write a Nix package that builds an artifact non-deterministically:</p>
<pre tabindex="0"><code><span><span>let</span></span>
<span><span>  pkgs</span><span> =</span><span> import</span><span> &lt;nixpkgs&gt; </span><span>{</span><span> };</span></span>
<span><span>in</span></span>
<span><span>pkgs</span><span>.</span><span>runCommand </span><span>&#34;random&#34;</span><span> {</span><span> }</span><span> &#39;&#39;</span></span>
<span><span>  echo $RANDOM &gt; $out</span></span>
<span><span>&#39;&#39;</span></span>
<span></span></code></pre>

<p>Despite this, build reproducibility has historically been used as a marketing argument by the NixOS community, with the catchphrase “<em>Reproducible builds and deployments</em>” appearing as a headline of the <a href="https://nixos.org">nixos.org</a> page until 2023<a href="#fn2" id="fnref2" role="doc-noteref"><sup>2</sup></a>. This situation has even occasionally created tensions with members of the <a href="https://reproducible-builds.org/">reproducible-builds</a> group who dedicate a lot of time contributing patches in compilers and downstream projects to make them bitwise reproducible <em>for everyone</em>, and prompted blog posts such as <a href="https://linderud.dev/blog/nixos-is-not-reproducible/">“NixOS is not reproducible”</a> by Foxboron.</p>
<p>Furthermore, an objective answer to the question “How good is NixOS for bitwise reproducibility” is difficult to give, as there exist no reproducibility monitoring at the scale of the Nix package set (<code>nixpkgs</code>), contrary to other Linux distributions like <a href="https://tests.reproducible-builds.org/debian/reproducible.html">Debian</a>. One of the reasons for that is that <code>nixpkgs</code> is such a big package set (about 100k packages at the time of writing), that systematically testing for bitwise reproducibility demands huge resources<a href="#fn3" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<h2 id="why-is-build-reproducibility-important">Why is build reproducibility important?</h2>
<p>One direct application of reproducible-builds is increasing trust in the software supply chain by allowing users to independently verify the trustworthiness of binaries they download. Indeed, in most typical scenarios, users of Linux distributions will not compile their software directly on their machine but rather download a pre-compiled version supplied by their distribution. The problem here is that the user have to <strong>trust</strong> that the artifacts that they acquire have not been tampered with (for example, if the compilation server is compromised).</p>
<p>When a software is reproducible, it makes it possible on the other hand to locally compile it and verify that the exact same artifacts are obtained, hence allowing to build trust in the artifact distributed by the Linux distribution. It is also possible to delegate this verification to one or several third-parties, hence “distributing” the trust one have in a given artifact.</p>
<figure>
<img src="https://probablydance.com/2025/02/08/assets/posts/is-nixos-truly-reproducible/rb-verif.png"/>
<figcaption>Caption: <em>Leveraging reproducible-builds to increase trust in distributed artifacts.</em></figcaption>
</figure>

<h2 id="science-to-the-rescue">Science to the rescue!</h2>
<p>As part of my PhD, and under the supervision of <a href="https://www.theozimmermann.net/">Théo Zimmermann</a> and <a href="https://upsilon.cc/~zack/">Stefano Zacchiroli</a>, I have empirically studied bitwise build reproducibility in <code>nixpkgs</code> over a time period of 6 years. I warmly advise the reader to go have a look at <a href="https://hal.science/hal-04913007">“Does Functional Package Management Enable Reproducible Builds at Scale? Yes.”</a>, our research article – to be published at MSR’25 – reporting all our findings on the matter, but I’ll try to synthesize our takeaways in this blog post.</p>
<h3 id="research-methodology">Research methodology</h3>
<p>We selected 17 <code>nixpkgs</code> revisions, regularly spaced between 2017 and 2023, and locally recompiled the integrality of the packages from these revisions. We then compared the output with the ground truth (historical builds from Hydra, the <code>nixpkgs</code> continuous integration) to determine if the package is bitwise reproducible or not.</p>
<div role="alert">
  <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
    <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z"></path>
  </svg>
  <p><span>Info</span></p><p>
Note that even projects that do monitor build reproducibility like Debian or Arch Linux only do it at a given point in time (when the package gets built) and not backward in time like we did in our experiment!

  </p>
</div>


<p>For every non-reproducible build, we then went further to try to infer reasons for non reproducibility:</p>
<ol type="1">
<li>We generated the <a href="https://diffoscope.org/">diffoscope</a> between both builds in order to understand how the artifacts differ;</li>
<li>In case the package becomes reproducible later at a later point in time in our dataset, we identified the commit that fixed the reproducibility issues using a bisection of the <code>nixpkgs</code> repository, to try to understand if the reproducibility fixes give use insights on the reproducibility issues.</li>
</ol>
<figure>
<img src="https://probablydance.com/2025/02/08/assets/posts/is-nixos-truly-reproducible/pipeline.png"/>
<figcaption>Caption: <em>Description of our build and analysis pipeline.</em></figcaption>
</figure>
<h3 id="key-findings">Key findings</h3>
<ol>
<li><p><strong>Reproducibility rate in <code>nixpkgs</code></strong></p>
<p>Our most important finding is that the reproducibility rate in <code>nixpkgs</code> has increased steadily from 69% in 2017 to <strong>about 91% in April 2023</strong>. The high reproducibility rate in our most recent revision is quite impressive, given both the size of the package set and the absence of systematic monitoring in <code>nixpkgs</code>. We knew that it was possible to achieve very good reproducibility rate in smaller package sets like Debian, but this shows that achieving very high bitwise reproducibility <strong>is possible at scale</strong>, something that was believed impossible by practitioners<a href="#fn4" id="fnref4" role="doc-noteref"><sup>4</sup></a>.</p>
<figure>
<img src="https://probablydance.com/2025/02/08/assets/posts/is-nixos-truly-reproducible/reproducibility-overall-absolute.png"/>
<figcaption>Caption: <em>Absolute numbers of reproducible, rebuildable (but unreproducible)
and non-rebuildable packages over time.</em></figcaption>
</figure>

<p>As shown by the figure, we can also spot a reproducibility regression around June 2020 that we traced back to a <code>pip</code> regression that happened at the time and that was <a href="https://github.com/pypa/pip/issues/7808">tracked by the NixOS community.</a></p></li>
<li><p><strong>Reasons for unreproducibilities</strong></p>
<p>By manually analyzing the diffoscopes from our unreproducible packages, we were also able to identify the most prevalent causes for non reproducibility and devise heuristics to identify them. With these heuristics, we are able to identify at least one non-reproducibility reason for about 20% of the diffoscopes.</p>
<p>Our derived heuristics are:</p>
<ul>
<li><em>embedded dates</em> (the date of the build appearing in the artifacts), accounting for 14.8% of the unreproducible packages (despite being <a href="https://reproducible-builds.org/docs/source-date-epoch/">one of the main recommendations from the reproducible-builds group</a> to improve reproducibility!);</li>
<li><em>embedded uname outputs</em> (containing impure information about the host running the build), accounting for 1.3% of the unreproducible packages;</li>
<li><em>embedded environment variables</em>, accounting for 2.2% of the unreproducible packages;</li>
<li><em>embedded build ids</em> (some ecosystems embed a unique – but not deterministic – build ID into the artifacts), also accounting for 2.2% of the unreproducible packages.</li>
</ul>
<figure>
<img src="https://probablydance.com/2025/02/08/assets/posts/is-nixos-truly-reproducible/diffoscope-heuristics.png"/>
<figcaption>Caption: <em>Evolution of the number of packages for which we generated
diffoscopes that are matched by each of our heuristics, over time.</em></figcaption>
</figure>

<p>The interesting aspect of these causes is that they show that even if <code>nixpkgs</code> already achieves great reproducibility rates, there still exists some low hanging fruits towards improving reproducibility that could be tackled by the Nix community and the whole FOSS ecosystem.</p>
<p>Additional research questions are covered in <a href="https://hal.science/hal-04913007">the paper</a> and more insights on the difference of reproducibility in different <code>nixpkgs</code>’s ecosystems or our study of the reproducibility fixes await the curious reader there!</p></li>
</ol>

<p>This research work shows that there is a very large proportion of packages that are already bitwise reproducible in <code>nixpkgs</code>. One direct consequence of this, is that for most packages, build reproducibility could be leveraged in order to <strong>increase trust in the Nix substitution protocol</strong> (downloading pre-built packages from caches). This justifies investing resources to build solutions towards distributed cache solutions relying on build reproducibility, like the one envisioned by the <a href="https://github.com/nix-community/trustix">Trustix project</a> for example.</p>

        </div></div>
  </body>
</html>
