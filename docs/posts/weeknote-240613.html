<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ryleealanza.org/posts/weeknote-240613/">Original</a>
    <h1>Weeknote 240613</h1>
    
    <div id="readability-page-1" class="page"><div id="content"><header></header><p>A “weeknote”, I am told is not like a blog post,
and yet here I am putting this first one on my blog.
I am sovereign of my domain name, I shall do as I see fit.
Expect: bullet-journal style reflections.
Also I think these are usually supposed to be a Friday sort of thing,
but here I am writing one on a Thursday.
It’s a really Friday-feeling Thursday, in my defense.</p><ul><li>Somehow I signed myself up for a bit more than usual this week.</li><li>Today I gave a little 5-minute talk on my <em>seamstress</em> program for the first time.</li><li>More about it later, but the preparation for it somehow managed to be a bit of a Hail Mary moment</li><li>On Saturday, I’m performing a set of live-coded music at Wonderville, here in NYC.</li><li>Don’t tell anyone (lol) but I really need to buckle down and rehearse.</li><li>Somehow I decided that I wanted to add unit tests to seamstress over the weekend.</li><li>They’ve been really helpful so far!</li><li>Seamstress is kind of annoying to test from Zig:</li><li>All the “real action” (by design) happens in the Lua layer,
and calling into Lua from Zig gets mind-bendy and verbose quite quickly.</li><li>Additionally, (again, by design) there isn’t a ton of heavy business logic happening in Zig?</li><li>Like, I ran into some endian-ness surprises when parsing hex numbers as RGB colors, but that’s about it</li><li>But from Lua’s perspective, since the Zig event loop and Lua VM are all set up, there’s <em>plenty</em> to test</li><li>Anyway, all of this is to say I’m using Busted, a Lua testing framework</li><li>But I quickly discovered that Busted tests have no builtin support for asynchronicity</li><li>This is an issue for testing the actual operation of seamstress 2,
because idiomatic (lol) seamstress code makes use of several provided callbacks</li><li>So what’s a Rylee to do?</li><li>I ended up hand-rolling a <code>Promise</code> type and <code>async</code> / <code>await</code> functionality heavily inspired by JavaScript.</li><li>Here it is in action</li></ul><div><div><pre tabindex="0"><code data-lang="lua"><span><span>  <span>-- calling Promise creates a Promise type</span>
</span></span><span><span>  <span>p</span> <span>=</span> <span>seamstress.async</span><span>.</span><span>Promise</span><span>(</span><span>function</span><span>()</span>
</span></span><span><span>    <span>print</span><span>(</span><span>&#39;hello from the promise&#39;</span><span>)</span>
</span></span><span><span>  <span>end</span><span>)</span>
</span></span><span><span>  <span>print</span><span>(</span><span>p</span><span>)</span>
</span></span><span><span>  <span>-- output:</span>
</span></span><span><span>  <span>-- seamstress.tui.Promise 0x[some address]</span>
</span></span><span><span>  <span>-- &#39;hello from the promise&#39;</span>
</span></span><span><span>
</span></span><span><span>  <span>-- calling async creates a function which returns a Promise</span>
</span></span><span><span>  <span>f</span> <span>=</span> <span>seamstress.async</span><span>(</span><span>function</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>)</span>
</span></span><span><span>    <span>return</span> <span>x</span> <span>+</span> <span>y</span>
</span></span><span><span>  <span>end</span><span>)</span>
</span></span><span><span>
</span></span><span><span>  <span>-- we can either chain the Promise with `anon`</span>
</span></span><span><span>  <span>-- (`then` is a reserved word in Lua)</span>
</span></span><span><span>  <span>-- or when in an async context, we may `await` it</span>
</span></span><span><span>  <span>f</span><span>(</span>5<span>,</span> 4<span>):</span><span>anon</span><span>(</span><span>function</span><span>(</span><span>x</span><span>)</span> <span>print</span><span>(</span><span>&#39;we got &#39;</span> <span>..</span> <span>x</span> <span>..</span> <span>&#39; folks!&#39;</span><span>)</span> <span>end</span><span>)</span>
</span></span><span><span>  <span>-- output:</span>
</span></span><span><span>  <span>-- we got 9 folks!</span>
</span></span><span><span>
</span></span><span><span>  <span>g</span> <span>=</span> <span>seamstress.async</span><span>.</span><span>Promise</span><span>(</span><span>function</span><span>()</span>
</span></span><span><span>    <span>local</span> <span>z</span> <span>=</span> <span>f</span><span>(</span>13 <span>,</span>3<span>):</span><span>await</span><span>()</span>
</span></span><span><span>    <span>print</span><span>(</span><span>&#39;we got &#39;</span> <span>..</span> <span>z</span> <span>..</span> <span>&#39; this time folks!&#39;</span><span>)</span>
</span></span><span><span>  <span>end</span><span>)</span>
</span></span><span><span>  <span>-- output:</span>
</span></span><span><span>  <span>-- we got 16 this time folks!</span></span></span></code></pre></div></div><ul><li>the implementation was truly brain-breaking and yet ultimately very simple code to write:</li><li>under the hood, a <code>Promise</code> executing Lua code puts a short timer onto the Zig event loop.
This timer resumes execution of the Lua function until it’s finished.</li><li>Awaiting a <code>Promise</code> is as simple as yielding until that <code>Promise</code> is resolved,
and then reaching into its stack and grabbing the values.</li><li>Many thanks to Jeremy Kaplan and Kyle Edwards for talking me through the gnarly bits.</li><li>Anyway, getting that right somehow ate most of the early part of my week.</li><li>Glad it did, but I might have been less stressed today if I had,
y’know, not wanted so badly to get that working.</li><li>Oh I made a little minesweeper demo game in seamstress 2.</li><li>It runs in the terminal; the whole code for the game is 236 lines of code,
which feels like a reasonable, small number.</li></ul></div></div>
  </body>
</html>
