<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://greg.molnar.io/blog/the-dangers-of-single-line-regular-expressions/">Original</a>
    <h1>The dangers of single line regular expressions</h1>
    
    <div id="readability-page-1" class="page"><div>
    <p>
      I&#39;d like to let you know that my book is finally done and if you want to learn about how to avoid security issues during code review, you should read it: <a href="https://greg.molnar.io/books/secure-code-review-for-rails-developers/" target="_blank">Secure code review for Rails Developers</a>.
    </p>

    <p>The Neonify challenge on Hack The Box is a small Sinatra(a Ruby web framework) app, that generates a glowing text of the submitted value:</p>

<p><img src="https://greg.molnar.io/images/posts/neonify.png" alt="neonify"/></p>

<p>Since it is a challenge, we have access to the source code, so instead of trying to find a vulnerability by testing the input, we can check the code to see if we spot any issues.</p>

<div><div><pre><code><span>class</span> <span>NeonControllers</span> <span>&lt;</span> <span>Sinatra</span><span>::</span><span>Base</span>

  <span>configure</span> <span>do</span>
    <span>set</span> <span>:views</span><span>,</span> <span>&#34;app/views&#34;</span>
    <span>set</span> <span>:public_dir</span><span>,</span> <span>&#34;public&#34;</span>
  <span>end</span>

  <span>get</span> <span>&#39;/&#39;</span> <span>do</span>
    <span>@neon</span> <span>=</span> <span>&#34;Glow With The Flow&#34;</span>
    <span>erb</span> <span>:&#39;index&#39;</span>
  <span>end</span>

  <span>post</span> <span>&#39;/&#39;</span> <span>do</span>
    <span>if</span> <span>params</span><span>[</span><span>:neon</span><span>]</span> <span>=~</span> <span>/^[0-9a-z ]+$/i</span>
      <span>@neon</span> <span>=</span> <span>ERB</span><span>.</span><span>new</span><span>(</span><span>params</span><span>[</span><span>:neon</span><span>]).</span><span>result</span><span>(</span><span>binding</span><span>)</span>
    <span>else</span>
      <span>@neon</span> <span>=</span> <span>&#34;Malicious Input Detected&#34;</span>
    <span>end</span>
    <span>erb</span> <span>:&#39;index&#39;</span>
  <span>end</span>

<span>end</span>
</code></pre></div></div>

<p>As we can see the post request uses a regular expression to only permit numbers, letters and spaces and it passes the value to <code>ERB.new</code> if it matches the regular expression, and the string gets evaluated. If we can bypass the regular expression check, we can execute any ruby code in ERB. The flag is in <code>/app/flag.txt</code>, so we could read it with <code>&lt;%= File.read(&#39;/app/flag.txt&#39;) %&gt;</code>.</p>

<div><div><pre><code>curl <span>-d</span> <span>&#39;neon=hello%0a%3C%25%3D%20File.open%28%27flag.txt%27%29.read%20%25%3E&#39;</span> TARGET_HOST
</code></pre></div></div>

<p>As you can see they payload starts with the string “hello”, followed by <code>%0a</code>, that’s the URL encoded version of a line break, then the URL encoded ERB snippet to extract the flag.<br/></p>

<p>This little challenge demonstrates well the danger of of using single line regular expressions. To prevent such an issue from happening, the regular expression should’ve started with <code>\A</code>(start of string) and end with <code>\z</code>(end of string).<br/></p>

<p>
Besides that, try to avoid using user controller values at places where code can be executed.
</p>

<p>Active Record validations warn about such an issue and if you use a static code analyser like spektr or brakeman, those should help to catch these issues before they reach production.</p>

    <div>
      <div>
        <div>
          <h2>Hire me for a penetration test</h2>
          <p>
          Let&#39;s find the security holes before the bad guys do.
          </p>
          
        </div>
      </div>
    </div>
    

    

  </div></div>
  </body>
</html>
