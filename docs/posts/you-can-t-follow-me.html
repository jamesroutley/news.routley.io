<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://so.nwalsh.com/2024/01/06-mastodon">Original</a>
    <h1>You can&#39;t follow me</h1>
    
    <div id="readability-page-1" class="page"><div><p>Random notes from my unsuccessful attempt to get this weblog onto Mastodon.</p></div><div>
<p>A few days ago, I stumbled over a couple of weblog posts that talked
about adding <span><a href="https://en.wikipedia.org/wiki/Mastodon_(social_network)">Mastodon</a></span> to (mostly) static sites. I thought that sounded
kind of<label for="mn-d3e16">⊕</label><span>“Kind of cool.” Always a bad sign!</span> cool. 
</p>
<p>So, I poked at things a bit. If I was serious about implementing a
full-fleged <span><a href="https://en.wikipedia.org/wiki/ActivityPub">ActivityPub</a></span> client or server, I’d dig in and work out what 
 other implementors use for testing environments, I’d read the 
 specifications, etc. 
</p>
<p>But this looked like low(er) hanging fruit, and I thought I might get 
 it working with just a bit of fun hacking. I think the problem can be 
 broken down into just a few steps: 
</p>
<ol>
<li>Publish a “<span><a href="https://en.wikipedia.org/wiki/WebFinger">WebFinger</a></span>” endpoint (easy).</li>
<li>Support a user, with an inbox and an outbox.</li>
<li>Handle “follow” and “unfollow” messages on the inbox.</li>
<li>Publish posts to followers in the outbox.</li>
<li>I assume that replies get sent back to the inbox as posts, though I
can’t actually prove that to myself with a few minutes of casual
web searching.</li>
</ol>
<p>The first hurdle is that all of the communcations have to be HTTPS,
which <a href="https://so.nwalsh.com/2023/12/31-https">is inconvenient</a> for testing purposes. Then there was a fair bit
of effort necessary to get <a href="https://so.nwalsh.com/2024/01/06-isolation">better isolation</a> for the test rig. 
</p>
<p>Once I had that up and running, I could fire up <a href="https://github.com/martinheinz/mastodon-local">a Mastodon server</a> on 
 my laptop. But could it follow my test weblog? 
</p>
<p>Pointing my Mastodon instance at <code>@so@sotest.nwalsh.com</code> was fine. It 
 hit the webfinger endpoint, hit the user endpoint, and posted 
 something to the inbox. Fantastic! Next, I edited a few things to get 
 some more debugging details about the messages being sent to my 
 endpoints, deployed those changes, went back to the Mastodon instance 
 and tried again. 
</p>
<p>Nothing happened. I mean, the Mastodon instance was happy to show me 
 the user to follow, but it didn’t actually hit the endpoints again. 
</p>
<p>I spent <em>a long time</em> poking about at the various places in the
Mastodon server were caching could be performed. I ran the “cache
clear” tasks, I fussed with the <code>nginx</code> configuration to turn off proxy 
 caching, I did everything I could think of. To no avail. 
</p>
<p>I was frustrated, but I discovered that I could make something happen 
 by clicking “Follow” so I dug in there a bit. 
</p>
<p>Next up: we’ve got all these digital signatures to deal with. There
are examples on the web of the sorts of things that need to be done,
but all the ones I could find were in <span><a href="https://en.wikipedia.org/wiki/TypeScript">TypeScript</a></span>. That’s a hurdle 
 I didn’t feel like trying to overcome today. 
</p>
<p>And then I realized that to validate the signature, I’d have to hit
the endpoint of the user attempting to follow me, e.g.,
<code>https://localhost/user/admin</code>, to get the user’s public key. 
</p>
<p>Well 🤬! 🤬! 🤬! 🤬! 
</p>
<p>There’s no way that’s going to work from my <code>sotest</code> server on a
different host. So to test this, I’d need <em>both</em> ends of the 
 communcation to be on the public internet with proper certificates. 
 And I’d have to work out how to disable caching. And I’d have to 
 reverse-engineer some TypeScript (or work out how to use TypeScript). 
</p>
<p>I gave myself a day to see if I could make progress. I did not. 
 (At least, not the kind of progress I was hoping to make.) 
</p>
<p>I officially give up. (At least for now.) 
</p>
</div></div>
  </body>
</html>
