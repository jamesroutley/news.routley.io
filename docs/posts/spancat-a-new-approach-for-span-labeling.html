<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://explosion.ai/blog/spancat/">Original</a>
    <h1>Spancat: a new approach for span labeling</h1>
    
    <div id="readability-page-1" class="page"><div><p>The SpanCategorizer is a spaCy component that answers the NLP community‚Äôs need to
have structured annotation for a wide variety of labeled spans, including long
phrases, non-named entities, or overlapping annotations. In this blog post, we‚Äôre
excited to talk more about <code>spancat</code> and showcase new features to help with your
span labeling needs!</p>
<figure>
<img src="https://explosion.ai/6b1370b86a5f09d7f2c9e9917d038e9f/spancat_intro_hook.gif"/>
</figure>
<p>A large portion of the NLP community treats span labeling as an entity
extraction problem. However, these two are not the same. Entities typically have clear
token boundaries and are comprised of syntactic units like proper nouns. Meanwhile,
spans can be arbitrary, often consisting of noun phrases and sentence
fragments. Occasionally, these spans even overlap! Take this for example:</p>
<center>
<img src="https://explosion.ai/2ec43ea3458813226adef7678bb5122e/spancat_intro_example.svg" width="540"/>
</center>
<figcaption>You might have encountered spans like this
in your work‚Äîlong, fragmented, and nested.
</figcaption>

<p>The <code>FACTOR</code> label covers a large span of tokens that is unusual in
standard NER. Most <code>ner</code> entities are short and distinguishable, but this
example has long and vague ones. Also, tokens such as ‚Äúseptic,‚Äù ‚Äúshock,‚Äù and
‚Äúbacteremia‚Äù belong to more than one span, rendering them incompatible with
spaCy‚Äôs <code>ner</code> component.</p>
<p>The text above is just one of the many examples you‚Äôll find in span labeling. So
during its v3.1 release, <strong>spaCy introduced the
<a href="https://spacy.io/api/spancategorizer" target="_blank" rel="noopener">SpanCategorizer</a>, a new component that
handles arbitrary and overlapping spans.</strong> Unlike the
<a href="https://spacy.io/api/entityrecognizer" target="_blank" rel="noopener">EntityRecognizer</a>, the <code>spancat</code>
component provides more flexibility in how you tackle your entity extraction
problems. It does this by:</p>
<ul>
<li><strong>Explicit control of candidate spans.</strong> Users can define rules on how
<code>spancat</code> obtains likely candidates via suggester functions.  You can bias your
model towards precision or recall through this, customizing it further depending
on your use case.</li>
<li><strong>Access to confidence scores.</strong>  Unlike <code>ner</code>, a <code>spancat</code> model returns
predicted label probabilities over the whole span, giving us more meaningful
confidences to threshold against. You can use this value to filter your
results and tune the performance of your system.</li>
<li><strong>Less edge-sensitivity.</strong> Sequence-based NER models typically predict single
token-based tags that are very sensitive to boundaries. Although effective
for proper nouns and self-contained expressions, it is less useful for other
types of phrases or overlapping spans.</li>
</ul>
<h2 id="spancat-architecture"><a href="#spancat-architecture">How spancat works </a></h2>
<p>From a high-level perspective, we can divide <code>spancat</code> into two parts: the
<strong>suggester</strong> and the <strong>classifier</strong>.  The suggester is a custom function that
extracts possible span candidates from the text and feeds them into the
classifier. These suggester functions can be completely rule-based, depend
on annotations from other components, or use machine learning approaches. </p>
<center>
<img src="https://explosion.ai/b64140af00474135ec6024027341e583/spancat_architecture.svg" width="600/"/>
<figcaption>The Spancat architecture</figcaption>
</center>


<p>The suggested spans go into the classifier, which then predicts the correct
label for every span. By including the context of the whole span, the classifier
can catch informative words deep within it. We can divide the classifier into
three steps: Embedding, Pooling, and Scoring.</p>
<ul>
<li><strong>Embedding</strong>: we obtain the <code>tok2vec</code> representation of the candidate spans so we can work on them numerically.</li>
<li><strong>Pooling</strong>: we reduce the sequences to make the model more robust, then encode the context using a window encoder.</li>
<li><strong>Scoring</strong>: we perform multilabel classification on these pooled spans, thereby returning model predictions and label probabilities.</li>
</ul>
<p>What‚Äôs nice about <code>spancat</code> is that it offers <strong>enough flexibility for you to
customize its architecture.</strong> For example, you can swap out the
<a href="https://spacy.io/api/architectures/#MaxoutWindowEncoder" target="_blank" rel="noopener">MaxOutWindowEncoder</a>
into a
<a href="https://spacy.io/api/architectures#MishWindowEncoder" target="_blank" rel="noopener">MishWindowEncoder</a> by
simply updating the config file! </p>
<h3 id="spancat-nested-ner"><a href="#spancat-nested-ner">Architecture case study on nested NER </a></h3>
<p>We developed a <a href="https://github.com/explosion/projects/tree/v3/experimental/ner_spancat_compare" target="_blank" rel="noopener nofollow noreferrer">spaCy
project</a>
that demonstrates how the architectural differences between <code>ner</code> and <code>spancat</code>
led to vastly different approaches to the same problem. We tackle a common use
case in span labeling‚Äî<strong>nested NER.</strong>  Here, tokens can be part of
<em>multiple spans simultaneously</em>, owing to the hierarchical or multilabel
nature of that dataset. Take this sentence, for example:</p>
<p><img src="https://explosion.ai/ecbc3a16cc0b3a08c3d5594002c9a314/spancat_genia_example.svg"/></p><p>This text came from <a href="http://www.geniaproject.org/genia-corpus" target="_blank" rel="noopener nofollow noreferrer">GENIA</a>, a
corpus of biomedical literature lifted from Medline abstracts. It contains five
labels‚ÄîDNA, RNA, cell line, cell type, and protein. Here, the span
<em>‚ÄúHuman IL4‚Äù</em> is by itself a protein. Additionally, <em>‚ÄúHuman IL4 promoter‚Äù</em> is a DNA
sequence that binds to that specific protein to initiate a process called
transcription. Both spans contain the tokens <em>‚ÄúHuman‚Äù</em> and <em>‚ÄúIL4‚Äù</em>, so we should
assign multiple labels to both, resulting in nested spans.</p>
<p>Suppose we attempt this problem using the
<a href="https://spacy.io/api/entityrecognizer" target="_blank" rel="noopener">EntityRecognizer</a>. In that case, we have
to <strong>train one model for each entity type, and then write a custom component that
combines them altogether into a coherent set.</strong>  This approach adds significant
complexity as the number of models scales with the number of your
labels. It works, but far from ideal:</p>
<center>
<img src="https://explosion.ai/6fdbd367ad0e94fab4ab786735f441d8/spancat_nested_ner.svg" width="360/"/>
</center>
<p>Another option is to lean into the <code>ner</code> paradigm and preprocess the dataset to
remove its nestedness. This approach might involve rethinking our annotations
(perhaps combining the overlapping span types as a new label or eliminating them
altogether) and turning the nested NER problem into a non-nested entity extraction
one. The resulting model won‚Äôt predict nested entities anymore. </p>
<center>
<img src="https://explosion.ai/ca320f7ca9822f0533e6574803c14585/spancat_nested_vanilla.svg" width="360/"/>
</center>
<p>With <code>spancat</code>, we can store all spans in a single <code>Doc</code>, and <strong>train a single
model for all</strong>. In spaCy, we can store these spans inside the <code>Doc.spans</code>
attribute under a specified key. This approach then makes experimentation much
more convenient:</p>
<center>
<img src="https://explosion.ai/3a77ee97fb1c3a95616ca17980278dbb/spancat_nested_spancat.svg" width="360/"/>
</center>
<p>We‚Äôre currently working on a more detailed performance comparison using various
datasets outside the nested NER use case. </p>
<h2 id="new-features"><a href="#new-features">New features </a></h2>
<p>With this blog post, we‚Äôre bringing some nice additions to <code>spancat</code>! üéâ</p>
<h3 id="spancat-debug"><a href="#spancat-debug">Analyze and debug your spancat datasets </a></h3>
<p>From v3.3.1 onwards, spaCy‚Äôs <a href="https://spacy.io/api/cli#debug-data" target="_blank" rel="noopener"><code>debug data</code></a> command fully
supports validation and analysis of your spancat datasets. If you have a
<code>spancat</code> component in your pipeline, you‚Äôll receive insights such as the
size of your spans, potential overlaps between training and evaluation sets, and
more!</p>
<center>
<img src="https://explosion.ai/0f0efd802b15b2a17d35c09bd6c820c7/spancat_debug_data.svg" width="620/"/>
<figcaption>Output of debug data on the NERGrit (IndoNLU) corpus</figcaption>
</center>

<p>In addition, <code>debug data</code> provides further analyses of your dataset. For
example, you can determine how long your spans are or how distinct they are
compared to the rest of the corpus. You can then use this information to refine
your spancat configuration further.<sup id="fnref-1"><a href="#fn-1">1</a></sup></p>
<h3 id="spancat-quickstart"><a href="#spancat-quickstart">Generate a spancat config with sensible defaults </a></h3>
<p>The <a href="https://spacy.io/usage/training#quickstart" target="_blank" rel="noopener">spaCy training quickstart</a> allows you to
generate <code>config.cfg</code> files and lets you choose the individual components for
your pipeline with the recommended settings. We‚Äôve updated the configuration for
<code>spancat</code>, giving you more sensible defaults to improve your training!</p>
<center>
<img src="https://explosion.ai/dcb9495c04f764c757636b3abe7c2e69/spancat_config.svg" width="480/"/>
<figcaption>The spancat configuration as seen in the quickstart</figcaption>
</center>

<h3 id="spancat-displacy"><a href="#spancat-displacy">Visualize overlapping spans </a></h3>
<p>We‚Äôve added support for <code>spancat</code> in our visualization library,
<a href="https://spacy.io/usage/visualizers" target="_blank" rel="noopener">displaCy</a>. If your dataset has overlapping
spans or some hierarchical structure, you can use the new <code>&#34;span&#34;</code>
style to display them.</p>
<pre><span>Using displaCy to visualize overlapping spans</span><code>text <span>=</span> <span>&#34;Welcome to the Bank of China.&#34;</span>
doc <span>=</span> nlp<span>(</span>text<span>)</span>
doc<span>.</span>spans<span>[</span><span>&#34;sc&#34;</span><span>]</span> <span>=</span> <span>[</span>
    Span<span>(</span>doc<span>,</span> <span>3</span><span>,</span> <span>6</span><span>,</span> <span>&#34;ORG&#34;</span><span>)</span><span>,</span>
    Span<span>(</span>doc<span>,</span> <span>5</span><span>,</span> <span>6</span><span>,</span> <span>&#34;GPE&#34;</span><span>)</span>
<span>]</span>
displacy<span>.</span>serve<span>(</span>doc<span>,</span> style<span>=</span><span>&#34;span&#34;</span><span>)</span>
</code></pre>
<p><span>
      <a href="https://explosion.ai/static/4fe38442a199954ccbdff855bc95e774/41889/spancat_displacy_sample.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
        <source srcset="/static/4fe38442a199954ccbdff855bc95e774/d8b2f/spancat_displacy_sample.webp 198w, /static/4fe38442a199954ccbdff855bc95e774/8d48d/spancat_displacy_sample.webp 395w, /static/4fe38442a199954ccbdff855bc95e774/69edf/spancat_displacy_sample.webp 416w" sizes="(max-width: 416px) 100vw, 416px" type="image/webp"/>
        <source srcset="/static/4fe38442a199954ccbdff855bc95e774/920f7/spancat_displacy_sample.png 198w, /static/4fe38442a199954ccbdff855bc95e774/ddeb6/spancat_displacy_sample.png 395w, /static/4fe38442a199954ccbdff855bc95e774/41889/spancat_displacy_sample.png 416w" sizes="(max-width: 416px) 100vw, 416px" type="image/png"/>
        <img src="https://explosion.ai/static/4fe38442a199954ccbdff855bc95e774/41889/spancat_displacy_sample.png" alt="spancat displacy sample" title="spancat displacy sample" loading="lazy"/>
      </picture>
  </a>
    </span></p><p>Similar to other displaCy styles, you‚Äôre free to configure the look and feel of
the span annotations. In this example, we‚Äôve color-coded the spans based on
their type:</p>
<figure>
<span>
      <a href="https://explosion.ai/static/522989340ffbb4ae38eb2fca88d60a0e/479cf/spancat_displacy_custom.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
        <source srcset="/static/522989340ffbb4ae38eb2fca88d60a0e/d8b2f/spancat_displacy_custom.webp 198w, /static/522989340ffbb4ae38eb2fca88d60a0e/8d48d/spancat_displacy_custom.webp 395w, /static/522989340ffbb4ae38eb2fca88d60a0e/199e2/spancat_displacy_custom.webp 790w, /static/522989340ffbb4ae38eb2fca88d60a0e/76841/spancat_displacy_custom.webp 1185w, /static/522989340ffbb4ae38eb2fca88d60a0e/15ae6/spancat_displacy_custom.webp 1580w, /static/522989340ffbb4ae38eb2fca88d60a0e/d598e/spancat_displacy_custom.webp 1683w" sizes="(max-width: 790px) 100vw, 790px" type="image/webp"/>
        <source srcset="/static/522989340ffbb4ae38eb2fca88d60a0e/920f7/spancat_displacy_custom.png 198w, /static/522989340ffbb4ae38eb2fca88d60a0e/ddeb6/spancat_displacy_custom.png 395w, /static/522989340ffbb4ae38eb2fca88d60a0e/75051/spancat_displacy_custom.png 790w, /static/522989340ffbb4ae38eb2fca88d60a0e/3517e/spancat_displacy_custom.png 1185w, /static/522989340ffbb4ae38eb2fca88d60a0e/8bb55/spancat_displacy_custom.png 1580w, /static/522989340ffbb4ae38eb2fca88d60a0e/479cf/spancat_displacy_custom.png 1683w" sizes="(max-width: 790px) 100vw, 790px" type="image/png"/>
        <img src="https://explosion.ai/static/522989340ffbb4ae38eb2fca88d60a0e/75051/spancat_displacy_custom.png" alt="spancat displacy custom" title="spancat displacy custom" loading="lazy"/>
      </picture>
  </a>
    </span>
</figure>
<h3 id="span-suggesters"><a href="#span-suggesters">New array of span suggester functions </a></h3>
<p>We‚Äôve also added three new rule-based suggester functions in the 0.5.0 release
of our <a href="https://spacy.io/universe/project/spacy-experimental" target="_blank" rel="noopener">spacy-experimental</a>
repository that depend on annotations from other components.</p>
<p>The <code>subtree-suggester</code> uses dependency annotation to suggest <a href="https://spacy.io/api/token#subtree" target="_blank" rel="noopener">tokens with
their syntactic descendants</a>.</p>
<center>
<img src="https://explosion.ai/c0fc2a92ba4b1fd47a6ebc8428a31ea6/spancat_subtree_suggester.svg" width="360/"/>
</center>
<p>The <code>chunk-suggester</code>  suggests noun chunks using the noun chunk iterator,
which requires POS and dependency annotation.</p>
<center>
<img src="https://explosion.ai/9caea2010cbd0de8816e20a31e103c7b/spancat_chunk_suggester.svg" width="360/"/>
</center>
<p>The <code>sentence-suggester</code> uses sentence boundaries to suggest sentence spans as
candidates.</p>
<center>
<img src="https://explosion.ai/5b93694549168bcf2c2b1b42b03aa4c8/spancat_sentence_suggester.svg" width="360/"/>
</center>
<p>These suggesters also come with the functionality to suggest n-grams spans in
addition. Try them out in this <a href="https://github.com/explosion/spacy-experimental/tree/master/projects/span_suggesters" target="_blank" rel="noopener nofollow noreferrer">spaCy project</a>
that showcases how to include them in your pipeline!</p>
<h3 id="span-finder"><a href="#span-finder">Learn span boundaries using SpanFinder </a></h3>
<p>The <a href="https://github.com/explosion/spacy-experimental/tree/master/spacy_experimental/span_finder" target="_blank" rel="noopener nofollow noreferrer">SpanFinder</a> is a new experimental component that identifies span
boundaries by tagging potential start and end tokens. It‚Äôs an ML approach to
suggest fewer but more precise span candidates than the
<a href="https://spacy.io/api/spancategorizer#ngram_suggester" target="_blank" rel="noopener">ngram suggester</a>.</p>
<p><img src="https://explosion.ai/60ac99bab10863cabe37f949515a52cc/spancat_spanfinder.svg"/></p><p>When using the ngram suggester, the number of suggested candidates can get high,
slowing down <code>spancat</code> training and increasing its memory usage. We designed the
SpanFinder to produce fewer candidates to solve these problems. In practice,
it makes sense to experiment with different suggester functions to determine
what works best for your specific use-case.</p>
<p>We‚Äôve prepared a <a href="https://github.com/explosion/spacy-experimental/tree/master/projects/span_finder" target="_blank" rel="noopener nofollow noreferrer">spaCy project</a>
that showcases how to use the SpanFinder and how it compares to the <code>ngram</code>
suggester on the GENIA dataset:</p>
<figure><h3>Comparison between n-gram and SpanFinder suggesters on GENIA</h3>


















































<table><thead><tr><th><strong>Metric</strong></th><th><strong>SpanFinder</strong></th><th><strong>n-gram (1-10)</strong></th></tr></thead><tbody><tr><td>F-score</td><td>0.7122</td><td>0.7201</td></tr><tr><td>Precision</td><td>0.7672</td><td>0.7595</td></tr><tr><td>Recall</td><td>0.6646</td><td>0.6847</td></tr><tr><td>Suggested candidates</td><td>13,754</td><td>486,903</td></tr><tr><td>Actual entities</td><td>5,474</td><td>5,474</td></tr><tr><td>% Ratio</td><td>251%</td><td>8894%</td></tr><tr><td>% Coverage</td><td>75.61%</td><td>99.53%</td></tr><tr><td>Speed (tokens/sec)</td><td>10,465</td><td>4,807</td></tr></tbody></table>
</figure>
<h2 id="final-thoughts"><a href="#final-thoughts">Final thoughts </a></h2>
<p>As we encounter several NLP use cases from the community, we recognize that
entity extraction is limited in solving the majority of span labeling problems.
Spancat is our answer to this challenge. You now have more tools to analyze,
train, and visualize your spans with these new features. You can use this as an
<a href="https://prodi.gy/docs/span-categorization#ner-vs-spancat" target="_blank" rel="noopener">alternative to NER</a>
or as an additional component in your existing pipeline.</p>
<p>You can find out more about span categorization in the <a href="https://spacy.io/api/spancategorizer" target="_blank" rel="noopener">spaCy
docs</a>, and be sure to check out our
experimental suggesters and example projects. We also appreciate community
feedback, so we hope to see you in our <a href="https://github.com/explosion/spaCy/discussions" target="_blank" rel="noopener nofollow noreferrer">discussions
forum</a> soon!</p>
</div></div>
  </body>
</html>
