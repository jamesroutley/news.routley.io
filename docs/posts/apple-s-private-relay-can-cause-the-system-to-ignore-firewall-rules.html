<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mullvad.net/en/blog/2022/4/25/apples-private-relay-can-cause-the-system-to-ignore-firewall-rules/">Original</a>
    <h1>Apple’s Private Relay can cause the system to ignore firewall rules</h1>
    
    <div id="readability-page-1" class="page"><div>
        <p><a href="https://support.apple.com/en-us/HT212614">Apple’s Private Relay</a> (Beta) feature calls home to Apple servers without respecting the firewall rules of the system, creating a leak that neither we, nor you, can stop without <a href="https://support.apple.com/en-us/HT212614#website-not-working">disabling the entire Private Relay feature</a>.</p>

<p>The Private Relay functionality is almost like a VPN tunnel, or somewhat similar to how Tor works. It routes your network traffic in encrypted form via relay servers before it reaches the internet. The feature is still in beta and only available in certain regions, and you need a paid iCloud+ subscription to enable it.</p>

<p>When we at Mullvad monitored our network connections while doing development on our app, we saw something that should not be there: QUIC traffic leaving the computer outside the VPN tunnel! This is a leak! We tracked the sending down to the Private Relay feature, and disabling the Private Relay made the leaks stop. We do not know for sure that the traffic belongs to Private Relay, but it sure does trigger it.</p>

<p>It is worth noting that Private Relay (mostly) disables itself as soon as any firewall rule is added to <a href="https://en.wikipedia.org/wiki/PF_(firewall)">PF</a> (the system firewall on macOS devices). The Mullvad VPN app does add firewall rules. Once you connect the Mullvad app, Private Relay announces that it has disabled itself. We see no correlation between user traffic and the leaking packets. We believe they are just some heartbeat signal calling home to Apple. We do not know what information is transmitted to Apple, but since the destination is Apple servers, it is a strong signal to your local network and ISP that you might be a macOS user.</p>

<h2>How to reproduce the leak</h2>

<p>If you have an iCloud+ subscription you can easily test this yourself. Follow these steps and observe Private Relay not respecting your firewall rules:</p>

<ol>
	<li>Set up monitoring of all QUIC traffic via <code>sudo tcpdump udp port 443</code>.</li>
	<li><a href="https://support.apple.com/en-us/HT212614#on">Enable private relay</a> and verify that it works (It should show a notification saying “Private Relay is Active”). The Mullvad VPN app will prevent it from working if it connects during boot. If the private relay is unavailable, remove our app or any other offending VPN client, reboot, and start again.</li>
	<li>Confirm that QUIC traffic can be observed. Before applying the firewall rule, you should also be able to see traffic in <code>tcpdump</code> if you just send some bytes over <code>nc -u apple.com 443</code></li>
	<li>Append a PF rule to block QUIC traffic in <code>/etc/pf.conf</code>, reload the rules and enable the firewall.
	<ol>
		<li>Append <code>block return out quick proto udp from any to any port 443</code> to <code>/etc/pf.conf</code></li>
		<li>Reload rules via <code>sudo pfctl -f /etc/pf.conf</code>.</li>
		<li>Flush any firewall state via <code>sudo pfctl -F states</code></li>
		<li>Enable PF via <code>sudo pfctl -e</code>.</li>
		<li>Verify that you can no longer send traffic over <code>nc -u apple.com 443</code></li>
	</ol>
	</li>
	<li>Now, you may verify that a trickle of QUIC traffic still flows out from your computer as per the output of <code>tcpdump</code>, yet you would not be able to make new QUIC connections over UDP to hosts on port 443. This means that Private Relay does not play by the same rules as <code>nc</code>.</li>
</ol>

<p>It is also worth noting that these QUIC leaks happen on the physical network interface even if you connect a VPN and set up the routing table to route everything through the VPN interface. So it is not only circumventing the firewall rules, it is also not respecting the routing table.</p>

<p>To restore your computer and the firewall again, just remove the rule from <code>/etc/pf.conf</code> and run <code>sudo pfctl -f /etc/pf.conf</code> again.</p>

<h2>What to do now?</h2>

<p>We are not aware of any way to prevent Private Relay from leaking this traffic, other than disabling the feature altogether. This is done in the same place where it is turned on. See <a href="https://support.apple.com/en-us/HT212614#website-not-working">Apple’s instructions</a>.</p>

<p>It is hard to speculate about the severity of this leak since the traffic is encrypted, meaning we cannot really know what it contains. This does however signal to your local network and ISP that you are using a macOS device. If your threat model forbids this, you should disable the Private Relay.</p>
        </div></div>
  </body>
</html>
