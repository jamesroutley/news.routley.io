<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://pytorch.org/blog/compromised-nightly-dependency/">Original</a>
    <h1>Compromised PyTorch-nightly dependency chain December 30th, 2022</h1>
    
    <div id="readability-page-1" class="page"><div>
        <div>
            <div>
                <p><img src="https://pytorch.org/assets/images/logo-icon.svg"/></p><article>
                    
                    <p>If you installed PyTorch-nightly on Linux via pip between December 25, 2022 and December 30, 2022, please uninstall it and torchtriton immediately, and use the latest nightly binaries (newer than Dec 30th 2022).</p>

<div><div><pre><code><span>$ </span>pip3 uninstall <span>-y</span> torch torchvision torchaudio torchtriton
<span>$ </span>pip3 cache purge
</code></pre></div></div>

<p>PyTorch-nightly Linux packages installed via pip during that time installed a dependency, torchtriton, which was compromised on the Python Package Index (PyPI) code repository and ran a malicious binary. This is what is known as a supply chain attack and directly affects dependencies for packages that are hosted on public package indices.</p>

<p><strong>NOTE:</strong> Users of the PyTorch <strong>stable</strong> packages <strong>are not</strong> affected by this issue.</p>

<h2 id="how-to-check-if-your-python-environment-is-affected">How to check if your Python environment is affected</h2>

<p>The following command searches for the malicious binary in the torchtriton package (<code>PYTHON_SITE_PACKAGES/triton/runtime/triton</code>) and prints out whether your current Python environment is affected or not.</p>

<div><div><pre><code>python3 <span>-c</span> <span>&#34;import pathlib;import importlib.util;s=importlib.util.find_spec(&#39;triton&#39;); affected=any(x.name == &#39;triton&#39; for x in (pathlib.Path(s.submodule_search_locations[0] if s is not None else &#39;/&#39; ) / &#39;runtime&#39;).glob(&#39;*&#39;));print(&#39;You are {}affected&#39;.format(&#39;&#39; if affected else &#39;not &#39;))&#34;</span>
</code></pre></div></div>

<p>The malicious binary is executed when the triton package is imported, which requires explicit code to do and is not PyTorch’s default behavior.</p>

<h2 id="the-background">The Background</h2>

<p>At around 4:40pm GMT on December 30 (Friday), we learned about a malicious dependency package (<code>torchtriton</code>) that was uploaded to the Python Package Index (PyPI) code repository with the same package name as the one we ship on the <a href="https://download.pytorch.org/whl/nightly">PyTorch nightly package index</a>. Since the <a href="https://github.com/pypa/pip/issues/8606">PyPI index takes precedence</a>, this malicious package was being installed instead of the version from our official repository. This design enables somebody to register a package by the same name as one that exists in a third party index, and pip will install their version by default.</p>

<p>This malicious package has the same name <code>torchtriton</code> but added in code that uploads sensitive data from the machine.</p>

<h2 id="what-we-know">What we know</h2>

<p>torchtriton on PyPI contains a malicious triton binary which is installed at <code>PYTHON_SITE_PACKAGES/triton/runtime/triton</code>. Its SHA256 hash is listed below.</p>

<p><code>SHA256(triton)= 2385b29489cd9e35f92c072780f903ae2e517ed422eae67246ae50a5cc738a0e</code></p>

<p>The binary’s main function does the following:</p>

<ul>
  <li>Get system information
    <ul>
      <li>nameservers from <code>/etc/resolv.conf</code></li>
      <li>hostname from <code>gethostname()</code></li>
      <li>current username from <code>getlogin()</code></li>
      <li>current working directory name from <code>getcwd()</code></li>
      <li>environment variables</li>
    </ul>
  </li>
  <li>Read the following files
    <ul>
      <li><code>/etc/hosts</code></li>
      <li><code>/etc/passwd</code></li>
      <li>The first 1,000 files in <code>$HOME/*</code></li>
      <li><code>$HOME/.gitconfig</code></li>
      <li><code>$HOME/.ssh/*</code></li>
    </ul>
  </li>
  <li>Upload all of this information, including file contents, via encrypted DNS queries to the domain *.h4ck[.]cfd, using the DNS server wheezy[.]io</li>
</ul>

<p>The binary’s file upload functionality is limited to files less than 99,999 bytes in size. It also uploads only the first 1,000 files in $HOME (but all files &lt; 99,999 bytes in the .ssh directory).</p>

<h2 id="steps-taken-towards-mitigation">Steps taken towards mitigation</h2>

<ul>
  <li>torchtriton has been removed as a dependency for our nightly packages and replaced with pytorch-triton (<a href="https://github.com/pytorch/pytorch/pull/91539">pytorch/pytorch#91539</a>) and a dummy package registered on PyPI (so that this issue doesn’t repeat)</li>
  <li>All nightly packages that depend on torchtriton have been removed from our package indices at https://download.pytorch.org until further notice</li>
  <li>We have reached out to the PyPI security team to get proper ownership of the <code>torchtriton</code> package on PyPI and to delete the malicious version</li>
</ul>


                </article>
            </div>
        </div>
    </div></div>
  </body>
</html>
