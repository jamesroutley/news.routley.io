<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.photoroom.com/tech/core-ml-performance-2022/">Original</a>
    <h1>CoreML Benchmark for the iPhone 14 Pro</h1>
    
    <div id="readability-page-1" class="page"><div>
            <h2>Core ML performance benchmark, 2022 edition</h2>
            <p><time datetime="2022-09-16T11:54:18+06:00">September 16, 2022</time>
        </p></div><div>
            <div>

                <p>Today is new-iPhone day! At PhotoRoom, this means today is CoreML-benchmark day.
Every year we cannot wait to discover what the improved computing power of the new hardware means for on-device machine learning.</p>
<p>CoreML allows iOS developers to ship and execute machine learning models, allowing us to build complex interactive experiences and building an image editor that allows users to think about objects, not pixels. In recent years, the possibility to run our models on the Apple Neural Engine (ANE) has dramatically sped up CoreML.</p>
<p>This year, we decided to spice things up a bit by analyzing performances not only across iPhone models but also across iOS versions.</p>
<figure>
    <img src="https://www.photoroom.com/tech/core-ml-performance-2022/iseg.gif" alt="Guided Cutout"/>
    <figcaption>Guided cutout edition inside the PhotoRoom app. On-device machine learning provides a sense of immediacy and dramatically shortens the feedback loop; it allows for a more intuitive user experience.</figcaption>
</figure>

<h2 id="setup">Setup</h2>
<p>This year we ran a benchmark analyzing the performance of our guided cutout pipeline illustrated above.</p>
<p>We ran this benchmark on the following devices across several OSes:</p>
<ul>
<li>iPhone 12 Pro <em>A14 Bionic</em> (iOS 15 + iOS 16)</li>
<li>iPhone 13 Pro <em>A15 Bionic</em> (iOS 15 + iOS 16)</li>
<li>iPhone 14 Pro <em>A16 Bionic</em> (iOS 16)</li>
<li>iPad Pro 2021 <em>M1</em> (iOS 15 + iOS 16)</li>
<li>MacBook Pro 2021 <em>M1 Pro</em> (macOS 12)</li>
</ul>
<hr/>
<figure>
    <img src="https://www.photoroom.com/tech/core-ml-performance-2022/setup.jpg" alt="Our testing setup"/>
    <figcaption>We ran a benchmark of our guided cutout CoreML process on the most recent Apple Pro devices, across OS versions.</figcaption>
</figure>

<p>For each device, we gathered the average execution time (excluding model-loading time) depending on the CoreML compute units configuration (<code>MLComputeUnits</code>):</p>
<ul>
<li><code>cpuOnly</code> (the model exclusively runs on the CPU)</li>
<li><code>cpuAndGPU</code> (the model runs on the GPU as much as possible, and defaults to the CPU when a layer cannot run on the GPU)</li>
<li><code>cpuAndNeuralEngine</code> (iOS 16 only, the model runs on the ANE as much as possible, and defaults to the CPU when a layer cannot run on the ANE)</li>
<li><code>all</code> (the model runs on the ANE, GPU or CPU depending on each unit’s ability)</li>
</ul>
<p>Each device, OS version and compute unit configuration was measured 40 times and averaged, with some cooldown time in between to avoid the effects of thermal throttling on the SoC.</p>
<h2 id="results--analysis">Results / Analysis</h2>
<figure>
    <img src="https://www.photoroom.com/tech/core-ml-performance-2022/results.png" alt="Results"/>
    <figcaption>The results of our benchmarking tests.</figcaption>
</figure>

<p>The results above reveal a few interesting takeaways:</p>
<ul>
<li>The consistent speed increase going from CPU to GPU to ANE showcases that most of our model is able to run on both the GPU and the ANE</li>
<li>That being said, the (nearly) consistent increase in inference time when going (on iOS 16) from <code>all</code> to <code>cpuAndNeuralEngine</code> showcases that a few number of layers in our model are not able to run on the ANE, but instead default to the GPU.</li>
<li>The OS version seems to have a negligible impact on overall performance. Do not expect a speed bump by upgrading your OS.</li>
<li>Across the A-series chips (A14 Bionic - A15 Bionic - A16 Bionic) we can see a slow and steady improvement in performances in all configurations. In fact, Apple touted 17 TFlops in its new A16 Bionic chip, up 7.5% from the 15.8 TFlops of the A15 Bionic, which is consistent with the <code>all</code> configuration going from 45ms to 41ms in between the iPhone 13 Pro and the iPhone 14 Pro.</li>
<li>Despite being based on the A14 cores, the M1 chip of the iPad pro is neck and neck on CPU and ANE compared to the new A16 Bionic, and blows it away on the GPU. Of course, this can be explained by both the M1 chip having more GPU cores than the A16 Bionic, and possibly the iPad Pro having a much larger thermal envelope.</li>
<li>Interestingly, the M1 Pro chip in the MacBook Pro does not fare much better than the M1 chip in the iPad Pro, and even performs significantly worse in the ANE. We would love to hear a compelling explanation as to why this is the case.</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<figure>
    <img src="https://www.photoroom.com/tech/core-ml-performance-2022/live-seg.gif" alt="An example of live segmentation"/>
    <figcaption>An example of the use-case that faster inference time can unlock: high-quality live segmentation on a video feed with wide outlines post-processing. See how the devices on the right are able to process the video stream much more fluidly than the ones on the far left.</figcaption>
</figure>

<p>So far, Apple is unparalleled as far as giving mobile developers tools for on-device machine learning goes. While today’s new hardware release is not a ground-breaking innovation, it is the latest data-point in a series of consistent improvements year-over-year. At 41ms per inference on the new iPhone 14 Pro, we are finally over the 24 FPS mark, the standard framerate of cinema (for high-quality, user-guided segmentation!). But if you are looking for the best performance available on models unable to run on the ANE, the latest M1 iPad Pro is still your most trusted ally.</p>

            </div>
        </div></div>
  </body>
</html>
