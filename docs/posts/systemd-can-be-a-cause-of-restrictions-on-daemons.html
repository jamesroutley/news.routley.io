<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/SystemdCanBeRestrictionCause">Original</a>
    <h1>Systemd can be a cause of restrictions on daemons</h1>
    
    <div id="readability-page-1" class="page"><div><h2>These days, systemd can be a cause of restrictions on daemons</h2>

	<p><small>September 19, 2025</small></p>
</div><div><p>One of the traditional rites of passage for Linux system administrators
is having a daemon not work in the normal system configuration (eg,
when you boot the system) but work when you manually run it as root.
The classical cause of this on Unix was that $PATH wasn&#39;t fully set
in the environment the daemon was running in but was in your root
shell. On Linux, another traditional cause of this sort of thing
has been <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/SELinuxGotcha">SELinux</a> and a more modern source (on
Ubuntu) has sometimes been AppArmor. All of these create hard to
see differences between your root shell (where the daemon works
when run by hand) and the normal system environment (where the
daemon doesn&#39;t work). These days, we can add another cause, an
increasingly common one, and that is <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/SystemdShouldLearnRestrictions">systemd service unit
restrictions</a>, many of which are
covered in <a href="https://www.freedesktop.org/software/systemd/man/latest/systemd.exec.html">systemd.exec</a>.</p>

<p>(One pernicious aspect of systemd as a cause of these restrictions is
that they can appear in new releases of the same distribution. If a
daemon has been running happily in an older release and now has surprise
issues in a new Ubuntu LTS, I don&#39;t always remember to look at its
.service file.)</p>

<p>Some of systemd&#39;s protective directives simply cause failures to
do things, like access user home directories if <a href="https://www.freedesktop.org/software/systemd/man/latest/systemd.exec.html#ProtectHome=">ProtectHome=</a>
is set to something appropriate. Hopefully your daemon complains
loudly here, reporting mysterious &#39;permission denied&#39; or &#39;file not
found&#39; errors. Some systemd settings can have additional, confusing
effects, like <a href="https://www.freedesktop.org/software/systemd/man/latest/systemd.exec.html#PrivateTmp=">PrivateTmp=</a>.
A standard thing I do when troubleshooting a chain of programs
executing programs executing programs is to shim in diagnostics
that dump information to /tmp, but with PrivateTmp= on, my debugging
dump files are mysteriously not there in the system-wide /tmp.</p>

<p>(On the other hand, a daemon may not complain about missing files
if it&#39;s expected that the files aren&#39;t always there. A mailer
usually can&#39;t really tell the difference between &#39;no one has .forward
files&#39; and &#39;I&#39;m mysteriously not able to see people&#39;s home
directories to find .forward files in them&#39;.)</p>

<p>Sometimes you don&#39;t get explicit errors, just mysterious failures
to do some things. For example, <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/SystemdPortFirewallWish">you might set IP address access
restrictions with the intention of blocking inbound connections but
wind up also blocking DNS queries</a> (and
this will also depend on whether or not you use systemd-resolved).
The good news is that you&#39;re mostly not going to find standard
systemd .service files for normal daemons shipped by your Linux
distribution with IP address restrictions. The bad news is that at
some point .service files may start showing up that impose IP address
restrictions with the assumption that DNS resolution is being done
via systemd-resolved as opposed to direct DNS queries.</p>

<p>(I expect some Linux distributions to resist this, for example
Debian, but others may declare that using systemd-resolved is now
mandatory in order to simplify things and let them harden service
configurations.)</p>

<p>Right now, you can usually test if this is the problem by creating
a version of the daemon&#39;s .service file with any systemd restrictions
stripped out of it and then seeing if using that version makes life
happy. In the future it&#39;s possible that some daemons will assume
and require some systemd restrictions (for instance, assuming that
they have a /tmp all of their own), making things harder to test.</p>
</div></div>
  </body>
</html>
