<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://jonasdn.blogspot.com/2020/10/proposal-to-add-build-graph-output-to.html">Original</a>
    <h1>Proposal to add build graph output to GNU Make (2020)</h1>
    
    <div id="readability-page-1" class="page"><div id="post-body-3262744680248272562" itemprop="description articleBody">
<h4>Background</h4><p>In 2015 I worked as a consultant at a large company in Lund. My position was with the <i>build</i> team and one of our responsibilities was managing and maintaining the build system for their Android based phones.</p><p>The problem I was tasked with solving was the fact that running &#39;make&#39; for a product after a successful build resulted in a lot of stuff being rebuilt unnecessarily.</p><p>A stock Android build tree behaved nicely: a second run of &#39;make&#39; only produced a line about everything being up-to-date. But the company products were taking a good 15 minutes for a rebuild even if nothing had been changed.</p><p>The Android build system works by including all recipes to be built (programs / libraries / etc) using the GNU Make include directive, so that you end up with one giant Makefile that holds all rules for building the platform. Possibly to avoid the problems laid out in the paper <i><a href="https://embeddedartistry.com/blog/2017/04/10/recursive-make-considered-harmful/">Recursive make considered harmful</a>.</i></p><p>As you can imagine this results in quite a large Makefile that is near impossible to debug. To help us out GNU Make has an option that helps you figure out what is going on with every decision it makes:</p><blockquote>-p, --print-data-base       Print make&#39;s internal database.</blockquote><p>This is very powerful and lets you investigate a lot about what Make is doing. It may be a bit too powerful though. It is a lot of information to digest. You can see example output from when I run it against the project from my last <a href="https://jonasdn.blogspot.com/2020/08/getting-to-know-risc-v-through-hifive1.html">blog  post</a>, <i>riscv-asm-hello-morse </i>in a gist <a href="https://gist.github.com/jonasdn/0602fbd1ea63311ec40aad6d2a7269b3">here.</a></p><p>The bugs we found and the fixes we implemented were mostly about targets depending on non-existing files or depending on <a href="https://www.gnu.org/software/make/manual/html_node/Phony-Targets.html">phony targets.</a> The fixes were almost never the hard part, it was finding the bugs that was hard.</p><p>Lately I have been working a bit with the <a href="https://www.yoctoproject.org/docs/2.1/yocto-project-qs/yocto-project-qs.html">Yocto build system</a> which uses <i>Bitbake </i>to build recipes. And Bitbake has a <i>-g</i> option to generate a dependency graph that lets you figure out why something was built.</p><p>I wondered if something similar could be made useful for GNU Make. So I attempted to implement it as:</p><blockquote><p>  -g, --output-graph          Output (dot) graph of modified targets for each goal.</p></blockquote><p>Here I might need to pause to inject that I am not the first person to have this idea:</p><ul><li><b>In 2009</b> an anonymous user suggested XML output for Make&#39;s dependency graph: <a href="https://savannah.gnu.org/bugs/?func=detailitem&amp;item_id=25751">https://savannah.gnu.org/bugs/index.php?25751</a></li><li><b>In 2016</b> user Yuri proposed something similar: <a href="https://savannah.gnu.org/bugs/?func=detailitem&amp;item_id=47308">https://savannah.gnu.org/bugs/index.php?47308</a></li><li><b>In 2019 </b>user<b> </b>Shlomi Fish brought it up again: <span><u><a href="https://savannah.gnu.org/bugs/index.php?56204">https://savannah.gnu.org/bugs/index.php?56204</a></u></span></li></ul><p>In my defense my approach is a bit different. I only want to include targets that have been updated from <a href="https://www.gnu.org/software/make/manual/html_node/Goals.html">Make goals </a>that have changed, which will trim the graph quite a bit. It is not an attempt to show the information from <i>--print-database</i> in a new way.</p><h4>Example 1</h4><p>If I use my proposal to generate a graph from the riscv project mentioned above:</p><blockquote><p>$ make -g</p><div><p>riscv64-unknown-elf-as -march=rv32imac -mabi=ilp32 -g -o0  -c -o hello-morse.o hello-morse.S</p><p>riscv64-unknown-elf-as -march=rv32imac -mabi=ilp32 -g -o0  -c -o wait.o wait.S</p><p>riscv64-unknown-elf-as -march=rv32imac -mabi=ilp32 -g -o0  -c -o led.o led.S</p><p>riscv64-unknown-elf-as -march=rv32imac -mabi=ilp32 -g -o0  -c -o morse.o morse.S</p><p>riscv64-unknown-elf-ld hello-morse.o wait.o led.o morse.o -m elf32lriscv -nostartfiles -nostdlib -Thello-morse.lds -o hello-morse.elf</p><p>riscv64-unknown-elf-objcopy -O ihex hello-morse.elf hello-morse.hex</p><p><b>make: Writing dependency graph to &#39;/home/jonas/sandbox/riscv/riscv-asm-hello-morse/all.dot&#39;</b></p></div></blockquote><div><p>The last line here (my bold) is new and added by my patch. If we now look at the graph generated by this build.</p></div><blockquote></blockquote><blockquote><blockquote><p>$ cat all.dot</p><p>strict digraph &#34;all&#34; {</p><p>  &#34;hello-morse.elf&#34; -&gt; &#34;hello-morse.o&#34; </p><p>  &#34;hello-morse.elf&#34; -&gt; &#34;wait.o&#34; </p><p>  &#34;hello-morse.elf&#34; -&gt; &#34;led.o&#34; </p><p>  &#34;hello-morse.elf&#34; -&gt; &#34;morse.o&#34; </p><p>  &#34;hello-morse.hex&#34; -&gt; &#34;hello-morse.elf&#34; </p><p>  &#34;all&#34; -&gt; &#34;hello-morse.hex&#34; </p><p>  &#34;all&#34;</p><p>}</p></blockquote></blockquote><blockquote></blockquote><p>And we can generate a PNG from it:</p><blockquote>$ dot -Tpng all.dot -o all.png</blockquote><p><a href="https://1.bp.blogspot.com/-Xmzky05NlVs/X5FLzAmQI0I/AAAAAAAAqko/Hs9jIqXc3RYRJPs3pbt7KHldCoyLOtgngCLcBGAsYHQ/s598/all.png"><img data-original-height="347" data-original-width="598" src="https://1.bp.blogspot.com/-Xmzky05NlVs/X5FLzAmQI0I/AAAAAAAAqko/Hs9jIqXc3RYRJPs3pbt7KHldCoyLOtgngCLcBGAsYHQ/s320/all.png" width="320"/></a></p></div></div>
  </body>
</html>
