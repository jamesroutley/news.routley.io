<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.kowalczyk.info/article/4/how-i-ported-pigz-from-unix-to-windows.html">Original</a>
    <h1>I ported pigz from Unix to Windows</h1>
    
    <div id="readability-page-1" class="page"><div id="post">
        <div id="4">


<p>Pigz was clearly written with Unix in mind, with no thought given to cross-platform portability.</p>

<p>Thankfully, it’s a relatively simple, command-line program that sticks to using standard C library.</p>

<h2 id="porting-pthreads"><p>Porting pthreads</p><a href="#porting-pthreads">

</a>
</h2>

<p>Pigz uses pthreads for threading. Porting pthreads code to Windows would be a nightmare. Lucky me: someone already did all the hard work and <a target="_blank" href="https://github.com/GerHobbelt/pthread-win32">implemented pthreads APIs</a> on top of Windows API, in only 20.000 lines of code. It seems to Just Work.</p>

<h2 id="porting-dirent"><p>Porting dirent</p><a href="#porting-dirent">

</a>
</h2>

<p>Another Unix-only API that pigz uses is <a target="_blank" href="http://pubs.opengroup.org/onlinepubs/007908799/xsh/dirent.h.html">dirent.h</a>, for reading the content of directories. I was lucky again: someone created a <a target="_blank" href="http://www.two-sdg.demon.co.uk/curbralan/code/dirent/dirent.html">Windows port of dirent APIs</a>.</p>

<h2 id="misc-fixes"><p>Misc fixes</p><a href="#misc-fixes">

</a>
</h2>

<p>There are few functions that pigz uses that are present in Visual Studio’s C library, but under a different name (e.g. <code>stat</code> is <code>_stat</code>, <code>fstat</code> is <code>_fstat</code> etc.). This is easily fixed with a <code>#define</code>.</p>

<p>Visual C doesn’t define <code>ssize_t</code> and <code>PATH_MAX</code>. A <code>typedef</code> here, a <code>#define</code> there solves those problems.</p>

<p>I consolidated all such fixes in a single <a target="_blank" href="https://github.com/kjk/pigz/blob/master/win32/wincompat.h">wincompat.h</a> file.</p>

<p>Pigz <code>#include</code>s some .h files that are only available under Unix. I used <code>#ifndef _WIN32</code> around those.</p>

<h2 id="build-system"><p>Build system</p><a href="#build-system">

</a>
</h2>

<p>Pigz uses standard Unix build tools: gcc and make.</p>

<p>While there are ports of GNU make to Windows and gcc-based compilers that can generate windows binaries (mingw), most Windows developers prefer using Visual Studio IDE.</p>

<p>Creating Visual Studio project files from scratch is time consuming and annoying, especially when you want to support multiple versions of Visual Studio.</p>

<p><a target="_blank" href="https://premake.github.io/">Premake</a> makes it easier. It’s a meta-build system: you write a <a target="_blank" href="https://github.com/kjk/pigz/blob/master/premake4.lua">text file</a> that defines the project, which files to compile, compilation flags etc. and premake generates Visual Studio files from that description.</p>

<p>Premake supports latest Visual Studio  2018 and 2022 project files via conversion).</p>

<h2 id="conclusion"><p>Conclusion</p><a href="#conclusion">

</a>
</h2>

<p>As far as porting goes, this one was easy thanks to existing efforts that created compatibility shims for the hard parts.</p>

<p>Premake is an interesting tool that allows to save time creating and maintaining Visual Studio projects.</p>

</div>

    </div></div>
  </body>
</html>
