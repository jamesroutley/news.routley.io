<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://macwright.com/2025/12/09/theme-selector.html">Original</a>
    <h1>Theme selector</h1>
    
    <div id="readability-page-1" class="page"><div><article><div><p>Two weeks ago I <a href="https://bsky.app/profile/macwright.com/post/3m6dkd2r57k2k">added dark mode</a> to this website. It was late one night and I was revisiting an article and my eyes were tired, so that was that. It was based solely on system dark mode settings, and I started using some more nice, modern CSS features like <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Reference/Values/color_value/light-dark">light-dark()</a> to tie it all together.</p><p><picture><source srcset="/images/2025-12-09-theme-selector-website-dark-mode-screenshot.webp" type="image/webp"/><img alt="Website dark mode screenshot" height="1149" src="https://macwright.com/images/2025-12-09-theme-selector-website-dark-mode-screenshot.jpg" width="1280"/></picture></p><p>But some people want dark mode for their desktop and light mode for their websites or the opposite, and sometimes I’m like that too. So I wanted to do it.</p><p>But I want this website to be peculiar. Like: I <a href="https://macwright.com/2016/05/03/the-featherweight-website">obsessively optimize it</a> and intentionally use zero JavaScript on a basic pageload, though YouTube and Bandcamp embeds often bring in some junk. But even then, I optimize my YouTube embeds with <a href="https://github.com/paulirish/lite-youtube-embed">lite-youtube-embed</a>.</p><p>So: I wanted theme switching, but zero JavaScript involved in setting it or reading it. Here’s what I’m currently deploying:</p><h2 id="form">Form</h2><p>The UI is a form: you can see it in the top right corner, those three circles. I don’t <em>love</em> that position and might tinker with it. But it’s just a form, or three of them: zero JavaScript, just buttons. Browsers are great at forms. We’re posting to <code>/mode.css</code>, the same location as the CSS.</p><div><div><pre><code><span>&lt;form</span> <span>class=</span><span>&#39;mode-container&#39;</span> <span>action=</span><span>&#34;/mode.css&#34;</span> <span>method=</span><span>&#34;POST&#34;</span><span>&gt;</span>
  <span>&lt;button</span> <span>type=</span><span>&#34;submit&#34;</span> 
    <span>title=</span><span>&#39;Auto theme&#39;</span>
    <span>class=</span><span>&#39;mode auto&#39;</span> <span>name=</span><span>&#34;scheme&#34;</span> <span>value=</span><span>&#34;auto&#34;</span>
  <span>&gt;</span>Auto<span>&lt;/button&gt;</span>
  <span>&lt;button</span> <span>type=</span><span>&#34;submit&#34;</span> <span>name=</span><span>&#34;scheme&#34;</span> <span>value=</span><span>&#34;light&#34;</span> <span>class=</span><span>&#34;mode light&#34;</span>
    <span>title=</span><span>&#39;Light theme&#39;</span>
    <span>style=</span><span>&#39;background-color: var(--mode-light)&#39;</span>
  <span>&gt;</span>Light<span>&lt;/button&gt;</span>
  <span>&lt;button</span> <span>type=</span><span>&#34;submit&#34;</span> <span>name=</span><span>&#34;scheme&#34;</span> <span>value=</span><span>&#34;dark&#34;</span> <span>class=</span><span>&#39;mode dark&#39;</span>
    <span>title=</span><span>&#39;Dark theme&#39;</span>
    <span>style=</span><span>&#39;background-color: var(--mode-dark)&#39;</span>
  <span>&gt;</span>Dark<span>&lt;/button&gt;</span>
<span>&lt;/form&gt;</span>
</code></pre></div></div><h2 id="function">Function</h2><p>That <code>/mode.css</code> endpoint is powered by a <a href="https://www.netlify.com/">Netlify function</a>, which uses Deno.</p><p>When it’s used as the form action, this receives a POST request, figures out which color scheme someone wants, and sends them back to the page that sent them but with a new cookie set for their browser. It’s all same-domain requests, so your browser sends cookies even with CSS requests, and thankfully it also sends full referrer URLs.</p><p>And then when <code>/mode.css</code> is accessed by a GET request, it reads that cookie and sets a different <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Reference/Properties/color-scheme">color-scheme</a> for the site. If this whole system fails, you just get some non-functional buttons but the rest of the CSS loads fine because it’s all static.</p><div><div><pre><code><span>export</span> <span>default</span> <span>async </span><span>(</span><span>req</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>const</span> <span>headers</span> <span>=</span> <span>{</span>
    <span>&#39;</span><span>Content-Type</span><span>&#39;</span><span>:</span> <span>&#39;</span><span>text/css</span><span>&#39;</span>
  <span>};</span>
  <span>const</span> <span>cacheHeaders</span> <span>=</span> <span>{</span>
    <span>&#39;</span><span>Netlify-Vary</span><span>&#39;</span><span>:</span> <span>&#39;</span><span>cookie=scheme</span><span>&#39;</span><span>,</span>
    <span>&#39;</span><span>Netlify-CDN-Cache-Control</span><span>&#39;</span><span>:</span> <span>&#39;</span><span>public, max-age=3600, stale-while-revalidate=120</span><span>&#39;</span><span>,</span>
    <span>&#39;</span><span>Cache-Control</span><span>&#39;</span><span>:</span> <span>&#39;</span><span>public, max-age=60</span><span>&#39;</span>
  <span>};</span>
  <span>if </span><span>(</span><span>req</span><span>.</span><span>method</span> <span>===</span> <span>&#39;</span><span>GET</span><span>&#39;</span><span>)</span> <span>{</span>
    <span>const</span> <span>cookie</span> <span>=</span> <span>req</span><span>.</span><span>headers</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>Cookie</span><span>&#39;</span><span>);</span>
    <span>if </span><span>(</span><span>cookie</span><span>.</span><span>includes</span><span>(</span><span>&#39;</span><span>colorscheme=light</span><span>&#39;</span><span>))</span> <span>{</span>
      <span>return</span> <span>new</span> <span>Response</span><span>(</span><span>`:root { color-scheme: light; }`</span><span>,</span> <span>{</span> <span>headers</span><span>,</span> <span>...</span><span>cacheHeaders</span> <span>});</span>
    <span>}</span>
    <span>if </span><span>(</span><span>cookie</span><span>.</span><span>includes</span><span>(</span><span>&#39;</span><span>colorscheme=dark</span><span>&#39;</span><span>))</span> <span>{</span>
      <span>return</span> <span>new</span> <span>Response</span><span>(</span><span>`:root { color-scheme: dark; }`</span><span>,</span> <span>{</span> <span>headers</span><span>,</span> <span>...</span><span>cacheHeaders</span> <span>});</span>
    <span>}</span>
    <span>return</span> <span>new</span> <span>Response</span><span>(</span><span>`:root { color-scheme: light dark; }`</span><span>,</span> <span>{</span> <span>headers</span><span>,</span> <span>...</span><span>cacheHeaders</span> <span>});</span>
  <span>}</span>

  <span>if </span><span>(</span><span>req</span><span>.</span><span>method</span> <span>===</span> <span>&#39;</span><span>POST</span><span>&#39;</span><span>)</span> <span>{</span>
    <span>const</span> <span>scheme</span> <span>=</span> <span>b</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>scheme</span><span>&#39;</span><span>);</span>
    <span>const</span> <span>back</span> <span>=</span> <span>`&lt;meta http-equiv=&#34;refresh&#34; content=&#34;0; url=</span><span>${</span><span>req</span><span>.</span><span>headers</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>Referer</span><span>&#39;</span><span>)</span> <span>||</span> <span>&#39;</span><span>https://macwright.com/</span><span>&#39;</span><span>}</span><span>&#34;&gt;`</span>
    <span>const</span> <span>b</span> <span>=</span> <span>await</span> <span>req</span><span>.</span><span>formData</span><span>();</span>
    <span>if </span><span>(</span><span>scheme</span> <span>===</span> <span>&#39;</span><span>light</span><span>&#39;</span> <span>||</span> <span>scheme</span> <span>===</span> <span>&#39;</span><span>dark</span><span>&#39;</span><span>)</span> <span>{</span>
      <span>return</span> <span>new</span> <span>Response</span><span>(</span><span>back</span><span>,</span> <span>{</span>
        <span>headers</span><span>:</span> <span>{</span>
          <span>&#39;</span><span>Content-Type</span><span>&#39;</span><span>:</span> <span>&#39;</span><span>text/html</span><span>&#39;</span><span>,</span>
          <span>&#39;</span><span>Set-Cookie</span><span>&#39;</span><span>:</span> <span>`colorscheme=</span><span>${</span><span>scheme</span><span>}</span><span>; SameSite=Lax;`</span>
        <span>}</span>
      <span>})</span>
    <span>}</span> <span>else</span> <span>{</span>
      <span>return</span> <span>new</span> <span>Response</span><span>(</span><span>back</span><span>,</span> <span>{</span>
        <span>headers</span><span>:</span> <span>{</span>
          <span>&#39;</span><span>Content-Type</span><span>&#39;</span><span>:</span> <span>&#39;</span><span>text/html</span><span>&#39;</span><span>,</span>
          <span>&#39;</span><span>Set-Cookie</span><span>&#39;</span><span>:</span> <span>&#39;</span><span>colorscheme=deleted; Expires=Thu, 01 Jan 1970 00:00:00 GMT</span><span>&#39;</span>
        <span>}</span>
      <span>})</span>
    <span>}</span>
  <span>}</span>
  <span>return</span> <span>new</span> <span>Response</span><span>(</span><span>&#39;</span><span>Method not supported</span><span>&#39;</span><span>);</span>
<span>}</span>

<span>export</span> <span>const</span> <span>config</span> <span>=</span> <span>{</span> <span>path</span><span>:</span> <span>&#34;</span><span>/mode.css</span><span>&#34;</span> <span>};</span>
</code></pre></div></div><p>Note that it might be tempting to use a 304 response or to otherwise just ‘navigate back’ to the sending page, but browsers will treat that differently than a http-equiv=”refresh” tag: just like hitting the back button in your browser, that isn’t guaranteed to force a reload, so it isn’t going to get a fresh copy of the <code>/mode.css</code> file with correct colors.</p><h2 id="todo">TODO</h2><p>That’s it: I just use <code>light-dark</code> for a lot of CSS properties to flip things in light and dark modes.</p><p>I think it works pretty well! I’ll keep an eye on the performance of <code>/mode.css</code> though, because it blocks the render of the full page. So that needs to be lightning-fast.</p><p>The buttons are <em>fairly</em> accessible: they’re normal buttons, keyboard-accessible, with good focus states, but I wish they had visible labels. It’s hard to balance the concern of wanting them to be clear, but not wanting them to steal attention from the rest of the page. They might eventually land in the navigation menu instead: a select box would be an elegant UI, but selects can’t auto-submit themselves without JavaScript.</p><p>I also don’t supply the <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Elements/meta/name/color-scheme">meta color scheme tag</a> yet, because that would require server logic built into the HTML of this website, which is something I’m not willing to do at this point. If I switch to something like a <a href="https://caddyserver.com/">Caddy</a> setup and self-host, that would become feasible.</p><p>I’m also in the process of figuring out how caching should work for this: ideally browsers are able to cache <code>/mode.css</code> as much as they’d like, but issuing a POST to the endpoint essentially clears the cache. Caching in practice is always a challenge!</p><p>Honestly I think this has 50% odds of surviving for a year. It might be useful and quiet, or it might make my Netlify usage go up and cause all sorts of trouble. We’ll see how it goes!</p></div></article></div></div>
  </body>
</html>
