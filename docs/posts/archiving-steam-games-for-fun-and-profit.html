<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lorendb.dev/posts/archiving-steam-games-for-fun-and-profit/">Original</a>
    <h1>Archiving Steam games for fun and profit</h1>
    
    <div id="readability-page-1" class="page"><div>
      
  <article>
    
    <div>
      <blockquote>
<p>tldr: if you want to create an archive of all your Steam games, check out <a href="https://github.com/LorenDB/download-steam-games">download-steam-games</a> on my GitHub. It has minimal documentation, but you should be able to get it running without too much trouble.</p>
</blockquote>
<p>I recently decided it would be cool to download some beta versions of <a href="https://www.kerbalspaceprogram.com/games-kerbal-space-program-2">KSP2</a> so I can revisit them in a year or so and laugh about how many terrible bugs there were in the original version of the game. I decided that it would make sense to download the game backup directly to my server, so I <code>ssh</code>ed into the server, installed Steam from the system repositories, and started a new <code>ssh -X</code> session. However, when I launched Steam, I realized that my server’s connection to the internet is much too slow to run <code>ssh -X</code> in any sort of usable state. In fact, it was so slow that it apparently timed something out on Steam’s end and made it practically impossible to log in to Steam.</p>
<p>Undaunted, I started looking into <a href="https://developer.valvesoftware.com/wiki/SteamCMD">SteamCMD</a>. It turns out that while SteamCMD is intended for game server administrators, it will happily download any Steam game. It didn’t take me long to install it and use it to download a game. However, it’s a bit of a pain running through a set of instructions in SteamCMD again and again for downloading multiple games, so I set out to script it.</p>
<h2 id="but-why-would-you-do-this">But why would you do this?</h2>
<p>Why wouldn’t I do this? If you think I’m crazy, just go read <a href="https://www.reddit.com/r/DataHoarder/">r/DataHoarder</a> for a while.</p>
<p>Seriously, while I don’t expect Steam to disappear tomorrow, there is precedent for games to be removed from the platform; many of the original games on the platform have been removed. The oldest game still available (counting by which date it was made available on Steam) is the original <a href="https://store.steampowered.com/app/10">Counterstrike</a> with a game ID of 10. Games 1 through 9 aren’t on the platform anymore, and I’m sure they are far from the only games deleted from the platform. Archiving games allows me to avoid losing games that are removed from Steam. Also, sometimes enthusiasts like to be able to access old versions of games; one of the top posts of all time on r/DataHoarder is about <a href="https://www.reddit.com/r/DataHoarder/comments/o9cnj3/one_womans_quest_to_never_delete_anything_allowed/">somebody who hoarded an old Minecraft alpha</a>, giving Minecraft enthusiasts a chance at taking a more complete look at the evolution of the game.</p>
<h2 id="a-naïve-bash-script">A naïve bash script</h2>
<p>My first approach was to create a bash script to wrap SteamCMD with a nice syntax. Of course, I also wanted to bypass the interactive prompt. Let’s go through what I ended up building:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>STEAM_ACCOUNT<span>=</span>
</span></span><span><span>GAME_NAME<span>=</span>
</span></span><span><span>GAME_STEAM_ID<span>=</span>
</span></span><span><span>GAME_FORCE_WINDOWS<span>=</span>
</span></span><span><span>GAME_BETA<span>=</span>
</span></span></code></pre></div><p>These variables control some basic stuff. <code>STEAM_ACCOUNT</code> is the account you logged into SteamCMD with; while SteamCMD caches credentials, you still have to issue the <code>login &lt;username&gt;</code> command every time you start it, so the script has to know what username to use. <code>GAME_NAME</code> doesn’t have to be the actual game name; it’s just used to generate the filename for the final game archive. <code>GAME_STEAM_ID</code> is the numerical ID of the game you want to download; for example, KSP2 is <a href="https://store.steampowered.com/app/954850/Kerbal_Space_Program_2/"><code>954850</code></a>.</p>
<p><code>GAME_FORCE_WINDOWS</code> deserves a more detailed explanation. While I run Linux, some games do not have Linux builds available. For those games, I would like to save a backup of the Windows build instead. This will let me run the game via Proton later. Conveniently, SteamCMD allows you to override what platform you download the game for by setting <code>@sSteamCmdForcePlatformType &lt;platform&gt;</code>. <code>GAME_FORCE_WINDOWS</code> is used later as part of the SteamCMD script contents; therefore, if I want to add a Windows override, I can set <code>GAME_FORCE_WINDOWS</code> to <code>@sSteamCmdForcePlatformType windows</code>.</p>
<p>Finally, we have <code>GAME_BETA</code>. <a href="https://steamdb.info">SteamDB</a> shows beta version identifiers for games; you can use those to download earlier versions of some games. This is something I want to use, given that the original purpose of this project was to archive early KSP2 builds.</p>
<p>The next bit of the script is simply logic to set each of these variables based on command line parameters. I’ve decided to skip it for brevity, as it is trivial bash logic. Moving on, we get this:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>cat &gt; ~/.download-$GAME_NAME.txt <span>&lt;&lt; EOF
</span></span></span><span><span><span>$GAME_FORCE_WINDOWS
</span></span></span><span><span><span>force_install_dir $HOME/Steam/downloads/$GAME_NAME
</span></span></span><span><span><span>login $STEAM_ACCOUNT
</span></span></span><span><span><span>app_update $GAME_STEAM_ID $GAME_BETA validate
</span></span></span><span><span><span>quit
</span></span></span><span><span><span>EOF</span>
</span></span></code></pre></div><p>SteamCMD can be controlled by scripts. This is how we’re going to get around its interactive interface.</p>
<p>The first line of the script is the aforementioned platform override. After that, we use <code>force_install_dir</code> to force SteamCMD to download the game to a known location. In this version of the script, I’ve hardcoded it to <code>~/Steam/downloads</code>, since I’ve installed SteamCMD to <code>~/Steam</code>. Then we log in and issue the actual command to grab the app; once the app has downloaded, we quit SteamCMD.</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>PREVIOUS_DIR<span>=</span><span>$(</span>pwd<span>)</span>
</span></span><span><span>cd ~/Steam
</span></span><span><span>~/Steam/steamcmd.sh +runscript $HOME/.download-$GAME_NAME.txt
</span></span><span><span>cd $PREVIOUS_DIR
</span></span><span><span>rm ~/.download-$GAME_NAME.txt
</span></span></code></pre></div><p>Here we actually execute the script and then delete it to prevent clutter.</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>PREVIOUS_DIR<span>=</span><span>$(</span>pwd<span>)</span>
</span></span><span><span>cd ~/Steam/downloads
</span></span><span><span>tar --use-compress-program<span>=</span>pigz -cf $PREVIOUS_DIR/$GAME_NAME.tar.gz $GAME_NAME
</span></span><span><span>cd $PREVIOUS_DIR
</span></span><span><span>
</span></span><span><span>rm -r $HOME/Steam/downloads/$GAME_NAME
</span></span></code></pre></div><p>The final step is to compress the game folder into a single <code>.tar.gz</code> file. Again, we’re dumping the final archive into <code>~/Steam/downloads</code> for now. The only really unusual part of this is that I’m telling <code>tar</code> to use <code>pigz</code> to do the gzip compression. This is because <code>pigz</code> will use all CPU cores, which is important when you’re archiving many gigabytes of game data.</p>
<p>This is all fine and good, but you still have to manually run the command for each game. To mitigate this, I created a <a href="https://paste.segfault.foo/loren/ac1cfff462804e70bdf85fb764328b19">simple script</a> that read a vaguely CSV-like file which listed games to download. That was definitely better than nothing, but it still felt pretty hacky.</p>
<h2 id="building-it-the-right-way">Building it the right way</h2>
<p>I decided to port my two scripts into one app. I chose to write the app in <a href="https://dlang.org">D</a>; in retrospect, Python would probably have been a good choice simply because it comes preinstalled on pretty much every distro, but I much prefer D for pretty much anything. My ported script is pretty similar to the functionality shown above; however, I added various improvements. Paths are no longer hardcoded, it’s possible to download games for any and all platforms (Windows, macOS, and Linux), and game data is stored as a JSON file instead of in a weird custom-ish format.</p>
<p>The app, which I’m calling <code>download-steam-games</code> (how original), is available <a href="https://github.com/LorenDB/download-steam-games">on GitHub</a>. Building it is a simple matter of running <code>dub build</code>. After that, you need to run <code>dub run -- --add-game</code> to add a game to the download list. After you’ve added some games, you can use <code>dub run</code> to run the application in download mode. It will download all your games for every platform you’ve specified, <code>.tar.gz</code> them, and put them in the output folder of your choosing.</p>
<h2 id="limitations">Limitations</h2>
<p>The app currently is somewhat limited: there’s no functionality to reconfigure the settings, you can’t specify beta versions with <code>--add-game</code>, and there’s no progress reporting during download. However, I think it’s robust enough to actually use in production. I hope to address all of these issues soon, and while I’m at it, I’d like to add a feature to add a timestamp to the archive name so you can download many versions of the same game over time.</p>
<h2 id="conclusion">Conclusion</h2>
<p>This is a fun project that is helping get me hooked on data hoarding. If you start using my app to help hoard your own games, please leave a comment below! I’d love seeing how many gigabytes (or terabytes) of games you’re hoarding.</p>
<h2 id="updates">Updates</h2>
<p>Shortly after writing this post, I’ve added some logging to the app. It ain’t pefect, but it ain’t terrible either.</p>







    </div>
    
  </article>

    </div></div>
  </body>
</html>
