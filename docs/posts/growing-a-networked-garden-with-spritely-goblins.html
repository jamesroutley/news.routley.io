<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://spritely.institute/news/growing-a-networked-garden-with-spritely-goblins.html">Original</a>
    <h1>Growing a Networked Garden with Spritely Goblins</h1>
    
    <div id="readability-page-1" class="page"><div><p>Hello!  This is David Thompson, Spritely Institute’s new Core
Infrastructure Architect!  I’m writing this post on a Friday, at the
end of my first week here, to share my experience with Spritely
Goblins so far.  My goal for this week was to learn as much as I could
about actors, object capabilities, and the Goblins API in order to
create a small demo program to demonstrate my progress.  I had my work
cut out for me because, although I&#39;m very comfortable with Scheme and
functional programming, the domain of object capability security is
one in which I have no prior experience (aside from studying and
providing feedback on <a href="https://spritely.institute/static/papers/spritely-core.html">The Heart of
Spritely</a>
before I joined!)</p><p>The good news is that Spritely Goblins has been thoughtfully designed
to allow programmers to start small and iteratively build an
application that can be used over a network.  This post will walk
through the steps I took to get from a concept to a demo that my
fellow Spritely coworkers could interact with over the Tor network.
You can find the full source code for this demo on <a href="https://git.dthompson.us/community-garden.git/">my personal
website</a>.</p><h2>Phase 0: The concept</h2><p><img src="https://spritely.institute/static/images/blog/growing-networked-garden-graphical-init.png" alt="Garden bed displayed using 2D sprites"/></p><p>When I’m not at the computer, I like to garden, so I thought it would
be fun to incorporate gardening into my demo.
<a href="https://spritely.institute/about/#christine-profile">Christine</a> suggested I make a tile-based
garden game where multiple people could plant things.  I thought that
was a great idea, so I ran with it.  This very simple game is modeled
after a community garden.  Community gardens are typically small plots
of land that a group of local people cultivate cooperatively.  Those
that join a community garden are expected to follow a set of rules
meant to keep the garden a happy and productive space.</p><p>My demo was made in just a couple of days, so it would be impossible
to simulate all the details of what it’s like to participate in a
community garden. For example: Every gardener gets a chunk of the
available growing space in a real community garden, and such a system
is certainly interesting from an object capability security
perspective, but I felt that it would take too long to implement.  I
chose to focus on three things: Planting, digging up plants, and
specifying which plants are acceptable for the community garden.  The
game takes place on a simple 2-dimensional grid of 8 by 8 tiles, where
any gardener can plant in any space provided that the plant has been
approved for use in the garden.</p><h2>Phase 1: Local interaction with text-based visualization</h2><p>As a first step, I wanted to figure out the minimal number of actors I
needed to model the simple interactions explained in the previous
section.  I came up with 4:</p><ul><li><strong>The Garden:</strong> The shared growing space.</li><li><strong>The Gardener:</strong> Someone who can modify a garden.</li><li><strong>The Botanist:</strong> The resident plant expert that says which plants are
allowed to be grown in the garden.</li><li><strong>The Garden Gate:</strong> The place where gardeners check-in with the
botanist before they sow/transplant to make sure it&#39;s OK for the
plant to be grown in the garden.</li></ul><p>Implementing the botanist was an opportunity to practice using
sealers:</p><pre><code><span>(</span><span>define</span> <span>(</span><span>^botanist</span> <span>bcom</span><span>)</span>
  <span>(</span><span>define-values</span> <span>(</span><span>seal-plant</span> <span>unseal-plant</span> <span>approved-plant?</span><span>)</span>
    <span>(</span><span>make-sealer-triplet</span><span>)</span><span>)</span>
  <span>(</span><span>methods</span>
   <span>(</span><span>(</span><span>approve-plant</span> <span>plant</span><span>)</span>
    <span>(</span><span>seal-plant</span> <span>plant</span><span>)</span><span>)</span>
   <span>(</span><span>(</span><span>check-plant</span> <span>plant</span><span>)</span>
    <span>(</span><span>if</span> <span>(</span><span>approved-plant?</span> <span>plant</span><span>)</span>
        <span>(</span><span>unseal-plant</span> <span>plant</span><span>)</span>
        <span>(</span><span>error</span> <span>&#34;plant is not allowed&#34;</span> <span>plant</span><span>)</span><span>)</span><span>)</span><span>)</span><span>)</span></code></pre><p>Whoever has access to the botanist can approve plants by sending the
<code>approve-plant</code> message.  In return they will receive a sealed plant
object.</p><p>The garden gate actor is simply a proxy for the botanist:</p><pre><code><span>(</span><span>define</span> <span>(</span><span>^garden-gate</span> <span>bcom</span> <span>botanist</span><span>)</span>
  <span>(</span><span>methods</span>
   <span>(</span><span>(</span><span>check-plant</span> <span>plant</span><span>)</span>
    <span>(</span><span>$</span> <span>botanist</span> <span>&#39;check-plant</span> <span>plant</span><span>)</span><span>)</span><span>)</span><span>)</span></code></pre><p>Whoever has access to the garden gate can <em>check</em> if plants are
approved, but they are not allowed to approve plants.</p><p>The garden actor manages the state of the community garden plot:</p><pre><code><span>(</span><span>define</span> <span>(</span><span>^garden</span> <span>bcom</span> <span>name</span> <span>garden-bed</span> <span>garden-gate</span><span>)</span>
  <span>(</span><span>define</span> <span>(</span><span>ensure-empty</span> <span>x</span> <span>y</span><span>)</span>
    <span>(</span><span>when</span> <span>(</span><span>garden-bed-ref</span> <span>garden-bed</span> <span>x</span> <span>y</span><span>)</span>
      <span>(</span><span>error</span> <span>&#34;tile already has something planted in it&#34;</span> <span>x</span> <span>y</span><span>)</span><span>)</span><span>)</span>
  <span>(</span><span>methods</span>
   <span>(</span><span>(</span><span>get-name</span><span>)</span> <span>name</span><span>)</span>
   <span>(</span><span>(</span><span>get-bed</span><span>)</span> <span>garden-bed</span><span>)</span>
   <span>(</span><span>(</span><span>plant</span> <span>x</span> <span>y</span> <span>sealed-plant</span><span>)</span>
    <span>(</span><span>ensure-empty</span> <span>x</span> <span>y</span><span>)</span>
    <span>(</span><span>let*</span> <span>(</span><span>(</span><span>plant</span> <span>(</span><span>$</span> <span>garden-gate</span> <span>&#39;check-plant</span> <span>sealed-plant</span><span>)</span><span>)</span>
           <span>(</span><span>new-bed</span> <span>(</span><span>garden-bed-set</span> <span>garden-bed</span> <span>x</span> <span>y</span> <span>plant</span><span>)</span><span>)</span><span>)</span>
      <span>(</span><span>bcom</span> <span>(</span><span>^garden</span> <span>bcom</span> <span>name</span> <span>new-bed</span> <span>garden-gate</span><span>)</span><span>)</span><span>)</span><span>)</span>
   <span>(</span><span>(</span><span>dig-up</span> <span>x</span> <span>y</span><span>)</span>
    <span>(</span><span>let</span> <span>(</span><span>(</span><span>new-bed</span> <span>(</span><span>garden-bed-set</span> <span>garden-bed</span> <span>x</span> <span>y</span> <span>#f</span><span>)</span><span>)</span><span>)</span>
      <span>(</span><span>bcom</span> <span>(</span><span>^garden</span> <span>bcom</span> <span>name</span> <span>new-bed</span> <span>garden-gate</span><span>)</span><span>)</span><span>)</span><span>)</span><span>)</span><span>)</span></code></pre><p>Whoever has access to the garden can plant or dig up whatever tile
they&#39;d like, but they have to check in at the garden gate before
planting.</p><p>Finally, there&#39;s the gardener:</p><pre><code><span>(</span><span>define</span> <span>(</span><span>^gardener</span> <span>bcom</span> <span>name</span> <span>garden</span><span>)</span>
  <span>(</span><span>methods</span>
   <span>(</span><span>(</span><span>get-name</span><span>)</span> <span>name</span><span>)</span>
   <span>(</span><span>(</span><span>get-garden-name</span><span>)</span>
    <span>(</span><span>&lt;-</span> <span>garden</span> <span>&#39;get-name</span><span>)</span><span>)</span>
   <span>(</span><span>(</span><span>inspect-garden</span><span>)</span>
    <span>(</span><span>&lt;-</span> <span>garden</span> <span>&#39;get-bed</span><span>)</span><span>)</span>
   <span>(</span><span>(</span><span>plant</span> <span>x</span> <span>y</span> <span>plant</span><span>)</span>
    <span>(</span><span>&lt;-</span> <span>garden</span> <span>&#39;plant</span> <span>x</span> <span>y</span> <span>plant</span><span>)</span><span>)</span>
   <span>(</span><span>(</span><span>dig-up</span> <span>x</span> <span>y</span><span>)</span>
    <span>(</span><span>&lt;-</span> <span>garden</span> <span>&#39;dig-up</span> <span>x</span> <span>y</span><span>)</span><span>)</span><span>)</span><span>)</span></code></pre><p>Gardeners belong to a garden, so their actions (planting, digging) are
done within the context of their garden.</p><p>With these actors in place, I could now create a garden and have a
gardener make changes to it.</p><pre><code><span>(</span><span>define</span> <span>garden-vat</span> <span>(</span><span>spawn-vat</span><span>)</span><span>)</span>
<span>(</span><span>define-vat-run</span> <span>garden-run</span> <span>garden-vat</span><span>)</span>
<span>(</span><span>define</span> <span>the-botanist</span> <span>(</span><span>garden-run</span> <span>(</span><span>spawn</span> <span>^botanist</span><span>)</span><span>)</span><span>)</span>
<span>(</span><span>define</span> <span>the-garden-gate</span> <span>(</span><span>garden-run</span> <span>(</span><span>spawn</span> <span>^garden-gate</span> <span>the-botanist</span><span>)</span><span>)</span><span>)</span>
<span>(</span><span>define</span> <span>our-garden</span>
  <span>(</span><span>garden-run</span>
   <span>(</span><span>spawn</span> <span>^garden</span>
          <span>&#34;Spritely Institute Community Garden&#34;</span>
          <span>(</span><span>make-garden-bed</span> <span>8</span> <span>8</span><span>)</span>
          <span>the-garden-gate</span><span>)</span><span>)</span><span>)</span>

<span>(</span><span>define</span> <span>sunflower/approved</span>
  <span>(</span><span>garden-run</span> <span>(</span><span>$</span> <span>the-botanist</span> <span>&#39;approve-plant</span> <span>sunflower</span><span>)</span><span>)</span><span>)</span>

<span>(</span><span>define</span> <span>alice-vat</span> <span>(</span><span>spawn-vat</span><span>)</span><span>)</span>
<span>(</span><span>define-vat-run</span> <span>alice-run</span> <span>alice-vat</span><span>)</span>
<span>(</span><span>define</span> <span>alice</span> <span>(</span><span>alice-run</span> <span>(</span><span>spawn</span> <span>^gardener</span> <span>&#34;Alice&#34;</span> <span>our-garden</span><span>)</span><span>)</span><span>)</span>
<span>(</span><span>alice-run</span> <span>(</span><span>$</span> <span>alice</span> <span>&#39;plant</span> <span>2</span> <span>2</span> <span>sunflower/approved</span><span>)</span><span>)</span>
</code></pre><p>A simple <code>display-garden-bed</code> procedure was made to visualize the
state of the garden:</p><p><img src="https://spritely.institute/static/images/blog/growing-networked-garden-text-render.png" alt="Garden bed displayed as ASCII art"/></p><h2>Phase 2: Local interaction with graphical visualization</h2><p>Text is nice, but I wanted something a little more eye catching to
share.  So, I integrated the Goblins code with the
<a href="https://dthompson.us/projects/chickadee.html">Chickadee</a> game
programming library to create a simple 2D visualization using sprites.
The result is the screenshot at the beginning of the post.  The
visualization program periodically polls a special read-only actor
(called a “visitor”) for the current state of the garden by sending
the <code>inspect-garden</code> message and updates the sprites to reflect the
current state of the garden.</p><h2>Phase 3: Network interaction over Tor via OCapN</h2><p>This is where things get really interesting.  Using the Object
Capabilities Network (OCapN) support in Goblins, I generated a special
URI that represents the garden.  By giving someone this URI (called a
“sturdy ref”), they gain the ability to edit the garden.</p><p>OCapN can operate over different types of networks (called
“netlayers.”)  Tor is used here:</p><pre><code><span>(</span><span>define</span> <span>onion-netlayer</span> <span>(</span><span>garden-run</span> <span>(</span><span>new-onion-netlayer</span><span>)</span><span>)</span><span>)</span>
<span>(</span><span>define</span> <span>mycapn</span>
  <span>(</span><span>garden-run</span>
   <span>(</span><span>let*</span> <span>(</span><span>(</span><span>mycapn</span> <span>(</span><span>spawn-mycapn</span> <span>onion-netlayer</span><span>)</span><span>)</span>
          <span>(</span><span>garden-sref</span> <span>(</span><span>$</span> <span>mycapn</span> <span>&#39;register</span> <span>our-garden</span> <span>&#39;onion</span><span>)</span><span>)</span><span>)</span>
     <span>(</span><span>format</span> <span>#t</span> <span>&#34;Connect to: ~a\n&#34;</span> <span>(</span><span>ocapn-id-&gt;string</span> <span>garden-sref</span><span>)</span><span>)</span>
     <span>mycapn</span><span>)</span><span>)</span><span>)</span></code></pre><p>This is the only code that needed to be added to make the garden
reachable over the network by those who have been given the sturdy
ref.</p><p>To make it possible for remote users to plant things, the botanist
actor was enhanced to keep a registry of approved plants: A mapping
from string (the plant’s name) to sealed plant object.  In order to
pass this list of sealed plants over the network, I switched from
“simple sealers” to the freshly merged “actor sealers” in the
implementation of the botanist.</p><p>A second program was created that allows the user to edit the remote
garden.  It receives the garden sturdy ref via a command-line
argument.  I didn’t have time to make a graphical program for remote
editing, so instead I made a very barebones text command
console. Then, I asked Christine to edit the garden from their
computer.  This program isn’t smart enough to tell Christine that
planting radishes isn’t allowed, but the botanist only likes cabbages
and sunflowers!</p><p><img src="https://spritely.institute/static/images/blog/growing-networked-garden-edit-console.png" alt="Garden editing console"/></p><p>Here&#39;s the result as seen from the graphical viewer program:</p><p><img src="https://spritely.institute/static/images/blog/growing-networked-garden-graphical-modified.png" alt="Garden bed displayed using 2D sprites"/></p><p>Let’s get a glimpse of the edit program:</p><pre><code><span>(</span><span>define</span> <span>(</span><span>edit-garden</span> <span>name</span> <span>garden-address</span><span>)</span>
  <span>(</span><span>define</span> <span>garden-sref</span> <span>(</span><span>string-&gt;ocapn-id</span> <span>garden-address</span><span>)</span><span>)</span>
  <span>(</span><span>define</span> <span>vat</span> <span>(</span><span>spawn-vat</span><span>)</span><span>)</span>
  <span>(</span><span>define-vat-run</span> <span>vat-run</span> <span>vat</span><span>)</span>
  <span>(</span><span>define</span> <span>onion-netlayer</span> <span>(</span><span>vat-run</span> <span>(</span><span>new-onion-netlayer</span><span>)</span><span>)</span><span>)</span>
  <span>(</span><span>define</span> <span>mycapn</span> <span>(</span><span>vat-run</span> <span>(</span><span>spawn-mycapn</span> <span>onion-netlayer</span><span>)</span><span>)</span><span>)</span>
  <span>(</span><span>define</span> <span>garden-vow</span> <span>(</span><span>vat-run</span> <span>(</span><span>$</span> <span>mycapn</span> <span>&#39;enliven</span> <span>garden-sref</span><span>)</span><span>)</span><span>)</span>
  <span>(</span><span>define</span> <span>approved-plants-vow</span> <span>(</span><span>vat-run</span> <span>(</span><span>&lt;-</span> <span>garden-vow</span> <span>&#39;get-approved-plants</span><span>)</span><span>)</span><span>)</span>
  <span>(</span><span>define</span> <span>gardener</span> <span>(</span><span>vat-run</span> <span>(</span><span>spawn</span> <span>^gardener</span> <span>name</span> <span>garden-vow</span><span>)</span><span>)</span><span>)</span>
  <span>...</span><span>)</span></code></pre><p>The reference to the remote garden is “enlivened” via OCapN to create
an actor, which can then be sent messages.  The <code>gardener</code> actor works
just like it did when it was talking to a local garden.  Neat!</p><h2>Phase 4: Audit logging</h2><p>As a finishing touch, I wanted to display a text log of what was
happening to the garden, inspired by the “Revocation and
accountability” section of the <a href="https://spritely.institute/static/papers/spritely-core.html#revocation-accountability">Heart of
Spritely</a>
paper.  This required a small change to the architecture.  A new actor
called the “Garden Community” was introduced to wrap the garden.</p><pre><code><span>(</span><span>define</span> <span>(</span><span>^garden-community</span> <span>bcom</span> <span>garden</span><span>)</span>
  <span>(</span><span>define</span> <span>garden-name</span> <span>(</span><span>$</span> <span>garden</span> <span>&#39;get-name</span><span>)</span><span>)</span>
  <span>(</span><span>define</span> <span>(</span><span>^gardener</span> <span>bcom</span> <span>name</span><span>)</span>
    <span>(</span><span>methods</span>
     <span>(</span><span>(</span><span>get-name</span><span>)</span> <span>name</span><span>)</span>
     <span>(</span><span>(</span><span>get-garden-name</span><span>)</span> <span>garden-name</span><span>)</span>
     <span>(</span><span>(</span><span>get-approved-plants</span><span>)</span>
      <span>(</span><span>$</span> <span>garden</span> <span>&#39;get-approved-plants</span><span>)</span><span>)</span>
     <span>(</span><span>(</span><span>inspect-garden</span><span>)</span>
      <span>(</span><span>$</span> <span>garden</span> <span>&#39;get-bed</span><span>)</span><span>)</span>
     <span>(</span><span>(</span><span>plant</span> <span>x</span> <span>y</span> <span>plant</span><span>)</span>
      <span>(</span><span>$</span> <span>garden</span> <span>&#39;plant</span> <span>name</span> <span>x</span> <span>y</span> <span>plant</span><span>)</span><span>)</span>
     <span>(</span><span>(</span><span>dig-up</span> <span>x</span> <span>y</span><span>)</span>
      <span>(</span><span>$</span> <span>garden</span> <span>&#39;dig-up</span> <span>name</span> <span>x</span> <span>y</span><span>)</span><span>)</span><span>)</span><span>)</span>
  <span>(</span><span>define</span> <span>(</span><span>^visitor</span> <span>bcom</span> <span>name</span><span>)</span>
    <span>(</span><span>methods</span>
     <span>(</span><span>(</span><span>get-name</span><span>)</span> <span>name</span><span>)</span>
     <span>(</span><span>(</span><span>get-garden-name</span><span>)</span> <span>garden-name</span><span>)</span>
     <span>(</span><span>(</span><span>inspect-garden</span><span>)</span>
      <span>(</span><span>$</span> <span>garden</span> <span>&#39;get-bed</span><span>)</span><span>)</span><span>)</span><span>)</span>
  <span>(</span><span>methods</span>
   <span>(</span><span>(</span><span>register-gardener</span> <span>name</span><span>)</span>
    <span>(</span><span>format</span> <span>#t</span> <span>&#34;~a has joined ~a\n&#34;</span> <span>name</span> <span>garden-name</span><span>)</span>
    <span>(</span><span>spawn</span> <span>^gardener</span> <span>name</span><span>)</span><span>)</span>
   <span>(</span><span>(</span><span>register-visitor</span> <span>name</span><span>)</span>
    <span>(</span><span>format</span> <span>#t</span> <span>&#34;~a has come to visit ~a\n&#34;</span> <span>name</span> <span>garden-name</span><span>)</span>
    <span>(</span><span>spawn</span> <span>^visitor</span> <span>name</span><span>)</span><span>)</span><span>)</span><span>)</span></code></pre><p>The garden community proxies a garden and passes along the name of the
gardener for the <code>plant</code> and <code>dig-up</code> methods so the garden
administrator can monitor what is going on.  The remote editing
program was changed to accept a sturdy ref to a community and initiate
gardener registration via the <code>register-gardener</code> message when it
starts.  The graphical viewer was likewise modified to register a
visitor.  (Note that there is no revocation feature to complement the
logging, so an administrator would be helpless to kick out a reckless
gardener!  However, in a non-demo version, we could always add such a
feature!)</p><p>Log sample:</p><p><img src="https://spritely.institute/static/images/blog/growing-networked-garden-audit-log.png" alt="Audit log sample"/></p><h2>How things went</h2><p>Overall, I had a lot of fun learning to use the Goblins API.  The way
actors compose allows for building simple pieces that can be combined
to form complex behavior.  I didn’t know exactly what the architecture
of my application would be when I started, but Goblins allowed me to
start <em>very</em> small and build on a series of successful prototypes.
Using actors across several vats within the same Guile process
provided the foundation for introducing the networking layer later.
And of course, building and testing actors within a Guile REPL made
development move quickly.  It was <em>really</em> nice to not have to think
about networking right away, but it was even nicer to finally add
networking without changing the application architecture much.</p><p>It’s still early days for Goblins, and not everything is perfect.  I
think the REPL experience could be improved.  Wrapping every Goblins
expression in a vat call feels cumbersome.  Also, handling/debugging
errors generated within a vat is less than ideal.  The exceptions and
backtraces I see are often hard to understand.  During phase 3 I got
stuck on a bug for awhile, thinking that I wasn’t understanding
something fundamental to using actors over OCapN, when really I had
introduced a simple argument ordering bug that was completely
unrelated.  I would like to help address these issues in the future.</p><h2>Summary</h2><p>I think games, even simple ones that barely do anything at all, are a
great way to explore and learn new concepts.  Building this very
simple community garden simulator has taught me a lot about Goblins
and has given me many ideas about what I could build in the future.
You can find the full source code for this demo on <a href="https://git.dthompson.us/community-garden.git/">my personal
website</a>.</p><p>I hope this post demonstrates how someone with no prior experience
building applications using object capabilities can get started and
have fun doing it!  If you&#39;re excited to learn more, check out the
<a href="https://spritely.institute/static/papers/spritely-core.html">The Heart of
Spritely</a>
whitepaper!</p></div></div>
  </body>
</html>
