<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kevindavid.org/code/2024/03/20/chrome-os-flex-proxmox.html">Original</a>
    <h1>Creating a Proxmox or QEMU ChromeOS Flex VM</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p>I recently wanted to experiment with <a href="https://chromeos.google/products/chromeos-flex/">ChromeOS Flex</a> but didn’t want to install it on a physical machine. I also was doing this without a USB key, which complicated things slightly.</p>

<p>After some trial and error, there are two non-obvious steps to get the installer running:</p>
<ul>
  <li>Properly mounting the <code>.bin</code> live USB image in a way that’s accessible to the VM</li>
  <li>Setting graphics drivers to something ChromeOS Flex supports, which enables the VM to successfully boot the live USB image</li>
</ul>

<h2 id="prepare">Prepare</h2>

<p>You’ll need the ChromeOS Flex USB image, which you can get from <a href="https://support.google.com/chromeosflex/answer/11541904?hl=en&amp;ref_topic=11551271&amp;sjid=13345019591806376618-NA">here</a> if you don’t want to enter your contact info on the main page.</p>

<p>Download the ZIP and extract it to your host device somewhere.</p>

<h3 id="while-you-wait">While you wait…</h3>

<p>To use the <code>VirGL GPU</code> driver, which we’ll need later:</p>

<div><div><pre><code>apt-get <span>install </span>libgl1 libegl1
</code></pre></div></div>

<h2 id="create-the-vm">Create the VM</h2>

<p>I used mostly default settings, with a few exceptions.</p>

<ul>
  <li>Linux OS, with the <code>Do not use any media</code> option initially selected</li>
  <li><code>q35</code> machine type</li>
  <li><code>host</code> CPU type</li>
  <li><code>OVMF (UEFI)</code> BIOS type</li>
</ul>

<p>If you’re using <code>OVMF (UEFI)</code> make sure you uncheck the <code>Pre-Enroll keys</code> option on the EFI disk, otherwise it won’t boot - I got an “Access Denied” error in the virtual BIOS.</p>

<p>After creation, go change the <code>Graphic card</code> setting under <code>Display</code> (inside <code>Hardware</code>) to  <code>VirGL GPU</code>.</p>

<p><code>VirtIO-GPU</code> may also work, but in my experience it was a bit laggier - <a href="https://forum.proxmox.com/threads/difference-between-virtio-gpu-and-virgl-gpu.113619/">more info</a> on differences, or search yourself.</p>

<p>Don’t bother starting the VM yet.</p>

<h2 id="map-in-the-live-usb-binary-image-as-a-disk">Map in the live USB binary image as a disk</h2>

<p>Set up a loop device with the extracted binary image from the earlier-downloaded from the ZIP file.</p>

<p>For example:</p>

<div><div><pre><code>losetup <span>--partscan</span> /dev/loop1 chromeos_15393.58.0_reven_recovery_stable-channel_mp-v2.bin
</code></pre></div></div>

<p>Then, map it to your VM like you would any other block device (<a href="https://pve.proxmox.com/wiki/Passthrough_Physical_Disk_to_Virtual_Machine_(VM)?ref=raptorswithhats.com#Update_Configuration">reference</a>):</p>

<div><div><pre><code>qm <span>set</span> &lt;vm_id_here&gt; <span>-scsi2</span> /dev/loop&lt;num&gt;
</code></pre></div></div>

<p>Mine was <code>/dev/loop1</code>, yours may be different.</p>

<h2 id="start-it-up">Start it up</h2>

<p>Go back to the Proxmox VM settings (<code>Options</code>, not <code>Hardware</code> this time) and change the boot order, putting the <code>scsi2</code> device first. It should be obvious which one it is, because it’s mapped to your loop device.</p>

<p>Finally, start the VM. If all goes well, you should be greeted with the ChromeOS Flex install screen via the console.</p>

  </div>
</article>

      </div>
    </div></div>
  </body>
</html>
