<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://about.gitlab.com/blog/2021/02/03/how-we-automatically-fixed-hundreds-of-ruby-2-7-deprecation-warnings/">Original</a>
    <h1>We automatically fixed thousands of Ruby 2.7 deprecation warnings</h1>
    
    <div id="readability-page-1" class="page"><article>
<img alt="" src="https://scottschmidt.io/images/blogimages/daria-nepriakhina-zNU3ErDAbAw-unsplash.jpg" width="100%"/>
<p>Ruby 3.0 was just released on Dec. 25, 2020, with some new features and some breaking changes.
GitLab was at Ruby 2.6, and we wanted to upgrade to Ruby 2.7 in preparation to eventually upgrade to Ruby 3.</p>
<p>In Ruby 3.0, <a href="https://www.ruby-lang.org/en/news/2019/12/12/separation-of-positional-and-keyword-arguments-in-ruby-3-0/">positional and keyword arguments will be separated</a>. To help developers prepare for this, in Ruby 2.7,
warnings were added. In GitLab, we discovered we have <a href="https://gitlab.com/gitlab-org/gitlab/-/issues/257438">thousands
of such warnings</a> across hundreds of files:</p>
<div><pre><code>warning: Using the last argument as keyword parameters is deprecated; maybe ** should be added to the call
</code></pre></div>
<h2 id="boring-solutions">Boring solutions</h2>
<p>To address this warning, the obvious, and boring solution was to simply add <code>**</code> to the last keyword argument.
For the most part, this is what we did. However, while this was under way, we also developed a RuboCop check that could
detect, and automatically fix the keyword arguments. The benefit for this approach was that we can
<a href="https://docs.rubocop.org/rubocop/usage/auto_correct.html">autocorrect</a> any existing warnings en masse.</p>
<p>The tricky part about this is that RuboCop is designed to statically analyze Ruby code, whereas the warnings were
generated by Ruby at runtime.</p>
<h2 id="a-way-forward">A way forward</h2>
<p>After some research, we found a way to utilize our comprehensive RSpec test suite to
gather all the warnings using the <a href="https://github.com/shopify/deprecation_toolkit">Deprecation Toolkit gem</a>. We also
considered using the <a href="https://github.com/jeremyevans/ruby-warning">warning gem</a> at one point, but preferred Deprecation Toolkit
as the results were easier to process.</p>
<p>Deprecation Toolkit supports RSpec out of the box, so it was really simple to configure. It also has a simple YAML-based file format to record all deprecations. We then adapted this to record deprecation warnings for Ruby 2.7
last keyword arguments with:</p>
<div><pre><code>  <span>kwargs_warnings</span> <span>=</span> <span>[</span>
    <span># Taken from https://github.com/jeremyevans/ruby-warning/blob/1.1.0/lib/warning.rb#L18</span>
    <span>%r{warning: (?:Using the last argument (?:for `.+&#39; )?as keyword parameters is deprecated; maybe </span><span>\*\*</span><span> should be added to the call|Passing the keyword argument (?:for `.+&#39; )?as the last hash parameter is deprecated|Splitting the last argument (?:for `.+&#39; )?into positional and keyword parameters is deprecated|The called method (?:`.+&#39; )?is defined here)</span><span>\n\z</span><span>}</span>
  <span>]</span>
  <span>DeprecationToolkit</span><span>::</span><span>Configuration</span><span>.</span><span>warnings_treated_as_deprecation</span> <span>=</span> <span>kwargs_warnings</span>
</code></pre></div>
<p>Lastly, we wrote a new RuboCop check, called
<a href="https://gitlab.com/gitlab-org/gitlab/-/blob/632b7768f7f9014951170a006489d66b34001c68/rubocop/cop/lint/last_keyword_argument.rb"><code>Lint/LastKeywordArgument</code></a>,
that checks against the YAML files generated by Deprecation Toolkit, and
generates offenses. Now we can very quickly, statically check the whole GitLab
codebase, and even autocorrect! You can see how <a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/47720">Deprecation Toolkit and the
<code>LastKeywordArgument</code> check was put together in this merge
request</a>. You can
see a sample output from running the <code>LastKeywordArgument</code> cop check:</p>
<p><img src="https://scottschmidt.io/images/blogimages/last-keyword-argument-rubocop-offenses.png" alt="LastKeywordArgument RuboCop offenses"/>
Sample output from running the <code>LastKeywordArgument</code> cop check</p>
<h2 id="automatically-fix-everything">Automatically fix everything</h2>
<p>Now we have an automatic RuboCop check, which can also autocorrect, we create merge requests to autocorrect!
For example, we autocorrected 62 instances across <a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/48407">39 spec files</a>.
Automation for the win!</p>
<p>We then went one step further, and integrated this in our GitLab CI pipelines. Using the <code>artifacts</code> feature of GitLab CI, we
gathered the <code>deprecations</code> directory from all RSpec jobs (we have about 400 such jobs). After all the RSpec jobs have passed, we then made a <code>post-test</code> job to
<a href="https://gitlab.com/gitlab-org/gitlab/-/merge_requests/49792">check the results</a> with the <code>LastKeywordArgument</code> cop. Below is a
snippet of the GitLab CI <code>.gitlab-ci.yml</code> configuration:</p>
<div><pre><code><span>stages</span><span>:</span>
  <span>-</span> <span>test</span>
  <span>-</span> <span>post-test</span>

<span># This inherited job is used by all RSpec jobs</span>
<span>.rspec-base</span><span>:</span>
  <span>stage</span><span>:</span> <span>test</span>
  <span>artifacts</span><span>:</span>
    <span>-</span> <span>deprecations/</span>

<span># GitLab CI job artifacts from previous stages are passed to this job</span>
<span>rspec:deprecations</span><span>:</span>
  <span>stage</span><span>:</span> <span>post-test</span>
  <span>script</span><span>:</span>
    <span>-</span> <span>bundle exec rubocop --only Lint/LastKeywordArgument --parallel</span>
  <span>artifacts</span><span>:</span>
    <span>-</span> <span>deprecations/</span>
</code></pre></div>
<p>This enabled us to have a single job where <a href="https://gitlab.com/gitlab-org/gitlab/-/jobs/991299621">we can see all deprecation warnings</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>With this measure we went from about 30,000 warnings related to keyword arguments to about 800 remaining warnings, largely stemming from
dependencies. Feel free to follow our progress in <a href="https://gitlab.com/gitlab-org/gitlab/-/issues/257438">GitLab issue #257438</a>, and contribute to
fix the remaining warnings if you are interested!</p>
<p>Cover image by <a href="https://unsplash.com/@epicantus">Daria Nepriakhina</a> on <a href="https://unsplash.com/photos/zNU3ErDAbAw">Unsplash</a></p>

</article></div>
  </body>
</html>
