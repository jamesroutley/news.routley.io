<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://esham.io/2025/05/shell-history">Original</a>
    <h1>Curate your shell history</h1>
    
    <div id="readability-page-1" class="page"><div><p>Simon Tatham wrote an article recently called <a href="https://www.chiark.greenend.org.uk/~sgtatham/quasiblog/transience/">“Policy of transience”</a>, explaining (among other things) why you might want to disable your shell history file. Simon writes:</p>
<blockquote>
<p>My unusual habit is: <strong>turn off the history file completely,</strong> by putting the command ‘<code>unset HISTFILE</code>’ in my <code>.bashrc</code>. I still get history within a single instance of the shell, so I can edit my last command ten times until it works properly; but history isn’t shared between my terminal windows, or preserved when I log out and log in again. All the shell history I allow myself is localised and short-term.</p>
<p>[…]</p>
<p>If I type a shell command that’s <em>valuable</em> – one that did something useful enough that I might want it again in future, and long and complicated enough that I’d be annoyed to have to figure it out a second time from scratch – then I can’t rely on it just happening to be in my <code>.bash_history</code>. So instead I put it somewhere else: maybe a shell function in my <code>.bashrc</code>, or maybe a shell script in my directory of random useful scriptlets. Or maybe just in a file of notes jotted down to myself about useful shell runes to remember.</p>
<p>I find this a more useful way to remember shell commands. Firstly, this procedure separates the <em>working</em> version of the command from all the failed attempts just before it. Even within the context of one instance of <code>bash</code> I’ll sometimes accidentally recall a <em>wrong</em> version of a command when I was aiming for the corrected one two commands later; the idea of having a <em>year’s worth</em> of my own false starts available for accidental recall seems horrifying! Instead, I deliberately save <em>just</em> the working version, and let all the failed attempts go in the trash when I close the shell.</p>
</blockquote>
<p>For me, this idea feels uncomfortable! If anything, I’m a shell history maximalist; I have zsh configured to save my last 9,800 commands.<a href="#shell-history_fn1" id="shell-history_fnref1" role="doc-noteref"><sup>1</sup></a> I rely heavily on my shell history to remember how I did things before. I suspect my most-used form of zsh completion is to complete the current command line from a history entry.</p>
<p>But I also think Simon makes a good point about how useless it is to record all of your false starts. Why save <code>cd ~/Dekstop</code>, which I’m never going to want to run again?<a href="#shell-history_fn2" id="shell-history_fnref2" role="doc-noteref"><sup>2</sup></a> Why save <code>vim /etc/rc.conf</code> when <code>sudo vim /etc/rc.conf</code> is what I meant 100% of the time? At best, these dead-end commands are taking up unnecessary space in my history file. At worst, they’ll trip me up <em>again</em> the next time I need to do the same thing and naively run the first command from my history that looks right.</p>
<hr/>
<p>For myself, I don’t want my shell history to be opt-in. But I <em>can</em> make it easier to remove the typos and dead ends. I came up with this zsh function to facilitate that:</p>
<div id="shell-history_cb1"><pre><code><span id="shell-history_cb1-1"><a href="#shell-history_cb1-1" aria-hidden="true" tabindex="-1"></a><span>function</span> <span>smite</span><span>()</span> <span>{</span></span>
<span id="shell-history_cb1-2"><a href="#shell-history_cb1-2" aria-hidden="true" tabindex="-1"></a>    <span>setopt</span> LOCAL_OPTIONS ERR_RETURN PIPE_FAIL</span>
<span id="shell-history_cb1-3"><a href="#shell-history_cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="shell-history_cb1-4"><a href="#shell-history_cb1-4" aria-hidden="true" tabindex="-1"></a>    <span>local</span> <span>opts</span><span>=</span><span>(</span> -I <span>)</span></span>
<span id="shell-history_cb1-5"><a href="#shell-history_cb1-5" aria-hidden="true" tabindex="-1"></a>    <span>if</span> <span>[[</span> <span>$1</span> <span>==</span> <span>&#39;-a&#39;</span> <span>]];</span> <span>then</span></span>
<span id="shell-history_cb1-6"><a href="#shell-history_cb1-6" aria-hidden="true" tabindex="-1"></a>        <span>opts</span><span>=</span><span>()</span></span>
<span id="shell-history_cb1-7"><a href="#shell-history_cb1-7" aria-hidden="true" tabindex="-1"></a>    <span>elif</span> <span>[[</span> <span>-n</span> <span>$1</span> <span>]];</span> <span>then</span></span>
<span id="shell-history_cb1-8"><a href="#shell-history_cb1-8" aria-hidden="true" tabindex="-1"></a>        <span>print</span> <span>&gt;&amp;</span><span>2</span> <span>&#39;usage: smite [-a]&#39;</span></span>
<span id="shell-history_cb1-9"><a href="#shell-history_cb1-9" aria-hidden="true" tabindex="-1"></a>        <span>return</span> <span>1</span></span>
<span id="shell-history_cb1-10"><a href="#shell-history_cb1-10" aria-hidden="true" tabindex="-1"></a>    <span>fi</span></span>
<span id="shell-history_cb1-11"><a href="#shell-history_cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="shell-history_cb1-12"><a href="#shell-history_cb1-12" aria-hidden="true" tabindex="-1"></a>    <span>fc</span> <span>-l</span> <span>-n</span> <span>$opts</span> 1 <span>|</span> <span>\</span></span>
<span id="shell-history_cb1-13"><a href="#shell-history_cb1-13" aria-hidden="true" tabindex="-1"></a>        <span>fzf</span> <span>--no-sort</span> <span>--tac</span> <span>--multi</span> <span>|</span> <span>\</span></span>
<span id="shell-history_cb1-14"><a href="#shell-history_cb1-14" aria-hidden="true" tabindex="-1"></a>        <span>while</span> <span>IFS</span><span>=</span><span>&#39;&#39;</span> <span>read</span> <span>-r</span> <span>command_to_delete</span><span>;</span> <span>do</span></span>
<span id="shell-history_cb1-15"><a href="#shell-history_cb1-15" aria-hidden="true" tabindex="-1"></a>            <span>printf</span> <span>&#39;Removing history entry &#34;%s&#34;\n&#39;</span> <span>$command_to_delete</span></span>
<span id="shell-history_cb1-16"><a href="#shell-history_cb1-16" aria-hidden="true" tabindex="-1"></a>            <span>local</span> <span>HISTORY_IGNORE</span><span>=</span><span>&#34;</span><span>${(</span><span>b</span><span>)command_to_delete}</span><span>&#34;</span></span>
<span id="shell-history_cb1-17"><a href="#shell-history_cb1-17" aria-hidden="true" tabindex="-1"></a>            <span>fc</span> <span>-W</span></span>
<span id="shell-history_cb1-18"><a href="#shell-history_cb1-18" aria-hidden="true" tabindex="-1"></a>            <span>fc</span> <span>-p</span> <span>$HISTFILE</span> <span>$HISTSIZE</span> <span>$SAVEHIST</span></span>
<span id="shell-history_cb1-19"><a href="#shell-history_cb1-19" aria-hidden="true" tabindex="-1"></a>        <span>done</span></span>
<span id="shell-history_cb1-20"><a href="#shell-history_cb1-20" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>Running <code>smite</code> opens an <a href="https://github.com/junegunn/fzf">fzf</a>-powered browser with your shell history in it. (So you’ll need fzf installed, but that’s the only dependency.) By default, you’ll only see your history from the current session, but running <code>smite -a</code> shows all of your history.</p>
<p>When you navigate to an entry and press <kbd>Return</kbd> or <kbd>Enter</kbd>, zsh will delete all instances of that command from your history. If you want to delete multiple commands at once, you can select them by pressing <kbd>Tab</kbd> on each one and then typing <kbd>Return</kbd> to commit your changes.</p>
<p>Multiline commands are not handled correctly, for now.</p>
<p>The function prints back all of the commands it’s deleting, just in case you select the wrong one.</p>
<p>Here’s a video:</p>
<video controls="controls" playsinline="playsinline" width="702" height="528">
<source src="/media/2025/shell-history/smite.mp4" type="video/mp4"/>
</video>
<p>The approach is taken from <a href="https://stackoverflow.com/a/63494771/371228">this Stack Overflow answer</a> by Marlon Richert, who later wrote a zsh plugin called <a href="https://github.com/marlonrichert/zsh-hist">zsh-hist</a> to make the history system easier to deal with. (I haven’t tried the plugin, but it seems to make it possible to delete the history entry with a given number, which is the omission in zsh that prevents multi-line commands from being easy to delete.)</p>
<hr/>
<p>Even if my zsh code isn’t relevant to you, I hope you’ve taken a moment to consider what you want out of your shell history and if there’s anything you could tweak to get closer to that.</p>
<p>Since adding this function to my zshrc, I’ve been paying more attention to which commands are misfires, and pruning the ones that are. If my history file is never quite going to be a beautiful garden, I can at least put more effort into removing the weeds.</p>
</div></div>
  </body>
</html>
