<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://den.dev/blog/spotify-wrapped/">Original</a>
    <h1>Behind the Spotify Wrapped API scenes</h1>
    
    <div id="readability-page-1" class="page"><div role="main"><section><article><header><h4>Understanding the components to the Spotify Wrapped generated story.</h4><p>By Den Delimarsky in <a href="https://den.dev/categories/hackery">Hackery</a></p><p>December 2, 2021</p></header><section><p>Every year (unless you’re one of those Apple Music people) music fans rejoice to get their <a href="https://www.spotify.com/us/wrapped/">Spotify Wrapped</a>, or - the musical year in review. It’s a fun way to explore the most frequently listened to songs and artists. And every year up until this one, if memory serves me right, the experience could be viewed in the browser. And then, I paid the site a visit in the year 2021.</p><p><img src="https://cdn.den.dev/images/postmedia/spotify-wrapped/wrapped-in-browser.png" alt="Screenshot of the Spotify Wrapped site"/></p><p>Well that’s a bummer, but I wonder if there is some special technical magic that they absolutely need to do client-side that cannot be rendered in the browser? Surely this is not just an elaborate scheme to get people to engage with the mobile app.</p><p>To roleplay as Sherlock Holmes, I decided to count on my trusted friends:</p><ol><li>An iPhone device, where the Spotify app was installed.</li><li>Fiddler on my Windows developer box (or <code>mitmproxy</code> <a href="https://den.dev/blog/intercepting-iphone-traffic-on-a-mac-a-how-to-guide/">if you are a macOS person</a>).</li><li>A self-signed certificate that allows me to decrypt local HTTPS traffic.</li><li>A lunch break.</li></ol><p>As I was trying to explore this, I was hoping that Spotify does not do <a href="https://security.stackexchange.com/questions/29988/what-is-certificate-pinning">certificate pinning</a>, since that would foil my plans. Spoiler alert - they don’t. But as it turns out, I was quite naive in assuming that things will just run right away. After <a href="https://docs.telerik.com/fiddler-everywhere/get-started/mobile-traffic/configure-ios">configuring the Fiddler certificate</a> with an iOS 15 device, I still could not capture <em>any</em> HTTPS traffic. It threw me off a bit because I was thinking that maybe between me deciding to write this blog post and putting my hands on the keyboard Spotify actually implemented certificate pinning. Something about Fiddler didn’t work well with iOS despite all the trust settings, so I switched to using <code>mitmproxy</code> inside <a href="https://docs.microsoft.com/en-us/windows/wsl/install">WSL</a>.</p><p>After a bit of configuration, I was up and running, and inspecting traffic like usual:</p><p><img src="https://cdn.den.dev/images/postmedia/spotify-wrapped/mitm-proxy-spotify.jpg" alt="Screenshot of mitmproxy inside Windows Subsystem for Linux"/></p><p>First thing that caught my eye was a request to the CDN that was pulling something of type <code>video/MP2T</code> - could I have struck gold that fast? I quickly grabbed the URL, which had the form of:</p><div><div><table><tbody><tr><td><pre><code><span>1
</span></code></pre></td><td><pre><code data-lang="http"><span>https://video-akpcw-cdn-spotify-com.akamaized.net/segments/v1/origins/{FIRST_ID}/sources/{SOME_ID}/encodings/{ANOTHER_ID}/profiles/17/4.ts?token=SOME_TOKEN&amp;token_ak=st=UNIX_TIMESTAMP_1~exp=UNIX_TIMESTAMP_2~acl=*/encodings/{SOME_ID}/*~hmac=HMAC_SIGNATURE
</span></code></pre></td></tr></tbody></table></div></div><p>Fortunately it seems from the UNIX timestamps included in the <code>token_ak</code> string, which, by the way, is <a href="https://github.com/kaltura/nginx-akamai-token-validate-module/issues/16">an Akamai token</a>, that the token is long-lived (I can use it at least for 7 days). I grabbed the URL, threw it in <code>curl</code> and saw a <code>.ts</code> file land on disk. Great! Upon opening it, though, nothing really exciting showed up.</p><p><img src="https://cdn.den.dev/images/postmedia/spotify-wrapped/video-spotify.gif" alt="Example of a Spotify Wrapped video"/></p><p>Alright, so let’s continue to dig. I restarted the app a couple of times because some of the requests seemed to be cached, and therefore I wasn’t going anywhere when I tried launching the story. And then, I saw this:</p><p><img src="https://cdn.den.dev/images/postmedia/spotify-wrapped/mitm-proxy-gold.jpg" alt="Screenshot of mitmproxy inside Windows Subsystem for Linux that shows a request in focus"/></p><p>Bingo! There’s a request to:</p><div><div><table><tbody><tr><td><pre><code><span>1
</span></code></pre></td><td><pre><code data-lang="http"><span>https://spclient.wg.spotify.com/campaigns-service/v1/campaigns/wrapped/consumer
</span></code></pre></td></tr></tbody></table></div></div><p>This request has a bunch of headers attached to it, which is great, but the most important is <code>Authorization</code> which is just a bearer token that you can grab by inspecting your local Spotify traffic (even from a desktop client). Running a <code>GET</code> request against this endpoint returned something interesting - the content type is <code>application/protobuf</code>. I haven’t worked with ProtoBufs since my foray into <a href="https://den.dev/blog/free-nest-video-recording/">the Nest camera internals</a>, so this was an exciting opportunity to re-familiarize myself with the tooling.</p><p>Because I didn’t want to write any code, I thought I would leverage <a href="https://grpc.io/docs/protoc-installation/"><code>protoc</code></a> to decode the data. If you’re on a Debian system (or inside Ubuntu in WSL), you can run:</p><div><div><table><tbody><tr><td><pre><code><span>1
</span></code></pre></td><td><pre><code data-lang="bash">sudo apt-get install protobuf-compiler
</code></pre></td></tr></tbody></table></div></div><p>Once installed, I can download the binary data through <code>curl</code>:</p><div><div><table><tbody><tr><td><pre><code><span>1
</span></code></pre></td><td><pre><code data-lang="bash">curl --location --request GET <span>&#39;https://spclient.wg.spotify.com/campaigns-service/v1/campaigns/wrapped/consumer&#39;</span> --header <span>&#39;Authorization: YOUR_BEARER_TOKEN&#39;</span> --output data.proto
</code></pre></td></tr></tbody></table></div></div><p>And lastly, I now decode the raw message:</p><div><div><table><tbody><tr><td><pre><code><span>1
</span></code></pre></td><td><pre><code data-lang="bash">protoc --decode_raw &lt; data.proto
</code></pre></td></tr></tbody></table></div></div><p>What do you know! The structured response for all Spotify Wrapped scenes:</p><p><img src="https://cdn.den.dev/images/postmedia/spotify-wrapped/spotify-protobuf.gif" alt="Example of structured data behind Spotify Wrapped"/></p><p>As it turns out, there is <em>very little</em> video media behind the scenes. Most behaviors are encoded in this ProtoBuf payload. If you are adventurous enough, you can even go as far as reconstruct your own Spotify Wrapped experience.</p><h2 id="conclusion">Conclusion</h2><p>Given that this is just structured data behind the scenes, it will remain a puzzle as to why Spotify decided not to enable Wrapped in the browser. However, it seems that the content in the ProtoBuf payload is just enough (including the preview MP3 audio, which is 96kbps and public) to build a custom experience in any environment.</p></section><div><div><p><h2>Feedback</h2></p><p>Have any thoughts? Let me know <a href="https://twitter.com/denniscode">on Twitter</a>!</p></div></div></article></section></div></div>
  </body>
</html>
