<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/EtcGlobHistory">Original</a>
    <h1>The history and use of /etc./glob in early Unixes</h1>
    
    <div id="readability-page-1" class="page"><div><h2>The history and use of <code>/etc/glob</code> in early Unixes</h2>

	<p><small>January 12, 2025</small></p>
</div><div><p>One of the innovations that the V7 Bourne shell introduced was built
in shell wildcard globbing, which is to say expanding things like
<code>*</code>, <code>?</code>, and so on. Of course Unix had shell wildcards well
before V7, but in V6 and earlier, the shell didn&#39;t implement globbing
itself; instead this was delegated to an external program, <code>/etc/glob</code>
(this affects things like <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/WildcardAnnoyance">looking into the history of Unix shell
wildcards</a>, because you have to know to look at
the <code>glob</code> source, not the shell).</p>

<p>As covered in places like <a href="https://www.tuhs.org/cgi-bin/utree.pl?file=V6/usr/man/man8/glob.8">the V6 glob(8) manual page</a>, the
<code>glob</code> program was passed a command and its arguments (already split
up by the shell), and went through the arguments to expand any
wildcards it found, then exec()&#39;d the command with the now expanded
arguments. The shell operated by scanning all of the arguments for
(unescaped) wildcard characters. If any were found, the shell exec&#39;d
/etc/glob with the whole show; otherwise, it directly exec()&#39;d the
command with its arguments. Quoting wildcards used a hack that
will be discussed later.</p>

<p>This basic /etc/glob behavior goes all the way back to Unix V1,
where we have <a href="https://www.tuhs.org/cgi-bin/utree.pl?file=V1/sh.s">sh.s</a>
and in it we can see that invocation of /etc/glob. In V2, glob is
one of the programs that have been rewritten in C (<a href="https://www.tuhs.org/cgi-bin/utree.pl?file=V2/cmd/glob.c">glob.c</a>), and
in V3 we have a <a href="https://www.tuhs.org/cgi-bin/utree.pl?file=V3/man/man1/sh.1">sh.1</a> that
mentions <code>/etc/glob</code> and has an interesting BUGS note about it:</p>

<blockquote><p>If any argument contains a quoted &#34;*&#34;, &#34;?&#34;, or &#34;[&#34;, then all
instances of these characters must be quoted. This is because <code>sh</code>
calls the <code>glob</code> routine whenever an unquoted &#34;*&#34;, &#34;?&#34;, or &#34;[&#34; is
noticed; the fact that other instances of these characters occurred
quoted is not noticed by <code>glob</code>.</p>
</blockquote>

<p>This section has disappeared in <a href="https://www.tuhs.org/cgi-bin/utree.pl?file=V4/man/man1/sh.1">the V4 sh.1 manual page</a>, which
suggests that the V4 shell and /etc/glob had acquired the hack they
use in V5 and V6 to avoid this particular problem.</p>

<p>How escaping wildcards works in the V5 and V6 shell is that all
characters in commands and arguments are restricted to being seven-bit
ASCII. The shell and /etc/glob both use the 8th bit to mark quoted
characters, which means that such quoted characters don&#39;t match
their unquoted versions and won&#39;t be seen as wildcards by either
the shell (when it&#39;s deciding whether or not it needs to run
/etc/glob) or by /etc/glob itself (when it&#39;s deciding what to
expand). However, obviously neither the shell nor /etc/glob can
pass such &#39;marked as quoted&#39; characters to actual commands, so each
of them strips the high bit from all characters before exec()&#39;ing
actual commands.</p>

<p>(This is clearer in <a href="https://www.tuhs.org/cgi-bin/utree.pl?file=V5/usr/source/s1/glob.c">the V5 glob.c source</a>; look
for how <code>cat()</code> ands every character with octal 0177 (0x7f) to drop
the high bit. You can also see it in <a href="https://www.tuhs.org/cgi-bin/utree.pl?file=V5/usr/source/s2/sh.c">the V5 sh.c source</a>, where
you want to look at <code>trim()</code>, and also the #define for &#39;<code>quote</code>&#39; at the
start of sh.c and how it&#39;s used later.)</p>

<p>PS: I don&#39;t know why expanding shell wildcards used a separate
program in V6 and earlier, but part of it may have been to keep the
shell smaller and more minimal so that it required less memory.</p>

<p>PPS: See also <a href="https://www.bsdcan.org/2015/schedule/attachments/306_srbBSDCan2015.pdf">Stephen R. Bourne&#39;s 2015 presentation from BSDCan</a>
[PDF], which has a bunch of interesting things on the V7 shell and
confirms that /etc/glob was there from V1.</p>
</div></div>
  </body>
</html>
