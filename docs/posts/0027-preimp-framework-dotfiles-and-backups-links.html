<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://scattered-thoughts.net/log/0027/">Original</a>
    <h1>0027: preimp, framework, dotfiles and backups, links</h1>
    
    <div id="readability-page-1" class="page"><article>
  <p>I got back to work Aug 8. The rest of the month has been blessedly uneventful.</p>
<h2 id="preimp">preimp</h2>
<p>I got as far as I could with the <a href="https://github.com/jamii/preimp/tree/last-clj-version">clj version</a>. </p>
<p>The main obstacle is provenance. The main feedback from the <a href="https://www.scattered-thoughts.net/writing/the-program-is-the-database-is-the-interface">essay</a> was that it would feel much more natural with direct manipulation. Why write code to make a toggle button for the status of a todo? Why can&#39;t you just click on the status and change it? </p>
<p>Doing that requires tracking, for each value, where in the source code it came from so that we can map edits back to that location. Doing this in clojurescript seems very difficult. Clojurescript&#39;s strings and numbers are just javascript strings and numbers. There is no way to attach any additional information to them. I could put wrapper objects around all strings and numbers in the source code, but then existing functions won&#39;t work on them. </p>
<p>Performance is also an issue. I used preimp to build an accounting tool that we actually use, but we have to use it on my fancy laptop because on a $200 chromebook it takes multiple seconds to render a few months of transaction history.</p>
<p><img src="https://scattered-thoughts.net/log/0027/chromebook.png" alt=""/></p>
<p><a href="https://scattered-thoughts.net/log/0027/nested-tables.html">Here</a> is a static recreation of a page that even on a brand-new 12th gen i7 takes 250ms to render. Probably something about the nested tables makes layout super-linear, but the browser profiler just gives me a single box labelled &#34;layout&#34; with no further information.</p>
<p>The slow layout is compounded by the fact that having a codemirror editor in the layout often causes forced reflow of surrounding elements. I <em>think</em> this is something to do with the hacks that codemirror has to use to measure the size of text elements, since it can&#39;t just ask the browser to layout text in isolation. But I have no idea how to verify that theory or prevent the extra layouts.</p>
<p>Clojurescript is also slow in general. The self-hosted compiler takes a long time to compile small amounts of code eg 5ms for a single line of code on my new i7. The self-hosted compiler also doesn&#39;t do any optimizations, so the generated code is slower than regular clojurescript - running the below code over a vec of 790 transactions takes 4.6ms. Naturally all these times are much worse on a $200 chromebook.</p>
<pre data-lang="clj"><code data-lang="clj"><span>(def </span><span>untagged 
</span><span>  (into [] 
</span><span>    (for [transaction transactions 
</span><span>          </span><span>:when </span><span>(nil? (</span><span>:tag </span><span>transaction))] 
</span><span>      transaction)))
</span></code></pre>
<p>The performance issues are probably workable, but if I have to write something from scratch to get provenance anyway I might as well aim for less opaque performance while I&#39;m at it.</p>
<p>So this month I wrote a very crude tree-walking interpreter for a simple lispy language, and built a minimum-viable structured editor in <a href="https://github.com/ocornut/imgui">dear imgui</a>. It&#39;s a long way from usable but I have the direct manipulation working:</p>
<video controls="">
  <source src="/log/0027/preimp.mp4" type="video/mp4"/>
</video>
<p>In the video above you can see me defining some data, making a simple view over that data and then directly editing the output of the view. On hovering over a value in the output you can also see the highlight on the location in the source from which it originated. </p>
<p>(The video also demonstrates a perfectly useful interaction that breaks all of the <a href="https://www.cis.upenn.edu/%7Ebcpierce/papers/lenses-etapsslides.pdf">lens axioms</a>. I delete the first todo and when the view updates I see the next todo. In a well-formed lens deleting the first todo should leave me with a blank space where the first todo used to be. That makes almost all of the existing lens research useless for this kind of interaction! Similar disallowed interactions include opening a list of unread email and marking one of them as read, or changing the search in a search box and seeing the search results change. <code>get(putback(l, v)) == v</code> seems like a totally reasonable rule that noone could disagree with, and yet when you apply it to everyday GUI patterns it breaks everything.)</p>
<p>There isn&#39;t enough of a language yet to recreate the accounting app, but I very roughly compared the frontend performance by just pasting <a href="https://scattered-thoughts.net/log/0027/data.txt">this output</a> into both. </p>
<p>In the cljs + html version:</p>
<ul>
<li>The frame where I hit eval takes 427ms total, which breaks down into:
<ul>
<li>160ms in javascript
<ul>
<li>25ms to parse and eval the input</li>
<li>145ms in reagent and react</li>
</ul>
</li>
<li>64 ms in recalculate style</li>
<li>150 ms in layout</li>
<li>42 ms in pre-paint</li>
</ul>
</li>
<li>The frame immediately beforehand takes 267ms.
<ul>
<li>The overall breakdown is similar, except that all the javascript time is spent in codemirror.</li>
<li>The layout in this frame is marked as forced reflow, I believe caused by codemirror.</li>
</ul>
</li>
<li>With no inputs, remaining frames take fractions of a millisecond</li>
<li>If I scroll down, I get frequent dropped frames during 300ms+ intervals where nothing appears to be happening:</li>
</ul>
<p><img src="https://scattered-thoughts.net/log/0027/scrolling.png" alt=""/></p>
<p>In the zig + dear imgui version it takes:</p>
<ul>
<li>7ms to parse the input</li>
<li>15ms to evaluate the input</li>
<li>8-12ms to draw and render each frame, regardless of scrolling</li>
</ul>
<p>Of the two, the html version is the one where I&#39;ve spent a bunch of time trying to understand and improve the performance. In the dear imgui version I&#39;ve done the easiest possible thing at every step and the performance is still fine.</p>
<p>And I know that dear imgui can&#39;t do all the things that html can, but it can do all the things I need to do to test out research prototypes and it does them without requiring any mental contortions or trial-and-error debugging from me. </p>
<p>When I was confused by how the layout was behaving, I stepped through the layout code in a debugger. If I have performance problems in the future, I&#39;ll be able to profile the layout code in detail rather than being presented with a single box saying &#34;layout&#34;. And while the documentation is poor-to-none the code itself is pretty readable, so I just jump-to-definitioned whenever I was confused. Being able to print out the internal state of the layout engine was also pretty handy.</p>
<h2 id="framework">framework</h2>
<p>My old dell precision 5510 is still mostly working after a little over six years. The speakers died in the first year, but I don&#39;t really need them. The left shift key cracked in half, but it still works. Two years ago a 1 foot drop onto a soft cushion caused the hinges to snap away from the tiny piece of internal plastic that held them in place, breaking off part of the case and bending all the connectors on the right side of the motherboard. But replacing both the <a href="https://www.parts-people.com/index.php?action=item&amp;id=21454">case</a> and <a href="https://www.parts-people.com/index.php?action=category&amp;id=142&amp;subid=561&amp;refine=motherboard">motherboard</a> would be pricey so I just applied duct tape and lived without the right-hand ports. Finally, this year the 3rd battery is totally exhausted and I have a battery life of about 11 seconds - short enough that sometimes the power cable falls out and my laptop dies before I can get it back in. I priced out a full repair at ~900 CAD of parts, including shipping and tax. Which is pretty reasonable, especially since the vast majority of the cost is the motherboard.</p>
<p>Instead I was seduced by one of the <a href="https://frame.work/">12th gen framework laptops</a>. Definitely an unneccesary upgrade, but one that I&#39;ve enjoyed. </p>
<p>The aluminium outer case covers the side of laptop, where the dell had a plastic edge that broke with the hinges. The hinges themselves are attached to a metal part on the lower frame, rather than the thin plastic screwon in the dell, and the lever is much longer which should reduce the force on that internal connection. The ports at the side are sacrificial - the actual connection to the motherboard is deeper in the frame where it seems well protected from bending. An accident of the kind that crippled my old laptop looks like it would be a minor repair here.</p>
<p>I&#39;m not confident that framework will still be around selling replacement parts six years from now, whereas dell will probably still have a few dusty 5510 batteries left in stock long after I die. But I want framework to succeed, and I feel happy taking a risk on them.</p>
<p>Also I won&#39;t drop this one.</p>
<h2 id="dotfiles-and-backups">dotfiles and backups</h2>
<p>Setting up a new laptop prompted me to find a nicer way to manage all the random crap in /home/jamie that I can&#39;t make public. </p>
<p>The solution I settled on is to make /home/jamie a git repo with:</p>
<pre data-lang="bash"><code data-lang="bash"><span>&gt;</span><span> cat </span><span>.gitignore
</span><span>/*
</span><span>!</span><span>.bash_profile
</span><span>!</span><span>.bashrc
</span><span>!</span><span>bin
</span><span>!</span><span>.config/
</span><span>.config/*
</span><span>!</span><span>.config/alacritty
</span><span>!</span><span>.config/fish
</span><span>!</span><span>.config/nixpkgs
</span><span>!</span><span>secret
</span><span>!</span><span>.gitconfig
</span><span>!</span><span>.gitignore
</span><span>!</span><span>.ssh
</span><span>!</span><span>.sway
</span><span>!</span><span>tax
</span><span>!</span><span>.gdbinit
</span><span>!</span><span>.mbsyncrc
</span><span>!</span><span>.newsboat
</span><span>!</span><span>texts
</span><span>!</span><span>tower
</span><span>!</span><span>.mozilla/firefox/o6svvwi3.dev-edition-default/chrome/userChrome.css
</span><span>!</span><span>.mozilla/firefox/o6svvwi3.dev-edition-default/logins.json
</span><span>zig-cache
</span><span>zig-out‚èé 
</span></code></pre>
<p>That ignores everything except folders that I explictly track, but doesn&#39;t require me to individually add every new file in those folders.</p>
<p>I commit with:</p>
<pre data-lang="bash"><code data-lang="bash"><span>&gt;</span><span> cat </span><span>bin/mu
</span><span>#!/usr/bin/env bash
</span><span>(</span><span>git</span><span> add ./ </span><span>&amp;&amp; </span><span>git</span><span> commit</span><span> -am </span><span>&#39;Mu&#39;</span><span>) </span><span>|| </span><span>true
</span></code></pre>
<p>I don&#39;t push the repo anywhere, because it seems weird to send all my ssh keys to 3rd party. But I do encrypted backups to <a href="https://www.tarsnap.com/">tarsnap</a> with:</p>
<pre data-lang="bash"><code data-lang="bash"><span>&gt;</span><span> cat </span><span>bin/backup-remote
</span><span>#!/usr/bin/env bash
</span><span>
</span><span>set </span><span>-ex
</span><span>
</span><span>cd </span><span>~
</span><span>mu
</span><span>git</span><span> ls-files</span><span> -z </span><span>| </span><span>xargs</span><span> -0 </span><span>\
</span><span>  tarsnap</span><span> -c </span><span>\
</span><span>    --cachedir</span><span> /home/jamie/tarsnap </span><span>\
</span><span>    --keyfile</span><span> /home/jamie/secret/tarsnap.key </span><span>\
</span><span>    -f </span><span>$HOSTNAME-`</span><span>date</span><span> +%Y-%m-%d_%H-%M-%S`
</span></code></pre>
<p>And very occasionally backup to two usb sticks:</p>
<pre data-lang="bash"><code data-lang="bash"><span>&gt;</span><span> cat </span><span>bin/backup-local
</span><span>#!/usr/bin/env bash
</span><span>
</span><span>set </span><span>-ex
</span><span>
</span><span>cd </span><span>~
</span><span>mu
</span><span>cd</span><span> /run/media/jamie/$(</span><span>ls</span><span> /run/media/jamie/)/$HOSTNAME
</span><span>git</span><span> pull </span><span>~
</span></code></pre>
<p>One usb stick lives on my keychain and the other with all my important paperwork. I should probably encrypt them.</p>
<p>I run <code>backup-remote</code> at the end of <code>.bash_profile</code> so that it starts when my laptop turns on and is finished by the time I start doing any serious work.</p>
<p>I have daily tarsnap backups going back 3 years. It typically costs me $2/month so I&#39;ve never bothered cleaning up old archives.</p>
<h2 id="links">links</h2>
<p>Weather in the mountains in BC is wildly unpredictable. Often the official forecast will tell me that it&#39;s sunny all day <em>while I&#39;m being rained on</em>. Once I got snowed on for an hour, from a totally blue sky on a sunny day. </p>
<p>I found a weather app called <a href="https://www.flowx.io/">flowx</a> that is far better than any other I&#39;ve tried. It can show forecasts from all available models side-by-side (useful as a kind of error bar - on the days where all the forecasts agree they&#39;re usually accurate). It shows hi-res models (useful for when it&#39;s only raining on some of the crags). It can show actual weather for the past 3 days and the angle of the sun at various times (useful for judging which crags will have dried out). It syncs when it can but also works with stale data offline. The free version is already very useful but I was plenty happy to give them $2/month to unlock all the extra models.</p>
<hr/>
<p><a href="https://counterexamples.org/intro.html">Counterexamples in type systems</a> is a collection of interesting soundness bugs in various type-systems. </p>
<p>Most educational material focuses on positive examples. But often the easiest way to understand the design of a system is to understand how it is trying to dodge all the flaws and cracks in it&#39;s predecessors.</p>
<hr/>
<p><a href="https://luau-lang.org/">Luau</a> is a fork of lua developed by Roblox that features <a href="https://luau-lang.org/typecheck">gradual typing</a>, <a href="https://luau-lang.org/sandbox">sandboxed execution</a> and <a href="https://luau-lang.org/performance">many interpreter optimizations</a>. </p>
<hr/>
<p><a href="https://munin.uit.no/bitstream/handle/10037/22344/thesis.pdf">Towards a General Database Management System of Conflict-Free Repli-
cated Relations</a> builds a CRDT layer underneath sqlite, so that application code can treat it like a regular sql database that just happens to do something sensible when syncing with other copies. </p>
<p>It&#39;s not clear how much of it is actually working at this point, but the idea is intriguing.</p>
<hr/>
<p>Many examples of <a href="https://www.gwern.net/docs/technology/2004-03-30-shirky-situatedsoftware.html">situated software</a> in this thread:</p>
<p><a href="https://twitter.com/Mappletons/status/1561357946960990213">https://twitter.com/Mappletons/status/1561357946960990213</a></p>

</article></div>
  </body>
</html>
