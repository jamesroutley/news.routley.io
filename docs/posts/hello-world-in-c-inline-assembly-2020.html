<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jameshfisher.com/2018/02/20/c-inline-assembly-hello-world/">Original</a>
    <h1>Hello world in C inline assembly (2020)</h1>
    
    <div id="readability-page-1" class="page"><div id="content"><p>Here’s an unusual “hello, world” in C:</p>
<pre><code><span>int</span> <span>main</span><span>(</span><span>void</span><span>)</span> <span>{</span>
  <span>register</span> <span>int</span>    syscall_no  <span>asm</span><span>(</span><span>&#34;rax&#34;</span><span>)</span> <span>=</span> <span>1</span><span>;</span>
  <span>register</span> <span>int</span>    arg1        <span>asm</span><span>(</span><span>&#34;rdi&#34;</span><span>)</span> <span>=</span> <span>1</span><span>;</span>
  <span>register</span> <span>char</span><span>*</span>  arg2        <span>asm</span><span>(</span><span>&#34;rsi&#34;</span><span>)</span> <span>=</span> <span>&#34;hello, world!\n&#34;</span><span>;</span>
  <span>register</span> <span>int</span>    arg3        <span>asm</span><span>(</span><span>&#34;rdx&#34;</span><span>)</span> <span>=</span> <span>14</span><span>;</span>
  <span>asm</span><span>(</span><span>&#34;syscall&#34;</span><span>)</span><span>;</span>
  <span>return</span> <span>0</span><span>;</span>
<span>}</span></code></pre>
<pre><code><span><span>$</span> <span>cc hello.c</span></span>
<span><span>$</span> <span>./a.out</span></span>
<span>hello, world!</span></code></pre>
<p>This C program doesn’t use any C standard library functions.
An ordinary “hello world” program might use <code>printf</code>,
ultimately making the <code>write</code> system call.
The above program bypasses this
and makes the system call more directly
using “inline assembly”.
This program works on Linux x86-64,
but because assembly is so non-portable,
probably doesn’t work on most other systems.</p>
<p>Inline assembly is written using the syntax form <code>asm(...)</code>.
The above program uses this in a couple of ways.
First, the statement <code>asm(&#34;syscall&#34;);</code>
injects a <code>syscall</code> assembly instruction
at that point in the program.
The <code>syscall</code> instruction expects a system call number in register <code>rax</code>.
The program arranges for <code>rax</code> to hold the value <code>1</code>,
the system call number for <code>write</code>.
It arranges this by declaring the local variable <code>syscall_no</code> as <code>register</code>,
and specifically marking this register variable to be stored in register <code>rax</code>
using <code>asm(&#34;rax&#34;)</code>.
The arguments for the <code>write</code> system call
are put in <code>rdi</code>, <code>rsi</code> and <code>rdx</code>
using the same feature.</p>
<p>In the statement <code>asm(&#34;syscall&#34;)</code>,
the string <code>&#34;syscall&#34;</code> is assembly in “gas” (GNU ASsembler) syntax.
We can write longer partions of assembly here.
For example, we can prepare the registers <code>rax</code>, <code>rdi</code> and <code>rdx</code>
using <code>mov</code> instructions instead of C variables:</p>
<pre><code><span>int</span> <span>main</span><span>(</span><span>void</span><span>)</span> <span>{</span>
  <span>register</span> <span>char</span><span>*</span> arg2 <span>asm</span><span>(</span><span>&#34;rsi&#34;</span><span>)</span> <span>=</span> <span>&#34;hello, world!\n&#34;</span><span>;</span>
  <span>asm</span><span>(</span><span>&#34;mov $1, %rax; mov $1, %rdi; mov $14, %rdx; syscall;&#34;</span><span>)</span><span>;</span>
  <span>return</span> <span>0</span><span>;</span>
<span>}</span></code></pre>
<p>Can we convert the <code>rsi</code> value to a <code>mov</code> instruction, too?
This is trickier, because we don’t know its exact value.
The value of <code>rsi</code> is the second argument to <code>write</code>,
a pointer to the bytes to be written.
So <code>rsi</code> should be given the pointer to the statically allocated string <code>&#34;hello, world!\n&#34;</code>.
How do we get that pointer value into our assembly code?
To do so,
we’ll need to switch to “extended <code>asm</code>”,
a more advanced feature which I’ll cover another time.</p>
<div><h3>Similar posts</h3><h3>More by Jim</h3><div><a href="https://jameshfisher.com/2020/11/01/what-does-the-dot-do-in-javascript/"><p>What does the dot do in JavaScript? </p><p><code>foo.bar</code>, <code>foo.bar()</code>, or <code>foo.bar = baz</code> - what do they mean? A deep dive into prototypical inheritance and getters/setters.  <span>2020-11-01</span></p></a><a href="https://jameshfisher.com/2020/08/06/smear-phishing-how-to-scam-an-android-user/"><p>Smear phishing: a new Android vulnerability </p><p>Trick Android to display an SMS as coming from any contact. Convincing phishing vuln, but still unpatched.  <span>2020-08-06</span></p></a><a href="https://jameshfisher.com/2020/04/26/jim-scoring-a-probabilistic-pub-quiz-for-nerds/"><p>A probabilistic pub quiz for nerds </p><p>A “true or false” quiz where you respond with your confidence level, and the optimal strategy is to report your true belief.  <span>2020-04-26</span></p></a><a href="https://jameshfisher.com/2020/03/14/time-is-running-out-to-catch-covid19/"><p>Time is running out to catch COVID-19 </p><p>Simulation shows it’s rational to deliberately infect yourself with COVID-19 early on to get treatment, but after healthcare capacity is exceeded, it’s better to avoid infection. Includes interactive parameters and visualizations.  <span>2020-03-14</span></p></a><a href="https://jameshfisher.com/2019/04/27/the-inception-bar-a-new-phishing-method/"><p>The inception bar: a new phishing method </p><p>A new phishing technique that displays a fake URL bar in Chrome for mobile. A key innovation is the “scroll jail” that traps the user in a fake browser.  <span>2019-04-27</span></p></a><a href="https://jameshfisher.com/2019/03/23/the-hacker-hype-cycle/"><p>The hacker hype cycle </p><p>I got started with simple web development, but because enamored with increasingly esoteric programming concepts, leading to a “trough of hipster technologies” before returning to more productive work.  <span>2019-03-23</span></p></a><a href="https://jameshfisher.com/2019/02/16/project-c-43-the-lost-origins-of-asymmetric-crypto/"><p>Project C-43: the lost origins of asymmetric crypto </p><p>Bob invents asymmetric cryptography by playing loud white noise to obscure Alice’s message, which he can cancel out but an eavesdropper cannot. This idea, published in 1944 by Walter Koenig Jr., is the forgotten origin of asymmetric crypto.  <span>2019-02-16</span></p></a><a href="https://jameshfisher.com/2019/01/26/how-hacker-news-stays-interesting/"><p>How Hacker News stays interesting </p><p>Hacker News buried my post on conspiracy theories in my family due to overheated discussion, not censorship. Moderation keeps the site focused on interesting technical content.  <span>2019-01-26</span></p></a><a href="https://jameshfisher.com/2019/01/20/my-parents-are-flat-earthers/"><p>My parents are Flat-Earthers </p><p>For decades, my parents have been working up to Flat-Earther beliefs. From Egyptology to Jehovah’s Witnesses to theories that human built the Moon billions of years in the future. Surprisingly, it doesn’t affect their successful lives very much. For me, it’s a fun family pastime.  <span>2019-01-20</span></p></a><a href="https://jameshfisher.com/2018/04/07/the-dots-do-matter-how-to-scam-a-gmail-user/"><p>The dots do matter: how to scam a Gmail user </p><p>Gmail’s “dots don’t matter” feature lets scammers create an account on, say, Netflix, with your email address but different dots. Results in convincing phishing emails.  <span>2018-04-07</span></p></a><a href="https://jameshfisher.com/2017/12/02/the-sorry-state-of-openssl-usability/"><p>The sorry state of OpenSSL usability </p><p>OpenSSL’s inadequate documentation, confusing key formats, and deprecated interfaces make it difficult to use, despite its importance.  <span>2017-12-02</span></p></a><a href="https://jameshfisher.com/2017/11/08/i-hate-telephones/"><p>I hate telephones </p><p>I hate telephones. Some rational reasons: lack of authentication, no spam filtering, forced synchronous communication. But also just a visceral fear.  <span>2017-11-08</span></p></a><a href="https://jameshfisher.com/2017/10/26/time-thought-and-typing/"><p>The Three Ts of Time, Thought and Typing: measuring cost on the web </p><p>Businesses often tout “free” services, but the real costs come in terms of time, thought, and typing required from users. Reducing these “Three Ts” is key to improving sign-up flows and increasing conversions.  <span>2017-10-26</span></p></a><a href="https://jameshfisher.com/2017/05/19/granddad-died-today/"><p>Granddad died today </p><p>Granddad died. The unspoken practice of death-by-dehydration in the NHS. The Liverpool Care Pathway. Assisted dying in the UK. The importance of planning in end-of-life care.  <span>2017-05-19</span></p></a><a href="https://jameshfisher.com/2017/02/17/how-do-i-call-a-program-in-c-with-pipes/"><p>How do I call a program in C, setting up standard pipes? </p><p>A C function to create a new process, set up its standard input/output/error pipes, and return a struct containing the process ID and pipe file descriptors.  <span>2017-02-17</span></p></a><a href="https://jameshfisher.com/2014/05/11/your-syntax-highlighter-is-wrong/"><p>Your syntax highlighter is wrong </p><p>Syntax highlighters make value judgments about code. Most highlighters judge that comments are cruft, and try to hide them. Most diff viewers judge that code deletions are bad.  <span>2014-05-11</span></p></a></div><div><p>Want to build a fantastic product using LLMs? I work at <strong><a href="https://granola.so" target="_blank">Granola</a></strong> where we&#39;re building the future IDE for knowledge work. Come and work with us! <a href="https://jobs.granola.so/" target="_blank">Read more</a> or <strong><a href="mailto:team@granola.so?subject=Let%27s+work+together%21&amp;body=Hey+team%2C%0A%0A">get in touch!</a></strong></p></div></div><p> This page copyright James Fisher 2018. Content is not associated with my employer.<span> <a href="https://github.com/jameshfisher/jameshfisher.com/edit/master/_posts/2018-02-20-c-inline-assembly-hello-world/index.md">Found an error? Edit this page.</a></span></p></div></div>
  </body>
</html>
