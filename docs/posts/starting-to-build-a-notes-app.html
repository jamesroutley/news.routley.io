<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://zachahn.com/posts/1707698713">Original</a>
    <h1>Starting to build a notes app</h1>
    
    <div id="readability-page-1" class="page"><div>
    <div>
      
      <p>I was recently using a note-taking app. I liked it, but I got pretty frustrated by its syncing feature—it kept on deleting and overwriting my notes as I was switching between my computer and phone! So I started wondering to myself, what’ll it take to make a something that syncs a little better?</p>
<p>I decided to investigate <a href="https://automerge.org">Automerge</a>, a CRDT library. I briefly considered <a href="https://yjs.dev">Yjs</a>, but disqualified it as an option since their Rust port, Yrs, used <code>unsafe</code> pretty liberally. This was a little disappointing since Yjs generally performed better in benchmarks. Rust support is important to me since the Rust port is likely to be the source of most of their bindings to other languages.</p>
<p>I wanted to build towards building cross-platform native apps, but I decided to use a web-based text editor. I decided to look into <a href="https://prosemirror.net">ProseMirror</a>. It seems to be a very mature and popular one.</p>
<p>So to conclude my introduction, I wanted:</p>
<ul>
<li>Fully offline editing</li>
<li>Conflict free syncing</li>
<li>Native and cross-platform apps, focusing on macOS and iOS</li>
<li>Eventually:
<ul>
<li>E2E encryption</li>
<li>Append-only CLI interface</li>
</ul>
</li>
</ul>
<hr/>
<p>I asked for some tips with building native apps in Swift, and a fellow Recurser said that he often builds separate spikes when building apps in Xcode, so I took that advice here.</p>
<p>My first question was around embedding ProseMirror inside a native SwiftUI app. How hard would it be? Would it be fast enough?</p>
<p>I was pleasantly surprised about how simple it was. I won’t go into details, but right now, I’m:</p>
<ul>
<li>Using a <code>WKWebView</code> to display the editor</li>
<li>Wrapping the web view inside a SwiftUI view</li>
<li>Wrapping that web view inside a <code>NavigationSplitView</code> for a nice navigation UI</li>
<li>Using esbuild to build the front end files</li>
<li>Packaging the files into the app so it runs offline</li>
</ul>
<p><img src="https://zachahn.com/files/3c34a2f49b610b4eb5ba67094a2e2f60" alt="Screenshot of a text editor with minimal styling, running in an iOS simulator"/></p>
<p>With that I got an ugly editor to show up! I already have some experience with building native apps that need communication between JavaScript and native code, so I’m not too worried about that part right now. Things seemed fast enough and natural enough—I’m pretty sure I can style the UI to look like the system UI when it’s time to make things look nice. This answered most of my questions around the text editor in a native app.</p>
<p>So that’s it for this spike. My next big question was around using Automerge. But for now, here are some code snippets. I’m zooming through here, but there’s very little that’s particularly innovative. I found it pretty difficult sometimes to work only with code snippets, so I hope that the full source code of these files are helpful!</p>
<h3>Wrappers for iOS/macOS compatibility</h3>
<div><pre><code><span>//</span>
<span>//  Representable.swift</span>
<span>//  ProsemirrorWrapper</span>
<span>//</span>
<span>//  Created by Zach Ahn on 2/1/24.</span>
<span>//</span>

<span>import</span> <span>SwiftUI</span>

<span>#if os(iOS)</span>
    <span>typealias</span> <span>UnitedRepresentableView</span> <span>=</span> <span>UIViewRepresentable</span>
<span>#elseif os(macOS)</span>
    <span>typealias</span> <span>UnitedRepresentableView</span> <span>=</span> <span>NSViewRepresentable</span>
<span>#endif</span>
</code></pre></div>
<p>The sample below includes some code to inject some JavaScript into the web view. It isn’t super important, but I left it there in case a full example was helpful.</p>
<p>I have a folder called <code>EditorSource</code> where I put in my JS, and a build folder called <code>Editor</code>. Here’s a visual representation of what it looks like on Xcode</p>
<p>Below, I’m referencing this exact <code>Editor</code> directory and telling the WebView to load it.</p>
<div><pre><code><span>//</span>
<span>//  EditorWebView.swift</span>
<span>//  ProsemirrorWrapper</span>
<span>//</span>
<span>//  Created by Zach Ahn on 1/31/24.</span>
<span>//</span>

<span>import</span> <span>SwiftUI</span>
<span>import</span> <span>WebKit</span>

<span>class</span> <span>EditorScriptMessageHandler</span><span>:</span> <span>NSObject</span><span>,</span> <span>WKScriptMessageHandler</span> <span>{</span>
    <span>override</span> <span>init</span><span>()</span> <span>{</span>
        <span>super</span><span>.</span><span>init</span><span>()</span>
    <span>}</span>

    <span>func</span> <span>userContentController</span><span>(</span><span>_</span><span>:</span> <span>WKUserContentController</span><span>,</span> <span>didReceive</span> <span>_</span><span>:</span> <span>WKScriptMessage</span><span>)</span> <span>{</span>
        <span>// TODO:</span>
    <span>}</span>
<span>}</span>

<span>struct</span> <span>EditorWebView</span><span>:</span> <span>UnitedRepresentableView</span> <span>{</span>
    <span>func</span> <span>makeView</span><span>()</span> <span>-&gt;</span> <span>WKWebView</span> <span>{</span>
        <span>let</span> <span>configuration</span> <span>=</span> <span>WKWebViewConfiguration</span><span>()</span>
        <span>let</span> <span>scriptMessageHandler</span> <span>=</span> <span>EditorScriptMessageHandler</span><span>()</span>
        <span>let</span> <span>controller</span> <span>=</span> <span>WKUserContentController</span><span>()</span>

        <span>let</span> <span>scriptBody</span> <span>=</span> <span>&#34;&#34;&#34;
        console.log(&#34;</span><span>Hello</span> <span>From</span> <span>The</span> <span>App</span><span>&#34;);
        &#34;&#34;&#34;</span>
        <span>let</span> <span>script</span> <span>=</span> <span>WKUserScript</span><span>(</span><span>source</span><span>:</span> <span>scriptBody</span><span>,</span> <span>injectionTime</span><span>:</span> <span>.</span><span>atDocumentEnd</span><span>,</span> <span>forMainFrameOnly</span><span>:</span> <span>true</span><span>)</span>
        <span>controller</span><span>.</span><span>addUserScript</span><span>(</span><span>script</span><span>)</span>
        <span>controller</span><span>.</span><span>add</span><span>(</span><span>scriptMessageHandler</span><span>,</span> <span>name</span><span>:</span> <span>&#34;sizeNotification&#34;</span><span>)</span>

        <span>configuration</span><span>.</span><span>userContentController</span> <span>=</span> <span>controller</span>

        <span>let</span> <span>wkwebView</span> <span>=</span> <span>WKWebView</span><span>(</span><span>frame</span><span>:</span> <span>.</span><span>zero</span><span>,</span> <span>configuration</span><span>:</span> <span>configuration</span><span>)</span>
        <span>#if DEBUG</span>
            <span>wkwebView</span><span>.</span><span>isInspectable</span> <span>=</span> <span>true</span>
        <span>#endif</span>
        <span>let</span> <span>url</span> <span>=</span> <span>Bundle</span><span>.</span><span>main</span><span>.</span><span>url</span><span>(</span><span>forResource</span><span>:</span> <span>&#34;index&#34;</span><span>,</span> <span>withExtension</span><span>:</span> <span>&#34;html&#34;</span><span>,</span> <span>subdirectory</span><span>:</span> <span>&#34;Editor&#34;</span><span>)</span><span>!</span>
        <span>wkwebView</span><span>.</span><span>loadFileURL</span><span>(</span><span>url</span><span>,</span> <span>allowingReadAccessTo</span><span>:</span> <span>url</span><span>)</span>

        <span>return</span> <span>wkwebView</span>
    <span>}</span>

    <span>#if os(iOS)</span>
        <span>func</span> <span>makeUIView</span><span>(</span><span>context</span> <span>_</span><span>:</span> <span>Context</span><span>)</span> <span>-&gt;</span> <span>WKWebView</span> <span>{</span>
            <span>makeView</span><span>()</span>
        <span>}</span>

        <span>func</span> <span>updateUIView</span><span>(</span><span>_</span><span>:</span> <span>WKWebView</span><span>,</span> <span>context</span> <span>_</span><span>:</span> <span>Context</span><span>)</span> <span>{}</span>
    <span>#elseif os(macOS)</span>
        <span>public</span> <span>func</span> <span>makeNSView</span><span>(</span><span>context</span> <span>_</span><span>:</span> <span>Context</span><span>)</span> <span>-&gt;</span> <span>WKWebView</span> <span>{</span>
            <span>makeView</span><span>()</span>
        <span>}</span>

        <span>public</span> <span>func</span> <span>updateNSView</span><span>(</span><span>_</span><span>:</span> <span>WKWebView</span><span>,</span> <span>context</span> <span>_</span><span>:</span> <span>Context</span><span>)</span> <span>{}</span>
    <span>#endif</span>
<span>}</span>

<span>#Preview {</span>
    <span>EditorWebView</span><span>()</span>
<span>}</span>
</code></pre></div>

    </div>
  </div></div>
  </body>
</html>
