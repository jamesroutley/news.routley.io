<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://f-droid.org/2023/03/01/new-repo-format-faster-smaller-updates.html">Original</a>
    <h1>New F-Droid repository format for faster and smaller updates</h1>
    
    <div id="readability-page-1" class="page"><div>

      


      <div>

        <div>
          <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p>We just released version <code>1.16</code> of the official F-Droid client app for
Android which includes many radical changes under the hood as well as many
bug fixes for long standing issue.  Read on for more details.</p>

<h2 id="growing-repository-size">Growing repository size</h2>

<p>As more and more apps make their way into F-Droid, the official repository
index that includes all apps and their metadata also keeps growing.
Currently, the size of the compressed index is <code>8 MB</code> which is <code>33 MB</code>
uncompressed.  When updating the repository index, each F-Droid client app
has to download and process those <code>8MB</code> again and again.  This problematic
trend became apparent <a href="https://gitlab.com/fdroid/fdroidclient/-/issues/649">a long time
ago</a>.</p>

<h2 id="updating-only-what-has-changed">Updating only what has changed</h2>

<p>Our repository index is in JSON format and we decided to make use of <a href="https://datatracker.ietf.org/doc/html/rfc7396">RFC
7396 JSON Merge Patch</a>  to
create much smaller JSON files that only contain the changes since your
F-Droid app last updated.  Technically, this works by downloading a new
<a href="https://f-droid.org/repo/entry.json"><code>entry.json</code></a> file instead of the full
index.  This entry file points to the full index in case the app had never
updated before and needs all app metadata anyway.  But the entry also
contains pointers to various smaller <em>diff</em>erence files.  The app
automatically picks the right diff and only downloads that much smaller file
instead of the full index.  This not only saves bandwidth, it also makes
updating the index much faster as only the minimum amount of data needs to
be downloaded, processed and stored.  As of writing, the latest diff is <code>80
KB</code> compressed which is <code>241 KB</code> uncompressed which is only <code>1%</code> of the full
index.  Version <code>1.16</code> of the official F-Droid client app for Android
supports this new repository format.</p>

<h2 id="other-improvements">Other improvements</h2>

<p>The new version has a large number of radical changes under the hood.  For
example, the entire database had to be replaced to support the new
difference based repository format.  We also used the opportunity to improve
various bit and pieces along the way:</p>

<ul>
  <li>improved mirror support: all files (e.g. images) now get loaded from
mirrors reducing the load on the main server</li>
  <li>better support for low RAM devices, because the index now gets streamed
into the DB instead of loading all of it into memory</li>
  <li>hash verification: The SHA256 hash of <em>all</em> files is now part of the
repository metadata and gets verified while downloading</li>
  <li>stronger digest algorithm for repository signing: We now use SHA256
instead of SHA1 for the index signature</li>
  <li>support for downloading repository files via IPFS</li>
  <li>many bug fixes that came out of modernizing ancient code</li>
</ul>

<p>The new version went through <a href="https://f-droid.org/en/2022/11/30/upcoming-alpha-release-of-f-droid-client.html">a series of alpha releases</a>  with
extended testing to make sure no severe issues make it into the stable
release.  It is now considered ready for general use.</p>

<h2 id="information-for-repository-and-client-maintainers">Information for repository and client maintainers</h2>

<p>Owners of third-party F-Droid repositories can enable the new format by
upgrading to the latest version of
<a href="https://gitlab.com/fdroid/fdroidserver">fdroidserver</a> which will
automatically publish the new format in addition to the old ones which we
keep around to support older client apps.</p>

<p>Developers of third-party F-Droid clients are encouraged to adopt the new
format either with their own implementations or by making use of the <a href="https://gitlab.com/fdroid/fdroidclient/-/tree/master/libs#f-droid-libraries">new
libraries</a>
we are publishing to make using this technology as easy as possible and to
share as much code as possible between different F-Droid implementations.</p>

<p><em>This work was funded by the <a href="https://f-droid.org/en/2022/02/05/decentralizing-distribution.html">FFDW-DVD grant</a></em></p>

  </div>

</article>

        </div>

        

      </div>

      


    </div></div>
  </body>
</html>
