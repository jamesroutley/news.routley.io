<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/Articles/947138/">Original</a>
    <h1>Progress on No-GIL CPython</h1>
    
    <div id="readability-page-1" class="page"><div>
<center>
           <div><b>Benefits for LWN subscribers</b><p>The primary benefit from <a href="https://lwn.net/subscribe/">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!</p></div>
           </center>
           
<p>Back at the end of July, the Python steering council <a href="https://discuss.python.org/t/a-steering-council-notice-about-pep-703-making-the-global-interpreter-lock-optional-in-cpython/30474">announced</a>
its intention to approve the proposal to make the global interpreter lock
(GIL) optional over the next few Python releases.  The details of that
acceptance are still being decided on, but work on the feature is
proceeding—in discussion form at least.  Beyond that, though, there are
efforts underway to solve that hardest of problems in computer
science, naming, for the no-GIL version. 
</p>

<h4>ABI concerns</h4>

<p>
In mid-September, Sam Gross, who authored <a href="https://peps.python.org/pep-0703/">PEP 703</a> (&#34;Making the
Global Interpreter Lock Optional in CPython&#34;), posted a <a href="https://discuss.python.org/t/python-abis-and-pep-703/34018">message</a>
to the Python discussion forum about the interaction of the PEP and the CPython
stable 
ABI. In part, the stable ABI is used by extensions to enable their binary wheels
to work with multiple CPython versions, thus not require rebuilds when
CPython is released. The PEP <a href="https://lwn.net/Articles/940780/">envisions a path</a> toward an
eventual single CPython version without the GIL, but, in the meantime,
there will be a build of the interpreter (using <tt>‑‑disable‑gil</tt>) that can be used to test no-GIL
operation.
</p>

<p>
Gross noted that extensions built for the
stable ABI will not actually work with a no-GIL CPython 3.13 (which is
due in
October 2024), but he is proposing some changes so that extensions
will work with both types of CPython builds 
from that version onward.  Extensions that only call into the &#34;limited&#34; C API
result in binaries that use the stable ABI, so Gross suggested a few
additions and changes to the API in order to facilitate extension binaries
that can work with both interpreter types (GIL and no-GIL).  In part, it
adopts the existing plan to <a href="https://discuss.python.org/t/limited-c-api-implement-py-incref-and-py-decref-as-function-calls/27592">switch
some macros to function calls</a>, in particular for incrementing and
decrementing the object reference counts that are used for garbage collection.
</p>

<p>
Victor Stinner, who has <a href="https://lwn.net/Articles/944764/">done a lot of recent
work</a> on the stable ABI, <a href="https://discuss.python.org/t/python-abis-and-pep-703/34018/2">replied</a>
that he thought there should a simple solution for extensions that can work
on both interpreter types; he is concerned that the no-GIL experiment will
fail otherwise.  Because extensions that are built for the stable ABI on
CPython 3.12 and earlier will not be compatible with no-GIL builds from 3.13 onward, he thinks it may make sense to create a new ABI version to
differentiate the cases.  Currently, the stable ABI is &#34;abi3&#34;, but that
could be bumped to abi4—even without moving to a Python 4.  Many
people seem to believe the ABI number and CPython major number are linked,
but that is not the case.
</p>

<p>
Gross is <a href="https://discuss.python.org/t/python-abis-and-pep-703/34018/4">less
concerned</a> about the need for extensions that want to support 
no-GIL mode having to build two separate binary wheel versions as he <a href="https://discuss.python.org/t/python-abis-and-pep-703/34018#what-about-the-default-with-gil-build-of-cpython-6">described
in his original message</a>.  He believes that building two wheels is a
manageable price to pay 
and is more worried about tying the no-GIL project to fixes or upgrades to
the C API and stable ABI. Alex Gaynor <a href="https://discuss.python.org/t/python-abis-and-pep-703/34018/6">agreed</a>
about the price;
he has multiple packages with abi3 wheels (and &#34;<q>is very excited about
the glorious nogil future</q>&#34;) that would be affected, but creating two
wheels is not 
overly burdensome as a one-time thing. He does want to ensure that
existing and future versions of <tt>pip</tt> do the right thing in choosing
between them, however. 
</p>

<p>
Brett Cannon <a href="https://discuss.python.org/t/python-abis-and-pep-703/34018/10">said</a>
that existing and older versions of <tt>pip</tt> would not do the right
thing, unless a change to abi4 was made; the logic used in <tt>pip</tt>
today would not be able to distinguish between the versions.  Gross <a href="https://discuss.python.org/t/python-abis-and-pep-703/34018/13">suggested</a>
that supporting older <tt>pip</tt> versions may not really be needed, since
it is not an actual change in behavior:

</p><blockquote>
I don&#39;t think we should worry too much about whether old versions of pip
work properly for the <i>experimental</i>, <tt>--disable-gil</tt> build of
CPython 3.13. As 
it is, old versions of pip frequently do not work with new versions of
Python. For example, <tt>pip==23.1.1</tt> and older (from just 5 months ago) will
break if installed in CPython 3.13 (missing pkgutil.ImpImporter).
</blockquote>


<p>
<tt>pip</tt> maintainer Paul Moore <a href="https://discuss.python.org/t/python-abis-and-pep-703/34018/14">pointed
out</a> a difference, though: breakage is different from silently doing the
wrong thing:
</p><blockquote>
I think it&#39;s fine if an older version <i>breaks</i> for newer Python. But
I&#39;m less 
sure that silently installing the wrong package is acceptable. People do
use older versions of pip, and loud breakages aren&#39;t the same as silent
errors. 
</blockquote>


<p>
He noted that <tt>pip</tt> has a policy that users should always upgrade to
the latest version, but that the project has no specific policy on silent
errors of this sort.  He is concerned that those who want to experiment
with the no-GIL (or &#34;free-threaded&#34;) builds will be put off if they end up
&#34;<q>having to debug ABI compatibility issues like this</q>&#34;.  Gaynor <a href="https://discuss.python.org/t/python-abis-and-pep-703/34018/15">agreed</a>,
noting that &#34;<q><tt>pip</tt> silently doing the wrong thing creates a flood
of issues</q>&#34; for the packages affected.
</p>

<p>
Barry Warsaw <a href="https://discuss.python.org/t/python-abis-and-pep-703/34018/5">asked</a>
about whether there were plans for allowing installation of both
interpreter types on the same system. Gross <a href="https://discuss.python.org/t/python-abis-and-pep-703/34018/7">said</a>
that the situation was the same as having two different versions of Python
installed. Warsaw <a href="https://discuss.python.org/t/python-abis-and-pep-703/34018/8">thought</a>
that was reasonable and that it is not too difficult handle parallel
installations. In the message linked above, Cannon said that one solution
could be a 
&#34;fat&#34; wheel that had both binaries, as long as the names of those binaries
in the wheel were distinct.
</p>

<h4>Naming</h4>

<p>
But the <a href="https://discuss.python.org/t/naming-the-python-binary-when-disable-gil-is-set/34052">naming
discussion</a> got spun off into its own thread—once it clearly headed in
that direction, anyway.  Moore said that it was important to be able to
install both interpreters so that people can easily test the no-GIL mode;
if that is not straightforward to do, in Windows, macOS, Linux, and others,
it will negatively impact the no-GIL project:
</p><blockquote>
This links back to the packaging question, because how easy it is for users
to try out nogil builds, and how easy it is for a user to select between
nogil and gil, will strongly affect how much demand there is for nogil
builds, and hence how much pressure there will be on package maintainers to
provide nogil-compatible wheels in the first place. 
</blockquote>


<p>
Barry Scott <a href="https://discuss.python.org/t/naming-the-python-binary-when-disable-gil-is-set/34052/3">wondered</a>
what names would be used, noting that the &#34;<a href="https://en.wikipedia.org/wiki/Shebang_%28Unix%29">shebang line</a>&#34; 
(i.e. &#34;<tt>#!/usr/bin/python</tt>&#34; or similar at the top of a script)
needs to indicate which interpreter to invoke, which should the same across
all of the platforms if possible:
</p><blockquote>
The gil version of python executable is &#34;python3&#34;.
What is the name of the nogil executable? &#34;python-nogil3&#34;,
&#34;python-nogil3.13&#34; etc? 
</blockquote>


<p>
But the no-GIL build for 3.13 is clearly meant as an experimental feature,
Gregory P. Smith <a href="https://discuss.python.org/t/naming-the-python-binary-when-disable-gil-is-set/34052/5">said</a>,
which means that distributions should not be putting that build on
the default <tt>$PATH</tt>, at least in his opinion.  Smith is a member of
the steering council, but noted that he was using his &#34;<q>personal
reply hat</q>&#34;.  Having a lengthy name for the interpreter that lingers for
long periods afterward because it remains in shebang lines is not
desirable, so he suggested waiting: 
</p><blockquote>
In effect this defers any potential install naming decision until 3.14 or
later once we&#39;ve got some practical knowledge of how things are working out
- we&#39;ll presumably know better at that time if there&#39;s a need for parallel
installs. It&#39;s okay for some things like this to be decided later, in
effect that is why <a href="https://peps.python.org/pep-0703/#python-build-modes">PEP-703 has an
Open Issues section</a> not fully specifying this area today. 
</blockquote>


<p>
But Fedora developer Petr Viktorin <a href="https://discuss.python.org/t/naming-the-python-binary-when-disable-gil-is-set/34052/6">pointed
out</a> that distributions are likely to want to package the no-GIL
interpreter for their users to experiment with.  Moore <a href="https://discuss.python.org/t/naming-the-python-binary-when-disable-gil-is-set/34052/7">agreed</a>
that users are going to want that:

</p><blockquote>
I would like to be able to write scripts with <tt>#!/usr/bin/env
python3.13-nogil</tt> (or something like that) in order to get the free threaded
build <i>without</i> needing to hard-code a long and probably non-intuitive path
(which on Windows is also user-specific). 
</blockquote>



<p>
In another <a href="https://discuss.python.org/t/nogil-installers-on-windows/34049">thread</a> that was started by Steve Dower, who creates the official
Python packages for Windows, Smith <a href="https://discuss.python.org/t/nogil-installers-on-windows/34049/3">noted</a>
that the steering council has agreed that it wants to avoid the name
&#34;nogil&#34; to describe the build.  With his council hat on, he
said that there were two reasons behind this decision: it &#34;<q>does not
communicate well to most non-core devs, people need not know what a GIL
is</q>&#34; and it contains a negative.  There is a suggested alternative:

</p><blockquote>
A more appropriate term for this experimental in 3.13 build if you have a
need to provide builds is &#34;free-threading&#34;. We realize &#34;free-threading&#34;
doesn&#39;t roll off the tongue like two-syllable &#34;nogil&#34; does, but it should
be more understandable to people-who-are-not-us. 
</blockquote>



<p>
That set off some predictable bikeshedding on naming, with several in the
thread noting that they think &#34;nogil&#34; is the better choice—or at least that
they
are perfectly happy with that name.  Gross <a href="https://discuss.python.org/t/nogil-installers-on-windows/34049/7">thought</a>
that the suggested alternative was confusing: &#34;<q>While I understand the
objections to &#39;nogil&#39;, I don&#39;t think &#39;free-threading&#39; is likely to be
understood by people-who-are-not-us.</q>&#34; He noted that the term is not
widely used elsewhere.  Most participants generally just wanted to use
something short—&#34;nogil&#34; was the clear &#34;winner&#34; in that department—but none
of the suggestions made there seemed to resonate.  The one concrete change
was to switch the <a href="https://peps.python.org/pep-0703/#build-configuration-changes">ABI
tag for the no-GIL builds</a> from &#34;n&#34; to &#34;t&#34; (for &#34;threading&#34;). Excising
&#34;nogil&#34; at this point is going to be something of an uphill climb, it would
seem. 
</p>

<h4>Proposing abi4</h4>

<p>
Back in the original thread, there was some discussion, mostly between
Viktorin and Gross, about problem areas in the API changes that Gross
proposed. That led to a <a href="https://discuss.python.org/t/python-abis-and-pep-703/34018/27">new
proposal</a> that incorporated the feedback and adopted the idea of
creating a new ABI, abi4.  Gross has developed a <a href="https://github.com/colesbury/cpython/commit/2c1d02a85ac3b41c545d1089f7439b108059cb53">prototype</a>
of the new ABI.  Viktorin is <a href="https://discuss.python.org/t/python-abis-and-pep-703/34018/29">generally
in agreement</a> with the approach, though some details still need to be
worked out.
</p>

<p>
One of those details is that a PEP for abi4 is needed, as Stinner <a href="https://discuss.python.org/t/python-abis-and-pep-703/34018/32">pointed
out</a>.  Viktorin <a href="https://discuss.python.org/t/python-abis-and-pep-703/34018/33">agreed</a>
(&#34;<q>This is a pre-PEP discussion.</q>&#34;) and it would seem that the mid-October
core developer sprint will be the venue for some face-to-face discussions
on the topic.
In particular, there is confusion about the compatibility guarantees
provided by the combinations of various limited API versions and abi3,
which will impact what will happen with abi4.  Research on those issues is <a href="https://discuss.python.org/t/python-abis-and-pep-703/34018/54">ongoing</a>.
</p>

<p>
So, work on the no-GIL (or free-threaded) version of CPython is proceeding
apace, but the final acceptance of the PEP is <a href="https://discuss.python.org/t/status-of-pep-703-making-the-global-interpreter-lock-optional-in-cpython-is-it-accepted-or-a-draft/35635">still
pending</a>.  It is somewhat surprising that there has been such a lengthy
delay, but PEP 703 and its knock-on effects are likely to dominate
CPython development—and ecosystem—over the next five or more
years, so the 
steering council wants to make its acceptance criteria clear.  As council
member Thomas Wouters <a href="https://discuss.python.org/t/status-of-pep-703-making-the-global-interpreter-lock-optional-in-cpython-is-it-accepted-or-a-draft/35635/2">put
it</a>: &#34;<q>we&#39;re ironing out the exact acceptance text (we want to clarify
a lot of our decisions)</q>&#34;.  Some of that work may happen at the sprint
as well.
</p></div></div>
  </body>
</html>
