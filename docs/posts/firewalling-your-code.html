<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lackofimagination.org/2024/08/firewalling-your-code/">Original</a>
    <h1>Firewalling Your Code</h1>
    
    <div id="readability-page-1" class="page"><div>
            <div>
              <p>When writing code, you can call any function as long as it’s public, and similarly, you can access any object’s public properties or methods. Usually, access to code is all or none – a piece of code can be either public or private. Access to private code is typically controlled by the upper layer that encapsulates it. Although some languages support semi-private (also known as protected) object members, that’s a merely variation on the public/private theme.</p>
<p>Lately, I’ve been thinking about ways to implement more fine-grained access controls and have looked to the networking world for inspiration. In computer networks, firewalls are used to restrict access to network resources. For example, you can set firewall rules to allow only the application and analytics servers to access the database server – or more specifically, the port on which the database service is running. There’s no need for encapsulation, inheritance or interfaces to implement; you simply define access rules.</p>
<p>Unlike network firewalls, when accessing a public property or method in a program, we don’t normally check whether the caller has the right to do so. Since the callee is public, any part of the program should be able to call it without any restrictions. However, I believe there are cases when more fine-grained controls could be useful.</p>
<p>In the commonly used <a href="https://lackofimagination.org/2024/03/software-architectures-in-a-nutshell/">multi-tier architecture</a>, code flows in one direction only – from the upper-most layer to the layers below. Modules can call the other modules in the same layer. They can also call modules in the layer directly below, but never above.</p>



<p>
  
    <svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 544 217">
      <g transform="translate(8,16)">
<path d="M 192,0 L 224,0" fill="none" stroke="currentColor"></path>
<path d="M 288,0 L 320,0" fill="none" stroke="currentColor"></path>
<path d="M 384,0 L 416,0" fill="none" stroke="currentColor"></path>
<path d="M 192,16 L 224,16" fill="none" stroke="currentColor"></path>
<path d="M 288,16 L 320,16" fill="none" stroke="currentColor"></path>
<path d="M 384,16 L 416,16" fill="none" stroke="currentColor"></path>
<path d="M 192,48 L 224,48" fill="none" stroke="currentColor"></path>
<path d="M 288,48 L 320,48" fill="none" stroke="currentColor"></path>
<path d="M 384,48 L 416,48" fill="none" stroke="currentColor"></path>
<path d="M 144,80 L 168,80" fill="none" stroke="currentColor"></path>
<path d="M 192,80 L 224,80" fill="none" stroke="currentColor"></path>
<path d="M 288,80 L 320,80" fill="none" stroke="currentColor"></path>
<path d="M 384,80 L 416,80" fill="none" stroke="currentColor"></path>
<path d="M 240,96 L 264,96" fill="none" stroke="currentColor"></path>
<path d="M 336,96 L 360,96" fill="none" stroke="currentColor"></path>
<path d="M 152,112 L 176,112" fill="none" stroke="currentColor"></path>
<path d="M 192,112 L 224,112" fill="none" stroke="currentColor"></path>
<path d="M 288,112 L 320,112" fill="none" stroke="currentColor"></path>
<path d="M 384,112 L 416,112" fill="none" stroke="currentColor"></path>
<path d="M 192,144 L 224,144" fill="none" stroke="currentColor"></path>
<path d="M 288,144 L 320,144" fill="none" stroke="currentColor"></path>
<path d="M 384,144 L 416,144" fill="none" stroke="currentColor"></path>
<path d="M 192,176 L 224,176" fill="none" stroke="currentColor"></path>
<path d="M 288,176 L 320,176" fill="none" stroke="currentColor"></path>
<path d="M 384,176 L 416,176" fill="none" stroke="currentColor"></path>
<path d="M 192,192 L 224,192" fill="none" stroke="currentColor"></path>
<path d="M 288,192 L 320,192" fill="none" stroke="currentColor"></path>
<path d="M 384,192 L 416,192" fill="none" stroke="currentColor"></path>
<path d="M 176,16 L 176,112" fill="none" stroke="currentColor"></path>
<path d="M 176,112 L 176,176" fill="none" stroke="currentColor"></path>
<path d="M 192,16 L 192,48" fill="none" stroke="currentColor"></path>
<path d="M 192,80 L 192,112" fill="none" stroke="currentColor"></path>
<path d="M 192,144 L 192,176" fill="none" stroke="currentColor"></path>
<path d="M 224,16 L 224,48" fill="none" stroke="currentColor"></path>
<path d="M 224,80 L 224,112" fill="none" stroke="currentColor"></path>
<path d="M 224,144 L 224,176" fill="none" stroke="currentColor"></path>
<path d="M 240,16 L 240,96" fill="none" stroke="currentColor"></path>
<path d="M 240,96 L 240,176" fill="none" stroke="currentColor"></path>
<path d="M 272,16 L 272,176" fill="none" stroke="currentColor"></path>
<path d="M 288,16 L 288,48" fill="none" stroke="currentColor"></path>
<path d="M 288,80 L 288,112" fill="none" stroke="currentColor"></path>
<path d="M 288,144 L 288,176" fill="none" stroke="currentColor"></path>
<path d="M 320,16 L 320,48" fill="none" stroke="currentColor"></path>
<path d="M 320,80 L 320,112" fill="none" stroke="currentColor"></path>
<path d="M 320,144 L 320,176" fill="none" stroke="currentColor"></path>
<path d="M 336,16 L 336,96" fill="none" stroke="currentColor"></path>
<path d="M 336,96 L 336,176" fill="none" stroke="currentColor"></path>
<path d="M 368,16 L 368,176" fill="none" stroke="currentColor"></path>
<path d="M 384,16 L 384,48" fill="none" stroke="currentColor"></path>
<path d="M 384,80 L 384,112" fill="none" stroke="currentColor"></path>
<path d="M 384,144 L 384,176" fill="none" stroke="currentColor"></path>
<path d="M 416,16 L 416,48" fill="none" stroke="currentColor"></path>
<path d="M 416,80 L 416,112" fill="none" stroke="currentColor"></path>
<path d="M 416,144 L 416,176" fill="none" stroke="currentColor"></path>
<path d="M 432,16 L 432,176" fill="none" stroke="currentColor"></path>
<polygon points="160.000000,112.000000 148.000000,106.400002 148.000000,117.599998" fill="currentColor" transform="rotate(180.000000, 152.000000, 112.000000)"></polygon>
<polygon points="176.000000,80.000000 164.000000,74.400002 164.000000,85.599998" fill="currentColor" transform="rotate(0.000000, 168.000000, 80.000000)"></polygon>
<polygon points="272.000000,96.000000 260.000000,90.400002 260.000000,101.599998" fill="currentColor" transform="rotate(0.000000, 264.000000, 96.000000)"></polygon>
<polygon points="368.000000,96.000000 356.000000,90.400002 356.000000,101.599998" fill="currentColor" transform="rotate(0.000000, 360.000000, 96.000000)"></polygon>
<path d="M 192,0 A 16,16 0 0,0 176,16" fill="none" stroke="currentColor"></path>
<path d="M 224,0 A 16,16 0 0,1 240,16" fill="none" stroke="currentColor"></path>
<path d="M 288,0 A 16,16 0 0,0 272,16" fill="none" stroke="currentColor"></path>
<path d="M 320,0 A 16,16 0 0,1 336,16" fill="none" stroke="currentColor"></path>
<path d="M 384,0 A 16,16 0 0,0 368,16" fill="none" stroke="currentColor"></path>
<path d="M 416,0 A 16,16 0 0,1 432,16" fill="none" stroke="currentColor"></path>
<path d="M 176,176 A 16,16 0 0,0 192,192" fill="none" stroke="currentColor"></path>
<path d="M 240,176 A 16,16 0 0,1 224,192" fill="none" stroke="currentColor"></path>
<path d="M 272,176 A 16,16 0 0,0 288,192" fill="none" stroke="currentColor"></path>
<path d="M 336,176 A 16,16 0 0,1 320,192" fill="none" stroke="currentColor"></path>
<path d="M 368,176 A 16,16 0 0,0 384,192" fill="none" stroke="currentColor"></path>
<path d="M 432,176 A 16,16 0 0,1 416,192" fill="none" stroke="currentColor"></path>
<text text-anchor="middle" x="88" y="116" fill="currentColor" style="font-size:1em">O</text>
<text text-anchor="middle" x="96" y="84" fill="currentColor" style="font-size:1em">I</text>
<text text-anchor="middle" x="96" y="116" fill="currentColor" style="font-size:1em">u</text>
<text text-anchor="middle" x="104" y="84" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="104" y="116" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="112" y="84" fill="currentColor" style="font-size:1em">p</text>
<text text-anchor="middle" x="112" y="116" fill="currentColor" style="font-size:1em">p</text>
<text text-anchor="middle" x="120" y="84" fill="currentColor" style="font-size:1em">u</text>
<text text-anchor="middle" x="120" y="116" fill="currentColor" style="font-size:1em">u</text>
<text text-anchor="middle" x="128" y="84" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="128" y="116" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="208" y="36" fill="currentColor" style="font-size:1em">M</text>
<text text-anchor="middle" x="208" y="100" fill="currentColor" style="font-size:1em">M</text>
<text text-anchor="middle" x="208" y="164" fill="currentColor" style="font-size:1em">M</text>
<text text-anchor="middle" x="304" y="36" fill="currentColor" style="font-size:1em">M</text>
<text text-anchor="middle" x="304" y="100" fill="currentColor" style="font-size:1em">M</text>
<text text-anchor="middle" x="304" y="164" fill="currentColor" style="font-size:1em">M</text>
<text text-anchor="middle" x="400" y="36" fill="currentColor" style="font-size:1em">M</text>
<text text-anchor="middle" x="400" y="100" fill="currentColor" style="font-size:1em">M</text>
<text text-anchor="middle" x="400" y="164" fill="currentColor" style="font-size:1em">M</text>
</g>

    </svg>
  
</p>
<p>How can you ensure that the modules follow these rules? Unless you’re conducting in-depth code reviews, it isn’t too difficult to end up with haphazard code paths that might have maintenance and security implications.</p>
<p>As a proof of concept, I’ve created a Node.js library called <a href="https://www.npmjs.com/package/firewall-js">firewall-js</a> using JavaScript proxies. It relies on the filesystem structure of a code base to limit access to certain parts.</p>
<p>Take a simple backend application with three layers: <strong>routes &gt; controllers &gt; services</strong>. Each layer has its own directory, and each file in a directory houses a module. The directory listing should look something like this:</p>
<div><pre tabindex="0"><code data-lang="text"><span><span>&gt; controllers
</span></span><span><span>&gt; routes
</span></span><span><span>v services
</span></span><span><span>   auth.js
</span></span><span><span>   log.js
</span></span><span><span>   user.js
</span></span></code></pre></div><p>Now, if you want all the controller modules (upper layer) and all other service modules (same layer) to have access to a particular service module, we can do it with a single line:</p>
<div><pre tabindex="0"><code data-lang="js"><span><span><span>// services/user.js
</span></span></span><span><span><span>// ...
</span></span></span><span><span><span></span><span>const</span> <span>firewall</span> <span>=</span> <span>require</span>(<span>&#39;firewall-js&#39;</span>);
</span></span><span><span>
</span></span><span><span><span>const</span> <span>userService</span> <span>=</span> {
</span></span><span><span>    <span>hashPassword</span><span>:</span> <span>function</span> (<span>password</span>) {
</span></span><span><span>        <span>return</span> <span>bcrypt</span>.<span>hash</span>(<span>password</span>, <span>8</span>);
</span></span><span><span>    },
</span></span><span><span>
</span></span><span><span>    <span>getUserByEmail</span><span>:</span> <span>function</span> (<span>email</span>) {
</span></span><span><span>        <span>return</span> <span>db</span>(<span>&#39;user&#39;</span>).<span>where</span>(<span>&#39;email&#39;</span>, <span>email</span>).<span>then</span>(<span>_</span>.<span>head</span>);
</span></span><span><span>    },
</span></span><span><span>
</span></span><span><span>    <span>// ...
</span></span></span><span><span><span></span>};
</span></span><span><span>
</span></span><span><span><span>module</span>.<span>exports</span> <span>=</span> <span>firewall</span>.<span>allow</span>([<span>&#39;controllers&#39;</span>, <span>&#39;services&#39;</span>], <span>userService</span>);
</span></span></code></pre></div><p>If you attempt to call, for example, <em>userService.hashPassword()</em> from a file in any other directory, an exception will be thrown:</p>
<div><pre tabindex="0"><code data-lang="text"><span><span>Error: Access denied for hashPassword from /Users/me/my-app/routes/main.js:51:19
</span></span></code></pre></div><p>You can go one step further, and allow access not just from directories, but from files too. In the following example, only the userProfile controller can access userService, and no one else:</p>
<div><pre tabindex="0"><code data-lang="js"><span><span><span>module</span>.<span>exports</span> <span>=</span> <span>firewall</span>.<span>allow</span>([<span>&#39;controllers/userProfile.js&#39;</span>], <span>userService</span>);
</span></span></code></pre></div><p>I’ve deliberately made the filesystem structure the basis of the access control system. This, I believe, has two benefits:</p>
<ul>
<li>A clear-cut organization of code with directories acting as layers and files as modules within those layers.</li>
<li>Permissions that are easy to understand, since most everyone is familiar with how a filesystem works.</li>
</ul>
<p>An access control system like the one implemented here can help prevent maintenance issues, such as dependencies or coupling between unrelated parts of the application, and enhance security by limiting the potential for unauthorized actions. Additionally, it doesn’t require any drastic changes to the existing code base, as long as a sensible directory hierarchy is in place. Firewalling a module can then be as easy as adding a single line of code.</p>
<p><strong>GitHub Repository:</strong> <a href="https://github.com/aycangulez/firewall-js">firewall-js</a></p>

              


              
                <hr/>
                <p><b>Related:</b></p>
                <ul>
                  
                    <li><a href="https://lackofimagination.org/2024/04/back-to-basics-in-web-apps/">Back to Basics in Web Apps</a></li>
                  
                    <li><a href="https://lackofimagination.org/2023/11/design-patterns-vs.-first-class-functions/">Design Patterns vs. First Class Functions</a></li>
                  
                    <li><a href="https://lackofimagination.org/2024/04/beyond-foreign-keys/">Beyond Foreign Keys</a></li>
                  
                </ul>
              
            </div>
          </div></div>
  </body>
</html>
