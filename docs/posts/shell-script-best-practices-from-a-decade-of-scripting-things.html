<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://sharats.me/posts/shell-script-best-practices/">Original</a>
    <h1>Shell Script Best Practices, from a decade of scripting things</h1>
    
    <div id="readability-page-1" class="page"><p>
<em>
Thank you for printing from <a href="https://sharats.me">sharats.me</a>. Do check back regularly for more such
awesome content. Subscribe to at sharats.me/posts/index.xml to stay updated.
</em>
</p><article><p>This article is about a few quick thumb rules I use when writing shell scripts that I’ve come to appreciate over the years. Very opinionated.</p>
<h2 id="things">Things<a href="#things" title="Permanent link">¶</a></h2>
<ol>
<li>
<p>Use <code>bash</code>. Using <code>zsh</code> or <code>fish</code> or any other, will make it hard for others to understand / collaborate. Among all shells, <code>bash</code> strikes a good balance between portability and DX.</p>
</li>
<li>
<p>Just make the first line be <code>#!/usr/bin/env bash</code>, even if you don’t give executable permission to the script file.</p>
</li>
<li>
<p>Use the <code>.sh</code> (or <code>.bash</code>) extension for your file. It may be fancy to not have an extension for your script, but unless your case explicitly depends on it, you’re probably just trying to do clever stuff. Clever stuff are hard to understand.</p>
</li>
<li>
<p>Use <code>set -o errexit</code> at the start of your script.</p>
<ul>
<li>So that when a command fails, <code>bash</code> exits instead of continuing with the rest of the script.</li>
</ul>
</li>
<li>
<p>Prefer to use <code>set -o nounset</code>. You <em>may</em> have a good excuse to not do this, but, my opinion, it’s best to always set it.</p>
<ul>
<li>This will make the script fail, when accessing an unset variable. Saves from horrible unintended consequences, with typos in variable names.</li>
<li>When you want to access a variable that may or may not have been set, use <code>&#34;${VARNAME-}&#34;</code> instead of <code>&#34;$VARNAME&#34;</code>, and you’re good.</li>
</ul>
</li>
<li>
<p>Use <code>set -o pipefail</code>. Again, you may have good reasons to not do this, but I’d recommend to always set it.</p>
<ul>
<li>This will ensure that a pipeline command is treated as failed, even if one command in the pipeline fails.</li>
</ul>
</li>
<li>
<p>Use <code>set -o xtrace</code>, with a check on <code>$TRACE</code> env variable.</p>
<ul>
<li>For copy-paste: <code>if [[ &#34;${TRACE-0}&#34; == &#34;1&#34; ]]; then set -o xtrace; fi</code>.</li>
<li>This helps in debugging your scripts, a lot. Like, really lot.</li>
<li>People can now <em>enable</em> debug mode, by running your script as <code>TRACE=1 ./script.sh</code> instead of <code>./script.sh</code>.</li>
</ul>
</li>
<li>
<p>Use <code>[[ ]]</code> for conditions in <code>if</code> / <code>while</code> statements, instead of <code>[ ]</code> or <code>test</code>.</p>
<ul>
<li><code>[[ ]]</code> is a bash builtin, and is more powerful than <code>[ ]</code> or <code>test</code>.</li>
</ul>
</li>
<li>
<p>Always quote variable accesses with double-quotes.</p>
<ul>
<li>One place where it’s <em>okay</em> not to is on the <em>left-hand-side</em> of an <code>[[ ]]</code> condition. But even there I’d recommend quoting.</li>
<li>When you need the unquoted behaviour, using <code>bash</code> arrays will likely serve you much better.</li>
</ul>
</li>
<li>
<p>Use <code>local</code> variables in functions.</p>
</li>
<li>
<p>Accept multiple ways that users can ask for help and respond in kind.</p>
<ul>
<li>Check if the first arg is <code>-h</code> or <code>--help</code> or <code>help</code> or just <code>h</code> or even <code>-help</code>, and in all these cases, print help text and exit.</li>
<li>Please. For the sake of your future-self.</li>
</ul>
</li>
<li>
<p>When printing error messages, please redirect to stderr.</p>
<ul>
<li>Use <code>echo &#39;Something unexpected happened&#39; &gt;&amp;2</code> for this.</li>
</ul>
</li>
<li>
<p>Use long options, where possible (like <code>--silent</code> instead of <code>-s</code>). These serve to document your commands explicitly.</p>
<ul>
<li>Note though, that commands shipped on some systems like macOS don’t always have long options.</li>
</ul>
</li>
<li>
<p>If appropriate, change to the script’s directory close to the start of the script.</p>
<ul>
<li>And it’s usually always appropriate.</li>
<li>Use <code>cd &#34;$(dirname &#34;$0&#34;)&#34;</code>, which works in <em>most</em> cases.</li>
</ul>
</li>
<li>
<p>Use <code>shellcheck</code>. Heed its warnings.</p>
</li>
</ol>
<h2 id="template">Template<a href="#template" title="Permanent link">¶</a></h2>
<div><pre><code><span>#!/usr/bin/env bash</span>

<span>set</span> -o errexit
<span>set</span> -o nounset
<span>set</span> -o pipefail
<span>if</span> <span>[[</span> <span>&#34;</span><span>${</span><span>TRACE</span><span>-0</span><span>}</span><span>&#34;</span> <span>==</span> <span>&#34;1&#34;</span> <span>]]</span><span>;</span> <span>then</span>
    <span>set</span> -o xtrace
<span>fi</span>

<span>if</span> <span>[[</span> <span>&#34;</span><span>${</span><span>1</span><span>-</span><span>}</span><span>&#34;</span> <span>=</span>~ ^-*h<span>(</span>elp<span>)</span>?$ <span>]]</span><span>;</span> <span>then</span>
    <span>echo</span> <span>&#39;Usage: ./script.sh arg-one arg-two</span>

<span>This is an awesome bash script to make your life better.</span>

<span>&#39;</span>
    <span>exit</span>
<span>fi</span>

<span>cd</span> <span>&#34;</span><span>$(</span>dirname <span>&#34;</span><span>$0</span><span>&#34;</span><span>)</span><span>&#34;</span>

main<span>()</span> <span>{</span>
    <span>echo</span> <span>do</span> awesome stuff
<span>}</span>

main <span>&#34;</span><span><a href="https://sharats.me/cdn-cgi/l/email-protection" data-cfemail="d1f591">[email protected]</a></span><span>&#34;</span>
</code></pre></div>

<h2 id="conclusion">Conclusion<a href="#conclusion" title="Permanent link">¶</a></h2>
<p>I try to follow these rules in my scripts, and they’re known to have made at least my own life better. I’m still not consistent though, unfortunately, in following my own rules. So perhaps writing them down this way will help me improve there as well.</p>
<p>Do you have anything you think I should add to this? Please share in the comments!</p>
<p>Edit 1: Included fixes from HN comments at <a href="https://news.ycombinator.com/item?id=33355407" rel="noopener noreferrer" target="_blank">https://news.ycombinator.com/item?id=33355407</a> and <a href="https://news.ycombinator.com/item?id=33355077" rel="noopener noreferrer" target="_blank">https://news.ycombinator.com/item?id=33355077</a>.</p></article></div>
  </body>
</html>
