<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://codeconfessions.substack.com/p/cpython-dynamic-dispatch-internals">Original</a>
    <h1>How many lines of C it takes to execute a &#43; b in Python</h1>
    
    <div id="readability-page-1" class="page"><div class=""><div><div dir="auto"><p><span>Welcome back to the </span><a href="https://codeconfessions.substack.com/t/cpython-internals" rel="">CPython internals series</a><span>. In the </span><a href="https://codeconfessions.substack.com/p/cpython-object-system-internals-understanding" rel="">previous article</a><span> we explored the </span><code>PyObject</code><span> structure, and its role as the header for all CPython runtime objects. This structure plays a crucial role in enabling inheritance and polymorphism in the CPython object system. But that was just the tip of the iceberg</span></p><p><span>In this article we will go one level deeper, and look at what exactly goes on behind the scenes in the Python runtime to execute something as simple as “</span><code>a + b</code><span>”. In other words, we will learn the implementation details behind types, operators, and dynamic dispatch in CPython. </span></p><p><span>Note that, even though we will be following the implementation of dynamic dispatch for a specific operator, the same ideas apply for all the operators supported by CPython. So effectively, with this knowledge you </span><em>could</em><span> implement your own new operator, or your own new type.</span></p><blockquote><p><em><span>If you are a recent subscriber, I’ve written quite a few articles on CPython internals, that you might enjoy. You can find them all </span><a href="https://codeconfessions.substack.com/t/cpython-internals" rel="">here</a><span>. </span></em></p></blockquote><p><span>When we write code such as </span><code>a + b</code><span> in Python, the types of </span><code>a</code><span> and </span><code>b</code><span> determine the exact behavior of the </span><code>+</code><span> operation. Every type in Python has its own implementation of the </span><code>+</code><span> operator (if that type supports </span><code>+</code><span>) and the Python interpreter figures out the right implementation to call based on the type of the operands. This whole process is called </span><em><a href="https://en.wikipedia.org/wiki/Dynamic_dispatch" rel="">dynamic dispatch</a></em><span> in programming languages. The following diagram gives a high level overview of how it works in CPython:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa4de83a7-74ea-49cc-9370-85dd9fb5adf2_1970x369.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa4de83a7-74ea-49cc-9370-85dd9fb5adf2_1970x369.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa4de83a7-74ea-49cc-9370-85dd9fb5adf2_1970x369.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa4de83a7-74ea-49cc-9370-85dd9fb5adf2_1970x369.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa4de83a7-74ea-49cc-9370-85dd9fb5adf2_1970x369.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_2400,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa4de83a7-74ea-49cc-9370-85dd9fb5adf2_1970x369.png" width="1200" height="225" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/a4de83a7-74ea-49cc-9370-85dd9fb5adf2_1970x369.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:false,&#34;imageSize&#34;:&#34;large&#34;,&#34;height&#34;:273,&#34;width&#34;:1456,&#34;resizeWidth&#34;:1200,&#34;bytes&#34;:119491,&#34;alt&#34;:&#34;High level flow of operator execution in the CPython VM&#34;,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="High level flow of operator execution in the CPython VM" title="High level flow of operator execution in the CPython VM" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa4de83a7-74ea-49cc-9370-85dd9fb5adf2_1970x369.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa4de83a7-74ea-49cc-9370-85dd9fb5adf2_1970x369.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa4de83a7-74ea-49cc-9370-85dd9fb5adf2_1970x369.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa4de83a7-74ea-49cc-9370-85dd9fb5adf2_1970x369.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>High level flow of operator execution in the CPython VM</figcaption></figure></div><p> Let’s briefly discuss the various parts:</p><ul><li><p><span>The Python code gets compiled to bytecode, which is executed by a stack based virtual machine (VM) in CPython. The </span><code>BINARY_OP</code><span> instruction is responsible for executing the </span><code>+</code><span> operation on the two operands, </span><code>a</code><span> and </span><code>b</code><span>.</span></p></li><li><p><span>The VM itself does not know how to perform </span><code>+</code><span> on two objects. Instead, it delegates this to an abstract object interface to deal with it.</span></p></li><li><p>The abstract object interface in CPython defines an interface supporting all the common object level operations in CPython. This gives the VM a single unified way of executing all the operators without knowing any implementation details of the object system. The abstract interface dispatches the execution to the concrete implementation within the types via the function pointer table lookup in the object header (more on this later).</p></li></ul><p><span>In the previous article, we briefly explored a part of this flow by looking at the implementation of the </span><code>BINARY_OP</code><span> instruction in the CPython VM. This time our goal is to properly understand how the dynamic dispatch happens. For this reason, we are going to follow a bottom up approach.</span></p><p>We will start by looking at how the different types implement various operators, then we will look at the abstract object interface and see how it calls those concrete implementations, and finally, we will see how the CPython VM integrates with the abstract object interface.</p><p><span>The </span><a href="https://github.com/python/cpython/blob/3.12/Include/cpython/object.h#L146" rel="">PyTypeObject</a><span> struct is the second building block of the CPython object system (first being </span><code>PyObject</code><span>). It contains the runtime type information about an object. Before we look at dynamic dispatch in CPython, we should first understand what’s inside </span><code>PyTypeObject</code><span>.</span></p><p><span>But first, let’s just recap, and see the definition of </span><a href="https://github.com/python/cpython/blob/3.12/Include/object.h#L166" rel="">PyObject</a><span>, which is where </span><code>PyTypeObject</code><span> comes into picture:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd857ca95-629f-43ef-8945-13242080c414_1438x351.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd857ca95-629f-43ef-8945-13242080c414_1438x351.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd857ca95-629f-43ef-8945-13242080c414_1438x351.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd857ca95-629f-43ef-8945-13242080c414_1438x351.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd857ca95-629f-43ef-8945-13242080c414_1438x351.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd857ca95-629f-43ef-8945-13242080c414_1438x351.png" width="1438" height="351" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/d857ca95-629f-43ef-8945-13242080c414_1438x351.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:351,&#34;width&#34;:1438,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:97038,&#34;alt&#34;:&#34;Definition of PyObject struct&#34;,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="Definition of PyObject struct" title="Definition of PyObject struct" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd857ca95-629f-43ef-8945-13242080c414_1438x351.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd857ca95-629f-43ef-8945-13242080c414_1438x351.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd857ca95-629f-43ef-8945-13242080c414_1438x351.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd857ca95-629f-43ef-8945-13242080c414_1438x351.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>Definition of PyObject struct</figcaption></figure></div><p><span>Also, every type definition in CPython includes </span><code>PyObject</code><span> as its first field as a header. For instance, this is the definition of the float type:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c87d89b-438c-4b2a-b34c-12f76c839fce_748x258.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c87d89b-438c-4b2a-b34c-12f76c839fce_748x258.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c87d89b-438c-4b2a-b34c-12f76c839fce_748x258.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c87d89b-438c-4b2a-b34c-12f76c839fce_748x258.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c87d89b-438c-4b2a-b34c-12f76c839fce_748x258.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c87d89b-438c-4b2a-b34c-12f76c839fce_748x258.png" width="748" height="258" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/8c87d89b-438c-4b2a-b34c-12f76c839fce_748x258.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:258,&#34;width&#34;:748,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:42047,&#34;alt&#34;:&#34;Definition of float type in CPython&#34;,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="Definition of float type in CPython" title="Definition of float type in CPython" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c87d89b-438c-4b2a-b34c-12f76c839fce_748x258.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c87d89b-438c-4b2a-b34c-12f76c839fce_748x258.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c87d89b-438c-4b2a-b34c-12f76c839fce_748x258.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c87d89b-438c-4b2a-b34c-12f76c839fce_748x258.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>Definition of float type in CPython</figcaption></figure></div><p><span>This means that every such object can be typecast to </span><code>PyObject</code><span> (see the </span><a href="https://codeconfessions.substack.com/p/cpython-object-system-internals-understanding" rel="">previous article on PyObject</a><span> to understand how), and because </span><code>PyObject</code><span> includes a pointer to </span><code>PyTypeObject</code><span>, the CPython runtime has all the type related information about the object available to it at all the times.</span></p><p><span>Now, let’s look inside </span><code>PyTypeObject</code><span>. It’s a very large object with dozens of fields. The following figure shows its full definition:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc473e75-3cf0-42ce-a7b3-11feee525c79_763x1617.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc473e75-3cf0-42ce-a7b3-11feee525c79_763x1617.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc473e75-3cf0-42ce-a7b3-11feee525c79_763x1617.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc473e75-3cf0-42ce-a7b3-11feee525c79_763x1617.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc473e75-3cf0-42ce-a7b3-11feee525c79_763x1617.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc473e75-3cf0-42ce-a7b3-11feee525c79_763x1617.png" width="763" height="1617" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/fc473e75-3cf0-42ce-a7b3-11feee525c79_763x1617.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:1617,&#34;width&#34;:763,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:317460,&#34;alt&#34;:&#34;Definition of the PyTypeObject struct&#34;,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="Definition of the PyTypeObject struct" title="Definition of the PyTypeObject struct" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc473e75-3cf0-42ce-a7b3-11feee525c79_763x1617.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc473e75-3cf0-42ce-a7b3-11feee525c79_763x1617.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc473e75-3cf0-42ce-a7b3-11feee525c79_763x1617.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc473e75-3cf0-42ce-a7b3-11feee525c79_763x1617.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>Definition of the PyTypeObject struct</figcaption></figure></div><p><code>The PyTypeObject</code><span> struct stores the runtime type details about the object, such as the type name, type size, functions to allocate and deallocate an object of that type.</span></p><p><span>Apart from that, it also stores function pointer tables for supporting various type specific behaviors. For instance, the </span><code>tp_as_number</code><span> field is one such table. It is a pointer to an object of type </span><a href="https://github.com/python/cpython/blob/3.12/Include/cpython/object.h#L59" rel="">PyNumberMethods</a><span> that defines a function pointer table for numeric operations.</span></p><p><span>Since we are interested in understanding how CPython executes the binary add (</span><code>+</code><span>) operator, we will zoom in and look at what’s inside </span><code>PyNumberMethods</code><span>. The following figure shows its definition:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75160d6d-7df2-4ce8-accb-96fbd93362a9_1400x641.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75160d6d-7df2-4ce8-accb-96fbd93362a9_1400x641.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75160d6d-7df2-4ce8-accb-96fbd93362a9_1400x641.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75160d6d-7df2-4ce8-accb-96fbd93362a9_1400x641.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75160d6d-7df2-4ce8-accb-96fbd93362a9_1400x641.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_2400,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75160d6d-7df2-4ce8-accb-96fbd93362a9_1400x641.png" width="1200" height="549.4285714285714" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/75160d6d-7df2-4ce8-accb-96fbd93362a9_1400x641.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:false,&#34;imageSize&#34;:&#34;large&#34;,&#34;height&#34;:641,&#34;width&#34;:1400,&#34;resizeWidth&#34;:1200,&#34;bytes&#34;:192249,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75160d6d-7df2-4ce8-accb-96fbd93362a9_1400x641.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75160d6d-7df2-4ce8-accb-96fbd93362a9_1400x641.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75160d6d-7df2-4ce8-accb-96fbd93362a9_1400x641.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75160d6d-7df2-4ce8-accb-96fbd93362a9_1400x641.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>Looking inside PyNumberMethods struct. The left side box is zoomed in definition of PyTypeObject, highlighting the PyNumberMethods field. The right side box is a partial definition of PyNumberMethods</figcaption></figure></div><p><span>Every type implementation in CPython needs to create an instance of </span><code>PyNumberMethods</code><span> struct and populate it with pointers to the functions that it implements for supporting numeric operators. If a type does not support numeric operations, it can simply set the </span><code>tp_as_number</code><span> field in </span><code>PyTypeObject</code><span> to </span><code>NULL</code><span>, which would tell the CPython runtime that this object does not support any of these operations. </span></p><p><span>Next, as a concrete example, let’s see how the </span><code>float</code><span> type implements these functions and then instantiates the </span><code>PyTypeObject</code><span> when creating a new float object.</span></p><p><span>The following figure shows the code from </span><a href="https://github.com/python/cpython/blob/3.12/Objects/floatobject.c" rel="">Objects/floatobject.c</a><span> which contains the implementation of the </span><code>float</code><span> type in CPython. </span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa0bd790a-6089-4092-9910-097eeb429a8b_1814x889.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa0bd790a-6089-4092-9910-097eeb429a8b_1814x889.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa0bd790a-6089-4092-9910-097eeb429a8b_1814x889.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa0bd790a-6089-4092-9910-097eeb429a8b_1814x889.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa0bd790a-6089-4092-9910-097eeb429a8b_1814x889.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_2400,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa0bd790a-6089-4092-9910-097eeb429a8b_1814x889.png" width="1200" height="588.4615384615385" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/a0bd790a-6089-4092-9910-097eeb429a8b_1814x889.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:false,&#34;imageSize&#34;:&#34;large&#34;,&#34;height&#34;:714,&#34;width&#34;:1456,&#34;resizeWidth&#34;:1200,&#34;bytes&#34;:350985,&#34;alt&#34;:&#34;How the float type implements numeric operators and populates the function pointer table in its instance of PyTypeObject, called PyFloat_Type&#34;,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="How the float type implements numeric operators and populates the function pointer table in its instance of PyTypeObject, called PyFloat_Type" title="How the float type implements numeric operators and populates the function pointer table in its instance of PyTypeObject, called PyFloat_Type" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa0bd790a-6089-4092-9910-097eeb429a8b_1814x889.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa0bd790a-6089-4092-9910-097eeb429a8b_1814x889.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa0bd790a-6089-4092-9910-097eeb429a8b_1814x889.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa0bd790a-6089-4092-9910-097eeb429a8b_1814x889.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>How the float type implements numeric operators and populates the function pointer table in its instance of PyTypeObject, called PyFloat_Type</figcaption></figure></div><p>Let’s break it down:</p><ul><li><p>The left most side box shows the functions which implement the add, subtract and multiply operations.</p></li><li><p><span>Next, the middle box shows an instance of the </span><code>PyNumberMethods</code><span> struct (called </span><code>float_as_number</code><span>) for the float data type. Notice how it includes the function pointers for the add, multiply and subtract functions.</span></p></li><li><p><span>The right most box shows an instance of the </span><code>PyTypeObject</code><span> for creating objects of float type. Notice how it includes a pointer to the </span><code>float_as_number</code><span> object. </span></p></li></ul><p><span>And, a pointer to </span><code>float_as_number</code><span> is included in every float object’s header (i.e. as the value of the </span><code>ob_type</code><span> field in </span><code>PyObject</code><span>). The following figure shows the function </span><a href="https://github.com/python/cpython/blob/3.12/Objects/floatobject.c#L131" rel="">PyFloat_FromDouble</a><span>, which creates new float type objects, and uses </span><code>float_as_number</code><span> to initialize the object header.</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F451eda26-020b-4c81-b7dd-c6e18597da86_1570x919.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F451eda26-020b-4c81-b7dd-c6e18597da86_1570x919.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F451eda26-020b-4c81-b7dd-c6e18597da86_1570x919.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F451eda26-020b-4c81-b7dd-c6e18597da86_1570x919.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F451eda26-020b-4c81-b7dd-c6e18597da86_1570x919.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_2400,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F451eda26-020b-4c81-b7dd-c6e18597da86_1570x919.png" width="1200" height="702.1978021978022" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/451eda26-020b-4c81-b7dd-c6e18597da86_1570x919.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:false,&#34;imageSize&#34;:&#34;large&#34;,&#34;height&#34;:852,&#34;width&#34;:1456,&#34;resizeWidth&#34;:1200,&#34;bytes&#34;:234309,&#34;alt&#34;:&#34;How an instance of the float type is created. Notice how it passes a pointer to PyFloat_Type in the call to _PyObject_Init to set its type.&#34;,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="How an instance of the float type is created. Notice how it passes a pointer to PyFloat_Type in the call to _PyObject_Init to set its type." title="How an instance of the float type is created. Notice how it passes a pointer to PyFloat_Type in the call to _PyObject_Init to set its type." srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F451eda26-020b-4c81-b7dd-c6e18597da86_1570x919.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F451eda26-020b-4c81-b7dd-c6e18597da86_1570x919.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F451eda26-020b-4c81-b7dd-c6e18597da86_1570x919.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F451eda26-020b-4c81-b7dd-c6e18597da86_1570x919.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>How an instance of the float type is created. Notice how it passes a pointer to PyFloat_Type in the call to _PyObject_Init to set its type.</figcaption></figure></div><p><span>The figure is pretty detailed and annotated, so I won’t spend anymore time on it. But this is the code which is executed when you write “</span><code>a = 3.14</code><span>” in your Python code.</span></p><blockquote><p><strong>Side note:</strong><span> </span><em>CPython maintains a cache of unused free float type objects and reuses them when it can. This possibly saves some time spent in memory allocation. There are similar caches for other objects, such as lists, tuples, dicts.</em></p></blockquote><p><span>At this point, we understand that every type implements various operators as functions and uses them to populate the function pointer table in </span><code>PyTypeObject</code><span>, which is included in the object header. We have seen how this scheme works in the implementation of the float type.</span></p><p>Next, we move one layer up and see the abstract object interface, which actually performs dynamic dispatch.</p><p data-attrs="{&#34;url&#34;:&#34;https://codeconfessions.substack.com/p/cpython-dynamic-dispatch-internals?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share&#34;,&#34;text&#34;:&#34;Share&#34;,&#34;action&#34;:null,&#34;class&#34;:null}" data-component-name="ButtonCreateButton"><a href="https://codeconfessions.substack.com/p/cpython-dynamic-dispatch-internals?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share" rel=""><span>Share</span></a></p><p>CPython defines an abstract object interface for unifying the access to the concrete type implementations. This keeps the VM code clean because it simply delegates the execution of an operator to this interface.</p><p><span>This abstract interface is defined in the file </span><a href="https://github.com/python/cpython/blob/3.12/Include/abstract.h" rel="">Include/abstract.h</a><span>. and the following figure shows the numeric functions declared in it:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e4888df-92a6-400d-9dee-a33b4c240db4_779x1010.jpeg" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e4888df-92a6-400d-9dee-a33b4c240db4_779x1010.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e4888df-92a6-400d-9dee-a33b4c240db4_779x1010.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e4888df-92a6-400d-9dee-a33b4c240db4_779x1010.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e4888df-92a6-400d-9dee-a33b4c240db4_779x1010.jpeg 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e4888df-92a6-400d-9dee-a33b4c240db4_779x1010.jpeg" width="779" height="1010" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/3e4888df-92a6-400d-9dee-a33b4c240db4_779x1010.jpeg&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:1010,&#34;width&#34;:779,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:null,&#34;alt&#34;:&#34;The abstract.h declares the abstract object interface, which includes functions for all the common object level operations in CPython. This figure shows a partial list of numeric operations as declared in abstract.h&#34;,&#34;title&#34;:null,&#34;type&#34;:null,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="The abstract.h declares the abstract object interface, which includes functions for all the common object level operations in CPython. This figure shows a partial list of numeric operations as declared in abstract.h" title="The abstract.h declares the abstract object interface, which includes functions for all the common object level operations in CPython. This figure shows a partial list of numeric operations as declared in abstract.h" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e4888df-92a6-400d-9dee-a33b4c240db4_779x1010.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e4888df-92a6-400d-9dee-a33b4c240db4_779x1010.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e4888df-92a6-400d-9dee-a33b4c240db4_779x1010.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e4888df-92a6-400d-9dee-a33b4c240db4_779x1010.jpeg 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption><span>The </span><code>abstract.h</code><span> header file declares the abstract object interface, which includes functions for all the common object level operations in CPython. This figure shows a partial list of numeric operations as declared in abstract.h</span></figcaption></figure></div><p><span>Now, </span><code>abstract.h</code><span> is a header file, so it only declares the prototypes of these functions. The implementations of these functions are in the file </span><a href="https://github.com/python/cpython/blob/3.12/Objects/abstract.c" rel="">Objects/abstract.c</a><span>. We will focus just on the implementation of the </span><code>PyNumber_Add</code><span> function in it, which is called by the VM to handle the </span><code>+</code><span> operator execution. The following figure shows its code, and the annotations explain what’s happening:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2a934799-4733-4f3b-a3b1-6c58e2708d1b_1486x781.jpeg" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2a934799-4733-4f3b-a3b1-6c58e2708d1b_1486x781.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2a934799-4733-4f3b-a3b1-6c58e2708d1b_1486x781.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2a934799-4733-4f3b-a3b1-6c58e2708d1b_1486x781.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2a934799-4733-4f3b-a3b1-6c58e2708d1b_1486x781.jpeg 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_2400,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2a934799-4733-4f3b-a3b1-6c58e2708d1b_1486x781.jpeg" width="1200" height="630.4945054945055" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/2a934799-4733-4f3b-a3b1-6c58e2708d1b_1486x781.jpeg&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:false,&#34;imageSize&#34;:&#34;large&#34;,&#34;height&#34;:765,&#34;width&#34;:1456,&#34;resizeWidth&#34;:1200,&#34;bytes&#34;:null,&#34;alt&#34;:&#34;abstract.c contains implementations of the functions declared in abstrac.h. This figure shows implementation of the PyNumber_Add function&#34;,&#34;title&#34;:null,&#34;type&#34;:null,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="abstract.c contains implementations of the functions declared in abstrac.h. This figure shows implementation of the PyNumber_Add function" title="abstract.c contains implementations of the functions declared in abstrac.h. This figure shows implementation of the PyNumber_Add function" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2a934799-4733-4f3b-a3b1-6c58e2708d1b_1486x781.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2a934799-4733-4f3b-a3b1-6c58e2708d1b_1486x781.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2a934799-4733-4f3b-a3b1-6c58e2708d1b_1486x781.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2a934799-4733-4f3b-a3b1-6c58e2708d1b_1486x781.jpeg 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>abstract.c contains implementations of the functions declared in abstrac.h. This figure shows implementation of the PyNumber_Add function</figcaption></figure></div><p><span>The </span><code>+</code><span> operation is supported by two classes of data types in Python: numeric types (</span><code>int</code><span>, </span><code>float</code><span>, </span><code>complex</code><span> etc.) and sequence types (</span><code>list</code><span>, </span><code>tuple</code><span>, etc.). </span></p><p><span>The </span><code>PyNumber_Add</code><span> function first tries to call the binary add implementation on the arguments. If those types do not support binary addition, then it tries to check if these types are sequence types, and if so, then it tries to call the concat function on them.</span></p><p><span>Let us focus on the numeric types here. For the numeric types, the </span><code>PyNumber_Add</code><span> function invokes the macro </span><code>BINARY_OP1</code><span>, which simply calls the </span><code>binary_op1</code><span> function. The following figure shows </span><code>binary_op1</code><span>:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b2c82e2-09d9-4c3b-9c0c-14949a6f19b3_1603x1071.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b2c82e2-09d9-4c3b-9c0c-14949a6f19b3_1603x1071.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b2c82e2-09d9-4c3b-9c0c-14949a6f19b3_1603x1071.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b2c82e2-09d9-4c3b-9c0c-14949a6f19b3_1603x1071.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b2c82e2-09d9-4c3b-9c0c-14949a6f19b3_1603x1071.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_2400,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b2c82e2-09d9-4c3b-9c0c-14949a6f19b3_1603x1071.png" width="1200" height="801.9230769230769" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/2b2c82e2-09d9-4c3b-9c0c-14949a6f19b3_1603x1071.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:false,&#34;imageSize&#34;:&#34;large&#34;,&#34;height&#34;:973,&#34;width&#34;:1456,&#34;resizeWidth&#34;:1200,&#34;bytes&#34;:335721,&#34;alt&#34;:&#34;The rest of the implementation of PyNumber_Add in abstract.c&#34;,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="The rest of the implementation of PyNumber_Add in abstract.c" title="The rest of the implementation of PyNumber_Add in abstract.c" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b2c82e2-09d9-4c3b-9c0c-14949a6f19b3_1603x1071.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b2c82e2-09d9-4c3b-9c0c-14949a6f19b3_1603x1071.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b2c82e2-09d9-4c3b-9c0c-14949a6f19b3_1603x1071.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b2c82e2-09d9-4c3b-9c0c-14949a6f19b3_1603x1071.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>The rest of the implementation of PyNumber_Add in abstract.c</figcaption></figure></div><p><span>The function is doing quite a lot of things, but the annotations explain everything. The key takeaway is that </span><code>abstract.c</code><span> simply does function pointer lookup in the methods table present in the object’s header, and calls that function.  </span></p><p>So far we have seen how a type implements various operators, and how the abstract object interface facilitates dynamic dispatch to those implementations. Now, for the final part, we will get back to the CPython VM and see where it calls the abstract object interface to execute an operator.</p><p><span>This is the final act where the CPython VM integrates operator execution with the abstract object interface. We discussed this partially in the previous article when understanding how the </span><code>PyObject</code><span> structure helps simulate polymorphism. This time, we will see it fully. But let’s start from the beginning.</span></p><p>The following figure shows a simple Python function and its bytecode instructions:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54eb1909-b150-4382-a587-a983521143c3_1363x800.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54eb1909-b150-4382-a587-a983521143c3_1363x800.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54eb1909-b150-4382-a587-a983521143c3_1363x800.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54eb1909-b150-4382-a587-a983521143c3_1363x800.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54eb1909-b150-4382-a587-a983521143c3_1363x800.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_2400,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54eb1909-b150-4382-a587-a983521143c3_1363x800.png" width="1200" height="704.3286867204696" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/54eb1909-b150-4382-a587-a983521143c3_1363x800.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:false,&#34;imageSize&#34;:&#34;large&#34;,&#34;height&#34;:800,&#34;width&#34;:1363,&#34;resizeWidth&#34;:1200,&#34;bytes&#34;:169314,&#34;alt&#34;:&#34;How the CPython stack based VM executes instructions&#34;,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="How the CPython stack based VM executes instructions" title="How the CPython stack based VM executes instructions" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54eb1909-b150-4382-a587-a983521143c3_1363x800.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54eb1909-b150-4382-a587-a983521143c3_1363x800.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54eb1909-b150-4382-a587-a983521143c3_1363x800.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54eb1909-b150-4382-a587-a983521143c3_1363x800.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>How the CPython stack based VM executes instructions</figcaption></figure></div><p><span>The bytecode instruction we are going to focus on is </span><code>BINARY_OP</code><span>. The following image shows how it is handled by the VM:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6686c1fe-069d-4b65-ba02-d5757802b35a_1487x598.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6686c1fe-069d-4b65-ba02-d5757802b35a_1487x598.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6686c1fe-069d-4b65-ba02-d5757802b35a_1487x598.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6686c1fe-069d-4b65-ba02-d5757802b35a_1487x598.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6686c1fe-069d-4b65-ba02-d5757802b35a_1487x598.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_2400,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6686c1fe-069d-4b65-ba02-d5757802b35a_1487x598.png" width="1200" height="482.967032967033" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/6686c1fe-069d-4b65-ba02-d5757802b35a_1487x598.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:false,&#34;imageSize&#34;:&#34;large&#34;,&#34;height&#34;:586,&#34;width&#34;:1456,&#34;resizeWidth&#34;:1200,&#34;bytes&#34;:191389,&#34;alt&#34;:&#34;Implementation of the BINARY_OP instruction in the CPython VM&#34;,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="Implementation of the BINARY_OP instruction in the CPython VM" title="Implementation of the BINARY_OP instruction in the CPython VM" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6686c1fe-069d-4b65-ba02-d5757802b35a_1487x598.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6686c1fe-069d-4b65-ba02-d5757802b35a_1487x598.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6686c1fe-069d-4b65-ba02-d5757802b35a_1487x598.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6686c1fe-069d-4b65-ba02-d5757802b35a_1487x598.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>Implementation of the BINARY_OP instruction in the CPython VM</figcaption></figure></div><p>I won’t spend time explaining any of this, as we covered this in the previous article. However, we glossed over the actual execution of the binary op, let’s see that code because that’s where the VM delegates to abstract.c.</p><p>In the above code, we see this line of code:</p><pre><code>res = binary_ops[oparg](lhs, rhs);</code></pre><p><span>This code is doing a function pointer lookup in a table called </span><code>binary_ops</code><span>, using the opcode of the binary operator as the index, and calling that function. Let’s take a look at this table which is defined in the file </span><a href="https://github.com/python/cpython/blob/3.12/Python/ceval.c#L287" rel="">ceval.c</a><span> (which is where most of the VM execution code is implemented).</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F16e57222-4ec0-4956-b9d0-6980b0fdb3bf_1580x812.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F16e57222-4ec0-4956-b9d0-6980b0fdb3bf_1580x812.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F16e57222-4ec0-4956-b9d0-6980b0fdb3bf_1580x812.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F16e57222-4ec0-4956-b9d0-6980b0fdb3bf_1580x812.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F16e57222-4ec0-4956-b9d0-6980b0fdb3bf_1580x812.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_2400,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F16e57222-4ec0-4956-b9d0-6980b0fdb3bf_1580x812.png" width="1200" height="616.4835164835165" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/16e57222-4ec0-4956-b9d0-6980b0fdb3bf_1580x812.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:false,&#34;imageSize&#34;:&#34;large&#34;,&#34;height&#34;:748,&#34;width&#34;:1456,&#34;resizeWidth&#34;:1200,&#34;bytes&#34;:274808,&#34;alt&#34;:&#34;The binary_ops table in CPython VM which indexes the operator functions as defined in abstract.c using the binary operators as the index&#34;,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="The binary_ops table in CPython VM which indexes the operator functions as defined in abstract.c using the binary operators as the index" title="The binary_ops table in CPython VM which indexes the operator functions as defined in abstract.c using the binary operators as the index" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F16e57222-4ec0-4956-b9d0-6980b0fdb3bf_1580x812.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F16e57222-4ec0-4956-b9d0-6980b0fdb3bf_1580x812.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F16e57222-4ec0-4956-b9d0-6980b0fdb3bf_1580x812.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F16e57222-4ec0-4956-b9d0-6980b0fdb3bf_1580x812.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>The binary_ops table in CPython VM which indexes the operator functions as defined in abstract.c using the binary operators as the index</figcaption></figure></div><p><span>Each function pointer in the </span><code>binary_ops</code><span> table points to a function which is implemented in </span><code>Objects/abstract.c</code><span>. In the previous section, we already saw the definition of </span><code>PyNumber_Add</code><span> in </span><code>abstract.c</code><span>, and understood how it does dynamic dispatch to the correct implementation of the operator based on the types of the operands.</span></p><p>So, this is how the VM delegates the execution of the binary operators to the abstract interface implementation, which ultimately performs the dynamic dispatch via function pointer lookup in the tables present in the object headers.</p><p><span>And, this is it! This is everything that goes on behind the scenes when you execute “</span><code>a + b</code><span>“ in your Python code. Let’s summarize quickly:</span></p><ul><li><p>Each type implements functions for the operators it supports and populates the function pointer table in its header (i.e., the PyTypeObject field inside PyObject).</p></li><li><p>Based on the operator, the CPython VM calls a function in the abstract object interface.</p></li><li><p>The abstract object interface (when called from the VM) performs function pointer table lookup in the header of the operand objects, and calls the right function.</p></li></ul><p><span>This was a short tour of ALL the CPython code which comes into action when you execute something as simple as “</span><code>a + b</code><span>” in your Python code. Although, this must be a lot to digest, it’s not too complex if you understand function pointers.</span></p><p>Equipped with this knowledge, you could implement your own operators, although for that you would also need to modify the tokenizer and parser which we have not talked about yet. Maybe we will cover those soon, if you have interest in learning more about CPython internals. Let me know via your comments, replies, likes and shares. </p><p data-attrs="{&#34;url&#34;:&#34;https://codeconfessions.substack.com/p/cpython-dynamic-dispatch-internals?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share&#34;,&#34;text&#34;:&#34;Share&#34;,&#34;action&#34;:null,&#34;class&#34;:null}" data-component-name="ButtonCreateButton"><a href="https://codeconfessions.substack.com/p/cpython-dynamic-dispatch-internals?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share" rel=""><span>Share</span></a></p></div></div></div></div>
  </body>
</html>
