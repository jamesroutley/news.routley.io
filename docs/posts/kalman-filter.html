<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://glitch.at.goth.cafe/kalman-filter/">Original</a>
    <h1>Kalman Filter</h1>
    
    <div id="readability-page-1" class="page"><div><h2 id="the-kalman-filter">The Kalman Filter</h2><p>Behold a wiggly and smooth lines animation for effect :crowd-cheering:</p><figure><img src="https://www.allthingsdistributed.com/images/blog-articles/kalman-filter/kalman-anim.gif"/></figure><p>Its terrible example, but I got your attention now so lets go! &lt;3</p><hr/><h2 id="intro">Intro</h2><p>Imagine you‚Äôre in a virtual world, wearing a VR headset that tracks your movements so you can explore, fight dragons, or build castles. But oh no! The sensors inside your headset, called IMUs, can sometimes get a bit confused and think you‚Äôve moved when you haven‚Äôt. This is called ‚Äúdrift,‚Äù and it can make you feel like you‚Äôre sliding or floating away in the game.</p><p>A Kalman Filter is an algorithm that helps correct their little mistakes and keeps track of where you really are, so you stay rooted in your virtual world. With a Kalman Filter, you can explore, battle, or build without worrying about drifting off course (bold claims to be verified, YMMV)! üõ°üêâüè∞</p><h2 id="filter-steps-overview">Filter Steps Overview</h2><p>This is how the kalman filter is described in the <a href="https://en.wikipedia.org/wiki/Kalman_filter">Wikipedia article</a>:</p><figure><img src="https://www.allthingsdistributed.com/images/blog-articles/kalman-filter/basic-concept-kalman-filtering.png"/></figure><p>Its a bit scary, so I want to break it down into easier to digest steps that even I your humble author can understand (because I selfishly want to use it in another mad experiment).</p><hr/><h2 id="explanation-of-each-part-of-the-filter-process">Explanation of Each Part Of The Filter Process</h2><h4 id="_prediction_"><em>Prediction</em></h4><p>Before you get a new measurement, your ‚Äúbest guess‚Äù is what you already thought before. You just keep your old guess for now.</p><p>$$ Prediction=Previous Estimate $$</p><h4 id="_update-estimation-error_"><em>Update Estimation Error</em></h4><p>Every time you make a new guess, it could be a little off. So, you add some ‚Äúprocess noise‚Äù to say ‚Äúmy guess might wander a little each time.‚Äù</p><p>$$ Updated Error=Previous Error+Process Noise $$</p><h4 id="_kalman-gain_"><em>Kalman Gain</em></h4><p>Kalman Gain is like a ‚Äúmagic mixing number.‚Äù It decides how much to trust the new measurement compared to your prediction. If the measurement is really noisy, you‚Äôll trust your prediction more, and vice versa.</p><p>$$ K=Updated ErrorUpdated Error+Measurement Noise $$</p><h4 id="_new-estimate_"><em>New Estimate</em></h4><p>Now, you mix your prediction and the new measurement. You adjust your prediction based on how far off the measurement was. The amount you adjust is controlled by the Kalman Gain!</p><p>$$ New Estimate=Prediction+K√ó(Measurement‚àíPrediction) $$</p><p>Thats it! Now you have a new estimate and how you sort of converge on values you can trust. You can use it for your next prediction, and the cycle continues.</p><hr/><h3 id="a-key-insight-here-the-kalman-gain">A Key Insight Here: The Kalman Gain</h3><p>The Kalman Gain is a value between 0 and 1 that determines how much to trust the measurement vs. the filters prediction. If the measurement is very noisy, the Kalman Gain will be close to 0, and the new estimate will be close to the previous estimate. If the measurement is very precise, the Kalman Gain will be close to 1, and the new estimate will be close to the measurement. Usually, the Kalman Gain is somewhere in between.</p><p><em>Essentially, it decides how much to trust new information from the sensor and how much to trust what we already know (the prediction).</em></p><p>And to represent it in a consise way:</p><p>$$
[
\text{Kalman Gain} = \frac{\text{Estimation Error}}{\text{Estimation Error} + \text{Measurement Noise}}
]
‚Äã$$</p><hr/><h2 id="implementation-in-code">Implementation In Code</h2><p>Since the state needs to be kept since the last measurement, a class/object is very tidy fit for this problem because the state is tightly bound to the code. Let implement it now in JavaScript, its surprisingly easy and really just the steps outlined above.</p><p>The class needs to take the following parameters:</p><p><strong>processNoise</strong>: This variable represents the expected noise or uncertainty in the process itself, separate from the measurements. In other words, even if you had a perfect measurement, the process you are measuring might naturally vary. For instance, if you‚Äôre measuring temperature, natural fluctuations occur even if your thermometer is perfect.</p><p><strong>measurementNoise</strong>: This variable represents the expected noise or uncertainty in the measurements. It‚Äôs not about how the thing you‚Äôre measuring is changing; it‚Äôs about how imprecise your measurements are.</p><p><strong>estimationError</strong>: This variable is your initial guess at how uncertain your initial estimate is. This is updated over time based on the measurements you take and whats called the <code>Kalman Gain</code>.</p><p><strong>initialValue</strong>: This is your initial estimate of the value you‚Äôre tracking. For example, iif you‚Äôre tracking temperature and you have no idea what it is, you might start at a default like 0?</p><div><pre tabindex="0"><code data-lang="javascript"><span><span>  <span>class</span> <span>KalmanFilter</span> {
</span></span><span><span>    <span>constructor</span>(<span>processNoise</span>, <span>measurementNoise</span>, <span>estimationError</span>, <span>initialValue</span> <span>=</span> <span>0</span>) {
</span></span><span><span>      <span>this</span>.<span>processNoise</span> <span>=</span> <span>processNoise</span>;
</span></span><span><span>      <span>this</span>.<span>measurementNoise</span> <span>=</span> <span>measurementNoise</span>;
</span></span><span><span>      <span>this</span>.<span>estimationError</span> <span>=</span> <span>estimationError</span>;
</span></span><span><span>      <span>this</span>.<span>estimate</span> <span>=</span> <span>initialValue</span>;
</span></span><span><span>    }
</span></span><span><span>
</span></span><span><span>    <span>update</span>(<span>measurement</span>) {
</span></span><span><span>        <span>// Step 1: Update estimation error based on process noise
</span></span></span><span><span><span></span>        <span>this</span>.<span>estimationError</span> <span>+=</span> <span>this</span>.<span>processNoise</span>;
</span></span><span><span>
</span></span><span><span>        <span>// Step 2: Calculate the Kalman Gain
</span></span></span><span><span><span></span>        <span>const</span> <span>kalmanGain</span> <span>=</span> <span>this</span>.<span>estimationError</span> <span>/</span> (<span>this</span>.<span>estimationError</span> <span>+</span> <span>this</span>.<span>measurementNoise</span>);
</span></span><span><span>
</span></span><span><span>        <span>// Step 3: Update the current estimate
</span></span></span><span><span><span></span>        <span>this</span>.<span>estimate</span> <span>+=</span> <span>kalmanGain</span> <span>*</span> (<span>measurement</span> <span>-</span> <span>this</span>.<span>estimate</span>);
</span></span><span><span>
</span></span><span><span>        <span>// Step 4: Update the estimation error
</span></span></span><span><span><span></span>        <span>this</span>.<span>estimationError</span> <span>*=</span> (<span>1</span> <span>-</span> <span>kalmanGain</span>);
</span></span><span><span>
</span></span><span><span>        <span>// Return the updated estimate
</span></span></span><span><span><span></span>        <span>return</span> <span>this</span>.<span>estimate</span>;
</span></span><span><span>    }
</span></span><span><span>  }
</span></span></code></pre></div><h2 id="example-parameters-for-an-imu-kalman-filter">Example Parameters For An IMU Kalman Filter:</h2><p><strong>initialValue</strong>: If you‚Äôre measuring orientation, a good initial value could be the angle given by the first sensor reading when you start the system. This assumes that you have a ‚Äúboot-up‚Äù position that is relatively stable and known.</p><p><em>Why</em>: Using the first measurement as an initial value is often a good idea because it‚Äôs usually the best estimate you have when starting the system right?!</p><p><strong>estimationError</strong>: Since this is the beginning and you haven‚Äôt received much data yet, you could set this to a high value like 1.</p><p><em>Why</em>: This high initial estimation error reflects your initial uncertainty about the orientation angle. It allows the filter to quickly adapt to the incoming measurements.</p><p><strong>processNoise</strong>: Given the factors like temperature fluctuations, magnetic field variations, and potential for mechanical vibrations, a reasonable value might be 0.01.</p><p><em>Why</em>: This value would allow for some inherent instability or drift in the IMU data but assumes that the sensor is reasonably reliable. You‚Äôre acknowledging that some error will accumulate over time but are optimistic it won‚Äôt be too bad.</p><p><strong>measurementNoise</strong>: If you‚Äôre using a high-quality IMU with low sensor noise, a value like 0.05 might be appropriate.</p><p><em>Why</em>: This value is lower than the processNoise because we assume that individual measurements are fairly accurate but not perfect. Lower measurementNoise compared to processNoise means you trust the measurements more than the internal state of the filter.</p><p>And in code it would look like this:</p><div><pre tabindex="0"><code data-lang="javascript"><span><span><span>// Initialize the Kalman filter for the IMU
</span></span></span><span><span><span></span><span>const</span> <span>imuKalmanFilter</span> <span>=</span> <span>new</span> <span>KalmanFilter</span>(<span>0.01</span>, <span>0.05</span>, <span>1</span>, <span>/* first sensor reading */</span>);
</span></span></code></pre></div><hr/><h2 id="in-closing">In Closing</h2><p>And that, my friends is it. Its that simple. Now lets see it in action, I have created a page that shows the Kalman Filter in action using a little simulation that I wrote. You can play with the values and see how it affects the filter. The yellow line is the filtered signal, the red line is the ‚Äúraw‚Äù IMU signal, and the white line is the ‚Äútrue‚Äù value ‚Äì the perfect value if there was no noise or errors.</p><p>All of the code is also available, and you can remix it and play with it as you like <a href="https://glitch.com/edit/#!/kalman-filter-example?path=index.html">https://glitch.com/edit/#!/kalman-filter-example?path=index.html</a></p><p>Until next time sweathearts! üíñ</p></div></div>
  </body>
</html>
