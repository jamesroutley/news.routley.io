<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.righto.com/2023/11/reverse-engineering-intel-386.html">Original</a>
    <h1>Reverse engineering the Intel 386 processor&#39;s register cell</h1>
    
    <div id="readability-page-1" class="page"><div id="post-body-6565762679814978317" itemprop="description articleBody">
<p>The groundbreaking Intel 386 processor (1985) was the first 32-bit processor in the x86 line.
It has numerous internal registers: general-purpose registers, index registers, segment selectors, and
more specialized registers.
In this blog post, I look at the silicon die of the 386 and explain how some of these registers are
implemented at the transistor level.
The registers that I examined are implemented as static RAM, with each bit stored in a common 8-transistor circuit, known as &#34;8T&#34;.
Studying this circuit shows the interesting layout techniques that Intel used to squeeze two storage cells together to minimize the space they require.</p>
<p>The diagram below shows the internal structure of the 386. I have marked the relevant registers with three red
boxes. Two sets of registers are in the segment descriptor cache, presumably holding cache entries, and one set is at the bottom of
the data path. Some of the registers at the bottom are 32 bits wide, while others are half as wide and
hold 16 bits. (More registers with different circuits, but I
won&#39;t discuss them in this post.)</p>
<p><a href="https://static.righto.com/images/386-reg/die-labeled-regs.jpg"><img alt="The 386 with the main functional blocks labeled. Click this image (or any other) for a larger version. I created this image using a die photo from Antoine Bercovici." height="641" src="https://static.righto.com/images/386-reg/die-labeled-regs-w600.jpg" title="The 386 with the main functional blocks labeled. Click this image (or any other) for a larger version. I created this image using a die photo from Antoine Bercovici." width="600"/></a></p><p>The 386 with the main functional blocks labeled. Click this image (or any other) for a larger version. I created this image using a die photo from Antoine Bercovici.</p>
<h2>The 6T and 8T static RAM cells</h2>
<p>First, I&#39;ll explain how a 6T or 8T static cell holds a bit.
The basic idea behind a static RAM cell is to connect two inverters into a loop.
This circuit will be stable, with one inverter on and one inverter off, and each inverter supporting the other.
Depending on which inverter is on,
the circuit stores a 0 or a 1.</p>
<p><a href="https://static.righto.com/images/386-reg/inverter-loop.png"><img alt="Two inverters in a loop can store a 0 or a 1." height="121" src="https://static.righto.com/images/386-reg/inverter-loop-w250.png" title="Two inverters in a loop can store a 0 or a 1." width="250"/></a></p><p>Two inverters in a loop can store a 0 or a 1.</p>
<p>To write a new value into the circuit, two signals are fed in, forcing the inverters to the desired new values.
One inverter receives the new bit value, while the other inverter receives the complemented bit value.
This may seem like a brute-force way to update the bit, but it works.
The trick is that the inverters in the cell are small and weak, while the input signals are higher current,
able to overpower the inverters.<span id="fnref:flip"><a href="#fn:flip">1</a></span>
The write data lines (called bitlines) are connected to the inverters by pass transistors.<span id="fnref:pass"><a href="#fn:pass">2</a></span> When the pass transistors are on, the
signals on the write lines can pass through to the inverters. But when the pass transistors are off, the
inverters are isolated from the write lines.
Thus, the write control signal enables writing a new value to the inverters.
(This signal is called a wordline since it controls access to a word of storage.)
Since each inverter consists of two transistors<span id="fnref:inverter"><a href="#fn:inverter">7</a></span>, the circuit below consists of six transistors,
forming the 6T storage cell.</p>
<p><a href="https://static.righto.com/images/386-reg/simple-cell.png"><img alt="Adding pass transistor so the cell can be written." height="125" src="https://static.righto.com/images/386-reg/simple-cell-w350.png" title="Adding pass transistor so the cell can be written." width="350"/></a></p><p>Adding pass transistor so the cell can be written.</p>
<p>The 6T cell uses the same bitlines for reading and writing.
Adding two transistors creates the 8T circuit, which has the advantage that you can read one register
and write to another register at the same time. (I.e. the register file is two-ported.)
In the 8T cell below, two additional transistors (G and H) are used for reading.
Transistor G buffers the cell&#39;s value; it turns on if the inverter output is high, pulling the read output bitline low.<span id="fnref:precharge"><a href="#fn:precharge">3</a></span>
Transistor H is a pass transistor that blocks this signal until a read is performed on this register;
it is controlled by a read wordline.</p>
<p><a href="https://static.righto.com/images/386-reg/cell-schematic.png"><img alt="Schematic of a storage cell. Each transistor is labeled with a letter." height="155" src="https://static.righto.com/images/386-reg/cell-schematic-w500.png" title="Schematic of a storage cell. Each transistor is labeled with a letter." width="500"/></a></p><p>Schematic of a storage cell. Each transistor is labeled with a letter.</p>
<p>To form registers (or memory), a grid is constructed from these cells.
Each row corresponds to a register, while each column corresponds to a bit position.
The horizontal lines are the wordlines, selecting which word to access, while the
vertical lines are the bitlines, passing bits in or out of the registers.
For a write, the vertical bitlines provide the 32 bits (along with their complements).
For a read, the vertical bitlines receive the 32 bits from the register.
A wordline is activated to read or write the selected register.</p>
<p><a href="https://static.righto.com/images/386-reg/grid.png"><img alt="Static memory cells (8T) organized into a grid." height="433" src="https://static.righto.com/images/386-reg/grid-w500.png" title="Static memory cells (8T) organized into a grid." width="500"/></a></p><p>Static memory cells (8T) organized into a grid.</p>
<h2>Silicon circuits in the 386</h2>
<p>Before showing the layout of the circuit on the die, I should give a bit of background on the technology used
to construct the 386.
The 386 was built with CMOS technology, with NMOS and PMOS transistors working together, an advance over the
earlier x86 chips that were built with NMOS transistors.
Intel called this CMOS technology CHMOS-III (complementary high-performance metal-oxide-silicon), with 1.5 Âµm features.
While Intel&#39;s earlier chips had a single metal layer, CHMOS-III provided two metal layers, making signal
routing much easier.</p>
<p>Because CMOS uses both NMOS and PMOS transistors, fabrication is more complicated.
In an MOS integrated circuit, a transistor is formed where a polysilicon wire crosses active silicon,
creating the transistor&#39;s gate.
A PMOS transistor is constructed directly on the silicon substrate (which is N-doped).
However, an NMOS transistor is the opposite, requiring a P-doped substrate.
This is created by forming a P well, a region
of P-doped silicon that holds NMOS transistors.
Each P well must be connected to ground; this is accomplished by connecting ground to specially-doped regions of the P well, called &#34;well taps&#34;`.</p>
<p>The diagram below shows a cross-section through two transistors, showing the layers of the chip.
There are four important layers: silicon (which has some regions doped to form active
silicon), polysilicon for wiring and transistors, and the two metal layers.
At the bottom is the silicon, with P or N doping; note the P-well for the NMOS transistor on the left.
Next is the polysilicon layer.
At the top are the two layers of metal, named M1 and M2. 
Conceptually, the chip is constructed from flat layers, but the layers have a three-dimensional
structure influenced by the layers below.
The layers are separated by silicon dioxide (&#34;ox&#34;) or silicon oxynitride<span id="fnref:oxynitride"><a href="#fn:oxynitride">4</a></span>; the
oxynitride under M2 caused me considerable difficulty.</p>
<p><a href="https://static.righto.com/images/386-reg/process-cross-section.jpg"><img alt="A cross-section of circuitry formed with the CHMOS-III process. From A double layer metal CHMOS III technology." height="244" src="https://static.righto.com/images/386-reg/process-cross-section-w600.jpg" title="A cross-section of circuitry formed with the CHMOS-III process. From A double layer metal CHMOS III technology." width="600"/></a></p>
<p>The image below shows how circuitry appears on the die;<span id="fnref:layers"><a href="#fn:layers">5</a></span>
I removed the metal layers to show the silicon and polysilicon that form transistors.
(As will be described below, this image shows two static cells, holding two bits.)
The pinkish and dark regions are active silicon, doped to take part in the circuits, while the &#34;background&#34; silicon
can be ignored.
The green lines are polysilicon lines on top of the silicon.
Transistors are the most important feature here: a transistor gate is formed when polysilicon crosses active
silicon, with the source and drain on either side.
The upper part of the image has PMOS transistors, while the lower part of the image has the P well that holds
NMOS transistors. (The well itself is not visible.)
In total, the image shows four PMOS transistors and 12 NMOS transistors.
At the bottom, the well taps connect the P well to ground.
Although the metal has been removed, the contacts between the lower metal layer (M1) and the silicon or
polysilicon are visible as faint circles.</p>
<p><a href="https://static.righto.com/images/386-reg/die-components.jpg"><img alt="A (heavily edited) closeup of the die." height="407" src="https://static.righto.com/images/386-reg/die-components-w600.jpg" title="A (heavily edited) closeup of the die." width="600"/></a></p><p>A (heavily edited) closeup of the die.</p>
<h2>Register layout in the 386</h2>
<p>Next, I&#39;ll explain the layout of these cells in the 386.
To increase the circuit density, two cells are put side-by-side, with a mirrored layout.
In this way, each row holds two interleaved registers.<span id="fnref:density"><a href="#fn:density">6</a></span>
The schematic below shows the arrangement of the paired cells, matching the die image above.
Transistors A and B form the first inverter,<span id="fnref2:inverter"><a href="#fn:inverter">7</a></span> while transistors C and D form the second
inverter.
Pass transistors E and F allow the bitlines to write the cell.
For reading, transistor G amplifies the signal while pass transistor H connects the selected bit to the
output.</p>
<p><a href="https://static.righto.com/images/386-reg/schematic-full.png"><img alt="Schematic of two static cells in the 386. The schematic approximately matches the physical layout." height="273" src="https://static.righto.com/images/386-reg/schematic-full-w700.png" title="Schematic of two static cells in the 386. The schematic approximately matches the physical layout." width="700"/></a></p><p>Schematic of two static cells in the 386. The schematic approximately matches the physical layout.</p>
<p>The left and right sides are approximately mirror images, with separate read and write control lines for
each half.
Because the control lines for the left and right sides are in different positions, the two sides have
some layout differences, in particular, the bulging loop on the right.
Mirroring the cells increases the density since the bitlines can be shared by the cells.</p>
<!--
Inconveniently, the read outputs for the two cells are at opposite ends, so the output on the left is connected
to the read bitline on the right.
-->

<p>The diagram below shows the various components on the die,
labeled to match the schematic above.
I&#39;ve drawn the lower M1 metal wiring in blue, but omitted the M2 wiring (horizontal control lines, power, and ground). &#34;Read crossover&#34; indicates the connection from the read output on the left to the bitline on the right.
Black circles indicate vias between M1 and M2, green circles indicate contacts between silicon and M1, and
reddish circles indicate contacts between polysilicon and M1.</p>
<p><a href="https://static.righto.com/images/386-reg/cell-silicon.jpg"><img alt="The layout of two static cells. The M1 metal layer is drawn in blue; the horizontal M2 lines are not shown." height="396" src="https://static.righto.com/images/386-reg/cell-silicon-w600.jpg" title="The layout of two static cells. The M1 metal layer is drawn in blue; the horizontal M2 lines are not shown." width="600"/></a></p><p>The layout of two static cells. The M1 metal layer is drawn in blue; the horizontal M2 lines are not shown.</p>
<p>One more complication is that alternating registers (i.e. rows) are reflected vertically, as shown below.
This allows one horizontal power line to feed two rows, and similarly for a horizontal ground line.
This cuts the number of power/ground lines in half, making the layout more efficient.</p>
<p><a href="https://static.righto.com/images/386-reg/multi-cells.jpg"><img alt="Multiple storage cells." height="387" src="https://static.righto.com/images/386-reg/multi-cells-w500.jpg" title="Multiple storage cells." width="500"/></a></p><p>Multiple storage cells.</p>
<p>Having two layers of metal makes the circuitry considerably more difficult to reverse engineer. The
photo below (left) shows one of the static RAM cells as it appears under the microscope.
Although the structure of the metal layers is visible in the photograph, there is a lot of ambiguity.
It is difficult to distinguish the two layers of metal. Moreover, the metal completely hides the
polysilicon layer, not to mention the underlying silicon.
The large black circles are vias between the two metal layers.
The smaller faint circles are contacts between a metal layer and the underlying silicon or polysilicon.</p>
<p><a href="https://static.righto.com/images/386-reg/metal-layers.jpg"><img alt="One cell as it appears on the die, with a diagram of the upper (M2) and lower (M1) metal layers." height="452" src="https://static.righto.com/images/386-reg/metal-layers-w600.jpg" title="One cell as it appears on the die, with a diagram of the upper (M2) and lower (M1) metal layers." width="600"/></a></p><p>One cell as it appears on the die, with a diagram of the upper (M2) and lower (M1) metal layers.</p>
<p>With some effort, I determined the metal layers, which I show on the right:
M2 (upper) and M1 (lower).
By comparing the left and right images, you can see how the structure of the metal layers is somewhat visible.
I use black circles to
indicate vias between the layers, green circles indicate contacts between M1 and silicon, and pink circles indicate
contacts between M1 and polysilicon.
Note that both metal layers are packed as tightly as possible.
The layout of this circuit was highly optimized to minimize the area.
It is interesting to note that decreasing the size of the transistors wouldn&#39;t help with this circuit, since
the size is limited by the metal density.
This illustrates that a fabrication process must balance the size of the metal features, polysilicon features,
and silicon features since over-optimizing one won&#39;t help the overall chip density.</p>
<p>The photo below shows the bottom of the register file.
The &#34;notch&#34; makes the registers at the very bottom half-width:
4 half-width rows corresponding to eight 16-bit registers.
Since there are six 16-bit segment registers in the 386, I suspect these are the segment registers and
two mystery registers.</p>
<p><a href="https://static.righto.com/images/386-reg/split.jpg"><img alt="The bottom of the register file." height="186" src="https://static.righto.com/images/386-reg/split-w500.jpg" title="The bottom of the register file." width="500"/></a></p><p>The bottom of the register file.</p>
<p>I haven&#39;t been able to determine which registers in the 386 correspond to the other registers on the die.
In the segment descriptor circuitry, there are two rows of register cells with ten more rows below,
corresponding to 24 32-bit registers. These are presumably segment descriptors.
At the bottom of the datapath, there are 10 32-bit registers with the T8 circuit.
The 386&#39;s programmer-visible registers consist of eight general-purpose 32-bit registers (EAX, etc.).
The 386 has various control registers, test registers, and segmentation registers<span id="fnref:registers"><a href="#fn:registers">8</a></span> that are
not well known.
The 8086 has a few registers for internal use that aren&#39;t visible to the programmer, so the 386 presumably
has even more invisible registers.
At this point, I can&#39;t narrow down the functionality.</p>

<p>It&#39;s interesting to examine how registers are implemented in a real processor. 
There are plenty of descriptions of the 8T static cell circuit, but it turns out that the physical implementation
is more complicated than the theoretical description.
Intel put a lot of effort into optimizing this circuit, resulting in a dense block of circuitry.
By mirroring cells horizontally and vertically, the density could be increased further.</p>
<p>Reverse engineering one small circuit of the 386 turned out to be pretty tricky, so I don&#39;t plan to do
a complete reverse engineering.
The main difficulty is the two layers of metal are hard to untangle.
Moreover, I lost most of the polysilicon when removing the metal.
Finally, it is hard to draw diagrams with four layers without the diagram turning into a mess,
but hopefully the diagrams made sense.</p>
<p>I plan to write more about the 386, so 
follow me on Twitter <a href="https://twitter.com/kenshirriff">@kenshirriff</a> or <a href="https://www.righto.com/feeds/posts/default">RSS</a> for updates.
I&#39;m also on Mastodon occasionally as <a href="https://oldbytes.space/@kenshirriff">@<span data-cfemail="3a515f544952534848535c5c7a55565e58434e5f4914494a5b595f">[emailÂ protected]</span></a>.</p>
<h2>Notes and references</h2>


</div></div>
  </body>
</html>
