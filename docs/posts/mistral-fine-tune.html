<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/mistralai/mistral-finetune">Original</a>
    <h1>Mistral Fine-Tune</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<a href="https://colab.research.google.com/github/mistralai/mistral-finetune/blob/main/tutorials/mistral_finetune_7b.ipynb" rel="nofollow">
  <img src="https://camo.githubusercontent.com/f5e0d0538a9c2972b5d413e0ace04cecd8efd828d133133933dfffec282a4e1b/68747470733a2f2f636f6c61622e72657365617263682e676f6f676c652e636f6d2f6173736574732f636f6c61622d62616467652e737667" alt="Open In Colab" data-canonical-src="https://colab.research.google.com/assets/colab-badge.svg"/>
</a>
<p dir="auto"><code>mistral-finetune</code> is a light-weight codebase that enables memory-efficient and performant finetuning of Mistral&#39;s models.
It is based on <a href="https://arxiv.org/abs/2106.09685" rel="nofollow">LoRA</a>, a training paradigm where most weights are frozen and only 1-2% additional weights in the form of low-rank matrix perturbations are trained.</p>
<p dir="auto">For maximum efficiency it is recommended to use a A100 or H100 GPU. The codebase is optimized
for multi-GPU-single-node training setups, but for smaller models, such as the 7B a single GPU suffices.</p>
<blockquote>
<p dir="auto"><strong>Note</strong></p>
<ul dir="auto">
<li>The goal of this repository is to provide a simple, guided entrypoint to finetune Mistral models.
As such, it is fairly opinionated (especially around data formatting) and does not aim at being exhaustive
across multiple model architecture or hardware types.
For more generic approaches, you can check out some other great projects like
<a href="https://pytorch.org/torchtune/stable/overview.html" rel="nofollow">torchtune</a>.</li>
</ul>
</blockquote>

<p dir="auto">To get started with Mistral LoRA fine-tuning, follow these steps:</p>
<ol dir="auto">
<li>Clone this repository:</li>
</ol>
<div data-snippet-clipboard-copy-content="cd $HOME &amp;&amp; git clone https://github.com/mistralai/mistral-finetune.git"><pre><code>cd $HOME &amp;&amp; git clone https://github.com/mistralai/mistral-finetune.git
</code></pre></div>
<ol start="2" dir="auto">
<li>Install all required dependencies:</li>
</ol>
<div data-snippet-clipboard-copy-content="cd mistral-finetune
pip install -r requirements.txt"><pre><code>cd mistral-finetune
pip install -r requirements.txt
</code></pre></div>

<p dir="auto">We recommend fine-tuning one of the official Mistral models which you can download here:</p>
<table>
<thead>
<tr>
<th>Model</th>
<th>Link</th>
<th>Checksum</th>
</tr>
</thead>
<tbody>
<tr>
<td>7B Base V3</td>
<td><a href="https://models.mistralcdn.com/mistral-7b-v0-3/mistral-7B-v0.3.tar" rel="nofollow">7B Base</a></td>
<td><code>0663b293810d7571dad25dae2f2a5806</code></td>
</tr>
<tr>
<td>7B Instruct v3</td>
<td><a href="https://models.mistralcdn.com/mistral-7b-v0-3/mistral-7B-Instruct-v0.3.tar" rel="nofollow">7B Instruct v3</a></td>
<td><code>80b71fcb6416085bcb4efad86dfb4d52</code></td>
</tr>
<tr>
<td>8x7B Base V1</td>
<td><a href="https://huggingface.co/mistralai/Mixtral-8x7B-v0.1" rel="nofollow">8x7B Base</a></td>
<td>(HF link)</td>
</tr>
<tr>
<td>8x7B Instruct V1</td>
<td><a href="https://models.mistralcdn.com/mixtral-8x7b-v0-1/Mixtral-8x7B-v0.1-Instruct.tar" rel="nofollow">8x7B Instruct</a></td>
<td><code>8e2d3930145dc43d3084396f49d38a3f</code></td>
</tr>
<tr>
<td>8x22 Instruct V3</td>
<td><a href="https://models.mistralcdn.com/mixtral-8x22b-v0-3/mixtral-8x22B-Instruct-v0.3.tar" rel="nofollow">8x22 Instruct</a></td>
<td><code>471a02a6902706a2f1e44a693813855b</code></td>
</tr>
<tr>
<td>8x22B Base V3</td>
<td><a href="https://models.mistralcdn.com/mixtral-8x22b-v0-3/mixtral-8x22B-v0.3.tar" rel="nofollow">8x22B Base</a></td>
<td><code>a2fa75117174f87d1197e3a4eb50371a</code></td>
</tr>
</tbody>
</table>
<p dir="auto"><strong>Important Notice</strong>: For 8x7B Base V1 and 8x7B Instruct V1, it is necessary to use our v3 tokenizer and extend the vocabulary size to 32768 prior to fine-tuning. For detailed instructions on this process, please refer to the <a href="https://github.com/mistralai/mistral-finetune?tab=readme-ov-file#model-extension">&#34;Model extension&#34;</a> section.</p>
<p dir="auto">E.g., to download the 7B-base model you can run the following command:</p>
<div dir="auto" data-snippet-clipboard-copy-content="mkdir -p ~/${HOME}/mistral_models
cd ${HOME} &amp;&amp; wget https://models.mistralcdn.com/mistral-7b-v0-3/mistral-7B-v0.3.tar
tar -xf mistral-7B-v0.3.tar -C mistral_models"><pre>mkdir -p <span>~</span>/<span>${HOME}</span>/mistral_models
<span>cd</span> <span>${HOME}</span> <span>&amp;&amp;</span> wget https://models.mistralcdn.com/mistral-7b-v0-3/mistral-7B-v0.3.tar
tar -xf mistral-7B-v0.3.tar -C mistral_models</pre></div>
<p dir="auto">Make sure to modify your training script and add the path to the downloaded
folder as <code>model_id_or_path</code>.</p>
<p dir="auto">E.g., modify <a href="https://github.com/mistralai/mistral-finetune/blob/main/example/7B.yaml">example/7B.yaml</a> to include the absolute path to <code>$HOME/mistral_models/7B</code>:</p>
<div data-snippet-clipboard-copy-content="model_id_or_path: &#34;/Users/johndoe/mistral_models/7B&#34;"><pre><code>model_id_or_path: &#34;/Users/johndoe/mistral_models/7B&#34;
</code></pre></div>

<p dir="auto">To ensure effective training, <code>mistral-finetune</code> has strict
requirements for how the training data has to be formatted.</p>
<p dir="auto">All data files must be stored in jsonl format files.</p>
<p dir="auto">You can build two types of data files:</p>

<p dir="auto">Pretrain data corresponds to plain text data stored in the <code>&#34;text&#34;</code> key. E.g:</p>
<div dir="auto" data-snippet-clipboard-copy-content="{&#34;text&#34;: &#34;Text contained in document n°1&#34;}
{&#34;text&#34;: &#34;Text contained in document n°2&#34;}"><pre>{<span>&#34;text&#34;</span>: <span><span>&#34;</span>Text contained in document n°1<span>&#34;</span></span>}
{<span>&#34;text&#34;</span>: <span><span>&#34;</span>Text contained in document n°2<span>&#34;</span></span>}</pre></div>

<p dir="auto">Currently two different types of instruction following data are supported:</p>
<ul dir="auto">
<li><em>Instruct</em>: conversational data stored in the <code>&#34;messages&#34;</code> key in the form of a list. Each list item is a dictionary containing the <code>&#34;content&#34;</code> and <code>&#34;role&#34;</code> keys. <code>&#34;role&#34;</code> is a string being one of &#34;user&#34;, &#34;assistant&#34; or &#34;system_prompt&#34;. The loss will only be computed if &#34;role&#34; == &#34;assistant&#34;. E.g.:</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="{
  &#34;messages&#34;: [
    {
      &#34;role&#34;: &#34;user&#34;,
      &#34;content&#34;: &#34;User interaction n°1 contained in document n°1&#34;
    },
    {
      &#34;role&#34;: &#34;assistant&#34;,
      &#34;content&#34;: &#34;Bot interaction n°1 contained in document n°1&#34;
    },
    {
      &#34;role&#34;: &#34;user&#34;,
      &#34;content&#34;: &#34;User interaction n°2 contained in document n°1&#34;
    },
    {
      &#34;role&#34;: &#34;assistant&#34;,
      &#34;content&#34;: &#34;Bot interaction n°2 contained in document n°1&#34;
    }
  ]
}
{
  &#34;messages&#34;: [
    {
      &#34;role&#34;: &#34;user&#34;,
      &#34;content&#34;: &#34;User interaction n°1 contained in document n°2&#34;
    },
    {
      &#34;role&#34;: &#34;assistant&#34;,
      &#34;content&#34;: &#34;Bot interaction n°1 contained in document n°2&#34;
    },
    {
      &#34;role&#34;: &#34;user&#34;,
      &#34;content&#34;: &#34;User interaction n°2 contained in document n°2&#34;
    },
    {
      &#34;role&#34;: &#34;assistant&#34;,
      &#34;content&#34;: &#34;Bot interaction n°2 contained in document n°2&#34;,
      &#34;weight&#34;: 0,  # don&#39;t train on n°2
    },
    {
      &#34;role&#34;: &#34;user&#34;,
      &#34;content&#34;: &#34;User interaction n°3 contained in document n°2&#34;
    },
    {
      &#34;role&#34;: &#34;assistant&#34;,
      &#34;content&#34;: &#34;Bot interaction n°3 contained in document n°2&#34;
    }
  ]
}"><pre>{
  <span>&#34;messages&#34;</span>: [
    {
      <span>&#34;role&#34;</span>: <span><span>&#34;</span>user<span>&#34;</span></span>,
      <span>&#34;content&#34;</span>: <span><span>&#34;</span>User interaction n°1 contained in document n°1<span>&#34;</span></span>
    },
    {
      <span>&#34;role&#34;</span>: <span><span>&#34;</span>assistant<span>&#34;</span></span>,
      <span>&#34;content&#34;</span>: <span><span>&#34;</span>Bot interaction n°1 contained in document n°1<span>&#34;</span></span>
    },
    {
      <span>&#34;role&#34;</span>: <span><span>&#34;</span>user<span>&#34;</span></span>,
      <span>&#34;content&#34;</span>: <span><span>&#34;</span>User interaction n°2 contained in document n°1<span>&#34;</span></span>
    },
    {
      <span>&#34;role&#34;</span>: <span><span>&#34;</span>assistant<span>&#34;</span></span>,
      <span>&#34;content&#34;</span>: <span><span>&#34;</span>Bot interaction n°2 contained in document n°1<span>&#34;</span></span>
    }
  ]
}
{
  <span>&#34;messages&#34;</span>: [
    {
      <span>&#34;role&#34;</span>: <span><span>&#34;</span>user<span>&#34;</span></span>,
      <span>&#34;content&#34;</span>: <span><span>&#34;</span>User interaction n°1 contained in document n°2<span>&#34;</span></span>
    },
    {
      <span>&#34;role&#34;</span>: <span><span>&#34;</span>assistant<span>&#34;</span></span>,
      <span>&#34;content&#34;</span>: <span><span>&#34;</span>Bot interaction n°1 contained in document n°2<span>&#34;</span></span>
    },
    {
      <span>&#34;role&#34;</span>: <span><span>&#34;</span>user<span>&#34;</span></span>,
      <span>&#34;content&#34;</span>: <span><span>&#34;</span>User interaction n°2 contained in document n°2<span>&#34;</span></span>
    },
    {
      <span>&#34;role&#34;</span>: <span><span>&#34;</span>assistant<span>&#34;</span></span>,
      <span>&#34;content&#34;</span>: <span><span>&#34;</span>Bot interaction n°2 contained in document n°2<span>&#34;</span></span>,
      <span>&#34;weight&#34;</span>: <span>0</span>,  <span># don&#39;t train on n°2</span>
    },
    {
      <span>&#34;role&#34;</span>: <span><span>&#34;</span>user<span>&#34;</span></span>,
      <span>&#34;content&#34;</span>: <span><span>&#34;</span>User interaction n°3 contained in document n°2<span>&#34;</span></span>
    },
    {
      <span>&#34;role&#34;</span>: <span><span>&#34;</span>assistant<span>&#34;</span></span>,
      <span>&#34;content&#34;</span>: <span><span>&#34;</span>Bot interaction n°3 contained in document n°2<span>&#34;</span></span>
    }
  ]
}</pre></div>
<ul dir="auto">
<li><em>Function calling</em>: conversational data stored in the <code>&#34;messages&#34;</code> key in the form of a list. Each list item is a dictionary containing the <code>&#34;role&#34;</code> and <code>&#34;content&#34;</code> or <code>&#34;tool_calls&#34;</code> keys. <code>&#34;role&#34;</code> is a string being one of &#34;user&#34;, &#34;assistant&#34;, &#34;system_prompt&#34;, or &#34;tool&#34;. The loss will only be computed if &#34;role&#34; == &#34;assistant&#34;.</li>
</ul>
<p dir="auto"><strong>Note</strong>: In function calling the <code>&#34;id&#34;</code> of <code>&#34;tool_calls&#34;</code> and the <code>&#34;tool_call_id&#34;</code> are randomly generated strings of exactly 9 chars. We recommend to generate this automatically
in a data preparation script as is done <a href="https://github.com/mistralai/mistral-finetune/blob/208b25c0f7299bb78d06cea25b82adee03834319/utils/reformat_data_glaive.py#L74">here</a>.</p>
<p dir="auto">E.g.:</p>
<div dir="auto" data-snippet-clipboard-copy-content="{
  &#34;messages&#34;: [
    {
      &#34;role&#34;: &#34;system&#34;,
      &#34;content&#34;: &#34;You are an helpful assistant who has access to the following functions to help the user, you can use the functions if needed&#34;
    },
    {
      &#34;role&#34;: &#34;user&#34;,
      &#34;content&#34;: &#34;Can you help me generate an anagram of the word \&#34;listen\&#34;?&#34;
    },
    {
      &#34;role&#34;: &#34;assistant&#34;,
      &#34;tool_calls&#34;: [
        {
          &#34;id&#34;: &#34;TX92Jm8Zi&#34;,
          &#34;type&#34;: &#34;function&#34;,
          &#34;function&#34;: {
            &#34;name&#34;: &#34;generate_anagram&#34;,
            &#34;arguments&#34;: &#34;{\&#34;word\&#34;: \&#34;listen\&#34;}&#34;
          }
        }
      ]
    },
    {
      &#34;role&#34;: &#34;tool&#34;,
      &#34;content&#34;: &#34;{\&#34;anagram\&#34;: \&#34;silent\&#34;}&#34;,
      &#34;tool_call_id&#34;: &#34;TX92Jm8Zi&#34;
    },
    {
      &#34;role&#34;: &#34;assistant&#34;,
      &#34;content&#34;: &#34;The anagram of the word \&#34;listen\&#34; is \&#34;silent\&#34;.&#34;
    },
    {
      &#34;role&#34;: &#34;user&#34;,
      &#34;content&#34;: &#34;That&#39;s amazing! Can you generate an anagram for the word \&#34;race\&#34;?&#34;
    },
    {
      &#34;role&#34;: &#34;assistant&#34;,
      &#34;tool_calls&#34;: [
        {
          &#34;id&#34;: &#34;3XhQnxLsT&#34;,
          &#34;type&#34;: &#34;function&#34;,
          &#34;function&#34;: {
            &#34;name&#34;: &#34;generate_anagram&#34;,
            &#34;arguments&#34;: &#34;{\&#34;word\&#34;: \&#34;race\&#34;}&#34;
          }
        }
      ]
    }
  ],
  &#34;tools&#34;: [
    {
      &#34;type&#34;: &#34;function&#34;,
      &#34;function&#34;: {
        &#34;name&#34;: &#34;generate_anagram&#34;,
        &#34;description&#34;: &#34;Generate an anagram of a given word&#34;,
        &#34;parameters&#34;: {
          &#34;type&#34;: &#34;object&#34;,
          &#34;properties&#34;: {
            &#34;word&#34;: {
              &#34;type&#34;: &#34;string&#34;,
              &#34;description&#34;: &#34;The word to generate an anagram of&#34;
            }
          },
          &#34;required&#34;: [
            &#34;word&#34;
          ]
        }
      }
    }
  ]
}"><pre>{
  <span>&#34;messages&#34;</span>: [
    {
      <span>&#34;role&#34;</span>: <span><span>&#34;</span>system<span>&#34;</span></span>,
      <span>&#34;content&#34;</span>: <span><span>&#34;</span>You are an helpful assistant who has access to the following functions to help the user, you can use the functions if needed<span>&#34;</span></span>
    },
    {
      <span>&#34;role&#34;</span>: <span><span>&#34;</span>user<span>&#34;</span></span>,
      <span>&#34;content&#34;</span>: <span><span>&#34;</span>Can you help me generate an anagram of the word <span>\&#34;</span>listen<span>\&#34;</span>?<span>&#34;</span></span>
    },
    {
      <span>&#34;role&#34;</span>: <span><span>&#34;</span>assistant<span>&#34;</span></span>,
      <span>&#34;tool_calls&#34;</span>: [
        {
          <span>&#34;id&#34;</span>: <span><span>&#34;</span>TX92Jm8Zi<span>&#34;</span></span>,
          <span>&#34;type&#34;</span>: <span><span>&#34;</span>function<span>&#34;</span></span>,
          <span>&#34;function&#34;</span>: {
            <span>&#34;name&#34;</span>: <span><span>&#34;</span>generate_anagram<span>&#34;</span></span>,
            <span>&#34;arguments&#34;</span>: <span><span>&#34;</span>{<span>\&#34;</span>word<span>\&#34;</span>: <span>\&#34;</span>listen<span>\&#34;</span>}<span>&#34;</span></span>
          }
        }
      ]
    },
    {
      <span>&#34;role&#34;</span>: <span><span>&#34;</span>tool<span>&#34;</span></span>,
      <span>&#34;content&#34;</span>: <span><span>&#34;</span>{<span>\&#34;</span>anagram<span>\&#34;</span>: <span>\&#34;</span>silent<span>\&#34;</span>}<span>&#34;</span></span>,
      <span>&#34;tool_call_id&#34;</span>: <span><span>&#34;</span>TX92Jm8Zi<span>&#34;</span></span>
    },
    {
      <span>&#34;role&#34;</span>: <span><span>&#34;</span>assistant<span>&#34;</span></span>,
      <span>&#34;content&#34;</span>: <span><span>&#34;</span>The anagram of the word <span>\&#34;</span>listen<span>\&#34;</span> is <span>\&#34;</span>silent<span>\&#34;</span>.<span>&#34;</span></span>
    },
    {
      <span>&#34;role&#34;</span>: <span><span>&#34;</span>user<span>&#34;</span></span>,
      <span>&#34;content&#34;</span>: <span><span>&#34;</span>That&#39;s amazing! Can you generate an anagram for the word <span>\&#34;</span>race<span>\&#34;</span>?<span>&#34;</span></span>
    },
    {
      <span>&#34;role&#34;</span>: <span><span>&#34;</span>assistant<span>&#34;</span></span>,
      <span>&#34;tool_calls&#34;</span>: [
        {
          <span>&#34;id&#34;</span>: <span><span>&#34;</span>3XhQnxLsT<span>&#34;</span></span>,
          <span>&#34;type&#34;</span>: <span><span>&#34;</span>function<span>&#34;</span></span>,
          <span>&#34;function&#34;</span>: {
            <span>&#34;name&#34;</span>: <span><span>&#34;</span>generate_anagram<span>&#34;</span></span>,
            <span>&#34;arguments&#34;</span>: <span><span>&#34;</span>{<span>\&#34;</span>word<span>\&#34;</span>: <span>\&#34;</span>race<span>\&#34;</span>}<span>&#34;</span></span>
          }
        }
      ]
    }
  ],
  <span>&#34;tools&#34;</span>: [
    {
      <span>&#34;type&#34;</span>: <span><span>&#34;</span>function<span>&#34;</span></span>,
      <span>&#34;function&#34;</span>: {
        <span>&#34;name&#34;</span>: <span><span>&#34;</span>generate_anagram<span>&#34;</span></span>,
        <span>&#34;description&#34;</span>: <span><span>&#34;</span>Generate an anagram of a given word<span>&#34;</span></span>,
        <span>&#34;parameters&#34;</span>: {
          <span>&#34;type&#34;</span>: <span><span>&#34;</span>object<span>&#34;</span></span>,
          <span>&#34;properties&#34;</span>: {
            <span>&#34;word&#34;</span>: {
              <span>&#34;type&#34;</span>: <span><span>&#34;</span>string<span>&#34;</span></span>,
              <span>&#34;description&#34;</span>: <span><span>&#34;</span>The word to generate an anagram of<span>&#34;</span></span>
            }
          },
          <span>&#34;required&#34;</span>: [
            <span><span>&#34;</span>word<span>&#34;</span></span>
          ]
        }
      }
    }
  ]
}</pre></div>

<p dir="auto">Before starting a training run you should verify that your dataset is correctly formatted and get an
estimation of the training time. You can do so by using the <a href="https://github.com/mistralai/mistral-finetune/blob/main/utils/validate_data.py">./utils/validate_data</a> script.</p>
<p dir="auto">Note that this step is crucial to ensure that the data is correctly formatted.</p>

<p dir="auto">Let&#39;s go over a simple example to train a model in instruction following:</p>
<ul dir="auto">
<li>
<ol dir="auto">
<li><strong>Load a chunk of <a href="https://huggingface.co/datasets/HuggingFaceH4/ultrachat_200k" rel="nofollow">Ultachat_200k</a></strong></li>
</ol>
</li>
</ul>
<p dir="auto">Create the data folder and navigate to the folder.</p>
<div dir="auto" data-snippet-clipboard-copy-content="cd $HOME &amp;&amp; mkdir -p data &amp;&amp; cd $HOME/data"><pre><span>cd</span> <span>$HOME</span> <span>&amp;&amp;</span> mkdir -p data <span>&amp;&amp;</span> <span>cd</span> <span>$HOME</span>/data</pre></div>
<p dir="auto">Load the data into a Pandas Dataframe.</p>
<p dir="auto"><strong>Note</strong>: Make sure to have pandas and pyarrow installed (<code>pip install pandas pyarrow</code>).</p>
<div dir="auto" data-snippet-clipboard-copy-content="import pandas as pd

df = pd.read_parquet(&#39;https://huggingface.co/datasets/HuggingFaceH4/ultrachat_200k/resolve/main/data/test_gen-00000-of-00001-3d4cd8309148a71f.parquet&#39;)"><pre><span>import</span> <span>pandas</span> <span>as</span> <span>pd</span>

<span>df</span> <span>=</span> <span>pd</span>.<span>read_parquet</span>(<span>&#39;https://huggingface.co/datasets/HuggingFaceH4/ultrachat_200k/resolve/main/data/test_gen-00000-of-00001-3d4cd8309148a71f.parquet&#39;</span>)</pre></div>
<ul dir="auto">
<li>
<ol start="2" dir="auto">
<li>Split into train and eval</li>
</ol>
</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="df_train=df.sample(frac=0.95,random_state=200)
df_eval=df.drop(df_train.index)"><pre><span>df_train</span><span>=</span><span>df</span>.<span>sample</span>(<span>frac</span><span>=</span><span>0.95</span>,<span>random_state</span><span>=</span><span>200</span>)
<span>df_eval</span><span>=</span><span>df</span>.<span>drop</span>(<span>df_train</span>.<span>index</span>)</pre></div>
<ul dir="auto">
<li>
<ol start="3" dir="auto">
<li>Save data to jsonl</li>
</ol>
</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="df_train.to_json(&#34;ultrachat_chunk_train.jsonl&#34;, orient=&#34;records&#34;, lines=True)
df_eval.to_json(&#34;ultrachat_chunk_eval.jsonl&#34;, orient=&#34;records&#34;, lines=True)"><pre><span>df_train</span>.<span>to_json</span>(<span>&#34;ultrachat_chunk_train.jsonl&#34;</span>, <span>orient</span><span>=</span><span>&#34;records&#34;</span>, <span>lines</span><span>=</span><span>True</span>)
<span>df_eval</span>.<span>to_json</span>(<span>&#34;ultrachat_chunk_eval.jsonl&#34;</span>, <span>orient</span><span>=</span><span>&#34;records&#34;</span>, <span>lines</span><span>=</span><span>True</span>)</pre></div>
<ul dir="auto">
<li>
<ol start="4" dir="auto">
<li>Modify your training yaml to include the ultrachat dataset and verify the yaml</li>
</ol>
</li>
</ul>
<p dir="auto">Modify <a href="https://github.com/mistralai/mistral-finetune/blob/main/example/7B.yaml">example/7B.yaml</a> to include the absolute path to <code>$HOME/data/ultrachat_chunk_train.jsonl</code> as well as a dataset mixing weight for training and <code>$HOME/data/ultrachat_chunk_eval.jsonl</code> for eval, <em>e.g.</em></p>
<div data-snippet-clipboard-copy-content="data:
  instruct_data: &#34;/Users/johndoe/data/ultrachat_chunk_train.jsonl&#34;
  eval_instruct_data: &#34;/Users/johndoe/data/ultrachat_chunk_eval.jsonl&#34;"><pre><code>data:
  instruct_data: &#34;/Users/johndoe/data/ultrachat_chunk_train.jsonl&#34;
  eval_instruct_data: &#34;/Users/johndoe/data/ultrachat_chunk_eval.jsonl&#34;
</code></pre></div>
<p dir="auto">Now you can verify your training yaml to make sure the data is correctly formatted and to get an estimate of your training time.</p>
<div data-snippet-clipboard-copy-content="cd $HOME/mistral-finetune
python -m utils.validate_data --train_yaml example/7B.yaml"><pre><code>cd $HOME/mistral-finetune
python -m utils.validate_data --train_yaml example/7B.yaml
</code></pre></div>
<p dir="auto">Upon completion you should see an error report with many of the following errors:</p>
<div data-snippet-clipboard-copy-content="The data in line 1412 of dataset /Users/johndoe/data/ultrachat_chunk_eval.jsonl is incorrectly formated.Expected last role to be one of: [assistant] but got user
The data in line 1413 of dataset /Users/johndoe/data/ultrachat_chunk_eval.jsonl is incorrectly formated.Expected last role to be one of: [assistant] but got user
The data in line 1414 of dataset /Users/johndoe/data/ultrachat_chunk_eval.jsonl is incorrectly formated.Expected last role to be one of: [assistant] but got user
The data in line 1415 of dataset /Users/johndoe/data/ultrachat_chunk_eval.jsonl is incorrectly formated.Expected last role to be one of: [assistant] but got user"><pre><code>The data in line 1412 of dataset /Users/johndoe/data/ultrachat_chunk_eval.jsonl is incorrectly formated.Expected last role to be one of: [assistant] but got user
The data in line 1413 of dataset /Users/johndoe/data/ultrachat_chunk_eval.jsonl is incorrectly formated.Expected last role to be one of: [assistant] but got user
The data in line 1414 of dataset /Users/johndoe/data/ultrachat_chunk_eval.jsonl is incorrectly formated.Expected last role to be one of: [assistant] but got user
The data in line 1415 of dataset /Users/johndoe/data/ultrachat_chunk_eval.jsonl is incorrectly formated.Expected last role to be one of: [assistant] but got user
</code></pre></div>
<p dir="auto">Many conversations seem to end with the &#39;user&#39; role which is unnecessary as we only train on &#39;assistant&#39; messages and thus would unnecessarily process data.</p>
<p dir="auto">You can make use of <a href="https://github.com/mistralai/mistral-finetune/blob/main/utils/reformat_data.py">./utils/reformat_data.py</a> to correct the data:</p>
<div data-snippet-clipboard-copy-content="cd $HOME/mistral-finetune
python -m utils.reformat_data $HOME/data/ultrachat_chunk_train.jsonl
python -m utils.reformat_data $HOME/data/ultrachat_chunk_eval.jsonl"><pre><code>cd $HOME/mistral-finetune
python -m utils.reformat_data $HOME/data/ultrachat_chunk_train.jsonl
python -m utils.reformat_data $HOME/data/ultrachat_chunk_eval.jsonl
</code></pre></div>
<p dir="auto">You should see that a couple of samples will be skipped.</p>
<ul dir="auto">
<li>
<ol start="5" dir="auto">
<li>Potentially change number of training steps</li>
</ol>
</li>
</ul>
<p dir="auto">Upon correction of the dataset, run the script again</p>
<div data-snippet-clipboard-copy-content="cd $HOME/mistral-finetune
python -m utils.validate_data --train_yaml example/7B.yaml"><pre><code>cd $HOME/mistral-finetune
python -m utils.validate_data --train_yaml example/7B.yaml
</code></pre></div>
<p dir="auto">You should get a summary of the data input and training parameters:</p>
<div data-snippet-clipboard-copy-content="Train States
 --------------------
{
   &#34;expected&#34;: {
       &#34;eta&#34;: &#34;00:52:44&#34;,
       &#34;data_tokens&#34;: 25169147,
       &#34;train_tokens&#34;: 131072000,
       &#34;epochs&#34;: &#34;5.21&#34;,
       &#34;max_steps&#34;: 500,
       &#34;data_tokens_per_dataset&#34;: {
           &#34;/Users/johndoe/data/ultrachat_chunk_train.jsonl&#34;: &#34;25169147.0&#34;
       },
       &#34;train_tokens_per_dataset&#34;: {
           &#34;/Users/johndoe/data/ultrachat_chunk_train.jsonl&#34;: &#34;131072000.0&#34;
       },
       &#34;epochs_per_dataset&#34;: {
           &#34;/Users/johndoe/data/ultrachat_chunk_train.jsonl&#34;: &#34;5.2&#34;
       }
   },
}"><pre><code>Train States
 --------------------
{
   &#34;expected&#34;: {
       &#34;eta&#34;: &#34;00:52:44&#34;,
       &#34;data_tokens&#34;: 25169147,
       &#34;train_tokens&#34;: 131072000,
       &#34;epochs&#34;: &#34;5.21&#34;,
       &#34;max_steps&#34;: 500,
       &#34;data_tokens_per_dataset&#34;: {
           &#34;/Users/johndoe/data/ultrachat_chunk_train.jsonl&#34;: &#34;25169147.0&#34;
       },
       &#34;train_tokens_per_dataset&#34;: {
           &#34;/Users/johndoe/data/ultrachat_chunk_train.jsonl&#34;: &#34;131072000.0&#34;
       },
       &#34;epochs_per_dataset&#34;: {
           &#34;/Users/johndoe/data/ultrachat_chunk_train.jsonl&#34;: &#34;5.2&#34;
       }
   },
}
</code></pre></div>
<p dir="auto">Having <code>max_steps</code> set to 500 would lead to iterating through the dataset roughly 5 times which is reasonable, but might
be a bit too much. A recommended setting is shown below which would only take 30min on a 8xH100 cluster.</p>

<p dir="auto">Next let&#39;s go over a more advanced use case to fine-tune a model on function calling.
Function calling requires the data to be in the format as <a href="#instruct">explained above</a>. Let&#39;s go over an example.</p>
<ul dir="auto">
<li>
<ol dir="auto">
<li><strong>Load a chat-formatted version of the <a href="https://huggingface.co/datasets/Locutusque/function-calling-chatml" rel="nofollow">Glaive function calling dataset</a></strong></li>
</ol>
</li>
</ul>
<p dir="auto">Create the data folder and navigate to the folder.</p>
<div dir="auto" data-snippet-clipboard-copy-content="cd $HOME &amp;&amp; mkdir -p data &amp;&amp; cd $HOME/data"><pre><span>cd</span> <span>$HOME</span> <span>&amp;&amp;</span> mkdir -p data <span>&amp;&amp;</span> <span>cd</span> <span>$HOME</span>/data</pre></div>
<p dir="auto">Load the data into a Pandas Dataframe.</p>
<p dir="auto"><strong>Note</strong>: Make sure to have pandas and pyarrow installed (<code>pip install pandas pyarrow</code>).</p>
<div dir="auto" data-snippet-clipboard-copy-content="import pandas as pd

df = pd.read_parquet(&#39;https://huggingface.co/datasets/Locutusque/function-calling-chatml/resolve/main/data/train-00000-of-00001-f0b56c6983b4a78f.parquet&#39;)"><pre><span>import</span> <span>pandas</span> <span>as</span> <span>pd</span>

<span>df</span> <span>=</span> <span>pd</span>.<span>read_parquet</span>(<span>&#39;https://huggingface.co/datasets/Locutusque/function-calling-chatml/resolve/main/data/train-00000-of-00001-f0b56c6983b4a78f.parquet&#39;</span>)</pre></div>
<ul dir="auto">
<li>
<ol start="2" dir="auto">
<li>Split into train and eval</li>
</ol>
</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="df_train=df.sample(frac=0.95,random_state=200)
df_eval=df.drop(df_train.index)"><pre><span>df_train</span><span>=</span><span>df</span>.<span>sample</span>(<span>frac</span><span>=</span><span>0.95</span>,<span>random_state</span><span>=</span><span>200</span>)
<span>df_eval</span><span>=</span><span>df</span>.<span>drop</span>(<span>df_train</span>.<span>index</span>)</pre></div>
<ul dir="auto">
<li>
<ol start="3" dir="auto">
<li>Save data to jsonl</li>
</ol>
</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="df_train.to_json(&#34;glaive_train.jsonl&#34;, orient=&#34;records&#34;, lines=True)
df_eval.to_json(&#34;glaive_eval.jsonl&#34;, orient=&#34;records&#34;, lines=True)"><pre><span>df_train</span>.<span>to_json</span>(<span>&#34;glaive_train.jsonl&#34;</span>, <span>orient</span><span>=</span><span>&#34;records&#34;</span>, <span>lines</span><span>=</span><span>True</span>)
<span>df_eval</span>.<span>to_json</span>(<span>&#34;glaive_eval.jsonl&#34;</span>, <span>orient</span><span>=</span><span>&#34;records&#34;</span>, <span>lines</span><span>=</span><span>True</span>)</pre></div>
<ul dir="auto">
<li>
<ol start="4" dir="auto">
<li>Reformat dataset</li>
</ol>
</li>
</ul>
<p dir="auto">As one can see the dataset does not follow the required function calling format, so it will need to be reformatted. Among other things <code>&#34;from&#34;</code> should be renamed to <code>&#34;user&#34;</code> and superfluous <code>&#34;\n&#34;</code> characters should be removed.
For this dataset you can make use of <a href="https://github.com/mistralai/mistral-finetune/blob/main/utils/reformat_data_glaive.py"><code>./utils/reformat_data_glaive.py</code></a>:</p>
<div data-snippet-clipboard-copy-content="cd $HOME/mistral-finetune
python -m utils.reformat_data_glaive $HOME/data/glaive_train.jsonl
python -m utils.reformat_data_glaive $HOME/data/glaive_eval.jsonl"><pre><code>cd $HOME/mistral-finetune
python -m utils.reformat_data_glaive $HOME/data/glaive_train.jsonl
python -m utils.reformat_data_glaive $HOME/data/glaive_eval.jsonl
</code></pre></div>
<p dir="auto">Running this command will make sure that most samples are in the correct format.</p>
<p dir="auto"><strong>Note</strong>: It is impossible to write reformatting scripts that work for all kinds of datasets.
If you have datasets that don&#39;t yet follow the required format above, you will most probably have to
create a reformatting script yourself (mistral-chat or chat-gpt is your best friend here!).</p>
<ul dir="auto">
<li>
<ol start="5" dir="auto">
<li>Validate dataset</li>
</ol>
</li>
</ul>
<p dir="auto">You can now validate the dataset by setting <code>data.instruct_data</code> and <code>data.eval_instruct_data</code> to
<code>$HOME/data/glaive_train.jsonl</code> and <code>$HOME/data/glaive_eval.jsonl</code> in <code>example/7B.yaml</code> respectively.</p>
<p dir="auto">The reformatted datasets still has some errors which can be removed with <code>--create_corrected</code>. For this, make sure to add
<code>--create_corrected</code> as follows:</p>
<div data-snippet-clipboard-copy-content="cd $HOME/mistral-finetune
python -m utils.validate_data --train_yaml example/7B.yaml --create_corrected"><pre><code>cd $HOME/mistral-finetune
python -m utils.validate_data --train_yaml example/7B.yaml --create_corrected
</code></pre></div>
<p dir="auto">Running this command will show a couple of errors and save two new datasets <code>$HOME/data/glaive_train.jsonl.corrected</code> and <code>$HOME/data/glaive_eval.jsonl.corrected</code>. Make sure to use these two dataset in <code>example/7B.yaml</code> and run the command again. Now the dataset should be correctly formatted!</p>

<p dir="auto">Having followed the <a href="#verify-dataset">dataset verification section</a>, we can now start training.
For faster training, we recommend setting max_steps to only 300. Make sure to define <code>run_dir</code> to your experiment folder and optionally set <code>wandb_project</code> to a Weights &amp; Biases project for logging`, <em>e.g.</em>:</p>
<div data-snippet-clipboard-copy-content="max_steps: 300
run_dir: &#34;/Users/johndoe/ultra_chat_test&#34;
wandb.project: ultra_chat"><pre><code>max_steps: 300
run_dir: &#34;/Users/johndoe/ultra_chat_test&#34;
wandb.project: ultra_chat
</code></pre></div>
<p dir="auto">Optionally you can also set <code>wandb</code></p>
<p dir="auto">Save the training configuration and start training! Make sure to set <code>--nproc-per-node</code> to the number of available GPUs.</p>
<div data-snippet-clipboard-copy-content="cd $HOME/mistral-finetune
torchrun --nproc-per-node 8 --master_port $RANDOM -m train example/7B.yaml"><pre><code>cd $HOME/mistral-finetune
torchrun --nproc-per-node 8 --master_port $RANDOM -m train example/7B.yaml
</code></pre></div>
<p dir="auto">Training on ultra-chat should take around 30min on a 8xH100 node and the resulting weights should give an MT Bench score around 6.3.</p>
<p dir="auto">Training on glaive should take around 1h on a 8xH100 node and the resulting weights should work nicely for function calling.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Customizing training configuration</h2><a id="user-content-customizing-training-configuration" aria-label="Permalink: Customizing training configuration" href="#customizing-training-configuration"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The example <code>mistral-finetune/examples/7B</code> defines reasonable parameters for learning rate, weight decay, etc... but you are advised to
customize these settings for your use case.</p>
<p dir="auto">Generally, a training configuration should fill the following parameters:</p>
<ul dir="auto">
<li><code>model_id_or_path</code> defines the model to start training from. This can be a path to a pre-trained model or a local model directory.</li>
<li><code>run_dir</code> defines the directory where training checkpoints and metrics are stored.</li>
<li><code>seq_len</code> defines the sequence length for training. This is the maximum length of input sequences the model will process. Samples are packed to reach a length of <code>seq_len</code> for maximum training efficiency.</li>
<li><code>batch_size</code> defines the number of training examples used per GPU. <strong>Note</strong>: The overall effective batch_size (in tokens) across all GPUs equals <code>num_gpus</code> x <code>batch_size</code> x <code>seq_len</code>.</li>
<li><code>max_steps</code> defines the maximum number of training steps. This is the total number of iterations the training process will run. It can be adjusted based on the specific needs of your training scenario. Total number of tokens seen during training is <code>max_steps</code> x <code>num_gpus</code> x <code>batch_size</code> x <code>seq_len</code>.</li>
<li><code>optim.lr</code> defines the learning rate. This is the initial learning rate for the optimizer.</li>
<li><code>optim.weight_decay</code> defines weight decay. Weight decay is a regularization technique used to prevent overfitting by penalizing large weights. We recommend leaving it at 0.1.</li>
<li><code>optim.pct_start</code> defines the percentage of the total training steps used for the learning rate warm-up phase before it starts to decrease. It corresponds to pct_start of PyTorch&#39;s OneCycleLR.</li>
<li><code>lora.rank</code> defines the size of the LoRA (Low-Rank Adaptation) adapters. We recommend 64 or less, which adjusts the rank of the low-rank decomposition used in LoRA.</li>
<li><code>seed</code> defines the random seed for initialization and data shuffling/sampling. Setting a seed ensures reproducibility of results.</li>
<li><code>log_freq</code> defines the logging frequency. This specifies how often (in steps) to log training metrics.</li>
<li><code>data.instruct_data</code> is the path to the instruction data used for training. This field has to be filled with one or multiple data sources in the format as explained above. Each data source should either be a path to jsonl file of a path to a directory containing jsonl files followed by a weighting to define the importance of this dataset: <code>&lt;path/to/data_source&gt;:&lt;weight&gt;</code>. E.g.: <code>data.instruct_data: &#34;/path/to/data1.jsonl:5.,/path/to/data2.jsonl:1.,/path/to/dir_of_jsonls:1.&#34;</code></li>
<li><code>data.data</code> is an optional path to additional pretraining data in the format as explained above. Note that this field can be left blank.</li>
<li><code>data.eval_instruct_data</code> is an optional path to evaluation instruction data to run cross-validation at every <code>eval_freq</code> steps. Cross-validation metrics are displayed as <code>loss</code> and <code>perplexity</code>.</li>
<li><code>eval_freq</code> defines how often (in steps) to evaluate the model. This specifies the interval at which the model is evaluated on the validation set.</li>
<li><code>no_eval</code> is a flag to enable or disable intermediate evaluation. Setting it to False enables periodic evaluation during training.</li>
<li><code>ckpt_freq</code> defines how often (in steps) to save checkpoints. This specifies the interval at which the model&#39;s state is saved.</li>
<li><code>ckpt_only_lora</code> defines whether to only save the trained LoRA checkpoints or whether the trained LoRA should directly be merged into the base model and saved. <strong>Note</strong>: When setting <code>ckpt_only_lora=False</code> make sure that you have enough CPU and GPU memory to save the full model on a single process (this is usually only possible for the 7B model).</li>
<li><code>wandb.key</code> is used to pass your Weights &amp; Biases (wandb) API key for logging. This allows you to log training metrics to the wandb dashboard.</li>
<li><code>wandb.project</code> defines the wandb project name. This is where the training run will be logged in the wandb interface.</li>
</ul>

<p dir="auto">Once your model is trained, you should try it out in inference. We recommend using <a href="https://github.com/mistralai/mistral-inference">mistral-inference</a>.</p>
<p dir="auto">Make sure to have <code>mistral_inference</code> correctly installed:</p>
<div data-snippet-clipboard-copy-content="pip install mistral_inference"><pre><code>pip install mistral_inference
</code></pre></div>
<p dir="auto">Assuming your <code>lora.safetensors</code> is saved under <code>$HOME/ultra_chat_test/checkpoints/checkpoint_000300/consolidated/lora.safetensors</code>, you can chat with the model using <code>mistral_inference</code>, <em>e.g.</em>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="mistral-chat /mnt/slow/runs/patrick/mistral-finetune/7B/ --max_tokens 256 --temperature 1.0 --instruct --lora_path $HOME/ultra_chat_test/checkpoints/checkpoint_000300/consolidated/lora.safetensors"><pre>mistral-chat /mnt/slow/runs/patrick/mistral-finetune/7B/ --max_tokens 256 --temperature 1.0 --instruct --lora_path <span>$HOME</span>/ultra_chat_test/checkpoints/checkpoint_000300/consolidated/lora.safetensors</pre></div>

<p dir="auto"><strong>Important</strong>: Note that one can only fine-tune mistral models that are compatible with the v3 tokenizer which entails that the models have a vocabulary size of 32768 - not 32000. One can however easily extend older version of vocabulary size 32000 to have a vocabulary size of 32768 by using:</p>
<div data-snippet-clipboard-copy-content="python -m utils.extend_model_vocab --original_model_ckpt /folder/to/old/model --extended_model_ckpt /folder/to/extended/model"><pre><code>python -m utils.extend_model_vocab --original_model_ckpt /folder/to/old/model --extended_model_ckpt /folder/to/extended/model
</code></pre></div>
<p dir="auto">Once the extension has worked, one can fine-tune using the newly created model checkpoint in <code>/folder/to/extended/model</code>.</p>

<blockquote>
<ul dir="auto">
<li>What&#39;s the best practice of fine-tuning MoEs?</li>
</ul>
</blockquote>
<p dir="auto">We see a higher degree of performance variance in when fine-tuning MoE models. It&#39;s not unusual to find that fine-tuning MoEs models with different seeds can lead to a high variance in performance. We did not observe such a high variance with dense models. Therefore, we suggest running multiple instances of the same fine-tuning process on MoEs models and selecting the one that performs best.</p>
<blockquote>
<ul dir="auto">
<li>How can I determine the number of tokens used during the model training process?</li>
</ul>
</blockquote>
<p dir="auto">You can use the following script to find out: <a href="https://github.com/mistralai/mistral-finetune/blob/main/utils/validate_data.py">https://github.com/mistralai/mistral-finetune/blob/main/utils/validate_data.py</a>. This script accepts a .yaml training file as input and returns the number of tokens the model is being trained on.</p>
<blockquote>
<ul dir="auto">
<li>What should I do if I encounter a CUDA out-of-memory error?</li>
</ul>
</blockquote>
<p dir="auto">One possible solution is to reduce the batch size per GPU. The batch size is equal to <code>seq_len</code> x <code>batch_size</code>. Try setting <code>batch_size</code> to 1 and reduce <code>seq_len</code>. You can define the <code>batch_size</code> and <code>seq_len</code> in the .yaml file.</p>
</article></div></div>
  </body>
</html>
