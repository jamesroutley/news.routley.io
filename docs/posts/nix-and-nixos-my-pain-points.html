<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://remy.grunblatt.org/nix-and-nixos-my-pain-points.html">Original</a>
    <h1>Nix and NixOS, my pain points</h1>
    
    <div id="readability-page-1" class="page"><div>
		<!-- 
Je suis un utilisateur de Nix (un gestionnaire de paquets « reproductible ») et de NixOS (la distribution Linux basée sur ce gestionnaire de paquets) depuis bientôt deux ans. Je l'utilise dans un contexte personnel mais aussi professionnel. Dans cet article, je vais me concentrer sur les points « douloureux » dans *mon* utilisation de Nix et de NixOS. Il y a certes beaucoup de points positifs, mais l'*expérience* NixOS est loin d'être un long fleuve tranquille.

## Une documentation mauvaise

La documentation de Nix et de NixOS est plutôt mauvaise. Pour comprendre comment fonctionne un service ou une option, il est très souvent nécessaire d'aller lire le code source (des fichiers `.nix`) car il n'y a pas d'explications dans le manuel, ou alors les explications ne sont pas très compréhensibles.

Sur ce point, l'utilisation de GitHub pour l'hébergement des dépôts des projets rend cette recherche parfois difficile. Par exemple une recherche sur le mot-clef ["pass-wayland"](https://github.com/NixOS/nixpkgs/search?q=%22pass-wayland%22) devrait renvoyer un résultat dans l'onglet "Code", mais ce n'est pas le cas, car Github n'indexe pas la totalité du dépôt.

Le [wiki](https://nixos.wiki/) de Nix / NixOS est rarement à jour. Il mélange des informations liées à des versions spécifiques de nixpkgs (e.g. `22.05`, `unstable`, …) sans nécessairement préciser de quelle version il s'agit. Comme il ne s'agit pas d'une ressource « officielle », ses pages contiennent de nombreuses références à l'utilisation d'outils *tiers* (comme le programme *home-manager* ou le service *cachix*) ou de fonctionnalités non stables (comme les *flakes*). Des configurations spécifiques sont postées directement dans le wiki (e.g. [https://nixos.wiki/wiki/Sway](https://web.archive.org/web/20220617040332/https://nixos.wiki/wiki/Sway)) sans qu'il y ait d'explication sur les choix fait ou leur spécificité, ce qui que l'aspect déclaratif de la configuration de NixOS tend à encourager.

## Une évaluation poreuse

La reproductibilité de NixOS / Nix / Nixpkgs est très perfectible. On pourrait croire que par défaut, NixOS est « reproductible » (pour une certaine définition de reproductible). Ce n'est pas vraiment le cas: deux machines qui possèdent les mêmes fichiers de configuration (`/etc/nixos/configuration.nix`) peuvent différer largement du fait de la dépendance à d'autres fichiers de configurations comme `~/.config/nixpkgs/config.nix`, de la possibilité de changer le comportement de Nix en utilisant des [variables d'environnements, des arguments sur sa ligne de commande](https://www.tweag.io/blog/2020-05-25-flakes/) ou même à cause de l'utilisation de versions différentes de Nix.

Le dépôt Nixpkgs (qui contient l'ensemble des recettes liées aux paquets présents dans NixOS) étant différent du dépôt Nix (qui contient le code source du gestionnaire de paquet Nix), utiliser un commit spécifique de Nixpkgs n'est pas suffisant, il est aussi nécessaire de faire attention à la version de Nix utilisée, sous peine de [régressions](https://github.com/NixOS/nix/issues/4859). De ce point de vue, Guix possède une approche à mon sens meilleure, [un unique dépôt](https://github.com/guix-mirror/guix) étant utilisé pour le gestionnaire de paquet et les « recettes » des paquets.

## Des sources fragiles

La reproductibilité de NixOS / Nix n'est aussi assurée que si les sources utilisées restent réellement accessibles. Un [exemple récent](https://github.com/NixOS/nixpkgs/issues/187314) souligne la fragilité de ces sources, et la fragilité de Nix qui [n'exploite pas](https://github.com/NixOS/nixpkgs/issues/53653) des solutions comme [Software Heritage](https://www.softwareheritage.org/) (là où Guix le fait [depuis au moins trois ans](https://guix.gnu.org/blog/2019/connecting-reproducible-deployment-to-a-long-term-source-code-archive/)).

## Pas de reproductibilité binaire

L'un des problèmes de Nix / NixOS / Nixpkgs concernant la sauvegarde de ces sources est tout simplement la découverte des sources à archiver. En effet, il n'est pas possible de facilement extraire l'ensemble des dépendances (e.g. les URLs utilisées dans les recettes des paquets de Nixpkgs) pour les archiver, car un certain nombre de ces URLs ne sont « calculées » qu'à l'évaluation, ce qui nécessite donc d'évaluer l'ensemble de Nixpkgs, dans toutes ses configurations possibles, pour s'assurer que l'on archive bien ce qu'il faut archiver (une partie de ce travail travail est [actuellement effectuée par Hydra](https://nix-community.github.io/nixpkgs-swh/)). Et cela, sans même parler des *Fixed Output Derivation*. On rappellera sur ce sujet que la reproductibilité de Nix / NixOS / Nixpkgs n'est qu'une reproductibilité des sources: si les sources changent, on est prévenu, mais il ne s'agit pas de la reproductibilité des binaires (qui peuvent changer à chaque build).

Cette reproductibilité *binaire* de Nix / NixOS / Nixpkgs n'est en effet pas vraiment testée, en tout cas pas systématiquement. Le site web [« Is NixOS Reproducible? »](https://r13y.com/) souligne que l'ISO de NixOS est reproductible à 99.77%, mais il s'agit là d'une vérification sur un pourcentage minuscule, moins de 2%, de l'ensemble des paquets. Là encore, Guix est bien meilleur avec notamment des stats effectuées sur [l'ensemble des paquets du dépôt](http://data.guix.gnu.org/repository/1/branch/master/latest-processed-revision/package-reproducibility). 

## NixOS: c'est tout ou rien

Lorsque l'on utilise NixOS, et que l'on souhaite utiliser un paquet qui n'est pas disponible sous NixOS / Nixpkgs (ce qui arrive quand même assez régulièrement), un unique choix s'offre à nous: le packager dans NixOS. Il n'est en général [pas possible de prendre un raccourci](https://nixos.wiki/wiki/Packaging/Binaries) et d'utiliser des binaires précompilés, ce qui veut dire qu'il n'est pas possible de travailler *sous contraintes* sur Nix / NixOS, à moins d'être un utilisateur suffisamment motivé pour parfois packager plusieurs niveaux de dépendances, ce qui a tendance à prendre du temps. Utiliser uniquement NixOS n'est ainsi pas tenable, pour moi: il m'est nécessaire d'avoir accès à une seconde machine, sous une distribution plus classique. -->

<!-- ### Des intégrations incomplètes

Contrairement à d'autres distributions, il est plutôt simple de devenir mainteneur d'un paquet sur NixOS. Il n'y a pas de mécanisme de cooptation, il suffit de soumettre une pull request et c'est bon. Ce mécanisme est tentant, car c'est parfois la manière la plus simple d'ajouter un paquet dans la distribution. À ce jour, près de 2 431 mainteneurs sont présents dans la liste des [mainteneurs](https://github.com/NixOS/nixpkgs/blob/master/maintainers/maintainer-list.nix) (c'est d'ailleurs mon cas sur quelques paquets). Contrairement à [AUR](https://aur.archlinux.org) de Archlinux, ces paquets sont disponibles comme des paquets classiques, et n'ont pas à être compilés sur les machines de chaque utilisateur. C'est probablement l'une des raisons expliquant la première place de Nixpkgs sur [Repology](https://repology.org/repositories/statistics/total) en termes de nombre de paquets disponibles.

Cette abondance de paquets s'accompagne cependant de quelques effets de bords. Tout d'abord, une partie importante des commits sont effectués de manière automatique, car il n'est plus possible de maintenir à jour et *à la main* les paquets présents sur nixpkgs. L'une des raisons est une implication plus faible des mainteneurs ayant ajouté un paquet une fois ce paquet effectivement intégré (et je me place dans cette catégorie). Cette abondance de paquets est aussi à mettre en lien avec un nombre de tickets important: actuellement, prêt de de 5 616 tickets sont ouverts sur GitHub, et la tendance ne semble pas être à la baisse. -->

<p>I have been a user of Nix (a “reproducible” package manager) and NixOS (the Linux distribution based on this package manager) for almost two years. I use it in a personal and professional context. In this article I will focus on the “pain points” in <em>my</em> use of Nix and NixOS. While there are many positives, the NixOS <em>experience</em> is far from being a smooth ride. I still mostly enjoy using Nix and NixOS, and this article is not about blaming anyone. I’m also a part of the problem, as I could probably participate more actively in the project.</p>
<h2 id="poor-documentation">Poor documentation<a href="#poor-documentation" title="Permanent link">¶</a></h2>
<p>The documentation of Nix and NixOS is rather poor. To understand how a service or an option works, it is very often necessary to read the source code (`.nix’ files) because there are no explanations in the manual, or the explanations are not very comprehensible.</p>
<p>On this point, the use of GitHub to host project repositories makes this search sometimes difficult. For example, a search on the keyword <a href="https://github.com/NixOS/nixpkgs/search?q=%22pass-wayland%22">“pass-wayland”</a> should return a result in the “Code” tab, but it does not, because Github does not index the entire repository (you can check that it is present by using your browser search feature on the <a href="https://raw.githubusercontent.com/NixOS/nixpkgs/master/pkgs/top-level/all-packages.nix">all-packages.nix</a> file)</p>
<p>The Nix / NixOS <a href="https://nixos.wiki/">wiki</a> is rarely up to date. It mixes information related to specific versions of nixpkgs (e.g. <code>22.05</code>, <code>unstable</code>, …) without necessarily specifying which version it is. As it is not an “official” resource, its pages contain many references to the use of <em>third party</em> tools (such as the <em>home-manager</em> program or the <em>cachix</em> service) or non-stable features (such as <em>flakes</em>). Specific configurations are posted directly to the wiki (e.g. <a href="https://web.archive.org/web/20220617040332/https://nixos.wiki/wiki/Sway">https://nixos.wiki/wiki/Sway</a>) without any explanation of the choices made or their specificity, which the declarative aspect of the NixOS configuration tends to encourage.</p>
<h2 id="a-porous-evaluation">A porous evaluation<a href="#a-porous-evaluation" title="Permanent link">¶</a></h2>
<p>The reproducibility of NixOS / Nix / Nixpkgs is very perfectible. One might think that by default NixOS is ‘reproducible’ (for some definition of reproducible). This is not really the case: two machines that have the same configuration files (<code>/etc/nixos/configuration.nix</code>) can differ widely due to dependency on other configuration files such as <code>~/.config/nixpkgs/config.nix</code>, the ability to change Nix’s behaviour using <a href="https://www.tweag.io/blog/2020-05-25-flakes/">environment variables, command line arguments</a> or even due to using different versions of Nix.</p>
<p>Since the Nixpkgs repository (which contains all the recipes related to the packages present in NixOS) is different from the Nix repository (which contains the source code of the Nix package manager), using a specific commit of Nixpkgs is not enough, it is also necessary to pay attention to the version of Nix used, or else <a href="https://github.com/NixOS/nix/issues/4859">regressions</a> might appear. From this point of view, Guix has a better approach in my opinion, <a href="https://github.com/guix-mirror/guix">a single repository</a> being used for the package manager and the package “recipes”.</p>
<h2 id="fragile-sources">Fragile sources<a href="#fragile-sources" title="Permanent link">¶</a></h2>
<p>The reproducibility of NixOS / Nix is also only assured if the sources used remain truly accessible. A <a href="https://github.com/NixOS/nixpkgs/issues/187314">recent example</a> underlines the fragility of these sources, and the fragility of Nix which <a href="https://github.com/NixOS/nixpkgs/issues/53653">does not</a> exploit solutions such as <a href="https://www.softwareheritage.org/">Software Heritage</a> (where Guix does <a href="https://guix.gnu.org/blog/2019/connecting-reproducible-deployment-to-a-long-term-source-code-archive/">for at least three years</a>). This means, in a scientific context for example, the user, that is to say me, still has to care for source preservation if they wants to be sure five or ten years after they developed their code and used nix, it still runs.</p>
<h2 id="no-binary-reproducibility">No binary reproducibility<a href="#no-binary-reproducibility" title="Permanent link">¶</a></h2>
<p>One of the problems with Nix / NixOS / Nixpkgs regarding the backup of these sources is simply the discovery of the sources to archive. Indeed, it is not possible to easily extract the set of dependencies (e.g. URLs used in the recipes of Nixpkgs packages) to archive them, as a certain number of these URLs are only “computed” at evaluation time, which requires to evaluate the whole Nixpkgs set, in all its possible configurations, to make sure that one is actually archiving what needs to be archived (part of this work is <a href="https://nix-community.github.io/nixpkgs-swh/">currently done by Hydra</a>, but unfortunately <a href="https://github.com/nix-community/nixpkgs-swh/issues/5">broken</a>). And that’s without even mentioning <em>Fixed Output Derivation</em>. It should be remembered that the reproducibility of Nix / NixOS / Nixpkgs is only a reproducibility of the sources: if the sources change, one is warned, but it is not a question of the reproducibility of the binaries (which can change at each build).</p>
<p>This <em>binary</em> reproducibility of Nix / NixOS / Nixpkgs is indeed not really tested, at least not systematically. The website <a href="https://r13y.com/">“Is NixOS Reproducible?”</a> points out that the NixOS ISO is 99.77% reproducible, but this is a check on a tiny percentage, less than 2%, of all packages. Again, Guix is much better with stats on <a href="http://data.guix.gnu.org/repository/1/branch/master/latest-processed-revision/package-reproducibility">all packages in the repository</a>. And even more classical distributions such as <a href="https://archlinux.org/">Archlinux</a> or <a href="https://www.debian.org/">Debian</a> are better at this than Nix / NixOS / Nixpkgs ! As of now :</p>
<ul>
<li><a href="https://reproducible.archlinux.org/">Archlinux is <s>78% reproducible</s>  between 86% and 90% reproducible</a> on amd64 packages (Thanks Foxboron for <a href="https://news.ycombinator.com/item?id=34127581">the correction</a>);</li>
<li><a href="https://tests.reproducible-builds.org/debian/reproducible.html">Debian is 95.7% reproducible</a> on amd64 packages ;</li>
<li>Both distribution actually test binary reproducibility, and offer good dashboards to follow the reproducibility of the packages.</li>
</ul>
<h2 id="managing-state-could-be-easier">Managing state could be easier<a href="#managing-state-could-be-easier" title="Permanent link">¶</a></h2>
<p>To handle « state », e.g. data that is not software but which is linked to certain software versions, e.g., postgresql data, NixOS uses the <code>system.stateVersion</code> option which specifies how compatible is the state with software versions. For example, for postgresql, the package version depends on <code>system.stateVersion</code>, unless overwritten manually :</p>
<div><pre><span></span><code><span>      </span><span>mkDefault</span><span> </span><span>(</span><span>if</span><span> </span><span>versionAtLeast</span><span> </span><span>config</span>.<span>system</span>.<span>stateVersion</span><span> </span><span>&#34;22.05&#34;</span><span> </span><span>then</span><span> </span><span>pkgs</span>.<span>postgresql_14</span><span></span>
<span>            </span><span>else</span><span> </span><span>if</span><span> </span><span>versionAtLeast</span><span> </span><span>config</span>.<span>system</span>.<span>stateVersion</span><span> </span><span>&#34;21.11&#34;</span><span> </span><span>then</span><span> </span><span>pkgs</span>.<span>postgresql_13</span><span></span>
<span>            </span><span>else</span><span> </span><span>if</span><span> </span><span>versionAtLeast</span><span> </span><span>config</span>.<span>system</span>.<span>stateVersion</span><span> </span><span>&#34;20.03&#34;</span><span> </span><span>then</span><span> </span><span>pkgs</span>.<span>postgresql_11</span><span></span>
<span>            </span><span>else</span><span> </span><span>if</span><span> </span><span>versionAtLeast</span><span> </span><span>config</span>.<span>system</span>.<span>stateVersion</span><span> </span><span>&#34;17.09&#34;</span><span> </span><span>then</span><span> </span><span>mkThrow</span><span> </span><span>&#34;9_6&#34;</span><span></span>
<span>            </span><span>else</span><span> </span><span>mkThrow</span><span> </span><span>&#34;9_5&#34;</span><span>)</span><span>;</span><span></span>
</code></pre></div>

<p>Because any module can depend on this stateVersion, this means updating between different stateVersions is harder than it should be, in an ideal world. The <a href="https://nixos.wiki/wiki/FAQ/When_do_I_update_stateVersion">NixOS FAQ</a> states (haha) you can update <code>system.stateVersion</code> when :</p>
<ol>
<li>You have read all release notes starting from your stateVersion.</li>
<li>You have verified all instances of stateVersion in the code in <code>&lt;nixpkgs/nixos&gt;</code>.</li>
<li>You have made all manual interventions as required by the changes previously inventoried.</li>
</ol>
<p>While reading release notes is ok, verifying the source code of <code>&lt;nixpkgs/nixos&gt;</code>, especially when the Github Search is broken, is less ok. Currently, there is also no policy on how long a given <code>system.stateVersion</code> should be supported. This seems harder than it should be.</p>
<h2 id="nix-and-nixos-its-all-or-nothing">Nix and NixOS: it’s all or nothing<a href="#nix-and-nixos-its-all-or-nothing" title="Permanent link">¶</a></h2>
<p>When we use NixOS, and we want to use a package that is not available under NixOS / Nixpkgs (which happens quite often), we have only one choice: pack it into NixOS. It is generally <a href="https://nixos.wiki/wiki/Packaging/Binaries">not possible to take a shortcut</a> and use precompiled binaries, which means that it is not possible to work <em>with constraints</em> (such as <em>time constraints</em>) on Nix / NixOS, unless you are a motivated enough user to sometimes package several levels of dependencies, which tends to take time. And, of course, because Nix or NixOS are radically different from more classical package management, you can’t really mix them together in a single project and expect to have a good user experience. Using only NixOS is thus not tenable, for me: I need to have access to a second machine, under a more classical distribution. That would also be true on Guix System.</p>
	</div></div>
  </body>
</html>
