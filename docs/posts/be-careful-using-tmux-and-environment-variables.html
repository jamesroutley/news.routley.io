<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://aj.codes/posts/be-careful-using-tmux-and-environment-variables/">Original</a>
    <h1>Be Careful Using Tmux and Environment Variables</h1>
    
    <div id="readability-page-1" class="page"><section><p>tmux has an interesting quirk in the way it handles environment variables that if you’re not careful can cause some seemingly strange behavior.</p><p>Fortunately, this behavior is documented but in my opinion, is not intuitive. From the tmux man page:</p><blockquote><p><strong>When the server is started, tmux copies the environment into the
global environment;</strong> in addition, each session has a session
environment. When a window is created, the session and global
environments are merged. If a variable exists in both, the value
from the session environment is used. The result is the initial
environment passed to the new process.</p></blockquote><p>What this says is that the global environment is copied over when the <strong>server</strong> is
started. Each session also has an environment that is merged with the original
global environment but it only has a set list of environment variables that are
updated. You can see this with the following command in a tmux session:</p><div><pre tabindex="0"><code data-lang="console"><span><span><span>&gt;</span> tmux show-environment
</span></span><span><span><span>-DISPLAY
</span></span></span><span><span><span>-KRB5CCNAME
</span></span></span><span><span><span>-SSH_AGENT_PID
</span></span></span><span><span><span>-SSH_ASKPASS
</span></span></span><span><span><span>SSH_AUTH_SOCK
</span></span></span><span><span><span>-SSH_CONNECTION
</span></span></span><span><span><span>-WINDOWIDkj
</span></span></span><span><span><span>-XAUTHORITY
</span></span></span></code></pre></div><p>This can cause some interesting consequences when you have multiple named tmux sessions running. Here’s an example of
this in action:</p><div><pre tabindex="0"><code data-lang="console"><span><span><span>&gt;</span> <span>export</span> <span>FOO</span><span>=</span>foo
</span></span><span><span><span>&gt;</span> tmux new-session -t first
</span></span><span><span><span>&gt;</span> <span>echo</span> <span>$FOO</span>
</span></span><span><span><span>foo
</span></span></span><span><span><span></span><span>
</span></span></span><span><span><span></span><span>&gt;</span> <span>export</span> <span>FOO</span><span>=</span>bar
</span></span><span><span><span>&gt;</span> tmux new-session -t second
</span></span><span><span><span>&gt;</span> <span>echo</span> <span>$FOO</span>
</span></span><span><span><span>foo
</span></span></span></code></pre></div><p>As long as the tmux server is running, it will retain the copy of the environment at the moment it was started and
unless the environment variable is in a set list it will not be updated when a new session starts <strong>even</strong> if its a
completely separate session.</p><p>There are a few different ways to work around this. If you know you’ll want a specific environment variable updated each
time you start a new session, you can add the variable to the global update list.</p><div><pre tabindex="0"><code data-lang="fallback"><span><span>tmux.conf
</span></span><span><span>
</span></span><span><span>set-option -g update-environment &#34;FOO&#34;
</span></span></code></pre></div><p>This will tell tmux the session environment for <code>$FOO</code> whenever a new session is created or an existing session is
attached to.</p><p>Alternatively, you can manually update the environment using <code>tmux set-environment</code> this can be applied to either the
global environment so that each new session picks up the new value or for a specific session.</p><p>Lastly, you can avoid the problem altogether by providing a named socket to tmux using <code>-L</code> which will cause a new server to start
and copy the current environment into the global environment.</p><div><pre tabindex="0"><code data-lang="console"><span><span><span>&gt;</span> <span>export</span> <span>FOO</span><span>=</span>foo
</span></span><span><span><span>&gt;</span> tmux new-session -t first
</span></span><span><span><span>&gt;</span> <span>echo</span> <span>$FOO</span>
</span></span><span><span><span>foo
</span></span></span><span><span><span></span><span>
</span></span></span><span><span><span></span><span>&gt;</span> <span>export</span> <span>FOO</span><span>=</span>bar
</span></span><span><span><span>&gt;</span> tmux -L other new-session -t second
</span></span><span><span><span>&gt;</span> <span>echo</span> <span>$FOO</span>
</span></span><span><span><span>bar
</span></span></span></code></pre></div><p>This does make the ergonomics for tmux a little more cumbersome since you’ll need to provide the name of the socket
each time you want to run tmux commands. For example, to re-attach to the <code>second</code> session you’ll need to do <code>tmux -L other attach -t second</code>.</p></section></div>
  </body>
</html>
