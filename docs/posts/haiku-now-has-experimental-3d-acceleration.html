<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://discuss.haiku-os.org/t/vulkan-lavapipe-software-rendering-is-working-on-haiku/11363?page=13">Original</a>
    <h1>Haiku Now Has Experimental 3D Acceleration</h1>
    
    <div id="readability-page-1" class="page"><div id="main-outlet">
        

  


      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          

            

          <p><span>
              <meta itemprop="datePublished" content="2021-11-28T03:36:43Z"/>
              <time itemprop="dateModified" datetime="2021-11-28T03:37:00Z">
                November 28, 2021,  3:37am
              </time>
          <span itemprop="position">#244</span>
          </span>
        </p></div>
        <div itemprop="articleBody">
          <p>RadeonGfx use client-server model with client-server thread pairs like in app_server. For each client thread that calls 3D acceleation API, server side thread is created. If client thread terminates, server side thread also exit. I made small library “ThreadLink” that implements client-server thread pair model and simpilfy code. Calling server from client is very simple:</p>
<pre><code>port_id gServerPort = find_port(&#34;RadeonGfx&#34;);

ClientThreadLink *link = GetClientThreadLink(gServerPort);
link-&gt;Link().StartMessage(radeonMmapMsg);
link-&gt;Link().Attach&lt;int32&gt;((int32)offset);
int32 reply;
link-&gt;Link().FlushWithReply(reply);
link-&gt;Link().Read&lt;int32&gt;(&amp;area);
link-&gt;Link().Read&lt;uint64&gt;(&amp;areaOfs);
</code></pre>
<p>Example of client and server stack when waiting command buffer execution to complete.</p>
<p>Client:</p>
<p>Server:</p>
        </div>

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>
          <meta itemprop="keywords" content=""/>

        

         

      </div>
      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        
        <div itemprop="articleBody">
          <p>When i originally began studying the code and hardware, i noticed that the Radeon driver already sort of had a acclerant design to it.</p>
<p>Cool stuff man</p>
        </div>

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>

        

         

      </div>
      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://discuss.haiku-os.org/u/X512"><span itemprop="name">X512</span></a>
            
          </span></p>


          <p><span>
              <time itemprop="datePublished" datetime="2021-11-29T03:41:06Z">
                November 29, 2021,  3:41am
              </time>
              <meta itemprop="dateModified" content="2021-11-29T03:41:06Z"/>
          <span itemprop="position">#246</span>
          </span>
        </p></div>
        <div itemprop="articleBody">
          <p>I looked at Zink code a bit and it seems possible to replace softpipe driver of existing Haiku Gallium add-on with Zink driver. It use <code>memcpy()</code> to draw surface:</p>
<pre><code>static void
zink_flush_frontbuffer(struct pipe_screen *pscreen,
                       struct pipe_context *pcontext,
                       struct pipe_resource *pres,
                       unsigned level, unsigned layer,
                       void *winsys_drawable_handle,
                       struct pipe_box *sub_box)
{
   struct zink_screen *screen = zink_screen(pscreen);
   struct sw_winsys *winsys = screen-&gt;winsys;
   struct zink_resource *res = zink_resource(pres);

   if (!winsys)
     return;
   void *map = winsys-&gt;displaytarget_map(winsys, res-&gt;dt, 0);

   if (map) {
      VkImageSubresource isr = {};
      isr.aspectMask = res-&gt;aspect;
      isr.mipLevel = level;
      isr.arrayLayer = layer;
      VkSubresourceLayout layout;
      vkGetImageSubresourceLayout(screen-&gt;dev, res-&gt;image, &amp;isr, &amp;layout);

      void *ptr;
      VkResult result = vkMapMemory(screen-&gt;dev, res-&gt;mem, res-&gt;offset, res-&gt;size, 0, &amp;ptr);
      if (result != VK_SUCCESS) {
         debug_printf(&#34;failed to map memory for display\n&#34;);
         return;
      }
      for (int i = 0; i &lt; pres-&gt;height0; ++i) {
         uint8_t *src = (uint8_t *)ptr + i * layout.rowPitch;
         uint8_t *dst = (uint8_t *)map + i * res-&gt;dt_stride;
         memcpy(dst, src, res-&gt;dt_stride);
      }
      vkUnmapMemory(screen-&gt;dev, res-&gt;mem);
   }

   winsys-&gt;displaytarget_unmap(winsys, res-&gt;dt);

   assert(res-&gt;dt);
   if (res-&gt;dt)
      winsys-&gt;displaytarget_display(winsys, res-&gt;dt, winsys_drawable_handle, sub_box);
}

</code></pre>
        </div>

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>

        

         

      </div>
      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://discuss.haiku-os.org/u/X512"><span itemprop="name">X512</span></a>
            
          </span></p>

            

          <p><span>
              <time itemprop="datePublished" datetime="2021-11-29T11:58:21Z">
                November 29, 2021, 11:58am
              </time>
              <meta itemprop="dateModified" content="2021-11-29T11:58:21Z"/>
          <span itemprop="position">#247</span>
          </span>
        </p></div>
        <div itemprop="articleBody">
          <p>And this works. Blender is working with OpenGL over Zink. No modifications were made to Haiku Gallium addon except changing driver to Zink.</p>
<p><img src="https://discuss.haiku-os.org/uploads/default/original/2X/c/c234f2167b4366f1132ff1b96a4054c0c4ef7c42.jpeg" alt="screenshot61" data-base62-sha1="rI2418gpsohR3g0DYQIPi4P8qPg" width="690" height="388"/></p>
        </div>

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>

        

         

      </div>
      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://discuss.haiku-os.org/u/X512"><span itemprop="name">X512</span></a>
            
          </span></p>

            

          <p><span>
              <time itemprop="datePublished" datetime="2021-11-29T12:13:00Z">
                November 29, 2021, 12:13pm
              </time>
              <meta itemprop="dateModified" content="2021-11-29T12:13:00Z"/>
          <span itemprop="position">#248</span>
          </span>
        </p></div>
        <p><img src="https://discuss.haiku-os.org/uploads/default/original/2X/2/2dbb404dd8d2c629f207bca15c1fa64b80462ddc.png" alt="screenshot62" data-base62-sha1="6wyFxrmqptEoCrzlC3Lsdhxvceg" width="647" height="500"/></p>

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>

        

         

      </div>
      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://discuss.haiku-os.org/u/SWY1985"><span itemprop="name">SWY1985</span></a>
            
          </span></p>


          <p><span>
              <time itemprop="datePublished" datetime="2021-11-29T12:15:08Z">
                November 29, 2021, 12:15pm
              </time>
              <meta itemprop="dateModified" content="2021-11-29T12:15:08Z"/>
          <span itemprop="position">#249</span>
          </span>
        </p></div>
        <p>How is the performance in Blender?</p>

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>

        

         

      </div>
      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://discuss.haiku-os.org/u/X512"><span itemprop="name">X512</span></a>
            
          </span></p>


          <p><span>
              <time itemprop="datePublished" datetime="2021-11-29T12:17:38Z">
                November 29, 2021, 12:17pm
              </time>
              <meta itemprop="dateModified" content="2021-11-29T12:17:38Z"/>
          <span itemprop="position">#250</span>
          </span>
        </p></div>
        <p>Not so good for now. In addition to GFX ring problem it probably currently use inoptimal video buffer configuration.</p>

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>

        

         

      </div>
      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://discuss.haiku-os.org/u/leavengood"><span itemprop="name">leavengood</span></a>
            
              split this topic 
          </span></p>


          <p><span>
              <meta itemprop="datePublished" content="2021-11-29T19:41:13Z"/>
              <time itemprop="dateModified" datetime="2021-11-29T19:41:13Z">
                November 29, 2021,  7:41pm
              </time>
          <span itemprop="position">#251</span>
          </span>
        </p></div>
        

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>

        

         

      </div>
      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://discuss.haiku-os.org/u/X512"><span itemprop="name">X512</span></a>
            
          </span></p>

            

          <p><span>
              <time itemprop="datePublished" datetime="2021-11-29T12:28:32Z">
                November 29, 2021, 12:28pm
              </time>
              <meta itemprop="dateModified" content="2021-11-29T12:28:32Z"/>
          <span itemprop="position">#252</span>
          </span>
        </p></div>
        <p><img src="https://discuss.haiku-os.org/uploads/default/original/2X/c/c0ebbbcf68791cab2e8d134c2f38820f0662adec.png" alt="screenshot63" data-base62-sha1="rwEJl8STPVqkLCByYDnGP3TfIkc" width="647" height="500"/></p>

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>

        

         

      </div>
      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://discuss.haiku-os.org/u/rudolfc"><span itemprop="name">rudolfc</span></a>
            
          </span></p>


          <p><span>
              <meta itemprop="datePublished" content="2021-11-29T19:45:20Z"/>
              <time itemprop="dateModified" datetime="2021-11-29T19:45:44Z">
                November 29, 2021,  7:45pm
              </time>
          <span itemprop="position">#253</span>
          </span>
        </p></div>
        <p>Nice! as usual <img src="https://discuss.haiku-os.org/images/emoji/twitter/wink.png?v=9" title=":wink:" alt=":wink:"/></p>

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>

        

         

      </div>
      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        
        <div itemprop="articleBody">
          <p>there is some kind of opengl fps test in blender, maybe it can help you to see performance differences…</p><p><a href="https://www.youtube.com/watch?v=9K2drYq6XvI" target="_blank" rel="noopener nofollow ugc">
    <img src="https://img.youtube.com/vi/9K2drYq6XvI/hqdefault.jpg" title="Eevee secret menu (Blender 2.83)" width="480" height="360"/>
  </a>
</p>

        </div>

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>

        

         

      </div>
      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://discuss.haiku-os.org/u/X512"><span itemprop="name">X512</span></a>
            
          </span></p>

            

          <p><span>
              <time itemprop="datePublished" datetime="2021-11-29T22:28:33Z">
                November 29, 2021, 10:28pm
              </time>
              <meta itemprop="dateModified" content="2021-11-29T22:28:33Z"/>
          <span itemprop="position">#255</span>
          </span>
        </p></div>
        <div itemprop="articleBody">
          <p>After fixing buffer stride alignment problem, multiple windows in Blender, window resizing and GLTeapot are working. There are currently problem with efficiency in Zink and RadeonGfx in server mode that it clone and delete buffer on each frame that is time consuming.</p>
<p><img src="https://discuss.haiku-os.org/uploads/default/original/2X/a/a57a1470a8232c655631ae402e6b8b5078946258.jpeg" alt="screenshot66" data-base62-sha1="nBSkVhN38K6rRZaO9B4sMpZF3bW" width="690" height="388"/></p>
        </div>

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>

        

         

      </div>
      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        
        <p>Now wiil be a great oportunity to test Godot Engine demos too n,n BTW Godot Engine 4 Alfa have a vulkan engine.</p>

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>

        

         

      </div>
      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://discuss.haiku-os.org/u/X512"><span itemprop="name">X512</span></a>
            
          </span></p>

            

          <p><span>
              <time itemprop="datePublished" datetime="2021-11-30T11:38:03Z">
                November 30, 2021, 11:38am
              </time>
              <meta itemprop="dateModified" content="2021-11-30T11:38:03Z"/>
          <span itemprop="position">#257</span>
          </span>
        </p></div>
        <div itemprop="articleBody">
          <p>Zink over Lavapipe also works, but with glitches (no cube in Blender) and crashes.</p>
<p><img src="https://discuss.haiku-os.org/uploads/default/original/2X/6/6a5d7d2cdbf7f8718a2ceb805cbe978ab1df76e5.png" alt="screenshot68" data-base62-sha1="faWUu5qq8pbZi5KyI5jGOsuW2UZ" width="647" height="500"/></p>
        </div>

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>

        

         

      </div>
      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://discuss.haiku-os.org/u/bitigchi"><span itemprop="name">bitigchi</span></a>
            
          </span></p>


          <p><span>
              <time itemprop="datePublished" datetime="2021-11-30T11:52:58Z">
                November 30, 2021, 11:52am
              </time>
              <meta itemprop="dateModified" content="2021-11-30T11:52:58Z"/>
          <span itemprop="position">#258</span>
          </span>
        </p></div>
        

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>

        

         

      </div>
      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        
        <p>Ah those expected standard “Nice, and i would use IF…” comments.</p>

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>

        

         

      </div>
      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://discuss.haiku-os.org/u/bitigchi"><span itemprop="name">bitigchi</span></a>
            
          </span></p>


          <p><span>
              <time itemprop="datePublished" datetime="2021-11-30T12:06:47Z">
                November 30, 2021, 12:06pm
              </time>
              <meta itemprop="dateModified" content="2021-11-30T12:06:47Z"/>
          <span itemprop="position">#260</span>
          </span>
        </p></div>
        <p>Shall we update the title? It’s more than software rendering at this point.</p>

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>

        

         

      </div>
      <div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://discuss.haiku-os.org/u/X512"><span itemprop="name">X512</span></a>
            
          </span></p>


          <p><span>
              <time itemprop="datePublished" datetime="2021-11-30T12:08:41Z">
                November 30, 2021, 12:08pm
              </time>
              <meta itemprop="dateModified" content="2021-11-30T12:08:41Z"/>
          <span itemprop="position">#261</span>
          </span>
        </p></div>
        <p>Maybe better to split when I started to write about implementing stub libdrm for RADV.</p>

        <meta itemprop="headline" content="Vulkan lavapipe software rendering is working on Haiku"/>

        

         

      </div>
      

    





    </div></div>
  </body>
</html>
