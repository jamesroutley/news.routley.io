<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://unix.stackexchange.com/questions/230472/can-i-exec-an-entirely-new-process-without-an-executable-file">Original</a>
    <h1>Can I exec a new process without an executable file? (2015)</h1>
    
    <div id="readability-page-1" class="page"><div>
            

<div id="left-sidebar" data-is-here-when="md lg">
    

        <div id="teams-are-moving-popover" role="menu">
            
            <p>Stack Overflow for Teams is moving to its own domain! When the migration is complete, you will access your Teams at <span>stackoverflowteams.com</span>, and they will no longer appear in the left sidebar on <span>stackoverflow.com</span>.</p>
            <p>Check your email for updates.</p>
        </div>



        <div id="popover-teams-create-cta" role="menu" aria-hidden="true">
            

            <div>
                <p><strong>Teams</strong></p>
                <p>Q&amp;A for work</p>
                <p>Connect and share knowledge within a single location that is structured and easy to search.</p>
                <p><a href="https://stackoverflow.co/teams" data-gps-track="teams.create.left-sidenav.click({ Action: CtaClick })" data-ga="[&#34;teams left navigation - anonymous&#34;,&#34;left nav cta&#34;,&#34;stackoverflow.com/teams&#34;,null,null]">
                    Learn more about Teams
                </a>
            </p></div>

            
        </div>


</div>






        <div id="content">

            

<div itemprop="mainEntity" itemscope="" itemtype="https://schema.org/Question">
    

    <div>

        

            
            <div>
                    <p><span>Asked</span>
                        <time itemprop="dateCreated" datetime="2015-09-18T05:33:01">7 years, 1 month ago</time>
                    </p>
                    
                    <p><span>Viewed</span>
                        6k times
                    </p>
            </div>
            <div id="mainbar" role="main" aria-label="question and answers">

                
<div data-questionid="230472" data-position-on-page="0" data-score="9" id="question">
    


    <div>
        

        

<div>
    
    <div itemprop="text">
                
<p>Suppose my non-root 32-bit app runs on a 64-bit system, all filesystems of which are mounted as read-only. The app creates an image of a 64-bit ELF in memory. But due to read-only filesystems it can&#39;t dump this image to a file to do an <code>execve</code> on. Is there still a supported way to launch a process from this image?</p>

<p>Note: the main problem here is to switch from 32-bit mode to 64-bit, not doing any <a href="https://stackoverflow.com/a/32384358/673852">potentially unreliable hacks</a>. If this is solved, then the whole issue becomes trivial â€” just make a custom loader.</p>
    </div>

        

    <div>
        <div>
            

                <div>
<div>
    
    <div>
        <a href="https://unix.stackexchange.com/users/-1/community"><p><img src="https://www.gravatar.com/avatar/a007be5a61f6aa8f3e85ae2fc18dd66e?s=64&amp;d=identicon&amp;r=PG" alt="Community&#39;s user avatar" width="32" height="32"/></p></a>
    </div>
    
</div>
                </div>
            <div>
                <div>
    <p>
        asked <span title="2015-09-18 05:33:01Z">Sep 18, 2015 at 5:33</span>
    </p>
    <div>
        <a href="https://unix.stackexchange.com/users/27672/ruslan"><p><img src="https://i.stack.imgur.com/S5IZ5.png?s=64&amp;g=1" alt="Ruslan&#39;s user avatar" width="32" height="32"/></p></a>
    </div>
    <div itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <p><a href="https://unix.stackexchange.com/users/27672/ruslan">Ruslan</a><span itemprop="name">Ruslan</span></p><p><span title="reputation score " dir="ltr">3,079</span><span title="2 gold badges" aria-hidden="true"><span></span><span>2</span></span><span>2 gold badges</span><span title="25 silver badges" aria-hidden="true"><span></span><span>25</span></span><span>25 silver badges</span><span title="44 bronze badges" aria-hidden="true"><span></span><span>44</span></span><span>44 bronze badges</span>
        </p>
    </div>
</div>


            </div>
        </div>
    </div>
    
</div>




            <p><span itemprop="commentCount">3</span></p><div>
        <div id="comments-230472" data-post-id="230472" data-min-length="15">
            <ul data-remaining-comments-count="0" data-canpost="false" data-cansee="true" data-comments-unavailable="false" data-addlink-disabled="true">

                        <li id="comment-393428" data-comment-id="393428" data-comment-owner-id="106900" data-comment-score="0">
        
        <div>
            <div>
                
                <p><span>If you have a <code>tmpfs</code>, you could write the image there and execute it. <code>tmpfs</code> is backed entirely by memory. Not sure this fits your requirements, though.</span></p>
                <p><span dir="ltr"><span title="2015-09-18 06:40:12Z, License: CC BY-SA 3.0">Sep 18, 2015 at 6:40</span></span>
            </p></div>
        </div>
    </li>
    <li id="comment-393476" data-comment-id="393476" data-comment-owner-id="27672" data-comment-score="0">
        
        <div>
            <div>
                
                <p><span>@alienth to mount a <code>tmpfs</code> I&#39;d need root privileges.</span></p>
                <p><span dir="ltr"><span title="2015-09-18 10:21:27Z, License: CC BY-SA 3.0">Sep 18, 2015 at 10:21</span></span>
            </p></div>
        </div>
    </li>
    <li id="comment-393637" data-comment-id="393637" data-comment-owner-id="79808" data-comment-score="0">
        
        <div>
            <div>
                
                <p><span>Ruslan:  @alienth&#39;s suggestion is to keep a <code>tmpfs</code> filesystem permanently mounted.  This doesn&#39;t let any of the read-only memory pages in your 64bit process be backed by the contents of the disk file holding the 32bit executable, though.  Instead, everything it needs has to be copied.  (Unless you have the 64bit program open and mmap after it starts.)  Also, you&#39;d need to make sure you clean up the tmpfs, to avoid upward-creeping memory usage.</span></p>
                <p><span dir="ltr"><span title="2015-09-18 17:39:26Z, License: CC BY-SA 3.0">Sep 18, 2015 at 17:39</span></span>
                        <span title="this comment was edited 2 times">
                            <svg aria-hidden="true" width="14" height="14" viewBox="0 0 14 14"><path d="m11.1 1.71 1.13 1.12c.2.2.2.51 0 .71L11.1 4.7 9.21 2.86l1.17-1.15c.2-.2.51-.2.71 0ZM2 10.12l6.37-6.43 1.88 1.88L3.88 12H2v-1.88Z"></path></svg>
                        </span>
            </p></div>
        </div>
    </li>

            </ul>
	    </div>

                 
    </div>
    </div>

</div>



                <div id="answers">
                    


                                        
<div id="answer-466637" data-answerid="466637" data-parentid="230472" data-score="12" data-position-on-page="1" data-highest-scored="1" data-question-has-accepted-highest-score="1" itemprop="acceptedAnswer" itemscope="" itemtype="https://schema.org/Answer">
    <div>
        

        

<div>
    
    <div itemprop="text">
<p>Yes, via <a href="http://man7.org/linux/man-pages/man2/memfd_create.2.html" rel="noreferrer"><code>memfd_create</code></a> and <a href="http://man7.org/linux/man-pages/man3/fexecve.3.html" rel="noreferrer"><code>fexecve</code></a>:</p>

<pre><code>int fd = memfd_create(&#34;foo&#34;, MFD_CLOEXEC);
// write your image to fd however you want
fexecve(fd, argv, envp);
</code></pre>
    </div>
    <div>
        <div>
            


            <div>
                <div>
    <p>
        answered <span title="2018-09-03 19:50:35Z">Sep 3, 2018 at 19:50</span>
    </p>
    <div>
        <a href="https://unix.stackexchange.com/users/217726/joseph-sible-reinstate-monica"><p><img src="https://i.stack.imgur.com/RZLo7.png?s=64&amp;g=1" alt="Joseph Sible-Reinstate Monica&#39;s user avatar" width="32" height="32"/></p></a>
    </div>
    
</div>


            </div>
        </div>
        
    
    </div>
    
</div>




            <p><span itemprop="commentCount">2</span></p><div>
        <div id="comments-466637" data-post-id="466637" data-min-length="15">
            <ul data-remaining-comments-count="0" data-canpost="false" data-cansee="true" data-comments-unavailable="false" data-addlink-disabled="true">

                        <li id="comment-849926" data-comment-id="849926" data-comment-owner-id="27672" data-comment-score="2">
        
        <div>
            <div>
                
                <p><span>Great. I&#39;ve checked, this indeed works (see <a href="https://dumpz.org/bRatbeMHKn7S" rel="nofollow noreferrer">this example code</a> (the child simply spins increasing <code>rax</code>)). But a couple of comments: <code>memfd_create</code> first appears in Linux 3.17. Include <code>&lt;sys/mman.h&gt;</code>, having defined <code>_GNU_SOURCE</code> (man page appears wrong about the include and doesn&#39;t mention the need for the define).</span></p>
                <p><span dir="ltr"><span title="2018-09-03 21:01:52Z, License: CC BY-SA 4.0">Sep 3, 2018 at 21:01</span></span>
            </p></div>
        </div>
    </li>
    <li id="comment-849957" data-comment-id="849957" data-comment-owner-id="217726" data-comment-score="2">
        
        <div>
            <div>
                
                <p><span>@Ruslan Good find. I just sent in a patch to add the _GNU_SOURCE requirement to the man page. (The header name is already fixed in git; the website just hasn&#39;t updated yet.)</span></p>
                <p><span dir="ltr"><span title="2018-09-03 22:38:39Z, License: CC BY-SA 4.0">Sep 3, 2018 at 22:38</span></span>
                        <span title="this comment was edited 1 time">
                            <svg aria-hidden="true" width="14" height="14" viewBox="0 0 14 14"><path d="m11.1 1.71 1.13 1.12c.2.2.2.51 0 .71L11.1 4.7 9.21 2.86l1.17-1.15c.2-.2.51-.2.71 0ZM2 10.12l6.37-6.43 1.88 1.88L3.88 12H2v-1.88Z"></path></svg>
                        </span>
            </p></div>
        </div>
    </li>

            </ul>
	    </div>

                 
    </div>
    </div>
</div>


                                        
<div id="answer-230597" data-answerid="230597" data-parentid="230472" data-score="1" data-position-on-page="2" data-highest-scored="0" data-question-has-accepted-highest-score="1" itemprop="suggestedAnswer" itemscope="" itemtype="https://schema.org/Answer">
    <div>
        

        

<div>
    
    <p>You&#39;re looking for something like &#34;userland exec&#34;. <a href="http://stratigery.com/userlandexec.html" rel="nofollow">Implementation here</a>. Basically, this involves loading some position-independent code that has no external references into memory, and marking it executable. This position independent code removes the previously-running executable, and reloads. Sounds like you might have to modify the userland exec I wrote at least a little.</p>
    <div>
        <div>
            


            <div>
                <div>
    <p>
        answered <span title="2015-09-18 17:01:47Z">Sep 18, 2015 at 17:01</span>
    </p>
    
    
</div>


            </div>
        </div>
        
    
    </div>
    
</div>




            <p><span itemprop="commentCount">3</span></p><div>
        <div id="comments-230597" data-post-id="230597" data-min-length="15">
            <ul data-remaining-comments-count="0" data-canpost="false" data-cansee="true" data-comments-unavailable="false" data-addlink-disabled="true">

                        <li id="comment-393641" data-comment-id="393641" data-comment-owner-id="79808" data-comment-score="1">
        
        <div>
            <div>
                
                <p><span>IDK if you can change from compat (32bit) mode to long (64bit) mode other than with <code>execve</code>.  It&#39;s going to require a kernel call of some sort.  <code>personality(2)</code> sounds like it might be the right thing, but it&#39;s for stuff like changing signal numbers to emulate a BSD or other non-Linux system call ABI, I think. <a href="http://man7.org/linux/man-pages/man2/personality.2.html" rel="nofollow noreferrer">man7.org/linux/man-pages/man2/personality.2.html</a></span></p>
                <p><span dir="ltr"><span title="2015-09-18 17:44:11Z, License: CC BY-SA 3.0">Sep 18, 2015 at 17:44</span></span>
            </p></div>
        </div>
    </li>
    <li id="comment-393649" data-comment-id="393649" data-comment-owner-id="27672" data-comment-score="1">
        
        <div>
            <div>
                
                <p><span>The only way to switch from 32bit to 64bit mode I&#39;ve come up with is <a href="http://stackoverflow.com/a/32384358/673852">quite hacky</a>. One can&#39;t even guarantee that it won&#39;t break in a newer kernel. Thus the implementation you point to doesn&#39;t seem workable in my use case. And, even if I do use the above mentioned hack, the process still looks like 32 bit to the kernel: e.g. <code>ptrace</code>&#39;ing it with <code>GETREGSET</code> with <code>NT_PRSTATUS</code> gives 32-bit regset.</span></p>
                <p><span dir="ltr"><span title="2015-09-18 18:42:30Z, License: CC BY-SA 3.0">Sep 18, 2015 at 18:42</span></span>
            </p></div>
        </div>
    </li>
    <li id="comment-925797" data-comment-id="925797" data-comment-owner-id="24541" data-comment-score="0">
        
        <div>
            <div>
                
                <p><span>As far as I can tell this doesn&#39;t close <code>CLOEXEC</code> fds</span></p>
                <p><span dir="ltr"><span title="2019-02-21 20:18:47Z, License: CC BY-SA 4.0">Feb 21, 2019 at 20:18</span></span>
            </p></div>
        </div>
    </li>

            </ul>
	    </div>

                 
    </div>
    </div>
</div>


                        


                            <h2 data-loc="1">
                                
                            </h2>
                </div>
            </div>

                
<div id="sidebar" role="complementary" aria-label="sidebar">
        

    
<div data-tracker="cb=1">
    <ul>
                    <li>
                        The Overflow Blog
                    </li>
        <li>
            
            
        </li>
        <li>
            
            
        </li>
                    <li>
                        Featured on Meta
                    </li>
        <li>
            
            
        </li>
        <li>
            
            
        </li>
    </ul>
</div>



        

    
        



    

                
    

</div>

    </div>

</div>


        </div>
    </div></div>
  </body>
</html>
