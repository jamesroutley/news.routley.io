<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/soegaard/webracket">Original</a>
    <h1>The WebRacket language is a subset of Racket that compiles to WebAssembly</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">The WebRacket language is a subset of Racket that compiles to WebAssembly (wasm).</p>
<p dir="auto">The long-term goal is to support full Racket.
However, to quote Piet Hein, “Things take time.”</p>
<p dir="auto">The subset supported by the WebRacket compiler is large enough,
to enable programmers to build practical programs for the web.</p>
<p dir="auto">The generated WebAssembly can be run either in the terminal (via Node) or in the browser.
The browser is the main focus.
WebAssembly is somewhat of a moving target.
The compiler only uses widely supported features of WebAssembly.
Expect the generated code to work in Chrome, Firefox and Safari.</p>
<p dir="auto">A JavaScript FFI makes it possible to use standard JavaScript functions as well as browser specific APIs.
Included are bindings for the DOM, Canvas, MathJax, XTermJS and JSXGraph.</p>
<p dir="auto">The hope is that this project allows the Racket community to experiment with WebAssembly.
The ideal outcome is that the experience can be used to extend the normal Racket compiler
with a WebAssembly backend. In the meantime, we can have fun writing Racket programs
that run in the browser.</p>

<p dir="auto">If you want to develop Racket programs that run in the browser and
want to avoid JavaScript, then WebRacket is for you.</p>
<p dir="auto">The FFI allows you to use WebRacket functions as event callbacks
on the JavaScript side.</p>
<p dir="auto">See <code>examples/</code> for a few WebRacket projects.</p>

<p dir="auto">The WebRacket compiler accepts a file containing a top-level form as input.
The <code>module</code> form is not supported. However, <code>include</code> is available.</p>
<p dir="auto">For supported data types most functions in <code>racket/base</code> and <code>racket</code>
are available as primitives. Most are implemented directly in WebAssembly,
some are reimplemented in WebRacket.</p>

<p dir="auto">Most basic data types are implemented, some have restrictions.</p>

<p dir="auto">The numerical tower contains only flonums and fixnums.
Complex numbers and bignums are missing.</p>

<p dir="auto">Mutable hash tables of all four varieties (<code>eq?</code> <code>eqv?</code> <code>equal?</code> <code>always?</code>) are supported.
The values of all mutable hash tables are strongly held, even for tables created by the weak construtors.</p>
<p dir="auto">Immutable hash tables are not yet supported.</p>

<p dir="auto">No direct support for regular expressions at the moment.
These will materialize once support for linklets and modules improves.</p>

<p dir="auto">Since the main target is the browser, only string (and byte string) ports are supported.
If there is interest for file ports (for the terminal), let me know.</p>

<p dir="auto">Most structure related bells and whistles are implemented including super structures,
structure properties and applicable structures.
The most notable missing feature is prefab structures.</p>

<p dir="auto">The WebRacket compiler uses the standard Racket expander, so a large number
of syntactic forms are supported. This includes <code>for</code> and <code>match</code>.</p>
<p dir="auto">Most notable omissions are the forms <code>module</code>, <code>module*</code> and <code>with-continuation-mark</code>.</p>

<p dir="auto">Tail calls are supported.
Multiple values are supported.
Upward flowing exceptions are supported.</p>
<p dir="auto">Continuations and continuation marks are not supported.
In particular, there is no support for <code>call/cc</code>  (sorry Shriram).</p>
<p dir="auto">Other omissions: promises, breaks, exit and black box.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Concurrency and Parallelism</h2><a id="user-content-concurrency-and-parallelism" aria-label="Permalink: Concurrency and Parallelism" href="#concurrency-and-parallelism"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Single threaded for now.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Foreign Function Interface</h2><a id="user-content-foreign-function-interface" aria-label="Permalink: Foreign Function Interface" href="#foreign-function-interface"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The JavaScript foreign function interface is used to access browser functionality.
The hope is that the community will help write bindings for commonly used libraries.
To some degree the generation of foreign function interfaces can be automated
with the help of an LLM.</p>
<p dir="auto">Included bindings currently cover the Math, DOM, Canvas, MathJax, XTermJS, and JSXGraph.</p>

<p dir="auto">After the initial release, the focus is to fix bugs found by early adopters.</p>
<p dir="auto">Then the top priority is to support modules.
Work on implementing linklets (needed to support modules) have already started.</p>
<p dir="auto">Due to my personal interests, complex numbers and bignums are likely to appear
sooner rather than later.</p>
<p dir="auto">Impersonators and chaperones are needed to support contracts.</p>
<p dir="auto">Unlocking modules (and linklets) will also unlock the full implementation of
regular expressions present in the source of the Racket expander.</p>
<p dir="auto">Support for continuations and continuation marks, although high on the wish list,
is something that is trickier to implement given the nature of the target.
Last resort is to add a CPS pass to the compiler.</p>

<p dir="auto">You need:</p>
<ul dir="auto">
<li>wasm-tools from the Bytecode Alliance (version 1.243.0 or newer)</li>
<li>Node.js (recent version; needs to support --experimental-wasm-exnref)</li>
<li>Racket 9.0</li>
<li>raco-static-web</li>
<li>a clone of the <code>webracket</code> repo</li>
</ul>

<p dir="auto">The WebRacket compiler depends on two external programs: <code>wasm-tools</code> and <code>node</code>.</p>
<p dir="auto">The <code>wasm-tools</code> project by Bytecode Alliance consists of a suite of WebAssembly tools.
WebRacket uses the <code>wasm-tools</code> to compile WebAssembly source files (.wat)
(in S-expression format) to bytecode (.wasm).</p>
<p dir="auto">Node (or Node.js) is a JavaScript runtime environment used to run JavaScript programs in the terminal.
WebRacket uses Node to run programs directly in the terminal.
This is useful for testing programs that do not depend on browser functionality.
A relatively new version is needed.</p>
<p dir="auto">When the target is the browser, the WebRacket compiler can optionally produce
an html file that loads the generated WebAssembly program. In order to test
locally, the package <code>raco-static-web</code> by Sam Philips is very convenient.</p>

<ol dir="auto">
<li>
<p dir="auto">Download the latest release from:</p>
<div data-snippet-clipboard-copy-content="https://github.com/bytecodealliance/wasm-tools/releases"><pre><code>https://github.com/bytecodealliance/wasm-tools/releases
</code></pre></div>
</li>
<li>
<p dir="auto">Unpack the tar-ball:</p>
<div data-snippet-clipboard-copy-content="tar -xvf wasm-tools-1.243.0-aarch64-macos.tar.gz"><pre><code>tar -xvf wasm-tools-1.243.0-aarch64-macos.tar.gz
</code></pre></div>
</li>
<li>
<p dir="auto">Open <code>README.md</code> in the browser to see further instructions.</p>
</li>
<li>
<p dir="auto">Make sure to place <code>wasm-tools</code> in somewhere in your PATH.
On macOS, you can do it with:</p>
<div data-snippet-clipboard-copy-content="sudo mv wasm-tools /usr/local/bin/"><pre><code>sudo mv wasm-tools /usr/local/bin/
</code></pre></div>
</li>
<li>
<p dir="auto">Test that <code>wasm-tools</code> works:</p>

</li>
</ol>
<p dir="auto">Depending on security settings, you might get a dialog on macOS.
If so, open the system preferences and find the &#34;Privacy and Security&#34; tab.
Then allow <code>wasm-tools</code> to run</p>

<ol dir="auto">
<li>
<p dir="auto">Go to <a href="https://nodejs.org/en/download" rel="nofollow">https://nodejs.org/en/download</a> and follow the instructions.</p>
</li>
<li>
<p dir="auto">Test that <code>node</code> works in the terminal (and that it is in you path).</p>

</li>
</ol>
<p dir="auto">WebRacket needs support for <code>exnref</code> so your Node version needs
to accept the <code>--experimental-wasm-exnref</code> flag.</p>
<p dir="auto">Here is what I see, when Node is started:</p>
<div data-snippet-clipboard-copy-content="% node --experimental-wasm-exnref --expose-gc
Welcome to Node.js v24.9.0.
Type &#34;.help&#34; for more information."><pre><code>% node --experimental-wasm-exnref --expose-gc
Welcome to Node.js v24.9.0.
Type &#34;.help&#34; for more information.
</code></pre></div>

<p dir="auto">The compiler needs Racket 9 or newer.</p>

<ol dir="auto">
<li>
<p dir="auto">Install the web-server using <code>raco</code>.</p>
<div data-snippet-clipboard-copy-content="raco pkg install raco-static-web"><pre><code>raco pkg install raco-static-web
</code></pre></div>
</li>
<li>
<p dir="auto">Test it works. Go to a folder that holds an html file.
Then start the web-server with:</p>

<p dir="auto">Follow the printing instructions.</p>
</li>
</ol>

<p dir="auto">The WebRacket compiler is a direct-style compiler.
This choice has made it easier to relate the generated code to the source program.
In the future we will probably need to add a CPS-pass in order to support
continuations and continuation marks.</p>
<p dir="auto">The frontend of the WebRacket compiler uses <code>read-syntax</code> to read
a WebRacket program from a file. The resulting syntax object is fed
into the normal Racket expander to produce a program in fully expanded form.</p>
<p dir="auto">The middle end of the compiler consists of several passes implemented
using the NanoPass framework.</p>
<p dir="auto">The passes are as follows:</p>
<div data-snippet-clipboard-copy-content="unexpand
parse
flatten-topbegin
infer-names
convert-quotations
explicit-begin
explicit-case-lambda
α-rename
assignment-conversion
categorize-applications
anormalize
closure-conversion
flatten-begin
(classify-variables)
generate-code"><pre><code>unexpand
parse
flatten-topbegin
infer-names
convert-quotations
explicit-begin
explicit-case-lambda
α-rename
assignment-conversion
categorize-applications
anormalize
closure-conversion
flatten-begin
(classify-variables)
generate-code
</code></pre></div>
<p dir="auto">See the comments in &#34;compiler.rkt&#34; for an explanation of each pass.</p>
<p dir="auto">The code generator generates WebAssembly in the form of S-expressions
in the &#34;folded&#34; format.</p>
<p dir="auto">This code generator is inspired by &#34;Destination-driven Code Generation&#34;
by Dybvig, Hieb and Butler. There are some differences, however. The code
generator in the paper generates &#34;flat&#34; code (assembler) whereas we
generate nested WebAssembly instructions.</p>
<p dir="auto">Finally, the external tool <code>wasm-tools parse</code> converts the S-expression
representation into bytecode format.</p>
<p dir="auto">The main part of the compiler is in &#34;compiler.rkt&#34;.
The WebAssembly runtime is in &#34;runtime-wasm.rkt&#34;.
The standard library (implemented in WebRacket) is found in <code>stdlib/</code>.
FFI bindings for popular libraries are in <code>ffi/</code>.</p>
<p dir="auto">It has been a design goal to avoid relying on functionality provided
by the WebAssembly host if possible. Who knows - maybe someone needs
a non-JavaScript host at some point? For browser functionality there
is no way around interfacing with the JavaScript host. The JavaScript
part of the runtime support is in <code>assembler.rkt</code>.</p>

<p dir="auto">The folder <code>examples/</code> contains a few examples that show different
aspects of WebRacket.</p>
<p dir="auto">Examples include:</p>
<ul dir="auto">
<li>MathJax 4 two-pane editor/preview</li>
<li>Matrix digital rain</li>
<li>MiniScheme REPL</li>
<li>pict port</li>
<li>Space Invaders</li>
<li>xtermjs demo</li>
</ul>

<ol dir="auto">
<li>
<p dir="auto">Go to the <code>examples/</code> folder</p>
</li>
<li>
<p dir="auto">Start a local web-server</p>
<p dir="auto">raco static-web</p>
</li>
<li>
<p dir="auto">Open  <a href="http://localhost:8000/" rel="nofollow">http://localhost:8000/</a>  in your favorite browser.</p>
</li>
<li>
<p dir="auto">Click on a folder and then click the html file.</p>
</li>
</ol>

<p dir="auto">The JavaScript library MathJax allows web page authors to use
mathematical formulas on their web pages.</p>
<p dir="auto">The MathJax example allows you to experiment with the
newest version, namely MathJax 4.</p>
<p dir="auto">The page will load MathJax 4 from a CDN (content delivery network).
The user is then presented with a simple two-pane editor/preview interface.
Any LaTeX formula entered on the left, is rendered and displayed on the right.</p>
<p dir="auto">The implementation is in one file &#34;mathjax4.rkt&#34;.</p>
<p dir="auto">Given html in the form of an S-expression, the program dynamically
generates a web page with an &#34;Input Pane&#34; and a &#34;Preview Pane&#34;.
An event handler is attached to the input pane, such that the
WebRacket function <code>update-preview-handler</code> is called each time
there are changes in the input pane.</p>
<p dir="auto">This example demonstrates how to use <code>js-var</code> and <code>js-send</code> to get
access to the JavaScript object <code>MathJax</code> and how to invoke methods
such as <code>typesetPromise</code>.</p>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://nickdrozd.github.io/soegaard/webracket/blob/main/assets/screenshots/examples/mathjax4.png"><img src="https://nickdrozd.github.io/soegaard/webracket/raw/main/assets/screenshots/examples/mathjax4.png" alt="MathJax 4 example" width="50%"/></a>
</p>

<p dir="auto">The movie &#34;Matrix&#34; by the Wachowskis featured a neat effect known
as &#34;Digital Rain&#34;.</p>
<div data-snippet-clipboard-copy-content="https://en.wikipedia.org/wiki/Digital_rain"><pre><code>https://en.wikipedia.org/wiki/Digital_rain
</code></pre></div>
<p dir="auto">The effect shows constantly falling characters, mostly green,
falling down the screen.</p>
<p dir="auto">The example uses the library <code>xterm.js</code> which emulates a
terminal in the browser.</p>
<p dir="auto">The demo highlights WebRacket&#39;s bindings for external JS libraries,
terminal control through the XtermJS FFI, and real-time animation
using browser callbacks.</p>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://nickdrozd.github.io/soegaard/webracket/blob/main/assets/screenshots/examples/matrix-rain.png"><img src="https://nickdrozd.github.io/soegaard/webracket/raw/main/assets/screenshots/examples/matrix-rain.png" alt="Matrix - digital rain example" width="50%"/></a>
</p>
<p dir="auto">Improvements to this example are welcome.</p>

<p dir="auto">MiniScheme provides an interactive Scheme REPL.</p>
<p dir="auto">There are two parts to this example.</p>
<p dir="auto">A small &#34;Scheme&#34; interpreter handles reading and evaluation of the user input.
Large parts of an editor is implemented to make the repl tolerable to use.
The terminal itself is backed by <code>xterm.js</code>.</p>
<p dir="auto">Improvements to this example are welcome.</p>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://nickdrozd.github.io/soegaard/webracket/blob/main/assets/screenshots/examples/minischeme.png"><img src="https://nickdrozd.github.io/soegaard/webracket/raw/main/assets/screenshots/examples/minischeme.png" alt="MiniScheme example" width="50%"/></a>
</p>

<p dir="auto">This is a port of the picture library <code>pict</code>.</p>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://nickdrozd.github.io/soegaard/webracket/blob/main/assets/screenshots/examples/pict.png"><img src="https://nickdrozd.github.io/soegaard/webracket/raw/main/assets/screenshots/examples/pict.png" alt="Pict example" width="50%"/></a>
</p>

<p dir="auto">Space Invaders is a 1978 shoot&#39;em up video game.</p>
<p dir="auto">The example uses a 2D canvas to render the playing area.
It sets up the canvas and styles entirely from WebRacket, tracks game
entities with mutable structs, handles keyboard input for movement and
shooting, and drives gameplay with a <code>requestAnimationFrame</code> loop. The
game illustrates WebRacket&#39;s canvas bindings, event handling for user
input, and stateful animation of sprites in a browser environment.</p>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://nickdrozd.github.io/soegaard/webracket/blob/main/assets/screenshots/examples/space-invaders.png"><img src="https://nickdrozd.github.io/soegaard/webracket/raw/main/assets/screenshots/examples/space-invaders.png" alt="space invaders example" width="25%"/></a>
</p>

<p dir="auto">The XtermJS Demo recreates the interactive terminal shown on the
xterm.js homepage.</p>
<p dir="auto">It constructs the page layout and styling with DOM operations,
initializes an xterm.js instance with theme options, registers
add-ons, and routes user input to a set of built-in demo commands.</p>
<p dir="auto">It demonstrates styling and layout via WebRacket&#39;s DOM FFI, deep
terminal control through the XtermJS bindings, and integration of JS
add-ons from Racket code.</p>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://nickdrozd.github.io/soegaard/webracket/blob/main/assets/screenshots/examples/xtermjs.png"><img src="https://nickdrozd.github.io/soegaard/webracket/raw/main/assets/screenshots/examples/xtermjs.png" alt="xtermjs example" width="50%"/></a>
</p>
</article></div></div>
  </body>
</html>
