<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.trailofbits.com/2022/11/15/python-wheels-abi-abi3audit/">Original</a>
    <h1>ABI compatibility in Python: How hard could it be?</h1>
    
    <div id="readability-page-1" class="page"><article id="post-103173">
	<!-- .entry-header -->

	<div>
		<p><strong>TL;DR:</strong> <em>Trail of Bits has developed <a href="https://github.com/trailofbits/abi3audit" target="_blank" rel="noopener">abi3audit</a>, a new Python tool for checking Python packages for CPython application binary interface (ABI) violations. We’ve used it to discover hundreds of inconsistently and incorrectly tagged package distributions, each of which is a potential source of crashes and exploitable memory corruption due to undetected ABI differences. It’s publicly available under a permissive open source license, so you can use it today!</em></p>

<p>Python is one of the most popular programming languages, with a correspondingly large package ecosystem: over 600,000 programmers use <a href="https://pypi.org/" rel="noopener" target="_blank">PyPI</a> to distribute over 400,000 unique packages, powering much of the world’s software.</p>
<p>The age of Python’s packaging ecosystem also sets it apart: among general-purpose languages, it is predated only by Perl’s <a href="https://www.cpan.org/" rel="noopener" target="_blank">CPAN</a>. This, combined with the mostly independent development of packaging tooling and standards, has made Python’s ecosystem among the more complex of the major programming language ecosystems. Those complexities include:</p>
<ul>
<li>Two major current packaging formats (source distributions and wheels), as well as a smattering of domain-specific and legacy formats (zipapps, Python Eggs, <a href="https://docs.conda.io/projects/conda/en/latest/user-guide/concepts/packages.html" rel="noopener" target="_blank">conda’s own format</a>, &amp;c.);</li><li>A constellation of different packaging tools and package specification files: <a href="https://pypi.org/project/setuptools/" rel="noopener" target="_blank">setuptools</a>, <a href="https://flit.pypa.io/" rel="noopener" target="_blank">flit</a>, <a href="https://python-poetry.org/" rel="noopener" target="_blank">poetry</a>, and <a href="https://github.com/pdm-project/pdm" rel="noopener" target="_blank">PDM</a>, as well as <a href="https://pip.pypa.io/" rel="noopener" target="_blank">pip</a>, <a href="https://github.com/pypa/pipx" rel="noopener" target="_blank">pipx</a>, and <a href="https://pipenv.pypa.io/" rel="noopener" target="_blank">pipenv</a> for actually installing packages;</li><li>…and a corresponding constellation of package and dependency specification files: <a href="https://pip.pypa.io/en/stable/reference/build-system/pyproject-toml/" rel="noopener" target="_blank">pyproject.toml</a> (PEP 518-style), <a href="https://python-poetry.org/docs/pyproject/" rel="noopener" target="_blank">pyproject.toml (Poetry-style)</a>, setup.py, setup.cfg, Pipfile, requirements.txt, MANIFEST.in, and so forth.</li></ul>
<p>This post will cover just one tiny piece of Python packaging’s complexity: the CPython stable ABI. We’ll see what the stable ABI is, why it exists, how it’s integrated into Python packaging, and how <strong>each piece goes terribly wrong</strong> to make accidental ABI violations easy.</p>
<h2>The CPython stable API and ABI</h2>
<p>Not unlike many other reference implementations, Python’s reference implementation (CPython) is written in C and provides two mechanisms for native interaction:</p>
<ul>
<li>A C Application Programming Interface (API), allowing C and C++ programmers to compile against CPython’s public headers and use any exposed functionality;</li><li>An Application Binary Interface (ABI), allowing any language with C ABI support (like Rust or Golang) to link against CPython’s runtime and use the same internals</li></ul>
<p>Developers can use the CPython API and ABI to write <a href="https://docs.python.org/3/extending/extending.html" rel="noopener" target="_blank">CPython extensions</a>. These extensions behave exactly like ordinary Python modules but interact directly with the interpreter’s implementation details rather than the “high-level” objects and APIs exposed in Python itself.</p>
<p>CPython extensions are a cornerstone of the Python ecosystem: they provide an “escape hatch” for performance-critical tasks in Python, as well as enable code reuse from native languages (like the broader C, C++, and Rust packaging ecosystems).</p>
<p>At the same time, extensions pose a problem: CPython’s APIs change between releases (as the implementation details of CPython change), meaning that <strong>it is unsound, by default</strong>, to load a CPython extension into an interpreter of a different version. The implications of this unsoundness vary: a user might get lucky and have no problems at all, might experience crashes due to missing functions or, worst of all, <strong>experience memory corruption</strong> due to changes in function signatures and structure layouts.</p>
<p>To ameliorate the situation, CPython’s developers created the <a href="https://docs.python.org/3/c-api/stable.html" rel="noopener" target="_blank">stable API and ABI</a>: a set of macros, types, functions, and data objects that are guaranteed to remain available and forward-compatible between minor releases. In other words: a CPython extension built for CPython 3.7’s stable API will also load and function correctly on CPython 3.8 and forwards, but is <strong>not</strong> guaranteed to load and function with CPython 3.6 or earlier.</p>
<p>At the ABI level, this compatibility is referred to as “<code>abi3</code>”, and is <em>optionally</em> tagged in the extension’s filename: <code>mymod.abi3.so</code>, for example, designates a loadable stable-ABI-compatible CPython extension module named <code>mymod</code>. Critically, the Python interpreter does not <em>do</em> anything with this tag — it’s simply ignored.</p>
<p>This is the first strike: CPython has no notion of whether an extension is <strong>actually</strong> stable-ABI-compatible. We’ll now see how this compounds with the state of Python packaging to produce even more problems.</p>
<h2>CPython extensions and packaging</h2>
<p>On its own, a CPython extension is just a bare Python module. To be useful to others, it needs to be <em>packaged and distributed</em> like all other modules.</p>
<p>With <a href="https://packaging.python.org/specifications/source-distribution-format/" rel="noopener" target="_blank">source distributions</a>, packaging a CPython extension is straightforward (for some definitions of straightforward): the source distribution’s build system (generally <code>setup.py</code>) describes the compilation steps needed to produce the native extension, and the package installer runs these steps during installation.</p>
<p>For example, here’s how we define <a href="https://github.com/lifting-bits/microx" rel="noopener" target="_blank">microx’s</a> native extension (microx_core) using <code>setuptools</code>:</p>
<p><a href="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?ssl=1"><img data-attachment-id="103189" data-permalink="https://blog.trailofbits.com/2022/11/15/python-wheels-abi-abi3audit/microx/" data-orig-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?fit=1600%2C635&amp;ssl=1" data-orig-size="1600,635" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="microx" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?fit=300%2C119&amp;ssl=1" data-large-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?fit=690%2C274&amp;ssl=1" decoding="async" src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?resize=690%2C274&amp;ssl=1" alt="" width="690" height="274" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?resize=1024%2C406&amp;ssl=1 1024w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?resize=300%2C119&amp;ssl=1 300w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?resize=768%2C305&amp;ssl=1 768w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?resize=1536%2C610&amp;ssl=1 1536w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?resize=1200%2C476&amp;ssl=1 1200w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?w=1600&amp;ssl=1 1600w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?w=1380&amp;ssl=1 1380w" data-lazy-sizes="(max-width: 690px) 100vw, 690px" data-lazy-src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?resize=690%2C274&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></p>
<p>Distributing a CPython extension via source distribution has advantages (✅) and disadvantages (❌):</p>
<ul>
✅API and ABI stability are <strong>non-issues</strong>: the package either builds during installation or it doesn’t and, when it does build, it runs against the same interpreter that it built against.</ul>
<p>The Python packaging ecosystem’s solution to these problems is <a href="https://packaging.python.org/en/latest/specifications/binary-distribution-format/" rel="noopener" target="_blank">wheels</a>. Wheels are a <em>binary distribution format</em>, which means that they can (but are not required to) provide <strong>pre-compiled</strong> binary extensions and other shared objects that can be installed as-is, without custom build steps. This is where ABI compatibility is <strong>absolutely essential</strong>: binary wheels are loaded blindly by the CPython interpreter, so any mismatch between the actual and expected interpreter ABIs can cause crashes (or worse, exploitable memory corruption).</p>
<p>Because wheels can contain pre-compiled extensions, they need to be tagged for the version(s) of Python that they support. This tagging is done with <a href="https://peps.python.org/pep-0425/" rel="noopener" target="_blank">PEP 425-style</a> “compatibility” tags: <code>microx-1.4.1-cp37-cp37m-macosx_10_15_x86_64.whl</code> designates a wheel that was built for CPython 3.7 on macOS 10.15 for x86-64, meaning that other Python versions, host OSes, and architectures should not attempt to install it.</p>
<p>On its own, this limitation makes wheel packaging for CPython extensions a bit of a hassle:</p>
<ul>
<p>❌In order to support all valid combinations of {<code>Python Version, Host OS, Host Architecture</code>}, the packager must build a valid wheel for each. This means additional test, build, and distribution complexity, as well as exponential CI growth as a package’s support matrix expands.</p></ul>
<p>This is where the stable ABI becomes critical: instead of building one wheel per Python, version packagers can build an “<code>abi3</code>” wheel for the lowest supported Python version. This comes with the guarantee that the wheel will work on all future (minor) releases, solving both the build matrix size problem <em>and</em> the ecosystem bootstrapping problem above.</p>
<p>Building an “<em>abi3</em>” wheel is a two-step process: the wheel is built locally (usually using the same build system as the source distribution) and then <em>retagged</em> with <code>abi3</code> as the <a href="https://peps.python.org/pep-0425/#abi-tag" rel="noopener" target="_blank">ABI tag</a> rather than a single Python version (like <code>cp37</code> for CPython 3.7).</p>
<p>Critically: <strong>neither of these steps is validated</strong>, because Python’s build tools <strong>have no good way to validate them</strong>. This leaves us with the second and third strikes:</p>
<ul>
<li>To <strong>correctly</strong> build a wheel against the stable API and ABI, the build needs to set the <a href="https://docs.python.org/3/c-api/stable.html#c.Py_LIMITED_API" rel="noopener" target="_blank"><code>Py_LIMITED_API</code></a> macro to the intended CPython support version (or, for Rust with PyO3, to use the correct build feature). This prevents Python’s C headers from using non-stable functionality or potentially inlining incompatible implementation details.</li></ul>
<p>For example, to build a wheel as <code>cp37-abi3</code> (stable ABI for CPython 3.7+), the extension needs to either <code>#define Py_LIMITED_API 0x03070000</code> in its own source code, or use the <code>setuptools.Extension</code> construct’s <code>define_macros </code>argument to configure it. These are easy to forget, and produce no warning when forgotten!</p>
<p>Additionally, when using <code>setuptools</code>, the packager <em>may</em> choose to set <code>py_limited_api=True</code>. But this <strong>does not enable any actual API restrictions</strong>; it merely adds the <code>.abi3</code> tag to the built extension’s filename. As you’ll recall this is not currently checked by the CPython interpreter, so this is <strong>effectively a no-op</strong>.</p>
<ul>
<li>To <em>tag</em> a wheel for the stable ABI, users of <a href="https://github.com/pypa/wheel" rel="noopener" target="_blank">the official wheel module and <code>bdist_wheel</code> subcommand</a> are expected to use the <code>--py-limited-api=cp37</code> flag, where 37 is the targeted minimum CPython version (3.7, here).
<p>This flag controls the wheel’s filename components, <a href="https://github.com/pypa/wheel/blob/43fcdfda8a224918eb846f8aa4f2dbe0d440889d/src/wheel/bdist_wheel.py#L294-L300" rel="noopener" target="_blank">as seen here</a>:</p>
<p><a href="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?ssl=1"><img data-attachment-id="103189" data-permalink="https://blog.trailofbits.com/2022/11/15/python-wheels-abi-abi3audit/microx/" data-orig-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?fit=1600%2C635&amp;ssl=1" data-orig-size="1600,635" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="microx" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?fit=300%2C119&amp;ssl=1" data-large-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?fit=690%2C274&amp;ssl=1" decoding="async" src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?resize=690%2C274&amp;ssl=1" alt="" width="690" height="274" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?resize=1024%2C406&amp;ssl=1 1024w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?resize=300%2C119&amp;ssl=1 300w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?resize=768%2C305&amp;ssl=1 768w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?resize=1536%2C610&amp;ssl=1 1536w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?resize=1200%2C476&amp;ssl=1 1200w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?w=1600&amp;ssl=1 1600w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?w=1380&amp;ssl=1 1380w" data-lazy-sizes="(max-width: 690px) 100vw, 690px" data-lazy-src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/microx.png?resize=690%2C274&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></p>
</li></ul>
<p>Critically, <strong>it does not affect the actual wheel build</strong>. The wheel is built however the underlying <code>setuptools.Extension</code> sees fit: it might be completely right, it might be a little wrong (stable ABI, but for the wrong CPython version), <strong>or it might be completely wrong</strong>.</p>
<p>This breakdown happens because of the devolved nature of Python packaging: the code that builds extensions is in <a href="https://github.com/pypa/setuptools" rel="noopener" target="_blank">pypa/setuptools</a>, while the code that builds wheels is in <a href="https://github.com/pypa/wheel" rel="noopener" target="_blank">pypa/wheel</a> — two <em>completely separate</em> codebases. Extension building is designed as a black box, a fact that Rust and other language ecosystems take advantage of (there is no <code>Py_LIMITED_API</code> macro to sensibly define in a PyO3-based extension — it’s all handled separately by build features).</p>
<p>To summarize:</p>
<ul>
<li>Stable ABI (“<code>abi3</code>”) wheels are the only reliable way to package native extensions without a massive build matrix.</li><li><strong>However</strong>, none of the dials that control abi3-compatible wheel building talk to each other: it’s possibly to build an abi3-compatible wheel without tagging it as such, or to build a non-abi3 wheel and tag it incorrectly as compatible, or to tag an abi3-compatible wheel as compatible with the wrong CPython version.</li><li>Consequently, <strong>the correctness of the current abi3-compatible wheel ecosystem is suspect</strong>. ABI violations are capable of causing crashes and even exploitable memory corruption, so we <strong>need</strong> to quantify the current state of affairs.</li></ul>
<h2>How bad is it, really?</h2>
<p>This all seems pretty bad, but it’s just an abstract problem: it’s entirely possible that every Python packager gets their wheel builds right, and hasn’t published any incorrectly tagged (or completely invalid) abi3-style wheels.</p>
<p>To get a sense for how bad things really are, we developed <a href="https://github.com/trailofbits/abi3audit" rel="noopener" target="_blank">abi3audit</a>. Abi3audit’s entire raison d’être is finding these kinds of ABI violation bugs: it scans individual extensions, Python wheels (which can contain multiple extensions), and entire package histories, reporting back anything that doesn’t match the specified stable ABI version or is entirely incompatible with the stable ABI.</p>
<p>To get a list of auditable packages to feed into abi3audit, I used <a href="https://packaging.python.org/en/latest/guides/analyzing-pypi-package-downloads/" rel="noopener" target="_blank">PyPI’s public BigQuery dataset</a> to generate a list of every abi3-wheel-containing package downloaded from PyPI in the last 21 days:</p>
<pre>#standardSQL
SELECT DISTINCT file.project
FROM `bigquery-public-data.pypi.file_downloads`
WHERE file.filename LIKE &#39;%abi3%&#39;
  -- Only query the last 21 days of history
  AND DATE(timestamp)
    BETWEEN DATE_SUB(CURRENT_DATE(), INTERVAL 21 DAY)
    AND CURRENT_DATE()
</pre>
<p>( I chose 21 because I blew through my BigQuery quota while testing. It’d be interesting to see the full list of downloads over a year or the entire history of PyPI, although I’d expect diminishing returns.)</p>
<p>From that query, I got 357 packages, which I’ve <a href="https://gist.github.com/woodruffw/40b79cc09d26f74e2b0ed8e13d53db9e" rel="noopener" target="_blank">uploaded as a GitHub Gist</a>. With those packages saved, a JSON report from abi3audit was only a single invocation away:</p>
<p><a href="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/abi3audit_bash.png?ssl=1"><img data-attachment-id="103207" data-permalink="https://blog.trailofbits.com/2022/11/15/python-wheels-abi-abi3audit/abi3audit_bash/" data-orig-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/abi3audit_bash.png?fit=1040%2C424&amp;ssl=1" data-orig-size="1040,424" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="abi3audit_bash" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/abi3audit_bash.png?fit=300%2C122&amp;ssl=1" data-large-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/abi3audit_bash.png?fit=690%2C281&amp;ssl=1" decoding="async" src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/abi3audit_bash.png?resize=690%2C281&amp;ssl=1" alt="" width="690" height="281" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/abi3audit_bash.png?resize=1024%2C417&amp;ssl=1 1024w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/abi3audit_bash.png?resize=300%2C122&amp;ssl=1 300w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/abi3audit_bash.png?resize=768%2C313&amp;ssl=1 768w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/abi3audit_bash.png?w=1040&amp;ssl=1 1040w" data-lazy-sizes="(max-width: 690px) 100vw, 690px" data-lazy-src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/abi3audit_bash.png?resize=690%2C281&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></p>
<p>The JSON from that audit is <a href="https://gist.github.com/woodruffw/db590d47cc671b6f4832ecdec8d13aeb" rel="noopener" target="_blank">also available as a GitHub Gist</a>.</p>
<p>First, some high-level statistics:</p>
<ul>
<li>Of the <strong>357</strong> initial packages queried from PyPI, <strong>339</strong> actually contained auditable wheels. Some were 404s (presumably created and then deleted), while others were tagged with <code>abi3</code> but did not actually contain any CPython extension modules (which does, technically, make them abi3 compatible!). A handful of these were <a href="https://docs.python.org/3/library/ctypes.html" rel="noopener" target="_blank">ctypes</a>-style modules, with either a vendored library or code to load a library that the host was expected to contain.</li><li>Those <strong>339</strong> remaining packages had a total of <strong>13650</strong> <code>abi3</code>-tagged wheels between them. The largest (in terms of wheels) was <a href="https://pypi.org/project/eclipse-zenoh-nightly/" rel="noopener" target="_blank">eclipse-zenoh-nightly</a>, with <strong>1596</strong> wheels (or nearly <strong>12 percent</strong> of all <code>abi3</code>-tagged wheels on PyPI).</li><li>The <strong>13650</strong> abi3-tagged wheels had a total of <strong>39544</strong> shared objects, each a potential Python extension, between them. In other words: the average <code>abi3</code>-tagged wheel has <strong>2.9</strong> shared objects in it, each of which was audited by <code>abi3audit</code>.</li></ul>
<p>Now, the juicy parts:</p>
<p>Of the 357 valid packages, 54 (15 percent)  contained wheels with ABI version violations. In other words: roughly one in six packages had wheels that claimed support for a particular Python version, but actually used the ABI of a newer Python version.</p>
<p>More severely: of those same 357 valid packages, 11 (3.1 percent) contained outright ABI violations. In other words: roughly one in thirty packages had wheels that claimed to be stable ABI compatible, but weren’t at all!</p>
<p>In total, 1139 (roughly 3 percent) Python extensions had version violations, and 90 (roughly 0.02 percent) had outright ABI violations. This suggests two things: that the same packages tend to have ABI violations across multiple wheels and extensions, and that multiple extensions within the same wheel tend to have ABI violations at the same time (which makes sense, since they should share the same build).</p>
<p>Here are some that we found particularly interesting:</p>
<h4>PyQt6 and sip</h4>
<p><a href="https://pypi.org/project/PyQt6/" rel="noopener" target="_blank">PyQt6</a> and <a href="https://pypi.org/project/sip/" rel="noopener" target="_blank">sip</a> are both part of the <a href="https://qt-project.org/" rel="noopener" target="_blank">Qt project</a>, and both had ABI version violations: multiple wheels were tagged for CPython 3.6 (<code>cp36-abi3</code>), but used APIs that were only stabilized with CPython 3.7.</p>
<p><a href="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pyqt6.png?ssl=1"><img data-attachment-id="103213" data-permalink="https://blog.trailofbits.com/2022/11/15/python-wheels-abi-abi3audit/pyqt6/" data-orig-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pyqt6.png?fit=1600%2C1186&amp;ssl=1" data-orig-size="1600,1186" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="pyqt6" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pyqt6.png?fit=300%2C222&amp;ssl=1" data-large-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pyqt6.png?fit=690%2C511&amp;ssl=1" decoding="async" src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pyqt6.png?resize=690%2C511&amp;ssl=1" alt="" width="690" height="511" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pyqt6.png?resize=1024%2C759&amp;ssl=1 1024w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pyqt6.png?resize=300%2C222&amp;ssl=1 300w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pyqt6.png?resize=768%2C569&amp;ssl=1 768w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pyqt6.png?resize=1536%2C1139&amp;ssl=1 1536w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pyqt6.png?resize=1200%2C890&amp;ssl=1 1200w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pyqt6.png?w=1600&amp;ssl=1 1600w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pyqt6.png?w=1380&amp;ssl=1 1380w" data-lazy-sizes="(max-width: 690px) 100vw, 690px" data-lazy-src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pyqt6.png?resize=690%2C511&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></p>
<p>sip additionally had a handful of wheels with outright ABI violations, all from the internal <code>_Py_DECREF API</code>:</p>
<p><a href="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/sip-6-6.png?ssl=1"><img data-attachment-id="103215" data-permalink="https://blog.trailofbits.com/2022/11/15/python-wheels-abi-abi3audit/sip-6-6/" data-orig-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/sip-6-6.png?fit=1600%2C1218&amp;ssl=1" data-orig-size="1600,1218" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="sip-6-6" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/sip-6-6.png?fit=300%2C228&amp;ssl=1" data-large-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/sip-6-6.png?fit=690%2C526&amp;ssl=1" decoding="async" src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/sip-6-6.png?resize=690%2C526&amp;ssl=1" alt="" width="690" height="526" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/sip-6-6.png?resize=1024%2C780&amp;ssl=1 1024w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/sip-6-6.png?resize=300%2C228&amp;ssl=1 300w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/sip-6-6.png?resize=768%2C585&amp;ssl=1 768w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/sip-6-6.png?resize=1536%2C1169&amp;ssl=1 1536w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/sip-6-6.png?resize=1200%2C914&amp;ssl=1 1200w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/sip-6-6.png?w=1600&amp;ssl=1 1600w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/sip-6-6.png?w=1380&amp;ssl=1 1380w" data-lazy-sizes="(max-width: 690px) 100vw, 690px" data-lazy-src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/sip-6-6.png?resize=690%2C526&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></p>
<h4>refl1d</h4>
<p><a href="https://pypi.org/project/refl1d/" rel="noopener" target="_blank">refl1d</a> is a <a href="https://www.nist.gov/ncnr/data-reduction-analysis/reflectometry-software" rel="noopener" target="_blank">NIST-developed</a> reflectometry package. They did a couple of releases tagged for the stable ABI of Python 3.2 (the absolute lowest), while actually targeting the stable ABI of Python 3.11 (the absolute highest — not even released yet!).</p>
<p><a href="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/refl1d.png?ssl=1"><img data-attachment-id="103218" data-permalink="https://blog.trailofbits.com/2022/11/15/python-wheels-abi-abi3audit/refl1d/" data-orig-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/refl1d.png?fit=1600%2C1414&amp;ssl=1" data-orig-size="1600,1414" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="refl1d" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/refl1d.png?fit=300%2C265&amp;ssl=1" data-large-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/refl1d.png?fit=690%2C610&amp;ssl=1" decoding="async" src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/refl1d.png?resize=690%2C610&amp;ssl=1" alt="" width="690" height="610" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/refl1d.png?resize=1024%2C905&amp;ssl=1 1024w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/refl1d.png?resize=300%2C265&amp;ssl=1 300w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/refl1d.png?resize=768%2C679&amp;ssl=1 768w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/refl1d.png?resize=1536%2C1357&amp;ssl=1 1536w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/refl1d.png?resize=1200%2C1061&amp;ssl=1 1200w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/refl1d.png?w=1600&amp;ssl=1 1600w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/refl1d.png?w=1380&amp;ssl=1 1380w" data-lazy-sizes="(max-width: 690px) 100vw, 690px" data-lazy-src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/refl1d.png?resize=690%2C610&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></p>
<h4>hdbcli</h4>
<p><a href="https://pypi.org/project/hdbcli/" rel="noopener" target="_blank">hdbcli</a> appears to be a proprietary client for <a href="https://en.wikipedia.org/wiki/SAP_HANA" rel="noopener" target="_blank">SAP HANA</a>, published by SAP themselves. It’s tagged as <code>abi3</code>, which is cool! Unfortunately, it isn’t <em>actually</em> abi3-compatible:</p>
<p><a href="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/hdbcli.png?ssl=1"><img data-attachment-id="103221" data-permalink="https://blog.trailofbits.com/2022/11/15/python-wheels-abi-abi3audit/hdbcli/" data-orig-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/hdbcli.png?fit=1600%2C1277&amp;ssl=1" data-orig-size="1600,1277" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="hdbcli" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/hdbcli.png?fit=300%2C239&amp;ssl=1" data-large-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/hdbcli.png?fit=690%2C551&amp;ssl=1" decoding="async" src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/hdbcli.png?resize=690%2C551&amp;ssl=1" alt="" width="690" height="551" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/hdbcli.png?resize=1024%2C817&amp;ssl=1 1024w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/hdbcli.png?resize=300%2C239&amp;ssl=1 300w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/hdbcli.png?resize=768%2C613&amp;ssl=1 768w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/hdbcli.png?resize=1536%2C1226&amp;ssl=1 1536w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/hdbcli.png?resize=1200%2C958&amp;ssl=1 1200w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/hdbcli.png?w=1600&amp;ssl=1 1600w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/hdbcli.png?w=1380&amp;ssl=1 1380w" data-lazy-sizes="(max-width: 690px) 100vw, 690px" data-lazy-src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/hdbcli.png?resize=690%2C551&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></p>
<p>This, again, suggests building without the correct macros. We’d be able to figure out more with the source code, but this package appears to be completely proprietary.</p>
<h4>gdp and pifacecam</h4>
<p>These are two smaller packages, but they piqued my interest because both had stable ABI violations that weren’t just the reference/counting helper APIs:</p>
<p><a href="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/gdp.png?ssl=1"><img data-attachment-id="103223" data-permalink="https://blog.trailofbits.com/2022/11/15/python-wheels-abi-abi3audit/gdp/" data-orig-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/gdp.png?fit=1084%2C1600&amp;ssl=1" data-orig-size="1084,1600" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="gdp" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/gdp.png?fit=203%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/gdp.png?fit=690%2C1018&amp;ssl=1" decoding="async" src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/gdp.png?resize=690%2C1018&amp;ssl=1" alt="" width="690" height="1018" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/gdp.png?resize=694%2C1024&amp;ssl=1 694w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/gdp.png?resize=203%2C300&amp;ssl=1 203w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/gdp.png?resize=768%2C1134&amp;ssl=1 768w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/gdp.png?resize=1041%2C1536&amp;ssl=1 1041w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/gdp.png?w=1084&amp;ssl=1 1084w" data-lazy-sizes="(max-width: 690px) 100vw, 690px" data-lazy-src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/gdp.png?resize=690%2C1018&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></p>
<p><a href="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pifacecam.png?ssl=1"><img data-attachment-id="103224" data-permalink="https://blog.trailofbits.com/2022/11/15/python-wheels-abi-abi3audit/pifacecam/" data-orig-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pifacecam.png?fit=1600%2C449&amp;ssl=1" data-orig-size="1600,449" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="pifacecam" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pifacecam.png?fit=300%2C84&amp;ssl=1" data-large-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pifacecam.png?fit=690%2C193&amp;ssl=1" decoding="async" src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pifacecam.png?resize=690%2C193&amp;ssl=1" alt="" width="690" height="193" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pifacecam.png?resize=1024%2C287&amp;ssl=1 1024w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pifacecam.png?resize=300%2C84&amp;ssl=1 300w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pifacecam.png?resize=768%2C216&amp;ssl=1 768w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pifacecam.png?resize=1536%2C431&amp;ssl=1 1536w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pifacecam.png?resize=1200%2C337&amp;ssl=1 1200w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pifacecam.png?w=1600&amp;ssl=1 1600w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pifacecam.png?w=1380&amp;ssl=1 1380w" data-lazy-sizes="(max-width: 690px) 100vw, 690px" data-lazy-src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/pifacecam.png?resize=690%2C193&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></p>
<h4>dockerfile</h4>
<p>Finally, I liked this one because it turns out to be a Python extension written in Go, not C, C++, or Rust!</p>
<p><a href="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/dockerfile.png?ssl=1"><img data-attachment-id="103226" data-permalink="https://blog.trailofbits.com/2022/11/15/python-wheels-abi-abi3audit/dockerfile/" data-orig-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/dockerfile.png?fit=1600%2C548&amp;ssl=1" data-orig-size="1600,548" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="dockerfile" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/dockerfile.png?fit=300%2C103&amp;ssl=1" data-large-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/dockerfile.png?fit=690%2C237&amp;ssl=1" decoding="async" src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/dockerfile.png?resize=690%2C237&amp;ssl=1" alt="" width="690" height="237" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/dockerfile.png?resize=1024%2C351&amp;ssl=1 1024w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/dockerfile.png?resize=300%2C103&amp;ssl=1 300w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/dockerfile.png?resize=768%2C263&amp;ssl=1 768w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/dockerfile.png?resize=1536%2C526&amp;ssl=1 1536w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/dockerfile.png?resize=1200%2C411&amp;ssl=1 1200w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/dockerfile.png?w=1600&amp;ssl=1 1600w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/dockerfile.png?w=1380&amp;ssl=1 1380w" data-lazy-sizes="(max-width: 690px) 100vw, 690px" data-lazy-src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/dockerfile.png?resize=690%2C237&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></p>
<p>The maintainer had the right idea, but didn’t define Py_LIMITED_API to any particular value. So Python’s headers “helpfully” interpreted that as not limited at all:</p>
<p><a href="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/setup.png?ssl=1"><img data-attachment-id="103228" data-permalink="https://blog.trailofbits.com/2022/11/15/python-wheels-abi-abi3audit/setup/" data-orig-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/setup.png?fit=1396%2C530&amp;ssl=1" data-orig-size="1396,530" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="setup" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/setup.png?fit=300%2C114&amp;ssl=1" data-large-file="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/setup.png?fit=690%2C262&amp;ssl=1" decoding="async" src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/setup.png?resize=690%2C262&amp;ssl=1" alt="" width="690" height="262" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/setup.png?resize=1024%2C389&amp;ssl=1 1024w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/setup.png?resize=300%2C114&amp;ssl=1 300w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/setup.png?resize=768%2C292&amp;ssl=1 768w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/setup.png?resize=1200%2C456&amp;ssl=1 1200w, https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/setup.png?w=1396&amp;ssl=1 1396w" data-lazy-sizes="(max-width: 690px) 100vw, 690px" data-lazy-src="https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/11/setup.png?resize=690%2C262&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></p>
<h2>The path forward</h2>
<p>First, the silver lining: most of the extremely popular packages in the list had no ABI violations or version mismatches. <a href="https://cryptography.io/" rel="noopener" target="_blank">Cryptography</a> and <a href="https://github.com/pyca/bcrypt" rel="noopener" target="_blank">bcrypt</a> were spared, for example, indicating strong build controls on their side. Other relatively popular packages had version violations, but they were <em>generally</em> minor (for example: expecting a function that was only stabilized with 3.7, but has been present and the same since 3.3).</p>
<p>Overall, however, these results are not great: they indicate (1) that a significant portion of the “<code>abi3</code>” wheels on PyPI aren’t really abi3-compatible at all (or are compatible with a different version than they claim), and (2) that maintainers don’t fully understand the different knobs that control abi3 tagging (and that those knobs do not actually modify the build itself).</p>
<p>More generally, the results point to a need for better controls, better documentation, and better interoperation between Python’s different packaging components. In nearly all cases, the package’s maintainer has <em>attempted</em> to do the right thing, but seemingly wasn’t aware of the additional steps necessary to actually build an abi3-compatible wheel. In addition to improving the package-side tooling here, the auditing is also automatable: we’ve designed <code><a href="https://github.com/trailofbits/abi3audit" rel="noopener" target="_blank">abi3audit</a></code> in part to demonstrate that it would be possible for PyPI to catch these kinds of wheel errors before they become a part of the public index.</p>
			</div><!-- .entry-content -->

	
</article></div>
  </body>
</html>
