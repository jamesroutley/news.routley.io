<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gist.github.com/munificent/b1bcd969063da3e6c298be070a22b604">Original</a>
    <h1>A random dungeon generator that fits on a business card</h1>
    
    <div id="readability-page-1" class="page"><p dir="auto">I used the language&#39;s vector operations and some additional refactoring to significantly cut down on the amount of &#34;math&#34; the original does.</p><div dir="auto"><pre><span>// based on: https://gist.github.com/munificent/b1bcd969063da3e6c298be070a22b604</span>
<span>// via: https://gist.github.com/Joker-vD/cc5372a349559b9d1a3b220d5eaf2b01</span>

<span>include</span> <span>std</span>
<span>include</span> <span>vec</span>
<span>include</span> <span>color</span>

<span>let</span> <span>TILE_VOID</span>        = <span>&#39; &#39;</span>
<span>let</span> <span>TILE_FLOOR</span>       = <span>&#39;.&#39;</span>
<span>let</span> <span>TILE_WALL</span>        = <span>&#39;#&#39;</span>
<span>let</span> <span>TILE_CORNER</span>      = <span>&#39;!&#39;</span>
<span>let</span> <span>TILE_OPEN_DOOR</span>   = <span>&#39;\&#39;&#39;</span>
<span>let</span> <span>TILE_CLOSED_DOOR</span> = <span>&#39;+&#39;</span>
<span>let</span> <span>TILE_PLAYER</span>      = <span>&#39;@&#39;</span>

<span>let</span> <span>fsize</span> = <span>xy</span> { <span>80</span>, <span>40</span> }
<span>var</span> <span>field</span> = <span>mapxy</span>(<span>fsize</span>): <span>TILE_VOID</span>

<span>def</span> <span>cave</span>(<span>with_player</span>):
    <span>// csize/start are all inner dimensions/coordinates (w/o walls)</span>
    <span>let</span> <span>csize</span> = <span>xy_rndi</span>(<span>xy</span> { <span>10</span>, <span>6</span> }) + <span>xy</span> { <span>5</span>, <span>3</span> }
    <span>let</span> <span>start</span> = <span>xy_rndi</span>(<span>fsize</span> - <span>csize</span> - <span>2</span>) + <span>1</span>

    <span>// Cave iterator function that supplies wall/corner type.</span>
    <span>def</span> <span>in_box</span>(<span>f</span>):
        <span>forxy</span>(<span>csize</span> + <span>2</span>) <span>v</span>:
            <span>v</span> += <span>start</span> - <span>1</span>
            <span>let</span> <span>at_wall</span> = (<span>v</span> &lt; <span>start</span>) + (<span>v</span> &gt;= <span>start</span> + <span>csize</span>)
            <span>// We need to somehow record corners of all caves to check</span>
            <span>// for intersections later, so we use a special tile for it</span>
            <span>f</span>(<span>v</span>, [ <span>TILE_FLOOR</span>, <span>TILE_WALL</span>, <span>TILE_CORNER</span> ][<span>manhattan</span>(<span>at_wall</span>)])

    <span>// Check if the new cave (with walls) intersects with the interior of</span>
    <span>// any already existing cave. Touching walls/corners are okay</span>
    <span>in_box</span>() <span>v</span>:
        <span>if</span> <span>field</span>[<span>v</span>] == <span>TILE_FLOOR</span>: <span>return</span>

    <span>// Find a suitable place for a door</span>
    <span>var</span> <span>door_counter</span> = <span>0</span>
    <span>var</span> <span>door_pos</span> = <span>xy_0i</span>
    <span>if</span> <span>not</span> <span>with_player</span>:
        <span>in_box</span>() <span>v</span>, <span>tile</span>:
            <span>// The door should not be created in the cave&#39;s corner or over</span>
            <span>// another door, or in another cave&#39;s corner. It&#39;s impossible</span>
            <span>// to make a cave without a door, because rnd always</span>
            <span>// returns 0.</span>
            <span>if</span> <span>tile</span> == <span>TILE_WALL</span> <span>and</span> <span>field</span>[<span>v</span>] == <span>TILE_WALL</span>:
                <span>door_counter</span>++
                <span>if</span> <span>rnd</span>(<span>door_counter</span>) == <span>0</span>: <span>door_pos</span> = <span>v</span>

        <span>// If the cave&#39;s walls were made completely out of corners</span>
        <span>// and doors, don&#39;t make such a cave</span>
        <span>if</span> <span>door_counter</span> == <span>0</span>: <span>return</span>

    <span>// The cave looks okay, let&#39;s draw it. First, draw the walls and the floor</span>
    <span>in_box</span>() <span>v</span>, <span>tile</span>:
        <span>field</span>[<span>v</span>] = <span>tile</span>

    <span>// Now draw the door.</span>
    <span>if</span> <span>door_counter</span> &gt; <span>0</span>:
        <span>field</span>[<span>door_pos</span>] = <span>if</span> <span>rnd</span>(<span>2</span>): <span>TILE_OPEN_DOOR</span> <span>else</span>: <span>TILE_CLOSED_DOOR</span>

    <span>if</span> <span>with_player</span>:
        <span>// A cave with the player has only the player inside it</span>
        <span>field</span>[<span>xy_rndi</span>(<span>csize</span>) + <span>start</span>] = <span>TILE_PLAYER</span>
    <span>else</span>:
        <span>// A cave without the player has some random mobs and/or gold in it;</span>
        <span>// 1d6 of entities total, 25% chance of gold, 75% of a mob.</span>
        <span>// Mob letters range from &#39;A&#39; to &#39;~&#39;, inclusive</span>
        <span>for</span> <span>rnd</span>(<span>6</span>) + <span>1</span>:
            <span>field</span>[<span>xy_rndi</span>(<span>csize</span>) + <span>start</span>] =
                <span>if</span> <span>rnd</span>(<span>4</span>) == <span>0</span>: <span>&#39;$&#39;</span> <span>else</span>: <span>&#39;A&#39;</span> + <span>rnd</span>(<span>&#39;~&#39;</span> - <span>&#39;A&#39;</span> + <span>1</span>)

<span>rnd_seed</span>(<span>int</span>(<span>seconds_elapsed</span>() * <span>1000000</span>))

<span>// A call to cave() is not guaranteed to actually make a new cave,</span>
<span>// so call it many times</span>
<span>for</span>(<span>1000</span>) <span>j</span>:
    <span>cave</span>(<span>j</span> == <span>0</span>)

<span>// Remove special corner type.</span>
<span>forxy</span>(<span>fsize</span>) <span>v</span>:
    <span>if</span> <span>field</span>[<span>v</span>] ==  <span>TILE_CORNER</span>:
        <span>field</span>[<span>v</span>] = <span>TILE_WALL</span>

<span>// Print the generated field</span>
<span>for</span>(<span>field</span>) <span>row</span>:
    <span>print</span> <span>unicode_to_string</span>(<span>row</span>)</pre></div><p dir="auto">The language has no syntax highlighting on github, so the above is better than nothing.</p></div>
  </body>
</html>
