<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://www.righto.com/2021/12/yamaha-dx7-reverse-engineering-part-iii.html">Original</a>
    <h1>Yamaha DX7 reverse-engineering, part III: Inside the log-sine ROM</h1>
    
    <div id="readability-page-1" class="page"><div id="post-body-5925435494478164745" itemprop="description articleBody">


<p>The Yamaha DX7 digital synthesizer (1983) was the classic synthesizer for 1980s pop music.
It used two custom digital chips to generate sounds with FM synthesis.
In this blog post, I examine the log-sine ROM that digitally produces sine waves inside one of these chips.
(This blog post jumps into the details; unless you care about the sine values specifically, my previous <a href="https://www.righto.com/2021/11/reverse-engineering-yamaha-dx7.html">DX7 reverse-engineering article</a> is probably more interesting.)</p>
<p>I created the high-resolution die photo below by compositing over a hundred microscope photos.
I removed the metal layer from the chip with acid to reveal the silicon and polysilicon wiring underneath.
You can see the structure of the functional blocks and the connections between them.
The colors are due to variations in thickness of the oxide layer, causing thin-film interference.
With the metal layer removed, I could read out the bits from the ROM, reverse-engineer the circuitry, and determine the exact values used for sine-wave generation.</p>
<p><a href="https://static.righto.com/images/dx7-sin/stripped2.jpg"><img alt="Die photo of the DX7&#39;s YM21280 Operator chip.  Click this photo (or any other) for a magnified version." height="436" src="https://static.righto.com/images/dx7-sin/stripped2-w500.jpg" title="Die photo of the DX7&#39;s YM21280 Operator chip.  Click this photo (or any other) for a magnified version." width="500"/></a></p><p>Die photo of the DX7&#39;s YM21280 Operator chip.  Click this photo (or any other) for a magnified version.</p>
<p>Instead of the analog oscillators and filters of an analog synthesizer, the DX7 generates sounds digitally, using a technique called FM synthesis.
The idea is that you start with a sine wave (the carrier signal) and perturb it with another signal (the modulating signal). The modulating signal changes the phase (and thus the frequency) of the carrier, creating complex harmonic structures like the waveform below.
These signals are represented as digital values throughout the system; a digital-to-analog converter (DAC) turns the digital representation into
an analog voltage for the synthesizer&#39;s output.</p>
<p><a href="https://static.righto.com/images/dx7-sin/waveform.jpg"><img alt="An example of a complex waveform created by FM synthesis.  (I made a tool that lets you experiment with FM synthesis.)" height="203" src="https://static.righto.com/images/dx7-sin/waveform-w500.jpg" title="An example of a complex waveform created by FM synthesis.  (I made a tool that lets you experiment with FM synthesis.)" width="500"/></a></p><p>An example of a complex waveform created by FM synthesis.  (I made a <a href="https://www.righto.com/2021/11/reverse-engineering-yamaha-dx7.html#fnref:tool">tool</a> that lets you experiment with FM synthesis.)</p>
<p>The digital implementation of frequency modulation uses a lookup table that holds a digitized sine wave.
By stepping an index through the table at a specific rate, you can produce a sine wave of a fixed frequency. 
By perturbing this index with another signal, you can produce a modulated sine wave like the one below.
The DX7 implements this with a sine-wave table in ROM,
an increment value that controls the frequency, and an adder that adds the increment to the table index (i.e. the phase angle) each time step.
This ROM is the subject of this blog post.</p>
<p>The amplitude of the sine wave is controlled by an envelope, varying over time; multiplying the sine wave by the envelope level yields the output.
However, fast multiplication required too much hardware in the 1980s, so the DX7 uses a mathematical shortcut: adding logarithms is equivalent to multiplying the values.
The obvious problem is that computing logarithms is harder than multiplying, but the trick is to store the (negated) logarithm of the sine wave in the lookup table (below) instead
of the sine wave.
This provides the logarithm for free.
(The other issue is that you need to perform an exponential to get the final result. I described the exponential ROM and circuit in my <a href="https://www.righto.com/2021/11/reverse-engineering-yamaha-dx7_28.html">previous DX7 article</a>).</p>
<p><a href="https://static.righto.com/images/dx7-sin/graph.jpg"><img alt="This graph shows the log-sine function over one quarter of the wave, as a 14-bit value. It&#39;s not recognizable as a sine function, but will turn into a sine wave after exponentiation." height="306" src="https://static.righto.com/images/dx7-sin/graph-w500.jpg" title="This graph shows the log-sine function over one quarter of the wave, as a 14-bit value. It&#39;s not recognizable as a sine function, but will turn into a sine wave after exponentiation." width="500"/></a></p><p>This graph shows the log-sine function over one quarter of the wave, as a 14-bit value. It&#39;s not recognizable as a sine function, but will turn into a sine wave after exponentiation.</p>
<p>The block diagram below shows the structure of the log-sine circuit, computing a 14-bit value from a 12-bit input.
The circuitry is somewhat complex to fit a fast, high-accuracy calculation into a small space on the die.
The implementation takes advantage of the symmetry of the sine wave so only a quarter-wave needs to be stored.
The top bit is used as the sign bit, which inverts the output elsewhere to obtain the negative half of the sine wave.
(This also avoids the problem of taking the log of a negative value.)
The second bit implements the mirror symmetry of each sine-wave peak by inverting the bits for the second half of the peak.</p>
<p><a href="https://static.righto.com/images/dx7-sin/block-diagram.jpg"><img alt="Block diagram of the sine circuit. Input bits are indicated in green." height="219" src="https://static.righto.com/images/dx7-sin/block-diagram-w700.jpg" title="Block diagram of the sine circuit. Input bits are indicated in green." width="700"/></a></p><p>Block diagram of the sine circuit. Input bits are indicated in green.</p>
<p>The ROM and associated logic take a 10-bit input address representing a quarter of the sine wave (angles 0 through π/2).
A technique called delta encoding is used to reduce the size of the ROM.
The idea of delta encoding is that if values change slowly, the difference between two values is considerably smaller than the value itself.<span id="fnref:ymf262"><a href="#fn:ymf262">1</a></span>
Specifically, only every fourth value is explicitly stored in the ROM; this value is called an &#34;absolute&#34; value.<span id="fnref:absolute"><a href="#fn:absolute">3</a></span>
The next three values are stored as deltas: the difference between the value and the previous absolute value.<span id="fnref:delta"><a href="#fn:delta">2</a></span>
An adder circuit adds the absolute value to the difference value, yielding the desired log-sin value.</p>
<p>The diagram below labels the main functional blocks of the chip.
In this article, I focus on the sine circuit, highlighted in red, but I&#39;ll summarize the
other blocks.
The 96 phase accumulators, implemented with shift registers, are the largest block of the chip.
They hold the current table index for each of the DX7&#39;s 96 oscillators.
The exponential function is implemented by two identical ROMs and associated addition/shifter circuitry.
Other major blocks apply the envelope, hold configuration data, compute the operators that combine oscillators, define different operator algorithms, and buffer the output values.</p>
<p><a href="https://static.righto.com/images/dx7-sin/die-labeled.jpg"><img alt="Die with the major functional blocks labeled. This photo shows the metal layer of the chip. (Click for a larger version.)" height="524" src="https://static.righto.com/images/dx7-sin/die-labeled-w600.jpg" title="Die with the major functional blocks labeled. This photo shows the metal layer of the chip. (Click for a larger version.)" width="600"/></a></p><p>Die with the major functional blocks labeled. This photo shows the metal layer of the chip. (Click for a larger version.)</p>
<h2>The ROM</h2>
<p>The photo below shows the log-sin ROM. The ROM itself consists of a grid of transistors. At the top, decoder circuits select signal lines based on the address bits.
At the right, the diagonal circuits are multiplexers, selecting particular rows of the ROM. To the right of the multiplexers, logic circuits select the delta values.
I won&#39;t explain these circuits in detail since I discussed the similar circuits for the exponential ROMs in my <a href="https://www.righto.com/2021/11/reverse-engineering-yamaha-dx7_28.html">previous article</a>.</p>
<p><a href="https://static.righto.com/images/dx7-sin/sin-rom-cropped.jpg"><img alt="High-resolution image of the sine ROM. Click this image (or any other) for an enlarged image.)" height="954" src="https://static.righto.com/images/dx7-sin/sin-rom-cropped-w300.jpg" title="High-resolution image of the sine ROM. Click this image (or any other) for an enlarged image.)" width="300"/></a></p><p>High-resolution image of the sine ROM. Click this image (or any other) for an enlarged image.)</p>
<p>By examining the ROM closely, you can see the individual transistors that store bits. A transistor represents a 1, and the lack of a transistor represents a 0.
Thus, the data in the ROM is created by the pattern of how the silicon is doped.
I was able to read out the ROM data visually by looking at this pattern.</p>
<p><a href="https://static.righto.com/images/dx7-sin/rom-closeup.jpg"><img alt="Closeup of the ROM." height="185" src="https://static.righto.com/images/dx7-sin/rom-closeup-w400.jpg" title="Closeup of the ROM." width="400"/></a></p><p>Closeup of the ROM.</p>
<h2>The delta representation and the adder</h2>
<p>The ROM itself produces 43 output bits, 13 bits for the &#34;absolute&#34; value and 30 bits for the three delta values.
Some logic circuitry expands the ROM&#39;s 30 bits into three deltas of 12 bits (and a zero delta for the absolute value), taking
advantage of some structure in the deltas. This circuitry is just to the right of the ROM and is implemented with AND-OR-INVERT gates.
These gates implement 4-to-1 multiplexers, selecting the appropriate delta value based on the 2 lowest input bits.</p>
<p>Next, the adder circuit to the right of the ROM adds the 13-bit absolute value and the 12-bit delta value to generate the final 14-bit value.
One interesting feature of the adder is it is pipelined to minimize the delay from carry propagation.
I discussed the adder implementation in my <a href="https://www.righto.com/2021/11/reverse-engineering-yamaha-dx7.html">previous article</a> so I won&#39;t go into details here.
The adder is immediately followed by a second adder that adds the envelope value to scale the signal level, taking advantage of the logarithmic representation.</p>
<p>Overall, the log-sine circuit generates 1024 14-bit values.
Stored directly, this would take over 14 kilobits, but the ROM is only 5344 bits. The delta representation and ROM compression reduce the ROM size by almost 63%,
important for a chip built in the 1980s when transistors were precious.
By itself, the delta representation doesn&#39;t save much space: a 12-bit delta instead of a 14-bit value.
But the ROM&#39;s implementation makes the deltas efficient: if a 32-bit row in the ROM is all zeroes, the row can be omitted entirely and the output defaults to 0.
For the flat parts of the function, the high-order bits of the deltas are mostly zero, so much of the ROM can be omitted.</p>
<h2>Conclusion</h2>
<p>The DX7 generates its waveforms from a digital sine wave, so producing a high-accuracy value rapidly is key to the synthesizer&#39;s performance.
By examining the ROM and associated circuitry, I could obtain the exact values that the DX7 uses for the log-sine function.
The ROM provides one quarter of the sine wave and the other quarters are formed by symmetry.
For a 10-bit input value <em>n</em>, the corresponding angle is <em>ω = (n + .5)/1024×π/2</em><span id="fnref:half"><a href="#fn:half">4</a></span>
and output value <em>y</em> is <em>-log<sub>2</sub>(sin(ω))</em>,
represented as the integer <em>round(y×1024)</em>.<span id="fnref:rounding"><a href="#fn:rounding">5</a></span></p>
<p><a href="https://static.righto.com/images/dx7-sin/package.jpg"><img alt="The DX7&#39;s OPS chip comes in a 64-pin ceramic package with staggered pins. This is known as a Quad Inline Package (QIP). Photo courtesy of Jacques Mattheij." height="222" src="https://static.righto.com/images/dx7-sin/package-w400.jpg" title="The DX7&#39;s OPS chip comes in a 64-pin ceramic package with staggered pins. This is known as a Quad Inline Package (QIP). Photo courtesy of Jacques Mattheij." width="400"/></a></p><p>The DX7&#39;s OPS chip comes in a 64-pin ceramic package with staggered pins. This is known as a Quad Inline Package (QIP). Photo courtesy of Jacques Mattheij.</p>
<p>I plan to continue investigating the DX7&#39;s circuitry,
so follow me on Twitter <a href="https://twitter.com/kenshirriff">@kenshirriff</a> for updates. I also have an <a href="http://www.righto.com/feeds/posts/default">RSS feed</a>.</p>
<p>Thanks to Jacques Mattheij and Anthony Richardson for providing the chip and discussion.<span id="fnref:refs"><a href="#fn:refs">6</a></span></p>
<h2>Notes and references</h2>


</div></div>
  </body>
</html>
