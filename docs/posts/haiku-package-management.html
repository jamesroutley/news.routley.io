<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.markround.com/blog/2023/02/13/haiku-package-management/">Original</a>
    <h1>Haiku Package Management</h1>
    
    <div id="readability-page-1" class="page"><section itemprop="text">
        
        <p>I’ve <a href="https://www.markround.com/about/#rootlocalhost" target="_blank">long since</a> been a die-hard BeOS fan and have been running the open-source recreation <a href="https://www.haiku-os.org" target="_blank">Haiku</a> for many years. I think it’s interesting to explore the “alternative OS” world and consider some <a href="https://youtu.be/7RNbIEJvjUA" target="_blank">great</a> <a href="https://datagubbe.se/ltmag/" target="_blank">ideas</a> that for whatever reason never caught on elsewhere.</p>

<p>The way Haiku handles package management and its alternative approach to an “immutable system” is one of those ideas I find <em>really</em> cool. Here’s what it looks like from a desktop user’s perspective - there’s all the usual stuff like an “app store”, package updater, repositories of packages and so on:</p>

<p><a href="https://www.markround.com/assets/images/haiku/package-tools.png"><picture><source srcset="/assets/generated/haiku/package-tools-200-8a322333d.webp 200w, /assets/generated/haiku/package-tools-400-8a322333d.webp 400w, /assets/generated/haiku/package-tools-800-8a322333d.webp 800w, /assets/generated/haiku/package-tools-1600-8a322333d.webp 1600w" type="image/webp"/><source srcset="/assets/generated/haiku/package-tools-200-99f343256.png 200w, /assets/generated/haiku/package-tools-400-99f343256.png 400w, /assets/generated/haiku/package-tools-800-99f343256.png 800w, /assets/generated/haiku/package-tools-1600-99f343256.png 1600w" type="image/png"/><img src="https://www.markround.com/assets/generated/haiku/package-tools-800-99f343256.png"/></picture></a></p>

<p>It’s all there and works well - it’s easily as smooth as any desktop Linux experience. However, it’s the implementation details behind the scenes that make it so interesting to me. Haiku takes a refreshingly new approach to package management: Despite the user experience “feeling” like a traditional package manager - say, something like <code>apt</code> or <code>dnf</code> - it has seamless support for:</p>

<ul>
  <li>Immutable system directories</li>
  <li>Rollback to previous states</li>
  <li>User-managed packages separated from system packages</li>
</ul>

<p>And a whole bunch of infrastructure and tooling to support multiple package repositories, building packages from source and more. As a geek, I find it beautifully elegant and an idea that I’d love to see other platforms exploring.</p>

<p>Let’s take a closer look, starting with how Haiku handles the split between “system” and “user” directories.</p>


<p>Running a <code>df</code> command from the Haiku shell (BASH is the default, but others like ZSH can be easily installed) shows the following:</p>

<div><div><pre><code>~&gt; <span>df</span> <span>-h</span>
 Mount             Type      Total     Free      Flags   Device
<span>-----------------</span> <span>---------</span> <span>---------</span> <span>---------</span> <span>-------</span> <span>------------------------</span>
/boot             bfs       232.9 GiB 219.6 GiB QAM-P-W /dev/disk/scsi/0/0/0/0
/boot/system      packagefs   4.0 KiB   4.0 KiB QAM-P--
/boot/home/config packagefs   4.0 KiB   4.0 KiB QAM-P--
</code></pre></div></div>

<p>In Haiku, the root <code>/</code> is a ram-based virtual filesystem set up by the kernel when it’s booted. All other filesystems and devices are mounted under <code>/</code>, so <code>/boot</code> refers to the entire boot volume - and not a boot partition as is the case with e.g. most Linux installs.</p>

<p>The <code>/boot/system</code> mountpoint is essentially the system directory which makes up the Haiku OS and installed applications. In the root directory, there are a bunch of symlinks that point there for convenience:</p>

<div><div><pre><code>~&gt; <span>ls</span> <span>-l</span> /
total 6
lrwxrwxrwx 1 user root   16 Feb 13 14:18 bin -&gt; /boot/system/bin
drwxr-xr-x 1 user root 2048 Mar 31  2021 boot
drwxr-xr-x 1 user root    0 Feb 13 14:18 dev
lrwxrwxrwx 1 user root   25 Feb 13 14:18 etc -&gt; /boot/system/settings/etc
lrwxrwxrwx 1 user root    5 Feb 13 14:18 Haiku -&gt; /boot
lrwxrwxrwx 1 user root   26 Feb 13 14:18 packages -&gt; /boot/system/package-links
lrwxrwxrwx 1 user root   12 Feb 13 14:18 system -&gt; /boot/system
lrwxrwxrwx 1 user root   22 Feb 13 14:18 tmp -&gt; /boot/system/cache/tmp
lrwxrwxrwx 1 user root   16 Feb 13 14:18 var -&gt; /boot/system/var
</code></pre></div></div>

<p>So we can access e.g. <code>/boot/system</code> as <code>/system</code> and so on. Note that this mount point is backed by <code>packagefs</code> - this is provided by a virtual filesystem that presents a merged view of all the packages installed. It’s sort of like an overlay filesystem (commonly used by container runtimes) in the Linux world.</p>

<p>This mount-point is read only:</p>

<div><div><pre><code>~&gt; <span>touch</span> /system/test
<span>touch</span>: cannot <span>touch</span> <span>&#39;/system/test&#39;</span>: Read-only file system
</code></pre></div></div>

<p>But we can however write to anything in our home directory, which ensures a clean separation of system and user data/configuration.</p>

<p><strong>NOTE :</strong> Due to its BeOS ancestry, Haiku is not currently a multi-user system so there is only one <code>/boot/home</code> directory and the user is effectively the sole administrator account. As I understand it, the scaffolding is present to support multiple users, but it won’t be a priority until after <a href="https://dev.haiku-os.org/milestone/R1" target="_blank">R1</a> is released. However, this opens up the later possibility for packages to be installed and configured on a per-user basis.</p>


<p>There’s a great overview of how all these components fit together in the <a href="https://www.haiku-os.org/docs/develop/packages/Infrastructure.html" target="_blank">developer documentation</a>, but here’s my lay-persons understanding of it…</p>

<p>Haiku has <a href="https://depot.haiku-os.org" target="_blank">many packages available</a>, ranging from system components, development libraries and end-user applications. There’s even recent ports of <a href="https://liliputing.com/run-some-windows-apps-on-haiku-operating-system-thanks-to-wine-port/" target="_blank">Wine</a>, <a href="https://depot.haiku-os.org/libreoffice" target="_blank">LibreOffice</a> and KDE Applications. These are available as <code>.hpkg</code> files which are placed in a special <code>packages</code> directory, and the <code>packagefs</code> service mounts the contents into e.g. the <code>/boot/system</code> mountpoint.</p>

<p>Unlike traditional package management tools, the contents of the package are <em>not</em> unarchived and copied into the filesystem; When you’re looking at <code>/boot/system</code>, you’re essentially looking at a collection of multiple packages and their contents, all dynamically mounted and made available on-the-fly as a read-only, virtual filesystem.</p>

<p>This is why <code>/boot/system</code> is read-only: It’s not a “real” filesystem and only exists as a virtual union of all the different packages that are activated at that point in time.</p>

<p><strong>NOTE :</strong> There are some exceptions to this, as some directories such as <code>packages</code>, <code>cache</code>, <code>var</code> etc. are writeable. There are called “shine-through directories” which reside on the underlying BFS volume. You can read more about these in the developer documentation. And while we’re geeking out, BeFS itself is definitely also worth <a href="https://arstechnica.com/information-technology/2018/07/the-beos-filesystem/" target="_blank">investigating</a>!</p>

<p>When packagefs detects a new <code>.hpkg</code> file has been copied to the <code>packages</code> directory, it performs some checks such as searching for dependencies or conflicts. If everything is OK it “activates” the package, and the contents are then available.</p>


<p>Here’s an example of installing a package using the CLI <code>pkgman</code> tool, showing what happens behind the scenes. First, let’s install an example package, in this case something simple like the awesome CLI <a href="http://www.ivarch.com/programs/pv.shtml" target="_blank">Pipe Viewer</a> tool. It’s very much like running <code>apt-get</code>, <code>yum</code> or other similar tools on a Linux system:</p>

<div><div><pre><code>~&gt; pkgman install pv
Validating checksum for Haiku...done.
100% repochecksum-1 [64 bytes]
Validating checksum for HaikuPorts...done.
The following changes will be made:
  in system:
    install package pv-1.6.6-2 from repository HaikuPorts
100% pv-1.6.6-2-x86_64.hpkg [40.57 KiB]
Validating checksum for https://eu.hpkg.haiku-os.org/haikuports/master/x86_64/current/packages/pv-1.6.6-2-x86_64.hpkg...done.
[system] Applying changes ...
[system] Changes applied. Old activation state backed up in &#34;state_2023-02-13_14:33:27&#34;
[system] Cleaning up ...
[system] Done.
</code></pre></div></div>

<p>If we now look at <code>/system/packages</code> we can see the downloaded <code>.hpkg</code> file (which can also be inspected with CLI or Desktop tools):</p>

<div><div><pre><code>~&gt; <span>ls</span> <span>-l</span> /system/packages/pv-1.6.6-2-x86_64.hpkg
<span>-rw-r--r--</span> 1 user root 41543 Feb 13 14:33 /system/packages/pv-1.6.6-2-x86_64.hpkg
</code></pre></div></div>

<p>Sure enough, the package daemon picked it up and mounted its contents so they are available through the merged packagefs under /boot/system. Here’s where the <code>pv</code> binary now appears installed:</p>

<div><div><pre><code>~&gt; <span>ls</span> <span>-l</span> /system/bin/pv
<span>-r-xr-xr-x</span> 1 user root 70136 Aug  6  2018 /system/bin/pv
</code></pre></div></div>

<p>Uninstalling is as simple as <code>pkgman uninstall pv</code> which removes the <code>.hpkg</code> file, and the contents then “disappear” from <code>/boot/system</code>.</p>


<p>What’s <em>really</em> nice about this, is that it enables a simple and elegant way of rolling-back your system state to a previous set of packages or even OS releases. If you check the last output from the <code>pkgman install pv</code> command above, you’ll see there’s a message saying that an “old activation state” is being backed up to a newly-created directory. The package manager does this at the start of every transaction, and if we check that directory we’ll see a simple plain-text file called <code>activated-packages</code>:</p>

<div><div><pre><code>~&gt; <span>head</span> <span>-n5</span> /system/packages/administrative/state_2023-02-13_14<span>\:</span>33<span>\:</span>27/activated-packages

netcat-1.10-4-x86_64.hpkg
ncurses6-6.3-2-x86_64.hpkg
mpfr3-3.1.6-6-x86_64.hpkg
mesa_swpipe-22.0.5-2-x86_64.hpkg
mesa_devel-22.0.5-2-x86_64.hpkg
</code></pre></div></div>

<p>This contains a record of the exact package versions that were installed at that time. If any packages were to be upgraded, then the <code>state</code> directory will also contain a set of packages to facilitate roll-back. Here’s what it looks like from the Haiku Desktop:</p>

<p><a href="https://www.markround.com/assets/images/haiku/state.png"><picture><source srcset="/assets/generated/haiku/state-200-b38704e03.webp 200w, /assets/generated/haiku/state-400-b38704e03.webp 400w, /assets/generated/haiku/state-800-b38704e03.webp 800w, /assets/generated/haiku/state-1600-b38704e03.webp 1600w" type="image/webp"/><source srcset="/assets/generated/haiku/state-200-9b5a1cb04.png 200w, /assets/generated/haiku/state-400-9b5a1cb04.png 400w, /assets/generated/haiku/state-800-9b5a1cb04.png 800w, /assets/generated/haiku/state-1600-9b5a1cb04.png 1600w" type="image/png"/><img src="https://www.markround.com/assets/generated/haiku/state-800-9b5a1cb04.png"/></picture></a></p>

<p>Along with a listing of old packages in a state directory, the currently installed packages are shown on the top left. You can see for example, that BASH in the current system is at 5.1 but in an old backup state from 2021 it was 5.0. You can also clean these old state directories up according to your needs - such as only keeping the last 30 days of state to preserve disk space.</p>

<p><a href="https://www.markround.com/assets/images/haiku/boot-loader.jpg"><picture><source srcset="/assets/generated/haiku/boot-loader-200-6fc7fd51c.webp 1.0x, /assets/generated/haiku/boot-loader-300.0-6fc7fd51c.webp 1.5x, /assets/generated/haiku/boot-loader-400-6fc7fd51c.webp 2.0x" type="image/webp"/><source srcset="/assets/generated/haiku/boot-loader-200-b00eafe97.jpg 1.0x, /assets/generated/haiku/boot-loader-300.0-b00eafe97.jpg 1.5x, /assets/generated/haiku/boot-loader-400-b00eafe97.jpg 2.0x" type="image/jpeg"/><img src="https://www.markround.com/assets/generated/haiku/boot-loader-250-b00eafe97.jpg"/></picture></a> 
Tying this all together, the <a href="https://www.haiku-os.org/docs/userguide/en/bootloader.html" target="_blank">Haiku Boot Loader</a> can make use of activation lists and saved packages to get back to any particular state very easily - all it has to do is pick a backup package activation file, and only activate the packages found in it when booting. You can select a backup state from the “Select Boot Volume” option in the boot loader and your system will boot back to the previous state using the archived packages and activation list. Your virtual <code>/boot/system</code> directory will then be reverted to the desired state - and this all happens on-the-fly at boot time; there is no long roll-back process or destructive operations and you can reboot into different states at will.</p>


<p>So far, I’ve just been talking about the packagefs mountpoint at <code>/boot/system</code>, but there’s also another mountpoint shown in my first <code>df -h</code> command which lives under <code>/boot/home/config</code>. Here’s what exists under that directory:</p>

<div><div><pre><code>~/config&gt; tree <span>-d</span> /boot/home/config <span>-L</span> 1
/boot/home/config
├── apps
├── cache
├── data
├── non-packaged
├── packages
├── settings
└── var
</code></pre></div></div>

<p>This is more-or-less a copy of the system directories, but they are specific to my user account. This means I can use this location to install software and test new packages out without “polluting” the system directories. And when Haiku gets full multi-user support this also means each user can have their own distinct set of packages available.</p>

<p>A couple of points of interest as an aside:</p>

<ul>
  <li>
    <p>For non-native software packages (e.g. something installed with <code>./configure &amp;&amp; make install</code>) you can use <code>~/config/non-packaged</code>. This is somewhat similar to <code>/usr/local</code> on Unix systems.</p>
  </li>
  <li>
    <p>The <code>settings</code> directory is where Haiku-packaged software keeps local configuration. To use an analogy again, it’s sort of like <code>$XDG_CONFIG_HOME</code> on other Unix-like systems. Haiku software tends to make use of this directory: For example, instead of SSH keeping configuration under <code>~/.ssh</code>, it’s now stored under a directory in <code>~/config/settings</code>:</p>
  </li>
</ul>

<div><div><pre><code>~/config&gt; <span>ls</span> <span>-l</span> settings/ssh/
total 32
<span>-rw-------</span> 1 user root 1238 Mar 31  2021 authorized_keys
<span>-rw-------</span> 1 user root  476 Mar 31  2021 config
<span>-rw-------</span> 1 user root 1679 Mar 31  2021 id_rsa
<span>-rw-------</span> 1 user root  410 Mar 31  2021 id_rsa.pub
<span>-rw-------</span> 1 user root 1790 Dec 18  2021 known_hosts
</code></pre></div></div>


<p>I’ll finish off by showing an example of building a user package and installing it using <a href="https://github.com/haikuports/haikuporter" target="_blank">Haikuporter</a> and the community <a href="https://github.com/haikuports/haikuports" target="_blank">HaikuPorts</a> collection. These tools can be used to build and customise a massive amount of software for Haiku ranging from old BeOS tools to a complete LibreOffice installation.</p>

<p><strong>NOTE :</strong> Think of building HaikuPorts from source like the FreeBSD “ports” collection. All the HaikuPorts packages are available through their repository as binaries through <code>pkgman</code> or the HaikuDepot graphical desktop application. As an end-user, you typically do not need to use Haikuporter unless you want to customise a package, create a new one, or submit patches/bug-fixes. I’m just using it as an example and because it’s cool!</p>

<p>After setting up Haiku Ports and Haikuporter by following the <a href="https://github.com/haikuports/haikuports/wiki/" target="_blank">instructions</a>, I can now build a package from source. I’ll use the GUI FTP client “FTP Positive” as an example:</p>

<div><div><pre><code>~/haikuports/haiku-apps&gt; alias hp=&#34;haikuporter -S -j8 --no-source-packages --get-dependencies&#34;
~/haikuports/haiku-apps&gt; hp ftppositive

Checking if any dependency-infos need to be updated ...
Looking for stale dependency-infos ...
----------------------------------------------------------------------
haiku-apps::ftppositive-1.2.2
        /boot/home/haikuports/haiku-apps/ftppositive/ftppositive-1.2.2.recipe
----------------------------------------------------------------------
Skipping download of source for 48a5acdfe0981697018abf151a82802f4f3e500e.tar.gz
Validating checksum of 48a5acdfe0981697018abf151a82802f4f3e500e.tar.gz
Unpacking source of 48a5acdfe0981697018abf151a82802f4f3e500e.tar.gz
...
... Build output truncated
...
mimesetting files for package ftppositive-1.2.2-7-x86_64.hpkg ...
creating package ftppositive-1.2.2-7-x86_64.hpkg ...
----- Package Info ----------------
header size:                     80
heap size:                   211523
TOC size:                      1110
package attributes size:        695
total size:                  211603
-----------------------------------
waiting for build package ftppositive-1.2.2-7 to be deactivated
grabbing ftppositive-1.2.2-7-x86_64.hpkg and moving it to /boot/home/haikuports/packages/ftppositive-1.2.2-7-x86_64.hpkg
</code></pre></div></div>

<p>The last lines of output show me that a <code>.hpkg</code> file has been created. I can then simply copy the package to my local <code>~/config/packages</code> directory to “activate” it. Once again, packagefs will check it and then add the contents to the <code>/boot/home/config</code> directory. Here’s what it looks like on the Haiku desktop:</p>

<p><a href="https://www.markround.com/assets/images/haiku/package-install.png"><picture><source srcset="/assets/generated/haiku/package-install-200-4581206f9.webp 200w, /assets/generated/haiku/package-install-400-4581206f9.webp 400w, /assets/generated/haiku/package-install-800-4581206f9.webp 800w, /assets/generated/haiku/package-install-1428-4581206f9.webp 1428w" type="image/webp"/><source srcset="/assets/generated/haiku/package-install-200-049025c7a.png 200w, /assets/generated/haiku/package-install-400-049025c7a.png 400w, /assets/generated/haiku/package-install-800-049025c7a.png 800w, /assets/generated/haiku/package-install-1428-049025c7a.png 1428w" type="image/png"/><img src="https://www.markround.com/assets/generated/haiku/package-install-800-049025c7a.png"/></picture></a></p>

<p>Note the top two windows “stuck” together using the built-in <a href="https://www.haiku-os.org/docs/userguide/en/GUI.html" target="_blank">stacking and tiling</a> window manager!</p>

<p>You can see the package has been activated after copying it into the user’s packages directory. It’s installed the application to <code>/boot/home/config/apps/FtpPositive/</code> instead of the system directories and has added a <a href="https://www.haiku-os.org/docs/userguide/en/deskbar.html" target="_blank">DeskBar</a> menu entry which has also been picked up and “merged” into the global system Applications menu - where it appears alongside all the system-installed packages.</p>



<p>Like the rest of Haiku, package management is a refreshingly different and well thought-out experience. Given how niche an OS it is, it still surprises me how polished the system is - I have it running natively on an old Lenovo ThinkStation SFF PC and it absolutely flies. Apart from my <a href="https://www.markround.com/amiga/">Amigas</a> it’s easily my favourite “hacking on code in the evening” system and for many tasks is perfectly capable of being a daily-driver.</p>

<p>There’s a fascinating world of alternative OSes out there, many of them following entirely different paradigms than the current mainstream world of Windows/Mac/Linux. I’ve had the good fortune to be exposed to these different ways of thinking all the way back to my school days in the UK, where <a href="https://en.wikipedia.org/wiki/Acorn_Archimedes" target="_blank">RISC OS</a> was commonplace in the classroom and Amigas and Ataris ruled the playground.</p>

<p>From this once-rich polyculture of competing processor architectures and platforms, the world seemingly consolidated itself around an x86 or ARM processor running something based on Windows or Unix. Which gets the job done, but it’s y’know… a little boring. There are so many interesting - and some downright <em>crazy</em> - ideas that either failed in the commercial marketplace, were never given a proper chance (yeah, I’m still salty about Commodore killing the Amiga) or only found a hobbyist following.</p>

<p>But here’s the thing: Just because they never got wide adoption doesn’t mean they were <em>wrong</em>. I think it’s great that people are exploring new ideas, continuing the lineage of legacy systems, and simply creating stuff because they <a href="https://serenityos.org" target="_blank">damn well feel like it</a> and it’s fun! There’s lots of really interesting code out there and it makes you wonder what an alternate time-line would look like where Apple did use BeOS as <a href="https://www.wired.com/2015/05/os-almost-made-apple-entirely-different-company/" target="_blank">the basis</a> for their next operating system. What if VMS had “won” over UNIX? What if Commodore had known what to do with the Amiga ?</p>

<p>Anyway, I hope this has whetted your appetite for all things Alt-OS, and Haiku in particular. If you haven’t yet tried it, there’s detailed <a href="https://www.haiku-os.org/get-haiku/installation-guide/" target="_blank">instructions</a> on their website, and I highly recommend taking it for a spin.</p>

<p>Happy Hacking!</p>

        
      </section></div>
  </body>
</html>
