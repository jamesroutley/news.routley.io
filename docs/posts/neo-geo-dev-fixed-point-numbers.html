<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mattgreer.dev/blog/neo-geo-dev-fixed-point/">Original</a>
    <h1>Neo Geo Dev: Fixed Point Numbers</h1>
    
    <div id="readability-page-1" class="page"><p>Let&#39;s take a look at how to work with decimal numbers on an ancient cpu.</p><div><p>Modern computers work with decimals, like <code>0.5</code>, using a system called <a tabindex="0" href="https://en.wikipedia.org/wiki/Floating-point_arithmetic">floating point</a>. If you remember scientific notation from your science classes, it&#39;s based on the same idea. These types of numbers are handled by the cpu in modern computers, and so programs can calculate with them very quickly. The Neo Geo can not work with decimals at all. It only knows how to calculate integers, like <code>1+3</code>, <code>88*4</code>, or <code>-45 / 5</code>. If you want to do <code>8 * 0.5</code> on the Neo Geo, you just can&#39;t. But for games, you almost always need decimal numbers, so what to do?</p><p>Thankfully there is a way to get them on something as old as the Neo Geo, using a number system called fixed point.</p><h2 id="floating-point">Floating Point<a aria-hidden="true" href="#floating-point"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2><p>Floating point numbers are decimal numbers where the decimal itself can be in any position. This allows computers to work with small decimal numbers like <code>3.00000000001</code> or big numbers like <code>12345678.2</code>, by moving the decimal point around, the decimal system is much more flexible. This article won&#39;t go into the details of how floating point works. But just know that when writing a program nowadays, you typically just use decimal numbers and hardly think much about them, as they just work.</p><p>Floating point is complicated, so it&#39;s pretty slow. Modern computers deal with this by doing floating point calculations in hardware instead of software. Old systems like the Neo Geo &#34;dealt&#34; with this by not supporting it at all :)</p><h2 id="fixed-point">Fixed Point<a aria-hidden="true" href="#fixed-point"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2><p>In a fixed point system, the decimal point is locked in place. For example one system might use six decimal digits and 10 integer digits, like <code>1234567890.450012</code></p><div><p>Computers actually work in binary, so the system would really be like</p><!-- --><p> 1101001001.011011</p></div><p>The advantage to this is being very simple and very fast. Behind the scenes the fixed point number is actually stored in an integer. The CPU itself has no idea it is working with fixed point, it just sees integers and can do arithmetic on them just like any other number it encounters.</p><p>This is not entirely true, as we will see below. Multiplication and division are a tad more complicated.</p><p>The disadvantage is precision and flexibility. If you need really precise decimal numbers, you might choose your fixed point system to have 4 integer digits and 12 decimal. But that means the maximum integer in that system is only 7! If you go the opposite direction, 12 integer and 4 decimal, your maximum integer is 2047. Which gives you more breathing room, but then you&#39;re unable to form precise decimal numbers.</p><figure><img src="https://swe-to-mle.pages.dev/_next/static/media/fixedPointDiagram.56e8bfa6.svg" alt="Where you place the decimal point is a trade-off"/><figcaption>Where you place the decimal point is a trade-off</figcaption></figure><p>Where you place it just depends on what your needs are. For my game, I&#39;ve opted for a system that creates pretty precise decimal numbers at the cost of smallish integers. Usually that is ok. Typically you&#39;re calculating where on the screen something will be, and since the Neo Geo&#39;s resolution is only 320x224, having smaller integers is often just fine.</p><h2 id="but-why-do-you-need-fixed-point">But why do you need fixed point?<a aria-hidden="true" href="#but-why-do-you-need-fixed-point"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2><p>This is a fair question. At the end of the day, it&#39;s all about placing sprites on the screen. You can&#39;t place a sprite at <code>(32.84, 44.9442)</code>, so what&#39;s the point?</p><p>Pretend you have a character that can walk across the screen, like Blue here</p><figure><img src="https://swe-to-mle.pages.dev/_next/static/media/bjourney.079c60bf.png" alt="Blue walking across the screen"/><figcaption>Blue walking across the screen</figcaption></figure><p>A simple way to do that is to decide Blue moves 1 pixel every frame. So the code might be something like this</p><p><code><p><span>if</span><span> <wbr/></span><span>(</span><span>pressingRight</span><span>)</span><span> <wbr/></span><span>{</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>blue</span><span>.</span><span>x <wbr/></span><span>+=</span><span> <wbr/></span><span>1</span><span>;</span><span></span></p><p><span></span><span>}</span><span></span></p><p><span></span><span>graphics_moveSprite</span><span>(</span><span>blue</span><span>.</span><span>spriteIndex</span><span>,</span><span> <wbr/>blue</span><span>.</span><span>x</span><span>,</span><span> <wbr/>blue</span><span>.</span><span>y</span><span>)</span><span>;</span><span></span></p></code></p><p>This is not real Blue&#39;s Journey code :) I&#39;m just using it for a simple example</p><p>That&#39;s fine, <code>1</code> pixel per frame means he moves 60 pixels every second. He&#39;d cross the screen in about 5 seconds. Ok what if we want him to move faster? <code>2</code> pixels per frame? He&#39;d cross the screen in about 2.5 seconds. What if that is too fast? There isn&#39;t much that can be done to deal with that. It&#39;s either too slow at <code>1</code> pixel, or too fast at <code>2</code> pixels. You can try fancy things like only moving him 2 out of every 3 frames. But that gets complex quick, and not to mention you&#39;re game isn&#39;t really 60fps anymore if you do that.</p><p>With fixed point, we could say that Blue moves at <code>1.2</code> pixels per frame, or just about any fractional value we want (within reason). We can decide exactly how fast Blue moves, move him every frame, and it will all just work, nice and simple.</p><p>With our fixed point system, Blue might be at 32.2 pixels one frame, then 32.8 pixels the next. Since sprites have to be placed on the screen using integers, that might mean visually Blue is at 32 pixels for two frames, then 33 pixels on the third frame. Not ideal, but also nothing we can really do about it. That&#39;s just the reality on these old low resolution systems.</p><div><p>If you have ever heard Super Mario Bros. players talking about &#34;sub pixels&#34;, this is exactly what they are referring to. The </p><!-- --><p>.2</p><!-- --><p> and</p><!-- --> <!-- --><p>.8</p><!-- --><p> are Blue&#39;s subpixels in this example.</p></div><p>Thankfully that is only a visual limitation. The logic of your game remains precise, so your controls and the &#34;feel&#34; of the game remains snappy.</p><h2 id="making-a-fixed-point-system">Making a fixed point system<a aria-hidden="true" href="#making-a-fixed-point-system"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2><p>A fixed point system is pretty simple to build. First, decide which size of integer to use for fixed point. The Neo Geo can work with up to 32 bits pretty well. If you are using <a tabindex="0" href="https://github.com/dciabrin/ngdevkit">ngdevkit</a>, that is <code>s32</code>. That&#39;s what I&#39;m using in my game and it is working well.</p><p>Then decide how many of those bits will be for the decimal portion, something like this:</p><p><code><p><span>typedef</span><span> <wbr/>s32 <wbr/>fixed</span><span>;</span><span></span></p><p><span></span><span>#</span><span>define</span><span> <wbr/></span><span>DECIMAL_BITS</span><span> <wbr/></span><span>5</span><span></span></p></code></p><p>32 bits on the Neo Geo&#39;s 68k processor is a trade-off in itself. It has 32 bit registers so once the number is loaded into the cpu, it can work with it just fine. But to pull a number in from memory, it needs to do it in two steps as it can only access memory 16 bits at a time. But I have found 16 bit fixed point is just not adequate, and in practice 32 bit numbers are still quite fast.</p><p>Then we need some simple macros to convert to and from our fixed point numbers</p><p><code><p><span>#define <wbr/></span><span>SCALE</span><span> <wbr/></span><span>(</span><span>1</span><span> <wbr/></span><span>&lt;&lt;</span><span> <wbr/></span><span>DECIMAL_BITS</span><span>)</span><span></span></p><p><span>#define <wbr/></span><span>TO_FIXED</span><span>(</span><span>a</span><span>)</span><span> <wbr/></span><span>(</span><span>(</span><span>a</span><span>)</span><span> <wbr/></span><span>*</span><span> <wbr/></span><span>SCALE</span><span>)</span><span></span></p><p><span>#define <wbr/></span><span>FROM_FIXED</span><span>(</span><span>a</span><span>)</span><span> <wbr/></span><span>(</span><span>(</span><span>a</span><span>)</span><span> <wbr/></span><span>/</span><span> <wbr/></span><span>SCALE</span><span>)</span><span></span></p></code></p><p>And yeah, all we are really doing is moving our numbers up higher in the 32 bit space. That&#39;s pretty much all it takes to simulate decimals.</p><p>Now with those in place, addition and subtraction are simple to do</p><p><code><p><span>s16 <wbr/>a <wbr/></span><span>=</span><span> <wbr/></span><span>5</span><span>;</span><span></span></p><p><span>s16 <wbr/>b <wbr/></span><span>=</span><span> <wbr/></span><span>6</span><span>;</span><span></span></p><p><span>fixed <wbr/>fa <wbr/></span><span>=</span><span> <wbr/></span><span>TO_FIXED</span><span>(</span><span>a</span><span>)</span><span>;</span><span></span></p><p><span>fixed <wbr/>fb <wbr/></span><span>=</span><span> <wbr/></span><span>TO_FIXED</span><span>(</span><span>b</span><span>)</span><span>;</span><span></span></p><p><span>fixed <wbr/>fc <wbr/></span><span>=</span><span> <wbr/>fa <wbr/></span><span>+</span><span> <wbr/>fb</span><span>;</span><span></span></p><p><span>fixed <wbr/>fc <wbr/></span><span>=</span><span> <wbr/>fa <wbr/></span><span>-</span><span> <wbr/>fb</span><span>;</span><span></span></p><p><span>s16 <wbr/>c <wbr/></span><span>=</span><span> <wbr/></span><span>FROM_FIXED</span><span>(</span><span>fc</span><span>)</span><span>;</span><span></span></p></code></p><p>In my game, I almost always store something&#39;s <code>x</code> and <code>y</code> values for its location on screen as <code>fixed</code>, then right before I need to update its sprite, I will convert it back to integers.</p><p><code><p><span>struct</span><span> <wbr/></span><span>Bullet</span><span> <wbr/></span><span>{</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>fixed <wbr/>xF</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>fixed <wbr/>yF</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>u16 <wbr/>spriteIndex</span><span>;</span><span></span></p><p><span></span><span>}</span><span>;</span><span></span></p><p><span></span><span>struct</span><span> <wbr/></span><span>Bullet</span><span> <wbr/>b</span><span>;</span><span></span></p><p><span>b</span><span>.</span><span>xF <wbr/></span><span>=</span><span> <wbr/></span><span>&lt;&lt;</span><span>SOME <wbr/>FIXED <wbr/>CALCULATION</span><span>&gt;&gt;</span><span></span></p><p><span>b</span><span>.</span><span>yF <wbr/></span><span>=</span><span> <wbr/></span><span>&lt;&lt;</span><span>SOME <wbr/>FIXED <wbr/>CALCULATION</span><span>&gt;&gt;</span><span></span></p><p><span></span><span>graphics_moveSprite</span><span>(</span><span>b</span><span>.</span><span>spriteIndex</span><span>,</span><span> <wbr/></span><span>FROM_FIXED</span><span>(</span><span>b</span><span>.</span><span>xF</span><span>)</span><span>,</span><span> <wbr/></span><span>FROM_FIXED</span><span>(</span><span>b</span><span>.</span><span>yF</span><span>)</span><span>)</span><span>;</span><span></span></p></code></p><p>That code is very simplified, but you get the idea.</p><h3 id="multiplication">Multiplication<a aria-hidden="true" href="#multiplication"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3><p>Now things get a tad more complex. When multiplying two fixed numbers together, the &#34;decimal point&#39;s location&#34; will move. Basically each fixed number has <code>SCALE</code> applied to it, so after a multiplication, the result with have <code>SCALE*SCALE</code> applied to it, so a division is needed to bring the result back down to a single <code>SCALE</code>.</p><p><code><p><span>fixed <wbr/></span><span>fixed_multiply</span><span>(</span><span>fixed <wbr/>a</span><span>,</span><span> <wbr/>fixed <wbr/>b</span><span>)</span><span> <wbr/></span><span>{</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>fixed <wbr/>temp <wbr/></span><span>=</span><span> <wbr/>a <wbr/></span><span>*</span><span> <wbr/>b</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>fixed <wbr/>result <wbr/></span><span>=</span><span> <wbr/>temp <wbr/></span><span>/</span><span> <wbr/>SCALE</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>return</span><span> <wbr/>result</span><span>;</span><span></span></p><p><span></span><span>}</span><span></span></p></code></p><p><b>Hey!</b> don&#39;t use the code from this blog post directly. I have simplified it as this post is just about the basics of fixed point. Most notably, multiplication and division should both round their results. See the conclusion section below.</p><p>And to use it, just call <code>fixed_multiply</code> instead of using <code>*</code> directly</p><p><code><p><span>fixed <wbr/>fa <wbr/></span><span>=</span><span> <wbr/></span><span>TO_FIXED</span><span>(</span><span>5</span><span>)</span><span>;</span><span></span></p><p><span>fixed <wbr/>fb <wbr/></span><span>=</span><span> <wbr/></span><span>TO_FIXED</span><span>(</span><span>8</span><span>)</span><span>;</span><span></span></p><p><span>fixed <wbr/>fc <wbr/></span><span>=</span><span> <wbr/></span><span>fixed_multiply</span><span>(</span><span>fa</span><span>,</span><span> <wbr/>fb</span><span>)</span><span>;</span><span></span></p></code></p><p>You only need to use <code>fixed_multiply</code> when both numbers are in the fixed system. Just need to double a fixed number? This will work</p><p><code><p><span>fixed <wbr/>fa <wbr/></span><span>=</span><span> <wbr/></span><span>TO_FIXED</span><span>(</span><span>5</span><span>)</span><span>;</span><span></span></p><p><span>fixed <wbr/>doubledFa <wbr/></span><span>=</span><span> <wbr/>fa <wbr/></span><span>*</span><span> <wbr/></span><span>2</span><span>;</span><span></span></p></code></p><p>It will be a little bit faster, but mixing <code>*</code> and <code>fixed_multiply</code> incorrectly will lead to bugs, so if not sure or worried, just stick with <code>fixed_multiply</code></p><p><code><p><span>fixed <wbr/>fa <wbr/></span><span>=</span><span> <wbr/></span><span>TO_FIXED</span><span>(</span><span>5</span><span>)</span><span>;</span><span></span></p><p><span>fixed <wbr/>doubledFa <wbr/></span><span>=</span><span> <wbr/></span><span>fixed_multiply</span><span>(</span><span>fa</span><span>,</span><span> <wbr/></span><span>TO_FIXED</span><span>(</span><span>2</span><span>)</span><span>)</span><span>;</span><span></span></p></code></p><h3 id="multiplication-overflow">Multiplication Overflow<a aria-hidden="true" href="#multiplication-overflow"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3><p>Multiplying two 32 bit numbers together and storing the result in a 32 bit number can cause overflow. take two very big numbers. When multiplied together, the result will be gigantic. Too big to fit into 32 bits, so some of it will get thrown away, causing the result to be incorrect. The common way to avoid this problem is to make <code>temp</code> be 64 bits.</p><p>But that is a problem on the Neo Geo, it has no 64 bit numbers!</p><p>64 bit numbers can be simulated by the compiler. But since the 68k processor has 32 bit registers, the cpu really needs to jump through a lot of hoops to work with 64 bit numbers. This can be extremely slow.</p><p>The way I handle this is to assert the result hasn&#39;t overflown</p><p><code><p><span>fixed <wbr/></span><span>fixed_multiply</span><span>(</span><span>fixed <wbr/>a</span><span>,</span><span> <wbr/>fixed <wbr/>b</span><span>)</span><span> <wbr/></span><span>{</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>fixed <wbr/>temp <wbr/></span><span>=</span><span> <wbr/>a <wbr/></span><span>*</span><span> <wbr/>b</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>ngassert</span><span>(</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/>a <wbr/></span><span>==</span><span> <wbr/></span><span>0</span><span> <wbr/></span><span>||</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/>b <wbr/></span><span>==</span><span> <wbr/></span><span>0</span><span> <wbr/></span><span>||</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/></span><span>abs</span><span>(</span><span>temp</span><span>)</span><span> <wbr/></span><span>&gt;=</span><span> <wbr/></span><span>abs</span><span>(</span><span>a</span><span>)</span><span>,</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/></span><span>&#34;fixed_multiply <wbr/>overflow, <wbr/>a: <wbr/>%d, <wbr/>b: <wbr/>%d, <wbr/>temp: <wbr/>%d&#34;</span><span>,</span><span> <wbr/>a</span><span>,</span><span> <wbr/>b</span><span>,</span><span> <wbr/>temp</span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>fixed <wbr/>result <wbr/></span><span>=</span><span> <wbr/>temp <wbr/></span><span>/</span><span> <wbr/>SCALE</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>return</span><span> <wbr/>result</span><span>;</span><span></span></p><p><span></span><span>}</span><span></span></p></code></p><p>If after multiplying is finished, if <code>temp</code> is smaller than <code>a</code>, that is a sign the result was too big. This is not ideal, because if you have multiplication overflow there isn&#39;t anything you can do except change your game to avoid it. But this is way better than just allowing the error to happen and having a broken game.</p><div><p>ngassert()</p><!-- --><p> is something I built myself. I explain how in my</p><!-- --> <p><a tabindex="0" href="https://mattgreer.dev/blog/mame-lua-for-better-retro-dev/#primitive-assertions">MAME Lua for Better Retro Dev</a></p><!-- --><p>post.</p></div><h3 id="division">Division<a aria-hidden="true" href="#division"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3><p>Similarly, division needs to be a function too</p><p><code><p><span> <wbr/>fixed <wbr/></span><span>fixed_divide</span><span>(</span><span>fixed <wbr/>a</span><span>,</span><span> <wbr/>fixed <wbr/>b</span><span>)</span><span> <wbr/></span><span>{</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>fixed <wbr/>temp <wbr/></span><span>=</span><span> <wbr/>a <wbr/></span><span>*</span><span> <wbr/>SCALE</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>ngassert</span><span>(</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/>a <wbr/></span><span>==</span><span> <wbr/></span><span>0</span><span> <wbr/></span><span>||</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/></span><span>abs</span><span>(</span><span>temp</span><span>)</span><span> <wbr/></span><span>&gt;=</span><span> <wbr/></span><span>abs</span><span>(</span><span>a</span><span>)</span><span>,</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/></span><span>&#34;fixed_divide <wbr/>overflow&#34;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>return</span><span> <wbr/>temp <wbr/></span><span>/</span><span> <wbr/>b</span><span>;</span><span></span></p><p><span></span><span>}</span><span></span></p></code></p><p>Division deals with <code>SCALE</code> in the opposite way as multiplication. Here the result will have <code>SCALE</code> removed from it, so first we <code>SCALE</code> up the input a second time. After division, the result is back to the correct scale.</p><p>Just like in <code>fixed_multiply</code>, there might not be enough room to scale up a, so we again check for that with <code>ngassert()</code>.</p><p>Also dividing by a large number (say <code>1 / 1000000000</code>) can result in <code>0</code> if there isn&#39;t enough decimal precision. I should probably assert on that too...</p><h2 id="fixed-literals">Fixed literals<a aria-hidden="true" href="#fixed-literals"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2><p>You may have noticed I&#39;ve never done <code>fixed fa = TO_FIXED(5.5)</code>, as that isn&#39;t possible. The way to do that is unfortunately</p><p><code><p><span>fixed <wbr/>fa <wbr/></span><span>=</span><span> <wbr/></span><span>TO_FIXED</span><span>(</span><span>5</span><span>)</span><span> <wbr/></span><span>+</span><span> <wbr/></span><span>fixed_divide</span><span>(</span><span>TO_FIXED</span><span>(</span><span>1</span><span>)</span><span>,</span><span> <wbr/></span><span>TO_FIXED</span><span>(</span><span>2</span><span>)</span><span>)</span><span>;</span><span></span></p></code></p><p>This is hard to read, but also <code>fixed_divide</code> is a function, not a macro, so this initialization will happen at runtime instead of compile time. To work around this, I have a &#34;fixedConstants.h&#34; in my game, which makes this a little more simple</p><p><code><p><span>#include <wbr/>&#34;fixedConstants.h&#34;</span></p><p><span>fixed <wbr/>fa <wbr/>= <wbr/>TO_FIXED(5) <wbr/>+ <wbr/>FIXED_ONE_HALF;</span></p></code></p><p>Easier to read, and all resolved by the compiler instead of the cpu. I wrote a little node script to generate fixedConstants.h</p><p><code><p><span>import</span><span> <wbr/>path <wbr/></span><span>from</span><span> <wbr/></span><span>&#39;node:path&#39;</span><span>;</span><span></span></p><p><span></span><span>import</span><span> <wbr/>fsp <wbr/></span><span>from</span><span> <wbr/></span><span>&#39;node:fs/promises&#39;</span><span>;</span><span></span></p><p><span></span><span>const</span><span> <wbr/>decimalBits <wbr/></span><span>=</span><span> <wbr/></span><span>6</span><span>;</span><span></span></p><p><span></span><span>const</span><span> <wbr/>scale <wbr/></span><span>=</span><span> <wbr/></span><span>1</span><span> <wbr/></span><span>&lt;&lt;</span><span> <wbr/>decimalBits</span><span>;</span><span></span></p><p><span></span><span>function</span><span> <wbr/></span><span>toFixed</span><span>(</span><span>a</span><span>:</span><span> <wbr/></span><span>number</span><span>)</span><span> <wbr/></span><span>{</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>return</span><span> <wbr/>Math</span><span>.</span><span>floor</span><span>(</span><span>a <wbr/></span><span>*</span><span> <wbr/>scale</span><span>)</span><span>;</span><span></span></p><p><span></span><span>}</span><span></span></p><p><span></span><span>async</span><span> <wbr/></span><span>function</span><span> <wbr/></span><span>main</span><span>(</span><span>outputDir</span><span>:</span><span> <wbr/></span><span>string</span><span>)</span><span>:</span><span> <wbr/></span><span>Promise</span><span>&lt;</span><span>void</span><span>&gt;</span><span> <wbr/></span><span>{</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>const</span><span> <wbr/>rawDefines</span><span>:</span><span> <wbr/></span><span>string</span><span>[</span><span>]</span><span> <wbr/></span><span>=</span><span> <wbr/></span><span>[</span><span>]</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>rawDefines</span><span>.</span><span>push</span><span>(</span><span>`</span><span>ONE_HALF <wbr/></span><span>${</span><span>toFixed</span><span>(</span><span>1</span><span> <wbr/></span><span>/</span><span> <wbr/></span><span>2</span><span>)</span><span>}</span><span>`</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>rawDefines</span><span>.</span><span>push</span><span>(</span><span>`</span><span>ONE_THIRD <wbr/></span><span>${</span><span>toFixed</span><span>(</span><span>1</span><span> <wbr/></span><span>/</span><span> <wbr/></span><span>3</span><span>)</span><span>}</span><span>`</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>rawDefines</span><span>.</span><span>push</span><span>(</span><span>`</span><span>ONE_FOURTH <wbr/></span><span>${</span><span>toFixed</span><span>(</span><span>1</span><span> <wbr/></span><span>/</span><span> <wbr/></span><span>4</span><span>)</span><span>}</span><span>`</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>rawDefines</span><span>.</span><span>push</span><span>(</span><span>`</span><span>ONE_FIFTH <wbr/></span><span>${</span><span>toFixed</span><span>(</span><span>1</span><span> <wbr/></span><span>/</span><span> <wbr/></span><span>5</span><span>)</span><span>}</span><span>`</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>rawDefines</span><span>.</span><span>push</span><span>(</span><span>`</span><span>ONE_SIXTH <wbr/></span><span>${</span><span>toFixed</span><span>(</span><span>1</span><span> <wbr/></span><span>/</span><span> <wbr/></span><span>6</span><span>)</span><span>}</span><span>`</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>rawDefines</span><span>.</span><span>push</span><span>(</span><span>`</span><span>ONE_TENTH <wbr/></span><span>${</span><span>toFixed</span><span>(</span><span>1</span><span> <wbr/></span><span>/</span><span> <wbr/></span><span>10</span><span>)</span><span>}</span><span>`</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>rawDefines</span><span>.</span><span>push</span><span>(</span><span>`</span><span>ONE_TWENTIETH <wbr/></span><span>${</span><span>toFixed</span><span>(</span><span>1</span><span> <wbr/></span><span>/</span><span> <wbr/></span><span>20</span><span>)</span><span>}</span><span>`</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>rawDefines</span><span>.</span><span>push</span><span>(</span><span>`</span><span>THREE_FOURTHS <wbr/></span><span>${</span><span>toFixed</span><span>(</span><span>3</span><span> <wbr/></span><span>/</span><span> <wbr/></span><span>4</span><span>)</span><span>}</span><span>`</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>rawDefines</span><span>.</span><span>push</span><span>(</span><span>`</span><span>TWO_THIRDS <wbr/></span><span>${</span><span>toFixed</span><span>(</span><span>2</span><span> <wbr/></span><span>/</span><span> <wbr/></span><span>3</span><span>)</span><span>}</span><span>`</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>const</span><span> <wbr/>defines <wbr/></span><span>=</span><span> <wbr/>rawDefines</span><span>.</span><span>map</span><span>(</span><span>(</span><span>rd</span><span>)</span><span> <wbr/></span><span>=&gt;</span><span> <wbr/></span><span>{</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/></span><span>return</span><span> <wbr/></span><span>`</span><span>#define <wbr/>FIXED_</span><span>${</span><span>rd</span><span>}</span><span>`</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>}</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>const</span><span> <wbr/>src <wbr/></span><span>=</span><span> <wbr/></span><span>`</span><span>#pragma <wbr/>once</span></p><p><span></span><span>${</span><span>defines</span><span>.</span><span>join</span><span>(</span><span>&#39;\n&#39;</span><span>)</span><span>}</span><span></span></p><p><span></span><span>`</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>const</span><span> <wbr/>definesOutputPath <wbr/></span><span>=</span><span> <wbr/>path</span><span>.</span><span>resolve</span><span>(</span><span>outputDir</span><span>,</span><span> <wbr/></span><span>&#39;fixedConstants.h&#39;</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>await</span><span> <wbr/>fsp</span><span>.</span><span>writeFile</span><span>(</span><span>definesOutputPath</span><span>,</span><span> <wbr/>src</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>console</span><span>.</span><span>log</span><span>(</span><span>&#39;wrote&#39;</span><span>,</span><span> <wbr/>definesOutputPath</span><span>)</span><span>;</span><span></span></p><p><span></span><span>}</span><span></span></p><p><span></span><span>const</span><span> <wbr/></span><span>[</span><span>_node</span><span>,</span><span> <wbr/>_buildFixedConstants</span><span>,</span><span> <wbr/>outputDir</span><span>]</span><span> <wbr/></span><span>=</span><span> <wbr/>process</span><span>.</span><span>argv</span><span>;</span><span></span></p><p><span></span><span>if</span><span> <wbr/></span><span>(</span><span>!</span><span>outputDir</span><span>)</span><span> <wbr/></span><span>{</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>console</span><span>.</span><span>error</span><span>(</span><span>&#39;usage: <wbr/>ts-node <wbr/>buildFixedConstants <wbr/><output-dir>&#39;</output-dir></span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>process</span><span>.</span><span>exit</span><span>(</span><span>1</span><span>)</span><span>;</span><span></span></p><p><span></span><span>}</span><span></span></p><p><span></span><span>main</span><span>(</span><span>path</span><span>.</span><span>resolve</span><span>(</span><span>outputDir</span><span>)</span><span>)</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>.</span><span>then</span><span>(</span><span>(</span><span>)</span><span> <wbr/></span><span>=&gt;</span><span> <wbr/></span><span>console</span><span>.</span><span>log</span><span>(</span><span>&#39;done&#39;</span><span>)</span><span>)</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>.</span><span>catch</span><span>(</span><span>(</span><span>e</span><span>)</span><span> <wbr/></span><span>=&gt;</span><span> <wbr/></span><span>console</span><span>.</span><span>error</span><span>(</span><span>e</span><span>)</span><span>)</span><span>;</span><span></span></p></code></p><h2 id="changing-the-precision">Changing the precision<a aria-hidden="true" href="#changing-the-precision"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2><p>As I worked on my game, I realized I needed to change how many bits I used for decimal and integer in my fixed point system. Just today I found I didn&#39;t have enough decimal bits and couldn&#39;t create the small fractions I needed (which inspired me to write this post).</p><p>To deal with this, I have actually defined the number of decimal bits as an environment variable. My C code, makefile, and scripts all feed off of that environment variable. So if I need to change the precision, I just need to update the variable, regenerate things like fixedConstants.h, and then do a full recompile. This is way better than hunting down every place that deals with decimal bits.</p><p>A lot of people don&#39;t like placing key information like this in environment variables. But since I&#39;m the only one working on this codebase, it works for me. You do you :)</p><p>So for example, in the script above, it&#39;s actually doing this in my real version</p><p><code><p><span>if</span><span> <wbr/></span><span>(</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>process</span><span>.</span><span>env</span><span>.</span><span>NEO_DECIMAL_BITS</span><span> <wbr/></span><span>===</span><span> <wbr/></span><span>undefined</span><span> <wbr/></span><span>||</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>Number</span><span>.</span><span>isNaN</span><span>(</span><span>parseInt</span><span>(</span><span>process</span><span>.</span><span>env</span><span>.</span><span>NEO_DECIMAL_BITS</span><span>)</span><span>)</span><span></span></p><p><span></span><span>)</span><span> <wbr/></span><span>{</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>throw</span><span> <wbr/></span><span>new</span><span> <wbr/></span><span>Error</span><span>(</span><span>&#39;NEO_DECIMAL_BITS <wbr/>env <wbr/>variable <wbr/>was <wbr/>not <wbr/>set&#39;</span><span>)</span><span>;</span><span></span></p><p><span></span><span>}</span><span></span></p><p><span></span><span>const</span><span> <wbr/>decimalBits <wbr/></span><span>=</span><span> <wbr/></span><span>parseInt</span><span>(</span><span>process</span><span>.</span><span>env</span><span>.</span><span>NEO_DECIMAL_BITS</span><span>)</span><span>;</span><span></span></p><p><span></span><span>const</span><span> <wbr/>scale <wbr/></span><span>=</span><span> <wbr/></span><span>1</span><span> <wbr/></span><span>&lt;&lt;</span><span> <wbr/>decimalBits</span><span>;</span><span></span></p><p><span></span><span>function</span><span> <wbr/></span><span>toFixed</span><span>(</span><span>a</span><span>:</span><span> <wbr/></span><span>number</span><span>)</span><span> <wbr/></span><span>{</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>return</span><span> <wbr/>Math</span><span>.</span><span>floor</span><span>(</span><span>a <wbr/></span><span>*</span><span> <wbr/>scale</span><span>)</span><span>;</span><span></span></p><p><span></span><span>}</span><span></span></p></code></p><h2 id="simulating-floating-point-with-gcc">Simulating floating point with GCC<a aria-hidden="true" href="#simulating-floating-point-with-gcc"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2><p>As a side note, if you are using ngdevkit, then you can using floating point numbers like <code>float</code> and even <code>double</code>. The catch is, GCC will create a software floating point implementation. It&#39;s <em>horrifically</em> slow, especially if you try to use <code>double</code>. This almost certainly can&#39;t be used in a real game. But it can be used in a pinch when just trying something or making a quick demo. It&#39;s good the option is there.</p><p>To use it, just add a <code>float</code> number to your code like you would when writing for a modern system. GCC will do the rest. One way I used it was to help confirm the fixed point system I created was accurate. I&#39;d do some calculations in my system as well as GCC&#39;s floating point system and confirm both got the same result.</p><h2 id="conclusion">Conclusion<a aria-hidden="true" href="#conclusion"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2><p>This post was really just a basic introduction to fixed point. I am far from an expert on the subject. In fact, I&#39;d never used a fixed point system until I started hacking on the Neo Geo. I recommend more detailed reading such as <a tabindex="0" href="http://www.sunshine2k.de/articles/coding/fp/sunfp.html">this article</a> before adding a fixed point system to your game.</p><p>You typically need to create your own fixed point system on something like the Neo Geo instead of using a library because most libraries make assumptions that won&#39;t hold true on on old game systems. Mostly they will promote multiplication and division to 64 bit numbers which isn&#39;t really feasable.</p></div></div>
  </body>
</html>
