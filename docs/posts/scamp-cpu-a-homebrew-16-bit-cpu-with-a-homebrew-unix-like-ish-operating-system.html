<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/jes/scamp-cpu">Original</a>
    <h1>Scamp CPU: A homebrew 16-bit CPU with a homebrew Unix-like-ish operating system</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
          <article itemprop="text">
<p dir="auto">SCAMP is my homebrew 16-bit CPU. It stands for something like &#34;Simple Computing and Arithmetic Microcoded Processor&#34;.</p>
<p dir="auto">The CPU is very primitive. It doesn&#39;t support interrupts, and has no MMU, and no concept of privilege levels. It currently runs
at 1 MHz, above that the CompactFlash interface falls over. It runs a homebrew operating system, with a homebrew
programming language and compiler, and can self-host the kernel and all of the system utilities.
The environment tastes a bit like an early Unix, but works like CP/M. I plan to use the computer to complete as much
as possible of this year&#39;s <a href="https://adventofcode.com/" rel="nofollow">Advent of Code</a>.</p>
<p dir="auto">I have some blog posts here: <a href="https://incoherency.co.uk/blog/tags/cpu.html" rel="nofollow">https://incoherency.co.uk/blog/tags/cpu.html</a> and a web-based emulator available here: <a href="https://incoherency.co.uk/scamp/" rel="nofollow">https://incoherency.co.uk/scamp/</a></p>
<p dir="auto">Here are some pictures:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://blog.vsinha.com/jes/scamp-cpu/blob/master/doc/card-cage.jpeg"><img src="https://blog.vsinha.com/jes/scamp-cpu/raw/master/doc/card-cage.jpeg" height="500"/></a> <a target="_blank" rel="noopener noreferrer" href="https://blog.vsinha.com/jes/scamp-cpu/blob/master/doc/case.jpeg"><img src="https://blog.vsinha.com/jes/scamp-cpu/raw/master/doc/case.jpeg" height="500"/></a></p>
<p dir="auto">Here&#39;s a sample session in the emulator recorded with <code>asciinema</code>:</p>
<p dir="auto"><a href="https://asciinema.org/a/W0rYJUeaSK5ePSycyNKe3nWeL" rel="nofollow"><img width="400" src="https://blog.vsinha.com/jes/scamp-cpu/raw/master/doc/asciinema.png"/></a></p>
<p dir="auto">And here&#39;s a video with some explanation and an example session on real hardware:</p>
<p dir="auto"><a href="https://www.youtube.com/watch?v=4sBB0iD6XvI" rel="nofollow"><img width="400" src="https://blog.vsinha.com/jes/scamp-cpu/raw/master/doc/youtube.png"/></a></p>
<h2 dir="auto"><a id="user-content-the-story-so-far" aria-hidden="true" href="#the-story-so-far"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>The story so far</h2>
<p dir="auto">This is what I&#39;ve already done:</p>
<ol dir="auto">
<li>Create the CPU in Verilog, with a testbench for each part.</li>
<li>Replace the raw Verilog with Verilog that only uses 74xx-compatible primitives
(e.g. <a href="https://github.com/TimRudy/ice-chips-verilog">https://github.com/TimRudy/ice-chips-verilog</a>), but still passes the testbenches.</li>
<li>Convert the 74xx-Verilog into KiCad schematics.</li>
<li>Order the PCBs and components, solder up the PCBs, build a card cage, build a wooden case.</li>
<li>Settle on the instruction set and write the microcode (see <a href="https://blog.vsinha.com/jes/scamp-cpu/blob/master/doc/table.html">doc/table.html</a>, available online at <a href="https://incoherency.co.uk/interest/table.html" rel="nofollow">https://incoherency.co.uk/interest/table.html</a>).</li>
<li>Write a bootloader, kernel, shell, text editor, compiler, and various system utilities.</li>
</ol>
<h2 dir="auto"><a id="user-content-next-steps" aria-hidden="true" href="#next-steps"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Next steps</h2>
<p dir="auto">The computer already works, and I suspect it will never be &#34;finished&#34;, but some things I still want to work on are:</p>
<h4 dir="auto"><a id="user-content-hardware" aria-hidden="true" href="#hardware"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Hardware</h4>
<ul>
<li> build a hardware multiplication card (and maybe division?)</li>
<li> build a hardware RNG</li>
</ul>
<h4 dir="auto"><a id="user-content-low-level-software" aria-hidden="true" href="#low-level-software"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Low-level software</h4>
<ul>
<li> make library blob self-hosting (compile within SCAMP/os)</li>
<li> write an strace-like debugging tool</li>
<li> write a DDT-like debugging tool</li>
<li> move fsck to &#34;userspace&#34;</li>
<li> better facility for memory profiling (mainly to stop kilo and asm from running out of memory on large inputs)</li>
<li> atexit()</li>
<li> static initialisation of globals from constants (e.g. <code>var x = 5</code> at global scope should not take any code to initialise)</li>
<li> &#34;const&#34; variables (e.g. <code>const x = 5</code> should lead to <code>x</code> being replaced with the constant value <code>5</code> where possible)</li>
</ul>
<h4 dir="auto"><a id="user-content-other-software" aria-hidden="true" href="#other-software"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Other software</h4>
<ul>
<li> write a big-fixed-point arithmetic library</li>
<li> fixed-point mathematics: pow,tan,asin,acos,atan,atan2</li>
<li> solve some of this year&#39;s <a href="https://adventofcode.com/" rel="nofollow">Advent of Code</a> using the SCAMP hardware</li>
<li> write a FORTH implementation (should it run on bare metal or under SCAMP/os?)</li>
<li> write a Z-machine interpreter and port some text adventures</li>
<li> write some games (pong? breakout? tetris?)</li>
<li> serial protocol: make it use xmodem-style block transfer for speed &amp; error-checking</li>
</ul>
<p dir="auto">If you happen to want to work on any of the above, I&#39;d be happy to help you!</p>
<h2 dir="auto"><a id="user-content-architecture" aria-hidden="true" href="#architecture"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Architecture</h2>
<p dir="auto">It is a 16-bit CPU. The bus is 16-bit, registers are 16-bit, addresses are 16-bit, and memory contents are
16-bit. The upper 8 bits of an instruction select the opcode, and the lower 8 bits are available
for small immediate values. There is no support for: cache, interrupts, virtual memory, DMA, privilege rings,
floating point, and ~anything else that is not strictly necessary.</p>
<p dir="auto">Here is a diagram of the architecture:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://blog.vsinha.com/jes/scamp-cpu/blob/master/doc/architecture.png"><img src="https://blog.vsinha.com/jes/scamp-cpu/raw/master/doc/architecture.png" alt=""/></a></p>
<p dir="auto">For more information, see <a href="https://blog.vsinha.com/jes/scamp-cpu/blob/master/doc/UCODE.md">doc/UCODE.md</a> and <a href="https://blog.vsinha.com/jes/scamp-cpu/blob/master/doc/ISA.md">doc/ISA.md</a>.</p>
<h2 dir="auto"><a id="user-content-try-it-out" aria-hidden="true" href="#try-it-out"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Try it out</h2>
<p dir="auto">The easiest way to try it out is to use the web-based emulator at <a href="https://incoherency.co.uk/scamp/" rel="nofollow">https://incoherency.co.uk/scamp/</a></p>
<p dir="auto">If you want to run it locally, first you&#39;ll need to build everything. Try <code>make -j</code> in the root directory of this
repository. It probably won&#39;t work on the first attempt because it works with multiple different Makefiles that have
annoying dependencies. Just run <code>make -j</code> twice. If that doesn&#39;t do the trick, run <code>make</code> in <code>sys/</code> first, and then run
it in <code>.</code>.</p>
<p dir="auto">Having built everything, you can go into <code>kernel/</code> and start it in the emulator with <code>./run</code>:</p>
<div data-snippet-clipboard-copy-content="~/scamp-cpu/kernel $ ./run
make: &#39;os.disk&#39; is up to date.
SCAMP boot...
.......................................................OK
starting kernel...
loading init...
      ____   ____    _    __  __ ____   __
     / ___| / ___|  / \  |  \/  |  _ \ / /__  ___
     \___ \| |     / _ \ | |\/| | |_) / / _ \/ __|
      ___) | |___ / ___ \| |  | |  __/ / (_) \__ \
     |____/ \____/_/   \_\_|  |_|_| /_/ \___/|___/

$
"><pre><code>~/scamp-cpu/kernel $ ./run
make: &#39;os.disk&#39; is up to date.
SCAMP boot...
.......................................................OK
starting kernel...
loading init...
      ____   ____    _    __  __ ____   __
     / ___| / ___|  / \  |  \/  |  _ \ / /__  ___
     \___ \| |     / _ \ | |\/| | |_) / / _ \/ __|
      ___) | |___ / ___ \| |  | |  __/ / (_) \__ \
     |____/ \____/_/   \_\_|  |_|_| /_/ \___/|___/

$
</code></pre></div>
<p dir="auto">If you know how to use Unix you&#39;ll probably understand how to use it. If you know how to use CP/M you&#39;ll probably
understand how it works.</p>
<p dir="auto">If you want, you can write SLANG programs using <code>kilo</code> and compile them with <code>slc</code>. You&#39;ve probably never written
SLANG before. You can learn how to use it by reading programs under <code>/src</code> (or <code>sys/</code> in the repo). It&#39;s mostly
like C but with fewer features and less safety.</p>
<h2 dir="auto"><a id="user-content-resources" aria-hidden="true" href="#resources"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Resources</h2>
<p dir="auto">I thoroughly recommend the Nand2Tetris course. <a href="https://nand2tetris.org/" rel="nofollow">https://nand2tetris.org/</a></p>
<p dir="auto">If you want to do the exercises from Nand2Tetris without learning what a hardware-description language
is, and without going through all the lectures, you can play <a href="https://nandgame.com/" rel="nofollow">https://nandgame.com/</a></p>
<p dir="auto">Ben Eater&#39;s <a href="https://www.youtube.com/watch?v=HyznrdDSSGM&amp;list=PLowKtXNTBypGqImE405J2565dvjafglHU" rel="nofollow">videos on 8-bit CPU design</a> are excellent and heavily influenced
the design of my CPU.</p>
<p dir="auto">I found the <a href="https://www.youtube.com/playlist?list=PLOech0kWpH8-njQpmSNGSiQBPUvl8v3IM" rel="nofollow">YouTube playlist</a> for Nicolas Laurent&#39;s <a href="https://norswap.com/compilers/" rel="nofollow">compiler class</a> quite helpful
in writing the parser for the compiler.</p>
<p dir="auto">The <a href="https://viewsourcecode.org/snaptoken/kilo/" rel="nofollow">Build Your Own Text Editor</a> is a fantastic tutorial that walks you through implementing
<a href="https://github.com/antirez">antirez</a>&#39;s <a href="https://github.com/antirez/kilo">kilo</a> editor.</p>
<p dir="auto"><a href="https://github.com/bazsimarkus">Balazs Markus</a>&#39;s <a href="https://github.com/bazsimarkus/Simple-8250-UART-System-with-Arduino">8250 UART example</a> is helpful.</p>
<p dir="auto">Daniel Tufvesson has a post that is a good starting point for understanding the <a href="http://www.waveguide.se/?article=8-bit-compact-flash-interface" rel="nofollow">8-bit CompactFlash interface</a>.</p>
<p dir="auto"><a href="https://github.com/PickledDog">PickledDog</a> has a description of an <a href="https://github.com/PickledDog/rc-cfcard">improvement to the RC2014 CompactFlash card</a> that might be helpful. Also <a href="https://groups.google.com/g/rc2014-z80/c/LmvGa6PZNhQ/m/H8jrbp86AQAJ" rel="nofollow">Bill Shen&#39;s comment on the RC2014 mailing list</a>.</p>
<p dir="auto">Michał Cierniak has a good blog post about <a href="https://ciernioo.wordpress.com/2015/02/10/compact-flash-8255-interface-card/" rel="nofollow">CompactFlash + 8255 interface card</a> with lots
of detail on how his CompactFlash interface works.</p>
<p dir="auto">SCAMP is featured on the <a href="https://www.homebrewcpuring.org/" rel="nofollow">Homebrew CPU ring</a> which also features many other interesting homebrew CPU designs.</p>
<h2 dir="auto"><a id="user-content-contact" aria-hidden="true" href="#contact"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Contact</h2>
<p dir="auto">You can email me on <a href="mailto:james@incoherency.co.uk">james@incoherency.co.uk</a>
or read my blog: [<a href="https://incoherency.co.uk/" rel="nofollow">https://incoherency.co.uk/</a>].</p>
</article>
        </div></div>
  </body>
</html>
