<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://copyninja.in/blog/clone_laptop_nvmet.html">Original</a>
    <h1>Cloning a Laptop over NVMe TCP</h1>
    
    <div id="readability-page-1" class="page"><div id="content"><section id="content"><div><p>Recently, I got a new laptop and had to set it up so I could start using it. But I wasn&#39;t really in the mood to go through the same old steps which I had explained in this <a href="https://copyninja.in/blog/live_install_debian.html">post earlier</a>. I was complaining about this to my colleague, and there came the suggestion of why not copy the entire disk to the new laptop. Though it sounded like an interesting idea to me, I had my doubts, so here is what I told him in return.</p><ol><li>I don&#39;t have the tools to open my old laptop and connect the new disk over USB to my new laptop.</li><li>I use full disk encryption, and my old laptop has a 512GB disk, whereas the new laptop has a 1TB NVME, and I&#39;m not so familiar with resizing LUKS.</li></ol><p>He promptly suggested both could be done. For step 1, just expose the disk using NVME over TCP and connect it over the network and do a full disk copy, and the rest is pretty simple to achieve. In short, he suggested the following:</p><ol><li>Export the disk using nvmet-tcp from the old laptop.</li><li>Do a disk copy to the new laptop.</li><li>Resize the partition to use the full 1TB.</li><li>Resize LUKS.</li><li>Finally, resize the BTRFS root disk.</li></ol><div id="exporting-disk-over-nvme-tcp"><h2>Exporting Disk over NVME TCP</h2><p>The easiest way suggested by my colleague to do this is using <a href="https://www.freedesktop.org/software/systemd/man/latest/systemd-storagetm.service.html">systemd-storagetm.service</a>. This service can be invoked by simply booting into <em>storage-target-mode.target</em> by specifying <em>rd.systemd.unit=storage-target-mode.target</em>. But he suggested not to use this as I need to tweak the dracut initrd image to involve network services as well as configuring WiFi from this mode is a painful thing to do.</p><p>So alternatively, I simply booted both my laptops with GRML rescue CD. And the following step was done to export the NVME disk on my current laptop using the nvmet-tcp module of Linux:</p><div><pre><span></span>modprobe<span> </span>nvemt-tcp
<span>cd</span><span> </span>/sys/kernel/config/nvmet
mkdir<span> </span>ports/0
<span>cd</span><span> </span>ports/0
<span>echo</span><span> </span><span>&#34;ipv4&#34;</span><span> </span>&gt;<span> </span>addr_adrfam
<span>echo</span><span> </span><span>0</span>.0.0.0<span> </span>&gt;<span> </span>addr_traaddr
<span>echo</span><span> </span><span>4420</span><span> </span>&gt;<span> </span>addr_trsvcid
<span>echo</span><span> </span>tcp<span> </span>&gt;<span> </span>addr_trtype

<span>cd</span><span> </span>/sys/kernel/config/nvmet/subsystems
mkdir<span> </span>testnqn
<span>echo</span><span> </span><span>1</span><span> </span>&gt;testnqn/allow_any_host
mkdir<span> </span>testnqn/namespaces/1

<span>cd</span><span> </span>testnqn
<span># replace the device name with the disk you want to export</span>
<span>echo</span><span> </span><span>&#34;/dev/nvme0n1&#34;</span><span> </span>&gt;<span> </span>namespaces/1/device_path
<span>echo</span><span> </span><span>1</span><span> </span>&gt;<span> </span>namespaces/1/enable

ln<span> </span>-s<span> </span><span>&#34;../../subsystems/testnqn&#34;</span><span> </span>/sys/kernel/config/nvmet/ports/0/subsystems/testnqn
</pre></div><p>These steps ensure that the device is now exported using NVME over TCP. The next step is to detect this on the new laptop and connect the device:</p><div><pre><span></span>nvme<span> </span>discover<span> </span>-t<span> </span>tcp<span> </span>-a<span> </span>&lt;ip&gt;<span> </span>-s<span> </span><span>4420</span>
nvme<span> </span>connectl-all<span> </span>-t<span> </span>tcp<span> </span>-a<span> </span>&lt;&gt;<span> </span>-s<span> </span><span>4420</span>
</pre></div><p>Finally, <tt>nvme list</tt> shows the device which is connected to the new laptop, and we can proceed with the next step, which is to do the disk copy.</p></div><div id="copying-the-disk"><h2>Copying the Disk</h2><p>I simply used the <tt>dd</tt> command to copy the root disk to my new laptop. Since the new laptop didn&#39;t have an Ethernet port, I had to rely only on WiFi, and it took about 7 and a half hours to copy the entire 512GB to the new laptop. The speed at which I was copying was about 18-20MB/s. The other option would have been to create an initial partition and file system and do an rsync of the root disk or use BTRFS itself for file system transfer.</p><div><pre><span></span>dd<span> </span><span>if</span><span>=</span>/dev/nvme2n1<span> </span><span>of</span><span>=</span>/dev/nvme0n1<span> </span><span>status</span><span>=</span>progress<span> </span><span>bs</span><span>=</span>40M
</pre></div></div><div id="resizing-partition-and-luks-container"><h2>Resizing Partition and LUKS Container</h2><p>The final part was very easy. When I launched <tt>parted</tt>, it detected that the partition table does not match the disk size and asked if it can fix it, and I said yes. Next, I had to install <tt><span>cloud-guest-utils</span></tt> to get <tt>growpart</tt> to fix the second partition, and the following command extended the partition to the full 1TB:</p><p>Next, I used <tt><span>cryptsetup-resize</span></tt> to increase the LUKS container size.</p><div><pre><span></span>cryptsetup<span> </span>luksOpen<span> </span>/dev/nvme0n1p2<span> </span>ENC
cryptsetup<span> </span>resize<span> </span>ENC
</pre></div><p>Finally, I rebooted into the disk, and everything worked fine. After logging into the system, I resized the BTRFS file system. BTRFS requires the system to be mounted for resize, so I could not attempt it in live boot.</p><div><pre><span></span>btfs<span> </span>fielsystem<span> </span>resize<span> </span>max<span> </span>/
</pre></div></div><div id="conclussion"><h2>Conclussion</h2><p>The only benefit of this entire process is that I have a new laptop, but I still feel like I&#39;m using my existing laptop. Typically, setting up a new laptop takes about a week or two to completely get adjusted, but in this case, that entire time is saved.</p><p>An added benefit is that I learned how to export disks using NVME over TCP, thanks to my colleague. This new knowledge adds to the value of the experience.</p></div></div></section></div></div>
  </body>
</html>
