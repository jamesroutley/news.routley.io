<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://zserge.com/posts/fenster/">Original</a>
    <h1>Minimal Cross-Platform Graphics</h1>
    
    <div id="readability-page-1" class="page"><div id="content"><p>I grew up with BASIC and Turbo Pascal. My first programs were very simple graphical games. I still miss the era of <a href="https://en.wikipedia.org/wiki/Borland_Graphics_Interface">BGI</a> and BASIC’s painting commands. Those graphics were neither beautiful nor fast, but they were simple. Simple enough for a kid with only elemental geometry knowledge to build something exciting.</p><p>Even today, whenever I want to prototype or visualise something, to experiment with generative art or to write a toy graphical app – I feel nostalgic for the old days.</p><p>Sure, there is SDL2 and Qt and JavaScript Canvas and Löve and many others. But how hard could it be to build our own cross-platform graphical library from scratch?</p><p>Our goal here is to have a <a href="https://en.wikipedia.org/wiki/Framebuffer">framebuffer</a> for a single window that would run and look the same on Linux, Windows and macOS. Good old C would the language of choice to keep the retro-computing atmosphere of the story.</p><p>TLDR: the end result is available as a single-header library on Github: <a href="https://github.com/zserge/fenster">https://github.com/zserge/fenster</a>.</p><h2 id="linux">Linux</h2><p>From my past experience with <a href="https://github.com/webview/webview">webview</a> and <a href="https://github.com/zserge/lorca">lorca</a>, Linux is the easiest platform to develop for. Or maybe I’m just biased. Of all the graphical options that Linux provides we’ll choose X11 as the foundation to our window, since it’s the lowest common denominator, so to say.</p><p>It all starts with opening the display connection. X server is an actual network server, so all the APIs are special packets sent over the X server connection. Once the connection is established – we should choose the screen and create a window on that screen. Fortunately, X11 comes with very simple and convenient APIs for all of it. Then we enter the event loop where we poll for incoming events and can handle them. Once we are about to exit the app – we close the display connection.</p><div><pre><code data-lang="c"><span>// cc main.c -lX11 &amp;&amp; ./a.out
</span><span></span><span>#include</span> <span>&lt;X11/Xlib.h&gt;</span><span>
</span><span></span><span>int</span> <span>main</span><span>()</span> <span>{</span>
  <span>Display</span> <span>*</span><span>dpy</span> <span>=</span> <span>XOpenDisplay</span><span>(</span><span>NULL</span><span>);</span>
  <span>int</span> <span>scr</span> <span>=</span> <span>DefaultScreen</span><span>(</span><span>dpy</span><span>);</span>
  <span>Window</span> <span>wnd</span> <span>=</span> <span>XCreateSimpleWindow</span><span>(</span><span>dpy</span><span>,</span> <span>RootWindow</span><span>(</span><span>dpy</span><span>,</span> <span>scr</span><span>),</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>320</span><span>,</span> <span>240</span><span>,</span> <span>0</span><span>,</span> <span>BlackPixel</span><span>(</span><span>dpy</span><span>,</span> <span>scr</span><span>),</span> <span>WhitePixel</span><span>(</span><span>dpy</span><span>,</span> <span>scr</span><span>));</span>
  <span>XStoreName</span><span>(</span><span>dpy</span><span>,</span> <span>wnd</span><span>,</span> <span>&#34;Hello, X11&#34;</span><span>);</span>
  <span>XSelectInput</span><span>(</span><span>dpy</span><span>,</span> <span>wnd</span><span>,</span> <span>ExposureMask</span> <span>|</span> <span>KeyPressMask</span><span>);</span>
  <span>XMapWindow</span><span>(</span><span>dpy</span><span>,</span> <span>wnd</span><span>);</span>
  <span>for</span> <span>(;;)</span> <span>{</span>
    <span>XEvent</span> <span>e</span><span>;</span>
    <span>XNextEvent</span><span>(</span><span>dpy</span><span>,</span> <span>&amp;</span><span>e</span><span>);</span>
    <span>// handle events here
</span><span></span>  <span>}</span>
  <span>return</span> <span>XCloseDisplay</span><span>(</span><span>dpy</span><span>);</span>
<span>}</span>
</code></pre></div><p>In only 15 lines of code we got a working window with the given size 320x240 and a title!</p><h2 id="macos">macOS</h2><p>While X11 apps can run on macOS using XQuartz, it’s still better to support native Cocoa apps. We won’t be using Swift or XCode and will try to only rely on bare bones technologies to remain portable. Let’s start with Objective-C, something like this might work:</p><div><pre><code data-lang="objc"><span>// cc -x objective-c main.m -framework Cocoa &amp;&amp; ./a.out
</span><span></span><span>#import &lt;Cocoa/Cocoa.h&gt;
</span><span></span><span>int</span> <span>main</span><span>()</span> <span>{</span>
  <span>[</span><span>NSApplication</span> <span>sharedApplication</span><span>];</span>
  <span>[</span><span>NSApp</span> <span>setActivationPolicy</span><span>:</span><span>NSApplicationActivationPolicyRegular</span><span>];</span>
  <span>NSWindow</span> <span>*</span><span>wnd</span> <span>=</span>
      <span>[[</span><span>NSWindow</span> <span>alloc</span><span>]</span> <span>initWithContentRect</span><span>:</span><span>NSMakeRect</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> <span>320</span><span>,</span> <span>240</span><span>)</span>
                                  <span>styleMask</span><span>:</span><span>NSTitledWindowMask</span>
                                    <span>backing</span><span>:</span><span>NSBackingStoreBuffered</span>
                                      <span>defer</span><span>:</span><span>NO</span><span>];</span>
  <span>[</span><span>wnd</span> <span>setTitle</span><span>:</span><span>@&#34;Hello, Cocoa&#34;</span><span>];</span>
  <span>[</span><span>wnd</span> <span>makeKeyAndOrderFront</span><span>:</span><span>nil</span><span>];</span>
  <span>[</span><span>NSApp</span> <span>activateIgnoringOtherApps</span><span>:</span><span>YES</span><span>];</span>
  <span>for</span> <span>(;;)</span> <span>{</span>
    <span>NSEvent</span> <span>*</span><span>event</span> <span>=</span> <span>[</span><span>NSApp</span> <span>nextEventMatchingMask</span><span>:</span><span>NSAnyEventMask</span>
                                        <span>untilDate</span><span>:[</span><span>NSDate</span> <span>distantPast</span><span>]</span>
                                           <span>inMode</span><span>:</span><span>NSDefaultRunLoopMode</span>
                                          <span>dequeue</span><span>:</span><span>YES</span><span>];</span>
    <span>// handle events here
</span><span></span>    <span>[</span><span>NSApp</span> <span>sendEvent</span><span>:</span><span>event</span><span>];</span>
  <span>}</span>
  <span>[</span><span>wnd</span> <span>close</span><span>];</span>
  <span>return</span> <span>0</span><span>;</span>
<span>}</span>
</code></pre></div><p>Slighly more verbose but still very compact and follows the same logic: start an app, open a window, run event loop, close the window.</p><p>But it’s Objective-C and I promised you just C…</p><h2 id="macos--c">macOS + C</h2><p>Fortunately, macOS comes with Objective-C runtime library that enables calling Objective-C constructs from C using something like a reflection layer:</p><div><pre><code data-lang="objc"><span>// For example this:
</span><span></span><span>[</span><span>NSApplication</span> <span>sharedApplication</span><span>];</span>
<span>// Becomes:
</span><span></span><span>objc_msgSend</span><span>(</span><span>objc_getClass</span><span>(</span><span>&#34;NSApplication&#34;</span><span>),</span> <span>sel_getUid</span><span>(</span><span>&#34;sharedApplication&#34;</span><span>));</span>
</code></pre></div><p>But now it’s barely readable. Imagine rewriting <code>initWithContextRect</code> like this. Also, if you experiment more with it you’ll discover that <code>objc_msgSend</code> should be type-casted to a correct signature before each call to avoid crashes.</p><p>But what if we come up with some clever preprocessor macros to achieve a terser syntax?</p><div><pre><code data-lang="c"><span>#include</span> <span>&lt;objc/NSObjCRuntime.h&gt;</span><span>
</span><span>#include</span> <span>&lt;objc/objc-runtime.h&gt;</span><span>
</span><span></span>
<span>#define msg(r, o, s) ((r(*)(id, SEL))objc_msgSend)(o, sel_getUid(s))
</span><span>#define msg1(r, o, s, A, a)                                                    \
</span><span>  ((r(*)(id, SEL, A))objc_msgSend)(o, sel_getUid(s), a)
</span><span>#define msg2(r, o, s, A, a, B, b)                                              \
</span><span>  ((r(*)(id, SEL, A, B))objc_msgSend)(o, sel_getUid(s), a, b)
</span><span>#define msg3(r, o, s, A, a, B, b, C, c)                                        \
</span><span>  ((r(*)(id, SEL, A, B, C))objc_msgSend)(o, sel_getUid(s), a, b, c)
</span><span>#define msg4(r, o, s, A, a, B, b, C, c, D, d)                                  \
</span><span>  ((r(*)(id, SEL, A, B, C, D))objc_msgSend)(o, sel_getUid(s), a, b, c, d)
</span><span></span>
<span>#define cls(x) ((id)objc_getClass(x))
</span></code></pre></div><p>Here <code>msg</code> is a message (think: method call) with no arguments. The return type should be specified, the receiver of the message and the message name itself. Similarly <code>msg1</code>, <code>msg2</code>, <code>msg3</code> and <code>msg4</code> are helpers for messages with one and more parameters. For each parameter a type should be provided as well as its value. Finally, <code>cls</code> is just a helper for <code>objc_getClass</code>.</p><p>Using these macros our minimal Cocoa window can be rewritten in standard C as follows:</p><div><pre><code data-lang="c"><span>// cc main.c -framework Cocoa
</span><span></span><span>...</span>
<span>extern</span> <span>id</span> <span>const</span> <span>NSDefaultRunLoopMode</span><span>;</span>
<span>extern</span> <span>id</span> <span>const</span> <span>NSApp</span><span>;</span>
<span>int</span> <span>main</span><span>()</span> <span>{</span>
  <span>msg</span><span>(</span><span>id</span><span>,</span> <span>cls</span><span>(</span><span>&#34;NSApplication&#34;</span><span>),</span> <span>&#34;sharedApplication&#34;</span><span>);</span>
  <span>msg1</span><span>(</span><span>void</span><span>,</span> <span>NSApp</span><span>,</span> <span>&#34;setActivationPolicy:&#34;</span><span>,</span> <span>NSInteger</span><span>,</span> <span>0</span><span>);</span>
  <span>id</span> <span>wnd</span> <span>=</span>
      <span>msg4</span><span>(</span><span>id</span><span>,</span> <span>msg</span><span>(</span><span>id</span><span>,</span> <span>cls</span><span>(</span><span>&#34;NSWindow&#34;</span><span>),</span> <span>&#34;alloc&#34;</span><span>),</span>
           <span>&#34;initWithContentRect:styleMask:backing:defer:&#34;</span><span>,</span> <span>CGRect</span><span>,</span>
           <span>CGRectMake</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> <span>320</span><span>,</span> <span>240</span><span>),</span> <span>NSUInteger</span><span>,</span> <span>3</span><span>,</span> <span>NSUInteger</span><span>,</span> <span>2</span><span>,</span> <span>BOOL</span><span>,</span> <span>NO</span><span>);</span>
  <span>id</span> <span>title</span> <span>=</span> <span>msg1</span><span>(</span><span>id</span><span>,</span> <span>cls</span><span>(</span><span>&#34;NSString&#34;</span><span>),</span> <span>&#34;stringWithUTF8String:&#34;</span><span>,</span> <span>const</span> <span>char</span> <span>*</span><span>,</span>
                  <span>&#34;Hello, Cocoa&#34;</span><span>);</span>
  <span>msg1</span><span>(</span><span>void</span><span>,</span> <span>wnd</span><span>,</span> <span>&#34;setTitle:&#34;</span><span>,</span> <span>id</span><span>,</span> <span>title</span><span>);</span>
  <span>msg1</span><span>(</span><span>void</span><span>,</span> <span>wnd</span><span>,</span> <span>&#34;makeKeyAndOrderFront:&#34;</span><span>,</span> <span>id</span><span>,</span> <span>nil</span><span>);</span>
  <span>msg</span><span>(</span><span>void</span><span>,</span> <span>wnd</span><span>,</span> <span>&#34;center&#34;</span><span>);</span>
  <span>msg1</span><span>(</span><span>void</span><span>,</span> <span>NSApp</span><span>,</span> <span>&#34;activateIgnoringOtherApps:&#34;</span><span>,</span> <span>BOOL</span><span>,</span> <span>YES</span><span>);</span>
  <span>for</span> <span>(;;)</span> <span>{</span>
    <span>id</span> <span>ev</span> <span>=</span> <span>msg4</span><span>(</span><span>id</span><span>,</span> <span>NSApp</span><span>,</span>
                 <span>&#34;nextEventMatchingMask:untilDate:inMode:dequeue:&#34;</span><span>,</span> <span>NSUInteger</span><span>,</span>
                 <span>NSUIntegerMax</span><span>,</span> <span>id</span><span>,</span> <span>NULL</span><span>,</span> <span>id</span><span>,</span> <span>NSDefaultRunLoopMode</span><span>,</span> <span>BOOL</span><span>,</span> <span>YES</span><span>);</span>
    <span>msg1</span><span>(</span><span>void</span><span>,</span> <span>NSApp</span><span>,</span> <span>&#34;sendEvent:&#34;</span><span>,</span> <span>id</span><span>,</span> <span>ev</span><span>);</span>
  <span>}</span>
  <span>msg</span><span>(</span><span>void</span><span>,</span> <span>wnd</span><span>,</span> <span>&#34;close&#34;</span><span>);</span>
  <span>return</span> <span>0</span><span>;</span>
<span>}</span>
</code></pre></div><p>Now it’s a perfectly valid C code that does exactly the same as the Objective-C code above. Moreover, using this technique we can create new classes dynamically, attach methods to them, create delegates and do much more. But for now our goal is achieved – we’ve made an empty macOS window with a title.</p><h2 id="windows">windows</h2><p>WinAPI was traditionally designed to be used from C/C++, and Windows is a graphical desktop OS, so making a window on Windows should be pretty straightforward (although tautological).</p><div><pre><code data-lang="c"><span>#include</span> <span>&lt;windows.h&gt;</span><span>
</span><span></span><span>LRESULT</span> <span>CALLBACK</span> <span>wndproc</span><span>(</span><span>HWND</span> <span>hwnd</span><span>,</span> <span>UINT</span> <span>msg</span><span>,</span> <span>WPARAM</span> <span>wParam</span><span>,</span> <span>LPARAM</span> <span>lParam</span><span>)</span> <span>{</span>
  <span>switch</span> <span>(</span><span>msg</span><span>)</span> <span>{</span>
    <span>// handle events
</span><span></span>  <span>case</span> <span>WM_CLOSE</span><span>:</span>
    <span>DestroyWindow</span><span>(</span><span>hwnd</span><span>);</span>
    <span>break</span><span>;</span>
  <span>case</span> <span>WM_DESTROY</span><span>:</span>
    <span>PostQuitMessage</span><span>(</span><span>0</span><span>);</span>
    <span>break</span><span>;</span>
  <span>default</span><span>:</span>
    <span>return</span> <span>DefWindowProc</span><span>(</span><span>hwnd</span><span>,</span> <span>msg</span><span>,</span> <span>wParam</span><span>,</span> <span>lParam</span><span>);</span>
  <span>}</span>
  <span>return</span> <span>0</span><span>;</span>
<span>}</span>

<span>int</span> <span>WINAPI</span> <span>WinMain</span><span>(</span><span>HINSTANCE</span> <span>instance</span><span>,</span> <span>HINSTANCE</span> <span>prevInstance</span><span>,</span> <span>LPSTR</span> <span>pCmdLine</span><span>,</span>
                   <span>int</span> <span>nCmdShow</span><span>)</span> <span>{</span>
  <span>MSG</span> <span>msg</span><span>;</span>
  <span>HINSTANCE</span> <span>hInstance</span> <span>=</span> <span>GetModuleHandle</span><span>(</span><span>NULL</span><span>);</span>
  <span>WNDCLASSEX</span> <span>wc</span> <span>=</span> <span>{</span><span>0</span><span>};</span>
  <span>wc</span><span>.</span><span>cbSize</span> <span>=</span> <span>sizeof</span><span>(</span><span>WNDCLASSEX</span><span>);</span>
  <span>wc</span><span>.</span><span>style</span> <span>=</span> <span>CS_VREDRAW</span> <span>|</span> <span>CS_HREDRAW</span><span>;</span>
  <span>wc</span><span>.</span><span>lpfnWndProc</span> <span>=</span> <span>wndproc</span><span>;</span>
  <span>wc</span><span>.</span><span>hInstance</span> <span>=</span> <span>hInstance</span><span>;</span>
  <span>wc</span><span>.</span><span>lpszClassName</span> <span>=</span> <span>&#34;demo&#34;</span><span>;</span>
  <span>RegisterClassEx</span><span>(</span><span>&amp;</span><span>wc</span><span>);</span>
  <span>HWND</span> <span>hwnd</span> <span>=</span> <span>CreateWindowEx</span><span>(</span><span>WS_EX_CLIENTEDGE</span><span>,</span> <span>&#34;demo&#34;</span><span>,</span> <span>&#34;Hello, WInAPI&#34;</span><span>,</span>
                             <span>WS_OVERLAPPEDWINDOW</span><span>,</span> <span>CW_USEDEFAULT</span><span>,</span> <span>CW_USEDEFAULT</span><span>,</span>
                             <span>320</span><span>,</span> <span>240</span><span>,</span> <span>NULL</span><span>,</span> <span>NULL</span><span>,</span> <span>hInstance</span><span>,</span> <span>NULL</span><span>);</span>
  <span>ShowWindow</span><span>(</span><span>hwnd</span><span>,</span> <span>SW_NORMAL</span><span>);</span>
  <span>UpdateWindow</span><span>(</span><span>hwnd</span><span>);</span>
  <span>while</span> <span>(</span><span>GetMessage</span><span>(</span><span>&amp;</span><span>msg</span><span>,</span> <span>NULL</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>))</span> <span>{</span>
    <span>if</span> <span>(</span><span>msg</span><span>.</span><span>message</span> <span>==</span> <span>WM_QUIT</span><span>)</span>
      <span>return</span> <span>0</span><span>;</span>
    <span>TranslateMessage</span><span>(</span><span>&amp;</span><span>msg</span><span>);</span>
    <span>DispatchMessage</span><span>(</span><span>&amp;</span><span>msg</span><span>);</span>
  <span>}</span>
<span>}</span>
</code></pre></div><p>WinAPI version requires a separate callback to handle all window events, unlike the previous two platforms, where events could be handled inside the loop body. Also it requires to register a window class before creating a window. But other than that it’s rather trivial: open a window, run event loop, handle events, exit when the window is closed.</p><p>Now that we’re done with window initialisation and the main loop for all three common desktop platforms – we can move on to actually drawing something inside those windows.</p><h2 id="graphics">Graphics</h2><p>We won’t do any fancy graphics, we won’t bother with GPUs and OpenGL. We’ll aim for a very simple framebuffer view. Typically, a framebuffer is a section of RAM that contains a bitmap and changing that bitmap affects the video display.</p><p>In our case we will create an array of 32-bit integers, where every integer controls a single pixel of the window. Changing the value of an integer would change the color of a single pixel. More advanced algorithms could be used to draw spires, lines, rectangles, circles, arc etc. But we’ll come back to it later. Now let’s draw some pixels.</p><h2 id="x11">X11</h2><p>In our X11 window a framebuffer can be implemented using a graphical context (GC) and an image:</p><div><pre><code data-lang="fallback">Display *dpy = ...
Window *wnd = ...
uint32_t buf[320*240];
GC gc = XCreateGC(dpy, wnd, 0, 0);
XImage *img = XCreateImage(dpy, DefaultVisual(dpy, 0), 24, ZPixmap, 0, (char *)buf, 320, 240, 32, 0);
// later in a loop
XPutImage(dpy, wnd, gc, img, 0, 0, 0, 0, 320, 240);
XFlush(dpy);
</code></pre></div><p>Image is backed by an array, every time we change the array – we should call <code>XPutImage</code> and flush the connection to redraw the window. Writing random integers to the array would create colourful white noise. Writing 0xff0000 would paint it red. Now let’s try reproduce it on macOS.</p><h2 id="coregraphics">CoreGraphics</h2><p>We can keep using ObjC runtime to create a custom <code>NSView</code> class and override its <code>drawRect</code> method. Then in a loop we would need to invalidate the view, it should trigger <code>drawRect</code> and we’re done.</p><div><pre><code data-lang="c"><span>static</span> <span>void</span> <span>draw_rect</span><span>(</span><span>id</span> <span>v</span><span>,</span> <span>SEL</span> <span>s</span><span>,</span> <span>CGRect</span> <span>r</span><span>)</span> <span>{</span>
  <span>CGContextRef</span> <span>context</span> <span>=</span>
      <span>msg</span><span>(</span><span>CGContextRef</span><span>,</span> <span>msg</span><span>(</span><span>id</span><span>,</span> <span>cls</span><span>(</span><span>&#34;NSGraphicsContext&#34;</span><span>),</span> <span>&#34;currentContext&#34;</span><span>),</span> <span>&#34;graphicsPort&#34;</span><span>);</span>
  <span>CGColorSpaceRef</span> <span>space</span> <span>=</span> <span>CGColorSpaceCreateDeviceRGB</span><span>();</span>
  <span>CGDataProviderRef</span> <span>provider</span> <span>=</span> <span>CGDataProviderCreateWithData</span><span>(</span><span>NULL</span><span>,</span> <span>buf</span><span>,</span> <span>width</span> <span>*</span> <span>height</span> <span>*</span> <span>4</span><span>,</span> <span>NULL</span><span>);</span>
  <span>CGImageRef</span> <span>img</span> <span>=</span>
      <span>CGImageCreate</span><span>(</span><span>width</span><span>,</span> <span>height</span><span>,</span> <span>8</span><span>,</span> <span>32</span><span>,</span> <span>width</span> <span>*</span> <span>4</span><span>,</span> <span>space</span><span>,</span>
                    <span>kCGImageAlphaNoneSkipFirst</span> <span>|</span> <span>kCGBitmapByteOrder32Little</span><span>,</span>
                    <span>provider</span><span>,</span> <span>NULL</span><span>,</span> <span>false</span><span>,</span> <span>kCGRenderingIntentDefault</span><span>);</span>
  <span>CGColorSpaceRelease</span><span>(</span><span>space</span><span>);</span>
  <span>CGDataProviderRelease</span><span>(</span><span>provider</span><span>);</span>
  <span>CGContextDrawImage</span><span>(</span><span>context</span><span>,</span> <span>CGRectMake</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> <span>width</span><span>,</span> <span>height</span><span>),</span> <span>img</span><span>);</span>
  <span>CGImageRelease</span><span>(</span><span>img</span><span>);</span>
<span>}</span>

<span>// Create view class
</span><span></span><span>Class</span> <span>c</span> <span>=</span> <span>objc_allocateClassPair</span><span>((</span><span>Class</span><span>)</span><span>cls</span><span>(</span><span>&#34;NSView&#34;</span><span>),</span> <span>&#34;FensterView&#34;</span><span>,</span> <span>0</span><span>);</span>
<span>class_addMethod</span><span>(</span><span>c</span><span>,</span> <span>sel_getUid</span><span>(</span><span>&#34;drawRect:&#34;</span><span>),</span> <span>(</span><span>IMP</span><span>)</span><span>draw_rect</span><span>,</span> <span>&#34;i@:@@&#34;</span><span>);</span>
<span>objc_registerClassPair</span><span>(</span><span>c</span><span>);</span>
<span>// Create view instance and add it to the window
</span><span></span><span>id</span> <span>v</span> <span>=</span> <span>msg</span><span>(</span><span>id</span><span>,</span> <span>msg</span><span>(</span><span>id</span><span>,</span> <span>(</span><span>id</span><span>)</span><span>c</span><span>,</span> <span>&#34;alloc&#34;</span><span>),</span> <span>&#34;init&#34;</span><span>);</span>
<span>msg1</span><span>(</span><span>void</span><span>,</span> <span>wnd</span><span>,</span> <span>&#34;setContentView:&#34;</span><span>,</span> <span>id</span><span>,</span> <span>v</span><span>);</span>
<span>// Later in a loop:
</span><span></span><span>msg1</span><span>(</span><span>void</span><span>,</span> <span>v</span><span>,</span> <span>&#34;setNeedsDisplay:&#34;</span><span>,</span> <span>BOOL</span><span>,</span> <span>YES</span><span>);</span>
</code></pre></div><p>If needed we can override more methods and create a custom delegate class for the window to handle the close button properly and do other nice things.</p><h2 id="hbitmap">HBITMAP</h2><p>On Windows we don’t need a separate child view, but we have to handle <code>WM_PAINT</code> message instead. Inside we would do things exactly like we did on macOS and Linux – we create an <code>HBITMAP</code>, configure information about its pixel format, and send framebuffer data to the canvas. Something like this:</p><div><pre><code data-lang="c"><span>PAINTSTRUCT</span> <span>ps</span><span>;</span>
<span>HDC</span> <span>hdc</span> <span>=</span> <span>BeginPaint</span><span>(</span><span>hwnd</span><span>,</span> <span>&amp;</span><span>ps</span><span>);</span>
<span>HDC</span> <span>memdc</span> <span>=</span> <span>CreateCompatibleDC</span><span>(</span><span>hdc</span><span>);</span>
<span>HBITMAP</span> <span>hbmp</span> <span>=</span> <span>CreateCompatibleBitmap</span><span>(</span><span>hdc</span><span>,</span> <span>width</span><span>,</span> <span>height</span><span>);</span>
<span>HBITMAP</span> <span>oldbmp</span> <span>=</span> <span>SelectObject</span><span>(</span><span>memdc</span><span>,</span> <span>hbmp</span><span>);</span>
<span>BITMAPINFO</span> <span>bi</span> <span>=</span> <span>{{</span><span>sizeof</span><span>(</span><span>bi</span><span>),</span> <span>width</span><span>,</span> <span>-</span><span>height</span><span>,</span> <span>1</span><span>,</span> <span>32</span><span>,</span> <span>BI_BITFIELDS</span><span>}};</span>
<span>bi</span><span>.</span><span>bmiColors</span><span>[</span><span>0</span><span>].</span><span>rgbRed</span> <span>=</span> <span>bi</span><span>.</span><span>bmiColors</span><span>[</span><span>1</span><span>].</span><span>rgbGreen</span> <span>=</span> <span>bi</span><span>.</span><span>bmiColors</span><span>[</span><span>2</span><span>].</span><span>rgbBlue</span> <span>=</span> <span>0xff</span><span>;</span>
<span>SetDIBitsToDevice</span><span>(</span><span>memdc</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>width</span><span>,</span> <span>height</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>height</span><span>,</span> <span>buf</span><span>,</span> <span>(</span><span>BITMAPINFO</span> <span>*</span><span>)</span><span>&amp;</span><span>bi</span><span>,</span> <span>DIB_RGB_COLORS</span><span>);</span>
<span>BitBlt</span><span>(</span><span>hdc</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>width</span><span>,</span> <span>height</span><span>,</span> <span>memdc</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>SRCCOPY</span><span>);</span>
<span>SelectObject</span><span>(</span><span>memdc</span><span>,</span> <span>oldbmp</span><span>);</span>
<span>DeleteObject</span><span>(</span><span>hbmp</span><span>);</span>
<span>DeleteDC</span><span>(</span><span>memdc</span><span>);</span>
<span>EndPaint</span><span>(</span><span>hwnd</span><span>,</span> <span>&amp;</span><span>ps</span><span>);</span>
</code></pre></div><p>Here in the BITMAPINFO initialiser <code>-height</code> is not a typo. According to <a href="https://learn.microsoft.com/en-us/windows/win32/api/wingdi/ns-wingdi-bitmapinfoheader">MSDN</a> negative height values for uncompressed bitmaps mean that the bitmap is filled up from the top to bottom (unlike <a href="https://en.wikipedia.org/wiki/BMP_file_format">BMP format</a> that goes from the bottom to the top).</p><h2 id="user-input">User input</h2><p>Now that we got an app window and a framebuffer working – we can attempt to handle some user input, such as keyboard or mouse. The good news is that we already have an event loop/callback, so all we need is to extend that with a few more “case” statements within a switch.</p><p>For mouse events we’ll only focus on simple things, such as movement (X/Y coordinate of the mouse should be reported) and the left button click. With the presence of touch screens and laptops it’s hard to find a middle mouse button or a horizontal scrolling wheel, anyway.</p><p>For keyboard we will be interested in key presses and releases, as well as some modifier key status. At least we should handle Ctrl and Shift.</p><h2 id="user-input-on-linux">user input on Linux</h2><p>On Linux we first need to adjust our window initialiser to support all the required event types:</p><div><pre><code data-lang="c"><span>XSelectInput</span><span>(</span><span>dpy</span><span>,</span> <span>&gt;</span><span>w</span><span>,</span> <span>ExposureMask</span> <span>|</span> <span>KeyPressMask</span> <span>|</span> <span>KeyReleaseMask</span> <span>|</span> <span>ButtonPressMask</span> <span>|</span> <span>ButtonReleaseMask</span> <span>|</span> <span>PointerMotionMask</span><span>);</span>
</code></pre></div><p>In the event loop we can handle them and extract information from the event structure:</p><div><pre><code data-lang="c"><span>switch</span> <span>(</span><span>ev</span><span>.</span><span>type</span><span>)</span> <span>{</span>
<span>case</span> <span>ButtonPress</span><span>:</span>
<span>case</span> <span>ButtonRelease</span><span>:</span>
  <span>mouse_btn</span> <span>=</span> <span>(</span><span>ev</span><span>.</span><span>type</span> <span>==</span> <span>ButtonPress</span><span>);</span> <span>/* is mouse pressed? */</span>
  <span>break</span><span>;</span>
<span>case</span> <span>MotionNotify</span><span>:</span>
  <span>mouse_x</span> <span>=</span> <span>ev</span><span>.</span><span>xmotion</span><span>.</span><span>x</span><span>;</span> <span>/* read mouse X/Y */</span>
  <span>mouse_y</span> <span>=</span> <span>ev</span><span>.</span><span>xmotion</span><span>.</span><span>y</span><span>;</span>
  <span>break</span><span>;</span>
<span>case</span> <span>KeyPress</span><span>:</span>
<span>case</span> <span>KeyRelease</span><span>:</span> <span>{</span>
  <span>int</span> <span>k</span> <span>=</span> <span>XkbKeycodeToKeysym</span><span>(</span><span>dpy</span><span>,</span> <span>ev</span><span>.</span><span>xkey</span><span>.</span><span>keycode</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>);</span>
  <span>for</span> <span>(</span><span>unsigned</span> <span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>124</span><span>;</span> <span>i</span> <span>+=</span> <span>2</span><span>)</span> <span>{</span>
    <span>/* Map XKB KeySym to our custom key code value */</span>
    <span>if</span> <span>(</span><span>FENSTER_KEYCODES</span><span>[</span><span>i</span><span>]</span> <span>==</span> <span>k</span><span>)</span> <span>{</span>
      <span>keys</span><span>[</span><span>FENSTER_KEYCODES</span><span>[</span><span>i</span> <span>+</span> <span>1</span><span>]]</span> <span>=</span> <span>(</span><span>ev</span><span>.</span><span>type</span> <span>==</span> <span>KeyPress</span><span>);</span>
      <span>break</span><span>;</span>
    <span>}</span>
  <span>}</span>
  <span>/* read keyboard modifiers */</span>
  <span>int</span> <span>m</span> <span>=</span> <span>ev</span><span>.</span><span>xkey</span><span>.</span><span>state</span><span>;</span>
  <span>kbd_mod</span> <span>=</span> <span>(</span><span>!!</span><span>(</span><span>m</span> <span>&amp;</span> <span>ControlMask</span><span>))</span> <span>|</span> <span>(</span><span>!!</span><span>(</span><span>m</span> <span>&amp;</span> <span>ShiftMask</span><span>)</span> <span>&lt;&lt;</span> <span>1</span><span>)</span> <span>|</span>
            <span>(</span><span>!!</span><span>(</span><span>m</span> <span>&amp;</span> <span>Mod1Mask</span><span>)</span> <span>&lt;&lt;</span> <span>2</span><span>)</span> <span>|</span> <span>(</span><span>!!</span><span>(</span><span>m</span> <span>&amp;</span> <span>Mod4Mask</span><span>)</span> <span>&lt;&lt;</span> <span>3</span><span>);</span>
<span>}</span> <span>break</span><span>;</span>
</code></pre></div><p>This is where the ugly part starts. Mouse handling is simple. But for keyboard every platform has its own definitions of “key codes”. To remain cross-platform we would have to map platform-specific keycodes into some common layout.</p><p>Usually, there are several approaches how to pick that common layout. Some choose the “primary” platform and convert key codes from the others, some choose <a href="https://deskthority.net/wiki/Scancode">HID standard</a> (which is really well defined and elegant). I decided to restrict key codes to a small minimal subset, and only use 7-bit ASCII for alphanumeric keys or symbols such as Enter, Backspace, Tab etc. I completely ignored CapsLock and other not-so-common keys. But at least we shall have a key code that can be just printed to see which key it belongs to. For arrows I made an exception and mapped codes 17..20 to them (DC1..DC4 in ASCII set).</p><p>I wasn’t sure if X11 keysym definitions are stable constants on all the systems that support X11, so I put them in an array where ASCII key code follows the X11 keysym, so that a simple for-loop could map one to the other:</p><div><pre><code data-lang="c"><span>static</span> <span>int</span> <span>FENSTER_KEYCODES</span><span>[</span><span>124</span><span>]</span> <span>=</span> <span>{</span><span>XK_BackSpace</span><span>,</span><span>8</span><span>,</span><span>XK_Delete</span><span>,</span><span>127</span><span>,</span><span>XK_Down</span><span>,</span><span>18</span><span>,</span><span>XK_End</span><span>,</span><span>5</span><span>,</span><span>XK_Escape</span><span>,</span><span>27</span><span>,</span><span>XK_Home</span><span>,</span><span>2</span><span>,</span><span>XK_Insert</span><span>,</span><span>26</span><span>,</span><span>XK_Left</span><span>,</span><span>20</span><span>,</span><span>XK_Page_Down</span><span>,</span><span>4</span><span>,</span><span>XK_Page_Up</span><span>,</span><span>3</span><span>,</span><span>XK_Return</span><span>,</span><span>10</span><span>,</span><span>XK_Right</span><span>,</span><span>19</span><span>,</span><span>XK_Tab</span><span>,</span><span>9</span><span>,</span><span>XK_Up</span><span>,</span><span>17</span><span>,</span><span>XK_apostrophe</span><span>,</span><span>39</span><span>,</span><span>XK_backslash</span><span>,</span><span>92</span><span>,</span><span>XK_bracketleft</span><span>,</span><span>91</span><span>,</span><span>XK_bracketright</span><span>,</span><span>93</span><span>,</span><span>XK_comma</span><span>,</span><span>44</span><span>,</span><span>XK_equal</span><span>,</span><span>61</span><span>,</span><span>XK_grave</span><span>,</span><span>96</span><span>,</span><span>XK_minus</span><span>,</span><span>45</span><span>,</span><span>XK_period</span><span>,</span><span>46</span><span>,</span><span>XK_semicolon</span><span>,</span><span>59</span><span>,</span><span>XK_slash</span><span>,</span><span>47</span><span>,</span><span>XK_space</span><span>,</span><span>32</span><span>,</span><span>XK_a</span><span>,</span><span>65</span><span>,</span><span>XK_b</span><span>,</span><span>66</span><span>,</span><span>XK_c</span><span>,</span><span>67</span><span>,</span><span>XK_d</span><span>,</span><span>68</span><span>,</span><span>XK_e</span><span>,</span><span>69</span><span>,</span><span>XK_f</span><span>,</span><span>70</span><span>,</span><span>XK_g</span><span>,</span><span>71</span><span>,</span><span>XK_h</span><span>,</span><span>72</span><span>,</span><span>XK_i</span><span>,</span><span>73</span><span>,</span><span>XK_j</span><span>,</span><span>74</span><span>,</span><span>XK_k</span><span>,</span><span>75</span><span>,</span><span>XK_l</span><span>,</span><span>76</span><span>,</span><span>XK_m</span><span>,</span><span>77</span><span>,</span><span>XK_n</span><span>,</span><span>78</span><span>,</span><span>XK_o</span><span>,</span><span>79</span><span>,</span><span>XK_p</span><span>,</span><span>80</span><span>,</span><span>XK_q</span><span>,</span><span>81</span><span>,</span><span>XK_r</span><span>,</span><span>82</span><span>,</span><span>XK_s</span><span>,</span><span>83</span><span>,</span><span>XK_t</span><span>,</span><span>84</span><span>,</span><span>XK_u</span><span>,</span><span>85</span><span>,</span><span>XK_v</span><span>,</span><span>86</span><span>,</span><span>XK_w</span><span>,</span><span>87</span><span>,</span><span>XK_x</span><span>,</span><span>88</span><span>,</span><span>XK_y</span><span>,</span><span>89</span><span>,</span><span>XK_z</span><span>,</span><span>90</span><span>,</span><span>XK_0</span><span>,</span><span>48</span><span>,</span><span>XK_1</span><span>,</span><span>49</span><span>,</span><span>XK_2</span><span>,</span><span>50</span><span>,</span><span>XK_3</span><span>,</span><span>51</span><span>,</span><span>XK_4</span><span>,</span><span>52</span><span>,</span><span>XK_5</span><span>,</span><span>53</span><span>,</span><span>XK_6</span><span>,</span><span>54</span><span>,</span><span>XK_7</span><span>,</span><span>55</span><span>,</span><span>XK_8</span><span>,</span><span>56</span><span>,</span><span>XK_9</span><span>,</span><span>57</span><span>};</span>
</code></pre></div><h2 id="user-input-on-macos">user input on macOS</h2><p>MacOS comes with a bit less of a surprise for key codes, but is somewhat peculiar in terms of mouse handling – the Y coordinate is inverted. Like in maths, where X axis goes right and Y axis goes up. To keep things compatible with other platforms we have to subtract Y from the window height to get a proper “computer graphics” coordinate system (where Y does down and (0,0) is a top-left corner of the window).</p><p>No changes are required in the initialisation of an app, but the event loop should be changed to handle more event types:</p><div><pre><code data-lang="c"><span>static</span> <span>const</span> <span>uint8_t</span> <span>FENSTER_KEYCODES</span><span>[</span><span>128</span><span>]</span> <span>=</span> <span>{</span><span>65</span><span>,</span><span>83</span><span>,</span><span>68</span><span>,</span><span>70</span><span>,</span><span>72</span><span>,</span><span>71</span><span>,</span><span>90</span><span>,</span><span>88</span><span>,</span><span>67</span><span>,</span><span>86</span><span>,</span><span>0</span><span>,</span><span>66</span><span>,</span><span>81</span><span>,</span><span>87</span><span>,</span><span>69</span><span>,</span><span>82</span><span>,</span><span>89</span><span>,</span><span>84</span><span>,</span><span>49</span><span>,</span><span>50</span><span>,</span><span>51</span><span>,</span><span>52</span><span>,</span><span>54</span><span>,</span><span>53</span><span>,</span><span>61</span><span>,</span><span>57</span><span>,</span><span>55</span><span>,</span><span>45</span><span>,</span><span>56</span><span>,</span><span>48</span><span>,</span><span>93</span><span>,</span><span>79</span><span>,</span><span>85</span><span>,</span><span>91</span><span>,</span><span>73</span><span>,</span><span>80</span><span>,</span><span>10</span><span>,</span><span>76</span><span>,</span><span>74</span><span>,</span><span>39</span><span>,</span><span>75</span><span>,</span><span>59</span><span>,</span><span>92</span><span>,</span><span>44</span><span>,</span><span>47</span><span>,</span><span>78</span><span>,</span><span>77</span><span>,</span><span>46</span><span>,</span><span>9</span><span>,</span><span>32</span><span>,</span><span>96</span><span>,</span><span>8</span><span>,</span><span>0</span><span>,</span><span>27</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>26</span><span>,</span><span>2</span><span>,</span><span>3</span><span>,</span><span>127</span><span>,</span><span>0</span><span>,</span><span>5</span><span>,</span><span>0</span><span>,</span><span>4</span><span>,</span><span>0</span><span>,</span><span>20</span><span>,</span><span>19</span><span>,</span><span>18</span><span>,</span><span>17</span><span>,</span><span>0</span><span>};</span>
<span>NSUInteger</span> <span>evtype</span> <span>=</span> <span>msg</span><span>(</span><span>NSUInteger</span><span>,</span> <span>ev</span><span>,</span> <span>&#34;type&#34;</span><span>);</span>
<span>switch</span> <span>(</span><span>evtype</span><span>)</span> <span>{</span>
<span>case</span> <span>1</span><span>:</span> <span>f</span><span>-&gt;</span><span>mouse</span> <span>|=</span> <span>1</span><span>;</span> <span>return</span> <span>0</span><span>;</span>  <span>/* NSEventTypeMouseDown */</span>
<span>case</span> <span>2</span><span>:</span> <span>f</span><span>-&gt;</span><span>mouse</span> <span>&amp;=</span> <span>~</span><span>1</span><span>;</span> <span>return</span> <span>0</span><span>;</span> <span>/* NSEventTypeMouseUp*/</span>
<span>case</span> <span>5</span><span>:</span> <span>case</span> <span>6</span><span>:</span> <span>{</span> <span>/* NSEventTypeMouseMoved */</span>
  <span>CGPoint</span> <span>xy</span> <span>=</span> <span>msg</span><span>(</span><span>CGPoint</span><span>,</span> <span>ev</span><span>,</span> <span>&#34;locationInWindow&#34;</span><span>);</span>
  <span>f</span><span>-&gt;</span><span>x</span> <span>=</span> <span>(</span><span>int</span><span>)</span><span>xy</span><span>.</span><span>x</span><span>;</span>
  <span>f</span><span>-&gt;</span><span>y</span> <span>=</span> <span>(</span><span>int</span><span>)(</span><span>f</span><span>-&gt;</span><span>height</span> <span>-</span> <span>xy</span><span>.</span><span>y</span><span>);</span>
  <span>return</span> <span>0</span><span>;</span>
<span>}</span>
<span>case</span> <span>10</span><span>:</span> <span>case</span> <span>11</span><span>:</span> <span>{</span> <span>/*NSEventTypeKeyDown, NSEventTypeKeyUp:*/</span>
  <span>NSUInteger</span> <span>k</span> <span>=</span> <span>msg</span><span>(</span><span>NSUInteger</span><span>,</span> <span>ev</span><span>,</span> <span>&#34;keyCode&#34;</span><span>);</span>
  <span>f</span><span>-&gt;</span><span>keys</span><span>[</span><span>k</span> <span>&lt;</span> <span>127</span> <span>?</span> <span>FENSTER_KEYCODES</span><span>[</span><span>k</span><span>]</span> <span>:</span> <span>0</span><span>]</span> <span>=</span> <span>evtype</span> <span>==</span> <span>10</span><span>;</span>
  <span>NSUInteger</span> <span>mod</span> <span>=</span> <span>msg</span><span>(</span><span>NSUInteger</span><span>,</span> <span>ev</span><span>,</span> <span>&#34;modifierFlags&#34;</span><span>)</span> <span>&gt;&gt;</span> <span>17</span><span>;</span>
  <span>f</span><span>-&gt;</span><span>mod</span> <span>=</span> <span>(</span><span>mod</span> <span>&amp;</span> <span>0xc</span><span>)</span> <span>|</span> <span>((</span><span>mod</span> <span>&amp;</span> <span>1</span><span>)</span> <span>&lt;&lt;</span> <span>1</span><span>)</span> <span>|</span> <span>((</span><span>mod</span> <span>&gt;&gt;</span> <span>1</span><span>)</span> <span>&amp;</span> <span>1</span><span>);</span>
  <span>return</span> <span>0</span><span>;</span>
<span>}</span>
<span>}</span>
</code></pre></div><p>On macOS the key codes are known constants, so we can define a lookup-table to convert them to the ASCII symbols. We have to handle two separate move events – one for the left mouse button being pressed (“drag”) and another for a regular move with a mouse button released. The rest should be self-explanatory.</p><h2 id="user-input-on-windows">user input on windows</h2><p>Finally, WinAPI comes with very convenient <code>WM_</code> message types that we can handle in the most straightforward way inside our WndProc:</p><div><pre><code data-lang="c"><span>static</span> <span>const</span> <span>uint8_t</span> <span>FENSTER_KEYCODES</span><span>[]</span> <span>=</span> <span>{</span><span>0</span><span>,</span><span>27</span><span>,</span><span>49</span><span>,</span><span>50</span><span>,</span><span>51</span><span>,</span><span>52</span><span>,</span><span>53</span><span>,</span><span>54</span><span>,</span><span>55</span><span>,</span><span>56</span><span>,</span><span>57</span><span>,</span><span>48</span><span>,</span><span>45</span><span>,</span><span>61</span><span>,</span><span>8</span><span>,</span><span>9</span><span>,</span><span>81</span><span>,</span><span>87</span><span>,</span><span>69</span><span>,</span><span>82</span><span>,</span><span>84</span><span>,</span><span>89</span><span>,</span><span>85</span><span>,</span><span>73</span><span>,</span><span>79</span><span>,</span><span>80</span><span>,</span><span>91</span><span>,</span><span>93</span><span>,</span><span>10</span><span>,</span><span>0</span><span>,</span><span>65</span><span>,</span><span>83</span><span>,</span><span>68</span><span>,</span><span>70</span><span>,</span><span>71</span><span>,</span><span>72</span><span>,</span><span>74</span><span>,</span><span>75</span><span>,</span><span>76</span><span>,</span><span>59</span><span>,</span><span>39</span><span>,</span><span>96</span><span>,</span><span>0</span><span>,</span><span>92</span><span>,</span><span>90</span><span>,</span><span>88</span><span>,</span><span>67</span><span>,</span><span>86</span><span>,</span><span>66</span><span>,</span><span>78</span><span>,</span><span>77</span><span>,</span><span>44</span><span>,</span><span>46</span><span>,</span><span>47</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>32</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>2</span><span>,</span><span>17</span><span>,</span><span>3</span><span>,</span><span>0</span><span>,</span><span>20</span><span>,</span><span>0</span><span>,</span><span>19</span><span>,</span><span>0</span><span>,</span><span>5</span><span>,</span><span>18</span><span>,</span><span>4</span><span>,</span><span>26</span><span>,</span><span>127</span><span>};</span>
<span>...</span>
<span>case</span> <span>WM_LBUTTONDOWN</span><span>:</span> <span>case</span> <span>WM_LBUTTONUP</span><span>:</span> <span>f</span><span>-&gt;</span><span>mouse</span> <span>=</span> <span>(</span><span>msg</span> <span>==</span> <span>WM_LBUTTONDOWN</span><span>);</span> <span>break</span><span>;</span>
<span>case</span> <span>WM_MOUSEMOVE</span><span>:</span> <span>f</span><span>-&gt;</span><span>y</span> <span>=</span> <span>HIWORD</span><span>(</span><span>lParam</span><span>);</span> <span>f</span><span>-&gt;</span><span>x</span> <span>=</span> <span>LOWORD</span><span>(</span><span>lParam</span><span>);</span> <span>break</span><span>;</span>
<span>case</span> <span>WM_KEYDOWN</span><span>:</span> <span>case</span> <span>WM_KEYUP</span><span>:</span> <span>{</span>
  <span>f</span><span>-&gt;</span><span>mod</span> <span>=</span> <span>((</span><span>GetKeyState</span><span>(</span><span>VK_CONTROL</span><span>)</span> <span>&amp;</span> <span>0x8000</span><span>)</span> <span>&gt;&gt;</span> <span>15</span><span>)</span> <span>|</span>
           <span>((</span><span>GetKeyState</span><span>(</span><span>VK_SHIFT</span><span>)</span> <span>&amp;</span> <span>0x8000</span><span>)</span> <span>&gt;&gt;</span> <span>14</span><span>)</span> <span>|</span>
           <span>((</span><span>GetKeyState</span><span>(</span><span>VK_MENU</span><span>)</span> <span>&amp;</span> <span>0x8000</span><span>)</span> <span>&gt;&gt;</span> <span>13</span><span>)</span> <span>|</span>
           <span>(((</span><span>GetKeyState</span><span>(</span><span>VK_LWIN</span><span>)</span> <span>|</span> <span>GetKeyState</span><span>(</span><span>VK_RWIN</span><span>))</span> <span>&amp;</span> <span>0x8000</span><span>)</span> <span>&gt;&gt;</span> <span>12</span><span>);</span>
  <span>f</span><span>-&gt;</span><span>keys</span><span>[</span><span>FENSTER_KEYCODES</span><span>[</span><span>HIWORD</span><span>(</span><span>lParam</span><span>)</span> <span>&amp;</span> <span>0x1ff</span><span>]]</span> <span>=</span> <span>!</span><span>((</span><span>lParam</span> <span>&gt;&gt;</span> <span>31</span><span>)</span> <span>&amp;</span> <span>1</span><span>);</span>
<span>}</span> <span>break</span><span>;</span>
</code></pre></div><p>We’re done here. Inside the main event loop on all three platforms users can now check for <code>x</code>/<code>y</code> coordinates, <code>mouse</code> flag, a <code>mod</code> bitmask and <code>keys</code> status array.</p><h2 id="timers-and-fps">Timers and FPS</h2><p>Since different computers have different performance it’s a common practice to limit the rate at which the frames are refreshed. Usually, an FPS=60 (i.e. 60 frames per second, or 16.6ms per frame) is used. To restrict our event loop from rendering and polling things faster than that we would need two functions: one to return the current time (at least in milliseconds) and another to sleep for the given amount of time.</p><p>Since both macOS and Linux have some POSIX compatibility we can reuse the same code:</p><div><pre><code data-lang="c"><span>void</span> <span>fenster_sleep</span><span>(</span><span>int64_t</span> <span>ms</span><span>)</span> <span>{</span>
  <span>struct</span> <span>timespec</span> <span>ts</span><span>;</span>
  <span>ts</span><span>.</span><span>tv_sec</span> <span>=</span> <span>ms</span> <span>/</span> <span>1000</span><span>;</span>
  <span>ts</span><span>.</span><span>tv_nsec</span> <span>=</span> <span>(</span><span>ms</span> <span>%</span> <span>1000</span><span>)</span> <span>*</span> <span>1000000</span><span>;</span>
  <span>nanosleep</span><span>(</span><span>&amp;</span><span>ts</span><span>,</span> <span>NULL</span><span>);</span>
<span>}</span>
<span>int64_t</span> <span>fenster_time</span><span>()</span> <span>{</span>
  <span>struct</span> <span>timespec</span> <span>time</span><span>;</span>
  <span>clock_gettime</span><span>(</span><span>CLOCK_REALTIME</span><span>,</span> <span>&amp;</span><span>time</span><span>);</span>
  <span>return</span> <span>time</span><span>.</span><span>tv_sec</span> <span>*</span> <span>1000</span> <span>+</span> <span>(</span><span>time</span><span>.</span><span>tv_nsec</span> <span>/</span> <span>1000000</span><span>);</span>
<span>}</span>
</code></pre></div><p>Windows, on the other hand, is special, but nevertheless very convenient:</p><div><pre><code data-lang="c"><span>void</span> <span>fenster_sleep</span><span>(</span><span>int64_t</span> <span>ms</span><span>)</span> <span>{</span> <span>Sleep</span><span>(</span><span>ms</span><span>);</span> <span>}</span>
<span>int64_t</span> <span>fenster_time</span><span>()</span> <span>{</span>
  <span>LARGE_INTEGER</span> <span>freq</span><span>,</span> <span>count</span><span>;</span>
  <span>QueryPerformanceFrequency</span><span>(</span><span>&amp;</span><span>freq</span><span>);</span>
  <span>QueryPerformanceCounter</span><span>(</span><span>&amp;</span><span>count</span><span>);</span>
  <span>return</span> <span>(</span><span>int64_t</span><span>)(</span><span>count</span><span>.</span><span>QuadPart</span> <span>*</span> <span>1000.0</span> <span>/</span> <span>freq</span><span>.</span><span>QuadPart</span><span>);</span>
<span>}</span>
</code></pre></div><p>A typical application structure for our library would look like this (you can use an up-to-date “fenster.h” from <a href="https://github.com/zserge/fenster):">https://github.com/zserge/fenster):</a></p><div><pre><code data-lang="c"><span>#include</span> <span>&#34;fenster.h&#34;</span><span>
</span><span></span>
<span>int</span> <span>main</span><span>()</span> <span>{</span>
  <span>uint32_t</span> <span>fb</span><span>[</span><span>320</span><span>*</span><span>240</span><span>]</span> <span>=</span> <span>{</span><span>0</span><span>};</span>
  <span>struct</span> <span>fenster</span> <span>f</span> <span>=</span> <span>{</span> <span>.</span><span>width</span> <span>=</span> <span>320</span><span>,</span> <span>.</span><span>height</span> <span>=</span> <span>240</span><span>,</span> <span>.</span><span>title</span> <span>=</span> <span>&#34;hello&#34;</span><span>,</span> <span>.</span><span>buf</span> <span>=</span> <span>fb</span> <span>};</span>
  <span>fenster_open</span><span>(</span><span>&amp;</span><span>f</span><span>);</span>
  <span>int64_t</span> <span>now</span> <span>=</span> <span>fenster_time</span><span>();</span>
  <span>while</span> <span>(</span><span>fenster_loop</span><span>(</span><span>&amp;</span><span>f</span><span>)</span> <span>==</span> <span>0</span><span>)</span> <span>{</span>
    <span>/* handle f.keys, f.mod, f.x, f.y, f.mouse */</span>
    <span>/* update framebuffer &#34;fb&#34; */</span>
    <span>/* limit FPS to 60 frames per second */</span>
    <span>uint64_t</span> <span>ms</span> <span>=</span> <span>now</span> <span>+</span> <span>(</span><span>1000</span><span>/</span><span>60</span><span>)</span> <span>-</span> <span>fenster_time</span><span>();</span>
    <span>if</span> <span>(</span><span>ms</span> <span>&gt;</span> <span>0</span><span>)</span> <span>fenster_sleep</span><span>(</span><span>ms</span><span>);</span>
    <span>now</span> <span>=</span> <span>fenster_time</span><span>();</span>
  <span>}</span>
  <span>fenster_close</span><span>(</span><span>&amp;</span><span>f</span><span>);</span>
<span>}</span>
</code></pre></div><p>So far so good. Clear, cross-platform app loop. But how can we actually draw anything?</p><h2 id="drawing-primitives">Drawing primitives</h2><p>Having a cross-platform framebuffer is convenient, but how we can turn it into a <em>canvas</em>?</p><p>Let’s start with drawing pixels. Since a framebuffer is essentially an array of pixels – we can introduce a macro to access an individual pixel:</p><div><pre><code data-lang="c"><span>#define fenster_pixel(f, x, y) ((f)-&gt;buf[((y) * (f)-&gt;width) + (x)])
</span><span></span>
<span>struct</span> <span>fenster</span> <span>f</span> <span>=</span> <span>...</span>
<span>fenster_pixel</span><span>(</span><span>&amp;</span><span>f</span><span>,</span> <span>25</span><span>,</span> <span>40</span><span>)</span> <span>=</span> <span>0xff0000</span><span>;</span> <span>/* pixel at (25,40) is now red */</span>
<span>uint32_t</span> <span>rgb</span> <span>=</span> <span>fenster_pixel</span><span>(</span><span>&amp;</span><span>f</span><span>,</span> <span>10</span><span>,</span> <span>10</span><span>);</span>   <span>/* get pixel colour at (10,10) */</span>
</code></pre></div><p>Next simple task would be to fill the complete framebuffer with a solid colour:</p><div><pre><code data-lang="c"><span>memset</span><span>(</span><span>f</span><span>-&gt;</span><span>buf</span><span>,</span> <span>rgb</span><span>,</span> <span>f</span><span>-&gt;</span><span>width</span><span>*</span><span>f</span><span>-&gt;</span><span>height</span><span>*</span><span>sizeoof</span><span>(</span><span>uint32_t</span><span>));</span>
</code></pre></div><p>Drawing rectangles isn’t that complicated either:</p><div><pre><code data-lang="c"><span>void</span> <span>fenster_rect</span><span>(</span><span>struct</span> <span>fenster</span> <span>*</span><span>f</span><span>,</span> <span>int</span> <span>x</span><span>,</span> <span>int</span> <span>y</span><span>,</span> <span>int</span> <span>w</span><span>,</span> <span>int</span> <span>h</span><span>,</span> <span>uint32_t</span> <span>c</span><span>)</span> <span>{</span>
  <span>for</span> <span>(</span><span>int</span> <span>row</span> <span>=</span> <span>0</span><span>;</span> <span>row</span> <span>&lt;</span> <span>h</span><span>;</span> <span>row</span><span>++</span><span>)</span>
    <span>for</span> <span>(</span><span>int</span> <span>col</span> <span>=</span> <span>0</span><span>;</span> <span>col</span> <span>&lt;</span> <span>w</span><span>;</span> <span>col</span><span>++</span><span>)</span>
      <span>fenster_pixel</span><span>(</span><span>f</span><span>,</span> <span>x</span> <span>+</span> <span>col</span><span>,</span> <span>y</span> <span>+</span> <span>row</span><span>)</span> <span>=</span> <span>c</span><span>;</span>
<span>}</span>
</code></pre></div><p>To draw a circle we can use a simple algorithm that checks for every pixel within the square where the circle is inscribed. If a circle radius squared is less than the sum of dx/dy squared (basic school math) – the pixel belongs to the circle and should be painted:</p><div><pre><code data-lang="c"><span>void</span> <span>fenster_circle</span><span>(</span><span>struct</span> <span>fenster</span> <span>*</span><span>f</span><span>,</span> <span>int</span> <span>x</span><span>,</span> <span>int</span> <span>y</span><span>,</span> <span>int</span> <span>r</span><span>,</span> <span>uint32_t</span> <span>c</span><span>)</span> <span>{</span>
  <span>for</span> <span>(</span><span>int</span> <span>dy</span> <span>=</span> <span>-</span><span>r</span><span>;</span> <span>dy</span> <span>&lt;=</span> <span>r</span><span>;</span> <span>dy</span><span>++</span><span>)</span>
    <span>for</span> <span>(</span><span>int</span> <span>dx</span> <span>=</span> <span>-</span><span>r</span><span>;</span> <span>dx</span> <span>&lt;=</span> <span>r</span><span>;</span> <span>dx</span><span>++</span><span>)</span>
      <span>if</span> <span>(</span><span>dx</span> <span>*</span> <span>dx</span> <span>+</span> <span>dy</span> <span>*</span> <span>dy</span> <span>&lt;=</span> <span>r</span> <span>*</span> <span>r</span><span>)</span>
        <span>fenster_pixel</span><span>(</span><span>f</span><span>,</span> <span>x</span> <span>+</span> <span>dx</span><span>,</span> <span>y</span> <span>+</span> <span>dy</span><span>)</span> <span>=</span> <span>c</span><span>;</span>
<span>}</span>
</code></pre></div><p>To draw a line we can use <a href="https://en.wikipedia.org/wiki/Bresenham%27s_line_algorithm">Bresenham’s algorithm</a>, a well-known classic:</p><div><pre><code data-lang="c"><span>void</span> <span>fenster_line</span><span>(</span><span>struct</span> <span>fenster</span> <span>*</span><span>f</span><span>,</span> <span>int</span> <span>x0</span><span>,</span> <span>int</span> <span>y0</span><span>,</span> <span>int</span> <span>x1</span><span>,</span> <span>int</span> <span>y1</span><span>,</span> <span>uint32_t</span> <span>c</span><span>)</span> <span>{</span>
  <span>int</span> <span>dx</span> <span>=</span> <span>abs</span><span>(</span><span>x1</span> <span>-</span> <span>x0</span><span>),</span> <span>sx</span> <span>=</span> <span>x0</span> <span>&lt;</span> <span>x1</span> <span>?</span> <span>1</span> <span>:</span> <span>-</span><span>1</span><span>;</span>
  <span>int</span> <span>dy</span> <span>=</span> <span>abs</span><span>(</span><span>y1</span> <span>-</span> <span>y0</span><span>),</span> <span>sy</span> <span>=</span> <span>y0</span> <span>&lt;</span> <span>y1</span> <span>?</span> <span>1</span> <span>:</span> <span>-</span><span>1</span><span>;</span>
  <span>int</span> <span>err</span> <span>=</span> <span>(</span><span>dx</span> <span>&gt;</span> <span>dy</span> <span>?</span> <span>dx</span> <span>:</span> <span>-</span><span>dy</span><span>)</span> <span>/</span> <span>2</span><span>,</span> <span>e2</span><span>;</span>
  <span>for</span> <span>(;;)</span> <span>{</span>
    <span>fenster_pixel</span><span>(</span><span>f</span><span>,</span> <span>x0</span><span>,</span> <span>y0</span><span>)</span> <span>=</span> <span>c</span><span>;</span>
    <span>if</span> <span>(</span><span>x0</span> <span>==</span> <span>x1</span> <span>&amp;&amp;</span> <span>y0</span> <span>==</span> <span>y1</span><span>)</span> <span>break</span><span>;</span>
    <span>e2</span> <span>=</span> <span>err</span><span>;</span>
    <span>if</span> <span>(</span><span>e2</span> <span>&gt;</span> <span>-</span><span>dx</span><span>)</span> <span>{</span> <span>err</span> <span>-=</span> <span>dy</span><span>;</span> <span>x0</span> <span>+=</span> <span>sx</span><span>;</span> <span>}</span>
    <span>if</span> <span>(</span><span>e2</span> <span>&lt;</span> <span>dy</span><span>)</span>  <span>{</span> <span>err</span> <span>+=</span> <span>dx</span><span>;</span> <span>y0</span> <span>+=</span> <span>sy</span><span>;</span> <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div><p>Having this we can now draw complex polygons and would probably need a “flood fill” algorithm. Typically it is implemented using a queue of pixels to check and paint, but we can use recursion, as long as the filled area remains small enough to not overflow the stack:</p><div><pre><code data-lang="c"><span>void</span> <span>fenster_fill</span><span>(</span><span>struct</span> <span>fenster</span> <span>*</span><span>f</span><span>,</span> <span>int</span> <span>x</span><span>,</span> <span>int</span> <span>y</span><span>,</span> <span>uint32_t</span> <span>old</span><span>,</span> <span>uint32_t</span> <span>c</span><span>)</span> <span>{</span>
  <span>if</span> <span>(</span><span>x</span> <span>&lt;</span> <span>0</span> <span>||</span> <span>y</span> <span>&lt;</span> <span>0</span> <span>||</span> <span>x</span> <span>&gt;=</span> <span>f</span><span>-&gt;</span><span>width</span> <span>||</span> <span>y</span> <span>&gt;=</span> <span>f</span><span>-&gt;</span><span>height</span><span>)</span> <span>return</span><span>;</span>
  <span>if</span> <span>(</span><span>fenster_pixel</span><span>(</span><span>f</span><span>,</span> <span>x</span><span>,</span> <span>y</span><span>)</span> <span>==</span> <span>old</span><span>)</span> <span>{</span>
    <span>fenster_pixel</span><span>(</span><span>f</span><span>,</span> <span>x</span><span>,</span> <span>y</span><span>)</span> <span>=</span> <span>c</span><span>;</span>
    <span>fenster_fill</span><span>(</span><span>f</span><span>,</span> <span>x</span> <span>-</span> <span>1</span><span>,</span> <span>y</span><span>,</span> <span>old</span><span>,</span> <span>c</span><span>);</span>
    <span>fenster_fill</span><span>(</span><span>f</span><span>,</span> <span>x</span> <span>+</span> <span>1</span><span>,</span> <span>y</span><span>,</span> <span>old</span><span>,</span> <span>c</span><span>);</span>
    <span>fenster_fill</span><span>(</span><span>f</span><span>,</span> <span>x</span><span>,</span> <span>y</span> <span>-</span> <span>1</span><span>,</span> <span>old</span><span>,</span> <span>c</span><span>);</span>
    <span>fenster_fill</span><span>(</span><span>f</span><span>,</span> <span>x</span><span>,</span> <span>y</span> <span>+</span> <span>1</span><span>,</span> <span>old</span><span>,</span> <span>c</span><span>);</span>
  <span>}</span>
<span>}</span>
</code></pre></div><p>Last but not least, let’s try to print some text on screen! To go truly old-school we will be using a bitmap font. In other words, our font is an array where each element corresponds to an ASCII character and describes which pixels in a glyph grid to colourise to make it look like a letter.</p><p>I’ve picked the smallest possible readable bitmap font where each letter is 5 pixels tall and 3 pixels wide (even though I’ve previously tried to create <a href="https://zserge.com/posts/tiny-font/">much smaller fonts</a> that are not so readable at all).</p><p>To encode the 5x3 font we can use one <code>uint16_t</code> per glyph. For example, here’s letters “A” and “B”:</p><div><pre><code data-lang="fallback">  #    010  | # #    110   A=101 1111 0111 1010
# # #  111  | #   #  101    =0x5f7a
#   #  101  | # # #  111   B=011 1011 1110 1011
# # #  111  | #   #  101    =0x3beb
#   #  101  | # #    110
</code></pre></div><p>If we treat every glyph as a sequence of bits counting from the top left corner we get <code>010111101111101</code> for “A”. But bits in numbers are usually numbered right-to-left, so we should reverse it and get <code>101111101111010</code>. Splitting this into octets and converting them to hexadecimal form would give us <code>0x5F7A</code>. Now, how to draw such a glyph?</p><div><pre><code data-lang="c"><span>static</span> <span>uint16_t</span> <span>font5x3</span><span>[]</span> <span>=</span> <span>{</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0x2092</span><span>,</span><span>0x2d</span><span>,</span><span>0x5f7d</span><span>,</span><span>0x279e</span><span>,</span><span>0x52a5</span><span>,</span><span>0x7ad6</span><span>,</span><span>0x12</span><span>,</span><span>0x4494</span><span>,</span><span>0x1491</span><span>,</span><span>0x17a</span><span>,</span><span>0x5d0</span><span>,</span><span>0x1400</span><span>,</span><span>0x1c0</span><span>,</span><span>0x400</span><span>,</span><span>0x12a4</span><span>,</span><span>0x2b6a</span><span>,</span><span>0x749a</span><span>,</span><span>0x752a</span><span>,</span><span>0x38a3</span><span>,</span><span>0x4f4a</span><span>,</span><span>0x38cf</span><span>,</span><span>0x3bce</span><span>,</span><span>0x12a7</span><span>,</span><span>0x3aae</span><span>,</span><span>0x49ae</span><span>,</span><span>0x410</span><span>,</span><span>0x1410</span><span>,</span><span>0x4454</span><span>,</span><span>0xe38</span><span>,</span><span>0x1511</span><span>,</span><span>0x10e3</span><span>,</span><span>0x73ee</span><span>,</span><span>0x5f7a</span><span>,</span><span>0x3beb</span><span>,</span><span>0x624e</span><span>,</span><span>0x3b6b</span><span>,</span><span>0x73cf</span><span>,</span><span>0x13cf</span><span>,</span><span>0x6b4e</span><span>,</span><span>0x5bed</span><span>,</span><span>0x7497</span><span>,</span><span>0x2b27</span><span>,</span><span>0x5add</span><span>,</span><span>0x7249</span><span>,</span><span>0x5b7d</span><span>,</span><span>0x5b6b</span><span>,</span><span>0x3b6e</span><span>,</span><span>0x12eb</span><span>,</span><span>0x4f6b</span><span>,</span><span>0x5aeb</span><span>,</span><span>0x388e</span><span>,</span><span>0x2497</span><span>,</span><span>0x6b6d</span><span>,</span><span>0x256d</span><span>,</span><span>0x5f6d</span><span>,</span><span>0x5aad</span><span>,</span><span>0x24ad</span><span>,</span><span>0x72a7</span><span>,</span><span>0x6496</span><span>,</span><span>0x4889</span><span>,</span><span>0x3493</span><span>,</span><span>0x2a</span><span>,</span><span>0xf000</span><span>,</span><span>0x11</span><span>,</span><span>0x6b98</span><span>,</span><span>0x3b79</span><span>,</span><span>0x7270</span><span>,</span><span>0x7b74</span><span>,</span><span>0x6750</span><span>,</span><span>0x95d6</span><span>,</span><span>0xb9ee</span><span>,</span><span>0x5b59</span><span>,</span><span>0x6410</span><span>,</span><span>0xb482</span><span>,</span><span>0x56e8</span><span>,</span><span>0x6492</span><span>,</span><span>0x5be8</span><span>,</span><span>0x5b58</span><span>,</span><span>0x3b70</span><span>,</span><span>0x976a</span><span>,</span><span>0xcd6a</span><span>,</span><span>0x1370</span><span>,</span><span>0x38f0</span><span>,</span><span>0x64ba</span><span>,</span><span>0x3b68</span><span>,</span><span>0x2568</span><span>,</span><span>0x5f68</span><span>,</span><span>0x54a8</span><span>,</span><span>0xb9ad</span><span>,</span><span>0x73b8</span><span>,</span><span>0x64d6</span><span>,</span><span>0x2492</span><span>,</span><span>0x3593</span><span>,</span><span>0x3e0</span><span>};</span>
<span>static</span> <span>void</span> <span>fenster_text</span><span>(</span><span>struct</span> <span>fenster</span> <span>*</span><span>f</span><span>,</span> <span>int</span> <span>x</span><span>,</span> <span>int</span> <span>y</span><span>,</span> <span>char</span> <span>*</span><span>s</span><span>,</span> <span>int</span> <span>scale</span><span>,</span> <span>uint32_t</span> <span>c</span><span>)</span> <span>{</span>
  <span>while</span> <span>(</span><span>*</span><span>s</span><span>)</span> <span>{</span>
    <span>int</span> <span>chr</span> <span>=</span> <span>*</span><span>s</span><span>++</span><span>;</span>
    <span>for</span> <span>(</span><span>int</span> <span>dy</span> <span>=</span> <span>0</span><span>;</span> <span>dy</span> <span>&lt;</span> <span>5</span><span>;</span> <span>dy</span><span>++</span><span>)</span>
      <span>for</span> <span>(</span><span>int</span> <span>dx</span> <span>=</span> <span>0</span><span>;</span> <span>dx</span> <span>&lt;</span> <span>3</span><span>;</span> <span>dx</span><span>++</span><span>)</span>
        <span>if</span> <span>(</span><span>font5x3</span><span>[</span><span>chr</span><span>]</span> <span>&gt;&gt;</span> <span>(</span><span>dy</span> <span>*</span> <span>3</span> <span>+</span> <span>dx</span><span>)</span> <span>&amp;</span> <span>1</span><span>)</span>
          <span>fenster_rect</span><span>(</span><span>f</span><span>,</span> <span>x</span> <span>+</span> <span>dx</span> <span>*</span> <span>scale</span><span>,</span> <span>y</span> <span>+</span> <span>dy</span> <span>*</span> <span>scale</span><span>,</span> <span>scale</span><span>,</span> <span>scale</span><span>,</span> <span>c</span><span>);</span>
    <span>x</span> <span>=</span> <span>x</span> <span>+</span> <span>4</span> <span>*</span> <span>scale</span><span>;</span>
  <span>}</span>
<span>}</span>
</code></pre></div><p>And we are finally ready to create some visual masterpieces:</p><p><img src="https://notebook.wesleyac.com/images/fenster-house.png" alt="fenster-screenshot"/></p><h2 id="sound">Sound</h2><p>We carry on. So far we’ve conquered main app loop, framebuffer/canvas and user input. But why do it all in silence? Can we add some audio playback?</p><p>Audio can be very complicated, and low-level audio even more so. But if we only focus on the most basic use cases – like, play a mono stream of floating-point audio samples – we can make it work rather easily on most of the computers.</p><p>It’s quite a safe bet to choose ALSA for Linux (since it’s part of the kernel), WinMM for WinAPI (as it’s been there for ages) and CoreAudio for macOS.</p><p>Many audio libraries choose a callback API model to give user more control over the latency and buffering. In our case, to keep the simplicity of the polling loop from the above let’s choose the synchronous “streaming” approach. We would need to implement 4 functions:</p><ul><li>One to open the default audio device.</li><li>Another to close it.</li><li>One to get the number of available samples to be written into the audio stream.</li><li>Another to actually write them.</li></ul><p>The implementation should guarantee that any attempt to write a buffer of samples not longer than the available number – it will not block. Then the caller should check the available count, take care of rendering/mixing sound and writing that part of the buffer.</p><p>ALSA implementation would be the simplest of them all:</p><div><pre><code data-lang="c"><span>int</span> <span>fenster_audio_open</span><span>(</span><span>struct</span> <span>fenster_audio</span> <span>*</span><span>fa</span><span>)</span> <span>{</span>
  <span>if</span> <span>(</span><span>snd_pcm_open</span><span>(</span><span>&amp;</span><span>fa</span><span>-&gt;</span><span>pcm</span><span>,</span> <span>&#34;default&#34;</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>))</span> <span>return</span> <span>-</span><span>1</span><span>;</span>
  <span>int</span> <span>fmt</span> <span>=</span> <span>(</span><span>*</span><span>(</span><span>unsigned</span> <span>char</span> <span>*</span><span>)(</span><span>&amp;</span><span>(</span><span>uint16_t</span><span>){</span><span>1</span><span>}))</span> <span>?</span> <span>14</span> <span>:</span> <span>15</span><span>;</span>
  <span>return</span> <span>snd_pcm_set_params</span><span>(</span><span>fa</span><span>-&gt;</span><span>pcm</span><span>,</span> <span>fmt</span><span>,</span> <span>3</span><span>,</span> <span>1</span><span>,</span> <span>FENSTER_SAMPLE_RATE</span><span>,</span> <span>1</span><span>,</span> <span>100000</span><span>);</span>
<span>}</span>
<span>int</span> <span>fenster_audio_available</span><span>(</span><span>struct</span> <span>fenster_audio</span> <span>*</span><span>fa</span><span>)</span> <span>{</span>
  <span>int</span> <span>n</span> <span>=</span> <span>snd_pcm_avail</span><span>(</span><span>fa</span><span>-&gt;</span><span>pcm</span><span>);</span>
  <span>if</span> <span>(</span><span>n</span> <span>&lt;</span> <span>0</span><span>)</span> <span>snd_pcm_recover</span><span>(</span><span>fa</span><span>-&gt;</span><span>pcm</span><span>,</span> <span>n</span><span>,</span> <span>0</span><span>);</span>
  <span>return</span> <span>n</span><span>;</span>
<span>}</span>
<span>void</span> <span>fenster_audio_write</span><span>(</span><span>struct</span> <span>fenster_audio</span> <span>*</span><span>fa</span><span>,</span> <span>float</span> <span>*</span><span>buf</span><span>,</span> <span>size_t</span> <span>n</span><span>)</span> <span>{</span>
  <span>int</span> <span>r</span> <span>=</span> <span>snd_pcm_writei</span><span>(</span><span>fa</span><span>-&gt;</span><span>pcm</span><span>,</span> <span>buf</span><span>,</span> <span>n</span><span>);</span>
  <span>if</span> <span>(</span><span>r</span> <span>&lt;</span> <span>0</span><span>)</span> <span>snd_pcm_recover</span><span>(</span><span>fa</span><span>-&gt;</span><span>pcm</span><span>,</span> <span>r</span><span>,</span> <span>0</span><span>);</span>
<span>}</span>
<span>void</span> <span>fenster_audio_close</span><span>(</span><span>struct</span> <span>fenster_audio</span> <span>*</span><span>fa</span><span>)</span> <span>{</span> <span>snd_pcm_close</span><span>(</span><span>fa</span><span>-&gt;</span><span>pcm</span><span>);</span> <span>}</span>
</code></pre></div><p>On macOS and WinAPI we would have to use double-buffering technique, where multiple audio buffer objects are created and chained for the playback, and as soon as the first one is done – the next one continues the playback, while the first one is being fulfilled with the following audio samples.</p><p>I wouldn’t post all of the code here, but you can check it out <a href="https://github.com/zserge/fenster">on Github</a>.</p><h2 id="bindings">Bindings</h2><p>C is a nice small language, but for quick prototyping maybe some other, less archaic languages could fit better.</p><p>There are Go bindings using CGo and the library can be imported like a normal Go module. @dim13 has offerred a few adjustments to the API so that our framebuffer is available as a standard <code>image.Image</code> interface. This enables compatibility with many other libraries, such as <a href="https://github.com/fogleman/gg">https://github.com/fogleman/gg</a> or <a href="https://github.com/llgcode/draw2d">https://github.com/llgcode/draw2d</a>.</p><p>Other bindings that were trivial to write were in Zig. In fact, Zig so well integrates with C code that it can use Fenster library directly:</p><div><pre><code data-lang="zig"><span>const</span><span> </span><span>std</span><span> </span><span>=</span><span> </span><span>@import</span><span>(</span><span>&#34;std&#34;</span><span>);</span><span>
</span><span></span><span>const</span><span> </span><span>c</span><span> </span><span>=</span><span> </span><span>@cImport</span><span>({</span><span>
</span><span>    </span><span>@cInclude</span><span>(</span><span>&#34;fenster.h&#34;</span><span>);</span><span>
</span><span></span><span>});</span><span>
</span><span>
</span><span></span><span>pub</span><span> </span><span>fn</span><span> </span><span>main</span><span>()</span><span> </span><span>void</span><span> </span><span>{</span><span>
</span><span>    </span><span>var</span><span> </span><span>buf</span><span>:</span><span> </span><span>[</span><span>320</span><span> </span><span>*</span><span> </span><span>240</span><span>]</span><span>u32</span><span> </span><span>=</span><span> </span><span>undefined</span><span>;</span><span>
</span><span>    </span><span>var</span><span> </span><span>f</span><span> </span><span>=</span><span> </span><span>std</span><span>.</span><span>mem</span><span>.</span><span>zeroInit</span><span>(</span><span>c</span><span>.</span><span>fenster</span><span>,</span><span> </span><span>.{.</span><span>width</span><span> </span><span>=</span><span> </span><span>320</span><span>,</span><span> </span><span>.</span><span>height</span><span> </span><span>=</span><span> </span><span>240</span><span>,</span><span> </span><span>.</span><span>title</span><span> </span><span>=</span><span> </span><span>&#34;hello&#34;</span><span>,</span><span> </span><span>.</span><span>buf</span><span> </span><span>=</span><span> </span><span>&amp;</span><span>buf</span><span>[</span><span>0</span><span>]});</span><span>
</span><span>    </span><span>_</span><span> </span><span>=</span><span> </span><span>c</span><span>.</span><span>fenster_open</span><span>(</span><span>&amp;</span><span>f</span><span>);</span><span>
</span><span>    </span><span>defer</span><span> </span><span>c</span><span>.</span><span>fenster_close</span><span>(</span><span>&amp;</span><span>f</span><span>);</span><span>
</span><span>    </span><span>var</span><span> </span><span>t</span><span>:</span><span> </span><span>u32</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span><span>
</span><span>    </span><span>var</span><span> </span><span>now</span><span>:</span><span> </span><span>i64</span><span> </span><span>=</span><span> </span><span>c</span><span>.</span><span>fenster_time</span><span>();</span><span>
</span><span>    </span><span>while</span><span> </span><span>(</span><span>c</span><span>.</span><span>fenster_loop</span><span>(</span><span>&amp;</span><span>f</span><span>)</span><span> </span><span>==</span><span> </span><span>0</span><span>)</span><span> </span><span>{</span><span>
</span><span>        </span><span>// Exit when Escape is pressed
</span><span></span><span>        </span><span>if</span><span> </span><span>(</span><span>f</span><span>.</span><span>keys</span><span>[</span><span>27</span><span>]</span><span> </span><span>!=</span><span> </span><span>0</span><span>)</span><span> </span><span>{</span><span>
</span><span>            </span><span>break</span><span>;</span><span>
</span><span>        </span><span>}</span><span>
</span><span>        </span><span>// Render x^y^t pattern
</span><span></span><span>        </span><span>for</span><span> </span><span>(</span><span>buf</span><span>)</span><span> </span><span>|</span><span>_</span><span>,</span><span> </span><span>i</span><span>|</span><span> </span><span>{</span><span>
</span><span>            </span><span>buf</span><span>[</span><span>i</span><span>]</span><span> </span><span>=</span><span> </span><span>@intCast</span><span>(</span><span>u32</span><span>,</span><span> </span><span>i</span><span> </span><span>%</span><span> </span><span>320</span><span>)</span><span> </span><span>^</span><span> </span><span>@intCast</span><span>(</span><span>u32</span><span>,</span><span> </span><span>i</span><span> </span><span>/</span><span> </span><span>240</span><span>)</span><span> </span><span>^</span><span> </span><span>t</span><span>;</span><span>
</span><span>        </span><span>}</span><span>
</span><span>        </span><span>t</span><span> </span><span>+%=</span><span> </span><span>1</span><span>;</span><span>
</span><span>        </span><span>// Keep ~60 FPS
</span><span></span><span>        </span><span>var</span><span> </span><span>diff</span><span>:</span><span> </span><span>i64</span><span> </span><span>=</span><span> </span><span>1000</span><span> </span><span>/</span><span> </span><span>60</span><span> </span><span>-</span><span> </span><span>(</span><span>c</span><span>.</span><span>fenster_time</span><span>()</span><span> </span><span>-</span><span> </span><span>now</span><span>);</span><span>
</span><span>        </span><span>if</span><span> </span><span>(</span><span>diff</span><span> </span><span>&gt;</span><span> </span><span>0</span><span>)</span><span> </span><span>{</span><span>
</span><span>            </span><span>c</span><span>.</span><span>fenster_sleep</span><span>(</span><span>diff</span><span>);</span><span>
</span><span>        </span><span>}</span><span>
</span><span>        </span><span>now</span><span> </span><span>=</span><span> </span><span>c</span><span>.</span><span>fenster_time</span><span>();</span><span>
</span><span>    </span><span>}</span><span>
</span><span></span><span>}</span><span>
</span></code></pre></div><p>Of course, some Zig-friendly idiomatic wrappers are always welcome!</p><h2 id="but-can-it-run-doom">But can it run Doom?</h2><p>Yes, it can! Porting Doom has never been easier these days, thanks to the wonderful <a href="https://github.com/ozkl/doomgeneric">https://github.com/ozkl/doomgeneric</a>. All you have to do is to implement several functions: for opening a window, for updating the framebuffer, for handling time and for user input. We’re lucky – Fenster literally has an API call for each of these cases.</p><p>If you only override these functions you already get a familiar starting picture and some demo animation:</p><div><pre><code data-lang="c"><span>struct</span> <span>fenster</span> <span>f</span> <span>=</span> <span>{</span> <span>.</span><span>width</span> <span>=</span> <span>DOOMGENERIC_RESX</span><span>,</span> <span>.</span><span>height</span> <span>=</span> <span>DOOMGENERIC_RESY</span><span>,</span> <span>.</span><span>title</span> <span>=</span> <span>&#34;doom&#34;</span> <span>};</span>
<span>void</span> <span>DG_Init</span><span>()</span> <span>{</span> <span>f</span><span>.</span><span>buf</span> <span>=</span> <span>DG_ScreenBuffer</span><span>;</span> <span>fenster_open</span><span>(</span><span>&amp;</span><span>f</span><span>);</span> <span>}</span>
<span>void</span> <span>DG_DrawFrame</span><span>()</span> <span>{</span> <span>fenster_loop</span><span>(</span><span>&amp;</span><span>f</span><span>);</span> <span>}</span>
<span>void</span> <span>DG_SleepMs</span><span>(</span><span>uint32_t</span> <span>ms</span><span>)</span> <span>{</span> <span>fenster_sleep</span><span>(</span><span>ms</span><span>);</span> <span>}</span>
<span>uint32_t</span> <span>DG_GetTicksMs</span><span>()</span> <span>{</span> <span>return</span> <span>fenster_time</span><span>();</span> <span>}</span>
</code></pre></div><p>What’s left is user input. Doom uses key events instead of key statuses, and it peeks them one by one. So we should keep another array of last know key statuses, compare it to the current keys and return an event if there is a mismatch. Additionally, Doom has its own custom key mapping that might not match our key codes, so we need to do some conversion:</p><div><pre><code data-lang="c"><span>unsigned</span> <span>char</span> <span>toDoomKey</span><span>(</span><span>int</span> <span>k</span><span>)</span> <span>{</span>
  <span>switch</span> <span>(</span><span>k</span><span>)</span> <span>{</span>
  <span>case</span> <span>&#39;\n&#39;</span><span>:</span> <span>return</span> <span>KEY_ENTER</span><span>;</span>
  <span>case</span> <span>&#39;\x1b&#39;</span><span>:</span> <span>return</span> <span>KEY_ESCAPE</span><span>;</span>
  <span>case</span> <span>&#39;\x11&#39;</span><span>:</span> <span>return</span> <span>KEY_UPARROW</span><span>;</span>
  <span>case</span> <span>&#39;\x12&#39;</span><span>:</span> <span>return</span> <span>KEY_DOWNARROW</span><span>;</span>
  <span>case</span> <span>&#39;\x13&#39;</span><span>:</span> <span>return</span> <span>KEY_RIGHTARROW</span><span>;</span>
  <span>case</span> <span>&#39;\x14&#39;</span><span>:</span> <span>return</span> <span>KEY_LEFTARROW</span><span>;</span>
  <span>case</span> <span>&#39;Z&#39;</span><span>:</span> <span>return</span> <span>KEY_FIRE</span><span>;</span>
  <span>case</span> <span>&#39;X&#39;</span><span>:</span> <span>return</span> <span>KEY_RSHIFT</span><span>;</span>
  <span>case</span> <span>&#39; &#39;</span><span>:</span> <span>return</span> <span>KEY_USE</span><span>;</span>
  <span>}</span>
  <span>return</span> <span>tolower</span><span>(</span><span>k</span><span>);</span>
<span>}</span>

<span>int</span> <span>DG_GetKey</span><span>(</span><span>int</span> <span>*</span><span>pressed</span><span>,</span> <span>unsigned</span> <span>char</span> <span>*</span><span>doomKey</span><span>)</span> <span>{</span>
  <span>static</span> <span>int</span> <span>old</span><span>[</span><span>128</span><span>]</span> <span>=</span> <span>{</span><span>0</span><span>};</span>
  <span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>128</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
    <span>if</span> <span>((</span><span>f</span><span>.</span><span>keys</span><span>[</span><span>i</span><span>]</span> <span>&amp;&amp;</span> <span>!</span><span>old</span><span>[</span><span>i</span><span>])</span> <span>||</span> <span>(</span><span>!</span><span>f</span><span>.</span><span>keys</span><span>[</span><span>i</span><span>]</span> <span>&amp;&amp;</span> <span>old</span><span>[</span><span>i</span><span>]))</span> <span>{</span>
      <span>*</span><span>pressed</span> <span>=</span> <span>old</span><span>[</span><span>i</span><span>]</span> <span>=</span> <span>f</span><span>.</span><span>keys</span><span>[</span><span>i</span><span>];</span>
      <span>*</span><span>doomKey</span> <span>=</span> <span>toDoomKey</span><span>(</span><span>i</span><span>);</span>
      <span>return</span> <span>1</span><span>;</span>
    <span>}</span>
  <span>}</span>
  <span>return</span> <span>0</span><span>;</span>
<span>}</span>
</code></pre></div><p>Unbelievable, but in less than 50 lines of code we got a fully working Doom game running on top of a tiny cross platform graphics library we’ve just created!</p><p><img src="https://notebook.wesleyac.com/images/fenster-doom.png" alt="doom"/></p><p>Well, if it can run Doom – it can do anything! I hope this little toy library would be helpful to those who miss the simplicity of the old school graphics. Pull requests, bug fixes and contributions are appreciated, as long as they don’t bloat the library and keep it simple.</p><p>I hope you’ve enjoyed this article. You can follow – and contribute to – on <a href="https://github.com/zserge">Github</a>, <a href="https://twitter.com/zsergo">Twitter</a> or subscribe via <a href="https://notebook.wesleyac.com/rss.xml">rss</a>.</p><p><em>Jan 15, 2023</em></p></div></div>
  </body>
</html>
