<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://dgroshev.com/blog/bufferbloat/">Original</a>
    <h1>Unbloating the buffers</h1>
    
    <div id="readability-page-1" class="page"><div>
        
  <div>
    
    

    <div>
      <p>Here is a square.</p>




  
  


<p><a href="https://dgroshev.com/blog/bufferbloat/img/01_square.png?hash=59080419" target="_blank">
  <img src="https://dgroshev.com/blog/bufferbloat/img/01_square.png?hash=59080419" srcset="img/01_square.png?hash=59080419, img/01_square.png?hash=59080419 2x" alt="Picture of a square"/>
</a></p><p>Wait, it&#39;s not just a square.</p>




  
  


<p><a href="https://dgroshev.com/blog/bufferbloat/img/02_my_computer.png?hash=18935211" target="_blank">
  <img src="https://dgroshev.com/blog/bufferbloat/img/02_my_computer.png?hash=18935211" srcset="img/02_my_computer.png?hash=18935211, img/02_my_computer.png?hash=18935211 2x" alt="Same square annotated as my computer"/>
</a></p><p>There&#39;s more of those.</p>




  
  

  
    
    
  


<p><a href="https://dgroshev.com/blog/bufferbloat/img/03_two_computers.png?hash=bfbb3d20" target="_blank">
  <img src="https://dgroshev.com/processed_images/03_two_computers.56547b83afec7feb.png?hash=bfbb3d20" srcset="https://dgroshev.com/processed_images/03_two_computers.56547b83afec7feb.png?hash=bfbb3d20, https://dgroshev.com/processed_images/03_two_computers.84da6ebbdab1b6a8.png?hash=bfbb3d20 2x" alt="Two squares, one says my computer, the other says your computer"/>
</a></p><p>They feel lonely. Can we help them?</p>




  
  

  
    
    
  


<p><a href="https://dgroshev.com/blog/bufferbloat/img/04_network.png?hash=44f0914c" target="_blank">
  <img src="https://dgroshev.com/processed_images/04_network.c5349072e720201e.png?hash=44f0914c" srcset="https://dgroshev.com/processed_images/04_network.c5349072e720201e.png?hash=44f0914c, https://dgroshev.com/processed_images/04_network.8add506471a17d78.png?hash=44f0914c 2x" alt="Same as before, but with a double sided arrow saying network cable"/>
</a></p><p>Yes! See, they are now connected and can talk to each other. Much better! </p>
<p>Except‚Ä¶ Oh no.</p>
<p>As you awoke one morning from uneasy dreams you found yourself transformed in your bed 
into a software engineer. A calamity that I find all too familiar.</p>
<p>Now it&#39;s on us to figure out how that network should work.</p>
<p>With time and effort, you and I can come up with a protocol that will let bytes go through that cable. 
We can even make it decently quick and send pictures of exotic tropical fish to each other.
It&#39;s relatively easy: both sides of the cable are under our control, so we can agree on the speed of exchange,
making sure that the sending computer does not overload the receiving one. All&#39;s good, and the sun is shining üï∂Ô∏è</p>
<p>Except‚Ä¶ Oh no.</p>




  
  

  
    
    
  


<p><a href="https://dgroshev.com/blog/bufferbloat/img/05_large_network.png?hash=4074f5d4" target="_blank">
  <img src="https://dgroshev.com/processed_images/05_large_network.8889fa4518d9013d.png?hash=4074f5d4" srcset="https://dgroshev.com/processed_images/05_large_network.8889fa4518d9013d.png?hash=4074f5d4, https://dgroshev.com/processed_images/05_large_network.4aaaa05d1247008a.png?hash=4074f5d4 2x" alt="A network of computers in the same style as before"/>
</a></p><p>I have more than one cable plugged into my computer. You have an ongoing amphibian emergency that
can only be helped by receiving frog pictures. I don&#39;t have any, but someone in my network has them.</p>




  
  

  
    
    
  


<p><a href="https://dgroshev.com/blog/bufferbloat/img/06_bad_link.png?hash=519527ee" target="_blank">
  <img src="https://dgroshev.com/processed_images/06_bad_link.3c05093d5b214ed1.png?hash=519527ee" srcset="https://dgroshev.com/processed_images/06_bad_link.3c05093d5b214ed1.png?hash=519527ee, https://dgroshev.com/processed_images/06_bad_link.fe713aea025b56e3.png?hash=519527ee 2x" alt="Same network, but one link is marked red"/>
</a></p><p>Computers are now interconnected into a large network, and all links are different. A family of magpies
made a nest in Ben&#39;s network cabinet, so every time the adult magpies bring food back, the link between me and Ben
slows down.</p>
<p>Ben&#39;s a smart guy. He knows that electrons are fickle, and the connection speed varies, so he adds 
a buffer to his computer. If his link to me is slow, he can still receive more from Li, filling
the buffer, and transmit it further as fast as he can. This way, the bandwidth is utilised as efficiently
as possible, and transient spikes of traffic or slowdowns are <em>buffered</em>.</p>
<p>Let&#39;s zoom in.</p>




  
  

  
    
    
  


<p><a href="https://dgroshev.com/blog/bufferbloat/img/07_buffer.png?hash=4d1d50e8" target="_blank">
  <img src="https://dgroshev.com/processed_images/07_buffer.5ddbbb3496e0253d.png?hash=4d1d50e8" srcset="https://dgroshev.com/processed_images/07_buffer.5ddbbb3496e0253d.png?hash=4d1d50e8, https://dgroshev.com/processed_images/07_buffer.0c65e4b4d61c7bc8.png?hash=4d1d50e8 2x" alt="Diagram of three computers and two links, with schematic buffers inside the computers"/>
</a></p><p>Look closely: magpie parents are working hard, and the buffer is full. Packets trickle through, but they can
only get into the buffer as fast as it is emptied on the other side. Ben&#39;s computer asks Li&#39;s to slow down.</p>
<p>Now imagine that there is more than one type of packet. Some of the packets belong to a voice call that is happening
over the same link!</p>




  
  

  
    
    
  


<p><a href="https://dgroshev.com/blog/bufferbloat/img/08_ribbit_over_ip.png?hash=742dd1d2" target="_blank">
  <img src="https://dgroshev.com/processed_images/08_ribbit_over_ip.c2ced80b71d1f5cf.png?hash=742dd1d2" srcset="https://dgroshev.com/processed_images/08_ribbit_over_ip.c2ced80b71d1f5cf.png?hash=742dd1d2, https://dgroshev.com/processed_images/08_ribbit_over_ip.f879976e9e45c78f.png?hash=742dd1d2 2x" alt="Same diagram, but some packets are marked yellow"/>
</a></p><p>Voice packets need to get through quickly, but instead they wait in the queue that doesn&#39;t go anywhere. The buffer
doesn&#39;t help throughput, it&#39;s not transient anymore, it just sits there. The buffer is actively harmful ‚Äî 
it adds a delay! The entire link from Li to me is not only at maximum throughput, it&#39;s also slow to react.
The latency gets higher for no benefit.</p>
<p>This is called <a href="https://en.wikipedia.org/wiki/Bufferbloat"><strong>bufferbloat</strong></a>.</p>
<p>Bufferbloat is so common that we don&#39;t even think about it. Of course video calls drop out and glitch when you download 
something, duh! <em>The internet</em> is working hard, it&#39;s only natural that it&#39;s a bit slow to react. </p>
<p>It doesn&#39;t have to be this way.</p>
<h2 id="how-bad-is-bufferbloat-really">How bad is bufferbloat, really?</h2>
<p>I tested my home connection with <a href="https://flent.org/">Flent</a>:</p>




  
  

  
    
    
  


<p><a href="https://dgroshev.com/blog/bufferbloat/img/09_test_nocake.png?hash=18b93a19" target="_blank">
  <img src="https://dgroshev.com/processed_images/09_test_nocake.465bfde4e4cb7e1e.png?hash=18b93a19" srcset="https://dgroshev.com/processed_images/09_test_nocake.465bfde4e4cb7e1e.png?hash=18b93a19, https://dgroshev.com/processed_images/09_test_nocake.7fa55d86984d0c4a.png?hash=18b93a19 2x" alt="Flent graph before configuring CAKE"/>
</a></p><p>Here is what happens on this graph:</p>
<ul>
<li>Flent starts pinging the remote server (both via ICMP and UDP)</li>
<li>five seconds into the test, Flent starts uploading and downloading in parallel</li>
<li>Flent runs multiple TCP streams with <a href="https://en.wikipedia.org/wiki/Differentiated_services">different priorities</a>
in parallel. BE/BK/CS5/EF are different priorities</li>
<li>both bandwidth and ping are charted five times a second</li>
</ul>
<p>Some conclusions:</p>
<ul>
<li>the download is pretty stable at 75Mbit per stream</li>
<li>upload is all over the place, floating from 10Mbit to 5Mbit per stream</li>
<li>ping raises from a few ms to almost 300ms ‚Äî 0.3s just for one packet to go there and back again! That makes
video calls unusable</li>
<li>priorities are ignored </li>
</ul>
<p>I also tested pure, non-parallel bandwidth to the same server with <a href="https://github.com/esnet/iperf">iperf3</a>.
On my connection, iperf3 shows total speed of 305Mbit down/48Mbit up. Compared
with the numbers above, total download matches Flent precisely, but upload slows down 2‚Äì4 times because
of the parallel download.</p>
<p>This is not ideal.</p>
<h2 id="what-can-i-do-about-it">What can I do about it?</h2>
<p>Let&#39;s look again at what happens when I&#39;m trying to download something from Li:</p>




  
  

  
    
    
  


<p><a href="https://dgroshev.com/blog/bufferbloat/img/10_speed_difference.png?hash=679f4683" target="_blank">
  <img src="https://dgroshev.com/processed_images/10_speed_difference.304ca8ec9e8f6cca.png?hash=679f4683" srcset="https://dgroshev.com/processed_images/10_speed_difference.304ca8ec9e8f6cca.png?hash=679f4683, https://dgroshev.com/processed_images/10_speed_difference.c4ab25258b1142b0.png?hash=679f4683 2x" alt="A diagram of three computers and two links annotated with their bandwidths. One link is much faster than the other"/>
</a></p><p>The reason why packets bunch is that there is a bandwidth bottleneck on the way. If I could just sign up 
for a faster contract, the problem would go away, right? To an extent this is true: faster connection makes it
harder to saturate the network.</p>
<p>However, my provider still has a much faster network on their side, so the problem is still there, it&#39;s just less 
likely to occur.</p>
<p>If only there was a way to adjust those queues dynamically, shrinking them if the network is saturated!</p>
<p>This is precisely what <a href="https://en.wikipedia.org/wiki/Active_queue_management">Active Queue Management</a> (AQM) does.</p>
<h2 id="cake-is-real">CAKE is real</h2>
<p>There are many AQM implementations, but the most modern, performant, non-fiddly one is 
<a href="https://www.bufferbloat.net/projects/codel/wiki/Cake/">CAKE</a>.<sup>a very tortured backronym</sup></p>
<p>Better internet is one configuration option away:</p>




  
  

  
    
    
  


<p><a href="https://dgroshev.com/blog/bufferbloat/img/11_test_cake.png?hash=6dafe903" target="_blank">
  <img src="https://dgroshev.com/processed_images/11_test_cake.9c7742236e9ccb6c.png?hash=6dafe903" srcset="https://dgroshev.com/processed_images/11_test_cake.9c7742236e9ccb6c.png?hash=6dafe903, https://dgroshev.com/processed_images/11_test_cake.94fbb766ec36e642.png?hash=6dafe903 2x" alt="Flent graph after configuring CAKE"/>
</a></p><p>I traded about 10% of bandwidth (263Mbit down/41Mbit up per iperf3) for:</p>
<ul>
<li>constant average bandwidth on both upload and download</li>
<li>no impact of download on upload</li>
<li>network load has no visible impact on latency</li>
<li>effective traffic prioritisation</li>
</ul>
<p>I believe I can be less conservative with the bandwidth and fiddle with CAKE settings more, but I am happy with 
this trade as it is. Here&#39;s the entirery of VyOs config changes :</p>
<pre><code><span>interfaces {
</span><span>    input ifb0 {
</span><span>    }
</span><span>    pppoe pppoe0 {
</span><span>        ...
</span><span>        redirect ifb0
</span><span>    }
</span><span>}
</span><span> 
</span><span>qos {
</span><span>    interface ifb0 {
</span><span>        egress CAKE-WAN-IN
</span><span>    }
</span><span>    interface pppoe0 {
</span><span>        egress CAKE-WAN-OUT
</span><span>    }
</span><span>    policy {
</span><span>        cake CAKE-WAN-IN {
</span><span>            bandwidth 280mbit
</span><span>            flow-isolation {
</span><span>                nat
</span><span>            }
</span><span>            rtt 30
</span><span>        }
</span><span>        cake CAKE-WAN-OUT {
</span><span>            bandwidth 45mbit
</span><span>            flow-isolation {
</span><span>                nat
</span><span>            }
</span><span>            rtt 30
</span><span>        } 
</span><span>    }
</span><span>}
</span></code></pre>
<p>No more frog picture delays!</p>




  
  

  
    
    
  


<p><a href="https://dgroshev.com/blog/bufferbloat/img/12_common_frog.jpeg?hash=3814138e" target="_blank">
  <img src="https://dgroshev.com/processed_images/12_common_frog.2a50ccca4e4fce8c.jpg?hash=3814138e" srcset="https://dgroshev.com/processed_images/12_common_frog.2a50ccca4e4fce8c.jpg?hash=3814138e, https://dgroshev.com/processed_images/12_common_frog.5a45a6dc6f97ce69.jpg?hash=3814138e 2x" alt="Wikipedia&#39;s picture of a common frog (Rana temporaria)"/>
</a></p><hr/>







    </div>
  </div>

      </div></div>
  </body>
</html>
