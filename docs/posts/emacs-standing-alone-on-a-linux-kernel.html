<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://informatimago.free.fr/i/linux/emacs-on-user-mode-linux.html">Original</a>
    <h1>Emacs standing alone on a Linux Kernel</h1>
    
    <div id="readability-page-1" class="page">
  <!--TOP-BEGIN-->
<!-- This section is automatically generated by html-update, -->
<!-- from data in 'node.el'.    Please, do not edit it here. -->

<!--TOP-END-->
<!--MENU-BEGIN-->
<!-- This section is automatically generated by html-update, -->
<!-- from data in 'node.el'.    Please, do not edit it here. -->

<!--MENU-END-->

<p><a href="#shell">Jump to Emacs as shell</a>

</p>

<p>The purpose of this experiment is to see how emacs can work alone
   over a linux kernel.

</p><p>The only external tool needed is <code>mount</code>.

</p><p>This &#34;root_fs_emacs&#34; could be used as a normal partition or on live CD,
   but for this experiment, we&#39;ll run it with 
   <a href="http://user-mode-linux.sourceforge.net">User Mode Linux</a>.

</p><h2>1- Initialize a root_fs with at least 150 MB</h2>
<pre>cd ~/uml
dd if=/dev/zero of=root_fs_emacs bs=1k count=200k
yes y|mke2fs root_fs_emacs
mkdir /emacs 
mount -o loop root_fs_emacs /emacs
cd /emacs
ln -s .  emacs     # we create this link to simplify config --prefix of emacs 
cp -a /dev dev     # we boldly copy the whole /dev
mkdir etc sbin tmp # some other directories not installed by emacs
cat &gt;etc/fstab &lt;&lt;EOF
/dev/ubd0 / ext2 defaults  0 1
EOF
</pre>

<h2>2- Compile an emacs without X and statically</h2>
<pre>cd ~/src
tar jxvf emacs-21.3.tar.bz2
cd emacs-21.3
CFLAGS=-static LDFLAGS=-static ./configure --without-x --prefix=/emacs
make &amp;&amp; make install
</pre>

<h2>3- Install emacs as /sbin/init</h2>
<pre>cd /emacs
ln bin/emacs sbin/init
cat &gt;.emacs &lt;&lt;EOF
(message &#34;init starting&#34;)
(setq auto-save-interval 0)
(defun shutdown ()
  (interactive)
  (when (yes-or-no-p &#34;Really shut down the system? &#34;)
    ;; actually, kill-emacs signals emacs ie. init, which makes linux panic.
    (kill-emacs)))
(global-set-key &#34;\C-x\C-c&#34; &#39;shutdown)
(global-set-key &#34;^\&#34;  &#39;keyboard-quit) ;; strangely, C-g does not work.
(call-process &#34;/bin/mount&#34; nil &#34;*log*&#34; t &#34;-n&#34; &#34;-o&#34; &#34;rw,remount&#34; &#34;/&#34;)
(if (file-exists-p &#34;/etc/mtab&#34;) (delete-file &#34;/etc/mtab&#34;))
(call-process &#34;/bin/mount&#34; nil &#34;*log*&#34; t &#34;-f&#34; &#34;/dev/ubd0&#34; &#34;/&#34;)
(message &#34;init done&#34;)
EOF
</pre>

<h2>4- Compile mount statically</h2>
<pre>cd ~/src
tar jxvf util-linux-2.12a.tar.bz2 
cd util-linux-2.12a
CFLAGS=-static LDFLAGS=-static ./configure
make &amp;&amp; install -m 755 mount/umount mount/mount /emacs/bin/
</pre>

<h2>5- Boot linux</h2>
<pre>cd ~/uml
umount /emacs
linux ubd0=root_fs_emacs
</pre>

<p>Now, you can launch an emacs shell with </p><pre> M-x eshell RET
ls -l RET
</pre>
<p>and get: </p><pre>File Edit Options Buffers Tools Help 
Welcome to the Emacs shell

/ # ls -l
total 21
drwxr-xr-x   2 0        0            1024 Jul 26 08:42 bin
drwxr-xr-x   1 0        0               0 Jan  1  1970 dev
lrwxrwxrwx   1 0        0               1 Jul 26 08:11 emacs -&gt; .
drwxr-xr-x   2 0        0            1024 Jul 26 09:20 etc
drwxr-xr-x   2 0        0            2048 Jul 26 08:11 info
drwxr-xr-x   3 0        0            1024 Jul 26 08:11 libexec
drwx------   2 0        0           12288 Jul 26 08:10 lost+found
drwxr-xr-x   3 0        0            1024 Jul 26 08:10 man
drwxr-xr-x   2 0        0            1024 Jul 26 08:11 sbin
drwxr-xr-x   3 0        0            1024 Jul 26 08:10 share
drwxr-xr-x   2 0        0            1024 Jul 26 09:15 tmp
/ # 

--1-:---F1  *eshell*          (EShell)--L20--All---------------------
</pre>

<p>Of course, quite a number of syscalls are missing from emacs (not
available as elisp primitives), so as it is, it would be hard enough to
do EVERYTHING with emacs, but this is a starting point.

</p><p>Another, more realistic, alternative would be to use a Common-Lisp
implementation with a FFI  and portable Hemlock.



</p>

<p>Emacs can easily be used as shell:
</p><pre>     echo    /usr/bin/emacs &gt;&gt; /etc/shells
     chsh -s /usr/bin/emacs  GOODUSER

     echo    &#39;(setenv &#34;SHELL&#34; &#34;/bin/bash&#34;)&#39; &gt;&gt; ~GOODUSER/.emacs
     # in case the user wants to use M-x shell
     # [ I use rather: (setenv &#34;SHELL&#34; &#34;/usr/bin/clisp&#34;) ]

     echo    &#39;(eshell)&#39; &gt;&gt; ~GOODUSER/.emacs
     # to launch eshell automatically.
     # One could use: (dired default-directory) instead...

     su - GOODUSER
     # Hosanna!
</pre>


  <!--MENU-BEGIN-->
<!-- This section is automatically generated by html-update, -->
<!-- from data in 'node.el'.    Please, do not edit it here. -->

<!--MENU-END-->
  <!--BOTTOM-BEGIN-->
<!-- This section is automatically generated by html-update, -->
<!-- from data in 'node.el'.    Please, do not edit it here. -->

<!--BOTTOM-END-->



</div>
  </body>
</html>
