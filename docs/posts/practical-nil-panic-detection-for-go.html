<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.uber.com/en-NL/blog/nilaway-practical-nil-panic-detection-for-go/">Original</a>
    <h1>Practical nil panic detection for Go</h1>
    
    <div id="readability-page-1" class="page"><div data-baseweb="block"><p>Uber has widely adopted <span><a href="https://go.dev/" target="_blank" rel="noreferrer noopener">Go</a></span> as a primary programming language for implementing backend services and libraries due to its <span><a href="https://www.uber.com/blog/tech-stack-part-one-foundation/?uclick_id=3e0d40f6-9bfc-4a69-8a58-c438c8a04702" target="_blank" rel="noreferrer noopener">high performance</a></span>. The <span><a href="https://www.uber.com/blog/go-monorepo-bazel/?uclick_id=3e0d40f6-9bfc-4a69-8a58-c438c8a04702" target="_blank" rel="noreferrer noopener">Go monorepo</a></span> is the largest codebase at Uber, comprising 90 million lines of code (and growing). This makes tooling for writing reliable Go code a critical part of our development infrastructure.</p>


<p><span><a href="https://www.golang-book.com/books/intro/8" target="_blank" rel="noreferrer noopener">Pointers</a></span> (variables that hold the memory addresses of other variables instead of their actual values) are an integral part of the Go programming language and facilitate efficient memory management and effective data manipulation. Therefore, programmers use pointers extensively in writing Go programs for various purposes such as in-place data modification, concurrent programming, easy data sharing, optimizing memory usage, and facilitating interfaces and polymorphism. While pointers are powerful and widely used, it is essential to use them carefully and judiciously to avoid common pitfalls like nil pointer dereferences causing nil panics.</p>


<hr aria-hidden="true" role="separator"/>





<p>A nil panic is a runtime panic that occurs when a program attempts to dereference a nil pointer. When a pointer is nil, it means that it does not point to any valid memory address, and attempting to access the value it points to will result in a panic (i.e., a runtime error) with the error message shown in Figure 1.</p>





<div><figure data-wp-block="{&#34;align&#34;:&#34;center&#34;,&#34;id&#34;:1067327,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;hash&#34;:&#34;d1b1d282-1d02-45bf-8785-b6bcfd98946e&#34;,&#34;alt&#34;:&#34;&#34;}" data-wp-block-name="core/image"><img alt="Image" src="https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_1-1024x62.jpg" srcset="https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_1.jpg 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_1.jpg 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_1.jpg 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_1.jpg 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=2048,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_1.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" loading="lazy" width="1024" height="62"/><figcaption>Figure 1: Nil panic error message</figcaption></figure></div>

<p>Figure 2 shows an example of a <span><a href="https://github.com/golang/go/pull/60823" target="_blank" rel="noreferrer noopener">recent nil panic problem</a></span> in the implementation of the Go standard library, particularly its <em>net</em> package, that was discovered and resolved. The panic was caused on line 1859 due to a direct call to the method <em>String()</em> on the return value of method <em>RemoteAddr()</em>, assuming it to be always non-nil, as shown in Figure 2. This is problematic when the field <em>c.rwc</em> of interface type <em>net.Conn</em> is assigned with the struct <em>net.conn</em>, since its concrete implementation of <em>RemoteAddr()</em> can return a nil value if the connection <em>c</em> is found to be not OK (shown in Figure 3). Specifically, <em>RemoteAddr()</em> can return a <span><a href="https://go.dev/tour/methods/13#:~:text=A%20nil%20interface%20value%20holds,which%20concrete%20method%20to%20call." target="_blank" rel="noreferrer noopener">nil interface value</a></span> on L225, leading to a nil panic when a method is called (<em>.String()</em> here) on it, since the <em>nil</em> value contains no pointer to any concrete method that can be invoked.</p>


<div><figure data-wp-block="{&#34;align&#34;:&#34;center&#34;,&#34;id&#34;:1067333,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;hash&#34;:&#34;96b7facd-dc4c-4115-ac64-00079bfa5ce8&#34;,&#34;alt&#34;:&#34;&#34;}" data-wp-block-name="core/image"><img alt="Image" src="https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_2-1024x422.jpeg" srcset="https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_2.jpeg 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_2.jpeg 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_2.jpeg 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_2.jpeg 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=2048,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_2.jpeg 2048w, https://blog.uber-cdn.com/cdn-cgi/image/width=2128,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_2.jpeg 2128w" sizes="(max-width: 1024px) 100vw, 1024px" loading="lazy" width="1024" height="422"/><figcaption>Figure 2: <span><a href="https://github.com/golang/go/commit/3c8b7a95513c088f02483aa876e16263cbc7ee52" target="_blank" rel="noreferrer noopener">Fix commit</a></span> from <span><a href="https://github.com/golang/go" target="_blank" rel="noreferrer noopener">golang/go</a></span> fixing a nil panic in its <em>net</em> package (<span><a href="https://github.com/golang/go/pull/60823" target="_blank" rel="noreferrer noopener">PR #60823</a></span>). The nil panic is caused by calling method <em>String()</em> on the return of <em>RemoteAddr()</em> on L1859, which can be a nil interface value (as shown in Figure 3)</figcaption></figure></div>

<div><figure data-wp-block="{&#34;align&#34;:&#34;center&#34;,&#34;id&#34;:1067335,&#34;width&#34;:&#34;682px&#34;,&#34;height&#34;:&#34;auto&#34;,&#34;aspectRatio&#34;:&#34;1.848375451263538&#34;,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;hash&#34;:&#34;bc719bce-2d29-45f9-90c4-a3fd9b2c8c61&#34;,&#34;alt&#34;:&#34;&#34;}" data-wp-block-name="core/image"><img alt="Image" src="https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_3-1024x554.jpg" srcset="https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_3.jpg 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_3.jpg 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_3.jpg 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_3.jpg 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=1877,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_3.jpg 1877w" sizes="(max-width: 1024px) 100vw, 1024px" loading="lazy" width="1024" height="554"/><figcaption>Figure 3: Excerpt from <span><a href="https://github.com/golang/go/blob/548790e64a6ad186a85f7a75ee53f6fdc6a2aead/src/net/net.go#L223" target="_blank" rel="noreferrer noopener">net/net.go</a></span> showing the <em>net.Conn</em> interface and the implementation of the <em>RemoteAddr()</em> method by the struct <em>net.conn</em>, which can return nil, if <em>c.ok()</em> is false</figcaption></figure></div>

<p>Nil panics are found to be an especially <span><a href="https://github.com/search?q=repo%3Agolang%2Fgo%20nil%20panic&amp;type=issues" target="_blank" rel="noreferrer noopener">pervasive</a></span> form of runtime errors in Go programs. Uber’s Go monorepo is no exception to this, and has witnessed several runtime errors in production because of nil panics, with effects ranging from incorrect program behavior to app outages, affecting Uber customers. Therefore, in order to maximize reliability and code quality, it is crucial for Uber to enable programmers to detect and fix nil panics early, before the buggy code gets deployed in production.</p>


<p>Nil panics can also cause denial of service attacks. For example, <span><a href="https://www.cvedetails.com/cve/CVE-2020-29652/" target="_blank" rel="noreferrer noopener">CVE-2020-29652</a></span> is due to a nil pointer dereference in the <span><a href="https://cs.opensource.google/go/x/crypto" target="_blank" rel="noreferrer noopener">golang.org/x/crypto/ssh</a></span> that allows remote attackers to cause a denial of service against SSH servers.</p>


<p>There exists an automated tool, <span><a href="https://pkg.go.dev/golang.org/x/tools/go/analysis/passes/nilness" target="_blank" rel="noreferrer noopener">nilness</a></span>, offered by the Go distribution for detecting nil panics. This nilness checker is a lightweight static analysis technique that reports only simple errors, such as obvious sites of nil dereferences <em>(e.g., if x == nil { print(*x) })</em>. However, such simple checks fail to capture the complex nil flows in real programs, such as the one shown in Figure 2. Therefore, we need a technique that performs rigorous analysis and is effective on production code.</p>


<p>To deal with NullPointerExceptions (NPEs) in Java, Uber has developed <span><a href="https://www.uber.com/blog/nullaway/" target="_blank" rel="noreferrer noopener">NullAway</a></span>. NullAway requires the code to be annotated with <em>@Nullable</em> annotations to guarantee NPE freedom during compile time. This limits the feasibility of directly adapting a NullAway-like technique for our purpose, since, unlike Java, Go does not have language support for annotations. Moreover, annotating a large codebase (e.g., Uber’s Go monorepo with 90 million lines of code) is a cumbersome task. Besides, Go’s various unique features and idiosyncrasies present their own unique challenges.</p>


<p>Our answer to overcome these limitations? <strong>NilAway</strong>.</p>


<p>We designed and developed NilAway for automatically detecting nil panics by employing sophisticated interprocedural static analysis and inferencing techniques. The design goal of NilAway was to have no annotation burden on developers, maintain minimal impact on local and CI build-times, and address the many challenges posed by Go language idioms in ways that are natural to Go developers.</p>


<hr aria-hidden="true" role="separator"/>





<p>Our main idea is that nilability flows in code can be modeled as a system of global typing constraints, which can then be solved using a <span><a href="https://en.wikipedia.org/wiki/2-satisfiability" target="_blank" rel="noreferrer noopener">2-SAT</a></span> algorithm to determine potential contradictions. At a high level, we capture both nilable and nonnil constraints at various program sites for struct fields, function parameters, and return values. An example of a nilable constraint is <em>return x</em>, where x is an uninitialized pointer, while the dereference, <em>*x</em>, is an example of a nonnil constraint. We then build a global <span><a href="https://en.wikipedia.org/wiki/Implication_graph" target="_blank" rel="noreferrer noopener">implication graph</a></span> modeling these program site-specific constraints. Finally, we traverse the implication graph – forward propagating known nilness values and backward propagating known nonnil values – to find contradictions. For a site, <em>S</em>, if a contradiction<em> nilable(S) ^ nonnil(S)</em> is discovered in a program path of the implication graph, then it implies that a nil value is witnessed to flow from a nil source to the site <em>S</em>, from where it reaches a dereference point, which can likely cause a nil panic. NilAway collects and reports these contradictions as potential nil panics to the developer.</p>


<div><figure data-wp-block="{&#34;align&#34;:&#34;center&#34;,&#34;id&#34;:1067340,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;hash&#34;:&#34;82c27e3a-38e3-4e2b-a7d2-e7669224aeca&#34;,&#34;alt&#34;:&#34;&#34;}" data-wp-block-name="core/image"><img alt="Image" src="https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_4-1024x250.jpg" srcset="https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_4.jpg 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_4.jpg 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_4.jpg 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_4.jpg 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=2048,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_4.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" loading="lazy" width="1024" height="250"/><figcaption>Figure 4: Excerpt from the implication graph built by NilAway representing the nil flow for the example in Figure 2.</figcaption></figure></div>

<p>Figure 4 shows the path through the implication graph built by NilAway for the nil flow for the example presented in Figure 2. Here the nodes are program sites that could be a nilable type and edges are the nil flows between them. NilAway traverses the implication graph to find unsafe flows modeling them as contradictions. A flow is deemed unsafe if a witnessed nil value is found to flow through different program paths to a destination where that same value is expected to be nonnil, such as in the case of the <em>nil</em> value flowing from the concrete implementation <em>net.conn.RemoteAddr()</em> to its dereference via method invocation on interface declaration <em>net.Conn.RemoteAddr()</em>. NilAway reports a detailed error message for this nil panic (as shown in Figure 5) that allows developers to easily debug through the exact nil flow from evidenced nilability to its dereference, and apply the necessary fix to prevent the nil panic.</p>


<div><figure data-wp-block="{&#34;align&#34;:&#34;center&#34;,&#34;id&#34;:1067342,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;hash&#34;:&#34;17a1ffd9-cca0-40b4-b296-458fa02457cf&#34;,&#34;alt&#34;:&#34;&#34;}" data-wp-block-name="core/image"><img alt="Image" src="https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_5-1024x189.jpg" srcset="https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_5.jpg 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_5.jpg 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_5.jpg 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_5.jpg 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=2048,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_5.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" loading="lazy" width="1024" height="189"/><figcaption>Figure 5: Error message reported by NilAway for the unsafe flow in Figure 2</figcaption></figure></div>

<p>Note that, in general, for practical static type systems, with or without global inference of types, there will always exist error-free programs that do not satisfy a valid static typing. In the case of NilAway, note that the above algorithm doesn’t capture cases where subtle inter-procedural invariants in the execution of the program would prevent the nil to nonnil flow from happening at runtime. For example, in Figure 3, it is possible that some shared program state is set up such that whenever <em>c.ok()</em> is called from <em>conn.RemoteAddr()</em>, it always returns <em>true</em>, in which case no nil panic exists in that code. However, in practice, NilAway’s false positive rate is low and the cases where such complex execution invariants inherently prevent inferring proper nilness constraints tend to be associated with likely code smells.</p>


<hr aria-hidden="true" role="separator"/>





<p>We designed and developed NilAway around the following four key requirements to make it a practical tool for Uber scale:</p>


<div><ol><li><strong>Low latency:</strong> NilAway should incur only a low overhead in performing its analysis on the large Go codebase. We want NilAway to give developers immediate feedback when they introduce a potential nil panic, thereby requiring NilAway to be fast enough to run with low latency at every stage of our development pipeline, even during local builds. A high overhead would mean higher latency (delayed feedback), thereby reducing developer productivity.</li>


<li><strong>High effectiveness:</strong> NilAway should have a low false positive rate; inspecting false positive nil panics wastes developer time.</li>


<li><strong>Fully automated:</strong> NilAway should be fully automated, requiring no additional input from developers (e.g., annotations as in NullAway, or contrived coding patterns).</li>


<li><strong>Tailored to Go’s idiosyncrasies:</strong> NilAway should treat the idiosyncrasies in Go as first-class citizens and devise a system tailored to Go.</li>
</ol></div>


<div><figure data-wp-block="{&#34;align&#34;:&#34;center&#34;,&#34;id&#34;:1067346,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;hash&#34;:&#34;dcae4ffc-2088-4d65-9339-ecfd5f2fa8c5&#34;,&#34;alt&#34;:&#34;&#34;}" data-wp-block-name="core/image"><img alt="Image" src="https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_6-1024x239.jpg" srcset="https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_6.jpg 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_6.jpg 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_6.jpg 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_6.jpg 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=2048,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_6.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px" loading="lazy" width="1024" height="239"/><figcaption>Figure 6: Architecture of NilAway.</figcaption></figure></div>

<p>NilAway is implemented in Go and uses the <span><a href="https://pkg.go.dev/golang.org/x/tools/go/analysis" target="_blank" rel="noreferrer noopener">go/analysis</a></span> framework for the analysis of code. Figure 6 shows an overview of NilAway’s architecture. NilAway takes as input standard Go code, in the form of a target package path containing the code, and returns as output the potential nil panic errors that it identifies through its analysis. NilAway is implemented as an analyzer that can be used as an independent tool or, optionally, can also be easily integrated into a build system, such as <span><a href="https://bazel.build/" target="_blank" rel="noreferrer noopener">Bazel</a></span>, with existing analyzer drivers, such as <span><a href="https://github.com/bazelbuild/rules_go/blob/master/go/nogo.rst" target="_blank" rel="noreferrer noopener">nogo</a></span>.</p>


<p>Broadly, the implementation of NilAway can be divided into 3 components: the Analyzer Engine, the Inference Engine, and the Error Engine. The <strong>Analyzer Engine</strong> is responsible for identifying all potential nil flows within a function independently (i.e., intra-procedurally), while the <strong>Inference Engine</strong> is responsible for collecting witnessed nilability values for different program sites and propagating this information through inter-procedural flows by building the implication graph. Finally, the <strong>Error Engine</strong> accumulates the information from both the Analyzer Engine and the Inference Engine, and marks each potential nil flow (intra- and inter-procedural) as <em>safe</em> or <em>unsafe</em>. Unsafe nil flows are then reported to the user as potential nil panic errors.</p>


<p>Powered with the novel constraint-based approach to detect nil panics, NilAway aptly satisfies the four requirements listed above:</p>


<div><ul><li><strong>NilAway is fast</strong>. Independent analysis of each function in the Analyzer Engine makes it amenable to parallelization, which is a major performance enhancer. Furthermore, we have designed NilAway to construct the global implication graph incrementally by leveraging build cache, avoiding expensive re-building of the dependencies. This careful engineering makes NilAway fast and scalable, making it suitable for large codebases. In our measurements at Uber, we have observed that NilAway added only a small overhead (less than 5%) to the normal build process.</li>


<li><strong>NilAway is practical</strong>. To keep NilAway precise, the Analyzer Engine is designed and implemented to support many common Go language idiosyncrasies. Our Error Engine is also carefully designed to only report errors when an unsafe nil flow is evidenced. Having said that, we don’t claim our approach to be either sound or complete, instead having practical bug finding as our northstar. NilAway may incur both false positives and false negatives. However, we are continuously striving hard to reduce them and make NilAway precise. NilAway has been observed to work well in practice when deployed at Uber (as discussed subsequently), catching most of the potential nil panics in new code, allowing NilAway to maintain a good balance between usefulness and performance overhead.</li>


<li><strong>NilAway is fully automated</strong>. Our constraint-based approach makes it a natural fit for inference, which allows NilAway to operate in a fully automated mode with no annotations required.</li>
</ul></div>


<hr aria-hidden="true" role="separator"/>





<p>NilAway is deployed centrally in the Go monorepo, integrating tightly with the Bazel+Nogo framework, allowing it to run as a default linter on every build in the CI pipeline and local builds. The error reporting is, however, in the testing phase, where nil panic errors are only reported for services in the Go monorepo that are onboarded onto NilAway. </p>


<p>For service owners, we currently offer two options of error reporting: (1) comprehensive and blocking, and (2) stop-the-bleed and non-blocking. </p>


<p>In the first option, NilAway causes the build to fail, if any errors are found (suppressions are possible if needed, through <em>//nolint:nilaway</em>). NilAway comprehensively reports errors on all code, existing and new. This option is preferable to ensure a nil panic free codebase. However, it requires all reported nil panics in the service’s code to be addressed, before any build can be allowed to pass. This may incur a high upfront cost for the service’s development, which can cause friction among service owners.</p>


<p>To address the above problem, we offer a lightweight version in Option 2, in which we only report NilAway errors for changed code in the service. These errors are directly reported in a non-blocking way on every differential code revision (i.e., a pull request) of the onboarded service. This stop-the-bleed approach helps to prevent new nil panics from being introduced into the service code, while allowing teams to gradually address nil panics in existing code without the need for a development-slowing upfront onboarding effort.</p>


<p>We have onboarded several services at Uber onto NilAway, across both the options, and the overall feedback that we have received from the teams has been positive. One such happy user says “<em>NilAway has helped their team catch issues early, preventing deployment rollbacks,</em>” while another says “<em>The comments left by NilAway are very actionable and it hasn’t caused any noise.</em>” The users also actively report false positives that they may encounter and suggest usability improvements that we actively work upon.</p>





<p>We now discuss one interesting case, where NilAway reported an important error in a service that was logging over 3,000 nil panics per day in production code. Figure 7 shows a simplified and redacted excerpt of the code causing the nil panic. This example uses the message passing construct of Go called <span><a href="https://go.dev/tour/concurrency/2" target="_blank" rel="noreferrer noopener">channel</a></span>. On line L16, the function call to <em>t.s.foo(…)</em> returns a channel <em>ch</em> which is subsequently received by the variable a. Unfortunately, Go allows reading from a closed channel, in which case a zero-value (i.e., nil) would be returned. If the code path L7-&gt;L8-&gt;L5 is taken in the function <em>foo</em>, the channel would be closed without anything written to it. This will cause a nil panic at the dereference point <em>a.Items[*id] </em>on line L17. NilAway correctly reported this error since it witnessed an unsafe dereference on the variable that may be received from a closed channel.</p>


<div><figure data-wp-block="{&#34;align&#34;:&#34;center&#34;,&#34;id&#34;:1067349,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;hash&#34;:&#34;1a9052b4-59dc-4d6d-b99e-63924eabcf2f&#34;,&#34;alt&#34;:&#34;&#34;}" data-wp-block-name="core/image"><img alt="Image" src="https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_7-1024x611.jpg" srcset="https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_7.jpg 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_7.jpg 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_7.jpg 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1536,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_7.jpg 1536w, https://blog.uber-cdn.com/cdn-cgi/image/width=1955,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_7.jpg 1955w" sizes="(max-width: 1024px) 100vw, 1024px" loading="lazy" width="1024" height="611"/><figcaption>Figure 7: Simplified and redacted code excerpt from an internal Uber service logging 3000+ nil panics per day in production.</figcaption></figure></div>

<p>The fix for this problem is to properly guard the receive from a closed channel, either using the ok construct of Go (e.g., <em>if a, ok := &lt;-t.s.foo(…); ok { … }</em>) or by a nilness check on the result variable a (e.g., <em>if a != nil { … }</em>) before the dereference on L17. Our developers applied the nilness check fix right after NilAway reported this error, and the impact was remarkable: the service went from logging 3,000+ nil panics daily to 0, as shown in Figure 8.</p>


<div><figure data-wp-block="{&#34;align&#34;:&#34;center&#34;,&#34;id&#34;:1067353,&#34;sizeSlug&#34;:&#34;large&#34;,&#34;linkDestination&#34;:&#34;none&#34;,&#34;hash&#34;:&#34;444098ee-ef59-4b4b-9fab-2c294f43a095&#34;,&#34;alt&#34;:&#34;&#34;}" data-wp-block-name="core/image"><img alt="Image" src="https://blog.uber-cdn.com/cdn-cgi/image/width=2160,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_8-1024x231.jpg" srcset="https://blog.uber-cdn.com/cdn-cgi/image/width=1024,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_8.jpg 1024w, https://blog.uber-cdn.com/cdn-cgi/image/width=300,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_8.jpg 300w, https://blog.uber-cdn.com/cdn-cgi/image/width=768,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_8.jpg 768w, https://blog.uber-cdn.com/cdn-cgi/image/width=1252,quality=80,onerror=redirect,format=auto/wp-content/uploads/2023/11/figure_8.jpg 1252w" sizes="(max-width: 1024px) 100vw, 1024px" loading="lazy" width="1024" height="231"/><figcaption>Figure 8: Complete addressal of the 3000+ nil panics being logged per day in production.</figcaption></figure></div>

<hr aria-hidden="true" role="separator"/>





<p>We are happy to announce that NilAway is now open source at <span><a href="https://github.com/uber-go/nilaway/" target="_blank" rel="noreferrer noopener">https://github.com/uber-go/nilaway/</a></span>. We believe NilAway will be useful for any individual or team that implements code in Go and wants to ensure a nil-panic-free codebase.</p>


<p>Setting up NilAway is fairly straightforward. It can be used as a standalone checker or integrated with existing drivers. Refer to the <span><a href="https://github.com/uber-go/nilaway/" target="_blank" rel="noreferrer noopener">README</a></span> and <span><a href="https://github.com/uber-go/nilaway/wiki" target="_blank" rel="noreferrer noopener">wiki</a></span> for more details. </p>


<p>Try NilAway today and let us know your experience. We also welcome contributions from the community.</p>


<hr aria-hidden="true" role="separator"/>


<p><h2 id="h-acknowledgements">Acknowledgements</h2></p>


<p>NilAway began as the internship project of Joshua Turcotti (Uber intern ’22) and benefited from the very significant contributions of the following Uber Ph.D. interns: Shubham Ugare, Narges Shadab, and Zhiqiang Zang. We also would like to thank the Go monorepo team at Uber for collaborating with us in building NilAway, with special thanks to Dmitriy Shirchenko.</p>



</div></div>
  </body>
</html>
