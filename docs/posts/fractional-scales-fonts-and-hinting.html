<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.gtk.org/2024/03/07/on-fractional-scales-fonts-and-hinting/">Original</a>
    <h1>Fractional scales, fonts and hinting</h1>
    
    <div id="readability-page-1" class="page"><article id="post-9942">
	<!-- .entry-header -->

	
	
	<div>
		<p>GTK 4.14 will be released very soon, with new renderers that were <a href="https://blog.gtk.org/2024/01/28/new-renderers-for-gtk/">introduced</a> earlier this year.</p>
<p>The new renderers have much improved support for fractional scaling—on my system, I now use 125% scaling instead of the ‘Large Text’ setting, and I find that works fine for my needs.</p>
<h3>Magical numbers</h3>
<p>Ever since 4.0, GTK has been advocating for linear layout.</p>
<p>The idea is that we just place glyphs where the coordinates tell us, and if that is a fractional position somewhere between pixels, so be it, we can render the outline at that offset just fine. This approach works—if your output device has a high-enough resolution (anything above 240 dpi should be ok). Sadly, we don’t live in a world where most laptop screens have that kind of resolution, so we can’t just ignore pixels.</p>
<p>Consequently, we added the <a href="https://docs.gtk.org/gtk4/property.Settings.gtk-hint-font-metrics.html">gtk-hint-font-metrics</a> setting that forces text layout to round things to integer positions. This is not a great fit for fractional scaling, since the rounding happens in application pixels, and we really need integral device pixel positions to produce crisp results.</p>
<figure id="attachment_10026" aria-describedby="caption-attachment-10026"><a href="https://blog.gtk.org/files/2024/03/test-3.png"><img fetchpriority="high" decoding="async" src="https://blog.gtk.org/files/2024/03/test-3.png" alt="" width="660" height="570" srcset="https://blog.gtk.org/files/2024/03/test-3.png 660w, https://blog.gtk.org/files/2024/03/test-3-300x259.png 300w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 984px) 61vw, (max-width: 1362px) 45vw, 600px"/></a><figcaption id="caption-attachment-10026">Application vs. device pixels</figcaption></figure>
<p>The common fractional scales are 125%, 150%, 175%, 200% and 225%. At these scales (with the exception of 200%), most application pixel boundaries do not align with device pixel boundaries.</p>
<h3>What now?</h3>
<p>The new renderers gave us an opportunity to revisit the topic of font rendering and do some <a href="https://gitlab.gnome.org/GNOME/gtk/-/merge_requests/6936#note_2032955">research</a> on the mechanics of hinting options, and how they get passed down the stack from GTK through Pango and cairo, and then end up in freetype as a combination of render target + load flags.</p>
<figure id="attachment_9972" aria-describedby="caption-attachment-9972"><a href="https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-04-10-22-51.png"><img decoding="async" src="https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-04-10-22-51.png" alt="" width="805" height="241" srcset="https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-04-10-22-51.png 805w, https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-04-10-22-51-300x90.png 300w, https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-04-10-22-51-768x230.png 768w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 984px) 61vw, (max-width: 1362px) 45vw, 600px"/></a><figcaption id="caption-attachment-9972">Hint style and antialiasing options translate to render mode and load flags</figcaption></figure>
<p>The new renders recognize that there’s two basic modes of operation when it comes to glyphs:</p>
<ul>
<li>optimize for uniform spacing</li>
<li>optimize for crisp rendering</li>
</ul>
<p>The former leads to subpixel positioning and unhinted rendering, the latter to hinted rendering and glyphs that are placed at integral pixel positions (since that is what the autohinter expects).</p>
<p>We determine which case we’re in by looking at the <a href="https://www.cairographics.org/manual/cairo-cairo-font-options-t.html">font options</a>. If they tell us to do hinting, we round the glyph position to an integral device pixel in the y direction. <em>Why only y?</em> The autohinter only applies hinting in the vertical direction and the horizontal direction is where the increased resolution of subpixel positions helps most. If we are not hinting, then we use subpixel positions for both x and y, just like the old renderer.</p>
<h3>A comparison</h3>
<p>Text rendering differences are always subtle and, to some degree, a matter a taste and preference. So these screenshots should be taken with a grain of salt—it is much better to try the new renderers for yourself.</p>
<figure id="attachment_10035" aria-describedby="caption-attachment-10035"><a href="https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-06-21-44-21.png"><img decoding="async" src="https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-06-21-44-21.png" alt="" width="631" height="311" srcset="https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-06-21-44-21.png 631w, https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-06-21-44-21-300x148.png 300w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 984px) 61vw, (max-width: 1362px) 45vw, 600px"/></a><figcaption id="caption-attachment-10035">Text rendered at 125%, old renderer</figcaption></figure>
<figure id="attachment_9981" aria-describedby="caption-attachment-9981"><a href="https://blog.gtk.org/files/2024/03/hinting-125.png"><img loading="lazy" decoding="async" src="https://blog.gtk.org/files/2024/03/hinting-125.png" alt="" width="627" height="312" srcset="https://blog.gtk.org/files/2024/03/hinting-125.png 627w, https://blog.gtk.org/files/2024/03/hinting-125-300x149.png 300w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 984px) 61vw, (max-width: 1362px) 45vw, 600px"/></a><figcaption id="caption-attachment-9981">Text rendered at 125%, new renderer</figcaption></figure>
<p>Both of these renderings were done at a scale of 125%, with hinting enabled.</p>
<p>Here is a look at some details: the horizontal bars of T and e are consistent across lines, even though we still allow the glyphs to shift by subpixel positions horizontally.</p>
<figure id="attachment_10059" aria-describedby="caption-attachment-10059"><a href="https://blog.gtk.org/files/2024/03/consitenTe.png"><img loading="lazy" decoding="async" src="https://blog.gtk.org/files/2024/03/consitenTe.png" alt="" width="627" height="312" srcset="https://blog.gtk.org/files/2024/03/consitenTe.png 627w, https://blog.gtk.org/files/2024/03/consitenTe-300x149.png 300w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 984px) 61vw, (max-width: 1362px) 45vw, 600px"/></a><figcaption id="caption-attachment-10059">Consistent vertical placement</figcaption></figure>
<figure id="attachment_10053" aria-describedby="caption-attachment-10053"><a href="https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-06-22-09-36.png"><img loading="lazy" decoding="async" src="https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-06-22-09-36.png" alt="" width="600" height="175" srcset="https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-06-22-09-36.png 992w, https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-06-22-09-36-300x88.png 300w, https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-06-22-09-36-768x225.png 768w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 984px) 61vw, (max-width: 1362px) 45vw, 600px"/></a><figcaption id="caption-attachment-10053">Instances of T and e, old renderer</figcaption></figure>
<figure id="attachment_10056" aria-describedby="caption-attachment-10056"><a href="https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-06-22-10-54.png"><img loading="lazy" decoding="async" src="https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-06-22-10-54.png" alt="" width="600" height="175" srcset="https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-06-22-10-54.png 992w, https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-06-22-10-54-300x88.png 300w, https://blog.gtk.org/files/2024/03/Screenshot-from-2024-03-06-22-10-54-768x225.png 768w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 984px) 61vw, (max-width: 1362px) 45vw, 600px"/></a><figcaption id="caption-attachment-10056">Instances of T and e, new renderer</figcaption></figure>
<h3>Summary</h3>
<p>The new renderers in GTK 4.14 should produce more crisp font rendering, in particular with fractional scaling.</p>
<p>Please try it out and tell us what you think.</p>
<h3>Update: On subpixel rendering</h3>
<p>I should have anticipated that this question would come up, so here is a quick answer:</p>
<p>We are not using subpixel rendering (aka Cleartype, or rgb antialiasing) in GTK 4, since our compositing does not have component alpha. Our antialiasing for fonts is always grayscale. Note that subixel <em>rendering</em> is something separate from subpixel <em>positioning</em>.</p>
	</div><!-- .entry-content -->

	<!-- .entry-footer -->
</article></div>
  </body>
</html>
