<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.ruby-lang.org/en/news/2022/04/03/ruby-3-2-0-preview1-released/">Original</a>
    <h1>Ruby 3.2 preview 1 with support for WASM compilation</h1>
    
    <div id="readability-page-1" class="page"><div id="content">
    <p>Posted by naruse on 3 Apr 2022</p>

    
<p>We are pleased to announce the release of Ruby 3.2.0-preview1. Ruby 3.2 adds many features and performance improvements.</p>

<h2>WASI based WebAssembly support</h2>

<p>This is an initial port of WASI based WebAssembly support. This enables a CRuby binary to be available on Web browser, Serverless Edge environment, and other WebAssembly/WASI embedders. Currently this port passes basic and bootstrap test suites not using Thread API.</p>

<p><img src="https://i.imgur.com/opCgKy2.png" alt=""/></p>

<h3>Background</h3>

<p><a href="https://webassembly.org/">WebAssembly (WASM)</a> is originally introduced to run programs safely and fast in web browsers. But its objective - running programs efficinently with security on various environment - is long wanted not only by web but also by general applications.</p>

<p><a href="https://wasi.dev/">WASI (The WebAssembly System Interface)</a> is designed for such use cases. Though such applications need to communicate with operating systems, WebAssembly runs on a virtual machine which didn’t have a system interface. WASI standardizes it.</p>

<p>WebAssembly/WASI Support in Ruby intends to leverage those projects. It enables Ruby developers to write applications which runs on such promised platform.</p>

<h3>Use case</h3>

<p>This support encourages developers can utilize CRuby in WebAssembly environment. An example use case of it is <a href="https://try.ruby-lang.org/playground/">TryRuby playground</a>’s CRuby support. Now you can try original CRuby in your web browser.</p>

<h3>Technical points</h3>

<p>Today’s WASI and WebAssembly itself has some missing features to implement Fiber, exception, and GC because it’s still evolving and also for security reasons. So CRuby fills the gap by using Asyncify, which is a binary transformation technique to control execution in userland.</p>

<p>In addition, we built <a href="https://github.com/kateinoigakukun/wasi-vfs/wiki/Getting-Started-with-CRuby">a VFS on top of WASI</a> so that we can easily pack Ruby apps into a single .wasm file. This makes distribution of Ruby apps a bit easier.</p>

<h3>Related links</h3>

<ul>
  <li><a href="https://github.com/ruby/ruby/pull/5407">Add WASI based WebAssembly support #5407</a></li>
  <li><a href="https://itnext.io/final-report-webassembly-wasi-support-in-ruby-4aface7d90c9">An Update on WebAssembly/WASI Support in Ruby</a></li>
</ul>

<h2>Regexp timeout</h2>

<p>A timeout feature for Regexp matching is introduced.</p>

<div><div><pre><code><span>Regexp</span><span>.</span><span>timeout</span> <span>=</span> <span>1.0</span>

<span>/^a*b?a*$/</span> <span>=~</span> <span>&#34;a&#34;</span> <span>*</span> <span>50000</span> <span>+</span> <span>&#34;x&#34;</span>
<span>#=&gt; Regexp::TimeoutError is raised in one second</span>
</code></pre></div></div>

<p>It is known that Regexp matching may take unexpectedly long. If your code attempts to match an possibly inefficient Regexp against an untrusted input, an attacker may exploit it for efficient Denial of Service (so-called Regular expression DoS, or ReDoS).</p>

<p>The risk of DoS can be prevented or significantly mitigated by configuring <code>Regexp.timeout</code> according to the requirements of your Ruby application. Please try it out in your application and welcome your feedback.</p>

<p>Note that <code>Regexp.timeout</code> is a global configuration. If you want to use different timeout settings for some special Regexps, you may want to use <code>timeout</code> keyword for <code>Regexp.new</code>.</p>

<div><div><pre><code><span>Regexp</span><span>.</span><span>timeout</span> <span>=</span> <span>1.0</span>

<span># This regexp has no timeout</span>
<span>long_time_re</span> <span>=</span> <span>Regexp</span><span>.</span><span>new</span><span>(</span><span>&#34;^a*b?a*$&#34;</span><span>,</span> <span>timeout: </span><span>nil</span><span>)</span>

<span>long_time_re</span> <span>=~</span> <span>&#34;a&#34;</span> <span>*</span> <span>50000</span> <span>+</span> <span>&#34;x&#34;</span> <span># never interrupted</span>
</code></pre></div></div>

<p>The original proposal is https://bugs.ruby-lang.org/issues/17837</p>

<h2>Other Notable New Features</h2>

<h3>No longer bundle 3rd party sources</h3>

<ul>
  <li>
    <p>We no longer bundle 3rd party sources like <code>libyaml</code>, <code>libffi</code>.</p>

    <ul>
      <li>
        <p>libyaml source has been removed from psych. You may need to install <code>libyaml-dev</code> with Ubuntu/Debian platfrom. The package name is different each platforms.</p>
      </li>
      <li>
        <p>libffi will be removed from <code>fiddle</code> at preview2</p>
      </li>
    </ul>
  </li>
</ul>

<h3>Language</h3>

<ul>
  <li>Find pattern is no longer experimental.</li>
</ul>

<h2>Performance improvements</h2>

<h2>Other notable changes since 3.1</h2>

<ul>
  <li>Hash
    <ul>
      <li>Hash#shift now always returns nil if the hash is
empty, instead of returning the default value or
calling the default proc. [[Bug #16908]]</li>
    </ul>
  </li>
  <li>MatchData
    <ul>
      <li>MatchData#byteoffset has been added. [[Feature #13110]]</li>
    </ul>
  </li>
  <li>Module
    <ul>
      <li>Module.used_refinements has been added. [[Feature #14332]]</li>
      <li>Module#refinements has been added. [[Feature #12737]]</li>
      <li>Module#const_added has been added. [[Feature #17881]]</li>
    </ul>
  </li>
  <li>Proc
    <ul>
      <li>Proc#dup returns an instance of subclass. [[Bug #17545]]</li>
      <li>Proc#parameters now accepts lambda keyword. [[Feature #15357]]</li>
    </ul>
  </li>
  <li>Refinement
    <ul>
      <li>Refinement#refined_class has been added. [[Feature #12737]]</li>
    </ul>
  </li>
  <li>Set
    <ul>
      <li>Set is now available as a builtin class without the need for <code>require &#34;set&#34;</code>. [[Feature #16989]]
It is currently autoloaded via the <code>Set</code> constant or a call to <code>Enumerable#to_set</code>.</li>
    </ul>
  </li>
  <li>String
    <ul>
      <li>String#byteindex and String#byterindex have been added. [[Feature #13110]]</li>
      <li>Update Unicode to Version 14.0.0 and Emoji Version 14.0. [[Feature #18037]]
(also applies to Regexp)</li>
      <li>String#bytesplice has been added.  [[Feature #18598]]</li>
    </ul>
  </li>
  <li>Struct
    <ul>
      <li>A Struct class can also be initialized with keyword arguments
without <code>keyword_init: true</code> on <code>Struct.new</code> [[Feature #16806]]</li>
    </ul>
  </li>
</ul>

<h3>Standard libraries updates</h3>

<ul>
  <li>
    <p>The following default gem are updated.</p>

    <ul>
      <li>TBD</li>
    </ul>
  </li>
  <li>
    <p>The following bundled gems are updated.</p>

    <ul>
      <li>TBD</li>
    </ul>
  </li>
  <li>
    <p>The following default gems are now bundled gems. You need to add the following libraries to <code>Gemfile</code> under the bundler environment.</p>

    <ul>
      <li>TBD</li>
    </ul>
  </li>
</ul>

<p>See <a href="https://github.com/ruby/ruby/blob/v3_2_0_preview1/NEWS.md">NEWS</a>
or <a href="https://github.com/ruby/ruby/compare/v3_1_0...v3_2_0_preview1">commit logs</a>
for more details.</p>

<p>With those changes, <a href="https://github.com/ruby/ruby/compare/v3_1_0...v3_2_0_preview1#file_bucket">1058 files changed, 34946 insertions(+), 29962 deletions(-)</a>
since Ruby 3.1.0!</p>

<h2>Download</h2>

<ul>
  <li>
    <p><a href="https://cache.ruby-lang.org/pub/ruby/3.2/ruby-3.2.0-preview1.tar.gz">https://cache.ruby-lang.org/pub/ruby/3.2/ruby-3.2.0-preview1.tar.gz</a></p>

    <div><div><pre><code>SIZE: 20728782
SHA1: 7c4197e67f230b0c5d011f4efb9b9158743a61c8
SHA256: 6946b966c561d5dfc2a662b88e8211be30bfffc7bb2f37ce3cc62d6c46a0b818
SHA512: d24e77161996c2085f613a86d1ed5ef5c5bf0e18eb459f6a93a0014a5d2ce41079283b4283d24cb96448a0986c8c6c52a04584abd4e73911ea59cefeb786836e
</code></pre></div>    </div>
  </li>
  <li>
    <p><a href="https://cache.ruby-lang.org/pub/ruby/3.2/ruby-3.2.0-preview1.tar.xz">https://cache.ruby-lang.org/pub/ruby/3.2/ruby-3.2.0-preview1.tar.xz</a></p>

    <div><div><pre><code>SIZE: 15011400
SHA1: 6bcc30ac670ab391997e0d68ba97b451db078934
SHA256: 6d28477f7fa626b63bf139afd37bcfeb28fce6847b203fa10f37cb3615d0c35d
SHA512: 0eca2c346b995d265df2659b4215ff96e515c29926c2a6256caad99db9c4c51fec1a2d899ca63a00010d4111060dc0fdd4f591be84c0a2c43b6303879de3c5de
</code></pre></div>    </div>
  </li>
  <li>
    <p><a href="https://cache.ruby-lang.org/pub/ruby/3.2/ruby-3.2.0-preview1.zip">https://cache.ruby-lang.org/pub/ruby/3.2/ruby-3.2.0-preview1.zip</a></p>

    <div><div><pre><code>SIZE: 25370458
SHA1: 3c93c2e775366eec6e93cf670fc8677934cb4e48
SHA256: 24f8ae73d56366453defb0654de624bd1c063921a1d7ac780e4da56bb8fbf7e4
SHA512: 9754f11aa167df167d1b336e5c660aab1bd9e12421c093e0fe96e9a2da4ffb9859b7ea5263473bbc7b57ac8b5568cf7ac3116c0abdc647e1ff97a8d060ff7eae
</code></pre></div>    </div>
  </li>
</ul>

<h2>What is Ruby</h2>

<p>Ruby was first developed by Matz (Yukihiro Matsumoto) in 1993,
and is now developed as Open Source. It runs on multiple platforms
and is used all over the world especially for web development.</p>

  </div></div>
  </body>
</html>
