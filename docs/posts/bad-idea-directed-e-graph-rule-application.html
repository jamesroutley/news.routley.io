<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/saulshanabrook/saulshanabrook/discussions/38">Original</a>
    <h1>Bad Idea: Directed e-graph rule application</h1>
    
    <div id="readability-page-1" class="page"><div><section aria-labelledby="file-name-id-wide file-name-id-mobile"><div data-hpc="true"><article itemprop="text"><div dir="auto"><a id="user-content-unix-in-lisp-shell-tutorial" aria-label="Permalink: Unix in Lisp shell tutorial" href="#unix-in-lisp-shell-tutorial"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div dir="auto"><a id="user-content-the-missing-semester" aria-label="Permalink: The missing semester" href="#the-missing-semester"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div dir="auto"><h2 tabindex="-1" dir="auto">Shell Tools and Scripting</h2><a id="user-content-shell-tools-and-scripting" aria-label="Permalink: Shell Tools and Scripting" href="#shell-tools-and-scripting"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div dir="auto" data-snippet-clipboard-copy-content="mcd () {
    mkdir -p &#34;$1&#34;
    cd &#34;$1&#34;
}"><pre><span>mcd</span> () {
    mkdir -p <span><span>&#34;</span><span>$1</span><span>&#34;</span></span>
    <span>cd</span> <span><span>&#34;</span><span>$1</span><span>&#34;</span></span>
}</pre></div>
<div dir="auto" data-snippet-clipboard-copy-content="(defmacro mcd (dir)
  `(fg
     (mkdir -p ,dir)
     (cd ,dir)))"><pre>(<span>defmacro</span> <span>mcd</span> (dir)
  <span>`</span>(fg
     (mkdir -p <span>,</span>dir)
     (cd <span>,</span>dir)))</pre></div>
<div dir="auto"><h2 tabindex="-1" dir="auto">Data Wrangling</h2><a id="user-content-data-wrangling" aria-label="Permalink: Data Wrangling" href="#data-wrangling"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To get the data, in POSIX shell they write:</p>
<div dir="auto" data-snippet-clipboard-copy-content="ssh myserver journalctl"><pre>ssh myserver journalctl</pre></div>
<p dir="auto">In Unix in Lisp, we write something very similar:</p>
<div dir="auto" data-snippet-clipboard-copy-content="(def journal (ssh myserver journalctl))"><pre>(def journal (ssh myserver journalctl))</pre></div>
<p dir="auto">Note that we conveniently store the result into <code>journal</code> so we can use it later. In POSIX shell they may use a temporary file, and they may be relunctant to do so to avoid littering in the file system. In any case, if we also want to store it in a file, just</p>
<div dir="auto" data-snippet-clipboard-copy-content="(defile journal.log (ssh myserver journalctl))"><pre>(defile journal.log (ssh myserver journalctl))</pre></div>
<p dir="auto">In POSIX shell, they do the following to narrow down the lines.</p>
<div dir="auto" data-snippet-clipboard-copy-content="ssh myserver journalctl | grep sshd"><pre>ssh myserver journalctl <span>|</span> grep sshd</pre></div>
<p dir="auto">In Unix in Lisp, we may do something similar</p>
<div dir="auto" data-snippet-clipboard-copy-content="(pipe journal (grep sshd))"><pre>(pipe journal (grep sshd))</pre></div>
<p dir="auto">We may do the same thing in a way that looks like more “common” Lisp:</p>
<div dir="auto" data-snippet-clipboard-copy-content="(filter (lambda (line) (ppcre:scan &#34;sshd&#34; line)) journal)"><pre>(filter (<span>lambda</span> (line) (<span>ppcre</span>:scan <span><span>&#34;</span>sshd<span>&#34;</span></span> line)) journal)</pre></div>
<p dir="auto">In POSIX shell, they do the following to narrow down more:</p>
<div dir="auto" data-snippet-clipboard-copy-content="ssh myserver journalctl
 | grep sshd
 | grep &#34;Disconnected from&#34;"><pre>ssh myserver journalctl
 <span>|</span> grep sshd
 <span>|</span> grep <span><span>&#34;</span>Disconnected from<span>&#34;</span></span></pre></div>
<p dir="auto">We can translate it “literally” into Unix in Lisp:</p>
<div dir="auto" data-snippet-clipboard-copy-content="(pipe journal (grep sshd) (grep &#34;Disconnected from&#34;))"><pre>(pipe journal (grep sshd) (grep <span><span>&#34;</span>Disconnected from<span>&#34;</span></span>))</pre></div>
<p dir="auto">Or do it the more “common” way:</p>
<div dir="auto" data-snippet-clipboard-copy-content="(filter
 (lambda (line)
   (and (ppcre:scan &#34;sshd&#34; line)
        (ppcre:scan &#34;Disconnected from&#34; line)))
 journal)"><pre>(filter
 (<span>lambda</span> (line)
   (<span>and</span> (<span>ppcre</span>:scan <span><span>&#34;</span>sshd<span>&#34;</span></span> line)
        (<span>ppcre</span>:scan <span><span>&#34;</span>Disconnected from<span>&#34;</span></span> line)))
 journal)</pre></div>
<p dir="auto">Now, POSIX shell people write their intermediate result into a temporary file:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ ssh myserver &#39;journalctl | grep sshd | grep &#34;Disconnected from&#34;&#39; &gt; ssh.log
$ less ssh.log"><pre>$ ssh myserver <span><span>&#39;</span>journalctl | grep sshd | grep &#34;Disconnected from&#34;<span>&#39;</span></span> <span>&gt;</span> ssh.log
$ less ssh.log</pre></div>
<p dir="auto">We have our intermediate result ready for use in our REPL via <code>*,**,***</code> variables. We can also store them into variables via <code>def</code> and alike. If we really want to store it persistently, just</p>
<div dir="auto" data-snippet-clipboard-copy-content="(defile ssh.log ...)"><pre>(defile ssh.log ...)</pre></div>
<p dir="auto">POSIX shell people now use <code>sed</code> magic to pick out user names.</p>
<div dir="auto" data-snippet-clipboard-copy-content="ssh myserver journalctl
 | grep sshd
 | grep &#34;Disconnected from&#34;
 | sed -E &#39;s/.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( \[preauth\])?$/\2/&#39;"><pre>ssh myserver journalctl
 <span>|</span> grep sshd
 <span>|</span> grep <span><span>&#34;</span>Disconnected from<span>&#34;</span></span>
 <span>|</span> sed -E <span><span>&#39;</span>s/.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( \[preauth\])?$/\2/<span>&#39;</span></span></pre></div>
<p dir="auto">We still use regex magic here (using <code>cl-ppcre</code>), but no need for <code>sed</code> line editing witchery. We collect the matches for the user field into a list:</p>
<div dir="auto" data-snippet-clipboard-copy-content="(def users
  (collecting
   (do-each (line (ssh myserver journalctl))
     (ppcre:register-groups-bind (_ user)
         (&#34;.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( \\[preauth\\])?$&#34;
          line)
       (when user (collect user))))))"><pre>(def users
  (collecting
   (do-each (line (ssh myserver journalctl))
     (<span>ppcre</span>:register-groups-bind (_ user)
         (<span><span>&#34;</span>.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( <span>\\</span>[preauth<span>\\</span>])?$<span>&#34;</span></span>
          line)
       (<span>when</span> user (collect user))))))</pre></div>
<p dir="auto">Now, POSIX shell people use <code>sort</code> and <code>uniq</code> to count time of occurrences:</p>
<div dir="auto" data-snippet-clipboard-copy-content="ssh myserver journalctl
 | grep sshd
 | grep &#34;Disconnected from&#34;
 | sed -E &#39;s/.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( \[preauth\])?$/\2/&#39;
 | sort | uniq -c"><pre>ssh myserver journalctl
 <span>|</span> grep sshd
 <span>|</span> grep <span><span>&#34;</span>Disconnected from<span>&#34;</span></span>
 <span>|</span> sed -E <span><span>&#39;</span>s/.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( \[preauth\])?$/\2/<span>&#39;</span></span>
 <span>|</span> sort <span>|</span> uniq -c</pre></div>
<p dir="auto">We may do something just as insane as the above:</p>
<div dir="auto" data-snippet-clipboard-copy-content="(pipe users (sort) (uniq -c))"><pre>(pipe users (<span>sort</span>) (uniq -c))</pre></div>
<p dir="auto">The output is a list of table rows, each of them is a string separated by white spaces. Rather than meddling with these unstructured text, I recommend using structured data consisting of real lists and numbers.</p>
<div dir="auto" data-snippet-clipboard-copy-content="(def fail-users-alist (hash-table-alist (frequencies users)))"><pre>(def fail-users-alist (hash-table-alist (frequencies users)))</pre></div>
<p dir="auto">In POSIX shell, they use some more cryptic text-manipulating spells to sort the table and display the 10 users with most occurrences:</p>
<div dir="auto" data-snippet-clipboard-copy-content="ssh myserver journalctl
 | grep sshd
 | grep &#34;Disconnected from&#34;
 | sed -E &#39;s/.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( \[preauth\])?$/\2/&#39;
 | sort | uniq -c
 | sort -nk1,1 | tail -n10"><pre>ssh myserver journalctl
 <span>|</span> grep sshd
 <span>|</span> grep <span><span>&#34;</span>Disconnected from<span>&#34;</span></span>
 <span>|</span> sed -E <span><span>&#39;</span>s/.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( \[preauth\])?$/\2/<span>&#39;</span></span>
 <span>|</span> sort <span>|</span> uniq -c
 <span>|</span> sort -nk1,1 <span>|</span> tail -n10</pre></div>
<p dir="auto">In Lisp, we do it the structured data way:</p>
<div dir="auto" data-snippet-clipboard-copy-content="(def sus-users (subseq (sort fail-users-alist #&#39;&gt; :key #&#39;cdr) 0 10))"><pre>(def sus-users (<span>subseq</span> (<span>sort</span> fail-users-alist <span>#&#39;</span><span>&gt;</span> <span>:key</span> <span>#&#39;</span><span>cdr</span>) <span>0</span> <span>10</span>))</pre></div>
<p dir="auto">In POSIX shell, <code>awk</code> and <code>paste</code> to construct a comma separated list:</p>
<div dir="auto" data-snippet-clipboard-copy-content="ssh myserver journalctl
 | grep sshd
 | grep &#34;Disconnected from&#34;
 | sed -E &#39;s/.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( \[preauth\])?$/\2/&#39;
 | sort | uniq -c
 | sort -nk1,1 | tail -n10
 | awk &#39;{print $2}&#39; | paste -sd,"><pre>ssh myserver journalctl
 <span>|</span> grep sshd
 <span>|</span> grep <span><span>&#34;</span>Disconnected from<span>&#34;</span></span>
 <span>|</span> sed -E <span><span>&#39;</span>s/.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( \[preauth\])?$/\2/<span>&#39;</span></span>
 <span>|</span> sort <span>|</span> uniq -c
 <span>|</span> sort -nk1,1 <span>|</span> tail -n10
 <span>|</span> awk <span><span>&#39;</span>{print $2}<span>&#39;</span></span> <span>|</span> paste -sd,</pre></div>
<p dir="auto">In Lisp, we:</p>
<div dir="auto" data-snippet-clipboard-copy-content="(string-join (mapcar #&#39;car sus-users) &#34;,&#34;)"><pre>(string-join (<span>mapcar</span> <span>#&#39;</span><span>car</span> sus-users) <span><span>&#34;</span>,<span>&#34;</span></span>)</pre></div>
<div dir="auto"><h2 tabindex="-1" dir="auto">Analyzing data</h2><a id="user-content-analyzing-data" aria-label="Permalink: Analyzing data" href="#analyzing-data"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Now the POSIX crowd spirals deeper into insanity, constructing math expressions using string concatenation and passing to <code>bs</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="... | paste -sd+ | bc -l"><pre>... <span>|</span> paste -sd+ <span>|</span> bc -l</pre></div>
<p dir="auto">In Lisp, we simply:</p>
<div dir="auto" data-snippet-clipboard-copy-content="(reduce #&#39;+ (mapcar #&#39;cdr fail-users-alist))"><pre>(<span>reduce</span> <span>#&#39;</span><span>+</span> (<span>mapcar</span> <span>#&#39;</span><span>cdr</span> fail-users-alist))</pre></div>
<div dir="auto"><h2 tabindex="-1" dir="auto">Data wrangling to make arguments</h2><a id="user-content-data-wrangling-to-make-arguments" aria-label="Permalink: Data wrangling to make arguments" href="#data-wrangling-to-make-arguments"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The POSIX shell way:</p>
<div dir="auto" data-snippet-clipboard-copy-content="rustup toolchain list | grep nightly | grep -vE &#34;nightly-x86&#34; | sed &#39;s/-x86.*//&#39; | xargs rustup toolchain uninstall"><pre>rustup toolchain list <span>|</span> grep nightly <span>|</span> grep -vE <span><span>&#34;</span>nightly-x86<span>&#34;</span></span> <span>|</span> sed <span><span>&#39;</span>s/-x86.*//<span>&#39;</span></span> <span>|</span> xargs rustup toolchain uninstall</pre></div>
<p dir="auto">The Lisp way:</p>
<div dir="auto" data-snippet-clipboard-copy-content="(def unused-crabs
  (mapcan
   (lambda (l)
     (when (and (ppcre:scan &#34;nightly&#34; l)
                (not (ppcre:scan &#34;nightly-x86&#34; l)))
       (list (ppcre:regex-replace &#34;-x86.*&#34; l &#34;&#34;))))
   (rustup toolchain list)))
(rustup toolchain uninstall ,@unused-crabs)"><pre>(def unused-crabs
  (<span>mapcan</span>
   (<span>lambda</span> (l)
     (<span>when</span> (<span>and</span> (<span>ppcre</span>:scan <span><span>&#34;</span>nightly<span>&#34;</span></span> l)
                (<span>not</span> (<span>ppcre</span>:scan <span><span>&#34;</span>nightly-x86<span>&#34;</span></span> l)))
       (<span>list</span> (<span>ppcre</span>:regex-replace <span><span>&#34;</span>-x86.*<span>&#34;</span></span> l <span><span>&#34;</span><span>&#34;</span></span>))))
   (rustup toolchain <span>list</span>)))
(rustup toolchain uninstall <span>,@</span>unused-crabs)</pre></div>
</article></div></section></div></div>
  </body>
</html>
