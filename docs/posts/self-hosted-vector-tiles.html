<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.openstreetmap.org/user/rtnf/diary/400836">Original</a>
    <h1>Self-hosted vector tiles</h1>
    
    <div id="readability-page-1" class="page"><div xml:lang="en" lang="en">
    <p>Inspired by this <a href="https://www.youtube.com/watch?v=dF9UuVKOf34" rel="nofollow noopener noreferrer">video</a>, i want to make my own self-hosted vector tiles.</p>

<p>First, prepare several geojson file by using JOSM. Each geojson file will serve as a “layer”. We can specify the style for each layer. I made three layer (mainroad, suburb, jalan_rest), with this specification</p>

<ul>
  <li>mainroad : <code>highway= (secondary | primary | trunk | tertiary)</code></li>
  <li>suburb : <code>place=suburb</code></li>
  <li>jalan_rest : <code>highway= (* &amp;&amp; not secondary &amp;&amp; not primary &amp;&amp; not trunk &amp;&amp; not tertiary)</code></li>
</ul>

<p>Use JOSM, create overpass query, save as .geojson, repeat.</p>

<p><img src="https://pbs.twimg.com/media/FnZGm3XacAITL6h?format=png&amp;name=small" alt=""/></p>

<p>Second, convert these geojson file to mbtile format by using tippecanoe. Installing tippecanoe on MacOS / Linux is pretty straightforward. But, installing on Windows needs a quick-hack. I followed this guide , it works.</p>

<p><img src="https://cdn.masto.host/enosmtown/media_attachments/files/109/748/729/066/646/780/original/37b061dafbb43e98.png" alt=""/></p>

<p>Then combine all those geojson file into one mbtile file by using tippecanoe.</p>

<p><img src="https://pbs.twimg.com/media/FnZGgHUaAAAHiuG?format=png&amp;name=small" alt=""/></p>

<p>Then, convert that mbtile file to pmtile by using <a href="https://github.com/protomaps/go-pmtiles/releases" rel="nofollow noopener noreferrer">go-pmtiles</a></p>

<p><img src="https://pbs.twimg.com/media/FnZG93_agAIiaJc?format=png&amp;name=medium" alt=""/></p>

<p>Now, let’s display that mbtile and do some styling.</p>

<p><a href="https://github.com/altilunium/vmap/blob/main/index.html" rel="nofollow noopener noreferrer">Index.html</a>, first, let’s import maplibre-gl and pmtiles javascript library.</p>

<pre><code>&lt;script src=&#39;maplibre-gl.js&#39;&gt;&lt;/script&gt;
&lt;link href=&#39;maplibre-gl.css&#39; rel=&#39;stylesheet&#39; /&gt;
&lt;script src=&#34;pmtiles-2.5.0.js&#34;&gt;&lt;/script&gt;
</code></pre>

<p>Then, define the map</p>

<pre><code>let protocol = new pmtiles.Protocol();
        maplibregl.addProtocol(&#34;pmtiles&#34;,protocol.tile);
        console.log(maplibregl)
        var map = new maplibregl.Map({
            container: &#39;map&#39;,
            style: &#39;styles/maptiler-basic.json&#39;,
            center: [106.99811303126697,-6.295502009348816],
            zoom: 11
        });
</code></pre>

<p>The rest of the configurations are stored on that “<a href="https://github.com/altilunium/vmap/blob/main/styles/maptiler-basic.json" rel="nofollow noopener noreferrer">maptiler-basic.json</a>”.</p>

<p>Let’s configure the pmtiles file</p>

<pre><code>&#34;sources&#34;: {
    &#34;openmaptiles&#34;: {
      &#34;type&#34;: &#34;vector&#34;,
      &#34;url&#34;: &#34;pmtiles://bks2.pmtiles&#34;
    }
  }
</code></pre>

<p>Then, configure the <a href="https://github.com/openmaptiles/fonts/tree/gh-pages" rel="nofollow noopener noreferrer">fonts file</a></p>

<pre><code> &#34;glyphs&#34;: &#34;fonts-gh-pages/{fontstack}/{range}.pbf&#34;
</code></pre>

<p>Finally, configure the actual map style. Match the “layer” from tippecanoe’s output to “source-layer” tag.</p>

<h3 id="mainroad-layer-style-">Mainroad layer style :</h3>

<pre><code>{
      &#34;id&#34;: &#34;road_major_motorway&#34;,
      &#34;type&#34;: &#34;line&#34;,
      &#34;source&#34;: &#34;openmaptiles&#34;,
      &#34;source-layer&#34;: &#34;mainroad&#34;,
      &#34;layout&#34;: {&#34;line-cap&#34;: &#34;round&#34;, &#34;line-join&#34;: &#34;round&#34;},
      &#34;paint&#34;: {
        &#34;line-color&#34;: &#34;hsl(0, 0%, 100%)&#34;,
        &#34;line-offset&#34;: 0,
        &#34;line-width&#34;: {&#34;base&#34;: 1.4, &#34;stops&#34;: [[8, 1], [16, 10]]}
      }
    }
</code></pre>

<h3 id="suburb-layer-style">Suburb layer style</h3>

<pre><code>{
      &#34;id&#34;: &#34;place_label_city&#34;,
      &#34;type&#34;: &#34;symbol&#34;,
      &#34;source&#34;: &#34;openmaptiles&#34;,
      &#34;source-layer&#34;: &#34;suburb&#34;,
      &#34;maxzoom&#34;: 16,
      &#34;layout&#34;: {
        &#34;text-field&#34;: &#34;{name}&#34;,
        &#34;text-font&#34;: [&#34;Open Sans Regular&#34;],
        &#34;text-max-width&#34;: 10,
        &#34;text-size&#34;: {&#34;stops&#34;: [[3, 12], [8, 16]]}
      },
      &#34;paint&#34;: {
        &#34;text-color&#34;: &#34;hsl(0, 0%, 0%)&#34;,
        &#34;text-halo-blur&#34;: 0,
        &#34;text-halo-color&#34;: &#34;hsla(0, 0%, 100%, 0.75)&#34;,
        &#34;text-halo-width&#34;: 2
      }
    }
</code></pre>

<h3 id="jalan-rest-layer-style">Jalan-rest layer style</h3>

<pre><code>{
      &#34;id&#34;: &#34;road_minor&#34;,
      &#34;type&#34;: &#34;line&#34;,
      &#34;source&#34;: &#34;openmaptiles&#34;,
      &#34;source-layer&#34;: &#34;jalan_rest&#34;,
      &#34;minzoom&#34;: 13,
      &#34;layout&#34;: {&#34;line-cap&#34;: &#34;round&#34;, &#34;line-join&#34;: &#34;round&#34;},
      &#34;paint&#34;: {
        &#34;line-color&#34;: &#34;hsl(0, 0%, 97%)&#34;,
        &#34;line-width&#34;: {&#34;base&#34;: 1.55, &#34;stops&#34;: [[4, 0.25], [20, 30]]}
      }
    }
</code></pre>

<h3 id="road-label-configuration">Road label configuration</h3>

<pre><code> {
      &#34;id&#34;: &#34;road_major_label&#34;,
      &#34;type&#34;: &#34;symbol&#34;,
      &#34;source&#34;: &#34;openmaptiles&#34;,
      &#34;source-layer&#34;: &#34;mainroad&#34;,
      &#34;minzoom&#34;: 13,
      &#34;layout&#34;: {
        &#34;symbol-placement&#34;: &#34;line&#34;,
        &#34;text-field&#34;: &#34;{name}&#34;,
        &#34;text-font&#34;: [&#34;Open Sans Regular&#34;],
        &#34;text-letter-spacing&#34;: 0.1,
        &#34;text-rotation-alignment&#34;: &#34;map&#34;,
        &#34;text-size&#34;: {&#34;base&#34;: 1.4, &#34;stops&#34;: [[10, 8], [20, 14]]},
        &#34;text-transform&#34;: &#34;uppercase&#34;,
        &#34;visibility&#34;: &#34;visible&#34;
      },
      &#34;paint&#34;: {
        &#34;text-color&#34;: &#34;#000&#34;,
        &#34;text-halo-color&#34;: &#34;hsl(0, 0%, 100%)&#34;,
        &#34;text-halo-width&#34;: 2
      }
    },
    {
      &#34;id&#34;: &#34;road_minor_label&#34;,
      &#34;type&#34;: &#34;symbol&#34;,
      &#34;source&#34;: &#34;openmaptiles&#34;,
      &#34;source-layer&#34;: &#34;jalan_rest&#34;,
      &#34;minzoom&#34;: 13,
      &#34;layout&#34;: {
        &#34;symbol-placement&#34;: &#34;line&#34;,
        &#34;text-field&#34;: &#34;{name}&#34;,
        &#34;text-font&#34;: [&#34;Open Sans Regular&#34;],
        &#34;text-letter-spacing&#34;: 0.1,
        &#34;text-rotation-alignment&#34;: &#34;map&#34;,
        &#34;text-size&#34;: {&#34;base&#34;: 1.4, &#34;stops&#34;: [[10, 8], [20, 14]]},
        &#34;text-transform&#34;: &#34;uppercase&#34;,
        &#34;visibility&#34;: &#34;visible&#34;
      },
      &#34;paint&#34;: {
        &#34;text-color&#34;: &#34;#000&#34;,
        &#34;text-halo-color&#34;: &#34;hsl(0, 0%, 100%)&#34;,
        &#34;text-halo-width&#34;: 2
      }
    }
</code></pre>

<hr/>

<p>Done!</p>

<p><img src="https://cdn.masto.host/enosmtown/media_attachments/files/109/755/017/276/996/332/original/bdc1c2d36edf964d.png" alt=""/></p>

<ul>
  <li>Live-demo : <a href="https://altilunium.github.io/vmap/" rel="nofollow noopener noreferrer">https://altilunium.github.io/vmap/</a></li>
  <li>Repository : <a href="https://github.com/altilunium/vmap" rel="nofollow noopener noreferrer">https://github.com/altilunium/vmap</a></li>
  <li>“Live-tweet” : <a href="https://en.osm.town/@rtnf/109748479313976168" rel="nofollow noopener noreferrer">https://en.osm.town/@rtnf/109748479313976168</a></li>
</ul>

  </div></div>
  </body>
</html>
