<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://sharpscript.net/lisp/">Original</a>
    <h1>Sharpscript: Lisp for Scripting</h1>
    
    <div id="readability-page-1" class="page"><div id="body">

        

        <div id="content">
            
            <p><code>#Script</code> is designed as a small, expressive and wrist-friendly dynamic scripting language that for maximum familiarity
is modelled after the world&#39;s most popular and ubiquitous scripting Language, JavaScript. Its minimal syntax was inspired 
by other small but powerful languages which heavily utilizes functions instead of adopting a larger language grammar 
defining different bespoke syntax for language constructs.</p>
<p>Small Languages like Smalltalk, despite being one of the most influential languages in history, is famous for its minimal
<a href="https://en.wikipedia.org/wiki/Smalltalk#Syntax">syntax that fits on a post card</a>. A language with arguably better power 
to size ratio is <a href="https://en.wikipedia.org/wiki/Lisp_%28programming_language%29">Lisp</a> which the inventor of
Smalltalk, Alan Kay has credited it as being
the <a href="https://en.wikiquote.org/wiki/Lisp_%28programming_language%29">greatest single programming language ever designed</a>
after realizing: </p>
<blockquote>
<p>“the half page of code on the bottom of page 13… was Lisp in itself. These were 
<a href="http://www.michaelnielsen.org/ddi/lisp-as-the-maxwells-equations-of-software/">“Maxwell’s Equations of Software!”</a></p>
</blockquote>
<p><a href="http://languagelog.ldc.upenn.edu/myl/llog/jmc.pdf">Lisp&#39;s unprecedented elegance and simplicity</a> spawned a <a href="https://en.wikipedia.org/wiki/List_of_Lisp-family_programming_languages">myriad of dialects</a>,
some noteworthy implementations illustrating the beauty of its small size and expressive power is <a href="http://norvig.com/lispy.html">lispy</a> by
by <a href="http://norvig.com">Peter Norvig</a> (Director of Google Research) that implements a Lisp interpreter in just <strong>117 lines of Python 3 code</strong> (inc. a REPL).</p>
<p>Another compact dialect is <a href="https://github.com/zick/ZickStandardLisp">Zick Standard Lisp</a> which <a href="https://github.com/zick">@zick</a> 
has implemented in <strong>42 different languages</strong> including a <a href="https://github.com/zick/ZickStandardLisp/blob/master/lisp.lsp">recursive Lisp evaluator in Lisp</a>
implemented in only <strong>66 lines of code</strong>.</p>
<p>A more complete Lisp implementation in C# is the elegant <a href="https://github.com/nukata/lisp-in-cs">Nukata Lisp</a> 
by <a href="https://github.com/nukata">SUZUKI Hisao</a> which is a 
Common Lisp-like <a href="https://stackoverflow.com/q/4578574/85785">Lisp-1</a> dialect with tail call optimization and partially hygienic macros, although
has some notable limitations including a <a href="https://github.com/nukata/lisp-in-cs/blob/d4258ec4b5681b0854a0d464b708df9ae26bbe3c/lisp.cs#L1216-L1391">small standard library</a>, 
only uses the <code>double</code> numeric type and doesn&#39;t contain .NET Scripting support.</p>
<h3>Script Lisp Overview</h3>
<p><a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack.Common/Script/ScriptLanguage.Lisp.cs">ScriptLisp</a> is an
enhanced version of <a href="https://github.com/nukata/lisp-in-cs">Nukata Lisp</a> with a number of new features
that reuses <code>#Script</code> existing scripting capabilities to provide seamless integration with both the rest of <code>#Script</code>
(see <a href="https://sharpscript.net/docs/syntax#language-blocks-and-expressions">Language Blocks an Expressions</a>)
and .NET including <a href="https://sharpscript.net/docs/script-net">Scripting of .NET Types</a>, support for all .NET numeric types and access to its comprehensive 
library of over <strong>1000+</strong> <a href="https://sharpscript.net/docs/methods">Script Methods</a> - optimally designed for accessing .NET functionality from a dynamic language.</p>
<p>To improve compatibility with existing Common Lisp source code it also implements most of the <a href="http://jtra.cz/stuff/lisp/sclr/">Simplified Common Lisp Reference</a>
as well as all missing functions required to implement C# LINQ 101 Examples in Lisp:</p>

<p>To improve readability and familiarity it also adopts a number of <strong>Clojure</strong> syntax for defining a 
<a href="https://clojure.org/guides/learn/syntax#_literal_collections">data list and map</a> literals, 
<a href="https://clojure.org/guides/learn/functions#_anonymous_function_syntax">anonymous functions</a>, 
syntax in <a href="https://clojure.org/guides/learn/functions#_java_interop">Java Interop</a> for .NET Interop,
<a href="https://clojure.org/guides/learn/hashed_colls#_field_accessors">keyword syntax for indexing collections</a> and accessing index accessors
and Clojure&#39;s popular shorter aliases for <code>fn</code>, <code>def</code>, <code>defn</code> - improving source-code compatibility with Clojure.</p>
<h3>Lisp REPL</h3>
<p>In addition to being a 1st class language option in <code>#Script</code>, Lisp&#39;s dynamism and extensibility makes it particularly 
well suited for explanatory programming whose access via a REPL is now built into the latest 
<a href="https://docs.servicestack.net/dotnet-tool">x</a> and <a href="https://docs.servicestack.net/netcore-windows-desktop">app</a> dotnet tools 
which can be quickly installed in any Windows, macOS or Linux OS (with <a href="https://dotnet.microsoft.com/download/dotnet-core/3.0">.NET Core</a>) with: </p>
<pre><code>$ dotnet tool install -g x
</code></pre>

<p>Or if you have a previous version installed, update to the latest version with:</p>
<pre><code>$ dotnet tool update -g x
</code></pre>

<p>Where you&#39;ll then be able to bring up an instant Lisp REPL with:  
</p>
<pre><code>$ x lisp
</code></pre>

<p>The quick demo below shows the kind of exploratory programming available where you can query the <code>scriptMethods</code> available, 
query an objects <code>props</code>, query the Lisp interpreter&#39;s global <code>symbols</code> table containing all its global state including all 
defined lisp functions, macros and variables:</p>
<iframe width="896" height="525" src="https://www.youtube.com/embed/RR7yk6ReNnQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
<h3>Annotated REPL Walk through</h3>
<p>Here&#39;s an annotated version of the demo below which explains what each of the different expressions is doing.</p>
<p>Just like <a href="https://sharpscript.net/docs/sharp-scripts">Sharp Scripts</a> and <a href="https://sharpscript.net/docs/sharp-apps">Sharp Apps</a> the Lisp REPL runs within the 
<a href="https://sharpscript.net/docs/sharp-pages">#Script Pages</a> ScriptContext <a href="https://sharpscript.net/docs/sandbox">sandbox</a> that when run from a Sharp App folder, 
starts a .NET Core App Server that simulates a fully configured .NET Core App. 
In this case it&#39;s running in the <a href="https://github.com/sharp-apps/redis">redis Sharp App</a> directory where it was able to access its static web assets
as well as its redis-server connection configured in its <a href="https://github.com/sharp-apps/redis/blob/master/app.settings">app.settings</a>.</p>

<div><div><pre><span><span>;</span> quick lisp test!</span>
(+ <span>1</span> <span>2</span> <span>3</span>)

<span><span>;</span> List of ScriptMethodInfo that the ScriptContext running this Lisp Interpreter has access to</span>
scriptMethods

<span><span>;</span> first script method</span>
(:<span>0</span> scriptMethods)

<span><span>;</span> show public properties of ScriptMethodInfo </span>
(props (:<span>0</span> scriptMethods))

<span><span>;</span> show 1 property per line</span>
(joinln (props (:<span>0</span> scriptMethods)))

<span><span>;</span> show both Property Type and Name</span>
(joinln (propTypes (:<span>0</span> scriptMethods)))

<span><span>;</span> view the Names of all avaialble script methods</span>
(joinln (map .Name scriptMethods))

<span><span>;</span> view all script methods starting with &#39;a&#39;</span>
(globln <span><span>&#34;</span>a*<span>&#34;</span></span> (map .Name scriptMethods))

<span><span>;</span> view all script methods starting with &#39;env&#39;</span>
(globln <span><span>&#34;</span>env*<span>&#34;</span></span> (map .Name scriptMethods))

<span><span>;</span> print environment info about this machine seperated by spaces</span>
(printlns envOSVersion envMachineName envFrameworkDescription envLogicalDrives)

<span><span>;</span> expand logical drives</span>
(printlns envOSVersion envMachineName envFrameworkDescription <span><span>&#34;</span>- drives:<span>&#34;</span></span> (join envLogicalDrives <span><span>&#34;</span> <span>&#34;</span></span>))

<span><span>;</span> view all current global symbols defined in this Lisp interpreter</span>
symbols

<span><span>;</span> view all symbols starting with &#39;c&#39;</span>
(globln <span><span>&#34;</span>c*<span>&#34;</span></span> symbols)

<span><span>;</span> see how many symbols are defined in this interpreter</span>
(count symbols)

<span><span>;</span> see how many script methods there are available</span>
(count scriptMethods)

<span><span>;</span> view the method signature for all script methods starting with &#39;all&#39;</span>
(globln <span><span>&#34;</span>all*<span>&#34;</span></span> (map .Signature scriptMethods))

<span><span>;</span> count all files accessible from the configured ScriptContext</span>
(count allFiles)

<span><span>;</span> view the public properties of the first IVirtualFile</span>
(props (:<span>0</span> allFiles))

<span><span>;</span> display the VirtualPath of all available files</span>
(joinln (map .VirtualPath allFiles))

<span><span>;</span> display the method signature for all script methods starting with &#39;findFiles&#39;</span>
(globln <span><span>&#34;</span>findFiles*<span>&#34;</span></span> (map .Signature scriptMethods))

<span><span>;</span> see how many .html files are available to this App</span>
(count (findFiles <span><span>&#34;</span>*.html<span>&#34;</span></span>))

<span><span>;</span> see how many .js files are available to this App</span>
(count (findFiles <span><span>&#34;</span>*.js<span>&#34;</span></span>))

<span><span>;</span> show the VirtualPath of all .html files</span>
(joinln (map .VirtualPath (findFiles <span><span>&#34;</span>*.html<span>&#34;</span></span>)))

<span><span>;</span> view the VirtualPath&#39;s of the 1st and 2nd .html files</span>
(:<span>0</span> (map .VirtualPath (findFiles <span><span>&#34;</span>*.html<span>&#34;</span></span>)))
(:<span>1</span> (map .VirtualPath (findFiles <span><span>&#34;</span>*.html<span>&#34;</span></span>)))

<span><span>;</span> view the text file contents of the 1st and 2nd .html files</span>
(fileTextContents (:<span>0</span> (map .VirtualPath (findFiles <span><span>&#34;</span>*.html<span>&#34;</span></span>))))
(fileTextContents (:<span>1</span> (map .VirtualPath (findFiles <span><span>&#34;</span>*.html<span>&#34;</span></span>))))

<span><span>;</span> display the method signatures of all script methods starting with &#39;redis&#39;</span>
(globln <span><span>&#34;</span>redis*<span>&#34;</span></span> (map .Signature scriptMethods))

<span><span>;</span> search for all Redis Keys starting with &#39;urn:&#39; in the redis-server instances this App is configured with</span>
(redisSearchKeys <span><span>&#34;</span>urn:*<span>&#34;</span></span>)

<span><span>;</span> display the first redis search entry</span>
(:<span>0</span> (redisSearchKeys <span><span>&#34;</span>urn:*<span>&#34;</span></span>))

<span><span>;</span> display the key names of all redis keys starting with &#39;urn:&#39;</span>
(joinln (map :id (redisSearchKeys <span><span>&#34;</span>urn:*<span>&#34;</span></span>)))

<span><span>;</span> find out the redis-server data type of the &#39;urn:tags&#39; key</span>
(redisCall <span><span>&#34;</span>TYPE urn:tags<span>&#34;</span></span>)

<span><span>;</span> view all tags in the &#39;urn:tags&#39; sorted set</span>
(redisCall <span><span>&#34;</span>ZRANGE urn:tags 0 -1<span>&#34;</span></span>)

<span><span>;</span> view the string contents of the &#39;urn:question:1&#39; key</span>
(redisCall <span><span>&#34;</span>GET urn:question:1<span>&#34;</span></span>)

<span><span>;</span> parse the json contents of question 1 and display its tag names</span>
(:Tags (parseJson (redisCall <span><span>&#34;</span>GET urn:question:1<span>&#34;</span></span>)))

<span><span>;</span> extract the 2nd tag of question 1</span>
(:<span>1</span> (:Tags (parseJson (redisCall <span><span>&#34;</span>GET urn:question:1<span>&#34;</span></span>))))

<span><span>;</span> clear the Console screen</span>
clear

<span><span>;</span> exit the Lisp REPL</span>
quit</pre></div>
</div>

<h4>Enable features and access resources with app.settings</h4>
<p>You can configure the Lisp REPL with any of the resources and features that <a href="https://sharpscript.net/docs/sharp-apps">Sharp Apps</a> and 
<a href="https://sharpscript.net/docs/gist-desktop-apps">Gist Desktop Apps</a> have access to, by creating a plain text <code>app.settings</code> file with all the 
features and resources you want the Lisp REPL to have access to, e.g. this <a href="https://sharpscript.net/docs/sharp-apps#pure-cloud-apps">Pure Cloud App app.settings</a>
allows the Lisp REPL to use <a href="https://sharpscript.net/docs/db-scripts">Database Scripts</a> against a AWS PostgreSQL RDS server and query remote 
<a href="https://docs.servicestack.net/virtual-file-system">S3 Virtual Files</a> using <a href="https://sharpscript.net/docs/protected-scripts#virtual-file-system-apis">Virtual File System APIs</a>:</p>
<pre><code># Note: values prefixed with &#39;$&#39; are resolved from Environment Variables
name AWS S3 PostgreSQL Web App
db postgres
db.connection $AWS_RDS_POSTGRES
files s3
files.config {AccessKey:$AWS_S3_ACCESS_KEY,SecretKey:$AWS_S3_SECRET_KEY,Region:us-east-1,Bucket:rockwind}
</code></pre>

<p>See the <a href="https://sharpscript.net/docs/sharp-apps#registering-servicestack-plugins">plugins app.settings</a> for examples of how to load and configure 
<a href="https://docs.servicestack.net/plugins">ServiceStack Plugins</a>.</p>
<h3>Lisp REPL TCP Server</h3>
<p>In addition to launching a Lisp REPL from the Console above, you can also open a Lisp REPL into any ServiceStack App 
configured with the <code>LispReplTcpServer</code> ServiceStack plugin. This effectively opens a <strong>&#34;programmable gateway&#34;</strong> into any 
ServiceStack App where it&#39;s able to perform live queries, access IOC dependencies, invoke internal Server functions and query
the state of a running Server which like the <a href="https://docs.servicestack.net/debugging#debug-inspector">Debug Inspector</a> 
can provide invaluable insight when diagnosing issues on a remote server.</p>
<p>To see it in action we&#39;ll enable it one of our production Apps <a href="https://techstacks.io">techstacks.io</a> which as it&#39;s a 
Vuetify SPA App is only configured with an empty <code>SharpPagesFeature</code> as it doesn&#39;t use any server-side scripting features.</p>
<p>We&#39;ll enable it in <code>DebugMode</code> where we can enable by setting <code>DebugMode</code> in our App&#39;s <code>appsettings.Production.json</code> 
which will launch a TCP Socket Server which by default is configured to listen to the <strong>loopback</strong> IP on port <code>5005</code>.</p>

<div><div><pre><span>if</span> (<span>Config</span>.<span>DebugMode</span>)
{
    <span>Plugins</span>.<span>Add</span>(<span>new</span> <span>LispReplTcpServer</span> {
        <span>ScriptMethods</span> <span>=</span> {
            <span>new</span> <span>DbScripts</span>()
        },
        <span>ScriptNamespaces</span> <span>=</span> {
            <span>nameof</span>(<span>TechStacks</span>),
            <span><span>$&#34;</span>{<span>nameof</span>(<span>TechStacks</span>)}.{<span>nameof</span>(<span>ServiceInterface</span>)}<span>&#34;</span></span>,
            <span><span>$&#34;</span>{<span>nameof</span>(<span>TechStacks</span>)}.{<span>nameof</span>(<span>ServiceModel</span>)}<span>&#34;</span></span>,
        },
    });
}</pre></div>
</div>

<blockquote>
<p><a href="https://sharpscript.net/docs/script-net#type-resolution">ScriptNamespaces</a> behaves like C#&#39;s <code>using Namespace;</code> statement letting you reference Types 
by <code>Name</code> instead of its fully-qualified Namespace.</p>
</blockquote>
<p>Whilst you can now connect to it with basic <code>telnet</code>, it&#39;s a much nicer experience to use it with the <a href="https://linux.die.net/man/1/rlwrap">rlwrap</a>
readline wrap utility which provides an enhanced experience with line editing, persistent history and completion.</p>
<pre><code>$ sudo apt-get install rlwrap
</code></pre>

<p>Then you can open a TCP Connection to connect to a new Lisp REPL with:</p>
<pre><code>$ rlwrap telnet localhost 5005
</code></pre>

<p>Where you now have full scriptability of the running server as allowed by <a href="https://sharpscript.net/docs/sharp-pages">#Script Pages</a> <code>SharpPagesFeature</code> which
allows <a href="https://sharpscript.net/docs/script-net#allowscriptingofalltypes">scripting of all .NET Types</a> by default. </p>
<h4>TechStacks TCP Lisp REPL Demo</h4>
<p>In this demo we&#39;ll explore some of the possibilities of scripting the live <a href="https://techstacks.io">techstacks.io</a> Server where we can 
<code>resolve</code> IOC dependencies to send out tweets using its registered <code>ITwitterUpdates</code> dependency, view the source and load a remote 
<a href="https://gist.github.com/gistlyn/3624b0373904cfb2fc7bb3c2cb9dc1a3">parse-rss</a> lisp function into the new Lisp interpreter attached to the TCP connection, 
use it to parse <a href="https://news.ycombinator.com/rss">Hacker News RSS Feed</a> into a .NET Collection where it can be more easily queried using its built-in functions
which is used to construct an email body with <strong>HN&#39;s current Top 5 links</strong>. </p>
<p>It then uses <a href="https://sharpscript.net/docs/db-scripts">DB Scripts</a> to explore its configured AWS RDS PostgreSQL RDBMS, listing its DB tables and viewing its 
column names and definitions before retrieving the Email addresses of all <strong>Admin</strong> users, sending them each an email with HN&#39;s Top 5 Links by 
publishing <strong>5x</strong> <code>SendEmail</code> Request DTOs using the <a href="https://sharpscript.net/docs/servicestack-scripts#publishmessage">publishMessage</a> ServiceStack Script to where 
they&#39;re processed in the background by its configured <a href="https://docs.servicestack.net/messaging">MQ Server</a> that uses it to execute the 
<code>SendEmail</code> ServiceStack Service where it uses its configured AWS SES SMTP Server to finally send out the Emails:</p>
<iframe width="896" height="525" src="https://www.youtube.com/embed/HO523cFkDfk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
<h3>Password Protection</h3>
<p>Since TCP Server effectively opens your remote Server up to being scripted you&#39;ll want to ensure the TCP Server is only accessible
within a trusted network, effectively treating it the same as <a href="https://redis.io/topics/security">Redis Security Model</a>.</p>
<p>A secure approach would be to leave the default of only binding to <code>IPAddress.Loopback</code> so only trusted users with SSH access will 
be able to access it, which they&#39;ll still be able to access remotely via <code>Local PC &gt; ssh &gt; telnet 127.0.0.1 5005</code>.</p>
<p>Just like <a href="https://redis.io/commands/auth">Redis AUTH</a> you can also add password protection for an additional layer of Security:</p>

<div><div><pre><span>Plugins</span>.<span>Add</span>(<span>new</span> <span>LispReplTcpServer</span> {
    <span>RequireAuthSecret</span> <span>=</span> <span>true</span>,
    ...
});</pre></div>
<p>Which will only allow access to users with the <a href="https://docs.servicestack.net/debugging#authsecret" rel="nofollow">configured AuthSecret</a>:</p>
<div><pre><span>SetConfig</span>(<span>new</span> <span>HostConfig</span> { 
    <span>AdminAuthSecret</span> <span>=</span> <span><span>&#34;</span>secretz<span>&#34;</span></span> 
});</pre></div>
</div>

<h4>Annotated Lisp TCP REPL Transcript</h4>

<div><div><pre><span><span>;</span> resolve `ITwitterUpdates` IOC dependency and assign it to `twitter`</span>
(def twitter (resolve <span><span>&#34;</span>ITwitterUpdates<span>&#34;</span></span>))

<span><span>;</span> view its concrete Type Name</span>
(typeName twitter)

<span><span>;</span> view its method names </span>
(joinln (methods twitter))

<span><span>;</span> view its method signatures </span>
(joinln (methodTypes twitter))

<span><span>;</span> use it to send tweet from its @webstacks account</span>
(.Tweet twitter <span><span>&#34;</span>Who&#39;s using #Script Lisp? https://sharpscript.net/lisp<span>&#34;</span></span>)

<span><span>;</span> view all available scripts in #Script Lisp Library Index gist.github.com/3624b0373904cfb2fc7bb3c2cb9dc1a3</span>
(gistindex)

<span><span>;</span> view the source code of the `parse-rss` library</span>
(load-src <span><span>&#34;</span>index:parse-rss<span>&#34;</span></span>)

<span><span>;</span> assign the XML contents of HN&#39;s RSS feed to `xml`</span>
(def xml (urlContents <span><span>&#34;</span>https://news.ycombinator.com/rss<span>&#34;</span></span>))

<span><span>;</span> preview its first 1000 chars</span>
(subString xml <span>0</span> <span>1000</span>)

<span><span>;</span> use `parse-rss` to parse the RSS feed into a .NET Collection and assign it to `rss`</span>
(def rss (parse-rss xml))

<span><span>;</span> view the `title`, `description` and the first `item` in the RSS feed:</span>
(:title rss)
(:description rss)
(:<span>0</span> (:items rss))

<span><span>;</span> view the links of all RSS feed items</span>
(joinln (map :link (:items rss)))

<span><span>;</span> view the links and titles of the top 5 news items</span>
(joinln (map :link (take <span>5</span> (:items rss))))
(joinln (map :title (take <span>5</span> (:items rss))))

<span><span>;</span> construct a plain-text numbered list of the top 5 HN Links and assign it to `body`</span>
(joinln (map-index #(str %<span>2</span> (:title %<span>1</span>)) (take <span>5</span> (:items rss))))
(joinln (map-index #(str (padLeft (<span>1</span>+ %<span>2</span>) <span>2</span>) <span><span>&#34;</span>. <span>&#34;</span></span> (:title %<span>1</span>)) (take <span>5</span> (:items rss))))
(def body (joinln 
    (map-index #(str (padLeft (<span>1</span>+ %<span>2</span>) <span>2</span>) <span><span>&#34;</span>. <span>&#34;</span></span> (:title %<span>1</span>) <span><span>&#34;</span><span>\n</span><span>&#34;</span></span> (:link %<span>1</span>) <span><span>&#34;</span><span>\n</span><span>&#34;</span></span>) (take <span>5</span> (:items rss)))))

<span><span>;</span> view all TechStacks PostgreSQL AWS RDS tables</span>
(dbTableNames)
(joinln dbTableNames)

<span><span>;</span> view the column names and definitions of the `technology` table</span>
(joinln (dbColumnNames <span><span>&#34;</span>technology<span>&#34;</span></span>))
(joinln (dbColumns <span><span>&#34;</span>technology<span>&#34;</span></span>))

<span><span>;</span> search for all `user` tables</span>
(globln <span><span>&#34;</span>*user*<span>&#34;</span></span> (dbTableNames))

<span><span>;</span> view how many Admin Users with Emails there are</span>
(dbScalar <span><span>&#34;</span>select count(email) from custom_user_auth where roles like &#39;%Admin%&#39;<span>&#34;</span></span>)

<span><span>;</span> assign the Admin Users email to the `emails` list</span>
(def emails (map :email (dbSelect <span><span>&#34;</span>select email from custom_user_auth where roles like &#39;%Admin%&#39;<span>&#34;</span></span>)))

<span><span>;</span> search for all `operation` script methods</span>
(globln <span><span>&#34;</span>*operation*<span>&#34;</span></span> scriptMethods)

<span><span>;</span> search for all `email` Request DTOs</span>
(globln <span><span>&#34;</span>*email*<span>&#34;</span></span> metaAllOperationNames)

<span><span>;</span> view the properties available on the `SendEmail` Request DTO</span>
(props (SendEmail.))

<span><span>;</span> search for all `publish` script methods that can publish messages</span>
(globln <span><span>&#34;</span>publish*<span>&#34;</span></span> scriptMethods)

<span><span>;</span> create and publish 5x `SendEmail` Request DTOs for processing by TechStacks configured MQ Server</span>
(doseq (to emails) (publishMessage <span><span>&#34;</span>SendEmail<span>&#34;</span></span> { :To to :Subject <span><span>&#34;</span>Top 5 HN Links<span>&#34;</span></span> :Body body }))</pre></div>
</div>


<h3>Run and watch Lisp Scripts</h3>
<p>The same <a href="https://sharpscript.net/docs/sharp-scripts">Sharp Scripts</a> functionality for <code>#Script</code> is also available to Lisp scripts where you can use the <code>x</code> and <code>app</code>
dotnet tools to <strong>run</strong> and <strong>watch</strong> stand-alone Lisp scripts with the <code>.l</code> file extension, e.g: </p>
<pre><code>$ x run lisp.l
$ x watch lisp.l
</code></pre>

<p>To clarify the behavioural differences between the Lisp REPL&#39;s above which uses the <strong>same Lisp interpreter</strong> to maintain state changes across each command, 
the <code>watch</code> Script is run with a <strong>new Lisp Interpreter</strong> which starts with a <strong>fresh</strong> copy of the Global symbols table so any state changes after each 
<code>Ctrl+S</code> save point is discarded.</p>
<h3>Watch <code>lisp</code> scripts</h3>
<p>This quick demo illustrates the same functionality in <a href="https://sharpscript.net/docs/sharp-scripts">Sharp Scripts</a> is also available in <code>lisp</code> scripts 
where it provides instant feedback whilst you develop in real-time:</p>
<iframe width="896" height="525" src="https://www.youtube.com/embed/rIgEP8ssikY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
<h3>Annotated Lisp watch script</h3>

<div><div><pre><span><span>;</span>&lt;!--</span>
<span><span>;</span> db sqlite</span>
<span><span>;</span> db.connection northwind.sqlite</span>
<span><span>;</span> files s3</span>
<span><span>;</span> files.config {AccessKey:$AWS_S3_ACCESS_KEY,SecretKey:$AWS_S3_SECRET_KEY,Region:us-east-1,Bucket:rockwind}</span>
<span><span>;</span>--&gt;</span>

<span><span>;</span> delete remove.txt file</span>
(sh (str (<span>if</span> isWin <span><span>&#34;</span>del<span>&#34;</span></span> <span><span>&#34;</span>rm<span>&#34;</span></span>) <span><span>&#34;</span> remove.txt<span>&#34;</span></span>))

<span><span>;</span> View all `northwind.sqlite` RDBMS Tables</span>
(textDump (dbTableNames) { :caption <span><span>&#34;</span>Northwind<span>&#34;</span></span> } )

<span><span>;</span> Display first `customer` row in Single Row View showing all Table Columns</span>
(textDump (dbSelect <span><span>&#34;</span>select * from customer limit 1<span>&#34;</span></span>))

<span><span>;</span> Display all Customers in London</span>
(def city <span><span>&#34;</span>London<span>&#34;</span></span>)
(textDump (dbSelect <span><span>&#34;</span>select Id, CompanyName, ContactName from customer where city = @city<span>&#34;</span></span> { :city city } ))

<span><span>;</span> View all root files and folders in configured S3 Virtual File Provider</span>
(joinln (map #(str (.Name %) <span><span>&#34;</span>/<span>&#34;</span></span>) (allRootDirectories vfsContent)))
(joinln (map .Name (allRootFiles vfsContent)))

<span><span>;</span> Show first 10 *.png files in S3 VFS Provider</span>
(def pattern (<span>or</span> (first ARGV) <span><span>&#34;</span>*.png<span>&#34;</span></span>))
(joinln (map .VirtualPath (take <span>10</span> (findFiles vfsContent pattern))))</pre></div>
</div>

<h4>Page Arguments</h4>
<p>You can also use the same syntax for declaring any <code>app.settings</code> page arguments used in <code>#Script</code> and <code>code</code> Scripts:</p>
<pre><code>&lt;!--
 db sqlite
 db.connection northwind.sqlite
--&gt;
</code></pre>

<p>But for compatibility with any Lisp syntax highlighters and code editors they can also be prefixed with a <code>;</code> line comment as seen above.</p>
<h2>Executing Lisp in .NET</h2>
<p>Lisp like all <code>#Script</code> languages are executed within a <code>ScriptContext</code> that defines all functionality available to them, i.e:</p>

<div><div><pre><span>var</span> <span>context</span> <span>=</span> <span>new</span> <span>ScriptContext</span> {
    <span>Args</span> <span>=</span> { ... },              <span><span>//</span> Global Arguments available to all Scripts, Pages, Partials, etc</span>
    <span>ScriptMethods</span> <span>=</span> { ... },     <span><span>//</span> Additional Methods</span>
    <span>ScriptBlocks</span> <span>=</span> { ... },      <span><span>//</span> Additional Script Blocks </span>
    <span>FilterTransformers</span> <span>=</span> { .. }, <span><span>//</span> Additional Stream Transformers</span>
    <span>PageFormats</span> <span>=</span> { ... },       <span><span>//</span> Additional Text Document Formats</span>
    <span>Plugins</span> <span>=</span> { ... },           <span><span>//</span> Encapsulated Features e.g. Markdown, Protected or ServiceStack Features</span>

    <span>ScanTypes</span> <span>=</span> { ... },         <span><span>//</span> Auto register Methods, Blocks and Code Page Types</span>
    <span>ScanAssemblies</span> <span>=</span> { ... },    <span><span>//</span> Auto register all Methods, Blocks and Code Page Types in Assembly</span>
}.<span>Init</span>();</pre></div>
</div>

<p>
    Where you can customize the pure <a href="https://sharpscript.net/docs/sandbox">sandboxed</a> <em>ScriptContext</em> your Script is executed within by extending it with:
</p>

<ul>
    <li>
        <a href="https://sharpscript.net/docs/arguments">Arguments</a>
    </li>
    <li>
        <a href="https://sharpscript.net/docs/methods">Script Methods</a>
    </li>
    <li>
        <a href="https://sharpscript.net/docs/blocks">Script Blocks</a>
    </li>
    <li>
        <a href="https://sharpscript.net/docs/transformers">Filter Transformers</a>
    </li>
    <li>
        <a href="https://sharpscript.net/docs/script-plugins">Script Plugins</a>
    </li>
    <li>
        <a href="https://sharpscript.net/docs/page-formats">Page Formats</a>
    </li>
    <li>
        <a href="https://sharpscript.net/docs/plugins">Plugins</a>
    </li>
</ul>


<div><p>To render <code>lisp</code> you&#39;ll first need to register the Lisp Language with the <code>ScriptContext</code> you&#39;re using:</p>
<div><pre><span>var</span> <span>context</span> <span>=</span> <span>new</span> <span>ScriptContext</span> {
    <span>ScriptLanguages</span> <span>=</span> { <span>ScriptLisp</span>.<span>Language</span> }
}.<span>Init</span>();</pre></div>
<p>Then use <code>RenderLisp</code> (i.e. instead of <code>RenderScript</code>) to render Lisp code, e.g:</p>
<div><pre><span><span>//</span> render lisp</span>
<span>var</span> <span>output</span> <span>=</span> <span>context</span>.<span>RenderLisp</span>(<span><span>&#34;</span>(dateFormat now <span>\&#34;</span>HH:mm:ss<span>\&#34;</span>)<span>&#34;</span></span>); 

<span><span>//</span> async</span>
<span>var</span> <span>output</span> <span>=</span> <span>await</span> <span>context</span>.<span>RenderLispAsync</span>(<span><span>&#34;</span>(dateFormat now <span>\&#34;</span>HH:mm:ss<span>\&#34;</span>)<span>&#34;</span></span>); </pre></div>
<p>These APIs match the high-level APIs for rendering normal <code>#Script</code>:</p>
<div><pre><span>var</span> <span>output</span> <span>=</span> <span>context</span>.<span>RenderScript</span>(<span><span>&#34;</span>{{ now |&gt; dateFormat(&#39;HH:mm:ss&#39;) }}<span>&#34;</span></span>); 
<span>var</span> <span>output</span> <span>=</span> <span>await</span> <span>context</span>.<span>RenderScriptAsync</span>(<span><span>&#34;</span>{{ now |&gt; dateFormat(&#39;HH:mm:ss&#39;) }}<span>&#34;</span></span>); </pre></div>
<h3>
<a id="user-content-finer-grained-control" href="#finer-grained-control" aria-hidden="true"><span aria-hidden="true"></span></a>Finer grained control</h3>
<p>The high-level APIs above wraps the finer-grained functionality below which works by rendering a <code>SharpPage</code> configured with the <code>lisp</code>
language in a <code>PageResult</code> that all languages use:</p>
<div><pre><span>var</span> <span>context</span> <span>=</span> <span>new</span> <span>ScriptContext</span> {
    <span>ScriptLanguages</span> <span>=</span> { <span>ScriptLisp</span>.<span>Language</span> }
}.<span>Init</span>();
<span>var</span> <span>dynamicPage</span> <span>=</span> <span>context</span>.<span>LispSharpPage</span>(<span><span>&#34;</span>(dateFormat now <span>\&#34;</span>HH:mm:ss<span>\&#34;</span>)<span>&#34;</span></span>);          <span><span>//</span> render lisp</span>
<span><span>//</span>var dynamicPage = context.SharpScriptPage(&#34;{{ now |&gt; dateFormat(&#39;HH:mm:ss&#39;) }}&#34;); // render #Script</span>
<span>var</span> <span>output</span> <span>=</span> <span>new</span> <span>PageResult</span>(<span>dynamicPage</span>).<span>RenderScript</span>();

<span><span>//</span>async</span>
<span>var</span> <span>output</span> <span>=</span> <span>await</span> <span>new</span> <span>PageResult</span>(<span>dynamicPage</span>).<span>RenderScriptAsync</span>();</pre></div>
<p>If you need the return value instead you can access it from:</p>
<div><pre><span>var</span> <span>result</span> <span>=</span> <span>new</span> <span>PageResult</span>(<span>dynamicPage</span>).<span>EvaluateResult</span>(<span>out</span> <span>var</span> <span>returnValue</span>)
    <span>?</span> <span>ScriptLanguage</span>.<span>UnwrapValue</span>(<span>returnValue</span>)
    <span>:</span> <span>null</span>;</pre></div>
<p>If your script source code doesn&#39;t change you can re-use <code>dynamicPage</code> which lets you re-evaluate your source code&#39;s cached AST.</p>
</div>

<h3>Evaluating Lisp Script Results</h3>
<p>If you instead wanted to access return values instead of its rendered output, use the <code>EvaluateLisp()</code> APIs:</p>

<div><div><pre><span>var</span> <span>result</span> <span>=</span> <span>context</span>.<span>EvaluateLisp</span>(<span><span>&#34;</span>(return (+ 1 1))<span>&#34;</span></span>); <span><span>//</span>= 2</span></pre></div>
<p>The generic overloads below utilizes ServiceStack&#39;s <a href="https://docs.servicestack.net/auto-mapping" rel="nofollow">Auto Mapping utils</a>
to convert the return value into your preferred type, e.g:</p>
<div><pre><span>double</span> <span>result</span> <span>=</span> <span>context</span>.<span>EvaluateLisp</span>&lt;<span>double</span>&gt;(<span><span>&#34;</span>(return (+ 1 1))<span>&#34;</span></span>); <span><span>//</span>= 2.0</span>
<span>string</span> <span>result</span> <span>=</span> <span>context</span>.<span>EvaluateLisp</span>&lt;<span>string</span>&gt;(<span><span>&#34;</span>(return (+ 1 1))<span>&#34;</span></span>); <span><span>//</span>= &#34;2&#34;</span></pre></div>
<p>Which can also be used for more powerful conversions like converting an Object Dictionary into your preferred POCO:</p>
<div><pre><span>var</span> <span>result</span> <span>=</span> <span>context</span>.<span>EvaluateLisp</span>&lt;<span>Customer</span>&gt;(
    <span><span>&#34;</span>(return (dbSingle <span>\&#34;</span>select * from customer where id=@id<span>\&#34;</span> { :id id }))<span>&#34;</span></span>,
    <span>new</span> <span>ObjectDictionary</span> {
        [<span><span>&#34;</span>id<span>&#34;</span></span>] <span>=</span> <span>1</span>
    });</pre></div>
</div>

<h2>.NET Interop</h2>
<p>The syntax for .NET Interop is inspired directly from Clojure&#39;s syntax used for <a href="https://clojure.org/reference/java_interop">Java Interop</a>.
See <a href="https://sharpscript.net/docs/script-net#type-resolution">Scripting .NET Type Resolution</a> for how to configure Types and imported Namespaces you want your 
Lisp scripts to have access to.</p>
<h3>Member Access</h3>
<p>The <code>&#39;.&#39;</code> prefix if for accessing an instance members which can be used for retrieving a properties public properties, fields and
invoking instance methods, e.g:</p>
<ul>
<li><strong>(.Property instance)</strong></li>
<li><strong>(.Field    instance)</strong></li>
<li><strong>(.Method   instance ...args)</strong></li>
</ul>
<h3>Indexer Access</h3>
<p>Use <code>&#39;:&#39;</code> prefix for accessing a Types indexer or for indexing collections, e.g:</p>
<ul>
<li><strong>(:key indexer)</strong></li>
<li><strong>(:&#34;string key&#34; dictionary)</strong></li>
<li><strong>(:n list)</strong></li>
<li><strong>(:n array)</strong></li>
<li><strong>(:n enumerable)</strong></li>
<li><strong>(:n indexer)</strong></li>
</ul>
<p>It can also be used to access an instance public Properties and Fields:</p>
<ul>
<li><strong>(:Property instance)</strong></li>
<li><strong>(:Field    instance)</strong></li>
</ul>
<p>However for readability we recommend using <code>&#39;.&#39;</code> prefix above to convey instance member access.</p>
<h3>Constructor Access</h3>
<p>Use <code>&#39;.&#39;</code> <strong>suffix</strong> for creating instances of Types:</p>
<ul>
<li><strong>(Type. ...args)</strong></li>
<li><strong>(Namespace.Type. ...args)</strong></li>
</ul>
<p>You can also create instances using the <a href="https://sharpscript.net/docs/script-net#creating-instances">new script method</a>, which as it accepts a 
<code>string</code> Type Name can be used to create generic classes with multiple generic args, e.g:</p>
<ul>
<li><strong>(new &#34;Type&#34; ...args)</strong></li>
<li><strong>(new &#34;Type&lt;T1,T2,T3&gt;&#34; ...args)</strong></li>
</ul>
<h3>Static Member Access</h3>
<p>Use the <code>&#39;/&#39;</code> separator to access a Type&#39;s static members or to invoke its static methods, e.g:</p>
<ul>
<li><strong>(StaticType/Property)</strong></li>
<li><strong>(StaticType/Field)</strong></li>
<li><strong>(StaticType/Const)</strong></li>
<li><strong>(StaticType/Method ...args)</strong></li>
</ul>
<p>Use <code>&#39;.&#39;</code> dot notation for specifying the fully-qualified Type name or to reference its Inner classes, e.g:</p>
<ul>
<li><strong>(Namespace.StaticType/Member)</strong></li>
<li><strong>(Namespace.StaticType.InnerType/Member)</strong></li>
</ul>
<h3>Script Methods</h3>
<p>Use <code>&#39;/&#39;</code> prefix to reference any Script Method registered in your <code>ScriptContext</code>:</p>
<ul>
<li><strong>(/scriptMethod ...args)</strong></li>
</ul>
<p>Script Methods without arguments can be referenced as an <a href="https://sharpscript.net/docs/default-scripts#as-bindings">argument binding</a> 
that when referenced as an argument (i.e. without brackets) are implicitly evaluated, in-effect making them a calculated property:</p>
<ul>
<li><strong>/methodAsBinding</strong></li>
</ul>
<p>While a <code>&#39;/&#39;</code> prefix indicates a reference to a <a href="https://sharpscript.net/docs/methods">script method</a>, for readability it can be excluded as when 
there&#39;s no existing symbol defined in the Lisp interpreter&#39;s symbol table it will fallback to referencing a script method:</p>
<ul>
<li><strong>(scriptMethod ...args)</strong></li>
<li><strong>methodAsBinding</strong></li>
</ul>
<p>This does mean that when there exists a <code>symbol</code> of the same name defined you will need to use the <code>&#39;/&#39;</code> prefix to reference a script method.</p>
<h3>Generic Types</h3>
<p>All references above support referencing generic types and methods with a single generic Type argument, e.g:</p>
<ul>
<li><strong>(StaticType/Method&lt;T&gt;)</strong></li>
<li><strong>(GenericStaticType&lt;T&gt;/Member)</strong></li>
<li><strong>(GenericStaticType&lt;T&gt;/Method&lt;T&gt;)</strong></li>
<li><strong>(GenericType&lt;T&gt;.)</strong></li>
</ul>
<p>As <code>&#39;,&#39;</code> is one of Lisp&#39;s few syntax tokens (<a href="http://www.lispworks.com/documentation/HyperSpec/Body/02_df.htm">unquoting</a>) it prevents them
from being able to use them to specify multiple generic arguments.</p>
<p>Instead you&#39;ll need to use the <a href="https://sharpscript.net/docs/script-net#creating-instances">Constructor function</a> for referencing constructors with multiple generic
arguments where you&#39;ll also need to specify the types of the exact constructor you want to call, e.g:</p>
<ul>
<li><strong>(/C &#34;Tuple&lt;String,int&gt;(String,int)&#34;)</strong></li>
</ul>
<p>The difference between the <code>/C</code> script method constructor function and Lisp&#39;s <code>C</code> function is that the script method only returns a reference
to the constructor which you&#39;ll need to invoke with arguments to create an instance:</p>
<ul>
<li><strong>((/C &#34;Tuple&lt;String,int&gt;(String,int)&#34;) &#34;A&#34; 1)</strong></li>
</ul>
<p>Whilst Lisp&#39;s <code>C</code> function will auto-invoke the constructor function with the supplied arguments in a single expression:</p>
<ul>
<li><strong>(C &#34;Tuple&lt;String,int&gt;(String,int)&#34; &#34;A&#34; 1)</strong></li>
</ul>
<p>Likewise when needing to invoke generic methods with multiple generic args you&#39;ll need to use <a href="https://sharpscript.net/docs/script-net#function">Function</a>:</p>
<ul>
<li><strong>((/F &#34;Tuple.Create&lt;String,int&gt;(String,int)&#34;) &#34;A&#34; 1)</strong></li>
</ul>
<p>Or Script Lisp&#39;s <code>F</code> function for invoking a function reference in a single expression:</p>
<ul>
<li><strong>(F &#34;Tuple.Create&lt;String,int&gt;(String,int)&#34; &#34;A&#34; 1)</strong></li>
</ul>
<p>For more examples and information see <a href="https://sharpscript.net/docs/script-net">Scripting .NET Types</a>.</p>
<h3>Property Setters</h3>
<p>You can populate multiple properties on an instance using the <a href="https://sharpscript.net/docs/script-net#user-content-set">set script method</a>, e.g:</p>
<ul>
<li><strong>(set instance { :Prop arg ... })</strong></li>
</ul>
<p>Alternatively properties can be set individually with:</p>
<ul>
<li><strong>(.Prop instance arg)</strong></li>
</ul>
<h3>Lisp Lists vs .NET Collections</h3>
<p>A potential source of friction when interoperating with .NET is that Lisp Lists are <a href="https://cs.gmu.edu/~sean/lisp/cons/">Cons Cells</a>
so that a code or data list in Lisp, i.e:</p>
<pre><code>&#39;(1 2 3)
[1 2 3]
</code></pre>

<p>Is implemented as a Linked List of Cons cells:</p>
<pre><code>(1 . (2 . (3 . null)))
</code></pre>

<p>Which is what Lisp&#39;s core functions expect to operate on, namely:</p>
<pre><code>car cdr caar cadr cdar cddr caaar caadr cadar caddr cdaar cdadr cddar cdddr append mapcar consp cons?
listp list? memq member assq assoc nreverse last nconc dolist dotimes mapcan mapc nthcdr nbutlast 
</code></pre>

<p>These core Lisp functions can&#39;t be used against .NET collections directly, instead you can use 
<code>(to-cons collection)</code> to convert a .NET <code>IEnumerable</code> collection into a cons list, e.g:</p>
<pre><code>(cdr (to-cons netEnumerable))
</code></pre>

<p>Should you need to do the inverse you can use <code>(to-list cons-list)</code> to convert a cons list to a .NET List, e.g:</p>
<pre><code>(to-list (range 10))
</code></pre>

<p>We&#39;ve made Script Lisp&#39;s cons <code>Cell</code> an <code>IEnumerable</code> so that <strong>all other built-in Lisp functions</strong> can operate on both 
cons cells and .NET Collections where instead of iterating a list with <code>(do-list)</code> you can use <code>(do-seq)</code> to iterate
both .NET Collections and cons cells, e.g:</p>
<pre><code>(do-seq (x collection) (println x) )
</code></pre>

<h3>Annotated .NET Interop Example</h3>

<div><p>To see what this looks like in action here&#39;s an annotated simple real-world example that heavily utilizes .NET interop:</p>
<div><pre><span><span>;</span> define function and assign to `parse-rss` value in Lisp interpreters symbols table</span>
(defn parse-rss [xml]
    <span><span>;</span> define local variables used within this scope</span>
    (<span>let</span> ( (to) (doc) (channel) (items) (el) )
        <span><span>;</span> use XDocument.Parse() to parse xml string argument containing xml and assign to `doc`</span>
        (def doc (System.Xml.Linq.XDocument/Parse xml))
        <span><span>;</span> create empty ObjectDictionary (wrapper for Dictionary&lt;string,object&gt;) and assign to `to`</span>
        (def to  (ObjectDictionary.))
        <span><span>;</span> create empty List of ObjectDictionary and assign to `items`</span>
        (def items (<span>List</span>&lt;ObjectDictionary&gt;.))
        <span><span>;</span> descend into first &lt;channel&gt; XML element and assign to `channel`</span>
        (def channel (first (.Descendants doc <span><span>&#34;</span>channel<span>&#34;</span></span>)))
        <span><span>;</span> use `XLinqExtensions.FirstElement()` extension method to assign channels first XML element to `el`</span>
        (def el  (XLinqExtensions/FirstElement channel))

        <span><span>;</span> iterate through all elements up to the first &lt;item&gt; and add them as top-level entries in `to`</span>
        (while (<span>not</span>= (.LocalName (.Name el)) <span><span>&#34;</span>item<span>&#34;</span></span>)
            <span><span>;</span> add current XML element name and value entry to `to`</span>
            (.Add to (.LocalName (.Name el)) (.Value el))
            <span><span>;</span> move to next element using `XLinqExtensions.NextElement()` extension method</span>
            (def el (XLinqExtensions/NextElement el)))

        <span><span>;</span> add all rss &lt;item&gt;&#39;s to `items` list</span>
        <span><span>;</span> iterate through all `channel` child &lt;item&gt; XML elements</span>
        (doseq (elItem (.Descendants channel <span><span>&#34;</span>item<span>&#34;</span></span>))
            <span><span>;</span> create empty ObjectDictionary and assign to `item`</span>
            (def item (ObjectDictionary.))
            
            <span><span>;</span> use `XLinqExtensions.FirstElement()` to assign &lt;item&gt; first XML element to `el`</span>
            (def el (XLinqExtensions/FirstElement elItem))
            (while el
                <span><span>;</span> add current XML element name and value entry to `item`</span>
                (.Add item (.LocalName (.Name el)) (.Value el))
                <span><span>;</span> move to next element using `XLinqExtensions.NextElement()` extension method</span>
                (def el (XLinqExtensions/NextElement el)))

            <span><span>;</span> add `item` ObjectDictionary to `items` List</span>
            (.Add items item))

        <span><span>;</span> add `items` ObjectDictionary List to `to` at key `items`</span>
        (.Add to <span><span>&#34;</span>items<span>&#34;</span></span> items)
        <span><span>;</span> return `to` ObjectDictionary</span>
        to
    )
)</pre></div>
<p>For comparison, this would be the equivalent implementation in C#:</p>
<div><pre><span>public</span> <span>static</span> <span>ObjectDictionary</span> <span>ParseRss</span>(<span>string</span> <span>xml</span>)
{
    <span>var</span> <span>to</span> <span>=</span> <span>new</span> <span>ObjectDictionary</span>();
    <span>var</span> <span>items</span> <span>=</span> <span>new</span> <span>List</span>&lt;<span>ObjectDictionary</span>&gt;();

    <span>var</span> <span>doc</span> <span>=</span> <span>XDocument</span>.<span>Parse</span>(<span>xml</span>);
    <span>var</span> <span>channel</span> <span>=</span> <span>doc</span>.<span>Descendants</span>(<span><span>&#34;</span>channel<span>&#34;</span></span>).<span>First</span>();
    <span>var</span> <span>el</span> <span>=</span> <span>channel</span>.<span>FirstElement</span>();
    <span>while</span> (<span>el</span>.<span>Name</span> <span>!=</span> <span><span>&#34;</span>item<span>&#34;</span></span>)
    {
        <span>to</span>[<span>el</span>.<span>Name</span>.<span>LocalName</span>] <span>=</span> <span>el</span>.<span>Value</span>;
        <span>el</span> <span>=</span> <span>el</span>.<span>NextElement</span>();
    }

    <span>var</span> <span>elItems</span> <span>=</span> <span>channel</span>.<span>Descendants</span>(<span><span>&#34;</span>item<span>&#34;</span></span>);
    <span>foreach</span> (<span>var</span> <span>elItem</span> <span>in</span> <span>elItems</span>)
    {
        <span>var</span> <span>item</span> <span>=</span> <span>new</span> <span>ObjectDictionary</span>();
        <span>el</span> <span>=</span> <span>elItem</span>.<span>FirstElement</span>();
        <span>while</span> (<span>el</span> <span>!=</span> <span>null</span>)
        {
            <span>item</span>[<span>el</span>.<span>Name</span>.<span>LocalName</span>] <span>=</span> <span>el</span>.<span>Value</span>;
            <span>el</span> <span>=</span> <span>el</span>.<span>NextElement</span>();
        }

        <span>items</span>.<span>Add</span>(<span>item</span>);
    }

    <span>to</span>[<span><span>&#34;</span>items<span>&#34;</span></span>] <span>=</span> <span>items</span>;
    <span>return</span> <span>to</span>;
}</pre></div>
</div>

<h3>Importing Global Scripts</h3>
<p>Importing scripts in Lisp is essentially a 2-stage process of parsing Lisp source code into an <a href="https://en.wikipedia.org/wiki/S-expression">SExpression</a>, 
(basically Lisp&#39;s AST of tokenized elements captured in a <a href="https://cs.gmu.edu/~sean/lisp/cons/">2-field Cons Cell</a>) then evaluating it in a 
Lisp interpreter where any defined symbols are captured in its Symbols table.</p>
<p>Lisp Script captures its &#34;standard library&#34; in a Global Interpreter which serves as the starting template for all other Lisp Interpreters 
which starts with a copy of the Global symbols table which you can further populate with your own common functions using <code>Lisp.Import()</code>, e.g:</p>

<div><div><pre><span>Lisp</span>.<span>Import</span>(<span><span>@&#34;</span></span>
<span>(defun fib (n)</span>
<span>    (if (&lt; n 2)</span>
<span>        1</span>
<span>        (+ (fib (- n 1))</span>
<span>        (fib (- n 2)) )))<span>&#34;</span></span>);</pre></div>
</div>

<h3>Loading Scripts</h3>
<p>Loading scripts within a Lisp script works similarly except they&#39;re only loaded into that Lisp interpreters symbol table, a new one
of which is created in each new <code>PageResult</code>.</p>
<p>Scripts loaded locally are loaded from the <code>ScriptContext</code> configured <a href="https://docs.servicestack.net/virtual-file-system">Virtual Files Provider</a> 
which for <a href="https://sharpscript.net/docs/sharp-pages">#Script Pages</a> <code>SharpPagesFeature</code> is configured to use the App&#39;s cascading virtual file sources. </p>
<p>A new <code>ScriptContext</code> starts with an empty <a href="https://docs.servicestack.net/virtual-file-system#virtual-file-systems-available">MemoryVirtualFiles</a>
which you can write files to with:</p>

<div><div><pre><span>var</span> <span>context</span> <span>=</span> <span>new</span> <span>ScriptContext</span> {
    <span>ScriptLanguages</span> <span>=</span> { <span>ScriptLisp</span>.<span>Language</span> },
    <span>ScriptMethods</span> <span>=</span> { <span>new</span> <span>ProtectedScripts</span>() },
};
<span>context</span>.<span>VirtualFiles</span>.<span>WriteFile</span>(<span><span>&#34;</span>lib1.l<span>&#34;</span></span>, <span><span>&#34;</span>(defn lib-calc [a b] (+ a b))<span>&#34;</span></span>);
<span>context</span>.<span>VirtualFiles</span>.<span>WriteFile</span>(<span><span>&#34;</span>/dir/lib2.l<span>&#34;</span></span>, <span><span>&#34;</span>(defn lib-calc [a b] (* a b))<span>&#34;</span></span>);
<span>context</span>.<span>Init</span>();</pre></div>
<p>You can load these scripts by symbol name where it assumes a <code>.l</code> extension, by quoting the argument so
Lisp doesn&#39;t try to evaluate it as an argument, e.g:</p>
<div><pre>(<span>load</span> &#39;lib1)

(lib-calc <span>4</span> <span>5</span>) <span><span>;</span>= 9</span></pre></div>
<p>Alternatively you can specify the virtual path to the script. You can load multiple scripts with the same definitions,
in Lisp this just updates the value assigned to the symbol name with the latest definition, e.g:</p>
<div><pre>(<span>load</span> <span><span>&#34;</span>lib1.l<span>&#34;</span></span>)

(lib-calc <span>4</span> <span>5</span>) <span><span>;</span>= 9</span>

(<span>load</span> <span><span>&#34;</span>/dir/lib2.l<span>&#34;</span></span>)

(lib-calc <span>4</span> <span>5</span>) <span><span>;</span>= 20</span></pre></div>
<h3>
<a id="user-content-import-scripts-from-urls" href="#import-scripts-from-urls" aria-hidden="true"><span aria-hidden="true"></span></a>Import Scripts from URLs</h3>
<p>Inspired by <a href="https://deno.land" rel="nofollow">Deno</a> you can also import remote scripts from URLs, e.g:</p>
<div><pre>(<span>load</span> <span><span>&#34;</span>https://example.org/lib.l<span>&#34;</span></span>)</pre></div>
<h3>
<a id="user-content-locally-cached" href="#locally-cached" aria-hidden="true"><span aria-hidden="true"></span></a>Locally Cached</h3>
<p>Like <a href="https://deno.land/manual.html" rel="nofollow">Deno</a> all remote resources are cached after first use so after it&#39;s loaded once it only loads the locally cached
version of the script (where it will still work in an airplane without an internet connection). This cache is maintained
under a <code>.lisp</code> folder at your configured Virtual Files provider (that can be deleted to clear any caches).</p>
<p>For Sharp Scripts or Apps using the <code>web</code> or <code>app</code> dotnet tools it&#39;s stored in its own cache folder that can be cleared with:</p>
<pre><code>$ x --clean
</code></pre>
<h3>
<a id="user-content-import-scripts-from-gists" href="#import-scripts-from-gists" aria-hidden="true"><span aria-hidden="true"></span></a>Import Scripts from Gists</h3>
<p>There&#39;s also first-class support for gists which you can reference with <code>gist:&lt;gist-id&gt;</code>, e.g:</p>
<div><pre>(<span>load</span> <span><span>&#34;</span>gist:2f14d629ba1852ee55865607f1fa2c3e<span>&#34;</span></span>)</pre></div>
<p>This will load all gist files in gist order, if you only to load a single file from a gist you can specify it with:</p>
<div><pre>(<span>load</span> <span><span>&#34;</span>gist:2f14d629ba1852ee55865607f1fa2c3e/lib1.l<span>&#34;</span></span>)</pre></div>
<h3>
<a id="user-content-script-lisp-library-index" href="#script-lisp-library-index" aria-hidden="true"><span aria-hidden="true"></span></a>Script Lisp Library Index</h3>
<p>To provide human readable names to remote Lisp Scripts and a discoverable catalog where anyone can share their own scripts,
you reference gists by name listed in the <a href="https://gist.github.com/gistlyn/3624b0373904cfb2fc7bb3c2cb9dc1a3">#Script Lisp Library Index</a>
which is itself a self-documenting machine and human readable gist of named links to external gists maintained by their
respective authors.</p>
<p>Index library references can be loaded using the format <code>index:&lt;name&gt;</code>, e.g:</p>

<p>Which also support being able to reference individual gist files:</p>
<div><pre>(<span>load</span> <span><span>&#34;</span>index:lib-calc/lib1.l<span>&#34;</span></span>)</pre></div>
<p>If you&#39;d like to share your own Lisp Scripts with everyone and publish your library to the index, just add a link
to your gist with your preferred name in the <a href="https://gist.github.com/gistlyn/3624b0373904cfb2fc7bb3c2cb9dc1a3">Gist Index Comments</a>.</p>
<h3>
<a id="user-content-viewing-script-source-code" href="#viewing-script-source-code" aria-hidden="true"><span aria-hidden="true"></span></a>Viewing Script Source Code</h3>
<p>You can view the source code of any load script references with <code>load-src</code>, e.g:</p>
<div><pre>(load-src &#39;lib)
(load-src <span><span>&#34;</span>/dir/lib2.l<span>&#34;</span></span>)
(load-src <span><span>&#34;</span>https://example.org/lib.l<span>&#34;</span></span>)
(load-src <span><span>&#34;</span>gist:2f14d629ba1852ee55865607f1fa2c3e/lib1.l<span>&#34;</span></span>)
(load-src <span><span>&#34;</span>index:lib-calc<span>&#34;</span></span>)</pre></div>
<h3>
<a id="user-content-disable-remote-imports" href="#disable-remote-imports" aria-hidden="true"><span aria-hidden="true"></span></a>Disable Remote Imports</h3>
<p>Should you wish, you can prevent anyone from loading remote scripts with:</p>
<div><pre><span>Lisp</span>.<span>AllowLoadingRemoteScripts</span> <span>=</span> <span>false</span>;</pre></div>
</div>

<h3>#Script Pages Integration</h3>
<p>Whilst Lisp is a small, powerfully expressive functional dynamic language it&#39;s not great for use as a templating language. 
Whilst there have been <a href="https://www.cliki.net/HTML%20generator">several attempts to create a HTML DSL in Lisp</a>, nothing is better
than having <strong>no syntax</strong> which is the default <strong>Template mode</strong> for <code>#Script</code> where it will emit everything that&#39;s not in a 
Template or Language Expression as verbatim text.</p>
<p>A nice USP of Script Lisp is that you&#39;re never forced into going &#34;full Lisp&#34;, you can utilize <code>#Script</code> template expressions and
<a href="https://sharpscript.net/docs/blocks">Script Blocks</a> handlebars syntax that provides the ideal DSL for usage in a Template Language for generating HTML
and utilize your preferred <code>Lisp</code> or <a href="https://sharpscript.net/scode/">Code</a> Script Languages for any computational logic you want included in your page
using <a href="https://sharpscript.net/docs/syntax#language-blocks-and-expressions">Language Blocks and Expressions</a>.</p>
<h4>Implementation</h4>
<p>Despite being implemented in different languages a <code>#Script</code> page containing multiple languages, e.g:</p>


 


<p>Still only produces a <strong>single page AST</strong>, where when first loaded <code>#Script</code> parses the page contents as a contiguous
<code>ReadOnlyMemory&lt;char&gt;</code> where page slices of any <a href="https://sharpscript.net/docs/syntax#language-blocks-and-expressions">Language Blocks and Expressions</a> 
on the page are delegated to the <code>ScriptContext</code> registered <code>ScriptLanguages</code> for parsing which returns a fragment which is
added to the pages AST:</p>
<p><a href="https://sharpscript.net/assets/img/multi-langs.svg"><img src="https://sharpscript.net/assets/img/multi-langs.svg"/></a></p>
<p>When executing the page, each language is responsible for rendering its own fragments which all write directly to the pages <code>OutputStream</code>
to generate the pages output.</p>
<p>The multi-languages support in <code>#Script</code> is designed to be extensible where everything about the language is encapsulated within its
<code>ScriptLanguage</code> implementation so that if you omit its registration:</p>
<pre><code>var context = new ScriptContext {
//    ScriptLanguages = { ScriptLisp.Language }
}.Init();
</code></pre>

<p>Any language expressions and language blocks referencing it become inert and its source code emitted as plain-text.</p>
<h3>Lisp Argument Scopes</h3>
<p>One differentiator between Lisp and <a href="https://sharpscript.net/scode/">Code</a> languages is that <code>code</code> utilizes the containing page current scope
for all its argument references where as Lisp stores all its definitions within the Lisp interpreter symbol table
attached to the <code>PageResult</code>, so whilst Lisp scripts can access arguments within the pages scope, in order for the 
outer page to access any Lisp symbols they need to be exported, e.g:</p>

 


<h3>Exporting Lisp Functions</h3>
<p>Lisp functions can also be exported for usage in the rest of the page by calling <code>(to-delegate lispFn)</code> to convert it 
into a .NET Delegate, e.g:</p>

 


<p>Although an easier way to define functions in Lisp is to use the <a href="https://sharpscript.net/docs/blocks#defn">defn Script Block</a> which wraps
this in a convenient syntax:</p>

 


<h3>Controlling Lisp output</h3>
<p>One of Lisp&#39;s famous traits is <strong>everything is an expression</strong> which is typically desired within a language, but may not 
be what you want when generating output. E.g traditionally Lisp uses <a href="http://www.lispworks.com/documentation/HyperSpec/Body/s_setq.htm">setq</a>
to set a variable which also returns its value that <code>#Script</code> will emit as it automatically emits all statement return values. </p>
<p>You could use <code>def</code> which is an alias for <code>setq</code> which returns <code>null</code>, other options include wrapping all statements within an empty <code>let</code>
expression where only the last expression is returned, or you could use a <a href="https://sharpscript.net/docs/syntax#language-block-modifiers">Language Block Modifier</a>
to ignore the entire <code>lisp</code> block output and only export the result you want to be able to control precisely where to emit it:</p>

 


<blockquote>
<p>can use either &#39;q&#39;, &#39;quiet&#39; or &#39;mute&#39; block modifier to ignore output</p>
</blockquote>
<p>Another way to generate output from Lisp is to use its built-in print functions below:</p>
<ul>
<li><strong>(print ...args)</strong> - write all arguments to the <code>OutputStream</code></li>
<li><strong>(println ...args)</strong> - write all arguments to the <code>OutputStream</code> followed by a <strong>new line</strong></li>
<li><strong>(printlns ...args)</strong> - write all arguments to the <code>OutputStream</code> with a <code>&#39; &#39;</code> <strong>space delimiter</strong> followed by a <strong>new line</strong></li>
<li><strong>(pr ...args)</strong> - same as <code>print</code> but <strong>HTML encode</strong> all arguments</li>
<li><strong>(prn ...args)</strong> - same as <code>println</code> but <strong>HTML encode</strong> all arguments</li>
</ul>
<h3>dorun</h3>
<p><a href="https://clojuredocs.org/clojure.core/dorun">dorun</a> can be used for executing a &#34;statement block&#34; (sequence of expressions) 
with side-effects that you want to discard the return type (akin to <code>void</code> return type):</p>
<pre><code>(dorun println (map fizzbuzz (range 1 100)))
</code></pre>

<p>Or you can use <code>do</code> to return the last expression in the statement block:</p>
<pre><code>(do (+ 1 1) (+ 2 2))       ; 4
(do (+ 1 1) (+ 2 2) nil))  ; null
(do ())                    ; null
</code></pre>

<h2>Learn #Script Lisp</h2>
<p>A great resource for learning Script Lisp is seeing it in action by seeing how to implement <strong>C#&#39;s 101 LINQ Examples in Lisp</strong>:</p>

<h3>Explore APIs in real-time</h3>
<p>We can also take advantage of Lisp&#39;s dynamism and interactivity to explore APIs in real-time, a great way to do this is via
a <a href="#run-and-watch-lisp-scripts">watched Lisp script</a> on the side where it provides instant feedback after each <code>Ctrl+S</code> save point
or a active <a href="#lisp-repl">Lisp REPL</a>.</p>
<ul>
<li><strong>symbols</strong> - List all symbols in Lisp interpreter - most symbols are named after <a href="http://www.lispworks.com/documentation/HyperSpec/Front/X_AllSym.htm">standard Lisp</a>
or <a href="https://clojure.org/api/cheatsheet">clojure functions</a></li>
<li><strong>(symbol-type symbol)</strong> - Display the Symbol&#39;s Value Type</li>
<li><strong>scriptMethods</strong> - List all available Script Method Names registered in <code>ScriptContext</code></li>
<li><strong>scriptMethodTypes</strong> - List all available Script Method Type information</li>
<li><strong>(joinln collection)</strong> - Display the string output of each item in the collection on a separate line </li>
<li><strong>(globln pattern collection)</strong> - Only display lines matching the glob pattern</li>
<li><strong>(typeName instance)</strong> - View the instance Type Name</li>
<li><strong>(props instance)</strong> - Display the Property names of an Instance public properties</li>
<li><strong>(fields instance)</strong> - Display the Field names of an Instance public fields</li>
<li><strong>(methods instance)</strong> - Display the Method names of an Instance public methods</li>
<li><strong>(propTypes instance)</strong> - Get the PropertyInfo[] of an Instance public properties</li>
<li><strong>(fieldTypes instance)</strong> - Get the FieldInfo[] of an Instance public fields</li>
<li><strong>(methodTypes instance)</strong> - Get the Script Method Infos of an Instance public methods</li>
<li><strong>(staticProps instance)</strong> - Display the Property names of an Instance public static properties</li>
<li><strong>(staticFields instance)</strong> - Display the Field names of an Instance public static fields</li>
<li><strong>(staticMethods instance)</strong> - Display the Method names of an Instance public static methods</li>
<li><strong>(staticPropTypes instance)</strong> - Get the PropertyInfo[] of an Instance public static properties</li>
<li><strong>(staticFieldTypes instance)</strong> - Get the FieldInfo[] of an Instance public static fields</li>
<li><strong>(staticMethodTypes instance)</strong> - Get the Script Method Infos of an Instance public static methods</li>
</ul>
<p>You can view the <a href="https://sharpscript.net/docs/scripts-reference">Scripts API Reference</a> and <a href="https://sharpscript.net/docs/default-scripts">Scripts Documentation</a>
on this website to interactively explore the available APIs, we&#39;ll work on providing further interactive documentation
for the built-in Lisp functions, in the mean-time the best resource are 
<a href="https://github.com/ServiceStack/ServiceStack/blob/32185f14aaf93d768dda5673381aa0d2fdbe34b4/src/ServiceStack.Common/Script/ScriptLanguage.Lisp.cs#L3106-L3508">their implementation</a>.</p>
<p>For reference, here&#39;s are a quick list of all built-in Lisp symbols:</p>
<pre><code>- % * *gensym-counter* *version* / /= _append _nreverse + &lt; &lt;= = &gt; &gt;= 1- 1+ 1st 2nd 3rd abs all? and any? 
append apply assoc assoc-key assoc-value assq atom atom? average butlast C caaar caadr caar cadar caddr 
cadr car cdaar cdadr cdar cddar cdddr cddr cdr ceiling cons cons? consp cos count debug dec decf def 
defmacro defn defun dispose do dolist dorun doseq doseq-while dotimes dump dump-inline elt empty? end?
endp enumerator enumeratorCurrent enumeratorNext eq eql equal error even? every every? exit exp expt F f++
false filter filter-index first flatmap flatten floor gensym glob globln group-by htmldump identity if 
inc incf instance? intern isqrt it last length let letrec list list? listp load load-src logand logior 
logxor lower-case make-symbol map mapc mapcan mapcar map-index map-where max member memq min mod nbutlast 
nconc new new-map next not not= nreverse nth nthcdr null number? odd? or order-by pop pr prin1 princ 
print println printlns prn prs push push-end random range reduce remove remove-if rest return reverse 
round rplaca rplacd second seq? setcar setcdr set-difference sets sin skip skip-while some some? sort 
sort-by sqrt str string string? string-downcase string-upcase subseq sum symbol-name symbol-type t take 
take-while tan terpri textdump third to-array to-cons to-delegate to-dictionary to-list true truncate 
union unless upper-case when where where-index while zero? zerop zip zip-where
</code></pre>

<p>Common Lisp by convention uses a <code>*p</code> suffix for <strong>predicate</strong> functions but we prefer Clojure&#39;s (and Ruby&#39;s)
more readable <code>*?</code> suffix convention, for source-code compatibility we include both for 
<a href="http://jtra.cz/stuff/lisp/sclr/index.html">core Lisp predicts</a> and just <code>*?</code> for others.</p>




        </div>

    </div></div>
  </body>
</html>
