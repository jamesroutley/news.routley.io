<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.jeffquast.com/post/ucs-detect-test-results/">Original</a>
    <h1>Terminal Emulators Battle Royale – Unicode Edition</h1>
    
    <div id="readability-page-1" class="page"><div>
        <header>
	
</header>
        
        <section>
            <article itemscope="" itemtype="//schema.org/BlogPosting">
                <p>
                    <h5>
                    <time datetime="" itemprop="datePublished">
                    14. December 2023
                    </time>
                    </h5>
                </p>
                
                <div itemprop="articleBody">
                    <div>


<p>It turns out that Unicode support in Terminals is a lot more difficult than it
first appears. A quick overview of special support for Unicode characters in
Terminals:</p>
<ul>
<li>&#34;Wide&#34; or &#34;<a href="https://en.wikipedia.org/wiki/Halfwidth_and_fullwidth_forms#In_Unicode">Fullwidth</a>&#34; characters, particularly for East Asian languages and
emojis, are codepoints that occupy two cells in a terminal instead of one.</li>
<li>&#34;Zero&#34; width <a href="https://en.wikipedia.org/wiki/Combining_character">combining</a> characters used in languages such as Arabic, Hebrew,
or Hindi do not occupy any cells themselves; instead, they modify the previous
character.</li>
<li>&#34;Zero Width Joiner&#34; (ZWJ <a href="https://codepoints.net/U+200D">U+200D</a>) reduces and combines many codepoints into
a single emoji.  This is similar to <a href="https://en.wikipedia.org/wiki/Combining_character">combining</a>, but encoded in a completely
different way.</li>
<li>&#34;Variation Selector-16&#34; (VS-16 <a href="https://codepoints.net/U+FE0F">U+FE0F</a>) is a special character that, for
specific &#34;Narrow&#34; emojis consuming one cell, causes them to become &#34;Wide&#34;,
consuming two cells.</li>
</ul>
<p>I share maintenance of the python <a href="https://github.com/jquast/wcwidth">wcwidth</a> library, which is responsible for
determining the printable width of a string when displayed to a terminal. I
worked hard to close all open issues, adding support for VS-16, ZWJ, and several
bug fixes to the Zero-Width table definitions.  I now believe it to be the most
accurate implementation.</p>
<p>Additionally, I authored a formal <a href="https://wcwidth.readthedocs.io/en/latest/specs.html">Specification</a> detailing how characters should
be measured.  Then, I updated the python <a href="https://github.com/jquast/ucs-detect">ucs-detect</a> tool to systematically asses
terminal emulators for their compliance with the specification.</p>
<p>Finally, I have <a href="https://ucs-detect.readthedocs.io/results.html">published results</a> for the most popular terminal emulators on
Linux, macOS, and Windows.  This article is a summary of my findings.</p>
<div id="wide-character-support">
<h2>Wide Character support</h2>
<p>Across all unicode capabilities tested, Wide character support is best. This is
likely attributed to the widespread adoption of emojis, which are treated as wide
characters, generating interest across developers and users of <em>all</em> languages.</p>
<p>While all tested terminals demonstrate support for wide characters, there are
variations in the Unicode versions they support. Notably, <a href="https://ucs-detect.readthedocs.io/sw_results/Konsole.html">Konsole</a>, <a href="https://ucs-detect.readthedocs.io/sw_results/iTerm2.html">iTerm2</a>,
and Kovid Goyal&#39;s <a href="https://ucs-detect.readthedocs.io/sw_results/KovidGoyalskitty.html">kitty</a> support wide characters up to Unicode release version
15.0.0 (2022). In contrast, <a href="https://ucs-detect.readthedocs.io/sw_results/Hyper.html">Hyper</a> and Visual Studio Code, both built on
<a href="http://xtermjs.org/">xterm.js</a>, provide support only up to Unicode release 12.1.0 (2019).</p>
<p>This means that these wide characters take up 1 cell instead of 2, often
occluded by the next character.</p>
<p><img alt="/images/hyper-wide.png" src="https://www.jeffquast.com/images/hyper-wide.png"/></p><p>Pictured here in <a href="https://ucs-detect.readthedocs.io/sw_results/Hyper.html">Hyper</a> terminal, the <a href="https://github.com/jquast/wcwidth">wcwidth</a> developer tool
<a href="https://github.com/jquast/wcwidth/blob/master/bin/wcwidth-browser.py">wcwidth-browser.py</a> shows several Wide Emoji mistakenly displayed as Narrow
instead of Wide, due to out-of-date code tables in <a href="http://xtermjs.org/">xterm.js</a>, causing
some to be partially occluded by the Pipe character (<tt>|</tt>).</p>
<p>The wcwidth project <a href="https://wcwidth.readthedocs.io/en/latest/specs.html">Specification</a> describes Wide characters as:</p>
<pre>&gt; Any character defined by East Asian Fullwidth (F)
&gt; or Wide (W) properties in EastAsianWidth txt
&gt; files, except those that are defined by the
&gt; Category codes of Nonspacing Mark (Mn) and
&gt; Spacing Mark (Mc).
</pre>
<p>The &#34;except&#34; clarification is needed, as there are several characters officially
categorized as Wide or Fullwidth, but contradictory definitions of Zero by other
data files!</p>
<p>The definition continues:</p>
<pre>&gt; Any characters of Modifier Symbol category,
&gt; &#39;Sk&#39; where &#39;FULLWIDTH&#39; is present in comment
&gt; of unicode data file, aprox. 3 characters.
</pre>
<p>The definition is further expanded to include any characters falling within the
Modifier Symbol &#39;Sk&#39; category, specifically those with &#39;FULLWIDTH&#39; mentioned in
the comment field of the Unicode data file—approximately three characters in
total.</p>
<p>This clause is crucial for a small set of characters from the modifier symbol
category that, while not officially designated as Fullwidth or Wide, indeed
exhibit these properties. Detecting these characters necessitates parsing the
comment field of the data files.</p>
<p>The &#34;Modifier Symbol&#34; category is a strange category. It is a set of combining
characters that <strong>do not</strong> act as combining characters, they are for lone display,
<strong>except</strong> for the Emoji Modifier Fitzpatrick codepoints, which modify the
skin tone of the preceding Emoji in sequence, making it a kind of <a href="https://en.wikipedia.org/wiki/Combining_character">combining</a>
character unlike all other characters of this category.</p>
<p>How difficult!  The Unicode.org data files present contradictory
categorizations. It&#39;s no wonder that developers, even those that strive for full
compliance, can still encounter difficulty in accurately categorizing a small
percentage of characters.</p>
</div>
<div id="zero-width">
<h2>Zero Width</h2>
<p>Testing support for Zero Width characters poses a particular challenge. While it
may be possible to combine some combining characters with any other Unicode
characters, like <a href="https://codepoints.net/U+0309">U+0309</a> &#34;Combining Hook
Above&#34; with box drawing character <a href="https://codepoints.net/U+2532">U+2532</a>:</p>
<pre>&gt;          ┲̉
</pre>
<p>Hoever, this is not the case for <em>most</em> combining characters, which can only
combine with specific characters.  For instance, <a href="https://codepoints.net/U+094D">U+094D</a> &#34;Devanagari Sign Virama&#34; successfully combines
with an appropriate Devanagari letter, like <a href="https://codepoints.net/U+0915">U+0915</a> &#34;Devanagari Letter Ka&#34;:</p>
<pre>&gt;           क्
</pre>
<p>However, it fails to combine for non-Devanagari letters, such as <a href="https://codepoints.net/U+0061">U+0061</a> &#34;Latin Small Letter A&#34;:</p>
<pre>&gt;           a्
</pre>
<p>The &#34;dotted donut&#34; depicted after &#34;Latin Small Letter A&#34; is used as a
placeholder for these illegal combinations.</p>
<p><img alt="/images/iterm2-combining-latin.png" src="https://www.jeffquast.com/images/iterm2-combining-latin.png"/></p><p>Depicted here in <a href="https://ucs-detect.readthedocs.io/sw_results/iTerm2.html">iTerm2</a> are several combining characters after
<a href="https://codepoints.net/U+0007">U+0007</a> &#34;Latin Small Letter O&#34;, where many
fail to combine, resulting in the display of a &#34;dotted donut&#34;.</p>
<p>To explore and visualize combining characters in a naive manner, you can use the
developer tool <a href="https://github.com/jquast/wcwidth/blob/master/bin/wcwidth-browser.py">wcwidth-browser.py</a> from the wcwidth repository. Press &#39;c&#39;
after launch or use the CLI argument <tt><span>--combining</span></tt>. However, this tool serves
primarily to demonstrate that naive combining is not feasible for a vast number
of characters.</p>
<div id="a-rosetta-stone">
<h3>A Rosetta Stone?</h3>
<p>The Universal Declaration of Human Rights (<a href="https://unicode.org/udhr/index.html">UDHR</a>) is a remarkable document
translated to over 500 languages. The <a href="https://unicode.org/udhr/index.html">UDHR</a> Unicode project curates a collection
of these translations, offering a valuable resource for testing support of
Zero-Width characters.</p>
<p>Outside of Emoji, we really only care about whether any particular language is
supported, and for many languages, Zero-Width characters are necessary to
properly write them.</p>
<p>Using the <a href="https://github.com/jquast/ucs-detect">ucs-detect</a> tool to display phrases from <a href="https://unicode.org/udhr/index.html">UDHR</a> in each language and
measuring the displayed width, we can conduct a comprehensive test for
Zero-Width character support of each Terminal by Language.</p>
</div>
<div id="zero-width-results">
<h3>Zero Width Results</h3>
<p>The Windows-only terminals, <a href="https://ucs-detect.readthedocs.io/sw_results/Terminalexe.html">Terminal.exe</a>, <a href="https://ucs-detect.readthedocs.io/sw_results/cmdexe.html">cmd.exe</a>, and <a href="https://ucs-detect.readthedocs.io/sw_results/ConsoleZ.html">ConsoleZ</a>,
as well as the cross-platform <a href="https://ucs-detect.readthedocs.io/sw_results/ExtratermQt.html">ExtraTermQt</a> and for-pay commercial <a href="https://ucs-detect.readthedocs.io/sw_results/zoc.html">zoc</a>
terminal all fail to correctly display many Zero-Width characters, failing
for approximately 100 of the world&#39;s languages.</p>
<p>The common error of these terminals is that they account category codes
Nonspacing Mark (Mn) and Spacing Mark (Mc) as Narrow instead of Zero width.</p>
<p>One example of the Hindi language from <a href="https://ucs-detect.readthedocs.io/sw_results/ConsoleZ.html">ConsoleZ</a> where the <a href="https://codepoints.net/U+093e">U+093e</a>
of &#39;Mc&#39; category is incorrectly measured as Narrow:</p>
<table>
<colgroup>
<col width="44%"/>
<col width="10%"/>
<col width="11%"/>
<col width="10%"/>
<col width="26%"/>
</colgroup>
<thead>
<tr><th>Codepoint</th>
<th>Python</th>
<th>Category</th>
<th>wcwidth</th>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr><td><a href="https://codepoints.net/U+092E">U+092E</a></td>
<td>&#39;\u092e&#39;</td>
<td>Lo</td>
<td>1</td>
<td>DEVANAGARI LETTER MA</td>
</tr>
<tr><td><a href="https://codepoints.net/U+093e">U+093e</a></td>
<td>&#39;\u093e&#39;</td>
<td>Mc</td>
<td>0</td>
<td>DEVANAGARI VOWEL SIGN AA</td>
</tr>
<tr><td><a href="https://codepoints.net/U+0928">U+0928</a></td>
<td>&#39;\u0928&#39;</td>
<td>Lo</td>
<td>1</td>
<td>DEVANAGARI LETTER NA</td>
</tr>
<tr><td><a href="https://codepoints.net/U+0935">U+0935</a></td>
<td>&#39;\u0935&#39;</td>
<td>Lo</td>
<td>1</td>
<td>DEVANAGARI LETTER VA</td>
</tr>
</tbody>
</table>
<ul>
<li>python <a href="https://wcwidth.readthedocs.io/en/latest/api.html#wcwidth.wcswidth">wcwidth.wcswidth()</a> measures width 3, while <a href="https://ucs-detect.readthedocs.io/sw_results/ConsoleZ.html">ConsoleZ</a> measures width 4.</li>
</ul>
<p>And another, of the Vietnamese language, from Microsoft&#39;s <a href="https://ucs-detect.readthedocs.io/sw_results/Terminalexe.html">Terminal.exe</a>, where
<a href="https://codepoints.net/U+0300">U+0300</a> &#34;Combining Grave Accent&#34; of the &#39;Mn&#39;
Category is incorrectly measured as Narrow:</p>
<table>
<colgroup>
<col width="45%"/>
<col width="10%"/>
<col width="11%"/>
<col width="10%"/>
<col width="24%"/>
</colgroup>
<thead>
<tr><th>Codepoint</th>
<th>Python</th>
<th>Category</th>
<th>wcwidth</th>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr><td><a href="https://codepoints.net/U+0074">U+0074</a></td>
<td>&#39;t&#39;</td>
<td>Ll</td>
<td>1</td>
<td>LATIN SMALL LETTER T</td>
</tr>
<tr><td><a href="https://codepoints.net/U+006F">U+006F</a></td>
<td>&#39;o&#39;</td>
<td>Ll</td>
<td>1</td>
<td>LATIN SMALL LETTER O</td>
</tr>
<tr><td><a href="https://codepoints.net/U+0061">U+0061</a></td>
<td>&#39;a&#39;</td>
<td>Ll</td>
<td>1</td>
<td>LATIN SMALL LETTER A</td>
</tr>
<tr><td><a href="https://codepoints.net/U+0300">U+0300</a></td>
<td>&#39;\u0300&#39;</td>
<td>Mn</td>
<td>0</td>
<td>COMBINING GRAVE ACCENT</td>
</tr>
<tr><td><a href="https://codepoints.net/U+006E">U+006E</a></td>
<td>&#39;n&#39;</td>
<td>Ll</td>
<td>1</td>
<td>LATIN SMALL LETTER N</td>
</tr>
</tbody>
</table>
<ul>
<li>python <a href="https://wcwidth.readthedocs.io/en/latest/api.html#wcwidth.wcswidth">wcwidth.wcswidth()</a> measures width 4, while Microsoft&#39;s
<a href="https://ucs-detect.readthedocs.io/sw_results/Terminalexe.html">Terminal.exe</a> measures width 5.</li>
</ul>
<p>It is understandable that these category codes are not considered for Zero-Width
support by so many other wcwidth and terminal developers. Unicode.org documents
make only general statements about the purpose of these categories and they do
not make any direct statements about Terminal Emulators. Developers must then
seek for answers among thousands of pages of documents that can be cryptic and
verbose.  Without a search engine and a &#34;hunch&#34;, it would be very difficult to
discover naturally!</p>
<p>From Standard <a href="https://www.unicode.org/reports/tr24/#Nonspacing_Marks">Annex #24</a> Unicode Script Property:</p>
<pre>&gt; Implementations that determine the boundaries
&gt; between characters of given scripts should never
&gt; break between a combining mark (a character with
&gt; General_Category value of Mc, Mn or Me)
</pre>
<p>And, from Unicode Standard <a href="https://www.unicode.org/reports/tr14/#DescriptionOfProperties">Annex #14</a> Unicode Line Breaking Algorithm:</p>
<pre>&gt; The CM line break class includes all combining
&gt; characters with General_Category Mc, Me, and Mn,
&gt; unless listed explicitly elsewhere. This includes
&gt; viramas that don’t have line break class VI or VF.
</pre>
</div>
</div>
<div id="variation-selector-16">
<h2>Variation Selector-16</h2>
<p><a href="https://codepoints.net/U+FE0F">U+FE0F</a> &#34;Variation Selector-16&#34; is peculiar.</p>
<p>I suspect it is some kind of &#34;fixup&#34; or compatibility sequence for the earliest
emojis. These emojis may be displayed in either &#34;text&#34; or &#34;emoji&#34; style, and
default to &#34;text&#34; style. In &#34;text&#34; style, emojis should appear without color in
a single cell (Narrow), while in &#34;emoji&#34; style, they should display in color and
occupy two cells (Wide).</p>
<p>Despite this distinction, very few fonts effectively differentiate between the two
styles, often rendering both types in color. When not in sequence with <a href="https://codepoints.net/U+FE0F">U+FE0F</a>
&#34;Variation Selector-16&#34;, they are occluded by any next character.</p>
<p>For example, <a href="https://codepoints.net/U+23F1">U+23F1</a> &#34;Stopwatch&#34;:</p>
<p><img alt="/images/iterm2-stopwatch-without-vs16.png" src="https://www.jeffquast.com/images/iterm2-stopwatch-without-vs16.png"/></p><p>Depicted here in <a href="https://ucs-detect.readthedocs.io/sw_results/iTerm2.html">iTerm2</a> is a single  <a href="https://codepoints.net/U+23F1">U+23F1</a>
&#34;Stopwatch&#34; character partially occluded by any next character. Surprisingly,
this is the correct behavior of a terminal when <a href="https://codepoints.net/U+FE0F">U+FE0F</a> &#34;Variation
Selector-16&#34; is not in sequence.</p>
<p>From python wcwidth <a href="https://wcwidth.readthedocs.io/en/latest/specs.html">Specification</a> on Wide characters:</p>
<pre>&gt; Any character in sequence with `U+FE0F`_
&gt; (Variation Selector 16) defined by Emoji
&gt; Variation Sequences txt as ``emoji style``.
</pre>
<p>A list of such characters is found in <a href="https://unicode.org/Public/15.1.0/ucd/emoji/emoji-variation-sequences.txt">emoji-variation-sequence.txt</a>.</p>
<div id="vs-16-results">
<h3>VS-16 Results</h3>
<p>Out of the 23 terminals subjected to testing, only 7 demonstrated correct behavior by
displaying these emojis as &#34;Wide&#34; characters when combined with VS-16 in sequence.</p>
<p>Remarkably, I found scarce documentation, if any, about VS-16 and its effects in
terminals.  The absence of documentation on this matter was the primary motivation
for writing this article.</p>
<p><a href="https://ucs-detect.readthedocs.io/sw_results/WezTerm.html">Wezterm</a>, for example, excels in complying with all other Unicode specifications
outlined in this article and tested by <a href="https://github.com/jquast/ucs-detect">ucs-detect</a>. However, like 16 other
terminals tested, it falls short in supporting VS-16. These emojis are
consistently occluded by the next character, even when in sequence with VS-16.</p>
<p><img alt="/images/wezterm-vs16.png" src="https://www.jeffquast.com/images/wezterm-vs16.png"/></p><p>Depicted here in <a href="https://ucs-detect.readthedocs.io/sw_results/WezTerm.html">Wezterm</a> is <a href="https://codepoints.net/U+23F1">U+23F1</a>
&#34;Stopwatch&#34; followed in sequence by <a href="https://codepoints.net/U+FE0F">U+FE0F</a> &#34;Variation Selector-16&#34;. However,
the stopwatch is displayed as Narrow. Wezterm does however do a good job of
scaling the font to fit within a single cell, while most other terminals cause
it to be partially occluded by any next character.</p>
</div>
</div>
<div id="emoji-zwj">
<h2>Emoji ZWJ</h2>
<p><a href="https://codepoints.net/U+200D">U+200D</a> &#34;Zero Width Joiner&#34; is a special character facilitating the reduction
of multiple emojis into a single representation that embodies their combination.
This feature resembles a special case of <a href="https://en.wikipedia.org/wiki/Combining_character">combining</a>, but it is encoded in a
completely different manner.</p>
<p>The python wcwidth <a href="https://wcwidth.readthedocs.io/en/latest/specs.html">Specification</a> on &#34;Width of 0&#34; reads:</p>
<pre>&gt; Any character following a ZWJ (U+200D) when
&gt; in sequence by function wcwidth.wcswidth().
</pre>
<p>An instance of a terminal lacking ZWJ support is Kovid Goyal’s <a href="https://ucs-detect.readthedocs.io/sw_results/KovidGoyalskitty.html">kitty</a>. It&#39;s
important to note that this terminal should not be confused with KiTTY, another
terminal emulator sharing a similar name but predating it by 14 years.
Mr. Goyal expresses <a href="https://github.com/kovidgoyal/kitty/issues/9#issuecomment-418566309">particular hostility</a> about
this naming conflict.</p>
<table>
<colgroup>
<col width="48%"/>
<col width="13%"/>
<col width="10%"/>
<col width="9%"/>
<col width="21%"/>
</colgroup>
<thead>
<tr><th>Codepoint</th>
<th>Python</th>
<th>Category</th>
<th>wcwidth</th>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr><td><a href="https://codepoints.net/U+0001F9D1">U+0001F9D1</a></td>
<td>&#39;\U0001f9d1&#39;</td>
<td>So</td>
<td>2</td>
<td>ADULT</td>
</tr>
<tr><td><a href="https://codepoints.net/U+200D">U+200D</a></td>
<td>&#39;\u200d&#39;</td>
<td>Cf</td>
<td>0</td>
<td>ZERO WIDTH JOINER</td>
</tr>
<tr><td><a href="https://codepoints.net/U+0001F9BC">U+0001F9BC</a></td>
<td>&#39;\U0001f9bc&#39;</td>
<td>So</td>
<td>2</td>
<td>MOTORIZED WHEELCHAIR</td>
</tr>
<tr><td><a href="https://codepoints.net/U+200D">U+200D</a></td>
<td>&#39;\u200d&#39;</td>
<td>Cf</td>
<td>0</td>
<td>ZERO WIDTH JOINER</td>
</tr>
<tr><td><a href="https://codepoints.net/U+27A1">U+27A1</a></td>
<td>&#39;\u27a1&#39;</td>
<td>So</td>
<td>1</td>
<td>BLACK RIGHTWARDS ARROW</td>
</tr>
<tr><td><a href="https://codepoints.net/U+FE0F">U+FE0F</a></td>
<td>&#39;\ufe0f&#39;</td>
<td>Mn</td>
<td>0</td>
<td>VARIATION SELECTOR-16</td>
</tr>
</tbody>
</table>
<ul>
<li>python <a href="https://wcwidth.readthedocs.io/en/latest/api.html#wcwidth.wcswidth">wcwidth.wcswidth()</a> measures width 2, while Kovid Goyal&#39;s <a href="https://ucs-detect.readthedocs.io/sw_results/KovidGoyalskitty.html">kitty</a>
measures width 6.</li>
</ul>
<p><img alt="/images/kitty-zwj.png" src="https://www.jeffquast.com/images/kitty-zwj.png"/></p><p>In this <a href="https://ucs-detect.readthedocs.io/sw_results/KovidGoyalskitty.html">kitty</a> example, the depicted sequence is expected to measure a width of 2.
However, <a href="https://ucs-detect.readthedocs.io/sw_results/KovidGoyalskitty.html">kitty</a> measures it as 6 because it does not interpret the Zero Width
Joiner character to reduce the three wide characters into one.</p>
</div>

</div>
                </div>
                
                
                

                
                
                    <a rel="prev" href="https://www.jeffquast.com/post/terminal_wcwidth_solution/" id="prev">
                        ← <span></span>
                    </a>
                
            </article>
        </section>

        
    </div></div>
  </body>
</html>
