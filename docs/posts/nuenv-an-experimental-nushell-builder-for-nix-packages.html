<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://determinate.systems/posts/nuenv">Original</a>
    <h1>Nuenv: An experimental Nushell builder for Nix packages</h1>
    
    <div id="readability-page-1" class="page"><div id="page" role="main">
        
          
<article id="sections" data-page-sections="615dfb3b1995b01cb9b11d99">
  
  
    
    


  


<section data-test="page-section" data-section-theme="white-bold" data-section-id="615dfb3b1995b01cb9b11d9b" data-controller="SectionWrapperController" data-current-styles="{
&#34;imageOverlayOpacity&#34;: 0.15,
&#34;backgroundWidth&#34;: &#34;background-width--full-bleed&#34;,
&#34;sectionHeight&#34;: &#34;section-height--medium&#34;,
&#34;horizontalAlignment&#34;: &#34;horizontal-alignment--center&#34;,
&#34;verticalAlignment&#34;: &#34;vertical-alignment--middle&#34;,
&#34;contentWidth&#34;: &#34;content-width--wide&#34;,
&#34;sectionTheme&#34;: &#34;white-bold&#34;,
&#34;sectionAnimation&#34;: &#34;none&#34;,
&#34;backgroundMode&#34;: &#34;image&#34;
}" data-current-context="{
&#34;video&#34;: {
&#34;playbackSpeed&#34;: 0.5,
&#34;filter&#34;: 1,
&#34;filterStrength&#34;: 0,
&#34;zoom&#34;: 0,
&#34;videoSourceProvider&#34;: &#34;none&#34;
},
&#34;backgroundImageId&#34;: null,
&#34;backgroundMediaEffect&#34;: null,
&#34;divider&#34;: null,
&#34;typeName&#34;: &#34;blog-side-by-side&#34;
}" data-animation="none">
  
  <div>
    <div>
      
      
      
      
      
      
      <div data-content-field="main-content" data-item-id="">
  <article id="article-">
  
    <div>
      

      <div>
        <div><div data-layout-label="Post Body" data-type="item" id="item-641b15403b9054754e0831e2"><div><div><div data-block-type="2" id="block-2480f9c265d49cd0aadc"><div>

<p>I appreciate <a href="https://www.gnu.org/software/bash/">Bash</a> for its stability and its near-ubiquity in Unix environments, but it has some clear drawbacks. I constantly get bitten by things like variable handling and string interpolation, I almost always need to supplement my Bash scripts with tools like <code>awk</code>, <code>sed</code>, <code>curl</code>, <code>jq</code>, and <code>wget</code> to get even basic things done, and I’d be hard-pressed to use “Bash” and “elegant” or “expressive” in the same sentence.</p><p>Despite shortcomings like these, <a href="https://zero-to-nix.com/concepts/nixpkgs">Nixpkgs</a> uses <a href="https://gnu.org/software/bash" target="_blank">Bash</a> as the builder in its <a href="https://nixos.org/manual/nixpkgs/stable/#chap-stdenv" target="_blank">standard environment</a> (or <code>stdenv</code>), most notably in the <code>stdenv.mkDerivation</code> function. This wrapper over Nix’s built-in derivation function is used almost everywhere in <a href="https://zero-to-nix.com/concepts/nixpkgs" target="_blank">Nixpkgs</a> and acts as a de facto default in the Nix community.</p><p>I believe that standardizing on Bash as a known quantity was absolutely the right choice for the standard environment. But I’ve always been intrigued by the possibility of using a more powerful, ergonomically-minded shell to <a href="https://zero-to-nix.com/concepts/realisation" target="_blank">realise</a> Nix derivations. So I decided to give it a try by creating a Nix realisation environment that uses <a href="https://www.nushell.sh/" target="_blank">Nushell</a>, a powerful, cutting-edge shell written in <a href="https://rust-lang.org">Rust</a> and under heavy development, instead of Bash. I’m calling it <a href="https://github.com/DeterminateSystems/nuenv">Nuenv</a> and it’s proven to be quite a fruitful exercise and yielded some promising initial results.</p><h3>Why I chose Nushell</h3><p>There are many “alt” shells out there, like <a href="https://fishshell.com/" target="_blank">Fish</a>, <a href="https://elv.sh/" target="_blank">Elvish</a>, and <a href="https://www.oilshell.org/" target="_blank">Oil</a>. These are all exciting projects but Nushell really stands out to me. Here’s a non-exhaustive list of reasons why:</p><ul data-rte-list="default"><li><p>It offers built-in support for <a href="https://www.nushell.sh/commands/docs/from_json.html" target="_blank">JSON</a>, <a href="https://www.nushell.sh/commands/docs/from_csv.html" target="_blank">CSV</a>, <a href="https://www.nushell.sh/commands/docs/from_yaml.html" target="_blank">YAML</a>, <a href="https://www.nushell.sh/commands/docs/from_toml.html" target="_blank">TOML</a>, <a href="https://www.nushell.sh/book/loading_data.html#sqlite" target="_blank">SQLite</a>, and even <a href="https://www.nushell.sh/book/dataframes.html" target="_blank">DataFrames</a>.</p></li><li><p>It offers a broad range of built-in <a href="https://www.nushell.sh/commands/">commands</a> that play nicely together and more or less replace tools like <code>jq</code>, <code>curl</code>, <code>awk</code>, <code>cut</code>, <code>join</code>, and <code>sed</code>.</p></li><li><p>It enables you to create <a href="https://www.nushell.sh/book/custom_commands.html#custom-commands">custom commands</a> with typed inputs and auto-generated (and very pretty) help output.</p></li><li><p>It supports nested data <a href="https://www.nushell.sh/book/types_of_data.html#records">records</a>, which gives it a kind of object-oriented flavor.</p></li><li><p>It has built-in support for <a href="https://www.nushell.sh/book/testing.html">testing</a>.</p></li><li><p>It offers scoping mechanisms like <a href="https://www.nushell.sh/book/modules.html">modules</a> and <a href="https://www.nushell.sh/book/overlays.html">overlays</a>.</p></li></ul><p>While Nushell isn’t <em>quite</em> a general-purpose programming language, it certainly skirts the boundary between a shell and a full-fledged language. Not all of Nushell’s features are equally germane to an alternative environment for Nix, of course, but I think that these features show how ambitious the project is.</p><p>Here’s what I think Nushell has to offer a new Nix environment:</p><ul data-rte-list="default"><li><p>It makes a clean separation between environment and standard variables. <code>$foo</code> would refer to a variable in the local scope but only <code>$env.foo</code> could refer to an environment variable. This enables you to avoid those un-fun variable name clashes that pop up so often in Bash.</p></li><li><p><a href="https://www.nushell.sh/commands/categories/strings.html" target="_blank">String handling</a> is powerful enough to obviate the need for the usual smorgasbord of tools required for string parsing, like <code>awk</code>, <code>sed</code>, and <code>tr</code>.</p></li><li><p>The <a href="https://www.nushell.sh/book/custom_commands.html#custom-commands" target="_blank">custom commands</a> with <a href="https://www.nushell.sh/book/custom_commands.html#parameter-types" target="_blank">typed parameters</a> that I mentioned above make the environment much more robust than Bash’s “stringly” typing and awkward function argument handling. Here’s an example custom command:</p></li></ul>


</div></div><div data-block-type="2" id="block-yui_3_17_2_1_1679500681923_8447"><p>Now here’s the help output you get by running <code>sayHello --help</code>:</p></div><div data-block-type="2" id="block-yui_3_17_2_1_1679500681923_9266"><div>

<p>As you can see, custom commands in Nushell feel like well-crafted CLI tools in their own right. This makes Nushell-based environments far more introspectable than their Bash counterparts.</p><h3>How I created the environment</h3><p>To create my new build environment for Nix, <a href="https://github.com/DeterminateSystems/nuenv">Nuenv</a>, I first wrote a Nix function wrapping Nix’s built-in <a href="https://zero-to-nix.com/concepts/derivations" target="_blank">derivation</a> function:</p>


</div></div><div data-block-type="2" id="block-yui_3_17_2_1_1679500681923_10468"><div>

<p>The basic mechanics: Nushell (set as the builder instead of Bash) runs a script called <code><a href="https://github.com/DeterminateSystems/nuenv/blob/0fbc1e0d6a398335e8404b0039c611fe462bc081/nuenv/bootstrap.nu">bootstrap.nu</a></code> that performs some setup actions (like making the Nushell executable itself discoverable in the env). The bootstrapper then runs a <code><a href="https://github.com/DeterminateSystems/nuenv/blob/0fbc1e0d6a398335e8404b0039c611fe462bc081/nuenv/builder.nu">builder.nu</a></code> script that performs the actual realisation. As in all Nix derivations, the other attributes of the derivation are set as environment variables available to that script (plus some others that Nix provides). The <code>builder.nu</code> script needs to do quite a lot, including:</p><ul data-rte-list="default"><li><p>Creating the directory in the <a href="https://zero-to-nix.com/concepts/nix-store" target="_blank">Nix store</a> where build output will end up (Nix provides an <code>out</code> environment variable for that but it doesn’t automatically create that directory).</p></li><li><p>Copying all of the derivation’s sources (<code>src</code> or <code>srcs</code> in the standard environment) into the build sandbox, which resides in a temporary directory. Nix <em>does</em> put those sources in the Nix store at <code>/nix/store/$HASH-source</code> but the builder script needs to copy them into the sandbox.</p></li><li><p>Making sure that the sandbox can discover any packages required by the derivation process using the <code>PATH</code>.</p></li></ul><p>That establishes a kind of bare minimum environment. Beyond that, a builder script <em>should</em> provide things like helper functions (<em>commands</em> in Nushell) for use in derivation logic. The standard environment provides many such functions via the <code><a href="https://github.com/DeterminateSystems/nuenv/blob/24c11410b359f8f96572cf97cb6e67177fad3200/nuenv/user-env.nu">user-env.nu</a></code> script, like <code><a href="https://nixos.org/manual/nixpkgs/stable/#fun-wrapProgram">wrapProgram</a></code> and <code><a href="https://nixos.org/manual/nixpkgs/stable/#fun-substituteInPlace">substituteInPlace</a></code>. For Nuenv, I’ve provided two so far:</p><ul data-rte-list="default"><li><p><code><a href="https://github.com/DeterminateSystems/nuenv/blob/0fbc1e0d6a398335e8404b0039c611fe462bc081/nuenv/user-env.nu#L60-L77">substitute</a></code>, which performs string substitution in a specified file and writes the output to a new file.</p></li><li><p><code><a href="https://github.com/DeterminateSystems/nuenv/blob/0fbc1e0d6a398335e8404b0039c611fe462bc081/nuenv/user-env.nu#L79-L94">substituteInPlace</a></code> is like <code>substitute</code> but rewrites the specified file in place.</p></li></ul><p>In principle, however, the full battery of <code>stdenv</code> functions could be replaced with custom Nushell commands.</p><p>Overall, I was extremely impressed with how elegant the Nushell build script is compared to what its Bash equivalent would be. I’ll provide an illustrative example. Here’s how I <a href="https://github.com/DeterminateSystems/nuenv/blob/0fbc1e0d6a398335e8404b0039c611fe462bc081/nuenv/builder.nu#L82-L87">set the </a><code><a href="https://github.com/DeterminateSystems/nuenv/blob/0fbc1e0d6a398335e8404b0039c611fe462bc081/nuenv/builder.nu#L82-L87">PATH</a></code> to discover packages in the Nix store:</p>


</div></div><div data-block-type="2" id="block-yui_3_17_2_1_1679500681923_13148"><p>Here’s how you would accomplish something like that in Bash:</p></div><div data-block-type="2" id="block-yui_3_17_2_1_1679500681923_13913"><div>

<p>As you can see, Nushell feels closer to something like Ruby.</p><p>Despite wins like this, Nuenv in its current state does have some major shortcomings vis-à-vis the Nixpkgs standard environment:</p><ul data-rte-list="default"><li><p>There’s only one realisation phase, called <code>build</code>. By contrast, the stdenv is much more nuanced, offering support for Makefiles, <code>configure</code> scripts, and differentiated <a href="https://nixos.org/manual/nixpkgs/stable/#ssec-controlling-phases">phases</a> like <code>buildPhase</code>, <code>installPhase</code>, <code>configurePhase</code>, and <code>checkPhase</code>.</p></li><li><p>You can only pass one set of packages to the environment, whereas stdenv makes a <a href="https://discourse.nixos.org/t/use-buildinputs-or-nativebuildinputs-for-nix-shell/8464" target="_blank">distinction</a> between <code>buildInputs</code>, <code>nativeBuildInputs</code>, <code>propagatedBuildInputs</code>, and others. The dependencies you supply using packages in Nuenv are only available at build time and aren’t included in the runtime package, while stdenv enables you to target dependencies to both build time and run time as well as things like cross-compilation (which is not supported in Nuenv).</p></li><li><p>Nuenv-based realisations are likely to be a bit more costly, in terms of build time and disk space used by the Nix store, than <code>stdenv.mkDerivation</code> because the Nushell package is required, although caching and the fact that Nushell doesn’t require <a href="https://www.gnu.org/software/coreutils/">coreutils</a> should make this cost relatively small. A related limitation is that you can only realise Nuenv-based derivations on systems that can run Nushell. While that should be a fairly sizable range of systems given that Nushell is built in <a href="https://rust-lang.org/" target="_blank">Rust</a>, it’s nowhere near the range of systems that can run Bash.</p></li></ul><p>So definitely don’t use Nuenv for any serious purpose just yet.</p><h3>User-facing benefits of Nuenv</h3><p>Although Nuenv is still at an early stage, I think that it already has some nice advantages over stdenv:</p><ul data-rte-list="default"><li><p>Inside your derivation logic, you get access to the broad Nushell feature set I talked about above.</p></li><li><p>It has much prettier log output thanks to Nushell’s easy-to-use <a href="https://www.nushell.sh/commands/docs/ansi.html" target="_blank">ANSI</a> support. While this is more of a quality-of-life thing, it does liven things up a bit.</p></li><li><p>You can try out the Nuenv environment locally by running <code>nix develop .#nuenv</code> if you clone the repo (or <code>nix develop github:DeterminateSystems/nuenv#nuenv</code> if you don’t want to clone the repo locally). This gives you access to Nuenv’s helper commands. Run <code>substituteInPlace --help</code> to see an example. As far as I know, there isn’t really a way to introspect the stdenv in this way. You <em>can</em> access Bash with stdenv’s functions provided by running <code>nix-shell -p</code> but those functions don’t provide help output. You can also see a list of custom commands available to Nuenv derivations by running <code>nix run github:DeterminateSystems/nuenv#nuenv-commands</code>.</p></li></ul><h3>Try it out</h3><p>You can try out Nuenv in several ways. To build an example package using the environment:</p>


</div></div><div data-block-type="2" id="block-yui_3_17_2_1_1679500681923_19871"><div>

<p>This is a pretty simple derivation that pipes a string to <a href="https://www.gnu.org/software/hello/">GNU hello</a> and writes that output to the <code>share</code> directory in the build output.</p><p>You can also build your own package with Nuenv! Here’s an example <code>flake.nix</code>:</p>


</div></div><div data-block-type="2" id="block-yui_3_17_2_1_1679500681923_20656"><div>

<p>If you’ve <a href="https://zero-to-nix.com/start/install" target="_blank">installed Nix with flakes enabled</a>, you can copy this flake.nix into a directory and run <code>nix build &amp;&amp; cat ./result/share/hello.txt</code> to see the result. To run a Nushell script instead of providing a raw string, you can supply <code>build = builtins.readFile ./my-nushell-script.nu</code> to the derivation.</p><h3>Ramifications</h3><p>I think that using a more powerful builder for Nix—maybe Nushell, maybe something else—has major implications:</p><ul data-rte-list="default"><li><p>If can offer a <strong>dramatically improved developer experience</strong> around derivation. Right now, derivation remains a bit of a dark art and one of the more intimidating aspects of using Nix (which is already intimidating in itself).</p></li><li><p>It can <strong>radically alter the division of labor between Nix and the builder</strong>. Because Bash isn’t terribly powerful, Nix has to do a lot of the work of making things palatable to Bash, like constructing complex strings. But with a more powerful shell, Nix can defer a lot of work to the builder. Wouldn’t it be nice to just use Nix to supply simple attribute sets and let the builder handle the rest?</p></li><li><p>Because any Nix environment is just Nix, you could <strong>introduce something like Nushell piecemeal into the Nix dependency tree</strong>. Imagine replacing some core utilities in Nixpkgs with more robust, ergonomic equivalents or dramatically simplifying language-specific derivation wrappers.</p></li></ul><p>While I don’t see Nushell or its ilk taking over the Nix world by storm any time soon, I do hope that this post gets you thinking about what a qualitatively better builder might mean for Nix.</p>


</div></div><div data-block-type="2" id="block-yui_3_17_2_1_1679500681923_21026"><div>

<h3>Conclusion: an oh-so-worthy experiment</h3><p>My work on <a href="https://github.com/DeterminateSystems/nuenv">Nuenv</a> hasn’t yielded a particularly robust Nix environment just yet but it’s been a fantastic learning experience about some of the lower-level nitty gritty of how Nix works. If you’re looking to level up your Nix knowledge, I strongly encourage you to take on a similar project (or hack on Nuenv!). You may just end up blazing a fruitful new trail for yourself and others in the Nix community—or with a renewed appreciation for the tried-and-true standard environment.</p><p>Finally, using Nushell in conjunction with Nix has simply sparked joy in a way that trusty old Bash simply doesn’t (for me, at least). While that isn’t a very “engineeringly” justification for building something, there’s much to be said for working on things that compel a dramatic shift of energy and attention. We don’t have any concrete plans to take Nuenv much further at this time but we’d love to see how the community reacts.</p>


</div></div></div></div></div></div>

        

        
        
          
        
      </div>

      
    </div>
  
</article>

</div>
    </div>
  </div>
  
  
</section>

  
</article>


          

          
            
              

            
          
        
      </div></div>
  </body>
</html>
