<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/valdanylchuk/xcc700">Original</a>
    <h1>Show HN: Xcc700: Self-hosting mini C compiler for ESP32 (Xtensa) in 700 lines</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<div dir="auto"><h2 tabindex="-1" dir="auto">Why look into this project?</h2><a id="user-content-why-look-into-this-project" aria-label="Permalink: Why look into this project?" href="#why-look-into-this-project"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>A compiler you can fully grasp and tweak, on a modern platform where small is still cool.</li>
<li>Basic features, not too entrenched, easy to morph into your language of choice.</li>
<li>Reusable ELF writer, and a basic Xtensa bytecodes emitter.</li>
<li>Possibly useful for hotfixes, CI, quick test/debug turnaround on esp32.</li>
</ul>

<div data-snippet-clipboard-copy-content="./xcc700 xcc700.c -o xcc700.elf 

[ xcc700 ] BUILD COMPLETED &gt; OK
&gt; IN  : 700 Lines / 7977 Tokens
&gt; SYM : 69 Funcs / 91 Globals
&gt; REL : 152 Literals / 1027 Patches
&gt; MEM : 1041 B .rodata / 17120 B .bss
&gt; OUT : 27735 B .text / 33300 B ELF
[ 40 ms ] &gt;&gt; 17500 Lines/sec &lt;&lt;"><pre><code>./xcc700 xcc700.c -o xcc700.elf 

[ xcc700 ] BUILD COMPLETED &gt; OK
&gt; IN  : 700 Lines / 7977 Tokens
&gt; SYM : 69 Funcs / 91 Globals
&gt; REL : 152 Literals / 1027 Patches
&gt; MEM : 1041 B .rodata / 17120 B .bss
&gt; OUT : 27735 B .text / 33300 B ELF
[ 40 ms ] &gt;&gt; 17500 Lines/sec &lt;&lt;
</code></pre></div>
<p dir="auto">Note: that timing is from esp32-s3. Timings on Mac/POSIX will be reported 1000x slower than they are, as on esp32 ticks are millisecond, and on POSIX microsecond, but there is no adjustment here.</p>

<details open="">
  <summary>
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path d="M16 3.75v8.5a.75.75 0 0 1-1.136.643L11 10.575v.675A1.75 1.75 0 0 1 9.25 13h-7.5A1.75 1.75 0 0 1 0 11.25v-6.5C0 3.784.784 3 1.75 3h7.5c.966 0 1.75.784 1.75 1.75v.675l3.864-2.318A.75.75 0 0 1 16 3.75Zm-6.5 1a.25.25 0 0 0-.25-.25h-7.5a.25.25 0 0 0-.25.25v6.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-6.5ZM11 8.825l3.5 2.1v-5.85l-3.5 2.1Z"></path>
</svg>
    <span>xcc700_demo10s.mov</span>
    <span></span>
  </summary>

  <video src="https://private-user-images.githubusercontent.com/621005/530360936-2bbd4fd5-04f7-4890-abf0-5e7454345148.mov?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjY3OTE1MDcsIm5iZiI6MTc2Njc5MTIwNywicGF0aCI6Ii82MjEwMDUvNTMwMzYwOTM2LTJiYmQ0ZmQ1LTA0ZjctNDg5MC1hYmYwLTVlNzQ1NDM0NTE0OC5tb3Y_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUxMjI2JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MTIyNlQyMzIwMDdaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT0zOTc1NzA0MjgyMWYyZjIwYjQwNDA0YmU1NjllOTQ1ZTI1MjgyMmJmZTdkN2M5OTkwMmQ3NjBmYTM0NDA3ZDBjJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.g0aWMWW5q9wzgncYOWPq0hxwr6De3tgrql9L_94KwQE" data-canonical-src="https://private-user-images.githubusercontent.com/621005/530360936-2bbd4fd5-04f7-4890-abf0-5e7454345148.mov?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjY3OTE1MDcsIm5iZiI6MTc2Njc5MTIwNywicGF0aCI6Ii82MjEwMDUvNTMwMzYwOTM2LTJiYmQ0ZmQ1LTA0ZjctNDg5MC1hYmYwLTVlNzQ1NDM0NTE0OC5tb3Y_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUxMjI2JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MTIyNlQyMzIwMDdaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT0zOTc1NzA0MjgyMWYyZjIwYjQwNDA0YmU1NjllOTQ1ZTI1MjgyMmJmZTdkN2M5OTkwMmQ3NjBmYTM0NDA3ZDBjJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.g0aWMWW5q9wzgncYOWPq0hxwr6De3tgrql9L_94KwQE" controls="controls" muted="muted">

  </video>
</details>

<p dir="auto">.</p>

<p dir="auto">Several options:</p>
<p dir="auto"><strong>A.</strong> Compile with <code>gcc xcc700.c</code> and run it on your computer as a cross-compiler. It is fairly portable, tested on Mac x86_64 and arm64.</p>
<p dir="auto"><strong>B.</strong> Compile for esp32 using xtensa-gcc or xcc700 from the option A (yes it can compile and cross-compile itself). Or grab the gcc-compiled version here: <a href="https://github.com/valdanylchuk/xcc700/blob/main/release/xcc700.elf">xcc700.elf (16kB)</a>. Run with <a href="https://components.espressif.com/components/espressif/elf_loader/" rel="nofollow">ESP-IDF elf_loader</a>.</p>
<p dir="auto"><strong>C.</strong> Adapt the source code and call it as a function in your firmware.</p>

<ul dir="auto">
<li>C features: minimum required to write something like this compiler. While loop, if/then/else, limited support for int/char/pointers/arrays, function calls and definitions, basic arithmetic and bitwise operators.</li>
<li>Single source .c file as input, single REL ELF file as output.</li>
<li>The output files can be run directly by the ESP-IDF elf_loader component, which links them on load via relocation table to anything you have exposed in your firmware: newlib libc, LVGL, your custom functions, anything you like. Just declare the functions you use.</li>
</ul>

<ul dir="auto">
<li>The rest of the C: for/do, include/define, long/float/double, struct/union/typedef, switch/case, array initializers, .data section, multi-line comments, too much to list.</li>
<li>Many features are implemented only partially. E.g. you can have .bss globals but not global initializers; ++/-- are only supported in prefix position, assignment as statement not expression, types are mostly not checked, etc.</li>
<li>Error handling and reporting. It is wildly optimistic, enforces nothing, has only a few error checks, and will crash in spectacular and unexpected ways on the most trivial errors.</li>
<li>Optimization. It treats the Xtensa CPU as a stack machine, with no attempt at register allocation, and no benefit from the sliding window. It is a major sacrifice of performance for simplicity. GCC-compiled: 16kB, 17,500 lines/s; self-compiled: 33kB, 3,900 lines/s.</li>
<li>Miss a feature? Just fork it! With a working foundation in only 700 lines, it is fairly easy to get started.</li>
</ul>

<p dir="auto">This is free software under MIT License, see <a href="https://github.com/valdanylchuk/xcc700/blob/main/LICENSE">LICENSE</a>.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Contributing: Forks Welcome!</h2><a id="user-content-contributing-forks-welcome" aria-label="Permalink: Contributing: Forks Welcome!" href="#contributing-forks-welcome"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">While I do not believe the world needs another C99 implementation, and do not intend to add features here, I am dead curious to see where the other creative minds can take a tiny self-hosting compiler on esp32.</p>
<p dir="auto">If you organize hackathons, or assign coursework, or write tutorials, please consider xcc700 as a base to fork and extend! It can run on the available PCs, or on a $5 MCU if you want real cool hardware for the final test. Or you can port it to other systems, and use ld to link those ELF files.</p>

<p dir="auto">I was making an esp32 &#34;cyberdeck&#34;, and thought it cool to build some binaries directly on it. Esp32 is underrated in userland. It can do everything a 90s PC could do and more.</p>
<p dir="auto">You can also take this as an artistic statement, and ask yourself:</p>
<ul dir="auto">
<li>How many Watts do you need to do fun/useful stuff on a computer?</li>
<li>Isn&#39;t it nice to have simple, tinker-friendly versions of common apps?</li>
<li>Do we really need 300MB mouse drivers?</li>
</ul>
<p dir="auto">Have fun!</p>
</article></div></div>
  </body>
</html>
