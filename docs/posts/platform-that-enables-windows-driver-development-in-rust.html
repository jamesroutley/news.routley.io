<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/microsoft/windows-drivers-rs">Original</a>
    <h1>Platform that enables Windows driver development in Rust</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">This repo is a collection of Rust crates that enable developers to develop Windows Drivers in Rust. It is the intention to support both WDM and WDF driver development models. This repo contains the following crates:</p>
<ul dir="auto">
<li><a href="http://ablwr.github.io/microsoft/windows-drivers-rs/blob/main/crates/wdk-build">wdk-build</a>: A library to configure a Cargo build script for binding generation and downstream linking of the WDK (Windows Developer Kit). While this crate is written to be flexible with different WDK releases and different WDF version, it is currently only tested for NI eWDK, KMDF 1.33, UMDF 2.33, and WDM Drivers. There may be missing linker options for older DDKs.</li>
<li><a href="http://ablwr.github.io/microsoft/windows-drivers-rs/blob/main/crates/wdk-sys">wdk-sys</a>: Direct FFI bindings to APIs available in the Windows Development Kit (WDK). This includes both autogenerated ffi bindings from <code>bindgen</code>, and also manual re-implementations of macros that bindgen fails to generate.</li>
<li><a href="http://ablwr.github.io/microsoft/windows-drivers-rs/blob/main/crates/wdk">wdk</a>: Safe idiomatic bindings to APIs available in the Windows Development Kit (WDK)</li>
<li><a href="http://ablwr.github.io/microsoft/windows-drivers-rs/blob/main/crates/wdk-panic">wdk-panic</a>: Default panic handler implementations for programs built with WDK</li>
<li><a href="http://ablwr.github.io/microsoft/windows-drivers-rs/blob/main/crates/wdk-alloc">wdk-alloc</a>: alloc support for binaries compiled with the Windows Development Kit (WDK)</li>
<li><a href="http://ablwr.github.io/microsoft/windows-drivers-rs/blob/main/crates/wdk-macros">wdk-macros</a>: A collection of macros that help make it easier to interact with wdk-sys&#39;s direct bindings. This crate is re-exported via <code>wdk-sys</code> and crates should typically never need to directly depend on <code>wdk-macros</code></li>
</ul>
<p dir="auto">To see an example of this repo used to create drivers, see <a href="https://github.com/microsoft/Windows-rust-driver-samples">Windows-rust-driver-samples</a>.</p>
<p dir="auto">Note: This project is still in early stages of development and is not yet recommended for commercial use. We encourage community experimentation, suggestions and discussions! We will be using our <a href="https://github.com/microsoft/windows-drivers-rs/discussions">GitHub Discussions forum</a> as the main form of engagement with the community!</p>
<h2 tabindex="-1" id="user-content-supported-configurations" dir="auto"><a href="#supported-configurations"></a><a name="user-content-supported-configs">Supported Configurations</a><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></h2>
<p dir="auto">This project was built with support of WDM, KMDF, and UMDF drivers in mind, as well as Win32 Services. This includes support for all versions of WDF included in WDK 22H2 and newer. Currently, the crates available on <a href="https://crates.io" rel="nofollow"><code>crates.io</code></a> only support KMDF v1.33, but bindings can be generated for everything else by cloning <code>windows-drivers-rs</code> and modifying the config specified in <a href="http://ablwr.github.io/microsoft/windows-drivers-rs/blob/main/crates/wdk-sys/build.rs"><code>build.rs</code> of <code>wdk-sys</code></a>. Crates.io support for other WDK configurations is planned in the near future.</p>
<h2 tabindex="-1" id="user-content-getting-started" dir="auto"><a href="#getting-started">Getting Started<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<h3 tabindex="-1" id="user-content-build-requirements" dir="auto"><a href="#build-requirements">Build Requirements<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<ul dir="auto">
<li>
<p dir="auto">Binding generation via <code>bindgen</code> requires <code>libclang</code>. The easiest way to acquire this is via <code>winget</code></p>
<ul dir="auto">
<li><code>winget install LLVM.LLVM</code></li>
</ul>
</li>
<li>
<p dir="auto">To execute post-build tasks (ie. <code>inf2cat</code>, <code>infverif</code>, etc.), <code>cargo make</code> is used</p>
<ul dir="auto">
<li><code>cargo install --locked cargo-make --no-default-features --features tls-native</code></li>
</ul>
</li>
<li>
<p dir="auto">Building programs with the WDK also requires being in a valid WDK enviroment. The recommended way to do this is to <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/develop/using-the-enterprise-wdk#getting-started" rel="nofollow">enter an eWDK developer prompt</a></p>
</li>
</ul>
<h2 tabindex="-1" id="user-content-adding-windows-drivers-rs-to-your-driver-package" dir="auto"><a href="#adding-windows-drivers-rs-to-your-driver-package">Adding windows-drivers-rs to Your Driver Package<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">The crates in this repository are available from <a href="https://crates.io" rel="nofollow"><code>crates.io</code></a>, but take into account the current limitations outlined in <a href="#supported-configs">Supported Configurations</a>. If you need to support a different config, try cloning this repo and using <a href="https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html#specifying-path-dependencies" rel="nofollow">path dependencies</a></p>
<ol dir="auto">
<li>
<p dir="auto">Create a new Cargo package with a lib crate:</p>
<div dir="auto" data-snippet-clipboard-copy-content="cargo new &lt;driver_name&gt; --lib --config"><pre>cargo new <span>&lt;</span>driver_name<span>&gt;</span> <span>--</span>lib <span>--</span>config</pre></div>
</li>
<li>
<p dir="auto">Add dependencies on <code>windows-drivers-rs</code> crates:</p>
<div dir="auto" data-snippet-clipboard-copy-content="cd &lt;driver_name&gt;
cargo add --build wdk-build
cargo add wdk wdk-sys wdk-alloc wdk-panic"><pre>cd <span>&lt;</span>driver_name<span>&gt;</span>
cargo add <span>--</span>build wdk<span>-</span>build
cargo add wdk wdk<span>-</span>sys wdk<span>-</span>alloc wdk<span>-</span>panic</pre></div>
</li>
<li>
<p dir="auto">Set the crate type to <code>cdylib</code> by adding the following snippet to <code>Cargo.toml</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="[lib]
crate-type = [&#34;cdylib&#34;]"><pre>[<span>lib</span>]
<span>crate-type</span> = [<span><span>&#34;</span>cdylib<span>&#34;</span></span>]</pre></div>
</li>
<li>
<p dir="auto">Set crate panic strategy to <code>abort</code> in <code>Cargo.toml</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="[profile.dev]
panic = &#34;abort&#34;
lto = true # optional setting to enable Link Time Optimizations

[profile.release]
panic = &#34;abort&#34;
lto = true # optional setting to enable Link Time Optimizations"><pre>[<span>profile</span>.<span>dev</span>]
<span>panic</span> = <span><span>&#34;</span>abort<span>&#34;</span></span>
<span>lto</span> = <span>true</span> <span><span>#</span> optional setting to enable Link Time Optimizations</span>

[<span>profile</span>.<span>release</span>]
<span>panic</span> = <span><span>&#34;</span>abort<span>&#34;</span></span>
<span>lto</span> = <span>true</span> <span><span>#</span> optional setting to enable Link Time Optimizations</span></pre></div>
</li>
<li>
<p dir="auto">Create a <code>build.rs</code> and add the following snippet:</p>
<div dir="auto" data-snippet-clipboard-copy-content="fn main() -&gt; Result&lt;(), wdk_build::ConfigError&gt; {
   wdk_build::Config::from_env_auto()?.configure_binary_build();
   Ok(())
}"><pre><span>fn</span> <span>main</span><span>(</span><span>)</span> -&gt; <span>Result</span><span>&lt;</span><span>(</span><span>)</span><span>,</span> wdk_build<span>::</span><span>ConfigError</span><span>&gt;</span> <span>{</span>
   wdk_build<span>::</span><span>Config</span><span>::</span><span>from_env_auto</span><span>(</span><span>)</span>?<span>.</span><span>configure_binary_build</span><span>(</span><span>)</span><span>;</span>
   <span>Ok</span><span>(</span><span>(</span><span>)</span><span>)</span>
<span>}</span></pre></div>
</li>
<li>
<p dir="auto">Mark your driver as <code>no_std</code> in <code>lib.rs</code>:</p>

</li>
<li>
<p dir="auto">Add a panic handler in <code>lib.rs</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="#[cfg(not(test))]
extern crate wdk_panic;
"><pre><span>#<span>[</span>cfg<span>(</span>not<span>(</span>test<span>)</span><span>)</span><span>]</span></span>
<span>extern</span> <span>crate</span> wdk_panic<span>;</span></pre></div>
</li>
<li>
<p dir="auto">Add a global allocator in <code>lib.rs</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="#[cfg(not(test))]
use wdk_alloc::WDKAllocator;

#[cfg(not(test))]
#[global_allocator]
static GLOBAL_ALLOCATOR: WDKAllocator = WDKAllocator;"><pre><span>#<span>[</span>cfg<span>(</span>not<span>(</span>test<span>)</span><span>)</span><span>]</span></span>
<span>use</span> wdk_alloc<span>::</span><span>WDKAllocator</span><span>;</span>

<span>#<span>[</span>cfg<span>(</span>not<span>(</span>test<span>)</span><span>)</span><span>]</span></span>
<span>#<span>[</span>global_allocator<span>]</span></span>
<span>static</span> <span>GLOBAL_ALLOCATOR</span><span>:</span> <span>WDKAllocator</span> = <span>WDKAllocator</span><span>;</span></pre></div>
</li>
<li>
<p dir="auto">Add a DriverEntry in <code>lib.rs</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="use wdk_sys::{
   DRIVER_OBJECT,
   NTSTATUS,
   PCUNICODE_STRING,
};

#[export_name = &#34;DriverEntry&#34;] // WDF expects a symbol with the name DriverEntry
pub unsafe extern &#34;system&#34; fn driver_entry(
   driver: &amp;mut DRIVER_OBJECT,
   registry_path: PCUNICODE_STRING,
) -&gt; NTSTATUS {
   0
}"><pre><span>use</span> wdk_sys<span>::</span><span>{</span>
   <span>DRIVER_OBJECT</span><span>,</span>
   <span>NTSTATUS</span><span>,</span>
   <span>PCUNICODE_STRING</span><span>,</span>
<span>}</span><span>;</span>

<span>#<span>[</span>export_name = <span>&#34;DriverEntry&#34;</span><span>]</span></span> <span>// WDF expects a symbol with the name DriverEntry</span>
<span>pub</span> <span>unsafe</span> <span>extern</span> <span>&#34;system&#34;</span> <span>fn</span> <span>driver_entry</span><span>(</span>
   <span>driver</span><span>:</span> <span>&amp;</span><span>mut</span> <span>DRIVER_OBJECT</span><span>,</span>
   <span>registry_path</span><span>:</span> <span>PCUNICODE_STRING</span><span>,</span>
<span>)</span> -&gt; <span>NTSTATUS</span> <span>{</span>
   <span>0</span>
<span>}</span></pre></div>
</li>
<li>
<p dir="auto">Add a <code>Makefile.toml</code>:</p>
</li>
</ol>
<div dir="auto" data-snippet-clipboard-copy-content="extend = &#34;.cargo-make-loadscripts/rust-driver-makefile.toml&#34;

[env]
CARGO_MAKE_EXTEND_WORKSPACE_MAKEFILE = true

[config]
load_script = &#34;&#34;&#34;
pwsh.exe -Command &#34;\
if ($env:CARGO_MAKE_CRATE_IS_WORKSPACE) { return };\
$cargoMakeURI = &#39;https://raw.githubusercontent.com/microsoft/windows-drivers-rs/main/rust-driver-makefile.toml&#39;;\
New-Item -ItemType Directory .cargo-make-loadscripts -Force;\
Invoke-RestMethod -Method GET -Uri $CargoMakeURI -OutFile $env:CARGO_MAKE_WORKSPACE_WORKING_DIRECTORY/.cargo-make-loadscripts/rust-driver-makefile.toml\
&#34;
&#34;&#34;&#34;"><pre><span>extend</span> = <span><span>&#34;</span>.cargo-make-loadscripts/rust-driver-makefile.toml<span>&#34;</span></span>

[<span>env</span>]
<span>CARGO_MAKE_EXTEND_WORKSPACE_MAKEFILE</span> = <span>true</span>

[<span>config</span>]
<span>load_script</span> = <span><span>&#34;&#34;&#34;</span></span>
<span>pwsh.exe -Command &#34;\</span>
<span>if ($env:CARGO_MAKE_CRATE_IS_WORKSPACE) { return };\</span>
<span>$cargoMakeURI = &#39;https://raw.githubusercontent.com/microsoft/windows-drivers-rs/main/rust-driver-makefile.toml&#39;;\</span>
<span>New-Item -ItemType Directory .cargo-make-loadscripts -Force;\</span>
<span>Invoke-RestMethod -Method GET -Uri $CargoMakeURI -OutFile $env:CARGO_MAKE_WORKSPACE_WORKING_DIRECTORY/.cargo-make-loadscripts/rust-driver-makefile.toml\</span>
<span>&#34;</span>
<span><span>&#34;&#34;&#34;</span></span></pre></div>
<ol start="11" dir="auto">
<li>
<p dir="auto">Add an inx file that matches the name of your <code>cdylib</code> crate.</p>
</li>
<li>
<p dir="auto">Build the driver:</p>
</li>
</ol>

<p dir="auto">A <code>DriverCertificate.cer</code> file will be generated, and a signed driver package will be available at <code>target/&lt;Cargo profile&gt;/package</code></p>
<h2 tabindex="-1" id="user-content-trademark-notice" dir="auto"><a href="#trademark-notice">Trademark Notice<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">Trademarks This project may contain trademarks or logos for projects, products, or services. Authorized use of Microsoft trademarks or logos is subject to and must follow Microsoft’s Trademark &amp; Brand Guidelines. Use of Microsoft trademarks or logos in modified versions of this project must not cause confusion or imply Microsoft sponsorship. Any use of third-party trademarks or logos are subject to those third-party’s policies.</p>
</article>
          </div></div>
  </body>
</html>
