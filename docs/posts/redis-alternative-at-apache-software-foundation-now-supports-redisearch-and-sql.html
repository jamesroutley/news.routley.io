<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kvrocks.apache.org/blog/kqir-query-engine/">Original</a>
    <h1>Redis Alternative at Apache Software Foundation Now Supports RediSearch and SQL</h1>
    
    <div id="readability-page-1" class="page"><div id="post-content" itemprop="articleBody"><h2 id="intro">Intro<a href="#intro" aria-label="Direct link to Intro" title="Direct link to Intro">​</a></h2><p>TL;DR:</p><p><img loading="lazy" alt="demo" src="https://kvrocks.apache.org/assets/images/demo-bf51c4ef55445434fbb4aaef6157ec67.png" width="3116" height="2596"/></p><p>Pretty cool, right? Let&#39;s dive in!</p><p>(The full example is provided in <a href="https://kvrocks.apache.org/blog/kqir-query-engine/#try-it">the final section</a>.)</p><h3 id="apache-kvrocks">Apache Kvrocks<a href="#apache-kvrocks" aria-label="Direct link to Apache Kvrocks" title="Direct link to Apache Kvrocks">​</a></h3><p><a href="https://kvrocks.apache.org/" target="_blank" rel="noopener noreferrer">Apache Kvrocks</a> is a <a href="https://redis.io/" target="_blank" rel="noopener noreferrer">Redis</a>-compatible database built on <a href="https://rocksdb.org/" target="_blank" rel="noopener noreferrer">RocksDB</a>.</p><p>It supports <a href="https://redis.io/docs/latest/develop/reference/protocol-spec/" target="_blank" rel="noopener noreferrer">the RESP protocol</a> (version 2 and 3) and <a href="https://kvrocks.apache.org/docs/supported-commands">a wide range of Redis commands</a>, encompassing core data structures like Strings, Sets, Hashes, Sorted Sets, Stream, GEO, as well as Lua Scripts, Transactions, <a href="https://redis.io/docs/latest/develop/interact/programmability/functions-intro/" target="_blank" rel="noopener noreferrer">Functions</a> and even <a href="https://redis.io/docs/latest/develop/data-types/probabilistic/bloom-filter/" target="_blank" rel="noopener noreferrer">BloomFilter</a>, <a href="https://redis.io/docs/latest/develop/data-types/json/" target="_blank" rel="noopener noreferrer">JSON</a> from the Redis Stack.</p><p>Unlike Redis which stores data in memory, Kvrocks persists data on disk for improved storage capabilities without being constrained by machine memory limit.</p><h3 id="the-capability-to-query">The capability to query<a href="#the-capability-to-query" aria-label="Direct link to The capability to query" title="Direct link to The capability to query">​</a></h3><p>In recent years, NoSQL databases have become more popular than traditional databases because they perform better, scale easily, and are more flexible for different industries.</p><p>However, many users are unwilling to abandon the essential features of SQL databases just for performance reasons.
These include ACID transactions, expressive query capabilities inherent in SQL, as well as optimization and abstraction possibilities offered by structured data and relational algebra.
Consequently, a new category of databases known as NewSQL has emerged gradually.</p><p>Kvrocks is a NoSQL database.
While not classified as NewSQL, Kvrocks aims to strike a balance between NoSQL and NewSQL paradigms:
It aims to maintain the high performance of NoSQL while also implementing transaction guarantees and supporting more complex queries.</p><h3 id="redisearch">RediSearch?<a href="#redisearch" aria-label="Direct link to RediSearch?" title="Direct link to RediSearch?">​</a></h3><p><a href="https://github.com/RediSearch/RediSearch" target="_blank" rel="noopener noreferrer">RediSearch</a> is a Redis module that enhances Redis with query, secondary indexing, and full-text search functionalities.
While <a href="https://redis.io/docs/latest/operate/oss_and_stack/stack-with-enterprise/search/commands/" target="_blank" rel="noopener noreferrer">its Redis commands</a> begin with <code>FT.</code> (i.e. full text), it goes beyond just full-text search.</p><p>In fact, it is Redis moving closer to SQL databases:
RediSearch enables users to create structured schemas on existing Redis JSON or HASH data for index building.
Its schema supports <a href="https://redis.io/docs/latest/develop/interact/search-and-query/basic-constructs/field-and-type-options/" target="_blank" rel="noopener noreferrer">various field types</a> such as numeric, tag, geo, text, and vector - the latter two are utilized for full-text and vector searches.
Instead of SQL support, RediSearch provides <a href="https://redis.io/docs/latest/develop/interact/search-and-query/advanced-concepts/query_syntax/" target="_blank" rel="noopener noreferrer">a unique query syntax</a> known as the RediSearch query language.</p><p>RediSearch finds applications in various fields.
One recent application involves utilizing its vector search feature to develop retrieval-augmented generation (RAG). For instance, <a href="https://www.langchain.com/" target="_blank" rel="noopener noreferrer">LangChain</a> utilizes Redis as one of its vector database.
If Kvrocks can be compatible with RediSearch, it could benefit from these ecosystem from RediSearch.</p><h3 id="sql">SQL?<a href="#sql" aria-label="Direct link to SQL?" title="Direct link to SQL?">​</a></h3><p>RediSearch uses a unique syntax for queries, but there are some issues to consider:</p><p>Firstly, RediSearch&#39;s schema (a.k.a. index, created with <code>FT.CREATE</code>) can be regarded as a table in an SQL database. Its query syntax also aligns semantically with SQL queries.
Given this similarity, supporting SQL should not increase significant challenges; why not include SQL support as well?</p><p>Secondly, SQL enjoys broader usage and is familiar to more individuals. It is simpler to learn at the syntax level. While developers may need time to understand RediSearch query syntax, adapting to a new SQL database often requires less effort. Furthermore, SQL offers robust support for various query features, enhanced expressive capabilities (like JOINs, subqueries, aggregations).</p><p>Finally, RediSearch query syntax suffers from some historical designs. For example, the operator precedence of AND and OR (represented by space and <code>|</code> operator in RediSearch queries) <a href="https://redis.io/docs/latest/develop/interact/search-and-query/advanced-concepts/query_syntax/#basic-syntax" target="_blank" rel="noopener noreferrer">varies across different dialect versions</a> (dialect 1 vs. dialect 2). This tribal knowledge might lead users to prefer established query languages.</p><p>To sum up, we believe that supporting SQL as a querying language would be a good decision.</p><h2 id="how-we-support-both">How we support both?<a href="#how-we-support-both" aria-label="Direct link to How we support both?" title="Direct link to How we support both?">​</a></h2><p><img loading="lazy" alt="KQIR" src="https://kvrocks.apache.org/assets/images/KQIR-8c913ba89d056b0cdd4f5234436a7a56.png" width="1530" height="1814"/></p><p>To introduce SQL capability to Kvrocks, we need to design a robust architecture with scalability, maintainability, and strong query planning and optimization features.</p><p>We plan to accomplish this through <a href="https://github.com/apache/kvrocks/tree/unstable/src/search" target="_blank" rel="noopener noreferrer">KQIR</a>. In the context of Kvrocks, KQIR stands for both:</p><ol><li>The complete query engine, covering frontend language parsing, query optimization and execution, etc.</li><li>An intermediate language (IR) that traverses the entire query engine.</li></ol><h3 id="kqir-a-multiple-level-ir">KQIR: a multiple-level IR<a href="#kqir-a-multiple-level-ir" aria-label="Direct link to KQIR: a multiple-level IR" title="Direct link to KQIR: a multiple-level IR">​</a></h3><p>To support both SQL and RediSearch queries, an intermediate language (IR) is necessary to handle them consistently in subsequent processes without concern for the user&#39;s input language.</p><p>We have developed parsers for a subset of MySQL syntax and RediSearch queries, converting the resulting syntax tree into KQIR.</p><p>And KQIR is a multi-level IR that can represent query structures at various levels during optimization.
The initial transformation from the syntax tree results in Syntactical IR, a high-level representation of certain syntactic expressions.
As it undergoes processing by an IR optimizer, KQIR evolves into Planning IR, a low-level representation used to express query execution plans within the query engine.</p><p>Additionally, we will conduct semantic checks on the IR before optimization to ensure that the query is semantically correct.
This includes verifying that it does not include any undefined schemas or fields and uses the appropriate field types.</p><h3 id="ir-optimizer">IR Optimizer<a href="#ir-optimizer" aria-label="Direct link to IR Optimizer" title="Direct link to IR Optimizer">​</a></h3><p>The KQIR optimizer consists of multiple passes, <a href="https://llvm.org/docs/Passes.html" target="_blank" rel="noopener noreferrer">a concept borrowed from LLVM</a>.
Each pass takes IR as input, conducts analysis and modifications, and generates a new IR.</p><p>Currently, the optimizer&#39;s passes are categorized into three main groups:</p><ul><li>expression passes for optimizing logical expressions like <code>AND</code>, <code>OR</code>, <code>NOT</code> operators;</li><li>numeric passes for optimizing numerical comparisons with an interval analysis (i.e. analyze the mathematical properties of numerical comparisons in terms of intervals) to enhance query optimization by eliminating unnecessary comparisons or improving comparison expressions;</li><li>planning passes for converting syntactical IR to planning IR and enhancing query plans through a cost model that selects optimal indexes and removes unnecessary sortings.</li></ul><p>Pass execution order is controlled by the pass manager.
A pass may run multiple times at different stages to simplify individual passes by combining them.</p><h3 id="plan-executor">Plan Executor<a href="#plan-executor" aria-label="Direct link to Plan Executor" title="Direct link to Plan Executor">​</a></h3><p>The KQIR plan executor is built on the Volcano model.</p><p>Once the IR optimizer finishes all optimizations, the resulting IR becomes a planning IR. This will then be passed to the plan executor to create execution logic based on certain context corresponding to the plan operator.</p><p>Subsequently, Kvrocks retrieves query results through iterative execution.</p><h3 id="on-disk-indexing">On-disk indexing<a href="#on-disk-indexing" aria-label="Direct link to On-disk indexing" title="Direct link to On-disk indexing">​</a></h3><p>Unlike Redis, which stores index data in memory, Kvrocks requires the construction of indexes on the disk.
This means that for any field type (e.g. tag, numeric), we need an encoding to reduce such index to RocksDB&#39;s key-values.</p><p>Furthermore, we incrementally create indexes before and after JSON or HASH commands getting executed to guarantee that query results are in real-time.</p><h2 id="current-status">Current status<a href="#current-status" aria-label="Direct link to Current status" title="Direct link to Current status">​</a></h2><p>The KQIR functionality is currently available on the <code>unstable</code> branch, supporting commands like <code>FT.CREATE</code>, <code>FT.SEARCH</code>, and <code>FT.SEARCHSQL</code> (an extension for running SQL queries) to encourage user to test.</p><p>However, as KQIR is still in early development, compatibility cannot be guaranteed and many features remain incomplete.
Thus the upcoming release (version 2.9.0) will not include any KQIR component.</p><h3 id="supported-field-types">Supported field types<a href="#supported-field-types" aria-label="Direct link to Supported field types" title="Direct link to Supported field types">​</a></h3><p>Currently, we only support two field types: tag and numeric.</p><p>Tag fields label each data record with multiple tags for filtering in queries.
And numeric fields hold numerical data within double-precision floating-point ranges. They allow sorting and filtering by specific numerical ranges.</p><p>In the future, we plan to expand support to include vector search and full-text search capabilities alongside other field types.</p><h3 id="transaction-guarantees">Transaction guarantees<a href="#transaction-guarantees" aria-label="Direct link to Transaction guarantees" title="Direct link to Transaction guarantees">​</a></h3><p>Currently, the transaction guarantee of KQIR is weak, which may lead to unexpected issues during use.</p><p><a href="https://github.com/apache/kvrocks/issues/2331" target="_blank" rel="noopener noreferrer">Another project in the Kvrocks community</a> aims to enhance Kvrocks&#39; transaction support by establishing a structured framework.
We will leverage these efforts to uphold the ACID properties of KQIR and release an official version incorporating KQIR after that.</p><h3 id="limitation-on-ir-optimizer">Limitation on IR optimizer<a href="#limitation-on-ir-optimizer" aria-label="Direct link to Limitation on IR optimizer" title="Direct link to Limitation on IR optimizer">​</a></h3><p>Currently, KQIR does not use the cost model when optimizing record sorting.
Instead, it relies on specialized logic. This could be an area for improvement soon.</p><p>Furthermore, KQIR does not currently utilize optimizations based on runtime statistics.
Our future focus will be on integrating runtime statistics into the cost model for more precise index selection.</p><h3 id="relationship-with-other-features">Relationship with other features<a href="#relationship-with-other-features" aria-label="Direct link to Relationship with other features" title="Direct link to Relationship with other features">​</a></h3><p>KQIR integrates well with the <a href="https://kvrocks.apache.org/docs/namespace" target="_blank" rel="noopener noreferrer">namespace</a> feature.
Any index created is restricted to the current namespace and cannot be accessed in other namespaces, aligning with how other data is accessed within the namespace.</p><p>Currently, KQIR cannot be enabled in the <a href="https://kvrocks.apache.org/docs/cluster" target="_blank" rel="noopener noreferrer">cluster mode</a>.
Cluster mode support may not be implemented in the short term, but we encourage anyone to submit discussions, design proposals, or suggestions.</p><h3 id="compliance">Compliance<a href="#compliance" aria-label="Direct link to Compliance" title="Direct link to Compliance">​</a></h3><p>While KQIR is designed to be compatible with RediSearch at the interface level, it does not include any code from RediSearch.
As previously mentioned, KQIR features a completely new framework, and its query architecture (including parsing, optimization, execution) is independent of RediSearch.</p><p>This distinction is important due to the proprietary license under which RediSearch is released.</p><h3 id="high-experimental">High experimental!<a href="#high-experimental" aria-label="Direct link to High experimental!" title="Direct link to High experimental!">​</a></h3><p>The current implementation of KQIR is in its early experimental stage.
We advise users to consider carefully when using KQIR functionalities in a production environment, as we do not guarantee compatibility, and there may be unexpected errors.</p><h2 id="future-outlook">Future outlook<a href="#future-outlook" aria-label="Direct link to Future outlook" title="Direct link to Future outlook">​</a></h2><p>KQIR is currently in development, and all mentioned aspects will continue to evolve.
If you&#39;re interested, please stay updated on the progress.</p><p>Developers keen on KQIR are encouraged to get involved in the development process and join the Apache Kvrocks community.</p><p>Note that our community consists entirely of volunteers.
As an ASF community, we strive to offer an open, inclusive, and vendor-neutral environment.</p><h3 id="vector-search">Vector search<a href="#vector-search" aria-label="Direct link to Vector search" title="Direct link to Vector search">​</a></h3><p>The design and implementation of vector search support are currently underway, which is very exciting.</p><p>In the Kvrocks community, some members have raised discussions and <a href="https://github.com/apache/kvrocks/discussions/2316" target="_blank" rel="noopener noreferrer">proposed an encoding design</a> for implementing vector search on KQIR.</p><p>As per the plan, we will initially implement an on-disk HNSW index and introduce the vector field type.</p><h3 id="full-text-search">Full-text search<a href="#full-text-search" aria-label="Direct link to Full-text search" title="Direct link to Full-text search">​</a></h3><p>There is currently no design proposal for full-text search.</p><p>However, community members are exploring the potential of incorporating full-text indexing in KQIR via <a href="https://clucene.sourceforge.net/" target="_blank" rel="noopener noreferrer">CLucene</a> or <a href="https://github.com/pisa-engine/pisa" target="_blank" rel="noopener noreferrer">PISA</a>.</p><p>We encourage anyone interested to share their ideas or suggestions and get involved in the development and implementation.</p><h3 id="more-sql-features">More SQL features<a href="#more-sql-features" aria-label="Direct link to More SQL features" title="Direct link to More SQL features">​</a></h3><p>In the future, we aim to progressively broaden our support for SQL features, potentially encompassing subqueries (including common table expressions), JOIN operations, aggregation functions, and other functionalities.</p><p>Our primary focus will remain on transaction processing rather than analytical tasks.</p><h2 id="try-it">Try it!<a href="#try-it" aria-label="Direct link to Try it!" title="Direct link to Try it!">​</a></h2><p>First, we can easily set up a Kvrocks instance via Docker images.
You also have the choice to <a href="https://kvrocks.apache.org/docs/getting-started#build-and-run-kvrocks-from-source">manually build executable from the source code</a> in the <code>unstable</code> branch.</p><div><div><pre tabindex="0"><code><span><span>docker</span><span> run -it -p </span><span>6666</span><span>:6666 apache/kvrocks:nightly --log-dir stdout</span><br/></span></code></pre></div></div><p>Then, we can connect to kvrocks locally using <code>redis-cli</code>,
and create an index named <code>testidx</code> consisting a tag field <code>a</code> and numeric field <code>b</code> with the following command:</p><div><div><pre tabindex="0"><code><span><span>FT</span><span>.</span><span>CREATE</span><span> testidx </span><span>ON</span><span> </span><span>JSON</span><span> </span><span>PREFIX</span><span> </span><span>1</span><span> </span><span>&#39;test:&#39;</span><span> </span><span>SCHEMA</span><span> a </span><span>TAG</span><span> b </span><span>NUMERIC</span><br/></span></code></pre></div></div><p>Next, we can add some new data using Redis JSON commands:
(Note that it is also possible to add data before running <code>FT.CREATE</code>.)</p><div><div><pre tabindex="0"><code><span><span>JSON</span><span>.</span><span>SET</span><span> </span><span>test</span><span>:</span><span>k1 $ </span><span>&#39;{&#34;a&#34;: &#34;x,y&#34;, &#34;b&#34;: 11}&#39;</span><span></span><br/></span><span><span></span><span>JSON</span><span>.</span><span>SET</span><span> </span><span>test</span><span>:</span><span>k2 $ </span><span>&#39;{&#34;a&#34;: &#34;y,z&#34;, &#34;b&#34;: 22}&#39;</span><span></span><br/></span><span><span></span><span>JSON</span><span>.</span><span>SET</span><span> </span><span>test</span><span>:</span><span>k3 $ </span><span>&#39;{&#34;a&#34;: &#34;x,z&#34;, &#34;b&#34;: 33}&#39;</span><br/></span></code></pre></div></div><p>Finally, we can execute some SQL queries to get the desired results:</p><div><div><pre tabindex="0"><code><span><span>FT</span><span>.</span><span>SEARCHSQL</span><span> </span><span>&#39;select * from testidx where a hastag &#34;z&#34; and b &lt; 30&#39;</span><br/></span></code></pre></div></div><p>Or an equivalent RediSearch query:</p><div><div><pre tabindex="0"><code><span><span>FT</span><span>.</span><span>SEARCH</span><span> testidx </span><span>&#39;@a:{z} @b:[-inf (30]&#39;</span><br/></span></code></pre></div></div><p>If you experience any issues with KQIR, please feel free to <a href="https://github.com/apache/kvrocks/issues" target="_blank" rel="noopener noreferrer">report them</a>.</p><p>Enjoy it!</p></div></div>
  </body>
</html>
