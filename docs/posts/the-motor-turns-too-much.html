<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.projectgus.com/2024/01/kona-motor-turns/">Original</a>
    <h1>The motor turns too much</h1>
    
    <div id="readability-page-1" class="page"><div id="main">
<section id="primary">
<main id="content" role="main">
<nav id="nav-above">



</nav><!-- #nav-above -->
<article id="kona-motor-turns" itemref="site-publisher">
<!-- .entry-header -->
<div itemprop="description articleBody">

<p>(Posting this one a while after it happened, due to holidays.)</p>
<p>This instalment is about the &#34;Bench Kona&#34; I&#39;ve built in the shed. Behold its questionable integrity:</p>
<p><a href="https://www.projectgus.com/images/2024-01/bench-kona.webp"><img alt="Mess of Kona components and wires on a bench" src="https://www.projectgus.com/images/2024-01/derivatives/article/1x/bench-kona.webp" srcset="https://www.projectgus.com/images/2024-01/derivatives/article/1x/bench-kona.webp 1x, https://www.projectgus.com/images/2024-01/derivatives/article/2x/bench-kona.webp 2x, https://www.projectgus.com/images/2024-01/derivatives/article/4x/bench-kona.webp 4x"/></a></p>
<p><a href="https://www.projectgus.com/images/2024-01/bench-kona-2.webp"><img alt="Different angle, can also see the motor and the battery" src="https://www.projectgus.com/images/2024-01/derivatives/article/1x/bench-kona-2.webp" srcset="https://www.projectgus.com/images/2024-01/derivatives/article/1x/bench-kona-2.webp 1x, https://www.projectgus.com/images/2024-01/derivatives/article/2x/bench-kona-2.webp 2x, https://www.projectgus.com/images/2024-01/derivatives/article/4x/bench-kona-2.webp 4x"/></a></p>
<p>You can see the motor and drive unit stack in the foreground, and the battery pack in the background under some junk. These are all the same part assemblies that came out of the crashed Kona, with their original wiring. All of the high voltage connections are exactly the same as in the car, including interlocks and seals.</p>
<p>The bench holds other modules taken from the engine bay and the interior of the car, plus large segments of the original wiring (now unwrapped, cut, spliced, and converted into a tangled mess).</p>
<p>The green wooden bench was &#34;obtainium&#34; that my mate Oli donated. It&#39;s far from perfect, but it has the very attractive property that we can cut it, screw into it, and generally mess with it as much as we want.</p>
<h2 id="why-would-you-do-this">Why would you do this?</h2>
<p>Like every modern car, the Hyundai Kona Electric is absurdly complicated. More than five separate CAN buses, ten or more kilograms of low voltage wiring, probably over one hundred electronic modules (most with their own CPU and firmware), etc.</p>
<p>In order to re-purpose the Kona&#39;s powertrain into an EV conversion, we need to find the simplest subset of modules that can work together.</p>
<p>Hence, a reverse engineering experiment: the Bench Kona.</p>
<h2 id="plan">Plan</h2>
<p>The rough plan has been:</p>
<ol>
<li>Wire together modules on the bench until the motor turns, and the traction battery can be charged.</li>
<li>Progressively remove modules, replacing them with fake CAN messages or other signals. The goal is to find the minimum that will still work.</li>
<li>Document this, and design some kind of &#34;Kona meta-VCU&#34; that allows the Kona&#39;s VCU (Vehicle Control Unit) to drive the motor in an EV conversion.</li>
<li>Celebrate wildly, should this step ever be reached.</li>
</ol>
<p>It&#39;s important to note that <em>absolutely none</em> of the techniques used to wire up the Bench Kona translate over to a real moving vehicle. This is strictly for reverse engineering purposes.</p>
<h2 id="looming">Looming</h2>
<p>I was able to drape most of the engine bay wiring loom and some of the cabin loom over the bench. The strategy was to find particular wires in the inter-loom connectors and cut them out when needed. Hopefully, once everything works then it&#39;ll be straightforward to remove what&#39;s left and dramatically reduce the rats nest qualities of this setup:</p>
<p><a href="https://www.projectgus.com/images/2024-01/rats-nest.webp"><img alt="Different angle of the bench showing even more wires" src="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/rats-nest.webp" srcset="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/rats-nest.webp 1x, https://www.projectgus.com/images/2024-01/derivatives/medium/2x/rats-nest.webp 2x, https://www.projectgus.com/images/2024-01/derivatives/medium/4x/rats-nest.webp 4x"/></a></p>
<p>A special mention for these lever-action wire connectors:</p>
<p><a href="https://www.projectgus.com/images/2024-01/wire-connector.webp"><img alt="A four wire lever-action wire connector on the bench" src="https://www.projectgus.com/images/2024-01/derivatives/small/1x/wire-connector.webp" srcset="https://www.projectgus.com/images/2024-01/derivatives/small/1x/wire-connector.webp 1x, https://www.projectgus.com/images/2024-01/derivatives/small/2x/wire-connector.webp 2x, https://www.projectgus.com/images/2024-01/derivatives/small/4x/wire-connector.webp 4x"/></a></p>
<p>They&#39;re very easy to connect and disconnect, and so far they&#39;ve been reliable.<sup id="fnref:bench"><a href="#fn:bench">1</a></sup> These ones are <a href="https://detail.tmall.com/item.htm?id=662737832381">from Taobao</a>, but <a href="https://www.aliexpress.com/item/1005006123575098.html">looks like they&#39;re also on Aliexpress</a>.</p>
<p>Elsewhere crimp ferrules and screw terminals were used, instead. The label maker came in particularly handy!</p>
<h2 id="gateway-antics">Gateway Antics</h2>
<p>Hoping that the Kona had been engineered in a modular fashion, I was counting on finding some integration points that could be &#34;sliced&#34; apart without too much impact. This turned out to be partly true, although the <a href="https://www.joelonsoftware.com/2002/11/11/the-law-of-leaky-abstractions/">Law of Leaky Abstractions</a> seems to also apply to cars.</p>
<p>The first module to eliminate was the Integrated Gateway and Power Module (IGPM):</p>
<p><a href="https://www.projectgus.com/images/2024-01/igpm.webp"><img alt="Integrated Gateway Power Module" src="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/igpm.webp" srcset="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/igpm.webp 1x, https://www.projectgus.com/images/2024-01/derivatives/medium/2x/igpm.webp 2x, https://www.projectgus.com/images/2024-01/derivatives/medium/4x/igpm.webp 4x"/></a></p>
<p>You may remember this module from <a href="https://www.projectgus.com/2023/03/ev-conversion-one/#finding-a-way-in">Part One</a>, when one of its connectors was accidentally damaged by forward probing...</p>
<p>Bench Kona has to to replicate at least two functions of the IGPM:</p>
<ol>
<li>Switching power to some modules, especially &#34;IG3&#34; which seems to be the power when the car is &#34;half turned on&#34; (for example, when charging).</li>
<li>Injecting some of the CAN messages that the IGPM forwards between the different buses.</li>
</ol>
<p>Switching power turned out to be pretty straightforward. Bench Kona has kept the original engine bay relay box for now. It still provides the main relays, large fuses, and the heavy-duty wiring for the DC/DC Converter and the 12V battery:</p>
<p><a href="https://www.projectgus.com/images/2024-01/engine-bay-fuse-box.webp"><img alt="Close up on Kona engine bay fuse box" src="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/engine-bay-fuse-box.webp" srcset="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/engine-bay-fuse-box.webp 1x, https://www.projectgus.com/images/2024-01/derivatives/medium/2x/engine-bay-fuse-box.webp 2x, https://www.projectgus.com/images/2024-01/derivatives/medium/4x/engine-bay-fuse-box.webp 4x"/></a></p>
<p>A lot of power supply wiring comes out of this box, goes into the IGPM where it&#39;s split up into different power domains and individually fused. Then some of these individual power wires come back through the engine bay fuse box. To replace individual IGPM circuits and fuses, Bench Kona has a simple automotive fuse box:</p>
<p><a href="https://www.projectgus.com/images/2024-01/fuse-box.webp"><img alt="Close up on automotive fuse box on bench" src="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/fuse-box.webp" srcset="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/fuse-box.webp 1x, https://www.projectgus.com/images/2024-01/derivatives/medium/2x/fuse-box.webp 2x, https://www.projectgus.com/images/2024-01/derivatives/medium/4x/fuse-box.webp 4x"/></a></p>
<p>The &#34;IG3&#34; power supply that&#39;s normally switched inside the IGPM by firmware has been replaced by... a switch!</p>
<p><a href="https://www.projectgus.com/images/2024-01/ig3-switch.webp"><img alt="IG3 relay switch on bench" src="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/ig3-switch.webp" srcset="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/ig3-switch.webp 1x, https://www.projectgus.com/images/2024-01/derivatives/medium/2x/ig3-switch.webp 2x, https://www.projectgus.com/images/2024-01/derivatives/medium/4x/ig3-switch.webp 4x"/></a></p>
<h2 id="brakes">Brakes</h2>
<p><a href="https://www.projectgus.com/images/2024-01/ieb.webp"><img alt="Integrated Electronic Brake module, as installed in Kona" src="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/ieb.webp" srcset="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/ieb.webp 1x, https://www.projectgus.com/images/2024-01/derivatives/medium/2x/ieb.webp 2x, https://www.projectgus.com/images/2024-01/derivatives/medium/4x/ieb.webp 4x"/></a></p>
<p>I also wanted to leave out the &#34;Integrated Electronic Brake&#34; (IEB) module, if possible. This electric brake booster module incorporates ABS and traction control. This means it relies on input from wheel sensors, among other things.</p>
<p>From <a href="https://www.projectgus.com/2023/10/kona-can-decoding/">CAN log analysis</a> it seemed likely that we could spoof the messages from this module, instead.</p>
<p>The Kona also has a redundant hard-wired brake signal, which connects the brake pedal to both the Vehicle Control Unit (VCU, part of the EPCU) and the Smart Key Module (SKM, for &#34;press brake before starting&#34;). The VCU also independently reads the inverse of this signal on a second wire.</p>
<p>Initially a simple switch was used for this, but it turned out to be easier to mount the brake pedal itself, at least for the first version:</p>
<p><a href="https://www.projectgus.com/images/2024-01/brake-pedal.webp"><img alt="Brake pedal mounted upside down to side of bench" src="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/brake-pedal.webp" srcset="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/brake-pedal.webp 1x, https://www.projectgus.com/images/2024-01/derivatives/medium/2x/brake-pedal.webp 2x, https://www.projectgus.com/images/2024-01/derivatives/medium/4x/brake-pedal.webp 4x"/></a></p>
<p>Removing the return spring and mounting it like this means it can be pushed back and forward like a lever. Odd, but functional!</p>
<p>The laptop would run a <code>bench_kona.py</code> program that injected the spoofed IEB CAN messages to the bus, with payloads corresponding to the vehicle sitting still with someone&#39;s foot on the brake. This seemed safe enough to me at the time.</p>
<p><em>Narrator: As we shall see, this was not quite safe enough.</em></p>
<h2 id="smart-key-module">Smart Key Module</h2>
<p><a href="https://www.projectgus.com/images/2024-01/skm.webp"><img alt="My Kona&#39;s Smart Key Module" src="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/skm.webp" srcset="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/skm.webp 1x, https://www.projectgus.com/images/2024-01/derivatives/medium/2x/skm.webp 2x, https://www.projectgus.com/images/2024-01/derivatives/medium/4x/skm.webp 4x"/></a></p>
<p>The Smart Key Module was shaping up to be the trickiest module. It contains a lot of logic around the various keyless entry features and door locks, and switches on the main ignition &#34;IG1&#34; and &#34;IG2&#34; power relays. The Bench Kona only needs a few of these functions, so maybe the SKM could be replaced with some switches for now?</p>
<p>Unfortunately, the SKM also has three hard-wired connections to the VCU:</p>
<ul>
<li>&#34;P_STS PWM&#34;, not sure what this is.</li>
<li>&#34;EV Ready Backup&#34; signal.</li>
<li>&#34;IMMO Signal&#34;, assumed to be the vehicle immobiliser signal.</li>
</ul>
<p>Until/unless these can be spoofed, the Smart Key Module needs to behave as if it is operating normally in a real Kona. This means wiring in all of its various power connections, relay outputs, the car&#39;s &#34;push to start&#34; power button, and even some of the antennas:</p>
<p><a href="https://www.projectgus.com/images/2024-01/skm-wiring.webp"><img alt="Smart Key Module wiring" src="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/skm-wiring.webp" srcset="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/skm-wiring.webp 1x, https://www.projectgus.com/images/2024-01/derivatives/medium/2x/skm-wiring.webp 2x, https://www.projectgus.com/images/2024-01/derivatives/medium/4x/skm-wiring.webp 4x"/></a></p>
<p>Plus the <code>bench_kona.py</code> program had to be augmented to send some spoofed BCAN (Body CAN bus) messages to the Smart Key Module&#39;s BCAN transceiver, so it thinks that the doors are closed, etc.</p>
<h2 id="and-nothing-happens">And... nothing happens!</h2>
<p>After triple checking all my custom wiring, it was time to attach the 12V Battery and manully switch on &#34;IG3&#34; to start powering up. Various CAN messages appeared on the bus, a few relays clicked in, and... nothing else happend.</p>
<p>The power button, attached directly to the Smart Key module, mostly sat silent but occasionally flashed through five mysterious amber blinks:</p>
<p><img alt="GIF of the power button blinking" src="https://www.projectgus.com/images/2024-01/power-blink.gif"/></p>
<p>Attempting to pull diagnostic codes from any of the vehicle components failed, presumably because the &#34;car&#34; was powered off. This left me back at the same awkward spot as last year with the <a href="https://www.projectgus.com/2022/06/bmw-f-series-gear-selector-part-one-failures/">BMW gear selector</a> - a complex electronic system sitting there silent and inscrutable.</p>
<h2 id="rtfm">RTFM</h2>
<p>After trying a lot of things that didn&#39;t work, I was reading Hyundai forums online discussing various &#34;won&#39;t power on&#34; issues and someone mentioned there was a failsafe &#34;limp home&#34; start method where you press the vehicle key into the power on button. Sure enough, it&#39;s right there in the Kona user manual:</p>
<p><a href="https://www.projectgus.com/images/2024-01/manual.webp"><img alt="Page from Kona manual showing how to emergency start with the vehicle key" src="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/manual.webp" srcset="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/manual.webp 1x, https://www.projectgus.com/images/2024-01/derivatives/medium/2x/manual.webp 2x, https://www.projectgus.com/images/2024-01/derivatives/medium/4x/manual.webp 4x"/></a></p>
<p>Pressing the key against the button, it would now replicate the &#34;five amber blinks&#34; sequence every time. Still, nothing else came to life...</p>
<h2 id="steering-wheel-lock">Steering Wheel Lock</h2>
<p>Going back to first principles, I started probing all of the inputs and outputs of the Smart Key Module to see if it did anything in particular when the button was pressed. It looks as if it very briefly tried to power up the Steering Wheel Lock module.</p>
<p>This module hadn&#39;t been wired in, on the assumption that the Smart Key Module would not consider it a fatal error if it was totally missing.</p>
<p>Turns out the steering wheel (complete with blown airbag) barely fits inside the bench:</p>
<p><a href="https://www.projectgus.com/images/2024-01/bench-steering.webp"><img alt="Steering wheel jammed inside bench" src="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/bench-steering.webp" srcset="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/bench-steering.webp 1x, https://www.projectgus.com/images/2024-01/derivatives/medium/2x/bench-steering.webp 2x, https://www.projectgus.com/images/2024-01/derivatives/medium/4x/bench-steering.webp 4x"/></a></p>
<p>After wiring the steering wheel lock&#39;s data and power lines<sup id="fnref:odd"><a href="#fn:odd">3</a></sup>, the car finally powered on:</p>
<p><a href="https://www.projectgus.com/images/2024-01/power-on.webp"><img alt="Kona power button illuminated in blue" src="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/power-on.webp" srcset="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/power-on.webp 1x, https://www.projectgus.com/images/2024-01/derivatives/medium/2x/power-on.webp 2x, https://www.projectgus.com/images/2024-01/derivatives/medium/4x/power-on.webp 4x"/></a></p>
<p>Such a glorious blue light! 🥳</p>
<p>I heard the tell-tale clunks of the main contactors closing in the traction battery pack, and the Bench Kona even went into Drive. However, the wheels wouldn&#39;t turn even with the brake pedal &#34;released&#34;.</p>
<p><a href="https://www.projectgus.com/images/2024-01/in-drive.webp"><img alt="Kona Gear selector with D illuminated" src="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/in-drive.webp" srcset="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/in-drive.webp 1x, https://www.projectgus.com/images/2024-01/derivatives/medium/2x/in-drive.webp 2x, https://www.projectgus.com/images/2024-01/derivatives/medium/4x/in-drive.webp 4x"/></a></p>
<p>The <code>bench_kona.py</code> program was spoofing CAN messages saying that someone was standing on the brake. Guessing that&#39;s why the motor doesn&#39;t turn...</p>
<h2 id="motion">Motion</h2>
<p>Next step, update the <code>bench_kona</code> software and add an input to turn the brake on and off. A very sophisticated user interface:</p>
<p><a href="https://www.projectgus.com/images/2024-01/bench-kona-ui.webp"><img alt="Bench Kona UI screenshot, just a checkbox for Braking" src="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/bench-kona-ui.webp" srcset="https://www.projectgus.com/images/2024-01/derivatives/medium/1x/bench-kona-ui.webp 1x, https://www.projectgus.com/images/2024-01/derivatives/medium/2x/bench-kona-ui.webp 2x, https://www.projectgus.com/images/2024-01/derivatives/medium/4x/bench-kona-ui.webp 4x"/></a></p>
<p>This is a bit clunky as there&#39;s a separate hard-wired brake pedal signal as well, but by this point the excitement of a possible breakthrough was making me impatient:</p>
<p>
<iframe allowfullscreen="" frameborder="0" seamless="" src="https://www.youtube.com/embed/Z4nDdb5fkbI"></iframe>
</p>
<p>Success? This is the motor in Drive steadily trying to &#34;creep&#34; forward,<sup id="fnref:creep"><a href="#fn:creep">2</a></sup> and also revving up once or twice due to a gentle accelerator press.</p>
<h2 id="too-much-motion">Too much motion</h2>
<p>So far the Bench Kona has been put into Drive three times. I only filmed one of the tests, but the other two ended with uncontrolled motor acceleration! 😱😱😱</p>
<p>Seemingly nothing would stop the motor - even switching to Neutral, putting the brake on (via both switch and CAN), or totally stopping all spoofed CAN messages. After twenty or seconds of the motor spinning flat out, the motor controller flagged a &#34;Motor Excess Current&#34; fault code and it came to a stop.</p>
<p>This was both unexpected and terrifying, and I realised how unprepared I&#39;d been for this eventuality.</p>
<p>I <em>think</em> what was happening is that the Vehicle Control Unit is running a control loop that outputs a motor torque request and reads wheel speed data as feedback. Because the <code>bench_kona.py</code> program was reporting fake 0 wheel speeds all round, the VCU&#39;s control loop assumed the torque it was requesting from the motor was either too low (when accelerating) or just fine (when not accelerating). So the controller only ever increased the torque request, or kept it at the same level. Even when I simulated pressing the brake it was like &#34;Nothing needs to change, we&#39;re not even moving!&#34;</p>
<p>Meanwhile, the electric motor controller (MCU) is receiving the torque requests and frantically trying to achieve the requested motor torque by revving the unloaded motor faster and faster. This is an impossible task as the motor is spinning unloaded, so torque is minimal.</p>
<p>This theory is a bit surprising, because you&#39;d think the VCU would have some failsafe where it also reads RPM from the motor controller (after all, what happens if a driveshaft breaks and the wheels aren&#39;t turning on the real car?) It&#39;s pure guesswork at this stage, maybe the real logic is very different.</p>
<hr/>
<p><em>Belated EDIT 2024-11: This post is suddenly getting a bunch of <a href="https://news.ycombinator.com/item?id=41970406">interest</a>, so I want to note that the <strong>above theory turned out to be mostly wrong</strong>. See the <a href="https://www.projectgus.com/2024/04/unremarkable/">follow-up post in this series</a> for more experiments.</em></p>
<p><em>I also want to clarify that &#34;uncontrolled acceleration&#34; in this context is for an unloaded motor on a bench, and not a real car. Lightly tapping the brake in a real car would immediately stop any similar runaway.</em></p>
<hr/>
<p>That said, the internet does contain some supporting material. For example, there is a <a href="https://patents.google.com/patent/US10421361B2/">Hyundai patent about motor control</a> that includes this signal diagram:</p>
<p><a href="https://www.projectgus.com/images/2023-12/patent_fig1.png"><img alt="Fig 1 from the linked patent" src="https://www.projectgus.com/images/2023-12/derivatives/medium/1x/patent_fig1.png" srcset="https://www.projectgus.com/images/2023-12/derivatives/medium/1x/patent_fig1.png 1x, https://www.projectgus.com/images/2023-12/derivatives/medium/2x/patent_fig1.png 2x, https://www.projectgus.com/images/2023-12/derivatives/medium/4x/patent_fig1.png 4x"/></a></p>
<p>(APS = Accelerator Position Sensor, BPS = Brake Position Sensor.)</p>
<p>If zero wheel speed is the culprit, then all that&#39;s needed for appropriate motor control is to send spoofed wheel speed data that matches the current motor rpm. I <em>think</em> we know where the motor rpm signal is found out in the CAN messages, but I want to do more logging on a real Kona to be 100% sure. I don&#39;t ever want to trigger that uncontrolled acceleration state again!</p>
<p>Not to mention that the Bench Kona now needs a few more features added, such as a rudimentary cooling system. It&#39;s also past time to write some microcontroller firmware, rather than little desktop Python programs.</p>
<p>After all this, it&#39;s also possible that the VCU&#39;s black box control logic turns out to be too complicated to adapt into a reliable EV conversion. In that case, adapting something like the <a href="https://openinverter.org/wiki/Mini_Mainboard">openinverter motor control board</a> to the Kona&#39;s existing IGBT drivers may be the best way to give these parts a second life. We&#39;ll see...</p>
<p>Stay tuned for the next update, hopefully soon!</p>

</div><!-- .entry-content -->
<!-- #entry-meta -->
</article>
<nav id="nav-below">



</nav><!-- #nav-below -->
 <!-- #comments -->
</main><!-- #content -->
</section><!-- #primary -->

</div></div>
  </body>
</html>
