<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://wasmlabs.dev/articles/hardening-drupal-with-webassembly/">Original</a>
    <h1>Hardening Drupal with WebAssembly</h1>
    
    <div id="readability-page-1" class="page"><div>

<p><a href="https://www.drupal.org/">Drupal</a> is one of the most popular Content Management Systems (CMS), powering well-known websites such as the <a href="https://european-union.europa.eu/index_en">European Union</a>, <a href="https://www.nasa.gov/">NASA</a> or <a href="http://www.tesla.com">Tesla</a>. Like any other complex software, vulnerabilities are discovered in Drupal or in the underlying PHP components over time, and in many cases, the necessary updates are not promptly implemented. In traditional stacks, where components have direct access to the underlaying operating system, certain vulnerabilities could be exploited to compromise the system.</p>
<p>This article explores how Drupal can benefit from the capabilities-based security model offered by <a href="https://webassembly.org/">WebAssembly</a>, a portable binary format that allows execution of code in a safe and efficient manner. By deploying Drupal within a WebAssembly-based stack, it gains an additional security layer, protecting against a wide range of vulnerabilities, including those that may not be public yet but can be preemptively mitigated through these mechanisms.</p>
<p>In addition, we provide a practical implementation of deploying Drupal in Apache with <a href="https://github.com/vmware-labs/mod_wasm">mod_wasm</a>, showcasing the seamless integration of the <a href="https://github.com/vmware-labs/webassembly-language-runtimes/releases?q=php">WebAssembly build of PHP</a>. This novel stack not only improves Drupal&#39;s security measures, but also unlocks the ability for integration with other WebAssembly-powered components.</p>
<h2 id="tl%3Bdr%3A" tabindex="-1">TL;DR:</h2>
<p>Try out Drupal running into a WebAssembly environment:</p>
<pre><code><span>docker run -p 8080:8080 ghcr.io/vmware-labs/httpd-mod-wasm:latest</span></code></pre>
<p>Go to <a href="http://localhost:8080/drupal">http://localhost:8080/drupal</a></p>

<p><a href="https://webassembly.org/">WebAssembly</a> (Wasm for short) is an open, portable and efficient binary instruction format, supported by many <a href="https://www.fermyon.com/wasm-languages/webassembly-language-support">programming languages</a>. It follows a secure-by-design approach, implementing a deny-by-default security model that requires explicit authorization for accessing external resources like the file system. This inherent security makes WebAssembly an excellent choice for running untrusted code while ensuring the integrity of the main application and the underlying system.</p>
<p>All major browsers already provide built-in WebAssembly support. Additionally, it can be run on the server-side using a dedicated runtime. This versatility means WebAssembly can execute near-native performance code in a secure environment on both the web and the server. It also provides the ability to seamlessly interoperate binary modules written in different programming languages.</p>
<p>At <a href="https://wasmlabs.dev/">Wasm Labs</a>, we aim to enable the execution of traditional applications within a WebAssembly environment with little to no modifications. The goal is to bring the benefits of Wasm to as many developers as possible without a steep learning curve. This led us to develop <a href="https://github.com/vmware-labs/mod_wasm">mod_wasm</a>, an Apache server extension that allows Wasm binaries to handle HTTP requests. This extension facilitates such a handling in virtually any programming language with WebAssembly support.</p>
<p>With mod_wasm, the stack to run PHP applications like Drupal closely resembles a traditional stack with a few modifications. The Apache HTTP server and the Drupal packages remain unchanged. However, instead of loading the <code>libphp.so</code> extension module, it incorporates <code>mod_wasm.so</code>. In addition, instead of relying on the traditional PHP interpreter, it utilizes a PHP build in the WebAssembly binary format. For this purpose, we can utilize the binary provided by the <a href="https://github.com/vmware-labs/webassembly-language-runtimes">WebAssembly Languages Runtime</a> project. This <a href="https://github.com/vmware-labs/webassembly-language-runtimes/releases?q=php">pre-built binary</a> bundles all the necessary <a href="https://www.drupal.org/docs/getting-started/system-requirements/php-requirements">PHP requirements</a> for Drupal, including PDO, DOM, GD, and more. As of the time of writing, the latest PHP Wasm build available is <a href="https://github.com/vmware-labs/webassembly-language-runtimes/releases/download/php%2F8.2.0%2B20230418-d75a618/php-cgi-8.2.0.wasm">8.2.0</a>.</p>
<picture>
<source type="image/avif" srcset="/static/images/opt/MzFRLjxvfb-757.avif, /static/images/opt/MzFRLjxvfb-1514.avif 2x"/>
<source type="image/jpeg" srcset="/static/images/opt/MzFRLjxvfb-757.jpeg, /static/images/opt/MzFRLjxvfb-1514.jpeg 2x"/>
<source type="image/webp" srcset="/static/images/opt/MzFRLjxvfb-757.webp, /static/images/opt/MzFRLjxvfb-1514.webp 2x"/>
<img src="https://wasmlabs.dev/static/images/opt/MzFRLjxvfb-757.webp" width="1514" height="835" alt="Comparison of traditional vs. wasm-based stack" loading="lazy" decoding="async"/>
</picture>

<p>The quickest way to try by yourself the full WebAssembly-based stack (Apache + mod_wasm + PHP Wasm + Drupal) is checking out the <a href="https://github.com/vmware-labs/mod_wasm/pkgs/container/httpd-mod-wasm">Docker container</a> we prepared for demo purposes. It includes Drupal in different flavors among other <a href="https://github.com/vmware-labs/mod_wasm/tree/main/examples">examples</a>.</p>
<h2 id="pre-initialized-drupal-10-instance" tabindex="-1">Pre-initialized Drupal 10 instance</h2>
<p>This provided instance of Drupal 10 is pre-configured and pre-initialized with some initial content. This pre-initialized state allows for a quick demonstration of the fully functional Wasm stack and showcases how all Drupal&#39;s PHP dependencies are met and fully operational.</p>
<p>As usual, you can easily install new Drupal extensions and themes via <code>composer</code>, provided their required version dependencies are met.</p>
<p>To access the administrator account, simply log in with the credentials &#34;admin/admin&#34;.</p>
<p>URL: <a href="http://localhost:8080/drupal">http://localhost:8080/drupal</a></p>
<picture>
<source type="image/avif" srcset="/static/images/opt/sFHvdczafv-720.avif"/>
<source type="image/jpeg" srcset="/static/images/opt/sFHvdczafv-720.jpeg"/>
<source type="image/webp" srcset="/static/images/opt/sFHvdczafv-720.webp"/>
<img src="https://wasmlabs.dev/static/images/opt/sFHvdczafv-720.webp" width="720" height="460" alt="A pre-initialized Drupal instance" loading="lazy" decoding="async"/>
</picture>
<h2 id="drupal-10-from-scratch" tabindex="-1">Drupal 10 from Scratch</h2>
<p>This particular instance of Drupal is uninitialized, providing users with the opportunity to explore and test the Drupal setup process within the WebAssembly stack.</p>
<p>During the setup process, Drupal may issue warnings regarding disabled OPcode caching and limited date range. We will address these limitations later on, but for now, you can safely ignore them.</p>
<p>URL: <a href="http://localhost:8080/drupal-10-zero">http://localhost:8080/drupal-10-zero</a></p>
<picture>
<source type="image/avif" srcset="/static/images/opt/BmhUc_nHS6-720.avif"/>
<source type="image/jpeg" srcset="/static/images/opt/BmhUc_nHS6-720.jpeg"/>
<source type="image/webp" srcset="/static/images/opt/BmhUc_nHS6-720.webp"/>
<img src="https://wasmlabs.dev/static/images/opt/BmhUc_nHS6-720.webp" width="720" height="378" alt="A non-initialized Drupal instance" loading="lazy" decoding="async"/>
</picture>
<h2 id="custom-setup" tabindex="-1">Custom Setup</h2>
<p>To try the WebAssembly stack on your own setup, you will first need to download the mod_wasm extension and drop it into your Apache&#39;s modules directory.</p>
<ul>
<li>
<p>If you are running Apache on Linux, you can get the latest release directly from <a href="https://github.com/vmware-labs/mod_wasm/releases">GitHub</a>.</p>
</li>
<li>
<p>For Windows users, mod_wasm can be downloaded from <a href="https://www.apachelounge.com/download/">Apache Lounge</a>.</p>
</li>
<li>
<p>Alternatively, you have the option to compile it yourself by following the provided <a href="https://github.com/vmware-labs/mod_wasm#%EF%B8%8F-building-mod_wasm">build instructions</a>.</p>
</li>
</ul>
<p>Setting up Apache for mod_wasm and Drupal is a straightforward process. Simply update your Apache&#39;s <em>httpd.conf</em> configuration file by loading the <code>mod_wasm.so</code> extension module, specifying the path to the PHP Wasm binary, and configuring specific <a href="https://github.com/vmware-labs/mod_wasm#new-directives">directives</a> for PHP and Drupal.</p>
<pre><code><span>LoadModule</span> wasm_module modules/mod_wasm.so</code></pre>

<p>As we mentioned earlier, WebAssembly follows a deny-by-default strategy, limiting access to different system resources unless explicitly authorized. In the previous configuration example, directives like <code>WasmDir</code> or <code>WasmMapDir</code> exemplify this approach. By authorizing access only to <code>/var/www/drupal/</code> and mapping a virtual <code>/tmp</code> directory to <code>/var/www/drupal/tmp</code>, the PHP Wasm interpreter is restricted from accessing other directories. This setup applies specifically to <code>.php</code> resources within the <code>/drupal</code> location. A different configuration could be applied to different directories, providing a secure environment for multi-tenant deployments.</p>
<p>These additional protections provide an extra layer of security without relying solely on operating system-level permissions. They grant developers and sysadmins improved control over access permissions, reducing the attack surface and ensuring better isolation between unrelated modules.</p>
<p>WebAssembly has proven effective in mitigating various vulnerabilities, including those not yet public. Dive deeper into this topic with our article <a href="https://wasmlabs.dev/articles/mitigating-php-vulnerabilities-with-webassembly/">&#34;Mitigating PHP Vulnerabilities with WebAssembly&#34;</a> and discover the benefits of WebAssembly for enhancing PHP security.</p>

<p>Before deploying Drupal into a Wasm-based stack, it&#39;s important to be aware of certain limitations.</p>
<p>The primary limitation is the current lack of socket support in mod_wasm, which prevents PHP Wasm from accessing the network and using client-server databases like MySQL and PostgreSQL. All different instances in the demo container were configured to use SQLite which is embedded in the PHP Wasm build. This may be good enough for certain web sites, but it is not suitable for many others.</p>
<p>There are ongoing efforts to make socket support mainstream in WebAssembly. The <a href="https://github.com/WebAssembly/wasi-sockets">standardization</a> process is making good progress, including <a href="https://youtu.be/nOkzmOapiSY?t=2113">functional demos</a>. Some runtimes, such as <a href="https://github.com/second-state/wasmedge_wasi_socket">WasmEdge</a>, already offer socket support. In fact, we succesfully <a href="https://wasmlabs.dev/articles/wordpress-nginx-fcgi-mysql/">connected a WordPress instance to a MySQL database</a> using this specific runtime.</p>
<p>The absence of sockets also means that PHP in Wasm cannot perform outgoing HTTP requests for downloading Drupal extensions or checking for updates.</p>
<p>In addition, the current WebAssembly version 1.0 only supports 32-bit memory addresses. Consequently, PHP Wasm can only <a href="https://www.drupal.org/docs/system-requirements/limitations-of-32-bit-php">handle 32-bit integers</a>. Fortunately, the <a href="https://webassembly.github.io/spec/core/index.html">WebAssembly 2.0</a> draft includes a <a href="https://github.com/WebAssembly/memory64/blob/main/proposals/memory64/Overview.md">64-bit memory space</a>, addressing this limitation. Also, PHP&#39;s <a href="https://www.php.net/manual/en/book.opcache.php">Opcode caching</a> feature is disabled in PHP Wasm. Drupal promptly detects these limitations during the installation process.</p>
<picture>
<source type="image/avif" srcset="/static/images/opt/L5gXCrwIkJ-588.avif"/>
<source type="image/jpeg" srcset="/static/images/opt/L5gXCrwIkJ-588.jpeg"/>
<source type="image/webp" srcset="/static/images/opt/L5gXCrwIkJ-588.webp"/>
<img src="https://wasmlabs.dev/static/images/opt/L5gXCrwIkJ-588.webp" width="588" height="462" alt="PHP limitations identified by Drupal" loading="lazy" decoding="async"/>
</picture>

<p>We explored deploying Drupal within a WebAssembly-based stack. By adopting a capabilities-based security model and integrating Drupal with mod_wasm, you can mitigate certain vulnerabilities. The integration of WebAssembly with the Apache server enables the execution of PHP code in a secure environment.</p>
<p>Moving forward, we will work on introducing socket support in mod_wasm to enable network access to traditional databases and outgoing HTTP requests, further expanding the capabilities of Drupal deployments.</p>
<p>Embracing WebAssembly opens doors to a more secure Drupal ecosystem. Try out our <a href="https://github.com/vmware-labs/mod_wasm/tree/main/examples">Drupal demos</a> or directly <a href="https://github.com/vmware-labs/mod_wasm/releases">download mod_wasm</a> for your own setup. And feel free to share your comments with us on <a href="https://twitter.com/vmwwasm">Twitter</a> and <a href="https://github.com/vmware-labs/mod_wasm">GitHub</a>. If you liked this project, <a href="https://github.com/vmware-labs/mod_wasm/stargazers">give us a ⭐️</a>!</p>
</div></div>
  </body>
</html>
