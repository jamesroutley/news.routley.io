<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/ptrsr/pi-ci">Original</a>
    <h1>Pi-CI â€“ A RasPi 5 emulator in a Docker image for creating and flashing configs</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">A raspberry Pi emulator in a <a href="https://hub.docker.com/r/ptrsr/pi-ci" rel="nofollow">Docker image</a> that lets developers easily prepare and flash RPi configurations.</p>

<p dir="auto">The PI-CI project enables developers to easily:</p>
<ul dir="auto">
<li>Run a RPi VM.</li>
<li>Prepare a configuration inside a RPi VM.</li>
<li>Flash a RPi VM image to a physical SD card.</li>
</ul>
<p dir="auto">Example use cases:</p>
<ul dir="auto">
<li>Preconfigure Raspberry Pi servers that work from first boot.</li>
<li>Create reproducible server configurations using Ansible.</li>
<li>Automate the distribution of configurations through a CI pipeline.</li>
<li>Test ARM applications in a virtualized environment.</li>
</ul>
<p dir="auto">Key features:</p>
<ul dir="auto">
<li>Pi 3, 4 and <strong>5</strong> support</li>
<li>64 bit (ARMv8) Raspberry PI OS (Bookworm) included
<ul dir="auto">
<li>image: <strong><a href="https://downloads.raspberrypi.com/raspios_lite_arm64/images/raspios_lite_arm64-2024-07-04/" rel="nofollow">2024-07-04-raspios-bookworm-arm64-lite</a></strong></li>
<li>kernel: <strong><a href="https://github.com/raspberrypi/linux/tree/rpi-6.6.y">6.6-y</a></strong></li>
</ul>
</li>
<li>Internet access</li>
<li>No root required</li>
<li>Safe, fully reproducible from source</li>
<li>Tested and stable</li>
</ul>

<div dir="auto" data-snippet-clipboard-copy-content="$ docker pull ptrsr/pi-ci
$ docker run --rm -it ptrsr/pi-ci

&gt; usage: docker run [docker args] ptrsr/pi-ci [command] [optional args]
&gt; 
&gt; PI-CI: the reproducible PI emulator.
&gt; 
&gt; positional arguments:
&gt;   command     [init, start, resize, flash, export]
&gt; 
&gt; optional arguments:
&gt;   -h, --help  show this help message and exit
&gt;   -v          show verbose output
&gt; 
&gt; Refer to https://github.com/ptrsr/pi-ci for the full README on how to use this program."><pre>$ docker pull ptrsr/pi-ci
$ docker run --rm -it ptrsr/pi-ci

<span>&gt;</span> usage: docker run [docker args] ptrsr/pi-ci [command] [optional args]
<span>&gt;</span> 
<span>&gt;</span> PI-CI: the reproducible PI emulator.
<span>&gt;</span> 
<span>&gt;</span> positional arguments:
<span>&gt;</span>   <span>command</span>     [init, start, resize, flash, export]
<span>&gt;</span> 
<span>&gt;</span> optional arguments:
<span>&gt;</span>   -h, --help  show this <span>help</span> message and <span>exit</span>
<span>&gt;</span>   -v          show verbose output
<span>&gt;</span> 
<span>&gt;</span> Refer to https://github.com/ptrsr/pi-ci <span>for</span> the full README on how to use this program.</pre></div>
<p dir="auto">Each command has a help message, for example:
<code>docker run --rm -it ptrsr/pi-ci start -h</code>.</p>

<p dir="auto">Simply run a <code>ptrsr/pi-ci</code> container with the start command:</p>
<div dir="auto" data-snippet-clipboard-copy-content="docker run --rm -it ptrsr/pi-ci start"><pre>docker run --rm -it ptrsr/pi-ci start</pre></div>
<p dir="auto">The emulator will automatically log into <code>root</code>.</p>

<p dir="auto">To save the resulting image, use a bind mount to <code>/dist</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="docker run --rm -it -v $PWD/dist:/dist ptrsr/pi-ci start"><pre>docker run --rm -it -v <span>$PWD</span>/dist:/dist ptrsr/pi-ci start</pre></div>
<p dir="auto"><strong>NOTE</strong>: this example will create and mount the <code>dist</code> folder in the current working directory of the host.</p>
<p dir="auto">To restart the image, simply use the same bind mount.</p>

<p dir="auto">To enable ssh access, run the container with port <strong>2222</strong> exposed.</p>
<div dir="auto" data-snippet-clipboard-copy-content="docker run --rm -p 2222:2222 ptrsr/pi-ci start"><pre>docker run --rm -p 2222:2222 ptrsr/pi-ci start</pre></div>
<p dir="auto">Then ssh into the virtual Pi:</p>
<div dir="auto" data-snippet-clipboard-copy-content="ssh root@localhost -p 2222"><pre>ssh root@localhost -p 2222</pre></div>

<p dir="auto">The default image is 2 gigabytes in size. This can be increased (but <strong>not decreased!</strong>) through the <code>resize</code> command. Increasing the size can be done in two ways:</p>
<ol dir="auto">
<li>
<p dir="auto">by providing a path to the target device (e.g. <code>/dev/mmcblk0</code>). The resulting image will be the same size as the target device.</p>
</li>
<li>
<p dir="auto">By providing a specific size in gigabytes, megabytes or bytes (e.g. <code>8G</code>, <code>8192M</code>, <code>8589934592</code>).</p>
</li>
</ol>
<p dir="auto">For an image to be flashed to a device, the image has to be the less or equal to the device size.</p>
<div dir="auto" data-snippet-clipboard-copy-content="docker run --rm -it -v $PWD/dist:/dist --device=/dev/mmcblk0 ptrsr/pi-ci resize /dev/mmcblk0"><pre>docker run --rm -it -v <span>$PWD</span>/dist:/dist --device=/dev/mmcblk0 ptrsr/pi-ci resize /dev/mmcblk0</pre></div>
<p dir="auto"><strong>NOTE</strong>: although an SD card will say a specific size (such as 16GB), the device is usually if not always smaller (GB vs GiB). Therefore, using a target device is recommended.</p>
<p dir="auto"><strong>NOTE</strong>: resizing can potentially be a dangerous operation. Always make backup of the <code>image.qcow2</code> file in the <code>dist</code> folder before proceeding.</p>

<p dir="auto">To flash the prepared image to a storage device (such as an SD card), provide the container with the device and run the flash command:</p>
<div dir="auto" data-snippet-clipboard-copy-content="docker run --rm -it -v $PWD/dist:/dist --device=/dev/mmcblk0 ptrsr/pi-ci flash /dev/mmcblk0"><pre>docker run --rm -it -v <span>$PWD</span>/dist:/dist --device=/dev/mmcblk0 ptrsr/pi-ci flash /dev/mmcblk0</pre></div>
<p dir="auto">On the first boot of the real RPi, a program will automatically inflate the root partition to fill the rest of the target device.</p>

<p dir="auto">The export function converts the virtual (<code>.qcow2</code>) image to a raw (<code>.img</code>) image. This is particularly handy when it is not possible to directly flash an image (e.g. when using WSL), as the raw image can be flashed using tools like <a href="https://www.balena.io/etcher" rel="nofollow">Balena Etcher</a>. The export command takes two optional arguments; the <code>--input</code> and <code>--output</code> path;</p>
<div dir="auto" data-snippet-clipboard-copy-content="docker run --rm -it -v $PWD/dist:/dist ptrsr/pi-ci export --input /dist/image.qcow2 --output /dist/image.img"><pre>docker run --rm -it -v <span>$PWD</span>/dist:/dist ptrsr/pi-ci <span>export</span> --input /dist/image.qcow2 --output /dist/image.img</pre></div>
<p dir="auto">The raw image should pop up alongside the virtual image in the mounted <code>dist</code> folder in the example above.</p>

<p dir="auto">Using Ansible, it is possible to automate the whole configuration process. Ansible requires docker-py to be installed. This can be done using <code>pip3 install docker-py</code>.</p>
<p dir="auto">Ansible can take care of:</p>
<ol dir="auto">
<li>Starting the VM</li>
<li>Running tasks in the VM</li>
<li>Stopping the VM</li>
</ol>
<p dir="auto">An example configuration can be found in the <code>./test</code> folder of this repository. To start the test process, run:</p>
<div dir="auto" data-snippet-clipboard-copy-content="ansible-playbook -i ./test/hosts.yml ./test/main.yml"><pre>ansible-playbook -i ./test/hosts.yml ./test/main.yml</pre></div>

<ul dir="auto">
<li>Do not forget to set a password for <code>root</code> and disable <code>PermitRootLogin</code> in the <code>/etc/ssh/sshd_config</code> for security.</li>
<li>Do not stop or kill the Docker container while the VM is running, this <strong>WILL</strong> corrupt the image!</li>
<li>Make sure to regularly back up the <code>distro.qcow2</code> image.</li>
</ul>

<p dir="auto">PI-CI has automatically been tested on Ubuntu 24.04 using GitHub Actions. Any other distro should work with the following software versions (or higher, perhaps):</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Software</th>
<th>Version</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ansible</td>
<td>2.5.1</td>
</tr>
<tr>
<td>docker-py</td>
<td>4.4.4</td>
</tr>
<tr>
<td>Docker</td>
<td>19.03.6</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>

<p dir="auto">PI-CI is licensed under <a href="https://www.gnu.org/licenses/gpl-3.0.en.html" rel="nofollow">GPLv3</a>.</p>
</article></div></div>
  </body>
</html>
