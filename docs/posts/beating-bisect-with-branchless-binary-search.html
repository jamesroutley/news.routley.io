<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/juliusgeo/branchless_bisect">Original</a>
    <h1>Beating Bisect with Branchless Binary Search</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><h2 tabindex="-1" dir="auto"><a id="user-content-beating-bisect-with-branchless-binary-search" aria-label="Heading link" href="#beating-bisect-with-branchless-binary-search"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Beating Bisect With Branchless Binary Search</h2>
<p dir="auto">I recently read this article: <a href="https://probablydance.com/2023/04/27/beautiful-branchless-binary-search/" rel="nofollow">https://probablydance.com/2023/04/27/beautiful-branchless-binary-search/</a>, and I was inspired.
First I implemented the same algorithm in pure Python:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L10" data-line-number="10"></td>
          <td id="LC10"> <span>def</span> <span>branchless_bisect_left</span>(<span>arr</span>, <span>value</span>): </td>
        </tr>

        <tr>
          <td id="L11" data-line-number="11"></td>
          <td id="LC11">     <span>begin</span>, <span>end</span><span>=</span><span>0</span>,<span>len</span>(<span>arr</span>) </td>
        </tr>

        <tr>
          <td id="L12" data-line-number="12"></td>
          <td id="LC12">     <span>length</span> <span>=</span> <span>end</span> <span>-</span> <span>begin</span> </td>
        </tr>

        <tr>
          <td id="L13" data-line-number="13"></td>
          <td id="LC13">     <span>if</span> <span>length</span> <span>==</span> <span>0</span>: </td>
        </tr>

        <tr>
          <td id="L14" data-line-number="14"></td>
          <td id="LC14">         <span>return</span> <span>end</span> </td>
        </tr>

        <tr>
          <td id="L15" data-line-number="15"></td>
          <td id="LC15">     <span>step</span> <span>=</span> <span>bit_floor</span>(<span>length</span>) </td>
        </tr>

        <tr>
          <td id="L16" data-line-number="16"></td>
          <td id="LC16">     <span>if</span> <span>step</span> <span>!=</span> <span>length</span> <span>and</span> <span>arr</span>[<span>step</span>]<span>&lt;</span><span>value</span>: </td>
        </tr>

        <tr>
          <td id="L17" data-line-number="17"></td>
          <td id="LC17">         <span>length</span> <span>-=</span> <span>step</span> <span>+</span> <span>1</span> </td>
        </tr>

        <tr>
          <td id="L18" data-line-number="18"></td>
          <td id="LC18">         <span>if</span> <span>length</span> <span>==</span> <span>0</span>: </td>
        </tr>

        <tr>
          <td id="L19" data-line-number="19"></td>
          <td id="LC19">             <span>return</span> <span>end</span> </td>
        </tr>

        <tr>
          <td id="L20" data-line-number="20"></td>
          <td id="LC20">         <span>step</span> <span>=</span> <span>bit_ceil</span>(<span>length</span>) </td>
        </tr>

        <tr>
          <td id="L21" data-line-number="21"></td>
          <td id="LC21">         <span>begin</span> <span>=</span> <span>end</span> <span>-</span> <span>step</span> </td>
        </tr>

        <tr>
          <td id="L22" data-line-number="22"></td>
          <td id="LC22">     <span>step</span> &gt;&gt;= <span>1</span> </td>
        </tr>

        <tr>
          <td id="L23" data-line-number="23"></td>
          <td id="LC23">     <span>while</span> <span>step</span><span>:=</span><span>step</span> <span>&gt;&gt;</span> <span>1</span>: </td>
        </tr>

        <tr>
          <td id="L24" data-line-number="24"></td>
          <td id="LC24">         <span>begin</span> <span>+=</span> <span>step</span> <span>if</span> <span>arr</span>[<span>step</span><span>+</span><span>begin</span>]<span>&lt;</span><span>value</span> <span>else</span> <span>0</span> </td>
        </tr>

        <tr>
          <td id="L25" data-line-number="25"></td>
          <td id="LC25">     <span>return</span> <span>begin</span><span>+</span><span>int</span>(<span>arr</span>[<span>begin</span>]<span>&lt;</span><span>value</span>) </td>
        </tr>
    </tbody></table>
  </div>
</div>

<p dir="auto">And then I compared it against <code>sortedcontainers</code>&#39;s implementation of bisect_left across a large range of array sizes:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/juliusgeo/branchless_bisect/blob/master/images/1.jpg"><img src="https://github.com/juliusgeo/branchless_bisect/raw/master/images/1.jpg" alt="image" title="Figure 1"/></a></p>
<p dir="auto">Pretty handily beats it! However, most people using Python would probably be using <code>bisect_left</code> from the <code>bisect</code> library in the stdlib.
To try to beat that implementation, though, I will have to descend into C-land. Here&#39;s my implementation as a Python C-extension:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L15" data-line-number="15"></td>
          <td id="LC15"> <span>static</span> PyObject* <span>bl_bisect_left</span>(PyObject *self, PyObject *args) { </td>
        </tr>

        <tr>
          <td id="L16" data-line-number="16"></td>
          <td id="LC16">     PyObject *list_obj; </td>
        </tr>

        <tr>
          <td id="L17" data-line-number="17"></td>
          <td id="LC17">     PyObject *value; </td>
        </tr>

        <tr>
          <td id="L18" data-line-number="18"></td>
          <td id="LC18">  </td>
        </tr>

        <tr>
          <td id="L19" data-line-number="19"></td>
          <td id="LC19">     <span>if</span> (!<span>PyArg_ParseTuple</span>(args, <span><span>&#34;</span>OO<span>&#34;</span></span>, &amp;list_obj, &amp;value)) </td>
        </tr>

        <tr>
          <td id="L20" data-line-number="20"></td>
          <td id="LC20">         <span>return</span> <span>NULL</span>; </td>
        </tr>

        <tr>
          <td id="L21" data-line-number="21"></td>
          <td id="LC21">  </td>
        </tr>

        <tr>
          <td id="L22" data-line-number="22"></td>
          <td id="LC22">     <span>long</span> size = <span>PyList_Size</span>(list_obj); </td>
        </tr>

        <tr>
          <td id="L23" data-line-number="23"></td>
          <td id="LC23">  </td>
        </tr>

        <tr>
          <td id="L24" data-line-number="24"></td>
          <td id="LC24">     <span>long</span> begin = <span>0</span>, end = size; </td>
        </tr>

        <tr>
          <td id="L25" data-line-number="25"></td>
          <td id="LC25">     <span>long</span> length = end - begin; </td>
        </tr>

        <tr>
          <td id="L26" data-line-number="26"></td>
          <td id="LC26">  </td>
        </tr>

        <tr>
          <td id="L27" data-line-number="27"></td>
          <td id="LC27">     <span>if</span> (length == <span>0</span>) { </td>
        </tr>

        <tr>
          <td id="L28" data-line-number="28"></td>
          <td id="LC28">         <span>return</span> <span>PyLong_FromLong</span>(end); </td>
        </tr>

        <tr>
          <td id="L29" data-line-number="29"></td>
          <td id="LC29">     } </td>
        </tr>

        <tr>
          <td id="L30" data-line-number="30"></td>
          <td id="LC30">  </td>
        </tr>

        <tr>
          <td id="L31" data-line-number="31"></td>
          <td id="LC31">     <span>long</span> step = <span>bit_floor_shifted</span>(length); </td>
        </tr>

        <tr>
          <td id="L32" data-line-number="32"></td>
          <td id="LC32">  </td>
        </tr>

        <tr>
          <td id="L33" data-line-number="33"></td>
          <td id="LC33">     <span>if</span> (step != length &amp;&amp; <span>PyObject_RichCompareBool</span>(<span>PyList_GetItem</span>(list_obj, begin + step - <span>1</span>), value, Py_LT)) { </td>
        </tr>

        <tr>
          <td id="L34" data-line-number="34"></td>
          <td id="LC34">         begin += step; </td>
        </tr>

        <tr>
          <td id="L35" data-line-number="35"></td>
          <td id="LC35">         length -= step; </td>
        </tr>

        <tr>
          <td id="L36" data-line-number="36"></td>
          <td id="LC36">     } </td>
        </tr>

        <tr>
          <td id="L37" data-line-number="37"></td>
          <td id="LC37">  </td>
        </tr>

        <tr>
          <td id="L38" data-line-number="38"></td>
          <td id="LC38">     <span>long</span> next = <span>0</span>; </td>
        </tr>

        <tr>
          <td id="L39" data-line-number="39"></td>
          <td id="LC39">     <span>for</span> (step &gt;&gt;= <span>1</span>; step != <span>0</span>; step &gt;&gt;=<span>1</span>) { </td>
        </tr>

        <tr>
          <td id="L40" data-line-number="40"></td>
          <td id="LC40">         <span>if</span> ((next = begin + step) &lt; size) { </td>
        </tr>

        <tr>
          <td id="L41" data-line-number="41"></td>
          <td id="LC41">             begin += <span>PyObject_RichCompareBool</span>(<span>PyList_GetItem</span>(list_obj, next), value, Py_LT) * step; </td>
        </tr>

        <tr>
          <td id="L42" data-line-number="42"></td>
          <td id="LC42">         } </td>
        </tr>

        <tr>
          <td id="L43" data-line-number="43"></td>
          <td id="LC43">     } </td>
        </tr>

        <tr>
          <td id="L44" data-line-number="44"></td>
          <td id="LC44">     <span>return</span> <span>PyLong_FromLong</span>(begin + (begin &lt; size &amp;&amp; <span>PyObject_RichCompareBool</span>(<span>PyList_GetItem</span>(list_obj, begin), value, Py_LT))); </td>
        </tr>

        <tr>
          <td id="L45" data-line-number="45"></td>
          <td id="LC45"> } </td>
        </tr>
    </tbody></table>
  </div>
</div>

<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/juliusgeo/branchless_bisect/blob/master/images/2.jpg"><img src="https://github.com/juliusgeo/branchless_bisect/raw/master/images/2.jpg" alt="image" title="Figure 2"/></a></p>
<p dir="auto">That beats it as well! Admittedly this is only for arrays of size up to <code>2**29</code>, but still pretty cool.
I also checked whether it successfully compiled with a <code>CMOVE</code> instruction:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L67" data-line-number="67"></td>
          <td id="LC67"> bf:	e8 00 00 00 00       	call   c4 &lt;_bl_bisect_left+0xa4&gt; </td>
        </tr>

        <tr>
          <td id="L68" data-line-number="68"></td>
          <td id="LC68"> c4:	83 f8 01             	cmp    $0x1,%eax </td>
        </tr>

        <tr>
          <td id="L69" data-line-number="69"></td>
          <td id="LC69"> c7:	4c 0f 44 fb          	cmove  %rbx,%r15 </td>
        </tr>

        <tr>
          <td id="L70" data-line-number="70"></td>
          <td id="LC70"> cb:	48 83 fb 02          	cmp    $0x2,%rbx </td>
        </tr>

        <tr>
          <td id="L71" data-line-number="71"></td>
          <td id="LC71"> cf:	73 35                	jae    106 &lt;_bl_bisect_left+0xe6&gt; </td>
        </tr>
    </tbody></table>
  </div>
</div>

<p dir="auto">It does! You can see the full compiled dump in <code>objdump_output.txt</code>.
Now, here are all of them combined (what you will get if you run <code>main.py</code>):</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/juliusgeo/branchless_bisect/blob/master/images/3.jpg"><img src="https://github.com/juliusgeo/branchless_bisect/raw/master/images/3.jpg" alt="image" title="Figure 3"/></a></p>
<p dir="auto">This repo contains the submodule and benchmarking code I used to obtain these results.</p>
</article>
          </div></div>
  </body>
</html>
