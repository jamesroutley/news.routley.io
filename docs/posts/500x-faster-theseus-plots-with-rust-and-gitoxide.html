<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://amedee.me/introducing-gix-of-theseus/">Original</a>
    <h1>500x Faster Theseus Plots with Rust and Gitoxide</h1>
    
    <div id="readability-page-1" class="page"><section>
			<p>One of my favorite types of graphs of all time is <a href="https://github.com/erikbern/git-of-theseus">Git of Theseus</a> by Erik Bern, which shows a Git repository’s composition over time.
It’s a stacked plot showing, for any given moment in time, the amount of code that was written in each year.
It has a really “natural” feel, it looks like layers of sedimentary rock accumulating and weathering over time:</p>
<figure><img src="https://amedee.me/img/theseus/linux.png" alt="A Theseus stacked plot of the Linux repository. Each layer counts the amount of code added that year."/><figcaption>
      <p>A Theseus stacked plot of the Linux repository</p>
    </figcaption>
</figure>

<p>These graphs are beautiful and interesting. But they have a big downside: they take forever to generate <sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup>.
It took ~10 hours to make the Linux graph on an M1 Max laptop.
While that’s a massive codebase, the point of the tool is to look at large, mature projects and it should be faster than that to be useful.
There’s an alternative tool linked in the README called <a href="https://github.com/src-d/hercules">Hercules</a> which is written in Go, but it still takes a whole hour for Linux on my laptop, and it eats up RAM.</p>
<p>So I wrote my own version in Rust using the <code>gix</code> (Gitoxide) crate and called it <a href="https://github.com/amedeedaboville/gix-of-theseus">gix-of-theseus</a>. It’s 500x-1000x faster at making the same graph:
<sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup></p>
<table>
<thead>
<tr>
<th>Repo</th>
<th>Git-of-Theseus (python) [s]</th>
<th>gix-of-theseus [s]</th>
<th>Speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td>torvalds/linux</td>
<td>~36000</td>
<td>68</td>
<td>~530x</td>
</tr>
<tr>
<td>git/git</td>
<td>3011</td>
<td>6.2</td>
<td>579x</td>
</tr>
<tr>
<td>ffmpeg/ffmpeg</td>
<td>8195</td>
<td>9.6</td>
<td>853x</td>
</tr>
<tr>
<td>elastic/elasticsearch</td>
<td>8193</td>
<td>9.4</td>
<td>871x</td>
</tr>
</tbody>
</table>
<p>I was surprised how much faster this could go, these numbers look bonkers. While the original tool was written in Python, it uses multiprocessing and shells out most of its work to Git fairly efficiently.
How did this get so much faster?</p>
<h2 id="strictly-fewer-features">Strictly Fewer Features</h2>
<p>It’s not a drop-in replacement; it only makes the one picture. The original can break down the repo by author, draw forgetting curves, and slice the data in many ways.
I may add those later, but the goal here is the sedimentary breakdown by year.
Collecting the data for these other graphs forces extra work if all you want is the year breakdown.</p>
<h2 id="a-better-algorithm">A Better Algorithm</h2>
<p>The time complexity of Git of Theseus is more or less <em>~quadratic</em> in the number of commits:
it goes through the repo, and for each week, it shells out <code>git blame</code> for every file in the repo at that point in time (only the files that changed since the last commit).
But each independent call to <code>git blame</code> has to go through the <em>entire prior history of that file</em>, so the amount of steps it takes is like adding 1 + 2 + 3 + 4… and getting to O(N²).</p>
<p>Taking inspiration from the aforementioned Hercules, gix-of-theseus implements an “incremental blame”.
It tracks the blame result for each file as it steps through the repo’s history, generating the data in one pass through the repo.
I thought re-implementing <code>git blame</code> would be too hard for a mere mortal like me, but seeing that Hercules did it gave me courage, and I took inspiration from its data structures.</p>
<h2 id="great-rust-crates">Great Rust Crates</h2>
<p>The functionality provided by best-in-class crates like <a href="https://github.com/GitoxideLabs/gitoxide">Gitoxide</a> and <a href="https://docs.rs/rayon/latest/rayon/">Rayon</a> is another important reason this tool is fast.</p>
<p>Gitoxide truly is a special library.
It’s super fast, has a ton of features and the interfaces are pretty coherent together. As an example of its superpowers, it can use Rayon to parallelize its own operations, and when unpacking compressed Git data it has access to <a href="https://github.com/trifectatechfoundation/zlib-rs">zlib-rs</a>, the <a href="https://trifectatech.org/blog/zlib-rs-is-faster-than-c/">fastest existing zlib library</a>.
It’s genuinely a shining star of the Rust ecosystem.</p>

<p>Install with <code>cargo install gix-of-theseus</code>, then run:</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>gix-of-theseus analyze $your_repo_path
</span></span></code></pre></div><p>To generate the plot. If you have <code>uv</code> or <code>pipx</code> installed (you can get either through <code>pip install</code>), the <code>analyze</code> command will auto-generate a plot and save it to <code>$outdir/stackplot.png</code>. The original python plotting scripts have been lifted and modernized into <a href="https://thisdavej.com/share-python-scripts-like-a-pro-uv-and-pep-723-for-easy-deployment/">PEP 723</a> “self-contained scripts” that auto-install their dependencies and don’t require you to think about virtualenvs.</p>
<p>If you try it, I’d love to see your graph ((@amedee.me)[https://bsky.app/profile/amedee.me] on Bluesky)!</p>
<p>You can also check out the <a href="https://github.com/amedeedaboville/gix-of-theseus">code</a> and give feedback on my intermediate Rust.</p>
<p>Next up: putting a small web UI on this so it can be online!</p>

<div>
<figure><img src="https://amedee.me/img/theseus/git.png" alt="Git (6s to generate)"/><figcaption>
      <p>Git (6s to generate)</p>
    </figcaption>
</figure>

<figure><img src="https://amedee.me/img/theseus/cpython.png" alt="The CPython interpreter (15s to generate)"/><figcaption>
      <p>The CPython interpreter (15s to generate)</p>
    </figcaption>
</figure>

<figure><img src="https://amedee.me/img/theseus/vim.png" alt="Vim (9s to generate)"/><figcaption>
      <p>Vim (9s to generate)</p>
    </figcaption>
</figure>

<figure><img src="https://amedee.me/img/theseus/rust.png" alt="Rust (13s to generate)"/><figcaption>
      <p>Rust (13s to generate)</p>
    </figcaption>
</figure>

<figure><img src="https://amedee.me/img/theseus/pandas.png" alt="Pandas (6s to generate)"/><figcaption>
      <p>Pandas (6s to generate)</p>
    </figcaption>
</figure>

<figure><img src="https://amedee.me/img/theseus/homebrew-core.png" alt="The packages in homebrew-core (8.3s to generate)"/><figcaption>
      <p>The packages in homebrew-core (8.3s to generate)</p>
    </figcaption>
</figure>

<figure><img src="https://amedee.me/img/theseus/postgres.png" alt="Postgres (19s to generate)"/><figcaption>
      <p>Postgres (19s to generate)</p>
    </figcaption>
</figure>

<figure><img src="https://amedee.me/img/theseus/django.png" alt="Django (5s to generate)"/><figcaption>
      <p>Django (5s to generate)</p>
    </figcaption>
</figure>

</div>



			
				<hr/>
				


<a href="https://disqus.com">comments powered by </a>
			

			<hr/>
			


<ul>
	
	<li><a href="https://amedee.me/group-theory-zoombinis-2/">Group Theory with Zoombinis: Part 2</a></li>
	
	<li><a href="https://amedee.me/group-theory-zoombinis-1/">Group Theory with Zoombinis: Part 1</a></li>
	
	<li><a href="https://amedee.me/ct-overrated/">Category Theory is Overrated for Programmers. Study Abstract Algebra Instead</a></li>
	
	<li><a href="https://amedee.me/missing-middle/">The Missing Middle in Tech Education</a></li>
	
	<li><a href="https://amedee.me/2022/11/09/debugging/">Debugging Is Science</a></li>
	
</ul>

		</section></div>
  </body>
</html>
