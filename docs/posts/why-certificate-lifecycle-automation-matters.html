<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.hezmatt.org/~mpalmer/blog/2024/01/30/why-certificate-automation-matters.html">Original</a>
    <h1>Why Certificate Lifecycle Automation Matters</h1>
    
    <div id="readability-page-1" class="page"><div id="body">
			
			<div id="content">

				
				<p>
					Posted: Tue, 30 January 2024
					| <a href="https://www.hezmatt.org/~mpalmer/blog/2024/01/30/why-certificate-automation-matters.html">permalink</a>
					| <a href="https://www.hezmatt.org/~mpalmer/blog/2024/01/30/why-certificate-automation-matters.html#comments">
						
							No comments
						
					</a>
				</p>
<p>If you’ve perused the <a href="https://botsin.space/@pwnedcerts">ActivityPub feed of certificates whose keys are known to be compromised</a>, and clicked on the “Show More” button to see the name of the certificate issuer, you may have noticed that some issuers seem to come up again and again.
This might make sense – after all, if a CA is issuing a large volume of certificates, they’ll be seen more often in a list of compromised certificates.
In an attempt to see if there is anything that we can learn from this data, though, I did a bit of digging, and came up with some illuminating results.</p>



<p>I started off by finding all the unexpired certificates logged in <a href="https://certificate.transparency.dev">Certificate Transparency</a> (CT) logs that have a key that is in the <a href="https://pwnedkeys.com">pwnedkeys</a> database as having been publicly disclosed.
From this list of certificates, I removed duplicates by matching up issuer/serial number tuples, and then reduced the set by counting the number of unique certificates by their issuer.</p>

<p>This gave me a list of the issuers of these certificates, which looks a bit like this:</p>

<pre>/C=BE/O=GlobalSign nv-sa/CN=AlphaSSL CA - SHA256 - G4
/C=GB/ST=Greater Manchester/L=Salford/O=Sectigo Limited/CN=Sectigo RSA Domain Validation Secure Server CA
/C=GB/ST=Greater Manchester/L=Salford/O=Sectigo Limited/CN=Sectigo RSA Organization Validation Secure Server CA
/C=US/ST=Arizona/L=Scottsdale/O=GoDaddy.com, Inc./OU=http://certs.godaddy.com/repository//CN=Go Daddy Secure Certificate Authority - G2
/C=US/ST=Arizona/L=Scottsdale/O=Starfield Technologies, Inc./OU=http://certs.starfieldtech.com/repository//CN=Starfield Secure Certificate Authority - G2
/C=AT/O=ZeroSSL/CN=ZeroSSL RSA Domain Secure Site CA
/C=BE/O=GlobalSign nv-sa/CN=GlobalSign GCC R3 DV TLS CA 2020
</pre>

<p>Rather than try to work with raw issuers (because, as Andrew Ayer says, <a href="https://www.agwa.name/blog/post/the_certificate_issuer_field_is_a_lie">The SSL Certificate Issuer Field is a Lie</a>), I mapped these issuers to the organisations that manage them, and summed the counts for those grouped issuers together.</p>



<figure>
<img src="https://www.hezmatt.org/~mpalmer/blog/2024/01/30/images/raw_data.jpg" alt="Lieutenant Commander Data from Star Trek: The Next Generation"/>
<figcaption>
  Insert obligatory &#34;not THAT data&#34; comment here
</figcaption>
</figure>

<p>The end result of this work is the following table, sorted by the count of certificates which have been compromised by exposing their private key:</p>

<table>
<tbody><tr><th>Issuer</th><th>Compromised Count</th></tr>
<tr><td>Sectigo</td><td>170</td></tr>
<tr><td>ISRG (Let&#39;s Encrypt)</td><td>161</td></tr>
<tr><td>GoDaddy</td><td>141</td></tr>
<tr><td>DigiCert</td><td>81</td></tr>
<tr><td>GlobalSign</td><td>46</td></tr>
<tr><td>Entrust</td><td>3</td></tr>
<tr><td>SSL.com</td><td>1</td></tr>
</tbody></table>

<p>If you’re familiar with the CA ecosystem, you’ll probably recognise that the organisations with large numbers of compromised certificates are also those who issue a lot of certificates.
So far, nothing particularly surprising, then.</p>

<p>Let’s look more closely at the relationships, though, to see if we can get more useful insights.</p>



<p>Using the <a href="https://crt.sh/cert-populations">issuance volume report from crt.sh</a>, we can compare issuance volumes to compromise counts, to come up with a “compromise rate”.
I’m using the “Unexpired Precertificates” colume from the issuance volume report, as I feel that’s the number that best matches the certificate population I’m examining to find compromised certificates.
To maintain parity with the previous table, this one is still sorted by the count of certificates that have been compromised.</p>

<table>
<tbody><tr><th>Issuer</th><th>Issuance Volume</th><th>Compromised Count</th><th>Compromise Rate</th></tr>
<tr><td>Sectigo</td><td>88,323,068</td><td>170</td><td>1 in 519,547</td></tr>
<tr><td>ISRG (Let&#39;s Encrypt)</td><td>315,476,402</td><td>161</td><td>1 in 1,959,480</td></tr>
<tr><td>GoDaddy</td><td>56,121,429</td><td>141</td><td>1 in 398,024</td></tr>
<tr><td>DigiCert</td><td>144,713,475</td><td>81</td><td>1 in 1,786,586</td></tr>
<tr><td>GlobalSign</td><td>1,438,485</td><td>46</td><td>1 in 31,271</td></tr>
<tr><td>Entrust</td><td>23,166</td><td>3</td><td>1 in 7,722</td></tr>
<tr><td>SSL.com</td><td>171,816</td><td>1</td><td>1 in 171,816</td></tr>
</tbody></table>

<p>If we now sort this table by compromise rate, we can see which organisations have the most (and least) leakiness going on from their customers:</p>

<table>
<tbody><tr><th>Issuer</th><th>Issuance Volume</th><th>Compromised Count</th><th>Compromise Rate</th></tr>
<tr><td>Entrust</td><td>23,166</td><td>3</td><td>1 in 7,722</td></tr>
<tr><td>GlobalSign</td><td>1,438,485</td><td>46</td><td>1 in 31,271</td></tr>
<tr><td>SSL.com</td><td>171,816</td><td>1</td><td>1 in 171,816</td></tr>
<tr><td>GoDaddy</td><td>56,121,429</td><td>141</td><td>1 in 398,024</td></tr>
<tr><td>Sectigo</td><td>88,323,068</td><td>170</td><td>1 in 519,547</td></tr>
<tr><td>DigiCert</td><td>144,713,475</td><td>81</td><td>1 in 1,786,586</td></tr>
<tr><td>ISRG (Let&#39;s Encrypt)</td><td>315,476,402</td><td>161</td><td>1 in 1,959,480</td></tr>
</tbody></table>

<p>By grouping by order-of-magnitude in the compromise rate, we can identify three “bands”:</p>

<ul>
  <li>
    <p><strong>The Super Leakers</strong>: Customers of Entrust and GlobalSign seem to love to lose control of their private keys.
For Entrust, at least, though, the small volumes involved make the numbers somewhat untrustworthy.
The three compromised certificates could very well belong to just one customer, for instance.
I’m not aware of anything that GlobalSign does that would make them such an outlier, either, so I’m inclined to think they just got unlucky with one or two customers, but as CAs don’t include customer IDs in the certificates they issue, it’s not possible to say whether that’s the actual cause or not.</p>
  </li>
  <li>
    <p><strong>The “Regular” Leakers</strong>: Customers of SSL.com, GoDaddy, and Sectigo all have compromise rates in the 1-in-hundreds-of-thousands range.
Again, the low volumes of SSL.com make the numbers somewhat unreliable, but the other two organisations in this group have large enough numbers that we can rely on that data fairly well, I think.</p>
  </li>
  <li>
    <p><strong>The Low Leakers</strong>: Customers of DigiCert and Let’s Encrypt are at least three times less likely than customers of the “regular leakers” to lose control of their private keys.
Good for them!</p>
  </li>
</ul>

<p>Now we have some useful insights we can think about.</p>



<figure>
<img src="https://www.hezmatt.org/~mpalmer/blog/2024/01/30/images/why_is_it_so.jpg" alt="Professor Julius Sumner Miller"/>
<figcaption>If you don&#39;t know who Professor Julius Sumner Miller is, I highly recommend <a href="https://www.abc.net.au/science/features/whyisitso/about.htm">finding out</a></figcaption>
</figure>

<p>All of the organisations on the list, with the exception of Let’s Encrypt, are what one might term “traditional” CAs.
To a first approximation, it’s reasonable to assume that the vast majority of the customers of these traditional CAs probably manage their certificates the same way they have for the past two decades or more.
That is, they generate a key and CSR, upload the CSR to the CA to get a certificate, then copy the cert and key… somewhere.
Since humans are handling the keys, there’s a higher risk of the humans using either risky practices, or making a mistake, and exposing the private key to the world.</p>

<p>Let’s Encrypt, on the other hand, issues all of its certificates using <a href="https://en.wikipedia.org/wiki/Automatic_Certificate_Management_Environment">the ACME (Automatic Certificate Management Environment) protocol</a>, and all of the Let’s Encrypt documentation encourages the use of software tools to generate keys, issue certificates, and install them for use.
Given that Let’s Encrypt has 161 compromised certificates currently in the wild, it’s clear that the automation in use is far from perfect, but the significantly lower compromise rate suggests to me that lifecycle automation at least <em>reduces</em> the rate of key compromise, even though it doesn’t eliminate it completely.</p>



<p>It is true that <em>all</em> of the organisations in this analysis <em>also</em> provide ACME issuance workflows, should customers desire it.
However, the “traditional CA” companies have been around a lot longer than ACME has, and so they probably acquired many of their customers before ACME existed.</p>

<p>Given that it’s <em>incredibly</em> hard to get humans to change the way they do things, once they have a way that “works”, it seems reasonable to assume that most of the certificates issued by these CAs are handled in the same human-centric, error-prone manner they always have been.</p>

<p>If organisations would like to refute this assumption, though, by sharing their data on ACME vs legacy issuance rates, I’m sure we’d all be extremely interested.</p>

<h2 id="explaining-the-outlier">Explaining the Outlier</h2>

<p>The difference in presumed issuance practices would seem to explain the significant difference in compromise rates between Let’s Encrypt and the other organisations, if it weren’t for one outlier.
This is a largely “traditional” CA, with the manual-handling issues that implies, but with a compromise rate close to that of Let’s Encrypt.</p>

<p>We are, of course, talking about DigiCert.</p>

<p>The thing about DigiCert, that doesn’t show up in the raw numbers from crt.sh, is that DigiCert manages the issuance of certificates for several of the biggest “hosted TLS” providers, such as CloudFlare and AWS.
When these services obtain a certificate from DigiCert on their customer’s behalf, the private key is kept locked away, and no human can (we hope) get access to the private key.
This is supported by the fact that no certificates identifiably issued to either CloudFlare or AWS appear in the set of certificates with compromised keys.</p>

<p>When we ask for “all certificates issued by DigiCert”, we get both the certificates issued to these big providers, which are very good at keeping their keys under control, as well as the certificates issued to everyone else, whose key handling practices may not be quite so stringent.</p>

<p>It’s possible, though not trivial, to account for certificates issued to these “hosted TLS” providers, because the certificates they use are issued from intermediates “branded” to those companies.
With the <a href="https://groups.google.com/g/crtsh/c/sUmV0mBz8bQ/m/K-6Vymd_AAAJ">crt.sh psql interface</a> we can run this query to get the total number of unexpired precertificates issued to these managed services:</p>

<pre>SELECT SUM(sub.NUM_ISSUED[2] - sub.NUM_EXPIRED[2])
  FROM (
    SELECT ca.name, max(coalesce(coalesce(nullif(trim(cc.SUBORDINATE_CA_OWNER), &#39;&#39;), nullif(trim(cc.CA_OWNER), &#39;&#39;)), cc.INCLUDED_CERTIFICATE_OWNER)) as OWNER,
           ca.NUM_ISSUED, ca.NUM_EXPIRED
      FROM ccadb_certificate cc, ca_certificate cac, ca
     WHERE cc.CERTIFICATE_ID = cac.CERTIFICATE_ID
       AND cac.CA_ID = ca.ID
  GROUP BY ca.ID
  ) sub
 WHERE sub.name ILIKE &#39;%Amazon%&#39; OR sub.name ILIKE &#39;%CloudFlare%&#39; AND sub.owner = &#39;DigiCert&#39;;
</pre>

<p>The number I get from running that query is 104,316,112, which should be <em>subtracted</em> from DigiCert’s total issuance figures to get a more accurate view of what DigiCert’s “regular” customers do with their private keys.
When I do this, the compromise rates table, sorted by the compromise rate, looks like this:</p>

<table>
<tbody><tr><th>Issuer</th><th>Issuance Volume</th><th>Compromised Count</th><th>Compromise Rate</th></tr>
<tr><td>Entrust</td><td>23,166</td><td>3</td><td>1 in 7,722</td></tr>
<tr><td>GlobalSign</td><td>1,438,485</td><td>46</td><td>1 in 31,271</td></tr>
<tr><td>SSL.com</td><td>171,816</td><td>1</td><td>1 in 171,816</td></tr>
<tr><td>GoDaddy</td><td>56,121,429</td><td>141</td><td>1 in 398,024</td></tr>
<tr><td>&#34;Regular&#34; DigiCert</td><td>40,397,363</td><td>81</td><td>1 in 498,732</td></tr>
<tr><td>Sectigo</td><td>88,323,068</td><td>170</td><td>1 in 519,547</td></tr>
<tr><td>All DigiCert</td><td>144,713,475</td><td>81</td><td>1 in 1,786,586</td></tr>
<tr><td>ISRG (Let&#39;s Encrypt)</td><td>315,476,402</td><td>161</td><td>1 in 1,959,480</td></tr>
</tbody></table>

<p>In short, it appears that DigiCert’s regular customers are just as likely as GoDaddy or Sectigo customers to expose their private keys.</p>



<p>The takeaway from all this is fairly straightforward, and not overly surprising, I believe.</p>

<p><em>The less humans have to do with certificate issuance, the less likely they are to compromise that certificate by exposing the private key.</em></p>

<p>While it may not be surprising, it is nice to have some empirical evidence to back up the common wisdom.</p>

<p>Fully-managed TLS providers, such as CloudFlare, AWS Certificate Manager, and whatever Azure’s thing is called, is the platonic ideal of this principle: never give humans any opportunity to expose a private key.
I’m not saying you <em>should</em> use one of these providers, but the security approach they have adopted appears to be the optimal one, and should be emulated universally.</p>

<p>The ACME protocol is the next best, in that there are a variety of standardised tools widely available that <em>allow</em> humans to take themselves out of the loop, but it’s still possible for humans to handle (and mistakenly expose) key material if they try hard enough.</p>

<p>Legacy issuance methods, which either cannot be automated, or require custom, per-provider automation to be developed, appear to be <em>at least</em> four times less helpful to the goal of avoiding compromise of the private key associated with a certificate.</p>

<h2 id="humans-are-of-course-the-problem">Humans Are, Of Course, The Problem</h2>

<figure>
<img src="https://www.hezmatt.org/~mpalmer/blog/2024/01/30/images/kill_all_humans.jpg" alt="Bender, the robot from Futurama, asking if we&#39;d like to kill all humans"/>
<figcaption>No thanks, Bender, I&#39;m busy tonight</figcaption>
</figure>

<p>This observation – that if you don’t let humans near keys, they don’t get leaked – is further supported by considering the biggest issuers by volume who have not issued <em>any</em> certificates whose keys have been compromised: Google Trust Services (fourth largest issuer overall, with 57,084,529 unexpired precertificates), and Microsoft Corporation (sixth largest issuer overall, with 22,852,468 unexpired precertificates).
It appears that somewhere between “most” and “basically all” of the certificates these organisations issue are to customers of their public clouds, and my understanding is that the keys for these certificates are managed in same manner as CloudFlare and AWS – the keys are locked away where humans can’t get to them.</p>

<p>It should, of course, go without saying that if a human can never have access to a private key, it makes it rather difficult for a human to expose it.</p>

<p>More broadly, if you are building something that handles sensitive or secret data, the more you can do to keep humans out of the loop, the better everything will be.</p>



<p>If you’d like to see more analysis of how key compromise happens, and the lessons we can learn from examining billions of certificates, please show your support by <a href="https://ko-fi.com/tobermorytech">buying me a refreshing beverage</a>.
Trawling CT logs is thirsty work.</p>



<p>In the interests of clarity, I feel it’s important to describe ways in which my research might be flawed.
Here are the things I know of that may have impacted the accuracy, that I couldn’t feasibly account for.</p>

<ul>
  <li>
    <p><strong>Time Periods</strong>: Because time never stops, there is likely to be some slight “mismatches” in the numbers obtained from the various data sources, because they weren’t collected at exactly the same moment.</p>
  </li>
  <li>
    <p><strong>Issuer-to-Organisation Mapping</strong>: It’s possible that the way I mapped issuers to organisations doesn’t match exactly with how crt.sh does it, meaning that counts might be skewed.
I tried to minimise that by using the same data sources (the <a href="https://www.ccadb.org/resources">CCADB AllCertificates report</a>) that I believe that crt.sh uses for its mapping, but I cannot be certain of a perfect match.</p>
  </li>
  <li>
    <p><strong>Unwarranted Grouping</strong>: I’ve drawn some conclusions about the practices of the various organisations based on their general approach to certificate issuance.
If a particular subordinate CA that I’ve grouped into the parent organisation is managed in some unusual way, that might cause my conclusions to be erroneous.
I was able to fairly easily separate out CloudFlare, AWS, and Azure, but there are almost certainly others that I didn’t spot, because hoo <em>boy</em> there are a lot of intermediate CAs out there.</p>
  </li>
</ul>


<hr/>
			
			

			</div>
		</div></div>
  </body>
</html>
