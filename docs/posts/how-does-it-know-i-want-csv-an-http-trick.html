<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://csvbase.com/blog/2">Original</a>
    <h1>How does it know I want CSV? – An HTTP trick</h1>
    
    <div id="readability-page-1" class="page"><div>
    <div>
      <div>
        
        <figure>
          <img src="https://csvbase.com/blog-static/signpost.jpg" alt="image of a signpost"/>
        </figure>
        <p>Forgotten parts of RFC2616</p>
        <p>2023-01-17</p>
        
        <p>by <a href="https://calpaterson.com">Cal Paterson</a></p>
        

        <!-- HTTP content negotiation tricks -->
<p>How come when you visit
<a href="https://csvbase.com/meripaterson/stock-exchanges">https://csvbase.com/meripaterson/stock-exchanges</a>
in a browser you get a webpage –:</p>
<p><img src="https://csvbase.com/blog-static/stock-exchanges.png" alt="screenshot of csvbase table web page"/></p>
<p>but when you <code>curl</code> the same url you get a csv file?:</p>
<p><img src="https://csvbase.com/blog-static/curl.png" alt="screenshot of csvbase table in curl"/></p>
<p>The url is the same - so how come?</p>
<p>The answer is HTTP&#39;s built-in &#34;content negotiation&#34;.</p>
<h2>How content negotiation works</h2>
<p>When an HTTP client sends any request, it sends &#34;headers&#34; with that request.
Here are the headers that Google Chrome sends:</p>
<div><pre><span></span><span>accept</span><span>:</span><span> </span><span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><span></span>
<span>accept-encoding</span><span>:</span><span> </span><span>gzip, deflate, br</span><span></span>
<span>accept-language</span><span>:</span><span> </span><span>en-GB,en-US;q=0.9,en;q=0.8</span><span></span>
<span>cache-control</span><span>:</span><span> </span><span>no-cache</span><span></span>
<span>pragma</span><span>:</span><span> </span><span>no-cache</span><span></span>
<span>sec-ch-ua</span><span>:</span><span> </span><span>&#34;Google</span><span> </span><span>Chrome&#34;</span><span>;v=&#34;105&#34;, &#34;Not)A;Brand&#34;;v=&#34;8&#34;, &#34;Chromium&#34;;v=&#34;105&#34;</span><span></span>
<span>sec-ch-ua-mobile</span><span>:</span><span> </span><span>?0</span><span></span>
<span>sec-ch-ua-platform</span><span>:</span><span> </span><span>&#34;Linux&#34;</span><span></span>
<span>sec-fetch-dest</span><span>:</span><span> </span><span>document</span><span></span>
<span>sec-fetch-mode</span><span>:</span><span> </span><span>navigate</span><span></span>
<span>sec-fetch-site</span><span>:</span><span> </span><span>none</span><span></span>
<span>sec-fetch-user</span><span>:</span><span> </span><span>?1</span><span></span>
<span>upgrade-insecure-requests</span><span>:</span><span> </span><span>1</span><span></span>
<span>user-agent</span><span>:</span><span> </span><span>Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.0.0 Safari/537.36</span><span></span>
</pre></div>
<p>That&#39;s a lot.  Only the first of these is relevant: the <code>accept</code> header:</p>
<div><pre><span></span><span>accept</span><span>:</span><span> </span><span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><span></span>
</pre></div>
<p>The <code>accept</code> header is an unordered list of preferences for what media type
(aka &#34;Content Type&#34;, or file format) the server should send.</p>
<p>Chrome is saying:</p>
<ul>
<li>
Ideally, give me:<ul>
<li><code>text/html</code> (ie: HTML)</li>
<li><code>application/xhtml+xml</code> (XHTML)</li>
<li><code>image/avif</code></li>
<li><code>image/webp</code></li>
<li>or <code>image/apng</code> (a <a href="https://en.wikipedia.org/wiki/APNG">animated version of a PNG</a>)</li>
</ul>
</li>
<li>
Otherwise (&#34;q&#34;, or quality, 0.9), give me<ul>
<li><code>application/xml</code></li>
<li>or <code>application/signed-exchange;v=b3</code></li>
</ul>
</li>
<li>
And if none of these are available (lowest priority; q=0.8):<ul>
<li>just send me anything (<code>*/*</code>)</li>
</ul>
</li>
</ul>
<p>csvbase has an HTML representation of the url being requested, which is
Chrome&#39;s joint top preference, so it just replies with that.</p>
<p>What accept header does curl send?  It sends just:</p>

<p>Much shorter.  Curl will take anything.  And csvbase has a default format:
csv, so it replies with that.</p>
<h2>&#34;Why though?&#34;, escape hatches and non-negotiables</h2>
<p>The main reason why csvbase bothers at all with this is to make it easier to
export tables.  For example, to get a table loaded into
<a href="https://en.wikipedia.org/wiki/Pandas_(software)">pandas</a>, all you have to do
is paste the url into the first argument for pandas&#39; <code>read_csv</code> - <em>the same url
as for the page</em>:</p>
<p><img src="https://csvbase.com/blog-static/pandas-content-neg.png" alt="screenshot of csvbase table in curl"/></p>
<p>This works in most tools - curl, pandas,
<a href="https://en.wikipedia.org/wiki/R_(programming_language)">R</a> and many others.
But not all.  Some, like <a href="https://en.wikipedia.org/wiki/Apache_Spark">Apache
Spark</a>, ask for HTML for some
reason.  So csvbase has an escape hatch from content negotiation — adding
a file extension:</p>
<p><a href="https://csvbase.com/meripaterson/stock-exchanges.csv">https://csvbase.com/meripaterson/stock-exchanges.<strong>csv</strong></a>
always returns csv file.</p>
<p>This escape hatch is also useful for other formats.  Media types are
controlled by the <a href="https://en.wikipedia.org/wiki/Internet_Assigned_Numbers_Authority">Internet Assigned Numbers
Authority</a>.
Not every file format has been given a media type.  For example, parquet (the
current favourite of most data scientists) doesn&#39;t have a media type.  Neither
does jsonlines.  At least not yet.</p>
<p>csvbase can output in those formats too, but there&#39;s no way to content neogiate
them - at least not until the IANA get around to officially assigning them a
media type.</p>
<p>Until then, use:
<a href="https://csvbase.com/meripaterson/stock-exchanges.parquet">https://csvbase.com/meripaterson/stock-exchanges.<strong>parquet</strong></a></p>
<p>You can even do:</p>
<div><pre><span></span><span>import</span> <span>pandas</span> <span>as</span> <span>pd</span>

<span>pd</span><span>.</span><span>read_parquet</span><span>(</span><span>&#34;https://csvbase.com/meripaterson/stock-exchanges.parquet&#34;</span><span>)</span>
</pre></div>

      </div>
    </div>
  </div></div>
  </body>
</html>
