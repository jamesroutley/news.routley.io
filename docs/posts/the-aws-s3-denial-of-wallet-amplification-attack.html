<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.limbus-medtec.com/the-aws-s3-denial-of-wallet-amplification-attack-bc5a97cc041d?gi=67ac052cc1ce">Original</a>
    <h1>The AWS S3 Denial of Wallet Amplification Attack</h1>
    
    <div id="readability-page-1" class="page"><section><div><div><div><div><div><h2 id="e3af">If you publicly host large data files on AWS S3 and pay for AWS transfer costs, you may be vulnerable to a “Denial of Wallet” amplification attack. Even if you are not hosting data publicly, you may be exposed to a malicious third-party attack or even a programming error, that can cause major costs within a short time frame.</h2><div><div><div><div><div><div><a href="https://medium.com/@ben.liesfeld" rel="noopener follow"><div><div aria-hidden="false"><div><div><p><img alt="Ben Liesfeld" src="https://miro.medium.com/v2/resize:fill:88:88/1*FyLZgd9JOES3Om5ZWhBAmA.jpeg" width="44" height="44" loading="lazy" data-testid="authorPhoto"/></p></div></div></div></div></a><a href="https://blog.limbus-medtec.com" rel="noopener  ugc nofollow"><div><div><div aria-hidden="false"><div><div><p><img alt="Limbus News" src="https://miro.medium.com/v2/resize:fill:48:48/1*IALqnjyW5pY58dTnY-zYqA.jpeg" width="24" height="24" loading="lazy" data-testid="publicationPhoto"/></p></div></div></div></div></div></a></div></div></div></div></div></div></div><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*c0IfusyKXAh3EIevlmDc-g.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*c0IfusyKXAh3EIevlmDc-g.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*c0IfusyKXAh3EIevlmDc-g.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*c0IfusyKXAh3EIevlmDc-g.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*c0IfusyKXAh3EIevlmDc-g.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*c0IfusyKXAh3EIevlmDc-g.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c0IfusyKXAh3EIevlmDc-g.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*c0IfusyKXAh3EIevlmDc-g.png 640w, https://miro.medium.com/v2/resize:fit:720/1*c0IfusyKXAh3EIevlmDc-g.png 720w, https://miro.medium.com/v2/resize:fit:750/1*c0IfusyKXAh3EIevlmDc-g.png 750w, https://miro.medium.com/v2/resize:fit:786/1*c0IfusyKXAh3EIevlmDc-g.png 786w, https://miro.medium.com/v2/resize:fit:828/1*c0IfusyKXAh3EIevlmDc-g.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*c0IfusyKXAh3EIevlmDc-g.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*c0IfusyKXAh3EIevlmDc-g.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="700" loading="eager" role="presentation"/></picture></div></div><figcaption>The way AWS meters data transfer costs may make your business vulnerable in a way you did not expect.</figcaption></figure><p id="b9ad">Cloud computing enables companies to build fast-scaling applications. This allows for new ways of analyzing data, especially in medicine or bioinformatics. But with the ease of resource scaling up and down, the way of cost control changes significantly for the cloud customers.</p><p id="a500">By design, resources are scaling in cloud environments, and this results in rising costs at the same time. Having control of the costs is a difficult job. Even though AWS offers its <a href="https://calculator.aws/" rel="noopener ugc nofollow" target="_blank">own pricing calculator</a>, it is so difficult that many companies have products to assist in cost control or cost overview, see for example “<a href="https://www.cloudzero.com/blog/aws-costs-surprise-surprise-it-shouldnt-be/" rel="noopener ugc nofollow" target="_blank">AWS Costs: Surprise, Surprise? It Shouldn’t Be!</a>”</p><p id="8a77">Because of the large variety of cloud services and their cost models, it is very important for customers that they can rely on certain assumptions. A simple assumption is that downloading of some S3 data (via the Internet) costs an amount of money that is proportional to the amount of data downloaded (<a href="https://aws.amazon.com/s3/pricing/" rel="noopener ugc nofollow" target="_blank">see S3 pricing structure</a>). With such an assumption people build software and have some rough idea about the costs a certain service may incur.</p><p id="51e4">Since cloud resources scale so easily, cloud users must take certain precautions to prevent malicious attacks that may incur unintended costs. For example, if you experience a DDoS attack on your specific application, the costs may rise significantly because your cloud resources can be configured to scale according to demand. You need to implement multiple mechanisms to prevent this. Cloud providers even create tools to reduce the attack surface (see <a href="https://docs.aws.amazon.com/whitepapers/latest/aws-best-practices-ddos-resiliency/attack-surface-reduction.html" rel="noopener ugc nofollow" target="_blank">here</a> for AWS best practices on this topic).</p><p id="c8e5">Here, we will provide a previously unknown example of a potential attack on cloud resources where the assumed costs differ significantly from the real costs. This is about how costs for AWS S3 egress (transfer into the Internet) are calculated. <strong>With a very small number of special requests, it is possible to generate costs that differ from the actually downloaded data by a factor of 50.</strong> We coined this scenario a “’Denial of Wallet’ Amplification Attack”. It is not an attack against your service but against your wallet.</p><p id="9f02">We publish this information in a blog post because we ourselves were caught unaware of this situation and we feel the need to raise awareness about this issue, as it could be exploited by malicious third parties.</p><h2 id="ea37">Data sets in health care may be large</h2><p id="6d11">In the healthcare industry, many other large companies and organizations use AWS S3 and similar cloud platforms for data storage or processing. For example, there are many public bioinformatics data repositories, also from government agencies, that provide large files on S3 publicly (e. g. <a href="https://www.ncbi.nlm.nih.gov/sra/docs/sra-cloud/" rel="noopener ugc nofollow" target="_blank">NCBI SRA</a> or <a href="https://gnomad.broadinstitute.org/downloads" rel="noopener ugc nofollow" target="_blank">gnomAD</a>). Even cloud-computing platforms of large sequencing instrument manufacturers are affected. Having cost control of data storage and data transfer is very important if your data volume is increasing that much.</p><h2 id="fbd1">Attack amplifying S3 egress costs</h2><p id="2c78">One day we experienced an anomaly of S3 egress costs. We analyzed this anomaly and found that the amount of data actually downloaded did not match the amount on our invoice. With our partners’ help, we reproduced this behavior and identified a minor bug in a bioinformatics library. It was an accident. Unfortunately, this accidental behavior could also have been ‘weaponized’ in an attack.</p><p id="fc0f">After contacting the AWS Support we were directed to the following details <a href="https://aws.amazon.com/s3/pricing/" rel="noopener ugc nofollow" target="_blank">of the S3 pricing page</a> (highlighting by us):</p><blockquote><p id="46bf">Data Transfer Out may be different from the data received by your application in case the connection is prematurely terminated by you, for example, if you make a request for a 10 GB object and terminate the connection after receiving the first 2 GB of data. <strong>Amazon S3 attempts to stop the streaming of data, but it does not happen instantaneously</strong>. In this example, the Data Transfer Out may be 3 GB (1 GB more than 2 GB you received). <strong>As a result, you will be billed for 3 GB of Data Transfer Out</strong>.</p></blockquote><p id="1e7b">Okay, this is half the explanation. AWS customers are not billed for the data actually transferred to the Internet but instead for some amount of data that is cached internally.</p><p id="a04e">The main problem is the potential difference between the amount of data received by an entity outside of AWS and the amount of data on your bill. In the example above from the AWS documentation, the difference is a factor of 1.5 (2GB sent, 3GB billed). In our real-world example, the difference was almost a factor of 50. This means 3TB sent and 130TB billed. That can make a difference between “we do not care” and “whaaat”?</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*_CGdxzIhiex6_bw_uUK-EA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*_CGdxzIhiex6_bw_uUK-EA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*_CGdxzIhiex6_bw_uUK-EA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*_CGdxzIhiex6_bw_uUK-EA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*_CGdxzIhiex6_bw_uUK-EA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*_CGdxzIhiex6_bw_uUK-EA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_CGdxzIhiex6_bw_uUK-EA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*_CGdxzIhiex6_bw_uUK-EA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*_CGdxzIhiex6_bw_uUK-EA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*_CGdxzIhiex6_bw_uUK-EA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*_CGdxzIhiex6_bw_uUK-EA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*_CGdxzIhiex6_bw_uUK-EA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*_CGdxzIhiex6_bw_uUK-EA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*_CGdxzIhiex6_bw_uUK-EA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="141" loading="lazy" role="presentation"/></picture></div></div><figcaption>A single programming error on a single machine caused a very expensive weekend. It also slightly raised the pulse of our controller.</figcaption></figure><h2 id="24b2">The extent of the problem</h2><p id="7be3">It may be even worse: we were able to reproduce the scenario where we downloaded 300MB of data in 30sec from AWS S3 and were billed for more than 6GB by AWS. If an attacker can induce costs for 6GB in 30sec how much costs can be generated in a day, or on the weekend when running many threads in parallel? Note that AWS S3 is highly available, and you may never reach any bandwidth limits in real-world scenarios. That should scare anyone who hosts large files on a public S3 bucket, because the egress costs can skyrocket in this scenario.</p><p id="e6a6">The good news: we only observed this behavior for large files (&gt;1GB), when software clients download them via HTTP(S) <a href="https://en.wikipedia.org/wiki/Byte_serving" rel="noopener ugc nofollow" target="_blank">RANGE requests</a>. With range requests, the client can request to retrieve a part of a file, but not the entire file. By quickly canceling such requests, a client can request parts of a file without downloading all the data. Due to the way AWS calculates egress costs the transfer of the entire file is billed. There may also be dependencies on access patterns and timing, but we were able to reproduce it across different buckets and files and over several weeks (so this is not a fluke).</p><p id="05d3">This means that everybody who hosts large files on S3 is at risk, especially if these files are publicly accessible.</p><h2 id="8e9d">Can I prevent this attack?</h2><p id="8bdb">Do not host large files on S3 if they can be accessed by range requests in a way that you cannot control. If you are relying on hosting large S3 data sets publicly, then you cannot prevent this attack. <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/security-best-practices.html" rel="noopener ugc nofollow" target="_blank">AWS best practice guidelines</a> recommend restricting data access to S3 buckets.</p><h2 id="be92">What does AWS recommend?</h2><p id="603b">We do not exactly know what the recommendation of AWS is for companies relying on hosting data publicly, but we did not find any official documentation that has any recommendations in that regard for files in public S3 buckets.</p><p id="a199">For example, the “<a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/security-best-practices.html" rel="noopener ugc nofollow" target="_blank">Security best practices for Amazon S3</a>” state:</p><blockquote><p id="042b">Unless you explicitly require anyone on the internet to be able to read or write to your S3 bucket, make sure that your S3 bucket is not public.</p></blockquote><p id="6116">But AWS does not say anything about those cases where you <em>do</em> need public access (at least we did not find any under the <a href="https://aws.amazon.com/architecture/storage/" rel="noopener ugc nofollow" target="_blank">AWS best practices for storage</a>).</p><p id="42e2">By the way: restricting access to your S3 buckets may not prevent you from incurring costs for unauthorized requests as <a href="http://twitter.com/maciej" rel="noopener ugc nofollow" target="_blank">@maciej</a>.pocwierz found out: <a href="https://medium.com/@maciej.pocwierz/how-an-empty-s3-bucket-can-make-your-aws-bill-explode-934a383cb8b1" rel="noopener">https://medium.com/@maciej.pocwierz/how-an-empty-s3-bucket-can-make-your-aws-bill-explode-934a383cb8b1</a>.</p><h2 id="7708">Are there workarounds to mitigate the attack?</h2><p id="16fc">Yes. As the first and most important step you should create cost alerts. We suggest to activate <a href="https://aws.amazon.com/aws-cost-management/aws-cost-anomaly-detection/" rel="noopener ugc nofollow" target="_blank">AWS Cost Anomaly Detection</a>. When activating this tool and configuring it correctly you will be informed about abnormal billing events. At least in our case, this helped us to identify such an adverse event after a short time frame limiting its financial impact.</p><p id="e559">Sadly, preventing such an attack is no easy task because of the design of AWS S3. The service is designed to serve large amounts of data as fast as possible. You could monitor HTTP API requests to your S3 buckets which is possible with a delay of a few hours. If you see an unusually high amount of API requests, you could prohibit access to the resource. But this solution is a brutal last resort, potentially disrupting your service entirely.</p><h2 id="41bb">So, if I’m not hosting public S3 files I’m safe?</h2><p id="0628">Unfortunately, no, as we observed a similar behavior when serving S3 files via pre-signed URLs, for example.</p><p id="2538">We thank <a href="https://twitter.com/Stephan_HolgerD" rel="noopener ugc nofollow" target="_blank">Stephan Drukewitz</a> from the Institute for Human Genetics, Leipzig, for his help in troubleshooting the issue. Also thanks to Martin Garbe and Roland Ewald who substantially researched and authored this article.</p><p id="9847">We thank the AWS Security team for their feedback on earlier drafts of this post.</p></div></div></div></div></section></div>
  </body>
</html>
