<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://registerspill.thorstenball.com/p/which-command-did-you-run-1731-days">Original</a>
    <h1>Keeping a long shell history</h1>
    
    <div id="readability-page-1" class="page"><div><div><article><div class=""><div><div dir="auto"><blockquote><p><em>Professor Henry Jones</em><span>: Well, he who finds the Grail must face the final challenge.</span></p><p><em>Indiana Jones</em><span>: What final challenge?</span></p><p><em>Professor Henry Jones</em><span>: Three devices of such lethal cunning.</span></p><p><em>Indiana Jones</em><span>: Booby traps?</span></p><p><em>Professor Henry Jones</em><span>: Oh, yes. But I found the clues that will safely take us through them in the Chronicles of St. Anselm.</span></p><p><em>Indiana Jones</em><span>: [pleased] Well, what are they?</span></p><p>[short pause as Henry tries to recall]</p><p><em>Indiana Jones</em><span>: Can’t you remember?</span></p><p><em>Professor Henry Jones</em><span>: I wrote them down in my diary so that I wouldn’t </span><em>have</em><span> to remember.</span></p></blockquote><p><span>                </span><strong>***</strong></p><p>Recipe for living a good life in the shell:</p><ol><li><p>Make sure it’s fast.</p></li><li><p>Make sure its history can grow nearly infinitely and you can fuzzy-search through it.</p></li></ol><p><span>The first one–fast shells–</span><a href="https://registerspill.thorstenball.com/p/how-fast-is-your-shell" rel="">we talked about last week</a><span>, so this time, let’s talk about shell history.</span></p><p><span>On one of my machines the </span><code>~/.zsh_history</code><span> file contains 26278 commands. Its oldest entry was recorded on April 25, 2019. When I hit </span><code>Ctrl-r</code><span> in ZSH </span><a href="https://github.com/junegunn/fzf" rel="">fzf</a><span> pops up and lets me fuzzy-search through all 26278 commands, through the last 5 years of my shell history. It’s glorious.</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F01532c09-5727-4ac5-8536-e20522bb90d4_800x518.gif" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F01532c09-5727-4ac5-8536-e20522bb90d4_800x518.gif 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F01532c09-5727-4ac5-8536-e20522bb90d4_800x518.gif 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F01532c09-5727-4ac5-8536-e20522bb90d4_800x518.gif 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F01532c09-5727-4ac5-8536-e20522bb90d4_800x518.gif 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F01532c09-5727-4ac5-8536-e20522bb90d4_800x518.gif" width="800" height="518" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/01532c09-5727-4ac5-8536-e20522bb90d4_800x518.gif&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:518,&#34;width&#34;:800,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:2388737,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/gif&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:false,&#34;topImage&#34;:true,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F01532c09-5727-4ac5-8536-e20522bb90d4_800x518.gif 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F01532c09-5727-4ac5-8536-e20522bb90d4_800x518.gif 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F01532c09-5727-4ac5-8536-e20522bb90d4_800x518.gif 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F01532c09-5727-4ac5-8536-e20522bb90d4_800x518.gif 1456w" sizes="100vw" fetchpriority="high"/></picture></div></a></figure></div><p><span>That one </span><code>curl</code><span> command with these four strange HTTP headers that I had to send to make sure I could talk to my local dev env correctly through the reverse-proxy – that’s in there, a few keystrokes and some hazy memories away. That one </span><code>rsync</code><span> that uses the correct SSH client binary on the other side and that preserves timestamps and permission – also in there. The ugly bastard of a command that combined </span><code>git grep</code><span> with </span><code>find</code><span> and 8 ugly incantations of AWK chained together – locked in there too. The test command I ran yesterday is as reachable as the one command with 12 </span><code>&amp;&amp;</code><span> in it that I ran 3 years ago, all thanks to a long shell history file.</span></p><p><span>Truly: </span><code>~/.zsh_history</code><span> is one of the most important files on my machine. I make use of it tens of times every day, whenever I hit </span><code>Ctrl-r</code><span>. If I wasn’t such a doofus it would contain even more than 26278 commands, because I’ve been keeping a long shell history for nearly a decade. But since I </span><em>am</em><span> such a doofus, I forgot to back it up (or deleted the backup too early) a few times and hence the </span><code>~/.zsh_history</code><span> on the machine I’m typing this only contains 1034 commands.</span></p><p>Someone might say: “well, if the command was that important, why don’t you save it to a script?” And to that I say: look, man, if I knew in advance which command would turn out to be important, then we wouldn’t be here, because I’d already have ascended to the astral realm.</p><p><span>Also: why </span><em>would</em><span> I record it in a script if I can just configure my shell to keep track of all of those commands for me? It’s cheap, it’s fast, there’s essentially no downsides to it: the largest </span><code>~/.zsh_history</code><span> I have is 2MB and I can fuzzy-search through it in </span><em>milliseconds</em><span>.</span></p><p><span>                </span><strong>***</strong></p><p>So, to repeat: your shell – ZSH, Bash, Fish, or others – can record every command you execute in it and I’m begging you to make sure it is configured to do that.</p><p><span>Make sure it keeps track of </span><em>a lot</em><span> of commands. So many commands that when you put the number in your rc-file you think: that’s ridiculous, why would I need to record that many commands? Double that number. As the next and final step you need to get a fuzzy-finder fuzzy-finder to search through it.</span></p><p><span>Here’s </span><a href="https://github.com/mrnugget/dotfiles/blob/2bdf21b659cbf34f21a0716bfac1f90914426a87/zshrc#L18-L35" rel="">the ZSH configuration</a><span> I used for many, many years:</span></p><pre><code><code>##########
# HISTORY
##########

HISTFILE=$HOME/.zsh_history
HISTSIZE=50000
SAVEHIST=50000

# Immediately append to history file:
setopt INC_APPEND_HISTORY

# Record timestamp in history:
setopt EXTENDED_HISTORY

# Expire duplicate entries first when trimming history:
setopt HIST_EXPIRE_DUPS_FIRST

# Dont record an entry that was just recorded again:
setopt HIST_IGNORE_DUPS

# Delete old recorded entry if new entry is a duplicate:
setopt HIST_IGNORE_ALL_DUPS

# Do not display a line previously found:
setopt HIST_FIND_NO_DUPS

# Dont record an entry starting with a space:
setopt HIST_IGNORE_SPACE

# Dont write duplicate entries in the history file:
setopt HIST_SAVE_NO_DUPS

# Share history between all sessions:
setopt SHARE_HISTORY

# Execute commands using history (e.g.: using !$) immediatel:
unsetopt HIST_VERIFY
</code></code></pre><p><span>That was combined with </span><a href="https://github.com/junegunn/fzf" rel="">fzf</a><span> to fuzzy-search through the history on </span><code>ctrl-r</code><span>.</span></p><p>Configure your shell roughly like that and there you are: living the good shell life.</p><p><span>Or you can use </span><a href="https://github.com/atuinsh/atuin" rel="">Atuin</a><span>, which I’ve been trying out for the last few weeks and have come to love. It’s a drop-in enhancement of your shell’s history functionality and not only gives you everything I described above – incredibly long shell history and fuzzy-search through it – but also syncing and backup (yup, need that) of shell history across multiple machines, filtering commands by machine, working-directory-specific history and probably 13 other things I forgot. It’s </span><em>very</em><span> nice. Highly recommend it.</span></p><p>Whatever you use: make sure your shell history is recorded, make sure your shell history can grow ridiculously long, and get a fuzzy-search for it.</p></div></div></div></article></div></div></div>
  </body>
</html>
