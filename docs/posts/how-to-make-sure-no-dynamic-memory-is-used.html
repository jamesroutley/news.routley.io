<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mcuoneclipse.com/2022/11/06/how-to-make-sure-no-dynamic-memory-is-used/">Original</a>
    <h1>How to make sure no dynamic memory is used</h1>
    
    <div id="readability-page-1" class="page"><div>
		
<p>In many embedded applications, it is mandatory that memory allocation is static and not dynamic. Means that no calls to things like malloc() or free() shall be used in the application, because they might fail at runtime (out of memory, heap fragmentation).</p>



<figure><a href="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack-allocation-in-linker-file.jpg"><img data-attachment-id="36019" data-permalink="https://mcuoneclipse.com/2022/11/06/how-to-make-sure-no-dynamic-memory-is-used/heap-and-stack-allocation-in-linker-file/" data-orig-file="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack-allocation-in-linker-file.jpg" data-orig-size="658,651" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="heap-and-stack-allocation-in-linker-file" data-image-description="" data-image-caption="" data-medium-file="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack-allocation-in-linker-file.jpg?w=300" data-large-file="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack-allocation-in-linker-file.jpg?w=584" src="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack-allocation-in-linker-file.jpg?w=658" alt="" srcset="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack-allocation-in-linker-file.jpg 658w, https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack-allocation-in-linker-file.jpg?w=150 150w, https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack-allocation-in-linker-file.jpg?w=300 300w" sizes="(max-width: 658px) 100vw, 658px"/></a></figure>



<p>But when linking with 3rd party libraries or even with the C/C++ standard libraries, how to ensure no dynamic memory is used? The problem can occur as well for C++ objects, or a simple call to <a href="https://mcuoneclipse.com/2013/04/19/why-i-dont-like-printf/">printf()</a> which internally requires some dynamic memory allocated.</p>



<h2>Zero Heap Size?</h2>



<p>An easy (and rather naive) approach is to set the heap size to zero. Most linker script or linker environments have the ability to set the heap size to zero, as below:</p>



<figure><a href="https://mcuoneclipse.files.wordpress.com/2022/11/heap-size-to-zero.jpg"><img data-attachment-id="36011" data-permalink="https://mcuoneclipse.com/2022/11/06/how-to-make-sure-no-dynamic-memory-is-used/heap-size-to-zero/" data-orig-file="https://mcuoneclipse.files.wordpress.com/2022/11/heap-size-to-zero.jpg" data-orig-size="911,770" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="heap-size-to-zero" data-image-description="" data-image-caption="" data-medium-file="https://mcuoneclipse.files.wordpress.com/2022/11/heap-size-to-zero.jpg?w=300" data-large-file="https://mcuoneclipse.files.wordpress.com/2022/11/heap-size-to-zero.jpg?w=584" src="https://mcuoneclipse.files.wordpress.com/2022/11/heap-size-to-zero.jpg?w=911" alt="" srcset="https://mcuoneclipse.files.wordpress.com/2022/11/heap-size-to-zero.jpg 911w, https://mcuoneclipse.files.wordpress.com/2022/11/heap-size-to-zero.jpg?w=150 150w, https://mcuoneclipse.files.wordpress.com/2022/11/heap-size-to-zero.jpg?w=300 300w, https://mcuoneclipse.files.wordpress.com/2022/11/heap-size-to-zero.jpg?w=768 768w" sizes="(max-width: 911px) 100vw, 911px"/></a></figure>



<p>However, this won’t help, as most linker scripts just uses the free space between the stack space and the variables (bss): So setting the heap size to zero just assumes a zero reservation, but the _sbrk() of the library will continue to use dynamic memory, potentially crashing into the stack space.</p>



<figure><a href="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack.jpg"><img data-attachment-id="36014" data-permalink="https://mcuoneclipse.com/2022/11/06/how-to-make-sure-no-dynamic-memory-is-used/heap-and-stack-2/" data-orig-file="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack.jpg" data-orig-size="665,520" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="heap-and-stack" data-image-description="" data-image-caption="" data-medium-file="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack.jpg?w=300" data-large-file="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack.jpg?w=584" src="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack.jpg?w=665" alt="" srcset="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack.jpg 665w, https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack.jpg?w=150 150w, https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack.jpg?w=300 300w" sizes="(max-width: 665px) 100vw, 665px"/></a></figure>



<p>Bottom line: with most linker scripts heap size set to zero will not help anything. It even increases the chances that the heap will crash into the stack as the linker assumes zero usage of heap. But it won’t prevent that the heap is used.</p>



<h2>Heap in Linker File</h2>



<p>This can be seen from the linker file shown below:</p>



<figure><a href="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack-allocation-in-linker-file.jpg"><img data-attachment-id="36019" data-permalink="https://mcuoneclipse.com/2022/11/06/how-to-make-sure-no-dynamic-memory-is-used/heap-and-stack-allocation-in-linker-file/" data-orig-file="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack-allocation-in-linker-file.jpg" data-orig-size="658,651" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="heap-and-stack-allocation-in-linker-file" data-image-description="" data-image-caption="" data-medium-file="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack-allocation-in-linker-file.jpg?w=300" data-large-file="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack-allocation-in-linker-file.jpg?w=584" src="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack-allocation-in-linker-file.jpg?w=658" alt="" srcset="https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack-allocation-in-linker-file.jpg 658w, https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack-allocation-in-linker-file.jpg?w=150 150w, https://mcuoneclipse.files.wordpress.com/2022/11/heap-and-stack-allocation-in-linker-file.jpg?w=300 300w" sizes="(max-width: 658px) 100vw, 658px"/></a></figure>



<p>To make sure that no heap is used, the easiest way is to simply remove the .heap allocation in above linker file. Check your linker file for ‘heap’ or something similar, and make sure no memory is allocated for it. Especially make sure that no symbol ‘<strong>__prvHeapStart</strong>‘ or ‘<strong>__prvHeapLimit</strong>‘ is used, as they usually are required by the newlib/newlib-nano library dynamic memory allocation.</p>



<h2>Linker FreeMarker Scripts</h2>



<p>Some environments like the NXP MCUXpresso IDE is using an automatic generation of linker files. But it is easy to deal with this, if you know about the <a href="https://mcuoneclipse.com/2019/10/06/linking-bootloader-applications-with-eclipse-and-freemarker-scripts/">FreeMarker </a>Scripts used by this. The Scripts are located in</p>



<pre>&lt;MCUXpresso IDE Installation Path&gt;\ide\Wizards\linker</pre>



<p>So I can easily disable the .heap using my modified FreeMarker Script:</p>



<figure><a href="https://mcuoneclipse.files.wordpress.com/2022/11/disabled-.heap-in-linker-script-file.jpg"><img data-attachment-id="36025" data-permalink="https://mcuoneclipse.com/2022/11/06/how-to-make-sure-no-dynamic-memory-is-used/disabled-heap-in-linker-script-file/" data-orig-file="https://mcuoneclipse.files.wordpress.com/2022/11/disabled-.heap-in-linker-script-file.jpg" data-orig-size="1663,1093" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="disabled-.heap-in-linker-script-file" data-image-description="" data-image-caption="" data-medium-file="https://mcuoneclipse.files.wordpress.com/2022/11/disabled-.heap-in-linker-script-file.jpg?w=300" data-large-file="https://mcuoneclipse.files.wordpress.com/2022/11/disabled-.heap-in-linker-script-file.jpg?w=584" src="https://mcuoneclipse.files.wordpress.com/2022/11/disabled-.heap-in-linker-script-file.jpg?w=1024" alt="" srcset="https://mcuoneclipse.files.wordpress.com/2022/11/disabled-.heap-in-linker-script-file.jpg?w=1024 1024w, https://mcuoneclipse.files.wordpress.com/2022/11/disabled-.heap-in-linker-script-file.jpg?w=150 150w, https://mcuoneclipse.files.wordpress.com/2022/11/disabled-.heap-in-linker-script-file.jpg?w=300 300w, https://mcuoneclipse.files.wordpress.com/2022/11/disabled-.heap-in-linker-script-file.jpg?w=768 768w, https://mcuoneclipse.files.wordpress.com/2022/11/disabled-.heap-in-linker-script-file.jpg 1663w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<h2>__sbrk()</h2>



<p>With the heap and its symbols removed, any usage of <strong>malloc()</strong> should give a linker error, similar to this one:</p>



<pre>Invoking: MCU Linker
arm-none-eabi-gcc -nostdlib -Xlinker -Map=&#34;AEMBS_tinyK22_HS22.map&#34; -Xlinker --gc-sections -Xlinker -print-memory-usage -Xlinker --sort-section=alignment -Xlinker --cref -mcpu=cortex-m4 -mfpu=fpv4-sp-d16 -mfloat-abi=hard -mthumb -T &#34;AEMBS_tinyK22_HS22_Debug.ld&#34; -o &#34;AEMBS_tinyK22_HS22.axf&#34; ./utilities/fsl_assert.o ...  ./McuLib/FreeRTOS/FreeRTOShooks.o   
arm-none-eabi/bin/ld.exe: arm-none-eabi/lib/thumb/v7e-m+fp/hard\libcr_newlib_semihost.a(_cr_sbrk.o): in function `_sbrk&#39;:
_cr_sbrk.c:(.text._sbrk+0x38): undefined reference to `_pvHeapStart&#39;</pre>



<p>Good!</p>



<h2>Linker Cross Reference</h2>



<p>In case it is not clear what is using memory allocation or causing the error, the linker cross reference can be used. For this the GNU linker <strong>–cref </strong>option has to be added to the linker options:</p>



<figure><a href="https://mcuoneclipse.files.wordpress.com/2022/11/cref-linker-option.jpg"><img data-attachment-id="36030" data-permalink="https://mcuoneclipse.com/2022/11/06/how-to-make-sure-no-dynamic-memory-is-used/cref-linker-option/" data-orig-file="https://mcuoneclipse.files.wordpress.com/2022/11/cref-linker-option.jpg" data-orig-size="627,477" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="cref-linker-option" data-image-description="" data-image-caption="" data-medium-file="https://mcuoneclipse.files.wordpress.com/2022/11/cref-linker-option.jpg?w=300" data-large-file="https://mcuoneclipse.files.wordpress.com/2022/11/cref-linker-option.jpg?w=584" src="https://mcuoneclipse.files.wordpress.com/2022/11/cref-linker-option.jpg?w=627" alt="" srcset="https://mcuoneclipse.files.wordpress.com/2022/11/cref-linker-option.jpg 627w, https://mcuoneclipse.files.wordpress.com/2022/11/cref-linker-option.jpg?w=150 150w, https://mcuoneclipse.files.wordpress.com/2022/11/cref-linker-option.jpg?w=300 300w" sizes="(max-width: 627px) 100vw, 627px"/></a></figure>



<p>This generates an information like below in the linker .map file:</p>



<pre>Cross Reference Table

Symbol                                            File
ADC0_DriverIRQHandler                             ./startup/startup_mk22f51212.o
ADC0_IRQHandler                                   ./startup/startup_mk22f51212.o
ADC16_ClearStatusFlags                            ./drivers/fsl_adc16.o
ADC16_Deinit                                      ./drivers/fsl_adc16.o
...
main                                              ./source/main.o
                                                  ./startup/startup_mk22f51212.o
malloc                                            arm-none-eabi/lib/thumb/v7e-m+fp/hard\libc_nano.a(lib_a-malloc.o)
                                                  arm-none-eabi/lib/thumb/v7e-m+fp/hard\libc_nano.a(lib_a-rand.o)
                                                  ./drivers/fsl_common.o
mcgConfig_BOARD_BootClockRUN                      ./board/clock_config.o
</pre>



<p>This gives a list of modules which are using things like malloc().</p>



<h2>Image Information</h2>



<p>Another way to find out the dependencies is using the ‘Image Information’ view in Eclipse/MCUXpresso, see <a href="https://mcuoneclipse.com/2020/01/10/listing-code-and-data-size-for-all-files-with-the-gnu-size-utility-as-post-build/">Listing Code and Data Size for all Files with the GNU size Utility in a Post-Build Action</a>:</p>



<figure><a href="https://mcuoneclipse.files.wordpress.com/2022/11/hidden-usage-of-malloc.jpg"><img data-attachment-id="36021" data-permalink="https://mcuoneclipse.com/2022/11/06/how-to-make-sure-no-dynamic-memory-is-used/hidden-usage-of-malloc/" data-orig-file="https://mcuoneclipse.files.wordpress.com/2022/11/hidden-usage-of-malloc.jpg" data-orig-size="813,535" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="hidden-usage-of-malloc" data-image-description="" data-image-caption="" data-medium-file="https://mcuoneclipse.files.wordpress.com/2022/11/hidden-usage-of-malloc.jpg?w=300" data-large-file="https://mcuoneclipse.files.wordpress.com/2022/11/hidden-usage-of-malloc.jpg?w=584" src="https://mcuoneclipse.files.wordpress.com/2022/11/hidden-usage-of-malloc.jpg?w=813" alt="" srcset="https://mcuoneclipse.files.wordpress.com/2022/11/hidden-usage-of-malloc.jpg 813w, https://mcuoneclipse.files.wordpress.com/2022/11/hidden-usage-of-malloc.jpg?w=150 150w, https://mcuoneclipse.files.wordpress.com/2022/11/hidden-usage-of-malloc.jpg?w=300 300w, https://mcuoneclipse.files.wordpress.com/2022/11/hidden-usage-of-malloc.jpg?w=768 768w" sizes="(max-width: 813px) 100vw, 813px"/></a></figure>







<h2>FreeRTOS static memory allocation</h2>



<p>More on a side-note: FreeRTOS by default is using its own dynamic heap allocation. But it is possible to run the RTOS in a static way (no dynamic memory allocation), see <a href="https://mcuoneclipse.com/2016/05/29/freertos-v9-0-0-with-static-memory-allocation/">FreeRTOS V9.0.0 with Static Memory Allocation</a>.</p>



<h2>Summary</h2>



<p>Dynamic memory allocation and usage is not desired in many applications. To prevent usage of malloc() and free(), it is best to remove any heap definition in the linker file, to cause a linker error. Then the GNU linker cross reference table or the image information can be very useful.</p>



<p>Happy linking 🙂</p>



<h3>Links</h3>



<ul>
<li>Example using FreeMarker Scripts: <a href="https://mcuoneclipse.com/2017/08/29/tutorial-porting-blenrf-kinetis-design-studio-project-to-mcuxpresso-ide/">Tutorial: Porting BLE+NRF Kinetis Design Studio Project to MCUXpresso IDE</a></li>



<li>Bootloader with FreeMarker Scripts: <a href="https://mcuoneclipse.com/2019/10/06/linking-bootloader-applications-with-eclipse-and-freemarker-scripts/">Linking Bootloader Applications with Eclipse and FreeMarker Scripts</a></li>



<li>FreeMarker scripts: <a href="https://freemarker.apache.org/">https://freemarker.apache.org/</a></li>
</ul>
			
			
						</div></div>
  </body>
</html>
