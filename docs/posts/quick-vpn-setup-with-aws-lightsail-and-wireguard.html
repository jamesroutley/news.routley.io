<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mcoliver.substack.com/p/quick-vpn-setup-with-aws-lightsail">Original</a>
    <h1>Quick VPN Setup with AWS Lightsail and WireGuard</h1>
    
    <div id="readability-page-1" class="page"><div><div><article><div class=""><div><div dir="auto"><p>When consumer VPN’s hit the mainstream 8-10 years ago (I’m talking about things like Mulvad/Nord/etc..) it amazed me how many people (including some smart people I know and work with) jumped on the bandwagon because they didn’t want their ISP spying on their traffic.  When I asked them why they felt the anonymous VPN operator was more trustworthy than a regulated ISP in the United States the response was usually a long pause; They had not considered that it was possible for the VPN operator to do the exact same thing.  Anyways, I digress.</p><p><span>So let’s say you want to tunnel traffic through another country to test your service or hide your traffic through another server for some other reason.  I’m assuming you’re doing legal things here and not going to get into the more rigorous details of OPSEC, dns leakage, or chained connections.  I’m also not going to talk about alternatives like leveraging proxy servers via things like </span><a href="https://github.com/shadowsocks" rel="nofollow ugc noopener">Shadowsocks</a><span> or reverse ssh tunnels.  It can get complex quick and everything is tradeoffs.</span></p><p>You need two things.  A remote server and a wireguard connection.</p><p><span>AWS has a service called </span><a href="https://aws.amazon.com/lightsail/" rel="nofollow ugc noopener">Lightsail</a><span>.  It is a quick and easy way to stand up a server without some of the complexities (and options) that EC2 provides.  Similar services are offered by the big cloud providers like Google’s GCP or Micrsoft’s Azure and a bunch of other platforms like </span><a href="https://www.digitalocean.com/" rel="nofollow ugc noopener">DigitalOcean</a><span>, </span><a href="https://www.linode.com/" rel="nofollow ugc noopener">Linode</a><span>, </span><a href="https://www.vultr.com/" rel="nofollow ugc noopener">Vultr</a><span>, </span><a href="https://www.hetzner.com/" rel="nofollow ugc noopener">Hetzner</a><span>, </span><a href="https://ovhcloud.com/" rel="nofollow ugc noopener">OVH</a><span>, and </span><a href="https://www.scaleway.com" rel="nofollow ugc noopener">Scaleway</a><span>.  Which one you use is up to you and involves lots of tradeoffs that are beyond the scope of this article.</span></p><p><a href="https://www.wireguard.com/" rel="nofollow ugc noopener">Wireguard</a><span> has been around for a few years now but is still relatively “new” to a lot of people.  I heard about it back in 2018 and remember the awe at how quickly the connection established and how performant it was with limited resources.  Way better than the </span><a href="https://en.wikipedia.org/wiki/IPsec" rel="nofollow ugc noopener">IPSec</a><span> / L2TP stuff I had been using. </span><a href="https://lists.zx2c4.com/pipermail/wireguard/2020-January/004906.html" rel="nofollow ugc noopener">Linus finally picked it up</a><span> back in early 2020 and since then adoption has been slowly happening with teams like </span><a href="https://tailscale.com/" rel="nofollow ugc noopener">Tailscale</a><span> leading the way and layering in user friendly authentication/authorization that the wireguard protocol natively lacks.  </span><a href="https://pritunl.com/" rel="nofollow ugc noopener">Pritunl</a><span> and </span><a href="https://www.zerotier.com/" rel="nofollow ugc noopener">Zerotier</a><span> have also added support and it powers </span><a href="https://blog.cloudflare.com/1111-warp-better-vpn/" rel="nofollow ugc noopener">Cloudflare’s WARP</a><span>.  </span></p><blockquote><p><strong>Sidebar</strong><span> - I was working at Netflix in 2019/2020 and got pinged for some help with a previsualization team on one of our partner managed shows that wanted to do </span><a href="https://www.youtube.com/watch?v=eoobmFHjaBE" rel="nofollow ugc noopener">remote multiuser editing</a><span>.  Partner managed means they make the movie and send it to Netflix which puts it on the service. So we didn’t usually get involved in the project execution, but I was part of a specialized group of which a small part of our remit was sort of like the A team.  Come in, solve problems others can’t, and leave.  It wasn’t exactly within my job description (I was leading and growing a engineering team building out the infrastructure for the then nascent Animation Studio) but I had done this stuff before, enjoy challenges and I love helping people.  </span></p><p><span>I set them up with </span><a href="https://tailscale.com/" rel="nofollow ugc noopener">Tailscale</a><span> (who was brand new on the scene) and gave them a script </span><a href="https://github.com/mcoliver/wireguardvpn/blob/main/unrealMultiUser.sh" rel="nofollow ugc noopener">similar to this one</a><span> to run in their own AWS account to run Unreal’s MultiUserEditing server on Linux.  I shared it with Epic which resulted in some </span><a href="https://beforesandafters.com/2020/07/09/keeping-production-going-remotely/" rel="nofollow ugc noopener">uncredited press</a><span> and sharing of my </span><a href="https://cdn2.unrealengine.com/unreal-engine-multi-user-cloud-setup-360515954.pdf" rel="nofollow ugc noopener">guide/code</a><span> on how to set it up.  The folks at Tailscale though it was a pretty interesting use case and I knew from our initial meetings their product had a very high chance of long term success.</span></p></blockquote><p><span>There are a lot of tutorials out there on this stuff but I’m going to assume you know your way around a terminal and are fairly experienced.  So here’s are the basic steps and some code I cobbled together (</span><a href="https://github.com/mcoliver/wireguardvpn" rel="nofollow ugc noopener">github repo here</a><span>)</span></p><p><strong>Requirements</strong></p><ul><li><p><span>Have an AWS Account, installed the </span><a href="https://aws.amazon.com/cli/" rel="nofollow ugc noopener">aws cli</a><span> and </span><a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html" rel="nofollow ugc noopener">configured</a><span> it with auth credentials.</span></p></li><li><p>Generate a pub/private keypair</p></li></ul><p><span>Download the </span><a href="https://www.wireguard.com/install/" rel="nofollow ugc noopener">wireguard client</a><span> and configure a new Tunnel.  You will need the public key to copy to the server you setup in the next step.  And you will need to swap out the server pub key and ip:port with your servers once it is setup.</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd53c054b-9275-45a9-a612-def3c7e26f5d_1176x938.png" data-component-name="Image2ToDOM" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd53c054b-9275-45a9-a612-def3c7e26f5d_1176x938.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd53c054b-9275-45a9-a612-def3c7e26f5d_1176x938.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd53c054b-9275-45a9-a612-def3c7e26f5d_1176x938.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd53c054b-9275-45a9-a612-def3c7e26f5d_1176x938.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd53c054b-9275-45a9-a612-def3c7e26f5d_1176x938.png" width="624" height="497.7142857142857" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/d53c054b-9275-45a9-a612-def3c7e26f5d_1176x938.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:938,&#34;width&#34;:1176,&#34;resizeWidth&#34;:624,&#34;bytes&#34;:114508,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd53c054b-9275-45a9-a612-def3c7e26f5d_1176x938.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd53c054b-9275-45a9-a612-def3c7e26f5d_1176x938.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd53c054b-9275-45a9-a612-def3c7e26f5d_1176x938.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd53c054b-9275-45a9-a612-def3c7e26f5d_1176x938.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a></figure></div><pre><code>#!/bin/zsh
KEYPAIRFILE=&#39;~/.ssh/id_rsa.pub&#39;
KEYPAIRNAME=$(basename -s &#39;.pub&#39; ${KEYPAIRFILE})
MACHINENAME=&#39;wg001&#39;
OS=&#39;ubuntu_22_04&#39;
PORT=&#39;41194&#39;
REGION=&#39;ap-south-1&#39;

# upload keypair
aws lightsail import-key-pair \
    --region ${REGION} \
    --key-pair-name ${KEYPAIRNAME} \
    --public-key-base64 $(base64 -i ${KEYPAIRFILE})

# Get the cheapest bundle
CHEAPBUNDLE=$(echo `aws lightsail get-bundles --query &#39;bundles[0].bundleId&#39; --region ${REGION} --output text` | tr -d &#39;&#34;&#39;)

# Create the instance
aws lightsail create-instances \
    --instance-names ${MACHINENAME} \
    --availability-zone  &#34;${REGION}&#34; \
    --blueprint-id ${OS} \
    --bundle-id ${CHEAPBUNDLE} \
    --key-pair-name ${KEYPAIRNAME}

# Wait a minute then grab the IP
EXTERNALIP=$(aws lightsail get-instance-access-details --instance-name ${MACHINENAME} --query &#39;accessDetails.ipAddress&#39; --output text)

# Configure Lightsail Firewall.
# Can also use `open-instance-public-ports --port-info` if you want to add to the rules not remove the defaults
aws lightsail put-instance-public-ports \
    --instance-name ${MACHINENAME} \
    --region ${REGION} \
    --port-infos &#39;[{&#34;fromPort&#34;: 41194, &#34;toPort&#34;: 41194, &#34;protocol&#34;: &#34;udp&#34;}, {&#34;fromPort&#34;: 22, &#34;toPort&#34;: 22, &#34;protocol&#34;: &#34;tcp&#34;}]&#39;

# Print out the IP so we can ssh to it
echo $EXTERNALIP</code></pre><ul><li><p>make sure to copy over your public key from your client into the server’s Peer config section.  </p></li><li><p>You’ll also need to grab the servers publickey to copy into your local clients config.</p></li></ul><pre><code>#!/bin/zsh
# ssh and configure wireguard
ssh ubuntu@$EXTERNALIP
sudo apt update -y &amp;&amp; sudo apt install wireguard -y

sudo -i
mkdir -m 0700 /etc/wireguard/
cd /etc/wireguard/
umask 077; wg genkey | tee privatekey | wg pubkey &gt; publickey

#You will need the public key for your client setup
cat publickey

ETHINT=&#34;eth0&#34;
SRVRIP=&#34;10.99.99.1&#34;
ALLOWEDIPS=&#34;10.99.99.0/24&#34;
PEERPUBKEY=&#39;GET THIS FROM YOUR WIREGUARD CLIENT&#39;

tee  /etc/wireguard/wg0.conf &lt;&lt;EOF
[Interface]
Address = $SRVRIP/24
ListenPort = 41194
PrivateKey = $(cat privatekey)
PostUp = iptables -t nat -A POSTROUTING -o $ETHINT -j MASQUERADE; ip6tables -t nat -A POSTROUTING -o $ETHINT -j MASQUERADE
PostDown = iptables -t nat -D POSTROUTING -o $ETHINT -j MASQUERADE; ip6tables -t nat -D POSTROUTING -o $ETHINT -j MASQUERADE

[Peer]
PublicKey = $PEERPUBKEY
AllowedIPs = $ALLOWEDIPS
EOF

ufw allow 41194/udp
ufw status
echo &#39;net.ipv4.ip_forward=1&#39; | sudo tee -a /etc/sysctl.d/10-wireguard.conf
echo &#39;net.ipv6.conf.all.forwarding=1&#39; | sudo tee -a /etc/sysctl.d/10-wireguard.conf
sysctl -p /etc/sysctl.d/10-wireguard.conf
systemctl enable wg-quick@wg0
systemctl start wg-quick@wg0
systemctl status wg-quick@wg0
wg
ip a show wg0</code></pre><p>Bring your local connection up and you should have a full tunnel wireguard server tunneling your traffic through a different part of the world.</p><p>While the bundle I selected as part of the Lightsail setup was the cheapest (~$5 a month) you only get charged when it’s running.  So don’t forget to stop it or delete it.  May only cost you a few cents per month ($5/720 = $0.007/hr)</p><pre><code>aws lightsail delete-instance --region ${REGION} --instance-name ${MACHINENAME}

aws lightsail stop-instance --region ${REGION} --instance-name ${MACHINENAME}</code></pre><p>Obviously I glossed over a lot of things here.  Like maybe move the port to a less common one than 41194.  Or maybe add a firewall rule to only allow traffic from your IP.  And of course make sure your pub/private keys have a passphrase.  And a whole lot of other stuff.  Or streamlining it all into some local commands that do it all automagically on the fly by piping values around between the various scripts.  But hopefully it’s a good skeleton to launch from.  Happy VPN’ing.</p><p><span>Did this help you?  Subscribe, Share, and/or </span><a href="https://www.buymeacoffee.com/mcoliver" rel="nofollow ugc noopener">buy me a coffee</a></p><div><figure><a target="_blank" href="https://www.buymeacoffee.com/mcoliver" data-component-name="Image2ToDOM" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F397082c6-cda7-4888-a3c8-2d9297bc22bd_545x153.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F397082c6-cda7-4888-a3c8-2d9297bc22bd_545x153.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F397082c6-cda7-4888-a3c8-2d9297bc22bd_545x153.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F397082c6-cda7-4888-a3c8-2d9297bc22bd_545x153.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F397082c6-cda7-4888-a3c8-2d9297bc22bd_545x153.png" width="167" height="46.88256880733945" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/397082c6-cda7-4888-a3c8-2d9297bc22bd_545x153.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:153,&#34;width&#34;:545,&#34;resizeWidth&#34;:167,&#34;bytes&#34;:4691,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:&#34;https://www.buymeacoffee.com/mcoliver&#34;,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F397082c6-cda7-4888-a3c8-2d9297bc22bd_545x153.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F397082c6-cda7-4888-a3c8-2d9297bc22bd_545x153.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F397082c6-cda7-4888-a3c8-2d9297bc22bd_545x153.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F397082c6-cda7-4888-a3c8-2d9297bc22bd_545x153.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a></figure></div></div></div></div></article></div></div></div>
  </body>
</html>
