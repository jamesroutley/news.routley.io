<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.ellenhp.me/host-a-planet-scale-geocoder-for-10-month">Original</a>
    <h1>Show HN: Host a planet-scale geocoder for $10/mo</h1>
    
    <div id="readability-page-1" class="page"><article id="post-body"><time datetime="2024-02-16T05:32:34Z" pubdate="" itemprop="datePublished" content="2024-02-16 05:32:34 +0000 UTC">February 16, 2024</time><div><p>About a month ago I began work a <a href="https://github.com/ellenhp/airmail">new geocoder</a> (<a href="https://airmail.rs/#demo-section">demo</a>), or search engine for places and addresses. I wanted to make something very inexpensive to run. A big barrier to entry for hosting a planet-scale <a href="https://github.com/headwaymaps/headway">headway instance</a> is the geocoder. Right now we’re using Pelias which is great at what it does, but runs on ElasticSearch which doesn’t do well on &lt;8GB of RAM. I’ve been poking at this problem off and on for years, and didn’t expect to get anything working, but much to my surprise things shaped up pretty quickly.</p>

<p>I was able to cobble together a mediocre address parser based on <a href="https://crates.io/crates/nom">nom</a>, drawing an immense amount of inspiration from the <a href="https://github.com/pelias/parser/">Pelias parser</a>. Armed with an okay address parser, I turned to <a href="https://github.com/quickwit-oss/tantivy">tantivy</a> as a search engine, thinking I’d take advantage of its ability to memory map the search index. After a bit of digging, I found <a href="https://github.com/phiresky/tantivy-wasm">tantivy-wasm</a> which runs in the browser and issues range queries to fetch bits of the index as needed. When I saw that the gears really started turning in my head. I didn’t want to fork a search engine library, so I implemented my own backing store for mainline tantivy using <a href="https://en.wikipedia.org/wiki/Mmap">anonymous memory maps</a> and <a href="https://docs.kernel.org/admin-guide/mm/userfaultfd.html">userfaultfd</a> to fetch chunks of the index from object storage on-demand via range queries. It worked, and after a bit of tuning the latency is getting into pretty acceptable ranges, around 1-3 seconds generally, and I’ve seen it as fast as 2ms for a simple query if the cache is hot.</p>

<p><a href="https://fly.io/">Fly.io</a> charges me about $3/mo for the machine it runs on, and just under $7/mo for the 320ish gigabytes of data in object storage, so this has been a very affordable project. I’m pretty happy with the results for the price. I’m planning on extending it handle more locales and use-cases over the coming months. I made a <a href="https://airmail.rs/#demo-section">demo site where you can play with it</a>, but don’t expect miracles. You get what you pay for, and I haven’t indexed OpenAddresses for the demo site so if something isn’t in OpenStreetMap I definitely do not have it in the index. The code is <a href="https://github.com/ellenhp/airmail/">all open-source</a>.</p>

<p>Cheers ✨✨</p>
</div></article></div>
  </body>
</html>
