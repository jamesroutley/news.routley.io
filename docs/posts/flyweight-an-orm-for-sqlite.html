<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/thebinarysearchtree/flyweight">Original</a>
    <h1>Flyweight: An ORM for SQLite</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">An ORM for SQLite and NodeJS. Flyweight is different from other ORMs in that it combines a very simple API for performing basic operations, with the ability to create SQL queries that are typed and automatically mapped to complex object types.</p>
<p dir="auto">The following examples are based on a hypothetical UFC database with the following structure:</p>
<p dir="auto">A UFC event has a name, a location, and a start time. Each event has one or more cards (the main card, the preliminary cards). Each card has many fights. Each fight has a red corner and a blue corner, representing the two fighters.</p>
<p dir="auto">The events table looks like this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="create table events (
    id integer primary key,
    name text not null,
    startTime date not null,
    locationId integer references locations
);"><pre><span>create</span> <span>table</span> <span>events</span> (
    id <span>integer</span> <span>primary key</span>,
    name <span>text</span> <span>not null</span>,
    startTime <span>date</span> <span>not null</span>,
    locationId <span>integer</span> <span>references</span> locations
);</pre></div>
<p dir="auto">Tables are created with SQL, not with a custom API. Even though SQLite only has a few types built in, Flyweight allows you to create your own types, which are converted to and from the database. In this example, the <code>startTime</code> column is using the new <code>date</code> type.</p>
<p dir="auto">Flyweight parses your sql statements and tables, and creates an API that is typed with TypeScript. Each table has a singular and plural form. If you want to get one row with the basic API, you can use:</p>
<div dir="auto" data-snippet-clipboard-copy-content="const event = await db.event.get({ id: 100 });"><pre><span>const</span> <span>event</span> <span>=</span> <span>await</span> <span>db</span><span>.</span><span>event</span><span>.</span><span>get</span><span>(</span><span>{</span> <span>id</span>: <span>100</span> <span>}</span><span>)</span><span>;</span></pre></div>
<p dir="auto">If you want to get many rows, you can use:</p>
<div dir="auto" data-snippet-clipboard-copy-content="const names = await db.events.get({ id: eventIds }, &#39;name&#39;);"><pre><span>const</span> <span>names</span> <span>=</span> <span>await</span> <span>db</span><span>.</span><span>events</span><span>.</span><span>get</span><span>(</span><span>{</span> <span>id</span>: <span>eventIds</span> <span>}</span><span>,</span> <span>&#39;name&#39;</span><span>)</span><span>;</span></pre></div>
<p dir="auto">If you want to insert a row, you can do:</p>
<div dir="auto" data-snippet-clipboard-copy-content="const id = await db.coach.insert({
  name: &#39;Eugene Bareman&#39;,
  city: &#39;Auckland&#39;
});"><pre><span>const</span> <span>id</span> <span>=</span> <span>await</span> <span>db</span><span>.</span><span>coach</span><span>.</span><span>insert</span><span>(</span><span>{</span>
  <span>name</span>: <span>&#39;Eugene Bareman&#39;</span><span>,</span>
  <span>city</span>: <span>&#39;Auckland&#39;</span>
<span>}</span><span>)</span><span>;</span></pre></div>
<p dir="auto">The basic API does not allow you to perform joins, aggregate functions, or anything else. When you need these features, you simply create a SQL file in a folder with the name of one of the tables. This will then be parsed and typed by Flyweight, and available as part of the API.</p>
<p dir="auto">By using conventions, Flyweight is able to automatically map SQL statements into nested objects without any extra code. For example, the following SQL statement:</p>
<div dir="auto" data-snippet-clipboard-copy-content="select
    e.id as eventId,
    e.name as eventName,
    c.id as cardId,
    c.cardName,
    f.id as fightId,
    f.blueId,
    bf.name as blueName,
    bf.social as blueSocial,
    f.redId,
    rf.name as redName,
    rf.social as redSocial
from
    events e join
    cards c on c.eventId = e.id join
    fights f on f.cardId = c.id join
    fighters bf on f.blueId = bf.id join
    fighters rf on f.redId = rf.id
where e.id = $id"><pre><span>select</span>
    <span>e</span>.<span>id</span> <span>as</span> eventId,
    <span>e</span>.<span>name</span> <span>as</span> eventName,
    <span>c</span>.<span>id</span> <span>as</span> cardId,
    <span>c</span>.<span>cardName</span>,
    <span>f</span>.<span>id</span> <span>as</span> fightId,
    <span>f</span>.<span>blueId</span>,
    <span>bf</span>.<span>name</span> <span>as</span> blueName,
    <span>bf</span>.<span>social</span> <span>as</span> blueSocial,
    <span>f</span>.<span>redId</span>,
    <span>rf</span>.<span>name</span> <span>as</span> redName,
    <span>rf</span>.<span>social</span> <span>as</span> redSocial
<span>from</span>
    events e <span>join</span>
    cards c <span>on</span> <span>c</span>.<span>eventId</span> <span>=</span> <span>e</span>.<span>id</span> <span>join</span>
    fights f <span>on</span> <span>f</span>.<span>cardId</span> <span>=</span> <span>c</span>.<span>id</span> <span>join</span>
    fighters bf <span>on</span> <span>f</span>.<span>blueId</span> <span>=</span> <span>bf</span>.<span>id</span> <span>join</span>
    fighters rf <span>on</span> <span>f</span>.<span>redId</span> <span>=</span> <span>rf</span>.<span>id</span>
<span>where</span> <span>e</span>.<span>id</span> <span>=</span> $id</pre></div>
<p dir="auto">is contained in a file called <code>getById.sql</code> in the <code>events</code> folder. It can be called from the API like this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="const event = await db.event.getById({ id: 100 });"><pre><span>const</span> <span>event</span> <span>=</span> <span>await</span> <span>db</span><span>.</span><span>event</span><span>.</span><span>getById</span><span>(</span><span>{</span> <span>id</span>: <span>100</span> <span>}</span><span>)</span><span>;</span></pre></div>
<p dir="auto">This returns an object that looks like this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="{
  id: 100,
  name: &#39;UFC 78: Validation&#39;,
  cards: [
    { id: 247, cardName: &#39;Main card (PPV)&#39;, fights: [Array] },
    { id: 248, cardName: &#39;Preliminary card&#39;, fights: [Array] }
  ]
}"><pre><span>{</span>
  <span>id</span>: <span>100</span><span>,</span>
  <span>name</span>: <span>&#39;UFC 78: Validation&#39;</span><span>,</span>
  <span>cards</span>: <span>[</span>
    <span>{</span> <span>id</span>: <span>247</span><span>,</span> <span>cardName</span>: <span>&#39;Main card (PPV)&#39;</span><span>,</span> <span>fights</span>: <span>[</span><span>Array</span><span>]</span> <span>}</span><span>,</span>
    <span>{</span> <span>id</span>: <span>248</span><span>,</span> <span>cardName</span>: <span>&#39;Preliminary card&#39;</span><span>,</span> <span>fights</span>: <span>[</span><span>Array</span><span>]</span> <span>}</span>
  <span>]</span>
<span>}</span></pre></div>
<p dir="auto">With each fight in the fights array looking like this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="{
  id: 805,
  blue: {
    id: 708,
    name: &#39;Rashad Evans&#39;,
    social: { instagram: &#39;sugarashadevans&#39;, twitter: &#39;SugaRashadEvans&#39; }
  },
  red: {
    id: 236,
    name: &#39;Michael Bisping&#39;,
    social: { instagram: &#39;mikebisping&#39;, twitter: &#39;bisping&#39; }
  }
}"><pre><span>{</span>
  <span>id</span>: <span>805</span><span>,</span>
  <span>blue</span>: <span>{</span>
    <span>id</span>: <span>708</span><span>,</span>
    <span>name</span>: <span>&#39;Rashad Evans&#39;</span><span>,</span>
    <span>social</span>: <span>{</span> <span>instagram</span>: <span>&#39;sugarashadevans&#39;</span><span>,</span> <span>twitter</span>: <span>&#39;SugaRashadEvans&#39;</span> <span>}</span>
  <span>}</span><span>,</span>
  <span>red</span>: <span>{</span>
    <span>id</span>: <span>236</span><span>,</span>
    <span>name</span>: <span>&#39;Michael Bisping&#39;</span><span>,</span>
    <span>social</span>: <span>{</span> <span>instagram</span>: <span>&#39;mikebisping&#39;</span><span>,</span> <span>twitter</span>: <span>&#39;bisping&#39;</span> <span>}</span>
  <span>}</span>
<span>}</span></pre></div>
<h2 dir="auto"><a id="user-content-how-it-works" aria-hidden="true" href="#how-it-works"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>How it works</h2>
<p dir="auto">Now let&#39;s look at how Flyweight does this without you having to specify any mapping code. It all comes down to the select statement:</p>
<div dir="auto" data-snippet-clipboard-copy-content="  e.id as eventId,          // primary key
  e.name as eventName,
  c.id as cardId,           // primary key
  c.cardName,
  f.id as fightId,          // primary key
  f.blueId,                 // foreign key
  bf.name as blueName,
  bf.social as blueSocial,
  f.redId,                  // foreign key
  rf.name as redName,
  rf.social as redSocial"><pre>  <span>e</span>.<span>id</span> <span>as</span> eventId,          <span>//</span> <span>primary key</span>
  <span>e</span>.<span>name</span> <span>as</span> eventName,
  <span>c</span>.<span>id</span> <span>as</span> cardId,           <span>//</span> <span>primary key</span>
  <span>c</span>.<span>cardName</span>,
  <span>f</span>.<span>id</span> <span>as</span> fightId,          <span>//</span> <span>primary key</span>
  <span>f</span>.<span>blueId</span>,                 <span>//</span> <span>foreign key</span>
  <span>bf</span>.<span>name</span> <span>as</span> blueName,
  <span>bf</span>.<span>social</span> <span>as</span> blueSocial,
  <span>f</span>.<span>redId</span>,                  <span>//</span> <span>foreign key</span>
  <span>rf</span>.<span>name</span> <span>as</span> redName,
  <span>rf</span>.<span>social</span> <span>as</span> redSocial</pre></div>
<p dir="auto">Every time you want to create an array within an object (such as the <code>cards</code> array in the main object), you include a primary key. Every column including and after the primary key forms the keys of the objects inside the array. Flyweight takes the name of the column (eg cardId), removes the Id part, and then converts the name into its plural form to create the name of the array (eg cards).</p>
<p dir="auto">If you didn&#39;t want to create a cards array but wanted to include the cardId, you would just select f.cardId, which is a foreign key on the fights table rather than a primary key.</p>
<p dir="auto">If you wanted to create a nested object inside an object (such as the red and blue in this example), you select a foreign key (such as blueId) and then give any other columns after blueId the same prefix (blue), and they will be included in the object with the prefix removed.</p>
<p dir="auto">The social column is an object because in the fighters table, it is defined with the type <code>json</code>, which is automatically parsed into an object.</p>
<h2 dir="auto"><a id="user-content-getting-started" aria-hidden="true" href="#getting-started"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Getting started</h2>

<p dir="auto">For JavaScript, create a file called db.js with the following code:</p>
<div dir="auto" data-snippet-clipboard-copy-content="import Database from &#39;flyweightjs&#39;;

const database = new Database();

const result = await database.initialize({
  db: &#39;/path/test.db&#39;,
  sql: &#39;/path/sql&#39;,
  tables: &#39;/path/initial.sql&#39;,
  types: &#39;/path/db.d.ts&#39;,
  extensions: &#39;/path/regexp.dylib&#39;
});

const db = result.db;
const makeTypes = result.makeTypes;
const getTables = result.getTables;

export {
  database,
  db,
  makeTypes,
  getTables
}"><pre><span>import</span> <span>Database</span> <span>from</span> <span>&#39;flyweightjs&#39;</span><span>;</span>

<span>const</span> <span>database</span> <span>=</span> <span>new</span> <span>Database</span><span>(</span><span>)</span><span>;</span>

<span>const</span> <span>result</span> <span>=</span> <span>await</span> <span>database</span><span>.</span><span>initialize</span><span>(</span><span>{</span>
  <span>db</span>: <span>&#39;/path/test.db&#39;</span><span>,</span>
  <span>sql</span>: <span>&#39;/path/sql&#39;</span><span>,</span>
  <span>tables</span>: <span>&#39;/path/initial.sql&#39;</span><span>,</span>
  <span>types</span>: <span>&#39;/path/db.d.ts&#39;</span><span>,</span>
  <span>extensions</span>: <span>&#39;/path/regexp.dylib&#39;</span>
<span>}</span><span>)</span><span>;</span>

<span>const</span> <span>db</span> <span>=</span> <span>result</span><span>.</span><span>db</span><span>;</span>
<span>const</span> <span>makeTypes</span> <span>=</span> <span>result</span><span>.</span><span>makeTypes</span><span>;</span>
<span>const</span> <span>getTables</span> <span>=</span> <span>result</span><span>.</span><span>getTables</span><span>;</span>

<span>export</span> <span>{</span>
  <span>database</span><span>,</span>
  <span>db</span><span>,</span>
  <span>makeTypes</span><span>,</span>
  <span>getTables</span>
<span>}</span></pre></div>
<p dir="auto">After you have done this:</p>
<ol dir="auto">
<li>create the <code>initial.sql</code> and add some tables.</li>
<li>create a new JavaScript file and import the <code>makeTypes</code> function, and then run it without any arguments. This should create a `db.d.ts<code>file that will type the exported</code>db``` variable.</li>
</ol>
<p dir="auto">For TypeScript, create a file with the following code:</p>
<div dir="auto" data-snippet-clipboard-copy-content="import Database from &#39;flyweightjs&#39;;
import { TypedDb } from &#39;./types.ts&#39;;

const database = new Database();

const result = await database.initialize&lt;TypedDb&gt;({
  db: &#39;/path/test.db&#39;,
  sql: &#39;/path/sql&#39;,
  tables: &#39;/path/initial.sql&#39;,
  types: &#39;/path/types.ts&#39;,
  extensions: &#39;/path/regexp.dylib&#39;
});

const db = result.db;
const makeTypes = result.makeTypes;
const getTables = result.getTables;

export {
  database,
  db,
  makeTypes,
  getTables
}"><pre><span>import</span> <span>Database</span> <span>from</span> <span>&#39;flyweightjs&#39;</span><span>;</span>
<span>import</span> <span>{</span> <span>TypedDb</span> <span>}</span> <span>from</span> <span>&#39;./types.ts&#39;</span><span>;</span>

<span>const</span> <span>database</span> <span>=</span> <span>new</span> <span>Database</span><span>(</span><span>)</span><span>;</span>

<span>const</span> <span>result</span> <span>=</span> <span>await</span> <span>database</span><span>.</span><span>initialize</span><span>&lt;</span><span>TypedDb</span><span>&gt;</span><span>(</span><span>{</span>
  <span>db</span>: <span>&#39;/path/test.db&#39;</span><span>,</span>
  <span>sql</span>: <span>&#39;/path/sql&#39;</span><span>,</span>
  <span>tables</span>: <span>&#39;/path/initial.sql&#39;</span><span>,</span>
  <span>types</span>: <span>&#39;/path/types.ts&#39;</span><span>,</span>
  <span>extensions</span>: <span>&#39;/path/regexp.dylib&#39;</span>
<span>}</span><span>)</span><span>;</span>

<span>const</span> <span>db</span> <span>=</span> <span>result</span><span>.</span><span>db</span><span>;</span>
<span>const</span> <span>makeTypes</span> <span>=</span> <span>result</span><span>.</span><span>makeTypes</span><span>;</span>
<span>const</span> <span>getTables</span> <span>=</span> <span>result</span><span>.</span><span>getTables</span><span>;</span>

<span>export</span> <span>{</span>
  <span>database</span><span>,</span>
  <span>db</span><span>,</span>
  <span>makeTypes</span><span>,</span>
  <span>getTables</span>
<span>}</span></pre></div>
<p dir="auto">When you first run this code, remove all of the references to <code>TypedDb</code> because it does not exist yet. Import <code>makeTypes</code> into another file and run (it has no arguments) to generate the <code>types.ts</code> file and then put the <code>TypedDb</code> references back. Before you do that though, you need to add some <code>create table</code> statements to the file specified in the <code>tables</code> argument so that there are some types to generate.</p>
<p dir="auto">The <code>initialize</code> method&#39;s <code>path</code> argument takes the following arguments:</p>
<p dir="auto"><code>db</code>: The path to the database.</p>
<p dir="auto"><code>sql</code>: A path to a folder for storing SQL files.</p>
<p dir="auto"><code>tables</code>: A path to a SQL file containing the <code>create table</code> statements that define your database schema.</p>
<p dir="auto"><code>types</code>: If you are using JavaScript, this should be a path to a file that is in the same location as <code>db.js</code>. If you are using TypeScript, this can be any path. This file should not exist yet. It will be created by the <code>makeTypes</code> function.</p>
<p dir="auto"><code>extensions</code>: A string or array of strings of SQLite extensions that will be loaded each time a connection is made to the database.</p>
<p dir="auto"><code>initialize</code> also takes an optional second argument, <code>interfaceName</code>, which is a string that can be used instead of <code>TypedDb</code>. This is useful if you have more than one database.</p>
<h2 dir="auto"><a id="user-content-compiling-extensions" aria-hidden="true" href="#compiling-extensions"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Compiling extensions</h2>
<p dir="auto">Flyweight supports regular expressions in some of its methods if you have loaded a regular expression extension. The SQLite website contains instructions for compiling extensions. It is missing some steps though. To compile the regexp.c extension included in the SQLite source code, you should do the following:</p>
<ol dir="auto">
<li>Download regexp.c from the SQLite repository</li>
<li>Download the SQLite amalgamation file from the SQLite website and unzip it into a folder</li>
<li>Put the regexp.c file into this folder and then run the commands mentioned at <a href="https://www.sqlite.org/loadext.html" rel="nofollow">https://www.sqlite.org/loadext.html</a> under the heading &#34;Compiling a Loadable Extension&#34; depending on your operating system</li>
</ol>
<h2 dir="auto"><a id="user-content-creating-tables" aria-hidden="true" href="#creating-tables"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Creating tables</h2>
<p dir="auto">Tables are created the same way as they are in SQL. Flyweight converts the custom types in these tables to native types, and converts the tables to strict mode. The native types available in strict mode are <code>integer</code>, <code>real</code>, <code>text</code>, <code>blob</code>, and <code>any</code>. In addition to these types, four custom types are included by default: <code>boolean</code>, <code>date</code>, <code>json</code>, and <code>regexp</code>. <code>boolean</code> is a column in which the values are restricted to 1 or 0, <code>date</code> is a JavaScript <code>Date</code> in milliseconds, <code>json</code> is json stored as text, and <code>regexp</code> is mostly just used for querying.</p>
<p dir="auto">To add your own types, you can use the <code>registerTypes</code> method on the <code>database</code> object mentioned earlier. <code>registerTypes</code> takes an array of <code>CustomType</code> objects that have the following properties:</p>
<p dir="auto"><code>name</code>: the name of the type to be used in <code>create table</code> statements</p>
<p dir="auto"><code>valueTest</code>: a function that takes a value and returns <code>true</code> or <code>false</code> as to whether they value&#39;s type is that of the custom type</p>
<p dir="auto"><code>makeConstraint</code>: an optional function that takes a column name as an argument, and returns a SQL constraint string</p>
<p dir="auto"><code>dbToJs</code>: a function that takes a value from the database and returns the JavaScript equivalent of that value</p>
<p dir="auto"><code>jsToDb</code>: a function that takes a JavaScript value and returns a value suitable for storing in the database</p>
<p dir="auto"><code>tsType</code>: the TypeScript type that represents this custom type</p>
<p dir="auto"><code>dbType</code>: the native database type that will be used to store values of this type</p>
<p dir="auto">For example, the custom type for <code>boolean</code> is as follows:</p>
<div dir="auto" data-snippet-clipboard-copy-content="{
  name: &#39;boolean&#39;,
  valueTest: (v) =&gt; typeof v === &#39;boolean&#39;,
  makeConstraint: (column) =&gt; `check (${column} in (0, 1))`,
  dbToJs: (v) =&gt; Boolean(v),
  jsToDb: (v) =&gt; v === true ? 1 : 0,
  tsType: &#39;boolean&#39;,
  dbType: &#39;integer&#39;
}"><pre><span>{</span>
  <span>name</span>: <span>&#39;boolean&#39;</span><span>,</span>
  <span>valueTest</span>: <span>(</span><span>v</span><span>)</span> <span>=&gt;</span> <span>typeof</span> <span>v</span> <span>===</span> <span>&#39;boolean&#39;</span><span>,</span>
  <span>makeConstraint</span>: <span>(</span><span>column</span><span>)</span> <span>=&gt;</span> <span>`check (<span><span>${</span><span>column</span><span>}</span></span> in (0, 1))`</span><span>,</span>
  <span>dbToJs</span>: <span>(</span><span>v</span><span>)</span> <span>=&gt;</span> <span>Boolean</span><span>(</span><span>v</span><span>)</span><span>,</span>
  <span>jsToDb</span>: <span>(</span><span>v</span><span>)</span> <span>=&gt;</span> <span>v</span> <span>===</span> <span>true</span> ? <span>1</span> : <span>0</span><span>,</span>
  <span>tsType</span>: <span>&#39;boolean&#39;</span><span>,</span>
  <span>dbType</span>: <span>&#39;integer&#39;</span>
<span>}</span></pre></div>
<p dir="auto">Once you have created your tables, you can run the <code>getTables</code> function mentioned earlier with no arguments to convert the tables into a form that can be run by the database to create the tables. <code>getTables</code> returns a string of SQL.</p>
<h2 dir="auto"><a id="user-content-creating-sql-queries" aria-hidden="true" href="#creating-sql-queries"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Creating SQL queries</h2>
<p dir="auto">In the SQL folder you supplied to the <code>initialize</code> method, you should create folders with the same name as your table names, and then put SQL files in thos folders that correspond to the name of the method you want to call to run them. For example, if you wanted a query that was called like this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="const event = await db.event.getById({ id: 100 });"><pre><span>const</span> <span>event</span> <span>=</span> <span>await</span> <span>db</span><span>.</span><span>event</span><span>.</span><span>getById</span><span>(</span><span>{</span> <span>id</span>: <span>100</span> <span>}</span><span>)</span><span>;</span></pre></div>
<p dir="auto">you would create an <code>events</code> folder and put a file in it called <code>getById.sql</code>.</p>
<p dir="auto">When creating SQL queries, make sure you give an alias to any columns in the select statement that don&#39;t have a name. For exampe, do not do:</p>
<div dir="auto" data-snippet-clipboard-copy-content="select max(startTime) from events;"><pre><span>select</span> <span>max</span>(startTime) <span>from</span> events;</pre></div>
<p dir="auto">as there is no name given to <code>max(startTime)</code>.</p>
<h2 dir="auto"><a id="user-content-the-api" aria-hidden="true" href="#the-api"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>The API</h2>
<p dir="auto">Flyweight parses all of your SQL files and generates an API using TypeScript. In the &#34;Getting started&#34; section, you export a variable named <code>db</code>. This is the API, and its properties include both the singular and plural form of every table in your database, as well as <code>begin</code>, <code>commit</code>, and <code>rollback</code> methods for transactions. Here is an example of a transaction:</p>
<div dir="auto" data-snippet-clipboard-copy-content="import { db } from &#39;./db.js&#39;;

try {
  await db.begin();

  const coachId = await db.coach.insert({
    name: &#39;Eugene Bareman&#39;,
    city: &#39;Auckland&#39;
  });
  const fighterId = await db.fighter.get({ name: /Israel/ }, &#39;id&#39;);
  await db.fighterCoach.insert({
    fighterId,
    coachId
  });
  
  await db.commit();
}
catch (e) {
  console.log(e);
  await db.rollback();
}"><pre><span>import</span> <span>{</span> <span>db</span> <span>}</span> <span>from</span> <span>&#39;./db.js&#39;</span><span>;</span>

<span>try</span> <span>{</span>
  <span>await</span> <span>db</span><span>.</span><span>begin</span><span>(</span><span>)</span><span>;</span>

  <span>const</span> <span>coachId</span> <span>=</span> <span>await</span> <span>db</span><span>.</span><span>coach</span><span>.</span><span>insert</span><span>(</span><span>{</span>
    <span>name</span>: <span>&#39;Eugene Bareman&#39;</span><span>,</span>
    <span>city</span>: <span>&#39;Auckland&#39;</span>
  <span>}</span><span>)</span><span>;</span>
  <span>const</span> <span>fighterId</span> <span>=</span> <span>await</span> <span>db</span><span>.</span><span>fighter</span><span>.</span><span>get</span><span>(</span><span>{</span> <span>name</span>: <span><span>/</span>Israel<span>/</span></span> <span>}</span><span>,</span> <span>&#39;id&#39;</span><span>)</span><span>;</span>
  <span>await</span> <span>db</span><span>.</span><span>fighterCoach</span><span>.</span><span>insert</span><span>(</span><span>{</span>
    fighterId<span>,</span>
    coachId
  <span>}</span><span>)</span><span>;</span>
  
  <span>await</span> <span>db</span><span>.</span><span>commit</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
<span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
  <span>console</span><span>.</span><span>log</span><span>(</span><span>e</span><span>)</span><span>;</span>
  <span>await</span> <span>db</span><span>.</span><span>rollback</span><span>(</span><span>)</span><span>;</span>
<span>}</span></pre></div>
<p dir="auto">Every table has <code>get</code>, <code>update</code>, <code>insert</code>, and <code>remove</code> methods available to it, along with any of the custom methods that are created when you add a new SQL file to the corresponding table&#39;s folder.</p>
<h3 dir="auto"><a id="user-content-insert" aria-hidden="true" href="#insert"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Insert</h3>
<p dir="auto"><code>insert</code> simply takes one argument - <code>params</code>, with the keys and values corresponding to the column names and values you want to insert. It returns the primary key if none was supplied, otherwise it returns the number of rows affected by the query.</p>
<h3 dir="auto"><a id="user-content-update" aria-hidden="true" href="#update"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Update</h3>
<p dir="auto"><code>update</code> takes two arguments - the <code>query</code> (or null), and the <code>params</code> you want to update. It returns a number representing the number of rows that were affected by the query. For example:</p>
<div dir="auto" data-snippet-clipboard-copy-content="await db.coach.update({ id: 100 }, { city: &#39;Brisbane&#39; });"><pre><span>await</span> <span>db</span><span>.</span><span>coach</span><span>.</span><span>update</span><span>(</span><span>{</span> <span>id</span>: <span>100</span> <span>}</span><span>,</span> <span>{</span> <span>city</span>: <span>&#39;Brisbane&#39;</span> <span>}</span><span>)</span><span>;</span></pre></div>
<p dir="auto">which corresponds to</p>
<div dir="auto" data-snippet-clipboard-copy-content="update coaches set city = &#39;Brisbane&#39; where id = 100;"><pre><span>update</span> coaches <span>set</span> city <span>=</span> <span><span>&#39;</span>Brisbane<span>&#39;</span></span> <span>where</span> id <span>=</span> <span>100</span>;</pre></div>
<h3 dir="auto"><a id="user-content-get" aria-hidden="true" href="#get"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Get</h3>
<p dir="auto"><code>get</code> takes two optional arguments. The first is <code>params</code> - an object representing the where clause. For example:</p>
<div dir="auto" data-snippet-clipboard-copy-content="const fights = await db.fights.get({ cardId: 9, titleFight: true });"><pre><span>const</span> <span>fights</span> <span>=</span> <span>await</span> <span>db</span><span>.</span><span>fights</span><span>.</span><span>get</span><span>(</span><span>{</span> <span>cardId</span>: <span>9</span><span>,</span> <span>titleFight</span>: <span>true</span> <span>}</span><span>)</span><span>;</span></pre></div>
<p dir="auto">translates to</p>
<div dir="auto" data-snippet-clipboard-copy-content="select * from fights where cardId = 9 and titleFight = 1;"><pre><span>select</span> <span>*</span> <span>from</span> fights <span>where</span> cardId <span>=</span> <span>9</span> <span>and</span> titleFight <span>=</span> <span>1</span>;</pre></div>
<p dir="auto">The keys to <code>params</code> must be the column names of the table. The values can either be of the same type as the column, an array of values that are the same type as the column, null, or a regular expression if the column is text. If an array is passed in, an <code>in</code> clause is used, such as:</p>
<div dir="auto" data-snippet-clipboard-copy-content="const fights = await db.fights.get({ cardId: [1, 2, 3] });"><pre><span>const</span> <span>fights</span> <span>=</span> <span>await</span> <span>db</span><span>.</span><span>fights</span><span>.</span><span>get</span><span>(</span><span>{</span> <span>cardId</span>: <span>[</span><span>1</span><span>,</span> <span>2</span><span>,</span> <span>3</span><span>]</span> <span>}</span><span>)</span><span>;</span></pre></div>
<p dir="auto">which translates to</p>
<div dir="auto" data-snippet-clipboard-copy-content="select * from fights where cardId in (1, 2, 3);"><pre><span>select</span> <span>*</span> <span>from</span> fights <span>where</span> cardId <span>in</span> (<span>1</span>, <span>2</span>, <span>3</span>);</pre></div>
<p dir="auto">If null is passed in as the value, the SQL will use <code>is null</code>. If a regular expression is passed in, the SQL will use <code>regexp</code>.</p>
<p dir="auto">All of the arguments are passed in as parameters for security reasons. There are no limits to the amount of values used in the <code>in</code> clause, unlike other ORMs.</p>
<p dir="auto">The second argument to <code>get</code> can be one of three possible values:</p>
<ol dir="auto">
<li>a string representing a column to select. In this case, the result returned is a single value or array of single values, depending on whether a plural or singular table name is used in the query.</li>
<li>an array of strings, representing the columns to select.</li>
<li>An object with one or more of the following properties:</li>
</ol>
<p dir="auto"><code>select</code> or <code>exclude</code>: <code>select</code> can be a string or array representing the columns to select. <code>exclude</code> can be an array of columns to exclude, with all of the other columns being selected.</p>
<p dir="auto"><code>orderBy</code>: a string representing the column to order the result by, or an array of columns to order the result by.</p>
<p dir="auto"><code>desc</code>: set to true when using <code>orderBy</code> if you want the results in descending order.</p>
<p dir="auto"><code>limit</code> and <code>offset</code>: corresponding to the SQL keywords with the same name.</p>
<p dir="auto"><code>distinct</code>: adds the <code>distinct</code> keywords to the start of the select clause.</p>
<p dir="auto">For example:</p>
<div dir="auto" data-snippet-clipboard-copy-content="const fighters = await db.fighters.get({ isActive: true }, {
  select: [&#39;name&#39;, &#39;hometown&#39;],
  orderBy: &#39;reachCm&#39;,
  limit: 10
});"><pre><span>const</span> <span>fighters</span> <span>=</span> <span>await</span> <span>db</span><span>.</span><span>fighters</span><span>.</span><span>get</span><span>(</span><span>{</span> <span>isActive</span>: <span>true</span> <span>}</span><span>,</span> <span>{</span>
  <span>select</span>: <span>[</span><span>&#39;name&#39;</span><span>,</span> <span>&#39;hometown&#39;</span><span>]</span><span>,</span>
  <span>orderBy</span>: <span>&#39;reachCm&#39;</span><span>,</span>
  <span>limit</span>: <span>10</span>
<span>}</span><span>)</span><span>;</span></pre></div>
<h3 dir="auto"><a id="user-content-remove" aria-hidden="true" href="#remove"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Remove</h3>
<p dir="auto"><code>remove</code> takes one argument representing the where clause and returns the number of rows affected by the query.</p>
<div dir="auto" data-snippet-clipboard-copy-content="const changes = await db.fighters.remove({ id: 100 });"><pre><span>const</span> <span>changes</span> <span>=</span> <span>await</span> <span>db</span><span>.</span><span>fighters</span><span>.</span><span>remove</span><span>(</span><span>{</span> <span>id</span>: <span>100</span> <span>}</span><span>)</span><span>;</span></pre></div>
</article>
          </div></div>
  </body>
</html>
