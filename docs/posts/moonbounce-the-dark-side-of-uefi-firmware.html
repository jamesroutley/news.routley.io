<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://securelist.com/moonbounce-the-dark-side-of-uefi-firmware/105468/">Original</a>
    <h1>MoonBounce: The dark side of UEFI firmware</h1>
    
    <div id="readability-page-1" class="page"><div>
												<div>
													<h2 id="what-happened">What happened?</h2>
<p>At the end of 2021, we were made aware of a UEFI firmware-level compromise through logs from our <a href="https://www.kaspersky.com/enterprise-security/wiki-section/products/anti-rootkit-and-remediation-technology">Firmware Scanner</a>, which has been integrated into Kaspersky products since the beginning of 2019. Further analysis has shown that a single component within the inspected firmware’s image was modified by attackers in a way that allowed them to intercept the original execution flow of the machine’s boot sequence and introduce a sophisticated infection chain.</p>
<p>By examining the components of the rogue firmware and other malicious artefacts from the target’s network, we were able to reach the following conclusions:</p>
<ul>
<li>The inspected UEFI firmware was tampered with to embed a malicious code that we dub MoonBounce;</li>
<li>Due to its emplacement on SPI flash which is located on the motherboard instead of the hard disk, the implant is capable of persisting in the system across disk formatting or replacement;</li>
<li>The purpose of the implant is to facilitate the deployment of user-mode malware that stages execution of further payloads downloaded from the internet;</li>
<li>The infection chain itself does not leave any traces on the hard drive, as its components operate in memory only, thus facilitating a fileless attack with a small footprint;</li>
<li>We detected other non-UEFI implants in the targeted network that communicated with the same infrastructure which hosted the the stager’s payload;</li>
<li>By assessing the combination of the above findings with network infrastructure fingerprints and other TTPs exhibited by the the attackers; to the best of our knowledge the intrusion set in question can be attributed to <a href="https://www.reuters.com/article/us-china-cyber-moonlighters-idUSKCN1UX1JE">APT41, a threat actor that’s been widely reported to be Chinese-speaking</a>;</li>
</ul>
<p>In this report we describe in detail how the MoonBounce implant works, how it is connected to APT41, and what other traces of activity related to Chinese-speaking actors we were able to observe in the compromised network that could indicate a connection to this threat actor and the underlying campaign.</p>
<h2 id="revisiting-the-current-state-of-the-art-in-persistent-attacks">Revisiting the current state of the art in persistent attacks</h2>
<p>In the last year, there have been several public accounts on the ongoing trend of UEFI threats. Notable examples include the UEFI bootkit used as part of the <a href="https://securelist.com/finspy-unseen-findings/104322/">FinSpy</a> surveillance toolset that we reported on, the work of our colleagues from ESET on the <a href="https://www.welivesecurity.com/2021/10/05/uefi-threats-moving-esp-introducing-especter-bootkit/">ESPectre</a> bootkit, and a little-known threat activity that was discovered within government organisations in the Middle East, using a UEFI bootkit of its own (briefly mentioned in our <a href="https://securelist.com/apt-trends-report-q3-2021/104708/">APT trends report Q3 2021</a> and covered in more detail in a private APT report delivered to customers of our Threat Intelligence Portal).</p>
<p>The common denominator of those three cases is the fact that the UEFI components targeted for infection reside on the ESP (EFI System Partition), a storage space designated for some UEFI components, typically based in the computer’s hard drive or SSD. The most notable elements of the ESP are the Boot Manager and OS loader, both invoked during the machine’s boot sequence and which also happen to be the subject of tampering in the case of the aforementioned bootkits.</p>
<p>While all of the above were seen in use by advanced actors, a different class of bootkits raises even higher concern. This one is made up of implants found in the UEFI firmware within the SPI flash, a non-volatile storage external to the hard drive. Such bootkits are not only stealthier (partially because of limited visibility by security products into this hardware component), but also more difficult to mitigate: flashing a clean firmware image in place of a malicious one can prove to be more difficult than formatting a hard drive and reinstalling an OS, which would typically eliminate ESP level threats.</p>
<p>MoonBounce is notable for being the third publicly revealed case of an implant from the latter class of firmware-based rootkits. Previous cases included <a href="https://www.welivesecurity.com/2018/09/27/lojax-first-uefi-rootkit-found-wild-courtesy-sednit-group/">LoJax</a> and <a href="https://securelist.com/mosaicregressor/98849/">MosaicRegressor</a>, which we reported on during October 2020. In that sense, MoonBounce marks a particular evolution in this group of threats by presenting a more complicated attack flow in comparison to its predecessors and a higher level of technical competence by its authors, who demonstrate a thorough understanding of the finer details involved in the UEFI boot process.</p>
<h2 id="our-discovery-a-sophisticated-implant-within-uefi-firmware">Our discovery: a sophisticated implant within UEFI firmware</h2>
<p>The UEFI implant, which was detected in spring 2021 , was found to have been incorporated by the attackers into the CORE_DXE component of the firmware (also known as the DXE Foundation), which is called early on at the DXE (Driver Execution Environment) phase of the UEFI boot sequence. Among other things, this component is responsible for initializing essential data structures and function interfaces, one of which is the EFI Boot Services Table – a set of pointers to routines that are part of the CORE_DXE image itself and are callable by other DXE drivers in the boot chain.</p>
<p>The source of the infection starts with a set of hooks that intercept the execution of several functions in the EFI Boot Services Table, namely AllocatePool, CreateEventEx and ExitBootServices. Those hooks are used to divert the flow of these functions to malicious shellcode that is appended by the attackers to the CORE_DXE image, which in turn sets up additional hooks in subsequent components of the boot chain, namely the Windows loader.</p>
<p>This multistage chain of hooks facilitates the propagation of malicious code from the CORE_DXE image to other boot components during system startup, allowing the introduction of a malicious driver to the memory address space of the Windows kernel. This driver, which runs during the initial phases of the kernel’s execution, is in charge of deploying user-mode malware by injecting it into an svchost.exe process, once the operating system is up and running. Finally, the user mode malware reaches out to a hardcoded C&amp;C URL (i.e. hxxp://mb.glbaitech[.]com/mboard.dll) and attempts to fetch another stage of the payload to run in memory, which we were not able to retrieve.</p>
<p>The diagram below contains the outline of the stages taken from the moment the hooked Boot Services are called in the context of the DXE Foundation’s execution until the user-mode malware is deployed and run during the Operating System’s execution. The full description of each step in the diagram, along with the analysis of both the MoonBounce driver and user-mode malware can be found in <a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2022/01/19115831/MoonBounce_technical-details_eng.pdf" rel="noopener" target="_blank">the technical document</a> released alongside this report.</p>
<p><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2022/01/13211801/MoonBounce_the_dark_side_of_UEFI_firmware_01.png"><img loading="lazy" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2022/01/13211801/MoonBounce_the_dark_side_of_UEFI_firmware_01.png" alt="Flow of MoonBounce execution from boot sequence to malware deployment in user space" width="852" height="698"/></a></p>
<p><strong><em>Flow of MoonBounce execution from boot sequence to malware deployment in user space</em></strong></p>
<p>Note that at the time of writing we lack sufficient evidence to retrace how the UEFI firmware was infected in the first place. The infection itself, however, is assumed to have occurred remotely. While previous UEFI firmware compromises (i.e. LoJax and MosaicRegressor) manifested as additions of DXE drivers to the overall firmware image on the SPI flash, the current case exhibits a much more subtle and stealthy technique where an existing firmware component is modified to alter its behaviour. Notably, particular functions were modified with an inline hook, meaning the replacement of the function prologue with an instruction to divert execution to a function chosen by the attacker. This form of binary instrumentation typically requires the attacker to obtain the original image, then parse and change it to introduce malicious logic. This would be possible for an attacker having ongoing and remote access to the targeted machine.</p>
<h2 id="other-pieces-of-malware-on-the-radar">Other pieces of malware on the radar</h2>
<p>In addition to MoonBounce, we found infections across multiple nodes in the same network by a known user-mode malware dubbed ScrambleCross, also known as SideWalk. This is an in-memory implant, implemented as position-independent code, that can communicate to a C2 server in order to exchange information and stage the execution of additional plugins in memory, of which none has been sighted in the wild yet. This malware was thoroughly covered by our colleagues at <a href="https://www.trendmicro.com/vinfo/us/security/news/cybercrime-and-digital-threats/earth-baku-returns?utm_source=trendmicroresearch&amp;utm_medium=smk&amp;utm_campaign=0821_EarthBaku1">Trend Micro</a> and <a href="https://www.welivesecurity.com/2021/08/24/sidewalk-may-be-as-dangerous-as-crosswalk/">ESET</a>, so we will refer the reader to their excellent write-ups to understand its internals better.</p>
<p>The position-independent code constituting ScrambleCross can be loaded in one of two ways, the first being a C++ DLL named StealthVector. It obtains the ScrambleCross shellcode by applying a modified ChaCha20 algorithm on an encrypted blob, which may reside as an additional file on disk or be embedded in the loader itself. We detected both variants of this loader in the network in question.</p>
<p>StealthVector gets loaded through the introduction of a modified benign system DLL, in which the import address table is patched to append the malware’s DLL as a dependency. In one case, we observed such altered wbemcomn.dll (MD5: C3B153347AED27435A18E789D8B67E0A) file, which originally facilitates the functionality of WMI in Windows and was located in the directory %SYSTEM%\wbem. As a consequence, when the WMI service was initiated, the rogue version of this DLL forced the loading of a StealthVector image named wmiwk.dll.</p>
<p><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2022/01/13211852/MoonBounce_the_dark_side_of_UEFI_firmware_02.png"><img loading="lazy" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2022/01/13211852/MoonBounce_the_dark_side_of_UEFI_firmware_02.png" alt="Appended IAT entry to a rogue wbemcomn.dll file which forces the loading of StealthVector upon initiation of the WMI service" width="891" height="384"/></a></p>
<p><strong><em>Appended IAT entry to a rogue wbemcomn.dll file which forces the loading of StealthVector upon initiation of the WMI service</em></strong></p>
<p>The table below specifies all instances of StealthVector that we detected in the targeted network, along with timestamp artefacts that might point to the date of their creation.</p>
<table>
<tbody>
<tr>
<td><strong>Loader Filename</strong></td>
<td><strong>Loader MD5</strong></td>
<td><strong>Shellcode Filename</strong></td>
<td><strong>C&amp;C Address</strong></td>
<td><strong>Compilation Timestamp</strong></td>
</tr>
<tr>
<td>wbwkem.dll</td>
<td>4D5EB9F6F501B4F6EDF981A3C6C4D6FA</td>
<td>compwm.bin</td>
<td>dev.kinopoisksu[.]com</td>
<td>Friday, 12.06.2020 08:25:02 UTC</td>
</tr>
<tr>
<td>wkbem.dll</td>
<td>E7155C355C90DC113476DDCF765B187D</td>
<td>pcomnl.bin</td>
<td>Unknown</td>
<td>Tuesday, 24.03.2020 09:09:21 UTC</td>
</tr>
<tr>
<td>wmiwk.dll</td>
<td>899608DE6B59C63B4AE219C3C13502F5</td>
<td>wmipl.dll</td>
<td>ns.glbaitech[.]com</td>
<td>Saturday, 20.02.2021 06:45:18 UTC</td>
</tr>
<tr>
<td>c_20344.nls</td>
<td>4EF90CEEF2CC9FF3121B34A9891BB28D</td>
<td>–</td>
<td>217.69.10[.]104</td>
<td>Tuesday, 24.03.2020 09:09:21 UTC</td>
</tr>
<tr>
<td>c_20334.nls</td>
<td>CFF2772C44F6F86661AB0A4FFBF86833</td>
<td>–</td>
<td>st.kinopoisksu[.]com</td>
<td>Tuesday, 24.03.2020 09:09:21 UTC</td>
</tr>
</tbody>
</table>
<p>Another loader that we detected and is commonly used to load ScrambleCross is .NET based, referred to as StealthMutant. It works by decrypting a shellcode BLOB with AES-256 and injecting it to the address space of another process, using the process-hollowing technique. The injected process in every case we observed was msdt.exe (Microsoft Diagnostic Troubleshooting Wizard).</p>
<p>StealthMutant is launched in one of two ways, which were partially described in other reports as well. The first way is by executing a launcher utility with the filename System.Mail.Service.dll (MD5: 5F9020983A61446A77AF1976247C443D) through the command line as a service. This is outlined in the following commands typed by the attackers on one of the compromised systems:</p>
		<div id="crayon-61eb17d3e86ac017569729" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span>net  </span><span>start</span><span> </span><span>&#34;iscsiwmi&#34;</span></p><p><span>sc  </span><span>stop </span><span>iscsiwmi</span></p><p><span>sc  </span><span>delete </span><span>iscsiwmi</span></p><p><span>reg  </span><span>add</span><span> </span><span>&#34;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost&#34;</span><span> </span>/<span>v</span><span> </span><span>&#34;iscsiwmi&#34;</span><span> </span>/<span>t</span><span> </span><span>REG_MULTI_SZ</span><span> </span>/<span>d</span><span> </span><span>&#34;iscsiwmi&#34;</span><span> </span>/<span>f</span></p><p><span>sc  </span><span>create</span><span> </span><span>&#34;iscsiwmi&#34;</span><span> </span><span>binPath</span>=<span> </span><span>&#34;$system32\svchost.exe -k iscsiwmi&#34;</span><span> </span><span>type</span>=<span> </span><span>share </span><span>start</span>=<span> </span><span>auto </span><span>error</span>=<span> </span><span>ignore </span><span>DisplayName</span>=<span> </span><span>&#34;iscsiwmi&#34;</span></p><p><span>SC  </span><span>failure</span><span> </span><span>&#34;iscsiwmi&#34;</span><span> </span><span>reset</span>=<span> </span><span>86400</span><span> </span><span>actions</span>=<span> </span><span>restart</span>/<span>60000</span>/<span>restart</span>/<span>60000</span>/<span>restart</span>/<span>60000</span></p><p><span>sc  </span><span>description</span><span> </span><span>&#34;iscsiwmi&#34;</span><span> </span><span>&#34;&#34;</span><span>iSCSI </span><span>WMI </span><span>Classes </span><span>That </span><span>Manage </span><span>Initiators</span><span>,</span><span> </span><span>Ports</span><span>,</span><span> </span><span>Sessions </span><span>and</span><span> </span><span>Connections</span><span>&#34;&#34;</span></p><p><span>reg  </span><span>add</span><span> </span><span>&#34;HKLM\SYSTEM\CurrentControlSet\Services\iscsiwmi\Parameters&#34;</span><span> </span>/<span>f</span></p><p><span>reg  </span><span>add</span><span> </span><span>&#34;HKLM\SYSTEM\CurrentControlSet\Services\iscsiwmi\Parameters&#34;</span><span> </span>/<span>v</span><span> </span><span>&#34;ServiceDll&#34;</span><span> </span>/<span>t</span><span> </span><span>REG_EXPAND_SZ</span><span> </span>/<span>d</span><span> </span><span>&#34;$windir\Microsoft.NET\Framework64\v4.0.30319\System.Mail.Service.dll&#34;</span><span> </span>/<span>f</span></p><p><span>net  </span><span>start</span><span> </span><span>&#34;iscsiwmi&#34;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div><p>
The launching utility in turn uses the .NET InstallUtil.exe application in order to execute the StealthMutant image, which has the filename Microsoft.Service.Watch.targets, and providing it with the encrypted ScrambleCross shellcode as an argument from a file named MstUtil.exe.config. The utility itself is a basic C++ program that achieves the aforementioned goal by issuing the following command line using the WinExec API:</p>
		<div id="crayon-61eb17d3e86b3049611128" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span>C</span><span>:</span><span>\</span><span>Windows</span><span>\</span><span>Microsoft</span><span>.</span><span>NET</span><span>\</span><span>Framework64</span><span>\</span><span>v4</span><span>.</span><span>0.30319</span><span>\</span><span>InstallUtil</span><span>.</span><span>exe</span><span> </span>/<span>logfile</span>=<span> </span>/<span>LogToConsole</span>=<span>false</span><span> </span>/<span>ConfigFile</span>=<span>MstUtil</span><span>.</span><span>exe</span><span>.</span><span>config</span><span> </span>/<span>U</span><span> </span><span>C</span><span>:</span><span>\</span><span>Windows</span><span>\</span><span>Microsoft</span><span>.</span><span>NET</span><span>\</span><span>Framework64</span><span>\</span><span>v4</span><span>.</span><span>0.30319</span><span>\</span><span>Microsoft</span><span>.</span><span>Service</span><span>.</span><span>Watch</span><span>.</span><span>targets</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div><p>
The second way to execute StealthMutant is through the creation of a scheduled task via a Windows batch script file named schtask.bat, as outlined below:</p>
		<div id="crayon-61eb17d3e86b5596822457" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>@</span><span>echo </span><span>off</span></p><p><span>cd</span><span> </span>/<span>d</span><span> </span><span>&#34;%~dp0&#34;</span></p><p><span>copy</span><span> </span>/<span>Y</span><span> </span><span>Microsoft</span><span>.</span><span>Service</span><span>.</span><span>Watch</span><span>.</span><span>targets</span><span> </span><span>&#34;C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Microsoft.Service.Watch.targets&#34;</span></p><p><span>copy</span><span> </span>/<span>Y</span><span> </span><span>MstUtil</span><span>.</span><span>exe</span><span>.</span><span>config</span><span> </span><span>&#34;C:\Windows\Microsoft.NET\Framework64\v4.0.30319\MstUtil.exe.config&#34;</span></p><p><span>schtasks</span><span> </span>/<span>create</span><span> </span>/<span>TN</span><span> </span><span>&#34;\Microsoft\Windows\UNP\UNPRefreshListTask&#34;</span><span> </span>/<span>SC </span><span>ONSTART</span><span> </span>/<span>TR</span><span> </span><span>&#34;C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=false /ConfigFile=MstUtil.exe.config /U C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Microsoft.Service.Watch.targets&#34;</span><span> </span>/<span>F</span><span>  </span>/<span>DELAY</span><span> </span><span>0000</span><span>:</span><span>02</span><span> </span>/<span>RU </span><span>SYSTEM</span><span> </span>/<span>RL </span><span>HIGHEST</span></p><p><span>schtasks</span><span> </span>/<span>run</span><span> </span>/<span>TN</span><span> </span><span>&#34;\Microsoft\Windows\UNP\UNPRefreshListTask&#34;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div><p>
The following table lists known StealthMutant loader IOCs, together with their corresponding ScrambleCross shellcode files and contacted C2 addresses. It’s worth noting that most of the ScrambleCross shellcodes (loaded by both StealthMutant and StealthVector) reached out to the same server (i.e. ns.glbaitech[.]com) and that StealthMutant was observed in this campaign only from February, 2021.</p>
<table>
<tbody>
<tr>
<td><strong>Loader MD5</strong></td>
<td><strong>C&amp;C Address</strong></td>
<td><strong>Compilation Timestamp</strong></td>
</tr>
<tr>
<td rowspan="2">0603C8AAECBDC523CBD3495E93AFB20C</td>
<td>92.38.178[.]246</td>
<td rowspan="2">Tuesday, 23.03.2021 08:00:44 UTC</td>
</tr>
<tr>
<td>ns.glbaitech[.]com</td>
</tr>
<tr>
<td>8C7598061D1E8741B8389A80BFD8B8F5</td>
<td>ns.glbaitech[.]com</td>
<td>Saturday, 20.02.2021 03:27:42 UTC</td>
</tr>
<tr>
<td>F9F9D6FB3CB94B1CDF9E437141B59E16</td>
<td>ns.glbaitech[.]com</td>
<td>Wednesday, 08.12.2021 07:07:28 UTC</td>
</tr>
</tbody>
</table>
<p>In addition to the above components, we found other stagers and post-exploitation malware implants during our research, some of which were attributed to or have been used by known Chinese-speaking threat actors:</p>
<ul>
<li><strong>Microcin: </strong>a backdoor typically used by the <a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2018/03/07170759/Microcin_Technical_4PDF_eng_final_s.pdf">SixLittleMonkeys</a> threat actor, which we have been tracking since 2016. It is worth noting that since its inception, the SixLittleMonkeys group has been using Microcin against various targets, partly against high-profile entities based in Russia and Central Asia.</li>
<li><strong>Mimikat_ssp</strong>: a publicly <a href="https://github.com/jas502n/mimikat_ssp">available</a> post-exploitation tool used to dump credentials and security secrets from exe, also used widely by various Chinese-speaking actors (e.g. <a href="https://securelist.com/ghostemperor-from-proxylogon-to-kernel-mode/104407/">GhostEmperor</a>, which we reported on).</li>
<li><strong>Go implant: </strong>a formerly unknown backdoor used to contact a C2 server using a RESTful API, where a combination of a hardcoded IP address and a hypermedia directory path on the underlying server are used for information exchange. Both the IP and the server directory path are encrypted with AES-128 using a base64 encoded key stored in the backdoor’s image. The IP and directory path tuple are used during execution for:
<ul>
<li>Initialising communications with the server;</li>
<li>Sending information from the infected host;</li>
<li>Requesting a specific server path containing a command for execution and downloading it;</li>
<li>Sending back the result of the command’s execution to the C2 server.</li>
</ul>
<p>The commands retrieved from the server are also encrypted with AES-128, with the key stored in the command’s file itself. Command execution results are then encrypted using the same key. We found the following list of supported commands:</p>
<ul>
<li>Get list of drives;</li>
<li>Get content list from a specified directory;</li>
<li>Download a file from the C2 server;</li>
<li>Write text to a given *.bat file and execute it;</li>
<li>Run a shell command.</li>
</ul>
</li>
</ul>
<p>It is important to note that we could not conclusively tie most of those additional pieces of malware to the intrusion set related to MoonBounce, with the exception of Microcin, where some timeline artefacts coincide with other events related to ScrambleCross, as outlined in the figure below. This suggests a low-confidence connection between Microcin and MoonBounce and may indicate usage of shared resources between SixLittleMonkeys and APT41 or involvement of the former’s operators in the MoonBounce activity.</p>
<p><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2022/01/13212702/MoonBounce_the_dark_side_of_UEFI_firmware_03.png"><img loading="lazy" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2022/01/13212702/MoonBounce_the_dark_side_of_UEFI_firmware_03.png" alt="Timeline of events related to artefacts found in the network containing the MoonBounce-infected machine" width="907" height="458"/></a></p>
<p><strong><em>Timeline of events related to artefacts found in the network containing the MoonBounce-infected machine</em></strong></p>
<h2 id="who-were-the-targets">Who were the targets?</h2>
<p>Currently, our detections indicate a very targeted nature of the attack – the presence of the firmware rootkit was detected in a single case. Other affiliated malicious samples (e.g. ScrambleCross and its loaders) were found on multiple other machines in the same network range. In addition, we found several other victims of an undetermined nature with the same versions of ScrambleCross reaching out to the same command and control infrastructure. One particular target corresponds to an organization in control of several enterprises dealing with transport technology.</p>
<h2 id="what-were-the-attackers-trying-to-achieve">What were the attackers trying to achieve?</h2>
<p>We traced some of the commands executed by the attackers after gaining a foothold in the network, which point to lateral movement and exfiltration of information from particular machines. This aligns in profile with some of the previous operations by APT41, wherein intrusions were typically made to intervene in the targeted companies’ supply chain, or to heist sensitive intellectual property and personally identifiable information. The usage of the UEFI implant in particular indicates the actor’s aim to establish a longstanding foothold within the network, as would be expected in an ongoing espionage activity.</p>
<p>The following are examples of command lines that portray some of the methods and actions taken by the operators of this threat activity to achieve their goals:</p>
<ul>
<li>Attempts to enumerate hosts and gather network information:</li>
<li>Copying of files across SMB shares, followed by an attempt to dump the Active Directory domain database (tid):</li>
<li>Usage of the Sysinternals Psexec tool for remote command execution in the network (as the renamed version tmp):</li>
<li>Usage of WMI for remote command execution:</li>
<li>Removal of artefacts from the system:</li>
<li>File archiving of remotely collected files, some of which contain *.hive files, possibly for <a href="https://attack.mitre.org/techniques/T1003/004/">LSA secrets dumping</a>, with the exe command line utility:</li>
</ul>
<h2 id="network-infrastructure">Network infrastructure</h2>
<p>The main cluster of infrastructure serving the activity of the UEFI implant and ScrambleCross implants is outlined in the table below. Note that the attackers maintained the infrastructure from at least March 2020, with some servers seemingly still active at the end of 2021 . During the time the actor switched between multiple hosting providers, resulting in a scattered infrastructure across several ASNs.</p>
<table>
<tbody>
<tr>
<td><strong>Domain</strong></td>
<td><strong>IP</strong></td>
<td><strong>ASN</strong></td>
</tr>
<tr>
<td>mb.glbaitech[.]com</td>
<td>188.166.61[.]146</td>
<td>AS14061 – DIGITALOCEAN-ASN</td>
</tr>
<tr>
<td rowspan="2">ns.glbaitech[.]com</td>
<td>188.166.61[.]146</td>
<td>AS14061 – DIGITALOCEAN-ASN</td>
</tr>
<tr>
<td>172.107.231[.]236</td>
<td>AS40676</td>
</tr>
<tr>
<td rowspan="2">dev.kinopoisksu[.]com</td>
<td>172.107.231[.]236</td>
<td>AS40676</td>
</tr>
<tr>
<td>193.29.57[.]161</td>
<td>AS48314 – IP-PROJECTS</td>
</tr>
<tr>
<td>st.kinopoisksu[.]com</td>
<td>136.244.100[.]127</td>
<td>AS20473 – AS-CHOOPA</td>
</tr>
<tr>
<td>–</td>
<td>217.69.10[.]104</td>
<td>AS20473 – AS-CHOOPA</td>
</tr>
<tr>
<td>–</td>
<td>92.38.178[.]246</td>
<td>AS202422 – GHOST</td>
</tr>
</tbody>
</table>
<p>A careful inspection of the infrastructure shows multiple connections between the servers. It is evident that MoonBounce’s user-mode stager and a few ScrambleCross instances reached out to a single domain, which resolved to the same IP at one point. In addition, there were several overlaps in IPs to which the domains resolved as outlined in the figure below, including one IP that was used to park two domains at different points in time.</p>
<p><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2022/01/13213606/MoonBounce_the_dark_side_of_UEFI_firmware_04.png"><img loading="lazy" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2022/01/13213606/MoonBounce_the_dark_side_of_UEFI_firmware_04-1024x530.png" alt="Connections between infrastructure elements of MoonBounce and ScrambleCross implants found on the same network " width="1024" height="530"/></a></p>
<p><strong><em>Connections between infrastructure elements of MoonBounce and ScrambleCross implants found on the same network</em> </strong></p>
<p>Another important commonality is a unique self-signed SSL certificate, exhibited by multiple servers in this campaign (and only a few dozen others in the wild), which represents a noteworthy fingerprint of the attacker’s network activity.</p>
<p>In addition to the above cluster, we detected two servers related to Microcin’s activity on the same network:</p>
<table>
<tbody>
<tr>
<td><strong>Domain</strong></td>
<td><strong>IP</strong></td>
<td><strong>ASN</strong></td>
</tr>
<tr>
<td>m.necemarket[.]com</td>
<td>172.105.94[.]67</td>
<td>AS63949 – LINODE</td>
</tr>
<tr>
<td>holdmem.dbhubspi[.]com</td>
<td>5.188.93[.]132</td>
<td>AS202422 – G-Core Labs</td>
</tr>
</tbody>
</table>
<h2 id="who-is-behind-the-moonbounce-attack">Who is behind the MoonBounce attack?</h2>
<p>To the best of our knowledge, the activity described in this report can be attributed to a group widely known as APT41, or an actor closely affiliated to it, with medium to high confidence. In part, our findings align with multiple public accounts from the previous year of either APT41 or other threat actors, namely <a href="https://www.trendmicro.com/vinfo/us/security/news/cybercrime-and-digital-threats/earth-baku-returns?utm_source=trendmicroresearch&amp;utm_medium=smk&amp;utm_campaign=0821_EarthBaku1">Earth Baku</a> and <a href="https://www.welivesecurity.com/2021/08/24/sidewalk-may-be-as-dangerous-as-crosswalk/">SparklingGoblin</a>, which are believed to be alternative names for APT41 or share significant resources and TTPs with it.</p>
<p>Our conclusion, in particular, is done based on the following factors:</p>
<ul>
<li>The loading schemes for ScrambleCross, including the usage of StealthVector and StealthMutant in the infection chain, are identical to those observed leveraged by Earth Baku and SparklingGoblin. Apart from the loaders themselves, their launchers seem identical. The attackers used the unique TTP of initiating the loader execution through exe in all cases observed by us. Particularly Install.bat, as used by Earth Baku and described in the public report by Trend Micro mentioned earlier, is highly similar to the sequence of commands used to execute the InstallUtil launcher in our case.</li>
<li>The ScrambleCross malware itself, which has been reported in use with both Earth Baku and SparklingGoblin, is considered a variant of CROSSWALK, a piece of malware that was <a href="https://content.fireeye.com/apt-41/rpt-apt41/">described</a> originally by Mandiant as an APT41 tool and remains distinct to the group, to the best of our knowledge.</li>
<li>A unique certificate retrieved from multiple ScrambleCross C2 servers in the campaign described in this report was sent as a response in a few other dozen servers in the wild, a few of them have been previously <a href="https://s3.documentcloud.org/documents/7210602/FLASH-AC-000133-TT-Published.pdf">reported</a> by the FBI as being part of an APT41-owned infrastructure.</li>
</ul>
<p>Additionally, the following observations are worth mentioning:</p>
<ul>
<li>The user-mode malware stager deployed by the UEFI implant contains a scheduling logic that is somewhat similar to one seen in Microcin samples (some of which were also found on infected hosts in this campaign). This suggests that these groups may be related through shared resources or a prime contractor.
<p>The said scheduling algorithm found in the stager can take a 672-bit bitmask to determine when the malware should start beaconing the C2 server in an attempt to retrieve the payload, whereby the scheduled working time can be decided in a granularity of 15-minute slots (i.e. the stager checks if it is supposed to run in a particular slot out of the 672 possibilities that constitute a full week, or alternatively sleep for 10 seconds before checking if it has reached a dedicated working slot again). A similar scheduling methodology occurs in the case of Microcin, but with a bitmask that simply represents the days of the week on which the malware ought to be active.</p>
<p><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2022/01/13213828/MoonBounce_the_dark_side_of_UEFI_firmware_05.png"><img loading="lazy" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2022/01/13213828/MoonBounce_the_dark_side_of_UEFI_firmware_05-1024x285.png" alt="Scheduling code used in MoonBounce&#39;s user-mode stager " width="1024" height="285"/></a></p>
<p><strong><em>Scheduling code used in MoonBounce’s user-mode stager</em> </strong></p>
</li>
<li>The Mimikat_ssp tool found on a few machines in the targeted network has been seen in use by multiple Chinese-speaking threat actors in the past. One recent example is its use in the campaigns of GhostEmperor, as <a href="https://securelist.com/ghostemperor-from-proxylogon-to-kernel-mode/104407/">described</a> in a previous report.</li>
<li>Some elements of shellcode leveraged in MoonBounce were spotted in an old rootkit that was part of a malicious framework dubbed xTalker, which has been seen in the wild since at least 2013, alongside several malware families affiliated to known actors, e.g. NetTraveler, Enfal and Microcin. It was prominently used against Russian-speaking targets including military, governmental entities and think-tanks.
<p>Both components shared a similar name-hashing algorithm, which is outlined below, along with unique corresponding function name hashes (e.g. 0x311B83F, the name hash of ExAllocatePool) that were not seen in use elsewhere in the wild.</p>
<p><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2022/01/13213937/MoonBounce_the_dark_side_of_UEFI_firmware_06.png"><img loading="lazy" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2022/01/13213937/MoonBounce_the_dark_side_of_UEFI_firmware_06.png" alt="Name-hashing algorithm used identically in both MoonBounce and xTalker&#39;s rootkit " width="299" height="201"/></a></p>
<p><em><strong>Name-hashing algorithm used identically in both MoonBounce and xTalker’s rootkit</strong> </em></p>
<p>In addition, both pieces of code used a technique of replacing magic marker values within shellcode buffers with pointer addresses during runtime. MoonBounce’s code used the marker 0x1122334455667788, while the xTalker rootkit’s code used 0x1234567812345678.</p>
<p><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2022/01/13214018/MoonBounce_the_dark_side_of_UEFI_firmware_07.png"><img loading="lazy" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2022/01/13214018/MoonBounce_the_dark_side_of_UEFI_firmware_07-1024x211.png" alt="Magic marker values replaced during execution within shellcodes in xTalker&#39;s rootkit and MoonBounce" width="1024" height="211"/></a></p>
<p><strong><em>Magic marker values replaced during execution within shellcodes in xTalker’s rootkit and MoonBounce</em></strong></p>
<p>In the case of xTalker, the above code elements were found within shellcode intended to be staged through an MBR bootkit. However, it is not clear to what extent it was actually used. This may suggest that the MoonBounce and xTalker codes were authored by the same, or a closely affiliated, developer.</p>
</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>In September 2020, the US Department of Justice released a series of <a href="https://www.justice.gov/opa/pr/seven-international-cyber-defendants-including-apt41-actors-charged-connection-computer">indictments</a> against members of the APT41 group, charging them with a high number of computer intrusions against a variety of targets, both in the private and public sectors, some of which included high-profile supply chain attacks. The intrusion set described in this report, and in other public accounts we referred to, shows that the group did not cease to be active despite these legal proceedings.</p>
<p>Moreover, it is evident that the group maintains a high level of proficiency and sophistication in the development of its toolset, gaining a foothold in new areas like UEFI firmware. In this sense, the group has introduced its own innovation to this landscape – patching an existing benign core component in the firmware (rather than adding a new driver to it), thereby turning the UEFI firmware into a highly stealthy and persistent storage for malware in the system.</p>
<p>Following previous <a href="https://securelist.com/ksb-threat-predictions-for-2018/83169/">predictions</a>, we can now say that UEFI threats are gradually becoming a norm. With this in mind, vendors are taking more precautions to mitigate attacks like MoonBounce, for example by enabling Secure Boot by default. We <a href="https://securelist.com/advanced-threat-predictions-for-2022/104870/">assess</a> that, in this ongoing arms race, attacks against UEFI will continue to proliferate, with attackers evolving and finding ways to exploit and bypass current security measures.</p>
<p>As a safety measure against this attack and similar ones, it is recommended to update the UEFI firmware regularly and verify that BootGuard, where applicable, is enabled. Likewise, enabling Trust Platform Modules, in case a corresponding hardware is supported on the machine, is also advisable. On top of all, a security product that has visibility into the firmware images should add an extra layer of security, alerting the user on a potential compromise if such occurs.</p>
<h2 id="moonbounce-indicators-of-compromise">MoonBounce’ indicators of compromise</h2>
<p><strong>EFI Rootkit – Malicious CORE_DXE</strong></p>
<p><strong>Modified WMI DLL Launcher</strong></p>
<p><strong>StealthVector</strong></p>
<p><strong>InstallUtil Launcher</strong></p>
<p><strong>StealthMutant</strong></p>
<p><strong>Microcin</strong></p>
<p><strong>Go Implant</strong></p>
<p><strong>Mimikat_SSP</strong></p>
<p><strong>xTalker Rootkit</strong></p>
<p><strong>Domains and IPs</strong></p>
<p><strong>File Names</strong></p>
<p><strong>ScrambleCross Mutexes</strong></p>
												</div>
											</div></div>
  </body>
</html>
