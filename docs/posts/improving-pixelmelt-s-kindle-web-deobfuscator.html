<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://shkspr.mobi/blog/2025/10/improving-pixelmelts-kindle-web-deobfuscator/">Original</a>
    <h1>Improving PixelMelt&#39;s Kindle Web Deobfuscator</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
					<p>A few days ago, someone called PixelMelt published a way for Amazon&#39;s customers to download their purchased books without DRM. Wellâ€¦ <em>sort of</em>.</p>
					<p>In their post &#34;<a href="https://blog.pixelmelt.dev/kindle-web-drm/">How I Reversed Amazon&#39;s Kindle Web Obfuscation Because Their App Sucked</a>&#34; they describe the process of spoofing a web browser, downloading a bunch of JSON files, reconstructing the obfuscated SVGs used to draw individual letters, and running OCR on them to extract text.</p>
					<p>There were a few problems with this approach.</p>
					<p>Firstly, the downloader was hard-coded to only work with the .com site. That fix was simple - do a search and replace on <code>amazon.com</code> with <code>amazon.co.uk</code>. Easy!</p>
					<p>But the harder problem was with the OCR. The code was designed to visually centre each extracted glyph. That gives a nice amount of whitespace around the character which makes it easier for OCR to run. The only problem is that some characters are ambiguous when centred:</p>
					<p><img alt="Several letters drawn with vertical centering." height="177" src="https://shkspr.mobi/blog/wp-content/uploads/2025/10/centred-fs8.png" width="1134"/></p><p>When I ran the code, lots of full-stops became midpoints, commas became apostrophes, and various other characters went a bit wonky.</p>
					<p>That made the output rather hard to read. This was compounded by the way line-breaks were treated. Modern eBooks are designed to be reflowable - no matter the size of your screen, lines should only break on a new paragraph. This had forced linebreaks at the end of every displayed line - rather than at the end of a paragraph.</p>
					<p>So I decided to fix it.</p>
					<h2 id="a-new-approach">
						<a href="#a-new-approach">A New Approach</a>
					</h2>
					<p>I decided that OCRing an entire page would yield better results than single characters. I was (mostly) right.  Here&#39;s what a typical page looks like after de-obfuscation and reconstruction:</p>
					<p><img alt="A page of text." height="800" src="https://shkspr.mobi/blog/wp-content/uploads/2025/10/sample-page.webp" width="500"/></p><p>As you can see - the typesetting is good for the body text, but skew-whiff for the title. Bold and italics are preserved. There are no links or images.</p>
					<p>Here&#39;s how I did it.</p>
					
					<p>As in the original code, I took the SVG path of the character and rendered it as a monochrome PNG. Rather than centring the glyph, I used the height and width provided in the <code>glyphs.json</code> file. That gave me a directory full of individual letters, numbers, punctuation marks, and ligatures. These were named by fontKey (bold, italic, normal, etc).</p>
					<h3 id="create-a-blank-page">
						<a href="#create-a-blank-page">Create a blank page</a>
					</h3>
					<p>The <code>page_data_0_4.json</code> has a width and height of the page. I created a white PNG with the same dimensions. The individual characters could then be placed on that.</p>
					<h3 id="resize-the-characters">
						<a href="#resize-the-characters">Resize the characters</a>
					</h3>
					<p>In the <code>page_data_0_4.json</code> each run of text has a fontKey - which allows the correct glyph to be selected. There&#39;s also a <code>fontSize</code> parameter. Most text seems to be (the ludicrously precise) <code>19.800001</code>. If a font had a different size, I temporarily scaled the glyph in proportion to 19.8.</p>
					<p>Each glyph has an associated <code>xPosition</code>, along with a <code>transform</code> which gives X and Y offsets.  That allows for indenting and other text layouts.</p>
					<p>The characters were then pasted on to the blank page.</p>
					<p>Once every character from that page had been extracted, resized, and placed - the page was saved as a monochrome PNG.</p>
					<h3 id="ocr-the-page">
						<a href="#ocr-the-page">OCR the page</a>
					</h3>
					<p><a href="https://tesseract-ocr.github.io/tessdoc/">Tesseract 5</a> is a fast, modern, and <em>reasonably</em> accurate OCR engine for Linux.</p>
					<p>Running <code>tesseract page_0022.png output -l eng</code> produced a .txt file with all the text extracted.</p>
					<p>For a more useful HTML style layout, the <a href="https://en.wikipedia.org/wiki/HOCR">hOCR output</a> can be used: <code>tesseract page_0022.png output -l eng hocr</code></p>
					<p>Or, a PDF with embedded text: <code>tesseract page_0022.png output -l eng pdf</code></p>
					<h3 id="mistakes">
						<a href="#mistakes">Mistakes</a>
					</h3>
					<p>OCR isn&#39;t infallible. Even with a high resolution image and a clear font, there were some errors.</p>
					<ul>
						<li>Superscript numerals for footnotes were often missing from the OCR.</li>
						<li>Words can run together even if they are well spaced.</li>
						<li>Tesseract can recognise bold and italic characters - but it outputs everything as plain text.</li>
					</ul>
					<h2 id="whats-missing">
						<a href="#whats-missing">What&#39;s missing?</a>
					</h2>
					<p>Images aren&#39;t downloaded. I took a brief look and, while there are links to them in the metadata, they&#39;re downloaded as encrypted blobs. I&#39;m not clever enough to do anything with them.</p>
					<p>The OCR can&#39;t pick out semantic meaning. Chapter headings and footnotes are rendered the same way as text.</p>
					<p>Layout is flat. The image of the page might have an indent, but the outputted text won&#39;t.</p>
					<h2 id="whats-next">
						<a href="#whats-next">What&#39;s next?</a>
					</h2>
					<p>This is very far from perfect. It can give you a visually <em>similar</em> layout to a book you have purchased from Amazon. But it won&#39;t be reflowable.</p>
					<p>The text will be <em>reasonably</em> accurate. But there will be plenty of mistakes.</p>
					<p>You can get an HTML layout with hOCR. But it will be missing formatting and links.</p>
					<p>Processing all the JSON files and OCRing all the images is <em>relatively</em> quick. But tweaking and assembling is still fairly manual.</p>
					<p>There&#39;s nothing particularly clever about what I&#39;ve done. The original code didn&#39;t come with an open source software licence, so I am unable to share my changes - but any moderately competent programmer could recreate this.</p>
					<p>Personally, I&#39;ve just stopped buying books from Amazon. I find that <a href="https://shkspr.mobi/blog/2025/02/automatic-kobo-and-kindle-ebook-arbitrage/">Kobo is often cheaper</a> and their DRM is easy to bypass. But if you have many books trapped in Amazon - or a book is only published there - this is a barely adequate way to liberate it for your personal use.</p>
				</div></div>
  </body>
</html>
