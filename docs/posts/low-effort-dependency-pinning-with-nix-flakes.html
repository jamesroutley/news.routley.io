<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://vaibhavsagar.com/blog/2024/02/09/low-effort-dependency-pinning-flakes/">Original</a>
    <h1>Low-effort Dependency Pinning with Nix Flakes</h1>
    
    <div id="readability-page-1" class="page"><div id="content">
            

            <p>
    Posted on  9 February 2024
    
</p>


<p>Back in 2018 I wrote <a href="https://vaibhavsagar.com/blog/2018/05/27/quick-easy-nixpkgs-pinning/">a blog post about pinning
<code>nixpkgs</code></a> which describes an
approach I’ve used happily and successfully since then to manage dependencies
(and not just <code>nixpkgs</code>) for small projects. In short, it involves</p>
<ol type="1">
<li><code>versions.json</code>, a JSON file storing dependency information</li>
<li><code>updater</code>, an updater script</li>
<li><code>pkgs.nix</code>, a Nix expression that makes each dependency available</li>
</ol>
<p>Here’s what each of those files might look like:</p>
<details>
<summary>
<code>versions.json</code>
</summary>
<div id="cb1"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span>&#34;ihaskell&#34;</span><span>:</span> <span>{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span>&#34;owner&#34;</span><span>:</span> <span>&#34;gibiansky&#34;</span><span>,</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span>&#34;repo&#34;</span><span>:</span> <span>&#34;IHaskell&#34;</span><span>,</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span>&#34;branch&#34;</span><span>:</span> <span>&#34;master&#34;</span><span>,</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span>&#34;rev&#34;</span><span>:</span> <span>&#34;575b2be1c25e8e7c5ed5048c8d7ead51bb9c67f0&#34;</span><span>,</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span>&#34;sha256&#34;</span><span>:</span> <span>&#34;148sdawqln2ys0s1rapwj2bwjzfq027dz5h49pa034nmyizyqs4a&#34;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span>},</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span>&#34;nixpkgs&#34;</span><span>:</span> <span>{</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span>&#34;owner&#34;</span><span>:</span> <span>&#34;NixOS&#34;</span><span>,</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span>&#34;repo&#34;</span><span>:</span> <span>&#34;nixpkgs&#34;</span><span>,</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span>&#34;branch&#34;</span><span>:</span> <span>&#34;nixos-23.11&#34;</span><span>,</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span>&#34;rev&#34;</span><span>:</span> <span>&#34;9dd7699928e26c3c00d5d46811f1358524081062&#34;</span><span>,</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span>&#34;sha256&#34;</span><span>:</span> <span>&#34;0hmsw3qd3i13dp8jhr1d96xlpkmd78m8g6shw086f6sqhn2rrvv6&#34;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span>}</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
</details>
<details>
<summary>
<code>updater</code>
</summary>
<div id="cb2"><pre><code><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span>#! /usr/bin/env nix-shell</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span>#! nix-shell -i bash</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span>#! nix-shell -p curl jq nix</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span>set</span> <span>-eufo</span> pipefail</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span>FILE</span><span>=</span><span>$1</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span>PROJECT</span><span>=</span><span>$2</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span>OWNER</span><span>=</span><span>$(</span><span>jq</span> <span>-r</span> <span>&#39;.[$project].owner&#39;</span> <span>--arg</span> project <span>&#34;</span><span>$PROJECT</span><span>&#34;</span> <span>&lt;</span> <span>&#34;</span><span>$FILE</span><span>&#34;</span><span>)</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span>REPO</span><span>=</span><span>$(</span><span>jq</span> <span>-r</span> <span>&#39;.[$project].repo&#39;</span> <span>--arg</span> project <span>&#34;</span><span>$PROJECT</span><span>&#34;</span> <span>&lt;</span> <span>&#34;</span><span>$FILE</span><span>&#34;</span><span>)</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span>DEFAULT_BRANCH</span><span>=</span><span>$(</span><span>jq</span> <span>-r</span> <span>&#39;.[$project].branch // &#34;master&#34;&#39;</span> <span>--arg</span> project <span>&#34;</span><span>$PROJECT</span><span>&#34;</span> <span>&lt;</span> <span>&#34;</span><span>$FILE</span><span>&#34;</span><span>)</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span>BRANCH</span><span>=</span><span>${3</span><span>:-</span><span>$DEFAULT_BRANCH}</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span>REV</span><span>=</span><span>$(</span><span>curl</span> <span>&#34;https://api.github.com/repos/</span><span>$OWNER</span><span>/</span><span>$REPO</span><span>/branches/</span><span>$BRANCH</span><span>&#34;</span> <span>|</span> <span>jq</span> <span>-r</span> <span>&#39;.commit.sha&#39;</span><span>)</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span>SHA256</span><span>=</span><span>$(</span><span>nix-prefetch-url</span> <span>--unpack</span> <span>&#34;https://github.com/</span><span>$OWNER</span><span>/</span><span>$REPO</span><span>/archive/</span><span>$REV</span><span>.tar.gz&#34;</span><span>)</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span>TJQ</span><span>=</span><span>$(</span><span>jq</span> <span>&#39;.[$project] = {owner: $owner, repo: $repo, branch: $branch, rev: $rev, sha256: $sha256}&#39;</span> <span>\</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span>--arg</span> project <span>&#34;</span><span>$PROJECT</span><span>&#34;</span> <span>\</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span>--arg</span> owner <span>&#34;</span><span>$OWNER</span><span>&#34;</span> <span>\</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span>--arg</span> repo <span>&#34;</span><span>$REPO</span><span>&#34;</span> <span>\</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span>--arg</span> branch <span>&#34;</span><span>$BRANCH</span><span>&#34;</span> <span>\</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span>--arg</span> rev <span>&#34;</span><span>$REV</span><span>&#34;</span> <span>\</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span>--arg</span> sha256 <span>&#34;</span><span>$SHA256</span><span>&#34;</span> <span>\</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span>&lt;</span> <span>&#34;</span><span>$FILE</span><span>&#34;</span><span>)</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span>[[</span> <span>$?</span> <span>==</span> 0 <span>]]</span> <span>&amp;&amp;</span> <span>echo</span> <span>&#34;</span><span>${TJQ}</span><span>&#34;</span> <span>&gt;|</span> <span>&#34;</span><span>$FILE</span><span>&#34;</span></span></code></pre></div>
</details>
<details>
<summary>
<code>pkgs.nix</code>
</summary>
<div id="cb3"><pre><code><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span>let</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span>fetcher</span> <span>=</span> <span>{</span> <span>owner</span><span>,</span> <span>repo</span><span>,</span> <span>rev</span><span>,</span> <span>sha256</span><span>,</span> <span>...</span> <span>}</span>: <span>builtins</span>.<span>fetchTarball</span> <span>{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span>inherit</span> sha256<span>;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span>url</span> <span>=</span> <span>&#34;https://github.com/</span><span>${</span>owner<span>}</span><span>/</span><span>${</span>repo<span>}</span><span>/tarball/</span><span>${</span>rev<span>}</span><span>&#34;</span><span>;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span>};</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span>versions</span> <span>=</span> <span>builtins</span>.mapAttrs</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span>(</span><span>_</span><span>:</span> fetcher<span>)</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span>(</span><span>builtins</span>.fromJSON <span>(</span><span>builtins</span>.readFile <span>./versions.json</span><span>));</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span>in</span> versions</span></code></pre></div>
</details>
<p>This approach still works, but in the meantime <a href="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-flake">Nix
flakes</a>
have become the primary way to manage dependencies in Nix projects. Although
they’re still listed as an experimental feature, the same is also true of the
<code>nix</code> command, and I don’t think either is going away in the foreseeable
future.</p>
<h2 id="the-fundamental-insight">The fundamental insight</h2>
<p>It turns out that you can replace <code>pkgs.nix</code>:</p>
<div id="cb4"><pre><code><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span>let</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span>fetcher</span> <span>=</span> <span>{</span> <span>owner</span><span>,</span> <span>repo</span><span>,</span> <span>rev</span><span>,</span> <span>sha256</span><span>,</span> <span>...</span> <span>}</span>: <span>builtins</span>.<span>fetchTarball</span> <span>{</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span>inherit</span> sha256<span>;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span>url</span> <span>=</span> <span>&#34;https://github.com/</span><span>${</span>owner<span>}</span><span>/</span><span>${</span>repo<span>}</span><span>/tarball/</span><span>${</span>rev<span>}</span><span>&#34;</span><span>;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span>};</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span>versions</span> <span>=</span> <span>builtins</span>.mapAttrs</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span>(</span><span>_</span><span>:</span> fetcher<span>)</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span>(</span><span>builtins</span>.fromJSON <span>(</span><span>builtins</span>.readFile <span>./versions.json</span><span>));</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span>in</span> versions</span></code></pre></div>
<p>using the relatively new <code>fetchTree</code> builtin:</p>
<div id="cb5"><pre><code><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span>let</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span>lock</span> <span>=</span> <span>builtins</span>.fromJSON <span>(</span><span>builtins</span>.readFile <span>./flake.lock</span><span>);</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span>versions</span> <span>=</span> <span>builtins</span>.mapAttrs</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span>(</span><span>_</span><span>:</span> <span>node</span><span>:</span> <span>(</span><span>builtins</span>.fetchTree node.locked<span>)</span>.outPath<span>)</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    lock.nodes<span>;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span>in</span> versions</span></code></pre></div>
<p>following which you can replace <code>updater</code> with <a href="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-flake-update"><code>nix flake update</code></a>
and <code>versions.json</code> with <code>flake.lock</code>.</p>
<h2 id="flakes-griping">Flakes griping</h2>
<p>I’ve done my best to avoid flakes for as long as possible, since there are
a couple of UI/UX issues that bother me:</p>
<h3 id="a-reliance-on-new-style-nix-commands">A reliance on new-style <code>nix</code> commands</h3>
<p>I’m pretty comfortable with <code>nix-build</code> and <code>nix-shell</code>, and it’s an adjustment
to use the newer <code>nix build</code> and <code>nix develop</code> commands since they don’t work
exactly the same (e.g. not printing build logs by default, having to use <code>.#</code>
for packages).</p>
<h3 id="coupling-dependency-and-systems-concerns">Coupling dependency and systems concerns</h3>
<p>The flakes position is that <code>system</code> is an impurity (which is reasonable
enough) and so each output is parametrised by the system and there’s no
built-in way to ignore or work around this. In practice I’ve seen most people
use <a href="https://github.com/numtide/flake-utils"><code>flake-utils</code></a> and its provided
<code>eachSystem</code> or <code>eachDefaultSystem</code> functions. For my purposes I haven’t run
into any issues with <code>eachDefaultSystem</code> and if you are shaking your head at
the screen thinking of all the ways this can go wrong then you probably don’t
need to read this blog post. Unfortunately <code>eachDefaultSystem</code> doesn’t save you
from having to supply <code>system</code> to <code>nixpkgs</code> everywhere you import it, which
makes adapting existing non-flakes projects with multiple imports of <code>nixpkgs</code>
tedious to migrate.</p>
<h3 id="surprising-interactions-with-git">Surprising interactions with <code>git</code></h3>
<p>Strange and confusing things can happen when you try to use a file that’s
currently untracked by <code>git</code>. Often it will tell you it can’t find a particular
file, even though it’s <em>right there</em>, but at other times things will appear to
work but your language-specific build tool will complain. The obvious solution
is to always <code>git add</code> everything you care about, but that has the same energy
as “I would simply write code with no bugs at all times” and is equally
non-actionable advice. The only hint you get is the message</p>
<p><code>warning: Git tree &#39;&lt;project root&gt;&#39; is dirty</code></p>
<p>as your build commences which is more often than not innocuous. I foresee
myself running into this issue over and over again when using flakes.</p>
<h2 id="why-bother-with-flakes">Why bother with flakes?</h2>
<p>Although I’m still critical of certain aspects of flakes, they do provide one
feature I was missing: the ability to manage and update dependencies without
the use of
<a href="https://nixos.org/manual/nix/stable/language/import-from-derivation">IFD</a>.
I also get the impression that the vast majority of effort being put into Nix
now is in and around the flakes ecosystem, e.g.
<a href="https://flakehub.com/">FlakeHub</a> and <a href="https://github.com/DeterminateSystems/update-flake-lock">the <code>update-flake-lock</code> GitHub
Action</a>. Keeping all
this in mind, I think there is a way to ignore most of the stuff I don’t care
about for now while getting rid of my primitive shell script in favour of
robust and better-supported dependency management code that’s built into Nix.
That way I can gradually integrate flakes more deeply, and if I’m wrong about
it being the future I still have the option to go back to what I was using
before (or adopt whatever the new hotness is).</p>
<h2 id="a-minimal-flake">A minimal flake</h2>
<p>The first hurdle to overcome is replacing <code>default.nix</code> with <code>flake.nix</code>. I’ve
found that this is a good starting point for me:</p>
<div id="cb6"><pre><code><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span>inputs</span>.<span>nixpkgs</span>.<span>url</span> <span>=</span> <span>&#34;github:NixOS/nixpkgs/release-23.11&#34;</span><span>;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span>inputs</span>.<span>flake-utils</span>.<span>url</span> <span>=</span> <span>&#34;github:numtide/flake-utils&#34;</span><span>;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span>inputs</span>.<span>flake-compat</span>.<span>url</span> <span>=</span> <span>&#34;github:edolstra/flake-compat&#34;</span><span>;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span>outputs</span> <span>=</span> <span>{</span><span>nixpkgs</span><span>,</span> <span>flake-utils</span><span>,</span> <span>...}</span>:</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    flake<span>-</span>utils.lib.eachDefaultSystem <span>(</span><span>system</span><span>:</span> <span>let</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>      <span>pkgs</span> <span>=</span> <span>import</span> nixpkgs <span>{</span> <span>inherit</span> system<span>;</span> <span>};</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>      <span># ...</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span>in</span> <span>{</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>      <span>defaultPackage</span> <span>=</span> <span>null</span><span>;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>      <span>devShell</span> <span>=</span> <span>null</span><span>;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span>});</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>combined with this snippet in <code>default.nix</code> taken from the <a href="https://github.com/edolstra/flake-compat/blob/0f9255e01c2351cc7d116c072cb317785dd33b33/README.md#usage"><code>flake-compat</code>
README</a>:</p>
<div id="cb7"><pre><code><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span>(</span><span>import</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span>(</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span>let</span> <span>lock</span> <span>=</span> <span>builtins</span>.fromJSON <span>(</span><span>builtins</span>.readFile <span>./flake.lock</span><span>);</span> <span>in</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span>fetchTarball</span> <span>{</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>      <span>url</span> <span>=</span> lock.nodes.flake<span>-</span>compat.locked.url <span>or</span> <span>&#34;https://github.com/edolstra/flake-compat/archive/</span><span>${</span>lock.nodes.flake<span>-</span>compat.locked.rev<span>}</span><span>.tar.gz&#34;</span><span>;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>      <span>sha256</span> <span>=</span> lock.nodes.flake<span>-</span>compat.locked.narHash<span>;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span>)</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span>{</span> <span>src</span> <span>=</span> <span>./.</span><span>;</span> <span>}</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span>)</span>.defaultNix</span></code></pre></div>
<p>A couple of things are worth pointing out:</p>
<ul>
<li>I include <code>flake-compat</code> in my inputs but I don’t actually use it in
<code>flake.nix</code>, it is declared solely so that it can be tracked in <code>flake.lock</code>.</li>
<li>I could include more dependencies here, as long as <code>nix flake update</code> knows
how to fetch them, which is already a huge improvement over my
GitHub-specific <code>updater</code> script.</li>
<li>If your input is a flake but you’re not using it in <code>flake.nix</code>, you probably
want to set <code>inpugs.&lt;input&gt;.flake = false</code> so that it doesn’t pull in that
flake’s dependencies too.</li>
<li>The <code>default.nix</code> snippet doesn’t have the old Nix behaviour of doing the
right thing when used with <code>nix-shell</code>, but I could probably recover this by
including (or reimplementing)
<a href="https://github.com/NixOS/nixpkgs/blob/9b5d456802b2322b36b69dca65b04095877495ad/lib/trivial.nix#L235-L240"><code>lib.inNixShell</code></a>
and using it.</li>
</ul>
<h2 id="migrating-all-the-things">Migrating all the things</h2>
<p>I recently went on a tear, moving a bunch of my repositories over to this workflow:</p>
<ul>
<li><a href="https://github.com/vaibhavsagar/resume/commit/a698b2df6e37c67bc05b57547d345883e76eb491"><code>resume</code></a></li>
<li><a href="https://github.com/vaibhavsagar/notebooks/commit/daa4f593f2bcacdb318f57525887c853db838304"><code>notebooks</code></a></li>
<li><a href="https://github.com/vaibhavsagar/website/commit/760a4b4c8f44347fbe3bb39203383c4a1b42178d"><code>website</code></a></li>
</ul>
<p>It was reasonably straightforward, except in the case of <code>notebooks</code>, where
I have a bunch of expressions that each have their own overlays etc. that
I wasn’t ready to unify just yet. This meant a lot of <code>{ system ? builtins.currentSystem }</code> which I could have done without. It’s an
anti-pattern to import <code>nixpkgs</code> in multiple places anyway, so this is probably
a sign that there is a better way to organise my expressions.</p>
<h2 id="further-reading">Further reading</h2>
<p>I was partly inspired to try this after reading Jade Lovelace’s <a href="https://jade.fyi/blog/flakes-arent-real/">excellent blog
post</a> about Nix flakes. Thank you
Jade!</p>

        </div></div>
  </body>
</html>
