<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://www.righto.com/2023/09/8086-flip-flops.html">Original</a>
    <h1>How flip-flops are implemented in the Intel 8086 processor</h1>
    
    <div id="readability-page-1" class="page"><div id="post-body-4830316179108208609" itemprop="description articleBody"><p>
A key concept for a processor is the management of &#34;state&#34;, information that persists
over time.
Much of a computer is built from logic gates, such as NAND or NOR gates, but logic gates
have no notion of time.
Processors also need a way to hold values, along with a mechanism to move from
step to step in a controlled fashion.
This is the role of &#34;sequential logic&#34;, where the output depends on what happened before.
Sequential logic usually operates off a clock signal,<span id="fnref:asynchronous"><a href="#fn:asynchronous">1</a></span>
a sequence of regular pulses that controls the timing of the computer.
(If you have a 3.2 GHz processor, for instance, that number is the clock frequency.)</p>
<p>A circuit called the flip-flop is a fundamental building block for sequential logic.
A flip-flop can hold one bit of state, a &#34;0&#34; or a &#34;1&#34;, changing its value when the
clock changes.
Flip-flops are a key part of processors, with multiple roles.
Several flip-flops can be combined to form a register, holding a value.
Flip-flops are also used to build &#34;state machines&#34;, circuits that move from step to step
in a controlled sequence.
A flip-flops can also delay a signal, holding it from from one clock cycle to the next.</p>
<p>Intel introduced the groundbreaking 8086 microprocessor in 1978, starting the x86 architecture
that is widely used today.
In this blog post, I take a close look at the flip-flops in the 8086: what they do and
how they are implemented.
In particular, I will focus on the dynamic flip-flop, which holds its
value using capacitance, much like DRAM.<span id="fnref:cross-coupled"><a href="#fn:cross-coupled">2</a></span>
Many of these flip-flops use a somewhat unusual &#34;enable&#34; input, which allows the flip-flop
to hold its value for multiple clock cycles.</p>
<p><a href="https://static.righto.com/images/8086-flipflop/die-labeled.jpg"><img alt="The 8086 die under the microscope, with the main functional blocks.
I count 184 flip-flops with enable and 53 without enable.
Click this image (or any other) for a larger version." height="691" src="https://static.righto.com/images/8086-flipflop/die-labeled-w700.jpg" title="The 8086 die under the microscope, with the main functional blocks.
I count 184 flip-flops with enable and 53 without enable.
Click this image (or any other) for a larger version." width="700"/></a></p><p>The 8086 die under the microscope, with the main functional blocks.
I count 184 flip-flops with enable and 53 without enable.
Click this image (or any other) for a larger version.</p>
<p>The die photo above shows the silicon die of the 8086.
In this image, I have removed the metal and polysilicon layers to show the silicon transistors underneath.
The colored squares indicate the flip-flops: blue flip-flops have an <code>enable</code> input, while red lack <code>enable</code>.
Flip-flops are used throughout the processor for a variety of roles.
Around the edges, they hold the state for output pins.
The control circuitry makes heavy use of flip-flops for various state machines, such as
moving through the &#34;T states&#34; that control the bus cycle.
The &#34;<a href="https://www.righto.com/2023/01/the-8086-processors-microcode-pipeline.html#:~:text=a%20memory%20access.-,The%20loader,-To%20decode%20and">loader</a>&#34; uses a state machine to start each instruction.
The instruction register, along with some special-purpose registers (<a href="https://www.righto.com/2023/03/8086-register-codes.html">N, M</a>, and X) are built with
flip-flops.
Other flip-flops track the instructions in the prefetch queue.
The microcode engine uses flip-flops to hold the current microcode address as well as to
latch the 21-bit output from the microcode ROM.
The ALU (Arithmetic/Logic Unit) uses flip-flops to hold the status flags,
temporary input values, and information on the operation.</p>


<h2>The flip-flop circuit</h2>
<p>In this section, I&#39;ll explain how the flip-flop circuits work, starting with a basic D flip-flop.
The D flip-flop (below) takes a data input (D) and stores that value, 0 or 1.
The output is labeled <code>Q</code>, while the inverted output is called <code>Q</code> (Q-bar).
This flip-flop is &#34;edge triggered&#34;, so the storage happens
on the edge when the clock changes from low to high.<span id="fnref:polarity"><a href="#fn:polarity">4</a></span>
Except at this transition, the input can change without affecting the output.</p>
<p><a href="https://static.righto.com/images/8086-flipflop/d-flip-flop2.png"><img alt="The symbol for a D flip-flop." height="108" src="https://static.righto.com/images/8086-flipflop/d-flip-flop2-w150.png" title="The symbol for a D flip-flop." width="150"/></a></p><p>The symbol for a D flip-flop.</p>
<p>The 8086 implements most of its flip-flops dynamically, using <a href="https://en.wikipedia.org/wiki/Flip-flop_(electronics)#Edge-triggered_dynamic_D_storage_element">pass transistor logic</a>.
That is, the capacitance of the wiring holds the 0 or 1 state.
The dynamic implementation is more compact than the typical static flip-flop implementation,
so it is often used in processors.
However, the charge on the wire&#39;s capacitance will eventually leak away, just like DRAM (dynamic RAM).
Thus, the clock must keep going or the values will be lost.<span id="fnref:minimum-clock-speed"><a href="#fn:minimum-clock-speed">3</a></span>
This behavior is different from a typical flip-flop chip, which will hold its value until the
next clock, whether that is a microsecond later or a day later.</p>
<p>The D flip-flop is built from two latch<span id="fnref:latch"><a href="#fn:latch">5</a></span> stages, each consisting of a pass transistor and an inverter.<span id="fnref:intel"><a href="#fn:intel">6</a></span>
The first pass transistor passes the input value through while the clock is low. When the clock switches high,
the first pass transistor turns off and isolates the inverter from the input, but the value persists due to the wire&#39;s capacitance (blue arrow).
Meanwhile, the second pass transistor switches on, passing the value from the first inverter through the second
inverter to the output.
Similarly, when the clock switches low, the second transistor switches off but the value is held by wire capacitance
at the green arrow.
(The circuit does not need an explicit capacitor; the wiring has enough capacitance to hold
the value.)
Thus, the output holds the value of the <code>D</code> input that was present at the moment when the clock switched from low to high.
Any other changes to the <code>D</code> input do not affect the output.</p>
<p><a href="https://static.righto.com/images/8086-flipflop/d-flip-flop-schematic.png"><img alt="Schematic of a D flip-flop built from pass transistor logic." height="103" src="https://static.righto.com/images/8086-flipflop/d-flip-flop-schematic-w350.png" title="Schematic of a D flip-flop built from pass transistor logic." width="350"/></a></p><p>Schematic of a D flip-flop built from pass transistor logic.</p>
<p>The basic flip-flop can be modified by adding an &#34;enable&#34; input that enables or blocks the clock.<span id="fnref:enable"><a href="#fn:enable">7</a></span>
When the <code>enable</code> input is high, the flip-flop records the <code>D</code> input on the clock edge as before, but when the <code>enable</code> input is low, the flip-flop holds its previous value.
The <code>enable</code> input allows the flip-flop to hold its value for an arbitrarily long period of time.</p>
<p><a href="https://static.righto.com/images/8086-flipflop/enable-flip-flop.png"><img alt="The symbol for the D flip-flop with enable." height="114" src="https://static.righto.com/images/8086-flipflop/enable-flip-flop-w150.png" title="The symbol for the D flip-flop with enable." width="150"/></a></p><p>The symbol for the D flip-flop with enable.</p>
<p>The enable flip-flop is constructed from a D flip-flop by feeding the flip-flop&#39;s output back to the input as shown below.
When the <code>enable</code> input is 0, the multiplexer selects the current <code>Q</code> output as the new flip-flop D input,
so the flip-flop retains its previous value.
But when the <code>enable</code> input is 1, the multiplexer selects the new <code>D</code> value.
(You can think of the <code>enable</code> input as selecting &#34;hold&#34; versus &#34;load&#34;.)</p>
<p><a href="https://static.righto.com/images/8086-flipflop/enable-flip-flop-diagram.png"><img alt="Block diagram of a flip-flop with an enable input." height="141" src="https://static.righto.com/images/8086-flipflop/enable-flip-flop-diagram-w280.png" title="Block diagram of a flip-flop with an enable input." width="280"/></a></p><p>Block diagram of a flip-flop with an enable input.</p>
<p>The multiplexer is implemented with two more pass transistors, as shown on the left below.<span id="fnref:mux"><a href="#fn:mux">8</a></span>
When <code>enable</code> is low, the upper pass transistor
switches on, passing the current <code>Q</code> output back to the input. When <code>enable</code> is high, the lower pass transistor switches on,
passing the <code>D</code> input through to the flip-flop.
The schematic below also shows how the inverted <code>Q&#39;</code> output is provided by the first inverter.
The circuit &#34;cheats&#34; a bit; since the inverted output bypasses the second transistor, this output can
change before the clock edge.</p>
<p><a href="https://static.righto.com/images/8086-flipflop/enable-flip-flop-schematic.png"><img alt="Schematic of a flip-flop with an enable input." height="199" src="https://static.righto.com/images/8086-flipflop/enable-flip-flop-schematic-w600.png" title="Schematic of a flip-flop with an enable input." width="600"/></a></p><p>Schematic of a flip-flop with an enable input.</p>
<p>The flip-flops often have a <code>set</code> or <code>clear</code> input, setting the flip-flop high or low.
This input is typically connected to the processor&#39;s &#34;reset&#34; line, ensuring that the flip-flops are initialized
to the proper state when the processor is started.
The symbol below shows a flip-flop with a <code>clear</code> input.</p>
<p><a href="https://static.righto.com/images/8086-flipflop/clear-flip-flop.png"><img alt="The symbol for the D flip-flop with enable and clear inputs." height="141" src="https://static.righto.com/images/8086-flipflop/clear-flip-flop-w150.png" title="The symbol for the D flip-flop with enable and clear inputs." width="150"/></a></p><p>The symbol for the D flip-flop with enable and clear inputs.</p>
<p>To support the clear function, a NOR gate replaces the inverter as shown below (red).
When the <code>clear</code> input is high, it forces the output from the NOR gate to be low.
Note that the <code>clear</code> input is asynchronous, changing the <code>Q</code> output immediately. The inverted <code>Q</code> output, however,  doesn&#39;t change until
<code>clk</code> is high and the output cycles around.
A similar modification implements a <code>set</code> input that forces the flip-flop high: a NOR gate replaces the first inverter.</p>
<p><a href="https://static.righto.com/images/8086-flipflop/clear-flip-flop-schematic.png"><img alt="This schematic shows the circuitry for the clear flip-flop." height="232" src="https://static.righto.com/images/8086-flipflop/clear-flip-flop-schematic-w600.png" title="This schematic shows the circuitry for the clear flip-flop." width="600"/></a></p><p>This schematic shows the circuitry for the clear flip-flop.</p>
<h2>Implementing a flip-flop in silicon</h2>
<p>The diagram below shows two flip-flops as they appear on the die.
The bright gray regions are doped silicon, the bottom layer of the chip
The brown lines are polysilicon, a layer on top of the silicon. When polysilicon crosses doped silicon, a transistor is formed with a polysilicon gate.
The black circles are vias (connections) to the metal layer.
The metal layer on top provides wiring between the transistors.
I removed the metal layer with acid to make the underlying circuitry visible.
Faint purple lines remain on the die, showing where the metal wiring was.</p>
<p><a href="https://static.righto.com/images/8086-flipflop/flip-flop-die.jpg"><img alt="Two flip-flops on the 8086 die." height="274" src="https://static.righto.com/images/8086-flipflop/flip-flop-die-w700.jpg" title="Two flip-flops on the 8086 die." width="700"/></a></p><p>Two flip-flops on the 8086 die.</p>
<p>Although the two flip-flops have the same circuitry, their layouts on the die are completely different.
In the 8086, each transistor was carefully shaped and positioned to make the layout compact, so the layout depends on the surrounding
logic and the connections.
This is in contrast to modern standard-cell layout, which uses a standard layout for each block (logic gate,
flip-flop, etc.) and puts the cells in orderly rows.
(Intel moved to standard-cell wiring for much of the logic in the the 386 processor since it is much faster to create
a standard-cell design than to perform manual layout.)</p>
<h2>Conclusions</h2>
<p>The flip-flop with <code>enable</code> input is a key part of the 8086, appearing throughout the processor.
However, the <code>enable</code> input is a fairly obscure feature for a flip-flop component;
most flip-flop chips have a clock input, but not an enable.<span id="fnref:chips"><a href="#fn:chips">9</a></span>
Many FPGA and ASIC synthesis libraries, though, provide it, under the name
&#34;D flip-flop with enable&#34; or &#34;D flip-flop with clock enable&#34;.</p>
<p>I plan to write more on the 8086, so 
follow me on Twitter <a href="https://twitter.com/kenshirriff">@kenshirriff</a> or <a href="http://www.righto.com/feeds/posts/default">RSS</a> for updates.
I&#39;ve also started experimenting with Mastodon recently as <a href="https://oldbytes.space/@kenshirriff">@<span data-cfemail="c6ada3a8b5aeafb4b4afa0a086a9aaa2a4bfb2a3b5e8b5b6a7a5a3">[emailÂ protected]</span></a>
so you can follow me there too.</p>
<h2>Notes and references</h2>


</div></div>
  </body>
</html>
