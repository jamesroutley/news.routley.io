<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://planetscale.com/blog/fastpage-faster-offset-pagination-for-rails-apps">Original</a>
    <h1>Faster offset pagination for Rails apps</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>We&#39;d like to introduce <a href="https://github.com/planetscale/fast_page">FastPage</a>, a new gem for ActiveRecord that applies the MySQL &#34;deferred join&#34; optimization to your <code>offset</code>/<code>limit</code> queries.</p>
<p>Here is a slow pagination query in Rails:</p>

<p>We add <code>.fast_page</code> to the query and now it&#39;s 2.7x faster!</p>

<h2 id="benchmark"><a href="#benchmark">Benchmark<span aria-label="Permalink to this section">#</span></a></h2>
<p>We wanted to see just how much faster using the deferred join could be. We took a table with about 1 million records in it and benchmarked the standard ActiveRecord <code>offset</code>/<code>limit</code> query vs the query with FastPage.</p>
<p>Here is the query:</p>

<p>Both <code>owner</code> and <code>created_at</code> are indexed.</p>
<p><span><img alt="Graph showing deferred join benchmarks for Activerecord vs with FastPage over 2000 pages, FastPage almost linear line with a small fraction of Activerecord" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="fill"/></span></p>
<p>As you can see in the chart above, it&#39;s significantly faster the further into the table we paginate.</p>
<h2 id="how-this-works"><a href="#how-this-works">How this works<span aria-label="Permalink to this section">#</span></a></h2>
<p>The most common form of pagination is implemented using <code>LIMIT</code> and <code>OFFSET</code>.</p>
<p>In this example, each page returns 50 blog posts. For the first page, we grab the first 50 posts. On the 2nd page we grab 100 posts and throw away the first 50. As the <code>OFFSET</code> increases, each additional page becomes more expensive for the database to serve.</p>

<p>This method of pagination works well until you have a large number of records. The later pages become very expensive to serve. Because of this, applications will often have to limit the maximum number of pages they allow users to view or swap to cursor based pagination.</p>
<h3>Deferred join technique</h3>
<p><a href="https://learning.oreilly.com/library/view/high-performance-mysql/9781492080503/">High Performance MySQL</a> recommends using a &#34;deferred join&#34; to increase the efficiency of <code>LIMIT</code>/<code>OFFSET</code> pagination for large tables.</p>

<p>Notice that we first select the ID of all the rows we want to show, then the data for those rows. This technique works &#34;because it lets the server examine as little data as possible in an index without accessing rows.&#34;</p>
<p>The FastPage gem makes it easy to apply this optimization to any <code>ActiveRecord::Relation</code> using <code>offset</code>/<code>limit</code>.</p>
<blockquote>
<p>To learn more on how this works, check out this blog post: <a href="https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins">Efficient Pagination Using Deferred Joins</a>.</p>
</blockquote>
<h2 id="when-should-i-use-this?"><a href="#when-should-i-use-this?">When should I use this?<span aria-label="Permalink to this section">#</span></a></h2>
<p><code>fast_page</code> works best on pagination queries that include an <code>ORDER BY</code>. It becomes more effective as the page number increases. You should test it on your application&#39;s data to see how it improves your query times.</p>
<p>Because <code>fast_page</code> runs 2 queries instead of 1, it is very likely a bit slower for early pages. The benefits begin as the user gets into deeper pages. It&#39;s worth testing to see at which page your application gets faster from using <code>fast_page</code> and only applying to your queries then.</p>

<h2 id="thank-you-❤️"><a href="#thank-you-❤️">Thank you ❤️<span aria-label="Permalink to this section">#</span></a></h2>
<p>This gem was inspired by <a href="https://github.com/hammerstonedev/fast-paginate">Hammerstone&#39;s <code>fast-paginate</code> for Laravel</a> and <a href="https://github.com/aarondfrancis">@aarondfrancis</a>&#39;s excellent blog post: <a href="https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins">Efficient Pagination Using Deferred Joins</a>. We were so impressed with the results, we had to bring this to Rails as well.</p>
</div></div></div>
  </body>
</html>
