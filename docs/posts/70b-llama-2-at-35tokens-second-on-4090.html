<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/turboderp/exllamav2">Original</a>
    <h1>70B Llama 2 at 35tokens/second on 4090</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">This is a very initial release of ExLlamaV2, an inference library for running local LLMs on modern consumer GPUs.</p>
<p dir="auto">It still needs a lot of testing and tuning, and a few key features are not yet implemented. Don&#39;t be surprised if
things are a bit broken to start with, as almost all of this code is completely new and only tested on a few setups
so far.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-overview-of-differences-compared-to-v1" aria-hidden="true" tabindex="-1" href="#overview-of-differences-compared-to-v1"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Overview of differences compared to V1</h2>
<ul dir="auto">
<li>Faster, better kernels</li>
<li>Cleaner and more versatile codebase</li>
<li>Support for a new quant format (see below)</li>
</ul>
<h2 tabindex="-1" dir="auto"><a id="user-content-performance" aria-hidden="true" tabindex="-1" href="#performance"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Performance</h2>
<p dir="auto">Some quick tests to compare performance with V1. There may be more performance optimizations in the future, and
speeds will vary across GPUs, with slow CPUs still being a potential bottleneck:</p>
<table>
<thead>
<tr>
<th>Model</th>
<th>Mode</th>
<th>Size</th>
<th>grpsz</th>
<th>act</th>
<th>V1: 3090Ti</th>
<th>V1: 4090</th>
<th>V2: 3090Ti</th>
<th>V2: 4090</th>
</tr>
</thead>
<tbody>
<tr>
<td>Llama</td>
<td>GPTQ</td>
<td>7B</td>
<td>128</td>
<td>no</td>
<td>143 t/s</td>
<td>173 t/s</td>
<td>175 t/s</td>
<td><strong>195</strong> t/s</td>
</tr>
<tr>
<td>Llama</td>
<td>GPTQ</td>
<td>13B</td>
<td>128</td>
<td>no</td>
<td>84 t/s</td>
<td>102 t/s</td>
<td>105 t/s</td>
<td><strong>110</strong> t/s</td>
</tr>
<tr>
<td>Llama</td>
<td>GPTQ</td>
<td>33B</td>
<td>128</td>
<td>yes</td>
<td>37 t/s</td>
<td>45 t/s</td>
<td>45 t/s</td>
<td><strong>48</strong> t/s</td>
</tr>
<tr>
<td>OpenLlama</td>
<td>GPTQ</td>
<td>3B</td>
<td>128</td>
<td>yes</td>
<td>194 t/s</td>
<td>226 t/s</td>
<td>295 t/s</td>
<td><strong>321</strong> t/s</td>
</tr>
<tr>
<td>CodeLlama</td>
<td>EXL2 4.0 bpw</td>
<td>34B</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>42 t/s</td>
<td><strong>48</strong> t/s</td>
</tr>
<tr>
<td>Llama2</td>
<td>EXL2 3.0 bpw</td>
<td>7B</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>195 t/s</td>
<td><strong>224</strong> t/s</td>
</tr>
<tr>
<td>Llama2</td>
<td>EXL2 4.0 bpw</td>
<td>7B</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>164 t/s</td>
<td><strong>197</strong> t/s</td>
</tr>
<tr>
<td>Llama2</td>
<td>EXL2 5.0 bpw</td>
<td>7B</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>144 t/s</td>
<td><strong>160</strong> t/s</td>
</tr>
<tr>
<td>Llama2</td>
<td>EXL2 2.5 bpw</td>
<td>70B</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>30 t/s</td>
<td><strong>35</strong> t/s</td>
</tr>
<tr>
<td>TinyLlama</td>
<td>EXL2 3.0 bpw</td>
<td>1.1B</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>536 t/s</td>
<td><strong>635</strong> t/s</td>
</tr>
<tr>
<td>TinyLlama</td>
<td>EXL2 4.0 bpw</td>
<td>1.1B</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>509 t/s</td>
<td><strong>590</strong> t/s</td>
</tr>
</tbody>
</table>
<h2 tabindex="-1" dir="auto"><a id="user-content-how-to" aria-hidden="true" tabindex="-1" href="#how-to"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>How to</h2>
<p dir="auto">Clone the repository and install dependencies:</p>
<div data-snippet-clipboard-copy-content="git clone https://github.com/turboderp/exllamav2
cd exllamav2
pip install -r requirements.txt

python test_inference.py -m &lt;path_to_model&gt; -p &#34;Once upon a time,&#34;"><pre><code>git clone https://github.com/turboderp/exllamav2
cd exllamav2
pip install -r requirements.txt

python test_inference.py -m &lt;path_to_model&gt; -p &#34;Once upon a time,&#34;
</code></pre></div>
<p dir="auto">For now, a simple console chatbot is included. Run it with:</p>
<div data-snippet-clipboard-copy-content="python examples/chat.py -m &lt;path_to_model&gt; -mode llama"><pre><code>python examples/chat.py -m &lt;path_to_model&gt; -mode llama
</code></pre></div>
<p dir="auto">The <code>-mode</code> argument chooses the prompt format to use. <code>llama</code> is for the Llama(2)-chat finetunes, while <code>codellama</code>
probably works better for CodeLlama-instruct. <code>raw</code> will produce a simple chatlog-style chat that works with base
models and various other finetunes. You can also provide a custom system prompt with <code>-sp</code>.</p>
<h3 tabindex="-1" dir="auto"><a id="user-content-installation" aria-hidden="true" tabindex="-1" href="#installation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Installation</h3>
<p dir="auto">To install as a library (not required for the included examples), clone the repository and run:</p>
<div data-snippet-clipboard-copy-content="python setup.py install --user"><pre><code>python setup.py install --user
</code></pre></div>
<p dir="auto">ExLlamaV2 relies on a Torch C++ extension for its CUDA functions, which is compiled at runtime. This means the first
time the library is used it will take 10-20 seconds (depending on your hardware) to start, but the extension gets cached
for subsequent use. A PyPI package will evantually be available with an option to install a precompiled extension.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-exl2-quantization" aria-hidden="true" tabindex="-1" href="#exl2-quantization"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>EXL2 quantization</h2>
<p dir="auto">ExLlamaV2 supports the same 4-bit GPTQ models as V1, but also a new &#34;EXL2&#34; format. EXL2 is based on the same
optimization method as GPTQ and supports 2, 3, 4, 5, 6 and 8-bit quantization. The format allows for mixing quantization
levels within a model to achieve any average bitrate between 2 and 8 bits per weight.</p>
<p dir="auto">Moreover, it&#39;s possible to apply multiple quantization levels to each linear layer, producing something akin to sparse
quantization wherein more important weights (columns) are quantized with more bits. The same remapping trick that lets
ExLlama work efficiently with act-order models allows this mixing of formats to happen with little to no impact on
performance.</p>
<p dir="auto">Parameter selection is done automatically by quantizing each matrix multiple times, measuring the quantization
error (with respect to the chosen calibration data) for each of a number of possible settings, per layer. Finally, a
combination is chosen that minimizes the maximum quantization error over the entire model while meeting a target
average bitrate.</p>
<p dir="auto">In my tests, this scheme allows Llama2 70B to run on a single 24 GB GPU with a 2048-token context, producing coherent
and mostly stable output with 2.55 bits per weight. 13B models run at 2.65 bits within 8 GB of VRAM, although currently
none of them uses GQA which effectively limits the context size to 2048. In either case it&#39;s unlikely that the model
will fit alongside a desktop environment. For now.</p>
<p dir="auto"><a href="https://github.com/turboderp/exllamav2/blob/master/doc/llama2_70b_chat.png"><img src="https://github.com/turboderp/exllamav2/raw/master/doc/llama2_70b_chat_thumb.png" alt="chat_screenshot"/></a>
<a href="https://github.com/turboderp/exllamav2/blob/master/doc/codellama_13b_instruct.png"><img src="https://github.com/turboderp/exllamav2/raw/master/doc/codellama_13b_instruct_thumb.png" alt="chat_screenshot"/></a></p>
<h3 tabindex="-1" dir="auto"><a id="user-content-conversion" aria-hidden="true" tabindex="-1" href="#conversion"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Conversion</h3>
<p dir="auto">A script is provided to quantize models. Converting large models can be somewhat slow, so be warned. To use it:</p>
<div data-snippet-clipboard-copy-content="python convert.py \
    -i &lt;input_HF_model&gt; \
    -o &lt;output_work_directory&gt; \
    -c &lt;calibration_data_file&gt; \
    -b &lt;target_bits_per_weight&gt;"><pre><code>python convert.py \
    -i &lt;input_HF_model&gt; \
    -o &lt;output_work_directory&gt; \
    -c &lt;calibration_data_file&gt; \
    -b &lt;target_bits_per_weight&gt;
</code></pre></div>
<p dir="auto">The output directory should be empty when you start converting. The script will dump a bunch of files there as it
works, so it can resume an interrupted job if you point it to the same output directory a second time.</p>
<p dir="auto">After the first pass is completed, a <code>measurement.json</code> file will be written to the output directory. This can be
supplied (with the <code>-m</code> argument) to subsequent conversion jobs to skip the first pass and save some time when quantizing
the same model to different bitrates. Once complete, the quantized tensors will be compiled into <code>output.safetensors</code>,
and this file can replace the safetensors file in the original HF model.</p>
<p dir="auto">Roughly speaking, you&#39;ll need about 24 GB of VRAM to convert a 70B model, while 7B seems to require about 8 GB. There
are optimizations planned to accelerate conversion, utilizing more or larger GPUs.</p>
<h3 tabindex="-1" dir="auto"><a id="user-content-huggingface-repos" aria-hidden="true" tabindex="-1" href="#huggingface-repos"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>HuggingFace repos</h3>
<p dir="auto">I&#39;ve uploaded a few EXL2-quantized models to HuggingFace to play around with, <a href="https://huggingface.co/turboderp" rel="nofollow">here</a>.</p>
<p dir="auto">Note that these were produced over a period of time with different calibration data, so they&#39;re not useful as a way to
measure quantization loss. Thorough perplexity and accuracy tests are coming, once I&#39;ve had time to convert models for
that purpose.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-more-to-come" aria-hidden="true" tabindex="-1" href="#more-to-come"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>More to come</h2>
<p dir="auto">There are still things that need to be ported over from V1, and other planned features. Among them:</p>
<ul dir="auto">
<li>PyPi package with prebuilt extensions</li>
<li>LoRA support</li>
<li>Example web UI</li>
<li>Web server</li>
<li>More samplers</li>
</ul>
<h2 tabindex="-1" dir="auto"><a id="user-content-updates" aria-hidden="true" tabindex="-1" href="#updates"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Updates</h2>
<p dir="auto"><strong>2023-09-13</strong>: Preliminary ROCm support added, thanks to @ardfork. Bumped to 0.0.1</p>
</article>
          </div></div>
  </body>
</html>
