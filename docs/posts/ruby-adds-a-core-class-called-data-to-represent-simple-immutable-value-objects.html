<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.saeloun.com/2022/11/22/data-immutable-object.html">Original</a>
    <h1>Ruby adds a core class called Data to represent simple immutable value objects</h1>
    
    <div id="readability-page-1" class="page"><article>
  <p>Ruby 3.1 adds a <a href="https://github.com/ruby/ruby/pull/6353">new core class called Data</a> to represent simple immutable value objects. The Data class helps define simple classes for value-alike objects that can be extended with custom methods.</p>

<p>While the Data class is not meant to be used directly, it can be used as a base class for creating custom value objects. The Data class is similar to Struct, but the key difference being that it is immutable.</p>

<p>Discussions started in <a href="https://bugs.ruby-lang.org/issues/16122#change-99339">Ruby forums</a> to build a data model on the principles of the Value Object, introduced by <a href="https://martinfowler.com/bliki/ValueObject.html">Martin Fowler</a>. It has the following properties:</p>
<ul>
  <li>Immutable</li>
  <li>Compared by type &amp; value</li>
  <li>Extensible</li>
</ul>

<p>Let’s look at an example of defining a Data class that represents a person.</p>

<figure><pre><code data-lang="ruby">  <span>irb</span><span>(</span><span>main</span><span>):</span><span>001</span><span>:</span><span>0</span><span>&gt;</span> <span>Person</span> <span>=</span> <span>Data</span><span>.</span><span>define</span><span>(</span><span>:name</span><span>,</span> <span>:dob</span><span>)</span>
  <span>=&gt;</span> <span>Person</span></code></pre></figure>

<p><code>Data.define</code> takes a list of symbols and returns a new class. Each symbol is an member of the newly defined Person class.</p>

<p>Now let’s use the Person class to create a new person object.</p>

<figure><pre><code data-lang="ruby">  <span>irb</span><span>(</span><span>main</span><span>):</span><span>002</span><span>:</span><span>0</span><span>&gt;</span> <span>john</span> <span>=</span> <span>Person</span><span>.</span><span>new</span><span>(</span><span>&#34;John&#34;</span><span>,</span> <span>Date</span><span>.</span><span>new</span><span>(</span><span>1990</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>))</span>
  <span>=&gt;</span> <span>#&lt;Person:0x00007f9b0c0b0a00 @name=&#34;John&#34;, @dob=#&lt;Date: 1990-01-01 ((2447892j,0s,0n),+0s,2299161j)&gt;&gt;</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>003</span><span>:</span><span>0</span><span>&gt;</span> <span>john</span><span>.</span><span>name</span>
  <span>=&gt;</span> <span>&#34;John&#34;</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>004</span><span>:</span><span>0</span><span>&gt;</span> <span>john</span><span>.</span><span>dob</span><span>.</span><span>to_s</span>
  <span>=&gt;</span> <span>&#34;1990-01-01&#34;</span></code></pre></figure>

<p>However remember that the Person class is immutable. Let’s try to change the name of the person.</p>

<figure><pre><code data-lang="ruby">  <span>irb</span><span>(</span><span>main</span><span>):</span><span>005</span><span>:</span><span>0</span><span>&gt;</span> <span>john</span><span>.</span><span>name</span> <span>=</span> <span>&#34;John Doe&#34;</span>
  <span>(</span><span>irb</span><span>):</span><span>5</span><span>:in</span> <span>`&lt;main&gt;&#39;: undefined method `</span><span>name</span><span>=</span><span>&#39;</span> <span>for</span> <span>#&lt;data Person name=&#34;John&#34;, dob=#&lt;Date: 1990-01-01 ((2447893j,0s,0n),+0s,2299161j)&gt;&gt; (NoMethodError)</span>
  <span>Did</span> <span>you</span> <span>mean?</span>  <span>name</span></code></pre></figure>

<p>This is the main difference between Data and Struct. Struct is mutable, while Data is immutable.</p>

<p>Let’s define the same Person class using Struct to see the difference.</p>

<figure><pre><code data-lang="ruby">  <span>irb</span><span>(</span><span>main</span><span>):</span><span>006</span><span>:</span><span>0</span><span>&gt;</span> <span>PersonStruct</span> <span>=</span> <span>Struct</span><span>.</span><span>new</span><span>(</span><span>:name</span><span>,</span> <span>:dob</span><span>)</span>
  <span>=&gt;</span> <span>PersonStruct</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>007</span><span>:</span><span>0</span><span>&gt;</span> <span>john_struct</span> <span>=</span> <span>PersonStruct</span><span>.</span><span>new</span><span>(</span><span>&#34;John&#34;</span><span>,</span> <span>Date</span><span>.</span><span>new</span><span>(</span><span>1990</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>))</span>
  <span>=&gt;</span> <span>#&lt;struct PersonStruct name=&#34;John&#34;, dob=#&lt;Date: 1990-01-01 ((2447892j,0s,0n),+0s,2299161j)&gt;&gt;</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>00</span><span>8</span><span>:</span><span>0</span><span>&gt;</span> <span>john_struct</span><span>.</span><span>name</span> <span>=</span> <span>&#34;John Doe&#34;</span>
  <span>=&gt;</span> <span>&#34;John Doe&#34;</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>00</span><span>9</span><span>:</span><span>0</span><span>&gt;</span> <span>john_struct</span><span>.</span><span>name</span>
  <span>=&gt;</span> <span>&#34;John Doe&#34;</span></code></pre></figure>

<p>However there is one caveat. If some of the data members are of a mutable class, Data does no additional immutability enforcement.</p>

<figure><pre><code data-lang="ruby">  <span>irb</span><span>(</span><span>main</span><span>):</span><span>010</span><span>:</span><span>0</span><span>&gt;</span> <span>Person</span> <span>=</span> <span>Data</span><span>.</span><span>define</span><span>(</span><span>:name</span><span>,</span> <span>:dob</span><span>,</span> <span>:address</span><span>)</span>
  <span>=&gt;</span> <span>Person</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>011</span><span>:</span><span>0</span><span>&gt;</span> <span>john</span> <span>=</span> <span>Person</span><span>.</span><span>new</span><span>(</span><span>&#34;John&#34;</span><span>,</span> <span>Date</span><span>.</span><span>new</span><span>(</span><span>1990</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>),</span> <span>{</span><span>street: </span><span>&#34;123 Main St&#34;</span><span>})</span>
  <span>=&gt;</span> <span>#&lt;Person:0x00007f9b0c0b0a00 @name=&#34;John&#34;, @dob=#&lt;Date: 1990-01-01 ((2447892j,0s,0n),+0s,2299161j)&gt;, @address={:street=&gt;&#34;123 Main St&#34;}&gt;</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>012</span><span>:</span><span>0</span><span>&gt;</span> <span>john</span><span>.</span><span>address</span><span>[</span><span>:street</span><span>]</span> <span>=</span> <span>&#34;456 Main St&#34;</span>
  <span>=&gt;</span> <span>&#34;456 Main St&#34;</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>013</span><span>:</span><span>0</span><span>&gt;</span> <span>john</span><span>.</span><span>address</span>
  <span>=&gt;</span> <span>{</span><span>:street</span><span>=&gt;</span><span>&#34;456 Main St&#34;</span><span>}</span></code></pre></figure>

<p>Ruby maintainers decided that Struct could not be made to suit the requirements of a value object. The core Struct class is a “somewhat alike” value-object; it is compared by value and is,</p>
<ul>
  <li>mutable</li>
  <li>collection-alike (defines to_a and is Enumerable)</li>
  <li>dictionary-alike (has [] and .values methods)</li>
</ul>

<p>Let’s look at this in action.</p>

<figure><pre><code data-lang="ruby">  <span>irb</span><span>(</span><span>main</span><span>):</span><span>010</span><span>:</span><span>0</span><span>&gt;</span> <span>Array</span><span>(</span><span>john_struct</span><span>)</span>
  <span>=&gt;</span> <span>[</span><span>&#34;John Doe&#34;</span><span>,</span> <span>#&lt;Date: 1990-01-01 ((2447893j,0s,0n),+0s,2299161j)&gt;]</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>011</span><span>:</span><span>0</span><span>&gt;</span> <span>Array</span><span>(</span><span>john</span><span>)</span>
<span>=&gt;</span> <span>[</span><span>#&lt;data Person name=&#34;John&#34;, dob=#&lt;Date: 1990-01-01 ((2447893j,0s,0n),+0s,2299161j)&gt;&gt;]</span></code></pre></figure>

<p>The expectation for the struct object is that it forms an array of structs, however the struct object is deconstructed and its values are used to form the Array. However the data object returns an array of Data objects. This is because the Data class is not Enumerable.</p>

<figure><pre><code data-lang="ruby">  <span>irb</span><span>(</span><span>main</span><span>):</span><span>012</span><span>:</span><span>0</span><span>&gt;</span> <span>john_struct</span><span>[</span><span>:name</span><span>]</span>
  <span>=&gt;</span> <span>&#34;John Doe&#34;</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>013</span><span>:</span><span>0</span><span>&gt;</span> <span>john</span><span>[</span><span>:name</span><span>]</span>
  <span>=&gt;</span> <span>nil</span></code></pre></figure>

<p>This also means that the Data class will not inherit the Enumerable module, which provides methods like #include?, #count, #map, #select and #uniq, amongst others. It is truly a <em>simple value object</em>. It is only meant to be a storage for immutable atomic values.</p>

<p>Further, the struct object is also dictionary-alike, which means that it can be accessed using the <code>.values</code> method. However the Data object is not dictionary-alike.</p>

<figure><pre><code data-lang="ruby">  <span>irb</span><span>(</span><span>main</span><span>):</span><span>014</span><span>:</span><span>0</span><span>&gt;</span> <span>john_struct</span><span>.</span><span>values</span>
  <span>=&gt;</span> <span>[</span><span>&#34;John Doe&#34;</span><span>,</span> <span>#&lt;Date: 1990-01-01 ((2447893j,0s,0n),+0s,2299161j)&gt;]</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>015</span><span>:</span><span>0</span><span>&gt;</span> <span>john</span><span>.</span><span>values</span>
  <span>=&gt;</span> <span>nil</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>016</span><span>:</span><span>1</span><span>*</span> <span>def</span> <span>display</span><span>(</span><span>arg1</span><span>,</span> <span>arg2</span> <span>=</span> <span>&#34;Empty!&#34;</span><span>)</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>017</span><span>:</span><span>1</span><span>*</span>   <span>puts</span> <span>arg1</span><span>,</span> <span>arg2</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>01</span><span>8</span><span>:</span><span>0</span><span>&gt;</span> <span>end</span>
  <span>=&gt;</span> <span>:display</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>01</span><span>9</span><span>:</span><span>0</span><span>&gt;</span> <span>display</span> <span>*</span><span>john_struct</span>
  <span>John</span> <span>Doe</span>
  <span>1990</span><span>-</span><span>01</span><span>-</span><span>01</span>
  <span>=&gt;</span> <span>nil</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>020</span><span>:</span><span>0</span><span>&gt;</span> <span>display</span> <span>*</span><span>john</span>
  <span>#&lt;data Person name=&#34;John&#34;, dob=#&lt;Date: 1990-01-01 ((2447893j,0s,0n),+0s,2299161j)&gt;&gt;</span>
  <span>Empty</span><span>!</span>                              
  <span>=&gt;</span> <span>nil</span></code></pre></figure>

<p>However, it is worth noting that the Data class does have a <code>#to_h</code> method.</p>

<figure><pre><code data-lang="ruby">  <span>irb</span><span>(</span><span>main</span><span>):</span><span>021</span><span>:</span><span>0</span><span>&gt;</span> <span>john_struct</span><span>.</span><span>to_h</span>
  <span>=&gt;</span> <span>{</span><span>:name</span><span>=&gt;</span><span>&#34;John Doe&#34;</span><span>,</span> <span>:dob</span><span>=&gt;</span><span>#&lt;Date: 1990-01-01 ((2447893j,0s,0n),+0s,2299161j)&gt;}</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>022</span><span>:</span><span>0</span><span>&gt;</span> <span>john</span><span>.</span><span>to_h</span>
  <span>=&gt;</span> <span>{</span><span>:name</span><span>=&gt;</span><span>&#34;John&#34;</span><span>,</span> <span>:dob</span><span>=&gt;</span><span>#&lt;Date: 1990-01-01 ((2447893j,0s,0n),+0s,2299161j)&gt;}</span></code></pre></figure>

<p>Finally, it is possible to extend the Person class with additional methods, only during class definition.</p>

<figure><pre><code data-lang="ruby">  <span>irb</span><span>(</span><span>main</span><span>):</span><span>023</span><span>:</span><span>1</span><span>*</span> <span>Person</span> <span>=</span> <span>Data</span><span>.</span><span>define</span><span>(</span><span>:name</span><span>,</span> <span>:dob</span><span>)</span> <span>do</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>024</span><span>:</span><span>2</span><span>*</span>   <span>def</span> <span>&lt;</span><span>=&gt;</span><span>(</span><span>other</span><span>)</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>025</span><span>:</span><span>2</span><span>*</span>     <span>return</span> <span>unless</span> <span>other</span><span>.</span><span>is_a?</span><span>(</span><span>self</span><span>.</span><span>class</span><span>)</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>026</span><span>:</span><span>2</span><span>*</span>     <span>(</span><span>Date</span><span>.</span><span>today</span> <span>-</span> <span>dob</span><span>)</span> <span>&lt;=&gt;</span> <span>(</span><span>Date</span><span>.</span><span>today</span> <span>-</span> <span>other</span><span>.</span><span>dob</span><span>)</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>027</span><span>:</span><span>1</span><span>*</span>   <span>end</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>02</span><span>8</span><span>:</span><span>1</span><span>*</span> 
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>02</span><span>9</span><span>:</span><span>1</span><span>*</span>   <span>include</span> <span>Comparable</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>030</span><span>:</span><span>0</span><span>&gt;</span> <span>end</span>
  <span>=&gt;</span> <span>Person</span></code></pre></figure>

<p>Now let’s compare the two Person objects.</p>

<figure><pre><code data-lang="ruby">  <span>irb</span><span>(</span><span>main</span><span>):</span><span>031</span><span>:</span><span>0</span><span>&gt;</span> <span>john</span> <span>=</span> <span>Person</span><span>.</span><span>new</span><span>(</span><span>&#34;John&#34;</span><span>,</span> <span>Date</span><span>.</span><span>new</span><span>(</span><span>1990</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>))</span>
  <span>=&gt;</span> <span>#&lt;Person:0x00007f9b0c0b0a00 @name=&#34;John&#34;, @dob=#&lt;Date: 1990-01-01 ((2447892j,0s,0n),+0s,2299161j)&gt;&gt;</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>032</span><span>:</span><span>0</span><span>&gt;</span> <span>jane</span> <span>=</span> <span>Person</span><span>.</span><span>new</span><span>(</span><span>&#34;Jane&#34;</span><span>,</span> <span>Date</span><span>.</span><span>new</span><span>(</span><span>1988</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>))</span>
  <span>=&gt;</span> <span>#&lt;Person:0x00007f9b0c0b0a00 @name=&#34;Jane&#34;, @dob=#&lt;Date: 1990-01-01 ((2447892j,0s,0n),+0s,2299161j)&gt;&gt;</span>
  <span>irb</span><span>(</span><span>main</span><span>):</span><span>033</span><span>:</span><span>0</span><span>&gt;</span> <span>john</span> <span>&gt;</span> <span>jane</span>
  <span>=&gt;</span> <span>false</span></code></pre></figure>

<p>The new Data class is a simple value object. While it is not meant to be a replacement for Struct, it can be used to store immutable atomic values making it easier for Ruby developers to create simple structures to store immutable data.</p>

<p>Will you be using the Data class in your next project? Let us know!</p>

</article></div>
  </body>
</html>
