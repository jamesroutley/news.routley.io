<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://fortran-lang.discourse.group/t/scipy-there-is-interest-in-adopting-this-prima-implementation-but-little-appetite-for-taking-on-more-fortran-code/5821">Original</a>
    <h1>SciPy: Interested in adopting PRIMA, but little appetite for more Fortran code</h1>
    
    <div id="readability-page-1" class="page"><div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
      <meta itemprop="headline" content="SciPy: &#34;there is interest in adopting this (PRIMA) implementation, but little appetite for taking on more Fortran code&#34;"/>
        <meta itemprop="articleSection" content="Uncategorized"/>
      <meta itemprop="keywords" content=""/>
      

          <div id="post_1">
            
            <div itemprop="articleBody">
              <p>In the latest discussion on the inclusion of <a href="https://github.com/libprima/prima" rel="noopener nofollow ugc">PRIMA</a> into SciPy, a major SciPy maintainer said the following.</p>
<blockquote>
<p>Update from the community call: there is interest in adopting this implementation, but little appetite for taking on more Fortran code (because we’re already working to get rid of it in several other components). A feasible route forward could be to translate the Fortran implementation to C, using e.g. f2c, and to use that. Or perhaps there is interest in doing an official Cython / Pythran / C / C++ port?</p>
</blockquote>
<p>See <a href="https://github.com/scipy/scipy/issues/18118#issuecomment-1552057125" rel="noopener nofollow ugc">ENH: The Fortran 77 implementation of COBYLA is buggy and challenging to maintain. Switch to the PRIMA implementation? · Issue #18118 · scipy/scipy · GitHub</a> for the original post. You may want to input your opinions / arguments under that thread.</p>
<p>This is not a good sign for the Fortran community according to the <a href="https://en.wikipedia.org/wiki/Broken_windows_theory" rel="noopener nofollow ugc">broken windows theory</a>. Such viewpoints are contagious and will spread quickly in a community as vigorous and populous as Python.</p>
<p>(For more information about PRIMA, see the <a href="https://fortran-lang.discourse.group/t/optimization-without-using-derivatives-the-prima-package-its-fortran-implementation-and-its-inclusion-in-scipy/5798">discussions under another thread</a>.)</p>
            </div>

            

            

                
          </div>
          <div id="post_2" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            
            <div itemprop="text">
              <p>I would stick to Fortran. Then all the adopters would have to use a port, if they want.</p>
<p>For me, this is like confronting a bully at school. He wants you to surrender. If you surrender, he wins.</p>
            </div>

            

            

          </div>
          <div id="post_3" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            <div>
              <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
                <a itemprop="url" href="https://fortran-lang.discourse.group/u/PierU"><span itemprop="name">PierU</span></a>
                
              </span></p>


              <p><span>
                  <time itemprop="datePublished" datetime="2023-05-18T10:50:29Z">
                    May 18, 2023, 10:50am
                  </time>
                  <meta itemprop="dateModified" content="2023-05-18T10:50:29Z"/>
              <span itemprop="position">3</span>
              </span>
            </p></div>
            <p>We all agree, but at some point they may chose to convert the code to C on their own. We have to convince them this is not the right way.</p>

            

            

          </div>
          <div id="post_4" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            
            <p>Yes, that is the point. They will have to convert… They will use non-original code, but a port.</p>

            

            

          </div>
          <div id="post_5" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            
            <p>One idea here would be to (in parallel to interfacing in python the Fortran code as discussed in the original thread) convert the current repo into an fpm package. It could be tested and used “out of the shelf” with fpm. What do you think <a href="https://fortran-lang.discourse.group/u/zaikunzhang">@zaikunzhang</a> ?</p>

            

            

          </div>
          <div id="post_6" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            
            <p><a href="https://fortran-lang.discourse.group/u/hkvzjal">@hkvzjal</a> Yes. That would call attention into the fpm initiative.</p>

            

            

          </div>
          <div id="post_7" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            
            <p>F2c is not an option for PRIMA, because f2c can only translate Fortran 77. Would the SciPy maintainers be willing to incorporate PRIMA if there were C wrappers for it? How difficult would it be to create such wrappers? Most of the R packages I see that have Fortran code have thin C wrappers that R calls.</p>

            

            

          </div>
          <div id="post_8" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            
            <p>With the iso_c_binding+ctypes approach there would be no need for a C wrapper but directly a python wrapper calling the signature functions written in the Fortran module wrapper. This could reduce the 3-languages issue.</p>

            

            

          </div>
          <div id="post_9" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            
            <div itemprop="text">
              <p>Thank you <a href="https://fortran-lang.discourse.group/u/conradoat">@conradoat</a> for your comment and suggestion.</p>
<p>My goal is to make <a href="https://en.wikipedia.org/wiki/Michael_J._D._Powell" rel="noopener nofollow ugc">Professor Powell</a>’s solvers as accessible as possible to scientists, engineers, and algorithm researchers. I am not particularly in favor of or against any language. I hope that everyone can easily use Powell’s solvers in her/his favorite languages.</p>
<p>The first implementation of PRIMA is in modern Fortran simply because Powell’s implementation was in Fortran 77. Using Fortran, I can <strong>systematically verify the bit-to-bit faithfulness</strong> of the modernized implementation (not only “faithful up to an epsilon”). In addition, the intrinsic support for matrix-vector calculations is a strong advantage when <a href="https://fortran-lang.discourse.group/t/fortran-an-ideal-language-for-writing-templates-of-numerical-algorithms/2054">developing reference implementations (or templates) of numerical solvers</a> — most numerical algorithms are combinations of such calculations anyway.</p>
<p>The major motivation for developing the modern Fortran version is to provide a reference for the implementation in other languages, namely Python, MATLAB, C++, Julia, and R. A reference implementation must be structured, modularized, readable, understandable, and extendable. The original Fortran 77 code is a true masterpiece, but it is not proper at all for being used as a reference implementation. You do not want to use a spaghetti-style codebase with 244 GOTOs as a reference, or your implementation will be of the same style.</p>
<p>Putting it more straightforwardly, <strong>I implemented the modern-Fortran version of PRIMA in order to <a href="https://github.com/libprima/prima#python" rel="noopener nofollow ugc">develop versions that are entirely Fortran-free</a>.</strong></p>
<p>Coming back to the point, I fully understand why the SciPy community has “little appetite for taking on more Fortran code”. The reputation of Fortran has been damaged over the years. I do <strong>not</strong> agree with the damaged reputation, and I feel sorry for those who do not have a chance to know (or refuse to know) modern Fortran due to this false reputation, but I do not blame them.  It is the responsibility of the Fortran community to re-establish the reputation.  I do not regard it as a bully to request non-Fortran implementations. It is not a question of surrendering or not.</p>
<p>I do consider myself a member of the Fortran community. Taking my share of the aforementioned responsibilty, I will try to promote the usage of modern Fortran via the PRIMA project. There is nothing more convincing than a successful real-life project.</p>
<p>For the inclusion of PRIMA in SciPy, I will keep communicating with both the SciPy and the Fortran community (e.g., those on this discourse), trying to find the best route. As pointed out by others, f2c is not an option due to its incapability of handling modern Fortran. Official C++ and Python implementations are being planned, but they will not be delivered in the near future. The most probable and practical solution, as suggested here and <a href="https://fortran-lang.discourse.group/t/optimization-without-using-derivatives-the-prima-package-its-fortran-implementation-and-its-inclusion-in-scipy/5798">under the other thread</a>, is to wrap the modern Fortran implementation of PRIMA using iso_c_bindings + ctypes or similar facilities. I hope the SciPy maintainers will accept this solution.</p>
            </div>

            

            

          </div>
          <div id="post_10" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            
            <div itemprop="text">
              <p><a href="https://fortran-lang.discourse.group/u/hkvzjal">@hkvzjal</a> <a href="https://fortran-lang.discourse.group/u/conradoat">@conradoat</a> Thank you for mentioning this. Absolutely. Making PRIMA an FPM package is the next thing to do for the modern-Fortran version of PRIMA. Another one is auto-documentation with FORD or Sphinx.</p>
<p>I think these are low-hanging apples. The only obstacle is that I am too busy right now. PRIMA has been a black hole that absorbs all my time and energy in the past three years. I have to catch up with my other projects or my career is in real danger.</p>
            </div>

            

            

          </div>
          <div id="post_11" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            
            <p><a href="https://fortran-lang.discourse.group/u/zaikunzhang">@zaikunzhang</a> I understand your point. I think the way to re-establish the reputation is to present quality software in modern Fortran. This is the spirit of the fpm initiative.</p>

            

            

          </div>
          <div id="post_12" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            
            <div itemprop="text">
              <p>Here is my response posted under <a href="https://github.com/scipy/scipy/issues/18118#issuecomment-1552057125" rel="noopener nofollow ugc">ENH: The Fortran 77 implementation of COBYLA is buggy and challenging to maintain. Switch to the PRIMA implementation? · Issue #18118 · scipy/scipy · GitHub</a> . <strong>You are particularly welcome to join the discussion <a href="https://github.com/scipy/scipy/issues/18118#issuecomment-1552057125" rel="noopener nofollow ugc">over there</a></strong>. Given my ignorance of Python, your input will be quite valuable. Thank you very much.</p>


            </div>

            

            

          </div>
          <div id="post_13" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            
            <div itemprop="text">
              
<p>You surely know the fortran code in detail, but I wanted to point out that Powell’s publications date back to the 1960s and 1970s, so the first versions of his methods were written well before the f77 standard.</p>
<p>On the Python topic, it is ridiculous on the face of it for someone to suggest using f2c to convert a modern fortran code to c. That simply shows how out of touch some programmer are, by decades.</p>
            </div>

            

            

          </div>
          <div id="post_14" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            <div>
              <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
                <a itemprop="url" href="https://fortran-lang.discourse.group/u/PierU"><span itemprop="name">PierU</span></a>
                
              </span></p>


              <p><span>
                  <time itemprop="datePublished" datetime="2023-05-18T15:14:04Z">
                    May 18, 2023,  3:14pm
                  </time>
                  <meta itemprop="dateModified" content="2023-05-18T15:14:04Z"/>
              <span itemprop="position">14</span>
              </span>
            </p></div>
            <div itemprop="text">
              
<p>Very true. But that also shows all the work that needs to be done to change that perception.</p>
            </div>

            

            

          </div>
          <div id="post_15" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            
            <div itemprop="text">
              
<p>Hi <a href="https://fortran-lang.discourse.group/u/ronshepard">@RonShepard</a> , thank you for pointing this out. It is correct that Professor Powell became an active and soon famous numerical analyst in the 1960s due to his works on the <a href="https://en.wikipedia.org/wiki/Davidon%E2%80%93Fletcher%E2%80%93Powell_formula" rel="noopener nofollow ugc">Davidon-Fletcher-Powell method</a> and <a href="https://en.wikipedia.org/wiki/Powell%27s_method" rel="noopener nofollow ugc">conjugate direction method</a>. I guess he started his career at <a href="https://www.harwellcampus.com/" rel="noopener nofollow ugc">Harwell</a> while coding in Fortran 6X.</p>
<p>However, the first of the solvers under discussion, namely <a href="https://handwiki.org/wiki/COBYLA" rel="noopener nofollow ugc">COBYLA</a>, was <a href="https://github.com/libprima/prima/blob/main/fortran/original/cobyla/email.txt" rel="noopener nofollow ugc">released on May 7th, 1992</a>, with <a href="https://link.springer.com/chapter/10.1007/978-94-015-8330-5_4" rel="noopener nofollow ugc">the paper</a> published in 1994. Therefore, the code was in quite standard Fortran 77.</p>
<p>Unfortunately, even though all the solvers under discussion were developed between the 1990s and 2010s, Professor Powell did not adopt Fortran 90. If he had, my life in the past three years (and probably in some years to come) would have been (would be) quite different.</p>
            </div>

            

            

          </div>
          <div id="post_16" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            <div>
              <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
                <a itemprop="url" href="https://fortran-lang.discourse.group/u/egio"><span itemprop="name">egio</span></a>
                
              </span></p>


              <p><span>
                  <time itemprop="datePublished" datetime="2023-05-18T15:47:57Z">
                    May 18, 2023,  3:47pm
                  </time>
                  <meta itemprop="dateModified" content="2023-05-18T15:47:57Z"/>
              <span itemprop="position">16</span>
              </span>
            </p></div>
            <p>Is PRIMA thread safe (mostly no global or saved variables, and all routines recursive)?</p>

            

            

          </div>
          <div id="post_17" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            
            <div itemprop="text">
              <p>Hi <a href="https://fortran-lang.discourse.group/u/egio">@egio</a> , thank you for raising this important point!</p>
<p>Yes, as far as I can see. There is no global variable / module variable. (BTW, how to test / verify thread safety systematically?)</p>
<p>I have been keeping thread safety in my mind when developing PRIMA. In fact, I asked a <a href="https://fortran-lang.discourse.group/t/thread-safety-of-modern-fortran-libraries-what-and-how/2641">question here about thread safety</a> some time ago — almost all my posts on this forum arise from PRIMA.</p>
            </div>

            

            

          </div>
          <div id="post_18" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            <div>
              <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
                <a itemprop="url" href="https://fortran-lang.discourse.group/u/egio"><span itemprop="name">egio</span></a>
                
              </span></p>


              <p><span>
                  <time itemprop="datePublished" datetime="2023-05-18T16:30:51Z">
                    May 18, 2023,  4:30pm
                  </time>
                  <meta itemprop="dateModified" content="2023-05-18T16:30:51Z"/>
              <span itemprop="position">18</span>
              </span>
            </p></div>
            <div itemprop="text">
              <p>I’m thinking about a Python user perspective, they may want to run it in a thread safe (with multiple  Python threads) and concurrently, solving a problem with a function that it is solving inside another problem (although it may be stupid to do that).</p>
<p>Without global and saved variables I think it should be ok. And of course if there is an error the routines shouldn’t stop but report back an error code.</p>
            </div>

            

            

          </div>
          <div id="post_19" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            
            <div itemprop="text">
              <p>Thank you <a href="https://fortran-lang.discourse.group/u/egio">@egio</a>  for your insights from a Python user’s perspective. This is important for PRIMA.</p>
<blockquote>
<p>Without global and saved variables I think it should be ok.</p>
</blockquote>
<p>I confirm that there is no such variables.</p>
<blockquote>
<p>And of course if there is an error the routines shouldn’t stop but report back an error code.</p>
</blockquote>
<p>PRIMA invokes <code>error stop</code> when there is an error. This occurs only once in the code, at the following place:</p>


<p>For the moment, I do not supply a code number to <code>error stop</code>. I will revise the code to assign an informative code to <code>error stop</code>. I remember that I did not do that because some compilers (e.g., Absoft <code>af95</code>, Oracle <code>sunf95</code>) do not support it. Now that I have dropped the support for discontinued compilers, it becomes doable.</p>
<blockquote>
<p>And, of course, they don’t have to access the operative system.</p>
</blockquote>
<p>Does <code>write</code> belong to “access the operative system”? That is the only possibility. All other code in PRIMA does nothing but numerical calculations. The usage of <code>write</code> is limited to a few lines in prima/fortran/common/{fprint.f90, debug.F90}. They can be easily removed / turned off if needed.</p>
            </div>

            

            

          </div>
          <div id="post_20" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            
            <div itemprop="text">
              <p>There is a discussion about this topic on the Front Page of Hacker News:</p>
<p><a href="https://news.ycombinator.com/news" target="_blank" rel="noopener nofollow ugc">https://news.ycombinator.com/news</a></p>
<p>(Of course, its position is falling with time going. It is about 20 at the time of writing. )</p>
<p>This is the second time that PRIMA appears as a front-page story within a week (indeed, three days), <a href="https://news.ycombinator.com/item?id=35959991" rel="noopener nofollow ugc">the first one being on 16 May</a>. Interestingly and encouragingly, many comments there show that there is still quite strong support for Fortran in the technology community.</p>
            </div>

            

            

          </div>
    </div></div>
  </body>
</html>
