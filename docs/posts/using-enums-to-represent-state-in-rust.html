<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://corrode.dev/blog/enums/">Original</a>
    <h1>Using enums to represent state in Rust</h1>
    
    <div id="readability-page-1" class="page"><div><p>Many Rust beginners with a background in systems programming tend to use <code>bool</code>
(or even <code>u8</code> â€” an 8-bit unsigned integer type) to represent <em>&#34;state&#34;</em>.</p>
<p>For example, how about a <code>bool</code> to indicate whether a user is active or not?</p>
<pre data-lang="rust"><code data-lang="rust"><span><span><span>struct</span> </span><span><span>User</span> </span><span><span><span>{</span>
        <span>active</span><span>:</span> <span>bool</span>,
</span><span><span>}</span></span></span>
</span></code></pre>
<p>Initially, this might seem fine, but as your codebase grows,
you&#39;ll find that &#34;active&#34; is not a binary state. There are many
different states that a user can be in. For example, a user
might be suspended or deleted. However, extending the user struct
can get problematic, because other parts of the code might
rely on the fact that <code>active</code> is a <code>bool</code>.</p>
<p>Another problem is that <code>bool</code> is not self-documenting. What does
<code>active = false</code> mean? Is the user inactive? Or is the user
deleted? Or is the user suspended? We don&#39;t know!</p>
<p>Alternatively, you could use an unsigned integer to represent state:</p>
<pre data-lang="rust"><code data-lang="rust"><span><span><span>struct</span> </span><span><span>User</span> </span><span><span><span>{</span>
        <span>status</span><span>:</span> <span>u8</span>,
</span><span><span>}</span></span></span>
</span></code></pre>
<p>This is <em>slightly</em> better, because we can now use different values
to represent more states:</p>
<pre data-lang="rust"><code data-lang="rust"><span><span>const</span> <span>ACTIVE</span><span>:</span> <span>u8</span> <span>=</span> <span>0</span><span>;</span>
<span>const</span> <span>INACTIVE</span><span>:</span> <span>u8</span> <span>=</span> <span>1</span><span>;</span>
<span>const</span> <span>SUSPENDED</span><span>:</span> <span>u8</span> <span>=</span> <span>2</span><span>;</span>
<span>const</span> <span>DELETED</span><span>:</span> <span>u8</span> <span>=</span> <span>3</span><span>;</span>

<span>let</span> user <span>=</span> User <span><span>{</span>
        status<span>:</span> <span>ACTIVE</span><span>,</span>
</span><span><span>}</span></span><span>;</span>
</span></code></pre>
<p>A common use-case for <code>u8</code> is when you interface with C code.
In that case, using <code>u8</code> might seemingly be the only option.
However, we could still wrap that <code>u8</code> in a
<a href="https://doc.rust-lang.org/rust-by-example/generics/new_types.html">newtype</a>!</p>
<pre data-lang="rust"><code data-lang="rust"><span><span><span>struct</span> </span><span><span>User</span> </span><span><span><span>{</span>
        <span>status</span><span>:</span> UserStatus,
</span><span><span>}</span></span></span>

<span><span>struct</span> </span><span><span>UserStatus</span></span><span><span><span>(</span><span>u8</span></span><span>)</span></span><span>;</span>

<span>const</span> <span>ACTIVE</span><span>:</span> UserStatus <span>=</span> UserStatus<span><span>(</span><span>0</span></span><span><span>)</span></span><span>;</span>
<span>const</span> <span>INACTIVE</span><span>:</span> UserStatus <span>=</span> UserStatus<span><span>(</span><span>1</span></span><span><span>)</span></span><span>;</span>
<span>const</span> <span>SUSPENDED</span><span>:</span> UserStatus <span>=</span> UserStatus<span><span>(</span><span>2</span></span><span><span>)</span></span><span>;</span>
<span>const</span> <span>DELETED</span><span>:</span> UserStatus <span>=</span> UserStatus<span><span>(</span><span>3</span></span><span><span>)</span></span><span>;</span>

<span>let</span> user <span>=</span> User <span><span>{</span>
        status<span>:</span> <span>ACTIVE</span><span>,</span>
</span><span><span>}</span></span><span>;</span>
</span></code></pre>
<p>This way, we can still use <code>u8</code> to represent state, but we can
now also put the type system to work (a common pattern in idiomatic Rust). For
example, we can define methods on <code>UserStatus</code>:</p>
<pre data-lang="rust"><code data-lang="rust"><span><span><span>impl</span> </span><span><span>UserStatus</span> </span><span><span><span>{</span>
    <span><span><span>fn</span> </span><span>is_active</span></span><span><span><span>(</span><span>&amp;</span><span>self</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>bool</span></span> </span><span><span><span>{</span>
        <span>self</span><span>.</span><span>0</span> <span>==</span> <span>ACTIVE</span><span>.</span><span>0</span>
    </span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>
</span></code></pre>
<p>And we can even define a constructor that validates the input:</p>
<pre data-lang="rust"><code data-lang="rust"><span><span><span>impl</span> </span><span><span>UserStatus</span> </span><span><span><span>{</span>
    <span><span><span>fn</span> </span><span>new</span></span><span><span><span>(</span><span>status</span><span>:</span> <span>u8</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span><span>Result</span><span>&lt;</span><span>Self</span>, <span>&amp;</span><span>&#39;static</span> <span>str</span><span>&gt;</span></span></span> </span><span><span><span>{</span>
        <span>match</span> status <span><span>{</span>
            <span>ACTIVE</span><span>.</span><span>0</span> <span>=&gt;</span> <span>Ok</span><span><span>(</span><span>ACTIVE</span></span><span><span>)</span></span><span>,</span>
            <span>INACTIVE</span><span>.</span><span>0</span> <span>=&gt;</span> <span>Ok</span><span><span>(</span><span>INACTIVE</span></span><span><span>)</span></span><span>,</span>
            <span>SUSPENDED</span><span>.</span><span>0</span> <span>=&gt;</span> <span>Ok</span><span><span>(</span><span>SUSPENDED</span></span><span><span>)</span></span><span>,</span>
            <span>DELETED</span><span>.</span><span>0</span> <span>=&gt;</span> <span>Ok</span><span><span>(</span><span>DELETED</span></span><span><span>)</span></span><span>,</span>
            <span>_</span> <span>=&gt;</span> <span>Err</span><span><span>(</span><span><span>&#34;</span>Invalid status<span>&#34;</span></span></span><span><span>)</span></span><span>,</span>
        </span><span><span>}</span></span>
    </span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>
</span></code></pre>
<p>It&#39;s still not ideal, however! Not even if you interface with C code, as we will
see in a bit. But first, let&#39;s look at the recommended way to represent state in Rust.</p>
<h2 id="use-enums-instead">Use Enums Instead!</h2>
<p><strong>Enums are a great way to model state inside your domain.</strong> They allow you to
express your intent in a very concise way. </p>
<pre data-lang="rust"><code data-lang="rust"><span><span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>pub</span> <span>enum</span> <span>UserStatus</span> <span><span>{</span>
            Active<span>,</span>
    
                Inactive<span>,</span>
    
                        Suspended<span>,</span>
    
                        Deleted<span>,</span>
</span><span><span>}</span></span></span>
</span></code></pre>
<p>We can plug this enum into our <code>User</code> struct:</p>
<pre data-lang="rust"><code data-lang="rust"><span><span><span>struct</span> </span><span><span>User</span> </span><span><span><span>{</span>
        <span>status</span><span>:</span> UserStatus,
</span><span><span>}</span></span></span>
</span></code></pre>
<p>But that&#39;s not all; in Rust, enums are much more powerful than in many other
languages. For example, we can add data to our enum variants:</p>
<pre data-lang="rust"><code data-lang="rust"><span><span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>pub</span> <span>enum</span> <span>UserStatus</span> <span><span>{</span>
    Active<span>,</span>
    Inactive<span>,</span>
    Suspended <span><span>{</span> until<span>:</span> <span>DateTime<span>&lt;</span>Utc<span>&gt;</span></span> </span><span><span>}</span></span><span>,</span>
    Deleted <span><span>{</span> deleted_at<span>:</span> <span>DateTime<span>&lt;</span>Utc<span>&gt;</span></span> </span><span><span>}</span></span><span>,</span>
</span><span><span>}</span></span></span>
</span></code></pre>
<p>We can even represent <strong>state transitions</strong>:</p>
<pre data-lang="rust"><code data-lang="rust"><span><span>use</span> <span>chrono<span>::</span></span><span><span>{</span>DateTime<span>,</span> Utc</span><span><span>}</span></span><span>;</span>

<span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>pub</span> <span>enum</span> <span>UserStatus</span> <span><span>{</span>
    Active<span>,</span>
    Inactive<span>,</span>
    Suspended <span><span>{</span> until<span>:</span> <span>DateTime<span>&lt;</span>Utc<span>&gt;</span></span> </span><span><span>}</span></span><span>,</span>
    Deleted <span><span>{</span> deleted_at<span>:</span> <span>DateTime<span>&lt;</span>Utc<span>&gt;</span></span> </span><span><span>}</span></span><span>,</span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span><span>UserStatus</span> </span><span><span><span>{</span>
        <span><span><span>fn</span> </span><span>suspend</span></span><span><span><span>(</span><span>&amp;</span><span>mut</span> <span>self</span>, <span>until</span><span>:</span> <span>DateTime<span>&lt;</span>Utc<span>&gt;</span></span></span><span><span><span>)</span></span></span></span><span> </span><span><span><span>{</span>
        <span>match</span> <span>self</span> <span><span>{</span>
            <span>UserStatus<span>::</span></span>Active <span>=&gt;</span> <span>*</span><span>self</span> <span>=</span> <span>UserStatus<span>::</span></span>Suspended <span><span>{</span> until </span><span><span>}</span></span><span>,</span>
            <span>_</span> <span>=&gt;</span> <span><span>{</span></span><span><span>}</span></span>
        </span><span><span>}</span></span>
    </span><span><span>}</span></span></span>

        <span><span><span>fn</span> </span><span>activate</span></span><span><span><span>(</span><span>&amp;</span><span>mut</span> <span>self</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span><span>Result</span><span>&lt;</span><span>(</span><span>)</span>, <span>&amp;</span><span>&#39;static</span> <span>str</span><span>&gt;</span></span></span> </span><span><span><span>{</span>
        <span>match</span> <span>self</span> <span><span>{</span>
                        <span>UserStatus<span>::</span></span>Deleted <span><span>{</span> <span>..</span> </span><span><span>}</span></span> <span>=&gt;</span> <span>return</span> <span>Err</span><span><span>(</span><span><span>&#34;</span>can&#39;t activate a deleted user<span>&#34;</span></span></span><span><span>)</span></span><span>,</span>
            <span>_</span> <span>=&gt;</span> <span>*</span><span>self</span> <span>=</span> <span>UserStatus<span>::</span></span>Active
        </span><span><span>}</span></span>
        <span>Ok</span><span><span>(</span><span><span>(</span></span><span><span>)</span></span></span><span><span>)</span></span>
    </span><span><span>}</span></span></span>

        <span><span><span>fn</span> </span><span>delete</span></span><span><span><span>(</span><span>&amp;</span><span>mut</span> <span>self</span></span><span><span><span>)</span></span></span></span><span> </span><span><span><span>{</span>
        <span>if</span> <span>let</span> <span>UserStatus<span>::</span></span>Deleted <span><span>{</span> <span>..</span> </span><span><span>}</span></span> <span>=</span> <span>self</span> <span><span>{</span>
                        <span>return</span><span>;</span>
        </span><span><span>}</span></span>
        <span>*</span><span>self</span> <span>=</span> <span>UserStatus<span>::</span></span>Deleted <span><span>{</span>
            deleted_at<span>:</span> <span>Utc<span>::</span></span>now<span><span>(</span></span><span><span>)</span></span><span>,</span>
        </span><span><span>}</span></span>
    </span><span><span>}</span></span></span>

    <span><span><span>fn</span> </span><span>is_active</span></span><span><span><span>(</span><span>&amp;</span><span>self</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>bool</span></span> </span><span><span><span>{</span>
        <span>matches!</span><span><span>(</span><span>self</span><span>,</span> <span>UserStatus<span>::</span></span>Active</span><span><span>)</span></span>
    </span><span><span>}</span></span></span>

    <span><span><span>fn</span> </span><span>is_suspended</span></span><span><span><span>(</span><span>&amp;</span><span>self</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>bool</span></span> </span><span><span><span>{</span>
        <span>matches!</span><span><span>(</span><span>self</span><span>,</span> <span>UserStatus<span>::</span></span>Suspended <span><span>{</span> <span>..</span> </span><span><span>}</span></span></span><span><span>)</span></span>
    </span><span><span>}</span></span></span>

    <span><span><span>fn</span> </span><span>is_deleted</span></span><span><span><span>(</span><span>&amp;</span><span>self</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>bool</span></span> </span><span><span><span>{</span>
        <span>matches!</span><span><span>(</span><span>self</span><span>,</span> <span>UserStatus<span>::</span></span>Deleted <span><span>{</span> <span>..</span> </span><span><span>}</span></span></span><span><span>)</span></span>
    </span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>#</span><span>[</span><span>cfg</span><span><span><span>(</span></span></span><span><span>test</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>mod</span> <span>tests</span> <span><span>{</span>
    <span>use</span> <span>chrono<span>::</span></span>Duration<span>;</span>
    <span>use</span> <span><span>super</span><span>::</span></span><span>*</span><span>;</span>

    <span><span>#</span><span>[</span><span>test</span><span>]</span></span>
    <span><span><span>fn</span> </span><span>test_user_status</span></span><span><span><span>(</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span><span>Result</span><span>&lt;</span><span>(</span><span>)</span>, <span>&amp;</span><span>&#39;static</span> <span>str</span><span>&gt;</span></span></span></span><span><span><span>{</span>
        <span>let</span> <span>mut</span> status <span>=</span> <span>UserStatus<span>::</span></span>Active<span>;</span>
        <span>assert!</span><span><span>(</span>status<span>.</span><span>is_active</span><span><span>(</span></span><span><span>)</span></span></span><span><span>)</span></span><span>;</span>
                status<span>.</span><span>suspend</span><span><span>(</span><span>Utc<span>::</span></span>now<span><span>(</span></span><span><span>)</span></span> <span>+</span> <span>Duration<span>::</span></span>days<span><span>(</span><span>1</span></span><span><span>)</span></span></span><span><span>)</span></span><span>;</span>
        <span>assert!</span><span><span>(</span>status<span>.</span><span>is_suspended</span><span><span>(</span></span><span><span>)</span></span></span><span><span>)</span></span><span>;</span>
        status<span>.</span><span>activate</span><span><span>(</span></span><span><span>)</span></span><span>?</span><span>;</span>
        <span>assert!</span><span><span>(</span>status<span>.</span><span>is_active</span><span><span>(</span></span><span><span>)</span></span></span><span><span>)</span></span><span>;</span>
        status<span>.</span><span>delete</span><span><span>(</span></span><span><span>)</span></span><span>;</span>
        <span>assert!</span><span><span>(</span>status<span>.</span><span>is_deleted</span><span><span>(</span></span><span><span>)</span></span></span><span><span>)</span></span><span>;</span>
        <span>Ok</span><span><span>(</span><span><span>(</span></span><span><span>)</span></span></span><span><span>)</span></span>
    </span><span><span>}</span></span></span>

    <span><span>#</span><span>[</span><span>test</span><span>]</span></span>
    <span><span><span>fn</span> </span><span>test_user_status_transition</span></span><span><span><span>(</span></span><span><span><span>)</span></span></span></span><span> </span><span><span><span>{</span>
        <span>let</span> <span>mut</span> status <span>=</span> <span>UserStatus<span>::</span></span>Active<span>;</span>
        <span>assert!</span><span><span>(</span>status<span>.</span><span>is_active</span><span><span>(</span></span><span><span>)</span></span></span><span><span>)</span></span><span>;</span>
        status<span>.</span><span>delete</span><span><span>(</span></span><span><span>)</span></span><span>;</span>
        <span>assert!</span><span><span>(</span>status<span>.</span><span>is_deleted</span><span><span>(</span></span><span><span>)</span></span></span><span><span>)</span></span><span>;</span>
                <span>assert!</span><span><span>(</span>status<span>.</span><span>activate</span><span><span>(</span></span><span><span>)</span></span><span>.</span><span>is_err</span><span><span>(</span></span><span><span>)</span></span></span><span><span>)</span></span><span>;</span>
    </span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>
</span></code></pre>
<p>Look how much ground we&#39;ve covered with just a few lines of code!
We can extend the application with confidence, knowing that
we can&#39;t accidentally delete a user twice or re-activate a deleted user.
<a href="https://corrode.dev/blog/illegal-state">Illegal state transitions are now impossible!</a></p>
<h2 id="using-enums-to-interact-with-c-code">Using Enums to Interact with C Code</h2>
<p>Earlier, I promised that you can still use enums, even if you have to interact
with C code.</p>
<p>Suppose you have a C library with a user status type (I&#39;ve omitted the other
fields for brevity).</p>
<pre data-lang="c"><code data-lang="c"><span><span>typedef</span> <span>struct</span> <span><span>{</span>
    <span>uint8_t</span> status<span>;</span>
<span>}</span></span> <span>User</span><span>;</span>

User <span>*</span><span><span>create_user</span></span><span><span><span>(</span></span></span><span><span><span>uint8_t</span> <span>status</span><span>)</span></span></span><span>;</span>
</span></code></pre>
<p>You can write a Rust enum to represent the status:</p>
<pre data-lang="rust"><code data-lang="rust"><span><span><span>#</span><span>[</span><span>repr</span><span><span><span>(</span></span></span><span><span>u8</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug<span>,</span> PartialEq</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>pub</span> <span>enum</span> <span>UserStatus</span> <span><span>{</span>
    Active <span>=</span> <span>0</span><span>,</span>
    Inactive<span>,</span>
    Suspended<span>,</span>
    Deleted<span>,</span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span><span>TryFrom<span>&lt;</span><span>u8</span><span>&gt;</span></span> <span>for</span></span><span> <span>UserStatus</span> </span><span><span><span>{</span>
    <span>type</span> <span>Error</span> <span>=</span> <span><span>(</span></span><span><span>)</span></span><span>;</span>

    <span><span><span>fn</span> </span><span>try_from</span></span><span><span><span>(</span><span>value</span><span>:</span> <span>u8</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span><span>Result</span><span>&lt;</span><span>Self</span>, <span><span><span>Self</span><span>::</span></span></span>Error<span>&gt;</span></span></span> </span><span><span><span>{</span>
        <span>match</span> value <span><span>{</span>
            <span>0</span> <span>=&gt;</span> <span>Ok</span><span><span>(</span><span>UserStatus<span>::</span></span>Active</span><span><span>)</span></span><span>,</span>
            <span>1</span> <span>=&gt;</span> <span>Ok</span><span><span>(</span><span>UserStatus<span>::</span></span>Inactive</span><span><span>)</span></span><span>,</span>
            <span>2</span> <span>=&gt;</span> <span>Ok</span><span><span>(</span><span>UserStatus<span>::</span></span>Suspended</span><span><span>)</span></span><span>,</span>
            <span>3</span> <span>=&gt;</span> <span>Ok</span><span><span>(</span><span>UserStatus<span>::</span></span>Deleted</span><span><span>)</span></span><span>,</span>
            <span>_</span> <span>=&gt;</span> <span>Err</span><span><span>(</span><span><span>(</span></span><span><span>)</span></span></span><span><span>)</span></span><span>,</span>
        </span><span><span>}</span></span>
    </span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>
</span></code></pre>
<p>Noticed that <code>#[repr(u8)]</code> attribute? It tells the compiler to represent this
enum as an unsigned 8-bit integer. This is critical for compatibility with the C
code.</p>
<p>Now, let&#39;s wrap the C function in a safe Rust wrapper:</p>
<pre data-lang="rust"><code data-lang="rust"><span><span>extern</span> <span><span>&#34;</span>C<span>&#34;</span></span> <span><span>{</span>
    <span><span><span>fn</span> </span><span>create_user</span></span><span><span><span>(</span><span>status</span><span>:</span> <span>u8</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>*mut</span> User</span></span><span>;</span>
</span><span><span>}</span></span>

<span><span><span>pub</span> <span>fn</span> </span><span>create_user_wrapper</span></span><span><span><span>(</span><span>status</span><span>:</span> UserStatus</span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span><span>Result</span><span>&lt;</span>User, <span>&amp;</span><span>&#39;static</span> <span>str</span><span>&gt;</span></span></span> </span><span><span><span>{</span>
    <span>let</span> user <span>=</span> <span>unsafe</span> <span><span>{</span> <span>create_user</span><span><span>(</span>status <span>as</span> <span>u8</span></span><span><span>)</span></span> </span><span><span>}</span></span><span>;</span>
    <span>if</span> user<span>.</span><span>is_null</span><span><span>(</span></span><span><span>)</span></span> <span><span>{</span>
        <span>Err</span><span><span>(</span><span><span>&#34;</span>Failed to create user<span>&#34;</span></span></span><span><span>)</span></span>
    </span><span><span>}</span></span> <span>else</span> <span><span>{</span>
        <span>Ok</span><span><span>(</span><span>unsafe</span> <span><span>{</span> <span>*</span><span>Box</span><span><span>::</span></span>from_raw<span><span>(</span>user</span><span><span>)</span></span> </span><span><span>}</span></span></span><span><span>)</span></span>
    </span><span><span>}</span></span>
</span><span><span>}</span></span></span>
</span></code></pre>
<p>The Rust code now communicates with the C code using a rich enum type, allowing
for more expressive and type-safe code.</p>
<p>If you want, you can play around with the code on the <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=8973e5e655c92c725f0b2b00f7830385">Rust
playground</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Enums in Rust are more powerful than in most other languages.
They can be used to elegantly represent state transitions â€”
even across language boundaries.</p>
<p>You should consider using enums whenever you need to represent a set of possible
values, like when representing the state of an object.</p>
</div></div>
  </body>
</html>
