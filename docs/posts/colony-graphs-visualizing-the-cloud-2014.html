<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.brendangregg.com/ColonyGraphs/cloud.html">Original</a>
    <h1>Colony Graphs: Visualizing the Cloud (2014)</h1>
    
    <div id="readability-page-1" class="page"><div>

<p>What does the cloud look like? As a customer, you may have thousands of instances running a variety of applications. As a cloud provider, you may have thousands of customers, running everything imaginable.</p>

<p>A process colony graph, or &#34;ptree graph&#34;, is a way to visualize your live application environment, based on basic process details. It illustrates the number, types, and activity of your applications, and allow you to spot unusual or problem areas.</p><p>The following sections show ptree graphs at increasing scales, from a few processes to an entire cloud datacenter.</p>

<h2>1. Processes</h2>

<p>Examining just a few processes to begin with (click any of these images for the full version):</p>

<center><a href="https://www.brendangregg.com/ColonyGraphs/pmap-1-processes.png"><img src="https://www.brendangregg.com/ColonyGraphs/pmap-1-processes-800.png" alt="" title="pmap-1-processes" width="400"/></a></center>

<p>Parent-child relationships are shown with arrows.  The size of each process reflects recent CPU usage: bigger means busier.  The color identifies the type of process: system processes are shown in light blue.  These details can be adjusted - the process size could show memory footprint, for example.</p>

<h2>2. Zone</h2>

<p>This is what a typical cloud computing node looks like (also known as a &#34;zone&#34; or &#34;container&#34;), in this case, a web server:</p>

<center><a href="https://www.brendangregg.com/ColonyGraphs/pmap-2-zone.png"><img src="https://www.brendangregg.com/ColonyGraphs/pmap-2-zone-1000.png" alt="" title="pmap-2-zone" width="500"/></a></center>

<p>The master process for the web server can be seen surrounded by its worker processes, all shown in red.  The worker processes are drawn larger, since they are busier on CPU doing work to respond to web requests.  In the middle is a gray oval representing the &#34;init&#34; process of the zone (the real customer zone name has been scrubbed here).  The full set of system processes that make up the zone can also be seen, with their relationship.</p>

<h2>3. Server</h2>

<p>Now scaling to show an entire physical server, which is running nine zones (plus one &#34;global&#34; zone):</p>

<center><a href="https://www.brendangregg.com/ColonyGraphs/pmap-3-server.png"><img src="https://www.brendangregg.com/ColonyGraphs/pmap-3-server-1200.png" alt="" title="pmap-3-server" width="600" height="648"/></a></center>

<p>Green is for language related processes, such as php, python, java, etc.  Pink shows database processes, including MySQL, memcached, Riak, etc.   The green/red zone is a Ruby/Apache server, and the top left zone has both mysqld and memcached.  The largest pink process at the top is a busy MySQL server.</p>

<p>Previously I could look at lists of processes using ps or ptree to see the same data. But getting a quick sense of what&#39;s processes exist, and are busy, from pages of text output becomes unwieldy.  Consider examining the same data on a rack of servers â€“ in can become hundreds of pages of text.</p>

<h2>4. Rack</h2>

<p>Visualizing all the zones in a rack:</p>

<center><a href="https://www.brendangregg.com/ColonyGraphs/pmap-4-rack-2400.png"><img src="https://www.brendangregg.com/ColonyGraphs/pmap-4-rack-1200.png" alt="" title="pmap-4-rack" width="600" height="592"/></a></center>

<p>More zone types pop out and can be identified quickly.  The chain of five green circles is a Perl server, with five busy perl processes. At this scale, this visualization is starting to look like a bacteria colony in a petri dish (which was inspiration for the name: colony graphs).</p>

<h2>5. Datacenter</h2>

<p>Now for a datacenter, which consists of a fleet of racks. These constitute an &#34;availability zone&#34;:</p>

<center><a href="https://www.brendangregg.com/ColonyGraphs/pmap-5-datacenter-2400.png"><img src="https://www.brendangregg.com/ColonyGraphs/pmap-5-datacenter-1200.png" alt="" title="pmap-5-datacenter" width="600" height="598"/></a></center>

<p>It&#39;s the first time I&#39;ve seen all the processes in an entire datacenter in one image.  This includes over 300 servers and over 3500 zones. Gathering the process data to generate this was easier than it sounds: since this is an OS virtualized cloud, I only needed to login to the 300 physical servers, and not the 3500 individual zone instances, to capture all processes running.</p>

<p>This image can be generated automatically to look for anomalies and changes in the cloud.  I&#39;ve made many discoveries so far, with the graphs often beautiful and unexpected.</p>

<h2>Dead Zone</h2>

<p>One of the discoveries can be seen in the middle of the graph above: six large zones that appear as concentric circles.  Here&#39;s how they look zoomed in:</p>

<center><a href="https://www.brendangregg.com/ColonyGraphs/pmap-deadzone.png"><img src="https://www.brendangregg.com/ColonyGraphs/pmap-deadzone-zoom.png" alt="" title="deadzone" width="900" height="600"/></a></center>

<p>My jaw dropped when I first saw this.  What&#39;s happened is that this zone is running a shell program via cron (system scheduler), that processes the result of getent.  The getent process is stuck on an LDAP lookup that never completes, and so all its related processes are also stuck.  Cron kept generating these mindlessly, until the zone had hit its process limit.</p>

<p>Fortunately these were old test zones that were not hurting anyone.</p>

<h2>Implementation</h2>

<p>These ptree graphs are based on process ID, parent process ID, process name, recent percent CPU, collected using just ps(1):

</p><pre># <b>ps -eo zone,ppid,pid,rss,pcpu,comm</b>
</pre>

<p>This includes a couple of extra fields: zone name (zone), for mapping any later discovered anomalies back to the origin zone, and resident set size (rss), for generating ptree graphs based on memory usage instead of CPU usage, when desired.</p>

<p>I&#39;ve been using the neato program from <a href="http://www.graphviz.org/">graphviz</a> to generate the images from this data. It reads a graph description in <a href="http://www.graphviz.org/doc/info/lang.html">DOT format</a>, and I wrote a trivial shell/awk program to convert the ps(1) output into DOT: <a href="https://www.brendangregg.com/ColonyGraphs/ps2gv-p.sh">ps2gv-p.sh</a>, which has the companion file <a href="https://www.brendangregg.com/ColonyGraphs/colors.awk">colors.awk</a>.</p>

<p>Here&#39;s an example of their use, to examine processes on my macbook, which has graphviz already installed:</p>

<pre>$ <b>ps -eo ppid,pid,rss,pcpu,comm | awk &#39;{ print &#34;-&#34;, $0 }&#39; &gt; ps-macbook.txt</b>
$ <b>./ps2gv-p.sh ps-macbook.txt</b>
$ <b>neato -Tpng -Nfontsize=12 -Elen=1.9 ps-macbook.gv -o ps-macbook.png</b>
</pre>

<p>The ps(1) on OS X doesn&#39;t have the zone field, so I used awk to add a dummy field. If you are elsewhere, use the earlier ps(1) command.</p>

<p>The resulting image is:</p>

<center><a href="https://www.brendangregg.com/ColonyGraphs/ps-macbook.png"><img src="https://www.brendangregg.com/ColonyGraphs/ps-macbook.png" alt="" title="macbook" width="600"/></a></center>

<p>If you look closely, you can find the bash shell that&#39;s running the ps(1) command, like a reflection of the photographer.</p>

<p>Adjust -Nfontsize and -Elen (edge length) as desired. You can also customize the colors.awk file, which maps process names to colors. It uses gray if a mapping isn&#39;t present. There is also setting in ps2gv-p.sh, cpulimit, which adjusts the scaling of the node sizes.</p>

<p>To use this on the cloud, collect the ps(1) output from multiple servers and concatenate before processing with ps2gv-p.sh.</p>

<h2>Conclusion</h2>

<p>Process colony graphs is a simple visualization of process parent/child relationships, which is a useful way to study environments at scale, up to entire datacenters. These were an experimental visualization created using ps(1) and graphviz, and have proven useful, finding issues that other observability tools have overlooked.</p>

<p>For more colony graphs, see the <a href="https://www.brendangregg.com/colonygraphs.html">main page</a>.</p>

</div></div>
  </body>
</html>
