<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://david.coffee/cloudflare-zero-trust-tunnels">Original</a>
    <h1>I finally understand Cloudflare Zero Trust tunnels</h1>
    
    <div id="readability-page-1" class="page"><div><p>A while ago, after frustration with Tailscale in environments where it couldn‚Äôt properly penetrate NAT/firewall and get a p2p connection, I decided to invest some time into learning something new: Cloudflare Zero Trust + Warp.</p><p>There are so many new concepts, but after way too long, I can finally say that <strong>I understand Cloudflare Zero Trust Warp now</strong>. I am a full-on Cloudflare Zero Trust with Warp convert, and while I still have Tailscale running in parallel, almost everything I do now is going through Zero Trust tunnels.</p><p>This post is an explanation of the basic concepts, because I‚Äôm sure others will have similar issues wrapping their head around it.</p><h4 id="why-tho">Why tho?</h4><p>Why would you even sink so much time into learning this? What does it give you?</p><p>Argo tunnels through Zero Trust allow you to do a bunch of <em>really</em> cool things:</p><ul><li>Connect private networks together - can be home networks, can be kubernetes clusters, you can create tunnels to and from every infra</li><li>Expose private services to the public, on public hostnames, no matter where they are running. You could even put your router running at 192.168.1.1 on the internet, accessible to everyone, no Warp client required</li><li>Create fully private networks with private IPs (10.x.x.x) that only resolve when Warp is connected, to services you specify</li><li>Quickly expose a public route to any service running locally or on any server, for quick development, testing webhooks or giving coworkers a quick preview</li><li>Create a fully private network running at home that‚Äôs only available when you‚Äôre connected to the Warp VPN client, or only to you, reachable anywhere</li><li>No worries about NAT, everything goes through the Cloudflare network, no direct p2p connection required</li><li>Add very granular access policies on who can access what - what login method does the user need, which email addresses are allowed. Allow bots and server-to-server exceptions with service access tokens.<ul><li>Does the user need to have Warp running? Does he need to be enrolled in Zero Trust? Does he need some special permission flag?</li></ul></li><li>Authenticate to SSH servers through Zero Trust access policies without the need of SSH keys. Just connect Warp, type <code>ssh host</code> and you‚Äôre logged in<ul><li>Close public SSH ports completely to only allow login through Warp</li></ul></li><li>Get the benefits of Cloudflare VPN edge routing on top (similar to 1.1.1.1 Warp+)</li></ul><h2 id="quickie-cloudflare-zero-trust-vs-tailscale">Quickie: Cloudflare Zero Trust vs Tailscale</h2><p>To get this out of the way:</p><ul><li><strong>Tailscale</strong>: peer-to-peer, uses NAT and firewall penetration methods to establish p2p connections. If not possible, it goes through central relay servers. Absolute best speed and latency if a connection is established.</li><li><strong>Cloudflare</strong>: All traffic (with the exception of warp-to-warp routing, which is p2p) goes through Cloudflare‚Äôs edge network. So even SSH-ing into your local router will hop through Cloudflare servers. This adds latency, but no issues with NAT at all.</li></ul><h2 id="cloudflared--warp">Cloudflared != Warp</h2><p>Cloudflare has 2 tools available: <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-devices/warp/">Warp Client</a> and <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/">Cloudflared</a>. They interact with each other and have similarities in some areas but are not the same.</p><p><strong>Warp Client</strong></p><p>The tool that connects you to the Cloudflare network. This is the thing that you configure to add clients into your Zero Trust network and enforces policies.</p><p>Usually this runs on clients, but can also run on servers.</p><p>Warp client also supports <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/private-net/warp-to-warp/">warp-to-warp routing</a> which is a true p2p connection similar to Tailscale.</p><p><strong>Cloudflared</strong></p><p>The thing that creates a <strong>tunnel</strong> and adds it to the Zero Trust network.</p><p>Most commonly you run this on servers to expose tunnels into your network, but you can also run it on clients.</p><p>On the client side you can use <code>cloudflared access</code> to establish a connection with other things in your Zero Trust network.</p><p>Can also create one-time-use tunnels that aren‚Äôt connected to the Zero Trust network. Good for testing.</p><h2 id="tunnels-routes-targets">Tunnels, Routes, Targets</h2><p>This took me the longest to understand. Zero Trust allows you to configure <em>Tunnels</em>, <em>Routes</em> and <em>Targets</em>; here‚Äôs how they interplay.</p><h3 id="tunnels">Tunnels</h3><p>The most important part of your setup. Tunnels are deployed through <code>cloudflared</code> and are simply an <em>exit</em> for traffic. Think of it as a literal tunnel that has its end somewhere.</p><p>Tunnels are deployed to infrastructure in the target network. So if you have a home network with 192.168.1.1/24, you want to deploy <code>cloudflared</code> on any machine that‚Äôs always on and within that network. It can be your router, or your Raspi, it doesn‚Äôt matter.</p><p>For server-hosted services, you can have a tunnel on your main dev server, on a server, or on a pod in your Kubernetes cluster.</p><p>Now you have an opening into these networks through Warp/Argo tunnels.</p><h4 id="configuring-tunnels">Configuring tunnels</h4><p>You can either <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/do-more-with-tunnels/local-management/configuration-file/">configure</a> tunnels through the Zero Trust UI by ‚Äúadopting‚Äù them, or configure them in the <code>/etc/cloudflared/config.yml</code> config on the machine itself. Personal preference, I usually configure them on the machine itself.</p><p>The config specifies where a request should get routed to when it arrives at the tunnel. So the tunnel knows what to do with it.</p><p>In this config we tell cloudflared to route traffic arriving at this tunnel for hostname <code>gitlab.widgetcorp.tech</code> to localhost:80, and <code>gitlab-ssh</code> to the local SSH server.</p><pre tabindex="0"><code>‚ùØ cat /etc/cloudflared/config.yml
tunnel: a2f17e27-cd4d-4fcd-b02a-63839f57a96f
credentials-file: /etc/cloudflared/a2f17e27-cd4d-4fcd-b02a-63839f57a96f.json
ingress:
  - hostname: gitlab.widgetcorp.tech
    service: http://localhost:80
  - hostname: gitlab-ssh.widgetcorp.tech
    service: ssh://localhost:22
  - service: http_status:404

  # Catch-all for WARP routing
  - service: http_status:404

warp-routing:
  enabled: true
</code></pre><p>The config alone doesn‚Äôt do anything. It just exposes a tunnel, and that‚Äôs it. What we need now are routes and targets.</p><h4 id="exposing-a-private-network-to-the-public-with-tunnels-quickly">Exposing a private network to the public with tunnels quickly</h4><p>Quick addition, as this is a super common use case. If you want to just expose something in your home network to the internet, you can add a config like this:</p><pre tabindex="0"><code>tunnel: a2f17e27-cd4d-4fcd-b02a-63839f57a96f
credentials-file: /etc/cloudflared/a2f17e27-cd4d-4fcd-b02a-63839f57a96f.json
ingress:
  - hostname: homeassistant.mydomain.com
    service: http://192.168.1.3:80
</code></pre><p>Then go into Cloudflare DNS settings and map the domain <code>homeassistant.mydomain.com</code> to the tunnel:</p><p><code>CNAME homeassistant.mydomain.com a2f17e27-cd4d-4fcd-b02a-63839f57a96f.cfargotunnel.com</code></p><p>Now all traffic going to this domain will go through the cloudflared tunnel, which is configured to route <code>homeassistant.mydomain.com</code> to <code>192.168.1.3</code>. <strong>No Warp client needed</strong>, Argo tunnel does everything for us.</p><p><strong>Note:</strong> If you adopted the tunnels and don‚Äôt use <code>config.yaml</code>, you can automatically create matching DNS records in the Cloudflare UI and don‚Äôt need to do this manually.</p><h3 id="routes">Routes</h3><p>A route defines <em>where</em> to direct traffic to.</p><p>Let‚Äôs say your homeassistant runs on 192.168.1.3 at home and you want to reach it from outside. Just above we deployed a <code>cloudflared</code> tunnel on our router at 192.168.1.3, and added a config pointing the domain to the Argo tunnel, so <code>homeassistant.mydomain.com</code> is already available to the public. However, <code>192.168.1.3</code> isn‚Äôt, as it‚Äôs a private network IP.</p><p><img src="https://david.coffee/routes-configure.png" alt="Configuring a route in Zero Trust"/></p><p>You can define:</p><ul><li>A route like <code>192.168.1.1/24</code> pointing at your tunnel, to route <em>ALL</em> traffic to the full IP range through that tunnel (so even 192.168.1.245 will go through your tunnel)</li><li>Or a more specific route like <code>192.168.1.3/32</code> pointing at your tunnel, to <em>ONLY</em> route traffic to 192.168.1.3 through that tunnel.</li></ul><p>When configured, once your user connects their Warp client that‚Äôs set up with your Zero Trust network, the Warp client will see requests to 192.168.1.3 and route it through the Cloudflare network to reach your specific tunnel. Like a little police helper directing cars where to go.</p><p><em>If the Warp client is <strong>not</strong> connected, 192.168.1.3 will just resolve in your current local network. If connected, it will resolve to the tunnel.</em></p><p><strong>The routed IP doesn‚Äôt need to exist!</strong> So you could, for example, route a random IP you like (e.g., 10.128.1.1) to your tunnel, the tunnel then forwards it based on your routes, for example to 192.168.1.1. This is extremely powerful because it allows you to build your own fully virtual network.</p><p>That‚Äôs all it does, what happens afterwards is up to the tunnel config that we created above. The tunnel decides where to point the incoming request to, whether that‚Äôs localhost or somewhere else.</p><p>To summarize, the <code>route</code> tells the Warp client where to route traffic to.</p><p>Now we have 2 things working:</p><ul><li><code>homeassistant.mydomain.com</code> - goes through a Cloudflare DNS record pointing at an Argo tunnel, which then forwards to 192.168.1.3. This works without Warp connected as it‚Äôs on the DNS level, public to everyone.</li><li><code>192.168.1.3</code> - The Warp client sees the request and routes it through the Argo tunnel, which then forwards it to <code>192.168.1.3</code> within that network. This needs Warp connected to work, and is only visible to people in your Zero Trust org.</li></ul><h3 id="targets">Targets</h3><p>This one took me a while.</p><p>Targets are needed to <em>define a piece of infrastructure</em> that you want to protect through Zero Trust. They are like a pointer pointing to something in your network. This goes hand-in-hand with routes, but isn‚Äôt always needed.</p><p>Let‚Äôs say you have 192.168.1.3 (homeassistant) exposed through a Cloudflare tunnel. By default, anyone in your network that is part of your Zero Trust org and has Warp client installed can now access your homeassistant at 192.168.1.3.</p><p>We can change that with targets. For example, defining a target with hostname = <code>homeassistant.mydomain.com</code> to the route <code>192.168.1.3/32</code> allows us to add access policies to it. We can also put an entire network into the target by specifying <code>192.168.1.3/24</code> to control access. This also works with virtual IPs like 10.128.1.1!</p><p><img src="https://david.coffee/targets-config-screen.png" alt="Configuring a target in Zero Trust"/></p><p>Targets alone won‚Äôt do anything, they just point to the service or network. ‚ÄúHey, here is homeassistant‚Äù, or ‚Äúhey, here is my home network‚Äù.</p><h2 id="access-policies-protecting-who-can-access-what">Access Policies: Protecting Who Can Access What</h2><p>Continuing the example from above:</p><ul><li>we have a tunnel running on our home network that routes <code>homeassistant.mydomain.com</code> to <code>192.168.1.3</code></li><li>we set up public DNS records to point <code>homeassistant.mydomain.com</code> to the Argo tunnel in Cloudflare</li><li>we created a <em>route</em> <code>192.168.1.3</code> to go through the same tunnel</li><li>we also created a <em>target</em> pointing to <code>192.168.1.3</code></li></ul><p>When users access either <code>192.168.1.3</code> or <code>homeassistant.mydomain.com</code>, the Warp client will route the request through the tunnel, which then forwards the request to 192.168.1.3. Homeassistant loads and everything is fine.</p><p><em>But do we want that?</em></p><p>Probably not.</p><p>Access policies to the rescue!</p><p>With access policies, we can leave things in the public but protect them with Cloudflare Zero Trust access. So while 192.168.1.3 is only available if Warp is connected (so routing to it works), we can add security to our public <code>homeassistant.mydomain.com</code>.</p><p>Go to Access -&gt; Applications -&gt; Add an Application -&gt; Self-hosted.</p><p>Here we can define <em>what</em> should be protected, and <em>how</em>.</p><p>Going with our previous example, we can add a public hostname <code>homeassistant.mydomain.com</code> or an IP like <code>192.168.1.3</code> (or both), then attach policies of who should be able to access it.</p><p>You can specify <strong>Include</strong> (‚ÄúOR‚Äù) and <strong>Require</strong> (‚ÄúAND‚Äù) selectors.</p><ul><li><strong>Require</strong> rules must always be met, <em>on top</em> of include rules, to grant access</li><li>Any of the <strong>Include</strong> rules must match to grant access</li></ul><p>Then there are <em>Actions</em>:</p><ul><li><strong>Allow</strong> - when the policy matches, allow access</li><li><strong>Deny</strong> - when the policy matches, deny access. aka blocking something.</li><li><strong>Bypass</strong> - when the policy matches, bypass Zero Trust completely. No more checking.</li><li><strong>Service Auth</strong> - when the policy matches, allow authentication to the service with a service token header (good for server-to-server, or bots). Check Access -&gt; Service Auth to create these tokens.</li></ul><h3 id="allow-public-access-to-everyone-logging-into-your-network">Allow public access to everyone logging into your network</h3><p>The most common use case: <code>homeassistant.mydomain.com</code> is public. We want to keep it public, but add an extra layer of security.</p><p>Add an <em>include</em> policy, pick any of the <code>email</code> selectors, add the email of the user you want to allow access to. Now only people authenticated with your Zero Trust org with the specified emails can access your homeassistant, without needing to have Warp running.</p><p>We can harden this by adding <em>require</em> rules: Add a <em>Login Method</em> selector rule, pick a specific login method like GitHub. Now only people with specific emails that have authenticated through GitHub can access your homeassistant, without needing to have Warp running.</p><p><img src="https://david.coffee/policy-github-emails.png" alt="Configuring an Access Policy with GitHub and email"/></p><h3 id="bypass-login-completely-when-connected-through-warp">Bypass login completely when connected through WARP</h3><p>Another policy I like having is to skip the login screen entirely when connected through Warp. If a user is already enrolled into my Zero Trust org and has the Warp client provisioned, then there‚Äôs no need to ask them to authenticate again.</p><p>We can add a separate policy (don‚Äôt edit the one we just created above), pick the <em>Gateway</em> selector and set it to <em>Allow</em> or <em>Bypass</em>.</p><p><img src="https://david.coffee/policy-gateway-auth.png" alt="Policy to allow Gateway auth"/></p><p><strong>Don‚Äôt use ‚ÄòWarp‚Äô</strong> - the Warp selector will match anyone that has Warp running, including the consumer 1.1.1.1 app. <em>Gateway</em>, on the other hand, matches only if someone is connecting through your Gateway, be that DNS or a provisioned Warp client.</p><p><em>(The ‚ÄòGateway‚Äô selector is only available if the Warp client is set to allow WARP authentication identity)</em></p><p>Now when:</p><ul><li>Warp through Zero Trust is running on a machine: No login screen</li><li>No Warp running (public access): Prompt for login screen, but only allow specific emails that authenticated through GitHub</li></ul><p>This setup makes it very convenient to reach homeassistant, no matter if connected through Warp or not.</p><h2 id="deploying-the-warp-client-and-enrolling-into-zero-trust">Deploying the Warp client and enrolling into Zero Trust</h2><p>Are you still with me?</p><p>Our network is basically done. We have a login-protected <code>homeassistant.mydomain.com</code> that routes through our tunnel into our private network and terminates at <code>192.168.1.3</code>, and we have a direct route to <code>192.168.1.3</code> that only works when connected with Warp.</p><p>We also have login policies to make sure only specific users (logged in with GitHub and certain email addresses) can access homeassistant.</p><p><em>So how do we deploy the dang Warp client?</em></p><p>Actually the same: We create some policies.</p><p><strong>Head to Settings -&gt; Warp Client</strong></p><p>In <strong>Enrollment Permissions</strong>, we specify the same policies for who can enroll. For example, ‚Äú<a href="https://david.coffee/cdn-cgi/l/email-protection" data-cfemail="dcbab3b3f2bebdae9cb8b3b1bdb5b2f2bfb3b1">[email¬†protected]</a>‚Äù when authenticated through GitHub is allowed to enroll. In the <em>Login Methods</em> we can specify what login methods are available when someone tries to enroll into our Zero Trust org.</p><p><img src="https://david.coffee/enrollment-policy-login-methods.png" alt="Login methods enroll policies"/></p><p>Toggle <em>WARP authentication identity settings</em> to make the <em>Gateway</em> selector available in policies, effectively allowing the configured WARP client to be used as a login method.</p><p><strong>Careful here</strong>, once someone is enrolled, they are basically in your Zero Trust network through Warp. Make sure you harden this.</p><p>Then, in <strong>Profile settings</strong>, we define <em>how the WARP client behaves</em>. These are things like protocol: MASQUE or WireGuard, service mode, what IPs and domains to exclude from WARP routing (e.g., the local network should never go through WARP), setting it to exclude or include mode and so on.</p><p>Other settings I recommend setting:</p><ul><li><em>Install CA to system certificate store</em> - installs the Cloudflare CA certificate automatically when enrolled.</li><li><em>Override local interface IP</em> - assigns a unique CGNAT private IP to the client. This is needed for warp-to-warp routing.</li><li><em>Device Posture</em> - what checks the WARP client should perform for the org. E.g., check the OS version, some OS files on disk, etc. I have this set to <em>WARP</em> and <em>Gateway</em> because I want the client to provide information on whether the user is connected through WARP and Gateway, for skipping certain login pages.</li></ul><p><img src="https://david.coffee/device-posture-checks.png" alt="Device posture checks for Gateway and Warp"/></p><p>Once done, just open the Warp client (<a href="https://developers.cloudflare.com/warp-client/)">https://developers.cloudflare.com/warp-client/)</a>, and log in to your network. This should open the login pages you specified in the <em>Device Enrollment</em> screen, and check all the enrollment policies you specified.</p><p>Once passed, congratulations, your WARP client is now connected to your Zero Trust network. The client will then go ahead and start routing <code>192.168.1.3</code> through your tunnels, as specified in your tunnel and route settings.</p><p>üéâ</p><h2 id="what-we-built">What we built</h2><p>If you followed this guide, here is what we built:</p><ul><li>Login methods to connect the Warp client to your Zero Trust org through GitHub and specific email addresses</li><li>A <em>tunnel</em> within your private network that<ul><li>Forwards any request coming in with host <code>homeassistant.mydomain.com</code> to <code>192.168.1.3</code></li></ul></li><li>A <em>route</em> that forwards all traffic for <code>192.168.1.3</code> to the tunnel in your private network, which will terminate it at 192.168.1.3, which will only work when connected through Warp to route the request</li><li>A DNS name <code>homeassistant.mydomain.com</code> that points to the Argo tunnel, and will allow everyone (even if not connected through Warp) to access homeassistant which runs at 192.168.1.3</li><li>Access policies that will<ul><li>Ask users that are not connected to Zero Trust through Warp to log in with GitHub and specific email, so everyone can access it if they can log in</li><li>A policy that skips the login screen completely and just shows homeassistant if the user connects through Zero Trust Warp client (enrolled into our org)</li></ul></li></ul><p>You don‚Äôt need the public domain and you don‚Äôt need the route to 192.168.1.3. These are 2 different options that you can use to expose homeassistant when you‚Äôre not at home. One is using a public domain name everyone can see, one is explicitly requiring connecting through enrolled Warp.</p><p>What I <em>didn‚Äôt</em> cover in this post:</p><ul><li>Warp-to-warp routing</li><li>Creating and assigning fully private IPs that only exist within your Zero Trust network</li><li>SSH authentication through Zero Trust access policies (that‚Äôs what we need <em>Targets</em> for)</li><li>The other application types besides <em>Self-Hosted</em></li></ul><p>I‚Äôm happy to expand on it if there‚Äôs interest. Let me know on <a href="https://x.com/dvcrn">X</a> or <a href="https://bsky.app/profile/david.d.sh">Bluesky</a>.</p><p>Happy tunneling! ‚õÖ</p></div></div>
  </body>
</html>
