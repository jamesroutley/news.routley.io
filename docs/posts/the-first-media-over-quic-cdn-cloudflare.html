<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://moq.dev/blog/first-cdn/">Original</a>
    <h1>The First Media over QUIC CDN: Cloudflare</h1>
    
    <div id="readability-page-1" class="page"><article> <p>
published 8/21/2025 </p> 
<p>🚨 It’s finally happening! 🚨</p>
<p>Cloudflare has <a href="https://blog.cloudflare.com/moq/">just announced</a> their Media over QUIC CDN!
It’s an <strong>official product</strong>, and you can test MoQ on their <em>massive</em>, anycast network.
Try it out, and convince your boss’ boss that the writing is on the wall.</p>
<p>If you’ve been living under a rock, MoQ is an <a href="https://datatracker.ietf.org/group/moq/about/">up-and-coming standard</a> for live media, aiming to supplant <a href="https://moq.dev/blog/replacing-webrtc">WebRTC</a>, <a href="https://moq.dev/blog/replacing-hls-dash">HLS/DASH</a>, and even <strong>RTMP/SRT</strong> as the one to rule them all.
And now Cloudflare wins the award for the first CDN offering!</p>
<figure><p><img src="https://moq.dev/blog/first-cdn/cloudflare.png" alt="Cloudflare logo"/>
</p><figcaption>Your prize is a blog post. You’re welcome mega-corp.</figcaption></figure>
<p>Also, <em>while you’re here</em>, some shameless self-promotion: I just soft-launched <a href="https://moq.dev/blog/first-app">hang.live</a>.
Check it out if you want to see the <del>cringe</del> cool stuff you can do with MoQ.</p>
<h2 id="whats-available-now">What’s available now?</h2>
<p>This is a <a href="https://developers.cloudflare.com/moq/">technical preview</a>, so it’s both free and subject to change.</p>
<p>Cloudflare is hosting a public <code>relay.cloudflare.mediaoverquic.com</code> endpoint that you can <del>abuse</del> test.
Connect using <a href="https://github.com/kixelated/moq">my library</a>, <a href="https://github.com/englishm/moq-rs">Mike’s fork</a>, <a href="https://www.meetecho.com/blog/imquic/">Lorenzo’s imquic</a>, <a href="https://github.com/facebookexperimental/moxygen">Meta’s moxygen</a>, or any client that supports this limited subset of draft-07.</p>
<p>I’m biased so naturally I’m going to use <a href="https://github.com/kixelated/moq/tree/main/js/hang">@kixelated/hang</a> (smash that star button).
You can publish a live broadcast in the browser using the <a href="https://moq.dev/publish">web demo</a> or the <a href="https://github.com/kixelated/moq/blob/main/js/hang-demo/src/publish.html#L25">library</a>:</p>
<pre tabindex="0" data-language="html"><code><span><span>&lt;</span><span>script</span><span> type</span><span>=</span><span>&#34;module&#34;</span><span>&gt;</span></span>
<span><span>	// Registers the &lt;hang-publish&gt; element.</span></span>
<span><span>	import</span><span> &#34;@kixelated/hang/publish/element&#34;</span><span>;</span></span>
<span><span>&lt;/</span><span>script</span><span>&gt;</span></span>
<span></span>
<span><span>&lt;!-- You&#39;ll need to replace `name` with something unique/random. --&gt;</span></span>
<span><span>&lt;</span><span>hang-publish</span><span> url</span><span>=</span><span>&#34;https://relay.cloudflare.mediaoverquic.com&#34;</span><span> name</span><span>=</span><span>&#34;unique-name-abc123&#34;</span><span> audio</span><span> video</span><span> controls</span><span> captions</span><span>&gt;</span></span>
<span><span>	&lt;!-- It&#39;s optional to provide a video element to preview the outgoing media. --&gt;</span></span>
<span><span>	&lt;</span><span>video</span><span> style</span><span>=</span><span>&#34;max-width: 100%; height: auto; border-radius: 4px; margin: 0 auto;&#34;</span><span> muted</span><span> autoplay</span><span>&gt;&lt;/</span><span>video</span><span>&gt;</span></span>
<span><span>&lt;/</span><span>hang-publish</span><span>&gt;</span></span></code></pre>
<p>There’s a link to watch your live broadcast using the <a href="https://moq.dev/watch">web demo</a>, or again you can use the <a href="https://github.com/kixelated/moq/blob/9f5f6153458c03f255877a036e36f68f742d5c85/js/hang-demo/src/index.html#L30">library</a>:</p>
<pre tabindex="0" data-language="html"><code><span><span>&lt;</span><span>script</span><span> type</span><span>=</span><span>&#34;module&#34;</span><span>&gt;</span></span>
<span><span>	// Registers the &lt;hang-watch&gt; element.</span></span>
<span><span>	import</span><span> &#34;@kixelated/hang/watch/element&#34;</span><span>;</span></span>
<span><span>&lt;/</span><span>script</span><span>&gt;</span></span>
<span></span>
<span><span>&lt;!-- Use the same name as the broadcast you published. --&gt;</span></span>
<span><span>&lt;</span><span>hang-watch</span><span> url</span><span>=</span><span>&#34;https://relay.cloudflare.mediaoverquic.com&#34;</span><span> name</span><span>=</span><span>&#34;unique-name-abc123&#34;</span><span> muted</span><span> controls</span><span> captions</span><span>&gt;</span></span>
<span><span>	&lt;!-- It&#39;s optional to provide a canvas if you want audio only --&gt;</span></span>
<span><span>	&lt;</span><span>canvas</span><span> style</span><span>=</span><span>&#34;max-width: 100%; height: auto; border-radius: 4px; margin: 0 auto;&#34;</span><span>&gt;&lt;/</span><span>canvas</span><span>&gt;</span></span>
<span><span>&lt;/</span><span>hang-watch</span><span>&gt;</span></span></code></pre>
<p>You might even notice <strong>closed captions</strong> because I’ve been experimenting with AI features (gotta get funding eventually 💰).
They’re generated <em>in the browser</em> using <a href="https://github.com/snakers4/silero-vad">silero-vad</a> + <a href="https://github.com/openai/whisper">whisper</a> + <a href="https://huggingface.co/docs/transformers.js/en/index">transformers.js</a> + <a href="https://github.com/microsoft/onnxruntime">onnxruntime-web</a> + <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGPU_API">WebGPU</a> and transmitted using MoQ of course.
But that’s a whole separate blog post; it’s pretty cool.</p>
<p><strong>NOTE:</strong> You don’t have to use this <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_components">Web Component</a> API.
<a href="https://moq.dev/blog/first-app">hang.live</a> uses the far more powerful Javascript API to do more complicated stuff like get access to individual video frames.
There’s a <em>super secret</em> section at the end of this blog if you LOVE sample code, but I’m not going to bore the rest of you.</p>
<p>There’s also a 🦀 Rust 🦀 library <a href="https://github.com/kixelated/moq/tree/main/rs/hang">to import MP4</a>, <a href="https://github.com/kixelated/moq/blob/9f5f6153458c03f255877a036e36f68f742d5c85/rs/justfile#L103">pipe media from ffmpeg</a>, and <a href="https://github.com/kixelated/moq/blob/9f5f6153458c03f255877a036e36f68f742d5c85/rs/justfile#L119">publish/watch using gstreamer</a> so you can do more complicated media stuff without 🤮 Javascript 🤮.
I wish I could spend more time on the Rust side but <strong>WebSupport</strong> is a big deal.
We are no longer forced to use WebRTC, but that also means we need to build our own WebRTC in 🤮 Javascript 🤮.
I can suffer and you can reap the rewards.</p>
<p>(and yes, <a href="https://moq.dev/blog/to-wasm">I’m aware that WASM exists</a>, but I ended up abandoning it)</p>
<h2 id="whats-not-available-yet">What’s not available yet?</h2>
<p>This is a <strong>preview</strong> release.
Cloudflare is only supporting a <em>tiny</em> subset of an <a href="https://www.ietf.org/archive/id/draft-ietf-moq-transport-07.html">old draft</a>, which is even smaller than <a href="https://www.ietf.org/archive/id/draft-lcurley-moq-lite-01.html">my tiny subset</a>.
They’re using a <a href="https://github.com/englishm/moq-rs">fork</a> of my terrible code so bugs are guaranteed.</p>
<ul>
<li><strong>There’s no authentication yet</strong>: choose an unguessable name for each broadcast.</li>
<li><strong>There’s no ANNOUNCE support</strong>: my <a href="https://github.com/kixelated/moq/blob/main/js/hang-demo/src/meet.html">conferencing example</a> uses <strong>ANNOUNCE</strong> to discover when broadcasts start/stop, so that won’t work.</li>
<li><strong>There’s no <a href="https://caniuse.com/webtransport">Safari support</a></strong>: <a href="https://github.com/WebKit/standards-positions/issues/18#issuecomment-1495890122">It’s coming eventually</a>.</li>
<li><strong>Nothing has been optimized</strong>: the user experience will improve over time.</li>
</ul>
<p>If any of these are deal breakers, then you could always run your own <a href="https://github.com/kixelated/moq/tree/main/rs/moq-relay">moq-relay</a> in the meantime.
I’ve been adding new features and fixing a bunch of stuff <em>after</em> Cloudflare smashed that fork button.
For example, authentication (via JWT) and a WebSocket fallback for Safari/TCP support.</p>
<p>There’s even a <a href="https://github.com/kixelated/moq.dev/blob/main/infra/relay.tf">terraform module</a> that powers <code>relay.moq.dev</code>.
You too can run your own “global” CDN with 3 nodes and pay GCP a boatload of money for the privilege.
It’s not <em>quite</em> as good as Cloudflare’s network, currently available for free…</p>
<figure><p><img src="https://moq.dev/blog/first-cdn/global.png" alt="A global CDN"/>
</p><figcaption>A “global” CDN according to me, an American. At least I didn’t <a href="https://www.reddit.com/r/MapsWithoutNZ/">forget New Zealand</a>.</figcaption></figure>
<p>Or host <strong>moq-relay</strong> yourself!
It should even work on private networks provided you <a href="https://moq.dev/blog/tls-and-quic">wrestle with TLS certificates</a>.
I’d also love to get MoQ running over <a href="https://www.iroh.computer/">Iroh</a> for peer-to-peer action if anybody wants to help.</p>
<h2 id="why-should-you-care">Why should you care?</h2>
<p>As a great philosopher once said:</p>
<blockquote>
<p>Apathy is a tragedy and boredom is a crime.
- <a href="https://www.youtube.com/watch?v=k1BneeJTDcU">Bo Burnham</a></p>
</blockquote>
<p>This is a big deal.
The biggest of deals.
The HUGEST of deals.</p>
<p>I’ve been an <a href="https://moq.dev/blog/transfork">outspoken critic</a> of the MoQ standardization process.
It’s just really difficult to design a protocol, via a cross-company committee, before there’s been any real world usage.
It’s been over 3 years since I fought Amazon lawyers and published my <a href="https://www.ietf.org/archive/id/draft-lcurley-warp-00.html">first MoQ draft</a>.
It’s going to be at least another 3 years before even the <a href="https://datatracker.ietf.org/doc/draft-ietf-moq-transport/">base networking layer</a> becomes an RFC.</p>
<p><strong>And that’s by design!</strong>
The best standards take a while.
Look no further than QUIC, deployed by Google in 2012, started standardization in 2015, with the RFC released in 2021.
And they had a boatload of production data to shape the specification.
Meanwhile, we have only had a <a href="https://moq.dev/watch">Big Buck Bunny demo</a>, and I believe the standard has veered off course as a result.</p>
<p>Cloudflare has done something fantastic and said:</p>
<blockquote>
<p>fuck waiting for a RFC, let’s release something</p>
</blockquote>
<p>Okay they didn’t say that, but this is <strong>exactly</strong> the mentality that MoQ needs right now.
<strong>Just build something</strong>.
<strong>Just release something</strong>.
<strong>Just do it</strong>.</p>
<figure><iframe width="560" height="315" src="https://www.youtube.com/embed/ZXsQAXx_ao0?si=xsAscm04CnwAer4b" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe><figcaption>Holy shit I’m Shia LaBeouf.</figcaption></figure>
<p>Arguing in the <a href="https://github.com/moq-wg/moq-transport/issues">650+ issues</a> and <a href="https://github.com/moq-wg/moq-transport/pulls">500+ PRs</a> can wait for another day.
Tweaking the messaging encoding for the hundredth time can wait for another day.
We’re still going to make sure that MoQ gets standardized <em>eventually</em>, but it’s more important to get <em>something</em> out there.</p>
<p>I’m looking at you: Google, Akamai, Fastly, etc.
Take some code, run it on some spare servers, and start to learn what customers need <em>before</em> you design the protocol.</p>
<h2 id="whats-next">What’s next?</h2>
<p>A lot of stuff.</p>
<p>We’re effectively trying to reimplement WebRTC / HLS / RTMP using relatively new Web APIs.
Don’t judge MoQ based on these initial offerings.
We’ve got a <strong>ton</strong> of work to do.
<strong>Let’s do it</strong>.</p>
<p><a href="https://discord.gg/FCYF3p99mr">Join the Discord</a>.
Somehow there’s 900+ people in there.
Ping me and I will do whatever I can to help.
<em>Especially</em> if it means putting one more nail in the WebRTC coffin.</p>
<p>Written by <a href="https://github.com/kixelated">@kixelated</a>.
<img src="https://moq.dev/blog/avatar.png" alt="@kixelated"/></p>
<h2 id="javascript-is-an-abomination">Javascript is an Abomination</h2>
<p>Still reading?</p>
<p>You win some bonus documentation.
Congrats!
I knew you would win.</p>
<p>Here’s an example of my reactive library in action.
It powers <a href="https://moq.dev/blog/first-app">hang.live</a> so the API is subject to change and is probably already out of date.
When in doubt, <a href="https://github.com/kixelated/moq/tree/main/js/hang">consult the source code</a> like the hacker you are.</p>
<pre tabindex="0" data-language="typescript"><code><span><span>import</span><span> { Watch } </span><span>from</span><span> &#34;@kixelated/hang&#34;</span></span>
<span></span>
<span><span>// Start downloading a broadcast.</span></span>
<span><span>const</span><span> watch</span><span> =</span><span> new</span><span> Watch.</span><span>Broadcast</span><span>({</span></span>
<span><span>	enabled: </span><span>true</span><span>,</span></span>
<span><span>	url: </span><span>&#34;https://relay.cloudflare.mediaoverquic.com&#34;</span><span>,</span></span>
<span><span>	name: </span><span>&#34;unique-name-abc123&#34;</span><span>,</span></span>
<span><span>	video: { enabled: </span><span>true</span><span> },</span></span>
<span><span>	reload: </span><span>false</span><span>, </span><span>// required for Cloudflare&#39;s CDN</span></span>
<span><span>});</span></span>
<span></span>
<span><span>// You can toggle reactive properties.</span></span>
<span><span>watch.audio.enabled.</span><span>set</span><span>(</span><span>true</span><span>);</span></span>
<span></span>
<span><span>// There are helpers to convert my custom signals, like for React:</span></span>
<span><span>import</span><span> react </span><span>from</span><span> &#34;@kixelated/signals/react&#34;</span></span>
<span><span>const</span><span> audioInfo</span><span> =</span><span> react</span><span>(watch.audio.info); </span><span>// a JSON blob of track information</span></span>
<span></span>
<span><span>// You could use the built-in renderers.</span></span>
<span><span>const</span><span> canvas</span><span> =</span><span> document.</span><span>getElementById</span><span>(</span><span>&#34;canvas&#34;</span><span>);</span></span>
<span><span>const</span><span> audio</span><span> =</span><span> new</span><span> Watch.</span><span>AudioEmitter</span><span>(watch.audio, { volume: </span><span>0.5</span><span> });</span></span>
<span><span>const</span><span> video</span><span> =</span><span> new</span><span> Watch.</span><span>VideoRenderer</span><span>(watch.video, { canvas });</span></span>
<span></span>
<span><span>// Or you can do it yourself, like this crude Vanilla JS example:</span></span>
<span><span>const</span><span> dispose</span><span> =</span><span> watch.video.frame.</span><span>subscribe</span><span>((</span><span>frame</span><span>?:</span><span> VideoFrame</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>	if</span><span> (</span><span>!</span><span>frame) </span><span>return</span><span>;</span></span>
<span></span>
<span><span>	// Render the frame to a canvas, or pass it to a ML model, or whatever.</span></span>
<span><span>	canvas.</span><span>getContext</span><span>(</span><span>&#34;2d&#34;</span><span>)?.</span><span>drawImage</span><span>(frame, </span><span>0</span><span>, </span><span>0</span><span>);</span></span>
<span></span>
<span><span>	// NOTE: You should use requestAnimationFrame instead, but I&#39;m lazy.</span></span>
<span><span>});</span></span></code></pre>
<p>There’s even some <em>top-secret</em> features behind undocumented APIs.
Like running an object detection model in browser and publishing the results as a MoQ track.
Stay tuned for a blog post about that if I can figure out a better use-case than a cat cam. 🐈</p>
<pre tabindex="0" data-language="typescript"><code><span><span>// Publish a broadcast.</span></span>
<span><span>const</span><span> publish</span><span> =</span><span> new</span><span> Watch.</span><span>Publish</span><span>({</span></span>
<span><span>	enabled: </span><span>true</span><span>,</span></span>
<span><span>	url: </span><span>&#34;https://relay.cloudflare.mediaoverquic.com&#34;</span><span>,</span></span>
<span><span>	name: </span><span>&#34;unique-name-abc123&#34;</span><span>,</span></span>
<span><span>	device: </span><span>&#34;camera&#34;</span><span>,</span></span>
<span><span>	video: {</span></span>
<span><span>		enabled: </span><span>true</span><span>,</span></span>
<span><span>		detection: {</span></span>
<span><span>			enabled: </span><span>true</span><span>,</span></span>
<span><span>		}</span></span>
<span><span>	},</span></span>
<span><span>})</span></span></code></pre>
<p>Also, for the record, Typescript is really nice.
🤮 Javascript 🤮 is still an abomination.</p> </article></div>
  </body>
</html>
