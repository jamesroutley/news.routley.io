<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://v8.dev/blog/math-random">Original</a>
    <h1>There&#39;s Math.random(), and then there&#39;s Math.random() (2015)</h1>
    
    <div id="readability-page-1" class="page"><div id="main"><article itemscope="" itemtype="http://schema.org/BlogPosting"><header><p>Published <time datetime="2015-12-17" itemprop="datePublished">17 December 2015</time> · Tagged with <a href="https://v8.dev/blog/tags/ecmascript">ECMAScript</a> <a href="https://v8.dev/blog/tags/internals">internals</a></p></header><div itemprop="articleBody"><blockquote><p><code>Math.random()</code> returns a <code>Number</code> value with positive sign, greater than or equal to <code>0</code> but less than <code>1</code>, chosen randomly or pseudo-randomly with approximately uniform distribution over that range, using an implementation-dependent algorithm or strategy. This function takes no arguments.</p></blockquote><p>— <em><a href="http://tc39.es/ecma262/#sec-math.random">ES 2015, section 20.2.2.27</a></em></p><p><code>Math.random()</code> is the most well-known and frequently-used source of randomness in Javascript. In V8 and most other Javascript engines, it is implemented using a <a href="https://en.wikipedia.org/wiki/Pseudorandom_number_generator">pseudo-random number generator</a> (PRNG). As with all PRNGs, the random number is derived from an internal state, which is altered by a fixed algorithm for every new random number. So for a given initial state, the sequence of random numbers is deterministic. Since the bit size n of the internal state is limited, the numbers that a PRNG generates will eventually repeat themselves. The upper bound for the period length of this <a href="https://en.wikipedia.org/wiki/Cyclic_permutation">permutation cycle</a> is 2<sup>n</sup>.</p><p>There are many different PRNG algorithms; among the most well-known ones are <a href="https://en.wikipedia.org/wiki/Mersenne_Twister">Mersenne-Twister</a> and <a href="https://en.wikipedia.org/wiki/Linear_congruential_generator">LCG</a>. Each has its particular characteristics, advantages, and drawbacks. Ideally, it would use as little memory as possible for the initial state, be quick to perform, have a large period length, and offer a high quality random distribution. While memory usage, performance, and period length can easily be measured or calculated, the quality is harder to determine. There is a lot of math behind statistical tests to check the quality of random numbers. The de-facto standard PRNG test suite, <a href="http://simul.iro.umontreal.ca/testu01/tu01.html">TestU01</a>, implements many of these tests.</p><p>Until <a href="https://github.com/v8/v8/blob/ceade6cf239e0773213d53d55c36b19231c820b5/src/js/math.js#L143">recently</a> (up to version 4.9.40), V8’s choice of PRNG was MWC1616 (multiply with carry, combining two 16-bit parts). It uses 64 bits of internal state and looks roughly like this:</p><pre><code><span>uint32_t</span> state0 <span>=</span> <span>1</span><span>;</span></code></pre><p>The 32-bit value is then turned into a floating point number between 0 and 1 in agreement with the specification.</p><p>MWC1616 uses little memory and is pretty fast to compute, but unfortunately offers sub-par quality:</p><ul><li>The number of random values it can generate is limited to 2<sup>32</sup> as opposed to the 2<sup>52</sup> numbers between 0 and 1 that double precision floating point can represent.</li><li>The more significant upper half of the result is almost entirely dependent on the value of state0. The period length would be at most 2<sup>32</sup>, but instead of few large permutation cycles, there are many short ones. With a badly chosen initial state, the cycle length could be less than 40 million.</li><li>It fails many statistical tests in the TestU01 suite.</li></ul><p>This has been <a href="https://medium.com/@betable/tifu-by-using-math-random-f1c308c4fd9d">pointed out</a> to us, and having understood the problem and after some research, we decided to reimplement <code>Math.random</code> based on an algorithm called <a href="http://vigna.di.unimi.it/ftp/papers/xorshiftplus.pdf">xorshift128+</a>. It uses 128 bits of internal state, has a period length of 2<sup>128</sup> - 1, and passes all tests from the TestU01 suite.</p><p>The implementation <a href="https://github.com/v8/v8/blob/085fed0fb5c3b0136827b5d7c190b4bd1c23a23e/src/base/utils/random-number-generator.h#L102">landed in V8 v4.9.41.0</a> within a few days of us becoming aware of the issue. It will become available with Chrome 49. Both <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=322529#c99">Firefox</a> and <a href="https://bugs.webkit.org/show_bug.cgi?id=151641">Safari</a> switched to xorshift128+ as well.</p><p>In V8 7.1 the implemementation was adjusted again <a href="https://chromium-review.googlesource.com/c/v8/v8/+/1238551/5">CL</a> relaying only on state0. Please find further implementation details in the <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/base/utils/random-number-generator.h;l=119?q=XorShift128&amp;sq=&amp;ss=chromium">source code</a>.</p><p>Make no mistake however: even though xorshift128+ is a huge improvement over MWC1616, it still is not <a href="https://en.wikipedia.org/wiki/Cryptographically_secure_pseudorandom_number_generator">cryptographically secure</a>. For use cases such as hashing, signature generation, and encryption/decryption, ordinary PRNGs are unsuitable. The Web Cryptography API introduces <a href="https://developer.mozilla.org/en-US/docs/Web/API/RandomSource/getRandomValues"><code>window.crypto.getRandomValues</code></a>, a method that returns cryptographically secure random values, at a performance cost.</p><p>Please keep in mind, if you find areas of improvement in V8 and Chrome, even ones that — like this one — do not directly affect spec compliance, stability, or security, please file <a href="https://bugs.chromium.org/p/v8/issues/entry?template=Defect%20report%20from%20user">an issue on our bug tracker</a>.</p></div></article></div></div>
  </body>
</html>
