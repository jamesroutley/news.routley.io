<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://eieio.games/nonsense/game-15-doom-ios-photos-app/">Original</a>
    <h1>DOOM in the iOS Photos app (kind of)</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
        <p>I made a game with <a href="https://adnanaga.com/">Adnan Aga</a>. It’s DOOM, but it runs inside the iOS photos app. Kind of.</p>


<p>look, we eventually manage to get up some stairs</p>

<p>It is…technically playable? We managed to pick up some power ups and shoot at some enemies. It requires 8 manually configured iOS shortcuts, a dedicated photos folder, and a separately configured computer.</p>

<p>Let’s look at how it works!
<!-- excerpt-end --></p>

<h2 id="why">Why</h2>
<p><a href="http://eieio.games/nonsense/game-13-breaktime/">I’ve been trying</a> to embed a game in the iOS walled garden for most of a year. I like <a href="http://eieio.games/nonsense/game-11-flappy-bird-finder/">putting games in weird places</a> and iOS is a clasically locked down ecosystem, which makes it a fun target.</p>

<p>Adnan and I were both doing a camp at <a href="https://itp.nyu.edu/itp/">ITP</a> this past summer and wanted a break from our longer-term projects - we thought that building a weird game inside iOS would be a fun diversion.</p>

<h2 id="discarded-prototypes">Discarded Prototypes</h2>
<p>To start, we searched for UI elements that we could abuse to display something interesting to the user. The first thing that we found was the lockscreen background. This was initially promising - it was easy to swap out the background with a shortcut, and we could easily get a reasonable framerate (here a proof of concept running at 2 FPS):</p>

<div>
<video src="/assets/images/doom-ios/background-swap.mp4" playsinline="" muted="" controls="" poster="/assets/images/doom-ios/background-swap-firstframe.png"></video>
<p><img src="http://eieio.games/assets/images/doom-ios/background-swap-code.png"/>
</p></div>
<p>can&#39;t say I&#39;d want my background to do this all the time tbh</p>

<p>This seemed promising! We started kicking around ideas for animations we could run on the lockscreen - we thought maybe we could run a whack-a-mole game where the lockscreen would cycle between different “mole” positions that overlapped with icons that you’d need to tap at the right time. But we ran into two problems:</p>

<ol>
  <li>We wanted to make our app icons translucent (so that you could see the “mole” behind the icon) and you…can’t do that. We probably could have worked around this, but…</li>
  <li>There’s a pretty low cap on the number of different lockscreen backgrounds you can have (I think it’s 10?) - which would have really limited the types of animations we could run.</li>
</ol>

<p>The second point there seemed like a big problem - we wanted a dynamic game, and 10 frames just didn’t seem dynamic enough. So we started looking around - and quickly found something exciting.</p>

<h2 id="ios-shortcuts-can-download-images">iOS shortcuts can download images!</h2>
<p>iOS shortcuts can hit arbitrary URLs and download images! So we could have a whole separate webserver that ran our game, and it could serve up images that we could slam onto the lockscreen background.</p>

<p><img src="http://eieio.games/assets/images/doom-ios/image-download-example.jpeg"/>
</p>
<p>shortcuts are wild</p>

<p>After testing a shortcut that downloaded an image from a website and set it as my lockscreen, I set out to prototype something dynamic. I settled on a shortcut that would capture an image from my laptop webcam and save it as my wallpaper because that seemed like a fun thing to do. So I wrote a simple server with an endpoint that would return a photo from my laptop webcam, and configured a shortcut that hit that server endpoint and saved the photo to my lockscreen in a loop.</p>


<p>demo feat. my 7 month old puppy Gabby</p>

<p>The shortcut code for this was pretty simple</p>
<p><img src="http://eieio.games/assets/images/doom-ios/webcam-capture-code.jpeg"/>
</p>
<p>shortcuts are *really* wild</p>

<details>
    <summary>And here&#39;s the server code if you&#39;re curious.</summary>
    
<figure><pre><code data-lang="python"><span>from</span> <span>flask</span> <span>import</span> <span>Flask</span><span>,</span> <span>Response</span>
<span>import</span> <span>cv2</span>
<span>from</span> <span>PIL</span> <span>import</span> <span>Image</span>
<span>import</span> <span>io</span>

<span>app</span> <span>=</span> <span>Flask</span><span>(</span><span>__name__</span><span>)</span>

<span># iPhone 14 mini dimensions in portrait mode
</span><span>IPHONE_WIDTH</span> <span>=</span> <span>1080</span>
<span>IPHONE_HEIGHT</span> <span>=</span> <span>2340</span>

<span>cap</span> <span>=</span> <span>cv2</span><span>.</span><span>VideoCapture</span><span>(</span><span>0</span><span>)</span>

<span>@</span><span>app</span><span>.</span><span>route</span><span>(</span><span>&#39;/screenshot&#39;</span><span>)</span>
<span>def</span> <span>get_screenshot</span><span>():</span>
    <span>ret</span><span>,</span> <span>frame</span> <span>=</span> <span>cap</span><span>.</span><span>read</span><span>()</span>

    <span>if</span> <span>not</span> <span>ret</span><span>:</span>
        <span>return</span> <span>&#34;Failed to capture screenshot&#34;</span><span>,</span> <span>500</span>
    <span>frame</span> <span>=</span> <span>cv2</span><span>.</span><span>cvtColor</span><span>(</span><span>frame</span><span>,</span> <span>cv2</span><span>.</span><span>COLOR_BGR2RGB</span><span>)</span>
    <span>img</span> <span>=</span> <span>Image</span><span>.</span><span>fromarray</span><span>(</span><span>frame</span><span>)</span>

    <span>width</span><span>,</span> <span>height</span> <span>=</span> <span>img</span><span>.</span><span>size</span>
    <span>aspect_ratio</span> <span>=</span> <span>IPHONE_WIDTH</span> <span>/</span> <span>IPHONE_HEIGHT</span>
    <span>if</span> <span>width</span> <span>/</span> <span>height</span> <span>&gt;</span> <span>aspect_ratio</span><span>:</span>
        <span>new_width</span> <span>=</span> <span>int</span><span>(</span><span>height</span> <span>*</span> <span>aspect_ratio</span><span>)</span>
        <span>left</span> <span>=</span> <span>(</span><span>width</span> <span>-</span> <span>new_width</span><span>)</span> <span>//</span> <span>2</span>
        <span>right</span> <span>=</span> <span>left</span> <span>+</span> <span>new_width</span>
        <span>img</span> <span>=</span> <span>img</span><span>.</span><span>crop</span><span>((</span><span>left</span><span>,</span> <span>0</span><span>,</span> <span>right</span><span>,</span> <span>height</span><span>))</span>
    <span>else</span><span>:</span>
        <span>new_height</span> <span>=</span> <span>int</span><span>(</span><span>width</span> <span>/</span> <span>aspect_ratio</span><span>)</span>
        <span>top</span> <span>=</span> <span>(</span><span>height</span> <span>-</span> <span>new_height</span><span>)</span> <span>//</span> <span>2</span>
        <span>bottom</span> <span>=</span> <span>top</span> <span>+</span> <span>new_height</span>
        <span>img</span> <span>=</span> <span>img</span><span>.</span><span>crop</span><span>((</span><span>0</span><span>,</span> <span>top</span><span>,</span> <span>width</span><span>,</span> <span>bottom</span><span>))</span>

    <span>img</span> <span>=</span> <span>img</span><span>.</span><span>resize</span><span>((</span><span>IPHONE_WIDTH</span><span>,</span> <span>IPHONE_HEIGHT</span><span>))</span>
    <span>img_bytes</span> <span>=</span> <span>io</span><span>.</span><span>BytesIO</span><span>()</span>
    <span>img</span><span>.</span><span>save</span><span>(</span><span>img_bytes</span><span>,</span> <span>format</span><span>=</span><span>&#39;JPEG&#39;</span><span>)</span>
    <span>img_bytes</span><span>.</span><span>seek</span><span>(</span><span>0</span><span>)</span>
    <span>response</span> <span>=</span> <span>Response</span><span>(</span><span>img_bytes</span><span>.</span><span>getvalue</span><span>(),</span> <span>mimetype</span><span>=</span><span>&#39;image/jpeg&#39;</span><span>)</span>
    <span>response</span><span>.</span><span>headers</span><span>.</span><span>set</span><span>(</span><span>&#39;Content-Disposition&#39;</span><span>,</span> <span>&#39;inline&#39;</span><span>,</span> <span>filename</span><span>=</span><span>&#39;screenshot.jpg&#39;</span><span>)</span>

    <span>return</span> <span>response</span>

<span>if</span> <span>__name__</span> <span>==</span> <span>&#39;__main__&#39;</span><span>:</span>
    <span>try</span><span>:</span>
        <span>app</span><span>.</span><span>run</span><span>(</span><span>host</span><span>=</span><span>&#39;0.0.0.0&#39;</span><span>,</span> <span>port</span><span>=</span><span>8000</span><span>)</span>
    <span>finally</span><span>:</span>
        <span>cap</span><span>.</span><span>release</span><span>()</span></code></pre></figure>

</details>

<p>So this worked great! Except that there was a big problem. That video is running at 5x speed. The shortcut was <em>really</em> slow.</p>

<p>At first we thought this was a problem with downloading the image - but more testing showed that it was the <em>act of setting a new wallpaper photo!</em></p>

<p>You can see this for yourself without a shortcut; if you choose a new photo, there’s this delay - I assume that it’s some kind of processing to make the photo look nice, choose the text color of your icons, etc - before you can actually save it. And that delay is around 5 seconds.</p>


<p>those delays add up in a game!</p>

<p>So this approach gave us dynamic lockscreen content, but we were limited to 1 frame every 5 seconds. That didn’t seem workable. But during our debugging process we had a different idea…</p>

<h2 id="what-if-we-just-ran-it-from-the-photos-app">What if we just ran it from the photos app?</h2>
<p>At some point while testing, we removed the logic to set new wallpaper photos (to check how quickly we could download images). And that was <em>fast</em> - the images flew into the photos app.</p>

<p>So we came up with a new plan - what if we ran our animations inside the iOS photos app itself?</p>

<p>Just downloading the images to the app wouldn’t work - you’d still see old images so it wouldn’t be much of an animation - but Adnan came up with the following plan:</p>
<ul>
  <li>Open up / maximize the first image</li>
  <li>Download the next image</li>
  <li>Delete the image that you were looking at</li>
</ul>

<p>This way you’d get more of an animation effect. And this…kinda works! iOS plays an effect when showing you the new image - it kinda slides in - which is pretty disorienting (we tried to disable this by reducing animations, to no success). But it seemed promising enough to be worth pursuing.</p>

<div>
<video poster="/assets/images/doom-ios/streaming-photos-firstframe.png" src="/assets/images/doom-ios/streaming-photos.mp4" playsinline="" muted="" controls=""></video>
<p><img src="http://eieio.games/assets/images/doom-ios/streaming-photos-code.png"/>
</p></div>
<p>says something about the project that this was &#34;promising&#34;</p>

<p>The animations here are pretty disorienting - not ideal! But we wanted to see what they’d look like with a real game. We chose DOOM, since running DOOM in funny places is a meme. We hatched a plan.</p>

<h2 id="running-doom-part-1">Running DOOM, part 1</h2>
<p>To run DOOM we needed…</p>

<ol>
  <li>A running version of DOOM, somewhere, that we could control</li>
  <li>A way to control that version of DOOM from the photos app.</li>
</ol>

<p>I tackled problem 1 and Adnan tackled problem 2<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" rel="footnote">1</a></sup>. Problem 1 wasn’t too bad - I found <a href="https://dosgames.club/shooter/doom.html">a version of DOOM</a> that was playable in the browser, and set up my laptop as a command and control server. You could send it a command (like “move forward” or “shoot”) and it would send the relevant keypress to the game and return an image from the game.</p>

<p>Adnan came up with the brilliant idea of abusing the <a href="https://support.apple.com/en-us/111794">AssistiveTouch</a> feature on the phone to let us send commands from the photos app. The idea behind Assistive Touch is that you get a gamepad-like display that’s always on your screen that you can customize with different commands. This is really handy if your home screen button is broken but your screen works (you can use your screen to send the “Home” command) - or if you need various commands in easy reach (maybe for accessibility reasons).</p>

<p>AssistiveTouch gives you an 8-command pallet and the pallet can contain shortcuts. So we created 8 shortcuts mapped to 8 important DOOM commands - <code>left/right/forward/back/strafe-left/strafe-right/reload/shoot</code> - and hooked them up to endpoints in my command and control server.</p>

<p>So our shortcut code ended up looking very similar to our animation code. And our server code looks something like this:</p>

<details>
    <summary>server code</summary>
    
<figure><pre><code data-lang="python"><span>from</span> <span>flask</span> <span>import</span> <span>Flask</span><span>,</span> <span>Response</span>
<span>from</span> <span>PIL</span> <span>import</span> <span>Image</span>
<span>import</span> <span>pyautogui</span>
<span>import</span> <span>io</span>
<span>import</span> <span>time</span>
<span>import</span> <span>mss</span>
<span>import</span> <span>mss.tools</span>

<span>app</span> <span>=</span> <span>Flask</span><span>(</span><span>__name__</span><span>)</span>

<span>def</span> <span>do_screenshot</span><span>(</span><span>override</span><span>=</span><span>None</span><span>):</span>
    <span>divisor</span> <span>=</span> <span>2</span>

    <span># Hardcoded coordinates of the DOOM window on nolen&#39;s laptop
</span>    <span>left</span> <span>=</span> <span>742</span> <span>/</span> <span>divisor</span>
    <span>top</span> <span>=</span> <span>734</span> <span>/</span> <span>divisor</span>
    <span>width</span> <span>=</span> <span>1540</span> <span>/</span> <span>divisor</span>
    <span>height</span> <span>=</span> <span>960</span> <span>/</span> <span>divisor</span>
    <span>right</span> <span>=</span> <span>left</span> <span>+</span> <span>width</span>
    <span>bottom</span> <span>=</span> <span>top</span> <span>+</span> <span>height</span>

    <span>with</span> <span>mss</span><span>.</span><span>mss</span><span>()</span> <span>as</span> <span>sct</span><span>:</span>
        <span>region</span> <span>=</span> <span>{</span> <span>&#34;top&#34;</span><span>:</span> <span>top</span><span>,</span> <span>&#34;left&#34;</span><span>:</span> <span>left</span><span>,</span> <span>&#34;width&#34;</span><span>:</span> <span>width</span><span>,</span> <span>&#34;height&#34;</span><span>:</span> <span>height</span> <span>}</span>
        <span>sct_img</span> <span>=</span> <span>sct</span><span>.</span><span>grab</span><span>(</span><span>region</span><span>)</span>
        <span>img</span> <span>=</span> <span>Image</span><span>.</span><span>frombytes</span><span>(</span><span>&#39;RGB&#39;</span><span>,</span> <span>(</span><span>sct_img</span><span>.</span><span>width</span><span>,</span> <span>sct_img</span><span>.</span><span>height</span><span>),</span> <span>sct_img</span><span>.</span><span>rgb</span><span>)</span>
        <span>return</span> <span>img</span>

<span>def</span> <span>send_command_while_recording</span><span>(</span><span>keys</span><span>):</span>
    <span>for</span> <span>key</span> <span>in</span> <span>keys</span><span>:</span>
        <span>pyautogui</span><span>.</span><span>keyDown</span><span>(</span><span>key</span><span>)</span>

    <span># We need this for things like forward/back, since otherwise the key is only registered for like
</span>    <span># a millisecond and you barely move
</span>    <span>time</span><span>.</span><span>sleep</span><span>(</span><span>0.10</span><span>)</span>
    <span>frame</span> <span>=</span> <span>do_screenshot</span><span>()</span>

    <span>for</span> <span>key</span> <span>in</span> <span>keys</span><span>:</span>
        <span>pyautogui</span><span>.</span><span>keyUp</span><span>(</span><span>key</span><span>)</span>

    <span>img_io</span> <span>=</span> <span>io</span><span>.</span><span>BytesIO</span><span>()</span>
    <span>frame</span><span>.</span><span>save</span><span>(</span><span>img_io</span><span>,</span> <span>format</span><span>=</span><span>&#39;PNG&#39;</span><span>)</span>
    <span>img_io</span><span>.</span><span>seek</span><span>(</span><span>0</span><span>)</span>

    <span>response</span> <span>=</span> <span>Response</span><span>(</span><span>img_io</span><span>.</span><span>getvalue</span><span>(),</span> <span>mimetype</span><span>=</span><span>&#39;image/png&#39;</span><span>)</span>
    <span>response</span><span>.</span><span>headers</span><span>.</span><span>set</span><span>(</span><span>&#39;Content-Disposition&#39;</span><span>,</span> <span>&#39;inline&#39;</span><span>,</span> <span>filename</span><span>=</span><span>&#39;screenshot.png&#39;</span><span>)</span>

    <span>return</span> <span>response</span>

<span>@</span><span>app</span><span>.</span><span>route</span><span>(</span><span>&#39;/forward&#39;</span><span>,</span> <span>methods</span><span>=</span><span>[</span><span>&#39;GET&#39;</span><span>])</span>
<span>def</span> <span>press_up</span><span>():</span>
    <span>return</span> <span>send_command_while_recording</span><span>([</span><span>&#34;up&#34;</span><span>])</span>

<span>@</span><span>app</span><span>.</span><span>route</span><span>(</span><span>&#39;/backward&#39;</span><span>,</span> <span>methods</span><span>=</span><span>[</span><span>&#39;GET&#39;</span><span>])</span>
<span>def</span> <span>press_down</span><span>():</span>
    <span>return</span> <span>send_command_while_recording</span><span>([</span><span>&#34;down&#34;</span><span>])</span>

<span>@</span><span>app</span><span>.</span><span>route</span><span>(</span><span>&#39;/fire&#39;</span><span>,</span> <span>methods</span><span>=</span><span>[</span><span>&#39;GET&#39;</span><span>])</span>
<span>def</span> <span>fire</span><span>():</span>
    <span>return</span> <span>send_command_while_recording</span><span>([</span><span>&#34;ctrl&#34;</span><span>])</span>

<span>#
# Imagine routes for all the relevant keys...
#
</span>
<span>if</span> <span>__name__</span> <span>==</span> <span>&#39;__main__&#39;</span><span>:</span>
    <span>try</span><span>:</span>
        <span>app</span><span>.</span><span>run</span><span>(</span><span>host</span><span>=</span><span>&#39;0.0.0.0&#39;</span><span>,</span> <span>port</span><span>=</span><span>8000</span><span>)</span>
    <span>finally</span><span>:</span>
        <span># Release the video stream when the webserver is stopped
</span>        <span>cap</span><span>.</span><span>release</span><span>()</span>
        </code></pre></figure>

        </details>


<p>menu selection!!</p>

<p>This was pretty exciting! We had wired DOOM up to the photos app. But our framerate was pretty bad.</p>

<p>We tried extending our code to download multiple images, but the animation that played every time a new image displayed got <em>very</em> disorienting. Which lead us to…</p>

<h2 id="running-doom-part-2">Running DOOM, part 2</h2>

<p>We wanted to increase our framerate and decrease the frequency at which we downloaded new images (to see fewer animations when new images were displayed). What if we <em>downloaded gifs?</em></p>

<p>We extended the code to take multiple screenshots of the game while it held down the relevant keys and to combine those screenshots into a gif before returning the image. There’s a bit of tricky stuff here - we want to make sure the length of our gif tracks with how long we held down the keys, to avoid returning a looping gif, and to keep track of the last frame of the prior gif and to use that for the first frame of the current one for continuity - but it wasn’t much more code than we already had.</p>

<details>
    <summary>Extended code</summary>
    
<figure><pre><code data-lang="python"><span>from</span> <span>flask</span> <span>import</span> <span>Flask</span><span>,</span> <span>Response</span>
<span>from</span> <span>PIL</span> <span>import</span> <span>Image</span>
<span>import</span> <span>pyautogui</span>
<span>import</span> <span>imageio</span>
<span>import</span> <span>io</span>
<span>import</span> <span>time</span>
<span>import</span> <span>mss</span>
<span>import</span> <span>mss.tools</span>

<span>app</span> <span>=</span> <span>Flask</span><span>(</span><span>__name__</span><span>)</span>

<span>def</span> <span>do_screenshot</span><span>(</span><span>override</span><span>=</span><span>None</span><span>):</span>
    <span>divisor</span> <span>=</span> <span>1</span>

    <span># Hardcoded coordinates of the DOOM window on nolen&#39;s laptop
</span>    <span>left</span> <span>=</span> <span>742</span> <span>/</span> <span>divisor</span>
    <span>top</span> <span>=</span> <span>734</span> <span>/</span> <span>divisor</span>
    <span>width</span> <span>=</span> <span>1540</span> <span>/</span> <span>divisor</span>
    <span>height</span> <span>=</span> <span>960</span> <span>/</span> <span>divisor</span>
    <span>right</span> <span>=</span> <span>left</span> <span>+</span> <span>width</span>
    <span>bottom</span> <span>=</span> <span>top</span> <span>+</span> <span>height</span>

    <span>screenshot</span> <span>=</span> <span>pyautogui</span><span>.</span><span>screenshot</span><span>()</span>
    <span>cropped_image</span> <span>=</span> <span>screenshot</span><span>.</span><span>crop</span><span>((</span><span>left</span><span>,</span> <span>top</span><span>,</span> <span>right</span><span>,</span> <span>bottom</span><span>))</span>
    <span>cropped_image</span> <span>=</span> <span>cropped_image</span><span>.</span><span>resize</span><span>((</span><span>cropped_image</span><span>.</span><span>width</span> <span>//</span> <span>2</span><span>,</span> <span>cropped_image</span><span>.</span><span>height</span> <span>//</span> <span>2</span><span>))</span>
    <span>return</span> <span>cropped_image</span>

<span># Use the last image of our last screenshot as the first image of our new one
# (for continuity)
</span><span>OLD_SCREENSHOT</span> <span>=</span> <span>[</span><span>None</span><span>]</span>
<span>def</span> <span>send_command_while_recording</span><span>(</span><span>keys</span><span>,</span> <span>delay</span><span>=</span><span>0.015</span><span>,</span> <span>num_frames</span><span>=</span><span>3</span><span>):</span>
    <span>start_time</span> <span>=</span> <span>time</span><span>.</span><span>time</span><span>()</span>
    <span>frames</span> <span>=</span> <span>[</span><span>x</span> <span>for</span> <span>x</span> <span>in</span> <span>OLD_SCREENSHOT</span> <span>if</span> <span>x</span> <span>is</span> <span>not</span> <span>None</span><span>]</span>
    <span>if</span> <span>not</span> <span>frames</span><span>:</span>
        <span>frames</span><span>.</span><span>append</span><span>(</span><span>do_screenshot</span><span>())</span>

    <span>for</span> <span>key</span> <span>in</span> <span>keys</span><span>:</span>
        <span>pyautogui</span><span>.</span><span>keyDown</span><span>(</span><span>key</span><span>)</span>

    <span>for</span> <span>_</span> <span>in</span> <span>range</span><span>(</span><span>num_frames</span><span>):</span>
        <span>s</span> <span>=</span> <span>do_screenshot</span><span>()</span>
        <span># We need this for things like forward/back, since otherwise the key is only registered for like
</span>        <span># a millisecond and you barely move
</span>        <span>time</span><span>.</span><span>sleep</span><span>(</span><span>delay</span><span>)</span>
        <span>frames</span><span>.</span><span>append</span><span>(</span><span>s</span><span>)</span>

    <span>for</span> <span>key</span> <span>in</span> <span>keys</span><span>:</span>
        <span>pyautogui</span><span>.</span><span>keyUp</span><span>(</span><span>key</span><span>)</span>

    <span>time</span><span>.</span><span>sleep</span><span>(</span><span>delay</span> <span>/</span> <span>2</span><span>)</span>
    <span>frames</span><span>.</span><span>append</span><span>(</span><span>do_screenshot</span><span>())</span>
    <span>OLD_SCREENSHOT</span><span>[</span><span>0</span><span>]</span> <span>=</span> <span>frames</span><span>[</span><span>-</span><span>1</span><span>]</span>

    <span>end_time</span> <span>=</span> <span>time</span><span>.</span><span>time</span><span>()</span>
    <span>total_time</span> <span>=</span> <span>end_time</span> <span>-</span> <span>start_time</span>
    <span>duration</span> <span>=</span> <span>max</span><span>(</span><span>0.1</span><span>,</span> <span>total_time</span> <span>/</span> <span>len</span><span>(</span><span>frames</span><span>))</span> <span>*</span> <span>1000</span>

    <span>img_io</span> <span>=</span> <span>io</span><span>.</span><span>BytesIO</span><span>()</span>
    <span>with</span> <span>imageio</span><span>.</span><span>get_writer</span><span>(</span><span>img_io</span><span>,</span> <span>format</span><span>=</span><span>&#39;GIF&#39;</span><span>,</span> <span>mode</span><span>=</span><span>&#39;I&#39;</span><span>,</span> <span>duration</span><span>=</span><span>duration</span><span>)</span> <span>as</span> <span>writer</span><span>:</span>
        <span>for</span> <span>frame</span> <span>in</span> <span>frames</span><span>:</span>
            <span># Convert PIL image to numpy array by saving it to a BytesIO object first
</span>            <span>byte_io</span> <span>=</span> <span>io</span><span>.</span><span>BytesIO</span><span>()</span>
            <span>frame</span><span>.</span><span>save</span><span>(</span><span>byte_io</span><span>,</span> <span>format</span><span>=</span><span>&#39;PNG&#39;</span><span>)</span>
            <span>byte_io</span><span>.</span><span>seek</span><span>(</span><span>0</span><span>)</span>
            <span>writer</span><span>.</span><span>append_data</span><span>(</span><span>imageio</span><span>.</span><span>imread</span><span>(</span><span>byte_io</span><span>))</span>
        
    <span>img_io</span><span>.</span><span>seek</span><span>(</span><span>0</span><span>)</span>
    <span>response</span> <span>=</span> <span>Response</span><span>(</span><span>img_io</span><span>.</span><span>getvalue</span><span>(),</span> <span>mimetype</span><span>=</span><span>&#39;image/gif&#39;</span><span>)</span>
    <span>response</span><span>.</span><span>headers</span><span>.</span><span>set</span><span>(</span><span>&#39;Content-Disposition&#39;</span><span>,</span> <span>&#39;inline&#39;</span><span>,</span> <span>filename</span><span>=</span><span>&#39;screenshot.gif&#39;</span><span>)</span>
    <span>return</span> <span>response</span>

<span>@</span><span>app</span><span>.</span><span>route</span><span>(</span><span>&#39;/forward&#39;</span><span>,</span> <span>methods</span><span>=</span><span>[</span><span>&#39;GET&#39;</span><span>])</span>
<span>def</span> <span>press_up</span><span>():</span>
    <span>return</span> <span>send_command_while_recording</span><span>([</span><span>&#34;up&#34;</span><span>])</span>

<span>@</span><span>app</span><span>.</span><span>route</span><span>(</span><span>&#39;/backward&#39;</span><span>,</span> <span>methods</span><span>=</span><span>[</span><span>&#39;GET&#39;</span><span>])</span>
<span>def</span> <span>press_down</span><span>():</span>
    <span>return</span> <span>send_command_while_recording</span><span>([</span><span>&#34;down&#34;</span><span>])</span>

<span>@</span><span>app</span><span>.</span><span>route</span><span>(</span><span>&#39;/fire&#39;</span><span>,</span> <span>methods</span><span>=</span><span>[</span><span>&#39;GET&#39;</span><span>])</span>
<span>def</span> <span>fire</span><span>():</span>
    <span>return</span> <span>send_command_while_recording</span><span>([</span><span>&#34;ctrl&#34;</span><span>])</span>

<span>#
# Imagine routes for all the relevant keys...
#
</span>
<span>if</span> <span>__name__</span> <span>==</span> <span>&#39;__main__&#39;</span><span>:</span>
    <span>try</span><span>:</span>
        <span>app</span><span>.</span><span>run</span><span>(</span><span>host</span><span>=</span><span>&#39;0.0.0.0&#39;</span><span>,</span> <span>port</span><span>=</span><span>8000</span><span>)</span>
    <span>finally</span><span>:</span>
        <span># Release the video stream when the webserver is stopped
</span>        <span>cap</span><span>.</span><span>release</span><span>()</span></code></pre></figure>

</details>


<p>very playable</p>

<p>This was the first thing that seemed moderately playable. We’re moving around in the game! It’s feasible to navigate (kind of)!</p>

<p>The biggest problem at this point was the delay. We’re holding down our keys for a bit (because if you only hold down “up” for .01 seconds, the character doesn’t move very far) so there’s some built-in delay before we can return the gif at all. But we were doing two things that contributed to slowing things down even more:</p>
<ol>
  <li>We were using pyautogui for screenshotting, and <a href="https://stackoverflow.com/questions/48144210/speeding-up-pyautogui-screenshot-with-region">pyautogui’s screenshotting code is really slow</a></li>
  <li>We were creating gifs, which are kinda slow to create (our profiling told us it took 0.4 seconds, which is pretty long)</li>
</ol>

<p>We went down a <em>deep</em> rabbit hole solving problem 1. The stack overflow question I linked proposes a solution - use a different screenshot library - but for some reason gifs created using that library didn’t work! They played fine on my laptop, but would not scan as gifs in iOS. It was a nightmare of a problem to debug - what are your search terms here? - and we started to give up hope.</p>

<p>But solving problem 2 gave us a solution. We thought mp4s might be faster to create than gifs, so we tried swapping out our implementation to create mp4s instead - and it was <em>4 times faster</em>. And mp4s created from our much faster screenshot code worked just fine.</p>

<p>We swapped out our code to create mp4s with a faster screenshot utility and cut out the vast majority of our delay (outside of the built in delay while we held down keys on the server, which we couldn’t do much about<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" rel="footnote">2</a></sup>).</p>

<p>This got us very close to our end state:</p>

<p>almost there - but there&#39;s a big flaw</p>

<p>This <em>almost worked</em>. Video creation was substantially faster, and having faster screenshots meant we could experiment with upping our framerate. But there was a huge problem.</p>

<p>When we created gifs, we specified that they never looped. The photos app would respect that and would leave the gifs on their <em>last</em> frame, which made it easy to provide continuity between images. With videos the photos app would instead jump back to the <em>first</em> frame of the video when it finished playing. This is probably good UX in general, but it was a big problem for us - it made the whole experience super confusing!</p>

<p>It took us a while but we eventually hit on a delightfully stupid solution - we extended the video with several seconds of padding using the video’s final frame - so as long as you’re sending new commands reasonably quickly, you never see the end of the video (and it never loops back to the start).</p>

<p>This padding would have been a pain with gifs (they’d get big), but mp4s compress things well so adding a hundred of the same frame at the end was pretty cheap (this did add a little time, but it was still substantially faster than gifs).</p>

<p>That basically gave us our final product, which looked like this (I’ve gone ahead and added bindings for additional commands like shooting).</p>

<details>
<summary>final code</summary>

<figure><pre><code data-lang="python"><span>from</span> <span>flask</span> <span>import</span> <span>Flask</span><span>,</span> <span>Response</span>
<span>from</span> <span>PIL</span> <span>import</span> <span>Image</span>
<span>import</span> <span>pyautogui</span>
<span>import</span> <span>imageio</span>
<span>import</span> <span>io</span>
<span>import</span> <span>time</span>
<span>import</span> <span>mss</span>
<span>import</span> <span>mss.tools</span>
<span>import</span> <span>numpy</span> <span>as</span> <span>np</span>

<span>app</span> <span>=</span> <span>Flask</span><span>(</span><span>__name__</span><span>)</span>

<span>def</span> <span>do_screenshot</span><span>(</span><span>use_pyautogui</span><span>=</span><span>False</span><span>):</span>
    <span>divisor</span> <span>=</span> <span>2</span>

    <span># Hardcoded coordinates of the DOOM window on nolen&#39;s laptop
</span>    <span>left</span> <span>=</span> <span>742</span> <span>/</span> <span>divisor</span>
    <span>top</span> <span>=</span> <span>734</span> <span>/</span> <span>divisor</span>
    <span>width</span> <span>=</span> <span>1540</span> <span>/</span> <span>divisor</span>
    <span>height</span> <span>=</span> <span>960</span> <span>/</span> <span>divisor</span>
    <span>right</span> <span>=</span> <span>left</span> <span>+</span> <span>width</span>
    <span>bottom</span> <span>=</span> <span>top</span> <span>+</span> <span>height</span>

    <span>if</span> <span>use_pyautogui</span><span>:</span>
        <span>screenshot</span> <span>=</span> <span>pyautogui</span><span>.</span><span>screenshot</span><span>()</span>
        <span>cropped_image</span> <span>=</span> <span>screenshot</span><span>.</span><span>crop</span><span>((</span><span>left</span><span>,</span> <span>top</span><span>,</span> <span>right</span><span>,</span> <span>bottom</span><span>))</span>
        <span>cropped_image</span> <span>=</span> <span>cropped_image</span><span>.</span><span>resize</span><span>((</span><span>cropped_image</span><span>.</span><span>width</span> <span>//</span> <span>2</span><span>,</span> <span>cropped_image</span><span>.</span><span>height</span> <span>//</span> <span>2</span><span>))</span>
        <span>return</span> <span>cropped_image</span>
    <span>else</span><span>:</span>
        <span>with</span> <span>mss</span><span>.</span><span>mss</span><span>()</span> <span>as</span> <span>sct</span><span>:</span>
            <span>region</span> <span>=</span> <span>{</span> <span>&#34;top&#34;</span><span>:</span> <span>top</span><span>,</span> <span>&#34;left&#34;</span><span>:</span> <span>left</span><span>,</span> <span>&#34;width&#34;</span><span>:</span> <span>width</span><span>,</span> <span>&#34;height&#34;</span><span>:</span> <span>height</span> <span>}</span>
            <span>sct_img</span> <span>=</span> <span>sct</span><span>.</span><span>grab</span><span>(</span><span>region</span><span>)</span>
            <span>img</span> <span>=</span> <span>Image</span><span>.</span><span>frombytes</span><span>(</span><span>&#39;RGB&#39;</span><span>,</span> <span>(</span><span>sct_img</span><span>.</span><span>width</span><span>,</span> <span>sct_img</span><span>.</span><span>height</span><span>),</span> <span>sct_img</span><span>.</span><span>rgb</span><span>)</span>
            <span>return</span> <span>img</span>

<span># Use the last image of our last screenshot as the first image of our new one
# (for continuity)
</span><span>OLD_SCREENSHOT</span> <span>=</span> <span>[</span><span>None</span><span>]</span>
<span>def</span> <span>send_command_while_recording</span><span>(</span><span>keys</span><span>,</span> <span>delay</span><span>=</span><span>0.015</span><span>,</span> <span>num_frames</span><span>=</span><span>6</span><span>):</span>
    <span>start_time</span> <span>=</span> <span>time</span><span>.</span><span>time</span><span>()</span>
    <span>frames</span> <span>=</span> <span>[</span><span>x</span> <span>for</span> <span>x</span> <span>in</span> <span>OLD_SCREENSHOT</span> <span>if</span> <span>x</span> <span>is</span> <span>not</span> <span>None</span><span>]</span>
    <span>if</span> <span>not</span> <span>frames</span><span>:</span>
        <span>frames</span><span>.</span><span>append</span><span>(</span><span>do_screenshot</span><span>())</span>

    <span>for</span> <span>key</span> <span>in</span> <span>keys</span><span>:</span>
        <span>pyautogui</span><span>.</span><span>keyDown</span><span>(</span><span>key</span><span>)</span>

    <span>for</span> <span>_</span> <span>in</span> <span>range</span><span>(</span><span>num_frames</span><span>):</span>
        <span>s</span> <span>=</span> <span>do_screenshot</span><span>()</span>
        <span># We need this for things like forward/back, since otherwise the key is only registered for like
</span>        <span># a millisecond and you barely move
</span>        <span>time</span><span>.</span><span>sleep</span><span>(</span><span>delay</span><span>)</span>
        <span>frames</span><span>.</span><span>append</span><span>(</span><span>s</span><span>)</span>

    <span>for</span> <span>key</span> <span>in</span> <span>keys</span><span>:</span>
        <span>pyautogui</span><span>.</span><span>keyUp</span><span>(</span><span>key</span><span>)</span>

    <span>frames</span><span>.</span><span>append</span><span>(</span><span>do_screenshot</span><span>())</span>
    <span>OLD_SCREENSHOT</span><span>[</span><span>0</span><span>]</span> <span>=</span> <span>frames</span><span>[</span><span>-</span><span>1</span><span>]</span>

    <span>end_time</span> <span>=</span> <span>time</span><span>.</span><span>time</span><span>()</span>
    <span>total_time</span> <span>=</span> <span>end_time</span> <span>-</span> <span>start_time</span>
    <span>duration</span> <span>=</span> <span>total_time</span> <span>/</span> <span>len</span><span>(</span><span>frames</span><span>)</span>
    <span>fps</span> <span>=</span> <span>1</span><span>/</span> <span>duration</span>

    <span>video_io</span> <span>=</span> <span>io</span><span>.</span><span>BytesIO</span><span>()</span>
    <span>with</span> <span>imageio</span><span>.</span><span>get_writer</span><span>(</span><span>video_io</span><span>,</span> <span>format</span><span>=</span><span>&#39;mp4&#39;</span><span>,</span> <span>fps</span><span>=</span><span>fps</span><span>)</span> <span>as</span> <span>writer</span><span>:</span>
        <span>for</span> <span>i</span><span>,</span> <span>frame</span> <span>in</span> <span>enumerate</span><span>(</span><span>frames</span><span>):</span>
            <span>writer</span><span>.</span><span>append_data</span><span>(</span><span>np</span><span>.</span><span>array</span><span>(</span><span>frame</span><span>))</span>

        <span>for</span> <span>_</span> <span>in</span> <span>range</span><span>(</span><span>50</span><span>):</span>
            <span>writer</span><span>.</span><span>append_data</span><span>(</span><span>np</span><span>.</span><span>array</span><span>(</span><span>frames</span><span>[</span><span>-</span><span>1</span><span>]))</span>

    <span>video_io</span><span>.</span><span>seek</span><span>(</span><span>0</span><span>)</span>
    <span>response</span> <span>=</span> <span>Response</span><span>(</span><span>video_io</span><span>.</span><span>getvalue</span><span>(),</span> <span>mimetype</span><span>=</span><span>&#39;video/mp4&#39;</span><span>)</span>
    <span>response</span><span>.</span><span>headers</span><span>.</span><span>set</span><span>(</span><span>&#34;Content-Type&#34;</span><span>,</span> <span>&#34;video/mp4&#34;</span><span>)</span>
    <span>response</span><span>.</span><span>headers</span><span>.</span><span>set</span><span>(</span><span>&#39;Content-Disposition&#39;</span><span>,</span> <span>&#39;attachment&#39;</span><span>,</span> <span>filename</span><span>=</span><span>&#39;screenshot.mp4&#39;</span><span>)</span>
    <span>return</span> <span>response</span>

<span>@</span><span>app</span><span>.</span><span>route</span><span>(</span><span>&#39;/forward&#39;</span><span>,</span> <span>methods</span><span>=</span><span>[</span><span>&#39;GET&#39;</span><span>])</span>
<span>def</span> <span>press_up</span><span>():</span>
    <span>return</span> <span>send_command_while_recording</span><span>([</span><span>&#34;up&#34;</span><span>])</span>

<span>@</span><span>app</span><span>.</span><span>route</span><span>(</span><span>&#39;/backward&#39;</span><span>,</span> <span>methods</span><span>=</span><span>[</span><span>&#39;GET&#39;</span><span>])</span>
<span>def</span> <span>press_down</span><span>():</span>
    <span>return</span> <span>send_command_while_recording</span><span>([</span><span>&#34;down&#34;</span><span>])</span>

<span>@</span><span>app</span><span>.</span><span>route</span><span>(</span><span>&#39;/fire&#39;</span><span>,</span> <span>methods</span><span>=</span><span>[</span><span>&#39;GET&#39;</span><span>])</span>
<span>def</span> <span>fire</span><span>():</span>
    <span>return</span> <span>send_command_while_recording</span><span>([</span><span>&#34;ctrl&#34;</span><span>])</span>

<span>@</span><span>app</span><span>.</span><span>route</span><span>(</span><span>&#39;/left&#39;</span><span>,</span> <span>methods</span><span>=</span><span>[</span><span>&#39;GET&#39;</span><span>])</span>
<span>def</span> <span>press_left</span><span>():</span>
    <span>return</span> <span>send_command_while_recording</span><span>([</span><span>&#34;left&#34;</span><span>])</span>

<span>@</span><span>app</span><span>.</span><span>route</span><span>(</span><span>&#39;/right&#39;</span><span>,</span> <span>methods</span><span>=</span><span>[</span><span>&#39;GET&#39;</span><span>])</span>
<span>def</span> <span>press_right</span><span>():</span>
    <span>return</span> <span>send_command_while_recording</span><span>([</span><span>&#34;right&#34;</span><span>])</span>

<span>@</span><span>app</span><span>.</span><span>route</span><span>(</span><span>&#39;/strafeLeft&#39;</span><span>,</span> <span>methods</span><span>=</span><span>[</span><span>&#39;GET&#39;</span><span>])</span>
<span>def</span> <span>strafe_left</span><span>():</span>
    <span>return</span> <span>send_command_while_recording</span><span>([</span><span>&#34;alt&#34;</span><span>,</span> <span>&#34;left&#34;</span><span>])</span>

<span>@</span><span>app</span><span>.</span><span>route</span><span>(</span><span>&#39;/strafeRight&#39;</span><span>,</span> <span>methods</span><span>=</span><span>[</span><span>&#39;GET&#39;</span><span>])</span>
<span>def</span> <span>strafe_right</span><span>():</span>
    <span>return</span> <span>send_command_while_recording</span><span>([</span><span>&#34;alt&#34;</span><span>,</span> <span>&#34;right&#34;</span><span>])</span>

<span>@</span><span>app</span><span>.</span><span>route</span><span>(</span><span>&#39;/use&#39;</span><span>,</span> <span>methods</span><span>=</span><span>[</span><span>&#39;GET&#39;</span><span>])</span>
<span>def</span> <span>use</span><span>():</span>
    <span>return</span> <span>send_command_while_recording</span><span>([</span><span>&#34;space&#34;</span><span>,</span> <span>&#34;enter&#34;</span><span>])</span>

<span>if</span> <span>__name__</span> <span>==</span> <span>&#39;__main__&#39;</span><span>:</span>
    <span>try</span><span>:</span>
        <span>app</span><span>.</span><span>run</span><span>(</span><span>host</span><span>=</span><span>&#39;0.0.0.0&#39;</span><span>,</span> <span>port</span><span>=</span><span>8000</span><span>)</span>
    <span>finally</span><span>:</span>
        <span># Release the video stream when the webserver is stopped
</span>        <span>cap</span><span>.</span><span>release</span><span>()</span></code></pre></figure>

</details>


<p>i didn&#39;t notice the white border on the video till just now :(</p>

<h2 id="closing-it-out">Closing it out</h2>
<p>Adnan closed things out by adding some finishing touches - he created an icon with the DOOM logo that started up music from the soundtrack, navigated to you the photos app, and downloaded a still image (we need to makes sure there’s a still image available for you to open at the start since we rely on <em>deleting</em> images to advance you to the next video). And then we…sat on this project for 3 months. Oops.</p>

<p>But working on it was a ton of fun! It’s rare that I work with someone else on a project right now; it was delightful to get to work with Adnan (maybe <a href="https://adnanaga.com/">hire him??</a>). And working with shortcuts was painful in the most fun way - one of my favorite things about making games like this is how stupid your problems end up being<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" rel="footnote">3</a></sup>.</p>

<p>I’m not sure this has totally scratched my itch for silly iOS things - doing this project gave me too many ideas! And I wish we had found a way to stream in the videos even more quickly to make the game feel more realtime. But I’m proud of what we ended up with here.</p>

<p>Thanks for reading! I’m working on a blog and video about the approach I take to silly projects like this; I’ll be back soon with more stuff :)</p>



    </div></div>
  </body>
</html>
