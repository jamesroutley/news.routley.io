<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://op-co.de/blog/posts/samsung_nx_mastodon/">Original</a>
    <h1>Samsung&#39;s abandoned NX cameras can be brought online with a $20 LTE stick</h1>
    
    <div id="readability-page-1" class="page"><div class="page">









<div id="pagebody">

<div id="content" role="main">
<p><span>Georg Lukas, <span>2024-07-05 18:46</span></span></p>
<p>From 2009 to 2014, Samsung released dozens of
<a href="https://op-co.de/blog/posts/samsung_wifi_cameras/">camera models and even some camcorders with built-in WiFi</a>
and a feature to upload photos and videos to social media, using Samsung&#39;s
Social Network Services (SNS). That service was discontinued in 2021, leaving
the cameras disconnected.</p>

<p>We are bringing a reverse-engineered API implementation of the SNS to a
<a href="https://hackaday.com/2022/08/03/hackable-20-modem-combines-lte-and-pi-zero-w2-power/">20$ LTE modem stick</a>
in order to email or publish our photos to Mastodon on the go.</p>

<p><img src="https://op-co.de/blog/posts/samsung_nx_mastodon/camera-modem.jpg" alt="Photo of a Samsung camera upload a photo"/></p>




<h2><a name="index1h2"></a>Social Network Services (SNS) API</h2>

<p>The SNS API is a set of HTTP endpoints consuming and returning XML-like
messages (the sent XML is malformed, and the received data is not
syntax-checked by the <code>strstr()</code> based parser). It is used by
<a href="https://op-co.de/blog/posts/samsung_wifi_cameras/">all Samsung WiFi cameras created between 2011 and 2014</a>,
and allows to proxy-upload photos and
videos to a series of social media services (Facebook, Picasa, Flickr,
YouTube, ...).</p>

<p>It is built on plain-text HTTP, and uses either OAuth or
<a href="https://op-co.de/blog/posts/samsung_nx_cryptofail/">a broken, hand-rolled encryption scheme</a>
to &#34;protect&#34; the user&#39;s social media credentials.</p>

<p>As the original servers have been shutdown, the only way to re-create the API
is to reverse engineer the client code located in various cameras&#39; firmware
(<a href="https://op-co.de/blog/posts/samsung_nx_cryptofail/">NX300</a>,
<a href="https://op-co.de/blog/posts/samsung_wb850f_firmware/">WB850F</a>, HMX-QF30) and
<a href="https://op-co.de/blog/posts/hacking_the_nx300/#index3h3">old packet traces</a>.</p>

<p>Luckily, the lack of HTTPS and the vulnerable encryption mean that we can
easily redirect the camera&#39;s traffic to
<a href="https://github.com/ge0rg/samsung-nx-emailservice">our re-implementation API</a>.
On the other hand, we do not want to force the user to send their credentials
over the insecure channel, and therefore will store them in the API bridge
instead.</p>

<p>The re-implementation is written in Python on top of Flask, and needs to work
around a few protocol-violating bugs on the camera side.</p>

<h2><a name="index2h2"></a>Deployment</h2>

<p>The SNS bridge needs to be reachable by the camera, and we need to
DNS-redirect the original Samsung API hostnames to it. It can be hosted on a
free VPS, but then we still need to do the DNS trickery on the WiFi side.</p>

<p>When on the go, you also need to have a mobile-backed WiFi hotspot.
Unfortunately, redirecting DNS for individual hostnames on stock Android is
<em>hard</em>, you can merely change the DNS server to one under your control. But
then you need to add a VPN tunnel or host a public DNS resolver, and those
will become DDoS reflectors very fast.</p>

<h3><a name="index1h3"></a>The 20$ LTE stick</h3>

<p>Luckily, there is an exciting dongle that will give us all three features: a
configurable WiFi hotspot, an LTE uplink, and enough power to run the
<code>samsung-nx-emailservice</code> right on it:
<a href="https://hackaday.com/2022/08/03/hackable-20-modem-combines-lte-and-pi-zero-w2-power/">Hackable $20 modem combines LTE and PI Zero W2 power</a>.</p>

<p>It also has the bonus of limiting access to the insecure SNS API to the local
WiFi hotspot network.</p>

<h3><a name="index2h3"></a>Initial Configuration</h3>

<p>There is an excellent
<a href="https://web.archive.org/web/20230330113846/https://extrowerk.com/2022/07/31/OpenStick/">step-by-step guide to install Debian</a>
that I will not repeat here.</p>

<p>On some devices, the original ADB-enabling trick does not work, but you can
directly open the unauthenticated
<a href="http://192.168.100.1/usbdebug.html">http://192.168.100.1/usbdebug.html</a> page
in the browser, and within a minute the stick will reboot with ADB enabled.</p>

<p>If you have the hardware revision UZ801 v3.x of the stick, you need to use a
<a href="https://zebra.ddscentral.org/pub/downloads/openstick/firmware/uz801_v30/README">custom kernel + base image</a>.</p>

<p>Please follow the above instructions to complete the Debian installation.
You should be logged in as <code>root@openstick</code> now for the next steps.</p>

<p>The openstick will support <code>adb shell</code>, USB RNDIS and WiFi to access it, but
for the cameras it needs to expose a WiFi hotspot. You can
<a href="https://gist.github.com/narate/d3f001c97e1c981a59f94cd76f041140">create a NetworkManager-based hotspot using nmcli</a>
or by other means as appropriate for you.</p>

<h3><a name="index3h3"></a>Installing <code>samsung-nx-emailservice</code></h3>

<p>We need git, Python 3 and its <code>venv</code> module to get started, install the
source, and patch werkzeug to compensate for Samsung&#39;s broken client
implementation:</p>

<div><pre>apt <span>install</span> <span>--no-install-recommends</span> git python3-venv virtualenv
git clone https<span>://</span>github.com<span>/</span>ge0rg<span>/</span>samsung-nx-emailservice
<span>cd</span> samsung-nx-emailservice
python3 <span>-m</span> venv venv
<span>source</span> .<span>/</span>venv<span>/</span>bin<span>/</span>activate
pip3 <span>install</span> <span>-r</span> requirements.txt
<span># the patch is for python 3.8, we have python 3.9</span>
<span>cd</span> venv<span>/</span>lib<span>/</span>python3.9<span>/</span>
<span>patch</span> <span>-p4</span> <span>&lt;</span> ..<span>/</span>..<span>/</span>..<span>/</span>flask-3.<span>diff</span>
<span>cd</span> <span>-</span>
python3 samsungserver.py
</pre></div>


<p>By default, this will open an HTTP server on port :8080 on all IP addresses of
the openstick. You can verify that by connecting to
<a href="http://192.168.68.1:8080/">http://192.168.68.1:8080/</a> on the USB interface.
You should see this page:</p>

<p><img src="https://op-co.de/blog/posts/samsung_nx_mastodon/screenshot-index.png" alt="Screenshot of the API bridge index page"/></p>

<p>We need to change the port to 80, and ideally we should not expose the service
to the LTE side of things, so we have to obtain the WiFi hotspot&#39;s IP address
using <code>ip addr show wlan0</code>:</p>

<div><pre><span>11</span><span>:</span> wlan0<span>: &lt;</span>BROADCAST<span>,</span>MULTICAST<span>,</span>UP<span>,</span>LOWER_UP<span>&gt;</span> mtu <span>1500</span> qdisc mq state UP group default qlen <span>1000</span>
    link<span>/</span>ether <span>02</span><span>:</span><span>00</span><span>:</span>a1<span>:</span><span>61</span><span>:</span>c7<span>:</span><span>3</span>a brd ff<span>:</span>ff<span>:</span>ff<span>:</span>ff<span>:</span>ff<span>:</span>ff
    inet <span>192.168.79.1</span><span>/</span><span>24</span> brd <span>192.168.79.255</span> scope global noprefixroute wlan0
       valid_lft forever preferred_lft forever
    inet6 fe80<span>::</span>a1ff<span>:</span>fe61<span>:</span>c73a<span>/</span><span>64</span> scope link 
       valid_lft forever preferred_lft forever
</pre></div>


<p>Accordingly, we edit <code>samsungserver.py</code> and change the code at the end of the
file to bind to 192.168.79.1 on port 80:</p>

<div><pre><span>if</span> __name__ <span>==</span> <span>&#39;__main__&#39;</span><span>:</span>
    app<span>.</span><span>run</span><span>(</span>debug <span>=</span> <span>True</span><span>,</span> host<span>=</span><span>&#39;192.168.79.1&#39;</span><span>,</span> port<span>=</span><span>80</span><span>)</span>
</pre></div>


<p>We need to change
<a href="https://github.com/ge0rg/samsung-nx-emailservice/blob/master/config.toml"><code>config.toml</code></a>
and enter our &#34;whitelisted&#34; sender addresses, as well as the email and
Mastodon credentials there. To obtain a Mastodon access token from your
instance, you need to
<a href="https://github.com/ge0rg/samsung-nx-emailservice/blob/master/README.md#mastodon">register a new application</a>.</p>

<h3><a name="index4h3"></a>Automatic startup with systemd</h3>

<p>We also create a systemd service file called <code>samsung-nx-email.service</code> in
<code>/etc/systemd/system/</code> so that the service will be started automatically:</p>

<div><pre><span>[</span>Unit<span>]</span>
Description<span>=</span>Samsung NX API
After<span>=</span>syslog.target network.target

<span>[</span>Service<span>]</span>
Type<span>=</span>simple
WorkingDirectory<span>=/</span>root<span>/</span>samsung-nx-emailservice
ExecStart<span>=/</span>root<span>/</span>samsung-nx-emailservice<span>/</span>venv<span>/</span>bin<span>/</span>python3 <span>/</span>root<span>/</span>samsung-nx-emailservice<span>/</span>samsungserver.py
Restart<span>=</span>on-abort
StandardOutput<span>=</span>journal

<span>[</span>Install<span>]</span>
WantedBy<span>=</span>multi-user.target
</pre></div>


<p>After that, we load, start, and activate it for auto-start:</p>

<div><pre>systemctl daemon-reload
systemctl <span>enable</span> samsung-nx-email.service
systemctl start samsung-nx-email.service
</pre></div>


<p>Using <code>journalctl -fu samsung-nx-email</code> we can verify that everything is
working:</p>

<div><pre>Jul <span>05 10</span><span>:</span><span>01</span><span>:</span><span>38</span> openstick systemd<span>[</span><span>1</span><span>]:</span> Started Samsung NX API.
Jul <span>05 10</span><span>:</span><span>01</span><span>:</span><span>38</span> openstick python3<span>[</span><span>2229382</span><span>]:  *</span> Serving Flask app <span>&#39;samsungserver&#39;</span>
Jul <span>05 10</span><span>:</span><span>01</span><span>:</span><span>38</span> openstick python3<span>[</span><span>2229382</span><span>]:  *</span> Debug mode<span>:</span> on
Jul <span>05 10</span><span>:</span><span>01</span><span>:</span><span>38</span> openstick python3<span>[</span><span>2229382</span><span>]:</span> WARNING<span>:</span> This is a development server. Do not use it <span>in</span> a production deployment. Use a production WSGI server instead.
Jul <span>05 10</span><span>:</span><span>01</span><span>:</span><span>38</span> openstick python3<span>[</span><span>2229382</span><span>]:  *</span> Running on http<span>://</span><span>192.168.79.1</span><span>:</span><span>80</span>
Jul <span>05 10</span><span>:</span><span>01</span><span>:</span><span>38</span> openstick python3<span>[</span><span>2229382</span><span>]:</span> Press CTRL<span>+</span>C to quit
Jul <span>05 10</span><span>:</span><span>01</span><span>:</span><span>38</span> openstick python3<span>[</span><span>2229382</span><span>]:  *</span> Restarting with stat
Jul <span>05 10</span><span>:</span><span>01</span><span>:</span><span>39</span> openstick python3<span>[</span><span>2229388</span><span>]:  *</span> Debugger is active<span>!</span>
Jul <span>05 10</span><span>:</span><span>01</span><span>:</span><span>39</span> openstick python3<span>[</span><span>2229388</span><span>]:  *</span> Debugger PIN<span>:</span> <span>123</span><span>-456-789</span>
</pre></div>


<h3><a name="index5h3"></a>Security warning: this is not secure!</h3>

<blockquote><p>WARNING: This is a development server. [...]</p></blockquote>

<p>Yes, this straight-forward deployment relying on python&#39;s built-in WSGI is not
meant for production, which is why we limit it to our private WiFi.</p>

<p>Furthermore, the API implementation is not performing authentication beyond
checking the address againts the <code>SENDERS</code> variable. Given that transmissions
are in plain-text, enforcing passwords could backfire on the user.</p>

<h3><a name="index6h3"></a>Redirecting DNS</h3>

<p>By default, the Samsung cameras will attempt to connect a few servers via HTTP
to find out if they are on a captive portal hotspot and to interact with the
social media. The full list of hosts can be found in the
<a href="https://github.com/ge0rg/samsung-nx-emailservice/blob/master/README.md#installation">project README</a>.</p>

<p>As we are using NetworkManager for the hotspot, and it uses
<a href="https://thekelleys.org.uk/dnsmasq/doc.html">dnsmasq</a> internally, we can
use dnsmasq&#39;s config syntax and create an additional config file
<code>/etc/NetworkManager/dnsmasq-shared.d/00-samsung-nx.conf</code> that will map all
relevant addresses to the hotspot&#39;s IP address:</p>

<div><pre>address<span>=/</span>snsgw.samsungmobile.com<span>/</span><span>192.168.79.1</span>
address<span>=/</span>gld.samsungosp.com<span>/</span><span>192.168.79.1</span>
address<span>=/</span>www.samsungimaging.com<span>/</span><span>192.168.79.1</span>
address<span>=/</span>www.ospserver.net<span>/</span><span>192.168.79.1</span>
address<span>=/</span>www.yahoo.co.kr<span>/</span><span>192.168.79.1</span>
address<span>=/</span>www.msn.com<span>/</span><span>192.168.79.1</span>
</pre></div>


<p>After a reboot, we should be up and running, and can connect from the camera
to the WiFi hotspot to send our pictures.</p>

<h3><a name="index7h3"></a>Hotspot detection strikes again</h3>

<p>The really old models (ST1000/CL65, SH100) will mis-detect a private IP for
the Samsung service as a captive hotspot portal and give you this cryptic
error message:</p>

<blockquote><p>Certification is needed from the Access Point. Connection cannot be made at
this time. Call ISP for further details</p></blockquote>

<p><img src="https://op-co.de/blog/posts/samsung_nx_mastodon/sh100-certification.jpg" alt="Camera error message: Certification is needed from the Access Point. Connection cannot be made at this time. Call ISP for further details"/></p>

<p>If you see this message, you need to trick the camera to use a non-private IP
address, which is by Samsung&#39;s standard one that doesn&#39;t begin with <code>192.168.</code></p>

<p>You can change the hotspot config in <code>/etc/NetworkManager/system-connections</code>
to use a different <a href="https://datatracker.ietf.org/doc/html/rfc1918">RFC 1918</a>
range from <code>10.0.0.0/8</code> or <code>172.16.0.0/12</code>, or you can band-aid around
the issue by dice-rolling a random IP from those ranges that you don&#39;t need to
access (e.g.  <code>10.23.42.99</code>), to return it from <code>00-samsung-nx.conf</code> and to use
<a href="https://superuser.com/a/661778">iptables</a> to redirect HTTP traffic going to
that address to the local SNS API instead:</p>

<div><pre>iptables <span>-t</span> nat <span>-A</span> PREROUTING <span>-p</span> tcp <span>-d</span> <span>10.23.42.99</span> <span>--dport</span> <span>80</span> <span>-j</span> DNAT <span>--to-destination</span> <span>192.168.79.1</span><span>:</span><span>8080</span>
</pre></div>


<p>This will prevent you from accessing 10.23.42.99 on your ISP&#39;s network via
HTTP, which is probably not a huge loss.</p>

<p>You can persist that rule over reboots by storing it in
<code>/etc/iptables/rules.v4</code>.</p>

<h2><a name="index3h2"></a>Demo</h2>

<p>This is how the finished pipeline looks in practice (the whole sequence is 3
minutes, shortened and accelerated for brevity):</p>



<p>And here&#39;s the resulting post:</p>






</div>









</div>



</div></div>
  </body>
</html>
