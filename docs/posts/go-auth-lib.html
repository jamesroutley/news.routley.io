<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/go-pkgz/auth">Original</a>
    <h1>Go Auth Lib</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto"><a href="https://github.com/go-pkgz/auth/actions"><img src="https://github.com/go-pkgz/auth/workflows/build/badge.svg" alt="Build Status"/></a> <a href="https://coveralls.io/github/go-pkgz/auth?branch=master" rel="nofollow"><img src="https://camo.githubusercontent.com/483d15d5b855c1c49b1059cce6a32d630b76c85128de47ba152c6734692acba8/68747470733a2f2f636f766572616c6c732e696f2f7265706f732f6769746875622f676f2d706b677a2f617574682f62616467652e7376673f6272616e63683d6d6173746572" alt="Coverage Status" data-canonical-src="https://coveralls.io/repos/github/go-pkgz/auth/badge.svg?branch=master"/></a> <a href="https://pkg.go.dev/github.com/go-pkgz/auth?tab=doc" rel="nofollow"><img src="https://camo.githubusercontent.com/b478e9153b4fefca4de44f061468dd15c4e43df8173fa0c5fa1fb601135cb956/68747470733a2f2f676f646f632e6f72672f6769746875622e636f6d2f676f2d706b677a2f617574683f7374617475732e737667" alt="godoc" data-canonical-src="https://godoc.org/github.com/go-pkgz/auth?status.svg"/></a></p>
<p dir="auto">This library provides &#34;social login&#34; with Github, Google, Facebook, Microsoft, Twitter, Yandex, Battle.net, Apple, Patreon and Telegram as well as custom auth providers and email verification.</p>
<ul dir="auto">
<li>Multiple oauth2 providers can be used at the same time</li>
<li>Special <code>dev</code> provider allows local testing and development</li>
<li>JWT stored in a secure cookie with XSRF protection. Cookies can be session-only</li>
<li>Minimal scopes with user name, id and picture (avatar) only</li>
<li>Direct authentication with user&#39;s provided credential checker</li>
<li>Verified authentication with user&#39;s provided sender (email, im, etc)</li>
<li>Custom oauth2 server and ability to use any third party provider</li>
<li>Integrated avatar proxy with an FS, boltdb and gridfs storage</li>
<li>Support of user-defined storage for avatars</li>
<li>Identicon for default avatars</li>
<li>Black list with user-defined validator</li>
<li>Multiple aud (audience) supported</li>
<li>Secure key with customizable <code>SecretReader</code></li>
<li>Ability to store an extra information to token and retrieve on login</li>
<li>Pre-auth and post-auth hooks to handle custom use cases.</li>
<li>Middleware for easy integration into http routers</li>
<li>Wrappers to extract user info from the request</li>
<li>Role based access control</li>
</ul>
<h2 dir="auto"><a id="user-content-install" aria-hidden="true" href="#install"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Install</h2>
<p dir="auto"><code>go get -u github.com/go-pkgz/auth</code></p>
<h2 dir="auto"><a id="user-content-usage" aria-hidden="true" href="#usage"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Usage</h2>
<p dir="auto">Example with chi router:</p>
<div dir="auto" data-snippet-clipboard-copy-content="
func main() {
	// define options
	options := auth.Opts{
		SecretReader: token.SecretFunc(func(id string) (string, error) { // secret key for JWT
			return &#34;secret&#34;, nil
		}),
		TokenDuration:  time.Minute * 5, // token expires in 5 minutes
		CookieDuration: time.Hour * 24,  // cookie expires in 1 day and will enforce re-login
		Issuer:         &#34;my-test-app&#34;,
		URL:            &#34;http://127.0.0.1:8080&#34;,
		AvatarStore:    avatar.NewLocalFS(&#34;/tmp&#34;),
		Validator: token.ValidatorFunc(func(_ string, claims token.Claims) bool {
			// allow only dev_* names
			return claims.User != nil &amp;&amp; strings.HasPrefix(claims.User.Name, &#34;dev_&#34;)
		}),
	}

	// create auth service with providers
	service := auth.NewService(options)
	service.AddProvider(&#34;github&#34;, &#34;&lt;Client ID&gt;&#34;, &#34;&lt;Client Secret&gt;&#34;)   // add github provider
	service.AddProvider(&#34;facebook&#34;, &#34;&lt;Client ID&gt;&#34;, &#34;&lt;Client Secret&gt;&#34;) // add facebook provider

	// retrieve auth middleware
	m := service.Middleware()

	// setup http server
	router := chi.NewRouter()
	router.Get(&#34;/open&#34;, openRouteHandler)                      // open api
	router.With(m.Auth).Get(&#34;/private&#34;, protectedRouteHandler) // protected api

	// setup auth routes
	authRoutes, avaRoutes := service.Handlers()
	router.Mount(&#34;/auth&#34;, authRoutes)  // add auth handlers
	router.Mount(&#34;/avatar&#34;, avaRoutes) // add avatar handler

	log.Fatal(http.ListenAndServe(&#34;:8080&#34;, router))
}"><pre><span>func</span> <span>main</span>() {
	<span>// define options</span>
	<span>options</span> <span>:=</span> auth.<span>Opts</span>{
		<span>SecretReader</span>: <span>token</span>.<span>SecretFunc</span>(<span>func</span>(<span>id</span> <span>string</span>) (<span>string</span>, <span>error</span>) { <span>// secret key for JWT</span>
			<span>return</span> <span>&#34;secret&#34;</span>, <span>nil</span>
		}),
		<span>TokenDuration</span>:  <span>time</span>.<span>Minute</span> <span>*</span> <span>5</span>, <span>// token expires in 5 minutes</span>
		<span>CookieDuration</span>: <span>time</span>.<span>Hour</span> <span>*</span> <span>24</span>,  <span>// cookie expires in 1 day and will enforce re-login</span>
		<span>Issuer</span>:         <span>&#34;my-test-app&#34;</span>,
		<span>URL</span>:            <span>&#34;http://127.0.0.1:8080&#34;</span>,
		<span>AvatarStore</span>:    <span>avatar</span>.<span>NewLocalFS</span>(<span>&#34;/tmp&#34;</span>),
		<span>Validator</span>: <span>token</span>.<span>ValidatorFunc</span>(<span>func</span>(<span>_</span> <span>string</span>, <span>claims</span> token.<span>Claims</span>) <span>bool</span> {
			<span>// allow only dev_* names</span>
			<span>return</span> <span>claims</span>.<span>User</span> <span>!=</span> <span>nil</span> <span>&amp;&amp;</span> <span>strings</span>.<span>HasPrefix</span>(<span>claims</span>.<span>User</span>.<span>Name</span>, <span>&#34;dev_&#34;</span>)
		}),
	}

	<span>// create auth service with providers</span>
	<span>service</span> <span>:=</span> <span>auth</span>.<span>NewService</span>(<span>options</span>)
	<span>service</span>.<span>AddProvider</span>(<span>&#34;github&#34;</span>, <span>&#34;&lt;Client ID&gt;&#34;</span>, <span>&#34;&lt;Client Secret&gt;&#34;</span>)   <span>// add github provider</span>
	<span>service</span>.<span>AddProvider</span>(<span>&#34;facebook&#34;</span>, <span>&#34;&lt;Client ID&gt;&#34;</span>, <span>&#34;&lt;Client Secret&gt;&#34;</span>) <span>// add facebook provider</span>

	<span>// retrieve auth middleware</span>
	<span>m</span> <span>:=</span> <span>service</span>.<span>Middleware</span>()

	<span>// setup http server</span>
	<span>router</span> <span>:=</span> <span>chi</span>.<span>NewRouter</span>()
	<span>router</span>.<span>Get</span>(<span>&#34;/open&#34;</span>, <span>openRouteHandler</span>)                      <span>// open api</span>
	<span>router</span>.<span>With</span>(<span>m</span>.<span>Auth</span>).<span>Get</span>(<span>&#34;/private&#34;</span>, <span>protectedRouteHandler</span>) <span>// protected api</span>

	<span>// setup auth routes</span>
	<span>authRoutes</span>, <span>avaRoutes</span> <span>:=</span> <span>service</span>.<span>Handlers</span>()
	<span>router</span>.<span>Mount</span>(<span>&#34;/auth&#34;</span>, <span>authRoutes</span>)  <span>// add auth handlers</span>
	<span>router</span>.<span>Mount</span>(<span>&#34;/avatar&#34;</span>, <span>avaRoutes</span>) <span>// add avatar handler</span>

	<span>log</span>.<span>Fatal</span>(<span>http</span>.<span>ListenAndServe</span>(<span>&#34;:8080&#34;</span>, <span>router</span>))
}</pre></div>
<h2 dir="auto"><a id="user-content-middleware" aria-hidden="true" href="#middleware"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Middleware</h2>
<p dir="auto"><code>github.com/go-pkgz/auth/middleware</code> provides ready-to-use middleware.</p>
<ul dir="auto">
<li><code>middleware.Auth</code> - requires authenticated user</li>
<li><code>middleware.Admin</code> - requires authenticated admin user</li>
<li><code>middleware.Trace</code> - doesn&#39;t require authenticated user, but adds user info to request</li>
<li><code>middleware.RBAC</code> - requires authenticated user with passed role(s)</li>
</ul>
<p dir="auto">Also, there is a special middleware <code>middleware.UpdateUser</code> for population and modifying UserInfo in every request. See &#34;Customization&#34; for more details.</p>
<h2 dir="auto"><a id="user-content-details" aria-hidden="true" href="#details"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Details</h2>
<p dir="auto">Generally, adding support of <code>auth</code> includes a few relatively simple steps:</p>
<ol dir="auto">
<li>Setup <code>auth.Opts</code> structure with all parameters. Each of them <a href="https://github.com/go-pkgz/auth/blob/master/auth.go#L29">documented</a> and most of parameters are optional and have sane defaults.</li>
<li><a href="https://github.com/go-pkgz/auth/blob/master/auth.go#L56">Create</a> the new <code>auth.Service</code> with provided options.</li>
<li><a href="https://github.com/go-pkgz/auth/blob/master/auth.go#L149">Add all</a> desirable authentication providers.</li>
<li>Retrieve <a href="https://github.com/go-pkgz/auth/blob/master/auth.go#L144">middleware</a> and <a href="https://github.com/go-pkgz/auth/blob/master/auth.go#L105">http handlers</a> from <code>auth.Service</code></li>
<li>Wire auth and avatar handlers into http router as sub–routes.</li>
</ol>
<h3 dir="auto"><a id="user-content-api" aria-hidden="true" href="#api"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>API</h3>
<p dir="auto">For the example above authentication handlers wired as <code>/auth</code> and provides:</p>
<ul dir="auto">
<li><code>/auth/&lt;provider&gt;/login?site=&lt;site_id&gt;&amp;from=&lt;redirect_url&gt;</code> - site_id used as <code>aud</code> claim for the token and can be processed by <code>SecretReader</code> to load/retrieve/define different secrets. redirect_url is the url to redirect after successful login.</li>
<li><code>/avatar/&lt;avatar_id&gt;</code> - returns the avatar (image). Links to those pictures added into user info automatically, for details see &#34;Avatar proxy&#34;</li>
<li><code>/auth/&lt;provider&gt;/logout</code> and <code>/auth/logout</code> - invalidate &#34;session&#34; by removing JWT cookie</li>
<li><code>/auth/list</code> - gives a json list of active providers</li>
<li><code>/auth/user</code> - returns <code>token.User</code> (json)</li>
<li><code>/auth/status</code> - returns status of logged in user (json)</li>
</ul>
<h3 dir="auto"><a id="user-content-user-info" aria-hidden="true" href="#user-info"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>User info</h3>
<p dir="auto">Middleware populates <code>token.User</code> to request&#39;s context. It can be loaded with <code>token.GetUserInfo(r *http.Request) (user User, err error)</code> or <code>token.MustGetUserInfo(r *http.Request) User</code> functions.</p>
<p dir="auto"><code>token.User</code> object includes all fields retrieved from oauth2 provider:</p>
<ul dir="auto">
<li><code>Name</code> - user name</li>
<li><code>ID</code> - hash of user id</li>
<li><code>Picture</code> - full link to proxied avatar (see &#34;Avatar proxy&#34;)</li>
</ul>
<p dir="auto">It also has placeholders for fields application can populate with custom <code>token.ClaimsUpdater</code> (see &#34;Customization&#34;)</p>
<ul dir="auto">
<li><code>IP</code>  - hash of user&#39;s IP address</li>
<li><code>Email</code> - user&#39;s email</li>
<li><code>Attributes</code> - map of string:any-value. To simplify management of this map some setters and getters provided, for example <code>users.StrAttr</code>, <code>user.SetBoolAttr</code> and so on. See <a href="https://github.com/go-pkgz/auth/blob/master/token/user.go">user.go</a> for more details.</li>
</ul>
<h3 dir="auto"><a id="user-content-avatar-proxy" aria-hidden="true" href="#avatar-proxy"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Avatar proxy</h3>
<p dir="auto">Direct links to avatars won&#39;t survive any real-life usage if they linked from a public page. For example, page <a href="https://remark42.com/demo/" rel="nofollow">like this</a> may have hundreds of avatars and, most likely, will trigger throttling on provider&#39;s side. To eliminate such restriction <code>auth</code> library provides an automatic proxy</p>
<ul dir="auto">
<li>On each login the proxy will retrieve user&#39;s picture and save it to <code>AvatarStore</code></li>
<li>Local (proxied) link to avatar included in user&#39;s info (jwt token)</li>
<li>API for avatar removal provided as a part of <code>AvatarStore</code></li>
<li>User can leverage one of the provided stores:
<ul dir="auto">
<li><code>avatar.LocalFS</code> - file system, each avatar in a separate file</li>
<li><code>avatar.BoltDB</code>  - single <a href="https://go.etcd.io/bbolt" rel="nofollow">boltdb</a> file (embedded KV store).</li>
<li><code>avatar.GridFS</code> - external <a href="https://docs.mongodb.com/manual/core/gridfs/" rel="nofollow">GridFS</a> (mongo db).</li>
</ul>
</li>
<li>In case of need custom implementations of other stores can be passed in and used by <code>auth</code> library. Each store has to implement <code>avatar.Store</code> <a href="https://github.com/go-pkgz/auth/blob/master/avatar/store.go#L25">interface</a>.</li>
<li>All avatar-related setup done as a part of <code>auth.Opts</code> and needs:
<ul dir="auto">
<li><code>AvatarStore</code> - avatar store to use, i.e. <code>avatar.NewLocalFS(&#34;/tmp/avatars&#34;)</code> or more generic <code>avatar.NewStore(uri)</code>
<ul dir="auto">
<li>file system uri - <code>file:///tmp/location</code> or just <code>/tmp/location</code></li>
<li>boltdb - <code>bolt://tmp/avatars.bdb</code></li>
<li>mongo - <code>&#34;mongodb://127.0.0.1:27017/test?ava_db=db1&amp;ava_coll=coll1</code></li>
</ul>
</li>
<li><code>AvatarRoutePath</code> - route prefix for direct links to proxied avatar. For example <code>/api/v1/avatars</code> will make full links like this - <code>http://example.com/api/v1/avatars/1234567890123.image</code>. The url will be stored in user&#39;s token and retrieved by middleware (see &#34;User Info&#34;)</li>
<li><code>AvatarResizeLimit</code> - size (in pixels) used to resize the avatar. Pls note - resize happens once as a part of <code>Put</code> call, i.e. on login. 0 size (default) disables resizing.</li>
</ul>
</li>
</ul>
<h3 dir="auto"><a id="user-content-direct-authentication" aria-hidden="true" href="#direct-authentication"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Direct authentication</h3>
<p dir="auto">In addition to oauth2 providers <code>auth.Service</code> allows to use direct user-defined authentication. This is done by adding direct provider with <code>auth.AddDirectProvider</code>.</p>
<div dir="auto" data-snippet-clipboard-copy-content="	service.AddDirectProvider(&#34;local&#34;, provider.CredCheckerFunc(func(user, password string) (ok bool, err error) {
		ok, err := checkUserSomehow(user, password)
		return ok, err
	}))"><pre>	<span>service</span>.<span>AddDirectProvider</span>(<span>&#34;local&#34;</span>, <span>provider</span>.<span>CredCheckerFunc</span>(<span>func</span>(<span>user</span>, <span>password</span> <span>string</span>) (<span>ok</span> <span>bool</span>, <span>err</span> <span>error</span>) {
		<span>ok</span>, <span>err</span> <span>:=</span> <span>checkUserSomehow</span>(<span>user</span>, <span>password</span>)
		<span>return</span> <span>ok</span>, <span>err</span>
	}))</pre></div>
<p dir="auto">Such provider acts like any other, i.e. will be registered as <code>/auth/local/login</code>.</p>
<p dir="auto">The API for this provider supports both GET and POST requests:</p>
<ul dir="auto">
<li>GET request with user credentials provided as query params:
<div data-snippet-clipboard-copy-content="GET /auth/&lt;name&gt;/login?user=&lt;user&gt;&amp;passwd=&lt;password&gt;&amp;aud=&lt;site_id&gt;&amp;session=[1|0]"><pre><code>GET /auth/&lt;name&gt;/login?user=&lt;user&gt;&amp;passwd=&lt;password&gt;&amp;aud=&lt;site_id&gt;&amp;session=[1|0]
</code></pre></div>
</li>
<li>POST request could be encoded as application/x-www-form-urlencoded or application/json:
<div data-snippet-clipboard-copy-content="POST /auth/&lt;name&gt;/login?session=[1|0]
body: application/x-www-form-urlencoded
user=&lt;user&gt;&amp;passwd=&lt;password&gt;&amp;aud=&lt;site_id&gt;"><pre><code>POST /auth/&lt;name&gt;/login?session=[1|0]
body: application/x-www-form-urlencoded
user=&lt;user&gt;&amp;passwd=&lt;password&gt;&amp;aud=&lt;site_id&gt;
</code></pre></div>
<div data-snippet-clipboard-copy-content="POST /auth/&lt;name&gt;/login?session=[1|0]
body: application/json
{
  &#34;user&#34;: &#34;name&#34;,
  &#34;passwd&#34;: &#34;xyz&#34;,
  &#34;aud&#34;: &#34;bar&#34;,
}"><pre><code>POST /auth/&lt;name&gt;/login?session=[1|0]
body: application/json
{
  &#34;user&#34;: &#34;name&#34;,
  &#34;passwd&#34;: &#34;xyz&#34;,
  &#34;aud&#34;: &#34;bar&#34;,
}
</code></pre></div>
</li>
</ul>
<p dir="auto"><em>note: password parameter doesn&#39;t have to be naked/real password and can be any kind of password hash prepared by caller.</em></p>
<h3 dir="auto"><a id="user-content-verified-authentication" aria-hidden="true" href="#verified-authentication"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Verified authentication</h3>
<p dir="auto">Another non-oauth2 provider allowing user-confirmed authentication, for example by email or slack or telegram. This is
done by adding confirmed provider with <code>auth.AddVerifProvider</code>.</p>
<div dir="auto" data-snippet-clipboard-copy-content="    msgTemplate := &#34;Confirmation email, token: {{.Token}}&#34;
	service.AddVerifProvider(&#34;email&#34;, msgTemplate, sender)"><pre>    <span>msgTemplate</span> <span>:=</span> <span>&#34;Confirmation email, token: {{.Token}}&#34;</span>
	<span>service</span>.<span>AddVerifProvider</span>(<span>&#34;email&#34;</span>, <span>msgTemplate</span>, <span>sender</span>)</pre></div>
<p dir="auto">Message template may use the follow elements:</p>
<ul dir="auto">
<li><code>{{.Address}}</code> - user address, for example email</li>
<li><code>{{.User}}</code> - user name</li>
<li><code>{{.Token}}</code> - confirmation token</li>
<li><code>{{.Site}}</code> - site ID</li>
</ul>
<p dir="auto">Sender should be provided by end-user and implements a single function interface</p>
<div dir="auto" data-snippet-clipboard-copy-content="type Sender interface {
	Send(address string, text string) error
}"><pre><span>type</span> <span>Sender</span> <span>interface</span> {
	<span>Send</span>(<span>address</span> <span>string</span>, <span>text</span> <span>string</span>) <span>error</span>
}</pre></div>
<p dir="auto">For convenience a functional wrapper <code>SenderFunc</code> provided. Email sender provided in <code>provider/sender</code> package and can be
used as <code>Sender</code>.</p>
<p dir="auto">The API for this provider:</p>
<ul dir="auto">
<li><code>GET /auth/&lt;name&gt;/login?user=&lt;user&gt;&amp;address=&lt;adsress&gt;&amp;aud=&lt;site_id&gt;&amp;from=&lt;url&gt;</code> - send confirmation request to user</li>
<li><code>GET /auth/&lt;name&gt;/login?token=&lt;conf.token&gt;&amp;sess=[1|0]</code> - authorize with confirmation token</li>
</ul>
<p dir="auto">The provider acts like any other, i.e. will be registered as <code>/auth/email/login</code>.</p>
<h3 dir="auto"><a id="user-content-telegram" aria-hidden="true" href="#telegram"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Telegram</h3>
<p dir="auto">Telegram provider allows your users to log in with Telegram account. First, you will need to create your bot.
Contact <a href="https://t.me/botfather" rel="nofollow">@BotFather</a> and follow his instructions to create your own bot (call it, for example, &#34;My site auth bot&#34;)</p>
<p dir="auto">Next initialize TelegramHandler with following parameters:</p>
<ul dir="auto">
<li><code>ProviderName</code> - Any unique name to distinguish between providers</li>
<li><code>SuccessMsg</code> - Message sent to user on successfull authentication</li>
<li><code>ErrorMsg</code> - Message sent on errors (e.g. login request expired)</li>
<li><code>Telegram</code> - Telegram API implementation. Use provider.NewTelegramAPI with following arguments
<ol dir="auto">
<li>The secret token bot father gave you</li>
<li>An http.Client for accessing Telegram API&#39;s</li>
</ol>
</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="token := os.Getenv(&#34;TELEGRAM_TOKEN&#34;)

telegram := provider.TelegramHandler{
	ProviderName: &#34;telegram&#34;,
	ErrorMsg:     &#34;❌ Invalid auth request. Please try clicking link again.&#34;,
	SuccessMsg:   &#34;✅ You have successfully authenticated!&#34;,
	Telegram:     provider.NewTelegramAPI(token, http.DefaultClient),

	L:            log.Default(),
	TokenService: service.TokenService(),
	AvatarSaver:  service.AvatarProxy(),
}"><pre><span>token</span> <span>:=</span> <span>os</span>.<span>Getenv</span>(<span>&#34;TELEGRAM_TOKEN&#34;</span>)

<span>telegram</span> <span>:=</span> provider.<span>TelegramHandler</span>{
	<span>ProviderName</span>: <span>&#34;telegram&#34;</span>,
	<span>ErrorMsg</span>:     <span>&#34;❌ Invalid auth request. Please try clicking link again.&#34;</span>,
	<span>SuccessMsg</span>:   <span>&#34;✅ You have successfully authenticated!&#34;</span>,
	<span>Telegram</span>:     <span>provider</span>.<span>NewTelegramAPI</span>(<span>token</span>, <span>http</span>.<span>DefaultClient</span>),

	<span>L</span>:            <span>log</span>.<span>Default</span>(),
	<span>TokenService</span>: <span>service</span>.<span>TokenService</span>(),
	<span>AvatarSaver</span>:  <span>service</span>.<span>AvatarProxy</span>(),
}</pre></div>
<p dir="auto">After that run provider and register it&#39;s handlers:</p>
<div dir="auto" data-snippet-clipboard-copy-content="// Run Telegram provider in the background
go func() {
	err := telegram.Run(context.Background())
	if err != nil {
		log.Fatalf(&#34;[PANIC] failed to start telegram: %v&#34;, err)
	}
}()

// Register Telegram provider
service.AddCustomHandler(&amp;telegram)"><pre><span>// Run Telegram provider in the background</span>
<span>go</span> <span>func</span>() {
	<span>err</span> <span>:=</span> <span>telegram</span>.<span>Run</span>(<span>context</span>.<span>Background</span>())
	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
		<span>log</span>.<span>Fatalf</span>(<span>&#34;[PANIC] failed to start telegram: %v&#34;</span>, <span>err</span>)
	}
}()

<span>// Register Telegram provider</span>
<span>service</span>.<span>AddCustomHandler</span>(<span>&amp;</span><span>telegram</span>)</pre></div>
<p dir="auto">Now all your users have to do is click one of the following links and press <strong>start</strong>
<code>tg://resolve?domain=&lt;botname&gt;&amp;start=&lt;token&gt;</code> or <code>https://t.me/&lt;botname&gt;/?start=&lt;token&gt;</code></p>
<p dir="auto">Use the following routes to interact with provider:</p>
<ol dir="auto">
<li>
<p dir="auto"><code>/auth/&lt;providerName&gt;/login</code> - Obtain auth token. Returns JSON object with <code>bot</code> (bot username) and <code>token</code> (token itself) fields.</p>
</li>
<li>
<p dir="auto"><code>/auth/&lt;providerName&gt;/login?token=&lt;token&gt;</code> - Check if auth request has been confirmed (i.e. user pressed start). Sets session cookie and returns user info on success, errors with 404 otherwise.</p>
</li>
<li>
<p dir="auto"><code>/auth/&lt;providerName&gt;/logout</code> - Invalidate user session.</p>
</li>
</ol>
<h3 dir="auto"><a id="user-content-custom-oauth2" aria-hidden="true" href="#custom-oauth2"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Custom oauth2</h3>
<p dir="auto">This provider brings two extra functions:</p>
<ol dir="auto">
<li>Adds ability to use any third-party oauth2 providers in addition to the list of directly supported. Included <a href="https://github.com/go-pkgz/auth/blob/master/_example/main.go#L113">example</a> demonstrates how to do it for bitbucket.
In order to add a new oauth2 provider following input is required:
<ul dir="auto">
<li><code>Name</code> - any name is allowed except the names from list of supported providers. It is possible to register more than one client for one given oauth2 provider (for example using different names <code>bitbucket_dev</code> and <code>bitbucket_prod</code>)</li>
<li><code>Client</code> - ID and secret of client</li>
<li><code>Endpoint</code> - auth URL and token URL. This information could be obtained from auth2 provider page</li>
<li><code>InfoURL</code> - oauth2 provider API method to read information of logged in user. This method could be found in documentation of oauth2 provider (e.g. for bitbucket <a href="https://developer.atlassian.com/bitbucket/api/2/reference/resource/user" rel="nofollow">https://developer.atlassian.com/bitbucket/api/2/reference/resource/user</a>)</li>
<li><code>MapUserFn</code> - function to convert the response from <code>InfoURL</code> to <code>token.User</code> (s. example below)</li>
<li><code>Scopes</code> - minimal needed scope to read user information. Client should be authorized to these scopes</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="c := auth.Client{
	Cid:     os.Getenv(&#34;AEXMPL_BITBUCKET_CID&#34;),
	Csecret: os.Getenv(&#34;AEXMPL_BITBUCKET_CSEC&#34;),
}

service.AddCustomProvider(&#34;bitbucket&#34;, c, provider.CustomHandlerOpt{
	Endpoint: oauth2.Endpoint{
		AuthURL:  &#34;https://bitbucket.org/site/oauth2/authorize&#34;,
		TokenURL: &#34;https://bitbucket.org/site/oauth2/access_token&#34;,
	},
	InfoURL: &#34;https://api.bitbucket.org/2.0/user/&#34;,
	MapUserFn: func(data provider.UserData, _ []byte) token.User {
		userInfo := token.User{
			ID: &#34;bitbucket_&#34; + token.HashID(sha1.New(),
				data.Value(&#34;username&#34;)),
			Name: data.Value(&#34;nickname&#34;),
		}
		return userInfo
	},
	Scopes: []string{&#34;account&#34;},
})"><pre><span>c</span> <span>:=</span> auth.<span>Client</span>{
	<span>Cid</span>:     <span>os</span>.<span>Getenv</span>(<span>&#34;AEXMPL_BITBUCKET_CID&#34;</span>),
	<span>Csecret</span>: <span>os</span>.<span>Getenv</span>(<span>&#34;AEXMPL_BITBUCKET_CSEC&#34;</span>),
}

<span>service</span>.<span>AddCustomProvider</span>(<span>&#34;bitbucket&#34;</span>, <span>c</span>, provider.<span>CustomHandlerOpt</span>{
	<span>Endpoint</span>: oauth2.<span>Endpoint</span>{
		<span>AuthURL</span>:  <span>&#34;https://bitbucket.org/site/oauth2/authorize&#34;</span>,
		<span>TokenURL</span>: <span>&#34;https://bitbucket.org/site/oauth2/access_token&#34;</span>,
	},
	<span>InfoURL</span>: <span>&#34;https://api.bitbucket.org/2.0/user/&#34;</span>,
	<span>MapUserFn</span>: <span>func</span>(<span>data</span> provider.<span>UserData</span>, <span>_</span> []<span>byte</span>) token.<span>User</span> {
		<span>userInfo</span> <span>:=</span> token.<span>User</span>{
			<span>ID</span>: <span>&#34;bitbucket_&#34;</span> <span>+</span> <span>token</span>.<span>HashID</span>(<span>sha1</span>.<span>New</span>(),
				<span>data</span>.<span>Value</span>(<span>&#34;username&#34;</span>)),
			<span>Name</span>: <span>data</span>.<span>Value</span>(<span>&#34;nickname&#34;</span>),
		}
		<span>return</span> <span>userInfo</span>
	},
	<span>Scopes</span>: []<span>string</span>{<span>&#34;account&#34;</span>},
})</pre></div>
</li>
<li>Adds local oauth2 server user can fully customize. It uses <a href="https://github.com/go-oauth2/oauth2"><code>gopkg.in/oauth2.v3</code></a> library and example shows how <a href="https://github.com/go-pkgz/auth/blob/master/_example/main.go#L227">to initialize</a> the server and <a href="https://github.com/go-pkgz/auth/blob/master/_example/main.go#L100">setup a provider</a>.
<ul dir="auto">
<li>to start local oauth2 server following options are required:
<ul dir="auto">
<li><code>URL</code> - url of oauth2 server with port</li>
<li><code>WithLoginPage</code> - flag to define whether login page should be shown</li>
<li><code>LoginPageHandler</code> - function to handle login request. If not specified default login page will be shown</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="sopts := provider.CustomServerOpt{
	URL:           &#34;http://127.0.0.1:9096&#34;,
	L:             options.Logger,
	WithLoginPage: true,
}
prov := provider.NewCustomServer(srv, sopts)

// Start server
go prov.Run(context.Background())"><pre><span>sopts</span> <span>:=</span> provider.<span>CustomServerOpt</span>{
	<span>URL</span>:           <span>&#34;http://127.0.0.1:9096&#34;</span>,
	<span>L</span>:             <span>options</span>.<span>Logger</span>,
	<span>WithLoginPage</span>: <span>true</span>,
}
<span>prov</span> <span>:=</span> <span>provider</span>.<span>NewCustomServer</span>(<span>srv</span>, <span>sopts</span>)

<span>// Start server</span>
<span>go</span> <span>prov</span>.<span>Run</span>(<span>context</span>.<span>Background</span>())</pre></div>
</li>
<li>to register handler for local oauth2 following option are required:
<ul dir="auto">
<li><code>Name</code> - any name except the names from list of supported providers</li>
<li><code>Client</code> - ID and secret of client</li>
<li><code>HandlerOpt</code> - handler options of custom oauth provider</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content=" service.AddCustomProvider(&#34;custom123&#34;, auth.Client{Cid: &#34;cid&#34;, Csecret: &#34;csecret&#34;}, prov.HandlerOpt)"><pre> <span>service</span>.<span>AddCustomProvider</span>(<span>&#34;custom123&#34;</span>, auth.<span>Client</span>{<span>Cid</span>: <span>&#34;cid&#34;</span>, <span>Csecret</span>: <span>&#34;csecret&#34;</span>}, <span>prov</span>.<span>HandlerOpt</span>)</pre></div>
</li>
</ul>
</li>
</ol>
<h3 dir="auto"><a id="user-content-self-implemented-auth-handler" aria-hidden="true" href="#self-implemented-auth-handler"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Self-implemented auth handler</h3>
<p dir="auto">Additionally it is possible to implement own auth handler. It may be useful if auth provider does not conform to oauth standard. Self-implemented handler has to implement <code>provider.Provider</code> interface.</p>
<div dir="auto" data-snippet-clipboard-copy-content="// customHandler implements provider.Provider interface
c := customHandler{}

// add customHandler to stack of auth handlers
service.AddCustomHandler(c)"><pre><span>// customHandler implements provider.Provider interface</span>
<span>c</span> <span>:=</span> <span>customHandler</span>{}

<span>// add customHandler to stack of auth handlers</span>
<span>service</span>.<span>AddCustomHandler</span>(<span>c</span>)</pre></div>
<h3 dir="auto"><a id="user-content-customization" aria-hidden="true" href="#customization"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Customization</h3>
<p dir="auto">There are several ways to adjust functionality of the library:</p>
<ol dir="auto">
<li><code>SecretReader</code> - interface with a single method <code>Get(aud string) string</code> to return the secret used for JWT signing and verification</li>
<li><code>ClaimsUpdater</code> - interface with <code>Update(claims Claims) Claims</code> method. This is the primary way to alter a token at login time and add any attributes, set ip, email, admin status, roles and so on.</li>
<li><code>Validator</code> - interface with <code>Validate(token string, claims Claims) bool</code> method. This is post-token hook and will be called on <strong>each request</strong> wrapped with <code>Auth</code> middleware. This will be the place for special logic to reject some tokens or users.</li>
<li><code>UserUpdater</code> - interface with <code>Update(claims token.User) token.User</code> method.  This method will be called on <strong>each request</strong> wrapped with <code>UpdateUser</code> middleware. This will be the place for special logic modify User Info in request context. <a href="https://github.com/go-pkgz/auth/blob/19c1b6d26608494955a4480f8f6165af85b1deab/_example/main.go#L189">Example of usage.</a></li>
</ol>
<p dir="auto">All of the interfaces above have corresponding Func adapters - <code>SecretFunc</code>, <code>ClaimsUpdFunc</code>, <code>ValidatorFunc</code> and <code>UserUpdFunc</code>.</p>
<h3 dir="auto"><a id="user-content-implementing-black-list-logic-or-some-other-filters" aria-hidden="true" href="#implementing-black-list-logic-or-some-other-filters"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Implementing black list logic or some other filters</h3>
<p dir="auto">Restricting some users or some tokens is two step process:</p>
<ul dir="auto">
<li><code>ClaimsUpdater</code> sets an attribute, like <code>blocked</code> (or <code>allowed</code>)</li>
<li><code>Validator</code> checks the attribute and returns true/false</li>
</ul>
<p dir="auto"><em>This technique used in the <a href="https://github.com/go-pkgz/auth/blob/master/_example/main.go#L56">example</a> code</em></p>
<p dir="auto">The process can be simplified by doing all checks directly in <code>Validator</code>, but depends on particular case such solution
can be too expensive because <code>Validator</code> runs on each request as a part of auth middleware. In contrast, <code>ClaimsUpdater</code> called on token creation/refresh only.</p>
<h3 dir="auto"><a id="user-content-multi-tenant-services-and-support-for-different-audiences" aria-hidden="true" href="#multi-tenant-services-and-support-for-different-audiences"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Multi-tenant services and support for different audiences</h3>
<p dir="auto">For complex systems a single authenticator may serve multiple distinct subsystems or multiple set of independent users. For example some SaaS offerings may need to provide different authentications for different customers and prevent use of tokens/cookies made by another customer.</p>
<p dir="auto">Such functionality can be implemented in 3 different ways:</p>
<ul dir="auto">
<li>Different instances of <code>auth.Service</code> each one with different secret. Doing this way will ensure the highest level of isolation and cookies/tokens won&#39;t be even parsable across the instances. Practically such architecture can be too complicated and not always possible.
– Handling &#34;allowed audience&#34; as a part of <code>ClaimsUpdater</code> and <code>Validator</code> chain. I.e. <code>ClaimsUpdater</code> sets a claim indicating expected audience code/id and <code>Validator</code> making sure it matches. This way a single <code>auth.Service</code> could handle multiple groups of auth tokens and reject some based on the audience.</li>
<li>Using the standard JWT <code>aud</code> claim. This method conceptually very similar to the previous one, but done by library internally and consumer don&#39;t need to define special  <code>ClaimsUpdater</code> and <code>Validator</code> logic.</li>
</ul>
<p dir="auto">In order to allow <code>aud</code> support the list of allowed audiences should be passed in as <code>opts.Audiences</code> parameter. Non-empty value will trigger internal checks for token generation (will reject token creation for alien <code>aud</code>) as well as <code>Auth</code> middleware.</p>
<h3 dir="auto"><a id="user-content-dev-provider" aria-hidden="true" href="#dev-provider"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Dev provider</h3>
<p dir="auto">Working with oauth2 providers can be a pain, especially during development phase. A special, development-only provider <code>dev</code> can make it less painful. This one can be registered directly, i.e. <code>service.AddProvider(&#34;dev&#34;, &#34;&#34;, &#34;&#34;)</code> or <code>service.AddDevProvider(port)</code> and should be activated like this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="	// runs dev oauth2 server on :8084 by default
	go func() {
		devAuthServer, err := service.DevAuth()
		if err != nil {
			log.Fatal(err)
		}
		devAuthServer.Run()
	}()"><pre>	<span>// runs dev oauth2 server on :8084 by default</span>
	<span>go</span> <span>func</span>() {
		<span>devAuthServer</span>, <span>err</span> <span>:=</span> <span>service</span>.<span>DevAuth</span>()
		<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
			<span>log</span>.<span>Fatal</span>(<span>err</span>)
		}
		<span>devAuthServer</span>.<span>Run</span>()
	}()</pre></div>
<p dir="auto">It will run fake aouth2 &#34;server&#34; on port :8084 and user could login with any user name. See <a href="https://github.com/go-pkgz/auth/blob/master/_example/main.go">example</a> for more details.</p>
<p dir="auto"><em>Warning: this is not the real oauth2 server but just a small fake thing for development and testing only. Don&#39;t use <code>dev</code> provider with any production code.</em></p>
<p dir="auto">By default, Dev provider doesn&#39;t return <code>email</code> claim from <code>/user</code> endpoint, to match behaviour of other providers which only request minimal scopes.
However sometimes it is useful to have <code>email</code> included into user info. This can be done by configuring <code>devAuthServer.GetEmailFn</code> function:</p>
<div dir="auto" data-snippet-clipboard-copy-content="    go func() {
		devAuthServer, err := service.DevAuth()
		devOauth2Srv.GetEmailFn = func(username string) string {
			return username + &#34;@example.com&#34;
		}
		if err != nil {
			log.Fatal(err)
		}
		devAuthServer.Run()
	}()"><pre>    <span>go</span> <span>func</span>() {
		<span>devAuthServer</span>, <span>err</span> <span>:=</span> <span>service</span>.<span>DevAuth</span>()
		<span>devOauth2Srv</span>.<span>GetEmailFn</span> <span>=</span> <span>func</span>(<span>username</span> <span>string</span>) <span>string</span> {
			<span>return</span> <span>username</span> <span>+</span> <span>&#34;@example.com&#34;</span>
		}
		<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
			<span>log</span>.<span>Fatal</span>(<span>err</span>)
		}
		<span>devAuthServer</span>.<span>Run</span>()
	}()</pre></div>
<h3 dir="auto"><a id="user-content-other-ways-to-authenticate" aria-hidden="true" href="#other-ways-to-authenticate"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Other ways to authenticate</h3>
<p dir="auto">In addition to the primary method (i.e. JWT cookie with XSRF header) there are two more ways to authenticate:</p>
<ol dir="auto">
<li>Send JWT header as <code>X-JWT</code>. This shouldn&#39;t be used for web application, however can be helpful for service-to-service authentication.</li>
<li>Send JWT token as query parameter, i.e. <code>/something?token=&lt;jwt&gt;</code></li>
<li>Basic access authentication, for more details see below <a href="#basic-authentication">Basic authentication</a>.</li>
</ol>
<h3 dir="auto"><a id="user-content-basic-authentication" aria-hidden="true" href="#basic-authentication"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Basic authentication</h3>
<p dir="auto">In some cases the <code>middleware.Authenticator</code> allow use  <a href="https://en.wikipedia.org/wiki/Basic_access_authentication" rel="nofollow">Basic access authentication</a>, which transmits credentials as user-id/password pairs, encoded using Base64 (<a href="https://tools.ietf.org/html/rfc7617" rel="nofollow">RFC7235</a>).
When basic authentication used, client doesn&#39;t get auth token in response. It&#39;s auth type expect credentials in a header <code>Authorization</code> at every client request. It can be helpful, if client side not support cookie/token store (e.g. embedded device or custom apps).
This mode disabled by default and will be enabled with options.</p>
<p dir="auto">The <code>auth</code> package has two options of basic authentication:</p>
<ul dir="auto">
<li>simple basic auth will be enabled if <code>Opts.AdminPasswd</code> defined. This will allow access with basic auth admin:&lt;Opts.AdminPasswd&gt; with user <a href="https://github.com/go-pkgz/auth/blob/master/middleware/auth.go#L24">admin</a>. Such method can be used for automation scripts.</li>
<li>basic auth with custom checker <a href="https://github.com/go-pkgz/auth/blob/master/middleware/auth.go#L47">function</a>, which allow adding user data from store to context of request.  It will be enabled if <code>Opts.BasicAuthChecker</code> defined. When <code>BasicAuthChecker</code> defined then <code>Opts.AdminPasswd</code> option will be ignore.</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="options := auth.Opts{
   //...
   AdminPasswd:    &#34;admin_secret_password&#34;, // will ignore if BasicAuthChecker defined
   BasicAuthChecker: func(user, passwd string) (bool, token.User, error) {
      if user == &#34;basic_user&#34; &amp;&amp; passwd == &#34;123456&#34; {
           return true, token.User{Name: user, Role: &#34;test_r&#34;}, nil
      }
      return false, token.User{}, errors.New(&#34;basic auth credentials check failed&#34;)
   }
   //...
}"><pre><span>options</span> <span>:=</span> auth.<span>Opts</span>{
   <span>//...</span>
   <span>AdminPasswd</span>:    <span>&#34;admin_secret_password&#34;</span>, <span>// will ignore if BasicAuthChecker defined</span>
   <span>BasicAuthChecker</span>: <span>func</span>(<span>user</span>, <span>passwd</span> <span>string</span>) (<span>bool</span>, token.<span>User</span>, <span>error</span>) {
      <span>if</span> <span>user</span> <span>==</span> <span>&#34;basic_user&#34;</span> <span>&amp;&amp;</span> <span>passwd</span> <span>==</span> <span>&#34;123456&#34;</span> {
           <span>return</span> <span>true</span>, token.<span>User</span>{<span>Name</span>: <span>user</span>, <span>Role</span>: <span>&#34;test_r&#34;</span>}, <span>nil</span>
      }
      <span>return</span> <span>false</span>, token.<span>User</span>{}, <span>errors</span>.<span>New</span>(<span>&#34;basic auth credentials check failed&#34;</span>)
   }
   <span>//...</span>
}</pre></div>
<h3 dir="auto"><a id="user-content-logging" aria-hidden="true" href="#logging"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Logging</h3>
<p dir="auto">By default, this library doesn&#39;t print anything to stdout/stderr, however user can pass a logger implementing <code>logger.L</code> interface with a single method <code>Logf(format string, args ...interface{})</code>. Functional adapter for this interface included as <code>logger.Func</code>. There are two predefined implementations in the <code>logger</code> package - <code>NoOp</code> (prints nothing, default) and <code>Std</code> wrapping <code>log.Printf</code> from stdlib.</p>
<h2 dir="auto"><a id="user-content-register-oauth2-providers" aria-hidden="true" href="#register-oauth2-providers"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Register oauth2 providers</h2>
<p dir="auto">Authentication handled by external providers. You should setup oauth2 for all (or some) of them to allow users to authenticate. It is not mandatory to have all of them, but at least one should be correctly configured.</p>
<h4 dir="auto"><a id="user-content-google-auth-provider" aria-hidden="true" href="#google-auth-provider"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Google Auth Provider</h4>
<ol dir="auto">
<li>Create a new project: <a href="https://console.developers.google.com/project" rel="nofollow">https://console.developers.google.com/project</a></li>
<li>Choose the new project from the top right project dropdown (only if another project is selected)</li>
<li>In the project Dashboard center pane, choose <strong>&#34;API Manager&#34;</strong></li>
<li>In the left Nav pane, choose <strong>&#34;Credentials&#34;</strong></li>
<li>In the center pane, choose <strong>&#34;OAuth consent screen&#34;</strong> tab. Fill in <strong>&#34;Product name shown to users&#34;</strong> and hit save.</li>
<li>In the center pane, choose <strong>&#34;Credentials&#34;</strong> tab.
<ul dir="auto">
<li>Open the <strong>&#34;New credentials&#34;</strong> drop down</li>
<li>Choose <strong>&#34;OAuth client ID&#34;</strong></li>
<li>Choose <strong>&#34;Web application&#34;</strong></li>
<li>Application name is freeform, choose something appropriate</li>
<li>Authorized origins is your domain ex: <code>https://example.mysite.com</code></li>
<li>Authorized redirect URIs is the location of oauth2/callback constructed as domain + <code>/auth/google/callback</code>, ex: <code>https://example.mysite.com/auth/google/callback</code></li>
<li>Choose <strong>&#34;Create&#34;</strong></li>
</ul>
</li>
<li>Take note of the <strong>Client ID</strong> and <strong>Client Secret</strong></li>
</ol>
<p dir="auto"><em>instructions for google oauth2 setup borrowed from <a href="https://github.com/bitly/oauth2_proxy">oauth2_proxy</a></em></p>
<h4 dir="auto"><a id="user-content-microsoft-auth-provider" aria-hidden="true" href="#microsoft-auth-provider"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Microsoft Auth Provider</h4>
<ol dir="auto">
<li>Register a new application <a href="https://docs.microsoft.com/en-us/graph/auth-register-app-v2" rel="nofollow">using the Azure portal</a>.</li>
<li>Under <strong>&#34;Authentication/Platform configurations/Web&#34;</strong> enter the correct url constructed as domain + <code>/auth/microsoft/callback</code>. i.e. <code>https://example.mysite.com/auth/microsoft/callback</code></li>
<li>In &#34;Overview&#34; take note of the <strong>Application (client) ID</strong></li>
<li>Choose the new project from the top right project dropdown (only if another project is selected)</li>
<li>Select &#34;Certificates &amp; secrets&#34; and click on &#34;+ New Client Secret&#34;.</li>
</ol>
<h4 dir="auto"><a id="user-content-github-auth-provider" aria-hidden="true" href="#github-auth-provider"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>GitHub Auth Provider</h4>
<ol dir="auto">
<li>Create a new <strong>&#34;OAuth App&#34;</strong>: <a href="https://github.com/settings/developers">https://github.com/settings/developers</a></li>
<li>Fill <strong>&#34;Application Name&#34;</strong> and <strong>&#34;Homepage URL&#34;</strong> for your site</li>
<li>Under <strong>&#34;Authorization callback URL&#34;</strong> enter the correct url constructed as domain + <code>/auth/github/callback</code>. ie <code>https://example.mysite.com/auth/github/callback</code></li>
<li>Take note of the <strong>Client ID</strong> and <strong>Client Secret</strong></li>
</ol>
<h4 dir="auto"><a id="user-content-facebook-auth-provider" aria-hidden="true" href="#facebook-auth-provider"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Facebook Auth Provider</h4>
<ol dir="auto">
<li>From <a href="https://developers.facebook.com" rel="nofollow">https://developers.facebook.com</a> select <strong>&#34;My Apps&#34;</strong> / <strong>&#34;Add a new App&#34;</strong></li>
<li>Set <strong>&#34;Display Name&#34;</strong> and <strong>&#34;Contact email&#34;</strong></li>
<li>Choose <strong>&#34;Facebook Login&#34;</strong> and then <strong>&#34;Web&#34;</strong></li>
<li>Set &#34;Site URL&#34; to your domain, ex: <code>https://example.mysite.com</code></li>
<li>Under <strong>&#34;Facebook login&#34;</strong> / <strong>&#34;Settings&#34;</strong> fill &#34;Valid OAuth redirect URIs&#34; with your callback url constructed as domain + <code>/auth/facebook/callback</code></li>
<li>Select <strong>&#34;App Review&#34;</strong> and turn public flag on. This step may ask you to provide a link to your privacy policy.</li>
</ol>
<h4 dir="auto"><a id="user-content-apple-auth-provider" aria-hidden="true" href="#apple-auth-provider"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apple Auth Provider</h4>
<p dir="auto">To configure this provider, a user requires an Apple developer account (without it setting up a sign in with Apple is impossible). <a href="https://developer.apple.com/documentation/sign_in_with_apple/sign_in_with_apple_rest_api" rel="nofollow">Sign in with Apple</a> lets users log in to your app using their two-factor authentication Apple ID.</p>
<p dir="auto">Follow to next steps for configuring on the Apple side:</p>
<ol dir="auto">
<li>Log in <a href="https://developer.apple.com/account" rel="nofollow">to the developer account</a>.</li>
<li>If you don&#39;t have an App ID yet, <a href="https://developer.apple.com/account/resources/identifiers/add/bundleId" rel="nofollow">create one</a>. Later on, you&#39;ll need <strong>TeamID</strong>, which is an &#34;App ID Prefix&#34; value.</li>
<li>Enable the &#34;Sign in with Apple&#34; capability for your App ID in <a href="https://developer.apple.com/account/resources/identifiers/list" rel="nofollow">the Certificates, Identifiers &amp; Profiles</a> section.</li>
<li>Create <a href="https://developer.apple.com/account/resources/identifiers/list/serviceId" rel="nofollow">Service ID</a> and bind with App ID from the previous step. Apple will display the description field value to end-users on sign-in. You&#39;ll need that service <strong>Identifier as a ClientID</strong> later on**.**</li>
<li>Configure &#34;Sign in with Apple&#34; for created Service ID. Add domain where you will use that auth on to &#34;Domains and subdomains&#34; and its main page URL (like <code>https://example.com/</code> to &#34;Return URLs&#34;.</li>
<li>Register a <a href="https://developer.apple.com/account/resources/authkeys/list" rel="nofollow">New Key</a> (private key) for the &#34;Sign in with Apple&#34; feature and download it. Write down the <strong>Key ID</strong>. This key will be used to create <a href="https://developer.apple.com/documentation/sign_in_with_apple/generate_and_validate_tokens#3262048" rel="nofollow">JWT</a> Client Secret.</li>
<li>Add your domain name and sender email in the Certificates, Identifiers &amp; Profiles &gt;&gt; <a href="https://developer.apple.com/account/resources/services/configure" rel="nofollow">More</a> section as a new Email Source.</li>
</ol>
<p dir="auto">After completing the previous steps, you can proceed with configuring the Apple auth provider. Here are the parameters for AppleConfig:</p>
<ul dir="auto">
<li><em>ClientID</em> (<strong>required</strong>) - Service ID identifier which is used for Sign with Apple</li>
<li><em>TeamID</em> (<strong>required</strong>) - Identifier a developer account (use as prefix for all App ID)</li>
<li><em>KeyID</em> (<strong>required</strong>) - Identifier a generated key for Sign with Apple</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="    // apple config parameters
	appleCfg := provider.AppleConfig{
		TeamID:   os.Getenv(&#34;AEXMPL_APPLE_TID&#34;), // developer account identifier
		ClientID: os.Getenv(&#34;AEXMPL_APPLE_CID&#34;), // service identifier
		KeyID:    os.Getenv(&#34;AEXMPL_APPLE_KEYID&#34;), // private key identifier
	}"><pre>    <span>// apple config parameters</span>
	<span>appleCfg</span> <span>:=</span> provider.<span>AppleConfig</span>{
		<span>TeamID</span>:   <span>os</span>.<span>Getenv</span>(<span>&#34;AEXMPL_APPLE_TID&#34;</span>), <span>// developer account identifier</span>
		<span>ClientID</span>: <span>os</span>.<span>Getenv</span>(<span>&#34;AEXMPL_APPLE_CID&#34;</span>), <span>// service identifier</span>
		<span>KeyID</span>:    <span>os</span>.<span>Getenv</span>(<span>&#34;AEXMPL_APPLE_KEYID&#34;</span>), <span>// private key identifier</span>
	}</pre></div>
<p dir="auto">Then add an Apple provider that accepts the following parameters:</p>
<ul dir="auto">
<li><code>appleConfig (provider.AppleConfig)</code>  created above</li>
<li><code>privateKeyLoader (PrivateKeyLoaderInterface)</code></li>
</ul>
<p dir="auto"><code>PrivateKeyLoaderInterface</code> <a href="https://github.com/go-pkgz/auth/blob/master/provider/apple.go#L98:L100">implements</a> a loader for the private key (which you downloaded above) to create a <code>client_secret</code>. The user can use a pre-defined function <code>provider.LoadApplePrivateKeyFromFile(filePath string)</code> to load the private key from local file.</p>
<p dir="auto"><code>AddAppleProvide</code> tries to load private key at call and return an error if load failed. Always check error when calling this provider.</p>
<div dir="auto" data-snippet-clipboard-copy-content="    if err := service.AddAppleProvider(appleCfg, provider.LoadApplePrivateKeyFromFile(&#34;PATH_TO_PRIVATE_KEY_FILE&#34;)); err != nil {
		log.Fatalf(&#34;[ERROR] failed create to AppleProvider: %v&#34;, err)
	}"><pre>    <span>if</span> <span>err</span> <span>:=</span> <span>service</span>.<span>AddAppleProvider</span>(<span>appleCfg</span>, <span>provider</span>.<span>LoadApplePrivateKeyFromFile</span>(<span>&#34;PATH_TO_PRIVATE_KEY_FILE&#34;</span>)); <span>err</span> <span>!=</span> <span>nil</span> {
		<span>log</span>.<span>Fatalf</span>(<span>&#34;[ERROR] failed create to AppleProvider: %v&#34;</span>, <span>err</span>)
	}</pre></div>
<p dir="auto"><strong>Limitation:</strong></p>
<ul dir="auto">
<li>
<p dir="auto">Map a userName (if specific scope defined) is only sent in the upon initial user sign up.
Subsequent logins to your app using Sign In with Apple with the same account do not share any user info and will only return a user identifier in IDToken claims.
This behaves correctly until a user delete sign in for you service with Apple ID in own Apple account profile (security section).
It is recommend that you securely cache the at first login containing the user info for bind it with a user UID at next login.
Provider always get user <code>UID</code> (<code>sub</code> claim) in <code>IDToken</code>.</p>
</li>
<li>
<p dir="auto">Apple doesn&#39;t have an API for fetch avatar and user info.</p>
</li>
</ul>
<p dir="auto">See <a href="https://github.com/go-pkgz/auth/blob/master/_example/main.go#L83:L93">example</a> before use.</p>
<h4 dir="auto"><a id="user-content-yandex-auth-provider" aria-hidden="true" href="#yandex-auth-provider"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Yandex Auth Provider</h4>
<ol dir="auto">
<li>Create a new <strong>&#34;OAuth App&#34;</strong>: <a href="https://oauth.yandex.com/client/new" rel="nofollow">https://oauth.yandex.com/client/new</a></li>
<li>Fill <strong>&#34;App name&#34;</strong> for your site</li>
<li>Under <strong>Platforms</strong> select <strong>&#34;Web services&#34;</strong> and enter <strong>&#34;Callback URI #1&#34;</strong> constructed as domain + <code>/auth/yandex/callback</code>. ie <code>https://example.mysite.com/auth/yandex/callback</code></li>
<li>Select <strong>Permissions</strong>. You need following permissions only from the <strong>&#34;Yandex.Passport API&#34;</strong> section:
<ul dir="auto">
<li>Access to user avatar</li>
<li>Access to username, first name and surname, gender</li>
</ul>
</li>
<li>Fill out the rest of fields if needed</li>
<li>Take note of the <strong>ID</strong> and <strong>Password</strong></li>
</ol>
<p dir="auto">For more details refer to <a href="https://tech.yandex.com/oauth/doc/dg/concepts/about-docpage/" rel="nofollow">Yandex OAuth</a> and <a href="https://tech.yandex.com/passport/doc/dg/index-docpage/" rel="nofollow">Yandex.Passport</a> API documentation.</p>
<h5 dir="auto"><a id="user-content-battlenet-auth-provider" aria-hidden="true" href="#battlenet-auth-provider"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Battle.net Auth Provider</h5>
<ol dir="auto">
<li>Log into Battle.net as a developer: <a href="https://develop.battle.net/nav/login-redirect" rel="nofollow">https://develop.battle.net/nav/login-redirect</a></li>
<li>Click &#34;+ CREATE CLIENT&#34; <a href="https://develop.battle.net/access/clients/create" rel="nofollow">https://develop.battle.net/access/clients/create</a></li>
<li>For &#34;Client name&#34;, enter whatever you want</li>
<li>For &#34;Redirect URLs&#34;, one of the lines must be &#34;http[s]://your_remark_installation:port//auth/battlenet/callback&#34;, e.g. <a href="https://localhost:8443/auth/battlenet/callback" rel="nofollow">https://localhost:8443/auth/battlenet/callback</a> or <a href="https://remark.mysite.com/auth/battlenet/callback" rel="nofollow">https://remark.mysite.com/auth/battlenet/callback</a></li>
<li>For &#34;Service URL&#34;, enter the URL to your site or check &#34;I do not have a service URL for this client.&#34; checkbox if you don&#39;t have any</li>
<li>For &#34;Intended use&#34;, describe the application you&#39;re developing</li>
<li>Click &#34;Save&#34;.</li>
<li>You can see your client ID and client secret at <a href="https://develop.battle.net/access/clients" rel="nofollow">https://develop.battle.net/access/clients</a> by clicking the client you created</li>
</ol>
<p dir="auto">For more details refer to <a href="https://hakanu.net/oauth/2017/01/26/complete-guide-of-battle-net-oauth-api-and-login-button/" rel="nofollow">Complete Guide of Battle.net OAuth API and Login Button</a> or <a href="https://develop.battle.net/documentation/guides/using-oauth" rel="nofollow">the official Battle.net OAuth2 guide</a></p>
<h4 dir="auto"><a id="user-content-patreon-auth-provider" aria-hidden="true" href="#patreon-auth-provider"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Patreon Auth Provider</h4>
<ol dir="auto">
<li>Create a new Patreon client <a href="https://www.patreon.com/portal/registration/register-clients" rel="nofollow">https://www.patreon.com/portal/registration/register-clients</a></li>
<li>Fill <strong>&#34;App Name&#34;</strong>, <strong>&#34;Description&#34;</strong>, <strong>&#34;App Category&#34;</strong> and <strong>&#34;Author&#34;</strong> for your site</li>
<li>Under <strong>&#34;Redirect URIs&#34;</strong> enter the correct url constructed as domain + <code>/auth/patreon/callback</code>. ie <code>https://example.mysite.com/auth/patreon/callback</code></li>
<li>Take note of the <strong>Client ID</strong> and <strong>Client Secret</strong></li>
</ol>
<h4 dir="auto"><a id="user-content-twitter-auth-provider" aria-hidden="true" href="#twitter-auth-provider"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Twitter Auth Provider</h4>
<ol dir="auto">
<li>Create a new twitter application <a href="https://developer.twitter.com/en/apps" rel="nofollow">https://developer.twitter.com/en/apps</a></li>
<li>Fill <strong>App name</strong>  and <strong>Description</strong> and <strong>URL</strong> of your site</li>
<li>In the field <strong>Callback URLs</strong> enter the correct url of your callback handler e.g. <a href="https://example.mysite.com/%7Broute%7D/twitter/callback" rel="nofollow">https://example.mysite.com/{route}/twitter/callback</a></li>
<li>Under <strong>Key and tokens</strong> take note of the <strong>Consumer API Key</strong> and <strong>Consumer API Secret key</strong>. Those will be used as <code>cid</code> and <code>csecret</code></li>
</ol>
<h2 dir="auto"><a id="user-content-status" aria-hidden="true" href="#status"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Status</h2>
<p dir="auto">The library extracted from <a href="https://github.com/umputun/remark">remark42</a> project. The original code in production use on multiple sites and seems to work fine.</p>
<p dir="auto"><code>go-pkgz/auth</code> library still in development and until version 1 released some breaking changes possible.</p>
</article>
          </div></div>
  </body>
</html>
