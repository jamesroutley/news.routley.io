<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/Gekkio/gb-research/tree/main/sm83-cpu-core">Original</a>
    <h1>Game Boy SM83 CPU Core</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">

<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/Gekkio/gb-research/blob/main/sm83-cpu-core/SGB-CPU_01_chip.jpg"><img src="https://github.com/Gekkio/gb-research/raw/main/sm83-cpu-core/SGB-CPU_01_chip.jpg" alt="SGB-CPU 01 chip"/></a></p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/Gekkio/gb-research/blob/main/sm83-cpu-core/soc_overview.jpg"><img src="https://github.com/Gekkio/gb-research/raw/main/sm83-cpu-core/soc_overview.jpg" alt="Overview of the SoC die with the CPU core highlighted"/></a></p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/Gekkio/gb-research/blob/main/sm83-cpu-core/sm83_overview.jpg"><img src="https://github.com/Gekkio/gb-research/raw/main/sm83-cpu-core/sm83_overview.jpg" alt="Overview of SM83 CPU core SVG with one small section highlighted"/></a></p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/Gekkio/gb-research/blob/main/sm83-cpu-core/sm83_detail.jpg"><img src="https://github.com/Gekkio/gb-research/raw/main/sm83-cpu-core/sm83_detail.jpg" alt="Zoomed-in detail of a SM83 CPU core section in the SVG"/></a></p>
<p dir="auto">Game Boy consoles use a custom Sharp CPU core that resembles Z80 and 8080 but
is not exactly either. Some people use the name LR35902, but that is actually
the name of the original Game Boy (DMG) SoC, which includes a huge amount of
other things than just the CPU despite being labeled &#34;DMG-CPU&#34;. This is why I
call the chip a System-on-a-Chip (SoC), and the CPU core needs a separate name.</p>
<p dir="auto">A couple of old Sharp databooks describe a &#34;SM83&#34; CPU core, which happens to
have an instruction set that is a perfect match with the Game Boy CPU. This
exact instruction set is unique and has not been seen in any other CPU cores,
so SM83 is the most probable name based on currently available information.
Personally I actually think that the CPU core might have an even older name,
since some very old Sharp SM-812/SM-813/SM-814 chips seem to have an unnamed
CPU core that seems at least like a relative. Since public information about
these chips is scarce, SM83 is the most accurate name.
You can read further information about this topic at the <a href="https://forums.nesdev.org/viewtopic.php?p=232656#p232656" rel="nofollow">NESdev forums</a></p>
<p dir="auto">The reverse engineering work is based on an SGB-CPU 01 chip used in the Super
Game Boy. The chip is a DMG-CPU B chip with a different boot ROM, so the are
no relevant differences to DMG-CPU B, and all researched information applies to
the original Game Boy as well.</p>
<p dir="auto">The HDL model passes the following tests:</p>
<ul dir="auto">
<li>The whole Blargg&#39;s cpu_instrs test suite, except &#34;02 - interrupts&#34; which
requires SoC peripherals and won&#39;t work with just the CPU core</li>
<li>DAA test from <a href="https://github.com/gekkio/mooneye-test-suite">mooneye-test-suite</a></li>
</ul>
<h2 dir="auto"><a id="user-content-what-has-been-done" aria-hidden="true" href="#what-has-been-done"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What has been done</h2>
<ul dir="auto">
<li>a stitched top photo of the entire SM83 CPU core using a 40x objective</li>
<li>an SVG file that contains hand-drawn traces of almost all interesting
signals. Some repetitive areas and signals have not been traced because they
follow a pattern that is already understood. Note: <strong>the background photo is
not in the repo</strong> and needs to be downloaded separately from
<a href="https://gekkio.fi/files/decapped-chips/Frankenscope/Nintendo_SGB-CPU_01/" rel="nofollow">here</a></li>
<li>a <strong>non-synthesizable</strong> HDL model (written in VHDL) using a &#34;medium
abstraction level&#34;. It&#39;s meant for simulation and won&#39;t work directly on an
FPGA. The abstraction level focuses on logical blocks and their connections,
and does not include every single transistor, or even every single signal</li>
<li>real-world ROM testing by plugging the CPU core into a &#34;mock SoC&#34; (not
included in the repo at the moment). The CPU core passes all Blargg&#39;s
cpu_instrs that don&#39;t require SoC peripherals. In practice this means
everything except &#34;02 - interrupts&#34; which only passes partially</li>
</ul>
<h2 dir="auto"><a id="user-content-what-has-not-been-done" aria-hidden="true" href="#what-has-not-been-done"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What has not been done</h2>
<ul dir="auto">
<li>implementation of propagation delays. Estimating realistic propagation delays
is complicated, especially due to dynamic logic. So far there has been no
need, but this may change in the future when more testing is done and
possible edge-cases are discovered</li>
<li>perfect names for everything. A lot of effort has been spent on naming
things, but for example the control unit signals currently have poor names</li>
</ul>
<h2 dir="auto"><a id="user-content-what-is-planned" aria-hidden="true" href="#what-is-planned"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What is planned</h2>
<ul dir="auto">
<li>KiCad schematics of at least the control unit. They already exist but aree
not ready for release. The hand-written HDL will be replaced with HDL
generated from the schematics once this is done</li>
</ul>
<h2 dir="auto"><a id="user-content-repository-contents" aria-hidden="true" href="#repository-contents"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Repository contents</h2>
<ul dir="auto">
<li><code>SGB-CPU_01_sm83_core_40x.svg</code>: Inkscape SVG with most of the CPU core traced
and identified. Download the background image <a href="https://gekkio.fi/files/decapped-chips/Frankenscope/Nintendo_SGB-CPU_01/" rel="nofollow">here</a>
separately and put it in the same folder to use it</li>
<li><code>hdl/</code>: a <strong>non-synthesizable</strong> HDL model of the SM83 CPU core</li>
<li><code>io-cell/</code>: a separate description of the &#34;I/O cell&#34; that connects the SoC
data bus to the SM83 CPU core internal data buses</li>
</ul>
<h2 dir="auto"><a id="user-content-running-the-hdl-test-suite" aria-hidden="true" href="#running-the-hdl-test-suite"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Running the HDL test suite</h2>
<ol dir="auto">
<li>Install <a href="https://python-poetry.org/" rel="nofollow">Poetry</a></li>
<li>Install <a href="https://github.com/ghdl/ghdl">GHDL</a></li>
<li>Run <code>poetry install</code> in the <code>hdl</code> directory</li>
<li>Run <code>poetry run test</code> in the <code>hdl</code> directory</li>
</ol>
<h2 dir="auto"><a id="user-content-further-reading" aria-hidden="true" href="#further-reading"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Further reading</h2>
<ul dir="auto">
<li><a href="https://github.com/Gekkio/gb-ctr">Game Boy: Complete Technical Reference</a>:
contains a high-level description of the CPU core and its instruction set</li>
</ul>
</article>
          </div></div>
  </body>
</html>
