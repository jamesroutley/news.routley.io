<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://cceckman.com/writing/aclock/electronics/">Original</a>
    <h1>A Daylight-Aware Clock: Electronics</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>It took me a little finagling to get the electronics of my <a href="https://cceckman.com/writing/aclock/">daylight clock</a>
running smoothly, even with the <a href="https://cceckman.com/writing/aclock/software/">software</a> in place.
Here’s some of the roadbumps and fixes.</p>


<h2 id="bill-of-materials">Bill of Materials</h2>
<p>I don’t have any commercial relationship with the shops below – no sponsorship, no affiliate links, etc.
Shop around and compare prices before ordering your own!</p>
<table>
  <thead>
      <tr>
          <th>Component</th>
          <th>Purpose</th>
          <th>Shop (price)</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1m (60 count) NeoPixel RGBW strip</td>
          <td>Edge lights</td>
          <td><a href="https://www.adafruit.com/product/2846" rel="external" target="_blank">Adafruit ($27)</a></td>
      </tr>
      <tr>
          <td>32x16 LED Matrix</td>
          <td>Face</td>
          <td><a href="https://www.adafruit.com/product/420" rel="external" target="_blank">Adafruit ($25)</a></td>
      </tr>
      <tr>
          <td>SCD30 CO2 sensor</td>
          <td>Health</td>
          <td><a href="https://mou.sr/3Wo3xtt" rel="external" target="_blank">Mouser ($44)</a>, <a href="https://www.adafruit.com/product/4867" rel="external" target="_blank">Adafruit ($60, with Qwiic)</a></td>
      </tr>
      <tr>
          <td>LED Matrix HAT</td>
          <td>Power, breakout, RTC</td>
          <td><a href="https://www.adafruit.com/product/2345" rel="external" target="_blank">Adafruit ($25)</a></td>
      </tr>
      <tr>
          <td>Raspberry Pi 3 Model B</td>
          <td>Control</td>
          <td><a href="https://www.adafruit.com/product/3055" rel="external" target="_blank">Adafruit ($35)</a>, also many other vendors</td>
      </tr>
      <tr>
          <td>5V/10A DC power supply</td>
          <td>Power</td>
          <td><a href="https://www.adafruit.com/product/658" rel="external" target="_blank">Adafruit ($30)</a></td>
      </tr>
  </tbody>
</table>
<figure><a href="https://cceckman.com/writing/aclock/electronics/components.webp"><img src="https://cceckman.com/writing/aclock/electronics/components.webp" alt="Electronic components separated and laid out. A black cat has come to help."/></a><figcaption>
      <p>Clockwise from upper left: LED matrix HAT (blue), LED matrix (black), cat paw (black), level shifter (red), C02 sensor (green), Raspberry Pi (green), and NeoPixels (white strip).</p>
    </figcaption>
</figure>
<h3 id="power-estimates">Power estimates</h3>
<p>Adafruit gives estimates of about
<a href="https://www.adafruit.com/product/2846" rel="external" target="_blank">80mA / pixel</a>
for the RGBW NeoPixel strip, and <a href="https://www.adafruit.com/product/420" rel="external" target="_blank">2.6A max for a 32x16 matrix</a>.</p>
<p>At a closer look, those are quite different. For the matrix:</p>
$$1.6 \text{mA} = 2.6 \text{A} \div (32 \text{ columns} \times 16 \text{ rows} \times 3 \text{ channels})$$<p>For the NeoPixels:</p>
$$20 \text{mA} = 80 \text{mA} \div 4 \text{ channels}$$<p>Note those are both per-channel value, i.e. accounting for the extra W diode in the NeoPixels.</p>
<p><strong>Why the difference?</strong> The matrix relies heavily on persistence-of-vision:
each pixel is only on for a fraction of the time.<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup>
This is in contrast to the NeoPixels, where “full brightness” means “lit 100% of the time”.</p>
<p>For this project, the realistic power draw will be yet smaller:</p>
<ul>
<li>The display will contain text, not every-pixel-illuminated.<sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup></li>
<li>I may run the NeoPixels at less than 100% brightness max; they’re pretty bright.</li>
<li>At my latitude, daylight hours max out at about 15h (60%).
The rest of the NeoPixels will be “not full brightness”.</li>
</ul>
<p>I guessed the 10A supply would be fine – and <a href="#misadventures-in-level-shifting">under real conditions</a>, it has been enough current.</p>
<h2 id="assembly-and-testing">Assembly and testing</h2>
<h3 id="hat-stackup">HAT stackup</h3>
<p>Once I got the parts,
I soldered everything to the matrix HAT as described in the <a href="https://learn.adafruit.com/adafruit-rgb-matrix-plus-real-time-clock-hat-for-raspberry-pi" rel="external" target="_blank">tutorial</a>.
I didn’t solder the “quality” jumper, though I might do so later.</p>
<p>A quick digression into physical design here: <strong>I regret making the HAT a HAT!</strong></p>
<p>The <a href="https://www.raspberrypi.com/news/introducing-raspberry-pi-hats/" rel="external" target="_blank">“Hardware Attached on Top”</a>
form-factor, as the name suggests, stacks an additional board on top of the Pi.
With the IDC connector on top of <em>that</em> board, the total height hit about 4cm.</p>
<figure><a href="https://cceckman.com/writing/aclock/electronics/stackup.web"><img src="https://cceckman.com/writing/aclock/electronics/stackup.webp" alt="The matrix HAT with power and data cables attached, attached to the top of the Raspberry Pi, mounted on a purple piece of plastic. A compass tool indicates the maximum height."/></a><figcaption>
      <p>The tallest distance is from the base of the mount (purple) to the top of the data cable.</p>
    </figcaption>
</figure>
<p>This means the clock stands out quite a bit from the wall!</p>
<p>I wish I had instead put 2x20 <strong>pins on top</strong> of the HAT, instead of socket on the bottom.
In this configuration, I could have used another ribbon cable to connect the Pi and the HAT,
and laid out all the boards in a single layer across the back.</p>
<figure><a href="https://cceckman.com/writing/aclock/electronics/flat-mount-model.png"><img src="https://cceckman.com/writing/aclock/electronics/flat-mount-model.png" alt="Top view of a 3d model: mounting points for HAT, Pi, SCD30, and level shifter (clockwise from top-left)."/></a><figcaption>
      <p>Electronics flat-mount – the ideal solution.
          <a href="https://www.tinkercad.com/">Modeled with TinkerCAD.</a></p>
    </figcaption>
</figure>
<p>But after putting the HAT together,
I wasn’t able to de-solder the socket connector on the HAT.<sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup>
I’m planning on making at least one more revision of this clock, though,
so I’ll get it right next time!</p>
<h3 id="neopixel-test-wiring">NeoPixel test wiring</h3>
<p>After I confirmed the HAT and matrix worked, I tested the NeoPixels.
I disconnected the HAT and
used a <a href="https://www.adafruit.com/product/2028" rel="external" target="_blank">T-Cobbler</a> to connect the Pi to a breadboard.</p>
<figure><a href="https://cceckman.com/writing/aclock/electronics/neopixel-breadboard.webp"><img src="https://cceckman.com/writing/aclock/electronics/neopixel-breadboard.webp" alt="Breadboard of the NeoPixel test setup. Per the circuit diagram below, a 22 microfarad capacitor sits between the left-hand power and ground rails. Those rails are connected via jumpers to the red (power) and black (ground) rails of a three-pin Dupont connector. The white (data) pin of that connector is connected, via a 220 ohm resistor and a jumper, to a data pin on the Raspberry Pi cobbler."/></a><figcaption>
      <p>Breadboard setup for initial NeoPixel testing; see circuit diagram <a href="#neopixel-breadboard">below</a>.</p>
    </figcaption>
</figure>
<p>I found the wires on the NeoPixel were slightly too large
to use with the
<a href="https://www.mattmillman.com/info/crimpconnectors/dupont-and-dupont-connectors/" rel="external" target="_blank">DuPont connector</a>
kit I had, so I <a href="https://en.wikipedia.org/wiki/Western_Union_splice" rel="external" target="_blank">spliced</a>
the NeoPixel wires to a slightly smaller gauge
before re-terminating with DuPont pins.</p>
<p>NeoPixels nominally take power and signal at 5V, but I cheated:
I connected the NeoPixel power to the Pi’s 3.3V output,
<a href="https://learn.adafruit.com/adafruit-neopixel-uberguide/powering-neopixels" rel="external" target="_blank">as described here</a>,
to avoid adding a level shifter to the mix. (For now! <em>Dun dun dun</em>!)</p>
<p>I also included a 22 μF capacitor between the power and ground,
and a small resistor between the NeoPixel data line and GPIO 18,
as suggested in Adafruit’s <a href="https://learn.adafruit.com/adafruit-neopixel-uberguide/powering-neopixels" rel="external" target="_blank">NeoPixel guide</a>.</p>

<figure><a href="https://cceckman.com/writing/aclock/electronics/electronics-v1-Breadboard%20NeoPixels.svg"><img src="https://cceckman.com/writing/aclock/electronics/electronics-v1-Breadboard%20NeoPixels.svg" alt="Electronic schematic of the NeoPixel test setup. The Raspberry Pi&#39;s 3.3 volt pin is connected to the positive terminal of a 22 microfarad capacitor, and to the power pin of the NeoPixels. The Raspberry Pi ground is also connected to the capacitor and the NeoPixels, by their ground pins. The Raspberry Pi&#39;s GPIO 18 pin is connected to the NeoPixel data pin via a 220 ohm resistor."/></a><figcaption>
      <p>Circuit diagram of the above test setup.</p>
    </figcaption>
</figure>
<p>After working through a couple <a href="https://cceckman.com/writing/aclock/software">software</a> issues,
the NeoPixels worked fine!</p>
<h3 id="all-together-now">All together now!</h3>
<p>I replaced the HAT on the Pi,
and made a splitter cable for the NeoPixels so I could connect them via the HAT.</p>
<figure><img src="https://cceckman.com/writing/aclock/electronics/electronics-v1-Neopixels%203.3V.svg" alt="Electronic schematic of the NeoPixels at in the matrix setup."/><figcaption>
      <p>Circuit diagram of the above test setup.</p>
    </figcaption>
</figure>
<p>You’ll note this setup no longer has a data-pin resistor, or a capacitor for the 3.3V line.
Problem? Maybe – read on.</p>
<p>I also moved the data pin from GPIO 18 to GPIO 10 (MOSI).
I was thinking of using the “quality” setting for the matrix, which requires GPIO 18.
Luckily, the <a href="https://github.com/jgarff/rpi_ws281x" rel="external" target="_blank">NeoPixel library</a> allows easy reconfiguration.</p>
<p><a name="test-program"></a>
I wrote a <a href="https://github.com/cceckman/aclock/blob/810592806ea7b9239577e4f02fb8c776ea6248c6/server/src/bin/brightness.rs#L53" rel="external" target="_blank">test program</a> that cycled matrix and NeoPixels between colors (white, red, green, blue).<sup id="fnref:4"><a href="#fn:4" role="doc-noteref">4</a></sup>
This let me do a smoke-test that all the data were getting through more or less correctly,
as well as check some properties of the physical design (more on that later!)</p>
<p>Running the test program, everything lit up <em>okay</em>; but I still had some electronics issues to resolve.</p>
<h2 id="electric-bugs">Electric Bugs</h2>
<h3 id="the-blushing-matrix">The Blushing Matrix</h3>
<p>During one test, half of the matrix was stuck at 100% red, with the other channels still behaving normally.</p>
<p>I suspected I damaged the cable or the socket.
If I understand the protocol correctly,<sup id="fnref1:1"><a href="#fn:1" role="doc-noteref">1</a></sup> the R1 and R2 pins each carry “red” data for <em>half</em> the board,
so a short in R1/R2 could keep half the matrix in a “red and other stuff” state.</p>
<p>But after getting a new cable<sup id="fnref:5"><a href="#fn:5" role="doc-noteref">5</a></sup>, touching up some of the GPIO solder joins on the HAT,
and <a href="https://cceckman.com/writing/aclock/software/#fn:5" rel="external" target="_blank">fixing the software</a>,
I couldn’t reproduce the issue. (Sorry, no picture!)</p>
<h3 id="misadventures-in-level-shifting">Misadventures in level shifting</h3>
<p>NeoPixels can run off a 3.3V power source or a 5V power source.
So far, I’d been powering them from the 3.3V terminal of the Raspberry Pi.</p>
<p>But while running the test program, the Pi threw up undervoltage warnings.<sup id="fnref:6"><a href="#fn:6" role="doc-noteref">6</a></sup>
Counterintuitively, I thought I might be able to avoid this by powering the NeoPixels
at 5V: then, I could wire them directly to the HAT’s power supply rather than going through the Raspberry Pi’s voltage regulator.
Maybe this would prevent the Pi from being under-voltaged?</p>
<p>I included a <a href="https://www.sparkfun.com/products/19626" rel="external" target="_blank">level shifter</a> in my next equipment order and wired it up:</p>
<figure><a href="https://cceckman.com/writing/aclock/electronics/electronics-v1-Neopixels%205V%20+%20LS.svg"><img src="https://cceckman.com/writing/aclock/electronics/electronics-v1-Neopixels%205V%20+%20LS.svg" alt="Electronic schematic including the level shifter. The level shifter&#39;s A voltage is the Pi&#39;s 3.3V source, and the B voltage is the 5V source. The MOSI data pin is attached to one level-shifter data input, and the corresponding output provides the NeoPixel data."/></a><figcaption>
      <p>Now with 100% more level shifting. A little short on capacitors, though.</p>
    </figcaption>
</figure>
<p>But … nothing happened!</p>
<p>I was worried that I had fried the level shifter – I definitely plugged in the VCC/GND connectors backwards a couple times.
I plugged the Pi, NeoPixels, and level shifter back in to a breadboard to run some tests.</p>
<p>I used a small CircuitPython script to toggle the output pin (GPIO 10 / MOSI) at 0.5Hz.<sup id="fnref:7"><a href="#fn:7" role="doc-noteref">7</a></sup>
This was slow enough that my multimeter could pick up the transitions.
When the output was high, I saw the input terminal (A1) was at 3.0V – enough lower than the expected 3.3V to indicate a problem!
And sure enough, the B1 output held at 0V.</p>
<p>I realized I needed another control for this experiment.
Was the Raspberry Pi not driving the GPIO high enough, or was the level shifter the problem?
To test, I attached input A2 directly to the 3.3V rail… and the output, B2, became 5V.
At least the A2-B2 channel works!</p>
<p>As a final test, I plugged in the 3.3V source to A1, and again saw B1 remain at 0V.
I had fried <em>something</em> along the A1-B1 path.</p>
<p>I thought I had a fix: run the NeoPixel data signal through A2-B2 instead.
But when I did, I got even more issues:</p>
<figure><a href="https://cceckman.com/writing/aclock/electronics/level-shifter-red.webp"><img src="https://cceckman.com/writing/aclock/electronics/level-shifter-red.webp" alt="On a table, matrix and NeoPixels illuminated in red; but one NeoPixel at the right is green. A digital multimeter sits to the left and a breadboard sits to the right. A rubber duck in a hoodie observes the debugging process from behind the matrix."/></a><figcaption>
      <p>The multimeter and breadboard indicate Something is Wrong. Maybe I need <a href="https://cceckman.com/writing/yak-and-duck">the duck’s help</a>?</p>
    </figcaption>
</figure>
<p>First, the green channel of the first LED in the matrix remained at 100%, regardless of any other settings.
Other than that one pixel, the <a href="#test-program">test program</a> worked fine on the LED strips.</p>
<p>That would have been easy enough to fix in software:
the first pixel on the strip represents “twelve minutes after midnight”, which is never lit up at my latitude.
But when I switched to the clock program, things got worse:</p>
<figure><a href="https://cceckman.com/writing/aclock/electronics/level-shifter-noise.webp"><img src="https://cceckman.com/writing/aclock/electronics/level-shifter-noise.webp" alt="Close-up of the NeoPixel strip, in front of the LED matrix showing the date and time. One portion of the NeoPixel strip alternates between bright green and bright blue pixels; another portion alternates between dim blue and bright white. The duck continues to observe."/></a><figcaption>
      <p>It’s supposed to be dim blue at night, bright white in the day. Not…green?</p>
    </figcaption>
</figure>
<p>Somewhere between the Pi and the NeoPixels the signal was corrupted.
There were a few possible culprits:
a shoddy solder job by yours truly, excessive stray capacitance,
or the fact that I hadn’t checked the effective bandwidth of
<a href="https://www.sparkfun.com/products/19626" rel="external" target="_blank">the level shifter</a> w/rt the NeoPixel protocol.
But none of these were things I could debug further without equipment I don’t have,<sup id="fnref:8"><a href="#fn:8" role="doc-noteref">8</a></sup> or at least time I wasn’t ready to spend.</p>
<p>To resolve all this… I went back to cheating.
I hooked up the NeoPixels to the 3.3V source on the HAT <a href="#all-together-now">as before</a>, but switched off the test program.
I’ll add back the capacitor and data resistor soon for extra safety,
but I haven’t seen the undervoltage warning any more.</p>
<p>The test program provides the worst-case power:
in the white phase, it illuminates every channel, on every pixel, on both the matrix and the NeoPixel strip.
When running the actual clock, most pixels on the display are dark, and at least some of the NeoPixels are too.
Less power draw -&gt; happier Pi.</p>
<h2 id="finishing-up">Finishing up</h2>
<h3 id="feeling-out-the-atmosphere">Feeling out the atmosphere</h3>
<p>I had one last thing to plug in: the SCD30 atmospheric sensor package.<sup id="fnref:9"><a href="#fn:9" role="doc-noteref">9</a></sup></p>
<p>I had added pins on the HAT for all the unused GPIOs,
and neither set of LEDs used the I2c pins.<sup id="fnref:10"><a href="#fn:10" role="doc-noteref">10</a></sup>
Easy: a quick, no-solder connection.<sup id="fnref:11"><a href="#fn:11" role="doc-noteref">11</a></sup></p>
<figure><a href="https://cceckman.com/writing/aclock/electronics/scd30.webp"><img src="https://cceckman.com/writing/aclock/electronics/scd30.webp" alt="In the upper frame, the matrix display shows the time (13:04), temperature (22C), and CO2 concentration (825). The SCD30, a small green PCB, hangs by a bundle of wires in front of the display. The NeoPixel strip rests on the table, arcing in front of and behind the matrix. Towards the camera, the NeoPixels are off or blue, of varying brightness; as the strip curves behind the matrix, some pixels can be seen illuminated in white."/></a><figcaption>
      <p>Time in large font, temperature in Celsius, and CO2 concentration in PPM. Yes, I need to open a window.</p>
    </figcaption>
</figure>
<h3 id="next-steps">Next steps</h3>
<p>I’m satisfied with the electronics, for now.
I’m tentatively planning a second revision, likely with an ESP32,
to keep the BOM a little simpler.</p>
<p>In the next part, I’ll talk about the physical design:
how all the parts fit together.
I’ve previously written a <a href="https://cceckman.com/writing/aclock/">project overview</a> and <a href="https://cceckman.com/writing/aclock/software/">software overview</a>.</p>
<p>In the mean time, if you have any questions or comments, let me know!</p>
<div>
  <p><a href="mailto:charles@cceckman.com">E-mail</a></p>
  <p><a ref="me" href="https://hachyderm.io/@cceckman">Fediverse</a></p>
  
  
</div>

<div role="doc-endnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Repeating from <a href="https://cceckman.com/reading/roundups/2024-11-07/">a reading roundup</a>,
<a href="https://justanotherelectronicsblog.com/?p=636" rel="external" target="_blank">these</a> two <a href="https://www.sparkfun.com/news/2650" rel="external" target="_blank">articles</a>
are very useful for understanding how the matrix works. <a href="#fnref:1" role="doc-backlink">↩︎</a> <a href="#fnref1:1" role="doc-backlink">↩︎</a></p>
</li>
<li id="fn:2">
<p>Yak shave for later: What is the average “duty cycle” of a bitmap font,
i.e. the fraction of pixels illuminated? Using random text? Using typical text? <a href="#fnref:2" role="doc-backlink">↩︎</a></p>
</li>
<li id="fn:3">
<p>Not that this is an impossible task – I just don’t have the desoldering skill for it. Yet! <a href="#fnref:3" role="doc-backlink">↩︎</a></p>
</li>
<li id="fn:4">
<p>…and then through each pixel individually, in white. I’ve skipped these pictures. <a href="#fnref:4" role="doc-backlink">↩︎</a></p>
</li>
<li id="fn:5">
<p>…multiple times, as I repeatedly ordered the wrong part.
Don’t browse the Mouser catalog late at night, kids. <a href="#fnref:5" role="doc-backlink">↩︎</a></p>
</li>
<li id="fn:6">
<p>In <code>dmesg</code>’s output, and on the default console:</p>
<pre tabindex="0"><code>[  448.153794] hwmon hwmon1: Undervoltage detected!
</code></pre> <a href="#fnref:6" role="doc-backlink">↩︎</a></li>
<li id="fn:7">
<p>If you’re curious:</p>
<div><pre tabindex="0"><code data-lang="python"><span><span><span>#!/usr/bin/env python</span>
</span></span><span><span>
</span></span><span><span><span>import</span> <span>time</span>
</span></span><span><span><span>import</span> <span>digitalio</span>
</span></span><span><span><span>import</span> <span>board</span>
</span></span><span><span>
</span></span><span><span><span>led</span> <span>=</span> <span>digitalio</span><span>.</span><span>DigitalInOut</span><span>(</span><span>board</span><span>.</span><span>MOSI</span><span>)</span>
</span></span><span><span><span>led</span><span>.</span><span>direction</span> <span>=</span> <span>digitalio</span><span>.</span><span>Direction</span><span>.</span><span>OUTPUT</span>
</span></span><span><span><span>for</span> <span>x</span> <span>in</span> <span>range</span><span>(</span><span>0</span><span>,</span><span>100000</span><span>):</span>
</span></span><span><span>    <span>led</span><span>.</span><span>value</span> <span>=</span> <span>True</span>
</span></span><span><span>    <span>print</span><span>(</span><span>&#34;on&#34;</span><span>)</span>
</span></span><span><span>    <span>time</span><span>.</span><span>sleep</span><span>(</span><span>2</span><span>)</span>
</span></span><span><span>    <span>led</span><span>.</span><span>value</span> <span>=</span> <span>False</span>
</span></span><span><span>    <span>print</span><span>(</span><span>&#34;off&#34;</span><span>)</span>
</span></span><span><span>    <span>time</span><span>.</span><span>sleep</span><span>(</span><span>2</span><span>)</span>
</span></span></code></pre></div> <a href="#fnref:7" role="doc-backlink">↩︎</a></li>
<li id="fn:8">
<p>I did this testing at home, where I only had access to a multimeter.
If I’d been at my library’s makerspace, I could have pulled out the oscilloscope to check the input and output signals.
(Yes, libraries are awesome!)
I may update this with more data once I can dig in deeper. <a href="#fnref:8" role="doc-backlink">↩︎</a></p>
</li>
<li id="fn:9">
<p>The clock sits in my line of sight in my office.
The NeoPixels are a reminder to enjoy the daylight; the CO2 sensor is a reminder to get some fresh air. <a href="#fnref:9" role="doc-backlink">↩︎</a></p>
</li>
<li id="fn:10">
<p>The RTC included on the HAT uses I2c, but there’s no pin conflicts or address conflicts. <a href="#fnref:10" role="doc-backlink">↩︎</a></p>
</li>
<li id="fn:11">
<p>“<a href="https://www.sparkfun.com/qwiic" rel="external" target="_blank">qwiic</a>” connection, rather: I had the SCD30 breakout from Adafruit,
which has an additional breakout with a Stemma QT / Qwiic-compatible connector.
It’s cheaper to get the SCD30 without the extra breakout board, but using it requires soldering headers or wires. <a href="#fnref:11" role="doc-backlink">↩︎</a></p>
</li>
</ol>
</div>

</div></div>
  </body>
</html>
