<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://quuxplusone.github.io/blog/2025/12/18/nodiscard-operator-bracket/">Original</a>
    <h1>Map: Operator[] Should Be Nodiscard</h1>
    
    <div id="readability-page-1" class="page"><div>
    <p>Lately libc++ has been adding the C++17 <code>[[nodiscard]]</code> attribute aggressively to every header.
(I’m not sure why <em>this</em> month, but my guess is that libc++ just dropped support
for some old compiler such that all their supported compilers now permit the attribute
even in C++11 mode.) libc++ is following the trail that Microsoft STL has blazed
<a href="https://devblogs.microsoft.com/cppblog/c17-progress-in-vs-2017-15-5-and-15-6/">since VS 15.6 in late 2017</a>.</p>

<p>Some functions, like <code>malloc</code>, always make sense to mark <code>[[nodiscard]]</code>.
Others, like <a href="https://en.cppreference.com/w/cpp/memory/unique_ptr/release"><code>unique_ptr::release</code></a>,
are deliberately left unmarked because even though it is <em>usually</em> a bug to write</p>



<p><em>sometimes</em> that’s actually what you meant — you’re calling it only for its side effect.
Back in 2022, Stephan T. Lavavej <a href="https://www.youtube.com/watch?v=FwLRIvUV584&amp;t=267s">estimated</a>
of <code>unique_ptr::release</code> that “90% of discards are a bug, but 10% are maybe valid…
Even though it would find bugs, the cost in false positives is too great.”
However, I think it’s worth pointing out that the fix for a false positive is trivial:
all you have to do is refactor that line of code into</p>



<p>and the warning goes away. So personally I’d apply <code>[[nodiscard]]</code> even to <code>unique_ptr::release</code>.
But it would <em>clearly</em> create noise to apply <code>[[nodiscard]]</code> to, for example, <code>printf</code> (which
returns <code>int</code>) or <a href="https://en.cppreference.com/w/cpp/container/vector/erase"><code>vector::erase</code></a>
(which returns an iterator).</p>

<hr/>

<p>An interesting borderline case came up this week. In <a href="https://github.com/llvm/llvm-project/pull/169971">llvm-project#169971</a>,
Hristo Hristov marked libc++’s <code>map::operator[]</code> as nodiscard. The assumption was that it is
usually a bug to write</p>



<p>Hans Wennborg quickly <a href="https://github.com/llvm/llvm-project/pull/169971#issuecomment-3656203466">reported</a>
that actually Google’s codebases do this a fair bit. Statements calling <code>map::operator[]</code> purely for its
side-effect are found
<a href="https://source.chromium.org/chromium/_/swiftshader/SwiftShader/+/ff4435d3f92dabbf65e210033ea178359ba7db0e:third_party/SPIRV-Tools/source/opt/ir_context.cpp;l=774">in Chromium</a>:</p>

<div><div><pre><code>// Map the result id to the empty set.
combinator_ops_[extension-&gt;result_id()];
</code></pre></div></div>

<p><a href="https://github.com/v8/v8/blob/3cf7ba6f3659b1f59eac1253e053a7545200280a/src/compiler/turboshaft/late-load-elimination-reducer.cc#L350">in V8</a>:</p>

<div><div><pre><code>// We need to insert the load into the truncation mapping as a key, because
// all loads need to be revisited during processing.
int32_truncated_loads_[op_idx];
</code></pre></div></div>

<p>and even <a href="https://github.com/google/flatbuffers/blob/a86afae9399bbe631d1ea0783f8816e780e236cc/src/idl_parser.cpp#L3991">in flatbuffers</a>:</p>

<div><div><pre><code>if (attributes.Add(kv-&gt;key()-&gt;str(), value)) {
  delete value;
  return false;
}
parser.known_attributes_[kv-&gt;key()-&gt;str()];
</code></pre></div></div>

<p>This last example doesn’t even come with a comment to explain it. If I owned this code, I’d absolutely
worry that some coworker would come along and refactor it to</p>

<div><div><pre><code>parser.known_attributes_[kv-&gt;key()-&gt;str()] = false;
</code></pre></div></div>

<p>But that would be incorrect! Assignment-of-<code>false</code> is an unconditional assignment; but what we have
above is a <em>conditional</em> assignment: “If this key isn’t yet in the map, then assign it <code>false</code>; if it
is already in the map, leave its value alone.” That is, it’s the verb that the STL calls
<a href="https://en.cppreference.com/w/cpp/container/map/try_emplace"><code>.try_emplace</code></a>, and as a maintainer
I’d insist that that line be rewritten for clarity into</p>

<div><div><pre><code>parser.known_attributes_.try_emplace(kv-&gt;key()-&gt;str(), false);
</code></pre></div></div>

<p>However, if that’s not possible (maybe because the codebase needs to keep working pre-C++17),
then we can at least add the cast-to-void:</p>

<div><div><pre><code>// Map to &#34;false&#34; only if the attribute isn&#39;t already mapped
(void)parser.known_attributes_[kv-&gt;key()-&gt;str()];
</code></pre></div></div>

<p>Actually, the GitHub history records that the code originally had a very clear
(albeit slightly inefficient) <code>if</code> statement:</p>

<div><div><pre><code>if (known_attributes_.find(attribute-&gt;key()-&gt;str()) == known_attributes_.end())
  known_attributes_[attribute-&gt;key()-&gt;str()] = false;
</code></pre></div></div>

<p>which <a href="https://github.com/google/flatbuffers/pull/5077/commits/ce032fe253af2095dd56c782003674f951aa946f#diff-3e4e0d4b8ff36f318f58a28c083e2395f035dfadb7b0a636cd49f5643e8b00e2L2884-L2885">was replaced</a>
with the current inscrutable version during review.</p>

<hr/>

<p>Anyway, libc++ responded by removing <code>[[nodiscard]]</code> from <code>map::operator[]</code> again in
<a href="https://github.com/llvm/llvm-project/pull/172444">#172444</a>.
I think they should have stuck to their guns: <code>mymap[key];</code> is a horrible way to write
<code>mymap.try_emplace(key)</code> and STL vendors shouldn’t condone it.</p>

<p>Microsoft STL doesn’t mark <code>map::operator[]</code> as nodiscard, either, presumably because they
encountered this “idiom” in the wild too. Microsoft (and now libc++) <em>do</em> mark
the side-effect-less <code>operator[]</code>s of <code>array</code>, <code>deque</code>, and <code>vector</code>.</p>

<p>LLVM internally doesn’t mark the <code>operator[]</code>s of
<a href="https://github.com/llvm/llvm-project/blob/03d044971eccac47ed8518684ea18ba413cd5748/llvm/include/llvm/ADT/DenseMap.h#L341-L347"><code>llvm::DenseMap</code></a>,
<a href="https://github.com/llvm/llvm-project/blob/03d044971eccac47ed8518684ea18ba413cd5748/llvm/include/llvm/ADT/MapVector.h#L98-L100"><code>llvm::MapVector</code></a>, or
<a href="https://github.com/llvm/llvm-project/blob/03d044971eccac47ed8518684ea18ba413cd5748/llvm/include/llvm/ADT/StringMap.h#L275-L277"><code>llvm::StringMap</code></a>,
although my experimentation shows that they could do so with only a handful of minor
fixups (<a href="https://github.com/llvm/llvm-project/blob/03d044971eccac47ed8518684ea18ba413cd5748/llvm/lib/Transforms/IPO/LowerTypeTests.cpp#L1153">here</a>,
<a href="https://github.com/llvm/llvm-project/blob/03d044971eccac47ed8518684ea18ba413cd5748/llvm/lib/Analysis/ModuleSummaryAnalysis.cpp#L492">here</a>,
<a href="https://github.com/llvm/llvm-project/blob/03d044971eccac47ed8518684ea18ba413cd5748/llvm/lib/LTO/ThinLTOCodeGenerator.cpp#L1101-L1104">here</a>,
<a href="https://github.com/llvm/llvm-project/blob/03d044971eccac47ed8518684ea18ba413cd5748/llvm/lib/Target/AArch64/AArch64TargetTransformInfo.cpp#L3970-L3972">here</a>),
in many cases by using the more expressive and efficient <code>tryEmplace</code> they’ve already
implemented and used as a building block for their <code>operator[]</code>.</p>

<blockquote>
  <p>PSA: If your codebase contains any instances of the <code>m[k];</code> “idiom,”
please change them to <code>m.try_emplace(k);</code> or to <code>(void)m[k];</code> with a code comment.
Your code reviewers will thank you, and so will your library vendors!</p>
</blockquote>

<p>See also:</p>

<ul>
  <li><a href="https://quuxplusone.github.io/blog/2024/12/08/should-expected-be-nodiscard/">“<code>std::expected</code> should be nodiscard”</a> (2024-12-08)</li>
</ul>

  </div></div>
  </body>
</html>
