<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/zknill/sqledge">Original</a>
    <h1>SQLedge: Replicate Postgres to SQLite on the Edge</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">[State: alpha]</p>
<p dir="auto">SQLedge uses Postgres logical replication to stream the changes in a source Postgres database to a SQLite database that can run on the edge.
SQLedge serves reads from its local SQLite database, and forwards writes to the upstream Postgres server that it&#39;s replicating from.</p>
<p dir="auto">This lets you run your apps on the edge, and have local, fast, and eventually consistent access to your data.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/zknill/sqledge/blob/main/etc/sqledge.png?raw=true"><img src="https://github.com/zknill/sqledge/raw/main/etc/sqledge.png?raw=true" alt="SQLedge"/></a></p>
<h2 tabindex="-1" dir="auto"><a id="user-content-sql-generation" aria-hidden="true" href="#sql-generation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>SQL generation</h2>
<p dir="auto">The <code>pkg/sqlgen</code> package has an SQL generator in it, which will generate the SQLite insert, update, delete statements based on the logical replication messages received.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-sql-parsing" aria-hidden="true" href="#sql-parsing"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>SQL parsing</h2>
<p dir="auto">When the database is started, we look at which tables already exist in the sqlite copy, and make sure new tables are created automatically on the fly.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-postgres-wire-proxy" aria-hidden="true" href="#postgres-wire-proxy"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Postgres wire proxy</h2>
<p dir="auto">SQLedge contains a Postgres wire proxy, default on <code>localhost:5433</code>. This proxy uses the local SQlite database for reads, and forwards writes to the upstream Postgres server.</p>
<h3 tabindex="-1" dir="auto"><a id="user-content-compatibility" aria-hidden="true" href="#compatibility"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Compatibility</h3>
<p dir="auto">When running, the SQL statements interact with two databases; Postgres (for writes) and SQLite (for reads).</p>
<p dir="auto">The Postgres wire proxy (which forwards reads to SQLite) doesn&#39;t currently translate any of the SQL statements from the Postgres query format/functions to the SQLite format/functions.
Read queries issued against the Postgres wire proxy need to be compatible with SQLite directly.
This is fine for simple <code>SELECT</code> queries, but you will have trouble with Postgres-specific query functions or syntax.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-copy-on-startup" aria-hidden="true" href="#copy-on-startup"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Copy on startup</h2>
<p dir="auto">SQLEdge maintains a table called <code>postgres_pos</code>, this tracks the LSN (log sequence number) of the received logical replication messages so it can pick up processing where it left
off.</p>
<p dir="auto">If no LSN is found, SQLedge will start a postgres <code>COPY</code> of all tables in the <code>public</code> schema. Creating the appropriate SQLite tables, and inserting data.</p>
<p dir="auto">When the replication slot is first created, it exports a transaction snapshot. This snapshot is used for the initial copy. This means that the <code>COPY</code> command will read the data from
the transaction at the moment the replication slot was created.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-trying-it-out" aria-hidden="true" href="#trying-it-out"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Trying it out</h2>
<ol dir="auto">
<li>
<p dir="auto">Create a database</p>
<div data-snippet-clipboard-copy-content="create database myappdatabase;"><pre><code>create database myappdatabase;
</code></pre></div>
</li>
<li>
<p dir="auto">Create a user -- must be a super user because we create a publication on all tables</p>
<div data-snippet-clipboard-copy-content="create user sqledger with login superuser password &#39;secret&#39;;"><pre><code>create user sqledger with login superuser password &#39;secret&#39;;
</code></pre></div>
</li>
<li>
<p dir="auto">Run the example</p>
<div data-snippet-clipboard-copy-content="SQLEDGE_UPSTREAM_USER=sqledger SQLEDGE_UPSTREAM_PASSWORD=secret SQLEDGE_UPSTREAM_NAME=myappdatabase go run ./cmd/sqledge/main.go"><pre><code>SQLEDGE_UPSTREAM_USER=sqledger SQLEDGE_UPSTREAM_PASSWORD=secret SQLEDGE_UPSTREAM_NAME=myappdatabase go run ./cmd/sqledge/main.go
</code></pre></div>
</li>
<li>
<p dir="auto">Connect to the postgres wire proxy</p>
<div data-snippet-clipboard-copy-content="psql -h localhost -p 5433

$ CREATE TABLE my_table (id serial not null primary key, names text);
$ INSERT INTO my_table (names) VALUES (&#39;Jane&#39;), (&#39;John&#39;);

$ SELECT * FROM my_table;"><pre><code>psql -h localhost -p 5433

$ CREATE TABLE my_table (id serial not null primary key, names text);
$ INSERT INTO my_table (names) VALUES (&#39;Jane&#39;), (&#39;John&#39;);

$ SELECT * FROM my_table;
</code></pre></div>
<p dir="auto">The read will be served from the local database</p>
</li>
<li>
<p dir="auto">Connect to the local sqlite db</p>
<div data-snippet-clipboard-copy-content="sqlite3 ./sqledge.db

.schema"><pre><code>sqlite3 ./sqledge.db

.schema
</code></pre></div>
</li>
</ol>
<h2 tabindex="-1" dir="auto"><a id="user-content-config" aria-hidden="true" href="#config"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Config</h2>
<p dir="auto">All config is read from environment variables. The full list is available in the struct tags on the fields in <code>pkg/config/config.go</code></p>
</article>
          </div></div>
  </body>
</html>
