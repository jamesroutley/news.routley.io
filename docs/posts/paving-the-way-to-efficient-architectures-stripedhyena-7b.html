<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.together.ai/blog/stripedhyena-7b">Original</a>
    <h1>Paving the way to efficient architectures: StripedHyena-7B</h1>
    
    <div id="readability-page-1" class="page"><div><figure class="w-richtext-align-center w-richtext-figure-type-image"><p><img src="https://assets-global.website-files.com/650c3b59079d92475f37b68f/65734bc389cf125880e4a8c9_herostriped.png" loading="lazy" alt=""/></p></figure><p>One of the focus areas at Together Research is new architectures for long context, improved training, and inference performance over the Transformer architecture. Spinning out of a research program from our team and academic collaborators, with roots in <a href="https://hazyresearch.stanford.edu/blog/2023-06-08-hyena-safari">signal processing-inspired sequence models</a>, we are excited to introduce the <strong>StripedHyena </strong>models. This release includes <a href="https://huggingface.co/togethercomputer/StripedHyena-Hessian-7B"><strong>StripedHyena-Hessian-7B</strong> <strong>(SH 7B)</strong></a>, a base model, and <a href="https://huggingface.co/togethercomputer/StripedHyena-Nous-7B"><strong>StripedHyena-Nous-7B (SH-N 7B)</strong></a>, a chat model. StripedHyena builds on the many lessons learned in the past year on designing efficient sequence modeling architectures: <a href="https://www.together.ai/blog/hungry-hungry-hippos-towards-language-modeling-with-state-space-models">H3</a>, <a href="https://hazyresearch.stanford.edu/blog/2023-03-07-hyena">Hyena</a>, <a href="https://hazyresearch.stanford.edu/blog/2023-06-29-hyena-dna">HyenaDNA</a>, and <a href="https://www.together.ai/blog/monarch-mixer">Monarch Mixer</a>.</p><p>‍</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><p><img src="https://assets-global.website-files.com/650c3b59079d92475f37b68f/657376483aa570d149ef2a34_ezgif-1-cf1baf1671.gif" loading="lazy" alt=""/></p></figure><ul role="list"><li>StripedHyena is the first alternative model competitive with the best open-source Transformers in short and long-context evaluations. The same base model achieves comparable performance with<strong> </strong>Llama-2, Yi and Mistral 7B on OpenLLM leaderboard tasks, outperforming on long-context summarization.</li><li>StripedHyena is faster and more memory efficient for long sequence training, fine-tuning, and generation. Beside attention, one core computational primitive for efficient inference is a state-space model (SSM) layer, building on pioneering work such as <a href="https://arxiv.org/abs/2111.00396">S4</a> (Gu el al.), enabling conversion of convolutional layers into recurrences. Using our latest research on fast kernels for gated convolutions (<a href="https://www.together.ai/blog/flashfftconv">FlashFFTConv</a>) and <a href="https://arxiv.org/abs/2310.18780">on efficient Hyena inference</a>, StripedHyena is &gt;30%, &gt;50%, and &gt;100% faster in end-to-end training on sequences of length 32k, 64k and 128k respectively, compared to an optimized Transformer baseline using FlashAttention v2 and custom kernels. StripedHyena caches for autoregressive generation are &gt;50% smaller than an equivalently-sized Transformer using grouped-query attention. </li><li>StripedHyena is designed using our latest research on <strong>scaling laws of efficient architectures.</strong> In particular, StripedHyena is a hybrid of attention and gated convolutions arranged in <a href="https://arxiv.org/abs/2302.10866">Hyena operators</a>. Via a compute-optimal scaling protocol, we identify several ways to improve on baseline scaling laws for Transformers (<a href="https://arxiv.org/abs/2203.15556">Chinchilla</a>) at the architecture level, such as hybridization. With these techniques, we are able to obtain higher quality models than Transformers at each training compute budget, with additional benefits at inference time.</li><li>StripedHyena is optimized using a set of new <strong>model grafting</strong> techniques, enabling us to change the model architecture during training. StripedHyena was obtained by grafting architectural components of Transformers and Hyena, and trained on a mix of the RedPajama dataset, augmented with longer-context data.</li></ul><p>‍</p><p>We look forward to further pushing the boundaries of model architectures for fast training and inference, allowing us to improve on existing scaling laws and to obtain higher quality base models at each compute budget. </p><p>‍</p><h2><strong>A single architecture for short and longer context tasks</strong>‍</h2><p>For the past year, the Together AI team and our collaborators at Hazy Research have been working on the design of new sequence models for language and other domains. We’ve been especially excited by architectures that replace attention as the primary operator responsible for mixing sequences of embeddings, and replacing them with alternatives that are computationally cheaper. We’ve developed several models (<a href="https://arxiv.org/abs/2212.14052">H3</a>, <a href="https://arxiv.org/abs/2302.10866">Hyena</a>) that replace attention with implicit gated convolutions and gated SSMs, and trained some of the first alternative architectures rivaling Transformers on language.</p><p>‍</p><h3><strong>Evaluation</strong></h3><p>We evaluate StripedHyena on a suite of benchmarks to establish performance on short-context tasks, as well as to probe its ability to process long prompts. </p><p>First, we test perplexity scaling on a subset of books from Project Gutenberg. We compute the perplexity on the last 2048 tokens of each sample, and repeat the experiment by including increasingly longer prefixes in the prompt of StripedHyena. We observe different behaviors depending on the structure of the sample; perplexity either saturates at 32k (the input length seen during the last stages of training), or keeps decreasing past 32k, suggesting that the model is able to incorporate some information from the longer prompt.</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><p><img src="https://assets-global.website-files.com/650c3b59079d92475f37b68f/65732f121802735f813cafb9_PastedGraphic-5.png" loading="lazy" alt=""/></p><figcaption>Context length scaling on books sampled from the Gutenberg collection. The loss decreases when the model is fed additional context via longer prompts.</figcaption></figure><p>‍</p><p>Quality on longer context makes StripedHyena an efficient baseline generalist model, competitive with Mistral 7B on summarization and longer context tasks:</p><p>‍</p><div><div>
  <table>
    <colgroup>
      <col/>
      <col/>
      <col/>
      <col/>
    </colgroup>
    <thead>
      <tr>
        <th>
          <strong>Benchmark (shot)</strong>
        </th>
        <th>
          <strong>SH 7B</strong>
        </th>
        <th>
          <strong>Mistral 7B</strong>
        </th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>GovReport, F1 (0)</td>
        <td>27.9</td>
        <td>17.5</td>
      </tr>
      <tr>
        <td>NarrativeQA, F1 (0)</td>
        <td>25.8</td>
        <td>24.7</td>
      </tr>
      <tr>
        <td>Qasper, F1 (0)</td>
        <td>28.8</td>
        <td>30.3</td>
      </tr>
      <tr>
        <td><strong>Average</strong></td>
        <td><strong>27.5</strong></td>
        <td><strong>24.2</strong></td>
      </tr>
    </tbody>
  </table>
</div></div><p>Benchmarking StripedHyena-Hessian-7B (SH 7B) and Mistral 7B on zero-shot, long-context tasks from <a href="https://www.zero.scrolls-benchmark.com/">ZeroScrolls</a>.</p><p>‍</p><p>StripedHyena is the first alternative architecture competitive with strong Transformer base models of the same size or larger, at scale. On short-context tasks, including <a href="https://huggingface.co/spaces/HuggingFaceH4/open_llm_leaderboard">OpenLLM</a> leaderboard tasks, StripedHyena outperforms Llama-2 7B, Yi 7B and the strongest Transformer alternatives such as RWKV 14B:</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><p><img src="https://assets-global.website-files.com/650c3b59079d92475f37b68f/6573705b70c9c003c9a61e1e_average.png" loading="lazy" alt=""/></p><figcaption>Average of standard short-context, benchmarks: `arc-challenge`, `mmlu`, `boolq`, `winogrande`, `hellaswag`, `truthfulqa`. We use the few shot configuration from the <a href="https://huggingface.co/spaces/HuggingFaceH4/open_llm_leaderboard">OpenLLM</a> leaderboard. <strong>SH 7B is the first alternative model with performance comparable to the best Transformer</strong> baselines of the same size or larger.</figcaption></figure><p>‍</p><p>With our collaborators at <a href="https://nousresearch.com/">Nous Research</a>, we are excited to also release <a href="https://huggingface.co/togethercomputer/StripedHyena-Nous-7B">StripedHyena-Nous- 7B</a> (SH-N 7B), a chat model, built with new fine-tuning recipes tailored to the StripedHyena architecture.</p><p>‍</p><h2><strong>Understanding the architecture design space: Many ways to improve scaling</strong></h2><h3><strong>Hybridization </strong></h3><p>‍</p><p>Early in our scaling experiments, we noticed a consistent trend: given a compute budget, architectures built out of mixtures of different key layers always outperform homogenous architectures. These observations echo findings described in various papers: <a href="https://arxiv.org/abs/2212.14052">H3</a>, <a href="https://www.google.com/search?q=mega+arxiv+model&amp;oq=mega+arxiv+model&amp;aqs=chrome..69i57j33i160l4j33i299.3100j0j7&amp;sourceid=chrome&amp;ie=UTF-8">MEGA</a> (among others) and find even earlier connections to the hybrid global-local attention design of <a href="https://arxiv.org/pdf/2005.14165.pdf">GPT-3</a> (from <a href="https://arxiv.org/pdf/1904.10509.pdf">Sparse Transformers</a>) and <a href="https://huggingface.co/docs/transformers/model_doc/gpt_neo">GPTNeo</a>. </p><p>‍</p><p>To understand this phenomenon, as well as the improvement on scaling coefficients – for example, the expected loss reduction per floating point operation (FLOP) in the budget – for a class of architectures, we carried out an extensive compute-optimal scaling analysis. We found hybrids composed of multi-head attention, gated MLPs and gated convolutions to outperform strong Transformer architectures such as Llama across compute budget, and identified optimal ways to mix these components, in both ordering and quantity.</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><p><img src="https://assets-global.website-files.com/650c3b59079d92475f37b68f/65734be22ed8d1eca69a9876_graph23.png" loading="lazy" alt=""/></p><figcaption>[Left] Perplexity scaling of different architectures, as a function of compute budget. [Right] Optimal hybridization ratio for the compute-optimal model at each compute budget. All points in the figures above, each representing a training setting (model size, architecture, and total number of tokens) are compute-optimal.</figcaption></figure><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><p><img src="https://assets-global.website-files.com/650c3b59079d92475f37b68f/65734b5af10b77767f02d895_graph22.png" loading="lazy" alt=""/></p><figcaption>Perplexity scaling analysis. We follow a compute-optimal protocol and identify the optimal model sizes for each FLOP group (each indicated via a different color) for base and hybrid architectures. To minimize the impact of hyperparameters on different architectures, we derive hyperparameter scaling laws from a subset of optimized experiments. <strong>Hybridizing improves on both scaling and robustness to training performed outside the compute-optimal frontier.</strong></figcaption></figure><p>With our academic partners, we have been developing theory and synthetic tasks to understand how and why this occurs. We have identified a variety of regimes where layers specialize to particular sub-tasks of sequence modeling, providing valuable signals for further architecture optimization. This continues our general line of work on <strong>mechanistic design</strong>, which involves small-scale, synthetic tasks carefully constructed to stress-test architecture capabilities.</p><h3><strong>Multi-head gated convolutions</strong></h3><p>‍</p><p>Another way to improve over Transformer rates is to introduce additional computation in the form of multiple heads in gated convolutions. This design, inspired by linear attention, has been validated in architectures such as <a href="https://arxiv.org/abs/2212.14052">H3</a> and <a href="https://arxiv.org/abs/2310.18780">MultiHyena</a>, and <a href="https://arxiv.org/abs/2310.18780">is provably more efficient at encoding associative recall circuits.</a> </p><figure class="w-richtext-align-center w-richtext-figure-type-image"><p><img src="https://assets-global.website-files.com/650c3b59079d92475f37b68f/6573717223a903c3f413a3bd_white%20lines.png" loading="lazy" alt=""/></p><figcaption>We validate a variety of architectural improvements via compute-optimal scaling.</figcaption></figure><p>‍</p><p>These are two of many architectural design techniques that can result in improved scaling over Transformers. With StripedHyena, we focus in particular on the synergy between attention and gated convolutions.</p><p>‍</p><h2><strong>A shift in the computational footprint of language models: Cheaper fine-tuning, faster inference</strong></h2><p>‍</p><p>Optimizing models built on a different architecture requires rethinking computational trade-offs of training, fine-tuning, and inference. For these new architectures, a different set of computational bottlenecks emerges, and we’re proud to have developed the key technologies enabling these models as well, such as <a href="https://www.together.ai/blog/flashfftconv">FlashFFTConv</a> and its <a href="https://www.together.ai/blog/h3">predecessors</a>. </p><p>‍</p><p>For training and fine-tuning workloads on long sequences, SH 7B is always faster than optimized Transformers (&gt;10%, &gt;20% and &gt;50% end-to-end faster than FlashAttention v2 processing sequences of lengths 32k, 64k and 128k, at batch size 1), with the speedup growing larger on longer sequences and with larger batches. StripedHyena models are optimal candidates for fine-tuning on long-context tasks – for tasks at length 128k, SH 7B can finetune on more than twice as many tokens as a Transformer given the same budget.</p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><p><img src="https://assets-global.website-files.com/650c3b59079d92475f37b68f/65732f3e6bb6da558f966bb8_PastedGraphic-4.png" loading="lazy" alt=""/></p><figcaption><strong> </strong>End-to-end batch size 1 latency of an optimized Transformer 7B (FlashAttention v2 and custom kernels) compared to SH 7B.</figcaption></figure><p>‍</p><p>These improvements are driven by the different asymptotic scaling and computational profile of layers in the hybrid architecture. We look forward to even faster models with refined mixing ratios and layers.</p><p>‍</p><h2><strong>Reducing memory for inference</strong></h2><p>‍</p><p>One additional advantage of SH 7B is a &gt;50% reduced memory footprint during autoregressive generation, compared to a Transformer (both with grouped-query attention). In Transformers, the key and value entries of each layer are cached during the <em>prefilling</em> phase to avoid recomputation and speed up incremental decoding. Gated-convolution layers introduce significantly more degrees of freedom during inference, as there are several ways to represent and optimize computation. We explore these trade-offs in our recent research on <a href="https://arxiv.org/abs/2310.18780">distillation and representation of convolutions in Hyena</a>. These new techniques have been used in SH 7B to further reduce the memory footprint by identifying and pruning redundant states. </p><p>‍</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><p><img src="https://assets-global.website-files.com/650c3b59079d92475f37b68f/65732f59425c945fc9fbfe71_PastedGraphic-6.png" loading="lazy" alt=""/></p><figcaption>Memory footprint of inference cache for GQA Transformer and StripedHyena, including key-value cache and convolution states (FIR and IIR). </figcaption></figure><h2><strong>From signal processing to language models</strong></h2><p>‍</p><p>The flexibility of StripedHyena is a direct consequence of the existence of multiple equivalent representations and parametrization of linear systems: convolutional, modal, canonical. Each form is better suited to a specific training and inference workload.</p><p>‍</p><p>Borrowing terminology from classical signal processing, SH convolutional filters can be broadly treated as  either finite (FIR) or infinite (IIR). FIR caching for a convolution is analogous to standard key-value caching (kv caching) in attention – particularly the sliding window kind – and grows in memory footprint (until a maximum value).</p><p>‍</p><p>IIR filters on the other hand can be applied by caching a constant-size state, then updated during decoding via a recurrent step. The IIR representation can itself be customized. Fixed-size states, in contrast to kv caches, open up several key optimizations at the inference stack level, streamlining techniques such as continuous batching and speculative decoding.</p><p>‍</p><h2><strong>What’s ahead </strong></h2><p>Our primary objective with the StripedHyena models is to push the frontier of architecture design beyond Transformers. StripedHyena only scratches the surface of what is possible with careful architecture design via mechanistic design and scaling laws, and with ideas such hybridization, implicit convolutions and state caching. We hope these models can inspire the open source community to explore new exciting builds with diverse architectures.</p><p>‍</p><p>In future versions we will explore: </p><ul role="list"><li>Larger models with longer context. </li><li>Multi-modal support. </li><li>Further performance optimizations. </li><li>Integration of StripedHyena into retrieval pipelines for full utilization of longer context.</li></ul><p>‍</p><h2><strong>Acknowledgments</strong></h2><p>This work would not have been possible without our collaborators at <a href="https://hazyresearch.stanford.edu/">HazyResearch</a>, <a href="https://hessian.ai/">Hessian.AI</a>, <a href="https://nousresearch.com/">Nous Research</a>, <a href="https://mila.quebec/en/">MILA</a>, <a href="https://huggingface.co/">HuggingFace</a>, <a href="https://www.dfki.de/en/web">DFKI</a>. </p><p>We are grateful to Hessian.AI Innovation Lab (funded by the Hessian Ministry for Digital Strategy and Innovation) and the hessian.AISC Service Center (funded by the Federal Ministry of Education and Research (BMBF)) for the collaboration and joint use of their AI supercomputer forty-two. Special thanks also go to the German Center for Artificial Intelligence (DFKI).</p></div></div>
  </body>
</html>
