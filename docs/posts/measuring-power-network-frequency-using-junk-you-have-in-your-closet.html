<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://halcy.de/blog/2025/02/09/measuring-power-network-frequency-using-junk-you-have-in-your-closet/">Original</a>
    <h1>Measuring power network frequency using junk you have in your closet</h1>
    
    <div id="readability-page-1" class="page"><div>
    <p>Over the weekend starting on Saturday, the 8th of February 2025, the Baltic states’ electricity grid is <a href="https://elering.ee/en/synchronization-continental-europe">switching from being synchronized with the Russian electric grid to being synchronized with the continental European electrical grid</a>. This involves first disconnecting from the Russian grid, then operating a while as an island system, regulating the frequency alone and doing various tests, and finally, synchronizing frequency and phase with the <span>EU</span> grid and throwing the breaker. Which <a href="https://icosahedron.website/deck/@halcy/113968360243773799">made me wonder earlier today</a>: How hard would it be to watch the frequency changing?</p>

<p>The <em>proper</em> way to do this would probably be to step down line voltage to something more manageable and then just record that signal directly and find the dominant frequency component in that. However, I don’t have a step-down converter, or really any electrical equipment, and I am a mains voltage respecter and not about to plug anything homemade into a socket. So that’s out. However, there’s an easier way: Fortunately, just about everything is an antenna.</p>
<p><a href="https://halcy.de/cites/">I did my PhD in biosignals processing</a>, and a common problem there is to get mains hum out of just about every signal. If you don’t take great care and employ technical measures to get rid of it, you <em>will</em> get substantial 50Hz hum in your signals. Even if you do, there’s likely to still be some. While this is more of a problem with the high amplification factors required to record, say, an <span>EEG</span>, it should still be true when just recording any signal. So, lets plug an audio cable into the PCs line in, wrap it around a power cable a few times for good measure, plug the other side into absolutely nothing, and see what we can do.</p>
<p><a href="https://halcy.de/blog/images/_newsu__kat_server_-_Discord_2025-02-09_02-19-08.png" target="_blank"><img alt="An audio cable coming from my PC, coiled around a power cable a few times, plugged into absolutely nothing" src="https://halcy.de/blog/images/_newsu__kat_server_-_Discord_2025-02-09_02-19-08.png" title="An audio cable coming from my PC, coiled around a power cable a few times, plugged into absolutely nothing"/></a></p>
<p>Firing up <a href="https://www.audacityteam.org/">Audacity</a> and just recording for a few seconds shows… a flat line with absolutely no audio.</p>
<p><a href="https://halcy.de/blog/images/Audacity_2025-02-09_02-17-15.png" target="_blank"><img alt="Audacity showing an audio track with nothing in it." src="https://halcy.de/blog/images/Audacity_2025-02-09_02-17-15.png" title="Audacity showing an audio track with nothing in it."/></a></p>
<p>But what if we normalize this apparent lack of a signal up to -3dBFS?</p>
<p><a href="https://halcy.de/blog/images/Audacity_2025-02-09_02-20-56.png" target="_blank"><img alt="Audacity showing an audio track with a very dirty sine wave in it." src="https://halcy.de/blog/images/Audacity_2025-02-09_02-20-56.png" title="Audacity showing an audio track with a very dirty sine wave in it."/></a>
<a href="https://halcy.de/blog/images/Audacity_2025-02-09_02-21-19.png" target="_blank"><img alt="Audacities spectrum display, with a peak at 50Hz." src="https://halcy.de/blog/images/Audacity_2025-02-09_02-21-19.png" title="Audacities spectrum display, with a peak at 50Hz."/></a></p>
<p>Ah! There’s a very noisy sine, and clearly, it’s somewhere around 50Hz. So this could work! Time to write some python.</p>
<p>Most of the script is boilerplate “record audio and put it into a ringbuffer” stuff, the more interesting part is a bit of basic <span>DSP</span>:</p>
<div><table><tbody><tr><td><div><pre><span> 1</span>
<span> 2</span>
<span> 3</span>
<span> 4</span>
<span> 5</span>
<span> 6</span>
<span> 7</span>
<span> 8</span>
<span> 9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
<span>18</span>
<span>19</span>
<span>20</span>
<span>21</span>
<span>22</span>
<span>23</span>
<span>24</span>
<span>25</span>
<span>26</span>
<span>27</span>
<span>28</span>
<span>29</span>
<span>30</span>
<span>31</span>
<span>32</span>
<span>33</span></pre></div></td><td><div><pre><span></span><code><span># Do a Hann windowed FFT</span>
<span>hann_window</span> <span>=</span> <span>np</span><span>.</span><span>hanning</span><span>(</span><span>fft_window_size</span><span>)</span>
<span>windowed</span> <span>=</span> <span>window_samples</span> <span>*</span> <span>hann_window</span>
<span>fft_complex</span> <span>=</span> <span>np</span><span>.</span><span>fft</span><span>.</span><span>rfft</span><span>(</span><span>windowed</span><span>)</span>

<span># Slice the magnitude spectrogram to the range we care about</span>
<span>freqs</span> <span>=</span> <span>np</span><span>.</span><span>fft</span><span>.</span><span>rfftfreq</span><span>(</span><span>fft_window_size</span><span>,</span> <span>1.0</span> <span>/</span> <span>sample_rate</span><span>)</span>
<span>idx_min</span> <span>=</span> <span>np</span><span>.</span><span>searchsorted</span><span>(</span><span>freqs</span><span>,</span> <span>FREQ_MIN</span><span>)</span>
<span>idx_max</span> <span>=</span> <span>np</span><span>.</span><span>searchsorted</span><span>(</span><span>freqs</span><span>,</span> <span>FREQ_MAX</span><span>)</span>
<span>sub_mags</span> <span>=</span> <span>np</span><span>.</span><span>abs</span><span>(</span><span>fft_complex</span><span>[</span><span>idx_min</span><span>:</span><span>idx_max</span><span>])</span>
<span>sub_freqs</span> <span>=</span> <span>freqs</span><span>[</span><span>idx_min</span><span>:</span><span>idx_max</span><span>]</span>

<span># Find the peak</span>
<span>n</span> <span>=</span> <span>np</span><span>.</span><span>argmax</span><span>(</span><span>sub_mags</span><span>)</span>

<span># Quadratic interpolation to refine the peak location</span>
<span>frac_offset</span> <span>=</span> <span>0.0</span>
<span>if</span> <span>not</span> <span>(</span><span>n</span> <span>&lt;</span> <span>1</span> <span>or</span> <span>n</span> <span>&gt;=</span> <span>len</span><span>(</span><span>sub_mags</span><span>)</span> <span>-</span> <span>1</span><span>):</span>
    <span>alpha</span> <span>=</span> <span>sub_mags</span><span>[</span><span>n</span> <span>-</span> <span>1</span><span>]</span>
    <span>beta</span>  <span>=</span> <span>sub_mags</span><span>[</span><span>n</span><span>]</span>
    <span>gamma</span> <span>=</span> <span>sub_mags</span><span>[</span><span>n</span> <span>+</span> <span>1</span><span>]</span>
    <span>denom</span> <span>=</span> <span>alpha</span> <span>-</span> <span>2</span><span>*</span><span>beta</span> <span>+</span> <span>gamma</span>
<span>if</span> <span>abs</span><span>(</span><span>denom</span><span>)</span> <span>&gt;</span> <span>1e-12</span><span>:</span>
    <span>frac_offset</span> <span>=</span> <span>0.5</span> <span>*</span> <span>(</span><span>alpha</span> <span>-</span> <span>gamma</span><span>)</span> <span>/</span> <span>denom</span>
<span>n_interp</span> <span>=</span> <span>n</span> <span>+</span> <span>frac_offset</span>

<span># Compute which frequency this corresponds to</span>
<span>lower_idx</span> <span>=</span> <span>int</span><span>(</span><span>np</span><span>.</span><span>floor</span><span>(</span><span>n_interp</span><span>))</span>
<span>upper_idx</span> <span>=</span> <span>int</span><span>(</span><span>np</span><span>.</span><span>ceil</span><span>(</span><span>n_interp</span><span>))</span>
<span>frac</span> <span>=</span> <span>n_interp</span> <span>-</span> <span>lower_idx</span>
<span>if</span> <span>upper_idx</span> <span>&gt;=</span> <span>len</span><span>(</span><span>sub_freqs</span><span>):</span>
    <span>upper_idx</span> <span>=</span> <span>len</span><span>(</span><span>sub_freqs</span><span>)</span> <span>-</span> <span>1</span>
<span>est_freq</span> <span>=</span> <span>(</span><span>1</span> <span>-</span> <span>frac</span><span>)</span> <span>*</span> <span>sub_freqs</span><span>[</span><span>lower_idx</span><span>]</span> <span>+</span> <span>frac</span> <span>*</span> <span>sub_freqs</span><span>[</span><span>upper_idx</span><span>]</span>
</code></pre></div></td></tr></tbody></table></div>
<p>I chose a relatively large <span>FFT</span> size (25 seconds) to have good frequency resolution - we can make up for that by just using a very low sample rate, since the frequencies we care about are very low as well, anyways. And indeed:</p>
<p><a href="https://halcy.de/blog/images/Anaconda_Prompt_anaconda3__2025-02-09_02-23-25.png" target="_blank"><img alt="Script output, showing a frequency a sliver below 50Hz." src="https://halcy.de/blog/images/Anaconda_Prompt_anaconda3__2025-02-09_02-23-25.png" title="Script output, showing a frequency a sliver below 50Hz."/></a></p>
<p>So how well does this work? How can we figure out if that reading is accurate? Fortunately, some people from Sympower, a power market company with offices in Estonia recently built their own, <a href="https://baltic-grid.sympower.net/">somewhat less hacky frequency monitoring tool</a>, and it has a convenient <span>API</span> that lets you retrieve their data over some period of time. Turns out this works way better than it has any right to:</p>
<p><a href="https://halcy.de/blog/images/TODO_measuring_network_frequency_with_junk_you_hav_2025-02-09_02-27-22.png" target="_blank"><img alt="Graph comparing my measurement with Sympowers, showing a pretty good overall match." src="https://halcy.de/blog/images/TODO_measuring_network_frequency_with_junk_you_hav_2025-02-09_02-27-22.png" title="Graph comparing my measurement with Sympowers, showing a pretty good overall match."/></a></p>
<p>There is obviously some time lag, and the output is way more smoothed than the more proper measurement, but it clearly works quite well and measures broadly the correct thing!</p>
<p>The logger is now running on my computer collecting data, I want to see if I can tell from the logs I am writing when they flip the breaker and connect to the <span>EU</span> network, so I’ll keep it running over the weekend. If you want to try yourself, <a href="https://gist.github.com/halcy/7fb41ae9457f25eb5d67fa0d2ee57aaf">The full python script is here</a>.</p>
<p>Update late on the 9th of February, 2025: <a href="https://chaos.social/@9er">@9er@chaos.social</a> pointed me to <a href="https://f50hz.de">https://f50hz.de</a>, which has an an <span>API</span> to get the european network frequency, so plotting my measurements next to that (shifting by 12.5 seconds to account for the time lag due to the very long Fourier transform window) gets us this, with the time axis in <span>UTC</span>:</p>
<p><a href="https://halcy.de/blog/images/__Plot.ipynb_-_Visual_Studio_Code_2025-02-09_21-13-45.png" target="_blank"><img alt="A plot showing, above, my measurements and data from f50hz.de, and below, the difference between the two time series. The moment where the grids sync is very clearly visible." src="https://halcy.de/blog/images/__Plot.ipynb_-_Visual_Studio_Code_2025-02-09_21-13-45.png" title="A plot showing, above, my measurements and data from f50hz.de, and below, the difference between the two time series. The moment where the grids sync is very clearly visible."/></a></p>
<p>You can perfectly see the moment the two networks are synced up. Right before, one shifts up in frequency and then goes down, while the other shifts down and then goes up - I wonder if this was intentional, it certainly looks a bit like it, letting the frequencies drift towards each other in a nice, controlled way before flipping the breaker.</p>
	
	
    </div></div>
  </body>
</html>
