<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://ablwr.github.io/blog/2022/06/10/aura-reader-for-two/">Original</a>
    <h1>Aura reader for two</h1>
    
    <div id="readability-page-1" class="page"><div>
      <div>
  
<p><span>10 Jun 2022</span></p><p>This blog post starts with a contextual-maybe-philosophical overview and then goes into a technical overview for my <a href="https://github.com/ablwr/aura-reader-for-two">AURA READER… FOR TWO</a>!</p>

<h2 id="the-first-part">The first part</h2>

<p><img src="https://blog.torh.net/images/aura-cover.jpg" alt="aura"/></p>

<p>Two years ago, I made a a little <a href="https://bits.ashleyblewer.com/aura-reader-2020/">aura reader</a>, as part of an ongoing series I’ve been doing on-and-off around techno-divination and mysticism (the other two are <a href="https://bits.ashleyblewer.com/i-ching/">the i-ching</a> and the <a href="http://bits.ashleyblewer.com/barthes-tarot/">barthes-tarot</a>). I want to tackle tea-leaves next!</p>

<p>I haven’t done a lot of little creative coding projects lately, but I’ve been wanting to update my aura reader for a while – the implementation is super simple (I prefer to work on little projects that only take a few hours rather than getting stuck into something for months at a time).</p>

<p>I’m also interested a bit in forcing people to engage with tech-based projects in a way in which time plays a crucial factor (see also: <a href="https://ashleyblewer.com/throttled.html">throttled</a>, which is essentially a movie on the web because the server moves so slowly).</p>

<p>So the aura reader, I wanted it to be more interactive, inviting people to have to describe someone’s aura to them and vice-versa, rather than the solo meditation of the original aura-reader (except when posting the results to twitter, which I regularly do, but I can’t show you because my tweets auto-delete).</p>

<p><img src="https://blog.torh.net/images/orig-aura.jpg" alt="aura"/></p>

<p>I thought I had written a blog post about the first aura reader, but I guess I hadn’t! It was inspired by a trip to <a href="https://www.magicjewelrynyc.com/aura-photo">Magic Jewelry NYC</a>, every NYCrs favorite spot for getting an aura reading. During a pandemic, it was nice to be able to enjoy seeing your aura from the comfort of your own apartment.</p>

<p>Three years into a pandemic, it’s still nice to be able to connect with people who are far away, either long-term or short-term.</p>

<p><img src="https://blog.torh.net/images/new-aura.jpg" alt="aura"/></p>

<p>So again, this works a bit like a performance piece – you have to already be in sync with the aura-reader partner because each room only lasts for 5 minutes. You have to make the session, invite your friend, and then both join and describe your auras to each other. You won’t be able to see your own aura, just your little self in the corner of the screen.</p>

<h2 id="the-second-part">The second part</h2>

<p>As the <a href="">README</a> describes, I made this using <a href="https://daily.co">Daily</a>, <a href="https://nextjs.org">Next.js</a>, <a href="https://www.typescriptlang.org/">TypeScript</a>, <a href="https://tailwindcss.com/">Tailwind</a>.</p>

<p>I work at Daily, so that was a convenient choice! But it was super easy to get up-and-running, something I’m always telling people in a day-to-day work context. I started by testing with the Prebuilt “drop-these-two-lines-of-code-in-to-replace-Zoom/Meet” to start and then switched to doing everything in a custom way (something I also recommend).</p>

<p>I got to use the brand-new (seriously brand new when I started putting this together!) <a href="https://docs.daily.co/reference/daily-react-hooks#main">daily-react-hooks</a>, which made state management a lot easier. I’m not a React-head, so I’ll take all the help I can get. Next.js and TypeScript helped with that.</p>

<p>This was my first time using Tailwind and I really got a lot out of it, it did feel intuitive to add the CSS I needed in the HTML instead of writing it all myself by hand.</p>

<p>The app is deployed on Vercel. I wanted to deploy it to GitHub Pages because I have a nice routing system that sends all of my projects to a subdomain of mine, but it just wasn’t having it. I wasn’t able to set up a GitHub Action at all, or any other hacky methods I’ve gotten away with in the past through manual builds. I don’t know if the services was having problems or what (literally could not commit the action), but it was a one-click thing with Vercel.</p>

<p>I had to almost totally rewrite the original code, which was fine because it was pretty sloppy to begin with. I cleaned it all up and moved it to TypeScript before realizing that you can’t put lipstick on a pig or whatever the phrase is, because adding types didn’t make up for some structural issues.</p>

<p><img src="https://blog.torh.net/images/aura-frown.jpg" alt="aura"/></p>

<p>The biggest things I had to do were:</p>
<ul>
  <li>make the video and aura take up more space</li>
  <li>work on mobile</li>
  <li>create rooms for two</li>
</ul>

<p>Daily helped with all of those things, because it’s managing any call infrastructure and just passing me a video stream to style as I like. I fully expect it to still be a bit wonky on mobile just because that’s the reality of mobile devices (permissions settings plague me).</p>

<p>Styling to have everything fit on the screen and on top of each other was tricky/finicky, but I eventually got it to work and just with Tailwind. This is where I should go back and figure out exactly what made things click, but I’m a bit lazy.</p>

<p>Something that did help is that <a href="https://justadudewhohacks.github.io/face-api.js/docs/index.html"><code>face-api</code></a>, which I used for the original aura-reader and I kept the exact same face models, has a very helpful resizing method for fitting the canvas on top of the video (which is taking up the full viewport):</p>

<div><div><pre><code><span>const</span> <span>canvas</span> <span>=</span> <span>document</span><span>.</span><span>getElementById</span><span>(</span><span>&#39;</span><span>overlay</span><span>&#39;</span><span>)</span> <span>as</span> <span>HTMLCanvasElement</span>

<span>const</span> <span>displaySize</span> <span>=</span> <span>{</span> <span>width</span><span>:</span> <span>window</span><span>.</span><span>innerWidth</span><span>,</span> <span>height</span><span>:</span> <span>window</span><span>.</span><span>innerHeight</span> <span>}</span>
<span>faceapi</span><span>.</span><span>matchDimensions</span><span>(</span><span>canvas</span><span>,</span> <span>displaySize</span><span>)</span>

<span>const</span> <span>resizedDetections</span> <span>=</span> <span>faceapi</span><span>.</span><span>resizeResults</span><span>(</span><span>detections</span><span>,</span> <span>displaySize</span><span>)</span>

<span>// x,y = size of video display</span>
<span>const</span> <span>x</span><span>:</span> <span>number</span> <span>=</span> <span>resizedDetections</span><span>.</span><span>detection</span><span>.</span><span>box</span><span>.</span><span>x</span>
<span>const</span> <span>y</span><span>:</span> <span>number</span> <span>=</span> <span>resizedDetections</span><span>.</span><span>detection</span><span>.</span><span>box</span><span>.</span><span>y</span>
<span>// w,h = size of face, in pixels</span>
<span>const</span> <span>w</span><span>:</span> <span>number</span> <span>=</span> <span>resizedDetections</span><span>.</span><span>detection</span><span>.</span><span>box</span><span>.</span><span>width</span>
<span>const</span> <span>h</span><span>:</span> <span>number</span> <span>=</span> <span>resizedDetections</span><span>.</span><span>detection</span><span>.</span><span>box</span><span>.</span><span>height</span>
</code></pre></div></div>

<p>Daily helped with making new sessions, it’s just a simple API call:</p>

<div><div><pre><code><span>const</span> <span>createRoom</span> <span>=</span> <span>async</span> <span>()</span> <span>=&gt;</span> <span>{</span>
  <span>try</span> <span>{</span>
    <span>const</span> <span>res</span> <span>=</span> <span>await</span> <span>fetch</span><span>(</span><span>&#39;</span><span>/api/room</span><span>&#39;</span><span>,</span> <span>{</span>
      <span>method</span><span>:</span> <span>&#39;</span><span>POST</span><span>&#39;</span><span>,</span>
      <span>headers</span><span>:</span> <span>{</span>
        <span>&#39;</span><span>Content-Type</span><span>&#39;</span><span>:</span> <span>&#39;</span><span>application/json</span><span>&#39;</span><span>,</span>
      <span>},</span>
    <span>})</span>
    <span>let</span> <span>resJson</span> <span>=</span> <span>await</span> <span>res</span><span>.</span><span>json</span><span>()</span>
    <span>router</span><span>.</span><span>push</span><span>(</span>
      <span>{</span>
        <span>pathname</span><span>:</span> <span>`/sessions/</span><span>${</span><span>resJson</span><span>.</span><span>name</span><span>}</span><span>`</span><span>,</span>
        <span>query</span><span>:</span> <span>{</span>
          <span>url</span><span>:</span> <span>resJson</span><span>.</span><span>url</span><span>,</span>
          <span>room</span><span>:</span> <span>resJson</span><span>.</span><span>name</span><span>,</span>
          <span>exp</span><span>:</span> <span>resJson</span><span>.</span><span>config</span><span>?.</span><span>exp</span><span>,</span>
        <span>},</span>
      <span>},</span>
      <span>// This is to provide a cleaner URL</span>
      <span>`/sessions/</span><span>${</span><span>resJson</span><span>.</span><span>name</span><span>}</span><span>`</span>
    <span>)</span>
  <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
    <span>setIsError</span><span>(</span><span>true</span><span>)</span>
  <span>}</span>
<span>}</span>
</code></pre></div></div>

<p>Because this only works with a maximum of two people, it’s easy enough to handle the media elements:</p>

<div><div><pre><code><span>useDailyEvent</span><span>(</span>
  <span>&#39;</span><span>track-started</span><span>&#39;</span><span>,</span>
  <span>useCallback</span><span>((</span><span>e</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>// Because each call has max 2 participants, there&#39;s only two places</span>
    <span>// where they can go: local in the corner, full screen for the partner</span>
    <span>if</span> <span>(</span><span>e</span><span>.</span><span>participant</span><span>.</span><span>local</span><span>)</span> <span>{</span>
      <span>let</span> <span>localVid</span> <span>=</span> <span>document</span><span>.</span><span>getElementById</span><span>(</span><span>`local`</span><span>)</span> <span>as</span> <span>HTMLVideoElement</span>
      <span>localVid</span><span>.</span><span>srcObject</span> <span>=</span> <span>new</span> <span>MediaStream</span><span>([</span><span>e</span><span>.</span><span>participant</span><span>.</span><span>videoTrack</span><span>])</span>
    <span>}</span> <span>else</span> <span>{</span>
      <span>let</span> <span>otherVid</span> <span>=</span> <span>document</span><span>.</span><span>getElementById</span><span>(</span><span>`other`</span><span>)</span> <span>as</span> <span>HTMLVideoElement</span>
      <span>otherVid</span><span>.</span><span>srcObject</span> <span>=</span> <span>new</span> <span>MediaStream</span><span>([</span><span>e</span><span>.</span><span>participant</span><span>.</span><span>videoTrack</span><span>])</span>
      <span>let</span> <span>otherAud</span> <span>=</span> <span>document</span><span>.</span><span>getElementById</span><span>(</span><span>`otherAud`</span><span>)</span> <span>as</span> <span>HTMLAudioElement</span>
      <span>otherAud</span><span>.</span><span>srcObject</span> <span>=</span> <span>new</span> <span>MediaStream</span><span>([</span><span>e</span><span>.</span><span>participant</span><span>.</span><span>audioTrack</span><span>])</span>
    <span>}</span>
  <span>},</span> <span>[])</span>
<span>)</span>
</code></pre></div></div>

<p>I can also rely on Daily to provide any error handling around the meeting – such as when the meeting ends at 5minutes or if a third person tries to join the room and has to be told that the room is full:</p>

<div><div><pre><code><span>/*
  Take care of any errors, send guidance and clarity
*/</span>

<span>function</span> <span>raiseError</span><span>(</span><span>msg</span><span>:</span> <span>any</span><span>):</span> <span>void</span> <span>{</span>
  <span>if</span> <span>(</span><span>msg</span><span>.</span><span>errorMsg</span><span>)</span> <span>{</span>
    <span>// e.g. &#34;Meeting is full&#34;, can handle more precisely later</span>
    <span>setErrorMsg</span><span>(</span><span>msg</span><span>.</span><span>errorMsg</span><span>)</span>
  <span>}</span>
<span>}</span>

<span>useDailyEvent</span><span>(</span>
  <span>&#39;</span><span>error</span><span>&#39;</span><span>,</span>
  <span>useCallback</span><span>((</span><span>ev</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>raiseError</span><span>(</span><span>ev</span><span>)</span>
  <span>},</span> <span>[])</span>
<span>)</span>
</code></pre></div></div>

<p>Okay, those are some of my quick notes! Hope you <a href="https://aura-reader-for-two.vercel.app/">enjoy</a> and please <a href="https://github.com/ablwr/aura-reader-for-two">let me know</a> of any awkward bugs you find – I’m sure there are PLENTY because side projects are for fun and I quit as soon as it’s not fun!</p>

<p><img src="https://blog.torh.net/images/aura-mobile.jpg" alt="aura"/></p>


</div>

    </div></div>
  </body>
</html>
