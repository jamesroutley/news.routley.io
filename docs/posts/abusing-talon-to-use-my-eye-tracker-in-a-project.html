<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ntietz.com/blog/abusing-talon-eyetracker/?utm_source=atom&amp;utm_medium=feed">Original</a>
    <h1>Abusing Talon to use my eye tracker in a project</h1>
    
    <div id="readability-page-1" class="page"><div><p>I use <a href="https://talonvoice.com/">Talon</a> to control my computer some of the time.
It&#39;s mostly voice control, but it has so many other controls built in!
One lets you use an eye tracker as a mouse.
I thought this sounded like a neat interaction for other situations too.
When I mentioned this to a friend, he suggested building a game with it.</p>
<p>First, though, I had to do some setup for us: get the eye tracker connected to a Rust game library.</p>

<p>There are a few ways that you can integrate eye tracker that are legitimate.</p>
<p>The <a href="https://developer.tobiipro.com/tobiiprosdk.html">Pro SDK</a> would let us do what we want, but it doesn&#39;t the Tobii 5, and never did.
This SDK only supports the more expensive research models (which are <em>thousands</em> of dollars instead of hundreds).
Since I have a Tobii 5, this is out.</p>
<p>Instead, maybe we can use the <a href="https://developer.tobii.com/pc-gaming/develop/tobii-game-integration/">game integration</a> which they provide!
Unfortunately, I <em>also</em> use Linux, and the game integrations are for Windows only.
These are built on top of the stream engine, though!</p>
<p>It looks like we can use their <a href="https://developer.tobii.com/product-integration/stream-engine/">Stream Engine</a> to get the data we need.
This is nice.
But it also means I&#39;ll be integrating C++ into my Rust project, and that doesn&#39;t sound like a good time.
Maybe it will by the time I&#39;m done here.</p>

<p>Instead of figuring out how to use Stream Engine, I thought about trying to see how Talon does it.
However, since Talon is closed source, there&#39;s not a lot of poking around I can do, so that&#39;s a dead end...</p>
<p>But is it?
I can&#39;t seem to find which library they&#39;re integrating, though it seems likely to be Stream Engine itself.
Instead, I looked to do some reversing to see if there&#39;s a way to see anything deeper.
Talon is written in Python but the source is obfuscated, so it&#39;s hard to see.</p>
<p>It does seem to call into some C code, and that&#39;s where the investigation ended for me.
I don&#39;t think it&#39;s a great idea for me to try to poke any deeper, since this is commercial software that&#39;s intended to be closed, and we should honor the intentions of the author.</p>
<p>Instead of <em>copying</em> from them, let&#39;s just make a sidecar and have Talon do things it was never intended for!</p>

<p>One of the beautiful things about Talon is that it&#39;s extremely configurable and customizable.
Out of the box, it is quite bare, which is why using the <a href="https://github.com/talonhub/community">community command set</a> is highly recommended to start.
In many ways, it&#39;s more a workshop for making your own tools, than it is a tool itself.
This gives us a lot of room to hook into Talon!</p>
<p>The first thing is to add a folder into our talon user directory, which for me is at <code>~/.talon/user/</code>.
I added one called <code>eyedaemon</code>.
Then, inside that folder, you can write Python code, and Talon will load it!</p>
<p>Talon supports hot reloads for plugins, which makes it very easy to iterate on this code.
In my code, I just imported Talon&#39;s eye tracker module and made an instance.
Then I iterate over the attached USB devices until I find an eye tracker, which I stash into a global variable to use later on.</p>
<pre data-lang="python"><code data-lang="python">from talon import usb
from talon.track import tobii

tracker = None

for dev in usb.devices():
    if isinstance(dev, tobii.TobiiEC):
        if not tracker:
            tracker = dev
</code></pre>
<p>After that, we write a handler to take the <code>on_gaze</code> event.
(I <em>told</em> you Talon gives us a lot of convenient ways to hook in.)
This will just take the frame and store it.
Specifically, we&#39;ll store this into a single-element list for multi-threading reasons that we&#39;ll see later.</p>
<pre data-lang="python"><code data-lang="python">gaze = [None]

def on_gaze(frame: tobii.GazeFrame) -&gt; None:
    global gaze
    gaze[0] = frame.gaze

tracker.register(&#39;gaze&#39;, on_gaze)
</code></pre>
<p>After this, we just need to expose this on a web server!
We can use Python&#39;s built-in <code>http.server</code> library for thisâ€”we don&#39;t really need to harden it, since this is just a local prototype.
The server is really basic: it just returns the gaze point (0 to 1 for each point, from top-left to bottom-right of your display).</p>
<pre data-lang="python"><code data-lang="python">class RequestHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.send_header(&#34;Content-Type&#34;, &#34;application/json&#34;)
        self.end_headers()

        data = (gaze[0].x, gaze[0].y)
        body = json.dumps(data)
        self.wfile.write(body.encode(&#34;utf-8&#34;))

def run_server(port=8080):
    server_address = (&#34;localhost&#34;, port)
    httpd = HTTPServer(server_address, RequestHandler)
    httpd.serve_forever()
</code></pre>
<p>When we run this via <code>run_server()</code>, we run into a snag: since it never terminates, Talon thinks the module stalled.
We want this, but Talon might get grumpy.
So let&#39;s put it in a thread.</p>
<pre data-lang="python"><code data-lang="python">t = threading.Thread(target=run_server)
t.gaze = gaze
t.start()
</code></pre>
<p>And then in our handler, where we get <code>gaze[0]</code>, we&#39;ll have to get it from the thread instead since this module variable will be different on each load.</p>
<pre data-lang="python"><code data-lang="python">        gaze = threading.current_thread().gaze[0]
        data = (gaze.x, gaze.y)
</code></pre>
<p>Now we fixed that problem but we effectively lost hot reloads, since the thread lives on past the reload and our port is already in use!
We need to stop the http server and its thread on each reload.
I got tired of restarting Talon, so I figured out a delightfully hacky feeling solution.</p>
<p>First, we make sure that we name the thread so we can identify it later.
Then we iterate through all the threads <em>before</em> starting a new one, and when we find it, we can do our stopping!
To do that shutdown, you have to have access to the http server that&#39;s running, so we&#39;ll update a couple of other places.</p>
<pre data-lang="python"><code data-lang="python">for t in threading.enumerate():
    print(t, t.name)
    if t.name == GAZE_THREAD_NAME:
        t.httpd.shutdown()
        t.httpd.server_close()
        t.join()
</code></pre>
<p>Then after we create our thread, we make sure to create the <code>httpd</code> field.</p>
<pre data-lang="python"><code data-lang="python">t = threading.Thread(target=run_server)
t.name = GAZE_THREAD_NAME
t.httpd = None
t.gaze = gaze
t.start()
</code></pre>
<p>And inside <code>run_server</code>, we also add a couple of lines to save <code>httpd</code> to the current thread:</p>
<pre data-lang="python"><code data-lang="python">    t = threading.current_thread()
    t.httpd = httpd
</code></pre>
<p>And after that, we put it all together and we have a hot-reloading http server running inside Talon!</p>

<p>I got it integrated into a Rust program on the read side.
Here&#39;s what that looks like right now.</p>
<p><img src="https://maskray.me/images/eyetracker.gif" alt="short GIF of a red dot moving around in a window, presumably following where the eyes were looking"/></p>
<p>The red dot follows my gaze to wherever I look!
There&#39;s some jitter, but it does follow my eyes pretty accurately, and works best in full screen.
Recording an eye tracker, or debugging it, is pretty funny because you can&#39;t look at the controls to trigger things or stop them.
And when you try to read print statements to see where the current measured point is, it changes to be exactly the area you&#39;re looking at!</p>
<p>Hopefully there&#39;ll be more updates on this project after we do our one-day game jam.
And hopefully this hack is a solid enough foundation for that.</p>
<hr/>


</div><p>
    If this post was enjoyable or useful for you, <strong>please share it!</strong>
    If you have comments, questions, or feedback, you can email <a href="mailto:me@ntietz.com">my personal email</a>.
    To get new posts and support my work, subscribe to the <a href="https://maskray.me/newsletter/">newsletter</a>. There is also an <a href="https://maskray.me/atom.xml">RSS feed</a>.
  </p></div>
  </body>
</html>
