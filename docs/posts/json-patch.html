<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://zuplo.com/blog/2024/10/10/unlocking-the-power-of-json-patch">Original</a>
    <h1>JSON Patch</h1>
    
    <div id="readability-page-1" class="page"><div><div><section><article itemprop="blogPost" itemtype="http://schema.org/BlogPosting"><time datetime="2024-10-10T00:00:00.000Z" itemprop="datePublished">October 10, 2024</time><div><p><a href="https://www.linkedin.com/in/adrianmachado/" target="_blank" rel="noopener noreferrer" itemprop="url"><img src="https://cdn.zuplo.com/cdn-cgi/image/fit=contain,width=200/assets/1dcc630c-ca5e-4031-a7df-580c9509b392.png" alt="Adrian Machado"/></a></p></div>
<p>JSON Patch is a standardized format defined in
<a href="https://datatracker.ietf.org/doc/html/rfc6902">RFC 6902</a> for describing how to
modify a JSON document. It was created to address the need for a simple,
efficient, and standardized way to apply partial updates to resources,
especially over HTTP. Unlike other partial update formats, JSON Patch is
specifically designed to work with JSON documents, which are often used in
modern web APIs.</p>
<p>Initially, HTTP methods like <code>PUT</code> and <code>POST</code> were used to update resources.
However, this often resulted in sending large amounts of data over the network,
even when only a small part of the resource needed modification. The <code>PATCH</code>
method was introduced to allow for partial updates, but there was no
standardized format for the patch document. JSON Patch fills this gap by
providing a clear, concise way to express changes to a JSON document, helping to
reduce bandwidth, and improve the performance of web applications.</p>

<p>JSON Patch operates on a JSON document as a sequence of atomic operations. An
operation is an object that describes a single change to the document. Each
operation includes an <code>op</code> field, which specifies the type of operation, and a
<code>path</code> field, which identifies the location in the document where the operation
should be applied.</p>
<p>Here&#39;s a basic structure of a JSON Patch:</p>
<p>Let&#39;s start with a simple JSON object.</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>{</span></span>
<span data-line=""><span>  &#34;age&#34;</span><span>: </span><span>29</span></span>
<span data-line=""><span>}</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>[</span></span>
<span data-line=""><span>  { </span><span>&#34;op&#34;</span><span>: </span><span>&#34;add&#34;</span><span>, </span><span>&#34;path&#34;</span><span>: </span><span>&#34;/name&#34;</span><span>, </span><span>&#34;value&#34;</span><span>: </span><span>&#34;Alice&#34;</span><span> },</span></span>
<span data-line=""><span>  { </span><span>&#34;op&#34;</span><span>: </span><span>&#34;replace&#34;</span><span>, </span><span>&#34;path&#34;</span><span>: </span><span>&#34;/age&#34;</span><span>, </span><span>&#34;value&#34;</span><span>: </span><span>30</span><span> }</span></span>
<span data-line=""><span>]</span></span></code></pre></figure>
<p>In this example, the first operation adds a <code>name</code> field with the value <code>Alice</code>
to the root of the document, and the second operation replaces the existing
<code>age</code> field with a new value.</p>
<p>The resulting JSON</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>{</span></span>
<span data-line=""><span>  &#34;name&#34;</span><span>: </span><span>&#34;Alice&#34;</span><span>,</span></span>
<span data-line=""><span>  &#34;age&#34;</span><span>: </span><span>30</span></span>
<span data-line=""><span>}</span></span></code></pre></figure>
<p>JSON Patch allows the following operations:</p>
<ul>
<li><strong>Add</strong> a value to an object/array</li>
<li><strong>Remove</strong> a value from an object or array</li>
<li><strong>Replace</strong> a value (essentially Remove + Add)</li>
<li><strong>Copy</strong> a value from one location to another</li>
<li><strong>Move</strong> a value from one location to another (essentially a Copy + Remove)</li>
<li><strong>Test</strong> if a value is set at a particular path in the JSON document</li>
</ul>

<p>In the example above, you might have been confused by how we determined the
<code>path</code> to use. JSON Patch relies on another standard called
<a href="https://datatracker.ietf.org/doc/html/rfc6901">JSON Pointer</a> to define the path
to the part of the JSON document being modified. A JSON Pointer is a string of
tokens separated by slashes (<code>/</code>), with each token identifying a level in the
document&#39;s hierarchy.</p>
<p>Here&#39;s an example JSON document and corresponding JSON Pointer:</p>
<p>JSON Document:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>{</span></span>
<span data-line=""><span>  &#34;user&#34;</span><span>: {</span></span>
<span data-line=""><span>    &#34;name&#34;</span><span>: </span><span>&#34;Bob&#34;</span><span>,</span></span>
<span data-line=""><span>    &#34;age&#34;</span><span>: </span><span>25</span><span>,</span></span>
<span data-line=""><span>    &#34;friends&#34;</span><span>: [</span><span>&#34;Alice&#34;</span><span>, </span><span>&#34;John&#34;</span><span>]</span></span>
<span data-line=""><span>  }</span></span>
<span data-line=""><span>}</span></span></code></pre></figure>
<p>JSON Pointer: <code>/user/name</code></p>
<p>This pointer identifies the <code>name</code> field within the <code>user</code> object. You can refer
to an array&#39;s entries by their index (ex. <code>/user/friends/0</code> is Alice). The last
element in an array ca be referenced using <code>-</code> (ex. <code>/user/friends/-</code> is John).
If a property name contains <code>~</code>, then inside the pointer it must be escaped
using <code>~0</code>, or if contains <code>/</code> then it must be escaped using <code>~1</code>.</p>
<p>For more examples go to the
<a href="https://datatracker.ietf.org/doc/html/rfc6901">JSON Pointer specification page</a>
or <a href="https://opis.io/json-schema/2.x/pointers.html">this helpful guide</a>.</p>

<p>While JSON Patch is a flexible and powerful standard, it is not free of
pitfalls. Lets dive into the strengths and weaknesses of the JSON Patch format.</p>
<h3 id="strengths">Strengths<a href="#strengths"><span>#</span></a></h3>
<ol>
<li>
<p><strong>Precision</strong>: JSON Patch allows for precise modifications of a JSON
document. This means you can target specific elements in a complex structure
without affecting other parts of the document.</p>
</li>
<li>
<p><strong>Efficiency</strong>: Unlike sending the entire updated document, JSON Patch only
sends the changes. This minimizes data transmission and latency between
clients and servers.</p>
</li>
<li>
<p><strong>Atomicity</strong>: If a JSON Patch operation fails, the entire operation can be
rolled back. This ensures data integrity and prevents partial updates.</p>
</li>
<li>
<p><strong>Idempotency</strong>: JSON Patch operations can be safely retried without causing
unintended side effects. This is crucial for reliable distributed systems and
APIs.</p>
</li>
<li>
<p><strong>Complex Operations</strong>: JSON Patch supports intricate operations, such as
moving an element from one location to another within the same document. You
can also copy elements from one place and paste them elsewhere.</p>
</li>
<li>
<p><strong>Validation</strong>: APIs using JSON Patch can validate incoming patches to ensure
they conform to expected operations and structure, reducing the likelihood of
malformed requests.</p>
</li>
<li>
<p><strong>Standards-Based</strong>: JSON Patch is based on web standards, making it easier
to integrate with a wide range of clients and servers.</p>
</li>
<li>
<p><strong>Field-level Access Control</strong>: Despite being complex to implement, JSON
Patch provides the possibility to restrict modifications at a granular level,
ensuring only authorized changes are made.</p>
</li>
<li>
<p><strong>Batch Operations</strong>: Multiple changes can be bundled into a single JSON
Patch, efficiently handling concurrent updates in a single request. If you
are making calls to an external API that is rate limited, but supports JSON
Patch, you can concatenate all of your patches together at the API gateway
level and fire off a single request rather than multiple.</p>
</li>
</ol>
<h4 id="optimized-for-updates">Optimized for Updates<a href="#optimized-for-updates"><span>#</span></a></h4>
<p>JSON Patch only transmits the changes needed, minimizing payload size. This
makes it more efficient than sending entire JSON objects, reducing response
times and bandwidth.</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>HTTP/</span><span>1.1</span><span> PATCH</span></span>
<span data-line=""><span>Content-Type: application/json-patch+json</span></span>
<span data-line=""> </span>
<span data-line=""><span>[</span></span>
<span data-line=""><span>  {</span></span>
<span data-line=""><span>    &#34;op&#34;</span><span>: </span><span>&#34;replace&#34;</span><span>,</span></span>
<span data-line=""><span>    &#34;path&#34;</span><span>: </span><span>&#34;/id&#34;</span><span>,</span></span>
<span data-line=""><span>    &#34;value&#34;</span><span>: </span><span>&#34;123456&#34;</span></span>
<span data-line=""><span>  }</span></span>
<span data-line=""><span>]</span></span></code></pre></figure>
<p>vs</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>HTTP/</span><span>1.1</span><span> POST</span></span>
<span data-line=""><span>Content-Type: application/json</span></span>
<span data-line=""> </span>
<span data-line=""><span>{</span></span>
<span data-line=""><span>  &#34;id&#34;</span><span>: </span><span>&#34;123456&#34;</span><span>,</span></span>
<span data-line=""><span>  &#34;firstName&#34;</span><span>: </span><span>&#34;John&#34;</span><span>,</span></span>
<span data-line=""><span>  &#34;lastName&#34;</span><span>: </span><span>&#34;Doe&#34;</span><span>,</span></span>
<span data-line=""><span>  &#34;fullName&#34;</span><span>: </span><span>&#34;John Doe&#34;</span><span>,</span></span>
<span data-line=""><span>  &#34;age&#34;</span><span>: </span><span>21</span><span>,</span></span>
<span data-line=""><span>  &#34;country&#34;</span><span>: </span><span>&#34;United States&#34;</span><span>,</span></span>
<span data-line=""><span>  &#34;state&#34;</span><span>: </span><span>&#34;California&#34;</span><span>,</span></span>
<span data-line=""><span>  &#34;city&#34;</span><span>: </span><span>&#34;Redwood City&#34;</span><span>,</span></span>
<span data-line=""><span>  &#34;zip&#34;</span><span>: </span><span>&#34;94063&#34;</span></span>
<span data-line=""><span>}</span></span></code></pre></figure>
<p>Notice how much smaller the first request is?</p>
<h3 id="weaknesses">Weaknesses<a href="#weaknesses"><span>#</span></a></h3>
<ol>
<li>
<p><strong>Complexity</strong>: JSON Patch can be intricate, especially when dealing with
complex JSON structures. This typically requires developers to rely on an
external library to handle to parsing and application of JSON Patches, which
can also introduce security and maintenance issues.</p>
</li>
<li>
<p><strong>Maintenance Costs</strong>: As APIs evolve, the paths specified in JSON Patches
might become obsolete, leading to maintenance overhead.</p>
</li>
<li>
<p><strong>Debugging Difficulty</strong>: Tracing changes in JSON Patch can be challenging,
especially if multiple operations are batched together. Sending over the
entire object with a POST gives you a snapshot through the request body,
where as a PATCH requires you to have knowledge of the state of the JSON
document before it was applied</p>
</li>
<li>
<p><strong>Preservation of Object Order</strong>: JSON Patch&#39;s move operations don&#39;t
guarantee the order of objects, which might necessitate supplementary
operations to reorganize elements.</p>
</li>
<li>
<p><strong>Security Concerns</strong>: Improper handling of JSON Patch requests can open up
vulnerabilities. For example, if an API doesn&#39;t properly validate a move or
remove operation, it could result in unintended data loss or exposure.</p>
</li>
</ol>

<p>Below are examples of each JSON Patch operation, alongside the resulting JSON.
Let&#39;s start with the following document:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>{</span></span>
<span data-line=""><span>  &#34;user&#34;</span><span>: {</span></span>
<span data-line=""><span>    &#34;name&#34;</span><span>: </span><span>&#34;Bob&#34;</span><span>,</span></span>
<span data-line=""><span>    &#34;age&#34;</span><span>: </span><span>25</span></span>
<span data-line=""><span>  }</span></span>
<span data-line=""><span>}</span></span></code></pre></figure>
<ol>
<li>
<p><strong>Add</strong></p>
<p>JSON Patch:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>{ </span><span>&#34;op&#34;</span><span>: </span><span>&#34;add&#34;</span><span>, </span><span>&#34;path&#34;</span><span>: </span><span>&#34;/email&#34;</span><span>, </span><span>&#34;value&#34;</span><span>: </span><span>&#34;bob@example.com&#34;</span><span> }</span></span></code></pre></figure>
<p>After:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>{</span></span>
<span data-line=""><span>  &#34;user&#34;</span><span>: {</span></span>
<span data-line=""><span>    &#34;name&#34;</span><span>: </span><span>&#34;Bob&#34;</span><span>,</span></span>
<span data-line=""><span>    &#34;age&#34;</span><span>: </span><span>25</span></span>
<span data-line=""><span>  },</span></span>
<span data-line=""><span>  &#34;email&#34;</span><span>: </span><span>&#34;bob@example.com&#34;</span></span>
<span data-line=""><span>}</span></span></code></pre></figure>
</li>
<li>
<p><strong>Remove</strong></p>
<p>JSON Patch:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>{ </span><span>&#34;op&#34;</span><span>: </span><span>&#34;remove&#34;</span><span>, </span><span>&#34;path&#34;</span><span>: </span><span>&#34;/user/age&#34;</span><span> }</span></span></code></pre></figure>
<p>After:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>{</span></span>
<span data-line=""><span>  &#34;user&#34;</span><span>: {</span></span>
<span data-line=""><span>    &#34;name&#34;</span><span>: </span><span>&#34;Bob&#34;</span></span>
<span data-line=""><span>  }</span></span>
<span data-line=""><span>}</span></span></code></pre></figure>
</li>
<li>
<p><strong>Replace</strong></p>
<p>JSON Patch:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>{ </span><span>&#34;op&#34;</span><span>: </span><span>&#34;replace&#34;</span><span>, </span><span>&#34;path&#34;</span><span>: </span><span>&#34;/user/name&#34;</span><span>, </span><span>&#34;value&#34;</span><span>: </span><span>&#34;Alice&#34;</span><span> }</span></span></code></pre></figure>
<p>After:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>{</span></span>
<span data-line=""><span>  &#34;user&#34;</span><span>: {</span></span>
<span data-line=""><span>    &#34;name&#34;</span><span>: </span><span>&#34;Alice&#34;</span><span>,</span></span>
<span data-line=""><span>    &#34;age&#34;</span><span>: </span><span>25</span></span>
<span data-line=""><span>  }</span></span>
<span data-line=""><span>}</span></span></code></pre></figure>
</li>
<li>
<p><strong>Move</strong></p>
<p>JSON Patch:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>{ </span><span>&#34;op&#34;</span><span>: </span><span>&#34;move&#34;</span><span>, </span><span>&#34;from&#34;</span><span>: </span><span>&#34;/user/age&#34;</span><span>, </span><span>&#34;path&#34;</span><span>: </span><span>&#34;/user/birthYear&#34;</span><span> }</span></span></code></pre></figure>
<p>After:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>{</span></span>
<span data-line=""><span>  &#34;user&#34;</span><span>: {</span></span>
<span data-line=""><span>    &#34;name&#34;</span><span>: </span><span>&#34;Alice&#34;</span><span>,</span></span>
<span data-line=""><span>    &#34;birthYear&#34;</span><span>: </span><span>25</span></span>
<span data-line=""><span>  }</span></span>
<span data-line=""><span>}</span></span></code></pre></figure>
</li>
<li>
<p><strong>Copy</strong></p>
<p>JSON Patch:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>{ </span><span>&#34;op&#34;</span><span>: </span><span>&#34;copy&#34;</span><span>, </span><span>&#34;from&#34;</span><span>: </span><span>&#34;/user/name&#34;</span><span>, </span><span>&#34;path&#34;</span><span>: </span><span>&#34;/displayName&#34;</span><span> }</span></span></code></pre></figure>
<p>After:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>{</span></span>
<span data-line=""><span>  &#34;user&#34;</span><span>: {</span></span>
<span data-line=""><span>    &#34;name&#34;</span><span>: </span><span>&#34;Alice&#34;</span><span>,</span></span>
<span data-line=""><span>    &#34;birthYear&#34;</span><span>: </span><span>25</span></span>
<span data-line=""><span>  },</span></span>
<span data-line=""><span>  &#34;displayName&#34;</span><span>: </span><span>&#34;Alice&#34;</span></span>
<span data-line=""><span>}</span></span></code></pre></figure>
</li>
<li>
<p><strong>Test</strong></p>
<p>JSON Patch:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>{ </span><span>&#34;op&#34;</span><span>: </span><span>&#34;test&#34;</span><span>, </span><span>&#34;path&#34;</span><span>: </span><span>&#34;/displayName&#34;</span><span>, </span><span>&#34;value&#34;</span><span>: </span><span>&#34;Alice&#34;</span><span> }</span></span></code></pre></figure>
<p>If the test operation succeeds, it has no effect on the document. If it
fails, the entire patch is considered unsuccessful.</p>
</li>
</ol>

<p>JSON Patch is widely used in API development and is supported by various
libraries in different programming languages. Here are some examples:</p>
<h3 id="libraries">Libraries<a href="#libraries"><span>#</span></a></h3>
<ul>
<li>
<p><a href="https://www.npmjs.com/package/fast-json-patch">fast-json-patch</a>: A Javascript
node JS package for generating and applying JSON patches.</p>
</li>
<li>
<p><a href="https://github.com/stefankoegl/python-json-patch">python-json-patch</a>: Library
to apply JSON Patches in Python.</p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/aspnet/core/web-api/jsonpatch?view=aspnetcore-7.0">JsonPatch library in .NET</a>:
A C# implementation of JSON Patch.</p>
</li>
</ul>
<p>If you use a different languauge, here&#39;s a more
<a href="https://github.com/dharmafly/jsonpatch.com/blob/gh-pages/index.md#libraries">complete list of libraries</a>.</p>
<h3 id="tools">Tools<a href="#tools"><span>#</span></a></h3>
<p>A great tool for learning JSON Patch is <a href="https://jsonpatch.me/">jsonpatch.me</a> -
a free online service for running JSON Patch commands. It even has an API!</p>

<p>If you are working on a client (ex. a React form), you will want to generate a
changeset client-side and send it to your API. To generate a JSON Patch change
set, a library like <code>fast-json-patch</code> can be used. Here&#39;s a simple example:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="typescript" data-theme="github-dark"><code data-language="typescript" data-theme="github-dark"><span data-line=""><span>import</span><span> *</span><span> as</span><span> jsonpatch </span><span>from</span><span> &#34;fast-json-patch&#34;</span><span>;</span></span>
<span data-line=""> </span>
<span data-line=""><span>const</span><span> originalDoc</span><span> =</span><span> {</span></span>
<span data-line=""><span>  firstName: </span><span>&#34;Albert&#34;</span><span>,</span></span>
<span data-line=""><span>  contactDetails: { phoneNumbers: [] },</span></span>
<span data-line=""><span>};</span></span>
<span data-line=""><span>const</span><span> modifiedDoc</span><span> =</span><span> {</span></span>
<span data-line=""><span>  firstName: </span><span>&#34;Joachim&#34;</span><span>,</span></span>
<span data-line=""><span>  contactDetails: { phoneNumbers: [] },</span></span>
<span data-line=""><span>};</span></span>
<span data-line=""> </span>
<span data-line=""><span>// Generate the JSON Patch</span></span>
<span data-line=""><span>const</span><span> patch</span><span> =</span><span> jsonpatch.</span><span>compare</span><span>(originalDoc, modifiedDoc);</span></span>
<span data-line=""> </span>
<span data-line=""><span>console.</span><span>log</span><span>(patch);</span></span>
<span data-line=""> </span>
<span data-line=""><span>// Send the patch to the server</span></span>
<span data-line=""><span>const</span><span> headers</span><span> =</span><span> new</span><span> Headers</span><span>({</span></span>
<span data-line=""><span>  // This content-type is specified in the spec</span></span>
<span data-line=""><span>  // and is useful for the server to validate</span></span>
<span data-line=""><span>  &#34;content-type&#34;</span><span>: </span><span>&#34;application/json-patch+json&#34;</span><span>,</span></span>
<span data-line=""><span>});</span></span>
<span data-line=""><span>await</span><span> fetch</span><span>(</span><span>&#34;https://your-backend.com/foo&#34;</span><span>, { method: </span><span>&#34;PATCH&#34;</span><span>, headers });</span></span></code></pre></figure>
<p>This code outputs the necessary patch document to convert the original document
into the modified document:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="json" data-theme="github-dark"><code data-language="json" data-theme="github-dark"><span data-line=""><span>[{ </span><span>&#34;op&#34;</span><span>: </span><span>&#34;replace&#34;</span><span>, </span><span>&#34;path&#34;</span><span>: </span><span>&#34;/firstName&#34;</span><span>, </span><span>&#34;value&#34;</span><span>: </span><span>&#34;Joachim&#34;</span><span> }]</span></span></code></pre></figure>

<p>To handle a PATCH request that includes a JSON Patch document, the
<code>fast-json-patch</code> library can be used again. Here&#39;s an example using express as
your server framework:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="typescript" data-theme="github-dark"><code data-language="typescript" data-theme="github-dark"><span data-line=""><span>const</span><span> express</span><span> =</span><span> require</span><span>(</span><span>&#34;express&#34;</span><span>);</span></span>
<span data-line=""><span>const</span><span> { </span><span>applyPatch</span><span> } </span><span>=</span><span> require</span><span>(</span><span>&#34;fast-json-patch&#34;</span><span>);</span></span>
<span data-line=""><span>const</span><span> bodyParser</span><span> =</span><span> require</span><span>(</span><span>&#34;body-parser&#34;</span><span>);</span></span>
<span data-line=""> </span>
<span data-line=""><span>const</span><span> app</span><span> =</span><span> express</span><span>();</span></span>
<span data-line=""><span>app.</span><span>use</span><span>(bodyParser.</span><span>json</span><span>());</span></span>
<span data-line=""> </span>
<span data-line=""><span>let</span><span> document </span><span>=</span><span> { firstName: </span><span>&#34;Albert&#34;</span><span>, contactDetails: { phoneNumbers: [] } };</span></span>
<span data-line=""> </span>
<span data-line=""><span>app.</span><span>patch</span><span>(</span><span>&#34;/&#34;</span><span>, (</span><span>req</span><span>, </span><span>res</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span data-line=""><span>  try</span><span> {</span></span>
<span data-line=""><span>    document </span><span>=</span><span> applyPatch</span><span>(document, req.body);</span></span>
<span data-line=""><span>    res.</span><span>status</span><span>(</span><span>200</span><span>).</span><span>json</span><span>(document);</span></span>
<span data-line=""><span>  } </span><span>catch</span><span> (error) {</span></span>
<span data-line=""><span>    res.</span><span>status</span><span>(</span><span>400</span><span>).</span><span>send</span><span>(</span><span>&#34;Invalid JSON Patch document&#34;</span><span>);</span></span>
<span data-line=""><span>  }</span></span>
<span data-line=""><span>});</span></span>
<span data-line=""> </span>
<span data-line=""><span>app.</span><span>listen</span><span>(</span><span>3000</span><span>, () </span><span>=&gt;</span><span> {</span></span>
<span data-line=""><span>  console.</span><span>log</span><span>(</span><span>&#34;Server is running on port 3000&#34;</span><span>);</span></span>
<span data-line=""><span>});</span></span></code></pre></figure>
<p>This server listens for PATCH requests and applies the provided JSON Patch
document to an existing resource.</p>

<p>As mentioned in the risks of JSON patch, a malformed or malicious request body
sent to your API can cause data loss or other unintended consequences. That&#39;s
why its important to
<a href="https://zuplo.com/blog/2024/07/19/verify-json-schema">validate the request body</a>. It&#39;s typically
best to validate the request body using an API Gateway (ex. Zuplo) so the
validation can be applied consistently across all of your Patch endpoints, and
be executed in a faster runtime. Here&#39;s three ways to do it:</p>
<h3 id="traditional-using-ajv--json-schema">Traditional: Using AJV + JSON Schema<a href="#traditional-using-ajv--json-schema"><span>#</span></a></h3>
<p>To simply validate a JSON Patch request body, the <a href="https://ajv.js.org/">AJV</a>
library and a JSON schema can be used:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="typescript" data-theme="github-dark"><code data-language="typescript" data-theme="github-dark"><span data-line=""><span>const</span><span> Ajv</span><span> =</span><span> require</span><span>(</span><span>&#34;ajv&#34;</span><span>);</span></span>
<span data-line=""><span>const</span><span> schema</span><span> =</span><span> require</span><span>(</span><span>&#34;json.schemastore.org/json-patch&#34;</span><span>);</span></span>
<span data-line=""> </span>
<span data-line=""><span>const</span><span> ajv</span><span> =</span><span> new</span><span> Ajv</span><span>();</span></span>
<span data-line=""><span>const</span><span> validate</span><span> =</span><span> ajv.</span><span>compile</span><span>(schema);</span></span>
<span data-line=""> </span>
<span data-line=""><span>const</span><span> patch</span><span> =</span><span> [{ op: </span><span>&#34;replace&#34;</span><span>, path: </span><span>&#34;/firstName&#34;</span><span>, value: </span><span>&#34;Joachim&#34;</span><span> }];</span></span>
<span data-line=""> </span>
<span data-line=""><span>if</span><span> (</span><span>validate</span><span>(patch)) {</span></span>
<span data-line=""><span>  console.</span><span>log</span><span>(</span><span>&#34;Valid Patch&#34;</span><span>);</span></span>
<span data-line=""><span>} </span><span>else</span><span> {</span></span>
<span data-line=""><span>  console.</span><span>log</span><span>(</span><span>&#34;Invalid Patch&#34;</span><span>, validate.errors);</span></span>
<span data-line=""><span>  // Return a 400 error</span></span>
<span data-line=""><span>}</span></span></code></pre></figure>
<p>This code validates a JSON Patch document against a JSON schema and prints
<code>Valid Patch</code> if the document is valid. This does not ensure sensitive data
isn&#39;t tampered with.</p>
<h3 id="simpler-using-zuplo--openapi">Simpler: Using Zuplo + OpenAPI<a href="#simpler-using-zuplo--openapi"><span>#</span></a></h3>
<p>A simpler way of implementing the same validation as above is by adding the
<a href="https://json.schemastore.org/json-patch">JSON Schema for JSON Patch</a> directly
into your OpenAPI file in your Zuplo API Gateway. Then you can add the
<a href="https://zuplo.com/docs/policies/request-validation-inbound">Request Validation policy</a> directly
to all of your PATCH endpoints. The policy will automatically return an HTTP 400
error using the
<a href="https://zuplo.com/blog/2023/04/11/the-power-of-problem-details">Problem Details format</a>. Here&#39;s a
<a href="https://zuplo.com/blog/2024/07/10/adding-dev-portal-and-request-validation-firebase#step-5-adding-request-validation">step-by-step guide</a>
if you&#39;re unfamiliar with Zuplo. Side-benefit is that you now have a fully
documented OpenAPI file, complete with schemas.</p>
<h3 id="advanced-using-fast-json-patch">Advanced: Using <code>fast-json-patch</code><a href="#advanced-using-fast-json-patch"><span>#</span></a></h3>
<p>We can actually reuse the <code>fast-json-patch</code> library in our API to validate the
request body, and even add additional <code>test</code> operations within the patch to
ensure certain invariants aren&#39;t violated.</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="typescript" data-theme="github-dark"><code data-language="typescript" data-theme="github-dark"><span data-line=""><span>import</span><span> *</span><span> as</span><span> fastJsonPatch </span><span>from</span><span> &#34;fast-json-patch&#34;</span><span>;</span></span>
<span data-line=""> </span>
<span data-line=""><span>const</span><span> patch</span><span> =</span><span> [{ op: </span><span>&#34;replace&#34;</span><span>, path: </span><span>&#34;/firstName&#34;</span><span>, value: </span><span>&#34;Joachim&#34;</span><span> }];</span></span>
<span data-line=""> </span>
<span data-line=""><span>// Add invariants to safeguard the firstName property</span></span>
<span data-line=""><span>patch.</span><span>push</span><span>({</span></span>
<span data-line=""><span>  op: </span><span>&#34;test&#34;</span><span>,</span></span>
<span data-line=""><span>  path: </span><span>&#34;/firstName&#34;</span><span>,</span></span>
<span data-line=""><span>  value: originalDocument.firstName,</span></span>
<span data-line=""><span>});</span></span>
<span data-line=""><span>const</span><span> errors</span><span> =</span><span> fastJsonPatch.</span><span>validate</span><span>(patch, originalDocument);</span></span>
<span data-line=""> </span>
<span data-line=""><span>if</span><span> (errors </span><span>===</span><span> undefined</span><span>) {</span></span>
<span data-line=""><span>  // there are no errors!</span></span>
<span data-line=""><span>} </span><span>else</span><span> {</span></span>
<span data-line=""><span>  console.</span><span>log</span><span>(</span><span>`Error ${</span><span>errors</span><span>.</span><span>name</span><span>}: ${</span><span>errors</span><span>.</span><span>message</span><span>}`</span><span>);</span></span>
<span data-line=""><span>  console.</span><span>log</span><span>(</span><span>&#34;at&#34;</span><span>, errors[</span><span>0</span><span>].operation); </span><span>// ex. {op: &#39;replace&#39;, path: &#39;/firstName&#39;, value: &#39;Joachim&#39;}</span></span>
<span data-line=""><span>}</span></span></code></pre></figure>
<p>The above code can be run within a
<a href="https://zuplo.com/docs/policies/custom-code-inbound">Custom Code Inbound Policy</a> in Zuplo and
easily applied to all of your Patch endpoints.</p>

<p><a href="https://zuplo.com/blog/2024/10/11/what-is-json-merge-patch">JSON Merge Patch</a> is a recently
proposed alternative to JSON Patch that seeks to simplify the interface for
specifying changes. Check out our
<a href="https://zuplo.com/blog/2024/10/14/json-patch-vs-json-merge-patch">JSON Patch vs JSON Merge Patch comparison</a>
to learn more.</p>

<p>JSON Patch is a powerful and efficient way to perform partial updates on JSON
documents. By understanding how it works and how to implement it, developers can
build more efficient APIs and applications that send less data over the network
and process updates more quickly. If you&#39;re looking to implement JSON Patch
across your APIs or just want to modernize your APIs more generally, and want
advice from an API expert - <a href="https:?utm_source=blog">get in touch</a>.</p></article></section></div></div></div>
  </body>
</html>
