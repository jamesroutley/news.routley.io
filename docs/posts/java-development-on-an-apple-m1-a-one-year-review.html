<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://rieckpil.de/java-development-on-an-apple-m1-a-one-year-review/">Original</a>
    <h1>Java Development on an Apple M1 – A One Year Review</h1>
    
    <div id="readability-page-1" class="page"><div id="content"> <div>  <div id="theme-content-section"><div> <div data-css="tve-u-17c74cad69e"><p>Last Updated:  <span data-attr-date-format="F j, Y" data-attr-date-format-select="F j, Y" data-attr-link="0" data-attr-rel="0" data-attr-show-time="0" data-attr-target="1" data-attr-time-format="" data-attr-time-format-select="g:i a" data-attr-type="modified" data-extra_key="" data-option-inline="1" data-shortcode="tcb_post_published_date" data-shortcode-name="Post date" data-css="tve-u-17c74c8c070">March 25, 2022 </span>| Published: <span data-extra_key="" data-option-inline="1" data-attr-date-format="F j, Y" data-attr-date-format-select="F j, Y" data-attr-show-time="0" data-attr-time-format="" data-attr-time-format-select="g:i a" data-attr-type="published" data-shortcode="tcb_post_published_date" data-shortcode-name="Post date" data-css="tve-u-17c74c8c074">March 25, 2022 </span></p></div><section data-css="tve-u-17724e3dc87"><p>It&#39;s been almost a year since I&#39;ve bought the MacBook Pro M1 (<code>arm64</code> processor) for my daily Java development as a freelance consultant. I had my first contact with the Apple M1 when one of my course students raised an issue that the build doesn&#39;t pass on Apple&#39;s new flagship laptop. I was first shocked to encounter hardware incompatibilities in 2021. To solve those problems (not my main intent, but I told myself so) and experience if that processor is really that fast, I decided to buy the MacBook Pro.</p> <p>This article will share my initial pitfalls when working with the Apple M1 and a collection of valuable tricks and workarounds for developing and testing Java applications.</p> <p>Note: Throughout this article, both <code>arm64</code> or <code>aarch64</code> refer to the Apple M1 chip. I&#39;ll refer to the traditional Intel/AMD processors as <code>x64</code>  (you may find the following synonyms: <code>x86_64</code>, <code>amd64</code>).</p> <h2>Installing Java Development Tools</h2> <p>The first thing we install as Java developers on a new machine is a JDK. While searching for a <code>arm64</code> compatible JDK back in 2021, the <a href="https://www.azul.com/downloads/?architecture=arm-64-bit&amp;package=jdk">Azul Zulu JDK</a> build popped up first.</p> <p>There&#39;s no difference in the installation process of a JDK compared to an <code>x64</code> Mac. Once we&#39;ve downloaded and installed a compatible JDK build, we have the baseline for our Java development for our Apple M1:</p> <div id="urvanov-syntax-highlighter-623e050a0277d894577488" data-settings=" minimize scroll-mouseover">    <div> <table> <tbody><tr> <td data-settings="show">  </td> <td><div><p><span>java</span><span> </span><span>-</span><span>version</span></p><p><span>openjdk </span><span>version</span><span> </span><span>&#34;17&#34;</span><span> </span><span>2021</span><span>-</span><span>09</span><span>-</span><span>14</span><span> </span><span>LTS</span></p><p><span>OpenJDK </span><span>Runtime </span><span>Environment </span><span>Zulu17</span><span>.</span><span>28</span><span>+</span><span>13</span><span>-</span><span>CA</span><span> </span><span>(</span><span>build</span><span> </span><span>17</span><span>+</span><span>35</span><span>-</span><span>LTS</span><span>)</span></p><p><span>OpenJDK</span><span> </span><span>64</span><span>-</span><span>Bit </span><span>Server </span><span>VM </span><span>Zulu17</span><span>.</span><span>28</span><span>+</span><span>13</span><span>-</span><span>CA</span><span> </span><span>(</span><span>build</span><span> </span><span>17</span><span>+</span><span>35</span><span>-</span><span>LTS</span><span>,</span><span> </span><span>mixed </span><span>mode</span><span>,</span><span> </span><span>sharing</span><span>)</span></p></div></td> </tr> </tbody></table> </div> </div> <p>Apart from the Azul Zulu JDK, many other JDK vendors have followed and now offer an arm64 build:</p> <ul> <li><a href="https://aws.amazon.com/corretto/">Amazon Corretto</a></li> <li><a href="https://adoptium.net/releases.html">Eclipse Temurin</a> (Adoptium project, former AdoptOpenJDK)</li> <li><a href="https://docs.microsoft.com/en-us/java/openjdk/download">Microsoft&#39;s build</a> of the OpenJDK</li> <li>etc.</li> </ul> <p>The <a href="https://formulae.brew.sh/formula/openjdk">brew formula for openjdk</a> is also installing a compatible Apple M1 JDK build. For managing different Java versions, <a href="https://sdkman.io/">sdkman</a> or <a href="https://www.jenv.be/">jEnv</a> is an excellent option.</p> <p>With Apple&#39;s Rosetta 2 emulation, we can also try to work with an <code>x64</code> JDK build. However, we may run into issues and/or won&#39;t get the expected performance.</p> <p>What&#39;s next is Docker. Installing a recent Docker for Mac version comes with Apple M1 support. In the early days, there were some minor issues. But having worked with it for almost a year now, many have been continuously fixed.</p> <p>All other development tools that we use on a daily basis either provide an <code>arm64</code> build or the emulated <code>x64</code> version works fine: IntelliJ IDEA, Visual Studio Code, Slack, Notion, Docker for Mac, Spotify, Firefox, Microsoft Teams, Postman.</p> <p>Rule one: Whenever there&#39;s a native <code>arm64</code> build of any development tool for the M1, go for it. Only try to get the <code>x64</code> build running if there&#39;s no <code>arm64</code> build available (yet).</p> <p>To further verify the compatibility and optimization for various other tools for Apple&#39;s M1, checkout out <a href="https://isapplesiliconready.com">isapplesiliconready</a>.</p> <h2>Integration Tests with Docker and Testcontainers</h2> <p>When it comes to <a href="https://rieckpil.de/howto-write-spring-boot-integration-tests-with-a-real-database/">running our integration tests that use Testcontainers</a>, the first thing we stumble over with our M1 machine are potential test failures because of missing <code>arm64</code> platform support.</p> <p>Docker images are built for specific processor architectures. We can identify the available platforms by looking at the OS/Arch column on Docker Hub for a particular Docker image:</p> <p><img alt="Docker Hub Image Platform Example" width="1000" height="142" nitro-lazy-src="https://cdn-aoloc.nitrocdn.com/LjZAnpMBiKRdWkhommfnyugsAOnHWdxL/assets/static/optimized/rev-a10598f/wp-content/uploads/2022/03/keycloak-docker-image-platform-example-e1648014799552.png" nitro-lazy-empty="" id="Njc3OjI0NQ==-1" src="data:image/svg+xml;nitro-empty-id=Njc3OjI0NQ==-1;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTAwMCAxNDIiIHdpZHRoPSIxMDAwIiBoZWlnaHQ9IjE0MiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48L3N2Zz4="/></p> <p>The example above is a screenshot of the official <a href="https://hub.docker.com/r/jboss/keycloak/tags">Keycloak Docker image</a>. It only comes with support for <code>x64</code> machines.</p> <p>If we try to run this Docker image on our <code>arm64</code> Apple M1 machine, we get the following warning:</p> <div id="urvanov-syntax-highlighter-623e050a02785260110174" data-settings=" minimize scroll-mouseover">    <div> <table> <tbody><tr> <td data-settings="show">  </td> <td><div><p>$ docker run jboss/keycloak:16.1.1</p><p>WARNING: The requested image&#39;s platform (linux/amd64) does not match the detected host platform (linux/arm64/v8) and no specific platform was requested</p></div></td> </tr> </tbody></table> </div> </div> <p>While we get past this warning and Docker tries to run an image for a different platform, it internally <a href="https://docs.docker.com/desktop/mac/apple-silicon/">uses emulation</a> to try to get the x64 container up and running. However, this emulation for <code>x64</code> support for <code>arm64</code> is a best effort.</p> <p>Images for a different platform may or may not work on our Apple M1. There&#39;s no guarantee that the container will start and function as expected.</p> <p>The Keycloak image, for example, unfortunately, crashes during the bootstrap phase:</p> <div id="urvanov-syntax-highlighter-623e050a02786724910766" data-settings=" minimize scroll-mouseover">    <div> <table> <tbody><tr> <td data-settings="show">  </td> <td><div><p>#</p><p>[thread 378 also had an error]</p><p>[thread 374 also had an error]</p><p># A fatal error has been detected by the Java Runtime Environment:</p><p>#</p><p>#  [thread 381 also had an error]</p><p>[thread 331 also had an error]</p><p>[thread 372 also had an error]</p><p>[thread 377 also had an error]</p><p>SIGSEGV (0xb) at pc=0x000000401de90af2, pid=310, tid=334</p><p>#</p><p># JRE version: OpenJDK Runtime Environment 18.9 (11.0.14+9) (build 11.0.14+9-LTS)</p><p># Java VM: OpenJDK 64-Bit Server VM 18.9 (11.0.14+9-LTS, mixed mode, sharing, tiered, compressed oops, g1 gc, linux-amd64)</p><p># Problematic frame:</p><p># J 546 c2 java.lang.AbstractStringBuilder.append(Ljava/lang/String;)Ljava/lang/AbstractStringBuilder;</p></div></td> </tr> </tbody></table> </div> </div> <p>When running our test suite for the first time on an Apple M1, we have to identify the Docker containers that fail to start.</p> <p>If the image itself doesn&#39;t provide arm64 support, we can look for an alternative. For the most commonly used Docker images, these are potential alternatives:</p> <ul> <li><strong>PostgreSQL</strong>: The standard images come with <code>arm64</code> support, no changes required</li> <li><strong>Webdriver</strong> <strong>images</strong>: Standalone arm64 support comes with <a href="https://hub.docker.com/u/seleniarm">seleniarm images</a></li> <li><strong>Keycloak</strong>: No arm64 build for the jboss variant, however, there are community multi-architecture builds (<a href="https://github.com/richardjkendall/keycloak-arm">richardjkendall</a> or <a href="https://hub.docker.com/r/mihaibob/keycloak">mihaibob</a>) available</li> <li><strong>LocalStack</strong>: Starting with version 0.13, LocalStack publishes multi-architecture Docker images</li> <li><strong>MySQL</strong>: Starting with version 8, the oracle version provides an arm64 build. Another alternative is the <a href="https://hub.docker.com/_/mariadb?tab=tags&amp;page=1&amp;ordering=last_updated">MariaDB image</a></li> <li><strong>MongoDB</strong>: The standard images come with <code>arm64</code> support, no changes required</li> <li><strong>Kafka</strong>: No <code>arm64</code> build for the bitnami image, but the <a href="https://hub.docker.com/r/wurstmeister/kafka/tags">wurstmeister</a> build supports <code>arm64</code></li> </ul> <h2>Dynamically Replace Docker Images For ARM64 Support</h2> <p>Whenever we find ourselves looking for an alternative to the default Testcontainers Docker image, we need to override the default image. If we&#39;re working on a project on our own or know that the entire team is using an <code>arm64</code> processor, we can hardcode the <code>arm64</code> compatible Docker image. Otherwise, we can make the image substitution more dynamic and only replace the Docker image when running on the specific architecture.</p> <p>Let&#39;s use the Selenium Webdriver container as an example for a dynamic override:</p> <div id="urvanov-syntax-highlighter-623e050a02787596718638" data-settings=" minimize scroll-mouseover">    <div> <table> <tbody><tr> <td data-settings="show">  </td> <td><div><p><span>@Container</span></p><p><span>static</span><span> </span><span>BrowserWebDriverContainer</span><span>&lt;</span><span>?</span><span>&gt;</span><span> </span><span>webDriverContainer</span><span> </span><span>=</span></p><p><span>  </span><span>new</span><span> </span><span>BrowserWebDriverContainer</span><span>&lt;&gt;</span><span>(</span></p><p><span>    </span><span>System</span><span>.</span><span>getProperty</span><span>(</span><span>&#34;os.arch&#34;</span><span>)</span><span>.</span><span>equals</span><span>(</span><span>&#34;aarch64&#34;</span><span>)</span><span> </span><span>?</span></p><p><span>      </span><span>DockerImageName</span><span>.</span><span>parse</span><span>(</span><span>&#34;seleniarm/standalone-chromium&#34;</span><span>)</span></p><p><span>        </span><span>.</span><span>asCompatibleSubstituteFor</span><span>(</span><span>&#34;selenium/standalone-chrome&#34;</span><span>)</span></p><p><span>      </span><span>:</span><span> </span><span>DockerImageName</span><span>.</span><span>parse</span><span>(</span><span>&#34;selenium/standalone-chrome&#34;</span><span>)</span></p><p><span>  </span><span>)</span><span>.</span><span>withCapabilities</span><span>(</span><span>new</span><span> </span><span>ChromeOptions</span><span>(</span><span>)</span><span>)</span><span>;</span></p></div></td> </tr> </tbody></table> </div> </div> <p>Based on the system property <code>os.arch</code> we decided which image to use for our <code>BrowserWebDriverContainer</code>.</p> <p>As an alternative to this workaround, we can use <a href="https://www.atomicjar.com/2021/11/announcing-testcontainers-cloud/">Testcontainers Cloud</a>. With Testcontainers Cloud, we run the backing containers for our integration tests in the cloud. There&#39;s no change required for our test. The containers will just run on someone else machine. Since its private beta, <a href="https://www.atomicjar.com/2021/11/announcing-testcontainers-cloud/">I had the chance to demo</a> this amazing tool and am convinced that this will drive the productivity (e.g., faster builds) for testing with Testcontainers even further.</p> <p>As a last resort, we can also disable specific tests if they won&#39;t run at all on our M1 processor. Based on the <code>os.arch</code> Java system property we can detect the processor architecture and  use a JUnit Jupiter annotation to disable tests for our M1:</p> <div id="urvanov-syntax-highlighter-623e050a02788007748435" data-settings=" minimize scroll-mouseover">    <div> <table> <tbody><tr> <td data-settings="show">  </td> <td><div><p><span>@DisabledIfSystemProperty</span><span>(</span><span>named</span><span> </span><span>=</span><span> </span><span>&#34;os.arch&#34;</span><span>,</span><span> </span><span>matches</span><span> </span><span>=</span><span> </span><span>&#34;aarch64&#34;</span><span>,</span><span> </span><span>disabledReason</span><span> </span><span>=</span><span> </span><span>&#34;No ARM64 support&#34;</span><span>)</span></p><p><span>class</span><span> </span><span>SomeIT</span><span> </span><span>{</span></p><p><span>}</span></p></div></td> </tr> </tbody></table> </div> </div> <p>We can use this annotation on top of a test class or for a particular test. While this is not an optimal solution, at least it helps the Apple M1 developers on our team to see a green build.</p> <p>These test disabling annotations should be temporary. We must check if there&#39;s a solution available (e.g. a compatible Docker image) from time to time. The final build on our CI pipeline must ensure to run all tests (usually a <code>x64</code> machine).</p> <h2>Docker Client JNA Failure with Testcontainers</h2> <p>Another pitfall we may fall into before we can actually run our Java integration test with Testcontainers is the following error:</p> <div id="urvanov-syntax-highlighter-623e050a02791695475462" data-settings=" minimize scroll-mouseover">    <div> <table> <tbody><tr> <td data-settings="show">  </td> <td><div><p>06:49:41.241 [main] ERROR org.testcontainers.dockerclient.DockerClientProviderStrategy - Could not find a valid Docker environment. Please check configuration. Attempted configurations were:</p><p>06:49:41.241 [main] ERROR org.testcontainers.dockerclient.DockerClientProviderStrategy -     UnixSocketClientProviderStrategy: failed with exception RuntimeException </p><p>(java.lang.UnsatisfiedLinkError: /Users/rieckpil/Library/Caches/JNA/temp/jna11180227188626594160.tmp: dlopen(/Users/rieckpil/Library/Caches/JNA/temp/jna11180227188626594160.tmp, 0x0001): </p><p>tried: &#39;/Users/rieckpil/Library/Caches/JNA/temp/jna11180227188626594160.tmp&#39; (fat file, but missing compatible architecture (have &#39;i386,x86_64&#39;, need &#39;arm64e&#39;)), &#39;/usr/lib/jna11180227188626594160.tmp&#39;</p><p> (no such file)). Root cause UnsatisfiedLinkError (/Users/rieckpil/Library/Caches/JNA/temp/jna11180227188626594160.tmp: dlopen(/Users/rieckpil/Library/Caches/JNA/temp/jna11180227188626594160.tmp, 0x0001): </p><p>tried: &#39;/Users/rieckpil/Library/Caches/JNA/temp/jna11180227188626594160.tmp&#39; (fat file, but missing compatible architecture (have &#39;i386,x86_64&#39;, need &#39;arm64e&#39;)), &#39;/usr/lib/jna11180227188626594160.tmp&#39; (no such file))</p><p>06:49:41.241 [main] ERROR org.testcontainers.dockerclient.DockerClientProviderStrategy -     UnixSocketClientProviderStrategy: failed with exception RuntimeException (java.lang.NoClassDefFoundError: </p><p>Could not initialize class org.testcontainers.shaded.com.github.dockerjava.okhttp.UnixSocketFactory$1). Root cause NoClassDefFoundError (Could not initialize class org.testcontainers.shaded.com.github.dockerjava.okhttp.UnixSocketFactory$1)</p></div></td> </tr> </tbody></table> </div> </div> <p>The underlying issue is a JNA (Java Native Access) dependency incompatibility with Apple&#39;s M1 chip. Testcontainers transitively depends on this library. Starting with JNA 5.7.0, this issue is resolved.</p> <p>To fix this problem for our projects, we can either upgrade our Testcontainers version (preferred) or manually override the JNA version. Starting with Testcontainers 1.15.3, Tesctonainers transitively depends on a JNA version (5.7.0) that is working for the Apple M1.</p> <p>Suppose we still see the same test failure even after bumping the Testcontainers version. In that case, the chances are high that another dependency also transitively depends on JNA and overrides the version.</p> <p>In this situation, we can either exclude the JNA dependency from any other dependency that includes it or use the <code>dependencyManagement</code> section to force the resolution of a specific version of it:</p> <div id="urvanov-syntax-highlighter-623e050a02792370421280" data-settings=" minimize scroll-mouseover">    <div> <table> <tbody><tr> <td data-settings="show">  </td> <td><div><p><span>&lt;dependencyManagement&gt;</span></p><p><span>  </span><span>&lt;dependencies&gt;</span></p><p><span>    </span><span>&lt;dependency&gt;</span></p><p><span>      </span><span>&lt;groupId&gt;</span><span>net.java.dev.jna</span><span>&lt;/groupId&gt;</span></p><p><span>      </span><span>&lt;artifactId&gt;</span><span>jna</span><span>&lt;/artifactId&gt;</span></p><p><span>      </span><span>&lt;version&gt;</span><span>5.7.0</span><span>&lt;/version&gt;</span></p><p><span>    </span><span>&lt;/dependency&gt;</span></p><p><span>  </span><span>&lt;/dependencies&gt;</span></p><p><span>&lt;/dependencyManagement&gt;</span></p></div></td> </tr> </tbody></table> </div> </div> <p>To locate dependencies that transitively include JNA, run <code>mvn dependency:tree</code> and then search for JNA in the result.</p> <h2>Local Development Environment with Docker Compose</h2> <p>Many projects use a <code>docker-compose.yml</code> for running the required infrastructure when locally developing or testing a Java application.</p> <p>Depending on the amount and variety of required infrastructure (e.g., messaging queues, databases, caches, etc.), tweaking the <code>docker-compose.yml</code> to work for both <code>x64</code> and <code>arm64</code> may not be an option.</p> <p>The same Docker image <code>arm64</code> availability issue as for testing applies here. Sometimes the community Docker builds only support one platform and not both.</p> <p>As a possible workaround, we can introduce a second <code>docker-compose-arm64.yml</code> file to support team members working with an M1 (or any other <code>arm64</code> machine).</p> <p>I&#39;m using this concept for the <a href="https://rieckpil.de/testing-spring-boot-applications-masterclass/">Testing Spring Boot Application Masterclass</a>, where the Amazon SQS and Keycloak image needs to be replaced with an arm64 compatible image.</p> <p>This adds some small maintenance effort as the team has to keep the two Docker compose files in sync. However, as soon as the availability and adoption of <code>arm64</code> images is improving, the dedicated <code>arm64</code> Docker compose file can be deleted.</p> <div id="urvanov-syntax-highlighter-623e050a02795447272797" data-settings=" minimize scroll-mouseover">    <div> <table> <tbody><tr> <td data-settings="show"> <div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p></div> </td> <td><div><p><span>version</span><span>: &#39;3.8&#39;</span></p><p><span>services</span><span>:</span></p><p><span>  </span><span># ...</span></p><p><span>  </span><span>keycloak</span><span>:</span></p><p><span>    </span><span>image</span><span>: mihaibob/keycloak</span><span>:15.0.1</span></p><p><span>    </span><span>environment</span><span>:</span></p><p><span>      </span>-<span> </span>KEYCLOAK<span>_</span>USER=keycloak</p><p><span>      </span>-<span> </span>KEYCLOAK<span>_</span>PASSWORD=keycloak</p><p><span>      </span>-<span> </span>DB<span>_</span>VENDOR=h2</p><p><span>      </span>-<span> </span>JAVA<span>_</span>OPTS=-Dkeycloak<span>.</span>migration<span>.</span>action=import<span> </span>-Dkeycloak<span>.</span>migration<span>.</span>provider=singleFile<span> </span>-Dkeycloak<span>.</span>migration<span>.</span>file=/tmp/keycloak-dump<span>.</span>json</p><p><span>    </span><span>volumes</span><span>:</span></p><p><span>      </span><span>- type</span><span>: bind</span></p><p><span>        </span><span>source</span><span>: ./tmp/keycloak-dump.json</span></p><p><span>        </span><span>target</span><span>: /tmp/keycloak-dump.json</span></p><p><span>        </span><span>read_only</span><span>: true</span></p><p><span>    </span><span>ports</span><span>:</span></p><p><span>    </span>-<span> </span><span>&#34;8888:8080&#34;</span></p><p><span>  </span><span>sqs</span><span>:</span></p><p><span>    </span><span>image</span><span>: softwaremill/elasticmq-native</span></p><p><span>    </span><span>volumes</span><span>:</span></p><p><span>      </span><span>- type</span><span>: bind</span></p><p><span>        </span><span>source</span><span>: ./tmp/sqs-queue-definition.conf</span></p><p><span>        </span><span>target</span><span>: /opt/elasticmq.conf</span></p><p><span>        </span><span>read_only</span><span>: true</span></p><p><span>    </span><span>ports</span><span>:</span></p><p><span>      </span>-<span> </span><span>&#34;9324:9324&#34;</span></p><p><span>      </span>-<span> </span><span>&#34;9325:9325&#34;</span></p></div></td> </tr> </tbody></table> </div> </div> <p>We can then pass the underlying compose file to our <code>docker-compose</code> start command:</p> <div id="urvanov-syntax-highlighter-623e050a02797780840604" data-settings=" minimize scroll-mouseover">    <div> <table> <tbody><tr> <td data-settings="show">  </td> <td><div><p>docker-compose --file docker-compose-arm64-support.yml up</p></div></td> </tr> </tbody></table> </div> </div> <p>The downside of this additional compose file is the duplicated maintenance. We have to ensure both our composes files (<code>x64</code> and <code>arm64</code>) are in sync. Similar to the workarounds for making our Testcontainers integration tests pass, this should also be a temporary solution that we reassess from time to time.</p> <h2>Java Development: Spring Boot Netty Warning on Startup</h2> <p>Upon starting a Spring Boot application on an Apple M1, we may encounter an <code>ERROR</code> log from Netty with a big stack trace during the bootstrap phase:</p> <div id="urvanov-syntax-highlighter-623e050a02798402435250" data-settings=" minimize scroll-mouseover">    <div> <table> <tbody><tr> <td data-settings="show">  </td> <td><div><p><span>2022</span><span>-</span><span>03</span><span>-</span><span>21</span><span> </span><span>06</span><span>:</span><span>52</span><span>:</span><span>09.885</span><span> </span><span>ERROR</span><span> </span><span>17220</span><span> </span><span>--</span><span>-</span><span> </span><span>[</span><span>main</span><span>]</span><span> </span><span>i</span><span>.</span><span>n</span><span>.</span><span>r</span><span>.</span><span>d</span><span>.</span><span>DnsServerAddressStreamProviders</span><span>  </span><span>:</span><span> </span><span>Unable </span><span>to</span><span> </span><span>load </span><span>io</span><span>.</span><span>netty</span><span>.</span><span>resolver</span><span>.</span><span>dns</span><span>.</span><span>macos</span><span>.</span><span>MacOSDnsServerAddressStreamProvider</span><span>,</span><span> </span><span>fallback </span><span>to</span><span> </span><span>system </span><span>defaults</span><span>.</span><span> </span><span>This</span><span> </span><span>may </span><span>result </span><span>in</span><span> </span><span>incorrect </span><span>DNS </span><span>resolutions </span><span>on </span><span>MacOS</span><span>.</span></p><p><span>java</span><span>.</span><span>lang</span><span>.</span><span>reflect</span><span>.</span><span>InvocationTargetException</span><span>:</span><span> </span><span>null</span></p><p><span>        </span><span>at </span><span>java</span><span>.</span><span>base</span><span>/</span><span>jdk</span><span>.</span><span>internal</span><span>.</span><span>reflect</span><span>.</span><span>NativeConstructorAccessorImpl</span><span>.</span><span>newInstance0</span><span>(</span><span>Native</span><span> </span><span>Method</span><span>)</span><span> </span><span>~</span><span>[</span><span>na</span><span>:</span><span>na</span><span>]</span></p><p><span>        </span><span>at </span><span>java</span><span>.</span><span>base</span><span>/</span><span>jdk</span><span>.</span><span>internal</span><span>.</span><span>reflect</span><span>.</span><span>NativeConstructorAccessorImpl</span><span>.</span><span>newInstance</span><span>(</span><span>NativeConstructorAccessorImpl</span><span>.</span><span>java</span><span>:</span><span>77</span><span>)</span><span> </span><span>~</span><span>[</span><span>na</span><span>:</span><span>na</span><span>]</span></p><p><span>        </span><span>at </span><span>java</span><span>.</span><span>base</span><span>/</span><span>jdk</span><span>.</span><span>internal</span><span>.</span><span>reflect</span><span>.</span><span>DelegatingConstructorAccessorImpl</span><span>.</span><span>newInstance</span><span>(</span><span>DelegatingConstructorAccessorImpl</span><span>.</span><span>java</span><span>:</span><span>45</span><span>)</span><span> </span><span>~</span><span>[</span><span>na</span><span>:</span><span>na</span><span>]</span></p><p><span>        </span><span>at </span><span>java</span><span>.</span><span>base</span><span>/</span><span>java</span><span>.</span><span>lang</span><span>.</span><span>reflect</span><span>.</span><span>Constructor</span><span>.</span><span>newInstanceWithCaller</span><span>(</span><span>Constructor</span><span>.</span><span>java</span><span>:</span><span>499</span><span>)</span><span> </span><span>~</span><span>[</span><span>na</span><span>:</span><span>na</span><span>]</span></p><p><span>        </span><span>at </span><span>java</span><span>.</span><span>base</span><span>/</span><span>java</span><span>.</span><span>lang</span><span>.</span><span>reflect</span><span>.</span><span>Constructor</span><span>.</span><span>newInstance</span><span>(</span><span>Constructor</span><span>.</span><span>java</span><span>:</span><span>480</span><span>)</span><span> </span><span>~</span><span>[</span><span>na</span><span>:</span><span>na</span><span>]</span></p><p><span>        </span><span>at </span><span>io</span><span>.</span><span>netty</span><span>.</span><span>resolver</span><span>.</span><span>dns</span><span>.</span><span>DnsServerAddressStreamProviders</span><span>.</span><span>&lt;clinit&gt;</span><span>(</span><span>DnsServerAddressStreamProviders</span><span>.</span><span>java</span><span>:</span><span>64</span><span>)</span></p></div></td> </tr> </tbody></table> </div> </div> <p>While our application should still function as expected, this log is noisy and may confuse developers. As long as we don&#39;t run our Spring Boot application on an Apple M1 in production, it&#39;s also less critical if we don&#39;t fix it.</p> <p>For those that want to fix this startup error message, make sure to use Netty &gt; <code>4.1.68.Final</code> and add the following dependency to our project:</p> <div id="urvanov-syntax-highlighter-623e050a0279b875947405" data-settings=" minimize scroll-mouseover">    <div> <table> <tbody><tr> <td data-settings="show">  </td> <td><div><p><span>&lt;!-- Fix noisy ERROR log on ARM64 processors during startup. See https://github.com/netty/netty/issues/11020 --&gt;</span></p><p><span>&lt;dependency&gt;</span></p><p><span>  </span><span>&lt;groupId&gt;</span><span>io.netty</span><span>&lt;/groupId&gt;</span></p><p><span>  </span><span>&lt;artifactId&gt;</span><span>netty-resolver-dns-native-macos</span><span>&lt;/artifactId&gt;</span></p><p><span>  </span><span>&lt;version&gt;</span><span>${netty.version}</span><span>&lt;/version&gt;</span></p><p><span>  </span><span>&lt;classifier&gt;</span><span>osx-aarch_64</span><span>&lt;/classifier&gt;</span></p><p><span>&lt;/dependency&gt;</span></p></div></td> </tr> </tbody></table> </div> </div> <p>After making this change, the Spring Boot application should start again with a <em>clean</em> bootstrap log.</p> <h2>Building Multiplatform Docker Images on an Apple M1</h2> <p>When building Docker images, the resulted image will only work on the platform we&#39;re working on. Any output of <code>docker build -t myimage .</code> on an Apple M1 will only work on another <code>arm64</code> machine.</p> <p>While this is completely obvious, it took me a 2 hour debug session to be aware of it. I was building a new feature for a Spring Boot application (<a href="https://stratospheric.dev/">Stratospheric</a>) and wanted to push the resulting Docker image directly to the ECR (Elastic Container Registry) from my local machine. While we have a running CI/CD in place, I wanted to short-circuit this process and save time. After pushing the image to the container registry, I encountered weird error logs, and the ECS (Elastic Container Service) task was unable to start.</p> <p>That&#39;s because the underlying EC2 instance is an <code>x64</code> machine. Even the obvious things sometimes take it the hard way to understand them.</p> <p>Whenever we find ourselves in a similar situation, where we want to create a Docker image for a different processor architecture, we have two options:</p> <ul> <li>Build the target Docker image on a CI/CD server running on an <code>x64</code> machine (or any architecture)</li> <li>Use <a href="https://docs.docker.com/buildx/working-with-buildx/">Docker&#39;s buildx</a>, a CLI plugin, to get access to all features of the Moby BuildKit  (e.g., multiplatform images)</li> </ul> <p>We won&#39;t go further into the first option, as a CI/CD workflow (e.g., <a href="https://rieckpil.de/github-actions-for-java-automate-your-maven-workflows/">GitHub actions</a>) should be already in place for (hopefully) most projects.</p> <p>The second option is more interesting to us as this will allow us to build locally <code>arm64</code> and <code>x64</code> compatible Docker images.</p> <p>As a prerequisite for this to work, we have to ensure our Docker base image (<code>FROM</code> part of the Dockerfile) provides a variant for all architectures we want to build the final Docker image for. We can verify this by visiting Docker Hub and the tags section of our Docker base image.</p> <p>Taking <code>eclipse-temurin</code> (OpenJDK build of the Adoptium project, <a href="https://blog.adoptopenjdk.net/2021/03/transition-to-eclipse-an-update/">former AdoptOpenJDK</a>) as a Docker base image example, we can see that this image <a href="https://hub.docker.com/_/eclipse-temurin?tab=tags">supports various architectures</a>:</p> <p><img alt="Eclipse Temurin Docker Image Multi Platform Example" width="1000" height="200" nitro-lazy-src="https://cdn-aoloc.nitrocdn.com/LjZAnpMBiKRdWkhommfnyugsAOnHWdxL/assets/static/optimized/rev-a10598f/wp-content/uploads/2022/03/eclipse-temurin-docker-image-multi-platform-e1647929226893.png" nitro-lazy-empty="" id="OTk1OjI2OA==-1" src="data:image/svg+xml;nitro-empty-id=OTk1OjI2OA==-1;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTAwMCAyMDAiIHdpZHRoPSIxMDAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48L3N2Zz4="/></p> <div id="urvanov-syntax-highlighter-623e050a0279c357522736" data-settings=" minimize scroll-mouseover">    <div> <table> <tbody><tr> <td data-settings="show">  </td> <td><div><p>docker buildx build --platform linux/amd64,linux/arm64 -t todo-app:latest .</p></div></td> </tr> </tbody></table> </div> </div> <p>In the example above, we build both an <code>arm64</code> and <code>x64</code> image for our Java Spring Boot application:</p> <div id="urvanov-syntax-highlighter-623e050a0279f336558949" data-settings=" minimize scroll-mouseover">    <div> <table> <tbody><tr> <td data-settings="show">  </td> <td><div><p>FROM eclipse-temurin:17-jre</p><p>ARG JAR_FILE=build/libs/*.jar</p><p>COPY ${JAR_FILE} app.jar</p><p>ENTRYPOINT [&#34;java&#34;, &#34;-jar&#34;, &#34;-Dspring.profiles.active=aws&#34;, &#34;/app.jar&#34;]</p></div></td> </tr> </tbody></table> </div> </div> <p>We can also directly push the result into a container registry with:</p> <div id="urvanov-syntax-highlighter-623e050a027a0552810791" data-settings=" minimize scroll-mouseover">    <div> <table> <tbody><tr> <td data-settings="show">  </td> <td><div><p>docker buildx build --platform linux/amd64,linux/arm64 --push -t some.ecr.amazonaws.com/todo-app:latest .</p></div></td> </tr> </tbody></table> </div> </div> <p>Using this technique, we now can build new Docker images locally and deploy them to run on <code>x64</code> machines in the cloud. This gives us great flexibility for the Java development on our Apple M1.</p> <h2>Building ARM64 Images on GitHub Actions</h2> <p>If we&#39;re in the lucky position to develop and publish our own Docker images, we may want to adopt <code>arm64</code> builds to increase the overall adoption rate.</p> <p>We&#39;re using a custom ActiveMQ Docker image for the <a href="https://stratospheric.dev/">Stratospheric</a> project for testing and local development purposes. We were all using a classic Intel processor during the inception phase of this project and when creating this Docker image. Things changed with my MacBook Pro purchase, and therefore, we started looking into multiplatform support.</p> <p>The ActiveMQ message broker runs on the JVM. Hence any ingredient of our Dockerfile must also be available for an arm64 architecture. For our example, we were using <code>fabric8/java-alpine-openjdk11-jre</code> as the base image. Unfortunately, this image <a href="https://hub.docker.com/r/fabric8/java-alpine-openjdk11-jre/tags">only supports</a> <code>linux/amd64</code> (i.e. <code>x64</code>) and hence we had to replace it with a JRE base image that supports all platforms we want to build our image for.</p> <p>We went for <code>eclipse-temurin:11-jre-focal</code> as the base Docker image as it <a href="https://hub.docker.com/_/eclipse-temurin?tab=tags">supports multiple architectures</a>:</p> <div id="urvanov-syntax-highlighter-623e050a027a1102662593" data-settings=" minimize scroll-mouseover">    <div> <table> <tbody><tr> <td data-settings="show"> <div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p></div> </td> <td><div><p>FROM eclipse-temurin:11-jre-focal</p><p># ...</p><p>RUN tar xzf $ACTIVEMQ-bin.tar.gz -C /opt &amp;&amp; \</p><p>    ln -s /opt/$ACTIVEMQ $ACTIVEMQ_HOME &amp;&amp; \</p><p>    groupadd activemq &amp;&amp; \</p><p>    useradd -m -d $ACTIVEMQ_HOME -g activemq activemq &amp;&amp; \</p><p>    chown -R activemq:activemq /opt/$ACTIVEMQ &amp;&amp; \</p><p>    chown -h activemq:activemq $ACTIVEMQ_HOME </p><p>EXPOSE 1883 5672 8161 61613 61614 61616</p><p>USER activemq</p><p>WORKDIR $ACTIVEMQ_HOME</p><p>CMD [&#34;/bin/sh&#34;, &#34;-c&#34;, &#34;bin/activemq console&#34;]</p></div></td> </tr> </tbody></table> </div> </div> <p>Given the multiplatform support from the base image, we can now locally build an <code>arm64</code> variant of the Docker image (using <code>buildx</code> of the last section) and push it to a Docker registry.</p> <p>As an alternative, we can automate this process on GitHub Actions and build a multiplatform image on each commit. The Docker team provides ready-to-use actions to build and push a multiplatform Docker image.</p> <p>For our custom ActiveMQ image, we adjusted our GitHub Actions as the following:</p> <div id="urvanov-syntax-highlighter-623e050a027a2226012223" data-settings=" minimize scroll-mouseover">    <div> <table> <tbody><tr> <td data-settings="show"> <div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p></div> </td> <td><div><p><span>name</span><span>: Publish Docker image</span></p><p><span>on</span><span>: [push]</span></p><p><span>jobs</span><span>:</span></p><p><span>  </span><span>build_push_to_registry</span><span>:</span></p><p><span>    </span><span>name</span><span>: Push Docker image to Docker Hub</span></p><p><span>    </span><span>runs-on</span><span>: ubuntu-latest</span></p><p><span>    </span><span>steps</span><span>:</span></p><p><span>      </span><span>- name</span><span>: Check out</span></p><p><span>      </span><span>- name</span><span>: Set up QEMU</span></p><p><span>        </span><span>with</span><span>:</span></p><p><span>          </span><span>platforms</span><span>: arm64</span><span>,</span><span> </span>amd64</p><p><span>      </span><span>- name</span><span>: Set up Docker Buildx</span></p><p><span>      </span><span>- name</span><span>: Login to Docker Hub</span></p><p><span>        </span><span>with</span><span>:</span></p><p><span>          </span><span>username</span><span>: $</span><span>{</span><span>{</span><span> </span>secrets<span>.</span>DOCKER<span>_</span>USERNAME<span> </span><span>}</span><span>}</span></p><p><span>          </span><span>password</span><span>: $</span><span>{</span><span>{</span><span> </span>secrets<span>.</span>DOCKER<span>_</span>ACCESS<span>_</span>TOKEN<span> </span><span>}</span><span>}</span></p><p><span>      </span><span>- name</span><span>: Build Docker image and push to Docker Hub</span></p><p><span>        </span><span>with</span><span>:</span></p><p><span>          </span><span>context</span><span>: .</span></p><p><span>          </span><span>file</span><span>: ./Dockerfile</span></p><p><span>          </span><span>platforms</span><span>: linux/amd64</span><span>,</span><span> </span>linux/arm64</p><p><span>          </span><span>push</span><span>: $</span><span>{</span><span>{</span><span> </span>github<span>.</span>ref<span> </span>==<span> </span><span>&#39;refs/heads/main&#39;</span><span> </span><span>}</span><span>}</span></p><p><span>          </span><span>tags</span><span>: stratospheric/activemq-docker-image</span><span>:latest</span></p></div></td> </tr> </tbody></table> </div> </div> <p>These five steps automate everything from checking out the source code, building a multiplatform image for <code>arm64</code> and <code>x64</code> and then finally pushing this image to Docker Hub.</p> <p>What&#39;s left for us is to configure a username and access token for Docker Hub. We store them as GitHub secrets for our repository.</p> <p>Given the GitHub automation, we deploy new versions of our Docker image to <a href="https://hub.docker.com/repository/docker/stratospheric/activemq-docker-image/tags?page=1&amp;ordering=last_updated">DockerHub</a> on every push to our main branch:</p> <p><picture loading="lazy"> <source type="image/webp" sizes="(max-width: 2410px) 100vw, 2410px" nitro-lazy-srcset="https://cdn-aoloc.nitrocdn.com/LjZAnpMBiKRdWkhommfnyugsAOnHWdxL/assets/static/optimized/rev-a10598f/wp-content/uploads/2022/03/docker-hub-arm64-amd64-image.png.webp 2410w, https://cdn-aoloc.nitrocdn.com/LjZAnpMBiKRdWkhommfnyugsAOnHWdxL/assets/static/optimized/rev-a10598f/wp-content/uploads/2022/03/docker-hub-arm64-amd64-image-768x125.png.webp 768w, https://cdn-aoloc.nitrocdn.com/LjZAnpMBiKRdWkhommfnyugsAOnHWdxL/assets/static/optimized/rev-a10598f/wp-content/uploads/2022/03/docker-hub-arm64-amd64-image-1536x250.png.webp 1536w, https://cdn-aoloc.nitrocdn.com/LjZAnpMBiKRdWkhommfnyugsAOnHWdxL/assets/static/optimized/rev-a10598f/wp-content/uploads/2022/03/docker-hub-arm64-amd64-image-2048x333.png.webp 2048w" nitro-lazy-empty="" id="MTE1Njo0NzE=-1" src="data:image/svg+xml;nitro-empty-id=MTE1Njo0NzE=-1;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQxMCAzOTIiIHdpZHRoPSIyNDEwIiBoZWlnaHQ9IjM5MiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48L3N2Zz4="/> <img alt="Multiple Platform Docker Build Example using GitHub Actions" width="2410" height="392" sizes="(max-width: 2410px) 100vw, 2410px" nitro-lazy-srcset="https://cdn-aoloc.nitrocdn.com/LjZAnpMBiKRdWkhommfnyugsAOnHWdxL/assets/static/optimized/rev-a10598f/wp-content/uploads/2022/03/docker-hub-arm64-amd64-image.png 2410w, https://cdn-aoloc.nitrocdn.com/LjZAnpMBiKRdWkhommfnyugsAOnHWdxL/assets/static/optimized/rev-a10598f/wp-content/uploads/2022/03/docker-hub-arm64-amd64-image-768x125.png 768w, https://cdn-aoloc.nitrocdn.com/LjZAnpMBiKRdWkhommfnyugsAOnHWdxL/assets/static/optimized/rev-a10598f/wp-content/uploads/2022/03/docker-hub-arm64-amd64-image-1536x250.png 1536w, https://cdn-aoloc.nitrocdn.com/LjZAnpMBiKRdWkhommfnyugsAOnHWdxL/assets/static/optimized/rev-a10598f/wp-content/uploads/2022/03/docker-hub-arm64-amd64-image-2048x333.png 2048w" nitro-lazy-src="https://cdn-aoloc.nitrocdn.com/LjZAnpMBiKRdWkhommfnyugsAOnHWdxL/assets/static/optimized/rev-a10598f/wp-content/uploads/2022/03/docker-hub-arm64-amd64-image.png" nitro-lazy-empty="" id="MTE1Nzo2MjM=-1" src="data:image/svg+xml;nitro-empty-id=MTE1Nzo2MjM=-1;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQxMCAzOTIiIHdpZHRoPSIyNDEwIiBoZWlnaHQ9IjM5MiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48L3N2Zz4="/> </picture> </p>  <h2>Summary: Java Development on an Apple M1</h2> <p>Having worked with an Apple M1 primarily for Java development for almost a year now, I don&#39;t regret the choice. It took me some time to resolve the initial hurdles and get everything running. The mentioned strategies in this article solved all my testing and developing concerns for Java applications on the M1.</p> <p>The good news is that with every passing day, more tools adopt <code>arm64</code> as Apple continues to release new flagship products running on <code>arm64</code> processors. It&#39;s only a matter of time until the last Java development tool works perfectly fine on an Apple M1.</p> <p>The performance of the laptop (Apple MacBook Pro M1 2021) is excellent, and a huge productivity boost as my Java builds, and tests run faster compared to an <code>x64</code> Mac. I still keep my old Ubuntu desktop PC around as there are occasionally tasks where I need a good old <code>x64</code> machine.</p> <p>Let me know about your tips &amp; tricks for Java development on an Apple M1 in the comments.</p> <p>Joyful testing,</p> <p>Philip</p> <span></span><span></span></section> </div></div> </div> </div></div>
  </body>
</html>
