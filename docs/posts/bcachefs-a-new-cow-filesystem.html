<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lore.kernel.org/lkml/20230509165657.1735798-1-kent.overstreet@linux.dev/T/#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">Original</a>
    <h1>Bcachefs – A New COW Filesystem</h1>
    
    <div id="readability-page-1" class="page"><pre><a href="#ef171fd06ffa420fe1bcf0f49a2b44a361ca6ac44" id="mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">*</a> <u id="u"><b>[PATCH 00/32] bcachefs - a new COW filesystem</b></u>
<b>@ 2023-05-09 16:56 Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#mda332a98731952301e95c9833fb1fd717bbe69c4">[PATCH 01/32] Compiler Attributes: add __flatten</a> Kent Overstreet
                   ` <a href="#rda332a98731952301e95c9833fb1fd717bbe69c4">(31 more replies)</a>
  <a href="#rf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">0 siblings, 32 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-1-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-1-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-block, linux-mm, linux-bcachefs
  Cc: Kent Overstreet, viro, akpm, boqun.feng, brauner, hch, colyli,
	djwong, mingo, jack, axboe, willy, ojeda, ming.lei, ndesaulniers,
	peterz, phillip, urezki, longman, will

I&#39;m submitting the bcachefs filesystem for review and inclusion.

Included in this patch series are all the non fs/bcachefs/ patches. The
entire tree, based on v6.3, may be found at:

  <a href="http://evilpiepirate.org/git/bcachefs.git">http://evilpiepirate.org/git/bcachefs.git</a> bcachefs-for-upstream

----------------------------------------------------------------

bcachefs overview, status:

Features:
 - too many to list

Known bugs:
 - too many to list

Status:
 - Snapshots have been declared stable; one serious bug report
   outstanding to look into, most users report it working well.

   These are RW btrfs-style snapshots, but with far better scalability
   and no scalability issues with sparse snapshots due to key level
   versioning.

 - Erasure coding is getting really close; hope to have it ready for
   users to beat on it by this summer. This is a novel RAID/erasure
   coding design with no write hole, and no fragmentation of writes
   (e.g. RAIDZ).

 - Tons of scalabality work finished over the past year, users are
   running it on 100 TB filesystems without complaint, waiting for first
   1 PB user; next thing to address re: scalability is fsck/recovery
   memory usage.

 - Test infrastructure! Major project milestone, check out our test
   dashboard at
     <a href="https://evilpiepirate.org/~testdashboard/ci?branch=bcachefs">https://evilpiepirate.org/~testdashboard/ci?branch=bcachefs</a>

Other project notes:

irc::/irc.oftc.net/bcache is where most activity happens; I&#39;m always
there, and most code review happens there - I find the conversational
format more productive.

------------------------------------------------

patches in this series:

Christopher James Halse Rogers (1):
  stacktrace: Export stack_trace_save_tsk

Daniel Hill (1):
  lib: add mean and variance module.

Dave Chinner (3):
  vfs: factor out inode hash head calculation
  hlist-bl: add hlist_bl_fake()
  vfs: inode cache conversion to hash-bl

Kent Overstreet (27):
  Compiler Attributes: add __flatten
  locking/lockdep: lock_class_is_held()
  locking/lockdep: lockdep_set_no_check_recursion()
  locking: SIX locks (shared/intent/exclusive)
  MAINTAINERS: Add entry for six locks
  sched: Add task_struct-&gt;faults_disabled_mapping
  mm: Bring back vmalloc_exec
  fs: factor out d_mark_tmpfile()
  block: Add some exports for bcachefs
  block: Allow bio_iov_iter_get_pages() with bio-&gt;bi_bdev unset
  block: Bring back zero_fill_bio_iter
  block: Rework bio_for_each_segment_all()
  block: Rework bio_for_each_folio_all()
  block: Don&#39;t block on s_umount from __invalidate_super()
  bcache: move closures to lib/
  MAINTAINERS: Add entry for closures
  closures: closure_wait_event()
  closures: closure_nr_remaining()
  closures: Add a missing include
  iov_iter: copy_folio_from_iter_atomic()
  MAINTAINERS: Add entry for generic-radix-tree
  lib/generic-radix-tree.c: Don&#39;t overflow in peek()
  lib/generic-radix-tree.c: Add a missing include
  lib/generic-radix-tree.c: Add peek_prev()
  lib/string_helpers: string_get_size() now returns characters wrote
  lib: Export errname
  MAINTAINERS: Add entry for bcachefs

 MAINTAINERS                                   |  39 +
 block/bdev.c                                  |   2 +-
 block/bio.c                                   |  57 +-
 block/blk-core.c                              |   1 +
 block/blk-map.c                               |  38 +-
 block/blk.h                                   |   1 -
 block/bounce.c                                |  12 +-
 drivers/md/bcache/Kconfig                     |  10 +-
 drivers/md/bcache/Makefile                    |   4 +-
 drivers/md/bcache/bcache.h                    |   2 +-
 drivers/md/bcache/btree.c                     |   8 +-
 drivers/md/bcache/super.c                     |   1 -
 drivers/md/bcache/util.h                      |   3 +-
 drivers/md/dm-crypt.c                         |  10 +-
 drivers/md/raid1.c                            |   4 +-
 fs/btrfs/disk-io.c                            |   4 +-
 fs/btrfs/extent_io.c                          |  50 +-
 fs/btrfs/raid56.c                             |  14 +-
 fs/crypto/bio.c                               |   9 +-
 fs/dcache.c                                   |  12 +-
 fs/erofs/zdata.c                              |   4 +-
 fs/ext4/page-io.c                             |   8 +-
 fs/ext4/readpage.c                            |   4 +-
 fs/f2fs/data.c                                |  20 +-
 fs/gfs2/lops.c                                |  10 +-
 fs/gfs2/meta_io.c                             |   8 +-
 fs/inode.c                                    | 218 +++--
 fs/iomap/buffered-io.c                        |  14 +-
 fs/mpage.c                                    |   4 +-
 fs/squashfs/block.c                           |  48 +-
 fs/squashfs/lz4_wrapper.c                     |  17 +-
 fs/squashfs/lzo_wrapper.c                     |  17 +-
 fs/squashfs/xz_wrapper.c                      |  19 +-
 fs/squashfs/zlib_wrapper.c                    |  18 +-
 fs/squashfs/zstd_wrapper.c                    |  19 +-
 fs/super.c                                    |  40 +-
 fs/verity/verify.c                            |   9 +-
 include/linux/bio.h                           | 132 +--
 include/linux/blkdev.h                        |   1 +
 include/linux/bvec.h                          |  70 +-
 .../md/bcache =&gt; include/linux}/closure.h     |  46 +-
 include/linux/compiler_attributes.h           |   5 +
 include/linux/dcache.h                        |   1 +
 include/linux/fs.h                            |  10 +-
 include/linux/generic-radix-tree.h            |  68 +-
 include/linux/list_bl.h                       |  22 +
 include/linux/lockdep.h                       |  10 +
 include/linux/lockdep_types.h                 |   2 +-
 include/linux/mean_and_variance.h             | 219 +++++
 include/linux/sched.h                         |   1 +
 include/linux/six.h                           | 210 +++++
 include/linux/string_helpers.h                |   4 +-
 include/linux/uio.h                           |   2 +
 include/linux/vmalloc.h                       |   1 +
 init/init_task.c                              |   1 +
 kernel/Kconfig.locks                          |   3 +
 kernel/locking/Makefile                       |   1 +
 kernel/locking/lockdep.c                      |  46 ++
 kernel/locking/six.c                          | 779 ++++++++++++++++++
 kernel/module/main.c                          |   4 +-
 kernel/stacktrace.c                           |   2 +
 lib/Kconfig                                   |   3 +
 lib/Kconfig.debug                             |  18 +
 lib/Makefile                                  |   2 +
 {drivers/md/bcache =&gt; lib}/closure.c          |  36 +-
 lib/errname.c                                 |   1 +
 lib/generic-radix-tree.c                      |  76 +-
 lib/iov_iter.c                                |  53 +-
 lib/math/Kconfig                              |   3 +
 lib/math/Makefile                             |   2 +
 lib/math/mean_and_variance.c                  | 136 +++
 lib/math/mean_and_variance_test.c             | 155 ++++
 lib/string_helpers.c                          |   8 +-
 mm/nommu.c                                    |  18 +
 mm/vmalloc.c                                  |  21 +
 75 files changed, 2485 insertions(+), 445 deletions(-)
 rename {drivers/md/bcache =&gt; include/linux}/closure.h (93%)
 create mode 100644 include/linux/mean_and_variance.h
 create mode 100644 include/linux/six.h
 create mode 100644 kernel/locking/six.c
 rename {drivers/md/bcache =&gt; lib}/closure.c (88%)
 create mode 100644 lib/math/mean_and_variance.c
 create mode 100644 lib/math/mean_and_variance_test.c

-- 
2.40.1


<a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44" id="ef171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-1-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-1-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-1-kent.overstreet@linux.dev/#R">reply</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-1-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-1-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#rf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">73+ messages in thread</a></pre><hr/><pre><a href="#eda332a98731952301e95c9833fb1fd717bbe69c4" id="mda332a98731952301e95c9833fb1fd717bbe69c4">*</a> <b>[PATCH 01/32] Compiler Attributes: add __flatten</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 17:04   ` <a href="#m72440a5aab6a33b89f4437cba0c7ddf673ba9771">Miguel Ojeda</a>
  2023-05-09 16:56 ` <a href="#m86cd2a43c7ceeb60c0a4e313c199deb289199877">[PATCH 02/32] locking/lockdep: lock_class_is_held()</a> Kent Overstreet
                   ` <a href="#r86cd2a43c7ceeb60c0a4e313c199deb289199877">(30 subsequent siblings)</a>
  <a href="#rda332a98731952301e95c9833fb1fd717bbe69c4">31 siblings, 1 reply; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-2-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-2-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Miguel Ojeda, Nick Desaulniers, Kent Overstreet

From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;

This makes __attribute__((flatten)) available, which is used by
bcachefs.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
Cc: Miguel Ojeda &lt;ojeda@kernel.org&gt; (maintainer:COMPILER ATTRIBUTES)
Cc: Nick Desaulniers &lt;ndesaulniers@google.com&gt; (reviewer:COMPILER ATTRIBUTES)
Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-2-kent.overstreet::40linux.dev:1include:linux:compiler_attributes.h" href="#Z2e.:..:20230509165657.1735798-2-kent.overstreet::40linux.dev:1include:linux:compiler_attributes.h">include/linux/compiler_attributes.h</a> | 5 +++++
 1 file <a href="#eda332a98731952301e95c9833fb1fd717bbe69c4">changed</a>, 5 insertions(+)

<span><a href="#iZ2e.:..:20230509165657.1735798-2-kent.overstreet::40linux.dev:1include:linux:compiler_attributes.h" id="Z2e.:..:20230509165657.1735798-2-kent.overstreet::40linux.dev:1include:linux:compiler_attributes.h">diff</a> --git a/include/linux/compiler_attributes.h b/include/linux/compiler_attributes.h
index e659cb6fde..e56793bc08 100644
--- a/include/linux/compiler_attributes.h
+++ b/include/linux/compiler_attributes.h
</span><span>@@ -366,4 +366,9 @@
</span>  */
 #define __fix_address noinline __noclone
 
<span>+/*
+ *   gcc: <a href="https://gcc.gnu.org/onlinedocs/gcc/Common-Function-Attributes.html#index-flatten-function-attribute">https://gcc.gnu.org/onlinedocs/gcc/Common-Function-Attributes.html#index-flatten-function-attribute</a>
+ */
+#define __flatten __attribute__((flatten))
+
</span> #endif /* __LINUX_COMPILER_ATTRIBUTES_H */
-- 
2.40.1


<a href="#mda332a98731952301e95c9833fb1fd717bbe69c4" id="eda332a98731952301e95c9833fb1fd717bbe69c4">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-2-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-2-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-2-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-2-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-2-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-2-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#rda332a98731952301e95c9833fb1fd717bbe69c4">73+ messages in thread</a></pre><hr/><pre><a href="#e86cd2a43c7ceeb60c0a4e313c199deb289199877" id="m86cd2a43c7ceeb60c0a4e313c199deb289199877">*</a> <b>[PATCH 02/32] locking/lockdep: lock_class_is_held()</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
  2023-05-09 16:56 ` <a href="#mda332a98731952301e95c9833fb1fd717bbe69c4">[PATCH 01/32] Compiler Attributes: add __flatten</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 19:30   ` <a href="#me6217c7916bdf0763c1175f29137722e31dc943c">Peter Zijlstra</a>
  2023-05-09 16:56 ` <a href="#m5ed7c55399215bfa0a81888ebb4421bfa03cf35b">[PATCH 03/32] locking/lockdep: lockdep_set_no_check_recursion()</a> Kent Overstreet
                   ` <a href="#r5ed7c55399215bfa0a81888ebb4421bfa03cf35b">(29 subsequent siblings)</a>
  <a href="#r86cd2a43c7ceeb60c0a4e313c199deb289199877">31 siblings, 1 reply; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-3-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-3-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Kent Overstreet, Peter Zijlstra, Ingo Molnar,
	Will Deacon, Waiman Long, Boqun Feng

From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;

This patch adds lock_class_is_held(), which can be used to assert that a
particular type of lock is not held.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
Cc: Peter Zijlstra &lt;peterz@infradead.org&gt;
Cc: Ingo Molnar &lt;mingo@redhat.com&gt;
Cc: Will Deacon &lt;will@kernel.org&gt;
Cc: Waiman Long &lt;longman@redhat.com&gt;
Cc: Boqun Feng &lt;boqun.feng@gmail.com&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-3-kent.overstreet::40linux.dev:1include:linux:lockdep.h" href="#Z2e.:..:20230509165657.1735798-3-kent.overstreet::40linux.dev:1include:linux:lockdep.h">include/linux/lockdep.h</a>  |  4 ++++
 <a id="iZ2e.:..:20230509165657.1735798-3-kent.overstreet::40linux.dev:1kernel:locking:lockdep.c" href="#Z2e.:..:20230509165657.1735798-3-kent.overstreet::40linux.dev:1kernel:locking:lockdep.c">kernel/locking/lockdep.c</a> | 20 ++++++++++++++++++++
 2 files <a href="#e86cd2a43c7ceeb60c0a4e313c199deb289199877">changed</a>, 24 insertions(+)

<span><a href="#iZ2e.:..:20230509165657.1735798-3-kent.overstreet::40linux.dev:1include:linux:lockdep.h" id="Z2e.:..:20230509165657.1735798-3-kent.overstreet::40linux.dev:1include:linux:lockdep.h">diff</a> --git a/include/linux/lockdep.h b/include/linux/lockdep.h
index 1023f349af..e858c288c7 100644
--- a/include/linux/lockdep.h
+++ b/include/linux/lockdep.h
</span><span>@@ -339,6 +339,8 @@ extern void lock_unpin_lock(struct lockdep_map *lock, struct pin_cookie);
</span> #define lockdep_repin_lock(l,c)	lock_repin_lock(&amp;(l)-&gt;dep_map, (c))
 #define lockdep_unpin_lock(l,c)	lock_unpin_lock(&amp;(l)-&gt;dep_map, (c))
 
<span>+int lock_class_is_held(struct lock_class_key *key);
+
</span> #else /* !CONFIG_LOCKDEP */
 
 static inline void lockdep_init_task(struct task_struct *task)
<span>@@ -427,6 +429,8 @@ extern int lockdep_is_held(const void *);
</span> #define lockdep_repin_lock(l, c)		do { (void)(l); (void)(c); } while (0)
 #define lockdep_unpin_lock(l, c)		do { (void)(l); (void)(c); } while (0)
 
<span>+static inline int lock_class_is_held(struct lock_class_key *key) { return 0; }
+
</span> #endif /* !LOCKDEP */
 
 enum xhlock_context_t {
<span><a href="#iZ2e.:..:20230509165657.1735798-3-kent.overstreet::40linux.dev:1kernel:locking:lockdep.c" id="Z2e.:..:20230509165657.1735798-3-kent.overstreet::40linux.dev:1kernel:locking:lockdep.c">diff</a> --git a/kernel/locking/lockdep.c b/kernel/locking/lockdep.c
index 50d4863974..e631464070 100644
--- a/kernel/locking/lockdep.c
+++ b/kernel/locking/lockdep.c
</span><span>@@ -6487,6 +6487,26 @@ void debug_check_no_locks_held(void)
</span> }
 EXPORT_SYMBOL_GPL(debug_check_no_locks_held);
 
<span>+#ifdef CONFIG_LOCKDEP
+int lock_class_is_held(struct lock_class_key *key)
+{
+	struct task_struct *curr = current;
+	struct held_lock *hlock;
+
+	if (unlikely(!debug_locks))
+		return 0;
+
+	for (hlock = curr-&gt;held_locks;
+	     hlock &lt; curr-&gt;held_locks + curr-&gt;lockdep_depth;
+	     hlock++)
+		if (hlock-&gt;instance-&gt;key == key)
+			return 1;
+
+	return 0;
+}
+EXPORT_SYMBOL_GPL(lock_class_is_held);
+#endif
+
</span> #ifdef __KERNEL__
 void debug_show_all_locks(void)
 {
-- 
2.40.1


<a href="#m86cd2a43c7ceeb60c0a4e313c199deb289199877" id="e86cd2a43c7ceeb60c0a4e313c199deb289199877">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-3-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-3-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-3-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-3-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-3-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-3-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r86cd2a43c7ceeb60c0a4e313c199deb289199877">73+ messages in thread</a></pre><hr/><pre><a href="#e5ed7c55399215bfa0a81888ebb4421bfa03cf35b" id="m5ed7c55399215bfa0a81888ebb4421bfa03cf35b">*</a> <b>[PATCH 03/32] locking/lockdep: lockdep_set_no_check_recursion()</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
  2023-05-09 16:56 ` <a href="#mda332a98731952301e95c9833fb1fd717bbe69c4">[PATCH 01/32] Compiler Attributes: add __flatten</a> Kent Overstreet
  2023-05-09 16:56 ` <a href="#m86cd2a43c7ceeb60c0a4e313c199deb289199877">[PATCH 02/32] locking/lockdep: lock_class_is_held()</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 19:31   ` <a href="#mdc1c43efeeae88da82cf5e2a930303b1dd0fd99e">Peter Zijlstra</a>
  2023-05-09 16:56 ` <a href="#mdf1a03c4a94e7bb6300666e5af4374084ddc4390">[PATCH 04/32] locking: SIX locks (shared/intent/exclusive)</a> Kent Overstreet
                   ` <a href="#rdf1a03c4a94e7bb6300666e5af4374084ddc4390">(28 subsequent siblings)</a>
  <a href="#r5ed7c55399215bfa0a81888ebb4421bfa03cf35b">31 siblings, 1 reply; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-4-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-4-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Peter Zijlstra, Ingo Molnar, Will Deacon,
	Waiman Long, Boqun Feng

This adds a method to tell lockdep not to check lock ordering within a
lock class - but to still check lock ordering w.r.t. other lock types.

This is for bcachefs, where for btree node locks we have our own
deadlock avoidance strategy w.r.t. other btree node locks (cycle
detection), but we still want lockdep to check lock ordering w.r.t.
other lock types.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
Cc: Peter Zijlstra &lt;peterz@infradead.org&gt;
Cc: Ingo Molnar &lt;mingo@redhat.com&gt;
Cc: Will Deacon &lt;will@kernel.org&gt;
Cc: Waiman Long &lt;longman@redhat.com&gt;
Cc: Boqun Feng &lt;boqun.feng@gmail.com&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-4-kent.overstreet::40linux.dev:1include:linux:lockdep.h" href="#Z2e.:..:20230509165657.1735798-4-kent.overstreet::40linux.dev:1include:linux:lockdep.h">include/linux/lockdep.h</a>       |  6 ++++++
 <a id="iZ2e.:..:20230509165657.1735798-4-kent.overstreet::40linux.dev:1include:linux:lockdep_types.h" href="#Z2e.:..:20230509165657.1735798-4-kent.overstreet::40linux.dev:1include:linux:lockdep_types.h">include/linux/lockdep_types.h</a> |  2 +-
 <a id="iZ2e.:..:20230509165657.1735798-4-kent.overstreet::40linux.dev:1kernel:locking:lockdep.c" href="#Z2e.:..:20230509165657.1735798-4-kent.overstreet::40linux.dev:1kernel:locking:lockdep.c">kernel/locking/lockdep.c</a>      | 26 ++++++++++++++++++++++++++
 3 files <a href="#e5ed7c55399215bfa0a81888ebb4421bfa03cf35b">changed</a>, 33 insertions(+), 1 deletion(-)

<span><a href="#iZ2e.:..:20230509165657.1735798-4-kent.overstreet::40linux.dev:1include:linux:lockdep.h" id="Z2e.:..:20230509165657.1735798-4-kent.overstreet::40linux.dev:1include:linux:lockdep.h">diff</a> --git a/include/linux/lockdep.h b/include/linux/lockdep.h
index e858c288c7..f6cc8709e2 100644
--- a/include/linux/lockdep.h
+++ b/include/linux/lockdep.h
</span><span>@@ -665,4 +665,10 @@ lockdep_rcu_suspicious(const char *file, const int line, const char *s)
</span> }
 #endif
 
<span>+#ifdef CONFIG_DEBUG_LOCK_ALLOC
+void lockdep_set_no_check_recursion(struct lockdep_map *map);
+#else
+static inline void lockdep_set_no_check_recursion(struct lockdep_map *map) {}
+#endif
+
</span> #endif /* __LINUX_LOCKDEP_H */
<span><a href="#iZ2e.:..:20230509165657.1735798-4-kent.overstreet::40linux.dev:1include:linux:lockdep_types.h" id="Z2e.:..:20230509165657.1735798-4-kent.overstreet::40linux.dev:1include:linux:lockdep_types.h">diff</a> --git a/include/linux/lockdep_types.h b/include/linux/lockdep_types.h
index d22430840b..506e769b4a 100644
--- a/include/linux/lockdep_types.h
+++ b/include/linux/lockdep_types.h
</span><span>@@ -128,7 +128,7 @@ struct lock_class {
</span> 	u8				wait_type_inner;
 	u8				wait_type_outer;
 	u8				lock_type;
<span>-	/* u8				hole; */
</span><span>+	u8				no_check_recursion;
</span> 
 #ifdef CONFIG_LOCK_STAT
 	unsigned long			contention_point[LOCKSTAT_POINTS];
<span><a href="#iZ2e.:..:20230509165657.1735798-4-kent.overstreet::40linux.dev:1kernel:locking:lockdep.c" id="Z2e.:..:20230509165657.1735798-4-kent.overstreet::40linux.dev:1kernel:locking:lockdep.c">diff</a> --git a/kernel/locking/lockdep.c b/kernel/locking/lockdep.c
index e631464070..f022b58dfa 100644
--- a/kernel/locking/lockdep.c
+++ b/kernel/locking/lockdep.c
</span><span>@@ -3024,6 +3024,9 @@ check_deadlock(struct task_struct *curr, struct held_lock *next)
</span> 		if ((next-&gt;read == 2) &amp;&amp; prev-&gt;read)
 			continue;
 
<span>+		if (hlock_class(next)-&gt;no_check_recursion)
+			continue;
+
</span> 		/*
 		 * We&#39;re holding the nest_lock, which serializes this lock&#39;s
 		 * nesting behaviour.
<span>@@ -3085,6 +3088,10 @@ check_prev_add(struct task_struct *curr, struct held_lock *prev,
</span> 		return 2;
 	}
 
<span>+	if (hlock_class(prev) == hlock_class(next) &amp;&amp;
+	    hlock_class(prev)-&gt;no_check_recursion)
+		return 2;
+
</span> 	/*
 	 * Prove that the new &lt;prev&gt; -&gt; &lt;next&gt; dependency would not
 	 * create a circular dependency in the graph. (We do this by
<span>@@ -6620,3 +6627,22 @@ void lockdep_rcu_suspicious(const char *file, const int line, const char *s)
</span> 	warn_rcu_exit(rcu);
 }
 EXPORT_SYMBOL_GPL(lockdep_rcu_suspicious);
<span>+
+#ifdef CONFIG_DEBUG_LOCK_ALLOC
+void lockdep_set_no_check_recursion(struct lockdep_map *lock)
+{
+	struct lock_class *class = lock-&gt;class_cache[0];
+	unsigned long flags;
+
+	raw_local_irq_save(flags);
+	lockdep_recursion_inc();
+
+	if (!class)
+		class = register_lock_class(lock, 0, 0);
+	if (class)
+		class-&gt;no_check_recursion = true;
+	lockdep_recursion_finish();
+	raw_local_irq_restore(flags);
+}
+EXPORT_SYMBOL_GPL(lockdep_set_no_check_recursion);
+#endif
</span>-- 
2.40.1


<a href="#m5ed7c55399215bfa0a81888ebb4421bfa03cf35b" id="e5ed7c55399215bfa0a81888ebb4421bfa03cf35b">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-4-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-4-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-4-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-4-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-4-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-4-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r5ed7c55399215bfa0a81888ebb4421bfa03cf35b">73+ messages in thread</a></pre><hr/><pre><a href="#edf1a03c4a94e7bb6300666e5af4374084ddc4390" id="mdf1a03c4a94e7bb6300666e5af4374084ddc4390">*</a> <b>[PATCH 04/32] locking: SIX locks (shared/intent/exclusive)</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#r5ed7c55399215bfa0a81888ebb4421bfa03cf35b">(2 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#m5ed7c55399215bfa0a81888ebb4421bfa03cf35b">[PATCH 03/32] locking/lockdep: lockdep_set_no_check_recursion()</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-11 12:14   ` <a href="#m413de2f22a49a50b48cef3d6c05c54ad4a845424">Jan Engelhardt</a>
  2023-05-09 16:56 ` <a href="#m8684754525a2d9a18e06f6d5f8b3cb9704c79a90">[PATCH 05/32] MAINTAINERS: Add entry for six locks</a> Kent Overstreet
                   ` <a href="#r8684754525a2d9a18e06f6d5f8b3cb9704c79a90">(27 subsequent siblings)</a>
  <a href="#rdf1a03c4a94e7bb6300666e5af4374084ddc4390">31 siblings, 1 reply; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-5-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-5-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Kent Overstreet, Peter Zijlstra, Ingo Molnar,
	Will Deacon, Waiman Long, Boqun Feng

From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;

New lock for bcachefs, like read/write locks but with a third state,
intent.

Intent locks conflict with each other, but not with read locks; taking a
write lock requires first holding an intent lock.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
Cc: Peter Zijlstra &lt;peterz@infradead.org&gt;
Cc: Ingo Molnar &lt;mingo@redhat.com&gt;
Cc: Will Deacon &lt;will@kernel.org&gt;
Cc: Waiman Long &lt;longman@redhat.com&gt;
Cc: Boqun Feng &lt;boqun.feng@gmail.com&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-5-kent.overstreet::40linux.dev:1include:linux:six.h" href="#Z2e.:..:20230509165657.1735798-5-kent.overstreet::40linux.dev:1include:linux:six.h">include/linux/six.h</a>     | 210 +++++++++++
 <a id="iZ2e.:..:20230509165657.1735798-5-kent.overstreet::40linux.dev:1kernel:Kconfig.locks" href="#Z2e.:..:20230509165657.1735798-5-kent.overstreet::40linux.dev:1kernel:Kconfig.locks">kernel/Kconfig.locks</a>    |   3 +
 <a id="iZ2e.:..:20230509165657.1735798-5-kent.overstreet::40linux.dev:1kernel:locking:Makefile" href="#Z2e.:..:20230509165657.1735798-5-kent.overstreet::40linux.dev:1kernel:locking:Makefile">kernel/locking/Makefile</a> |   1 +
 <a id="iZ2e.:..:20230509165657.1735798-5-kent.overstreet::40linux.dev:1kernel:locking:six.c" href="#Z2e.:..:20230509165657.1735798-5-kent.overstreet::40linux.dev:1kernel:locking:six.c">kernel/locking/six.c</a>    | 779 ++++++++++++++++++++++++++++++++++++++++
 4 files <a href="#edf1a03c4a94e7bb6300666e5af4374084ddc4390">changed</a>, 993 insertions(+)
 create mode 100644 include/linux/six.h
 create mode 100644 kernel/locking/six.c

<span><a href="#iZ2e.:..:20230509165657.1735798-5-kent.overstreet::40linux.dev:1include:linux:six.h" id="Z2e.:..:20230509165657.1735798-5-kent.overstreet::40linux.dev:1include:linux:six.h">diff</a> --git a/include/linux/six.h b/include/linux/six.h
new file mode 100644
index 0000000000..41ddf63b74
--- /dev/null
+++ b/include/linux/six.h
</span><span>@@ -0,0 +1,210 @@
</span><span>+/* SPDX-License-Identifier: GPL-2.0 */
+
+#ifndef _LINUX_SIX_H
+#define _LINUX_SIX_H
+
+/*
+ * Shared/intent/exclusive locks: sleepable read/write locks, much like rw
+ * semaphores, except with a third intermediate state, intent. Basic operations
+ * are:
+ *
+ * six_lock_read(&amp;foo-&gt;lock);
+ * six_unlock_read(&amp;foo-&gt;lock);
+ *
+ * six_lock_intent(&amp;foo-&gt;lock);
+ * six_unlock_intent(&amp;foo-&gt;lock);
+ *
+ * six_lock_write(&amp;foo-&gt;lock);
+ * six_unlock_write(&amp;foo-&gt;lock);
+ *
+ * Intent locks block other intent locks, but do not block read locks, and you
+ * must have an intent lock held before taking a write lock, like so:
+ *
+ * six_lock_intent(&amp;foo-&gt;lock);
+ * six_lock_write(&amp;foo-&gt;lock);
+ * six_unlock_write(&amp;foo-&gt;lock);
+ * six_unlock_intent(&amp;foo-&gt;lock);
+ *
+ * Other operations:
+ *
+ *   six_trylock_read()
+ *   six_trylock_intent()
+ *   six_trylock_write()
+ *
+ *   six_lock_downgrade():	convert from intent to read
+ *   six_lock_tryupgrade():	attempt to convert from read to intent
+ *
+ * Locks also embed a sequence number, which is incremented when the lock is
+ * locked or unlocked for write. The current sequence number can be grabbed
+ * while a lock is held from lock-&gt;state.seq; then, if you drop the lock you can
+ * use six_relock_(read|intent_write)(lock, seq) to attempt to retake the lock
+ * iff it hasn&#39;t been locked for write in the meantime.
+ *
+ * There are also operations that take the lock type as a parameter, where the
+ * type is one of SIX_LOCK_read, SIX_LOCK_intent, or SIX_LOCK_write:
+ *
+ *   six_lock_type(lock, type)
+ *   six_unlock_type(lock, type)
+ *   six_relock(lock, type, seq)
+ *   six_trylock_type(lock, type)
+ *   six_trylock_convert(lock, from, to)
+ *
+ * A lock may be held multiple types by the same thread (for read or intent,
+ * not write). However, the six locks code does _not_ implement the actual
+ * recursive checks itself though - rather, if your code (e.g. btree iterator
+ * code) knows that the current thread already has a lock held, and for the
+ * correct type, six_lock_increment() may be used to bump up the counter for
+ * that type - the only effect is that one more call to unlock will be required
+ * before the lock is unlocked.
+ */
+
+#include &lt;linux/lockdep.h&gt;
+#include &lt;linux/osq_lock.h&gt;
+#include &lt;linux/sched.h&gt;
+#include &lt;linux/types.h&gt;
+
+#define SIX_LOCK_SEPARATE_LOCKFNS
+
+union six_lock_state {
+	struct {
+		atomic64_t	counter;
+	};
+
+	struct {
+		u64		v;
+	};
+
+	struct {
+		/* for waitlist_bitnr() */
+		unsigned long	l;
+	};
+
+	struct {
+		unsigned	read_lock:27;
+		unsigned	write_locking:1;
+		unsigned	intent_lock:1;
+		unsigned	waiters:3;
+		/*
+		 * seq works much like in seqlocks: it&#39;s incremented every time
+		 * we lock and unlock for write.
+		 *
+		 * If it&#39;s odd write lock is held, even unlocked.
+		 *
+		 * Thus readers can unlock, and then lock again later iff it
+		 * hasn&#39;t been modified in the meantime.
+		 */
+		u32		seq;
+	};
+};
+
+enum six_lock_type {
+	SIX_LOCK_read,
+	SIX_LOCK_intent,
+	SIX_LOCK_write,
+};
+
+struct six_lock {
+	union six_lock_state	state;
+	unsigned		intent_lock_recurse;
+	struct task_struct	*owner;
+	struct optimistic_spin_queue osq;
+	unsigned __percpu	*readers;
+
+	raw_spinlock_t		wait_lock;
+	struct list_head	wait_list[2];
+#ifdef CONFIG_DEBUG_LOCK_ALLOC
+	struct lockdep_map	dep_map;
+#endif
+};
+
+typedef int (*six_lock_should_sleep_fn)(struct six_lock *lock, void *);
+
+static __always_inline void __six_lock_init(struct six_lock *lock,
+					    const char *name,
+					    struct lock_class_key *key)
+{
+	atomic64_set(&amp;lock-&gt;state.counter, 0);
+	raw_spin_lock_init(&amp;lock-&gt;wait_lock);
+	INIT_LIST_HEAD(&amp;lock-&gt;wait_list[SIX_LOCK_read]);
+	INIT_LIST_HEAD(&amp;lock-&gt;wait_list[SIX_LOCK_intent]);
+#ifdef CONFIG_DEBUG_LOCK_ALLOC
+	debug_check_no_locks_freed((void *) lock, sizeof(*lock));
+	lockdep_init_map(&amp;lock-&gt;dep_map, name, key, 0);
+#endif
+}
+
+#define six_lock_init(lock)						\
+do {									\
+	static struct lock_class_key __key;				\
+									\
+	__six_lock_init((lock), #lock, &amp;__key);				\
+} while (0)
+
+#define __SIX_VAL(field, _v)	(((union six_lock_state) { .field = _v }).v)
+
+#define __SIX_LOCK(type)						\
+bool six_trylock_##type(struct six_lock *);				\
+bool six_relock_##type(struct six_lock *, u32);				\
+int six_lock_##type(struct six_lock *, six_lock_should_sleep_fn, void *);\
+void six_unlock_##type(struct six_lock *);
+
+__SIX_LOCK(read)
+__SIX_LOCK(intent)
+__SIX_LOCK(write)
+#undef __SIX_LOCK
+
+#define SIX_LOCK_DISPATCH(type, fn, ...)			\
+	switch (type) {						\
+	case SIX_LOCK_read:					\
+		return fn##_read(__VA_ARGS__);			\
+	case SIX_LOCK_intent:					\
+		return fn##_intent(__VA_ARGS__);		\
+	case SIX_LOCK_write:					\
+		return fn##_write(__VA_ARGS__);			\
+	default:						\
+		BUG();						\
+	}
+
+static inline bool six_trylock_type(struct six_lock *lock, enum six_lock_type type)
+{
+	SIX_LOCK_DISPATCH(type, six_trylock, lock);
+}
+
+static inline bool six_relock_type(struct six_lock *lock, enum six_lock_type type,
+				   unsigned seq)
+{
+	SIX_LOCK_DISPATCH(type, six_relock, lock, seq);
+}
+
+static inline int six_lock_type(struct six_lock *lock, enum six_lock_type type,
+				six_lock_should_sleep_fn should_sleep_fn, void *p)
+{
+	SIX_LOCK_DISPATCH(type, six_lock, lock, should_sleep_fn, p);
+}
+
+static inline void six_unlock_type(struct six_lock *lock, enum six_lock_type type)
+{
+	SIX_LOCK_DISPATCH(type, six_unlock, lock);
+}
+
+void six_lock_downgrade(struct six_lock *);
+bool six_lock_tryupgrade(struct six_lock *);
+bool six_trylock_convert(struct six_lock *, enum six_lock_type,
+			 enum six_lock_type);
+
+void six_lock_increment(struct six_lock *, enum six_lock_type);
+
+void six_lock_wakeup_all(struct six_lock *);
+
+void six_lock_pcpu_free_rcu(struct six_lock *);
+void six_lock_pcpu_free(struct six_lock *);
+void six_lock_pcpu_alloc(struct six_lock *);
+
+struct six_lock_count {
+	unsigned read;
+	unsigned intent;
+};
+
+struct six_lock_count six_lock_counts(struct six_lock *);
+
+#endif /* _LINUX_SIX_H */
</span><span><a href="#iZ2e.:..:20230509165657.1735798-5-kent.overstreet::40linux.dev:1kernel:Kconfig.locks" id="Z2e.:..:20230509165657.1735798-5-kent.overstreet::40linux.dev:1kernel:Kconfig.locks">diff</a> --git a/kernel/Kconfig.locks b/kernel/Kconfig.locks
index 4198f0273e..b2abd9a5d9 100644
--- a/kernel/Kconfig.locks
+++ b/kernel/Kconfig.locks
</span><span>@@ -259,3 +259,6 @@ config ARCH_HAS_MMIOWB
</span> config MMIOWB
 	def_bool y if ARCH_HAS_MMIOWB
 	depends on SMP
<span>+
+config SIXLOCKS
+	bool
</span><span><a href="#iZ2e.:..:20230509165657.1735798-5-kent.overstreet::40linux.dev:1kernel:locking:Makefile" id="Z2e.:..:20230509165657.1735798-5-kent.overstreet::40linux.dev:1kernel:locking:Makefile">diff</a> --git a/kernel/locking/Makefile b/kernel/locking/Makefile
index 0db4093d17..a095dbbf01 100644
--- a/kernel/locking/Makefile
+++ b/kernel/locking/Makefile
</span><span>@@ -32,3 +32,4 @@ obj-$(CONFIG_QUEUED_RWLOCKS) += qrwlock.o
</span> obj-$(CONFIG_LOCK_TORTURE_TEST) += locktorture.o
 obj-$(CONFIG_WW_MUTEX_SELFTEST) += test-ww_mutex.o
 obj-$(CONFIG_LOCK_EVENT_COUNTS) += lock_events.o
<span>+obj-$(CONFIG_SIXLOCKS) += six.o
</span><span><a href="#iZ2e.:..:20230509165657.1735798-5-kent.overstreet::40linux.dev:1kernel:locking:six.c" id="Z2e.:..:20230509165657.1735798-5-kent.overstreet::40linux.dev:1kernel:locking:six.c">diff</a> --git a/kernel/locking/six.c b/kernel/locking/six.c
new file mode 100644
index 0000000000..5b2d92c6e9
--- /dev/null
+++ b/kernel/locking/six.c
</span><span>@@ -0,0 +1,779 @@
</span><span>+// SPDX-License-Identifier: GPL-2.0
+
+#include &lt;linux/export.h&gt;
+#include &lt;linux/log2.h&gt;
+#include &lt;linux/percpu.h&gt;
+#include &lt;linux/preempt.h&gt;
+#include &lt;linux/rcupdate.h&gt;
+#include &lt;linux/sched.h&gt;
+#include &lt;linux/sched/rt.h&gt;
+#include &lt;linux/six.h&gt;
+#include &lt;linux/slab.h&gt;
+
+#ifdef DEBUG
+#define EBUG_ON(cond)		BUG_ON(cond)
+#else
+#define EBUG_ON(cond)		do {} while (0)
+#endif
+
+#define six_acquire(l, t)	lock_acquire(l, 0, t, 0, 0, NULL, _RET_IP_)
+#define six_release(l)		lock_release(l, _RET_IP_)
+
+struct six_lock_vals {
+	/* Value we add to the lock in order to take the lock: */
+	u64			lock_val;
+
+	/* If the lock has this value (used as a mask), taking the lock fails: */
+	u64			lock_fail;
+
+	/* Value we add to the lock in order to release the lock: */
+	u64			unlock_val;
+
+	/* Mask that indicates lock is held for this type: */
+	u64			held_mask;
+
+	/* Waitlist we wakeup when releasing the lock: */
+	enum six_lock_type	unlock_wakeup;
+};
+
+#define __SIX_LOCK_HELD_read	__SIX_VAL(read_lock, ~0)
+#define __SIX_LOCK_HELD_intent	__SIX_VAL(intent_lock, ~0)
+#define __SIX_LOCK_HELD_write	__SIX_VAL(seq, 1)
+
+#define LOCK_VALS {							\
+	[SIX_LOCK_read] = {						\
+		.lock_val	= __SIX_VAL(read_lock, 1),		\
+		.lock_fail	= __SIX_LOCK_HELD_write + __SIX_VAL(write_locking, 1),\
+		.unlock_val	= -__SIX_VAL(read_lock, 1),		\
+		.held_mask	= __SIX_LOCK_HELD_read,			\
+		.unlock_wakeup	= SIX_LOCK_write,			\
+	},								\
+	[SIX_LOCK_intent] = {						\
+		.lock_val	= __SIX_VAL(intent_lock, 1),		\
+		.lock_fail	= __SIX_LOCK_HELD_intent,		\
+		.unlock_val	= -__SIX_VAL(intent_lock, 1),		\
+		.held_mask	= __SIX_LOCK_HELD_intent,		\
+		.unlock_wakeup	= SIX_LOCK_intent,			\
+	},								\
+	[SIX_LOCK_write] = {						\
+		.lock_val	= __SIX_VAL(seq, 1),			\
+		.lock_fail	= __SIX_LOCK_HELD_read,			\
+		.unlock_val	= __SIX_VAL(seq, 1),			\
+		.held_mask	= __SIX_LOCK_HELD_write,		\
+		.unlock_wakeup	= SIX_LOCK_read,			\
+	},								\
+}
+
+static inline void six_set_owner(struct six_lock *lock, enum six_lock_type type,
+				 union six_lock_state old)
+{
+	if (type != SIX_LOCK_intent)
+		return;
+
+	if (!old.intent_lock) {
+		EBUG_ON(lock-&gt;owner);
+		lock-&gt;owner = current;
+	} else {
+		EBUG_ON(lock-&gt;owner != current);
+	}
+}
+
+static inline unsigned pcpu_read_count(struct six_lock *lock)
+{
+	unsigned read_count = 0;
+	int cpu;
+
+	for_each_possible_cpu(cpu)
+		read_count += *per_cpu_ptr(lock-&gt;readers, cpu);
+	return read_count;
+}
+
+struct six_lock_waiter {
+	struct list_head	list;
+	struct task_struct	*task;
+};
+
+/* This is probably up there with the more evil things I&#39;ve done */
+#define waitlist_bitnr(id) ilog2((((union six_lock_state) { .waiters = 1 &lt;&lt; (id) }).l))
+
+static inline void six_lock_wakeup(struct six_lock *lock,
+				   union six_lock_state state,
+				   unsigned waitlist_id)
+{
+	if (waitlist_id == SIX_LOCK_write) {
+		if (state.write_locking &amp;&amp; !state.read_lock) {
+			struct task_struct *p = READ_ONCE(lock-&gt;owner);
+			if (p)
+				wake_up_process(p);
+		}
+	} else {
+		struct list_head *wait_list = &amp;lock-&gt;wait_list[waitlist_id];
+		struct six_lock_waiter *w, *next;
+
+		if (!(state.waiters &amp; (1 &lt;&lt; waitlist_id)))
+			return;
+
+		clear_bit(waitlist_bitnr(waitlist_id),
+			  (unsigned long *) &amp;lock-&gt;state.v);
+
+		raw_spin_lock(&amp;lock-&gt;wait_lock);
+
+		list_for_each_entry_safe(w, next, wait_list, list) {
+			list_del_init(&amp;w-&gt;list);
+
+			if (wake_up_process(w-&gt;task) &amp;&amp;
+			    waitlist_id != SIX_LOCK_read) {
+				if (!list_empty(wait_list))
+					set_bit(waitlist_bitnr(waitlist_id),
+						(unsigned long *) &amp;lock-&gt;state.v);
+				break;
+			}
+		}
+
+		raw_spin_unlock(&amp;lock-&gt;wait_lock);
+	}
+}
+
+static __always_inline bool do_six_trylock_type(struct six_lock *lock,
+						enum six_lock_type type,
+						bool try)
+{
+	const struct six_lock_vals l[] = LOCK_VALS;
+	union six_lock_state old, new;
+	bool ret;
+	u64 v;
+
+	EBUG_ON(type == SIX_LOCK_write &amp;&amp; lock-&gt;owner != current);
+	EBUG_ON(type == SIX_LOCK_write &amp;&amp; (lock-&gt;state.seq &amp; 1));
+
+	EBUG_ON(type == SIX_LOCK_write &amp;&amp; (try != !(lock-&gt;state.write_locking)));
+
+	/*
+	 * Percpu reader mode:
+	 *
+	 * The basic idea behind this algorithm is that you can implement a lock
+	 * between two threads without any atomics, just memory barriers:
+	 *
+	 * For two threads you&#39;ll need two variables, one variable for &#34;thread a
+	 * has the lock&#34; and another for &#34;thread b has the lock&#34;.
+	 *
+	 * To take the lock, a thread sets its variable indicating that it holds
+	 * the lock, then issues a full memory barrier, then reads from the
+	 * other thread&#39;s variable to check if the other thread thinks it has
+	 * the lock. If we raced, we backoff and retry/sleep.
+	 */
+
+	if (type == SIX_LOCK_read &amp;&amp; lock-&gt;readers) {
+retry:
+		preempt_disable();
+		this_cpu_inc(*lock-&gt;readers); /* signal that we own lock */
+
+		smp_mb();
+
+		old.v = READ_ONCE(lock-&gt;state.v);
+		ret = !(old.v &amp; l[type].lock_fail);
+
+		this_cpu_sub(*lock-&gt;readers, !ret);
+		preempt_enable();
+
+		/*
+		 * If we failed because a writer was trying to take the
+		 * lock, issue a wakeup because we might have caused a
+		 * spurious trylock failure:
+		 */
+		if (old.write_locking) {
+			struct task_struct *p = READ_ONCE(lock-&gt;owner);
+
+			if (p)
+				wake_up_process(p);
+		}
+
+		/*
+		 * If we failed from the lock path and the waiting bit wasn&#39;t
+		 * set, set it:
+		 */
+		if (!try &amp;&amp; !ret) {
+			v = old.v;
+
+			do {
+				new.v = old.v = v;
+
+				if (!(old.v &amp; l[type].lock_fail))
+					goto retry;
+
+				if (new.waiters &amp; (1 &lt;&lt; type))
+					break;
+
+				new.waiters |= 1 &lt;&lt; type;
+			} while ((v = atomic64_cmpxchg(&amp;lock-&gt;state.counter,
+						       old.v, new.v)) != old.v);
+		}
+	} else if (type == SIX_LOCK_write &amp;&amp; lock-&gt;readers) {
+		if (try) {
+			atomic64_add(__SIX_VAL(write_locking, 1),
+				     &amp;lock-&gt;state.counter);
+			smp_mb__after_atomic();
+		}
+
+		ret = !pcpu_read_count(lock);
+
+		/*
+		 * On success, we increment lock-&gt;seq; also we clear
+		 * write_locking unless we failed from the lock path:
+		 */
+		v = 0;
+		if (ret)
+			v += __SIX_VAL(seq, 1);
+		if (ret || try)
+			v -= __SIX_VAL(write_locking, 1);
+
+		if (try &amp;&amp; !ret) {
+			old.v = atomic64_add_return(v, &amp;lock-&gt;state.counter);
+			six_lock_wakeup(lock, old, SIX_LOCK_read);
+		} else {
+			atomic64_add(v, &amp;lock-&gt;state.counter);
+		}
+	} else {
+		v = READ_ONCE(lock-&gt;state.v);
+		do {
+			new.v = old.v = v;
+
+			if (!(old.v &amp; l[type].lock_fail)) {
+				new.v += l[type].lock_val;
+
+				if (type == SIX_LOCK_write)
+					new.write_locking = 0;
+			} else if (!try &amp;&amp; type != SIX_LOCK_write &amp;&amp;
+				   !(new.waiters &amp; (1 &lt;&lt; type)))
+				new.waiters |= 1 &lt;&lt; type;
+			else
+				break; /* waiting bit already set */
+		} while ((v = atomic64_cmpxchg_acquire(&amp;lock-&gt;state.counter,
+					old.v, new.v)) != old.v);
+
+		ret = !(old.v &amp; l[type].lock_fail);
+
+		EBUG_ON(ret &amp;&amp; !(lock-&gt;state.v &amp; l[type].held_mask));
+	}
+
+	if (ret)
+		six_set_owner(lock, type, old);
+
+	EBUG_ON(type == SIX_LOCK_write &amp;&amp; (try || ret) &amp;&amp; (lock-&gt;state.write_locking));
+
+	return ret;
+}
+
+__always_inline __flatten
+static bool __six_trylock_type(struct six_lock *lock, enum six_lock_type type)
+{
+	if (!do_six_trylock_type(lock, type, true))
+		return false;
+
+	if (type != SIX_LOCK_write)
+		six_acquire(&amp;lock-&gt;dep_map, 1);
+	return true;
+}
+
+__always_inline __flatten
+static bool __six_relock_type(struct six_lock *lock, enum six_lock_type type,
+			      unsigned seq)
+{
+	const struct six_lock_vals l[] = LOCK_VALS;
+	union six_lock_state old;
+	u64 v;
+
+	EBUG_ON(type == SIX_LOCK_write);
+
+	if (type == SIX_LOCK_read &amp;&amp;
+	    lock-&gt;readers) {
+		bool ret;
+
+		preempt_disable();
+		this_cpu_inc(*lock-&gt;readers);
+
+		smp_mb();
+
+		old.v = READ_ONCE(lock-&gt;state.v);
+		ret = !(old.v &amp; l[type].lock_fail) &amp;&amp; old.seq == seq;
+
+		this_cpu_sub(*lock-&gt;readers, !ret);
+		preempt_enable();
+
+		/*
+		 * Similar to the lock path, we may have caused a spurious write
+		 * lock fail and need to issue a wakeup:
+		 */
+		if (old.write_locking) {
+			struct task_struct *p = READ_ONCE(lock-&gt;owner);
+
+			if (p)
+				wake_up_process(p);
+		}
+
+		if (ret)
+			six_acquire(&amp;lock-&gt;dep_map, 1);
+
+		return ret;
+	}
+
+	v = READ_ONCE(lock-&gt;state.v);
+	do {
+		old.v = v;
+
+		if (old.seq != seq || old.v &amp; l[type].lock_fail)
+			return false;
+	} while ((v = atomic64_cmpxchg_acquire(&amp;lock-&gt;state.counter,
+				old.v,
+				old.v + l[type].lock_val)) != old.v);
+
+	six_set_owner(lock, type, old);
+	if (type != SIX_LOCK_write)
+		six_acquire(&amp;lock-&gt;dep_map, 1);
+	return true;
+}
+
+#ifdef CONFIG_LOCK_SPIN_ON_OWNER
+
+static inline int six_can_spin_on_owner(struct six_lock *lock)
+{
+	struct task_struct *owner;
+	int retval = 1;
+
+	if (need_resched())
+		return 0;
+
+	rcu_read_lock();
+	owner = READ_ONCE(lock-&gt;owner);
+	if (owner)
+		retval = owner-&gt;on_cpu;
+	rcu_read_unlock();
+	/*
+	 * if lock-&gt;owner is not set, the mutex owner may have just acquired
+	 * it and not set the owner yet or the mutex has been released.
+	 */
+	return retval;
+}
+
+static inline bool six_spin_on_owner(struct six_lock *lock,
+				     struct task_struct *owner)
+{
+	bool ret = true;
+
+	rcu_read_lock();
+	while (lock-&gt;owner == owner) {
+		/*
+		 * Ensure we emit the owner-&gt;on_cpu, dereference _after_
+		 * checking lock-&gt;owner still matches owner. If that fails,
+		 * owner might point to freed memory. If it still matches,
+		 * the rcu_read_lock() ensures the memory stays valid.
+		 */
+		barrier();
+
+		if (!owner-&gt;on_cpu || need_resched()) {
+			ret = false;
+			break;
+		}
+
+		cpu_relax();
+	}
+	rcu_read_unlock();
+
+	return ret;
+}
+
+static inline bool six_optimistic_spin(struct six_lock *lock, enum six_lock_type type)
+{
+	struct task_struct *task = current;
+
+	if (type == SIX_LOCK_write)
+		return false;
+
+	preempt_disable();
+	if (!six_can_spin_on_owner(lock))
+		goto fail;
+
+	if (!osq_lock(&amp;lock-&gt;osq))
+		goto fail;
+
+	while (1) {
+		struct task_struct *owner;
+
+		/*
+		 * If there&#39;s an owner, wait for it to either
+		 * release the lock or go to sleep.
+		 */
+		owner = READ_ONCE(lock-&gt;owner);
+		if (owner &amp;&amp; !six_spin_on_owner(lock, owner))
+			break;
+
+		if (do_six_trylock_type(lock, type, false)) {
+			osq_unlock(&amp;lock-&gt;osq);
+			preempt_enable();
+			return true;
+		}
+
+		/*
+		 * When there&#39;s no owner, we might have preempted between the
+		 * owner acquiring the lock and setting the owner field. If
+		 * we&#39;re an RT task that will live-lock because we won&#39;t let
+		 * the owner complete.
+		 */
+		if (!owner &amp;&amp; (need_resched() || rt_task(task)))
+			break;
+
+		/*
+		 * The cpu_relax() call is a compiler barrier which forces
+		 * everything in this loop to be re-loaded. We don&#39;t need
+		 * memory barriers as we&#39;ll eventually observe the right
+		 * values at the cost of a few extra spins.
+		 */
+		cpu_relax();
+	}
+
+	osq_unlock(&amp;lock-&gt;osq);
+fail:
+	preempt_enable();
+
+	/*
+	 * If we fell out of the spin path because of need_resched(),
+	 * reschedule now, before we try-lock again. This avoids getting
+	 * scheduled out right after we obtained the lock.
+	 */
+	if (need_resched())
+		schedule();
+
+	return false;
+}
+
+#else /* CONFIG_LOCK_SPIN_ON_OWNER */
+
+static inline bool six_optimistic_spin(struct six_lock *lock, enum six_lock_type type)
+{
+	return false;
+}
+
+#endif
+
+noinline
+static int __six_lock_type_slowpath(struct six_lock *lock, enum six_lock_type type,
+				    six_lock_should_sleep_fn should_sleep_fn, void *p)
+{
+	union six_lock_state old;
+	struct six_lock_waiter wait;
+	int ret = 0;
+
+	if (type == SIX_LOCK_write) {
+		EBUG_ON(lock-&gt;state.write_locking);
+		atomic64_add(__SIX_VAL(write_locking, 1), &amp;lock-&gt;state.counter);
+		smp_mb__after_atomic();
+	}
+
+	ret = should_sleep_fn ? should_sleep_fn(lock, p) : 0;
+	if (ret)
+		goto out_before_sleep;
+
+	if (six_optimistic_spin(lock, type))
+		goto out_before_sleep;
+
+	lock_contended(&amp;lock-&gt;dep_map, _RET_IP_);
+
+	INIT_LIST_HEAD(&amp;wait.list);
+	wait.task = current;
+
+	while (1) {
+		set_current_state(TASK_UNINTERRUPTIBLE);
+		if (type == SIX_LOCK_write)
+			EBUG_ON(lock-&gt;owner != current);
+		else if (list_empty_careful(&amp;wait.list)) {
+			raw_spin_lock(&amp;lock-&gt;wait_lock);
+			list_add_tail(&amp;wait.list, &amp;lock-&gt;wait_list[type]);
+			raw_spin_unlock(&amp;lock-&gt;wait_lock);
+		}
+
+		if (do_six_trylock_type(lock, type, false))
+			break;
+
+		ret = should_sleep_fn ? should_sleep_fn(lock, p) : 0;
+		if (ret)
+			break;
+
+		schedule();
+	}
+
+	__set_current_state(TASK_RUNNING);
+
+	if (!list_empty_careful(&amp;wait.list)) {
+		raw_spin_lock(&amp;lock-&gt;wait_lock);
+		list_del_init(&amp;wait.list);
+		raw_spin_unlock(&amp;lock-&gt;wait_lock);
+	}
+out_before_sleep:
+	if (ret &amp;&amp; type == SIX_LOCK_write) {
+		old.v = atomic64_sub_return(__SIX_VAL(write_locking, 1),
+					    &amp;lock-&gt;state.counter);
+		six_lock_wakeup(lock, old, SIX_LOCK_read);
+	}
+
+	return ret;
+}
+
+__always_inline
+static int __six_lock_type(struct six_lock *lock, enum six_lock_type type,
+			   six_lock_should_sleep_fn should_sleep_fn, void *p)
+{
+	int ret;
+
+	if (type != SIX_LOCK_write)
+		six_acquire(&amp;lock-&gt;dep_map, 0);
+
+	ret = do_six_trylock_type(lock, type, true) ? 0
+		: __six_lock_type_slowpath(lock, type, should_sleep_fn, p);
+
+	if (ret &amp;&amp; type != SIX_LOCK_write)
+		six_release(&amp;lock-&gt;dep_map);
+	if (!ret)
+		lock_acquired(&amp;lock-&gt;dep_map, _RET_IP_);
+
+	return ret;
+}
+
+__always_inline __flatten
+static void __six_unlock_type(struct six_lock *lock, enum six_lock_type type)
+{
+	const struct six_lock_vals l[] = LOCK_VALS;
+	union six_lock_state state;
+
+	EBUG_ON(type == SIX_LOCK_write &amp;&amp;
+		!(lock-&gt;state.v &amp; __SIX_LOCK_HELD_intent));
+
+	if (type != SIX_LOCK_write)
+		six_release(&amp;lock-&gt;dep_map);
+
+	if (type == SIX_LOCK_intent) {
+		EBUG_ON(lock-&gt;owner != current);
+
+		if (lock-&gt;intent_lock_recurse) {
+			--lock-&gt;intent_lock_recurse;
+			return;
+		}
+
+		lock-&gt;owner = NULL;
+	}
+
+	if (type == SIX_LOCK_read &amp;&amp;
+	    lock-&gt;readers) {
+		smp_mb(); /* unlock barrier */
+		this_cpu_dec(*lock-&gt;readers);
+		smp_mb(); /* between unlocking and checking for waiters */
+		state.v = READ_ONCE(lock-&gt;state.v);
+	} else {
+		EBUG_ON(!(lock-&gt;state.v &amp; l[type].held_mask));
+		state.v = atomic64_add_return_release(l[type].unlock_val,
+						      &amp;lock-&gt;state.counter);
+	}
+
+	six_lock_wakeup(lock, state, l[type].unlock_wakeup);
+}
+
+#define __SIX_LOCK(type)						\
+bool six_trylock_##type(struct six_lock *lock)				\
+{									\
+	return __six_trylock_type(lock, SIX_LOCK_##type);		\
+}									\
+EXPORT_SYMBOL_GPL(six_trylock_##type);					\
+									\
+bool six_relock_##type(struct six_lock *lock, u32 seq)			\
+{									\
+	return __six_relock_type(lock, SIX_LOCK_##type, seq);		\
+}									\
+EXPORT_SYMBOL_GPL(six_relock_##type);					\
+									\
+int six_lock_##type(struct six_lock *lock,				\
+		    six_lock_should_sleep_fn should_sleep_fn, void *p)	\
+{									\
+	return __six_lock_type(lock, SIX_LOCK_##type, should_sleep_fn, p);\
+}									\
+EXPORT_SYMBOL_GPL(six_lock_##type);					\
+									\
+void six_unlock_##type(struct six_lock *lock)				\
+{									\
+	__six_unlock_type(lock, SIX_LOCK_##type);			\
+}									\
+EXPORT_SYMBOL_GPL(six_unlock_##type);
+
+__SIX_LOCK(read)
+__SIX_LOCK(intent)
+__SIX_LOCK(write)
+
+#undef __SIX_LOCK
+
+/* Convert from intent to read: */
+void six_lock_downgrade(struct six_lock *lock)
+{
+	six_lock_increment(lock, SIX_LOCK_read);
+	six_unlock_intent(lock);
+}
+EXPORT_SYMBOL_GPL(six_lock_downgrade);
+
+bool six_lock_tryupgrade(struct six_lock *lock)
+{
+	union six_lock_state old, new;
+	u64 v = READ_ONCE(lock-&gt;state.v);
+
+	do {
+		new.v = old.v = v;
+
+		if (new.intent_lock)
+			return false;
+
+		if (!lock-&gt;readers) {
+			EBUG_ON(!new.read_lock);
+			new.read_lock--;
+		}
+
+		new.intent_lock = 1;
+	} while ((v = atomic64_cmpxchg_acquire(&amp;lock-&gt;state.counter,
+				old.v, new.v)) != old.v);
+
+	if (lock-&gt;readers)
+		this_cpu_dec(*lock-&gt;readers);
+
+	six_set_owner(lock, SIX_LOCK_intent, old);
+
+	return true;
+}
+EXPORT_SYMBOL_GPL(six_lock_tryupgrade);
+
+bool six_trylock_convert(struct six_lock *lock,
+			 enum six_lock_type from,
+			 enum six_lock_type to)
+{
+	EBUG_ON(to == SIX_LOCK_write || from == SIX_LOCK_write);
+
+	if (to == from)
+		return true;
+
+	if (to == SIX_LOCK_read) {
+		six_lock_downgrade(lock);
+		return true;
+	} else {
+		return six_lock_tryupgrade(lock);
+	}
+}
+EXPORT_SYMBOL_GPL(six_trylock_convert);
+
+/*
+ * Increment read/intent lock count, assuming we already have it read or intent
+ * locked:
+ */
+void six_lock_increment(struct six_lock *lock, enum six_lock_type type)
+{
+	const struct six_lock_vals l[] = LOCK_VALS;
+
+	six_acquire(&amp;lock-&gt;dep_map, 0);
+
+	/* XXX: assert already locked, and that we don&#39;t overflow: */
+
+	switch (type) {
+	case SIX_LOCK_read:
+		if (lock-&gt;readers) {
+			this_cpu_inc(*lock-&gt;readers);
+		} else {
+			EBUG_ON(!lock-&gt;state.read_lock &amp;&amp;
+				!lock-&gt;state.intent_lock);
+			atomic64_add(l[type].lock_val, &amp;lock-&gt;state.counter);
+		}
+		break;
+	case SIX_LOCK_intent:
+		EBUG_ON(!lock-&gt;state.intent_lock);
+		lock-&gt;intent_lock_recurse++;
+		break;
+	case SIX_LOCK_write:
+		BUG();
+		break;
+	}
+}
+EXPORT_SYMBOL_GPL(six_lock_increment);
+
+void six_lock_wakeup_all(struct six_lock *lock)
+{
+	struct six_lock_waiter *w;
+
+	raw_spin_lock(&amp;lock-&gt;wait_lock);
+
+	list_for_each_entry(w, &amp;lock-&gt;wait_list[0], list)
+		wake_up_process(w-&gt;task);
+	list_for_each_entry(w, &amp;lock-&gt;wait_list[1], list)
+		wake_up_process(w-&gt;task);
+
+	raw_spin_unlock(&amp;lock-&gt;wait_lock);
+}
+EXPORT_SYMBOL_GPL(six_lock_wakeup_all);
+
+struct free_pcpu_rcu {
+	struct rcu_head		rcu;
+	void __percpu		*p;
+};
+
+static void free_pcpu_rcu_fn(struct rcu_head *_rcu)
+{
+	struct free_pcpu_rcu *rcu =
+		container_of(_rcu, struct free_pcpu_rcu, rcu);
+
+	free_percpu(rcu-&gt;p);
+	kfree(rcu);
+}
+
+void six_lock_pcpu_free_rcu(struct six_lock *lock)
+{
+	struct free_pcpu_rcu *rcu = kzalloc(sizeof(*rcu), GFP_KERNEL);
+
+	if (!rcu)
+		return;
+
+	rcu-&gt;p = lock-&gt;readers;
+	lock-&gt;readers = NULL;
+
+	call_rcu(&amp;rcu-&gt;rcu, free_pcpu_rcu_fn);
+}
+EXPORT_SYMBOL_GPL(six_lock_pcpu_free_rcu);
+
+void six_lock_pcpu_free(struct six_lock *lock)
+{
+	BUG_ON(lock-&gt;readers &amp;&amp; pcpu_read_count(lock));
+	BUG_ON(lock-&gt;state.read_lock);
+
+	free_percpu(lock-&gt;readers);
+	lock-&gt;readers = NULL;
+}
+EXPORT_SYMBOL_GPL(six_lock_pcpu_free);
+
+void six_lock_pcpu_alloc(struct six_lock *lock)
+{
+#ifdef __KERNEL__
+	if (!lock-&gt;readers)
+		lock-&gt;readers = alloc_percpu(unsigned);
+#endif
+}
+EXPORT_SYMBOL_GPL(six_lock_pcpu_alloc);
+
+/*
+ * Returns lock held counts, for both read and intent
+ */
+struct six_lock_count six_lock_counts(struct six_lock *lock)
+{
+	struct six_lock_count ret = { 0, lock-&gt;state.intent_lock };
+
+	if (!lock-&gt;readers)
+		ret.read += lock-&gt;state.read_lock;
+	else {
+		int cpu;
+
+		for_each_possible_cpu(cpu)
+			ret.read += *per_cpu_ptr(lock-&gt;readers, cpu);
+	}
+
+	return ret;
+}
+EXPORT_SYMBOL_GPL(six_lock_counts);
</span>-- 
2.40.1


<a href="#mdf1a03c4a94e7bb6300666e5af4374084ddc4390" id="edf1a03c4a94e7bb6300666e5af4374084ddc4390">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-5-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-5-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-5-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-5-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-5-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-5-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#rdf1a03c4a94e7bb6300666e5af4374084ddc4390">73+ messages in thread</a></pre><hr/><pre><a href="#e8684754525a2d9a18e06f6d5f8b3cb9704c79a90" id="m8684754525a2d9a18e06f6d5f8b3cb9704c79a90">*</a> <b>[PATCH 05/32] MAINTAINERS: Add entry for six locks</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#rdf1a03c4a94e7bb6300666e5af4374084ddc4390">(3 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#mdf1a03c4a94e7bb6300666e5af4374084ddc4390">[PATCH 04/32] locking: SIX locks (shared/intent/exclusive)</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#mc6f62d46382370e1205be68249bfa6f9a8f7f35c">[PATCH 06/32] sched: Add task_struct-&gt;faults_disabled_mapping</a> Kent Overstreet
                   ` <a href="#rc6f62d46382370e1205be68249bfa6f9a8f7f35c">(26 subsequent siblings)</a>
  <a href="#r8684754525a2d9a18e06f6d5f8b3cb9704c79a90">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-6-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-6-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs; <b>+Cc:</b> Kent Overstreet

SIX locks are a new locking primitive, shared/intent/exclusive,
currently used by bcachefs but available for other uses. Mark them as
maintained.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-6-kent.overstreet::40linux.dev:1MAINTAINERS" href="#Z2e.:..:20230509165657.1735798-6-kent.overstreet::40linux.dev:1MAINTAINERS">MAINTAINERS</a> | 8 ++++++++
 1 file <a href="#e8684754525a2d9a18e06f6d5f8b3cb9704c79a90">changed</a>, 8 insertions(+)

<span><a href="#iZ2e.:..:20230509165657.1735798-6-kent.overstreet::40linux.dev:1MAINTAINERS" id="Z2e.:..:20230509165657.1735798-6-kent.overstreet::40linux.dev:1MAINTAINERS">diff</a> --git a/MAINTAINERS b/MAINTAINERS
index c6545eb541..3fc37de3d6 100644
--- a/MAINTAINERS
+++ b/MAINTAINERS
</span><span>@@ -19166,6 +19166,14 @@ S:	Maintained
</span> W:	<a href="http://www.winischhofer.at/linuxsisusbvga.shtml">http://www.winischhofer.at/linuxsisusbvga.shtml</a>
 F:	drivers/usb/misc/sisusbvga/
 
<span>+SIX LOCKS
+M:	Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
+L:	linux-bcachefs@vger.kernel.org
+S:	Supported
+C:	irc://irc.oftc.net/bcache
+F:	include/linux/six.h
+F:	kernel/locking/six.c
+
</span> SL28 CPLD MFD DRIVER
 M:	Michael Walle &lt;michael@walle.cc&gt;
 S:	Maintained
-- 
2.40.1


<a href="#m8684754525a2d9a18e06f6d5f8b3cb9704c79a90" id="e8684754525a2d9a18e06f6d5f8b3cb9704c79a90">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-6-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-6-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-6-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-6-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-6-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-6-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r8684754525a2d9a18e06f6d5f8b3cb9704c79a90">73+ messages in thread</a></pre><hr/><pre><a href="#ec6f62d46382370e1205be68249bfa6f9a8f7f35c" id="mc6f62d46382370e1205be68249bfa6f9a8f7f35c">*</a> <b>[PATCH 06/32] sched: Add task_struct-&gt;faults_disabled_mapping</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#r8684754525a2d9a18e06f6d5f8b3cb9704c79a90">(4 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#m8684754525a2d9a18e06f6d5f8b3cb9704c79a90">[PATCH 05/32] MAINTAINERS: Add entry for six locks</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-10  1:07   ` <a href="#m613d136f0d8a1ed3d18224d73c012f467295aa60">Jan Kara</a>
  2023-05-09 16:56 ` <a href="#mcabddb3f4bded12301500ae05b7bcb26474a2aa4">[PATCH 07/32] mm: Bring back vmalloc_exec</a> Kent Overstreet
                   ` <a href="#rcabddb3f4bded12301500ae05b7bcb26474a2aa4">(25 subsequent siblings)</a>
  <a href="#rc6f62d46382370e1205be68249bfa6f9a8f7f35c">31 siblings, 1 reply; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-7-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-7-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Kent Overstreet, Jan Kara, Darrick J . Wong

From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;

This is used by bcachefs to fix a page cache coherency issue with
O_DIRECT writes.

Also relevant: mapping-&gt;invalidate_lock, see below.

O_DIRECT writes (and other filesystem operations that modify file data
while bypassing the page cache) need to shoot down ranges of the page
cache - and additionally, need locking to prevent those pages from
pulled back in.

But O_DIRECT writes invoke the page fault handler (via get_user_pages),
and the page fault handler will need to take that same lock - this is a
classic recursive deadlock if userspace has mmaped the file they&#39;re DIO
writing to and uses those pages for the buffer to write from, and it&#39;s a
lock ordering deadlock in general.

Thus we need a way to signal from the dio code to the page fault handler
when we already are holding the pagecache add lock on an address space -
this patch just adds a member to task_struct for this purpose. For now
only bcachefs is implementing this locking, though it may be moved out
of bcachefs and made available to other filesystems in the future.

---------------------------------

The closest current VFS equivalent is mapping-&gt;invalidate_lock, which
comes from XFS. However, it&#39;s not used by direct IO.  Instead, direct IO
paths shoot down the page cache twice - before starting the IO and at
the end, and they&#39;re still technically racy w.r.t. page cache coherency.

This is a more complete approach: in the future we might consider
replacing mapping-&gt;invalidate_lock with the bcachefs code.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
Cc: Jan Kara &lt;jack@suse.cz&gt;
Cc: Darrick J. Wong &lt;djwong@kernel.org&gt;
Cc: linux-fsdevel@vger.kernel.org
---
 <a id="iZ2e.:..:20230509165657.1735798-7-kent.overstreet::40linux.dev:1include:linux:sched.h" href="#Z2e.:..:20230509165657.1735798-7-kent.overstreet::40linux.dev:1include:linux:sched.h">include/linux/sched.h</a> | 1 +
 <a id="iZ2e.:..:20230509165657.1735798-7-kent.overstreet::40linux.dev:1init:init_task.c" href="#Z2e.:..:20230509165657.1735798-7-kent.overstreet::40linux.dev:1init:init_task.c">init/init_task.c</a>      | 1 +
 2 files <a href="#ec6f62d46382370e1205be68249bfa6f9a8f7f35c">changed</a>, 2 insertions(+)

<span><a href="#iZ2e.:..:20230509165657.1735798-7-kent.overstreet::40linux.dev:1include:linux:sched.h" id="Z2e.:..:20230509165657.1735798-7-kent.overstreet::40linux.dev:1include:linux:sched.h">diff</a> --git a/include/linux/sched.h b/include/linux/sched.h
index 63d242164b..f2a56f64f7 100644
--- a/include/linux/sched.h
+++ b/include/linux/sched.h
</span><span>@@ -869,6 +869,7 @@ struct task_struct {
</span> 
 	struct mm_struct		*mm;
 	struct mm_struct		*active_mm;
<span>+	struct address_space		*faults_disabled_mapping;
</span> 
 	int				exit_state;
 	int				exit_code;
<span><a href="#iZ2e.:..:20230509165657.1735798-7-kent.overstreet::40linux.dev:1init:init_task.c" id="Z2e.:..:20230509165657.1735798-7-kent.overstreet::40linux.dev:1init:init_task.c">diff</a> --git a/init/init_task.c b/init/init_task.c
index ff6c4b9bfe..f703116e05 100644
--- a/init/init_task.c
+++ b/init/init_task.c
</span><span>@@ -85,6 +85,7 @@ struct task_struct init_task
</span> 	.nr_cpus_allowed= NR_CPUS,
 	.mm		= NULL,
 	.active_mm	= &amp;init_mm,
<span>+	.faults_disabled_mapping = NULL,
</span> 	.restart_block	= {
 		.fn = do_no_restart_syscall,
 	},
-- 
2.40.1


<a href="#mc6f62d46382370e1205be68249bfa6f9a8f7f35c" id="ec6f62d46382370e1205be68249bfa6f9a8f7f35c">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-7-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-7-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-7-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-7-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-7-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-7-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#rc6f62d46382370e1205be68249bfa6f9a8f7f35c">73+ messages in thread</a></pre><hr/><pre><a href="#ecabddb3f4bded12301500ae05b7bcb26474a2aa4" id="mcabddb3f4bded12301500ae05b7bcb26474a2aa4">*</a> <b>[PATCH 07/32] mm: Bring back vmalloc_exec</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#rc6f62d46382370e1205be68249bfa6f9a8f7f35c">(5 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#mc6f62d46382370e1205be68249bfa6f9a8f7f35c">[PATCH 06/32] sched: Add task_struct-&gt;faults_disabled_mapping</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 18:19   ` <a href="#m4441d42cf9b00ca0af1c77affa4e0e32fc889be6">Lorenzo Stoakes</a>
                     ` <a href="#r4441d42cf9b00ca0af1c77affa4e0e32fc889be6">(3 more replies)</a>
  2023-05-09 16:56 ` <a href="#m702650dbd641de54c259f6831566def2a84bf204">[PATCH 08/32] fs: factor out d_mark_tmpfile()</a> Kent Overstreet
                   ` <a href="#r702650dbd641de54c259f6831566def2a84bf204">(24 subsequent siblings)</a>
  <a href="#rcabddb3f4bded12301500ae05b7bcb26474a2aa4">31 siblings, 4 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-8-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-8-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Kent Overstreet, Andrew Morton,
	Uladzislau Rezki, Christoph Hellwig, linux-mm

From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;

This is needed for bcachefs, which dynamically generates per-btree node
unpack functions.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
Cc: Andrew Morton &lt;akpm@linux-foundation.org&gt;
Cc: Uladzislau Rezki &lt;urezki@gmail.com&gt;
Cc: Christoph Hellwig &lt;hch@infradead.org&gt;
Cc: linux-mm@kvack.org
---
 <a id="iZ2e.:..:20230509165657.1735798-8-kent.overstreet::40linux.dev:1include:linux:vmalloc.h" href="#Z2e.:..:20230509165657.1735798-8-kent.overstreet::40linux.dev:1include:linux:vmalloc.h">include/linux/vmalloc.h</a> |  1 +
 <a id="iZ2e.:..:20230509165657.1735798-8-kent.overstreet::40linux.dev:1kernel:module:main.c" href="#Z2e.:..:20230509165657.1735798-8-kent.overstreet::40linux.dev:1kernel:module:main.c">kernel/module/main.c</a>    |  4 +---
 <a id="iZ2e.:..:20230509165657.1735798-8-kent.overstreet::40linux.dev:1mm:nommu.c" href="#Z2e.:..:20230509165657.1735798-8-kent.overstreet::40linux.dev:1mm:nommu.c">mm/nommu.c</a>              | 18 ++++++++++++++++++
 <a id="iZ2e.:..:20230509165657.1735798-8-kent.overstreet::40linux.dev:1mm:vmalloc.c" href="#Z2e.:..:20230509165657.1735798-8-kent.overstreet::40linux.dev:1mm:vmalloc.c">mm/vmalloc.c</a>            | 21 +++++++++++++++++++++
 4 files <a href="#ecabddb3f4bded12301500ae05b7bcb26474a2aa4">changed</a>, 41 insertions(+), 3 deletions(-)

<span><a href="#iZ2e.:..:20230509165657.1735798-8-kent.overstreet::40linux.dev:1include:linux:vmalloc.h" id="Z2e.:..:20230509165657.1735798-8-kent.overstreet::40linux.dev:1include:linux:vmalloc.h">diff</a> --git a/include/linux/vmalloc.h b/include/linux/vmalloc.h
index 69250efa03..ff147fe115 100644
--- a/include/linux/vmalloc.h
+++ b/include/linux/vmalloc.h
</span><span>@@ -145,6 +145,7 @@ extern void *vzalloc(unsigned long size) __alloc_size(1);
</span> extern void *vmalloc_user(unsigned long size) __alloc_size(1);
 extern void *vmalloc_node(unsigned long size, int node) __alloc_size(1);
 extern void *vzalloc_node(unsigned long size, int node) __alloc_size(1);
<span>+extern void *vmalloc_exec(unsigned long size, gfp_t gfp_mask) __alloc_size(1);
</span> extern void *vmalloc_32(unsigned long size) __alloc_size(1);
 extern void *vmalloc_32_user(unsigned long size) __alloc_size(1);
 extern void *__vmalloc(unsigned long size, gfp_t gfp_mask) __alloc_size(1);
<span><a href="#iZ2e.:..:20230509165657.1735798-8-kent.overstreet::40linux.dev:1kernel:module:main.c" id="Z2e.:..:20230509165657.1735798-8-kent.overstreet::40linux.dev:1kernel:module:main.c">diff</a> --git a/kernel/module/main.c b/kernel/module/main.c
index d3be89de70..9eaa89e84c 100644
--- a/kernel/module/main.c
+++ b/kernel/module/main.c
</span><span>@@ -1607,9 +1607,7 @@ static void dynamic_debug_remove(struct module *mod, struct _ddebug_info *dyndbg
</span> 
 void * __weak module_alloc(unsigned long size)
 {
<span>-	return __vmalloc_node_range(size, 1, VMALLOC_START, VMALLOC_END,
-			GFP_KERNEL, PAGE_KERNEL_EXEC, VM_FLUSH_RESET_PERMS,
-			NUMA_NO_NODE, __builtin_return_address(0));
</span><span>+	return vmalloc_exec(size, GFP_KERNEL);
</span> }
 
 bool __weak module_init_section(const char *name)
<span><a href="#iZ2e.:..:20230509165657.1735798-8-kent.overstreet::40linux.dev:1mm:nommu.c" id="Z2e.:..:20230509165657.1735798-8-kent.overstreet::40linux.dev:1mm:nommu.c">diff</a> --git a/mm/nommu.c b/mm/nommu.c
index 57ba243c6a..8d9ab19e39 100644
--- a/mm/nommu.c
+++ b/mm/nommu.c
</span><span>@@ -280,6 +280,24 @@ void *vzalloc_node(unsigned long size, int node)
</span> }
 EXPORT_SYMBOL(vzalloc_node);
 
<span>+/**
+ *	vmalloc_exec  -  allocate virtually contiguous, executable memory
+ *	@size:		allocation size
+ *
+ *	Kernel-internal function to allocate enough pages to cover @size
+ *	the page level allocator and map them into contiguous and
+ *	executable kernel virtual space.
+ *
+ *	For tight control over page level allocator and protection flags
+ *	use __vmalloc() instead.
+ */
+
+void *vmalloc_exec(unsigned long size, gfp_t gfp_mask)
+{
+	return __vmalloc(size, gfp_mask);
+}
+EXPORT_SYMBOL_GPL(vmalloc_exec);
+
</span> /**
  * vmalloc_32  -  allocate virtually contiguous memory (32bit addressable)
  *	@size:		allocation size
<span><a href="#iZ2e.:..:20230509165657.1735798-8-kent.overstreet::40linux.dev:1mm:vmalloc.c" id="Z2e.:..:20230509165657.1735798-8-kent.overstreet::40linux.dev:1mm:vmalloc.c">diff</a> --git a/mm/vmalloc.c b/mm/vmalloc.c
index 31ff782d36..2ebb9ea7f0 100644
--- a/mm/vmalloc.c
+++ b/mm/vmalloc.c
</span><span>@@ -3401,6 +3401,27 @@ void *vzalloc_node(unsigned long size, int node)
</span> }
 EXPORT_SYMBOL(vzalloc_node);
 
<span>+/**
+ * vmalloc_exec - allocate virtually contiguous, executable memory
+ * @size:	  allocation size
+ *
+ * Kernel-internal function to allocate enough pages to cover @size
+ * the page level allocator and map them into contiguous and
+ * executable kernel virtual space.
+ *
+ * For tight control over page level allocator and protection flags
+ * use __vmalloc() instead.
+ *
+ * Return: pointer to the allocated memory or %NULL on error
+ */
+void *vmalloc_exec(unsigned long size, gfp_t gfp_mask)
+{
+	return __vmalloc_node_range(size, 1, VMALLOC_START, VMALLOC_END,
+			gfp_mask, PAGE_KERNEL_EXEC, VM_FLUSH_RESET_PERMS,
+			NUMA_NO_NODE, __builtin_return_address(0));
+}
+EXPORT_SYMBOL_GPL(vmalloc_exec);
+
</span> #if defined(CONFIG_64BIT) &amp;&amp; defined(CONFIG_ZONE_DMA32)
 #define GFP_VMALLOC32 (GFP_DMA32 | GFP_KERNEL)
 #elif defined(CONFIG_64BIT) &amp;&amp; defined(CONFIG_ZONE_DMA)
-- 
2.40.1


<a href="#mcabddb3f4bded12301500ae05b7bcb26474a2aa4" id="ecabddb3f4bded12301500ae05b7bcb26474a2aa4">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-8-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-8-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-8-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-8-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-8-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-8-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#rcabddb3f4bded12301500ae05b7bcb26474a2aa4">73+ messages in thread</a></pre><hr/><pre><a href="#e702650dbd641de54c259f6831566def2a84bf204" id="m702650dbd641de54c259f6831566def2a84bf204">*</a> <b>[PATCH 08/32] fs: factor out d_mark_tmpfile()</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#rcabddb3f4bded12301500ae05b7bcb26474a2aa4">(6 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#mcabddb3f4bded12301500ae05b7bcb26474a2aa4">[PATCH 07/32] mm: Bring back vmalloc_exec</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#m65fc2af60840e53f8cf40f795a9d3eeea31252f6">[PATCH 09/32] block: Add some exports for bcachefs</a> Kent Overstreet
                   ` <a href="#r65fc2af60840e53f8cf40f795a9d3eeea31252f6">(23 subsequent siblings)</a>
  <a href="#r702650dbd641de54c259f6831566def2a84bf204">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-9-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-9-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Kent Overstreet, Alexander Viro, Christian Brauner

From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;

New helper for bcachefs - bcachefs doesn&#39;t want the
inode_dec_link_count() call that d_tmpfile does, it handles i_nlink on
its own atomically with other btree updates

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
Cc: Alexander Viro &lt;viro@zeniv.linux.org.uk&gt;
Cc: Christian Brauner &lt;brauner@kernel.org&gt;
Cc: linux-fsdevel@vger.kernel.org
---
 <a id="iZ2e.:..:20230509165657.1735798-9-kent.overstreet::40linux.dev:1fs:dcache.c" href="#Z2e.:..:20230509165657.1735798-9-kent.overstreet::40linux.dev:1fs:dcache.c">fs/dcache.c</a>            | 12 ++++++++++--
 <a id="iZ2e.:..:20230509165657.1735798-9-kent.overstreet::40linux.dev:1include:linux:dcache.h" href="#Z2e.:..:20230509165657.1735798-9-kent.overstreet::40linux.dev:1include:linux:dcache.h">include/linux/dcache.h</a> |  1 +
 2 files <a href="#e702650dbd641de54c259f6831566def2a84bf204">changed</a>, 11 insertions(+), 2 deletions(-)

<span><a href="#iZ2e.:..:20230509165657.1735798-9-kent.overstreet::40linux.dev:1fs:dcache.c" id="Z2e.:..:20230509165657.1735798-9-kent.overstreet::40linux.dev:1fs:dcache.c">diff</a> --git a/fs/dcache.c b/fs/dcache.c
index 52e6d5fdab..dbdafa2617 100644
--- a/fs/dcache.c
+++ b/fs/dcache.c
</span><span>@@ -3249,11 +3249,10 @@ void d_genocide(struct dentry *parent)
</span> 
 EXPORT_SYMBOL(d_genocide);
 
<span>-void d_tmpfile(struct file *file, struct inode *inode)
</span><span>+void d_mark_tmpfile(struct file *file, struct inode *inode)
</span> {
 	struct dentry *dentry = file-&gt;f_path.dentry;
 
<span>-	inode_dec_link_count(inode);
</span> 	BUG_ON(dentry-&gt;d_name.name != dentry-&gt;d_iname ||
 		!hlist_unhashed(&amp;dentry-&gt;d_u.d_alias) ||
 		!d_unlinked(dentry));
<span>@@ -3263,6 +3262,15 @@ void d_tmpfile(struct file *file, struct inode *inode)
</span> 				(unsigned long long)inode-&gt;i_ino);
 	spin_unlock(&amp;dentry-&gt;d_lock);
 	spin_unlock(&amp;dentry-&gt;d_parent-&gt;d_lock);
<span>+}
+EXPORT_SYMBOL(d_mark_tmpfile);
+
+void d_tmpfile(struct file *file, struct inode *inode)
+{
+	struct dentry *dentry = file-&gt;f_path.dentry;
+
+	inode_dec_link_count(inode);
+	d_mark_tmpfile(file, inode);
</span> 	d_instantiate(dentry, inode);
 }
 EXPORT_SYMBOL(d_tmpfile);
<span><a href="#iZ2e.:..:20230509165657.1735798-9-kent.overstreet::40linux.dev:1include:linux:dcache.h" id="Z2e.:..:20230509165657.1735798-9-kent.overstreet::40linux.dev:1include:linux:dcache.h">diff</a> --git a/include/linux/dcache.h b/include/linux/dcache.h
index 6b351e009f..3da2f0545d 100644
--- a/include/linux/dcache.h
+++ b/include/linux/dcache.h
</span><span>@@ -251,6 +251,7 @@ extern struct dentry * d_make_root(struct inode *);
</span> /* &lt;clickety&gt;-&lt;click&gt; the ramfs-type tree */
 extern void d_genocide(struct dentry *);
 
<span>+extern void d_mark_tmpfile(struct file *, struct inode *);
</span> extern void d_tmpfile(struct file *, struct inode *);
 
 extern struct dentry *d_find_alias(struct inode *);
-- 
2.40.1


<a href="#m702650dbd641de54c259f6831566def2a84bf204" id="e702650dbd641de54c259f6831566def2a84bf204">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-9-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-9-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-9-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-9-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-9-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-9-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r702650dbd641de54c259f6831566def2a84bf204">73+ messages in thread</a></pre><hr/><pre><a href="#e65fc2af60840e53f8cf40f795a9d3eeea31252f6" id="m65fc2af60840e53f8cf40f795a9d3eeea31252f6">*</a> <b>[PATCH 09/32] block: Add some exports for bcachefs</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#r702650dbd641de54c259f6831566def2a84bf204">(7 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#m702650dbd641de54c259f6831566def2a84bf204">[PATCH 08/32] fs: factor out d_mark_tmpfile()</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#m5498b0871049061f28297c94aaab0ce25f38bba9">[PATCH 10/32] block: Allow bio_iov_iter_get_pages() with bio-&gt;bi_bdev unset</a> Kent Overstreet
                   ` <a href="#r5498b0871049061f28297c94aaab0ce25f38bba9">(22 subsequent siblings)</a>
  <a href="#r65fc2af60840e53f8cf40f795a9d3eeea31252f6">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-10-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-10-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, linux-block, Jens Axboe, Kent Overstreet

From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;

 - bio_set_pages_dirty(), bio_check_pages_dirty() - dio path
 - blk_status_to_str() - error messages
 - bio_add_folio() - this should definitely be exported for everyone,
   it&#39;s the modern version of bio_add_page()

Signed-off-by: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
Cc: linux-block@vger.kernel.org
Cc: Jens Axboe &lt;axboe@kernel.dk&gt;
Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-10-kent.overstreet::40linux.dev:1block:bio.c" href="#Z2e.:..:20230509165657.1735798-10-kent.overstreet::40linux.dev:1block:bio.c">block/bio.c</a>            | 3 +++
 <a id="iZ2e.:..:20230509165657.1735798-10-kent.overstreet::40linux.dev:1block:blk-core.c" href="#Z2e.:..:20230509165657.1735798-10-kent.overstreet::40linux.dev:1block:blk-core.c">block/blk-core.c</a>       | 1 +
 <a id="iZ2e.:..:20230509165657.1735798-10-kent.overstreet::40linux.dev:1block:blk.h" href="#Z2e.:..:20230509165657.1735798-10-kent.overstreet::40linux.dev:1block:blk.h">block/blk.h</a>            | 1 -
 <a id="iZ2e.:..:20230509165657.1735798-10-kent.overstreet::40linux.dev:1include:linux:blkdev.h" href="#Z2e.:..:20230509165657.1735798-10-kent.overstreet::40linux.dev:1include:linux:blkdev.h">include/linux/blkdev.h</a> | 1 +
 4 files <a href="#e65fc2af60840e53f8cf40f795a9d3eeea31252f6">changed</a>, 5 insertions(+), 1 deletion(-)

<span><a href="#iZ2e.:..:20230509165657.1735798-10-kent.overstreet::40linux.dev:1block:bio.c" id="Z2e.:..:20230509165657.1735798-10-kent.overstreet::40linux.dev:1block:bio.c">diff</a> --git a/block/bio.c b/block/bio.c
index fd11614bba..1e75840d17 100644
--- a/block/bio.c
+++ b/block/bio.c
</span><span>@@ -1159,6 +1159,7 @@ bool bio_add_folio(struct bio *bio, struct folio *folio, size_t len,
</span> 		return false;
 	return bio_add_page(bio, &amp;folio-&gt;page, len, off) &gt; 0;
 }
<span>+EXPORT_SYMBOL(bio_add_folio);
</span> 
 void __bio_release_pages(struct bio *bio, bool mark_dirty)
 {
<span>@@ -1480,6 +1481,7 @@ void bio_set_pages_dirty(struct bio *bio)
</span> 			set_page_dirty_lock(bvec-&gt;bv_page);
 	}
 }
<span>+EXPORT_SYMBOL_GPL(bio_set_pages_dirty);
</span> 
 /*
  * bio_check_pages_dirty() will check that all the BIO&#39;s pages are still dirty.
<span>@@ -1539,6 +1541,7 @@ void bio_check_pages_dirty(struct bio *bio)
</span> 	spin_unlock_irqrestore(&amp;bio_dirty_lock, flags);
 	schedule_work(&amp;bio_dirty_work);
 }
<span>+EXPORT_SYMBOL_GPL(bio_check_pages_dirty);
</span> 
 static inline bool bio_remaining_done(struct bio *bio)
 {
<span><a href="#iZ2e.:..:20230509165657.1735798-10-kent.overstreet::40linux.dev:1block:blk-core.c" id="Z2e.:..:20230509165657.1735798-10-kent.overstreet::40linux.dev:1block:blk-core.c">diff</a> --git a/block/blk-core.c b/block/blk-core.c
index 42926e6cb8..f19bcc684b 100644
--- a/block/blk-core.c
+++ b/block/blk-core.c
</span><span>@@ -205,6 +205,7 @@ const char *blk_status_to_str(blk_status_t status)
</span> 		return &#34;&lt;null&gt;&#34;;
 	return blk_errors[idx].name;
 }
<span>+EXPORT_SYMBOL_GPL(blk_status_to_str);
</span> 
 /**
  * blk_sync_queue - cancel any pending callbacks on a queue
<span><a href="#iZ2e.:..:20230509165657.1735798-10-kent.overstreet::40linux.dev:1block:blk.h" id="Z2e.:..:20230509165657.1735798-10-kent.overstreet::40linux.dev:1block:blk.h">diff</a> --git a/block/blk.h b/block/blk.h
index cc4e8873df..cc04dc73e9 100644
--- a/block/blk.h
+++ b/block/blk.h
</span><span>@@ -259,7 +259,6 @@ static inline void blk_integrity_del(struct gendisk *disk)
</span> 
 unsigned long blk_rq_timeout(unsigned long timeout);
 void blk_add_timer(struct request *req);
<span>-const char *blk_status_to_str(blk_status_t status);
</span> 
 bool blk_attempt_plug_merge(struct request_queue *q, struct bio *bio,
 		unsigned int nr_segs);
<span><a href="#iZ2e.:..:20230509165657.1735798-10-kent.overstreet::40linux.dev:1include:linux:blkdev.h" id="Z2e.:..:20230509165657.1735798-10-kent.overstreet::40linux.dev:1include:linux:blkdev.h">diff</a> --git a/include/linux/blkdev.h b/include/linux/blkdev.h
index 941304f174..7cac183112 100644
--- a/include/linux/blkdev.h
+++ b/include/linux/blkdev.h
</span><span>@@ -867,6 +867,7 @@ extern const char *blk_op_str(enum req_op op);
</span> 
 int blk_status_to_errno(blk_status_t status);
 blk_status_t errno_to_blk_status(int errno);
<span>+const char *blk_status_to_str(blk_status_t status);
</span> 
 /* only poll the hardware once, don&#39;t continue until a completion was found */
 #define BLK_POLL_ONESHOT		(1 &lt;&lt; 0)
-- 
2.40.1


<a href="#m65fc2af60840e53f8cf40f795a9d3eeea31252f6" id="e65fc2af60840e53f8cf40f795a9d3eeea31252f6">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-10-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-10-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-10-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-10-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-10-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-10-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r65fc2af60840e53f8cf40f795a9d3eeea31252f6">73+ messages in thread</a></pre><hr/><pre><a href="#e5498b0871049061f28297c94aaab0ce25f38bba9" id="m5498b0871049061f28297c94aaab0ce25f38bba9">*</a> <b>[PATCH 10/32] block: Allow bio_iov_iter_get_pages() with bio-&gt;bi_bdev unset</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#r65fc2af60840e53f8cf40f795a9d3eeea31252f6">(8 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#m65fc2af60840e53f8cf40f795a9d3eeea31252f6">[PATCH 09/32] block: Add some exports for bcachefs</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#m49b14c550668d20a55fa7b8c5d7f8a286b60e0ad">[PATCH 11/32] block: Bring back zero_fill_bio_iter</a> Kent Overstreet
                   ` <a href="#r49b14c550668d20a55fa7b8c5d7f8a286b60e0ad">(21 subsequent siblings)</a>
  <a href="#r5498b0871049061f28297c94aaab0ce25f38bba9">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-11-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-11-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Jens Axboe, linux-block

bio_iov_iter_get_pages() trims the IO based on the block size of the
block device the IO will be issued to.

However, bcachefs is a multi device filesystem; when we&#39;re creating the
bio we don&#39;t yet know which block device the bio will be submitted to -
we have to handle the alignment checks elsewhere.

Thus this is needed to avoid a null ptr deref.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
Cc: Jens Axboe &lt;axboe@kernel.dk&gt;
Cc: linux-block@vger.kernel.org
---
 <a id="iZ2e.:..:20230509165657.1735798-11-kent.overstreet::40linux.dev:1block:bio.c" href="#Z2e.:..:20230509165657.1735798-11-kent.overstreet::40linux.dev:1block:bio.c">block/bio.c</a> | 10 ++++++----
 1 file <a href="#e5498b0871049061f28297c94aaab0ce25f38bba9">changed</a>, 6 insertions(+), 4 deletions(-)

<span><a href="#iZ2e.:..:20230509165657.1735798-11-kent.overstreet::40linux.dev:1block:bio.c" id="Z2e.:..:20230509165657.1735798-11-kent.overstreet::40linux.dev:1block:bio.c">diff</a> --git a/block/bio.c b/block/bio.c
index 1e75840d17..e74a04ea14 100644
--- a/block/bio.c
+++ b/block/bio.c
</span><span>@@ -1245,7 +1245,7 @@ static int __bio_iov_iter_get_pages(struct bio *bio, struct iov_iter *iter)
</span> 	struct page **pages = (struct page **)bv;
 	ssize_t size, left;
 	unsigned len, i = 0;
<span>-	size_t offset, trim;
</span><span>+	size_t offset;
</span> 	int ret = 0;
 
 	/*
<span>@@ -1274,10 +1274,12 @@ static int __bio_iov_iter_get_pages(struct bio *bio, struct iov_iter *iter)
</span> 
 	nr_pages = DIV_ROUND_UP(offset + size, PAGE_SIZE);
 
<span>-	trim = size &amp; (bdev_logical_block_size(bio-&gt;bi_bdev) - 1);
-	iov_iter_revert(iter, trim);
</span><span>+	if (bio-&gt;bi_bdev) {
+		size_t trim = size &amp; (bdev_logical_block_size(bio-&gt;bi_bdev) - 1);
+		iov_iter_revert(iter, trim);
+		size -= trim;
+	}
</span> 
<span>-	size -= trim;
</span> 	if (unlikely(!size)) {
 		ret = -EFAULT;
 		goto out;
-- 
2.40.1


<a href="#m5498b0871049061f28297c94aaab0ce25f38bba9" id="e5498b0871049061f28297c94aaab0ce25f38bba9">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-11-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-11-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-11-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-11-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-11-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-11-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r5498b0871049061f28297c94aaab0ce25f38bba9">73+ messages in thread</a></pre><hr/><pre><a href="#e49b14c550668d20a55fa7b8c5d7f8a286b60e0ad" id="m49b14c550668d20a55fa7b8c5d7f8a286b60e0ad">*</a> <b>[PATCH 11/32] block: Bring back zero_fill_bio_iter</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#r5498b0871049061f28297c94aaab0ce25f38bba9">(9 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#m5498b0871049061f28297c94aaab0ce25f38bba9">[PATCH 10/32] block: Allow bio_iov_iter_get_pages() with bio-&gt;bi_bdev unset</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#me7c73abf299cc9cefad55241f69d34f076de39ea">[PATCH 12/32] block: Rework bio_for_each_segment_all()</a> Kent Overstreet
                   ` <a href="#re7c73abf299cc9cefad55241f69d34f076de39ea">(20 subsequent siblings)</a>
  <a href="#r49b14c550668d20a55fa7b8c5d7f8a286b60e0ad">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-12-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-12-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Kent Overstreet, Jens Axboe, linux-block

From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;

This reverts the commit that deleted it; it&#39;s used by bcachefs.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
Cc: Jens Axboe &lt;axboe@kernel.dk&gt;
Cc: linux-block@vger.kernel.org
---
 <a id="iZ2e.:..:20230509165657.1735798-12-kent.overstreet::40linux.dev:1block:bio.c" href="#Z2e.:..:20230509165657.1735798-12-kent.overstreet::40linux.dev:1block:bio.c">block/bio.c</a>         | 6 +++---
 <a id="iZ2e.:..:20230509165657.1735798-12-kent.overstreet::40linux.dev:1include:linux:bio.h" href="#Z2e.:..:20230509165657.1735798-12-kent.overstreet::40linux.dev:1include:linux:bio.h">include/linux/bio.h</a> | 7 ++++++-
 2 files <a href="#e49b14c550668d20a55fa7b8c5d7f8a286b60e0ad">changed</a>, 9 insertions(+), 4 deletions(-)

<span><a href="#iZ2e.:..:20230509165657.1735798-12-kent.overstreet::40linux.dev:1block:bio.c" id="Z2e.:..:20230509165657.1735798-12-kent.overstreet::40linux.dev:1block:bio.c">diff</a> --git a/block/bio.c b/block/bio.c
index e74a04ea14..70b5c987bc 100644
--- a/block/bio.c
+++ b/block/bio.c
</span><span>@@ -606,15 +606,15 @@ struct bio *bio_kmalloc(unsigned short nr_vecs, gfp_t gfp_mask)
</span> }
 EXPORT_SYMBOL(bio_kmalloc);
 
<span>-void zero_fill_bio(struct bio *bio)
</span><span>+void zero_fill_bio_iter(struct bio *bio, struct bvec_iter start)
</span> {
 	struct bio_vec bv;
 	struct bvec_iter iter;
 
<span>-	bio_for_each_segment(bv, bio, iter)
</span><span>+	__bio_for_each_segment(bv, bio, iter, start)
</span> 		memzero_bvec(&amp;bv);
 }
<span>-EXPORT_SYMBOL(zero_fill_bio);
</span><span>+EXPORT_SYMBOL(zero_fill_bio_iter);
</span> 
 /**
  * bio_truncate - truncate the bio to small size of @new_size
<span><a href="#iZ2e.:..:20230509165657.1735798-12-kent.overstreet::40linux.dev:1include:linux:bio.h" id="Z2e.:..:20230509165657.1735798-12-kent.overstreet::40linux.dev:1include:linux:bio.h">diff</a> --git a/include/linux/bio.h b/include/linux/bio.h
index d766be7152..3536f28c05 100644
--- a/include/linux/bio.h
+++ b/include/linux/bio.h
</span><span>@@ -484,7 +484,12 @@ extern void bio_copy_data_iter(struct bio *dst, struct bvec_iter *dst_iter,
</span> extern void bio_copy_data(struct bio *dst, struct bio *src);
 extern void bio_free_pages(struct bio *bio);
 void guard_bio_eod(struct bio *bio);
<span>-void zero_fill_bio(struct bio *bio);
</span><span>+void zero_fill_bio_iter(struct bio *bio, struct bvec_iter iter);
+
+static inline void zero_fill_bio(struct bio *bio)
+{
+	zero_fill_bio_iter(bio, bio-&gt;bi_iter);
+}
</span> 
 static inline void bio_release_pages(struct bio *bio, bool mark_dirty)
 {
-- 
2.40.1


<a href="#m49b14c550668d20a55fa7b8c5d7f8a286b60e0ad" id="e49b14c550668d20a55fa7b8c5d7f8a286b60e0ad">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-12-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-12-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-12-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-12-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-12-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-12-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r49b14c550668d20a55fa7b8c5d7f8a286b60e0ad">73+ messages in thread</a></pre><hr/><pre><a href="#ee7c73abf299cc9cefad55241f69d34f076de39ea" id="me7c73abf299cc9cefad55241f69d34f076de39ea">*</a> <b>[PATCH 12/32] block: Rework bio_for_each_segment_all()</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#r49b14c550668d20a55fa7b8c5d7f8a286b60e0ad">(10 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#m49b14c550668d20a55fa7b8c5d7f8a286b60e0ad">[PATCH 11/32] block: Bring back zero_fill_bio_iter</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#maca8f244af9569907d098909fdf84087d95d7acd">[PATCH 13/32] block: Rework bio_for_each_folio_all()</a> Kent Overstreet
                   ` <a href="#raca8f244af9569907d098909fdf84087d95d7acd">(19 subsequent siblings)</a>
  <a href="#re7c73abf299cc9cefad55241f69d34f076de39ea">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-13-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-13-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Jens Axboe, linux-block, Ming Lei, Phillip Lougher

This patch reworks bio_for_each_segment_all() to be more inline with how
the other bio iterators work:

 - bio_iter_all_peek() now returns a synthesized bio_vec; we don&#39;t stash
   one in the iterator and pass a pointer to it - bad. This way makes it
   clearer what&#39;s a constructed value vs. a reference to something
   pre-existing, and it also will help with cleaning up and
   consolidating code with bio_for_each_folio_all().

 - We now provide bio_for_each_segment_all_continue(), for squashfs:
   this makes their code clearer.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
Cc: Jens Axboe &lt;axboe@kernel.dk&gt;
Cc: linux-block@vger.kernel.org
Cc: Ming Lei &lt;ming.lei@redhat.com&gt;
Cc: Phillip Lougher &lt;phillip@squashfs.org.uk&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1block:bio.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1block:bio.c">block/bio.c</a>                | 38 ++++++++++++------------
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1block:blk-map.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1block:blk-map.c">block/blk-map.c</a>            | 38 ++++++++++++------------
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1block:bounce.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1block:bounce.c">block/bounce.c</a>             | 12 ++++----
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1drivers:md:bcache:btree.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1drivers:md:bcache:btree.c">drivers/md/bcache/btree.c</a>  |  8 ++---
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1drivers:md:dm-crypt.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1drivers:md:dm-crypt.c">drivers/md/dm-crypt.c</a>      | 10 +++----
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1drivers:md:raid1.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1drivers:md:raid1.c">drivers/md/raid1.c</a>         |  4 +--
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:btrfs:disk-io.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:btrfs:disk-io.c">fs/btrfs/disk-io.c</a>         |  4 +--
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:btrfs:extent_io.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:btrfs:extent_io.c">fs/btrfs/extent_io.c</a>       | 50 +++++++++++++++----------------
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:btrfs:raid56.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:btrfs:raid56.c">fs/btrfs/raid56.c</a>          | 14 ++++-----
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:erofs:zdata.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:erofs:zdata.c">fs/erofs/zdata.c</a>           |  4 +--
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:ext4:page-io.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:ext4:page-io.c">fs/ext4/page-io.c</a>          |  8 ++---
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:ext4:readpage.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:ext4:readpage.c">fs/ext4/readpage.c</a>         |  4 +--
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:f2fs:data.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:f2fs:data.c">fs/f2fs/data.c</a>             | 20 ++++++-------
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:gfs2:lops.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:gfs2:lops.c">fs/gfs2/lops.c</a>             | 10 +++----
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:gfs2:meta_io.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:gfs2:meta_io.c">fs/gfs2/meta_io.c</a>          |  8 ++---
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:mpage.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:mpage.c">fs/mpage.c</a>                 |  4 +--
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:block.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:block.c">fs/squashfs/block.c</a>        | 48 +++++++++++++++++-------------
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:lz4_wrapper.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:lz4_wrapper.c">fs/squashfs/lz4_wrapper.c</a>  | 17 ++++++-----
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:lzo_wrapper.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:lzo_wrapper.c">fs/squashfs/lzo_wrapper.c</a>  | 17 ++++++-----
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:xz_wrapper.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:xz_wrapper.c">fs/squashfs/xz_wrapper.c</a>   | 19 ++++++------
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:zlib_wrapper.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:zlib_wrapper.c">fs/squashfs/zlib_wrapper.c</a> | 18 ++++++-----
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:zstd_wrapper.c" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:zstd_wrapper.c">fs/squashfs/zstd_wrapper.c</a> | 19 ++++++------
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1include:linux:bio.h" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1include:linux:bio.h">include/linux/bio.h</a>        | 34 ++++++++++++++++-----
 <a id="iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1include:linux:bvec.h" href="#Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1include:linux:bvec.h">include/linux/bvec.h</a>       | 61 ++++++++++++++++++++++----------------
 24 files <a href="#ee7c73abf299cc9cefad55241f69d34f076de39ea">changed</a>, 256 insertions(+), 213 deletions(-)

<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1block:bio.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1block:bio.c">diff</a> --git a/block/bio.c b/block/bio.c
index 70b5c987bc..f2845d4e47 100644
--- a/block/bio.c
+++ b/block/bio.c
</span><span>@@ -1163,13 +1163,13 @@ EXPORT_SYMBOL(bio_add_folio);
</span> 
 void __bio_release_pages(struct bio *bio, bool mark_dirty)
 {
<span>-	struct bvec_iter_all iter_all;
-	struct bio_vec *bvec;
</span><span>+	struct bvec_iter_all iter;
+	struct bio_vec bvec;
</span> 
<span>-	bio_for_each_segment_all(bvec, bio, iter_all) {
-		if (mark_dirty &amp;&amp; !PageCompound(bvec-&gt;bv_page))
-			set_page_dirty_lock(bvec-&gt;bv_page);
-		put_page(bvec-&gt;bv_page);
</span><span>+	bio_for_each_segment_all(bvec, bio, iter) {
+		if (mark_dirty &amp;&amp; !PageCompound(bvec.bv_page))
+			set_page_dirty_lock(bvec.bv_page);
+		put_page(bvec.bv_page);
</span> 	}
 }
 EXPORT_SYMBOL_GPL(__bio_release_pages);
<span>@@ -1436,11 +1436,11 @@ EXPORT_SYMBOL(bio_copy_data);
</span> 
 void bio_free_pages(struct bio *bio)
 {
<span>-	struct bio_vec *bvec;
-	struct bvec_iter_all iter_all;
</span><span>+	struct bvec_iter_all iter;
+	struct bio_vec bvec;
</span> 
<span>-	bio_for_each_segment_all(bvec, bio, iter_all)
-		__free_page(bvec-&gt;bv_page);
</span><span>+	bio_for_each_segment_all(bvec, bio, iter)
+		__free_page(bvec.bv_page);
</span> }
 EXPORT_SYMBOL(bio_free_pages);
 
<span>@@ -1475,12 +1475,12 @@ EXPORT_SYMBOL(bio_free_pages);
</span>  */
 void bio_set_pages_dirty(struct bio *bio)
 {
<span>-	struct bio_vec *bvec;
-	struct bvec_iter_all iter_all;
</span><span>+	struct bvec_iter_all iter;
+	struct bio_vec bvec;
</span> 
<span>-	bio_for_each_segment_all(bvec, bio, iter_all) {
-		if (!PageCompound(bvec-&gt;bv_page))
-			set_page_dirty_lock(bvec-&gt;bv_page);
</span><span>+	bio_for_each_segment_all(bvec, bio, iter) {
+		if (!PageCompound(bvec.bv_page))
+			set_page_dirty_lock(bvec.bv_page);
</span> 	}
 }
 EXPORT_SYMBOL_GPL(bio_set_pages_dirty);
<span>@@ -1524,12 +1524,12 @@ static void bio_dirty_fn(struct work_struct *work)
</span> 
 void bio_check_pages_dirty(struct bio *bio)
 {
<span>-	struct bio_vec *bvec;
</span><span>+	struct bvec_iter_all iter;
+	struct bio_vec bvec;
</span> 	unsigned long flags;
<span>-	struct bvec_iter_all iter_all;
</span> 
<span>-	bio_for_each_segment_all(bvec, bio, iter_all) {
-		if (!PageDirty(bvec-&gt;bv_page) &amp;&amp; !PageCompound(bvec-&gt;bv_page))
</span><span>+	bio_for_each_segment_all(bvec, bio, iter) {
+		if (!PageDirty(bvec.bv_page) &amp;&amp; !PageCompound(bvec.bv_page))
</span> 			goto defer;
 	}
 
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1block:blk-map.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1block:blk-map.c">diff</a> --git a/block/blk-map.c b/block/blk-map.c
index 9137d16cec..5774a9e467 100644
--- a/block/blk-map.c
+++ b/block/blk-map.c
</span><span>@@ -46,21 +46,21 @@ static struct bio_map_data *bio_alloc_map_data(struct iov_iter *data,
</span>  */
 static int bio_copy_from_iter(struct bio *bio, struct iov_iter *iter)
 {
<span>-	struct bio_vec *bvec;
-	struct bvec_iter_all iter_all;
</span><span>+	struct bvec_iter_all bv_iter;
+	struct bio_vec bvec;
</span> 
<span>-	bio_for_each_segment_all(bvec, bio, iter_all) {
</span><span>+	bio_for_each_segment_all(bvec, bio, bv_iter) {
</span> 		ssize_t ret;
 
<span>-		ret = copy_page_from_iter(bvec-&gt;bv_page,
-					  bvec-&gt;bv_offset,
-					  bvec-&gt;bv_len,
</span><span>+		ret = copy_page_from_iter(bvec.bv_page,
+					  bvec.bv_offset,
+					  bvec.bv_len,
</span> 					  iter);
 
 		if (!iov_iter_count(iter))
 			break;
 
<span>-		if (ret &lt; bvec-&gt;bv_len)
</span><span>+		if (ret &lt; bvec.bv_len)
</span> 			return -EFAULT;
 	}
 
<span>@@ -77,21 +77,21 @@ static int bio_copy_from_iter(struct bio *bio, struct iov_iter *iter)
</span>  */
 static int bio_copy_to_iter(struct bio *bio, struct iov_iter iter)
 {
<span>-	struct bio_vec *bvec;
-	struct bvec_iter_all iter_all;
</span><span>+	struct bvec_iter_all bv_iter;
+	struct bio_vec bvec;
</span> 
<span>-	bio_for_each_segment_all(bvec, bio, iter_all) {
</span><span>+	bio_for_each_segment_all(bvec, bio, bv_iter) {
</span> 		ssize_t ret;
 
<span>-		ret = copy_page_to_iter(bvec-&gt;bv_page,
-					bvec-&gt;bv_offset,
-					bvec-&gt;bv_len,
</span><span>+		ret = copy_page_to_iter(bvec.bv_page,
+					bvec.bv_offset,
+					bvec.bv_len,
</span> 					&amp;iter);
 
 		if (!iov_iter_count(&amp;iter))
 			break;
 
<span>-		if (ret &lt; bvec-&gt;bv_len)
</span><span>+		if (ret &lt; bvec.bv_len)
</span> 			return -EFAULT;
 	}
 
<span>@@ -442,12 +442,12 @@ static void bio_copy_kern_endio(struct bio *bio)
</span> static void bio_copy_kern_endio_read(struct bio *bio)
 {
 	char *p = bio-&gt;bi_private;
<span>-	struct bio_vec *bvec;
-	struct bvec_iter_all iter_all;
</span><span>+	struct bvec_iter_all iter;
+	struct bio_vec bvec;
</span> 
<span>-	bio_for_each_segment_all(bvec, bio, iter_all) {
-		memcpy_from_bvec(p, bvec);
-		p += bvec-&gt;bv_len;
</span><span>+	bio_for_each_segment_all(bvec, bio, iter) {
+		memcpy_from_bvec(p, &amp;bvec);
+		p += bvec.bv_len;
</span> 	}
 
 	bio_copy_kern_endio(bio);
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1block:bounce.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1block:bounce.c">diff</a> --git a/block/bounce.c b/block/bounce.c
index 7cfcb242f9..e701832d76 100644
--- a/block/bounce.c
+++ b/block/bounce.c
</span><span>@@ -102,18 +102,18 @@ static void copy_to_high_bio_irq(struct bio *to, struct bio *from)
</span> static void bounce_end_io(struct bio *bio)
 {
 	struct bio *bio_orig = bio-&gt;bi_private;
<span>-	struct bio_vec *bvec, orig_vec;
</span><span>+	struct bio_vec bvec, orig_vec;
</span> 	struct bvec_iter orig_iter = bio_orig-&gt;bi_iter;
<span>-	struct bvec_iter_all iter_all;
</span><span>+	struct bvec_iter_all iter;
</span> 
 	/*
 	 * free up bounce indirect pages used
 	 */
<span>-	bio_for_each_segment_all(bvec, bio, iter_all) {
</span><span>+	bio_for_each_segment_all(bvec, bio, iter) {
</span> 		orig_vec = bio_iter_iovec(bio_orig, orig_iter);
<span>-		if (bvec-&gt;bv_page != orig_vec.bv_page) {
-			dec_zone_page_state(bvec-&gt;bv_page, NR_BOUNCE);
-			mempool_free(bvec-&gt;bv_page, &amp;page_pool);
</span><span>+		if (bvec.bv_page != orig_vec.bv_page) {
+			dec_zone_page_state(bvec.bv_page, NR_BOUNCE);
+			mempool_free(bvec.bv_page, &amp;page_pool);
</span> 		}
 		bio_advance_iter(bio_orig, &amp;orig_iter, orig_vec.bv_len);
 	}
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1drivers:md:bcache:btree.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1drivers:md:bcache:btree.c">diff</a> --git a/drivers/md/bcache/btree.c b/drivers/md/bcache/btree.c
index 147c493a98..98ce12b239 100644
--- a/drivers/md/bcache/btree.c
+++ b/drivers/md/bcache/btree.c
</span><span>@@ -373,12 +373,12 @@ static void do_btree_node_write(struct btree *b)
</span> 		       bset_sector_offset(&amp;b-&gt;keys, i));
 
 	if (!bch_bio_alloc_pages(b-&gt;bio, __GFP_NOWARN|GFP_NOWAIT)) {
<span>-		struct bio_vec *bv;
</span><span>+		struct bio_vec bv;
</span> 		void *addr = (void *) ((unsigned long) i &amp; ~(PAGE_SIZE - 1));
<span>-		struct bvec_iter_all iter_all;
</span><span>+		struct bvec_iter_all iter;
</span> 
<span>-		bio_for_each_segment_all(bv, b-&gt;bio, iter_all) {
-			memcpy(page_address(bv-&gt;bv_page), addr, PAGE_SIZE);
</span><span>+		bio_for_each_segment_all(bv, b-&gt;bio, iter) {
+			memcpy(page_address(bv.bv_page), addr, PAGE_SIZE);
</span> 			addr += PAGE_SIZE;
 		}
 
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1drivers:md:dm-crypt.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1drivers:md:dm-crypt.c">diff</a> --git a/drivers/md/dm-crypt.c b/drivers/md/dm-crypt.c
index 3ba53dc3cc..166bb4fdb4 100644
--- a/drivers/md/dm-crypt.c
+++ b/drivers/md/dm-crypt.c
</span><span>@@ -1713,12 +1713,12 @@ static struct bio *crypt_alloc_buffer(struct dm_crypt_io *io, unsigned int size)
</span> 
 static void crypt_free_buffer_pages(struct crypt_config *cc, struct bio *clone)
 {
<span>-	struct bio_vec *bv;
-	struct bvec_iter_all iter_all;
</span><span>+	struct bvec_iter_all iter;
+	struct bio_vec bv;
</span> 
<span>-	bio_for_each_segment_all(bv, clone, iter_all) {
-		BUG_ON(!bv-&gt;bv_page);
-		mempool_free(bv-&gt;bv_page, &amp;cc-&gt;page_pool);
</span><span>+	bio_for_each_segment_all(bv, clone, iter) {
+		BUG_ON(!bv.bv_page);
+		mempool_free(bv.bv_page, &amp;cc-&gt;page_pool);
</span> 	}
 }
 
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1drivers:md:raid1.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1drivers:md:raid1.c">diff</a> --git a/drivers/md/raid1.c b/drivers/md/raid1.c
index 68a9e2d998..4f58cae37e 100644
--- a/drivers/md/raid1.c
+++ b/drivers/md/raid1.c
</span><span>@@ -2188,7 +2188,7 @@ static void process_checks(struct r1bio *r1_bio)
</span> 		blk_status_t status = sbio-&gt;bi_status;
 		struct page **ppages = get_resync_pages(pbio)-&gt;pages;
 		struct page **spages = get_resync_pages(sbio)-&gt;pages;
<span>-		struct bio_vec *bi;
</span><span>+		struct bio_vec bi;
</span> 		int page_len[RESYNC_PAGES] = { 0 };
 		struct bvec_iter_all iter_all;
 
<span>@@ -2198,7 +2198,7 @@ static void process_checks(struct r1bio *r1_bio)
</span> 		sbio-&gt;bi_status = 0;
 
 		bio_for_each_segment_all(bi, sbio, iter_all)
<span>-			page_len[j++] = bi-&gt;bv_len;
</span><span>+			page_len[j++] = bi.bv_len;
</span> 
 		if (!status) {
 			for (j = vcnt; j-- ; ) {
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:btrfs:disk-io.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:btrfs:disk-io.c">diff</a> --git a/fs/btrfs/disk-io.c b/fs/btrfs/disk-io.c
index 9e1596bb20..92b3396c15 100644
--- a/fs/btrfs/disk-io.c
+++ b/fs/btrfs/disk-io.c
</span><span>@@ -3804,12 +3804,12 @@ ALLOW_ERROR_INJECTION(open_ctree, ERRNO);
</span> static void btrfs_end_super_write(struct bio *bio)
 {
 	struct btrfs_device *device = bio-&gt;bi_private;
<span>-	struct bio_vec *bvec;
</span><span>+	struct bio_vec bvec;
</span> 	struct bvec_iter_all iter_all;
 	struct page *page;
 
 	bio_for_each_segment_all(bvec, bio, iter_all) {
<span>-		page = bvec-&gt;bv_page;
</span><span>+		page = bvec.bv_page;
</span> 
 		if (bio-&gt;bi_status) {
 			btrfs_warn_rl_in_rcu(device-&gt;fs_info,
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:btrfs:extent_io.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:btrfs:extent_io.c">diff</a> --git a/fs/btrfs/extent_io.c b/fs/btrfs/extent_io.c
index 40300e8e5f..5796c99ea1 100644
--- a/fs/btrfs/extent_io.c
+++ b/fs/btrfs/extent_io.c
</span><span>@@ -581,34 +581,34 @@ static void end_bio_extent_writepage(struct btrfs_bio *bbio)
</span> {
 	struct bio *bio = &amp;bbio-&gt;bio;
 	int error = blk_status_to_errno(bio-&gt;bi_status);
<span>-	struct bio_vec *bvec;
</span><span>+	struct bio_vec bvec;
</span> 	u64 start;
 	u64 end;
 	struct bvec_iter_all iter_all;
 
 	ASSERT(!bio_flagged(bio, BIO_CLONED));
 	bio_for_each_segment_all(bvec, bio, iter_all) {
<span>-		struct page *page = bvec-&gt;bv_page;
</span><span>+		struct page *page = bvec.bv_page;
</span> 		struct inode *inode = page-&gt;mapping-&gt;host;
 		struct btrfs_fs_info *fs_info = btrfs_sb(inode-&gt;i_sb);
 		const u32 sectorsize = fs_info-&gt;sectorsize;
 
 		/* Our read/write should always be sector aligned. */
<span>-		if (!IS_ALIGNED(bvec-&gt;bv_offset, sectorsize))
</span><span>+		if (!IS_ALIGNED(bvec.bv_offset, sectorsize))
</span> 			btrfs_err(fs_info,
 		&#34;partial page write in btrfs with offset %u and length %u&#34;,
<span>-				  bvec-&gt;bv_offset, bvec-&gt;bv_len);
-		else if (!IS_ALIGNED(bvec-&gt;bv_len, sectorsize))
</span><span>+				  bvec.bv_offset, bvec.bv_len);
+		else if (!IS_ALIGNED(bvec.bv_len, sectorsize))
</span> 			btrfs_info(fs_info,
 		&#34;incomplete page write with offset %u and length %u&#34;,
<span>-				   bvec-&gt;bv_offset, bvec-&gt;bv_len);
</span><span>+				   bvec.bv_offset, bvec.bv_len);
</span> 
<span>-		start = page_offset(page) + bvec-&gt;bv_offset;
-		end = start + bvec-&gt;bv_len - 1;
</span><span>+		start = page_offset(page) + bvec.bv_offset;
+		end = start + bvec.bv_len - 1;
</span> 
 		end_extent_writepage(page, error, start, end);
 
<span>-		btrfs_page_clear_writeback(fs_info, page, start, bvec-&gt;bv_len);
</span><span>+		btrfs_page_clear_writeback(fs_info, page, start, bvec.bv_len);
</span> 	}
 
 	bio_put(bio);
<span>@@ -736,7 +736,7 @@ static struct extent_buffer *find_extent_buffer_readpage(
</span> static void end_bio_extent_readpage(struct btrfs_bio *bbio)
 {
 	struct bio *bio = &amp;bbio-&gt;bio;
<span>-	struct bio_vec *bvec;
</span><span>+	struct bio_vec bvec;
</span> 	struct processed_extent processed = { 0 };
 	/*
 	 * The offset to the beginning of a bio, since one bio can never be
<span>@@ -749,7 +749,7 @@ static void end_bio_extent_readpage(struct btrfs_bio *bbio)
</span> 	ASSERT(!bio_flagged(bio, BIO_CLONED));
 	bio_for_each_segment_all(bvec, bio, iter_all) {
 		bool uptodate = !bio-&gt;bi_status;
<span>-		struct page *page = bvec-&gt;bv_page;
</span><span>+		struct page *page = bvec.bv_page;
</span> 		struct inode *inode = page-&gt;mapping-&gt;host;
 		struct btrfs_fs_info *fs_info = btrfs_sb(inode-&gt;i_sb);
 		const u32 sectorsize = fs_info-&gt;sectorsize;
<span>@@ -769,19 +769,19 @@ static void end_bio_extent_readpage(struct btrfs_bio *bbio)
</span> 		 * for unaligned offsets, and an error if they don&#39;t add up to
 		 * a full sector.
 		 */
<span>-		if (!IS_ALIGNED(bvec-&gt;bv_offset, sectorsize))
</span><span>+		if (!IS_ALIGNED(bvec.bv_offset, sectorsize))
</span> 			btrfs_err(fs_info,
 		&#34;partial page read in btrfs with offset %u and length %u&#34;,
<span>-				  bvec-&gt;bv_offset, bvec-&gt;bv_len);
-		else if (!IS_ALIGNED(bvec-&gt;bv_offset + bvec-&gt;bv_len,
</span><span>+				  bvec.bv_offset, bvec.bv_len);
+		else if (!IS_ALIGNED(bvec.bv_offset + bvec.bv_len,
</span> 				     sectorsize))
 			btrfs_info(fs_info,
 		&#34;incomplete page read with offset %u and length %u&#34;,
<span>-				   bvec-&gt;bv_offset, bvec-&gt;bv_len);
</span><span>+				   bvec.bv_offset, bvec.bv_len);
</span> 
<span>-		start = page_offset(page) + bvec-&gt;bv_offset;
-		end = start + bvec-&gt;bv_len - 1;
-		len = bvec-&gt;bv_len;
</span><span>+		start = page_offset(page) + bvec.bv_offset;
+		end = start + bvec.bv_len - 1;
+		len = bvec.bv_len;
</span> 
 		mirror = bbio-&gt;mirror_num;
 		if (uptodate &amp;&amp; !is_data_inode(inode) &amp;&amp;
<span>@@ -1993,7 +1993,7 @@ static void end_bio_subpage_eb_writepage(struct btrfs_bio *bbio)
</span> {
 	struct bio *bio = &amp;bbio-&gt;bio;
 	struct btrfs_fs_info *fs_info;
<span>-	struct bio_vec *bvec;
</span><span>+	struct bio_vec bvec;
</span> 	struct bvec_iter_all iter_all;
 
 	fs_info = btrfs_sb(bio_first_page_all(bio)-&gt;mapping-&gt;host-&gt;i_sb);
<span>@@ -2001,12 +2001,12 @@ static void end_bio_subpage_eb_writepage(struct btrfs_bio *bbio)
</span> 
 	ASSERT(!bio_flagged(bio, BIO_CLONED));
 	bio_for_each_segment_all(bvec, bio, iter_all) {
<span>-		struct page *page = bvec-&gt;bv_page;
-		u64 bvec_start = page_offset(page) + bvec-&gt;bv_offset;
-		u64 bvec_end = bvec_start + bvec-&gt;bv_len - 1;
</span><span>+		struct page *page = bvec.bv_page;
+		u64 bvec_start = page_offset(page) + bvec.bv_offset;
+		u64 bvec_end = bvec_start + bvec.bv_len - 1;
</span> 		u64 cur_bytenr = bvec_start;
 
<span>-		ASSERT(IS_ALIGNED(bvec-&gt;bv_len, fs_info-&gt;nodesize));
</span><span>+		ASSERT(IS_ALIGNED(bvec.bv_len, fs_info-&gt;nodesize));
</span> 
 		/* Iterate through all extent buffers in the range */
 		while (cur_bytenr &lt;= bvec_end) {
<span>@@ -2050,14 +2050,14 @@ static void end_bio_subpage_eb_writepage(struct btrfs_bio *bbio)
</span> static void end_bio_extent_buffer_writepage(struct btrfs_bio *bbio)
 {
 	struct bio *bio = &amp;bbio-&gt;bio;
<span>-	struct bio_vec *bvec;
</span><span>+	struct bio_vec bvec;
</span> 	struct extent_buffer *eb;
 	int done;
 	struct bvec_iter_all iter_all;
 
 	ASSERT(!bio_flagged(bio, BIO_CLONED));
 	bio_for_each_segment_all(bvec, bio, iter_all) {
<span>-		struct page *page = bvec-&gt;bv_page;
</span><span>+		struct page *page = bvec.bv_page;
</span> 
 		eb = (struct extent_buffer *)page-&gt;private;
 		BUG_ON(!eb);
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:btrfs:raid56.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:btrfs:raid56.c">diff</a> --git a/fs/btrfs/raid56.c b/fs/btrfs/raid56.c
index 642828c1b2..39d8101541 100644
--- a/fs/btrfs/raid56.c
+++ b/fs/btrfs/raid56.c
</span><span>@@ -1388,7 +1388,7 @@ static struct sector_ptr *find_stripe_sector(struct btrfs_raid_bio *rbio,
</span> static void set_bio_pages_uptodate(struct btrfs_raid_bio *rbio, struct bio *bio)
 {
 	const u32 sectorsize = rbio-&gt;bioc-&gt;fs_info-&gt;sectorsize;
<span>-	struct bio_vec *bvec;
</span><span>+	struct bio_vec bvec;
</span> 	struct bvec_iter_all iter_all;
 
 	ASSERT(!bio_flagged(bio, BIO_CLONED));
<span>@@ -1397,9 +1397,9 @@ static void set_bio_pages_uptodate(struct btrfs_raid_bio *rbio, struct bio *bio)
</span> 		struct sector_ptr *sector;
 		int pgoff;
 
<span>-		for (pgoff = bvec-&gt;bv_offset; pgoff - bvec-&gt;bv_offset &lt; bvec-&gt;bv_len;
</span><span>+		for (pgoff = bvec.bv_offset; pgoff - bvec.bv_offset &lt; bvec.bv_len;
</span> 		     pgoff += sectorsize) {
<span>-			sector = find_stripe_sector(rbio, bvec-&gt;bv_page, pgoff);
</span><span>+			sector = find_stripe_sector(rbio, bvec.bv_page, pgoff);
</span> 			ASSERT(sector);
 			if (sector)
 				sector-&gt;uptodate = 1;
<span>@@ -1453,7 +1453,7 @@ static void verify_bio_data_sectors(struct btrfs_raid_bio *rbio,
</span> {
 	struct btrfs_fs_info *fs_info = rbio-&gt;bioc-&gt;fs_info;
 	int total_sector_nr = get_bio_sector_nr(rbio, bio);
<span>-	struct bio_vec *bvec;
</span><span>+	struct bio_vec bvec;
</span> 	struct bvec_iter_all iter_all;
 
 	/* No data csum for the whole stripe, no need to verify. */
<span>@@ -1467,8 +1467,8 @@ static void verify_bio_data_sectors(struct btrfs_raid_bio *rbio,
</span> 	bio_for_each_segment_all(bvec, bio, iter_all) {
 		int bv_offset;
 
<span>-		for (bv_offset = bvec-&gt;bv_offset;
-		     bv_offset &lt; bvec-&gt;bv_offset + bvec-&gt;bv_len;
</span><span>+		for (bv_offset = bvec.bv_offset;
+		     bv_offset &lt; bvec.bv_offset + bvec.bv_len;
</span> 		     bv_offset += fs_info-&gt;sectorsize, total_sector_nr++) {
 			u8 csum_buf[BTRFS_CSUM_SIZE];
 			u8 *expected_csum = rbio-&gt;csum_buf +
<span>@@ -1479,7 +1479,7 @@ static void verify_bio_data_sectors(struct btrfs_raid_bio *rbio,
</span> 			if (!test_bit(total_sector_nr, rbio-&gt;csum_bitmap))
 				continue;
 
<span>-			ret = btrfs_check_sector_csum(fs_info, bvec-&gt;bv_page,
</span><span>+			ret = btrfs_check_sector_csum(fs_info, bvec.bv_page,
</span> 				bv_offset, csum_buf, expected_csum);
 			if (ret &lt; 0)
 				set_bit(total_sector_nr, rbio-&gt;error_bitmap);
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:erofs:zdata.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:erofs:zdata.c">diff</a> --git a/fs/erofs/zdata.c b/fs/erofs/zdata.c
index f1708c77a9..1fd0f01d11 100644
--- a/fs/erofs/zdata.c
+++ b/fs/erofs/zdata.c
</span><span>@@ -1651,11 +1651,11 @@ static void z_erofs_decompressqueue_endio(struct bio *bio)
</span> {
 	struct z_erofs_decompressqueue *q = bio-&gt;bi_private;
 	blk_status_t err = bio-&gt;bi_status;
<span>-	struct bio_vec *bvec;
</span><span>+	struct bio_vec bvec;
</span> 	struct bvec_iter_all iter_all;
 
 	bio_for_each_segment_all(bvec, bio, iter_all) {
<span>-		struct page *page = bvec-&gt;bv_page;
</span><span>+		struct page *page = bvec.bv_page;
</span> 
 		DBG_BUGON(PageUptodate(page));
 		DBG_BUGON(z_erofs_page_is_invalidated(page));
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:ext4:page-io.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:ext4:page-io.c">diff</a> --git a/fs/ext4/page-io.c b/fs/ext4/page-io.c
index 1e4db96a04..81a1cc4518 100644
--- a/fs/ext4/page-io.c
+++ b/fs/ext4/page-io.c
</span><span>@@ -99,15 +99,15 @@ static void buffer_io_error(struct buffer_head *bh)
</span> 
 static void ext4_finish_bio(struct bio *bio)
 {
<span>-	struct bio_vec *bvec;
</span><span>+	struct bio_vec bvec;
</span> 	struct bvec_iter_all iter_all;
 
 	bio_for_each_segment_all(bvec, bio, iter_all) {
<span>-		struct page *page = bvec-&gt;bv_page;
</span><span>+		struct page *page = bvec.bv_page;
</span> 		struct page *bounce_page = NULL;
 		struct buffer_head *bh, *head;
<span>-		unsigned bio_start = bvec-&gt;bv_offset;
-		unsigned bio_end = bio_start + bvec-&gt;bv_len;
</span><span>+		unsigned bio_start = bvec.bv_offset;
+		unsigned bio_end = bio_start + bvec.bv_len;
</span> 		unsigned under_io = 0;
 		unsigned long flags;
 
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:ext4:readpage.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:ext4:readpage.c">diff</a> --git a/fs/ext4/readpage.c b/fs/ext4/readpage.c
index c61dc8a7c0..ce42b3d5c9 100644
--- a/fs/ext4/readpage.c
+++ b/fs/ext4/readpage.c
</span><span>@@ -69,11 +69,11 @@ struct bio_post_read_ctx {
</span> static void __read_end_io(struct bio *bio)
 {
 	struct page *page;
<span>-	struct bio_vec *bv;
</span><span>+	struct bio_vec bv;
</span> 	struct bvec_iter_all iter_all;
 
 	bio_for_each_segment_all(bv, bio, iter_all) {
<span>-		page = bv-&gt;bv_page;
</span><span>+		page = bv.bv_page;
</span> 
 		if (bio-&gt;bi_status)
 			ClearPageUptodate(page);
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:f2fs:data.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:f2fs:data.c">diff</a> --git a/fs/f2fs/data.c b/fs/f2fs/data.c
index 06b552a0ab..e44bd8586f 100644
--- a/fs/f2fs/data.c
+++ b/fs/f2fs/data.c
</span><span>@@ -139,12 +139,12 @@ struct bio_post_read_ctx {
</span>  */
 static void f2fs_finish_read_bio(struct bio *bio, bool in_task)
 {
<span>-	struct bio_vec *bv;
</span><span>+	struct bio_vec bv;
</span> 	struct bvec_iter_all iter_all;
 	struct bio_post_read_ctx *ctx = bio-&gt;bi_private;
 
 	bio_for_each_segment_all(bv, bio, iter_all) {
<span>-		struct page *page = bv-&gt;bv_page;
</span><span>+		struct page *page = bv.bv_page;
</span> 
 		if (f2fs_is_compressed_page(page)) {
 			if (ctx &amp;&amp; !ctx-&gt;decompression_attempted)
<span>@@ -189,11 +189,11 @@ static void f2fs_verify_bio(struct work_struct *work)
</span> 	 * as those were handled separately by f2fs_end_read_compressed_page().
 	 */
 	if (may_have_compressed_pages) {
<span>-		struct bio_vec *bv;
</span><span>+		struct bio_vec bv;
</span> 		struct bvec_iter_all iter_all;
 
 		bio_for_each_segment_all(bv, bio, iter_all) {
<span>-			struct page *page = bv-&gt;bv_page;
</span><span>+			struct page *page = bv.bv_page;
</span> 
 			if (!f2fs_is_compressed_page(page) &amp;&amp;
 			    !fsverity_verify_page(page)) {
<span>@@ -241,13 +241,13 @@ static void f2fs_verify_and_finish_bio(struct bio *bio, bool in_task)
</span> static void f2fs_handle_step_decompress(struct bio_post_read_ctx *ctx,
 		bool in_task)
 {
<span>-	struct bio_vec *bv;
</span><span>+	struct bio_vec bv;
</span> 	struct bvec_iter_all iter_all;
 	bool all_compressed = true;
 	block_t blkaddr = ctx-&gt;fs_blkaddr;
 
 	bio_for_each_segment_all(bv, ctx-&gt;bio, iter_all) {
<span>-		struct page *page = bv-&gt;bv_page;
</span><span>+		struct page *page = bv.bv_page;
</span> 
 		if (f2fs_is_compressed_page(page))
 			f2fs_end_read_compressed_page(page, false, blkaddr,
<span>@@ -327,7 +327,7 @@ static void f2fs_read_end_io(struct bio *bio)
</span> static void f2fs_write_end_io(struct bio *bio)
 {
 	struct f2fs_sb_info *sbi;
<span>-	struct bio_vec *bvec;
</span><span>+	struct bio_vec bvec;
</span> 	struct bvec_iter_all iter_all;
 
 	iostat_update_and_unbind_ctx(bio);
<span>@@ -337,7 +337,7 @@ static void f2fs_write_end_io(struct bio *bio)
</span> 		bio-&gt;bi_status = BLK_STS_IOERR;
 
 	bio_for_each_segment_all(bvec, bio, iter_all) {
<span>-		struct page *page = bvec-&gt;bv_page;
</span><span>+		struct page *page = bvec.bv_page;
</span> 		enum count_type type = WB_DATA_TYPE(page);
 
 		if (page_private_dummy(page)) {
<span>@@ -583,7 +583,7 @@ static void __submit_merged_bio(struct f2fs_bio_info *io)
</span> static bool __has_merged_page(struct bio *bio, struct inode *inode,
 						struct page *page, nid_t ino)
 {
<span>-	struct bio_vec *bvec;
</span><span>+	struct bio_vec bvec;
</span> 	struct bvec_iter_all iter_all;
 
 	if (!bio)
<span>@@ -593,7 +593,7 @@ static bool __has_merged_page(struct bio *bio, struct inode *inode,
</span> 		return true;
 
 	bio_for_each_segment_all(bvec, bio, iter_all) {
<span>-		struct page *target = bvec-&gt;bv_page;
</span><span>+		struct page *target = bvec.bv_page;
</span> 
 		if (fscrypt_is_bounce_page(target)) {
 			target = fscrypt_pagecache_page(target);
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:gfs2:lops.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:gfs2:lops.c">diff</a> --git a/fs/gfs2/lops.c b/fs/gfs2/lops.c
index 1902413d5d..7f62fe8eb7 100644
--- a/fs/gfs2/lops.c
+++ b/fs/gfs2/lops.c
</span><span>@@ -202,7 +202,7 @@ static void gfs2_end_log_write_bh(struct gfs2_sbd *sdp,
</span> static void gfs2_end_log_write(struct bio *bio)
 {
 	struct gfs2_sbd *sdp = bio-&gt;bi_private;
<span>-	struct bio_vec *bvec;
</span><span>+	struct bio_vec bvec;
</span> 	struct page *page;
 	struct bvec_iter_all iter_all;
 
<span>@@ -217,9 +217,9 @@ static void gfs2_end_log_write(struct bio *bio)
</span> 	}
 
 	bio_for_each_segment_all(bvec, bio, iter_all) {
<span>-		page = bvec-&gt;bv_page;
</span><span>+		page = bvec.bv_page;
</span> 		if (page_has_buffers(page))
<span>-			gfs2_end_log_write_bh(sdp, bvec, bio-&gt;bi_status);
</span><span>+			gfs2_end_log_write_bh(sdp, &amp;bvec, bio-&gt;bi_status);
</span> 		else
 			mempool_free(page, gfs2_page_pool);
 	}
<span>@@ -395,11 +395,11 @@ static void gfs2_log_write_page(struct gfs2_sbd *sdp, struct page *page)
</span> static void gfs2_end_log_read(struct bio *bio)
 {
 	struct page *page;
<span>-	struct bio_vec *bvec;
</span><span>+	struct bio_vec bvec;
</span> 	struct bvec_iter_all iter_all;
 
 	bio_for_each_segment_all(bvec, bio, iter_all) {
<span>-		page = bvec-&gt;bv_page;
</span><span>+		page = bvec.bv_page;
</span> 		if (bio-&gt;bi_status) {
 			int err = blk_status_to_errno(bio-&gt;bi_status);
 
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:gfs2:meta_io.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:gfs2:meta_io.c">diff</a> --git a/fs/gfs2/meta_io.c b/fs/gfs2/meta_io.c
index 924361fa51..832572784e 100644
--- a/fs/gfs2/meta_io.c
+++ b/fs/gfs2/meta_io.c
</span><span>@@ -193,15 +193,15 @@ struct buffer_head *gfs2_meta_new(struct gfs2_glock *gl, u64 blkno)
</span> 
 static void gfs2_meta_read_endio(struct bio *bio)
 {
<span>-	struct bio_vec *bvec;
</span><span>+	struct bio_vec bvec;
</span> 	struct bvec_iter_all iter_all;
 
 	bio_for_each_segment_all(bvec, bio, iter_all) {
<span>-		struct page *page = bvec-&gt;bv_page;
</span><span>+		struct page *page = bvec.bv_page;
</span> 		struct buffer_head *bh = page_buffers(page);
<span>-		unsigned int len = bvec-&gt;bv_len;
</span><span>+		unsigned int len = bvec.bv_len;
</span> 
<span>-		while (bh_offset(bh) &lt; bvec-&gt;bv_offset)
</span><span>+		while (bh_offset(bh) &lt; bvec.bv_offset)
</span> 			bh = bh-&gt;b_this_page;
 		do {
 			struct buffer_head *next = bh-&gt;b_this_page;
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:mpage.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:mpage.c">diff</a> --git a/fs/mpage.c b/fs/mpage.c
index 22b9de5ddd..49505456ba 100644
--- a/fs/mpage.c
+++ b/fs/mpage.c
</span><span>@@ -45,11 +45,11 @@
</span>  */
 static void mpage_end_io(struct bio *bio)
 {
<span>-	struct bio_vec *bv;
</span><span>+	struct bio_vec bv;
</span> 	struct bvec_iter_all iter_all;
 
 	bio_for_each_segment_all(bv, bio, iter_all) {
<span>-		struct page *page = bv-&gt;bv_page;
</span><span>+		struct page *page = bv.bv_page;
</span> 		page_endio(page, bio_op(bio),
 			   blk_status_to_errno(bio-&gt;bi_status));
 	}
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:block.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:block.c">diff</a> --git a/fs/squashfs/block.c b/fs/squashfs/block.c
index bed3bb8b27..83e8b44518 100644
--- a/fs/squashfs/block.c
+++ b/fs/squashfs/block.c
</span><span>@@ -35,30 +35,33 @@ static int copy_bio_to_actor(struct bio *bio,
</span> 			     int offset, int req_length)
 {
 	void *actor_addr;
<span>-	struct bvec_iter_all iter_all = {};
-	struct bio_vec *bvec = bvec_init_iter_all(&amp;iter_all);
</span><span>+	struct bvec_iter_all iter;
+	struct bio_vec bvec;
</span> 	int copied_bytes = 0;
 	int actor_offset = 0;
<span>+	int bytes_to_copy;
</span> 
 	squashfs_actor_nobuff(actor);
 	actor_addr = squashfs_first_page(actor);
 
<span>-	if (WARN_ON_ONCE(!bio_next_segment(bio, &amp;iter_all)))
-		return 0;
</span><span>+	bvec_iter_all_init(&amp;iter);
+	bio_iter_all_advance(bio, &amp;iter, offset);
</span> 
<span>-	while (copied_bytes &lt; req_length) {
-		int bytes_to_copy = min_t(int, bvec-&gt;bv_len - offset,
</span><span>+	while (copied_bytes &lt; req_length &amp;&amp;
+	       iter.idx &lt; bio-&gt;bi_vcnt) {
+		bvec = bio_iter_all_peek(bio, &amp;iter);
+
+		bytes_to_copy = min_t(int, bvec.bv_len,
</span> 					  PAGE_SIZE - actor_offset);
 
 		bytes_to_copy = min_t(int, bytes_to_copy,
 				      req_length - copied_bytes);
 		if (!IS_ERR(actor_addr))
<span>-			memcpy(actor_addr + actor_offset, bvec_virt(bvec) +
-					offset, bytes_to_copy);
</span><span>+			memcpy(actor_addr + actor_offset, bvec_virt(&amp;bvec),
+			       bytes_to_copy);
</span> 
 		actor_offset += bytes_to_copy;
 		copied_bytes += bytes_to_copy;
<span>-		offset += bytes_to_copy;
</span> 
 		if (actor_offset &gt;= PAGE_SIZE) {
 			actor_addr = squashfs_next_page(actor);
<span>@@ -66,11 +69,8 @@ static int copy_bio_to_actor(struct bio *bio,
</span> 				break;
 			actor_offset = 0;
 		}
<span>-		if (offset &gt;= bvec-&gt;bv_len) {
-			if (!bio_next_segment(bio, &amp;iter_all))
-				break;
-			offset = 0;
-		}
</span><span>+
+		bio_iter_all_advance(bio, &amp;iter, bytes_to_copy);
</span> 	}
 	squashfs_finish_page(actor);
 	return copied_bytes;
<span>@@ -159,8 +159,10 @@ int squashfs_read_data(struct super_block *sb, u64 index, int length,
</span> 		 * Metadata block.
 		 */
 		const u8 *data;
<span>-		struct bvec_iter_all iter_all = {};
-		struct bio_vec *bvec = bvec_init_iter_all(&amp;iter_all);
</span><span>+		struct bvec_iter_all iter;
+		struct bio_vec bvec;
+
+		bvec_iter_all_init(&amp;iter);
</span> 
 		if (index + 2 &gt; msblk-&gt;bytes_used) {
 			res = -EIO;
<span>@@ -170,21 +172,25 @@ int squashfs_read_data(struct super_block *sb, u64 index, int length,
</span> 		if (res)
 			goto out;
 
<span>-		if (WARN_ON_ONCE(!bio_next_segment(bio, &amp;iter_all))) {
</span><span>+		bvec = bio_iter_all_peek(bio, &amp;iter);
+
+		if (WARN_ON_ONCE(!bvec.bv_len)) {
</span> 			res = -EIO;
 			goto out_free_bio;
 		}
 		/* Extract the length of the metadata block */
<span>-		data = bvec_virt(bvec);
</span><span>+		data = bvec_virt(&amp;bvec);
</span> 		length = data[offset];
<span>-		if (offset &lt; bvec-&gt;bv_len - 1) {
</span><span>+		if (offset &lt; bvec.bv_len - 1) {
</span> 			length |= data[offset + 1] &lt;&lt; 8;
 		} else {
<span>-			if (WARN_ON_ONCE(!bio_next_segment(bio, &amp;iter_all))) {
</span><span>+			bio_iter_all_advance(bio, &amp;iter, bvec.bv_len);
+
+			if (WARN_ON_ONCE(!bvec.bv_len)) {
</span> 				res = -EIO;
 				goto out_free_bio;
 			}
<span>-			data = bvec_virt(bvec);
</span><span>+			data = bvec_virt(&amp;bvec);
</span> 			length |= data[0] &lt;&lt; 8;
 		}
 		bio_free_pages(bio);
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:lz4_wrapper.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:lz4_wrapper.c">diff</a> --git a/fs/squashfs/lz4_wrapper.c b/fs/squashfs/lz4_wrapper.c
index 49797729f1..bd0dd787d2 100644
--- a/fs/squashfs/lz4_wrapper.c
+++ b/fs/squashfs/lz4_wrapper.c
</span><span>@@ -92,20 +92,23 @@ static int lz4_uncompress(struct squashfs_sb_info *msblk, void *strm,
</span> 	struct bio *bio, int offset, int length,
 	struct squashfs_page_actor *output)
 {
<span>-	struct bvec_iter_all iter_all = {};
-	struct bio_vec *bvec = bvec_init_iter_all(&amp;iter_all);
</span><span>+	struct bvec_iter_all iter;
+	struct bio_vec bvec;
</span> 	struct squashfs_lz4 *stream = strm;
 	void *buff = stream-&gt;input, *data;
 	int bytes = length, res;
 
<span>-	while (bio_next_segment(bio, &amp;iter_all)) {
-		int avail = min(bytes, ((int)bvec-&gt;bv_len) - offset);
</span><span>+	bvec_iter_all_init(&amp;iter);
+	bio_iter_all_advance(bio, &amp;iter, offset);
</span> 
<span>-		data = bvec_virt(bvec);
-		memcpy(buff, data + offset, avail);
</span><span>+	bio_for_each_segment_all_continue(bvec, bio, iter) {
+		unsigned avail = min_t(unsigned, bytes, bvec.bv_len);
+
+		memcpy(buff, bvec_virt(&amp;bvec), avail);
</span> 		buff += avail;
 		bytes -= avail;
<span>-		offset = 0;
</span><span>+		if (!bytes)
+			break;
</span> 	}
 
 	res = LZ4_decompress_safe(stream-&gt;input, stream-&gt;output,
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:lzo_wrapper.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:lzo_wrapper.c">diff</a> --git a/fs/squashfs/lzo_wrapper.c b/fs/squashfs/lzo_wrapper.c
index d216aeefa8..bccfcfa12e 100644
--- a/fs/squashfs/lzo_wrapper.c
+++ b/fs/squashfs/lzo_wrapper.c
</span><span>@@ -66,21 +66,24 @@ static int lzo_uncompress(struct squashfs_sb_info *msblk, void *strm,
</span> 	struct bio *bio, int offset, int length,
 	struct squashfs_page_actor *output)
 {
<span>-	struct bvec_iter_all iter_all = {};
-	struct bio_vec *bvec = bvec_init_iter_all(&amp;iter_all);
</span><span>+	struct bvec_iter_all iter;
+	struct bio_vec bvec;
</span> 	struct squashfs_lzo *stream = strm;
 	void *buff = stream-&gt;input, *data;
 	int bytes = length, res;
 	size_t out_len = output-&gt;length;
 
<span>-	while (bio_next_segment(bio, &amp;iter_all)) {
-		int avail = min(bytes, ((int)bvec-&gt;bv_len) - offset);
</span><span>+	bvec_iter_all_init(&amp;iter);
+	bio_iter_all_advance(bio, &amp;iter, offset);
</span> 
<span>-		data = bvec_virt(bvec);
-		memcpy(buff, data + offset, avail);
</span><span>+	bio_for_each_segment_all_continue(bvec, bio, iter) {
+		unsigned avail = min_t(unsigned, bytes, bvec.bv_len);
+
+		memcpy(buff, bvec_virt(&amp;bvec), avail);
</span> 		buff += avail;
 		bytes -= avail;
<span>-		offset = 0;
</span><span>+		if (!bytes)
+			break;
</span> 	}
 
 	res = lzo1x_decompress_safe(stream-&gt;input, (size_t)length,
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:xz_wrapper.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:xz_wrapper.c">diff</a> --git a/fs/squashfs/xz_wrapper.c b/fs/squashfs/xz_wrapper.c
index 6c49481a2f..6cf0e11e3b 100644
--- a/fs/squashfs/xz_wrapper.c
+++ b/fs/squashfs/xz_wrapper.c
</span><span>@@ -120,8 +120,7 @@ static int squashfs_xz_uncompress(struct squashfs_sb_info *msblk, void *strm,
</span> 	struct bio *bio, int offset, int length,
 	struct squashfs_page_actor *output)
 {
<span>-	struct bvec_iter_all iter_all = {};
-	struct bio_vec *bvec = bvec_init_iter_all(&amp;iter_all);
</span><span>+	struct bvec_iter_all iter;
</span> 	int total = 0, error = 0;
 	struct squashfs_xz *stream = strm;
 
<span>@@ -136,26 +135,28 @@ static int squashfs_xz_uncompress(struct squashfs_sb_info *msblk, void *strm,
</span> 		goto finish;
 	}
 
<span>+	bvec_iter_all_init(&amp;iter);
+	bio_iter_all_advance(bio, &amp;iter, offset);
+
</span> 	for (;;) {
 		enum xz_ret xz_err;
 
 		if (stream-&gt;buf.in_pos == stream-&gt;buf.in_size) {
<span>-			const void *data;
-			int avail;
</span><span>+			struct bio_vec bvec = bio_iter_all_peek(bio, &amp;iter);
+			unsigned avail = min_t(unsigned, length, bvec.bv_len);
</span> 
<span>-			if (!bio_next_segment(bio, &amp;iter_all)) {
</span><span>+			if (iter.idx &gt;= bio-&gt;bi_vcnt) {
</span> 				/* XZ_STREAM_END must be reached. */
 				error = -EIO;
 				break;
 			}
 
<span>-			avail = min(length, ((int)bvec-&gt;bv_len) - offset);
-			data = bvec_virt(bvec);
</span> 			length -= avail;
<span>-			stream-&gt;buf.in = data + offset;
</span><span>+			stream-&gt;buf.in = bvec_virt(&amp;bvec);
</span> 			stream-&gt;buf.in_size = avail;
 			stream-&gt;buf.in_pos = 0;
<span>-			offset = 0;
</span><span>+
+			bio_iter_all_advance(bio, &amp;iter, avail);
</span> 		}
 
 		if (stream-&gt;buf.out_pos == stream-&gt;buf.out_size) {
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:zlib_wrapper.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:zlib_wrapper.c">diff</a> --git a/fs/squashfs/zlib_wrapper.c b/fs/squashfs/zlib_wrapper.c
index cbb7afe7bc..981ca5e410 100644
--- a/fs/squashfs/zlib_wrapper.c
+++ b/fs/squashfs/zlib_wrapper.c
</span><span>@@ -53,8 +53,7 @@ static int zlib_uncompress(struct squashfs_sb_info *msblk, void *strm,
</span> 	struct bio *bio, int offset, int length,
 	struct squashfs_page_actor *output)
 {
<span>-	struct bvec_iter_all iter_all = {};
-	struct bio_vec *bvec = bvec_init_iter_all(&amp;iter_all);
</span><span>+	struct bvec_iter_all iter;
</span> 	int zlib_init = 0, error = 0;
 	z_stream *stream = strm;
 
<span>@@ -67,25 +66,28 @@ static int zlib_uncompress(struct squashfs_sb_info *msblk, void *strm,
</span> 		goto finish;
 	}
 
<span>+	bvec_iter_all_init(&amp;iter);
+	bio_iter_all_advance(bio, &amp;iter, offset);
+
</span> 	for (;;) {
 		int zlib_err;
 
 		if (stream-&gt;avail_in == 0) {
<span>-			const void *data;
</span><span>+			struct bio_vec bvec = bio_iter_all_peek(bio, &amp;iter);
</span> 			int avail;
 
<span>-			if (!bio_next_segment(bio, &amp;iter_all)) {
</span><span>+			if (iter.idx &gt;= bio-&gt;bi_vcnt) {
</span> 				/* Z_STREAM_END must be reached. */
 				error = -EIO;
 				break;
 			}
 
<span>-			avail = min(length, ((int)bvec-&gt;bv_len) - offset);
-			data = bvec_virt(bvec);
</span><span>+			avail = min_t(unsigned, length, bvec.bv_len);
</span> 			length -= avail;
<span>-			stream-&gt;next_in = data + offset;
</span><span>+			stream-&gt;next_in = bvec_virt(&amp;bvec);
</span> 			stream-&gt;avail_in = avail;
<span>-			offset = 0;
</span><span>+
+			bio_iter_all_advance(bio, &amp;iter, avail);
</span> 		}
 
 		if (stream-&gt;avail_out == 0) {
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:zstd_wrapper.c" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1fs:squashfs:zstd_wrapper.c">diff</a> --git a/fs/squashfs/zstd_wrapper.c b/fs/squashfs/zstd_wrapper.c
index 0e407c4d8b..658e5d462a 100644
--- a/fs/squashfs/zstd_wrapper.c
+++ b/fs/squashfs/zstd_wrapper.c
</span><span>@@ -68,8 +68,7 @@ static int zstd_uncompress(struct squashfs_sb_info *msblk, void *strm,
</span> 	int error = 0;
 	zstd_in_buffer in_buf = { NULL, 0, 0 };
 	zstd_out_buffer out_buf = { NULL, 0, 0 };
<span>-	struct bvec_iter_all iter_all = {};
-	struct bio_vec *bvec = bvec_init_iter_all(&amp;iter_all);
</span><span>+	struct bvec_iter_all iter;
</span> 
 	stream = zstd_init_dstream(wksp-&gt;window_size, wksp-&gt;mem, wksp-&gt;mem_size);
 
<span>@@ -85,25 +84,27 @@ static int zstd_uncompress(struct squashfs_sb_info *msblk, void *strm,
</span> 		goto finish;
 	}
 
<span>+	bvec_iter_all_init(&amp;iter);
+	bio_iter_all_advance(bio, &amp;iter, offset);
+
</span> 	for (;;) {
 		size_t zstd_err;
 
 		if (in_buf.pos == in_buf.size) {
<span>-			const void *data;
-			int avail;
</span><span>+			struct bio_vec bvec = bio_iter_all_peek(bio, &amp;iter);
+			unsigned avail = min_t(unsigned, length, bvec.bv_len);
</span> 
<span>-			if (!bio_next_segment(bio, &amp;iter_all)) {
</span><span>+			if (iter.idx &gt;= bio-&gt;bi_vcnt) {
</span> 				error = -EIO;
 				break;
 			}
 
<span>-			avail = min(length, ((int)bvec-&gt;bv_len) - offset);
-			data = bvec_virt(bvec);
</span> 			length -= avail;
<span>-			in_buf.src = data + offset;
</span><span>+			in_buf.src = bvec_virt(&amp;bvec);
</span> 			in_buf.size = avail;
 			in_buf.pos = 0;
<span>-			offset = 0;
</span><span>+
+			bio_iter_all_advance(bio, &amp;iter, avail);
</span> 		}
 
 		if (out_buf.pos == out_buf.size) {
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1include:linux:bio.h" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1include:linux:bio.h">diff</a> --git a/include/linux/bio.h b/include/linux/bio.h
index 3536f28c05..f86c7190c3 100644
--- a/include/linux/bio.h
+++ b/include/linux/bio.h
</span><span>@@ -78,22 +78,40 @@ static inline void *bio_data(struct bio *bio)
</span> 	return NULL;
 }
 
<span>-static inline bool bio_next_segment(const struct bio *bio,
-				    struct bvec_iter_all *iter)
</span><span>+static inline struct bio_vec bio_iter_all_peek(const struct bio *bio,
+					       struct bvec_iter_all *iter)
</span> {
<span>-	if (iter-&gt;idx &gt;= bio-&gt;bi_vcnt)
-		return false;
</span><span>+	if (WARN_ON(iter-&gt;idx &gt;= bio-&gt;bi_vcnt))
+		return (struct bio_vec) { NULL };
</span> 
<span>-	bvec_advance(&amp;bio-&gt;bi_io_vec[iter-&gt;idx], iter);
-	return true;
</span><span>+	return bvec_iter_all_peek(bio-&gt;bi_io_vec, iter);
+}
+
+static inline void bio_iter_all_advance(const struct bio *bio,
+					struct bvec_iter_all *iter,
+					unsigned bytes)
+{
+	bvec_iter_all_advance(bio-&gt;bi_io_vec, iter, bytes);
+
+	WARN_ON(iter-&gt;idx &gt; bio-&gt;bi_vcnt ||
+		(iter-&gt;idx == bio-&gt;bi_vcnt &amp;&amp; iter-&gt;done));
</span> }
 
<span>+#define bio_for_each_segment_all_continue(bvl, bio, iter)		\
+	for (;								\
+	     iter.idx &lt; bio-&gt;bi_vcnt &amp;&amp;					\
+		((bvl = bio_iter_all_peek(bio, &amp;iter)), true);		\
+	     bio_iter_all_advance((bio), &amp;iter, bvl.bv_len))
+
</span> /*
  * drivers should _never_ use the all version - the bio may have been split
  * before it got to the driver and the driver won&#39;t own all of it
  */
<span>-#define bio_for_each_segment_all(bvl, bio, iter) \
-	for (bvl = bvec_init_iter_all(&amp;iter); bio_next_segment((bio), &amp;iter); )
</span><span>+#define bio_for_each_segment_all(bvl, bio, iter)			\
+	for (bvec_iter_all_init(&amp;iter);					\
+	     iter.idx &lt; (bio)-&gt;bi_vcnt &amp;&amp;				\
+		((bvl = bio_iter_all_peek((bio), &amp;iter)), true);		\
+	     bio_iter_all_advance((bio), &amp;iter, bvl.bv_len))
</span> 
 static inline void bio_advance_iter(const struct bio *bio,
 				    struct bvec_iter *iter, unsigned int bytes)
<span><a href="#iZ2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1include:linux:bvec.h" id="Z2e.:..:20230509165657.1735798-13-kent.overstreet::40linux.dev:1include:linux:bvec.h">diff</a> --git a/include/linux/bvec.h b/include/linux/bvec.h
index 555aae5448..635fb54143 100644
--- a/include/linux/bvec.h
+++ b/include/linux/bvec.h
</span><span>@@ -85,12 +85,6 @@ struct bvec_iter {
</span> 						   current bvec */
 } __packed;
 
<span>-struct bvec_iter_all {
-	struct bio_vec	bv;
-	int		idx;
-	unsigned	done;
-};
-
</span> /*
  * various member access, note that bio_data should of course not be used
  * on highmem page vectors
<span>@@ -184,7 +178,10 @@ static inline void bvec_iter_advance_single(const struct bio_vec *bv,
</span> 		((bvl = bvec_iter_bvec((bio_vec), (iter))), 1);	\
 	     bvec_iter_advance_single((bio_vec), &amp;(iter), (bvl).bv_len))
 
<span>-/* for iterating one bio from start to end */
</span><span>+/*
+ * bvec_iter_all: for advancing over a bio as it was originally created, but
+ * with the usual bio_for_each_segment interface - nonstandard, do not use:
+ */
</span> #define BVEC_ITER_ALL_INIT (struct bvec_iter)				\
 {									\
 	.bi_sector	= 0,						\
<span>@@ -193,33 +190,45 @@ static inline void bvec_iter_advance_single(const struct bio_vec *bv,
</span> 	.bi_bvec_done	= 0,						\
 }
 
<span>-static inline struct bio_vec *bvec_init_iter_all(struct bvec_iter_all *iter_all)
</span><span>+/*
+ * bvec_iter_all: for advancing over individual pages in a bio, as it was when
+ * it was first created:
+ */
+struct bvec_iter_all {
+	int		idx;
+	unsigned	done;
+};
+
+static inline void bvec_iter_all_init(struct bvec_iter_all *iter_all)
</span> {
 	iter_all-&gt;done = 0;
 	iter_all-&gt;idx = 0;
<span>+}
</span> 
<span>-	return &amp;iter_all-&gt;bv;
</span><span>+static inline struct bio_vec bvec_iter_all_peek(const struct bio_vec *bvec,
+						struct bvec_iter_all *iter)
+{
+	struct bio_vec bv = bvec[iter-&gt;idx];
+
+	bv.bv_offset	+= iter-&gt;done;
+	bv.bv_len	-= iter-&gt;done;
+
+	bv.bv_page	+= bv.bv_offset &gt;&gt; PAGE_SHIFT;
+	bv.bv_offset	&amp;= ~PAGE_MASK;
+	bv.bv_len	= min_t(unsigned, PAGE_SIZE - bv.bv_offset, bv.bv_len);
+
+	return bv;
</span> }
 
<span>-static inline void bvec_advance(const struct bio_vec *bvec,
-				struct bvec_iter_all *iter_all)
</span><span>+static inline void bvec_iter_all_advance(const struct bio_vec *bvec,
+					 struct bvec_iter_all *iter,
+					 unsigned bytes)
</span> {
<span>-	struct bio_vec *bv = &amp;iter_all-&gt;bv;
-
-	if (iter_all-&gt;done) {
-		bv-&gt;bv_page++;
-		bv-&gt;bv_offset = 0;
-	} else {
-		bv-&gt;bv_page = bvec-&gt;bv_page + (bvec-&gt;bv_offset &gt;&gt; PAGE_SHIFT);
-		bv-&gt;bv_offset = bvec-&gt;bv_offset &amp; ~PAGE_MASK;
-	}
-	bv-&gt;bv_len = min_t(unsigned int, PAGE_SIZE - bv-&gt;bv_offset,
-			   bvec-&gt;bv_len - iter_all-&gt;done);
-	iter_all-&gt;done += bv-&gt;bv_len;
</span><span>+	iter-&gt;done += bytes;
</span> 
<span>-	if (iter_all-&gt;done == bvec-&gt;bv_len) {
-		iter_all-&gt;idx++;
-		iter_all-&gt;done = 0;
</span><span>+	while (iter-&gt;done &amp;&amp; iter-&gt;done &gt;= bvec[iter-&gt;idx].bv_len) {
+		iter-&gt;done -= bvec[iter-&gt;idx].bv_len;
+		iter-&gt;idx++;
</span> 	}
 }
 
-- 
2.40.1


<a href="#me7c73abf299cc9cefad55241f69d34f076de39ea" id="ee7c73abf299cc9cefad55241f69d34f076de39ea">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-13-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-13-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-13-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-13-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-13-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-13-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#re7c73abf299cc9cefad55241f69d34f076de39ea">73+ messages in thread</a></pre><hr/><pre><a href="#eaca8f244af9569907d098909fdf84087d95d7acd" id="maca8f244af9569907d098909fdf84087d95d7acd">*</a> <b>[PATCH 13/32] block: Rework bio_for_each_folio_all()</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#re7c73abf299cc9cefad55241f69d34f076de39ea">(11 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#me7c73abf299cc9cefad55241f69d34f076de39ea">[PATCH 12/32] block: Rework bio_for_each_segment_all()</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#m34397a4d39f5988cc0b635e29f70a6170927746f">[PATCH 14/32] block: Don&#39;t block on s_umount from __invalidate_super()</a> Kent Overstreet
                   ` <a href="#r34397a4d39f5988cc0b635e29f70a6170927746f">(18 subsequent siblings)</a>
  <a href="#raca8f244af9569907d098909fdf84087d95d7acd">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-14-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-14-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Matthew Wilcox, linux-block

This reimplements bio_for_each_folio_all() on top of the newly-reworked
bvec_iter_all, and since it&#39;s now trivial we also provide
bio_for_each_folio.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
Cc: Matthew Wilcox &lt;willy@infradead.org&gt;
Cc: linux-block@vger.kernel.org
---
 <a id="iZ2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1fs:crypto:bio.c" href="#Z2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1fs:crypto:bio.c">fs/crypto/bio.c</a>        |  9 +++--
 <a id="iZ2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1fs:iomap:buffered-io.c" href="#Z2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1fs:iomap:buffered-io.c">fs/iomap/buffered-io.c</a> | 14 ++++---
 <a id="iZ2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1fs:verity:verify.c" href="#Z2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1fs:verity:verify.c">fs/verity/verify.c</a>     |  9 +++--
 <a id="iZ2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1include:linux:bio.h" href="#Z2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1include:linux:bio.h">include/linux/bio.h</a>    | 91 +++++++++++++++++++++---------------------
 <a id="iZ2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1include:linux:bvec.h" href="#Z2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1include:linux:bvec.h">include/linux/bvec.h</a>   | 15 +++++--
 5 files <a href="#eaca8f244af9569907d098909fdf84087d95d7acd">changed</a>, 75 insertions(+), 63 deletions(-)

<span><a href="#iZ2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1fs:crypto:bio.c" id="Z2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1fs:crypto:bio.c">diff</a> --git a/fs/crypto/bio.c b/fs/crypto/bio.c
index d57d0a020f..6469861add 100644
--- a/fs/crypto/bio.c
+++ b/fs/crypto/bio.c
</span><span>@@ -30,11 +30,12 @@
</span>  */
 bool fscrypt_decrypt_bio(struct bio *bio)
 {
<span>-	struct folio_iter fi;
</span><span>+	struct bvec_iter_all iter;
+	struct folio_vec fv;
</span> 
<span>-	bio_for_each_folio_all(fi, bio) {
-		int err = fscrypt_decrypt_pagecache_blocks(fi.folio, fi.length,
-							   fi.offset);
</span><span>+	bio_for_each_folio_all(fv, bio, iter) {
+		int err = fscrypt_decrypt_pagecache_blocks(fv.fv_folio, fv.fv_len,
+							   fv.fv_offset);
</span> 
 		if (err) {
 			bio-&gt;bi_status = errno_to_blk_status(err);
<span><a href="#iZ2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1fs:iomap:buffered-io.c" id="Z2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1fs:iomap:buffered-io.c">diff</a> --git a/fs/iomap/buffered-io.c b/fs/iomap/buffered-io.c
index 6f4c97a6d7..60661c87d5 100644
--- a/fs/iomap/buffered-io.c
+++ b/fs/iomap/buffered-io.c
</span><span>@@ -187,10 +187,11 @@ static void iomap_finish_folio_read(struct folio *folio, size_t offset,
</span> static void iomap_read_end_io(struct bio *bio)
 {
 	int error = blk_status_to_errno(bio-&gt;bi_status);
<span>-	struct folio_iter fi;
</span><span>+	struct bvec_iter_all iter;
+	struct folio_vec fv;
</span> 
<span>-	bio_for_each_folio_all(fi, bio)
-		iomap_finish_folio_read(fi.folio, fi.offset, fi.length, error);
</span><span>+	bio_for_each_folio_all(fv, bio, iter)
+		iomap_finish_folio_read(fv.fv_folio, fv.fv_offset, fv.fv_len, error);
</span> 	bio_put(bio);
 }
 
<span>@@ -1328,7 +1329,8 @@ iomap_finish_ioend(struct iomap_ioend *ioend, int error)
</span> 	u32 folio_count = 0;
 
 	for (bio = &amp;ioend-&gt;io_inline_bio; bio; bio = next) {
<span>-		struct folio_iter fi;
</span><span>+		struct bvec_iter_all iter;
+		struct folio_vec fv;
</span> 
 		/*
 		 * For the last bio, bi_private points to the ioend, so we
<span>@@ -1340,8 +1342,8 @@ iomap_finish_ioend(struct iomap_ioend *ioend, int error)
</span> 			next = bio-&gt;bi_private;
 
 		/* walk all folios in bio, ending page IO on them */
<span>-		bio_for_each_folio_all(fi, bio) {
-			iomap_finish_folio_write(inode, fi.folio, fi.length,
</span><span>+		bio_for_each_folio_all(fv, bio, iter) {
+			iomap_finish_folio_write(inode, fv.fv_folio, fv.fv_len,
</span> 					error);
 			folio_count++;
 		}
<span><a href="#iZ2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1fs:verity:verify.c" id="Z2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1fs:verity:verify.c">diff</a> --git a/fs/verity/verify.c b/fs/verity/verify.c
index e250822275..b111ab0102 100644
--- a/fs/verity/verify.c
+++ b/fs/verity/verify.c
</span><span>@@ -340,7 +340,8 @@ void fsverity_verify_bio(struct bio *bio)
</span> 	struct inode *inode = bio_first_page_all(bio)-&gt;mapping-&gt;host;
 	struct fsverity_info *vi = inode-&gt;i_verity_info;
 	struct ahash_request *req;
<span>-	struct folio_iter fi;
</span><span>+	struct bvec_iter_all iter;
+	struct folio_vec fv;
</span> 	unsigned long max_ra_pages = 0;
 
 	/* This allocation never fails, since it&#39;s mempool-backed. */
<span>@@ -359,9 +360,9 @@ void fsverity_verify_bio(struct bio *bio)
</span> 		max_ra_pages = bio-&gt;bi_iter.bi_size &gt;&gt; (PAGE_SHIFT + 2);
 	}
 
<span>-	bio_for_each_folio_all(fi, bio) {
-		if (!verify_data_blocks(inode, vi, req, fi.folio, fi.length,
-					fi.offset, max_ra_pages)) {
</span><span>+	bio_for_each_folio_all(fv, bio, iter) {
+		if (!verify_data_blocks(inode, vi, req, fv.fv_folio, fv.fv_len,
+					fv.fv_offset, max_ra_pages)) {
</span> 			bio-&gt;bi_status = BLK_STS_IOERR;
 			break;
 		}
<span><a href="#iZ2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1include:linux:bio.h" id="Z2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1include:linux:bio.h">diff</a> --git a/include/linux/bio.h b/include/linux/bio.h
index f86c7190c3..7ced281734 100644
--- a/include/linux/bio.h
+++ b/include/linux/bio.h
</span><span>@@ -169,6 +169,42 @@ static inline void bio_advance(struct bio *bio, unsigned int nbytes)
</span> #define bio_for_each_segment(bvl, bio, iter)				\
 	__bio_for_each_segment(bvl, bio, iter, (bio)-&gt;bi_iter)
 
<span>+struct folio_vec {
+	struct folio	*fv_folio;
+	size_t		fv_offset;
+	size_t		fv_len;
+};
+
+static inline struct folio_vec biovec_to_foliovec(struct bio_vec bv)
+{
+
+	struct folio *folio	= page_folio(bv.bv_page);
+	size_t offset		= (folio_page_idx(folio, bv.bv_page) &lt;&lt; PAGE_SHIFT) +
+		bv.bv_offset;
+	size_t len = min_t(size_t, folio_size(folio) - offset, bv.bv_len);
+
+	return (struct folio_vec) {
+		.fv_folio	= folio,
+		.fv_offset	= offset,
+		.fv_len		= len,
+	};
+}
+
+static inline struct folio_vec bio_iter_iovec_folio(struct bio *bio,
+						    struct bvec_iter iter)
+{
+	return biovec_to_foliovec(bio_iter_iovec(bio, iter));
+}
+
+#define __bio_for_each_folio(bvl, bio, iter, start)			\
+	for (iter = (start);						\
+	     (iter).bi_size &amp;&amp;						\
+		((bvl = bio_iter_iovec_folio((bio), (iter))), 1);	\
+	     bio_advance_iter_single((bio), &amp;(iter), (bvl).fv_len))
+
+#define bio_for_each_folio(bvl, bio, iter)				\
+	__bio_for_each_folio(bvl, bio, iter, (bio)-&gt;bi_iter)
+
</span> #define __bio_for_each_bvec(bvl, bio, iter, start)		\
 	for (iter = (start);						\
 	     (iter).bi_size &amp;&amp;						\
<span>@@ -277,59 +313,22 @@ static inline struct bio_vec *bio_last_bvec_all(struct bio *bio)
</span> 	return &amp;bio-&gt;bi_io_vec[bio-&gt;bi_vcnt - 1];
 }
 
<span>-/**
- * struct folio_iter - State for iterating all folios in a bio.
- * @folio: The current folio we&#39;re iterating.  NULL after the last folio.
- * @offset: The byte offset within the current folio.
- * @length: The number of bytes in this iteration (will not cross folio
- *	boundary).
- */
-struct folio_iter {
-	struct folio *folio;
-	size_t offset;
-	size_t length;
-	/* private: for use by the iterator */
-	struct folio *_next;
-	size_t _seg_count;
-	int _i;
-};
-
-static inline void bio_first_folio(struct folio_iter *fi, struct bio *bio,
-				   int i)
-{
-	struct bio_vec *bvec = bio_first_bvec_all(bio) + i;
-
-	fi-&gt;folio = page_folio(bvec-&gt;bv_page);
-	fi-&gt;offset = bvec-&gt;bv_offset +
-			PAGE_SIZE * (bvec-&gt;bv_page - &amp;fi-&gt;folio-&gt;page);
-	fi-&gt;_seg_count = bvec-&gt;bv_len;
-	fi-&gt;length = min(folio_size(fi-&gt;folio) - fi-&gt;offset, fi-&gt;_seg_count);
-	fi-&gt;_next = folio_next(fi-&gt;folio);
-	fi-&gt;_i = i;
-}
-
-static inline void bio_next_folio(struct folio_iter *fi, struct bio *bio)
</span><span>+static inline struct folio_vec bio_folio_iter_all_peek(const struct bio *bio,
+						       const struct bvec_iter_all *iter)
</span> {
<span>-	fi-&gt;_seg_count -= fi-&gt;length;
-	if (fi-&gt;_seg_count) {
-		fi-&gt;folio = fi-&gt;_next;
-		fi-&gt;offset = 0;
-		fi-&gt;length = min(folio_size(fi-&gt;folio), fi-&gt;_seg_count);
-		fi-&gt;_next = folio_next(fi-&gt;folio);
-	} else if (fi-&gt;_i + 1 &lt; bio-&gt;bi_vcnt) {
-		bio_first_folio(fi, bio, fi-&gt;_i + 1);
-	} else {
-		fi-&gt;folio = NULL;
-	}
</span><span>+	return biovec_to_foliovec(__bvec_iter_all_peek(bio-&gt;bi_io_vec, iter));
</span> }
 
 /**
  * bio_for_each_folio_all - Iterate over each folio in a bio.
<span>- * @fi: struct folio_iter which is updated for each folio.
</span><span>+ * @fi: struct bio_folio_iter_all which is updated for each folio.
</span>  * @bio: struct bio to iterate over.
  */
<span>-#define bio_for_each_folio_all(fi, bio)				\
-	for (bio_first_folio(&amp;fi, bio, 0); fi.folio; bio_next_folio(&amp;fi, bio))
</span><span>+#define bio_for_each_folio_all(fv, bio, iter)				\
+	for (bvec_iter_all_init(&amp;iter);					\
+	     iter.idx &lt; bio-&gt;bi_vcnt &amp;&amp;					\
+		((fv = bio_folio_iter_all_peek(bio, &amp;iter)), true);	\
+	     bio_iter_all_advance((bio), &amp;iter, fv.fv_len))
</span> 
 enum bip_flags {
 	BIP_BLOCK_INTEGRITY	= 1 &lt;&lt; 0, /* block layer owns integrity data */
<span><a href="#iZ2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1include:linux:bvec.h" id="Z2e.:..:20230509165657.1735798-14-kent.overstreet::40linux.dev:1include:linux:bvec.h">diff</a> --git a/include/linux/bvec.h b/include/linux/bvec.h
index 635fb54143..d238f959e3 100644
--- a/include/linux/bvec.h
+++ b/include/linux/bvec.h
</span><span>@@ -205,18 +205,27 @@ static inline void bvec_iter_all_init(struct bvec_iter_all *iter_all)
</span> 	iter_all-&gt;idx = 0;
 }
 
<span>-static inline struct bio_vec bvec_iter_all_peek(const struct bio_vec *bvec,
-						struct bvec_iter_all *iter)
</span><span>+static inline struct bio_vec __bvec_iter_all_peek(const struct bio_vec *bvec,
+						  const struct bvec_iter_all *iter)
</span> {
 	struct bio_vec bv = bvec[iter-&gt;idx];
 
<span>+	BUG_ON(iter-&gt;done &gt;= bv.bv_len);
+
</span> 	bv.bv_offset	+= iter-&gt;done;
 	bv.bv_len	-= iter-&gt;done;
 
 	bv.bv_page	+= bv.bv_offset &gt;&gt; PAGE_SHIFT;
 	bv.bv_offset	&amp;= ~PAGE_MASK;
<span>-	bv.bv_len	= min_t(unsigned, PAGE_SIZE - bv.bv_offset, bv.bv_len);
</span><span>+	return bv;
+}
+
+static inline struct bio_vec bvec_iter_all_peek(const struct bio_vec *bvec,
+						const struct bvec_iter_all *iter)
+{
+	struct bio_vec bv = __bvec_iter_all_peek(bvec, iter);
</span> 
<span>+	bv.bv_len = min_t(unsigned, PAGE_SIZE - bv.bv_offset, bv.bv_len);
</span> 	return bv;
 }
 
-- 
2.40.1


<a href="#maca8f244af9569907d098909fdf84087d95d7acd" id="eaca8f244af9569907d098909fdf84087d95d7acd">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-14-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-14-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-14-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-14-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-14-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-14-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#raca8f244af9569907d098909fdf84087d95d7acd">73+ messages in thread</a></pre><hr/><pre><a href="#e34397a4d39f5988cc0b635e29f70a6170927746f" id="m34397a4d39f5988cc0b635e29f70a6170927746f">*</a> <b>[PATCH 14/32] block: Don&#39;t block on s_umount from __invalidate_super()</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#raca8f244af9569907d098909fdf84087d95d7acd">(12 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#maca8f244af9569907d098909fdf84087d95d7acd">[PATCH 13/32] block: Rework bio_for_each_folio_all()</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#m808e33cd7146a6cf25568dd0527029deacdc1f57">[PATCH 15/32] bcache: move closures to lib/</a> Kent Overstreet
                   ` <a href="#r808e33cd7146a6cf25568dd0527029deacdc1f57">(17 subsequent siblings)</a>
  <a href="#r34397a4d39f5988cc0b635e29f70a6170927746f">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-15-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-15-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs; <b>+Cc:</b> Kent Overstreet

__invalidate_super() is used to flush any filesystem mounted on a
device, generally on some sort of media change event.

However, when unmounting a filesystem and closing the underlying block
devices, we can deadlock if the block driver then calls
__invalidate_device() (e.g. because the block device goes away when it
is no longer in use).

This happens with bcachefs on top of loopback, and can be triggered by
fstests generic/042:

  put_super
    -&gt; blkdev_put
    -&gt; lo_release
    -&gt; disk_force_media_change
    -&gt; __invalidate_device
    -&gt; get_super

This isn&#39;t inherently specific to bcachefs - it hasn&#39;t shown up with
other filesystems before because most other filesystems use the sget()
mechanism for opening/closing block devices (and enforcing exclusion),
however sget() has its own downsides and weird/sketchy behaviour w.r.t.
block device open lifetime - if that ever gets fixed more code will run
into this issue.

The __invalidate_device() call here is really a best effort &#34;I just
yanked the device for a mounted filesystem, please try not to lose my
data&#34; - if it&#39;s ever actually needed the user has already done something
crazy, and we probably shouldn&#39;t make things worse by deadlocking.
Switching to a trylock seems in keeping with what the code is trying to
do.

If we ever get revoke() at the block layer, perhaps we would look at
rearchitecting to use that instead.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-15-kent.overstreet::40linux.dev:1block:bdev.c" href="#Z2e.:..:20230509165657.1735798-15-kent.overstreet::40linux.dev:1block:bdev.c">block/bdev.c</a>       |  2 +-
 <a id="iZ2e.:..:20230509165657.1735798-15-kent.overstreet::40linux.dev:1fs:super.c" href="#Z2e.:..:20230509165657.1735798-15-kent.overstreet::40linux.dev:1fs:super.c">fs/super.c</a>         | 40 +++++++++++++++++++++++++++++++---------
 <a id="iZ2e.:..:20230509165657.1735798-15-kent.overstreet::40linux.dev:1include:linux:fs.h" href="#Z2e.:..:20230509165657.1735798-15-kent.overstreet::40linux.dev:1include:linux:fs.h">include/linux/fs.h</a> |  1 +
 3 files <a href="#e34397a4d39f5988cc0b635e29f70a6170927746f">changed</a>, 33 insertions(+), 10 deletions(-)

<span><a href="#iZ2e.:..:20230509165657.1735798-15-kent.overstreet::40linux.dev:1block:bdev.c" id="Z2e.:..:20230509165657.1735798-15-kent.overstreet::40linux.dev:1block:bdev.c">diff</a> --git a/block/bdev.c b/block/bdev.c
index 1795c7d4b9..743e969b7b 100644
--- a/block/bdev.c
+++ b/block/bdev.c
</span><span>@@ -922,7 +922,7 @@ EXPORT_SYMBOL(lookup_bdev);
</span> 
 int __invalidate_device(struct block_device *bdev, bool kill_dirty)
 {
<span>-	struct super_block *sb = get_super(bdev);
</span><span>+	struct super_block *sb = try_get_super(bdev);
</span> 	int res = 0;
 
 	if (sb) {
<span><a href="#iZ2e.:..:20230509165657.1735798-15-kent.overstreet::40linux.dev:1fs:super.c" id="Z2e.:..:20230509165657.1735798-15-kent.overstreet::40linux.dev:1fs:super.c">diff</a> --git a/fs/super.c b/fs/super.c
index 04bc62ab7d..a2decce02f 100644
--- a/fs/super.c
+++ b/fs/super.c
</span><span>@@ -791,14 +791,7 @@ void iterate_supers_type(struct file_system_type *type,
</span> 
 EXPORT_SYMBOL(iterate_supers_type);
 
<span>-/**
- * get_super - get the superblock of a device
- * @bdev: device to get the superblock for
- *
- * Scans the superblock list and finds the superblock of the file system
- * mounted on the device given. %NULL is returned if no match is found.
- */
-struct super_block *get_super(struct block_device *bdev)
</span><span>+static struct super_block *__get_super(struct block_device *bdev, bool try)
</span> {
 	struct super_block *sb;
 
<span>@@ -813,7 +806,12 @@ struct super_block *get_super(struct block_device *bdev)
</span> 		if (sb-&gt;s_bdev == bdev) {
 			sb-&gt;s_count++;
 			spin_unlock(&amp;sb_lock);
<span>-			down_read(&amp;sb-&gt;s_umount);
</span><span>+
+			if (!try)
+				down_read(&amp;sb-&gt;s_umount);
+			else if (!down_read_trylock(&amp;sb-&gt;s_umount))
+				return NULL;
+
</span> 			/* still alive? */
 			if (sb-&gt;s_root &amp;&amp; (sb-&gt;s_flags &amp; SB_BORN))
 				return sb;
<span>@@ -828,6 +826,30 @@ struct super_block *get_super(struct block_device *bdev)
</span> 	return NULL;
 }
 
<span>+/**
+ * get_super - get the superblock of a device
+ * @bdev: device to get the superblock for
+ *
+ * Scans the superblock list and finds the superblock of the file system
+ * mounted on the device given. %NULL is returned if no match is found.
+ */
+struct super_block *get_super(struct block_device *bdev)
+{
+	return __get_super(bdev, false);
+}
+
+/**
+ * try_get_super - get the superblock of a device, using trylock on sb-&gt;s_umount
+ * @bdev: device to get the superblock for
+ *
+ * Scans the superblock list and finds the superblock of the file system
+ * mounted on the device given. %NULL is returned if no match is found.
+ */
+struct super_block *try_get_super(struct block_device *bdev)
+{
+	return __get_super(bdev, true);
+}
+
</span> /**
  * get_active_super - get an active reference to the superblock of a device
  * @bdev: device to get the superblock for
<span><a href="#iZ2e.:..:20230509165657.1735798-15-kent.overstreet::40linux.dev:1include:linux:fs.h" id="Z2e.:..:20230509165657.1735798-15-kent.overstreet::40linux.dev:1include:linux:fs.h">diff</a> --git a/include/linux/fs.h b/include/linux/fs.h
index c85916e9f7..1a6f951942 100644
--- a/include/linux/fs.h
+++ b/include/linux/fs.h
</span><span>@@ -2878,6 +2878,7 @@ extern struct file_system_type *get_filesystem(struct file_system_type *fs);
</span> extern void put_filesystem(struct file_system_type *fs);
 extern struct file_system_type *get_fs_type(const char *name);
 extern struct super_block *get_super(struct block_device *);
<span>+extern struct super_block *try_get_super(struct block_device *);
</span> extern struct super_block *get_active_super(struct block_device *bdev);
 extern void drop_super(struct super_block *sb);
 extern void drop_super_exclusive(struct super_block *sb);
-- 
2.40.1


<a href="#m34397a4d39f5988cc0b635e29f70a6170927746f" id="e34397a4d39f5988cc0b635e29f70a6170927746f">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-15-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-15-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-15-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-15-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-15-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-15-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r34397a4d39f5988cc0b635e29f70a6170927746f">73+ messages in thread</a></pre><hr/><pre><a href="#e808e33cd7146a6cf25568dd0527029deacdc1f57" id="m808e33cd7146a6cf25568dd0527029deacdc1f57">*</a> <b>[PATCH 15/32] bcache: move closures to lib/</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#r34397a4d39f5988cc0b635e29f70a6170927746f">(13 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#m34397a4d39f5988cc0b635e29f70a6170927746f">[PATCH 14/32] block: Don&#39;t block on s_umount from __invalidate_super()</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-10  1:10   ` <a href="#m38a9689ff588cd1e3a641de6183a3213bb0a103b">Randy Dunlap</a>
  2023-05-09 16:56 ` <a href="#m766da299d420970b1b3f7ac489b0d1393f2da35d">[PATCH 16/32] MAINTAINERS: Add entry for closures</a> Kent Overstreet
                   ` <a href="#r766da299d420970b1b3f7ac489b0d1393f2da35d">(16 subsequent siblings)</a>
  <a href="#r808e33cd7146a6cf25568dd0527029deacdc1f57">31 siblings, 1 reply; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-16-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-16-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Kent Overstreet, Coly Li

From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;

Prep work for bcachefs - being a fork of bcache it also uses closures

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
Acked-by: Coly Li &lt;colyli@suse.de&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:Kconfig" href="#Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:Kconfig">drivers/md/bcache/Kconfig</a>                     | 10 +-----
 <a id="iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:Makefile" href="#Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:Makefile">drivers/md/bcache/Makefile</a>                    |  4 +--
 <a id="iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:bcache.h" href="#Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:bcache.h">drivers/md/bcache/bcache.h</a>                    |  2 +-
 <a id="iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:super.c" href="#Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:super.c">drivers/md/bcache/super.c</a>                     |  1 -
 <a id="iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:util.h" href="#Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:util.h">drivers/md/bcache/util.h</a>                      |  3 +-
 <a id="iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1include:linux::7d:closure.h" href="#Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1include:linux::7d:closure.h">.../md/bcache =&gt; include/linux}/closure.h</a>     | 17 +++++----
 <a id="iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1lib:Kconfig" href="#Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1lib:Kconfig">lib/Kconfig</a>                                   |  3 ++
 <a id="iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1lib:Kconfig.debug" href="#Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1lib:Kconfig.debug">lib/Kconfig.debug</a>                             |  9 +++++
 <a id="iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1lib:Makefile" href="#Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1lib:Makefile">lib/Makefile</a>                                  |  2 ++
 <a id="iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1lib:closure.c" href="#Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1lib:closure.c">{drivers/md/bcache =&gt; lib}/closure.c</a>          | 35 +++++++++----------
 10 files <a href="#e808e33cd7146a6cf25568dd0527029deacdc1f57">changed</a>, 43 insertions(+), 43 deletions(-)
 rename {drivers/md/bcache =&gt; include/linux}/closure.h (97%)
 rename {drivers/md/bcache =&gt; lib}/closure.c (88%)

<span><a href="#iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:Kconfig" id="Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:Kconfig">diff</a> --git a/drivers/md/bcache/Kconfig b/drivers/md/bcache/Kconfig
index 529c9d04e9..b2d10063d3 100644
--- a/drivers/md/bcache/Kconfig
+++ b/drivers/md/bcache/Kconfig
</span><span>@@ -4,6 +4,7 @@ config BCACHE
</span> 	tristate &#34;Block device as cache&#34;
 	select BLOCK_HOLDER_DEPRECATED if SYSFS
 	select CRC64
<span>+	select CLOSURES
</span> 	help
 	Allows a block device to be used as cache for other devices; uses
 	a btree for indexing and the layout is optimized for SSDs.
<span>@@ -19,15 +20,6 @@ config BCACHE_DEBUG
</span> 	Enables extra debugging tools, allows expensive runtime checks to be
 	turned on.
 
<span>-config BCACHE_CLOSURES_DEBUG
-	bool &#34;Debug closures&#34;
-	depends on BCACHE
-	select DEBUG_FS
-	help
-	Keeps all active closures in a linked list and provides a debugfs
-	interface to list them, which makes it possible to see asynchronous
-	operations that get stuck.
-
</span> config BCACHE_ASYNC_REGISTRATION
 	bool &#34;Asynchronous device registration&#34;
 	depends on BCACHE
<span><a href="#iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:Makefile" id="Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:Makefile">diff</a> --git a/drivers/md/bcache/Makefile b/drivers/md/bcache/Makefile
index 5b87e59676..054e8a33a7 100644
--- a/drivers/md/bcache/Makefile
+++ b/drivers/md/bcache/Makefile
</span><span>@@ -2,6 +2,6 @@
</span> 
 obj-$(CONFIG_BCACHE)	+= bcache.o
 
<span>-bcache-y		:= alloc.o bset.o btree.o closure.o debug.o extents.o\
-	io.o journal.o movinggc.o request.o stats.o super.o sysfs.o trace.o\
</span><span>+bcache-y		:= alloc.o bset.o btree.o debug.o extents.o io.o\
+	journal.o movinggc.o request.o stats.o super.o sysfs.o trace.o\
</span> 	util.o writeback.o features.o
<span><a href="#iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:bcache.h" id="Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:bcache.h">diff</a> --git a/drivers/md/bcache/bcache.h b/drivers/md/bcache/bcache.h
index aebb7ef10e..c8b4914ad8 100644
--- a/drivers/md/bcache/bcache.h
+++ b/drivers/md/bcache/bcache.h
</span><span>@@ -179,6 +179,7 @@
</span> #define pr_fmt(fmt) &#34;bcache: %s() &#34; fmt, __func__
 
 #include &lt;linux/bio.h&gt;
<span>+#include &lt;linux/closure.h&gt;
</span> #include &lt;linux/kobject.h&gt;
 #include &lt;linux/list.h&gt;
 #include &lt;linux/mutex.h&gt;
<span>@@ -192,7 +193,6 @@
</span> #include &#34;bcache_ondisk.h&#34;
 #include &#34;bset.h&#34;
 #include &#34;util.h&#34;
<span>-#include &#34;closure.h&#34;
</span> 
 struct bucket {
 	atomic_t	pin;
<span><a href="#iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:super.c" id="Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:super.c">diff</a> --git a/drivers/md/bcache/super.c b/drivers/md/bcache/super.c
index ba3909bb6b..31b68a1b87 100644
--- a/drivers/md/bcache/super.c
+++ b/drivers/md/bcache/super.c
</span><span>@@ -2912,7 +2912,6 @@ static int __init bcache_init(void)
</span> 		goto err;
 
 	bch_debug_init();
<span>-	closure_debug_init();
</span> 
 	bcache_is_reboot = false;
 
<span><a href="#iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:util.h" id="Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1drivers:md:bcache:util.h">diff</a> --git a/drivers/md/bcache/util.h b/drivers/md/bcache/util.h
index 6f3cb7c921..f61ab1bada 100644
--- a/drivers/md/bcache/util.h
+++ b/drivers/md/bcache/util.h
</span><span>@@ -4,6 +4,7 @@
</span> #define _BCACHE_UTIL_H
 
 #include &lt;linux/blkdev.h&gt;
<span>+#include &lt;linux/closure.h&gt;
</span> #include &lt;linux/errno.h&gt;
 #include &lt;linux/kernel.h&gt;
 #include &lt;linux/sched/clock.h&gt;
<span>@@ -13,8 +14,6 @@
</span> #include &lt;linux/workqueue.h&gt;
 #include &lt;linux/crc64.h&gt;
 
<span>-#include &#34;closure.h&#34;
-
</span> struct closure;
 
 #ifdef CONFIG_BCACHE_DEBUG
<span>diff --git a/drivers/md/bcache/closure.h b/include/linux/closure.h
similarity index 97%
rename from drivers/md/bcache/closure.h
rename to include/linux/closure.h
index c88cdc4ae4..0ec9e7bc8d 100644
--- a/drivers/md/bcache/closure.h
+++ b/include/linux/closure.h
</span><span>@@ -155,7 +155,7 @@ struct closure {
</span> 
 	atomic_t		remaining;
 
<span>-#ifdef CONFIG_BCACHE_CLOSURES_DEBUG
</span><span>+#ifdef CONFIG_DEBUG_CLOSURES
</span> #define CLOSURE_MAGIC_DEAD	0xc054dead
 #define CLOSURE_MAGIC_ALIVE	0xc054a11e
 
<span>@@ -184,15 +184,13 @@ static inline void closure_sync(struct closure *cl)
</span> 		__closure_sync(cl);
 }
 
<span>-#ifdef CONFIG_BCACHE_CLOSURES_DEBUG
</span><span>+#ifdef CONFIG_DEBUG_CLOSURES
</span> 
<span>-void closure_debug_init(void);
</span> void closure_debug_create(struct closure *cl);
 void closure_debug_destroy(struct closure *cl);
 
 #else
 
<span>-static inline void closure_debug_init(void) {}
</span> static inline void closure_debug_create(struct closure *cl) {}
 static inline void closure_debug_destroy(struct closure *cl) {}
 
<span>@@ -200,21 +198,21 @@ static inline void closure_debug_destroy(struct closure *cl) {}
</span> 
 static inline void closure_set_ip(struct closure *cl)
 {
<span>-#ifdef CONFIG_BCACHE_CLOSURES_DEBUG
</span><span>+#ifdef CONFIG_DEBUG_CLOSURES
</span> 	cl-&gt;ip = _THIS_IP_;
 #endif
 }
 
 static inline void closure_set_ret_ip(struct closure *cl)
 {
<span>-#ifdef CONFIG_BCACHE_CLOSURES_DEBUG
</span><span>+#ifdef CONFIG_DEBUG_CLOSURES
</span> 	cl-&gt;ip = _RET_IP_;
 #endif
 }
 
 static inline void closure_set_waiting(struct closure *cl, unsigned long f)
 {
<span>-#ifdef CONFIG_BCACHE_CLOSURES_DEBUG
</span><span>+#ifdef CONFIG_DEBUG_CLOSURES
</span> 	cl-&gt;waiting_on = f;
 #endif
 }
<span>@@ -243,6 +241,7 @@ static inline void closure_queue(struct closure *cl)
</span> 	 */
 	BUILD_BUG_ON(offsetof(struct closure, fn)
 		     != offsetof(struct work_struct, func));
<span>+
</span> 	if (wq) {
 		INIT_WORK(&amp;cl-&gt;work, cl-&gt;work.func);
 		BUG_ON(!queue_work(wq, &amp;cl-&gt;work));
<span>@@ -255,7 +254,7 @@ static inline void closure_queue(struct closure *cl)
</span>  */
 static inline void closure_get(struct closure *cl)
 {
<span>-#ifdef CONFIG_BCACHE_CLOSURES_DEBUG
</span><span>+#ifdef CONFIG_DEBUG_CLOSURES
</span> 	BUG_ON((atomic_inc_return(&amp;cl-&gt;remaining) &amp;
 		CLOSURE_REMAINING_MASK) &lt;= 1);
 #else
<span>@@ -271,7 +270,7 @@ static inline void closure_get(struct closure *cl)
</span>  */
 static inline void closure_init(struct closure *cl, struct closure *parent)
 {
<span>-	memset(cl, 0, sizeof(struct closure));
</span><span>+	cl-&gt;fn = NULL;
</span> 	cl-&gt;parent = parent;
 	if (parent)
 		closure_get(parent);
<span><a href="#iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1lib:Kconfig" id="Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1lib:Kconfig">diff</a> --git a/lib/Kconfig b/lib/Kconfig
index ce2abffb9e..1aa1c15a83 100644
--- a/lib/Kconfig
+++ b/lib/Kconfig
</span><span>@@ -504,6 +504,9 @@ config ASSOCIATIVE_ARRAY
</span> 
 	  for more information.
 
<span>+config CLOSURES
+	bool
+
</span> config HAS_IOMEM
 	bool
 	depends on !NO_IOMEM
<span><a href="#iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1lib:Kconfig.debug" id="Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1lib:Kconfig.debug">diff</a> --git a/lib/Kconfig.debug b/lib/Kconfig.debug
index 39d1d93164..3dba7a9aff 100644
--- a/lib/Kconfig.debug
+++ b/lib/Kconfig.debug
</span><span>@@ -1618,6 +1618,15 @@ config DEBUG_NOTIFIERS
</span> 	  This is a relatively cheap check but if you care about maximum
 	  performance, say N.
 
<span>+config DEBUG_CLOSURES
+	bool &#34;Debug closures (bcache async widgits)&#34;
+	depends on CLOSURES
+	select DEBUG_FS
+	help
+	Keeps all active closures in a linked list and provides a debugfs
+	interface to list them, which makes it possible to see asynchronous
+	operations that get stuck.
+
</span> config BUG_ON_DATA_CORRUPTION
 	bool &#34;Trigger a BUG when data corruption is detected&#34;
 	select DEBUG_LIST
<span><a href="#iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1lib:Makefile" id="Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1lib:Makefile">diff</a> --git a/lib/Makefile b/lib/Makefile
index baf2821f7a..fd13ca6e0e 100644
--- a/lib/Makefile
+++ b/lib/Makefile
</span><span>@@ -245,6 +245,8 @@ obj-$(CONFIG_ATOMIC64_SELFTEST) += atomic64_test.o
</span> 
 obj-$(CONFIG_CPU_RMAP) += cpu_rmap.o
 
<span>+obj-$(CONFIG_CLOSURES) += closure.o
+
</span> obj-$(CONFIG_DQL) += dynamic_queue_limits.o
 
 obj-$(CONFIG_GLOB) += glob.o
<span><a href="#iZ2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1lib:closure.c" id="Z2e.:..:20230509165657.1735798-16-kent.overstreet::40linux.dev:1lib:closure.c">diff</a> --git a/drivers/md/bcache/closure.c b/lib/closure.c
similarity index 88%
rename from drivers/md/bcache/closure.c
rename to lib/closure.c
index d8d9394a6b..b38ded00b9 100644
--- a/drivers/md/bcache/closure.c
+++ b/lib/closure.c
</span><span>@@ -6,13 +6,12 @@
</span>  * Copyright 2012 Google, Inc.
  */
 
<span>+#include &lt;linux/closure.h&gt;
</span> #include &lt;linux/debugfs.h&gt;
<span>-#include &lt;linux/module.h&gt;
</span><span>+#include &lt;linux/export.h&gt;
</span> #include &lt;linux/seq_file.h&gt;
 #include &lt;linux/sched/debug.h&gt;
 
<span>-#include &#34;closure.h&#34;
-
</span> static inline void closure_put_after_sub(struct closure *cl, int flags)
 {
 	int r = flags &amp; CLOSURE_REMAINING_MASK;
<span>@@ -45,6 +44,7 @@ void closure_sub(struct closure *cl, int v)
</span> {
 	closure_put_after_sub(cl, atomic_sub_return(v, &amp;cl-&gt;remaining));
 }
<span>+EXPORT_SYMBOL(closure_sub);
</span> 
 /*
  * closure_put - decrement a closure&#39;s refcount
<span>@@ -53,6 +53,7 @@ void closure_put(struct closure *cl)
</span> {
 	closure_put_after_sub(cl, atomic_dec_return(&amp;cl-&gt;remaining));
 }
<span>+EXPORT_SYMBOL(closure_put);
</span> 
 /*
  * closure_wake_up - wake up all closures on a wait list, without memory barrier
<span>@@ -74,6 +75,7 @@ void __closure_wake_up(struct closure_waitlist *wait_list)
</span> 		closure_sub(cl, CLOSURE_WAITING + 1);
 	}
 }
<span>+EXPORT_SYMBOL(__closure_wake_up);
</span> 
 /**
  * closure_wait - add a closure to a waitlist
<span>@@ -93,6 +95,7 @@ bool closure_wait(struct closure_waitlist *waitlist, struct closure *cl)
</span> 
 	return true;
 }
<span>+EXPORT_SYMBOL(closure_wait);
</span> 
 struct closure_syncer {
 	struct task_struct	*task;
<span>@@ -127,8 +130,9 @@ void __sched __closure_sync(struct closure *cl)
</span> 
 	__set_current_state(TASK_RUNNING);
 }
<span>+EXPORT_SYMBOL(__closure_sync);
</span> 
<span>-#ifdef CONFIG_BCACHE_CLOSURES_DEBUG
</span><span>+#ifdef CONFIG_DEBUG_CLOSURES
</span> 
 static LIST_HEAD(closure_list);
 static DEFINE_SPINLOCK(closure_list_lock);
<span>@@ -144,6 +148,7 @@ void closure_debug_create(struct closure *cl)
</span> 	list_add(&amp;cl-&gt;all, &amp;closure_list);
 	spin_unlock_irqrestore(&amp;closure_list_lock, flags);
 }
<span>+EXPORT_SYMBOL(closure_debug_create);
</span> 
 void closure_debug_destroy(struct closure *cl)
 {
<span>@@ -156,8 +161,7 @@ void closure_debug_destroy(struct closure *cl)
</span> 	list_del(&amp;cl-&gt;all);
 	spin_unlock_irqrestore(&amp;closure_list_lock, flags);
 }
<span>-
-static struct dentry *closure_debug;
</span><span>+EXPORT_SYMBOL(closure_debug_destroy);
</span> 
 static int debug_show(struct seq_file *f, void *data)
 {
<span>@@ -181,7 +185,7 @@ static int debug_show(struct seq_file *f, void *data)
</span> 			seq_printf(f, &#34; W %pS\n&#34;,
 				   (void *) cl-&gt;waiting_on);
 
<span>-		seq_printf(f, &#34;\n&#34;);
</span><span>+		seq_puts(f, &#34;\n&#34;);
</span> 	}
 
 	spin_unlock_irq(&amp;closure_list_lock);
<span>@@ -190,18 +194,11 @@ static int debug_show(struct seq_file *f, void *data)
</span> 
 DEFINE_SHOW_ATTRIBUTE(debug);
 
<span>-void  __init closure_debug_init(void)
</span><span>+static int __init closure_debug_init(void)
</span> {
<span>-	if (!IS_ERR_OR_NULL(bcache_debug))
-		/*
-		 * it is unnecessary to check return value of
-		 * debugfs_create_file(), we should not care
-		 * about this.
-		 */
-		closure_debug = debugfs_create_file(
-			&#34;closures&#34;, 0400, bcache_debug, NULL, &amp;debug_fops);
</span><span>+	debugfs_create_file(&#34;closures&#34;, 0400, NULL, NULL, &amp;debug_fops);
+	return 0;
</span> }
<span>-#endif
</span><span>+late_initcall(closure_debug_init)
</span> 
<span>-MODULE_AUTHOR(&#34;Kent Overstreet &lt;koverstreet@google.com&gt;&#34;);
-MODULE_LICENSE(&#34;GPL&#34;);
</span><span>+#endif
</span>-- 
2.40.1


<a href="#m808e33cd7146a6cf25568dd0527029deacdc1f57" id="e808e33cd7146a6cf25568dd0527029deacdc1f57">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-16-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-16-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-16-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-16-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-16-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-16-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r808e33cd7146a6cf25568dd0527029deacdc1f57">73+ messages in thread</a></pre><hr/><pre><a href="#e766da299d420970b1b3f7ac489b0d1393f2da35d" id="m766da299d420970b1b3f7ac489b0d1393f2da35d">*</a> <b>[PATCH 16/32] MAINTAINERS: Add entry for closures</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#r808e33cd7146a6cf25568dd0527029deacdc1f57">(14 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#m808e33cd7146a6cf25568dd0527029deacdc1f57">[PATCH 15/32] bcache: move closures to lib/</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 17:05   ` <a href="#mbb2558522aa7d939e3d68574ae0ae4a8acfaae61">Coly Li</a>
  2023-05-09 21:03   ` <a href="#m1da07d4e58363b6d528f2a64372eb80c78d0b92f">Randy Dunlap</a>
  2023-05-09 16:56 ` <a href="#m26517bcd26c9764cee8234a773e737b705211bb3">[PATCH 17/32] closures: closure_wait_event()</a> Kent Overstreet
                   ` <a href="#r26517bcd26c9764cee8234a773e737b705211bb3">(15 subsequent siblings)</a>
  <a href="#r766da299d420970b1b3f7ac489b0d1393f2da35d">31 siblings, 2 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-17-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-17-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs; <b>+Cc:</b> Kent Overstreet, Coly Li

closures, from bcache, are async widgets with a variety of uses.
bcachefs also uses them, so they&#39;re being moved to lib/; mark them as
maintained.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
Cc: Coly Li &lt;colyli@suse.de&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-17-kent.overstreet::40linux.dev:1MAINTAINERS" href="#Z2e.:..:20230509165657.1735798-17-kent.overstreet::40linux.dev:1MAINTAINERS">MAINTAINERS</a> | 8 ++++++++
 1 file <a href="#e766da299d420970b1b3f7ac489b0d1393f2da35d">changed</a>, 8 insertions(+)

<span><a href="#iZ2e.:..:20230509165657.1735798-17-kent.overstreet::40linux.dev:1MAINTAINERS" id="Z2e.:..:20230509165657.1735798-17-kent.overstreet::40linux.dev:1MAINTAINERS">diff</a> --git a/MAINTAINERS b/MAINTAINERS
index 3fc37de3d6..5d76169140 100644
--- a/MAINTAINERS
+++ b/MAINTAINERS
</span><span>@@ -5044,6 +5044,14 @@ T:	git git://git.kernel.org/pub/scm/linux/kernel/git/tip/tip.git timers/core
</span> F:	Documentation/devicetree/bindings/timer/
 F:	drivers/clocksource/
 
<span>+CLOSURES:
+M:	Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
+L:	linux-bcachefs@vger.kernel.org
+S:	Supported
+C:	irc://irc.oftc.net/bcache
+F:	include/linux/closure.h
+F:	lib/closure.c
+
</span> CMPC ACPI DRIVER
 M:	Thadeu Lima de Souza Cascardo &lt;cascardo@holoscopio.com&gt;
 M:	Daniel Oliveira Nascimento &lt;don@syst.com.br&gt;
-- 
2.40.1


<a href="#m766da299d420970b1b3f7ac489b0d1393f2da35d" id="e766da299d420970b1b3f7ac489b0d1393f2da35d">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-17-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-17-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-17-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-17-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-17-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-17-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r766da299d420970b1b3f7ac489b0d1393f2da35d">73+ messages in thread</a></pre><hr/><pre><a href="#e26517bcd26c9764cee8234a773e737b705211bb3" id="m26517bcd26c9764cee8234a773e737b705211bb3">*</a> <b>[PATCH 17/32] closures: closure_wait_event()</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#r766da299d420970b1b3f7ac489b0d1393f2da35d">(15 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#m766da299d420970b1b3f7ac489b0d1393f2da35d">[PATCH 16/32] MAINTAINERS: Add entry for closures</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#md7a0cc0ae16f7122387e4f90ff5274287512e12d">[PATCH 18/32] closures: closure_nr_remaining()</a> Kent Overstreet
                   ` <a href="#rd7a0cc0ae16f7122387e4f90ff5274287512e12d">(14 subsequent siblings)</a>
  <a href="#r26517bcd26c9764cee8234a773e737b705211bb3">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-18-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-18-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Coly Li, Kent Overstreet

From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;

Like wait_event() - except, because it uses closures and closure
waitlists it doesn&#39;t have the restriction on modifying task state inside
the condition check, like wait_event() does.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
Acked-by: Coly Li &lt;colyli@suse.de&gt;
Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-18-kent.overstreet::40linux.dev:1include:linux:closure.h" href="#Z2e.:..:20230509165657.1735798-18-kent.overstreet::40linux.dev:1include:linux:closure.h">include/linux/closure.h</a> | 22 ++++++++++++++++++++++
 1 file <a href="#e26517bcd26c9764cee8234a773e737b705211bb3">changed</a>, 22 insertions(+)

<span><a href="#iZ2e.:..:20230509165657.1735798-18-kent.overstreet::40linux.dev:1include:linux:closure.h" id="Z2e.:..:20230509165657.1735798-18-kent.overstreet::40linux.dev:1include:linux:closure.h">diff</a> --git a/include/linux/closure.h b/include/linux/closure.h
index 0ec9e7bc8d..36b4a83f9b 100644
--- a/include/linux/closure.h
+++ b/include/linux/closure.h
</span><span>@@ -374,4 +374,26 @@ static inline void closure_call(struct closure *cl, closure_fn fn,
</span> 	continue_at_nobarrier(cl, fn, wq);
 }
 
<span>+#define __closure_wait_event(waitlist, _cond)				\
+do {									\
+	struct closure cl;						\
+									\
+	closure_init_stack(&amp;cl);					\
+									\
+	while (1) {							\
+		closure_wait(waitlist, &amp;cl);				\
+		if (_cond)						\
+			break;						\
+		closure_sync(&amp;cl);					\
+	}								\
+	closure_wake_up(waitlist);					\
+	closure_sync(&amp;cl);						\
+} while (0)
+
+#define closure_wait_event(waitlist, _cond)				\
+do {									\
+	if (!(_cond))							\
+		__closure_wait_event(waitlist, _cond);			\
+} while (0)
+
</span> #endif /* _LINUX_CLOSURE_H */
-- 
2.40.1


<a href="#m26517bcd26c9764cee8234a773e737b705211bb3" id="e26517bcd26c9764cee8234a773e737b705211bb3">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-18-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-18-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-18-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-18-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-18-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-18-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r26517bcd26c9764cee8234a773e737b705211bb3">73+ messages in thread</a></pre><hr/><pre><a href="#ed7a0cc0ae16f7122387e4f90ff5274287512e12d" id="md7a0cc0ae16f7122387e4f90ff5274287512e12d">*</a> <b>[PATCH 18/32] closures: closure_nr_remaining()</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#r26517bcd26c9764cee8234a773e737b705211bb3">(16 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#m26517bcd26c9764cee8234a773e737b705211bb3">[PATCH 17/32] closures: closure_wait_event()</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#m938b57c7d21ba84793e9eb47c121f5bf7dd1c9ea">[PATCH 19/32] closures: Add a missing include</a> Kent Overstreet
                   ` <a href="#r938b57c7d21ba84793e9eb47c121f5bf7dd1c9ea">(13 subsequent siblings)</a>
  <a href="#rd7a0cc0ae16f7122387e4f90ff5274287512e12d">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-19-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-19-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs; <b>+Cc:</b> Kent Overstreet

Factor out a new helper, which returns the number of events outstanding.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-19-kent.overstreet::40linux.dev:1include:linux:closure.h" href="#Z2e.:..:20230509165657.1735798-19-kent.overstreet::40linux.dev:1include:linux:closure.h">include/linux/closure.h</a> | 7 ++++++-
 1 file <a href="#ed7a0cc0ae16f7122387e4f90ff5274287512e12d">changed</a>, 6 insertions(+), 1 deletion(-)

<span><a href="#iZ2e.:..:20230509165657.1735798-19-kent.overstreet::40linux.dev:1include:linux:closure.h" id="Z2e.:..:20230509165657.1735798-19-kent.overstreet::40linux.dev:1include:linux:closure.h">diff</a> --git a/include/linux/closure.h b/include/linux/closure.h
index 36b4a83f9b..722a586bb2 100644
--- a/include/linux/closure.h
+++ b/include/linux/closure.h
</span><span>@@ -172,6 +172,11 @@ void __closure_wake_up(struct closure_waitlist *list);
</span> bool closure_wait(struct closure_waitlist *list, struct closure *cl);
 void __closure_sync(struct closure *cl);
 
<span>+static inline unsigned closure_nr_remaining(struct closure *cl)
+{
+	return atomic_read(&amp;cl-&gt;remaining) &amp; CLOSURE_REMAINING_MASK;
+}
+
</span> /**
  * closure_sync - sleep until a closure a closure has nothing left to wait on
  *
<span>@@ -180,7 +185,7 @@ void __closure_sync(struct closure *cl);
</span>  */
 static inline void closure_sync(struct closure *cl)
 {
<span>-	if ((atomic_read(&amp;cl-&gt;remaining) &amp; CLOSURE_REMAINING_MASK) != 1)
</span><span>+	if (closure_nr_remaining(cl) != 1)
</span> 		__closure_sync(cl);
 }
 
-- 
2.40.1


<a href="#md7a0cc0ae16f7122387e4f90ff5274287512e12d" id="ed7a0cc0ae16f7122387e4f90ff5274287512e12d">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-19-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-19-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-19-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-19-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-19-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-19-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#rd7a0cc0ae16f7122387e4f90ff5274287512e12d">73+ messages in thread</a></pre><hr/><pre><a href="#e938b57c7d21ba84793e9eb47c121f5bf7dd1c9ea" id="m938b57c7d21ba84793e9eb47c121f5bf7dd1c9ea">*</a> <b>[PATCH 19/32] closures: Add a missing include</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#rd7a0cc0ae16f7122387e4f90ff5274287512e12d">(17 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#md7a0cc0ae16f7122387e4f90ff5274287512e12d">[PATCH 18/32] closures: closure_nr_remaining()</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#m23d3c4393a27a0337fc775be7136fdf01bd20a64">[PATCH 20/32] vfs: factor out inode hash head calculation</a> Kent Overstreet
                   ` <a href="#r23d3c4393a27a0337fc775be7136fdf01bd20a64">(12 subsequent siblings)</a>
  <a href="#r938b57c7d21ba84793e9eb47c121f5bf7dd1c9ea">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-20-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-20-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs; <b>+Cc:</b> Kent Overstreet

Fixes building in userspace.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-20-kent.overstreet::40linux.dev:1lib:closure.c" href="#Z2e.:..:20230509165657.1735798-20-kent.overstreet::40linux.dev:1lib:closure.c">lib/closure.c</a> | 1 +
 1 file <a href="#e938b57c7d21ba84793e9eb47c121f5bf7dd1c9ea">changed</a>, 1 insertion(+)

<span><a href="#iZ2e.:..:20230509165657.1735798-20-kent.overstreet::40linux.dev:1lib:closure.c" id="Z2e.:..:20230509165657.1735798-20-kent.overstreet::40linux.dev:1lib:closure.c">diff</a> --git a/lib/closure.c b/lib/closure.c
index b38ded00b9..0855e698ce 100644
--- a/lib/closure.c
+++ b/lib/closure.c
</span><span>@@ -9,6 +9,7 @@
</span> #include &lt;linux/closure.h&gt;
 #include &lt;linux/debugfs.h&gt;
 #include &lt;linux/export.h&gt;
<span>+#include &lt;linux/rcupdate.h&gt;
</span> #include &lt;linux/seq_file.h&gt;
 #include &lt;linux/sched/debug.h&gt;
 
-- 
2.40.1


<a href="#m938b57c7d21ba84793e9eb47c121f5bf7dd1c9ea" id="e938b57c7d21ba84793e9eb47c121f5bf7dd1c9ea">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-20-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-20-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-20-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-20-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-20-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-20-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r938b57c7d21ba84793e9eb47c121f5bf7dd1c9ea">73+ messages in thread</a></pre><hr/><pre><a href="#e23d3c4393a27a0337fc775be7136fdf01bd20a64" id="m23d3c4393a27a0337fc775be7136fdf01bd20a64">*</a> <b>[PATCH 20/32] vfs: factor out inode hash head calculation</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#r938b57c7d21ba84793e9eb47c121f5bf7dd1c9ea">(18 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#m938b57c7d21ba84793e9eb47c121f5bf7dd1c9ea">[PATCH 19/32] closures: Add a missing include</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#m20c403d1bc99dafdf25c76ce50ec9c9cf8eb7e04">[PATCH 21/32] hlist-bl: add hlist_bl_fake()</a> Kent Overstreet
                   ` <a href="#r20c403d1bc99dafdf25c76ce50ec9c9cf8eb7e04">(11 subsequent siblings)</a>
  <a href="#r23d3c4393a27a0337fc775be7136fdf01bd20a64">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-21-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-21-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Dave Chinner, Alexander Viro, Christian Brauner, Kent Overstreet

From: Dave Chinner &lt;dchinner@redhat.com&gt;

In preparation for changing the inode hash table implementation.

Signed-off-by: Dave Chinner &lt;dchinner@redhat.com&gt;
Cc: Alexander Viro &lt;viro@zeniv.linux.org.uk&gt;
Cc: Christian Brauner &lt;brauner@kernel.org&gt;
Cc: linux-fsdevel@vger.kernel.org
Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-21-kent.overstreet::40linux.dev:1fs:inode.c" href="#Z2e.:..:20230509165657.1735798-21-kent.overstreet::40linux.dev:1fs:inode.c">fs/inode.c</a> | 44 +++++++++++++++++++++++++-------------------
 1 file <a href="#e23d3c4393a27a0337fc775be7136fdf01bd20a64">changed</a>, 25 insertions(+), 19 deletions(-)

<span><a href="#iZ2e.:..:20230509165657.1735798-21-kent.overstreet::40linux.dev:1fs:inode.c" id="Z2e.:..:20230509165657.1735798-21-kent.overstreet::40linux.dev:1fs:inode.c">diff</a> --git a/fs/inode.c b/fs/inode.c
index 4558dc2f13..41a10bcda1 100644
--- a/fs/inode.c
+++ b/fs/inode.c
</span><span>@@ -60,6 +60,22 @@ static unsigned int i_hash_shift __read_mostly;
</span> static struct hlist_head *inode_hashtable __read_mostly;
 static __cacheline_aligned_in_smp DEFINE_SPINLOCK(inode_hash_lock);
 
<span>+static unsigned long hash(struct super_block *sb, unsigned long hashval)
+{
+	unsigned long tmp;
+
+	tmp = (hashval * (unsigned long)sb) ^ (GOLDEN_RATIO_PRIME + hashval) /
+			L1_CACHE_BYTES;
+	tmp = tmp ^ ((tmp ^ GOLDEN_RATIO_PRIME) &gt;&gt; i_hash_shift);
+	return tmp &amp; i_hash_mask;
+}
+
+static inline struct hlist_head *i_hash_head(struct super_block *sb,
+		unsigned int hashval)
+{
+	return inode_hashtable + hash(sb, hashval);
+}
+
</span> /*
  * Empty aops. Can be used for the cases where the user does not
  * define any of the address_space operations.
<span>@@ -506,16 +522,6 @@ static inline void inode_sb_list_del(struct inode *inode)
</span> 	}
 }
 
<span>-static unsigned long hash(struct super_block *sb, unsigned long hashval)
-{
-	unsigned long tmp;
-
-	tmp = (hashval * (unsigned long)sb) ^ (GOLDEN_RATIO_PRIME + hashval) /
-			L1_CACHE_BYTES;
-	tmp = tmp ^ ((tmp ^ GOLDEN_RATIO_PRIME) &gt;&gt; i_hash_shift);
-	return tmp &amp; i_hash_mask;
-}
-
</span> /**
  *	__insert_inode_hash - hash an inode
  *	@inode: unhashed inode
<span>@@ -1163,7 +1169,7 @@ struct inode *inode_insert5(struct inode *inode, unsigned long hashval,
</span> 			    int (*test)(struct inode *, void *),
 			    int (*set)(struct inode *, void *), void *data)
 {
<span>-	struct hlist_head *head = inode_hashtable + hash(inode-&gt;i_sb, hashval);
</span><span>+	struct hlist_head *head = i_hash_head(inode-&gt;i_sb, hashval);
</span> 	struct inode *old;
 
 again:
<span>@@ -1267,7 +1273,7 @@ EXPORT_SYMBOL(iget5_locked);
</span>  */
 struct inode *iget_locked(struct super_block *sb, unsigned long ino)
 {
<span>-	struct hlist_head *head = inode_hashtable + hash(sb, ino);
</span><span>+	struct hlist_head *head = i_hash_head(sb, ino);
</span> 	struct inode *inode;
 again:
 	spin_lock(&amp;inode_hash_lock);
<span>@@ -1335,7 +1341,7 @@ EXPORT_SYMBOL(iget_locked);
</span>  */
 static int test_inode_iunique(struct super_block *sb, unsigned long ino)
 {
<span>-	struct hlist_head *b = inode_hashtable + hash(sb, ino);
</span><span>+	struct hlist_head *b = i_hash_head(sb, ino);
</span> 	struct inode *inode;
 
 	hlist_for_each_entry_rcu(inode, b, i_hash) {
<span>@@ -1422,7 +1428,7 @@ EXPORT_SYMBOL(igrab);
</span> struct inode *ilookup5_nowait(struct super_block *sb, unsigned long hashval,
 		int (*test)(struct inode *, void *), void *data)
 {
<span>-	struct hlist_head *head = inode_hashtable + hash(sb, hashval);
</span><span>+	struct hlist_head *head = i_hash_head(sb, hashval);
</span> 	struct inode *inode;
 
 	spin_lock(&amp;inode_hash_lock);
<span>@@ -1477,7 +1483,7 @@ EXPORT_SYMBOL(ilookup5);
</span>  */
 struct inode *ilookup(struct super_block *sb, unsigned long ino)
 {
<span>-	struct hlist_head *head = inode_hashtable + hash(sb, ino);
</span><span>+	struct hlist_head *head = i_hash_head(sb, ino);
</span> 	struct inode *inode;
 again:
 	spin_lock(&amp;inode_hash_lock);
<span>@@ -1526,7 +1532,7 @@ struct inode *find_inode_nowait(struct super_block *sb,
</span> 					     void *),
 				void *data)
 {
<span>-	struct hlist_head *head = inode_hashtable + hash(sb, hashval);
</span><span>+	struct hlist_head *head = i_hash_head(sb, hashval);
</span> 	struct inode *inode, *ret_inode = NULL;
 	int mval;
 
<span>@@ -1571,7 +1577,7 @@ EXPORT_SYMBOL(find_inode_nowait);
</span> struct inode *find_inode_rcu(struct super_block *sb, unsigned long hashval,
 			     int (*test)(struct inode *, void *), void *data)
 {
<span>-	struct hlist_head *head = inode_hashtable + hash(sb, hashval);
</span><span>+	struct hlist_head *head = i_hash_head(sb, hashval);
</span> 	struct inode *inode;
 
 	RCU_LOCKDEP_WARN(!rcu_read_lock_held(),
<span>@@ -1609,7 +1615,7 @@ EXPORT_SYMBOL(find_inode_rcu);
</span> struct inode *find_inode_by_ino_rcu(struct super_block *sb,
 				    unsigned long ino)
 {
<span>-	struct hlist_head *head = inode_hashtable + hash(sb, ino);
</span><span>+	struct hlist_head *head = i_hash_head(sb, ino);
</span> 	struct inode *inode;
 
 	RCU_LOCKDEP_WARN(!rcu_read_lock_held(),
<span>@@ -1629,7 +1635,7 @@ int insert_inode_locked(struct inode *inode)
</span> {
 	struct super_block *sb = inode-&gt;i_sb;
 	ino_t ino = inode-&gt;i_ino;
<span>-	struct hlist_head *head = inode_hashtable + hash(sb, ino);
</span><span>+	struct hlist_head *head = i_hash_head(sb, ino);
</span> 
 	while (1) {
 		struct inode *old = NULL;
-- 
2.40.1


<a href="#m23d3c4393a27a0337fc775be7136fdf01bd20a64" id="e23d3c4393a27a0337fc775be7136fdf01bd20a64">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-21-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-21-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-21-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-21-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-21-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-21-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r23d3c4393a27a0337fc775be7136fdf01bd20a64">73+ messages in thread</a></pre><hr/><pre><a href="#e20c403d1bc99dafdf25c76ce50ec9c9cf8eb7e04" id="m20c403d1bc99dafdf25c76ce50ec9c9cf8eb7e04">*</a> <b>[PATCH 21/32] hlist-bl: add hlist_bl_fake()</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#r23d3c4393a27a0337fc775be7136fdf01bd20a64">(19 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#m23d3c4393a27a0337fc775be7136fdf01bd20a64">[PATCH 20/32] vfs: factor out inode hash head calculation</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-10  4:48   ` <a href="#m93c547f5d42cdc1f61d75f164b8fac7ae9110e76">Dave Chinner</a>
  2023-05-09 16:56 ` <a href="#m9a45d1eb8402cf51d25f06fda723d3f9a42457f0">[PATCH 22/32] vfs: inode cache conversion to hash-bl</a> Kent Overstreet
                   ` <a href="#r9a45d1eb8402cf51d25f06fda723d3f9a42457f0">(10 subsequent siblings)</a>
  <a href="#r20c403d1bc99dafdf25c76ce50ec9c9cf8eb7e04">31 siblings, 1 reply; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-22-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-22-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs; <b>+Cc:</b> Dave Chinner, Kent Overstreet

From: Dave Chinner &lt;dchinner@redhat.com&gt;

in preparation for switching the VFS inode cache over the hlist_bl
lists, we nee dto be able to fake a list node that looks like it is
hased for correct operation of filesystems that don&#39;t directly use
the VFS indoe cache.

Signed-off-by: Dave Chinner &lt;dchinner@redhat.com&gt;
Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-22-kent.overstreet::40linux.dev:1include:linux:list_bl.h" href="#Z2e.:..:20230509165657.1735798-22-kent.overstreet::40linux.dev:1include:linux:list_bl.h">include/linux/list_bl.h</a> | 22 ++++++++++++++++++++++
 1 file <a href="#e20c403d1bc99dafdf25c76ce50ec9c9cf8eb7e04">changed</a>, 22 insertions(+)

<span><a href="#iZ2e.:..:20230509165657.1735798-22-kent.overstreet::40linux.dev:1include:linux:list_bl.h" id="Z2e.:..:20230509165657.1735798-22-kent.overstreet::40linux.dev:1include:linux:list_bl.h">diff</a> --git a/include/linux/list_bl.h b/include/linux/list_bl.h
index ae1b541446..8ee2bf5af1 100644
--- a/include/linux/list_bl.h
+++ b/include/linux/list_bl.h
</span><span>@@ -143,6 +143,28 @@ static inline void hlist_bl_del_init(struct hlist_bl_node *n)
</span> 	}
 }
 
<span>+/**
+ * hlist_bl_add_fake - create a fake list consisting of a single headless node
+ * @n: Node to make a fake list out of
+ *
+ * This makes @n appear to be its own predecessor on a headless hlist.
+ * The point of this is to allow things like hlist_bl_del() to work correctly
+ * in cases where there is no list.
+ */
+static inline void hlist_bl_add_fake(struct hlist_bl_node *n)
+{
+	n-&gt;pprev = &amp;n-&gt;next;
+}
+
+/**
+ * hlist_fake: Is this node a fake hlist_bl?
+ * @h: Node to check for being a self-referential fake hlist.
+ */
+static inline bool hlist_bl_fake(struct hlist_bl_node *n)
+{
+	return n-&gt;pprev == &amp;n-&gt;next;
+}
+
</span> static inline void hlist_bl_lock(struct hlist_bl_head *b)
 {
 	bit_spin_lock(0, (unsigned long *)b);
-- 
2.40.1


<a href="#m20c403d1bc99dafdf25c76ce50ec9c9cf8eb7e04" id="e20c403d1bc99dafdf25c76ce50ec9c9cf8eb7e04">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-22-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-22-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-22-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-22-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-22-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-22-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r20c403d1bc99dafdf25c76ce50ec9c9cf8eb7e04">73+ messages in thread</a></pre><hr/><pre><a href="#e9a45d1eb8402cf51d25f06fda723d3f9a42457f0" id="m9a45d1eb8402cf51d25f06fda723d3f9a42457f0">*</a> <b>[PATCH 22/32] vfs: inode cache conversion to hash-bl</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#r20c403d1bc99dafdf25c76ce50ec9c9cf8eb7e04">(20 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#m20c403d1bc99dafdf25c76ce50ec9c9cf8eb7e04">[PATCH 21/32] hlist-bl: add hlist_bl_fake()</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-10  4:45   ` <a href="#m5e84bf1b54b345170f06c3cef8743db555c982aa">Dave Chinner</a>
  2023-05-09 16:56 ` <a href="#mb432faef6999d4df09b333f1d1842e1989b7be4d">[PATCH 23/32] iov_iter: copy_folio_from_iter_atomic()</a> Kent Overstreet
                   ` <a href="#rb432faef6999d4df09b333f1d1842e1989b7be4d">(9 subsequent siblings)</a>
  <a href="#r9a45d1eb8402cf51d25f06fda723d3f9a42457f0">31 siblings, 1 reply; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-23-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-23-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Dave Chinner, Alexander Viro, Christian Brauner, Kent Overstreet

From: Dave Chinner &lt;dchinner@redhat.com&gt;

Because scalability of the global inode_hash_lock really, really
sucks.

32-way concurrent create on a couple of different filesystems
before:

-   52.13%     0.04%  [kernel]            [k] ext4_create
   - 52.09% ext4_create
      - 41.03% __ext4_new_inode
         - 29.92% insert_inode_locked
            - 25.35% _raw_spin_lock
               - do_raw_spin_lock
                  - 24.97% __pv_queued_spin_lock_slowpath

-   72.33%     0.02%  [kernel]            [k] do_filp_open
   - 72.31% do_filp_open
      - 72.28% path_openat
         - 57.03% bch2_create
            - 56.46% __bch2_create
               - 40.43% inode_insert5
                  - 36.07% _raw_spin_lock
                     - do_raw_spin_lock
                          35.86% __pv_queued_spin_lock_slowpath
                    4.02% find_inode

Convert the inode hash table to a RCU-aware hash-bl table just like
the dentry cache. Note that we need to store a pointer to the
hlist_bl_head the inode has been added to in the inode so that when
it comes to unhash the inode we know what list to lock. We need to
do this because the hash value that is used to hash the inode is
generated from the inode itself - filesystems can provide this
themselves so we have to either store the hash or the head pointer
in the inode to be able to find the right list head for removal...

Same workload after:

Signed-off-by: Dave Chinner &lt;dchinner@redhat.com&gt;
Cc: Alexander Viro &lt;viro@zeniv.linux.org.uk&gt;
Cc: Christian Brauner &lt;brauner@kernel.org&gt;
Cc: linux-fsdevel@vger.kernel.org
Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-23-kent.overstreet::40linux.dev:1fs:inode.c" href="#Z2e.:..:20230509165657.1735798-23-kent.overstreet::40linux.dev:1fs:inode.c">fs/inode.c</a>         | 200 ++++++++++++++++++++++++++++-----------------
 <a id="iZ2e.:..:20230509165657.1735798-23-kent.overstreet::40linux.dev:1include:linux:fs.h" href="#Z2e.:..:20230509165657.1735798-23-kent.overstreet::40linux.dev:1include:linux:fs.h">include/linux/fs.h</a> |   9 +-
 2 files <a href="#e9a45d1eb8402cf51d25f06fda723d3f9a42457f0">changed</a>, 132 insertions(+), 77 deletions(-)

<span><a href="#iZ2e.:..:20230509165657.1735798-23-kent.overstreet::40linux.dev:1fs:inode.c" id="Z2e.:..:20230509165657.1735798-23-kent.overstreet::40linux.dev:1fs:inode.c">diff</a> --git a/fs/inode.c b/fs/inode.c
index 41a10bcda1..d446b054ec 100644
--- a/fs/inode.c
+++ b/fs/inode.c
</span><span>@@ -57,8 +57,7 @@
</span> 
 static unsigned int i_hash_mask __read_mostly;
 static unsigned int i_hash_shift __read_mostly;
<span>-static struct hlist_head *inode_hashtable __read_mostly;
-static __cacheline_aligned_in_smp DEFINE_SPINLOCK(inode_hash_lock);
</span><span>+static struct hlist_bl_head *inode_hashtable __read_mostly;
</span> 
 static unsigned long hash(struct super_block *sb, unsigned long hashval)
 {
<span>@@ -70,7 +69,7 @@ static unsigned long hash(struct super_block *sb, unsigned long hashval)
</span> 	return tmp &amp; i_hash_mask;
 }
 
<span>-static inline struct hlist_head *i_hash_head(struct super_block *sb,
</span><span>+static inline struct hlist_bl_head *i_hash_head(struct super_block *sb,
</span> 		unsigned int hashval)
 {
 	return inode_hashtable + hash(sb, hashval);
<span>@@ -433,7 +432,7 @@ EXPORT_SYMBOL(address_space_init_once);
</span> void inode_init_once(struct inode *inode)
 {
 	memset(inode, 0, sizeof(*inode));
<span>-	INIT_HLIST_NODE(&amp;inode-&gt;i_hash);
</span><span>+	INIT_HLIST_BL_NODE(&amp;inode-&gt;i_hash);
</span> 	INIT_LIST_HEAD(&amp;inode-&gt;i_devices);
 	INIT_LIST_HEAD(&amp;inode-&gt;i_io_list);
 	INIT_LIST_HEAD(&amp;inode-&gt;i_wb_list);
<span>@@ -522,6 +521,17 @@ static inline void inode_sb_list_del(struct inode *inode)
</span> 	}
 }
 
<span>+/*
+ * Ensure that we store the hash head in the inode when we insert the inode into
+ * the hlist_bl_head...
+ */
+static inline void
+__insert_inode_hash_head(struct inode *inode, struct hlist_bl_head *b)
+{
+	hlist_bl_add_head_rcu(&amp;inode-&gt;i_hash, b);
+	inode-&gt;i_hash_head = b;
+}
+
</span> /**
  *	__insert_inode_hash - hash an inode
  *	@inode: unhashed inode
<span>@@ -532,13 +542,13 @@ static inline void inode_sb_list_del(struct inode *inode)
</span>  */
 void __insert_inode_hash(struct inode *inode, unsigned long hashval)
 {
<span>-	struct hlist_head *b = inode_hashtable + hash(inode-&gt;i_sb, hashval);
</span><span>+	struct hlist_bl_head *b = i_hash_head(inode-&gt;i_sb, hashval);
</span> 
<span>-	spin_lock(&amp;inode_hash_lock);
</span><span>+	hlist_bl_lock(b);
</span> 	spin_lock(&amp;inode-&gt;i_lock);
<span>-	hlist_add_head_rcu(&amp;inode-&gt;i_hash, b);
</span><span>+	__insert_inode_hash_head(inode, b);
</span> 	spin_unlock(&amp;inode-&gt;i_lock);
<span>-	spin_unlock(&amp;inode_hash_lock);
</span><span>+	hlist_bl_unlock(b);
</span> }
 EXPORT_SYMBOL(__insert_inode_hash);
 
<span>@@ -550,11 +560,44 @@ EXPORT_SYMBOL(__insert_inode_hash);
</span>  */
 void __remove_inode_hash(struct inode *inode)
 {
<span>-	spin_lock(&amp;inode_hash_lock);
-	spin_lock(&amp;inode-&gt;i_lock);
-	hlist_del_init_rcu(&amp;inode-&gt;i_hash);
-	spin_unlock(&amp;inode-&gt;i_lock);
-	spin_unlock(&amp;inode_hash_lock);
</span><span>+	struct hlist_bl_head *b = inode-&gt;i_hash_head;
+
+	/*
+	 * There are some callers that come through here without synchronisation
+	 * and potentially with multiple references to the inode. Hence we have
+	 * to handle the case that we might race with a remove and insert to a
+	 * different list. Coda, in particular, seems to have a userspace API
+	 * that can directly trigger &#34;unhash/rehash to different list&#34; behaviour
+	 * without any serialisation at all.
+	 *
+	 * Hence we have to handle the situation where the inode-&gt;i_hash_head
+	 * might point to a different list than what we expect, indicating that
+	 * we raced with another unhash and potentially a new insertion. This
+	 * means we have to retest the head once we have everything locked up
+	 * and loop again if it doesn&#39;t match.
+	 */
+	while (b) {
+		hlist_bl_lock(b);
+		spin_lock(&amp;inode-&gt;i_lock);
+		if (b != inode-&gt;i_hash_head) {
+			hlist_bl_unlock(b);
+			b = inode-&gt;i_hash_head;
+			spin_unlock(&amp;inode-&gt;i_lock);
+			continue;
+		}
+		/*
+		 * Need to set the pprev pointer to NULL after list removal so
+		 * that both RCU traversals and hlist_bl_unhashed() work
+		 * correctly at this point.
+		 */
+		hlist_bl_del_rcu(&amp;inode-&gt;i_hash);
+		inode-&gt;i_hash.pprev = NULL;
+		inode-&gt;i_hash_head = NULL;
+		spin_unlock(&amp;inode-&gt;i_lock);
+		hlist_bl_unlock(b);
+		break;
+	}
+
</span> }
 EXPORT_SYMBOL(__remove_inode_hash);
 
<span>@@ -904,26 +947,28 @@ long prune_icache_sb(struct super_block *sb, struct shrink_control *sc)
</span> 	return freed;
 }
 
<span>-static void __wait_on_freeing_inode(struct inode *inode);
</span><span>+static void __wait_on_freeing_inode(struct hlist_bl_head *b,
+				struct inode *inode);
</span> /*
  * Called with the inode lock held.
  */
 static struct inode *find_inode(struct super_block *sb,
<span>-				struct hlist_head *head,
</span><span>+				struct hlist_bl_head *b,
</span> 				int (*test)(struct inode *, void *),
 				void *data)
 {
<span>+	struct hlist_bl_node *node;
</span> 	struct inode *inode = NULL;
 
 repeat:
<span>-	hlist_for_each_entry(inode, head, i_hash) {
</span><span>+	hlist_bl_for_each_entry(inode, node, b, i_hash) {
</span> 		if (inode-&gt;i_sb != sb)
 			continue;
 		if (!test(inode, data))
 			continue;
 		spin_lock(&amp;inode-&gt;i_lock);
 		if (inode-&gt;i_state &amp; (I_FREEING|I_WILL_FREE)) {
<span>-			__wait_on_freeing_inode(inode);
</span><span>+			__wait_on_freeing_inode(b, inode);
</span> 			goto repeat;
 		}
 		if (unlikely(inode-&gt;i_state &amp; I_CREATING)) {
<span>@@ -942,19 +987,20 @@ static struct inode *find_inode(struct super_block *sb,
</span>  * iget_locked for details.
  */
 static struct inode *find_inode_fast(struct super_block *sb,
<span>-				struct hlist_head *head, unsigned long ino)
</span><span>+				struct hlist_bl_head *b, unsigned long ino)
</span> {
<span>+	struct hlist_bl_node *node;
</span> 	struct inode *inode = NULL;
 
 repeat:
<span>-	hlist_for_each_entry(inode, head, i_hash) {
</span><span>+	hlist_bl_for_each_entry(inode, node, b, i_hash) {
</span> 		if (inode-&gt;i_ino != ino)
 			continue;
 		if (inode-&gt;i_sb != sb)
 			continue;
 		spin_lock(&amp;inode-&gt;i_lock);
 		if (inode-&gt;i_state &amp; (I_FREEING|I_WILL_FREE)) {
<span>-			__wait_on_freeing_inode(inode);
</span><span>+			__wait_on_freeing_inode(b, inode);
</span> 			goto repeat;
 		}
 		if (unlikely(inode-&gt;i_state &amp; I_CREATING)) {
<span>@@ -1162,25 +1208,25 @@ EXPORT_SYMBOL(unlock_two_nondirectories);
</span>  * return it locked, hashed, and with the I_NEW flag set. The file system gets
  * to fill it in before unlocking it via unlock_new_inode().
  *
<span>- * Note both @test and @set are called with the inode_hash_lock held, so can&#39;t
- * sleep.
</span><span>+ * Note both @test and @set are called with the inode hash chain lock held,
+ * so can&#39;t sleep.
</span>  */
 struct inode *inode_insert5(struct inode *inode, unsigned long hashval,
 			    int (*test)(struct inode *, void *),
 			    int (*set)(struct inode *, void *), void *data)
 {
<span>-	struct hlist_head *head = i_hash_head(inode-&gt;i_sb, hashval);
</span><span>+	struct hlist_bl_head *b = i_hash_head(inode-&gt;i_sb, hashval);
</span> 	struct inode *old;
 
 again:
<span>-	spin_lock(&amp;inode_hash_lock);
-	old = find_inode(inode-&gt;i_sb, head, test, data);
</span><span>+	hlist_bl_lock(b);
+	old = find_inode(inode-&gt;i_sb, b, test, data);
</span> 	if (unlikely(old)) {
 		/*
 		 * Uhhuh, somebody else created the same inode under us.
 		 * Use the old inode instead of the preallocated one.
 		 */
<span>-		spin_unlock(&amp;inode_hash_lock);
</span><span>+		hlist_bl_unlock(b);
</span> 		if (IS_ERR(old))
 			return NULL;
 		wait_on_inode(old);
<span>@@ -1202,7 +1248,7 @@ struct inode *inode_insert5(struct inode *inode, unsigned long hashval,
</span> 	 */
 	spin_lock(&amp;inode-&gt;i_lock);
 	inode-&gt;i_state |= I_NEW;
<span>-	hlist_add_head_rcu(&amp;inode-&gt;i_hash, head);
</span><span>+	__insert_inode_hash_head(inode, b);
</span> 	spin_unlock(&amp;inode-&gt;i_lock);
 
 	/*
<span>@@ -1212,7 +1258,7 @@ struct inode *inode_insert5(struct inode *inode, unsigned long hashval,
</span> 	if (list_empty(&amp;inode-&gt;i_sb_list))
 		inode_sb_list_add(inode);
 unlock:
<span>-	spin_unlock(&amp;inode_hash_lock);
</span><span>+	hlist_bl_unlock(b);
</span> 
 	return inode;
 }
<span>@@ -1273,12 +1319,12 @@ EXPORT_SYMBOL(iget5_locked);
</span>  */
 struct inode *iget_locked(struct super_block *sb, unsigned long ino)
 {
<span>-	struct hlist_head *head = i_hash_head(sb, ino);
</span><span>+	struct hlist_bl_head *b = i_hash_head(sb, ino);
</span> 	struct inode *inode;
 again:
<span>-	spin_lock(&amp;inode_hash_lock);
-	inode = find_inode_fast(sb, head, ino);
-	spin_unlock(&amp;inode_hash_lock);
</span><span>+	hlist_bl_lock(b);
+	inode = find_inode_fast(sb, b, ino);
+	hlist_bl_unlock(b);
</span> 	if (inode) {
 		if (IS_ERR(inode))
 			return NULL;
<span>@@ -1294,17 +1340,17 @@ struct inode *iget_locked(struct super_block *sb, unsigned long ino)
</span> 	if (inode) {
 		struct inode *old;
 
<span>-		spin_lock(&amp;inode_hash_lock);
</span><span>+		hlist_bl_lock(b);
</span> 		/* We released the lock, so.. */
<span>-		old = find_inode_fast(sb, head, ino);
</span><span>+		old = find_inode_fast(sb, b, ino);
</span> 		if (!old) {
 			inode-&gt;i_ino = ino;
 			spin_lock(&amp;inode-&gt;i_lock);
 			inode-&gt;i_state = I_NEW;
<span>-			hlist_add_head_rcu(&amp;inode-&gt;i_hash, head);
</span><span>+			__insert_inode_hash_head(inode, b);
</span> 			spin_unlock(&amp;inode-&gt;i_lock);
 			inode_sb_list_add(inode);
<span>-			spin_unlock(&amp;inode_hash_lock);
</span><span>+			hlist_bl_unlock(b);
</span> 
 			/* Return the locked inode with I_NEW set, the
 			 * caller is responsible for filling in the contents
<span>@@ -1317,7 +1363,7 @@ struct inode *iget_locked(struct super_block *sb, unsigned long ino)
</span> 		 * us. Use the old inode instead of the one we just
 		 * allocated.
 		 */
<span>-		spin_unlock(&amp;inode_hash_lock);
</span><span>+		hlist_bl_unlock(b);
</span> 		destroy_inode(inode);
 		if (IS_ERR(old))
 			return NULL;
<span>@@ -1341,10 +1387,11 @@ EXPORT_SYMBOL(iget_locked);
</span>  */
 static int test_inode_iunique(struct super_block *sb, unsigned long ino)
 {
<span>-	struct hlist_head *b = i_hash_head(sb, ino);
</span><span>+	struct hlist_bl_head *b = i_hash_head(sb, ino);
+	struct hlist_bl_node *node;
</span> 	struct inode *inode;
 
<span>-	hlist_for_each_entry_rcu(inode, b, i_hash) {
</span><span>+	hlist_bl_for_each_entry_rcu(inode, node, b, i_hash) {
</span> 		if (inode-&gt;i_ino == ino &amp;&amp; inode-&gt;i_sb == sb)
 			return 0;
 	}
<span>@@ -1428,12 +1475,12 @@ EXPORT_SYMBOL(igrab);
</span> struct inode *ilookup5_nowait(struct super_block *sb, unsigned long hashval,
 		int (*test)(struct inode *, void *), void *data)
 {
<span>-	struct hlist_head *head = i_hash_head(sb, hashval);
</span><span>+	struct hlist_bl_head *b = i_hash_head(sb, hashval);
</span> 	struct inode *inode;
 
<span>-	spin_lock(&amp;inode_hash_lock);
-	inode = find_inode(sb, head, test, data);
-	spin_unlock(&amp;inode_hash_lock);
</span><span>+	hlist_bl_lock(b);
+	inode = find_inode(sb, b, test, data);
+	hlist_bl_unlock(b);
</span> 
 	return IS_ERR(inode) ? NULL : inode;
 }
<span>@@ -1483,12 +1530,12 @@ EXPORT_SYMBOL(ilookup5);
</span>  */
 struct inode *ilookup(struct super_block *sb, unsigned long ino)
 {
<span>-	struct hlist_head *head = i_hash_head(sb, ino);
</span><span>+	struct hlist_bl_head *b = i_hash_head(sb, ino);
</span> 	struct inode *inode;
 again:
<span>-	spin_lock(&amp;inode_hash_lock);
-	inode = find_inode_fast(sb, head, ino);
-	spin_unlock(&amp;inode_hash_lock);
</span><span>+	hlist_bl_lock(b);
+	inode = find_inode_fast(sb, b, ino);
+	hlist_bl_unlock(b);
</span> 
 	if (inode) {
 		if (IS_ERR(inode))
<span>@@ -1532,12 +1579,13 @@ struct inode *find_inode_nowait(struct super_block *sb,
</span> 					     void *),
 				void *data)
 {
<span>-	struct hlist_head *head = i_hash_head(sb, hashval);
</span><span>+	struct hlist_bl_head *b = i_hash_head(sb, hashval);
+	struct hlist_bl_node *node;
</span> 	struct inode *inode, *ret_inode = NULL;
 	int mval;
 
<span>-	spin_lock(&amp;inode_hash_lock);
-	hlist_for_each_entry(inode, head, i_hash) {
</span><span>+	hlist_bl_lock(b);
+	hlist_bl_for_each_entry(inode, node, b, i_hash) {
</span> 		if (inode-&gt;i_sb != sb)
 			continue;
 		mval = match(inode, hashval, data);
<span>@@ -1548,7 +1596,7 @@ struct inode *find_inode_nowait(struct super_block *sb,
</span> 		goto out;
 	}
 out:
<span>-	spin_unlock(&amp;inode_hash_lock);
</span><span>+	hlist_bl_unlock(b);
</span> 	return ret_inode;
 }
 EXPORT_SYMBOL(find_inode_nowait);
<span>@@ -1577,13 +1625,14 @@ EXPORT_SYMBOL(find_inode_nowait);
</span> struct inode *find_inode_rcu(struct super_block *sb, unsigned long hashval,
 			     int (*test)(struct inode *, void *), void *data)
 {
<span>-	struct hlist_head *head = i_hash_head(sb, hashval);
</span><span>+	struct hlist_bl_head *b = i_hash_head(sb, hashval);
+	struct hlist_bl_node *node;
</span> 	struct inode *inode;
 
 	RCU_LOCKDEP_WARN(!rcu_read_lock_held(),
 			 &#34;suspicious find_inode_rcu() usage&#34;);
 
<span>-	hlist_for_each_entry_rcu(inode, head, i_hash) {
</span><span>+	hlist_bl_for_each_entry_rcu(inode, node, b, i_hash) {
</span> 		if (inode-&gt;i_sb == sb &amp;&amp;
 		    !(READ_ONCE(inode-&gt;i_state) &amp; (I_FREEING | I_WILL_FREE)) &amp;&amp;
 		    test(inode, data))
<span>@@ -1615,13 +1664,14 @@ EXPORT_SYMBOL(find_inode_rcu);
</span> struct inode *find_inode_by_ino_rcu(struct super_block *sb,
 				    unsigned long ino)
 {
<span>-	struct hlist_head *head = i_hash_head(sb, ino);
</span><span>+	struct hlist_bl_head *b = i_hash_head(sb, ino);
+	struct hlist_bl_node *node;
</span> 	struct inode *inode;
 
 	RCU_LOCKDEP_WARN(!rcu_read_lock_held(),
 			 &#34;suspicious find_inode_by_ino_rcu() usage&#34;);
 
<span>-	hlist_for_each_entry_rcu(inode, head, i_hash) {
</span><span>+	hlist_bl_for_each_entry_rcu(inode, node, b, i_hash) {
</span> 		if (inode-&gt;i_ino == ino &amp;&amp;
 		    inode-&gt;i_sb == sb &amp;&amp;
 		    !(READ_ONCE(inode-&gt;i_state) &amp; (I_FREEING | I_WILL_FREE)))
<span>@@ -1635,39 +1685,42 @@ int insert_inode_locked(struct inode *inode)
</span> {
 	struct super_block *sb = inode-&gt;i_sb;
 	ino_t ino = inode-&gt;i_ino;
<span>-	struct hlist_head *head = i_hash_head(sb, ino);
</span><span>+	struct hlist_bl_head *b = i_hash_head(sb, ino);
</span> 
 	while (1) {
<span>-		struct inode *old = NULL;
-		spin_lock(&amp;inode_hash_lock);
-		hlist_for_each_entry(old, head, i_hash) {
-			if (old-&gt;i_ino != ino)
</span><span>+		struct hlist_bl_node *node;
+		struct inode *old = NULL, *t;
+
+		hlist_bl_lock(b);
+		hlist_bl_for_each_entry(t, node, b, i_hash) {
+			if (t-&gt;i_ino != ino)
</span> 				continue;
<span>-			if (old-&gt;i_sb != sb)
</span><span>+			if (t-&gt;i_sb != sb)
</span> 				continue;
<span>-			spin_lock(&amp;old-&gt;i_lock);
-			if (old-&gt;i_state &amp; (I_FREEING|I_WILL_FREE)) {
-				spin_unlock(&amp;old-&gt;i_lock);
</span><span>+			spin_lock(&amp;t-&gt;i_lock);
+			if (t-&gt;i_state &amp; (I_FREEING|I_WILL_FREE)) {
+				spin_unlock(&amp;t-&gt;i_lock);
</span> 				continue;
 			}
<span>+			old = t;
</span> 			break;
 		}
 		if (likely(!old)) {
 			spin_lock(&amp;inode-&gt;i_lock);
 			inode-&gt;i_state |= I_NEW | I_CREATING;
<span>-			hlist_add_head_rcu(&amp;inode-&gt;i_hash, head);
</span><span>+			__insert_inode_hash_head(inode, b);
</span> 			spin_unlock(&amp;inode-&gt;i_lock);
<span>-			spin_unlock(&amp;inode_hash_lock);
</span><span>+			hlist_bl_unlock(b);
</span> 			return 0;
 		}
 		if (unlikely(old-&gt;i_state &amp; I_CREATING)) {
 			spin_unlock(&amp;old-&gt;i_lock);
<span>-			spin_unlock(&amp;inode_hash_lock);
</span><span>+			hlist_bl_unlock(b);
</span> 			return -EBUSY;
 		}
 		__iget(old);
 		spin_unlock(&amp;old-&gt;i_lock);
<span>-		spin_unlock(&amp;inode_hash_lock);
</span><span>+		hlist_bl_unlock(b);
</span> 		wait_on_inode(old);
 		if (unlikely(!inode_unhashed(old))) {
 			iput(old);
<span>@@ -2192,17 +2245,18 @@ EXPORT_SYMBOL(inode_needs_sync);
</span>  * wake_up_bit(&amp;inode-&gt;i_state, __I_NEW) after removing from the hash list
  * will DTRT.
  */
<span>-static void __wait_on_freeing_inode(struct inode *inode)
</span><span>+static void __wait_on_freeing_inode(struct hlist_bl_head *b,
+				struct inode *inode)
</span> {
 	wait_queue_head_t *wq;
 	DEFINE_WAIT_BIT(wait, &amp;inode-&gt;i_state, __I_NEW);
 	wq = bit_waitqueue(&amp;inode-&gt;i_state, __I_NEW);
 	prepare_to_wait(wq, &amp;wait.wq_entry, TASK_UNINTERRUPTIBLE);
 	spin_unlock(&amp;inode-&gt;i_lock);
<span>-	spin_unlock(&amp;inode_hash_lock);
</span><span>+	hlist_bl_unlock(b);
</span> 	schedule();
 	finish_wait(wq, &amp;wait.wq_entry);
<span>-	spin_lock(&amp;inode_hash_lock);
</span><span>+	hlist_bl_lock(b);
</span> }
 
 static __initdata unsigned long ihash_entries;
<span>@@ -2228,7 +2282,7 @@ void __init inode_init_early(void)
</span> 
 	inode_hashtable =
 		alloc_large_system_hash(&#34;Inode-cache&#34;,
<span>-					sizeof(struct hlist_head),
</span><span>+					sizeof(struct hlist_bl_head),
</span> 					ihash_entries,
 					14,
 					HASH_EARLY | HASH_ZERO,
<span>@@ -2254,7 +2308,7 @@ void __init inode_init(void)
</span> 
 	inode_hashtable =
 		alloc_large_system_hash(&#34;Inode-cache&#34;,
<span>-					sizeof(struct hlist_head),
</span><span>+					sizeof(struct hlist_bl_head),
</span> 					ihash_entries,
 					14,
 					HASH_ZERO,
<span><a href="#iZ2e.:..:20230509165657.1735798-23-kent.overstreet::40linux.dev:1include:linux:fs.h" id="Z2e.:..:20230509165657.1735798-23-kent.overstreet::40linux.dev:1include:linux:fs.h">diff</a> --git a/include/linux/fs.h b/include/linux/fs.h
index 1a6f951942..db8d49cbf7 100644
--- a/include/linux/fs.h
+++ b/include/linux/fs.h
</span><span>@@ -647,7 +647,8 @@ struct inode {
</span> 	unsigned long		dirtied_when;	/* jiffies of first dirtying */
 	unsigned long		dirtied_time_when;
 
<span>-	struct hlist_node	i_hash;
</span><span>+	struct hlist_bl_node	i_hash;
+	struct hlist_bl_head	*i_hash_head;
</span> 	struct list_head	i_io_list;	/* backing dev IO list */
 #ifdef CONFIG_CGROUP_WRITEBACK
 	struct bdi_writeback	*i_wb;		/* the associated cgroup wb */
<span>@@ -713,7 +714,7 @@ static inline unsigned int i_blocksize(const struct inode *node)
</span> 
 static inline int inode_unhashed(struct inode *inode)
 {
<span>-	return hlist_unhashed(&amp;inode-&gt;i_hash);
</span><span>+	return hlist_bl_unhashed(&amp;inode-&gt;i_hash);
</span> }
 
 /*
<span>@@ -724,7 +725,7 @@ static inline int inode_unhashed(struct inode *inode)
</span>  */
 static inline void inode_fake_hash(struct inode *inode)
 {
<span>-	hlist_add_fake(&amp;inode-&gt;i_hash);
</span><span>+	hlist_bl_add_fake(&amp;inode-&gt;i_hash);
</span> }
 
 /*
<span>@@ -2695,7 +2696,7 @@ static inline void insert_inode_hash(struct inode *inode)
</span> extern void __remove_inode_hash(struct inode *);
 static inline void remove_inode_hash(struct inode *inode)
 {
<span>-	if (!inode_unhashed(inode) &amp;&amp; !hlist_fake(&amp;inode-&gt;i_hash))
</span><span>+	if (!inode_unhashed(inode) &amp;&amp; !hlist_bl_fake(&amp;inode-&gt;i_hash))
</span> 		__remove_inode_hash(inode);
 }
 
-- 
2.40.1


<a href="#m9a45d1eb8402cf51d25f06fda723d3f9a42457f0" id="e9a45d1eb8402cf51d25f06fda723d3f9a42457f0">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-23-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-23-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-23-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-23-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-23-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-23-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r9a45d1eb8402cf51d25f06fda723d3f9a42457f0">73+ messages in thread</a></pre><hr/><pre><a href="#eb432faef6999d4df09b333f1d1842e1989b7be4d" id="mb432faef6999d4df09b333f1d1842e1989b7be4d">*</a> <b>[PATCH 23/32] iov_iter: copy_folio_from_iter_atomic()</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#r9a45d1eb8402cf51d25f06fda723d3f9a42457f0">(21 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#m9a45d1eb8402cf51d25f06fda723d3f9a42457f0">[PATCH 22/32] vfs: inode cache conversion to hash-bl</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-10  2:20   ` <a href="#m5828ea4e5b889cfc135329e431ec2be9179194ba">kernel test robot</a>
  2023-05-11  2:08   ` <a href="#m2be1ce6189d96241cbd4b322f136ff0da35e00ad">kernel test robot</a>
  2023-05-09 16:56 ` <a href="#md351e32f2d22a702c7790ac75cdff4ff5bb75be0">[PATCH 24/32] MAINTAINERS: Add entry for generic-radix-tree</a> Kent Overstreet
                   ` <a href="#rd351e32f2d22a702c7790ac75cdff4ff5bb75be0">(8 subsequent siblings)</a>
  <a href="#rb432faef6999d4df09b333f1d1842e1989b7be4d">31 siblings, 2 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-24-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-24-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Alexander Viro, Matthew Wilcox

Add a foliated version of copy_page_from_iter_atomic()

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
Cc: Alexander Viro &lt;viro@zeniv.linux.org.uk&gt;
Cc: Matthew Wilcox &lt;willy@infradead.org&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-24-kent.overstreet::40linux.dev:1include:linux:uio.h" href="#Z2e.:..:20230509165657.1735798-24-kent.overstreet::40linux.dev:1include:linux:uio.h">include/linux/uio.h</a> |  2 ++
 <a id="iZ2e.:..:20230509165657.1735798-24-kent.overstreet::40linux.dev:1lib:iov_iter.c" href="#Z2e.:..:20230509165657.1735798-24-kent.overstreet::40linux.dev:1lib:iov_iter.c">lib/iov_iter.c</a>      | 53 ++++++++++++++++++++++++++++++++++++---------
 2 files <a href="#eb432faef6999d4df09b333f1d1842e1989b7be4d">changed</a>, 45 insertions(+), 10 deletions(-)

<span><a href="#iZ2e.:..:20230509165657.1735798-24-kent.overstreet::40linux.dev:1include:linux:uio.h" id="Z2e.:..:20230509165657.1735798-24-kent.overstreet::40linux.dev:1include:linux:uio.h">diff</a> --git a/include/linux/uio.h b/include/linux/uio.h
index 27e3fd9429..b2c281cb10 100644
--- a/include/linux/uio.h
+++ b/include/linux/uio.h
</span><span>@@ -154,6 +154,8 @@ static inline struct iovec iov_iter_iovec(const struct iov_iter *iter)
</span> 
 size_t copy_page_from_iter_atomic(struct page *page, unsigned offset,
 				  size_t bytes, struct iov_iter *i);
<span>+size_t copy_folio_from_iter_atomic(struct folio *folio, size_t offset,
+				   size_t bytes, struct iov_iter *i);
</span> void iov_iter_advance(struct iov_iter *i, size_t bytes);
 void iov_iter_revert(struct iov_iter *i, size_t bytes);
 size_t fault_in_iov_iter_readable(const struct iov_iter *i, size_t bytes);
<span><a href="#iZ2e.:..:20230509165657.1735798-24-kent.overstreet::40linux.dev:1lib:iov_iter.c" id="Z2e.:..:20230509165657.1735798-24-kent.overstreet::40linux.dev:1lib:iov_iter.c">diff</a> --git a/lib/iov_iter.c b/lib/iov_iter.c
index 274014e4ea..27ba7e9f9e 100644
--- a/lib/iov_iter.c
+++ b/lib/iov_iter.c
</span><span>@@ -800,18 +800,10 @@ size_t iov_iter_zero(size_t bytes, struct iov_iter *i)
</span> }
 EXPORT_SYMBOL(iov_iter_zero);
 
<span>-size_t copy_page_from_iter_atomic(struct page *page, unsigned offset, size_t bytes,
-				  struct iov_iter *i)
</span><span>+static inline size_t __copy_page_from_iter_atomic(struct page *page, unsigned offset,
+						  size_t bytes, struct iov_iter *i)
</span> {
 	char *kaddr = kmap_atomic(page), *p = kaddr + offset;
<span>-	if (!page_copy_sane(page, offset, bytes)) {
-		kunmap_atomic(kaddr);
-		return 0;
-	}
-	if (WARN_ON_ONCE(!i-&gt;data_source)) {
-		kunmap_atomic(kaddr);
-		return 0;
-	}
</span> 	iterate_and_advance(i, bytes, base, len, off,
 		copyin(p + off, base, len),
 		memcpy(p + off, base, len)
<span>@@ -819,8 +811,49 @@ size_t copy_page_from_iter_atomic(struct page *page, unsigned offset, size_t byt
</span> 	kunmap_atomic(kaddr);
 	return bytes;
 }
<span>+
+size_t copy_page_from_iter_atomic(struct page *page, unsigned offset, size_t bytes,
+				  struct iov_iter *i)
+{
+	if (!page_copy_sane(page, offset, bytes))
+		return 0;
+	if (WARN_ON_ONCE(!i-&gt;data_source))
+		return 0;
+	return __copy_page_from_iter_atomic(page, offset, bytes, i);
+}
</span> EXPORT_SYMBOL(copy_page_from_iter_atomic);
 
<span>+size_t copy_folio_from_iter_atomic(struct folio *folio, size_t offset,
+				   size_t bytes, struct iov_iter *i)
+{
+	size_t ret = 0;
+
+	if (WARN_ON(offset + bytes &gt; folio_size(folio)))
+		return 0;
+	if (WARN_ON_ONCE(!i-&gt;data_source))
+		return 0;
+
+#ifdef CONFIG_HIGHMEM
+	while (bytes) {
+		struct page *page = folio_page(folio, offset &gt;&gt; PAGE_SHIFT);
+		unsigned b = min(bytes, PAGE_SIZE - (offset &amp; PAGE_MASK));
+		unsigned r = __copy_page_from_iter_atomic(page, offset, b, i);
+
+		offset	+= r;
+		bytes	-= r;
+		ret	+= r;
+
+		if (r != b)
+			break;
+	}
+#else
+	ret = __copy_page_from_iter_atomic(&amp;folio-&gt;page, offset, bytes, i);
+#endif
+
+	return ret;
+}
+EXPORT_SYMBOL(copy_folio_from_iter_atomic);
+
</span> static void pipe_advance(struct iov_iter *i, size_t size)
 {
 	struct pipe_inode_info *pipe = i-&gt;pipe;
-- 
2.40.1


<a href="#mb432faef6999d4df09b333f1d1842e1989b7be4d" id="eb432faef6999d4df09b333f1d1842e1989b7be4d">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-24-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-24-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-24-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-24-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-24-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-24-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#rb432faef6999d4df09b333f1d1842e1989b7be4d">73+ messages in thread</a></pre><hr/><pre><a href="#ed351e32f2d22a702c7790ac75cdff4ff5bb75be0" id="md351e32f2d22a702c7790ac75cdff4ff5bb75be0">*</a> <b>[PATCH 24/32] MAINTAINERS: Add entry for generic-radix-tree</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#rb432faef6999d4df09b333f1d1842e1989b7be4d">(22 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#mb432faef6999d4df09b333f1d1842e1989b7be4d">[PATCH 23/32] iov_iter: copy_folio_from_iter_atomic()</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 21:03   ` <a href="#mbe2af624344228cc4957a1fab50b261b52fb408a">Randy Dunlap</a>
  2023-05-09 16:56 ` <a href="#mf14a5bed7c254335976abe8dc95464076df5d2a8">[PATCH 25/32] lib/generic-radix-tree.c: Don&#39;t overflow in peek()</a> Kent Overstreet
                   ` <a href="#rf14a5bed7c254335976abe8dc95464076df5d2a8">(7 subsequent siblings)</a>
  <a href="#rd351e32f2d22a702c7790ac75cdff4ff5bb75be0">31 siblings, 1 reply; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-25-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-25-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs; <b>+Cc:</b> Kent Overstreet

lib/generic-radix-tree.c is a simple radix tree that supports storing
arbitrary types. Add a maintainers entry for it.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-25-kent.overstreet::40linux.dev:1MAINTAINERS" href="#Z2e.:..:20230509165657.1735798-25-kent.overstreet::40linux.dev:1MAINTAINERS">MAINTAINERS</a> | 7 +++++++
 1 file <a href="#ed351e32f2d22a702c7790ac75cdff4ff5bb75be0">changed</a>, 7 insertions(+)

<span><a href="#iZ2e.:..:20230509165657.1735798-25-kent.overstreet::40linux.dev:1MAINTAINERS" id="Z2e.:..:20230509165657.1735798-25-kent.overstreet::40linux.dev:1MAINTAINERS">diff</a> --git a/MAINTAINERS b/MAINTAINERS
index 5d76169140..c550f5909e 100644
--- a/MAINTAINERS
+++ b/MAINTAINERS
</span><span>@@ -8615,6 +8615,13 @@ F:	Documentation/devicetree/bindings/power/power?domain*
</span> F:	drivers/base/power/domain*.c
 F:	include/linux/pm_domain.h
 
<span>+GENERIC RADIX TREE:
+M:	Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
+S:	Supported
+C:	irc://irc.oftc.net/bcache
+F:	include/linux/generic-radix-tree.h
+F:	lib/generic-radix-tree.c
+
</span> GENERIC RESISTIVE TOUCHSCREEN ADC DRIVER
 M:	Eugen Hristev &lt;eugen.hristev@microchip.com&gt;
 L:	linux-input@vger.kernel.org
-- 
2.40.1


<a href="#md351e32f2d22a702c7790ac75cdff4ff5bb75be0" id="ed351e32f2d22a702c7790ac75cdff4ff5bb75be0">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-25-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-25-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-25-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-25-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-25-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-25-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#rd351e32f2d22a702c7790ac75cdff4ff5bb75be0">73+ messages in thread</a></pre><hr/><pre><a href="#ef14a5bed7c254335976abe8dc95464076df5d2a8" id="mf14a5bed7c254335976abe8dc95464076df5d2a8">*</a> <b>[PATCH 25/32] lib/generic-radix-tree.c: Don&#39;t overflow in peek()</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#rd351e32f2d22a702c7790ac75cdff4ff5bb75be0">(23 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#md351e32f2d22a702c7790ac75cdff4ff5bb75be0">[PATCH 24/32] MAINTAINERS: Add entry for generic-radix-tree</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#m2263dc10e0138c8c3ef6d8030dae2cb8716cf3a6">[PATCH 26/32] lib/generic-radix-tree.c: Add a missing include</a> Kent Overstreet
                   ` <a href="#r2263dc10e0138c8c3ef6d8030dae2cb8716cf3a6">(6 subsequent siblings)</a>
  <a href="#rf14a5bed7c254335976abe8dc95464076df5d2a8">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-26-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-26-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Kent Overstreet

From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;

When we started spreading new inode numbers throughout most of the 64
bit inode space, that triggered some corner case bugs, in particular
some integer overflows related to the radix tree code. Oops.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-26-kent.overstreet::40linux.dev:1include:linux:generic-radix-tree.h" href="#Z2e.:..:20230509165657.1735798-26-kent.overstreet::40linux.dev:1include:linux:generic-radix-tree.h">include/linux/generic-radix-tree.h</a> |  6 ++++++
 <a id="iZ2e.:..:20230509165657.1735798-26-kent.overstreet::40linux.dev:1lib:generic-radix-tree.c" href="#Z2e.:..:20230509165657.1735798-26-kent.overstreet::40linux.dev:1lib:generic-radix-tree.c">lib/generic-radix-tree.c</a>           | 17 ++++++++++++++---
 2 files <a href="#ef14a5bed7c254335976abe8dc95464076df5d2a8">changed</a>, 20 insertions(+), 3 deletions(-)

<span><a href="#iZ2e.:..:20230509165657.1735798-26-kent.overstreet::40linux.dev:1include:linux:generic-radix-tree.h" id="Z2e.:..:20230509165657.1735798-26-kent.overstreet::40linux.dev:1include:linux:generic-radix-tree.h">diff</a> --git a/include/linux/generic-radix-tree.h b/include/linux/generic-radix-tree.h
index 107613f7d7..63080822dc 100644
--- a/include/linux/generic-radix-tree.h
+++ b/include/linux/generic-radix-tree.h
</span><span>@@ -184,6 +184,12 @@ void *__genradix_iter_peek(struct genradix_iter *, struct __genradix *, size_t);
</span> static inline void __genradix_iter_advance(struct genradix_iter *iter,
 					   size_t obj_size)
 {
<span>+	if (iter-&gt;offset + obj_size &lt; iter-&gt;offset) {
+		iter-&gt;offset	= SIZE_MAX;
+		iter-&gt;pos	= SIZE_MAX;
+		return;
+	}
+
</span> 	iter-&gt;offset += obj_size;
 
 	if (!is_power_of_2(obj_size) &amp;&amp;
<span><a href="#iZ2e.:..:20230509165657.1735798-26-kent.overstreet::40linux.dev:1lib:generic-radix-tree.c" id="Z2e.:..:20230509165657.1735798-26-kent.overstreet::40linux.dev:1lib:generic-radix-tree.c">diff</a> --git a/lib/generic-radix-tree.c b/lib/generic-radix-tree.c
index f25eb111c0..7dfa88282b 100644
--- a/lib/generic-radix-tree.c
+++ b/lib/generic-radix-tree.c
</span><span>@@ -166,6 +166,10 @@ void *__genradix_iter_peek(struct genradix_iter *iter,
</span> 	struct genradix_root *r;
 	struct genradix_node *n;
 	unsigned level, i;
<span>+
+	if (iter-&gt;offset == SIZE_MAX)
+		return NULL;
+
</span> restart:
 	r = READ_ONCE(radix-&gt;root);
 	if (!r)
<span>@@ -184,10 +188,17 @@ void *__genradix_iter_peek(struct genradix_iter *iter,
</span> 			(GENRADIX_ARY - 1);
 
 		while (!n-&gt;children[i]) {
<span>+			size_t objs_per_ptr = genradix_depth_size(level);
+
+			if (iter-&gt;offset + objs_per_ptr &lt; iter-&gt;offset) {
+				iter-&gt;offset	= SIZE_MAX;
+				iter-&gt;pos	= SIZE_MAX;
+				return NULL;
+			}
+
</span> 			i++;
<span>-			iter-&gt;offset = round_down(iter-&gt;offset +
-					   genradix_depth_size(level),
-					   genradix_depth_size(level));
</span><span>+			iter-&gt;offset = round_down(iter-&gt;offset + objs_per_ptr,
+						  objs_per_ptr);
</span> 			iter-&gt;pos = (iter-&gt;offset &gt;&gt; PAGE_SHIFT) *
 				objs_per_page;
 			if (i == GENRADIX_ARY)
-- 
2.40.1


<a href="#mf14a5bed7c254335976abe8dc95464076df5d2a8" id="ef14a5bed7c254335976abe8dc95464076df5d2a8">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-26-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-26-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-26-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-26-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-26-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-26-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#rf14a5bed7c254335976abe8dc95464076df5d2a8">73+ messages in thread</a></pre><hr/><pre><a href="#e2263dc10e0138c8c3ef6d8030dae2cb8716cf3a6" id="m2263dc10e0138c8c3ef6d8030dae2cb8716cf3a6">*</a> <b>[PATCH 26/32] lib/generic-radix-tree.c: Add a missing include</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#rf14a5bed7c254335976abe8dc95464076df5d2a8">(24 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#mf14a5bed7c254335976abe8dc95464076df5d2a8">[PATCH 25/32] lib/generic-radix-tree.c: Don&#39;t overflow in peek()</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#m00d67d9cabe02fc86e9073ada90a91501b11267e">[PATCH 27/32] lib/generic-radix-tree.c: Add peek_prev()</a> Kent Overstreet
                   ` <a href="#r00d67d9cabe02fc86e9073ada90a91501b11267e">(5 subsequent siblings)</a>
  <a href="#r2263dc10e0138c8c3ef6d8030dae2cb8716cf3a6">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-27-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-27-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Kent Overstreet

From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;

We now need linux/limits.h for SIZE_MAX.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-27-kent.overstreet::40linux.dev:1include:linux:generic-radix-tree.h" href="#Z2e.:..:20230509165657.1735798-27-kent.overstreet::40linux.dev:1include:linux:generic-radix-tree.h">include/linux/generic-radix-tree.h</a> | 1 +
 1 file <a href="#e2263dc10e0138c8c3ef6d8030dae2cb8716cf3a6">changed</a>, 1 insertion(+)

<span><a href="#iZ2e.:..:20230509165657.1735798-27-kent.overstreet::40linux.dev:1include:linux:generic-radix-tree.h" id="Z2e.:..:20230509165657.1735798-27-kent.overstreet::40linux.dev:1include:linux:generic-radix-tree.h">diff</a> --git a/include/linux/generic-radix-tree.h b/include/linux/generic-radix-tree.h
index 63080822dc..f6cd0f909d 100644
--- a/include/linux/generic-radix-tree.h
+++ b/include/linux/generic-radix-tree.h
</span><span>@@ -38,6 +38,7 @@
</span> 
 #include &lt;asm/page.h&gt;
 #include &lt;linux/bug.h&gt;
<span>+#include &lt;linux/limits.h&gt;
</span> #include &lt;linux/log2.h&gt;
 #include &lt;linux/math.h&gt;
 #include &lt;linux/types.h&gt;
-- 
2.40.1


<a href="#m2263dc10e0138c8c3ef6d8030dae2cb8716cf3a6" id="e2263dc10e0138c8c3ef6d8030dae2cb8716cf3a6">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-27-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-27-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-27-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-27-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-27-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-27-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r2263dc10e0138c8c3ef6d8030dae2cb8716cf3a6">73+ messages in thread</a></pre><hr/><pre><a href="#e00d67d9cabe02fc86e9073ada90a91501b11267e" id="m00d67d9cabe02fc86e9073ada90a91501b11267e">*</a> <b>[PATCH 27/32] lib/generic-radix-tree.c: Add peek_prev()</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#r2263dc10e0138c8c3ef6d8030dae2cb8716cf3a6">(25 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#m2263dc10e0138c8c3ef6d8030dae2cb8716cf3a6">[PATCH 26/32] lib/generic-radix-tree.c: Add a missing include</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#mf522e4c439373af3164ac7333e4a2d8960904f15">[PATCH 28/32] stacktrace: Export stack_trace_save_tsk</a> Kent Overstreet
                   ` <a href="#rf522e4c439373af3164ac7333e4a2d8960904f15">(4 subsequent siblings)</a>
  <a href="#r00d67d9cabe02fc86e9073ada90a91501b11267e">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-28-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-28-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Kent Overstreet

From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;

This patch adds genradix_peek_prev(), genradix_iter_rewind(), and
genradix_for_each_reverse(), for iterating backwards over a generic
radix tree.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-28-kent.overstreet::40linux.dev:1include:linux:generic-radix-tree.h" href="#Z2e.:..:20230509165657.1735798-28-kent.overstreet::40linux.dev:1include:linux:generic-radix-tree.h">include/linux/generic-radix-tree.h</a> | 61 +++++++++++++++++++++++++++++-
 <a id="iZ2e.:..:20230509165657.1735798-28-kent.overstreet::40linux.dev:1lib:generic-radix-tree.c" href="#Z2e.:..:20230509165657.1735798-28-kent.overstreet::40linux.dev:1lib:generic-radix-tree.c">lib/generic-radix-tree.c</a>           | 59 +++++++++++++++++++++++++++++
 2 files <a href="#e00d67d9cabe02fc86e9073ada90a91501b11267e">changed</a>, 119 insertions(+), 1 deletion(-)

<span><a href="#iZ2e.:..:20230509165657.1735798-28-kent.overstreet::40linux.dev:1include:linux:generic-radix-tree.h" id="Z2e.:..:20230509165657.1735798-28-kent.overstreet::40linux.dev:1include:linux:generic-radix-tree.h">diff</a> --git a/include/linux/generic-radix-tree.h b/include/linux/generic-radix-tree.h
index f6cd0f909d..c74b737699 100644
--- a/include/linux/generic-radix-tree.h
+++ b/include/linux/generic-radix-tree.h
</span><span>@@ -117,6 +117,11 @@ static inline size_t __idx_to_offset(size_t idx, size_t obj_size)
</span> 
 #define __genradix_cast(_radix)		(typeof((_radix)-&gt;type[0]) *)
 #define __genradix_obj_size(_radix)	sizeof((_radix)-&gt;type[0])
<span>+#define __genradix_objs_per_page(_radix)			\
+	(PAGE_SIZE / sizeof((_radix)-&gt;type[0]))
+#define __genradix_page_remainder(_radix)			\
+	(PAGE_SIZE % sizeof((_radix)-&gt;type[0]))
+
</span> #define __genradix_idx_to_offset(_radix, _idx)			\
 	__idx_to_offset(_idx, __genradix_obj_size(_radix))
 
<span>@@ -180,7 +185,25 @@ void *__genradix_iter_peek(struct genradix_iter *, struct __genradix *, size_t);
</span> #define genradix_iter_peek(_iter, _radix)			\
 	(__genradix_cast(_radix)				\
 	 __genradix_iter_peek(_iter, &amp;(_radix)-&gt;tree,		\
<span>-			      PAGE_SIZE / __genradix_obj_size(_radix)))
</span><span>+			__genradix_objs_per_page(_radix)))
+
+void *__genradix_iter_peek_prev(struct genradix_iter *, struct __genradix *,
+				size_t, size_t);
+
+/**
+ * genradix_iter_peek - get first entry at or below iterator&#39;s current
+ *			position
+ * @_iter:	a genradix_iter
+ * @_radix:	genradix being iterated over
+ *
+ * If no more entries exist at or below @_iter&#39;s current position, returns NULL
+ */
+#define genradix_iter_peek_prev(_iter, _radix)			\
+	(__genradix_cast(_radix)				\
+	 __genradix_iter_peek_prev(_iter, &amp;(_radix)-&gt;tree,	\
+			__genradix_objs_per_page(_radix),	\
+			__genradix_obj_size(_radix) +		\
+			__genradix_page_remainder(_radix)))
</span> 
 static inline void __genradix_iter_advance(struct genradix_iter *iter,
 					   size_t obj_size)
<span>@@ -203,6 +226,25 @@ static inline void __genradix_iter_advance(struct genradix_iter *iter,
</span> #define genradix_iter_advance(_iter, _radix)			\
 	__genradix_iter_advance(_iter, __genradix_obj_size(_radix))
 
<span>+static inline void __genradix_iter_rewind(struct genradix_iter *iter,
+					  size_t obj_size)
+{
+	if (iter-&gt;offset == 0 ||
+	    iter-&gt;offset == SIZE_MAX) {
+		iter-&gt;offset = SIZE_MAX;
+		return;
+	}
+
+	if ((iter-&gt;offset &amp; (PAGE_SIZE - 1)) == 0)
+		iter-&gt;offset -= PAGE_SIZE % obj_size;
+
+	iter-&gt;offset -= obj_size;
+	iter-&gt;pos--;
+}
+
+#define genradix_iter_rewind(_iter, _radix)			\
+	__genradix_iter_rewind(_iter, __genradix_obj_size(_radix))
+
</span> #define genradix_for_each_from(_radix, _iter, _p, _start)	\
 	for (_iter = genradix_iter_init(_radix, _start);	\
 	     (_p = genradix_iter_peek(&amp;_iter, _radix)) != NULL;	\
<span>@@ -220,6 +262,23 @@ static inline void __genradix_iter_advance(struct genradix_iter *iter,
</span> #define genradix_for_each(_radix, _iter, _p)			\
 	genradix_for_each_from(_radix, _iter, _p, 0)
 
<span>+#define genradix_last_pos(_radix)				\
+	(SIZE_MAX / PAGE_SIZE * __genradix_objs_per_page(_radix) - 1)
+
+/**
+ * genradix_for_each_reverse - iterate over entry in a genradix, reverse order
+ * @_radix:	genradix to iterate over
+ * @_iter:	a genradix_iter to track current position
+ * @_p:		pointer to genradix entry type
+ *
+ * On every iteration, @_p will point to the current entry, and @_iter.pos
+ * will be the current entry&#39;s index.
+ */
+#define genradix_for_each_reverse(_radix, _iter, _p)		\
+	for (_iter = genradix_iter_init(_radix,	genradix_last_pos(_radix));\
+	     (_p = genradix_iter_peek_prev(&amp;_iter, _radix)) != NULL;\
+	     genradix_iter_rewind(&amp;_iter, _radix))
+
</span> int __genradix_prealloc(struct __genradix *, size_t, gfp_t);
 
 /**
<span><a href="#iZ2e.:..:20230509165657.1735798-28-kent.overstreet::40linux.dev:1lib:generic-radix-tree.c" id="Z2e.:..:20230509165657.1735798-28-kent.overstreet::40linux.dev:1lib:generic-radix-tree.c">diff</a> --git a/lib/generic-radix-tree.c b/lib/generic-radix-tree.c
index 7dfa88282b..41f1bcdc44 100644
--- a/lib/generic-radix-tree.c
+++ b/lib/generic-radix-tree.c
</span><span>@@ -1,4 +1,5 @@
</span> 
<span>+#include &lt;linux/atomic.h&gt;
</span> #include &lt;linux/export.h&gt;
 #include &lt;linux/generic-radix-tree.h&gt;
 #include &lt;linux/gfp.h&gt;
<span>@@ -212,6 +213,64 @@ void *__genradix_iter_peek(struct genradix_iter *iter,
</span> }
 EXPORT_SYMBOL(__genradix_iter_peek);
 
<span>+void *__genradix_iter_peek_prev(struct genradix_iter *iter,
+				struct __genradix *radix,
+				size_t objs_per_page,
+				size_t obj_size_plus_page_remainder)
+{
+	struct genradix_root *r;
+	struct genradix_node *n;
+	unsigned level, i;
+
+	if (iter-&gt;offset == SIZE_MAX)
+		return NULL;
+
+restart:
+	r = READ_ONCE(radix-&gt;root);
+	if (!r)
+		return NULL;
+
+	n	= genradix_root_to_node(r);
+	level	= genradix_root_to_depth(r);
+
+	if (ilog2(iter-&gt;offset) &gt;= genradix_depth_shift(level)) {
+		iter-&gt;offset = genradix_depth_size(level);
+		iter-&gt;pos = (iter-&gt;offset &gt;&gt; PAGE_SHIFT) * objs_per_page;
+
+		iter-&gt;offset -= obj_size_plus_page_remainder;
+		iter-&gt;pos--;
+	}
+
+	while (level) {
+		level--;
+
+		i = (iter-&gt;offset &gt;&gt; genradix_depth_shift(level)) &amp;
+			(GENRADIX_ARY - 1);
+
+		while (!n-&gt;children[i]) {
+			size_t objs_per_ptr = genradix_depth_size(level);
+
+			iter-&gt;offset = round_down(iter-&gt;offset, objs_per_ptr);
+			iter-&gt;pos = (iter-&gt;offset &gt;&gt; PAGE_SHIFT) * objs_per_page;
+
+			if (!iter-&gt;offset)
+				return NULL;
+
+			iter-&gt;offset -= obj_size_plus_page_remainder;
+			iter-&gt;pos--;
+
+			if (!i)
+				goto restart;
+			--i;
+		}
+
+		n = n-&gt;children[i];
+	}
+
+	return &amp;n-&gt;data[iter-&gt;offset &amp; (PAGE_SIZE - 1)];
+}
+EXPORT_SYMBOL(__genradix_iter_peek_prev);
+
</span> static void genradix_free_recurse(struct genradix_node *n, unsigned level)
 {
 	if (level) {
-- 
2.40.1


<a href="#m00d67d9cabe02fc86e9073ada90a91501b11267e" id="e00d67d9cabe02fc86e9073ada90a91501b11267e">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-28-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-28-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-28-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-28-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-28-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-28-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r00d67d9cabe02fc86e9073ada90a91501b11267e">73+ messages in thread</a></pre><hr/><pre><a href="#ef522e4c439373af3164ac7333e4a2d8960904f15" id="mf522e4c439373af3164ac7333e4a2d8960904f15">*</a> <b>[PATCH 28/32] stacktrace: Export stack_trace_save_tsk</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#r00d67d9cabe02fc86e9073ada90a91501b11267e">(26 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#m00d67d9cabe02fc86e9073ada90a91501b11267e">[PATCH 27/32] lib/generic-radix-tree.c: Add peek_prev()</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#md9f53a37fa6f09af1330005af56d57b88b7bc668">[PATCH 29/32] lib/string_helpers: string_get_size() now returns characters wrote</a> Kent Overstreet
                   ` <a href="#rd9f53a37fa6f09af1330005af56d57b88b7bc668">(3 subsequent siblings)</a>
  <a href="#rf522e4c439373af3164ac7333e4a2d8960904f15">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-29-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-29-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Christopher James Halse Rogers, Kent Overstreet

From: Christopher James Halse Rogers &lt;raof@ubuntu.com&gt;

The bcachefs module wants it, and there doesn&#39;t seem to be any
reason it shouldn&#39;t be exported like the other functions.

Signed-off-by: Christopher James Halse Rogers &lt;raof@ubuntu.com&gt;
Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-29-kent.overstreet::40linux.dev:1kernel:stacktrace.c" href="#Z2e.:..:20230509165657.1735798-29-kent.overstreet::40linux.dev:1kernel:stacktrace.c">kernel/stacktrace.c</a> | 2 ++
 1 file <a href="#ef522e4c439373af3164ac7333e4a2d8960904f15">changed</a>, 2 insertions(+)

<span><a href="#iZ2e.:..:20230509165657.1735798-29-kent.overstreet::40linux.dev:1kernel:stacktrace.c" id="Z2e.:..:20230509165657.1735798-29-kent.overstreet::40linux.dev:1kernel:stacktrace.c">diff</a> --git a/kernel/stacktrace.c b/kernel/stacktrace.c
index 9ed5ce9894..4f65824879 100644
--- a/kernel/stacktrace.c
+++ b/kernel/stacktrace.c
</span><span>@@ -151,6 +151,7 @@ unsigned int stack_trace_save_tsk(struct task_struct *tsk, unsigned long *store,
</span> 	put_task_stack(tsk);
 	return c.len;
 }
<span>+EXPORT_SYMBOL_GPL(stack_trace_save_tsk);
</span> 
 /**
  * stack_trace_save_regs - Save a stack trace based on pt_regs into a storage array
<span>@@ -301,6 +302,7 @@ unsigned int stack_trace_save_tsk(struct task_struct *task,
</span> 	save_stack_trace_tsk(task, &amp;trace);
 	return trace.nr_entries;
 }
<span>+EXPORT_SYMBOL_GPL(stack_trace_save_tsk);
</span> 
 /**
  * stack_trace_save_regs - Save a stack trace based on pt_regs into a storage array
-- 
2.40.1


<a href="#mf522e4c439373af3164ac7333e4a2d8960904f15" id="ef522e4c439373af3164ac7333e4a2d8960904f15">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-29-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-29-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-29-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-29-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-29-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-29-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#rf522e4c439373af3164ac7333e4a2d8960904f15">73+ messages in thread</a></pre><hr/><pre><a href="#ed9f53a37fa6f09af1330005af56d57b88b7bc668" id="md9f53a37fa6f09af1330005af56d57b88b7bc668">*</a> <b>[PATCH 29/32] lib/string_helpers: string_get_size() now returns characters wrote</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#rf522e4c439373af3164ac7333e4a2d8960904f15">(27 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#mf522e4c439373af3164ac7333e4a2d8960904f15">[PATCH 28/32] stacktrace: Export stack_trace_save_tsk</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#ma3574e520d51015d372e8411eaad6e0688b31158">[PATCH 30/32] lib: Export errname</a> Kent Overstreet
                   ` <a href="#ra3574e520d51015d372e8411eaad6e0688b31158">(2 subsequent siblings)</a>
  <a href="#rd9f53a37fa6f09af1330005af56d57b88b7bc668">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-30-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-30-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Kent Overstreet

From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;

printbuf now needs to know the number of characters that would have been
written if the buffer was too small, like snprintf(); this changes
string_get_size() to return the the return value of snprintf().

Signed-off-by: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-30-kent.overstreet::40linux.dev:1include:linux:string_helpers.h" href="#Z2e.:..:20230509165657.1735798-30-kent.overstreet::40linux.dev:1include:linux:string_helpers.h">include/linux/string_helpers.h</a> | 4 ++--
 <a id="iZ2e.:..:20230509165657.1735798-30-kent.overstreet::40linux.dev:1lib:string_helpers.c" href="#Z2e.:..:20230509165657.1735798-30-kent.overstreet::40linux.dev:1lib:string_helpers.c">lib/string_helpers.c</a>           | 8 ++++----
 2 files <a href="#ed9f53a37fa6f09af1330005af56d57b88b7bc668">changed</a>, 6 insertions(+), 6 deletions(-)

<span><a href="#iZ2e.:..:20230509165657.1735798-30-kent.overstreet::40linux.dev:1include:linux:string_helpers.h" id="Z2e.:..:20230509165657.1735798-30-kent.overstreet::40linux.dev:1include:linux:string_helpers.h">diff</a> --git a/include/linux/string_helpers.h b/include/linux/string_helpers.h
index fae6beaaa2..44148f8feb 100644
--- a/include/linux/string_helpers.h
+++ b/include/linux/string_helpers.h
</span><span>@@ -23,8 +23,8 @@ enum string_size_units {
</span> 	STRING_UNITS_2,		/* use binary powers of 2^10 */
 };
 
<span>-void string_get_size(u64 size, u64 blk_size, enum string_size_units units,
-		     char *buf, int len);
</span><span>+int string_get_size(u64 size, u64 blk_size, enum string_size_units units,
+		    char *buf, int len);
</span> 
 int parse_int_array_user(const char __user *from, size_t count, int **array);
 
<span><a href="#iZ2e.:..:20230509165657.1735798-30-kent.overstreet::40linux.dev:1lib:string_helpers.c" id="Z2e.:..:20230509165657.1735798-30-kent.overstreet::40linux.dev:1lib:string_helpers.c">diff</a> --git a/lib/string_helpers.c b/lib/string_helpers.c
index 230020a2e0..ca36ceba0e 100644
--- a/lib/string_helpers.c
+++ b/lib/string_helpers.c
</span><span>@@ -32,8 +32,8 @@
</span>  * at least 9 bytes and will always be zero terminated.
  *
  */
<span>-void string_get_size(u64 size, u64 blk_size, const enum string_size_units units,
-		     char *buf, int len)
</span><span>+int string_get_size(u64 size, u64 blk_size, const enum string_size_units units,
+		    char *buf, int len)
</span> {
 	static const char *const units_10[] = {
 		&#34;B&#34;, &#34;kB&#34;, &#34;MB&#34;, &#34;GB&#34;, &#34;TB&#34;, &#34;PB&#34;, &#34;EB&#34;, &#34;ZB&#34;, &#34;YB&#34;
<span>@@ -126,8 +126,8 @@ void string_get_size(u64 size, u64 blk_size, const enum string_size_units units,
</span> 	else
 		unit = units_str[units][i];
 
<span>-	snprintf(buf, len, &#34;%u%s %s&#34;, (u32)size,
-		 tmp, unit);
</span><span>+	return snprintf(buf, len, &#34;%u%s %s&#34;, (u32)size,
+			tmp, unit);
</span> }
 EXPORT_SYMBOL(string_get_size);
 
-- 
2.40.1


<a href="#md9f53a37fa6f09af1330005af56d57b88b7bc668" id="ed9f53a37fa6f09af1330005af56d57b88b7bc668">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-30-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-30-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-30-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-30-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-30-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-30-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#rd9f53a37fa6f09af1330005af56d57b88b7bc668">73+ messages in thread</a></pre><hr/><pre><a href="#ea3574e520d51015d372e8411eaad6e0688b31158" id="ma3574e520d51015d372e8411eaad6e0688b31158">*</a> <b>[PATCH 30/32] lib: Export errname</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#rd9f53a37fa6f09af1330005af56d57b88b7bc668">(28 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#md9f53a37fa6f09af1330005af56d57b88b7bc668">[PATCH 29/32] lib/string_helpers: string_get_size() now returns characters wrote</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#m86c8777e4dadc4d7c0a6fa4ecc59f7c9315dff8c">[PATCH 31/32] lib: add mean and variance module</a> Kent Overstreet
  2023-05-09 16:56 ` <a href="#m1452c4f62de7e7806f01f4afe55d78271a434b81">[PATCH 32/32] MAINTAINERS: Add entry for bcachefs</a> Kent Overstreet
  <a href="#ra3574e520d51015d372e8411eaad6e0688b31158">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-31-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-31-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Christopher James Halse Rogers

The bcachefs module now wants this and it seems sensible.

Signed-off-by: Christopher James Halse Rogers &lt;raof@ubuntu.com&gt;
Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-31-kent.overstreet::40linux.dev:1lib:errname.c" href="#Z2e.:..:20230509165657.1735798-31-kent.overstreet::40linux.dev:1lib:errname.c">lib/errname.c</a> | 1 +
 1 file <a href="#ea3574e520d51015d372e8411eaad6e0688b31158">changed</a>, 1 insertion(+)

<span><a href="#iZ2e.:..:20230509165657.1735798-31-kent.overstreet::40linux.dev:1lib:errname.c" id="Z2e.:..:20230509165657.1735798-31-kent.overstreet::40linux.dev:1lib:errname.c">diff</a> --git a/lib/errname.c b/lib/errname.c
index 67739b174a..dd1b998552 100644
--- a/lib/errname.c
+++ b/lib/errname.c
</span><span>@@ -228,3 +228,4 @@ const char *errname(int err)
</span> 
 	return err &gt; 0 ? name + 1 : name;
 }
<span>+EXPORT_SYMBOL(errname);
</span>-- 
2.40.1


<a href="#ma3574e520d51015d372e8411eaad6e0688b31158" id="ea3574e520d51015d372e8411eaad6e0688b31158">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-31-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-31-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-31-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-31-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-31-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-31-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#ra3574e520d51015d372e8411eaad6e0688b31158">73+ messages in thread</a></pre><hr/><pre><a href="#e86c8777e4dadc4d7c0a6fa4ecc59f7c9315dff8c" id="m86c8777e4dadc4d7c0a6fa4ecc59f7c9315dff8c">*</a> <b>[PATCH 31/32] lib: add mean and variance module.</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#ra3574e520d51015d372e8411eaad6e0688b31158">(29 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#ma3574e520d51015d372e8411eaad6e0688b31158">[PATCH 30/32] lib: Export errname</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 16:56 ` <a href="#m1452c4f62de7e7806f01f4afe55d78271a434b81">[PATCH 32/32] MAINTAINERS: Add entry for bcachefs</a> Kent Overstreet
  <a href="#r86c8777e4dadc4d7c0a6fa4ecc59f7c9315dff8c">31 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-32-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-32-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs; <b>+Cc:</b> Daniel Hill, Kent Overstreet

From: Daniel Hill &lt;daniel@gluo.nz&gt;

This module provides a fast 64bit implementation of basic statistics
functions, including mean, variance and standard deviation in both
weighted and unweighted variants, the unweighted variant has a 32bit
limitation per sample to prevent overflow when squaring.

Signed-off-by: Daniel Hill &lt;daniel@gluo.nz&gt;
Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1MAINTAINERS" href="#Z2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1MAINTAINERS">MAINTAINERS</a>                       |   9 ++
 <a id="iZ2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1include:linux:mean_and_variance.h" href="#Z2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1include:linux:mean_and_variance.h">include/linux/mean_and_variance.h</a> | 219 ++++++++++++++++++++++++++++++
 <a id="iZ2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:Kconfig.debug" href="#Z2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:Kconfig.debug">lib/Kconfig.debug</a>                 |   9 ++
 <a id="iZ2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:math:Kconfig" href="#Z2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:math:Kconfig">lib/math/Kconfig</a>                  |   3 +
 <a id="iZ2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:math:Makefile" href="#Z2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:math:Makefile">lib/math/Makefile</a>                 |   2 +
 <a id="iZ2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:math:mean_and_variance.c" href="#Z2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:math:mean_and_variance.c">lib/math/mean_and_variance.c</a>      | 136 +++++++++++++++++++
 <a id="iZ2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:math:mean_and_variance_test.c" href="#Z2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:math:mean_and_variance_test.c">lib/math/mean_and_variance_test.c</a> | 155 +++++++++++++++++++++
 7 files <a href="#e86c8777e4dadc4d7c0a6fa4ecc59f7c9315dff8c">changed</a>, 533 insertions(+)
 create mode 100644 include/linux/mean_and_variance.h
 create mode 100644 lib/math/mean_and_variance.c
 create mode 100644 lib/math/mean_and_variance_test.c

<span><a href="#iZ2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1MAINTAINERS" id="Z2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1MAINTAINERS">diff</a> --git a/MAINTAINERS b/MAINTAINERS
index c550f5909e..dbf3c33c31 100644
--- a/MAINTAINERS
+++ b/MAINTAINERS
</span><span>@@ -12767,6 +12767,15 @@ F:	Documentation/devicetree/bindings/net/ieee802154/mcr20a.txt
</span> F:	drivers/net/ieee802154/mcr20a.c
 F:	drivers/net/ieee802154/mcr20a.h
 
<span>+MEAN AND VARIANCE LIBRARY
+M:	Daniel B. Hill &lt;daniel@gluo.nz&gt;
+M:	Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
+S:	Maintained
+T:	git <a href="https://github.com/YellowOnion/linux/">https://github.com/YellowOnion/linux/</a>
+F:	include/linux/mean_and_variance.h
+F:	lib/math/mean_and_variance.c
+F:	lib/math/mean_and_variance_test.c
+
</span> MEASUREMENT COMPUTING CIO-DAC IIO DRIVER
 M:	William Breathitt Gray &lt;william.gray@linaro.org&gt;
 L:	linux-iio@vger.kernel.org
<span><a href="#iZ2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1include:linux:mean_and_variance.h" id="Z2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1include:linux:mean_and_variance.h">diff</a> --git a/include/linux/mean_and_variance.h b/include/linux/mean_and_variance.h
new file mode 100644
index 0000000000..89540628e8
--- /dev/null
+++ b/include/linux/mean_and_variance.h
</span><span>@@ -0,0 +1,219 @@
</span><span>+/* SPDX-License-Identifier: GPL-2.0 */
+#ifndef MEAN_AND_VARIANCE_H_
+#define MEAN_AND_VARIANCE_H_
+
+#include &lt;linux/types.h&gt;
+#include &lt;linux/limits.h&gt;
+#include &lt;linux/math64.h&gt;
+
+#define SQRT_U64_MAX 4294967295ULL
+
+
+#if defined(CONFIG_ARCH_SUPPORTS_INT128) &amp;&amp; defined(__SIZEOF_INT128__)
+
+typedef unsigned __int128 u128;
+
+static inline u128 u64_to_u128(u64 a)
+{
+	return (u128)a;
+}
+
+static inline u64 u128_to_u64(u128 a)
+{
+	return (u64)a;
+}
+
+static inline u64 u128_shr64_to_u64(u128 a)
+{
+	return (u64)(a &gt;&gt; 64);
+}
+
+static inline u128 u128_add(u128 a, u128 b)
+{
+	return a + b;
+}
+
+static inline u128 u128_sub(u128 a, u128 b)
+{
+	return a - b;
+}
+
+static inline u128 u128_shl(u128 i, s8 shift)
+{
+	return i &lt;&lt; shift;
+}
+
+static inline u128 u128_shl64_add(u64 a, u64 b)
+{
+	return ((u128)a &lt;&lt; 64) + b;
+}
+
+static inline u128 u128_square(u64 i)
+{
+	return i*i;
+}
+
+#else
+
+typedef struct {
+	u64 hi, lo;
+} u128;
+
+static inline u128 u64_to_u128(u64 a)
+{
+	return (u128){ .lo = a };
+}
+
+static inline u64 u128_to_u64(u128 a)
+{
+	return a.lo;
+}
+
+static inline u64 u128_shr64_to_u64(u128 a)
+{
+	return a.hi;
+}
+
+static inline u128 u128_add(u128 a, u128 b)
+{
+	u128 c;
+
+	c.lo = a.lo + b.lo;
+	c.hi = a.hi + b.hi + (c.lo &lt; a.lo);
+	return c;
+}
+
+static inline u128 u128_sub(u128 a, u128 b)
+{
+	u128 c;
+
+	c.lo = a.lo - b.lo;
+	c.hi = a.hi - b.hi - (c.lo &gt; a.lo);
+	return c;
+}
+
+static inline u128 u128_shl(u128 i, s8 shift)
+{
+	u128 r;
+
+	r.lo = i.lo &lt;&lt; shift;
+	if (shift &lt; 64)
+		r.hi = (i.hi &lt;&lt; shift) | (i.lo &gt;&gt; (64 - shift));
+	else {
+		r.hi = i.lo &lt;&lt; (shift - 64);
+		r.lo = 0;
+	}
+	return r;
+}
+
+static inline u128 u128_shl64_add(u64 a, u64 b)
+{
+	return u128_add(u128_shl(u64_to_u128(a), 64), u64_to_u128(b));
+}
+
+static inline u128 u128_square(u64 i)
+{
+	u128 r;
+	u64  h = i &gt;&gt; 32, l = i &amp; (u64)U32_MAX;
+
+	r =             u128_shl(u64_to_u128(h*h), 64);
+	r = u128_add(r, u128_shl(u64_to_u128(h*l), 32));
+	r = u128_add(r, u128_shl(u64_to_u128(l*h), 32));
+	r = u128_add(r,          u64_to_u128(l*l));
+	return r;
+}
+
+#endif
+
+static inline u128 u128_div(u128 n, u64 d)
+{
+	u128 r;
+	u64 rem;
+	u64 hi = u128_shr64_to_u64(n);
+	u64 lo = u128_to_u64(n);
+	u64  h =  hi &amp; ((u64)U32_MAX  &lt;&lt; 32);
+	u64  l = (hi &amp;  (u64)U32_MAX) &lt;&lt; 32;
+
+	r =             u128_shl(u64_to_u128(div64_u64_rem(h,                d, &amp;rem)), 64);
+	r = u128_add(r, u128_shl(u64_to_u128(div64_u64_rem(l  + (rem &lt;&lt; 32), d, &amp;rem)), 32));
+	r = u128_add(r,          u64_to_u128(div64_u64_rem(lo + (rem &lt;&lt; 32), d, &amp;rem)));
+	return r;
+}
+
+struct mean_and_variance {
+	s64 n;
+	s64 sum;
+	u128 sum_squares;
+};
+
+/* expontentially weighted variant */
+struct mean_and_variance_weighted {
+	bool init;
+	u8 w;
+	s64 mean;
+	u64 variance;
+};
+
+/**
+ * fast_divpow2() - fast approximation for n / (1 &lt;&lt; d)
+ * @n: numerator
+ * @d: the power of 2 denominator.
+ *
+ * note: this rounds towards 0.
+ */
+static inline s64 fast_divpow2(s64 n, u8 d)
+{
+	return (n + ((n &lt; 0) ? ((1 &lt;&lt; d) - 1) : 0)) &gt;&gt; d;
+}
+
+static inline struct mean_and_variance
+mean_and_variance_update_inlined(struct mean_and_variance s1, s64 v1)
+{
+	struct mean_and_variance s2;
+	u64 v2 = abs(v1);
+
+	s2.n           = s1.n + 1;
+	s2.sum         = s1.sum + v1;
+	s2.sum_squares = u128_add(s1.sum_squares, u128_square(v2));
+	return s2;
+}
+
+static inline struct mean_and_variance_weighted
+mean_and_variance_weighted_update_inlined(struct mean_and_variance_weighted s1, s64 x)
+{
+	struct mean_and_variance_weighted s2;
+	// previous weighted variance.
+	u64 var_w0 = s1.variance;
+	u8 w = s2.w = s1.w;
+	// new value weighted.
+	s64 x_w = x &lt;&lt; w;
+	s64 diff_w = x_w - s1.mean;
+	s64 diff = fast_divpow2(diff_w, w);
+	// new mean weighted.
+	s64 u_w1     = s1.mean + diff;
+
+	BUG_ON(w % 2 != 0);
+
+	if (!s1.init) {
+		s2.mean = x_w;
+		s2.variance = 0;
+	} else {
+		s2.mean = u_w1;
+		s2.variance = ((var_w0 &lt;&lt; w) - var_w0 + ((diff_w * (x_w - u_w1)) &gt;&gt; w)) &gt;&gt; w;
+	}
+	s2.init = true;
+
+	return s2;
+}
+
+struct mean_and_variance mean_and_variance_update(struct mean_and_variance s1, s64 v1);
+       s64		 mean_and_variance_get_mean(struct mean_and_variance s);
+       u64		 mean_and_variance_get_variance(struct mean_and_variance s1);
+       u32		 mean_and_variance_get_stddev(struct mean_and_variance s);
+
+struct mean_and_variance_weighted mean_and_variance_weighted_update(struct mean_and_variance_weighted s1, s64 v1);
+       s64			  mean_and_variance_weighted_get_mean(struct mean_and_variance_weighted s);
+       u64			  mean_and_variance_weighted_get_variance(struct mean_and_variance_weighted s);
+       u32			  mean_and_variance_weighted_get_stddev(struct mean_and_variance_weighted s);
+
+#endif // MEAN_AND_VAIRANCE_H_
</span><span><a href="#iZ2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:Kconfig.debug" id="Z2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:Kconfig.debug">diff</a> --git a/lib/Kconfig.debug b/lib/Kconfig.debug
index 3dba7a9aff..9ca88e0027 100644
--- a/lib/Kconfig.debug
+++ b/lib/Kconfig.debug
</span><span>@@ -2101,6 +2101,15 @@ config CPUMASK_KUNIT_TEST
</span> 
 	  If unsure, say N.
 
<span>+config MEAN_AND_VARIANCE_UNIT_TEST
+	tristate &#34;mean_and_variance unit tests&#34; if !KUNIT_ALL_TESTS
+	depends on KUNIT
+	select MEAN_AND_VARIANCE
+	default KUNIT_ALL_TESTS
+	help
+	  This option enables the kunit tests for mean_and_variance module.
+	  If unsure, say N.
+
</span> config TEST_LIST_SORT
 	tristate &#34;Linked list sorting test&#34; if !KUNIT_ALL_TESTS
 	depends on KUNIT
<span><a href="#iZ2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:math:Kconfig" id="Z2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:math:Kconfig">diff</a> --git a/lib/math/Kconfig b/lib/math/Kconfig
index 0634b428d0..7530ae9a35 100644
--- a/lib/math/Kconfig
+++ b/lib/math/Kconfig
</span><span>@@ -15,3 +15,6 @@ config PRIME_NUMBERS
</span> 
 config RATIONAL
 	tristate
<span>+
+config MEAN_AND_VARIANCE
+	tristate
</span><span><a href="#iZ2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:math:Makefile" id="Z2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:math:Makefile">diff</a> --git a/lib/math/Makefile b/lib/math/Makefile
index bfac26ddfc..2ef1487e01 100644
--- a/lib/math/Makefile
+++ b/lib/math/Makefile
</span><span>@@ -4,6 +4,8 @@ obj-y += div64.o gcd.o lcm.o int_pow.o int_sqrt.o reciprocal_div.o
</span> obj-$(CONFIG_CORDIC)		+= cordic.o
 obj-$(CONFIG_PRIME_NUMBERS)	+= prime_numbers.o
 obj-$(CONFIG_RATIONAL)		+= rational.o
<span>+obj-$(CONFIG_MEAN_AND_VARIANCE) += mean_and_variance.o
</span> 
 obj-$(CONFIG_TEST_DIV64)	+= test_div64.o
 obj-$(CONFIG_RATIONAL_KUNIT_TEST) += rational-test.o
<span>+obj-$(CONFIG_MEAN_AND_VARIANCE_UNIT_TEST)   += mean_and_variance_test.o
</span><span><a href="#iZ2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:math:mean_and_variance.c" id="Z2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:math:mean_and_variance.c">diff</a> --git a/lib/math/mean_and_variance.c b/lib/math/mean_and_variance.c
new file mode 100644
index 0000000000..6e315d3a13
--- /dev/null
+++ b/lib/math/mean_and_variance.c
</span><span>@@ -0,0 +1,136 @@
</span><span>+// SPDX-License-Identifier: GPL-2.0
+/*
+ * Functions for incremental mean and variance.
+ *
+ * This program is free software; you can redistribute it and/or modify it
+ * under the terms of the GNU General Public License version 2 as published by
+ * the Free Software Foundation.
+ *
+ * This program is distributed in the hope that it will be useful, but WITHOUT
+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
+ * more details.
+ *
+ * Copyright © 2022 Daniel B. Hill
+ *
+ * Author: Daniel B. Hill &lt;daniel@gluo.nz&gt;
+ *
+ * Description:
+ *
+ * This is includes some incremental algorithms for mean and variance calculation
+ *
+ * Derived from the paper: <a href="https://fanf2.user.srcf.net/hermes/doc/antiforgery/stats.pdf">https://fanf2.user.srcf.net/hermes/doc/antiforgery/stats.pdf</a>
+ *
+ * Create a struct and if it&#39;s the weighted variant set the w field (weight = 2^k).
+ *
+ * Use mean_and_variance[_weighted]_update() on the struct to update it&#39;s state.
+ *
+ * Use the mean_and_variance[_weighted]_get_* functions to calculate the mean and variance, some computation
+ * is deferred to these functions for performance reasons.
+ *
+ * see lib/math/mean_and_variance_test.c for examples of usage.
+ *
+ * DO NOT access the mean and variance fields of the weighted variants directly.
+ * DO NOT change the weight after calling update.
+ */
+
+#include &lt;linux/bug.h&gt;
+#include &lt;linux/compiler.h&gt;
+#include &lt;linux/export.h&gt;
+#include &lt;linux/limits.h&gt;
+#include &lt;linux/math.h&gt;
+#include &lt;linux/math64.h&gt;
+#include &lt;linux/mean_and_variance.h&gt;
+#include &lt;linux/module.h&gt;
+
+/**
+ * mean_and_variance_update() - update a mean_and_variance struct @s1 with a new sample @v1
+ * and return it.
+ * @s1: the mean_and_variance to update.
+ * @v1: the new sample.
+ *
+ * see linked pdf equation 12.
+ */
+struct mean_and_variance mean_and_variance_update(struct mean_and_variance s1, s64 v1)
+{
+	return mean_and_variance_update_inlined(s1, v1);
+}
+EXPORT_SYMBOL_GPL(mean_and_variance_update);
+
+/**
+ * mean_and_variance_get_mean() - get mean from @s
+ */
+s64 mean_and_variance_get_mean(struct mean_and_variance s)
+{
+	return div64_u64(s.sum, s.n);
+}
+EXPORT_SYMBOL_GPL(mean_and_variance_get_mean);
+
+/**
+ * mean_and_variance_get_variance() -  get variance from @s1
+ *
+ * see linked pdf equation 12.
+ */
+u64 mean_and_variance_get_variance(struct mean_and_variance s1)
+{
+	u128 s2 = u128_div(s1.sum_squares, s1.n);
+	u64  s3 = abs(mean_and_variance_get_mean(s1));
+
+	return u128_to_u64(u128_sub(s2, u128_square(s3)));
+}
+EXPORT_SYMBOL_GPL(mean_and_variance_get_variance);
+
+/**
+ * mean_and_variance_get_stddev() - get standard deviation from @s
+ */
+u32 mean_and_variance_get_stddev(struct mean_and_variance s)
+{
+	return int_sqrt64(mean_and_variance_get_variance(s));
+}
+EXPORT_SYMBOL_GPL(mean_and_variance_get_stddev);
+
+/**
+ * mean_and_variance_weighted_update() - exponentially weighted variant of mean_and_variance_update()
+ * @s1: ..
+ * @s2: ..
+ *
+ * see linked pdf: function derived from equations 140-143 where alpha = 2^w.
+ * values are stored bitshifted for performance and added precision.
+ */
+struct mean_and_variance_weighted mean_and_variance_weighted_update(struct mean_and_variance_weighted s1,
+								    s64 x)
+{
+	return mean_and_variance_weighted_update_inlined(s1, x);
+}
+EXPORT_SYMBOL_GPL(mean_and_variance_weighted_update);
+
+/**
+ * mean_and_variance_weighted_get_mean() - get mean from @s
+ */
+s64 mean_and_variance_weighted_get_mean(struct mean_and_variance_weighted s)
+{
+	return fast_divpow2(s.mean, s.w);
+}
+EXPORT_SYMBOL_GPL(mean_and_variance_weighted_get_mean);
+
+/**
+ * mean_and_variance_weighted_get_variance() -- get variance from @s
+ */
+u64 mean_and_variance_weighted_get_variance(struct mean_and_variance_weighted s)
+{
+	// always positive don&#39;t need fast divpow2
+	return s.variance &gt;&gt; s.w;
+}
+EXPORT_SYMBOL_GPL(mean_and_variance_weighted_get_variance);
+
+/**
+ * mean_and_variance_weighted_get_stddev() - get standard deviation from @s
+ */
+u32 mean_and_variance_weighted_get_stddev(struct mean_and_variance_weighted s)
+{
+	return int_sqrt64(mean_and_variance_weighted_get_variance(s));
+}
+EXPORT_SYMBOL_GPL(mean_and_variance_weighted_get_stddev);
+
+MODULE_AUTHOR(&#34;Daniel B. Hill&#34;);
+MODULE_LICENSE(&#34;GPL&#34;);
</span><span><a href="#iZ2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:math:mean_and_variance_test.c" id="Z2e.:..:20230509165657.1735798-32-kent.overstreet::40linux.dev:1lib:math:mean_and_variance_test.c">diff</a> --git a/lib/math/mean_and_variance_test.c b/lib/math/mean_and_variance_test.c
new file mode 100644
index 0000000000..79a96d7307
--- /dev/null
+++ b/lib/math/mean_and_variance_test.c
</span><span>@@ -0,0 +1,155 @@
</span><span>+// SPDX-License-Identifier: GPL-2.0
+#include &lt;kunit/test.h&gt;
+#include &lt;linux/mean_and_variance.h&gt;
+
+#define MAX_SQR (SQRT_U64_MAX*SQRT_U64_MAX)
+
+static void mean_and_variance_basic_test(struct kunit *test)
+{
+	struct mean_and_variance s = {};
+
+	s = mean_and_variance_update(s, 2);
+	s = mean_and_variance_update(s, 2);
+
+	KUNIT_EXPECT_EQ(test, mean_and_variance_get_mean(s), 2);
+	KUNIT_EXPECT_EQ(test, mean_and_variance_get_variance(s), 0);
+	KUNIT_EXPECT_EQ(test, s.n, 2);
+
+	s = mean_and_variance_update(s, 4);
+	s = mean_and_variance_update(s, 4);
+
+	KUNIT_EXPECT_EQ(test, mean_and_variance_get_mean(s), 3);
+	KUNIT_EXPECT_EQ(test, mean_and_variance_get_variance(s), 1);
+	KUNIT_EXPECT_EQ(test, s.n, 4);
+}
+
+/*
+ * Test values computed using a spreadsheet from the psuedocode at the bottom:
+ * <a href="https://fanf2.user.srcf.net/hermes/doc/antiforgery/stats.pdf">https://fanf2.user.srcf.net/hermes/doc/antiforgery/stats.pdf</a>
+ */
+
+static void mean_and_variance_weighted_test(struct kunit *test)
+{
+	struct mean_and_variance_weighted s = {};
+
+	s.w = 2;
+
+	s = mean_and_variance_weighted_update(s, 10);
+	KUNIT_EXPECT_EQ(test, mean_and_variance_weighted_get_mean(s), 10);
+	KUNIT_EXPECT_EQ(test, mean_and_variance_weighted_get_variance(s), 0);
+
+	s = mean_and_variance_weighted_update(s, 20);
+	KUNIT_EXPECT_EQ(test, mean_and_variance_weighted_get_mean(s), 12);
+	KUNIT_EXPECT_EQ(test, mean_and_variance_weighted_get_variance(s), 18);
+
+	s = mean_and_variance_weighted_update(s, 30);
+	KUNIT_EXPECT_EQ(test, mean_and_variance_weighted_get_mean(s), 16);
+	KUNIT_EXPECT_EQ(test, mean_and_variance_weighted_get_variance(s), 72);
+
+	s = (struct mean_and_variance_weighted){};
+	s.w = 2;
+
+	s = mean_and_variance_weighted_update(s, -10);
+	KUNIT_EXPECT_EQ(test, mean_and_variance_weighted_get_mean(s), -10);
+	KUNIT_EXPECT_EQ(test, mean_and_variance_weighted_get_variance(s), 0);
+
+	s = mean_and_variance_weighted_update(s, -20);
+	KUNIT_EXPECT_EQ(test, mean_and_variance_weighted_get_mean(s), -12);
+	KUNIT_EXPECT_EQ(test, mean_and_variance_weighted_get_variance(s), 18);
+
+	s = mean_and_variance_weighted_update(s, -30);
+	KUNIT_EXPECT_EQ(test, mean_and_variance_weighted_get_mean(s), -16);
+	KUNIT_EXPECT_EQ(test, mean_and_variance_weighted_get_variance(s), 72);
+
+}
+
+static void mean_and_variance_weighted_advanced_test(struct kunit *test)
+{
+	struct mean_and_variance_weighted s = {};
+	s64 i;
+
+	s.w = 8;
+	for (i = 10; i &lt;= 100; i += 10)
+		s = mean_and_variance_weighted_update(s, i);
+
+	KUNIT_EXPECT_EQ(test, mean_and_variance_weighted_get_mean(s), 11);
+	KUNIT_EXPECT_EQ(test, mean_and_variance_weighted_get_variance(s), 107);
+
+	s = (struct mean_and_variance_weighted){};
+
+	s.w = 8;
+	for (i = -10; i &gt;= -100; i -= 10)
+		s = mean_and_variance_weighted_update(s, i);
+
+	KUNIT_EXPECT_EQ(test, mean_and_variance_weighted_get_mean(s), -11);
+	KUNIT_EXPECT_EQ(test, mean_and_variance_weighted_get_variance(s), 107);
+
+}
+
+static void mean_and_variance_fast_divpow2(struct kunit *test)
+{
+	s64 i;
+	u8 d;
+
+	for (i = 0; i &lt; 100; i++) {
+		d = 0;
+		KUNIT_EXPECT_EQ(test, fast_divpow2(i, d), div_u64(i, 1LLU &lt;&lt; d));
+		KUNIT_EXPECT_EQ(test, abs(fast_divpow2(-i, d)), div_u64(i, 1LLU &lt;&lt; d));
+		for (d = 1; d &lt; 32; d++) {
+			KUNIT_EXPECT_EQ_MSG(test, abs(fast_divpow2(i, d)),
+					    div_u64(i, 1 &lt;&lt; d), &#34;%lld %u&#34;, i, d);
+			KUNIT_EXPECT_EQ_MSG(test, abs(fast_divpow2(-i, d)),
+					    div_u64(i, 1 &lt;&lt; d), &#34;%lld %u&#34;, -i, d);
+		}
+	}
+}
+
+static void mean_and_variance_u128_basic_test(struct kunit *test)
+{
+	u128 a = u128_shl64_add(0, U64_MAX);
+	u128 a1 = u128_shl64_add(0, 1);
+	u128 b = u128_shl64_add(1, 0);
+	u128 c = u128_shl64_add(0, 1LLU &lt;&lt; 63);
+	u128 c2 = u128_shl64_add(U64_MAX, U64_MAX);
+
+	KUNIT_EXPECT_EQ(test, u128_shr64_to_u64(u128_add(a, a1)), 1);
+	KUNIT_EXPECT_EQ(test, u128_to_u64(u128_add(a, a1)), 0);
+	KUNIT_EXPECT_EQ(test, u128_shr64_to_u64(u128_add(a1, a)), 1);
+	KUNIT_EXPECT_EQ(test, u128_to_u64(u128_add(a1, a)), 0);
+
+	KUNIT_EXPECT_EQ(test, u128_to_u64(u128_sub(b, a1)), U64_MAX);
+	KUNIT_EXPECT_EQ(test, u128_shr64_to_u64(u128_sub(b, a1)), 0);
+
+	KUNIT_EXPECT_EQ(test, u128_shr64_to_u64(u128_shl(c, 1)), 1);
+	KUNIT_EXPECT_EQ(test, u128_to_u64(u128_shl(c, 1)), 0);
+
+	KUNIT_EXPECT_EQ(test, u128_shr64_to_u64(u128_square(U64_MAX)), U64_MAX - 1);
+	KUNIT_EXPECT_EQ(test, u128_to_u64(u128_square(U64_MAX)), 1);
+
+	KUNIT_EXPECT_EQ(test, u128_to_u64(u128_div(b, 2)), 1LLU &lt;&lt; 63);
+
+	KUNIT_EXPECT_EQ(test, u128_shr64_to_u64(u128_div(c2, 2)), U64_MAX &gt;&gt; 1);
+	KUNIT_EXPECT_EQ(test, u128_to_u64(u128_div(c2, 2)), U64_MAX);
+
+	KUNIT_EXPECT_EQ(test, u128_shr64_to_u64(u128_div(u128_shl(u64_to_u128(U64_MAX), 32), 2)), U32_MAX &gt;&gt; 1);
+	KUNIT_EXPECT_EQ(test, u128_to_u64(u128_div(u128_shl(u64_to_u128(U64_MAX), 32), 2)), U64_MAX &lt;&lt; 31);
+}
+
+static struct kunit_case mean_and_variance_test_cases[] = {
+	KUNIT_CASE(mean_and_variance_fast_divpow2),
+	KUNIT_CASE(mean_and_variance_u128_basic_test),
+	KUNIT_CASE(mean_and_variance_basic_test),
+	KUNIT_CASE(mean_and_variance_weighted_test),
+	KUNIT_CASE(mean_and_variance_weighted_advanced_test),
+	{}
+};
+
+static struct kunit_suite mean_and_variance_test_suite = {
+.name = &#34;mean and variance tests&#34;,
+.test_cases = mean_and_variance_test_cases
+};
+
+kunit_test_suite(mean_and_variance_test_suite);
+
+MODULE_AUTHOR(&#34;Daniel B. Hill&#34;);
+MODULE_LICENSE(&#34;GPL&#34;);
</span>-- 
2.40.1


<a href="#m86c8777e4dadc4d7c0a6fa4ecc59f7c9315dff8c" id="e86c8777e4dadc4d7c0a6fa4ecc59f7c9315dff8c">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-32-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-32-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-32-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-32-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-32-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-32-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r86c8777e4dadc4d7c0a6fa4ecc59f7c9315dff8c">73+ messages in thread</a></pre><hr/><pre><a href="#e1452c4f62de7e7806f01f4afe55d78271a434b81" id="m1452c4f62de7e7806f01f4afe55d78271a434b81">*</a> <b>[PATCH 32/32] MAINTAINERS: Add entry for bcachefs</b>
  2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
                   ` <a href="#r86c8777e4dadc4d7c0a6fa4ecc59f7c9315dff8c">(30 preceding siblings ...)</a>
  2023-05-09 16:56 ` <a href="#m86c8777e4dadc4d7c0a6fa4ecc59f7c9315dff8c">[PATCH 31/32] lib: add mean and variance module</a> Kent Overstreet
<b>@ 2023-05-09 16:56 ` Kent Overstreet</b>
  2023-05-09 21:04   ` <a href="#m037ca88ece9bd977aa1ac140dc7dbf3b38a5cd51">Randy Dunlap</a>
  <a href="#r1452c4f62de7e7806f01f4afe55d78271a434b81">31 siblings, 1 reply; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 16:56 UTC (<a href="https://payments.posthaven.com/20230509165657.1735798-33-kent.overstreet@linux.dev/">permalink</a> / <a href="https://payments.posthaven.com/20230509165657.1735798-33-kent.overstreet@linux.dev/raw">raw</a>)
  To: linux-kernel, linux-fsdevel, linux-bcachefs; <b>+Cc:</b> Kent Overstreet

bcachefs is a new copy-on-write filesystem; add a MAINTAINERS entry for
it.

Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
---
 <a id="iZ2e.:..:20230509165657.1735798-33-kent.overstreet::40linux.dev:1MAINTAINERS" href="#Z2e.:..:20230509165657.1735798-33-kent.overstreet::40linux.dev:1MAINTAINERS">MAINTAINERS</a> | 7 +++++++
 1 file <a href="#e1452c4f62de7e7806f01f4afe55d78271a434b81">changed</a>, 7 insertions(+)

<span><a href="#iZ2e.:..:20230509165657.1735798-33-kent.overstreet::40linux.dev:1MAINTAINERS" id="Z2e.:..:20230509165657.1735798-33-kent.overstreet::40linux.dev:1MAINTAINERS">diff</a> --git a/MAINTAINERS b/MAINTAINERS
index dbf3c33c31..0ac2b432f0 100644
--- a/MAINTAINERS
+++ b/MAINTAINERS
</span><span>@@ -3509,6 +3509,13 @@ W:	<a href="http://bcache.evilpiepirate.org">http://bcache.evilpiepirate.org</a>
</span> C:	irc://irc.oftc.net/bcache
 F:	drivers/md/bcache/
 
<span>+BCACHEFS:
+M:	Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
+L:	linux-bcachefs@vger.kernel.org
+S:	Supported
+C:	irc://irc.oftc.net/bcache
+F:	fs/bcachefs/
+
</span> BDISP ST MEDIA DRIVER
 M:	Fabien Dessenne &lt;fabien.dessenne@foss.st.com&gt;
 L:	linux-media@vger.kernel.org
-- 
2.40.1


<a href="#m1452c4f62de7e7806f01f4afe55d78271a434b81" id="e1452c4f62de7e7806f01f4afe55d78271a434b81">^</a> <a href="https://payments.posthaven.com/20230509165657.1735798-33-kent.overstreet@linux.dev/">permalink</a> <a href="https://payments.posthaven.com/20230509165657.1735798-33-kent.overstreet@linux.dev/raw">raw</a> <a href="https://payments.posthaven.com/20230509165657.1735798-33-kent.overstreet@linux.dev/#R">reply</a> <a href="https://payments.posthaven.com/20230509165657.1735798-33-kent.overstreet@linux.dev/#related">related</a>	[<a href="https://payments.posthaven.com/20230509165657.1735798-33-kent.overstreet@linux.dev/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509165657.1735798-33-kent.overstreet@linux.dev/t/#u">nested</a>] <a href="#r1452c4f62de7e7806f01f4afe55d78271a434b81">73+ messages in thread</a></pre><hr/><pre><a href="#e72440a5aab6a33b89f4437cba0c7ddf673ba9771" id="m72440a5aab6a33b89f4437cba0c7ddf673ba9771">*</a> <b>Re: [PATCH 01/32] Compiler Attributes: add __flatten</b>
  2023-05-09 16:56 ` <a href="#mda332a98731952301e95c9833fb1fd717bbe69c4">[PATCH 01/32] Compiler Attributes: add __flatten</a> Kent Overstreet
<b>@ 2023-05-09 17:04   ` Miguel Ojeda</b>
  2023-05-09 17:24     ` <a href="#md90808a3e0fc85cadda811f5d882ae24841e4ac7">Kent Overstreet</a>
  <a href="#r72440a5aab6a33b89f4437cba0c7ddf673ba9771">0 siblings, 1 reply; 73+ messages in thread</a>
From: Miguel Ojeda @ 2023-05-09 17:04 UTC (<a href="https://payments.posthaven.com/CANiq72mLmAG1Vus5-r4ynQciyypZbO8ueva2jbiEvaOAQTTzdQ@mail.gmail.com/">permalink</a> / <a href="https://payments.posthaven.com/CANiq72mLmAG1Vus5-r4ynQciyypZbO8ueva2jbiEvaOAQTTzdQ@mail.gmail.com/raw">raw</a>)
  To: Kent Overstreet
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Kent Overstreet,
	Miguel Ojeda, Nick Desaulniers

On Tue, May 9, 2023 at 6:57 PM Kent Overstreet
&lt;kent.overstreet@linux.dev&gt; wrote:
<span>&gt;
&gt; This makes __attribute__((flatten)) available, which is used by
&gt; bcachefs.
</span>
We already have it in mainline, so I think it is one less patch you
need to care about! :)

Cheers,
Miguel

<a href="#m72440a5aab6a33b89f4437cba0c7ddf673ba9771" id="e72440a5aab6a33b89f4437cba0c7ddf673ba9771">^</a> <a href="https://payments.posthaven.com/CANiq72mLmAG1Vus5-r4ynQciyypZbO8ueva2jbiEvaOAQTTzdQ@mail.gmail.com/">permalink</a> <a href="https://payments.posthaven.com/CANiq72mLmAG1Vus5-r4ynQciyypZbO8ueva2jbiEvaOAQTTzdQ@mail.gmail.com/raw">raw</a> <a href="https://payments.posthaven.com/CANiq72mLmAG1Vus5-r4ynQciyypZbO8ueva2jbiEvaOAQTTzdQ@mail.gmail.com/#R">reply</a>	[<a href="https://payments.posthaven.com/CANiq72mLmAG1Vus5-r4ynQciyypZbO8ueva2jbiEvaOAQTTzdQ@mail.gmail.com/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/CANiq72mLmAG1Vus5-r4ynQciyypZbO8ueva2jbiEvaOAQTTzdQ@mail.gmail.com/t/#u">nested</a>] <a href="#r72440a5aab6a33b89f4437cba0c7ddf673ba9771">73+ messages in thread</a></pre><hr/><pre><a href="#ebb2558522aa7d939e3d68574ae0ae4a8acfaae61" id="mbb2558522aa7d939e3d68574ae0ae4a8acfaae61">*</a> <b>Re: [PATCH 16/32] MAINTAINERS: Add entry for closures</b>
  2023-05-09 16:56 ` <a href="#m766da299d420970b1b3f7ac489b0d1393f2da35d">[PATCH 16/32] MAINTAINERS: Add entry for closures</a> Kent Overstreet
<b>@ 2023-05-09 17:05   ` Coly Li</b>
  2023-05-09 21:03   ` <a href="#m1da07d4e58363b6d528f2a64372eb80c78d0b92f">Randy Dunlap</a>
  <a href="#rbb2558522aa7d939e3d68574ae0ae4a8acfaae61">1 sibling, 0 replies; 73+ messages in thread</a>
From: Coly Li @ 2023-05-09 17:05 UTC (<a href="https://payments.posthaven.com/106B2DFE-5516-49E2-9EEB-2759CE35D465@suse.de/">permalink</a> / <a href="https://payments.posthaven.com/106B2DFE-5516-49E2-9EEB-2759CE35D465@suse.de/raw">raw</a>)
  To: Kent Overstreet; <b>+Cc:</b> linux-kernel, linux-fsdevel, linux-bcachefs



<span>&gt; 2023年5月10日 00:56，Kent Overstreet &lt;kent.overstreet@linux.dev&gt; 写道：
&gt; 
&gt; closures, from bcache, are async widgets with a variety of uses.
&gt; bcachefs also uses them, so they&#39;re being moved to lib/; mark them as
&gt; maintained.
&gt; 
&gt; Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
&gt; Cc: Coly Li &lt;colyli@suse.de&gt;
</span>
Acked-by: Coly Li &lt;colyli@suse.de&gt;

Thanks.

Coly Li

<span>&gt; ---
&gt; MAINTAINERS | 8 ++++++++
&gt; 1 file changed, 8 insertions(+)
&gt; 
&gt; diff --git a/MAINTAINERS b/MAINTAINERS
&gt; index 3fc37de3d6..5d76169140 100644
&gt; --- a/MAINTAINERS
&gt; +++ b/MAINTAINERS
&gt; @@ -5044,6 +5044,14 @@ T: git git://git.kernel.org/pub/scm/linux/kernel/git/tip/tip.git timers/core
&gt; F: Documentation/devicetree/bindings/timer/
&gt; F: drivers/clocksource/
&gt; 
&gt; +CLOSURES:
&gt; +M: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
&gt; +L: linux-bcachefs@vger.kernel.org
&gt; +S: Supported
&gt; +C: irc://irc.oftc.net/bcache
&gt; +F: include/linux/closure.h
&gt; +F: lib/closure.c
&gt; +
&gt; CMPC ACPI DRIVER
&gt; M: Thadeu Lima de Souza Cascardo &lt;cascardo@holoscopio.com&gt;
&gt; M: Daniel Oliveira Nascimento &lt;don@syst.com.br&gt;
&gt; -- 
&gt; 2.40.1
&gt; 
</span>

<a href="#mbb2558522aa7d939e3d68574ae0ae4a8acfaae61" id="ebb2558522aa7d939e3d68574ae0ae4a8acfaae61">^</a> <a href="https://payments.posthaven.com/106B2DFE-5516-49E2-9EEB-2759CE35D465@suse.de/">permalink</a> <a href="https://payments.posthaven.com/106B2DFE-5516-49E2-9EEB-2759CE35D465@suse.de/raw">raw</a> <a href="https://payments.posthaven.com/106B2DFE-5516-49E2-9EEB-2759CE35D465@suse.de/#R">reply</a>	[<a href="https://payments.posthaven.com/106B2DFE-5516-49E2-9EEB-2759CE35D465@suse.de/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/106B2DFE-5516-49E2-9EEB-2759CE35D465@suse.de/t/#u">nested</a>] <a href="#rbb2558522aa7d939e3d68574ae0ae4a8acfaae61">73+ messages in thread</a></pre><hr/><pre><a href="#ed90808a3e0fc85cadda811f5d882ae24841e4ac7" id="md90808a3e0fc85cadda811f5d882ae24841e4ac7">*</a> <b>Re: [PATCH 01/32] Compiler Attributes: add __flatten</b>
  2023-05-09 17:04   ` <a href="#m72440a5aab6a33b89f4437cba0c7ddf673ba9771">Miguel Ojeda</a>
<b>@ 2023-05-09 17:24     ` Kent Overstreet</b>
  <a href="#rd90808a3e0fc85cadda811f5d882ae24841e4ac7">0 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 17:24 UTC (<a href="https://payments.posthaven.com/ZFqBvs1+yZ8aYRIW@moria.home.lan/">permalink</a> / <a href="https://payments.posthaven.com/ZFqBvs1+yZ8aYRIW@moria.home.lan/raw">raw</a>)
  To: Miguel Ojeda
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Kent Overstreet,
	Miguel Ojeda, Nick Desaulniers

On Tue, May 09, 2023 at 07:04:43PM +0200, Miguel Ojeda wrote:
<span>&gt; On Tue, May 9, 2023 at 6:57 PM Kent Overstreet
&gt; &lt;kent.overstreet@linux.dev&gt; wrote:
&gt; &gt;
&gt; &gt; This makes __attribute__((flatten)) available, which is used by
&gt; &gt; bcachefs.
&gt; 
&gt; We already have it in mainline, so I think it is one less patch you
&gt; need to care about! :)
&gt; 
&gt; Cheers,
&gt; Miguel
</span>
Wonderful :)

Cheers,
Kent

<a href="#md90808a3e0fc85cadda811f5d882ae24841e4ac7" id="ed90808a3e0fc85cadda811f5d882ae24841e4ac7">^</a> <a href="https://payments.posthaven.com/ZFqBvs1+yZ8aYRIW@moria.home.lan/">permalink</a> <a href="https://payments.posthaven.com/ZFqBvs1+yZ8aYRIW@moria.home.lan/raw">raw</a> <a href="https://payments.posthaven.com/ZFqBvs1+yZ8aYRIW@moria.home.lan/#R">reply</a>	[<a href="https://payments.posthaven.com/ZFqBvs1+yZ8aYRIW@moria.home.lan/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/ZFqBvs1+yZ8aYRIW@moria.home.lan/t/#u">nested</a>] <a href="#rd90808a3e0fc85cadda811f5d882ae24841e4ac7">73+ messages in thread</a></pre><hr/><pre><a href="#e4441d42cf9b00ca0af1c77affa4e0e32fc889be6" id="m4441d42cf9b00ca0af1c77affa4e0e32fc889be6">*</a> <b>Re: [PATCH 07/32] mm: Bring back vmalloc_exec</b>
  2023-05-09 16:56 ` <a href="#mcabddb3f4bded12301500ae05b7bcb26474a2aa4">[PATCH 07/32] mm: Bring back vmalloc_exec</a> Kent Overstreet
<b>@ 2023-05-09 18:19   ` Lorenzo Stoakes</b>
  2023-05-09 20:15     ` <a href="#m9afc6b0109fc157fe194c22d7343b4370bdbaa9d">Kent Overstreet</a>
  2023-05-09 20:46   ` <a href="#mfa639982c8ae26fa0750bbf9244a1d3272ef00a0">Christoph Hellwig</a>
                     ` <a href="#rfa639982c8ae26fa0750bbf9244a1d3272ef00a0">(2 subsequent siblings)</a>
  <a href="#r4441d42cf9b00ca0af1c77affa4e0e32fc889be6">3 siblings, 1 reply; 73+ messages in thread</a>
From: Lorenzo Stoakes @ 2023-05-09 18:19 UTC (<a href="https://payments.posthaven.com/ZFqOukfefifbfHMb@murray/">permalink</a> / <a href="https://payments.posthaven.com/ZFqOukfefifbfHMb@murray/raw">raw</a>)
  To: Kent Overstreet
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Kent Overstreet,
	Andrew Morton, Uladzislau Rezki, Christoph Hellwig, linux-mm

On Tue, May 09, 2023 at 12:56:32PM -0400, Kent Overstreet wrote:
<span>&gt; From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
&gt;
&gt; This is needed for bcachefs, which dynamically generates per-btree node
&gt; unpack functions.
</span>
Small nits -

Would be good to refer to the original patch that removed it,
i.e. 7a0e27b2a0ce (&#34;mm: remove vmalloc_exec&#34;) something like &#39;patch
... folded vmalloc_exec() into its one user, however bcachefs requires this
as well so revert&#39;.

Would also be good to mention that you are now exporting the function which
the original didn&#39;t appear to do.

<span>&gt;
&gt; Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
&gt; Cc: Andrew Morton &lt;akpm@linux-foundation.org&gt;
&gt; Cc: Uladzislau Rezki &lt;urezki@gmail.com&gt;
&gt; Cc: Christoph Hellwig &lt;hch@infradead.org&gt;
&gt; Cc: linux-mm@kvack.org
</span>
Another nit: I&#39;m a vmalloc reviewer so would be good to get cc&#39;d too :)
(forgivable mistake as very recent change!)

<span>&gt; ---
&gt;  include/linux/vmalloc.h |  1 +
&gt;  kernel/module/main.c    |  4 +---
&gt;  mm/nommu.c              | 18 ++++++++++++++++++
&gt;  mm/vmalloc.c            | 21 +++++++++++++++++++++
&gt;  4 files changed, 41 insertions(+), 3 deletions(-)
&gt;
&gt; diff --git a/include/linux/vmalloc.h b/include/linux/vmalloc.h
&gt; index 69250efa03..ff147fe115 100644
&gt; --- a/include/linux/vmalloc.h
&gt; +++ b/include/linux/vmalloc.h
&gt; @@ -145,6 +145,7 @@ extern void *vzalloc(unsigned long size) __alloc_size(1);
&gt;  extern void *vmalloc_user(unsigned long size) __alloc_size(1);
&gt;  extern void *vmalloc_node(unsigned long size, int node) __alloc_size(1);
&gt;  extern void *vzalloc_node(unsigned long size, int node) __alloc_size(1);
&gt; +extern void *vmalloc_exec(unsigned long size, gfp_t gfp_mask) __alloc_size(1);
&gt;  extern void *vmalloc_32(unsigned long size) __alloc_size(1);
&gt;  extern void *vmalloc_32_user(unsigned long size) __alloc_size(1);
&gt;  extern void *__vmalloc(unsigned long size, gfp_t gfp_mask) __alloc_size(1);
&gt; diff --git a/kernel/module/main.c b/kernel/module/main.c
&gt; index d3be89de70..9eaa89e84c 100644
&gt; --- a/kernel/module/main.c
&gt; +++ b/kernel/module/main.c
&gt; @@ -1607,9 +1607,7 @@ static void dynamic_debug_remove(struct module *mod, struct _ddebug_info *dyndbg
&gt;
&gt;  void * __weak module_alloc(unsigned long size)
&gt;  {
&gt; -	return __vmalloc_node_range(size, 1, VMALLOC_START, VMALLOC_END,
&gt; -			GFP_KERNEL, PAGE_KERNEL_EXEC, VM_FLUSH_RESET_PERMS,
&gt; -			NUMA_NO_NODE, __builtin_return_address(0));
&gt; +	return vmalloc_exec(size, GFP_KERNEL);
&gt;  }
&gt;
&gt;  bool __weak module_init_section(const char *name)
&gt; diff --git a/mm/nommu.c b/mm/nommu.c
&gt; index 57ba243c6a..8d9ab19e39 100644
&gt; --- a/mm/nommu.c
&gt; +++ b/mm/nommu.c
&gt; @@ -280,6 +280,24 @@ void *vzalloc_node(unsigned long size, int node)
&gt;  }
&gt;  EXPORT_SYMBOL(vzalloc_node);
&gt;
&gt; +/**
&gt; + *	vmalloc_exec  -  allocate virtually contiguous, executable memory
&gt; + *	@size:		allocation size
&gt; + *
&gt; + *	Kernel-internal function to allocate enough pages to cover @size
&gt; + *	the page level allocator and map them into contiguous and
&gt; + *	executable kernel virtual space.
&gt; + *
&gt; + *	For tight control over page level allocator and protection flags
&gt; + *	use __vmalloc() instead.
&gt; + */
&gt; +
&gt; +void *vmalloc_exec(unsigned long size, gfp_t gfp_mask)
&gt; +{
&gt; +	return __vmalloc(size, gfp_mask);
&gt; +}
&gt; +EXPORT_SYMBOL_GPL(vmalloc_exec);
&gt; +
&gt;  /**
&gt;   * vmalloc_32  -  allocate virtually contiguous memory (32bit addressable)
&gt;   *	@size:		allocation size
&gt; diff --git a/mm/vmalloc.c b/mm/vmalloc.c
&gt; index 31ff782d36..2ebb9ea7f0 100644
&gt; --- a/mm/vmalloc.c
&gt; +++ b/mm/vmalloc.c
&gt; @@ -3401,6 +3401,27 @@ void *vzalloc_node(unsigned long size, int node)
&gt;  }
&gt;  EXPORT_SYMBOL(vzalloc_node);
&gt;
&gt; +/**
&gt; + * vmalloc_exec - allocate virtually contiguous, executable memory
&gt; + * @size:	  allocation size
&gt; + *
&gt; + * Kernel-internal function to allocate enough pages to cover @size
&gt; + * the page level allocator and map them into contiguous and
&gt; + * executable kernel virtual space.
&gt; + *
&gt; + * For tight control over page level allocator and protection flags
&gt; + * use __vmalloc() instead.
&gt; + *
&gt; + * Return: pointer to the allocated memory or %NULL on error
&gt; + */
&gt; +void *vmalloc_exec(unsigned long size, gfp_t gfp_mask)
&gt; +{
&gt; +	return __vmalloc_node_range(size, 1, VMALLOC_START, VMALLOC_END,
&gt; +			gfp_mask, PAGE_KERNEL_EXEC, VM_FLUSH_RESET_PERMS,
&gt; +			NUMA_NO_NODE, __builtin_return_address(0));
&gt; +}
&gt; +EXPORT_SYMBOL_GPL(vmalloc_exec);
&gt; +
&gt;  #if defined(CONFIG_64BIT) &amp;&amp; defined(CONFIG_ZONE_DMA32)
&gt;  #define GFP_VMALLOC32 (GFP_DMA32 | GFP_KERNEL)
&gt;  #elif defined(CONFIG_64BIT) &amp;&amp; defined(CONFIG_ZONE_DMA)
&gt; --
&gt; 2.40.1
&gt;
</span>
Otherwise lgtm, feel free to add:

Acked-by: Lorenzo Stoakes &lt;lstoakes@gmail.com&gt;

<a href="#m4441d42cf9b00ca0af1c77affa4e0e32fc889be6" id="e4441d42cf9b00ca0af1c77affa4e0e32fc889be6">^</a> <a href="https://payments.posthaven.com/ZFqOukfefifbfHMb@murray/">permalink</a> <a href="https://payments.posthaven.com/ZFqOukfefifbfHMb@murray/raw">raw</a> <a href="https://payments.posthaven.com/ZFqOukfefifbfHMb@murray/#R">reply</a>	[<a href="https://payments.posthaven.com/ZFqOukfefifbfHMb@murray/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/ZFqOukfefifbfHMb@murray/t/#u">nested</a>] <a href="#r4441d42cf9b00ca0af1c77affa4e0e32fc889be6">73+ messages in thread</a></pre><hr/><pre><a href="#ee6217c7916bdf0763c1175f29137722e31dc943c" id="me6217c7916bdf0763c1175f29137722e31dc943c">*</a> <b>Re: [PATCH 02/32] locking/lockdep: lock_class_is_held()</b>
  2023-05-09 16:56 ` <a href="#m86cd2a43c7ceeb60c0a4e313c199deb289199877">[PATCH 02/32] locking/lockdep: lock_class_is_held()</a> Kent Overstreet
<b>@ 2023-05-09 19:30   ` Peter Zijlstra</b>
  2023-05-09 20:11     ` <a href="#m05f9f3c5016228a09d1b54acf882c1bdf7512f16">Kent Overstreet</a>
  <a href="#re6217c7916bdf0763c1175f29137722e31dc943c">0 siblings, 1 reply; 73+ messages in thread</a>
From: Peter Zijlstra @ 2023-05-09 19:30 UTC (<a href="https://payments.posthaven.com/20230509193039.GB2148518@hirez.programming.kicks-ass.net/">permalink</a> / <a href="https://payments.posthaven.com/20230509193039.GB2148518@hirez.programming.kicks-ass.net/raw">raw</a>)
  To: Kent Overstreet
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Kent Overstreet,
	Ingo Molnar, Will Deacon, Waiman Long, Boqun Feng

On Tue, May 09, 2023 at 12:56:27PM -0400, Kent Overstreet wrote:
<span>&gt; From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
&gt; 
&gt; This patch adds lock_class_is_held(), which can be used to assert that a
&gt; particular type of lock is not held.
</span>
How is lock_is_held_type() not sufficient? Which is what&#39;s used to
implement lockdep_assert_held*().


<a href="#me6217c7916bdf0763c1175f29137722e31dc943c" id="ee6217c7916bdf0763c1175f29137722e31dc943c">^</a> <a href="https://payments.posthaven.com/20230509193039.GB2148518@hirez.programming.kicks-ass.net/">permalink</a> <a href="https://payments.posthaven.com/20230509193039.GB2148518@hirez.programming.kicks-ass.net/raw">raw</a> <a href="https://payments.posthaven.com/20230509193039.GB2148518@hirez.programming.kicks-ass.net/#R">reply</a>	[<a href="https://payments.posthaven.com/20230509193039.GB2148518@hirez.programming.kicks-ass.net/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509193039.GB2148518@hirez.programming.kicks-ass.net/t/#u">nested</a>] <a href="#re6217c7916bdf0763c1175f29137722e31dc943c">73+ messages in thread</a></pre><hr/><pre><a href="#edc1c43efeeae88da82cf5e2a930303b1dd0fd99e" id="mdc1c43efeeae88da82cf5e2a930303b1dd0fd99e">*</a> <b>Re: [PATCH 03/32] locking/lockdep: lockdep_set_no_check_recursion()</b>
  2023-05-09 16:56 ` <a href="#m5ed7c55399215bfa0a81888ebb4421bfa03cf35b">[PATCH 03/32] locking/lockdep: lockdep_set_no_check_recursion()</a> Kent Overstreet
<b>@ 2023-05-09 19:31   ` Peter Zijlstra</b>
  2023-05-09 19:57     ` <a href="#m670b7c1071b0982068fc786f48cc3a5910599a38">Kent Overstreet</a>
  2023-05-09 20:18     ` <a href="#m4c5848c5e0839861066340c7f2aa5e237ba6c2ea">Kent Overstreet</a>
  <a href="#rdc1c43efeeae88da82cf5e2a930303b1dd0fd99e">0 siblings, 2 replies; 73+ messages in thread</a>
From: Peter Zijlstra @ 2023-05-09 19:31 UTC (<a href="https://payments.posthaven.com/20230509193147.GC2148518@hirez.programming.kicks-ass.net/">permalink</a> / <a href="https://payments.posthaven.com/20230509193147.GC2148518@hirez.programming.kicks-ass.net/raw">raw</a>)
  To: Kent Overstreet
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Ingo Molnar,
	Will Deacon, Waiman Long, Boqun Feng

On Tue, May 09, 2023 at 12:56:28PM -0400, Kent Overstreet wrote:
<span>&gt; This adds a method to tell lockdep not to check lock ordering within a
&gt; lock class - but to still check lock ordering w.r.t. other lock types.
&gt; 
&gt; This is for bcachefs, where for btree node locks we have our own
&gt; deadlock avoidance strategy w.r.t. other btree node locks (cycle
&gt; detection), but we still want lockdep to check lock ordering w.r.t.
&gt; other lock types.
&gt; 
</span>
ISTR you had a much nicer version of this where you gave a custom order
function -- what happend to that?

<a href="#mdc1c43efeeae88da82cf5e2a930303b1dd0fd99e" id="edc1c43efeeae88da82cf5e2a930303b1dd0fd99e">^</a> <a href="https://payments.posthaven.com/20230509193147.GC2148518@hirez.programming.kicks-ass.net/">permalink</a> <a href="https://payments.posthaven.com/20230509193147.GC2148518@hirez.programming.kicks-ass.net/raw">raw</a> <a href="https://payments.posthaven.com/20230509193147.GC2148518@hirez.programming.kicks-ass.net/#R">reply</a>	[<a href="https://payments.posthaven.com/20230509193147.GC2148518@hirez.programming.kicks-ass.net/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509193147.GC2148518@hirez.programming.kicks-ass.net/t/#u">nested</a>] <a href="#rdc1c43efeeae88da82cf5e2a930303b1dd0fd99e">73+ messages in thread</a></pre><hr/><pre><a href="#e670b7c1071b0982068fc786f48cc3a5910599a38" id="m670b7c1071b0982068fc786f48cc3a5910599a38">*</a> <b>Re: [PATCH 03/32] locking/lockdep: lockdep_set_no_check_recursion()</b>
  2023-05-09 19:31   ` <a href="#mdc1c43efeeae88da82cf5e2a930303b1dd0fd99e">Peter Zijlstra</a>
<b>@ 2023-05-09 19:57     ` Kent Overstreet</b>
  2023-05-09 20:18     ` <a href="#m4c5848c5e0839861066340c7f2aa5e237ba6c2ea">Kent Overstreet</a>
  <a href="#r670b7c1071b0982068fc786f48cc3a5910599a38">1 sibling, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 19:57 UTC (<a href="https://payments.posthaven.com/ZFqlmrL27is3AofY@moria.home.lan/">permalink</a> / <a href="https://payments.posthaven.com/ZFqlmrL27is3AofY@moria.home.lan/raw">raw</a>)
  To: Peter Zijlstra
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Ingo Molnar,
	Will Deacon, Waiman Long, Boqun Feng

On Tue, May 09, 2023 at 09:31:47PM +0200, Peter Zijlstra wrote:
<span>&gt; On Tue, May 09, 2023 at 12:56:28PM -0400, Kent Overstreet wrote:
&gt; &gt; This adds a method to tell lockdep not to check lock ordering within a
&gt; &gt; lock class - but to still check lock ordering w.r.t. other lock types.
&gt; &gt; 
&gt; &gt; This is for bcachefs, where for btree node locks we have our own
&gt; &gt; deadlock avoidance strategy w.r.t. other btree node locks (cycle
&gt; &gt; detection), but we still want lockdep to check lock ordering w.r.t.
&gt; &gt; other lock types.
&gt; &gt; 
&gt; 
&gt; ISTR you had a much nicer version of this where you gave a custom order
&gt; function -- what happend to that?
</span>
Probably in the other branch that I was meaning to re-mail you separately,
clearly I hadn&#39;t pulled the latest versions back into here... expect
that shortly :)

<a href="#m670b7c1071b0982068fc786f48cc3a5910599a38" id="e670b7c1071b0982068fc786f48cc3a5910599a38">^</a> <a href="https://payments.posthaven.com/ZFqlmrL27is3AofY@moria.home.lan/">permalink</a> <a href="https://payments.posthaven.com/ZFqlmrL27is3AofY@moria.home.lan/raw">raw</a> <a href="https://payments.posthaven.com/ZFqlmrL27is3AofY@moria.home.lan/#R">reply</a>	[<a href="https://payments.posthaven.com/ZFqlmrL27is3AofY@moria.home.lan/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/ZFqlmrL27is3AofY@moria.home.lan/t/#u">nested</a>] <a href="#r670b7c1071b0982068fc786f48cc3a5910599a38">73+ messages in thread</a></pre><hr/><pre><a href="#e05f9f3c5016228a09d1b54acf882c1bdf7512f16" id="m05f9f3c5016228a09d1b54acf882c1bdf7512f16">*</a> <b>Re: [PATCH 02/32] locking/lockdep: lock_class_is_held()</b>
  2023-05-09 19:30   ` <a href="#me6217c7916bdf0763c1175f29137722e31dc943c">Peter Zijlstra</a>
<b>@ 2023-05-09 20:11     ` Kent Overstreet</b>
  <a href="#r05f9f3c5016228a09d1b54acf882c1bdf7512f16">0 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 20:11 UTC (<a href="https://payments.posthaven.com/ZFqo50Gg3jFB1OEU@moria.home.lan/">permalink</a> / <a href="https://payments.posthaven.com/ZFqo50Gg3jFB1OEU@moria.home.lan/raw">raw</a>)
  To: Peter Zijlstra
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Kent Overstreet,
	Ingo Molnar, Will Deacon, Waiman Long, Boqun Feng

On Tue, May 09, 2023 at 09:30:39PM +0200, Peter Zijlstra wrote:
<span>&gt; On Tue, May 09, 2023 at 12:56:27PM -0400, Kent Overstreet wrote:
&gt; &gt; From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
&gt; &gt; 
&gt; &gt; This patch adds lock_class_is_held(), which can be used to assert that a
&gt; &gt; particular type of lock is not held.
&gt; 
&gt; How is lock_is_held_type() not sufficient? Which is what&#39;s used to
&gt; implement lockdep_assert_held*().
</span>
I should&#39;ve looked at that before - it returns a tristate, so it&#39;s
closer than I thought, but this is used in contexts where we don&#39;t have
a lock or lockdep_map to pass and need to pass the lock_class_key
instead.

e.g, when initializing a btree_trans, or waiting on btree node IO, we
need to assert that no btree node locks are held.

Looking at the code, __lock_is_held() -&gt; match_held_lock() has to care
about a bunch of stuff related to subclasses that doesn&#39;t seem relevant
to lock_class_is_held() - lock_class_is_held() is practically no code in
comparison, so I&#39;m inclined to think they should just be separate.

But I&#39;m not the lockdep expert :) Thoughts?

<a href="#m05f9f3c5016228a09d1b54acf882c1bdf7512f16" id="e05f9f3c5016228a09d1b54acf882c1bdf7512f16">^</a> <a href="https://payments.posthaven.com/ZFqo50Gg3jFB1OEU@moria.home.lan/">permalink</a> <a href="https://payments.posthaven.com/ZFqo50Gg3jFB1OEU@moria.home.lan/raw">raw</a> <a href="https://payments.posthaven.com/ZFqo50Gg3jFB1OEU@moria.home.lan/#R">reply</a>	[<a href="https://payments.posthaven.com/ZFqo50Gg3jFB1OEU@moria.home.lan/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/ZFqo50Gg3jFB1OEU@moria.home.lan/t/#u">nested</a>] <a href="#r05f9f3c5016228a09d1b54acf882c1bdf7512f16">73+ messages in thread</a></pre><hr/><pre><a href="#e9afc6b0109fc157fe194c22d7343b4370bdbaa9d" id="m9afc6b0109fc157fe194c22d7343b4370bdbaa9d">*</a> <b>Re: [PATCH 07/32] mm: Bring back vmalloc_exec</b>
  2023-05-09 18:19   ` <a href="#m4441d42cf9b00ca0af1c77affa4e0e32fc889be6">Lorenzo Stoakes</a>
<b>@ 2023-05-09 20:15     ` Kent Overstreet</b>
  <a href="#r9afc6b0109fc157fe194c22d7343b4370bdbaa9d">0 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 20:15 UTC (<a href="https://payments.posthaven.com/ZFqp1UEjM8ibrCWT@moria.home.lan/">permalink</a> / <a href="https://payments.posthaven.com/ZFqp1UEjM8ibrCWT@moria.home.lan/raw">raw</a>)
  To: Lorenzo Stoakes
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Kent Overstreet,
	Andrew Morton, Uladzislau Rezki, Christoph Hellwig, linux-mm

On Tue, May 09, 2023 at 11:19:38AM -0700, Lorenzo Stoakes wrote:
<span>&gt; On Tue, May 09, 2023 at 12:56:32PM -0400, Kent Overstreet wrote:
&gt; &gt; From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
&gt; &gt;
&gt; &gt; This is needed for bcachefs, which dynamically generates per-btree node
&gt; &gt; unpack functions.
&gt; 
&gt; Small nits -
&gt; 
&gt; Would be good to refer to the original patch that removed it,
&gt; i.e. 7a0e27b2a0ce (&#34;mm: remove vmalloc_exec&#34;) something like &#39;patch
&gt; ... folded vmalloc_exec() into its one user, however bcachefs requires this
&gt; as well so revert&#39;.
&gt; 
&gt; Would also be good to mention that you are now exporting the function which
&gt; the original didn&#39;t appear to do.
&gt; 
&gt; &gt;
&gt; &gt; Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
&gt; &gt; Cc: Andrew Morton &lt;akpm@linux-foundation.org&gt;
&gt; &gt; Cc: Uladzislau Rezki &lt;urezki@gmail.com&gt;
&gt; &gt; Cc: Christoph Hellwig &lt;hch@infradead.org&gt;
&gt; &gt; Cc: linux-mm@kvack.org
&gt; 
&gt; Another nit: I&#39;m a vmalloc reviewer so would be good to get cc&#39;d too :)
&gt; (forgivable mistake as very recent change!)
</span>
Thanks - folded your suggestions into the commit message, and added you
for the next posting :)

<a href="#m9afc6b0109fc157fe194c22d7343b4370bdbaa9d" id="e9afc6b0109fc157fe194c22d7343b4370bdbaa9d">^</a> <a href="https://payments.posthaven.com/ZFqp1UEjM8ibrCWT@moria.home.lan/">permalink</a> <a href="https://payments.posthaven.com/ZFqp1UEjM8ibrCWT@moria.home.lan/raw">raw</a> <a href="https://payments.posthaven.com/ZFqp1UEjM8ibrCWT@moria.home.lan/#R">reply</a>	[<a href="https://payments.posthaven.com/ZFqp1UEjM8ibrCWT@moria.home.lan/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/ZFqp1UEjM8ibrCWT@moria.home.lan/t/#u">nested</a>] <a href="#r9afc6b0109fc157fe194c22d7343b4370bdbaa9d">73+ messages in thread</a></pre><hr/><pre><a href="#e4c5848c5e0839861066340c7f2aa5e237ba6c2ea" id="m4c5848c5e0839861066340c7f2aa5e237ba6c2ea">*</a> <b>Re: [PATCH 03/32] locking/lockdep: lockdep_set_no_check_recursion()</b>
  2023-05-09 19:31   ` <a href="#mdc1c43efeeae88da82cf5e2a930303b1dd0fd99e">Peter Zijlstra</a>
  2023-05-09 19:57     ` <a href="#m670b7c1071b0982068fc786f48cc3a5910599a38">Kent Overstreet</a>
<b>@ 2023-05-09 20:18     ` Kent Overstreet</b>
  2023-05-09 20:27       ` <a href="#m300bc72c7328f6808bafb4f9a78a04d953029686">Waiman Long</a>
  2023-05-10  8:59       ` <a href="#mc00ab06c40f934efbc30a1f117ec7336e9c0dcfa">Peter Zijlstra</a>
  <a href="#r4c5848c5e0839861066340c7f2aa5e237ba6c2ea">1 sibling, 2 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 20:18 UTC (<a href="https://payments.posthaven.com/ZFqqsyDpatgb77Vh@moria.home.lan/">permalink</a> / <a href="https://payments.posthaven.com/ZFqqsyDpatgb77Vh@moria.home.lan/raw">raw</a>)
  To: Peter Zijlstra
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Ingo Molnar,
	Will Deacon, Waiman Long, Boqun Feng

On Tue, May 09, 2023 at 09:31:47PM +0200, Peter Zijlstra wrote:
<span>&gt; On Tue, May 09, 2023 at 12:56:28PM -0400, Kent Overstreet wrote:
&gt; &gt; This adds a method to tell lockdep not to check lock ordering within a
&gt; &gt; lock class - but to still check lock ordering w.r.t. other lock types.
&gt; &gt; 
&gt; &gt; This is for bcachefs, where for btree node locks we have our own
&gt; &gt; deadlock avoidance strategy w.r.t. other btree node locks (cycle
&gt; &gt; detection), but we still want lockdep to check lock ordering w.r.t.
&gt; &gt; other lock types.
&gt; &gt; 
&gt; 
&gt; ISTR you had a much nicer version of this where you gave a custom order
&gt; function -- what happend to that?
</span>
Actually, I spoke too soon; this patch and the other series with the
comparison function solve different problems.

For bcachefs btree node locks, we don&#39;t have a defined lock ordering at
all - we do full runtime cycle detection, so we don&#39;t want lockdep
checking for self deadlock because we&#39;re handling that but we _do_ want
lockdep checking lock ordering of btree node locks w.r.t. other locks in
the system.

<a href="#m4c5848c5e0839861066340c7f2aa5e237ba6c2ea" id="e4c5848c5e0839861066340c7f2aa5e237ba6c2ea">^</a> <a href="https://payments.posthaven.com/ZFqqsyDpatgb77Vh@moria.home.lan/">permalink</a> <a href="https://payments.posthaven.com/ZFqqsyDpatgb77Vh@moria.home.lan/raw">raw</a> <a href="https://payments.posthaven.com/ZFqqsyDpatgb77Vh@moria.home.lan/#R">reply</a>	[<a href="https://payments.posthaven.com/ZFqqsyDpatgb77Vh@moria.home.lan/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/ZFqqsyDpatgb77Vh@moria.home.lan/t/#u">nested</a>] <a href="#r4c5848c5e0839861066340c7f2aa5e237ba6c2ea">73+ messages in thread</a></pre><hr/><pre><a href="#e300bc72c7328f6808bafb4f9a78a04d953029686" id="m300bc72c7328f6808bafb4f9a78a04d953029686">*</a> <b>Re: [PATCH 03/32] locking/lockdep: lockdep_set_no_check_recursion()</b>
  2023-05-09 20:18     ` <a href="#m4c5848c5e0839861066340c7f2aa5e237ba6c2ea">Kent Overstreet</a>
<b>@ 2023-05-09 20:27       ` Waiman Long</b>
  2023-05-09 20:35         ` <a href="#m1a9c685bfb0e1f61d9fdca7b290974dee2c0f412">Kent Overstreet</a>
  2023-05-10  8:59       ` <a href="#mc00ab06c40f934efbc30a1f117ec7336e9c0dcfa">Peter Zijlstra</a>
  <a href="#r300bc72c7328f6808bafb4f9a78a04d953029686">1 sibling, 1 reply; 73+ messages in thread</a>
From: Waiman Long @ 2023-05-09 20:27 UTC (<a href="https://payments.posthaven.com/d5b65b01-62a9-e483-dea8-5e2bb65be278@redhat.com/">permalink</a> / <a href="https://payments.posthaven.com/d5b65b01-62a9-e483-dea8-5e2bb65be278@redhat.com/raw">raw</a>)
  To: Kent Overstreet, Peter Zijlstra
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Ingo Molnar,
	Will Deacon, Boqun Feng


On 5/9/23 16:18, Kent Overstreet wrote:
<span>&gt; On Tue, May 09, 2023 at 09:31:47PM +0200, Peter Zijlstra wrote:
&gt;&gt; On Tue, May 09, 2023 at 12:56:28PM -0400, Kent Overstreet wrote:
&gt;&gt;&gt; This adds a method to tell lockdep not to check lock ordering within a
&gt;&gt;&gt; lock class - but to still check lock ordering w.r.t. other lock types.
&gt;&gt;&gt;
&gt;&gt;&gt; This is for bcachefs, where for btree node locks we have our own
&gt;&gt;&gt; deadlock avoidance strategy w.r.t. other btree node locks (cycle
&gt;&gt;&gt; detection), but we still want lockdep to check lock ordering w.r.t.
&gt;&gt;&gt; other lock types.
&gt;&gt;&gt;
&gt;&gt; ISTR you had a much nicer version of this where you gave a custom order
&gt;&gt; function -- what happend to that?
&gt; Actually, I spoke too soon; this patch and the other series with the
&gt; comparison function solve different problems.
&gt;
&gt; For bcachefs btree node locks, we don&#39;t have a defined lock ordering at
&gt; all - we do full runtime cycle detection, so we don&#39;t want lockdep
&gt; checking for self deadlock because we&#39;re handling that but we _do_ want
&gt; lockdep checking lock ordering of btree node locks w.r.t. other locks in
&gt; the system.
</span>
Maybe you can use lock_set_novalidate_class() instead.

Cheers,
Longman


<a href="#m300bc72c7328f6808bafb4f9a78a04d953029686" id="e300bc72c7328f6808bafb4f9a78a04d953029686">^</a> <a href="https://payments.posthaven.com/d5b65b01-62a9-e483-dea8-5e2bb65be278@redhat.com/">permalink</a> <a href="https://payments.posthaven.com/d5b65b01-62a9-e483-dea8-5e2bb65be278@redhat.com/raw">raw</a> <a href="https://payments.posthaven.com/d5b65b01-62a9-e483-dea8-5e2bb65be278@redhat.com/#R">reply</a>	[<a href="https://payments.posthaven.com/d5b65b01-62a9-e483-dea8-5e2bb65be278@redhat.com/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/d5b65b01-62a9-e483-dea8-5e2bb65be278@redhat.com/t/#u">nested</a>] <a href="#r300bc72c7328f6808bafb4f9a78a04d953029686">73+ messages in thread</a></pre><hr/><pre><a href="#e1a9c685bfb0e1f61d9fdca7b290974dee2c0f412" id="m1a9c685bfb0e1f61d9fdca7b290974dee2c0f412">*</a> <b>Re: [PATCH 03/32] locking/lockdep: lockdep_set_no_check_recursion()</b>
  2023-05-09 20:27       ` <a href="#m300bc72c7328f6808bafb4f9a78a04d953029686">Waiman Long</a>
<b>@ 2023-05-09 20:35         ` Kent Overstreet</b>
  2023-05-09 21:37           ` <a href="#me18094d9aa57bec6c9c8ea68aaae73d60e7c4152">Waiman Long</a>
  <a href="#r1a9c685bfb0e1f61d9fdca7b290974dee2c0f412">0 siblings, 1 reply; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 20:35 UTC (<a href="https://payments.posthaven.com/ZFquoxJn1RzWhRiI@moria.home.lan/">permalink</a> / <a href="https://payments.posthaven.com/ZFquoxJn1RzWhRiI@moria.home.lan/raw">raw</a>)
  To: Waiman Long
  Cc: Peter Zijlstra, linux-kernel, linux-fsdevel, linux-bcachefs,
	Ingo Molnar, Will Deacon, Boqun Feng

On Tue, May 09, 2023 at 04:27:46PM -0400, Waiman Long wrote:
<span>&gt; 
&gt; On 5/9/23 16:18, Kent Overstreet wrote:
&gt; &gt; On Tue, May 09, 2023 at 09:31:47PM +0200, Peter Zijlstra wrote:
&gt; &gt; &gt; On Tue, May 09, 2023 at 12:56:28PM -0400, Kent Overstreet wrote:
&gt; &gt; &gt; &gt; This adds a method to tell lockdep not to check lock ordering within a
&gt; &gt; &gt; &gt; lock class - but to still check lock ordering w.r.t. other lock types.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; This is for bcachefs, where for btree node locks we have our own
&gt; &gt; &gt; &gt; deadlock avoidance strategy w.r.t. other btree node locks (cycle
&gt; &gt; &gt; &gt; detection), but we still want lockdep to check lock ordering w.r.t.
&gt; &gt; &gt; &gt; other lock types.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; ISTR you had a much nicer version of this where you gave a custom order
&gt; &gt; &gt; function -- what happend to that?
&gt; &gt; Actually, I spoke too soon; this patch and the other series with the
&gt; &gt; comparison function solve different problems.
&gt; &gt; 
&gt; &gt; For bcachefs btree node locks, we don&#39;t have a defined lock ordering at
&gt; &gt; all - we do full runtime cycle detection, so we don&#39;t want lockdep
&gt; &gt; checking for self deadlock because we&#39;re handling that but we _do_ want
&gt; &gt; lockdep checking lock ordering of btree node locks w.r.t. other locks in
&gt; &gt; the system.
&gt; 
&gt; Maybe you can use lock_set_novalidate_class() instead.
</span>
No, we want that to go away, this is the replacement.

<a href="#m1a9c685bfb0e1f61d9fdca7b290974dee2c0f412" id="e1a9c685bfb0e1f61d9fdca7b290974dee2c0f412">^</a> <a href="https://payments.posthaven.com/ZFquoxJn1RzWhRiI@moria.home.lan/">permalink</a> <a href="https://payments.posthaven.com/ZFquoxJn1RzWhRiI@moria.home.lan/raw">raw</a> <a href="https://payments.posthaven.com/ZFquoxJn1RzWhRiI@moria.home.lan/#R">reply</a>	[<a href="https://payments.posthaven.com/ZFquoxJn1RzWhRiI@moria.home.lan/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/ZFquoxJn1RzWhRiI@moria.home.lan/t/#u">nested</a>] <a href="#r1a9c685bfb0e1f61d9fdca7b290974dee2c0f412">73+ messages in thread</a></pre><hr/><pre><a href="#efa639982c8ae26fa0750bbf9244a1d3272ef00a0" id="mfa639982c8ae26fa0750bbf9244a1d3272ef00a0">*</a> <b>Re: [PATCH 07/32] mm: Bring back vmalloc_exec</b>
  2023-05-09 16:56 ` <a href="#mcabddb3f4bded12301500ae05b7bcb26474a2aa4">[PATCH 07/32] mm: Bring back vmalloc_exec</a> Kent Overstreet
  2023-05-09 18:19   ` <a href="#m4441d42cf9b00ca0af1c77affa4e0e32fc889be6">Lorenzo Stoakes</a>
<b>@ 2023-05-09 20:46   ` Christoph Hellwig</b>
  2023-05-09 21:12     ` <a href="#m7ee439ad1f809f0b1feb30dd0b4c3de50dbe5098">Lorenzo Stoakes</a>
  2023-05-10 14:18   ` <a href="#m9cd8ae95b882e838cc1b43927a152aa3128f5b45">Christophe Leroy</a>
  2023-05-10 15:05   ` <a href="#m815f98c7cb3a865c0378ae5c190f234cf5b2c645">Johannes Thumshirn</a>
  <a href="#rfa639982c8ae26fa0750bbf9244a1d3272ef00a0">3 siblings, 1 reply; 73+ messages in thread</a>
From: Christoph Hellwig @ 2023-05-09 20:46 UTC (<a href="https://payments.posthaven.com/ZFqxEWqD19eHe353@infradead.org/">permalink</a> / <a href="https://payments.posthaven.com/ZFqxEWqD19eHe353@infradead.org/raw">raw</a>)
  To: Kent Overstreet
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Kent Overstreet,
	Andrew Morton, Uladzislau Rezki, Christoph Hellwig, linux-mm

On Tue, May 09, 2023 at 12:56:32PM -0400, Kent Overstreet wrote:
<span>&gt; From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
&gt; 
&gt; This is needed for bcachefs, which dynamically generates per-btree node
&gt; unpack functions.
</span>
No, we will never add back a way for random code allocating executable
memory in kernel space.

<a href="#mfa639982c8ae26fa0750bbf9244a1d3272ef00a0" id="efa639982c8ae26fa0750bbf9244a1d3272ef00a0">^</a> <a href="https://payments.posthaven.com/ZFqxEWqD19eHe353@infradead.org/">permalink</a> <a href="https://payments.posthaven.com/ZFqxEWqD19eHe353@infradead.org/raw">raw</a> <a href="https://payments.posthaven.com/ZFqxEWqD19eHe353@infradead.org/#R">reply</a>	[<a href="https://payments.posthaven.com/ZFqxEWqD19eHe353@infradead.org/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/ZFqxEWqD19eHe353@infradead.org/t/#u">nested</a>] <a href="#rfa639982c8ae26fa0750bbf9244a1d3272ef00a0">73+ messages in thread</a></pre><hr/><pre><a href="#e1da07d4e58363b6d528f2a64372eb80c78d0b92f" id="m1da07d4e58363b6d528f2a64372eb80c78d0b92f">*</a> <b>Re: [PATCH 16/32] MAINTAINERS: Add entry for closures</b>
  2023-05-09 16:56 ` <a href="#m766da299d420970b1b3f7ac489b0d1393f2da35d">[PATCH 16/32] MAINTAINERS: Add entry for closures</a> Kent Overstreet
  2023-05-09 17:05   ` <a href="#mbb2558522aa7d939e3d68574ae0ae4a8acfaae61">Coly Li</a>
<b>@ 2023-05-09 21:03   ` Randy Dunlap</b>
  <a href="#r1da07d4e58363b6d528f2a64372eb80c78d0b92f">1 sibling, 0 replies; 73+ messages in thread</a>
From: Randy Dunlap @ 2023-05-09 21:03 UTC (<a href="https://payments.posthaven.com/60de8092-f8a7-3d1f-26e1-eeeeebaa9044@infradead.org/">permalink</a> / <a href="https://payments.posthaven.com/60de8092-f8a7-3d1f-26e1-eeeeebaa9044@infradead.org/raw">raw</a>)
  To: Kent Overstreet, linux-kernel, linux-fsdevel, linux-bcachefs; <b>+Cc:</b> Coly Li



On 5/9/23 09:56, Kent Overstreet wrote:
<span>&gt; closures, from bcache, are async widgets with a variety of uses.
&gt; bcachefs also uses them, so they&#39;re being moved to lib/; mark them as
&gt; maintained.
&gt; 
&gt; Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
&gt; Cc: Coly Li &lt;colyli@suse.de&gt;
&gt; ---
&gt;  MAINTAINERS | 8 ++++++++
&gt;  1 file changed, 8 insertions(+)
&gt; 
&gt; diff --git a/MAINTAINERS b/MAINTAINERS
&gt; index 3fc37de3d6..5d76169140 100644
&gt; --- a/MAINTAINERS
&gt; +++ b/MAINTAINERS
&gt; @@ -5044,6 +5044,14 @@ T:	git git://git.kernel.org/pub/scm/linux/kernel/git/tip/tip.git timers/core
&gt;  F:	Documentation/devicetree/bindings/timer/
&gt;  F:	drivers/clocksource/
&gt;  
&gt; +CLOSURES:
</span>
No colon at the end of the line.

<span>&gt; +M:	Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
&gt; +L:	linux-bcachefs@vger.kernel.org
&gt; +S:	Supported
&gt; +C:	irc://irc.oftc.net/bcache
&gt; +F:	include/linux/closure.h
&gt; +F:	lib/closure.c
&gt; +
&gt;  CMPC ACPI DRIVER
&gt;  M:	Thadeu Lima de Souza Cascardo &lt;cascardo@holoscopio.com&gt;
&gt;  M:	Daniel Oliveira Nascimento &lt;don@syst.com.br&gt;
</span>
-- 
~Randy

<a href="#m1da07d4e58363b6d528f2a64372eb80c78d0b92f" id="e1da07d4e58363b6d528f2a64372eb80c78d0b92f">^</a> <a href="https://payments.posthaven.com/60de8092-f8a7-3d1f-26e1-eeeeebaa9044@infradead.org/">permalink</a> <a href="https://payments.posthaven.com/60de8092-f8a7-3d1f-26e1-eeeeebaa9044@infradead.org/raw">raw</a> <a href="https://payments.posthaven.com/60de8092-f8a7-3d1f-26e1-eeeeebaa9044@infradead.org/#R">reply</a>	[<a href="https://payments.posthaven.com/60de8092-f8a7-3d1f-26e1-eeeeebaa9044@infradead.org/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/60de8092-f8a7-3d1f-26e1-eeeeebaa9044@infradead.org/t/#u">nested</a>] <a href="#r1da07d4e58363b6d528f2a64372eb80c78d0b92f">73+ messages in thread</a></pre><hr/><pre><a href="#ebe2af624344228cc4957a1fab50b261b52fb408a" id="mbe2af624344228cc4957a1fab50b261b52fb408a">*</a> <b>Re: [PATCH 24/32] MAINTAINERS: Add entry for generic-radix-tree</b>
  2023-05-09 16:56 ` <a href="#md351e32f2d22a702c7790ac75cdff4ff5bb75be0">[PATCH 24/32] MAINTAINERS: Add entry for generic-radix-tree</a> Kent Overstreet
<b>@ 2023-05-09 21:03   ` Randy Dunlap</b>
  <a href="#rbe2af624344228cc4957a1fab50b261b52fb408a">0 siblings, 0 replies; 73+ messages in thread</a>
From: Randy Dunlap @ 2023-05-09 21:03 UTC (<a href="https://payments.posthaven.com/96edbeae-59a0-2619-1fe7-f39ecf6a9206@infradead.org/">permalink</a> / <a href="https://payments.posthaven.com/96edbeae-59a0-2619-1fe7-f39ecf6a9206@infradead.org/raw">raw</a>)
  To: Kent Overstreet, linux-kernel, linux-fsdevel, linux-bcachefs



On 5/9/23 09:56, Kent Overstreet wrote:
<span>&gt; lib/generic-radix-tree.c is a simple radix tree that supports storing
&gt; arbitrary types. Add a maintainers entry for it.
&gt; 
&gt; Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
&gt; ---
&gt;  MAINTAINERS | 7 +++++++
&gt;  1 file changed, 7 insertions(+)
&gt; 
&gt; diff --git a/MAINTAINERS b/MAINTAINERS
&gt; index 5d76169140..c550f5909e 100644
&gt; --- a/MAINTAINERS
&gt; +++ b/MAINTAINERS
&gt; @@ -8615,6 +8615,13 @@ F:	Documentation/devicetree/bindings/power/power?domain*
&gt;  F:	drivers/base/power/domain*.c
&gt;  F:	include/linux/pm_domain.h
&gt;  
&gt; +GENERIC RADIX TREE:
</span>
No colon at the end of the line.

<span>&gt; +M:	Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
&gt; +S:	Supported
&gt; +C:	irc://irc.oftc.net/bcache
&gt; +F:	include/linux/generic-radix-tree.h
&gt; +F:	lib/generic-radix-tree.c
&gt; +
&gt;  GENERIC RESISTIVE TOUCHSCREEN ADC DRIVER
&gt;  M:	Eugen Hristev &lt;eugen.hristev@microchip.com&gt;
&gt;  L:	linux-input@vger.kernel.org
</span>
-- 
~Randy

<a href="#mbe2af624344228cc4957a1fab50b261b52fb408a" id="ebe2af624344228cc4957a1fab50b261b52fb408a">^</a> <a href="https://payments.posthaven.com/96edbeae-59a0-2619-1fe7-f39ecf6a9206@infradead.org/">permalink</a> <a href="https://payments.posthaven.com/96edbeae-59a0-2619-1fe7-f39ecf6a9206@infradead.org/raw">raw</a> <a href="https://payments.posthaven.com/96edbeae-59a0-2619-1fe7-f39ecf6a9206@infradead.org/#R">reply</a>	[<a href="https://payments.posthaven.com/96edbeae-59a0-2619-1fe7-f39ecf6a9206@infradead.org/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/96edbeae-59a0-2619-1fe7-f39ecf6a9206@infradead.org/t/#u">nested</a>] <a href="#rbe2af624344228cc4957a1fab50b261b52fb408a">73+ messages in thread</a></pre><hr/><pre><a href="#e037ca88ece9bd977aa1ac140dc7dbf3b38a5cd51" id="m037ca88ece9bd977aa1ac140dc7dbf3b38a5cd51">*</a> <b>Re: [PATCH 32/32] MAINTAINERS: Add entry for bcachefs</b>
  2023-05-09 16:56 ` <a href="#m1452c4f62de7e7806f01f4afe55d78271a434b81">[PATCH 32/32] MAINTAINERS: Add entry for bcachefs</a> Kent Overstreet
<b>@ 2023-05-09 21:04   ` Randy Dunlap</b>
  2023-05-09 21:07     ` <a href="#mf115c2449f934a1cacb166cb987457dc0cc65c6b">Kent Overstreet</a>
  <a href="#r037ca88ece9bd977aa1ac140dc7dbf3b38a5cd51">0 siblings, 1 reply; 73+ messages in thread</a>
From: Randy Dunlap @ 2023-05-09 21:04 UTC (<a href="https://payments.posthaven.com/08fed8bc-0a15-2d13-81d3-2a81408457ae@infradead.org/">permalink</a> / <a href="https://payments.posthaven.com/08fed8bc-0a15-2d13-81d3-2a81408457ae@infradead.org/raw">raw</a>)
  To: Kent Overstreet, linux-kernel, linux-fsdevel, linux-bcachefs



On 5/9/23 09:56, Kent Overstreet wrote:
<span>&gt; bcachefs is a new copy-on-write filesystem; add a MAINTAINERS entry for
&gt; it.
&gt; 
&gt; Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
&gt; ---
&gt;  MAINTAINERS | 7 +++++++
&gt;  1 file changed, 7 insertions(+)
&gt; 
&gt; diff --git a/MAINTAINERS b/MAINTAINERS
&gt; index dbf3c33c31..0ac2b432f0 100644
&gt; --- a/MAINTAINERS
&gt; +++ b/MAINTAINERS
&gt; @@ -3509,6 +3509,13 @@ W:	<a href="http://bcache.evilpiepirate.org">http://bcache.evilpiepirate.org</a>
&gt;  C:	irc://irc.oftc.net/bcache
&gt;  F:	drivers/md/bcache/
&gt;  
&gt; +BCACHEFS:
</span>
No colon at the end of the line.


<span>&gt; +M:	Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
&gt; +L:	linux-bcachefs@vger.kernel.org
&gt; +S:	Supported
&gt; +C:	irc://irc.oftc.net/bcache
&gt; +F:	fs/bcachefs/
&gt; +
&gt;  BDISP ST MEDIA DRIVER
&gt;  M:	Fabien Dessenne &lt;fabien.dessenne@foss.st.com&gt;
&gt;  L:	linux-media@vger.kernel.org
</span>
-- 
~Randy

<a href="#m037ca88ece9bd977aa1ac140dc7dbf3b38a5cd51" id="e037ca88ece9bd977aa1ac140dc7dbf3b38a5cd51">^</a> <a href="https://payments.posthaven.com/08fed8bc-0a15-2d13-81d3-2a81408457ae@infradead.org/">permalink</a> <a href="https://payments.posthaven.com/08fed8bc-0a15-2d13-81d3-2a81408457ae@infradead.org/raw">raw</a> <a href="https://payments.posthaven.com/08fed8bc-0a15-2d13-81d3-2a81408457ae@infradead.org/#R">reply</a>	[<a href="https://payments.posthaven.com/08fed8bc-0a15-2d13-81d3-2a81408457ae@infradead.org/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/08fed8bc-0a15-2d13-81d3-2a81408457ae@infradead.org/t/#u">nested</a>] <a href="#r037ca88ece9bd977aa1ac140dc7dbf3b38a5cd51">73+ messages in thread</a></pre><hr/><pre><a href="#ef115c2449f934a1cacb166cb987457dc0cc65c6b" id="mf115c2449f934a1cacb166cb987457dc0cc65c6b">*</a> <b>Re: [PATCH 32/32] MAINTAINERS: Add entry for bcachefs</b>
  2023-05-09 21:04   ` <a href="#m037ca88ece9bd977aa1ac140dc7dbf3b38a5cd51">Randy Dunlap</a>
<b>@ 2023-05-09 21:07     ` Kent Overstreet</b>
  <a href="#rf115c2449f934a1cacb166cb987457dc0cc65c6b">0 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 21:07 UTC (<a href="https://payments.posthaven.com/ZFq19bA8MgDx%2Fpzn@moria.home.lan/">permalink</a> / <a href="https://payments.posthaven.com/ZFq19bA8MgDx%2Fpzn@moria.home.lan/raw">raw</a>)
  To: Randy Dunlap; <b>+Cc:</b> linux-kernel, linux-fsdevel, linux-bcachefs

On Tue, May 09, 2023 at 02:04:00PM -0700, Randy Dunlap wrote:
<span>&gt; 
&gt; 
&gt; On 5/9/23 09:56, Kent Overstreet wrote:
&gt; &gt; bcachefs is a new copy-on-write filesystem; add a MAINTAINERS entry for
&gt; &gt; it.
&gt; &gt; 
&gt; &gt; Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
&gt; &gt; ---
&gt; &gt;  MAINTAINERS | 7 +++++++
&gt; &gt;  1 file changed, 7 insertions(+)
&gt; &gt; 
&gt; &gt; diff --git a/MAINTAINERS b/MAINTAINERS
&gt; &gt; index dbf3c33c31..0ac2b432f0 100644
&gt; &gt; --- a/MAINTAINERS
&gt; &gt; +++ b/MAINTAINERS
&gt; &gt; @@ -3509,6 +3509,13 @@ W:	<a href="http://bcache.evilpiepirate.org">http://bcache.evilpiepirate.org</a>
&gt; &gt;  C:	irc://irc.oftc.net/bcache
&gt; &gt;  F:	drivers/md/bcache/
&gt; &gt;  
&gt; &gt; +BCACHEFS:
&gt; 
&gt; No colon at the end of the line.
</span>
Thanks, updated.

<a href="#mf115c2449f934a1cacb166cb987457dc0cc65c6b" id="ef115c2449f934a1cacb166cb987457dc0cc65c6b">^</a> <a href="https://payments.posthaven.com/ZFq19bA8MgDx%2Fpzn@moria.home.lan/">permalink</a> <a href="https://payments.posthaven.com/ZFq19bA8MgDx%2Fpzn@moria.home.lan/raw">raw</a> <a href="https://payments.posthaven.com/ZFq19bA8MgDx%2Fpzn@moria.home.lan/#R">reply</a>	[<a href="https://payments.posthaven.com/ZFq19bA8MgDx%2Fpzn@moria.home.lan/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/ZFq19bA8MgDx%2Fpzn@moria.home.lan/t/#u">nested</a>] <a href="#rf115c2449f934a1cacb166cb987457dc0cc65c6b">73+ messages in thread</a></pre><hr/><pre><a href="#e7ee439ad1f809f0b1feb30dd0b4c3de50dbe5098" id="m7ee439ad1f809f0b1feb30dd0b4c3de50dbe5098">*</a> <b>Re: [PATCH 07/32] mm: Bring back vmalloc_exec</b>
  2023-05-09 20:46   ` <a href="#mfa639982c8ae26fa0750bbf9244a1d3272ef00a0">Christoph Hellwig</a>
<b>@ 2023-05-09 21:12     ` Lorenzo Stoakes</b>
  2023-05-09 21:29       ` <a href="#mde4acd2516e5034c6dd79bff2c54932802f8c9b5">Kent Overstreet</a>
  2023-05-09 21:43       ` <a href="#mf4d4ed092002ad0a50c9a5ce05c638b1d6e8987c">Darrick J. Wong</a>
  <a href="#r7ee439ad1f809f0b1feb30dd0b4c3de50dbe5098">0 siblings, 2 replies; 73+ messages in thread</a>
From: Lorenzo Stoakes @ 2023-05-09 21:12 UTC (<a href="https://payments.posthaven.com/ZFq3SdSBJ_LWsOgd@murray/">permalink</a> / <a href="https://payments.posthaven.com/ZFq3SdSBJ_LWsOgd@murray/raw">raw</a>)
  To: Christoph Hellwig
  Cc: Kent Overstreet, linux-kernel, linux-fsdevel, linux-bcachefs,
	Kent Overstreet, Andrew Morton, Uladzislau Rezki, linux-mm

On Tue, May 09, 2023 at 01:46:09PM -0700, Christoph Hellwig wrote:
<span>&gt; On Tue, May 09, 2023 at 12:56:32PM -0400, Kent Overstreet wrote:
&gt; &gt; From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
&gt; &gt;
&gt; &gt; This is needed for bcachefs, which dynamically generates per-btree node
&gt; &gt; unpack functions.
&gt;
&gt; No, we will never add back a way for random code allocating executable
&gt; memory in kernel space.
</span>
Yeah I think I glossed over this aspect a bit as it looks ostensibly like simply
reinstating a helper function because the code is now used in more than one
place (at lsf/mm so a little distracted :)

But it being exported is a problem. Perhaps there&#39;s another way of acheving the
same aim without having to do so?

<a href="#m7ee439ad1f809f0b1feb30dd0b4c3de50dbe5098" id="e7ee439ad1f809f0b1feb30dd0b4c3de50dbe5098">^</a> <a href="https://payments.posthaven.com/ZFq3SdSBJ_LWsOgd@murray/">permalink</a> <a href="https://payments.posthaven.com/ZFq3SdSBJ_LWsOgd@murray/raw">raw</a> <a href="https://payments.posthaven.com/ZFq3SdSBJ_LWsOgd@murray/#R">reply</a>	[<a href="https://payments.posthaven.com/ZFq3SdSBJ_LWsOgd@murray/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/ZFq3SdSBJ_LWsOgd@murray/t/#u">nested</a>] <a href="#r7ee439ad1f809f0b1feb30dd0b4c3de50dbe5098">73+ messages in thread</a></pre><hr/><pre><a href="#ede4acd2516e5034c6dd79bff2c54932802f8c9b5" id="mde4acd2516e5034c6dd79bff2c54932802f8c9b5">*</a> <b>Re: [PATCH 07/32] mm: Bring back vmalloc_exec</b>
  2023-05-09 21:12     ` <a href="#m7ee439ad1f809f0b1feb30dd0b4c3de50dbe5098">Lorenzo Stoakes</a>
<b>@ 2023-05-09 21:29       ` Kent Overstreet</b>
  2023-05-10  6:48         ` <a href="#mc945d16c820fcbc010bcdbf7c73ae1f57d502a07">Eric Biggers</a>
  2023-05-10 11:56         ` <a href="#m07f44d5a1a85f6f7e2f92cf648aa8876fb10ab60">David Laight</a>
  2023-05-09 21:43       ` <a href="#mf4d4ed092002ad0a50c9a5ce05c638b1d6e8987c">Darrick J. Wong</a>
  <a href="#rde4acd2516e5034c6dd79bff2c54932802f8c9b5">1 sibling, 2 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 21:29 UTC (<a href="https://payments.posthaven.com/ZFq7JhrhyrMTNfd%2F@moria.home.lan/">permalink</a> / <a href="https://payments.posthaven.com/ZFq7JhrhyrMTNfd%2F@moria.home.lan/raw">raw</a>)
  To: Lorenzo Stoakes
  Cc: Christoph Hellwig, linux-kernel, linux-fsdevel, linux-bcachefs,
	Kent Overstreet, Andrew Morton, Uladzislau Rezki, linux-mm

On Tue, May 09, 2023 at 02:12:41PM -0700, Lorenzo Stoakes wrote:
<span>&gt; On Tue, May 09, 2023 at 01:46:09PM -0700, Christoph Hellwig wrote:
&gt; &gt; On Tue, May 09, 2023 at 12:56:32PM -0400, Kent Overstreet wrote:
&gt; &gt; &gt; From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
&gt; &gt; &gt;
&gt; &gt; &gt; This is needed for bcachefs, which dynamically generates per-btree node
&gt; &gt; &gt; unpack functions.
&gt; &gt;
&gt; &gt; No, we will never add back a way for random code allocating executable
&gt; &gt; memory in kernel space.
&gt; 
&gt; Yeah I think I glossed over this aspect a bit as it looks ostensibly like simply
&gt; reinstating a helper function because the code is now used in more than one
&gt; place (at lsf/mm so a little distracted :)
&gt; 
&gt; But it being exported is a problem. Perhaps there&#39;s another way of acheving the
&gt; same aim without having to do so?
</span>
None that I see.

The background is that bcachefs generates a per btree node unpack
function, based on the packed format for that btree node, for unpacking
keys within that node. The unpack function is only ~50 bytes, and for
locality we want it to be located with the btree node&#39;s other in-memory
lookup tables so they can be prefetched all at once.

Here&#39;s the codegen:

<a href="https://evilpiepirate.org/git/bcachefs.git/tree/fs/bcachefs/bkey.c#n727">https://evilpiepirate.org/git/bcachefs.git/tree/fs/bcachefs/bkey.c#n727</a>

<a href="#mde4acd2516e5034c6dd79bff2c54932802f8c9b5" id="ede4acd2516e5034c6dd79bff2c54932802f8c9b5">^</a> <a href="https://payments.posthaven.com/ZFq7JhrhyrMTNfd%2F@moria.home.lan/">permalink</a> <a href="https://payments.posthaven.com/ZFq7JhrhyrMTNfd%2F@moria.home.lan/raw">raw</a> <a href="https://payments.posthaven.com/ZFq7JhrhyrMTNfd%2F@moria.home.lan/#R">reply</a>	[<a href="https://payments.posthaven.com/ZFq7JhrhyrMTNfd%2F@moria.home.lan/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/ZFq7JhrhyrMTNfd%2F@moria.home.lan/t/#u">nested</a>] <a href="#rde4acd2516e5034c6dd79bff2c54932802f8c9b5">73+ messages in thread</a></pre><hr/><pre><a href="#ee18094d9aa57bec6c9c8ea68aaae73d60e7c4152" id="me18094d9aa57bec6c9c8ea68aaae73d60e7c4152">*</a> <b>Re: [PATCH 03/32] locking/lockdep: lockdep_set_no_check_recursion()</b>
  2023-05-09 20:35         ` <a href="#m1a9c685bfb0e1f61d9fdca7b290974dee2c0f412">Kent Overstreet</a>
<b>@ 2023-05-09 21:37           ` Waiman Long</b>
  <a href="#re18094d9aa57bec6c9c8ea68aaae73d60e7c4152">0 siblings, 0 replies; 73+ messages in thread</a>
From: Waiman Long @ 2023-05-09 21:37 UTC (<a href="https://payments.posthaven.com/a7fcd53a-7680-49c5-dd93-489d75126c8d@redhat.com/">permalink</a> / <a href="https://payments.posthaven.com/a7fcd53a-7680-49c5-dd93-489d75126c8d@redhat.com/raw">raw</a>)
  To: Kent Overstreet
  Cc: Peter Zijlstra, linux-kernel, linux-fsdevel, linux-bcachefs,
	Ingo Molnar, Will Deacon, Boqun Feng

On 5/9/23 16:35, Kent Overstreet wrote:
<span>&gt; On Tue, May 09, 2023 at 04:27:46PM -0400, Waiman Long wrote:
&gt;&gt; On 5/9/23 16:18, Kent Overstreet wrote:
&gt;&gt;&gt; On Tue, May 09, 2023 at 09:31:47PM +0200, Peter Zijlstra wrote:
&gt;&gt;&gt;&gt; On Tue, May 09, 2023 at 12:56:28PM -0400, Kent Overstreet wrote:
&gt;&gt;&gt;&gt;&gt; This adds a method to tell lockdep not to check lock ordering within a
&gt;&gt;&gt;&gt;&gt; lock class - but to still check lock ordering w.r.t. other lock types.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; This is for bcachefs, where for btree node locks we have our own
&gt;&gt;&gt;&gt;&gt; deadlock avoidance strategy w.r.t. other btree node locks (cycle
&gt;&gt;&gt;&gt;&gt; detection), but we still want lockdep to check lock ordering w.r.t.
&gt;&gt;&gt;&gt;&gt; other lock types.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; ISTR you had a much nicer version of this where you gave a custom order
&gt;&gt;&gt;&gt; function -- what happend to that?
&gt;&gt;&gt; Actually, I spoke too soon; this patch and the other series with the
&gt;&gt;&gt; comparison function solve different problems.
&gt;&gt;&gt;
&gt;&gt;&gt; For bcachefs btree node locks, we don&#39;t have a defined lock ordering at
&gt;&gt;&gt; all - we do full runtime cycle detection, so we don&#39;t want lockdep
&gt;&gt;&gt; checking for self deadlock because we&#39;re handling that but we _do_ want
&gt;&gt;&gt; lockdep checking lock ordering of btree node locks w.r.t. other locks in
&gt;&gt;&gt; the system.
&gt;&gt; Maybe you can use lock_set_novalidate_class() instead.
&gt; No, we want that to go away, this is the replacement.
</span>
OK, you can mention that in the commit log then.

Cheers,
Longman


<a href="#me18094d9aa57bec6c9c8ea68aaae73d60e7c4152" id="ee18094d9aa57bec6c9c8ea68aaae73d60e7c4152">^</a> <a href="https://payments.posthaven.com/a7fcd53a-7680-49c5-dd93-489d75126c8d@redhat.com/">permalink</a> <a href="https://payments.posthaven.com/a7fcd53a-7680-49c5-dd93-489d75126c8d@redhat.com/raw">raw</a> <a href="https://payments.posthaven.com/a7fcd53a-7680-49c5-dd93-489d75126c8d@redhat.com/#R">reply</a>	[<a href="https://payments.posthaven.com/a7fcd53a-7680-49c5-dd93-489d75126c8d@redhat.com/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/a7fcd53a-7680-49c5-dd93-489d75126c8d@redhat.com/t/#u">nested</a>] <a href="#re18094d9aa57bec6c9c8ea68aaae73d60e7c4152">73+ messages in thread</a></pre><hr/><pre><a href="#ef4d4ed092002ad0a50c9a5ce05c638b1d6e8987c" id="mf4d4ed092002ad0a50c9a5ce05c638b1d6e8987c">*</a> <b>Re: [PATCH 07/32] mm: Bring back vmalloc_exec</b>
  2023-05-09 21:12     ` <a href="#m7ee439ad1f809f0b1feb30dd0b4c3de50dbe5098">Lorenzo Stoakes</a>
  2023-05-09 21:29       ` <a href="#mde4acd2516e5034c6dd79bff2c54932802f8c9b5">Kent Overstreet</a>
<b>@ 2023-05-09 21:43       ` Darrick J. Wong</b>
  2023-05-09 21:54         ` <a href="#mb89bc221ea6ac376fb784f85f11766b68e139a44">Kent Overstreet</a>
  <a href="#rf4d4ed092002ad0a50c9a5ce05c638b1d6e8987c">1 sibling, 1 reply; 73+ messages in thread</a>
From: Darrick J. Wong @ 2023-05-09 21:43 UTC (<a href="https://payments.posthaven.com/20230509214319.GA858791@frogsfrogsfrogs/">permalink</a> / <a href="https://payments.posthaven.com/20230509214319.GA858791@frogsfrogsfrogs/raw">raw</a>)
  To: Lorenzo Stoakes
  Cc: Christoph Hellwig, Kent Overstreet, linux-kernel, linux-fsdevel,
	linux-bcachefs, Kent Overstreet, Andrew Morton, Uladzislau Rezki,
	linux-mm

On Tue, May 09, 2023 at 02:12:41PM -0700, Lorenzo Stoakes wrote:
<span>&gt; On Tue, May 09, 2023 at 01:46:09PM -0700, Christoph Hellwig wrote:
&gt; &gt; On Tue, May 09, 2023 at 12:56:32PM -0400, Kent Overstreet wrote:
&gt; &gt; &gt; From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
&gt; &gt; &gt;
&gt; &gt; &gt; This is needed for bcachefs, which dynamically generates per-btree node
&gt; &gt; &gt; unpack functions.
&gt; &gt;
&gt; &gt; No, we will never add back a way for random code allocating executable
&gt; &gt; memory in kernel space.
&gt; 
&gt; Yeah I think I glossed over this aspect a bit as it looks ostensibly like simply
&gt; reinstating a helper function because the code is now used in more than one
&gt; place (at lsf/mm so a little distracted :)
&gt; 
&gt; But it being exported is a problem. Perhaps there&#39;s another way of acheving the
&gt; same aim without having to do so?
</span>
I already trolled Kent with this on IRC, but for the parts of bcachefs
that want better assembly code than whatever gcc generates from the C
source, could you compile code to BPF and then let the BPF JIT engines
turn that into machine code for you?

(also distracted by LSFMM)

--D

<a href="#mf4d4ed092002ad0a50c9a5ce05c638b1d6e8987c" id="ef4d4ed092002ad0a50c9a5ce05c638b1d6e8987c">^</a> <a href="https://payments.posthaven.com/20230509214319.GA858791@frogsfrogsfrogs/">permalink</a> <a href="https://payments.posthaven.com/20230509214319.GA858791@frogsfrogsfrogs/raw">raw</a> <a href="https://payments.posthaven.com/20230509214319.GA858791@frogsfrogsfrogs/#R">reply</a>	[<a href="https://payments.posthaven.com/20230509214319.GA858791@frogsfrogsfrogs/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230509214319.GA858791@frogsfrogsfrogs/t/#u">nested</a>] <a href="#rf4d4ed092002ad0a50c9a5ce05c638b1d6e8987c">73+ messages in thread</a></pre><hr/><pre><a href="#eb89bc221ea6ac376fb784f85f11766b68e139a44" id="mb89bc221ea6ac376fb784f85f11766b68e139a44">*</a> <b>Re: [PATCH 07/32] mm: Bring back vmalloc_exec</b>
  2023-05-09 21:43       ` <a href="#mf4d4ed092002ad0a50c9a5ce05c638b1d6e8987c">Darrick J. Wong</a>
<b>@ 2023-05-09 21:54         ` Kent Overstreet</b>
  2023-05-11  5:33           ` <a href="#m97f5977d75b7ce418668cecd61d701579259c227">Theodore Ts&#39;o</a>
  <a href="#rb89bc221ea6ac376fb784f85f11766b68e139a44">0 siblings, 1 reply; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-09 21:54 UTC (<a href="https://payments.posthaven.com/ZFrBEsjrfseCUzqV@moria.home.lan/">permalink</a> / <a href="https://payments.posthaven.com/ZFrBEsjrfseCUzqV@moria.home.lan/raw">raw</a>)
  To: Darrick J. Wong
  Cc: Lorenzo Stoakes, Christoph Hellwig, linux-kernel, linux-fsdevel,
	linux-bcachefs, Kent Overstreet, Andrew Morton, Uladzislau Rezki,
	linux-mm

On Tue, May 09, 2023 at 02:43:19PM -0700, Darrick J. Wong wrote:
<span>&gt; On Tue, May 09, 2023 at 02:12:41PM -0700, Lorenzo Stoakes wrote:
&gt; &gt; On Tue, May 09, 2023 at 01:46:09PM -0700, Christoph Hellwig wrote:
&gt; &gt; &gt; On Tue, May 09, 2023 at 12:56:32PM -0400, Kent Overstreet wrote:
&gt; &gt; &gt; &gt; From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; This is needed for bcachefs, which dynamically generates per-btree node
&gt; &gt; &gt; &gt; unpack functions.
&gt; &gt; &gt;
&gt; &gt; &gt; No, we will never add back a way for random code allocating executable
&gt; &gt; &gt; memory in kernel space.
&gt; &gt; 
&gt; &gt; Yeah I think I glossed over this aspect a bit as it looks ostensibly like simply
&gt; &gt; reinstating a helper function because the code is now used in more than one
&gt; &gt; place (at lsf/mm so a little distracted :)
&gt; &gt; 
&gt; &gt; But it being exported is a problem. Perhaps there&#39;s another way of acheving the
&gt; &gt; same aim without having to do so?
&gt; 
&gt; I already trolled Kent with this on IRC, but for the parts of bcachefs
&gt; that want better assembly code than whatever gcc generates from the C
&gt; source, could you compile code to BPF and then let the BPF JIT engines
&gt; turn that into machine code for you?
</span>
It&#39;s an intriguing idea, but it&#39;d be a _lot_ of work and this is old
code that&#39;s never had a single bug - I&#39;m not in a hurry to rewrite it.

And there would still be the issue that we&#39;ve still got lots of little
unpack functions that go with other tables; we can&#39;t just burn a full
page per unpack function, that would waste way too much memory, and if
we put them together then we&#39;re stuck writing a whole nother allocator
- nope, and then we&#39;re also mucking with the memory layout of the data
structures used in the very hottest paths in the filesystem - I&#39;m very
wary of introducing performance regressions there.

I think it&#39;d be much more practical to find some way of making
vmalloc_exec() more palatable. What are the exact concerns?

<a href="#mb89bc221ea6ac376fb784f85f11766b68e139a44" id="eb89bc221ea6ac376fb784f85f11766b68e139a44">^</a> <a href="https://payments.posthaven.com/ZFrBEsjrfseCUzqV@moria.home.lan/">permalink</a> <a href="https://payments.posthaven.com/ZFrBEsjrfseCUzqV@moria.home.lan/raw">raw</a> <a href="https://payments.posthaven.com/ZFrBEsjrfseCUzqV@moria.home.lan/#R">reply</a>	[<a href="https://payments.posthaven.com/ZFrBEsjrfseCUzqV@moria.home.lan/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/ZFrBEsjrfseCUzqV@moria.home.lan/t/#u">nested</a>] <a href="#rb89bc221ea6ac376fb784f85f11766b68e139a44">73+ messages in thread</a></pre><hr/><pre><a href="#e613d136f0d8a1ed3d18224d73c012f467295aa60" id="m613d136f0d8a1ed3d18224d73c012f467295aa60">*</a> <b>Re: [PATCH 06/32] sched: Add task_struct-&gt;faults_disabled_mapping</b>
  2023-05-09 16:56 ` <a href="#mc6f62d46382370e1205be68249bfa6f9a8f7f35c">[PATCH 06/32] sched: Add task_struct-&gt;faults_disabled_mapping</a> Kent Overstreet
<b>@ 2023-05-10  1:07   ` Jan Kara</b>
  2023-05-10  6:18     ` <a href="#m7cce75af26bf200b94dfafb53ca15f2f2b12f1de">Kent Overstreet</a>
  <a href="#r613d136f0d8a1ed3d18224d73c012f467295aa60">0 siblings, 1 reply; 73+ messages in thread</a>
From: Jan Kara @ 2023-05-10  1:07 UTC (<a href="https://payments.posthaven.com/20230510010737.heniyuxazlprrbd6@quack3/">permalink</a> / <a href="https://payments.posthaven.com/20230510010737.heniyuxazlprrbd6@quack3/raw">raw</a>)
  To: Kent Overstreet
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Kent Overstreet,
	Jan Kara, Darrick J . Wong

On Tue 09-05-23 12:56:31, Kent Overstreet wrote:
<span>&gt; From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
&gt; 
&gt; This is used by bcachefs to fix a page cache coherency issue with
&gt; O_DIRECT writes.
&gt; 
&gt; Also relevant: mapping-&gt;invalidate_lock, see below.
&gt; 
&gt; O_DIRECT writes (and other filesystem operations that modify file data
&gt; while bypassing the page cache) need to shoot down ranges of the page
&gt; cache - and additionally, need locking to prevent those pages from
&gt; pulled back in.
&gt; 
&gt; But O_DIRECT writes invoke the page fault handler (via get_user_pages),
&gt; and the page fault handler will need to take that same lock - this is a
&gt; classic recursive deadlock if userspace has mmaped the file they&#39;re DIO
&gt; writing to and uses those pages for the buffer to write from, and it&#39;s a
&gt; lock ordering deadlock in general.
&gt; 
&gt; Thus we need a way to signal from the dio code to the page fault handler
&gt; when we already are holding the pagecache add lock on an address space -
&gt; this patch just adds a member to task_struct for this purpose. For now
&gt; only bcachefs is implementing this locking, though it may be moved out
&gt; of bcachefs and made available to other filesystems in the future.
</span>
It would be nice to have at least a link to the code that&#39;s actually using
the field you are adding.

Also I think we were already through this discussion [1] and we ended up
agreeing that your scheme actually solves only the AA deadlock but a
malicious userspace can easily create AB BA deadlock by running direct IO
to file A using mapped file B as a buffer *and* direct IO to file B using
mapped file A as a buffer.

[1] <a href="https://lore.kernel.org/all/20191218124052.GB19387@quack2.suse.cz">https://lore.kernel.org/all/20191218124052.GB19387@quack2.suse.cz</a>

<span>&gt; ---------------------------------
&gt; 
&gt; The closest current VFS equivalent is mapping-&gt;invalidate_lock, which
&gt; comes from XFS. However, it&#39;s not used by direct IO.  Instead, direct IO
&gt; paths shoot down the page cache twice - before starting the IO and at
&gt; the end, and they&#39;re still technically racy w.r.t. page cache coherency.
&gt; 
&gt; This is a more complete approach: in the future we might consider
&gt; replacing mapping-&gt;invalidate_lock with the bcachefs code.
</span>
Yes, and this is because we never provided 100% consistent buffered VS
direct IO behavior on the same file exactly because we never found the
complexity worth the usefulness...

								Honza

<span>&gt; 
&gt; Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
&gt; Cc: Jan Kara &lt;jack@suse.cz&gt;
&gt; Cc: Darrick J. Wong &lt;djwong@kernel.org&gt;
&gt; Cc: linux-fsdevel@vger.kernel.org
&gt; ---
&gt;  include/linux/sched.h | 1 +
&gt;  init/init_task.c      | 1 +
&gt;  2 files changed, 2 insertions(+)
&gt; 
&gt; diff --git a/include/linux/sched.h b/include/linux/sched.h
&gt; index 63d242164b..f2a56f64f7 100644
&gt; --- a/include/linux/sched.h
&gt; +++ b/include/linux/sched.h
&gt; @@ -869,6 +869,7 @@ struct task_struct {
&gt;  
&gt;  	struct mm_struct		*mm;
&gt;  	struct mm_struct		*active_mm;
&gt; +	struct address_space		*faults_disabled_mapping;
&gt;  
&gt;  	int				exit_state;
&gt;  	int				exit_code;
&gt; diff --git a/init/init_task.c b/init/init_task.c
&gt; index ff6c4b9bfe..f703116e05 100644
&gt; --- a/init/init_task.c
&gt; +++ b/init/init_task.c
&gt; @@ -85,6 +85,7 @@ struct task_struct init_task
&gt;  	.nr_cpus_allowed= NR_CPUS,
&gt;  	.mm		= NULL,
&gt;  	.active_mm	= &amp;init_mm,
&gt; +	.faults_disabled_mapping = NULL,
&gt;  	.restart_block	= {
&gt;  		.fn = do_no_restart_syscall,
&gt;  	},
&gt; -- 
&gt; 2.40.1
&gt; 
</span>-- 
Jan Kara &lt;jack@suse.com&gt;
SUSE Labs, CR

<a href="#m613d136f0d8a1ed3d18224d73c012f467295aa60" id="e613d136f0d8a1ed3d18224d73c012f467295aa60">^</a> <a href="https://payments.posthaven.com/20230510010737.heniyuxazlprrbd6@quack3/">permalink</a> <a href="https://payments.posthaven.com/20230510010737.heniyuxazlprrbd6@quack3/raw">raw</a> <a href="https://payments.posthaven.com/20230510010737.heniyuxazlprrbd6@quack3/#R">reply</a>	[<a href="https://payments.posthaven.com/20230510010737.heniyuxazlprrbd6@quack3/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230510010737.heniyuxazlprrbd6@quack3/t/#u">nested</a>] <a href="#r613d136f0d8a1ed3d18224d73c012f467295aa60">73+ messages in thread</a></pre><hr/><pre><a href="#e38a9689ff588cd1e3a641de6183a3213bb0a103b" id="m38a9689ff588cd1e3a641de6183a3213bb0a103b">*</a> <b>Re: [PATCH 15/32] bcache: move closures to lib/</b>
  2023-05-09 16:56 ` <a href="#m808e33cd7146a6cf25568dd0527029deacdc1f57">[PATCH 15/32] bcache: move closures to lib/</a> Kent Overstreet
<b>@ 2023-05-10  1:10   ` Randy Dunlap</b>
  <a href="#r38a9689ff588cd1e3a641de6183a3213bb0a103b">0 siblings, 0 replies; 73+ messages in thread</a>
From: Randy Dunlap @ 2023-05-10  1:10 UTC (<a href="https://payments.posthaven.com/efa69d65-d5bd-b3b8-14e0-323cfdd67b62@infradead.org/">permalink</a> / <a href="https://payments.posthaven.com/efa69d65-d5bd-b3b8-14e0-323cfdd67b62@infradead.org/raw">raw</a>)
  To: Kent Overstreet, linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Coly Li



On 5/9/23 09:56, Kent Overstreet wrote:
<span>&gt; diff --git a/lib/Kconfig.debug b/lib/Kconfig.debug
&gt; index 39d1d93164..3dba7a9aff 100644
&gt; --- a/lib/Kconfig.debug
&gt; +++ b/lib/Kconfig.debug
&gt; @@ -1618,6 +1618,15 @@ config DEBUG_NOTIFIERS
&gt;  	  This is a relatively cheap check but if you care about maximum
&gt;  	  performance, say N.
&gt;  
&gt; +config DEBUG_CLOSURES
&gt; +	bool &#34;Debug closures (bcache async widgits)&#34;
&gt; +	depends on CLOSURES
&gt; +	select DEBUG_FS
&gt; +	help
&gt; +	Keeps all active closures in a linked list and provides a debugfs
&gt; +	interface to list them, which makes it possible to see asynchronous
&gt; +	operations that get stuck.
</span>
According to coding-style.rst, the help text (3 lines above) should be
indented with 2 additional spaces.

<span>&gt; +	help
&gt; +	  Keeps all active closures in a linked list and provides a debugfs
&gt; +	  interface to list them, which makes it possible to see asynchronous
&gt; +	  operations that get stuck.
</span>
-- 
~Randy

<a href="#m38a9689ff588cd1e3a641de6183a3213bb0a103b" id="e38a9689ff588cd1e3a641de6183a3213bb0a103b">^</a> <a href="https://payments.posthaven.com/efa69d65-d5bd-b3b8-14e0-323cfdd67b62@infradead.org/">permalink</a> <a href="https://payments.posthaven.com/efa69d65-d5bd-b3b8-14e0-323cfdd67b62@infradead.org/raw">raw</a> <a href="https://payments.posthaven.com/efa69d65-d5bd-b3b8-14e0-323cfdd67b62@infradead.org/#R">reply</a>	[<a href="https://payments.posthaven.com/efa69d65-d5bd-b3b8-14e0-323cfdd67b62@infradead.org/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/efa69d65-d5bd-b3b8-14e0-323cfdd67b62@infradead.org/t/#u">nested</a>] <a href="#r38a9689ff588cd1e3a641de6183a3213bb0a103b">73+ messages in thread</a></pre><hr/><pre><a href="#e5828ea4e5b889cfc135329e431ec2be9179194ba" id="m5828ea4e5b889cfc135329e431ec2be9179194ba">*</a> <b>Re: [PATCH 23/32] iov_iter: copy_folio_from_iter_atomic()</b>
  2023-05-09 16:56 ` <a href="#mb432faef6999d4df09b333f1d1842e1989b7be4d">[PATCH 23/32] iov_iter: copy_folio_from_iter_atomic()</a> Kent Overstreet
<b>@ 2023-05-10  2:20   ` kernel test robot</b>
  2023-05-11  2:08   ` <a href="#m2be1ce6189d96241cbd4b322f136ff0da35e00ad">kernel test robot</a>
  <a href="#r5828ea4e5b889cfc135329e431ec2be9179194ba">1 sibling, 0 replies; 73+ messages in thread</a>
From: kernel test robot @ 2023-05-10  2:20 UTC (<a href="https://payments.posthaven.com/202305101003.uncpRKqA-lkp@intel.com/">permalink</a> / <a href="https://payments.posthaven.com/202305101003.uncpRKqA-lkp@intel.com/raw">raw</a>)
  To: Kent Overstreet, linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: llvm, oe-kbuild-all, Kent Overstreet, Alexander Viro, Matthew Wilcox

Hi Kent,

kernel test robot noticed the following build warnings:

[auto build test WARNING on tip/locking/core]
[cannot apply to axboe-block/for-next akpm-mm/mm-everything kdave/for-next linus/master v6.4-rc1 next-20230509]
[If your patch is applied to the wrong git tree, kindly drop us a note.
And when submitting patch, we suggest to use &#39;--base&#39; as documented in
<a href="https://git-scm.com/docs/git-format-patch#_base_tree_information">https://git-scm.com/docs/git-format-patch#_base_tree_information</a>]

url:    <a href="https://github.com/intel-lab-lkp/linux/commits/Kent-Overstreet/Compiler-Attributes-add-__flatten/20230510-010302">https://github.com/intel-lab-lkp/linux/commits/Kent-Overstreet/Compiler-Attributes-add-__flatten/20230510-010302</a>
base:   tip/locking/core
patch link:    <a href="https://lore.kernel.org/r/20230509165657.1735798-24-kent.overstreet%40linux.dev">https://lore.kernel.org/r/20230509165657.1735798-24-kent.overstreet%40linux.dev</a>
patch subject: [PATCH 23/32] iov_iter: copy_folio_from_iter_atomic()
config: i386-randconfig-a002 (<a href="https://download.01.org/0day-ci/archive/20230510/202305101003.uncpRKqA-lkp@intel.com/config">https://download.01.org/0day-ci/archive/20230510/202305101003.uncpRKqA-lkp@intel.com/config</a>)
compiler: clang version 14.0.6 (<a href="https://github.com/llvm/llvm-project">https://github.com/llvm/llvm-project</a> f28c006a5895fc0e329fe15fead81e37457cb1d1)
reproduce (this is a W=1 build):
        wget <a href="https://raw.githubusercontent.com/intel/lkp-tests/master/sbin/make.cross">https://raw.githubusercontent.com/intel/lkp-tests/master/sbin/make.cross</a> -O ~/bin/make.cross
        chmod +x ~/bin/make.cross
        # <a href="https://github.com/intel-lab-lkp/linux/commit/0e5d4229f5e7671dabba56ea36583b1ca20a9a18">https://github.com/intel-lab-lkp/linux/commit/0e5d4229f5e7671dabba56ea36583b1ca20a9a18</a>
        git remote add linux-review <a href="https://github.com/intel-lab-lkp/linux">https://github.com/intel-lab-lkp/linux</a>
        git fetch --no-tags linux-review Kent-Overstreet/Compiler-Attributes-add-__flatten/20230510-010302
        git checkout 0e5d4229f5e7671dabba56ea36583b1ca20a9a18
        # save the config file
        mkdir build_dir &amp;&amp; cp config build_dir/.config
        COMPILER_INSTALL_PATH=$HOME/0day COMPILER=clang make.cross W=1 O=build_dir ARCH=i386 olddefconfig
        COMPILER_INSTALL_PATH=$HOME/0day COMPILER=clang make.cross W=1 O=build_dir ARCH=i386 SHELL=/bin/bash

If you fix the issue, kindly add following tag where applicable
| Reported-by: kernel test robot &lt;lkp@intel.com&gt;
| Link: <a href="https://lore.kernel.org/oe-kbuild-all/202305101003.uncpRKqA-lkp@intel.com/">https://lore.kernel.org/oe-kbuild-all/202305101003.uncpRKqA-lkp@intel.com/</a>

All warnings (new ones prefixed by &gt;&gt;):

<span>&gt;&gt; lib/iov_iter.c:839:16: warning: comparison of distinct pointer types (&#39;typeof (bytes) *&#39; (aka &#39;unsigned int *&#39;) and &#39;typeof (((1UL) &lt;&lt; 12) - (offset &amp; (~(((1UL) &lt;&lt; 12) - 1)))) *&#39; (aka &#39;unsigned long *&#39;)) [-Wcompare-distinct-pointer-types]
</span>                   unsigned b = min(bytes, PAGE_SIZE - (offset &amp; PAGE_MASK));
                                ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   include/linux/minmax.h:67:19: note: expanded from macro &#39;min&#39;
   #define min(x, y)       __careful_cmp(x, y, &lt;)
                           ^~~~~~~~~~~~~~~~~~~~~~
   include/linux/minmax.h:36:24: note: expanded from macro &#39;__careful_cmp&#39;
           __builtin_choose_expr(__safe_cmp(x, y), \
                                 ^~~~~~~~~~~~~~~~
   include/linux/minmax.h:26:4: note: expanded from macro &#39;__safe_cmp&#39;
                   (__typecheck(x, y) &amp;&amp; __no_side_effects(x, y))
                    ^~~~~~~~~~~~~~~~~
   include/linux/minmax.h:20:28: note: expanded from macro &#39;__typecheck&#39;
           (!!(sizeof((typeof(x) *)1 == (typeof(y) *)1)))
                      ~~~~~~~~~~~~~~ ^  ~~~~~~~~~~~~~~
   1 warning generated.


vim +839 lib/iov_iter.c

   825	
   826	size_t copy_folio_from_iter_atomic(struct folio *folio, size_t offset,
   827					   size_t bytes, struct iov_iter *i)
   828	{
   829		size_t ret = 0;
   830	
   831		if (WARN_ON(offset + bytes &gt; folio_size(folio)))
   832			return 0;
   833		if (WARN_ON_ONCE(!i-&gt;data_source))
   834			return 0;
   835	
   836	#ifdef CONFIG_HIGHMEM
   837		while (bytes) {
   838			struct page *page = folio_page(folio, offset &gt;&gt; PAGE_SHIFT);
 &gt; 839			unsigned b = min(bytes, PAGE_SIZE - (offset &amp; PAGE_MASK));
   840			unsigned r = __copy_page_from_iter_atomic(page, offset, b, i);
   841	
   842			offset	+= r;
   843			bytes	-= r;
   844			ret	+= r;
   845	
   846			if (r != b)
   847				break;
   848		}
   849	#else
   850		ret = __copy_page_from_iter_atomic(&amp;folio-&gt;page, offset, bytes, i);
   851	#endif
   852	
   853		return ret;
   854	}
   855	EXPORT_SYMBOL(copy_folio_from_iter_atomic);
   856	

-- 
0-DAY CI Kernel Test Service
<a href="https://github.com/intel/lkp-tests">https://github.com/intel/lkp-tests</a>

<a href="#m5828ea4e5b889cfc135329e431ec2be9179194ba" id="e5828ea4e5b889cfc135329e431ec2be9179194ba">^</a> <a href="https://payments.posthaven.com/202305101003.uncpRKqA-lkp@intel.com/">permalink</a> <a href="https://payments.posthaven.com/202305101003.uncpRKqA-lkp@intel.com/raw">raw</a> <a href="https://payments.posthaven.com/202305101003.uncpRKqA-lkp@intel.com/#R">reply</a>	[<a href="https://payments.posthaven.com/202305101003.uncpRKqA-lkp@intel.com/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/202305101003.uncpRKqA-lkp@intel.com/t/#u">nested</a>] <a href="#r5828ea4e5b889cfc135329e431ec2be9179194ba">73+ messages in thread</a></pre><hr/><pre><a href="#e5e84bf1b54b345170f06c3cef8743db555c982aa" id="m5e84bf1b54b345170f06c3cef8743db555c982aa">*</a> <b>Re: [PATCH 22/32] vfs: inode cache conversion to hash-bl</b>
  2023-05-09 16:56 ` <a href="#m9a45d1eb8402cf51d25f06fda723d3f9a42457f0">[PATCH 22/32] vfs: inode cache conversion to hash-bl</a> Kent Overstreet
<b>@ 2023-05-10  4:45   ` Dave Chinner</b>
  <a href="#r5e84bf1b54b345170f06c3cef8743db555c982aa">0 siblings, 0 replies; 73+ messages in thread</a>
From: Dave Chinner @ 2023-05-10  4:45 UTC (<a href="https://payments.posthaven.com/20230510044557.GF2651828@dread.disaster.area/">permalink</a> / <a href="https://payments.posthaven.com/20230510044557.GF2651828@dread.disaster.area/raw">raw</a>)
  To: Kent Overstreet
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Dave Chinner,
	Alexander Viro, Christian Brauner

On Tue, May 09, 2023 at 12:56:47PM -0400, Kent Overstreet wrote:
<span>&gt; From: Dave Chinner &lt;dchinner@redhat.com&gt;
&gt; 
&gt; Because scalability of the global inode_hash_lock really, really
&gt; sucks.
&gt; 
&gt; 32-way concurrent create on a couple of different filesystems
&gt; before:
&gt; 
&gt; -   52.13%     0.04%  [kernel]            [k] ext4_create
&gt;    - 52.09% ext4_create
&gt;       - 41.03% __ext4_new_inode
&gt;          - 29.92% insert_inode_locked
&gt;             - 25.35% _raw_spin_lock
&gt;                - do_raw_spin_lock
&gt;                   - 24.97% __pv_queued_spin_lock_slowpath
&gt; 
&gt; -   72.33%     0.02%  [kernel]            [k] do_filp_open
&gt;    - 72.31% do_filp_open
&gt;       - 72.28% path_openat
&gt;          - 57.03% bch2_create
&gt;             - 56.46% __bch2_create
&gt;                - 40.43% inode_insert5
&gt;                   - 36.07% _raw_spin_lock
&gt;                      - do_raw_spin_lock
&gt;                           35.86% __pv_queued_spin_lock_slowpath
&gt;                     4.02% find_inode
&gt; 
&gt; Convert the inode hash table to a RCU-aware hash-bl table just like
&gt; the dentry cache. Note that we need to store a pointer to the
&gt; hlist_bl_head the inode has been added to in the inode so that when
&gt; it comes to unhash the inode we know what list to lock. We need to
&gt; do this because the hash value that is used to hash the inode is
&gt; generated from the inode itself - filesystems can provide this
&gt; themselves so we have to either store the hash or the head pointer
&gt; in the inode to be able to find the right list head for removal...
&gt; 
&gt; Same workload after:
&gt; 
&gt; Signed-off-by: Dave Chinner &lt;dchinner@redhat.com&gt;
&gt; Cc: Alexander Viro &lt;viro@zeniv.linux.org.uk&gt;
&gt; Cc: Christian Brauner &lt;brauner@kernel.org&gt;
&gt; Cc: linux-fsdevel@vger.kernel.org
&gt; Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
</span>
I have been maintaining this patchset uptodate in my own local trees
and the code in this patch looks the same. The commit message above,
however, has been mangled. The full commit message should be:

vfs: inode cache conversion to hash-bl

Because scalability of the global inode_hash_lock really, really
sucks and prevents me from doing scalability characterisation and
analysis of bcachefs algorithms.

Profiles of a 32-way concurrent create of 51.2m inodes with fsmark
on a couple of different filesystems on a 5.10 kernel:

-   52.13%     0.04%  [kernel]            [k] ext4_create
   - 52.09% ext4_create
      - 41.03% __ext4_new_inode
         - 29.92% insert_inode_locked
            - 25.35% _raw_spin_lock
               - do_raw_spin_lock
                  - 24.97% __pv_queued_spin_lock_slowpath


-   72.33%     0.02%  [kernel]            [k] do_filp_open
   - 72.31% do_filp_open
      - 72.28% path_openat
         - 57.03% bch2_create
            - 56.46% __bch2_create
               - 40.43% inode_insert5
                  - 36.07% _raw_spin_lock
                     - do_raw_spin_lock
                          35.86% __pv_queued_spin_lock_slowpath
                    4.02% find_inode

btrfs was tested but it is limited by internal lock contention at
<span>&gt;=2 threads on this workload, so never hammers the inode cache lock
</span>hard enough for this change to matter to it&#39;s performance.

However, both bcachefs and ext4 demonstrate poor scaling at &gt;=8
threads on concurrent lookup or create workloads.

Hence convert the inode hash table to a RCU-aware hash-bl table just
like the dentry cache. Note that we need to store a pointer to the
hlist_bl_head the inode has been added to in the inode so that when
it comes to unhash the inode we know what list to lock. We need to
do this because, unlike the dentry cache, the hash value that is
used to hash the inode is not generated from the inode itself. i.e.
filesystems can provide this themselves so we have to either store
the hashval or the hlist head pointer in the inode to be able to
find the right list head for removal...

Concurrent create with variying thread count (files/s):

                ext4                    bcachefs
threads         vanilla  patched        vanilla patched
2               117k     112k            80k     85k
4               185k     190k           133k    145k
8               303k     346k           185k    255k
16              389k     465k           190k    420k
32              360k     437k           142k    481k

CPU usage for both bcachefs and ext4 at 16 and 32 threads has been
halved on the patched kernel, while performance has increased
marginally on ext4 and massively on bcachefs. Internal filesystem
algorithms now limit performance on these workloads, not the global
inode_hash_lock.

Profile of the workloads on the patched kernels:

-   35.94%     0.07%  [kernel]                  [k] ext4_create
   - 35.87% ext4_create
      - 20.45% __ext4_new_inode
...
           3.36% insert_inode_locked

   - 78.43% do_filp_open
      - 78.36% path_openat
         - 53.95% bch2_create
            - 47.99% __bch2_create
....
              - 7.57% inode_insert5
                    6.94% find_inode

Spinlock contention is largely gone from the inode hash operations
and the filesystems are limited by contention in their internal
algorithms.

Signed-off-by: Dave Chinner &lt;dchinner@redhat.com&gt;
---

Other than that, the diffstat is the same and I don&#39;t see any obvious
differences in the code comapred to what I&#39;ve been running locally.

-Dave.
-- 
Dave Chinner
david@fromorbit.com

<a href="#m5e84bf1b54b345170f06c3cef8743db555c982aa" id="e5e84bf1b54b345170f06c3cef8743db555c982aa">^</a> <a href="https://payments.posthaven.com/20230510044557.GF2651828@dread.disaster.area/">permalink</a> <a href="https://payments.posthaven.com/20230510044557.GF2651828@dread.disaster.area/raw">raw</a> <a href="https://payments.posthaven.com/20230510044557.GF2651828@dread.disaster.area/#R">reply</a>	[<a href="https://payments.posthaven.com/20230510044557.GF2651828@dread.disaster.area/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230510044557.GF2651828@dread.disaster.area/t/#u">nested</a>] <a href="#r5e84bf1b54b345170f06c3cef8743db555c982aa">73+ messages in thread</a></pre><hr/><pre><a href="#e93c547f5d42cdc1f61d75f164b8fac7ae9110e76" id="m93c547f5d42cdc1f61d75f164b8fac7ae9110e76">*</a> <b>Re: [PATCH 21/32] hlist-bl: add hlist_bl_fake()</b>
  2023-05-09 16:56 ` <a href="#m20c403d1bc99dafdf25c76ce50ec9c9cf8eb7e04">[PATCH 21/32] hlist-bl: add hlist_bl_fake()</a> Kent Overstreet
<b>@ 2023-05-10  4:48   ` Dave Chinner</b>
  <a href="#r93c547f5d42cdc1f61d75f164b8fac7ae9110e76">0 siblings, 0 replies; 73+ messages in thread</a>
From: Dave Chinner @ 2023-05-10  4:48 UTC (<a href="https://payments.posthaven.com/20230510044824.GG2651828@dread.disaster.area/">permalink</a> / <a href="https://payments.posthaven.com/20230510044824.GG2651828@dread.disaster.area/raw">raw</a>)
  To: Kent Overstreet; <b>+Cc:</b> linux-kernel, linux-fsdevel, linux-bcachefs, Dave Chinner

On Tue, May 09, 2023 at 12:56:46PM -0400, Kent Overstreet wrote:
<span>&gt; From: Dave Chinner &lt;dchinner@redhat.com&gt;
&gt; 
&gt; in preparation for switching the VFS inode cache over the hlist_bl
</span>  In

<span>&gt; lists, we nee dto be able to fake a list node that looks like it is
</span>            need to

<span>&gt; hased for correct operation of filesystems that don&#39;t directly use
</span>  hashed

<span>&gt; the VFS indoe cache.
</span>          inode cache hash index.

-Dave.

-- 
Dave Chinner
david@fromorbit.com

<a href="#m93c547f5d42cdc1f61d75f164b8fac7ae9110e76" id="e93c547f5d42cdc1f61d75f164b8fac7ae9110e76">^</a> <a href="https://payments.posthaven.com/20230510044824.GG2651828@dread.disaster.area/">permalink</a> <a href="https://payments.posthaven.com/20230510044824.GG2651828@dread.disaster.area/raw">raw</a> <a href="https://payments.posthaven.com/20230510044824.GG2651828@dread.disaster.area/#R">reply</a>	[<a href="https://payments.posthaven.com/20230510044824.GG2651828@dread.disaster.area/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230510044824.GG2651828@dread.disaster.area/t/#u">nested</a>] <a href="#r93c547f5d42cdc1f61d75f164b8fac7ae9110e76">73+ messages in thread</a></pre><hr/><pre><a href="#e7cce75af26bf200b94dfafb53ca15f2f2b12f1de" id="m7cce75af26bf200b94dfafb53ca15f2f2b12f1de">*</a> <b>Re: [PATCH 06/32] sched: Add task_struct-&gt;faults_disabled_mapping</b>
  2023-05-10  1:07   ` <a href="#m613d136f0d8a1ed3d18224d73c012f467295aa60">Jan Kara</a>
<b>@ 2023-05-10  6:18     ` Kent Overstreet</b>
  <a href="#r7cce75af26bf200b94dfafb53ca15f2f2b12f1de">0 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-10  6:18 UTC (<a href="https://payments.posthaven.com/ZFs3RYgdCeKjxYCw@moria.home.lan/">permalink</a> / <a href="https://payments.posthaven.com/ZFs3RYgdCeKjxYCw@moria.home.lan/raw">raw</a>)
  To: Jan Kara
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Kent Overstreet,
	Darrick J . Wong, dhowells

On Wed, May 10, 2023 at 03:07:37AM +0200, Jan Kara wrote:
<span>&gt; On Tue 09-05-23 12:56:31, Kent Overstreet wrote:
&gt; &gt; From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
&gt; &gt; 
&gt; &gt; This is used by bcachefs to fix a page cache coherency issue with
&gt; &gt; O_DIRECT writes.
&gt; &gt; 
&gt; &gt; Also relevant: mapping-&gt;invalidate_lock, see below.
&gt; &gt; 
&gt; &gt; O_DIRECT writes (and other filesystem operations that modify file data
&gt; &gt; while bypassing the page cache) need to shoot down ranges of the page
&gt; &gt; cache - and additionally, need locking to prevent those pages from
&gt; &gt; pulled back in.
&gt; &gt; 
&gt; &gt; But O_DIRECT writes invoke the page fault handler (via get_user_pages),
&gt; &gt; and the page fault handler will need to take that same lock - this is a
&gt; &gt; classic recursive deadlock if userspace has mmaped the file they&#39;re DIO
&gt; &gt; writing to and uses those pages for the buffer to write from, and it&#39;s a
&gt; &gt; lock ordering deadlock in general.
&gt; &gt; 
&gt; &gt; Thus we need a way to signal from the dio code to the page fault handler
&gt; &gt; when we already are holding the pagecache add lock on an address space -
&gt; &gt; this patch just adds a member to task_struct for this purpose. For now
&gt; &gt; only bcachefs is implementing this locking, though it may be moved out
&gt; &gt; of bcachefs and made available to other filesystems in the future.
&gt; 
&gt; It would be nice to have at least a link to the code that&#39;s actually using
&gt; the field you are adding.
</span>
Bit of a trick to link to a _later_ patch in the series from a commit
message, but...

<a href="https://evilpiepirate.org/git/bcachefs.git/tree/fs/bcachefs/fs-io.c#n975">https://evilpiepirate.org/git/bcachefs.git/tree/fs/bcachefs/fs-io.c#n975</a>
<a href="https://evilpiepirate.org/git/bcachefs.git/tree/fs/bcachefs/fs-io.c#n2454">https://evilpiepirate.org/git/bcachefs.git/tree/fs/bcachefs/fs-io.c#n2454</a>

<span>&gt; Also I think we were already through this discussion [1] and we ended up
&gt; agreeing that your scheme actually solves only the AA deadlock but a
&gt; malicious userspace can easily create AB BA deadlock by running direct IO
&gt; to file A using mapped file B as a buffer *and* direct IO to file B using
&gt; mapped file A as a buffer.
</span>
No, that&#39;s definitely handled (and you can see it in the code I linked),
and I wrote a torture test for fstests as well.

David Howells was also just running into a strange locking situation with
iov_iters and recursive gups - I don&#39;t recall all the details, but it
sounded like this might be a solution for that. David, did you have
thoughts on that?

<a href="#m7cce75af26bf200b94dfafb53ca15f2f2b12f1de" id="e7cce75af26bf200b94dfafb53ca15f2f2b12f1de">^</a> <a href="https://payments.posthaven.com/ZFs3RYgdCeKjxYCw@moria.home.lan/">permalink</a> <a href="https://payments.posthaven.com/ZFs3RYgdCeKjxYCw@moria.home.lan/raw">raw</a> <a href="https://payments.posthaven.com/ZFs3RYgdCeKjxYCw@moria.home.lan/#R">reply</a>	[<a href="https://payments.posthaven.com/ZFs3RYgdCeKjxYCw@moria.home.lan/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/ZFs3RYgdCeKjxYCw@moria.home.lan/t/#u">nested</a>] <a href="#r7cce75af26bf200b94dfafb53ca15f2f2b12f1de">73+ messages in thread</a></pre><hr/><pre><a href="#ec945d16c820fcbc010bcdbf7c73ae1f57d502a07" id="mc945d16c820fcbc010bcdbf7c73ae1f57d502a07">*</a> <b>Re: [PATCH 07/32] mm: Bring back vmalloc_exec</b>
  2023-05-09 21:29       ` <a href="#mde4acd2516e5034c6dd79bff2c54932802f8c9b5">Kent Overstreet</a>
<b>@ 2023-05-10  6:48         ` Eric Biggers</b>
  2023-05-10 11:56         ` <a href="#m07f44d5a1a85f6f7e2f92cf648aa8876fb10ab60">David Laight</a>
  <a href="#rc945d16c820fcbc010bcdbf7c73ae1f57d502a07">1 sibling, 0 replies; 73+ messages in thread</a>
From: Eric Biggers @ 2023-05-10  6:48 UTC (<a href="https://payments.posthaven.com/20230510064849.GC1851@quark.localdomain/">permalink</a> / <a href="https://payments.posthaven.com/20230510064849.GC1851@quark.localdomain/raw">raw</a>)
  To: Kent Overstreet
  Cc: Lorenzo Stoakes, Christoph Hellwig, linux-kernel, linux-fsdevel,
	linux-bcachefs, Kent Overstreet, Andrew Morton, Uladzislau Rezki,
	linux-mm

On Tue, May 09, 2023 at 05:29:10PM -0400, Kent Overstreet wrote:
<span>&gt; On Tue, May 09, 2023 at 02:12:41PM -0700, Lorenzo Stoakes wrote:
&gt; &gt; On Tue, May 09, 2023 at 01:46:09PM -0700, Christoph Hellwig wrote:
&gt; &gt; &gt; On Tue, May 09, 2023 at 12:56:32PM -0400, Kent Overstreet wrote:
&gt; &gt; &gt; &gt; From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; This is needed for bcachefs, which dynamically generates per-btree node
&gt; &gt; &gt; &gt; unpack functions.
&gt; &gt; &gt;
&gt; &gt; &gt; No, we will never add back a way for random code allocating executable
&gt; &gt; &gt; memory in kernel space.
&gt; &gt; 
&gt; &gt; Yeah I think I glossed over this aspect a bit as it looks ostensibly like simply
&gt; &gt; reinstating a helper function because the code is now used in more than one
&gt; &gt; place (at lsf/mm so a little distracted :)
&gt; &gt; 
&gt; &gt; But it being exported is a problem. Perhaps there&#39;s another way of acheving the
&gt; &gt; same aim without having to do so?
&gt; 
&gt; None that I see.
&gt; 
&gt; The background is that bcachefs generates a per btree node unpack
&gt; function, based on the packed format for that btree node, for unpacking
&gt; keys within that node. The unpack function is only ~50 bytes, and for
&gt; locality we want it to be located with the btree node&#39;s other in-memory
&gt; lookup tables so they can be prefetched all at once.
&gt; 
&gt; Here&#39;s the codegen:
&gt; 
&gt; <a href="https://evilpiepirate.org/git/bcachefs.git/tree/fs/bcachefs/bkey.c#n727">https://evilpiepirate.org/git/bcachefs.git/tree/fs/bcachefs/bkey.c#n727</a>
</span>
Well, it&#39;s a cool trick, but it&#39;s not clear that it actually belongs in
production kernel code.  What else in the kernel actually does dynamic codegen?
Just BPF, I think?

Among other issues, this is entirely architecture-specific, and it may cause
interoperability issues with various other features, including security
features.  Is it really safe to leave a W&amp;X page around, for example?

What seems to be missing is any explanation for what we&#39;re actually getting from
this extremely unusual solution that cannot be gained any other way.  What is
unique about bcachefs that it really needs something like this?

- Eric

<a href="#mc945d16c820fcbc010bcdbf7c73ae1f57d502a07" id="ec945d16c820fcbc010bcdbf7c73ae1f57d502a07">^</a> <a href="https://payments.posthaven.com/20230510064849.GC1851@quark.localdomain/">permalink</a> <a href="https://payments.posthaven.com/20230510064849.GC1851@quark.localdomain/raw">raw</a> <a href="https://payments.posthaven.com/20230510064849.GC1851@quark.localdomain/#R">reply</a>	[<a href="https://payments.posthaven.com/20230510064849.GC1851@quark.localdomain/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230510064849.GC1851@quark.localdomain/t/#u">nested</a>] <a href="#rc945d16c820fcbc010bcdbf7c73ae1f57d502a07">73+ messages in thread</a></pre><hr/><pre><a href="#ec00ab06c40f934efbc30a1f117ec7336e9c0dcfa" id="mc00ab06c40f934efbc30a1f117ec7336e9c0dcfa">*</a> <b>Re: [PATCH 03/32] locking/lockdep: lockdep_set_no_check_recursion()</b>
  2023-05-09 20:18     ` <a href="#m4c5848c5e0839861066340c7f2aa5e237ba6c2ea">Kent Overstreet</a>
  2023-05-09 20:27       ` <a href="#m300bc72c7328f6808bafb4f9a78a04d953029686">Waiman Long</a>
<b>@ 2023-05-10  8:59       ` Peter Zijlstra</b>
  2023-05-10 20:38         ` <a href="#ma11a6138299bdcdd1ef0bd82aa3672a2c178d7fa">Kent Overstreet</a>
  <a href="#rc00ab06c40f934efbc30a1f117ec7336e9c0dcfa">1 sibling, 1 reply; 73+ messages in thread</a>
From: Peter Zijlstra @ 2023-05-10  8:59 UTC (<a href="https://payments.posthaven.com/20230510085905.GJ4253@hirez.programming.kicks-ass.net/">permalink</a> / <a href="https://payments.posthaven.com/20230510085905.GJ4253@hirez.programming.kicks-ass.net/raw">raw</a>)
  To: Kent Overstreet
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Ingo Molnar,
	Will Deacon, Waiman Long, Boqun Feng

On Tue, May 09, 2023 at 04:18:59PM -0400, Kent Overstreet wrote:
<span>&gt; On Tue, May 09, 2023 at 09:31:47PM +0200, Peter Zijlstra wrote:
&gt; &gt; On Tue, May 09, 2023 at 12:56:28PM -0400, Kent Overstreet wrote:
&gt; &gt; &gt; This adds a method to tell lockdep not to check lock ordering within a
&gt; &gt; &gt; lock class - but to still check lock ordering w.r.t. other lock types.
&gt; &gt; &gt; 
&gt; &gt; &gt; This is for bcachefs, where for btree node locks we have our own
&gt; &gt; &gt; deadlock avoidance strategy w.r.t. other btree node locks (cycle
&gt; &gt; &gt; detection), but we still want lockdep to check lock ordering w.r.t.
&gt; &gt; &gt; other lock types.
&gt; &gt; &gt; 
&gt; &gt; 
&gt; &gt; ISTR you had a much nicer version of this where you gave a custom order
&gt; &gt; function -- what happend to that?
&gt; 
&gt; Actually, I spoke too soon; this patch and the other series with the
&gt; comparison function solve different problems.
&gt; 
&gt; For bcachefs btree node locks, we don&#39;t have a defined lock ordering at
&gt; all - we do full runtime cycle detection, so we don&#39;t want lockdep
&gt; checking for self deadlock because we&#39;re handling that but we _do_ want
&gt; lockdep checking lock ordering of btree node locks w.r.t. other locks in
&gt; the system.
</span>
Have you read the ww_mutex code? If not, please do so, it does similar
things.

The way it gets around the self-nesting check is by using the nest_lock
annotation, the acquire context itself also has a dep_map for this
purpose.

<a href="#mc00ab06c40f934efbc30a1f117ec7336e9c0dcfa" id="ec00ab06c40f934efbc30a1f117ec7336e9c0dcfa">^</a> <a href="https://payments.posthaven.com/20230510085905.GJ4253@hirez.programming.kicks-ass.net/">permalink</a> <a href="https://payments.posthaven.com/20230510085905.GJ4253@hirez.programming.kicks-ass.net/raw">raw</a> <a href="https://payments.posthaven.com/20230510085905.GJ4253@hirez.programming.kicks-ass.net/#R">reply</a>	[<a href="https://payments.posthaven.com/20230510085905.GJ4253@hirez.programming.kicks-ass.net/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230510085905.GJ4253@hirez.programming.kicks-ass.net/t/#u">nested</a>] <a href="#rc00ab06c40f934efbc30a1f117ec7336e9c0dcfa">73+ messages in thread</a></pre><hr/><pre><a href="#e07f44d5a1a85f6f7e2f92cf648aa8876fb10ab60" id="m07f44d5a1a85f6f7e2f92cf648aa8876fb10ab60">*</a> <b>RE: [PATCH 07/32] mm: Bring back vmalloc_exec</b>
  2023-05-09 21:29       ` <a href="#mde4acd2516e5034c6dd79bff2c54932802f8c9b5">Kent Overstreet</a>
  2023-05-10  6:48         ` <a href="#mc945d16c820fcbc010bcdbf7c73ae1f57d502a07">Eric Biggers</a>
<b>@ 2023-05-10 11:56         ` David Laight</b>
  <a href="#r07f44d5a1a85f6f7e2f92cf648aa8876fb10ab60">1 sibling, 0 replies; 73+ messages in thread</a>
From: David Laight @ 2023-05-10 11:56 UTC (<a href="https://payments.posthaven.com/aa542818337b4157bfdcf262926b9fe3@AcuMS.aculab.com/">permalink</a> / <a href="https://payments.posthaven.com/aa542818337b4157bfdcf262926b9fe3@AcuMS.aculab.com/raw">raw</a>)
  To: &#39;Kent Overstreet&#39;, Lorenzo Stoakes
  Cc: Christoph Hellwig, linux-kernel, linux-fsdevel, linux-bcachefs,
	Kent Overstreet, Andrew Morton, Uladzislau Rezki, linux-mm

From: Kent Overstreet
<span>&gt; Sent: 09 May 2023 22:29
</span>...
<span>&gt; The background is that bcachefs generates a per btree node unpack
&gt; function, based on the packed format for that btree node, for unpacking
&gt; keys within that node. The unpack function is only ~50 bytes, and for
&gt; locality we want it to be located with the btree node&#39;s other in-memory
&gt; lookup tables so they can be prefetched all at once.
</span>
Loading data into the d-cache isn&#39;t going to load code into
the i-cache.
Indeed you don&#39;t want to be mixing code and data in the same
cache line - because it just wastes space in the cache.

Looks to me like you could have a few different unpack
functions and pick the correct one based on the packed format.
Quite likely the code would be just as fast (if longer)
when you allow for parallel execution on modern cpu.

	David

-
Registered Address Lakeside, Bramley Road, Mount Farm, Milton Keynes, MK1 1PT, UK
Registration No: 1397386 (Wales)


<a href="#m07f44d5a1a85f6f7e2f92cf648aa8876fb10ab60" id="e07f44d5a1a85f6f7e2f92cf648aa8876fb10ab60">^</a> <a href="https://payments.posthaven.com/aa542818337b4157bfdcf262926b9fe3@AcuMS.aculab.com/">permalink</a> <a href="https://payments.posthaven.com/aa542818337b4157bfdcf262926b9fe3@AcuMS.aculab.com/raw">raw</a> <a href="https://payments.posthaven.com/aa542818337b4157bfdcf262926b9fe3@AcuMS.aculab.com/#R">reply</a>	[<a href="https://payments.posthaven.com/aa542818337b4157bfdcf262926b9fe3@AcuMS.aculab.com/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/aa542818337b4157bfdcf262926b9fe3@AcuMS.aculab.com/t/#u">nested</a>] <a href="#r07f44d5a1a85f6f7e2f92cf648aa8876fb10ab60">73+ messages in thread</a></pre><hr/><pre><a href="#e9cd8ae95b882e838cc1b43927a152aa3128f5b45" id="m9cd8ae95b882e838cc1b43927a152aa3128f5b45">*</a> <b>Re: [PATCH 07/32] mm: Bring back vmalloc_exec</b>
  2023-05-09 16:56 ` <a href="#mcabddb3f4bded12301500ae05b7bcb26474a2aa4">[PATCH 07/32] mm: Bring back vmalloc_exec</a> Kent Overstreet
  2023-05-09 18:19   ` <a href="#m4441d42cf9b00ca0af1c77affa4e0e32fc889be6">Lorenzo Stoakes</a>
  2023-05-09 20:46   ` <a href="#mfa639982c8ae26fa0750bbf9244a1d3272ef00a0">Christoph Hellwig</a>
<b>@ 2023-05-10 14:18   ` Christophe Leroy</b>
  2023-05-10 15:05   ` <a href="#m815f98c7cb3a865c0378ae5c190f234cf5b2c645">Johannes Thumshirn</a>
  <a href="#r9cd8ae95b882e838cc1b43927a152aa3128f5b45">3 siblings, 0 replies; 73+ messages in thread</a>
From: Christophe Leroy @ 2023-05-10 14:18 UTC (<a href="https://payments.posthaven.com/d874c1f9-472e-398b-87e7-f83701fa2bfa@csgroup.eu/">permalink</a> / <a href="https://payments.posthaven.com/d874c1f9-472e-398b-87e7-f83701fa2bfa@csgroup.eu/raw">raw</a>)
  To: Kent Overstreet, linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: Kent Overstreet, Andrew Morton, Uladzislau Rezki,
	Christoph Hellwig, linux-mm



Le 09/05/2023 à 18:56, Kent Overstreet a écrit :
<span>&gt; From: Kent Overstreet &lt;kent.overstreet@gmail.com&gt;
&gt; 
&gt; This is needed for bcachefs, which dynamically generates per-btree node
&gt; unpack functions.
&gt; 
&gt; Signed-off-by: Kent Overstreet &lt;kent.overstreet@linux.dev&gt;
&gt; Cc: Andrew Morton &lt;akpm@linux-foundation.org&gt;
&gt; Cc: Uladzislau Rezki &lt;urezki@gmail.com&gt;
&gt; Cc: Christoph Hellwig &lt;hch@infradead.org&gt;
&gt; Cc: linux-mm@kvack.org
&gt; ---
&gt;   include/linux/vmalloc.h |  1 +
&gt;   kernel/module/main.c    |  4 +---
&gt;   mm/nommu.c              | 18 ++++++++++++++++++
&gt;   mm/vmalloc.c            | 21 +++++++++++++++++++++
&gt;   4 files changed, 41 insertions(+), 3 deletions(-)
&gt; 
&gt; diff --git a/include/linux/vmalloc.h b/include/linux/vmalloc.h
&gt; index 69250efa03..ff147fe115 100644
&gt; --- a/include/linux/vmalloc.h
&gt; +++ b/include/linux/vmalloc.h
&gt; @@ -145,6 +145,7 @@ extern void *vzalloc(unsigned long size) __alloc_size(1);
&gt;   extern void *vmalloc_user(unsigned long size) __alloc_size(1);
&gt;   extern void *vmalloc_node(unsigned long size, int node) __alloc_size(1);
&gt;   extern void *vzalloc_node(unsigned long size, int node) __alloc_size(1);
&gt; +extern void *vmalloc_exec(unsigned long size, gfp_t gfp_mask) __alloc_size(1);
&gt;   extern void *vmalloc_32(unsigned long size) __alloc_size(1);
&gt;   extern void *vmalloc_32_user(unsigned long size) __alloc_size(1);
&gt;   extern void *__vmalloc(unsigned long size, gfp_t gfp_mask) __alloc_size(1);
&gt; diff --git a/kernel/module/main.c b/kernel/module/main.c
&gt; index d3be89de70..9eaa89e84c 100644
&gt; --- a/kernel/module/main.c
&gt; +++ b/kernel/module/main.c
&gt; @@ -1607,9 +1607,7 @@ static void dynamic_debug_remove(struct module *mod, struct _ddebug_info *dyndbg
&gt;   
&gt;   void * __weak module_alloc(unsigned long size)
&gt;   {
&gt; -	return __vmalloc_node_range(size, 1, VMALLOC_START, VMALLOC_END,
&gt; -			GFP_KERNEL, PAGE_KERNEL_EXEC, VM_FLUSH_RESET_PERMS,
&gt; -			NUMA_NO_NODE, __builtin_return_address(0));
&gt; +	return vmalloc_exec(size, GFP_KERNEL);
&gt;   }
&gt;   
&gt;   bool __weak module_init_section(const char *name)
&gt; diff --git a/mm/nommu.c b/mm/nommu.c
&gt; index 57ba243c6a..8d9ab19e39 100644
&gt; --- a/mm/nommu.c
&gt; +++ b/mm/nommu.c
&gt; @@ -280,6 +280,24 @@ void *vzalloc_node(unsigned long size, int node)
&gt;   }
&gt;   EXPORT_SYMBOL(vzalloc_node);
&gt;   
&gt; +/**
&gt; + *	vmalloc_exec  -  allocate virtually contiguous, executable memory
&gt; + *	@size:		allocation size
&gt; + *
&gt; + *	Kernel-internal function to allocate enough pages to cover @size
&gt; + *	the page level allocator and map them into contiguous and
&gt; + *	executable kernel virtual space.
&gt; + *
&gt; + *	For tight control over page level allocator and protection flags
&gt; + *	use __vmalloc() instead.
&gt; + */
&gt; +
&gt; +void *vmalloc_exec(unsigned long size, gfp_t gfp_mask)
&gt; +{
&gt; +	return __vmalloc(size, gfp_mask);
&gt; +}
&gt; +EXPORT_SYMBOL_GPL(vmalloc_exec);
&gt; +
&gt;   /**
&gt;    * vmalloc_32  -  allocate virtually contiguous memory (32bit addressable)
&gt;    *	@size:		allocation size
&gt; diff --git a/mm/vmalloc.c b/mm/vmalloc.c
&gt; index 31ff782d36..2ebb9ea7f0 100644
&gt; --- a/mm/vmalloc.c
&gt; +++ b/mm/vmalloc.c
&gt; @@ -3401,6 +3401,27 @@ void *vzalloc_node(unsigned long size, int node)
&gt;   }
&gt;   EXPORT_SYMBOL(vzalloc_node);
&gt;   
&gt; +/**
&gt; + * vmalloc_exec - allocate virtually contiguous, executable memory
&gt; + * @size:	  allocation size
&gt; + *
&gt; + * Kernel-internal function to allocate enough pages to cover @size
&gt; + * the page level allocator and map them into contiguous and
&gt; + * executable kernel virtual space.
&gt; + *
&gt; + * For tight control over page level allocator and protection flags
&gt; + * use __vmalloc() instead.
&gt; + *
&gt; + * Return: pointer to the allocated memory or %NULL on error
&gt; + */
&gt; +void *vmalloc_exec(unsigned long size, gfp_t gfp_mask)
&gt; +{
&gt; +	return __vmalloc_node_range(size, 1, VMALLOC_START, VMALLOC_END,
&gt; +			gfp_mask, PAGE_KERNEL_EXEC, VM_FLUSH_RESET_PERMS,
&gt; +			NUMA_NO_NODE, __builtin_return_address(0));
&gt; +}
</span>
That cannot work. The VMALLOC space is mapped non-exec on powerpc/32. 
You have to allocate between MODULES_VADDR and MODULES_END if you want 
something executable so you must use module_alloc() see 
<a href="https://elixir.bootlin.com/linux/v6.4-rc1/source/arch/powerpc/kernel/module.c#L108">https://elixir.bootlin.com/linux/v6.4-rc1/source/arch/powerpc/kernel/module.c#L108</a>

<span>&gt; +EXPORT_SYMBOL_GPL(vmalloc_exec);
&gt; +
&gt;   #if defined(CONFIG_64BIT) &amp;&amp; defined(CONFIG_ZONE_DMA32)
&gt;   #define GFP_VMALLOC32 (GFP_DMA32 | GFP_KERNEL)
&gt;   #elif defined(CONFIG_64BIT) &amp;&amp; defined(CONFIG_ZONE_DMA)
</span>
<a href="#m9cd8ae95b882e838cc1b43927a152aa3128f5b45" id="e9cd8ae95b882e838cc1b43927a152aa3128f5b45">^</a> <a href="https://payments.posthaven.com/d874c1f9-472e-398b-87e7-f83701fa2bfa@csgroup.eu/">permalink</a> <a href="https://payments.posthaven.com/d874c1f9-472e-398b-87e7-f83701fa2bfa@csgroup.eu/raw">raw</a> <a href="https://payments.posthaven.com/d874c1f9-472e-398b-87e7-f83701fa2bfa@csgroup.eu/#R">reply</a>	[<a href="https://payments.posthaven.com/d874c1f9-472e-398b-87e7-f83701fa2bfa@csgroup.eu/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/d874c1f9-472e-398b-87e7-f83701fa2bfa@csgroup.eu/t/#u">nested</a>] <a href="#r9cd8ae95b882e838cc1b43927a152aa3128f5b45">73+ messages in thread</a></pre><hr/><pre><a href="#e815f98c7cb3a865c0378ae5c190f234cf5b2c645" id="m815f98c7cb3a865c0378ae5c190f234cf5b2c645">*</a> <b>Re: [PATCH 07/32] mm: Bring back vmalloc_exec</b>
  2023-05-09 16:56 ` <a href="#mcabddb3f4bded12301500ae05b7bcb26474a2aa4">[PATCH 07/32] mm: Bring back vmalloc_exec</a> Kent Overstreet
                     ` <a href="#r9cd8ae95b882e838cc1b43927a152aa3128f5b45">(2 preceding siblings ...)</a>
  2023-05-10 14:18   ` <a href="#m9cd8ae95b882e838cc1b43927a152aa3128f5b45">Christophe Leroy</a>
<b>@ 2023-05-10 15:05   ` Johannes Thumshirn</b>
  <a href="#r815f98c7cb3a865c0378ae5c190f234cf5b2c645">3 siblings, 0 replies; 73+ messages in thread</a>
From: Johannes Thumshirn @ 2023-05-10 15:05 UTC (<a href="https://payments.posthaven.com/3508afc0-6f03-a971-e716-999a7373951f@wdc.com/">permalink</a> / <a href="https://payments.posthaven.com/3508afc0-6f03-a971-e716-999a7373951f@wdc.com/raw">raw</a>)
  To: Kent Overstreet, linux-kernel, linux-fsdevel, linux-bcachefs, Kees Cook
  Cc: Kent Overstreet, Andrew Morton, Uladzislau Rezki, hch, linux-mm,
	linux-hardening

On 09.05.23 18:56, Kent Overstreet wrote:
<span>&gt; +/**
&gt; + * vmalloc_exec - allocate virtually contiguous, executable memory
&gt; + * @size:	  allocation size
&gt; + *
&gt; + * Kernel-internal function to allocate enough pages to cover @size
&gt; + * the page level allocator and map them into contiguous and
&gt; + * executable kernel virtual space.
&gt; + *
&gt; + * For tight control over page level allocator and protection flags
&gt; + * use __vmalloc() instead.
&gt; + *
&gt; + * Return: pointer to the allocated memory or %NULL on error
&gt; + */
&gt; +void *vmalloc_exec(unsigned long size, gfp_t gfp_mask)
&gt; +{
&gt; +	return __vmalloc_node_range(size, 1, VMALLOC_START, VMALLOC_END,
&gt; +			gfp_mask, PAGE_KERNEL_EXEC, VM_FLUSH_RESET_PERMS,
&gt; +			NUMA_NO_NODE, __builtin_return_address(0));
&gt; +}
&gt; +EXPORT_SYMBOL_GPL(vmalloc_exec);
</span>
Uh W+X memory reagions.
The 90s called, they want their shellcode back.

<a href="#m815f98c7cb3a865c0378ae5c190f234cf5b2c645" id="e815f98c7cb3a865c0378ae5c190f234cf5b2c645">^</a> <a href="https://payments.posthaven.com/3508afc0-6f03-a971-e716-999a7373951f@wdc.com/">permalink</a> <a href="https://payments.posthaven.com/3508afc0-6f03-a971-e716-999a7373951f@wdc.com/raw">raw</a> <a href="https://payments.posthaven.com/3508afc0-6f03-a971-e716-999a7373951f@wdc.com/#R">reply</a>	[<a href="https://payments.posthaven.com/3508afc0-6f03-a971-e716-999a7373951f@wdc.com/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/3508afc0-6f03-a971-e716-999a7373951f@wdc.com/t/#u">nested</a>] <a href="#r815f98c7cb3a865c0378ae5c190f234cf5b2c645">73+ messages in thread</a></pre><hr/><pre><a href="#ea11a6138299bdcdd1ef0bd82aa3672a2c178d7fa" id="ma11a6138299bdcdd1ef0bd82aa3672a2c178d7fa">*</a> <b>Re: [PATCH 03/32] locking/lockdep: lockdep_set_no_check_recursion()</b>
  2023-05-10  8:59       ` <a href="#mc00ab06c40f934efbc30a1f117ec7336e9c0dcfa">Peter Zijlstra</a>
<b>@ 2023-05-10 20:38         ` Kent Overstreet</b>
  2023-05-11  8:25           ` <a href="#m9bebc063b3cd901afc9fff9a095dad9477a53db1">Peter Zijlstra</a>
  <a href="#ra11a6138299bdcdd1ef0bd82aa3672a2c178d7fa">0 siblings, 1 reply; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-10 20:38 UTC (<a href="https://payments.posthaven.com/ZFwAtwIrKyJ9GJ%2FU@moria.home.lan/">permalink</a> / <a href="https://payments.posthaven.com/ZFwAtwIrKyJ9GJ%2FU@moria.home.lan/raw">raw</a>)
  To: Peter Zijlstra
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Ingo Molnar,
	Will Deacon, Waiman Long, Boqun Feng

On Wed, May 10, 2023 at 10:59:05AM +0200, Peter Zijlstra wrote:
<span>&gt; On Tue, May 09, 2023 at 04:18:59PM -0400, Kent Overstreet wrote:
&gt; &gt; On Tue, May 09, 2023 at 09:31:47PM +0200, Peter Zijlstra wrote:
&gt; &gt; &gt; On Tue, May 09, 2023 at 12:56:28PM -0400, Kent Overstreet wrote:
&gt; &gt; &gt; &gt; This adds a method to tell lockdep not to check lock ordering within a
&gt; &gt; &gt; &gt; lock class - but to still check lock ordering w.r.t. other lock types.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; This is for bcachefs, where for btree node locks we have our own
&gt; &gt; &gt; &gt; deadlock avoidance strategy w.r.t. other btree node locks (cycle
&gt; &gt; &gt; &gt; detection), but we still want lockdep to check lock ordering w.r.t.
&gt; &gt; &gt; &gt; other lock types.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; 
&gt; &gt; &gt; ISTR you had a much nicer version of this where you gave a custom order
&gt; &gt; &gt; function -- what happend to that?
&gt; &gt; 
&gt; &gt; Actually, I spoke too soon; this patch and the other series with the
&gt; &gt; comparison function solve different problems.
&gt; &gt; 
&gt; &gt; For bcachefs btree node locks, we don&#39;t have a defined lock ordering at
&gt; &gt; all - we do full runtime cycle detection, so we don&#39;t want lockdep
&gt; &gt; checking for self deadlock because we&#39;re handling that but we _do_ want
&gt; &gt; lockdep checking lock ordering of btree node locks w.r.t. other locks in
&gt; &gt; the system.
&gt; 
&gt; Have you read the ww_mutex code? If not, please do so, it does similar
&gt; things.
&gt; 
&gt; The way it gets around the self-nesting check is by using the nest_lock
&gt; annotation, the acquire context itself also has a dep_map for this
&gt; purpose.
</span>
This might work.

I was confused for a good bit when reading tho code to figure out how
it works - nest_lock seems to be a pretty bad name, it&#39;s really not a
lock. acquire_ctx?

<a href="#ma11a6138299bdcdd1ef0bd82aa3672a2c178d7fa" id="ea11a6138299bdcdd1ef0bd82aa3672a2c178d7fa">^</a> <a href="https://payments.posthaven.com/ZFwAtwIrKyJ9GJ%2FU@moria.home.lan/">permalink</a> <a href="https://payments.posthaven.com/ZFwAtwIrKyJ9GJ%2FU@moria.home.lan/raw">raw</a> <a href="https://payments.posthaven.com/ZFwAtwIrKyJ9GJ%2FU@moria.home.lan/#R">reply</a>	[<a href="https://payments.posthaven.com/ZFwAtwIrKyJ9GJ%2FU@moria.home.lan/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/ZFwAtwIrKyJ9GJ%2FU@moria.home.lan/t/#u">nested</a>] <a href="#ra11a6138299bdcdd1ef0bd82aa3672a2c178d7fa">73+ messages in thread</a></pre><hr/><pre><a href="#e2be1ce6189d96241cbd4b322f136ff0da35e00ad" id="m2be1ce6189d96241cbd4b322f136ff0da35e00ad">*</a> <b>Re: [PATCH 23/32] iov_iter: copy_folio_from_iter_atomic()</b>
  2023-05-09 16:56 ` <a href="#mb432faef6999d4df09b333f1d1842e1989b7be4d">[PATCH 23/32] iov_iter: copy_folio_from_iter_atomic()</a> Kent Overstreet
  2023-05-10  2:20   ` <a href="#m5828ea4e5b889cfc135329e431ec2be9179194ba">kernel test robot</a>
<b>@ 2023-05-11  2:08   ` kernel test robot</b>
  <a href="#r2be1ce6189d96241cbd4b322f136ff0da35e00ad">1 sibling, 0 replies; 73+ messages in thread</a>
From: kernel test robot @ 2023-05-11  2:08 UTC (<a href="https://payments.posthaven.com/202305110949.RCcHYzkJ-lkp@intel.com/">permalink</a> / <a href="https://payments.posthaven.com/202305110949.RCcHYzkJ-lkp@intel.com/raw">raw</a>)
  To: Kent Overstreet, linux-kernel, linux-fsdevel, linux-bcachefs
  Cc: oe-kbuild-all, Kent Overstreet, Alexander Viro, Matthew Wilcox

Hi Kent,

kernel test robot noticed the following build warnings:

[auto build test WARNING on tip/locking/core]
[cannot apply to axboe-block/for-next akpm-mm/mm-everything kdave/for-next linus/master v6.4-rc1 next-20230510]
[If your patch is applied to the wrong git tree, kindly drop us a note.
And when submitting patch, we suggest to use &#39;--base&#39; as documented in
<a href="https://git-scm.com/docs/git-format-patch#_base_tree_information">https://git-scm.com/docs/git-format-patch#_base_tree_information</a>]

url:    <a href="https://github.com/intel-lab-lkp/linux/commits/Kent-Overstreet/Compiler-Attributes-add-__flatten/20230510-010302">https://github.com/intel-lab-lkp/linux/commits/Kent-Overstreet/Compiler-Attributes-add-__flatten/20230510-010302</a>
base:   tip/locking/core
patch link:    <a href="https://lore.kernel.org/r/20230509165657.1735798-24-kent.overstreet%40linux.dev">https://lore.kernel.org/r/20230509165657.1735798-24-kent.overstreet%40linux.dev</a>
patch subject: [PATCH 23/32] iov_iter: copy_folio_from_iter_atomic()
config: powerpc-randconfig-s042-20230509 (<a href="https://download.01.org/0day-ci/archive/20230511/202305110949.RCcHYzkJ-lkp@intel.com/config">https://download.01.org/0day-ci/archive/20230511/202305110949.RCcHYzkJ-lkp@intel.com/config</a>)
compiler: powerpc-linux-gcc (GCC) 12.1.0
reproduce:
        wget <a href="https://raw.githubusercontent.com/intel/lkp-tests/master/sbin/make.cross">https://raw.githubusercontent.com/intel/lkp-tests/master/sbin/make.cross</a> -O ~/bin/make.cross
        chmod +x ~/bin/make.cross
        # apt-get install sparse
        # sparse version: v0.6.4-39-gce1a6720-dirty
        # <a href="https://github.com/intel-lab-lkp/linux/commit/0e5d4229f5e7671dabba56ea36583b1ca20a9a18">https://github.com/intel-lab-lkp/linux/commit/0e5d4229f5e7671dabba56ea36583b1ca20a9a18</a>
        git remote add linux-review <a href="https://github.com/intel-lab-lkp/linux">https://github.com/intel-lab-lkp/linux</a>
        git fetch --no-tags linux-review Kent-Overstreet/Compiler-Attributes-add-__flatten/20230510-010302
        git checkout 0e5d4229f5e7671dabba56ea36583b1ca20a9a18
        # save the config file
        mkdir build_dir &amp;&amp; cp config build_dir/.config
        COMPILER_INSTALL_PATH=$HOME/0day COMPILER=gcc-12.1.0 make.cross C=1 CF=&#39;-fdiagnostic-prefix -D__CHECK_ENDIAN__&#39; O=build_dir ARCH=powerpc olddefconfig
        COMPILER_INSTALL_PATH=$HOME/0day COMPILER=gcc-12.1.0 make.cross C=1 CF=&#39;-fdiagnostic-prefix -D__CHECK_ENDIAN__&#39; O=build_dir ARCH=powerpc SHELL=/bin/bash

If you fix the issue, kindly add following tag where applicable
| Reported-by: kernel test robot &lt;lkp@intel.com&gt;
| Link: <a href="https://lore.kernel.org/oe-kbuild-all/202305110949.RCcHYzkJ-lkp@intel.com/">https://lore.kernel.org/oe-kbuild-all/202305110949.RCcHYzkJ-lkp@intel.com/</a>

sparse warnings: (new ones prefixed by &gt;&gt;)
<span>&gt;&gt; lib/iov_iter.c:839:30: sparse: sparse: incompatible types in comparison expression (different type sizes):
&gt;&gt; lib/iov_iter.c:839:30: sparse:    unsigned int *
&gt;&gt; lib/iov_iter.c:839:30: sparse:    unsigned long *
</span>
vim +839 lib/iov_iter.c

   825	
   826	size_t copy_folio_from_iter_atomic(struct folio *folio, size_t offset,
   827					   size_t bytes, struct iov_iter *i)
   828	{
   829		size_t ret = 0;
   830	
   831		if (WARN_ON(offset + bytes &gt; folio_size(folio)))
   832			return 0;
   833		if (WARN_ON_ONCE(!i-&gt;data_source))
   834			return 0;
   835	
   836	#ifdef CONFIG_HIGHMEM
   837		while (bytes) {
   838			struct page *page = folio_page(folio, offset &gt;&gt; PAGE_SHIFT);
 &gt; 839			unsigned b = min(bytes, PAGE_SIZE - (offset &amp; PAGE_MASK));
   840			unsigned r = __copy_page_from_iter_atomic(page, offset, b, i);
   841	
   842			offset	+= r;
   843			bytes	-= r;
   844			ret	+= r;
   845	
   846			if (r != b)
   847				break;
   848		}
   849	#else
   850		ret = __copy_page_from_iter_atomic(&amp;folio-&gt;page, offset, bytes, i);
   851	#endif
   852	
   853		return ret;
   854	}
   855	EXPORT_SYMBOL(copy_folio_from_iter_atomic);
   856	

-- 
0-DAY CI Kernel Test Service
<a href="https://github.com/intel/lkp-tests">https://github.com/intel/lkp-tests</a>

<a href="#m2be1ce6189d96241cbd4b322f136ff0da35e00ad" id="e2be1ce6189d96241cbd4b322f136ff0da35e00ad">^</a> <a href="https://payments.posthaven.com/202305110949.RCcHYzkJ-lkp@intel.com/">permalink</a> <a href="https://payments.posthaven.com/202305110949.RCcHYzkJ-lkp@intel.com/raw">raw</a> <a href="https://payments.posthaven.com/202305110949.RCcHYzkJ-lkp@intel.com/#R">reply</a>	[<a href="https://payments.posthaven.com/202305110949.RCcHYzkJ-lkp@intel.com/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/202305110949.RCcHYzkJ-lkp@intel.com/t/#u">nested</a>] <a href="#r2be1ce6189d96241cbd4b322f136ff0da35e00ad">73+ messages in thread</a></pre><hr/><pre><a href="#e97f5977d75b7ce418668cecd61d701579259c227" id="m97f5977d75b7ce418668cecd61d701579259c227">*</a> <b>Re: [PATCH 07/32] mm: Bring back vmalloc_exec</b>
  2023-05-09 21:54         ` <a href="#mb89bc221ea6ac376fb784f85f11766b68e139a44">Kent Overstreet</a>
<b>@ 2023-05-11  5:33           ` Theodore Ts&#39;o</b>
  2023-05-11  5:44             ` <a href="#m4e04d1fa99298e0b712d481ef8ffd0b8c62e759e">Kent Overstreet</a>
  <a href="#r97f5977d75b7ce418668cecd61d701579259c227">0 siblings, 1 reply; 73+ messages in thread</a>
From: Theodore Ts&#39;o @ 2023-05-11  5:33 UTC (<a href="https://payments.posthaven.com/ZFx+GOjabJIaJWU8@mit.edu/">permalink</a> / <a href="https://payments.posthaven.com/ZFx+GOjabJIaJWU8@mit.edu/raw">raw</a>)
  To: Kent Overstreet
  Cc: Darrick J. Wong, Lorenzo Stoakes, Christoph Hellwig,
	linux-kernel, linux-fsdevel, linux-bcachefs, Kent Overstreet,
	Andrew Morton, Uladzislau Rezki, linux-mm

On Tue, May 09, 2023 at 05:54:26PM -0400, Kent Overstreet wrote:
<span>&gt; 
&gt; I think it&#39;d be much more practical to find some way of making
&gt; vmalloc_exec() more palatable. What are the exact concerns?
</span>
Having a vmalloc_exec() function (whether it is not exported at all,
or exported as a GPL symbol) makes it *much* easier for an exploit
writer, since it&#39;s a super convenient gadget for use with
Returned-oriented-programming[1] to create a writeable, executable
space that could then be filled with arbitrary code of the exploit
author&#39;s arbitrary desire.

[1] <a href="https://en.wikipedia.org/wiki/Return-oriented_programming">https://en.wikipedia.org/wiki/Return-oriented_programming</a>

The other thing I&#39;ll note from examining the code generator, is that
it appears that bcachefs *only* has support for x86_64.  This brings
me back to the days of my youth when all the world was a Vax[2].  :-)

   10.  Thou shalt foreswear, renounce, and abjure the vile heresy
        which claimeth that ``All the world&#39;s a VAX&#39;&#39;, and have no commerce
	with the benighted heathens who cling to this barbarous belief, that
 	the days of thy program may be long even though the days of thy
	current machine be short.

	[ This particular heresy bids fair to be replaced by ``All the
	world&#39;s a Sun&#39;&#39; or ``All the world&#39;s a 386&#39;&#39; (this latter
	being a particularly revolting invention of Satan), but the
	words apply to all such without limitation. Beware, in
	particular, of the subtle and terrible ``All the world&#39;s a
	32-bit machine&#39;&#39;, which is almost true today but shall cease
	to be so before thy resume grows too much longer.]

[2] The Ten Commandments for C Programmers (Annotated Edition)
    <a href="https://www.lysator.liu.se/c/ten-commandments.html">https://www.lysator.liu.se/c/ten-commandments.html</a>

Seriously, does this mean that bcachefs won&#39;t work on Arm systems
(arm32 or arm64)?  Or Risc V systems?  Or S/390&#39;s?  Or Power
architectuers?  Or Itanium or PA-RISC systems?  (OK, I really don&#39;t
care all that much about those last two.  :-)


When people ask me why file systems are so hard to make enterprise
ready, I tell them to recall the general advice given to people to
write secure, robust systems: (a) avoid premature optimization, (b)
avoid fine-grained, multi-threaded programming, as much as possible,
because locking bugs are a b*tch, and (c) avoid unnecessary global
state as much as possible.

File systems tend to violate all of these precepts: (a) people chase
benchmark optimizations to the exclusion of all else, because people
have an unhealthy obsession with Phornix benchmark articles, (b) file
systems tend to be inherently multi-threaded, with lots of locks, and
(c) file systems are all about managing global state in the form of
files, directories, etc.

However, hiding a miniature architecture-specific compiler inside a
file system seems to be a rather blatent example of &#34;premature
optimization&#34;.

							- Ted

<a href="#m97f5977d75b7ce418668cecd61d701579259c227" id="e97f5977d75b7ce418668cecd61d701579259c227">^</a> <a href="https://payments.posthaven.com/ZFx+GOjabJIaJWU8@mit.edu/">permalink</a> <a href="https://payments.posthaven.com/ZFx+GOjabJIaJWU8@mit.edu/raw">raw</a> <a href="https://payments.posthaven.com/ZFx+GOjabJIaJWU8@mit.edu/#R">reply</a>	[<a href="https://payments.posthaven.com/ZFx+GOjabJIaJWU8@mit.edu/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/ZFx+GOjabJIaJWU8@mit.edu/t/#u">nested</a>] <a href="#r97f5977d75b7ce418668cecd61d701579259c227">73+ messages in thread</a></pre><hr/><pre><a href="#e4e04d1fa99298e0b712d481ef8ffd0b8c62e759e" id="m4e04d1fa99298e0b712d481ef8ffd0b8c62e759e">*</a> <b>Re: [PATCH 07/32] mm: Bring back vmalloc_exec</b>
  2023-05-11  5:33           ` <a href="#m97f5977d75b7ce418668cecd61d701579259c227">Theodore Ts&#39;o</a>
<b>@ 2023-05-11  5:44             ` Kent Overstreet</b>
  <a href="#r4e04d1fa99298e0b712d481ef8ffd0b8c62e759e">0 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-11  5:44 UTC (<a href="https://payments.posthaven.com/ZFyAr%2F9L3neIWpF8@moria.home.lan/">permalink</a> / <a href="https://payments.posthaven.com/ZFyAr%2F9L3neIWpF8@moria.home.lan/raw">raw</a>)
  To: Theodore Ts&#39;o
  Cc: Darrick J. Wong, Lorenzo Stoakes, Christoph Hellwig,
	linux-kernel, linux-fsdevel, linux-bcachefs, Kent Overstreet,
	Andrew Morton, Uladzislau Rezki, linux-mm

On Thu, May 11, 2023 at 01:33:12AM -0400, Theodore Ts&#39;o wrote:
<span>&gt; Seriously, does this mean that bcachefs won&#39;t work on Arm systems
&gt; (arm32 or arm64)?  Or Risc V systems?  Or S/390&#39;s?  Or Power
&gt; architectuers?  Or Itanium or PA-RISC systems?  (OK, I really don&#39;t
&gt; care all that much about those last two.  :-)
</span>
No :)

My CI servers are arm64 servers. There&#39;s a bch2_bkey_unpack_key()
written in C, that works on any architecture. But specializing for a
particular format is a not-insignificant performance improvement, so
writing an arm64 version has been on my todo list.

<span>&gt; When people ask me why file systems are so hard to make enterprise
&gt; ready, I tell them to recall the general advice given to people to
&gt; write secure, robust systems: (a) avoid premature optimization, (b)
&gt; avoid fine-grained, multi-threaded programming, as much as possible,
&gt; because locking bugs are a b*tch, and (c) avoid unnecessary global
&gt; state as much as possible.
&gt; 
&gt; File systems tend to violate all of these precepts: (a) people chase
&gt; benchmark optimizations to the exclusion of all else, because people
&gt; have an unhealthy obsession with Phornix benchmark articles, (b) file
&gt; systems tend to be inherently multi-threaded, with lots of locks, and
&gt; (c) file systems are all about managing global state in the form of
&gt; files, directories, etc.
&gt; 
&gt; However, hiding a miniature architecture-specific compiler inside a
&gt; file system seems to be a rather blatent example of &#34;premature
&gt; optimization&#34;.
</span>
Ted, this project is _15_ years old.

I&#39;m getting ready to write a full explanation of what this is for and
why it&#39;s important, I&#39;ve just been busy with the conference - and I want
to write something good, that provides all the context.

I&#39;ve also been mulling over fallback options, but I don&#39;t see any good
ones. The unspecialized, C version of unpack has branches (the absolute
minimum, I took my time when I was writing that code too); the
specialized versions are branchless and _much_ smaller, and the only way
to do that specialization is with some form of dynamic codegen.

But I do owe you all a detailed walkthrough of what this is all about,
so you&#39;ll get it in the next day or so.

Cheers,
Kent

<a href="#m4e04d1fa99298e0b712d481ef8ffd0b8c62e759e" id="e4e04d1fa99298e0b712d481ef8ffd0b8c62e759e">^</a> <a href="https://payments.posthaven.com/ZFyAr%2F9L3neIWpF8@moria.home.lan/">permalink</a> <a href="https://payments.posthaven.com/ZFyAr%2F9L3neIWpF8@moria.home.lan/raw">raw</a> <a href="https://payments.posthaven.com/ZFyAr%2F9L3neIWpF8@moria.home.lan/#R">reply</a>	[<a href="https://payments.posthaven.com/ZFyAr%2F9L3neIWpF8@moria.home.lan/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/ZFyAr%2F9L3neIWpF8@moria.home.lan/t/#u">nested</a>] <a href="#r4e04d1fa99298e0b712d481ef8ffd0b8c62e759e">73+ messages in thread</a></pre><hr/><pre><a href="#e9bebc063b3cd901afc9fff9a095dad9477a53db1" id="m9bebc063b3cd901afc9fff9a095dad9477a53db1">*</a> <b>Re: [PATCH 03/32] locking/lockdep: lockdep_set_no_check_recursion()</b>
  2023-05-10 20:38         ` <a href="#ma11a6138299bdcdd1ef0bd82aa3672a2c178d7fa">Kent Overstreet</a>
<b>@ 2023-05-11  8:25           ` Peter Zijlstra</b>
  2023-05-11  9:32             ` <a href="#mdc8b9d4f3a89091c668d257318914cb4a1e6a87e">Kent Overstreet</a>
  <a href="#r9bebc063b3cd901afc9fff9a095dad9477a53db1">0 siblings, 1 reply; 73+ messages in thread</a>
From: Peter Zijlstra @ 2023-05-11  8:25 UTC (<a href="https://payments.posthaven.com/20230511082544.GS4253@hirez.programming.kicks-ass.net/">permalink</a> / <a href="https://payments.posthaven.com/20230511082544.GS4253@hirez.programming.kicks-ass.net/raw">raw</a>)
  To: Kent Overstreet
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Ingo Molnar,
	Will Deacon, Waiman Long, Boqun Feng

On Wed, May 10, 2023 at 04:38:15PM -0400, Kent Overstreet wrote:
<span>&gt; On Wed, May 10, 2023 at 10:59:05AM +0200, Peter Zijlstra wrote:
</span>
<span>&gt; &gt; Have you read the ww_mutex code? If not, please do so, it does similar
&gt; &gt; things.
&gt; &gt; 
&gt; &gt; The way it gets around the self-nesting check is by using the nest_lock
&gt; &gt; annotation, the acquire context itself also has a dep_map for this
&gt; &gt; purpose.
&gt; 
&gt; This might work.
&gt; 
&gt; I was confused for a good bit when reading tho code to figure out how
&gt; it works - nest_lock seems to be a pretty bad name, it&#39;s really not a
&gt; lock. acquire_ctx?
</span>
That&#39;s just how ww_mutex uses it, the annotation itself comes from
mm_take_all_locks() where mm-&gt;mmap_lock (the lock formerly known as
mmap_sem) is used to serialize multi acquisition of vma locks.

That is, no other code takes multiple vma locks (be it i_mmap_rwsem or
anonvma-&gt;root-&gt;rwsem) in any order. These locks nest inside mmap_lock
and therefore by holding mmap_lock you serialize the whole thing and can
take them in any order you like.

Perhaps, now, all these many years later another name would&#39;ve made more
sense, but I don&#39;t think it&#39;s worth the hassle of the tree-wide rename
(there&#39;s a few other users since).

<a href="#m9bebc063b3cd901afc9fff9a095dad9477a53db1" id="e9bebc063b3cd901afc9fff9a095dad9477a53db1">^</a> <a href="https://payments.posthaven.com/20230511082544.GS4253@hirez.programming.kicks-ass.net/">permalink</a> <a href="https://payments.posthaven.com/20230511082544.GS4253@hirez.programming.kicks-ass.net/raw">raw</a> <a href="https://payments.posthaven.com/20230511082544.GS4253@hirez.programming.kicks-ass.net/#R">reply</a>	[<a href="https://payments.posthaven.com/20230511082544.GS4253@hirez.programming.kicks-ass.net/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/20230511082544.GS4253@hirez.programming.kicks-ass.net/t/#u">nested</a>] <a href="#r9bebc063b3cd901afc9fff9a095dad9477a53db1">73+ messages in thread</a></pre><hr/><pre><a href="#edc8b9d4f3a89091c668d257318914cb4a1e6a87e" id="mdc8b9d4f3a89091c668d257318914cb4a1e6a87e">*</a> <b>Re: [PATCH 03/32] locking/lockdep: lockdep_set_no_check_recursion()</b>
  2023-05-11  8:25           ` <a href="#m9bebc063b3cd901afc9fff9a095dad9477a53db1">Peter Zijlstra</a>
<b>@ 2023-05-11  9:32             ` Kent Overstreet</b>
  <a href="#rdc8b9d4f3a89091c668d257318914cb4a1e6a87e">0 siblings, 0 replies; 73+ messages in thread</a>
From: Kent Overstreet @ 2023-05-11  9:32 UTC (<a href="https://payments.posthaven.com/ZFy2JqL%2FxkvIn+O1@moria.home.lan/">permalink</a> / <a href="https://payments.posthaven.com/ZFy2JqL%2FxkvIn+O1@moria.home.lan/raw">raw</a>)
  To: Peter Zijlstra
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Ingo Molnar,
	Will Deacon, Waiman Long, Boqun Feng

On Thu, May 11, 2023 at 10:25:44AM +0200, Peter Zijlstra wrote:
<span>&gt; On Wed, May 10, 2023 at 04:38:15PM -0400, Kent Overstreet wrote:
&gt; &gt; On Wed, May 10, 2023 at 10:59:05AM +0200, Peter Zijlstra wrote:
&gt; 
&gt; &gt; &gt; Have you read the ww_mutex code? If not, please do so, it does similar
&gt; &gt; &gt; things.
&gt; &gt; &gt; 
&gt; &gt; &gt; The way it gets around the self-nesting check is by using the nest_lock
&gt; &gt; &gt; annotation, the acquire context itself also has a dep_map for this
&gt; &gt; &gt; purpose.
&gt; &gt; 
&gt; &gt; This might work.
&gt; &gt; 
&gt; &gt; I was confused for a good bit when reading tho code to figure out how
&gt; &gt; it works - nest_lock seems to be a pretty bad name, it&#39;s really not a
&gt; &gt; lock. acquire_ctx?
&gt; 
&gt; That&#39;s just how ww_mutex uses it, the annotation itself comes from
&gt; mm_take_all_locks() where mm-&gt;mmap_lock (the lock formerly known as
&gt; mmap_sem) is used to serialize multi acquisition of vma locks.
&gt; 
&gt; That is, no other code takes multiple vma locks (be it i_mmap_rwsem or
&gt; anonvma-&gt;root-&gt;rwsem) in any order. These locks nest inside mmap_lock
&gt; and therefore by holding mmap_lock you serialize the whole thing and can
&gt; take them in any order you like.
&gt; 
&gt; Perhaps, now, all these many years later another name would&#39;ve made more
&gt; sense, but I don&#39;t think it&#39;s worth the hassle of the tree-wide rename
&gt; (there&#39;s a few other users since).
</span>
Thanks for the history lesson :)

<a href="#mdc8b9d4f3a89091c668d257318914cb4a1e6a87e" id="edc8b9d4f3a89091c668d257318914cb4a1e6a87e">^</a> <a href="https://payments.posthaven.com/ZFy2JqL%2FxkvIn+O1@moria.home.lan/">permalink</a> <a href="https://payments.posthaven.com/ZFy2JqL%2FxkvIn+O1@moria.home.lan/raw">raw</a> <a href="https://payments.posthaven.com/ZFy2JqL%2FxkvIn+O1@moria.home.lan/#R">reply</a>	[<a href="https://payments.posthaven.com/ZFy2JqL%2FxkvIn+O1@moria.home.lan/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/ZFy2JqL%2FxkvIn+O1@moria.home.lan/t/#u">nested</a>] <a href="#rdc8b9d4f3a89091c668d257318914cb4a1e6a87e">73+ messages in thread</a></pre><hr/><pre><a href="#e413de2f22a49a50b48cef3d6c05c54ad4a845424" id="m413de2f22a49a50b48cef3d6c05c54ad4a845424">*</a> <b>Re: [PATCH 04/32] locking: SIX locks (shared/intent/exclusive)</b>
  2023-05-09 16:56 ` <a href="#mdf1a03c4a94e7bb6300666e5af4374084ddc4390">[PATCH 04/32] locking: SIX locks (shared/intent/exclusive)</a> Kent Overstreet
<b>@ 2023-05-11 12:14   ` Jan Engelhardt</b>
  <a href="#r413de2f22a49a50b48cef3d6c05c54ad4a845424">0 siblings, 0 replies; 73+ messages in thread</a>
From: Jan Engelhardt @ 2023-05-11 12:14 UTC (<a href="https://payments.posthaven.com/7233p553-861o-9772-n4nr-rr5424prq1r@vanv.qr/">permalink</a> / <a href="https://payments.posthaven.com/7233p553-861o-9772-n4nr-rr5424prq1r@vanv.qr/raw">raw</a>)
  To: Kent Overstreet
  Cc: linux-kernel, linux-fsdevel, linux-bcachefs, Kent Overstreet,
	Peter Zijlstra, Ingo Molnar, Will Deacon, Waiman Long,
	Boqun Feng


On Tuesday 2023-05-09 18:56, Kent Overstreet wrote:
<span>&gt;--- /dev/null
&gt;+++ b/include/linux/six.h
&gt;@@ -0,0 +1,210 @@
&gt;+ * There are also operations that take the lock type as a parameter, where the
&gt;+ * type is one of SIX_LOCK_read, SIX_LOCK_intent, or SIX_LOCK_write:
&gt;+ *
&gt;+ *   six_lock_type(lock, type)
&gt;+ *   six_unlock_type(lock, type)
&gt;+ *   six_relock(lock, type, seq)
&gt;+ *   six_trylock_type(lock, type)
&gt;+ *   six_trylock_convert(lock, from, to)
&gt;+ *
&gt;+ * A lock may be held multiple types by the same thread (for read or intent,
</span>
&#34;multiple times&#34;

<span>&gt;+// SPDX-License-Identifier: GPL-2.0
</span>
The currently SPDX list only knows &#34;GPL-2.0-only&#34; or &#34;GPL-2.0-or-later&#34;,
please edit.

<a href="#m413de2f22a49a50b48cef3d6c05c54ad4a845424" id="e413de2f22a49a50b48cef3d6c05c54ad4a845424">^</a> <a href="https://payments.posthaven.com/7233p553-861o-9772-n4nr-rr5424prq1r@vanv.qr/">permalink</a> <a href="https://payments.posthaven.com/7233p553-861o-9772-n4nr-rr5424prq1r@vanv.qr/raw">raw</a> <a href="https://payments.posthaven.com/7233p553-861o-9772-n4nr-rr5424prq1r@vanv.qr/#R">reply</a>	[<a href="https://payments.posthaven.com/7233p553-861o-9772-n4nr-rr5424prq1r@vanv.qr/T/#u"><b>flat</b></a>|<a href="https://payments.posthaven.com/7233p553-861o-9772-n4nr-rr5424prq1r@vanv.qr/t/#u">nested</a>] <a href="#r413de2f22a49a50b48cef3d6c05c54ad4a845424">73+ messages in thread</a></pre><hr/><pre>end of thread, other threads:[<a href="https://payments.posthaven.com/?t=20230511121507">~2023-05-11 12:15 UTC</a> | <a href="https://payments.posthaven.com/">newest</a>]

<b id="t">Thread overview:</b> 73+ messages (download: <a href="https://payments.posthaven.com/t.mbox.gz">mbox.gz</a> / follow: <a href="https://payments.posthaven.com/t.atom">Atom feed</a>)
-- links below jump to the message on this page --
2023-05-09 16:56 <a href="#mf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44" id="rf171fd06ffa420fe1bcf0f49a2b44a361ca6ac44">[PATCH 00/32] bcachefs - a new COW filesystem</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#mda332a98731952301e95c9833fb1fd717bbe69c4" id="rda332a98731952301e95c9833fb1fd717bbe69c4">[PATCH 01/32] Compiler Attributes: add __flatten</a> Kent Overstreet
2023-05-09 17:04   ` <a href="#m72440a5aab6a33b89f4437cba0c7ddf673ba9771" id="r72440a5aab6a33b89f4437cba0c7ddf673ba9771">Miguel Ojeda</a>
2023-05-09 17:24     ` <a href="#md90808a3e0fc85cadda811f5d882ae24841e4ac7" id="rd90808a3e0fc85cadda811f5d882ae24841e4ac7">Kent Overstreet</a>
2023-05-09 16:56 ` <a href="#m86cd2a43c7ceeb60c0a4e313c199deb289199877" id="r86cd2a43c7ceeb60c0a4e313c199deb289199877">[PATCH 02/32] locking/lockdep: lock_class_is_held()</a> Kent Overstreet
2023-05-09 19:30   ` <a href="#me6217c7916bdf0763c1175f29137722e31dc943c" id="re6217c7916bdf0763c1175f29137722e31dc943c">Peter Zijlstra</a>
2023-05-09 20:11     ` <a href="#m05f9f3c5016228a09d1b54acf882c1bdf7512f16" id="r05f9f3c5016228a09d1b54acf882c1bdf7512f16">Kent Overstreet</a>
2023-05-09 16:56 ` <a href="#m5ed7c55399215bfa0a81888ebb4421bfa03cf35b" id="r5ed7c55399215bfa0a81888ebb4421bfa03cf35b">[PATCH 03/32] locking/lockdep: lockdep_set_no_check_recursion()</a> Kent Overstreet
2023-05-09 19:31   ` <a href="#mdc1c43efeeae88da82cf5e2a930303b1dd0fd99e" id="rdc1c43efeeae88da82cf5e2a930303b1dd0fd99e">Peter Zijlstra</a>
2023-05-09 19:57     ` <a href="#m670b7c1071b0982068fc786f48cc3a5910599a38" id="r670b7c1071b0982068fc786f48cc3a5910599a38">Kent Overstreet</a>
2023-05-09 20:18     ` <a href="#m4c5848c5e0839861066340c7f2aa5e237ba6c2ea" id="r4c5848c5e0839861066340c7f2aa5e237ba6c2ea">Kent Overstreet</a>
2023-05-09 20:27       ` <a href="#m300bc72c7328f6808bafb4f9a78a04d953029686" id="r300bc72c7328f6808bafb4f9a78a04d953029686">Waiman Long</a>
2023-05-09 20:35         ` <a href="#m1a9c685bfb0e1f61d9fdca7b290974dee2c0f412" id="r1a9c685bfb0e1f61d9fdca7b290974dee2c0f412">Kent Overstreet</a>
2023-05-09 21:37           ` <a href="#me18094d9aa57bec6c9c8ea68aaae73d60e7c4152" id="re18094d9aa57bec6c9c8ea68aaae73d60e7c4152">Waiman Long</a>
2023-05-10  8:59       ` <a href="#mc00ab06c40f934efbc30a1f117ec7336e9c0dcfa" id="rc00ab06c40f934efbc30a1f117ec7336e9c0dcfa">Peter Zijlstra</a>
2023-05-10 20:38         ` <a href="#ma11a6138299bdcdd1ef0bd82aa3672a2c178d7fa" id="ra11a6138299bdcdd1ef0bd82aa3672a2c178d7fa">Kent Overstreet</a>
2023-05-11  8:25           ` <a href="#m9bebc063b3cd901afc9fff9a095dad9477a53db1" id="r9bebc063b3cd901afc9fff9a095dad9477a53db1">Peter Zijlstra</a>
2023-05-11  9:32             ` <a href="#mdc8b9d4f3a89091c668d257318914cb4a1e6a87e" id="rdc8b9d4f3a89091c668d257318914cb4a1e6a87e">Kent Overstreet</a>
2023-05-09 16:56 ` <a href="#mdf1a03c4a94e7bb6300666e5af4374084ddc4390" id="rdf1a03c4a94e7bb6300666e5af4374084ddc4390">[PATCH 04/32] locking: SIX locks (shared/intent/exclusive)</a> Kent Overstreet
2023-05-11 12:14   ` <a href="#m413de2f22a49a50b48cef3d6c05c54ad4a845424" id="r413de2f22a49a50b48cef3d6c05c54ad4a845424">Jan Engelhardt</a>
2023-05-09 16:56 ` <a href="#m8684754525a2d9a18e06f6d5f8b3cb9704c79a90" id="r8684754525a2d9a18e06f6d5f8b3cb9704c79a90">[PATCH 05/32] MAINTAINERS: Add entry for six locks</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#mc6f62d46382370e1205be68249bfa6f9a8f7f35c" id="rc6f62d46382370e1205be68249bfa6f9a8f7f35c">[PATCH 06/32] sched: Add task_struct-&gt;faults_disabled_mapping</a> Kent Overstreet
2023-05-10  1:07   ` <a href="#m613d136f0d8a1ed3d18224d73c012f467295aa60" id="r613d136f0d8a1ed3d18224d73c012f467295aa60">Jan Kara</a>
2023-05-10  6:18     ` <a href="#m7cce75af26bf200b94dfafb53ca15f2f2b12f1de" id="r7cce75af26bf200b94dfafb53ca15f2f2b12f1de">Kent Overstreet</a>
2023-05-09 16:56 ` <a href="#mcabddb3f4bded12301500ae05b7bcb26474a2aa4" id="rcabddb3f4bded12301500ae05b7bcb26474a2aa4">[PATCH 07/32] mm: Bring back vmalloc_exec</a> Kent Overstreet
2023-05-09 18:19   ` <a href="#m4441d42cf9b00ca0af1c77affa4e0e32fc889be6" id="r4441d42cf9b00ca0af1c77affa4e0e32fc889be6">Lorenzo Stoakes</a>
2023-05-09 20:15     ` <a href="#m9afc6b0109fc157fe194c22d7343b4370bdbaa9d" id="r9afc6b0109fc157fe194c22d7343b4370bdbaa9d">Kent Overstreet</a>
2023-05-09 20:46   ` <a href="#mfa639982c8ae26fa0750bbf9244a1d3272ef00a0" id="rfa639982c8ae26fa0750bbf9244a1d3272ef00a0">Christoph Hellwig</a>
2023-05-09 21:12     ` <a href="#m7ee439ad1f809f0b1feb30dd0b4c3de50dbe5098" id="r7ee439ad1f809f0b1feb30dd0b4c3de50dbe5098">Lorenzo Stoakes</a>
2023-05-09 21:29       ` <a href="#mde4acd2516e5034c6dd79bff2c54932802f8c9b5" id="rde4acd2516e5034c6dd79bff2c54932802f8c9b5">Kent Overstreet</a>
2023-05-10  6:48         ` <a href="#mc945d16c820fcbc010bcdbf7c73ae1f57d502a07" id="rc945d16c820fcbc010bcdbf7c73ae1f57d502a07">Eric Biggers</a>
2023-05-10 11:56         ` <a href="#m07f44d5a1a85f6f7e2f92cf648aa8876fb10ab60" id="r07f44d5a1a85f6f7e2f92cf648aa8876fb10ab60">David Laight</a>
2023-05-09 21:43       ` <a href="#mf4d4ed092002ad0a50c9a5ce05c638b1d6e8987c" id="rf4d4ed092002ad0a50c9a5ce05c638b1d6e8987c">Darrick J. Wong</a>
2023-05-09 21:54         ` <a href="#mb89bc221ea6ac376fb784f85f11766b68e139a44" id="rb89bc221ea6ac376fb784f85f11766b68e139a44">Kent Overstreet</a>
2023-05-11  5:33           ` <a href="#m97f5977d75b7ce418668cecd61d701579259c227" id="r97f5977d75b7ce418668cecd61d701579259c227">Theodore Ts&#39;o</a>
2023-05-11  5:44             ` <a href="#m4e04d1fa99298e0b712d481ef8ffd0b8c62e759e" id="r4e04d1fa99298e0b712d481ef8ffd0b8c62e759e">Kent Overstreet</a>
2023-05-10 14:18   ` <a href="#m9cd8ae95b882e838cc1b43927a152aa3128f5b45" id="r9cd8ae95b882e838cc1b43927a152aa3128f5b45">Christophe Leroy</a>
2023-05-10 15:05   ` <a href="#m815f98c7cb3a865c0378ae5c190f234cf5b2c645" id="r815f98c7cb3a865c0378ae5c190f234cf5b2c645">Johannes Thumshirn</a>
2023-05-09 16:56 ` <a href="#m702650dbd641de54c259f6831566def2a84bf204" id="r702650dbd641de54c259f6831566def2a84bf204">[PATCH 08/32] fs: factor out d_mark_tmpfile()</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#m65fc2af60840e53f8cf40f795a9d3eeea31252f6" id="r65fc2af60840e53f8cf40f795a9d3eeea31252f6">[PATCH 09/32] block: Add some exports for bcachefs</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#m5498b0871049061f28297c94aaab0ce25f38bba9" id="r5498b0871049061f28297c94aaab0ce25f38bba9">[PATCH 10/32] block: Allow bio_iov_iter_get_pages() with bio-&gt;bi_bdev unset</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#m49b14c550668d20a55fa7b8c5d7f8a286b60e0ad" id="r49b14c550668d20a55fa7b8c5d7f8a286b60e0ad">[PATCH 11/32] block: Bring back zero_fill_bio_iter</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#me7c73abf299cc9cefad55241f69d34f076de39ea" id="re7c73abf299cc9cefad55241f69d34f076de39ea">[PATCH 12/32] block: Rework bio_for_each_segment_all()</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#maca8f244af9569907d098909fdf84087d95d7acd" id="raca8f244af9569907d098909fdf84087d95d7acd">[PATCH 13/32] block: Rework bio_for_each_folio_all()</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#m34397a4d39f5988cc0b635e29f70a6170927746f" id="r34397a4d39f5988cc0b635e29f70a6170927746f">[PATCH 14/32] block: Don&#39;t block on s_umount from __invalidate_super()</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#m808e33cd7146a6cf25568dd0527029deacdc1f57" id="r808e33cd7146a6cf25568dd0527029deacdc1f57">[PATCH 15/32] bcache: move closures to lib/</a> Kent Overstreet
2023-05-10  1:10   ` <a href="#m38a9689ff588cd1e3a641de6183a3213bb0a103b" id="r38a9689ff588cd1e3a641de6183a3213bb0a103b">Randy Dunlap</a>
2023-05-09 16:56 ` <a href="#m766da299d420970b1b3f7ac489b0d1393f2da35d" id="r766da299d420970b1b3f7ac489b0d1393f2da35d">[PATCH 16/32] MAINTAINERS: Add entry for closures</a> Kent Overstreet
2023-05-09 17:05   ` <a href="#mbb2558522aa7d939e3d68574ae0ae4a8acfaae61" id="rbb2558522aa7d939e3d68574ae0ae4a8acfaae61">Coly Li</a>
2023-05-09 21:03   ` <a href="#m1da07d4e58363b6d528f2a64372eb80c78d0b92f" id="r1da07d4e58363b6d528f2a64372eb80c78d0b92f">Randy Dunlap</a>
2023-05-09 16:56 ` <a href="#m26517bcd26c9764cee8234a773e737b705211bb3" id="r26517bcd26c9764cee8234a773e737b705211bb3">[PATCH 17/32] closures: closure_wait_event()</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#md7a0cc0ae16f7122387e4f90ff5274287512e12d" id="rd7a0cc0ae16f7122387e4f90ff5274287512e12d">[PATCH 18/32] closures: closure_nr_remaining()</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#m938b57c7d21ba84793e9eb47c121f5bf7dd1c9ea" id="r938b57c7d21ba84793e9eb47c121f5bf7dd1c9ea">[PATCH 19/32] closures: Add a missing include</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#m23d3c4393a27a0337fc775be7136fdf01bd20a64" id="r23d3c4393a27a0337fc775be7136fdf01bd20a64">[PATCH 20/32] vfs: factor out inode hash head calculation</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#m20c403d1bc99dafdf25c76ce50ec9c9cf8eb7e04" id="r20c403d1bc99dafdf25c76ce50ec9c9cf8eb7e04">[PATCH 21/32] hlist-bl: add hlist_bl_fake()</a> Kent Overstreet
2023-05-10  4:48   ` <a href="#m93c547f5d42cdc1f61d75f164b8fac7ae9110e76" id="r93c547f5d42cdc1f61d75f164b8fac7ae9110e76">Dave Chinner</a>
2023-05-09 16:56 ` <a href="#m9a45d1eb8402cf51d25f06fda723d3f9a42457f0" id="r9a45d1eb8402cf51d25f06fda723d3f9a42457f0">[PATCH 22/32] vfs: inode cache conversion to hash-bl</a> Kent Overstreet
2023-05-10  4:45   ` <a href="#m5e84bf1b54b345170f06c3cef8743db555c982aa" id="r5e84bf1b54b345170f06c3cef8743db555c982aa">Dave Chinner</a>
2023-05-09 16:56 ` <a href="#mb432faef6999d4df09b333f1d1842e1989b7be4d" id="rb432faef6999d4df09b333f1d1842e1989b7be4d">[PATCH 23/32] iov_iter: copy_folio_from_iter_atomic()</a> Kent Overstreet
2023-05-10  2:20   ` <a href="#m5828ea4e5b889cfc135329e431ec2be9179194ba" id="r5828ea4e5b889cfc135329e431ec2be9179194ba">kernel test robot</a>
2023-05-11  2:08   ` <a href="#m2be1ce6189d96241cbd4b322f136ff0da35e00ad" id="r2be1ce6189d96241cbd4b322f136ff0da35e00ad">kernel test robot</a>
2023-05-09 16:56 ` <a href="#md351e32f2d22a702c7790ac75cdff4ff5bb75be0" id="rd351e32f2d22a702c7790ac75cdff4ff5bb75be0">[PATCH 24/32] MAINTAINERS: Add entry for generic-radix-tree</a> Kent Overstreet
2023-05-09 21:03   ` <a href="#mbe2af624344228cc4957a1fab50b261b52fb408a" id="rbe2af624344228cc4957a1fab50b261b52fb408a">Randy Dunlap</a>
2023-05-09 16:56 ` <a href="#mf14a5bed7c254335976abe8dc95464076df5d2a8" id="rf14a5bed7c254335976abe8dc95464076df5d2a8">[PATCH 25/32] lib/generic-radix-tree.c: Don&#39;t overflow in peek()</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#m2263dc10e0138c8c3ef6d8030dae2cb8716cf3a6" id="r2263dc10e0138c8c3ef6d8030dae2cb8716cf3a6">[PATCH 26/32] lib/generic-radix-tree.c: Add a missing include</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#m00d67d9cabe02fc86e9073ada90a91501b11267e" id="r00d67d9cabe02fc86e9073ada90a91501b11267e">[PATCH 27/32] lib/generic-radix-tree.c: Add peek_prev()</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#mf522e4c439373af3164ac7333e4a2d8960904f15" id="rf522e4c439373af3164ac7333e4a2d8960904f15">[PATCH 28/32] stacktrace: Export stack_trace_save_tsk</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#md9f53a37fa6f09af1330005af56d57b88b7bc668" id="rd9f53a37fa6f09af1330005af56d57b88b7bc668">[PATCH 29/32] lib/string_helpers: string_get_size() now returns characters wrote</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#ma3574e520d51015d372e8411eaad6e0688b31158" id="ra3574e520d51015d372e8411eaad6e0688b31158">[PATCH 30/32] lib: Export errname</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#m86c8777e4dadc4d7c0a6fa4ecc59f7c9315dff8c" id="r86c8777e4dadc4d7c0a6fa4ecc59f7c9315dff8c">[PATCH 31/32] lib: add mean and variance module</a> Kent Overstreet
2023-05-09 16:56 ` <a href="#m1452c4f62de7e7806f01f4afe55d78271a434b81" id="r1452c4f62de7e7806f01f4afe55d78271a434b81">[PATCH 32/32] MAINTAINERS: Add entry for bcachefs</a> Kent Overstreet
2023-05-09 21:04   ` <a href="#m037ca88ece9bd977aa1ac140dc7dbf3b38a5cd51" id="r037ca88ece9bd977aa1ac140dc7dbf3b38a5cd51">Randy Dunlap</a>
2023-05-09 21:07     ` <a href="#mf115c2449f934a1cacb166cb987457dc0cc65c6b" id="rf115c2449f934a1cacb166cb987457dc0cc65c6b">Kent Overstreet</a>
</pre><hr/><pre>This is a public inbox, see <a href="https://payments.posthaven.com/_/text/mirror/">mirroring instructions</a>
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).</pre></div>
  </body>
</html>
