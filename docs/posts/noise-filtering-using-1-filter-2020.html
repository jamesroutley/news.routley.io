<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jaantollander.com/post/noise-filtering-using-one-euro-filter/">Original</a>
    <h1>Noise Filtering Using €1 Filter (2020)</h1>
    
    <div id="readability-page-1" class="page"><div><details open=""><summary>Table of Contents</summary><nav id="TableOfContents"><ul><li><a href="#introduction">Introduction</a></li><li><a href="#1-filter">1€ Filter</a></li><li><a href="#algorithm">Algorithm</a></li><li><a href="#tuning-the-filter">Tuning the Filter</a></li><li><a href="#python-implementation">Python Implementation</a></li><li><a href="#conclusions">Conclusions</a></li><li><a href="#contribute">Contribute</a></li><li><a href="#references">References</a></li></ul></nav></details><h2 id="introduction">Introduction</h2><p>This article explores the <a href="http://cristal.univ-lille.fr/~casiez/1euro/" target="_blank" rel="noopener">1€ Filter</a>, a simple, but powerful algorithm for filtering noisy real-time signals. The article focuses on the practical implementation of the algorithm, and it covers the mathematical basis, a pseudocode implementation, and simple, pure Python implementation of the algorithm. To understand why and how the filter works, we recommend reading the original article <sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup>.</p><h2 id="1-filter">1€ Filter</h2><p>The 1€ Filter is a low pass filter for filtering noisy signals in real-time. It is also a simple filter with only two configurable parameters. The signal at time $T_i$ is denoted as value $X_i$ and the filtered signal as value $\hat{X}_i$. The filter uses <strong>exponential smoothing</strong></p><p>$$\hat{X}_1 = X_1$$
$$\hat{X}_i = α X_i + (1-α) \hat{X} _{i-1},\quad i≥2
\tag{1}
\label{1}
$$</p><p>where the smoothing factor $α∈[0, 1]$, instead of being a constant, is adaptive, that is, dynamically computed using information about the rate of change (speed) of the signal. The adaptive smoothing factor aims to balance the jitter versus lag trade-off since people are sensitive to jitter at low speeds and more sensitive to lag at high speeds. The <strong>smoothing factor</strong> is defined as</p><p>$$α = \frac{1}{1 + \dfrac{τ}{T_e}},$$</p><p>where $T_e$ is the <strong>sampling period</strong> computed from the time difference between the samples</p><p>$$T_e=T_i-T _{i-1}$$</p><p>and $τ$ is <strong>time constant</strong> computed using the cutoff frequency</p><p>$$τ = \frac{1}{2πf_C}.$$</p><p>The <strong>cutoff frequency</strong> $f_C$ increases linearly as the rate of change, aka speed, increases</p><p>$$f_C=f_{C_{min}} + β|\hat{\dot{X}}_i|$$</p><p>where $f _{C _{min}}&gt;0$ is the <strong>minimum cutoff frequency</strong>, $β&gt;0$ is the <strong>speed coefficient</strong> and $\hat{\dot{X}}_i$ is the filtered rate of change. We define the rate of change $\hat{X}_i$ as the discrete derivative of the signal</p><p>$$\dot{X}_1 = 0$$
$$\dot{X}_i = \frac{X_i-\hat{X} _{i-1}}{T_e},\quad i≥2$$</p><p>which is then filtered using exponential smoothing $\eqref{1}$ with a constant cutoff frequency $f_{C_d},$ by default $f_{C_d}=1$.</p><h2 id="algorithm">Algorithm</h2><p>In this section, we implement the 1€ filter algorithm as pseudocode. The precise implementation of the algorithm depends on the programming language and paradigm in question. We have written this algorithm using a functional style.</p><p>$\operatorname{Smoothing-Factor}(f_C, T_e)$</p><ol><li>$r=2π⋅f_c⋅T_e$</li><li><strong>return</strong> $\dfrac{r}{r+1}$</li></ol><p>$\operatorname{Exponential-Smoothing}(α, X_i, \hat{X}_{i-1})$</p><ol><li><strong>return</strong> $α X_i + (1-α) \hat{X}_{i-1}$</li></ol><p>$\operatorname{One-Euro-Filter}(T_i,X_i,T_{i-1},\hat{X}_{i-1},\hat{\dot{X}}_{i-1},f_C,β,f_{C_d}),\quad i≥2$</p><ol><li>$T_e=T_i-T_{i-1}$</li><li>$α_d=\operatorname{Smoothing-Factor}(T_e, f_{C_d})$</li><li>$\dot{X}_i = \dfrac{X_i-\hat{X} _{i-1}}{T_e}$</li><li>$\hat{\dot{X}}_i=\operatorname{Exponential-Smoothing}(α_d, \dot{X}_i, \hat{\dot{X}} _{i-1})$</li><li>$f_C=f_{C_{min}} + β|\hat{\dot{X}}_i|$</li><li>$α=\operatorname{Smoothing-Factor}(f_C, T_e)$</li><li>$\hat{X}_i=\operatorname{Exponential-Smoothing}(α, X_i, \hat{X} _{i-1})$</li><li><strong>return</strong> $T_i,\hat{X}_i,\hat{\dot{X}}_i$</li></ol><h2 id="tuning-the-filter">Tuning the Filter</h2><p>There are two configurable parameters in the model, the <strong>minimum cutoff frequency</strong> $f _{C _{min}}$ and the <strong>speed coefficient</strong> $β$. Decreasing the minimum cutoff frequency decreases slow speed jitter. Increasing the speed coefficient decreases speed lag.</p><h2 id="python-implementation">Python Implementation</h2><p>The following Python implementation is available in the <a href="https://github.com/jaantollander/OneEuroFilter" target="_blank" rel="noopener"><strong>OneEuroFilter</strong></a> GitHub repository.</p><p>The object-oriented approach stores the previous values inside the object instead of explicitly giving them a return value as functional implementation would. It should be relatively simple to implement this algorithm in other languages.</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>import</span> <span>math</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>smoothing_factor</span><span>(</span><span>t_e</span><span>,</span> <span>cutoff</span><span>):</span>
</span></span><span><span>    <span>r</span> <span>=</span> <span>2</span> <span>*</span> <span>math</span><span>.</span><span>pi</span> <span>*</span> <span>cutoff</span> <span>*</span> <span>t_e</span>
</span></span><span><span>    <span>return</span> <span>r</span> <span>/</span> <span>(</span><span>r</span> <span>+</span> <span>1</span><span>)</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>exponential_smoothing</span><span>(</span><span>a</span><span>,</span> <span>x</span><span>,</span> <span>x_prev</span><span>):</span>
</span></span><span><span>    <span>return</span> <span>a</span> <span>*</span> <span>x</span> <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>a</span><span>)</span> <span>*</span> <span>x_prev</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>class</span> <span>OneEuroFilter</span><span>:</span>
</span></span><span><span>    <span>def</span> <span>__init__</span><span>(</span><span>self</span><span>,</span> <span>t0</span><span>,</span> <span>x0</span><span>,</span> <span>dx0</span><span>=</span><span>0.0</span><span>,</span> <span>min_cutoff</span><span>=</span><span>1.0</span><span>,</span> <span>beta</span><span>=</span><span>0.0</span><span>,</span>
</span></span><span><span>                 <span>d_cutoff</span><span>=</span><span>1.0</span><span>):</span>
</span></span><span><span>        <span>&#34;&#34;&#34;Initialize the one euro filter.&#34;&#34;&#34;</span>
</span></span><span><span>        <span># The parameters.</span>
</span></span><span><span>        <span>self</span><span>.</span><span>min_cutoff</span> <span>=</span> <span>float</span><span>(</span><span>min_cutoff</span><span>)</span>
</span></span><span><span>        <span>self</span><span>.</span><span>beta</span> <span>=</span> <span>float</span><span>(</span><span>beta</span><span>)</span>
</span></span><span><span>        <span>self</span><span>.</span><span>d_cutoff</span> <span>=</span> <span>float</span><span>(</span><span>d_cutoff</span><span>)</span>
</span></span><span><span>        <span># Previous values.</span>
</span></span><span><span>        <span>self</span><span>.</span><span>x_prev</span> <span>=</span> <span>float</span><span>(</span><span>x0</span><span>)</span>
</span></span><span><span>        <span>self</span><span>.</span><span>dx_prev</span> <span>=</span> <span>float</span><span>(</span><span>dx0</span><span>)</span>
</span></span><span><span>        <span>self</span><span>.</span><span>t_prev</span> <span>=</span> <span>float</span><span>(</span><span>t0</span><span>)</span>
</span></span><span><span>
</span></span><span><span>    <span>def</span> <span>__call__</span><span>(</span><span>self</span><span>,</span> <span>t</span><span>,</span> <span>x</span><span>):</span>
</span></span><span><span>        <span>&#34;&#34;&#34;Compute the filtered signal.&#34;&#34;&#34;</span>
</span></span><span><span>        <span>t_e</span> <span>=</span> <span>t</span> <span>-</span> <span>self</span><span>.</span><span>t_prev</span>
</span></span><span><span>
</span></span><span><span>        <span># The filtered derivative of the signal.</span>
</span></span><span><span>        <span>a_d</span> <span>=</span> <span>smoothing_factor</span><span>(</span><span>t_e</span><span>,</span> <span>self</span><span>.</span><span>d_cutoff</span><span>)</span>
</span></span><span><span>        <span>dx</span> <span>=</span> <span>(</span><span>x</span> <span>-</span> <span>self</span><span>.</span><span>x_prev</span><span>)</span> <span>/</span> <span>t_e</span>
</span></span><span><span>        <span>dx_hat</span> <span>=</span> <span>exponential_smoothing</span><span>(</span><span>a_d</span><span>,</span> <span>dx</span><span>,</span> <span>self</span><span>.</span><span>dx_prev</span><span>)</span>
</span></span><span><span>
</span></span><span><span>        <span># The filtered signal.</span>
</span></span><span><span>        <span>cutoff</span> <span>=</span> <span>self</span><span>.</span><span>min_cutoff</span> <span>+</span> <span>self</span><span>.</span><span>beta</span> <span>*</span> <span>abs</span><span>(</span><span>dx_hat</span><span>)</span>
</span></span><span><span>        <span>a</span> <span>=</span> <span>smoothing_factor</span><span>(</span><span>t_e</span><span>,</span> <span>cutoff</span><span>)</span>
</span></span><span><span>        <span>x_hat</span> <span>=</span> <span>exponential_smoothing</span><span>(</span><span>a</span><span>,</span> <span>x</span><span>,</span> <span>self</span><span>.</span><span>x_prev</span><span>)</span>
</span></span><span><span>
</span></span><span><span>        <span># Memorize the previous values.</span>
</span></span><span><span>        <span>self</span><span>.</span><span>x_prev</span> <span>=</span> <span>x_hat</span>
</span></span><span><span>        <span>self</span><span>.</span><span>dx_prev</span> <span>=</span> <span>dx_hat</span>
</span></span><span><span>        <span>self</span><span>.</span><span>t_prev</span> <span>=</span> <span>t</span>
</span></span><span><span>
</span></span><span><span>        <span>return</span> <span>x_hat</span>
</span></span></code></pre></div><p>Code for the plot:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>import</span> <span>matplotlib.pyplot</span> <span>as</span> <span>plt</span>
</span></span><span><span><span>import</span> <span>numpy</span> <span>as</span> <span>np</span>
</span></span><span><span><span>import</span> <span>seaborn</span>
</span></span><span><span><span>from</span> <span>matplotlib.animation</span> <span>import</span> <span>FuncAnimation</span>
</span></span><span><span>
</span></span><span><span><span>from</span> <span>one_euro_filter</span> <span>import</span> <span>OneEuroFilter</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>np</span><span>.</span><span>random</span><span>.</span><span>seed</span><span>(</span><span>1</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span># Parameters</span>
</span></span><span><span><span>frames</span> <span>=</span> <span>100</span>
</span></span><span><span><span>start</span> <span>=</span> <span>0</span>
</span></span><span><span><span>end</span> <span>=</span> <span>4</span> <span>*</span> <span>np</span><span>.</span><span>pi</span>
</span></span><span><span><span>scale</span> <span>=</span> <span>0.05</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span># The noisy signal</span>
</span></span><span><span><span>t</span> <span>=</span> <span>np</span><span>.</span><span>linspace</span><span>(</span><span>start</span><span>,</span> <span>end</span><span>,</span> <span>frames</span><span>)</span>
</span></span><span><span><span>x</span> <span>=</span> <span>np</span><span>.</span><span>sin</span><span>(</span><span>t</span><span>)</span>
</span></span><span><span><span>x_noisy</span> <span>=</span> <span>x</span> <span>+</span> <span>np</span><span>.</span><span>random</span><span>.</span><span>normal</span><span>(</span><span>scale</span><span>=</span><span>scale</span><span>,</span> <span>size</span><span>=</span><span>len</span><span>(</span><span>t</span><span>))</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span># The filtered signal</span>
</span></span><span><span><span>min_cutoff</span> <span>=</span> <span>0.004</span>
</span></span><span><span><span>beta</span> <span>=</span> <span>0.7</span>
</span></span><span><span><span>x_hat</span> <span>=</span> <span>np</span><span>.</span><span>zeros_like</span><span>(</span><span>x_noisy</span><span>)</span>
</span></span><span><span><span>x_hat</span><span>[</span><span>0</span><span>]</span> <span>=</span> <span>x_noisy</span><span>[</span><span>0</span><span>]</span>
</span></span><span><span><span>one_euro_filter</span> <span>=</span> <span>OneEuroFilter</span><span>(</span>
</span></span><span><span>    <span>t</span><span>[</span><span>0</span><span>],</span> <span>x_noisy</span><span>[</span><span>0</span><span>],</span>
</span></span><span><span>    <span>min_cutoff</span><span>=</span><span>min_cutoff</span><span>,</span>
</span></span><span><span>    <span>beta</span><span>=</span><span>beta</span>
</span></span><span><span><span>)</span>
</span></span><span><span><span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>1</span><span>,</span> <span>len</span><span>(</span><span>t</span><span>)):</span>
</span></span><span><span>    <span>x_hat</span><span>[</span><span>i</span><span>]</span> <span>=</span> <span>one_euro_filter</span><span>(</span><span>t</span><span>[</span><span>i</span><span>],</span> <span>x_noisy</span><span>[</span><span>i</span><span>])</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span># The figure</span>
</span></span><span><span><span># https://eli.thegreenplace.net/2016/drawing-animated-gifs-with-matplotlib/</span>
</span></span><span><span><span>seaborn</span><span>.</span><span>set</span><span>()</span>
</span></span><span><span><span>fig</span><span>,</span> <span>ax</span> <span>=</span> <span>plt</span><span>.</span><span>subplots</span><span>(</span><span>figsize</span><span>=</span><span>(</span><span>12</span><span>,</span> <span>6</span><span>))</span>
</span></span><span><span><span>ax</span><span>.</span><span>set</span><span>(</span>
</span></span><span><span>    <span>xlim</span><span>=</span><span>(</span><span>start</span><span>,</span> <span>end</span><span>),</span>
</span></span><span><span>    <span>ylim</span><span>=</span><span>(</span><span>1.1</span><span>*</span><span>(</span><span>-</span><span>1</span><span>-</span><span>scale</span><span>),</span> <span>1.1</span><span>*</span><span>(</span><span>1</span><span>+</span><span>scale</span><span>)),</span>
</span></span><span><span>    <span>xlabel</span><span>=</span><span>&#34;$t$&#34;</span><span>,</span>
</span></span><span><span>    <span>ylabel</span><span>=</span><span>&#34;$x$&#34;</span><span>,</span>
</span></span><span><span><span>)</span>
</span></span><span><span><span>fig</span><span>.</span><span>set_tight_layout</span><span>(</span><span>True</span><span>)</span>
</span></span><span><span><span>signal</span><span>,</span> <span>=</span> <span>ax</span><span>.</span><span>plot</span><span>(</span><span>t</span><span>[</span><span>0</span><span>],</span> <span>x_noisy</span><span>[</span><span>0</span><span>],</span> <span>&#39;o&#39;</span><span>)</span>
</span></span><span><span><span>filtered</span><span>,</span> <span>=</span> <span>ax</span><span>.</span><span>plot</span><span>(</span><span>t</span><span>[</span><span>0</span><span>],</span> <span>x_hat</span><span>[</span><span>0</span><span>],</span> <span>&#39;-&#39;</span><span>)</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>update</span><span>(</span><span>i</span><span>):</span>
</span></span><span><span>    <span>print</span><span>(</span><span>i</span><span>)</span>
</span></span><span><span>    <span>signal</span><span>.</span><span>set_data</span><span>(</span><span>t</span><span>[</span><span>0</span><span>:</span><span>i</span><span>],</span> <span>x_noisy</span><span>[</span><span>0</span><span>:</span><span>i</span><span>])</span>
</span></span><span><span>    <span>filtered</span><span>.</span><span>set_data</span><span>(</span><span>t</span><span>[</span><span>0</span><span>:</span><span>i</span><span>],</span> <span>x_hat</span><span>[</span><span>0</span><span>:</span><span>i</span><span>])</span>
</span></span><span><span>    <span>return</span> <span>signal</span><span>,</span> <span>filtered</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>if</span> <span>__name__</span> <span>==</span> <span>&#39;__main__&#39;</span><span>:</span>
</span></span><span><span>    <span># FuncAnimation will call the &#39;update&#39; function for each frame; here</span>
</span></span><span><span>    <span># animating over 10 frames, with an interval of 200ms between frames.</span>
</span></span><span><span>    <span>anim</span> <span>=</span> <span>FuncAnimation</span><span>(</span><span>fig</span><span>,</span> <span>update</span><span>,</span> <span>frames</span><span>=</span><span>frames</span><span>,</span> <span>interval</span><span>=</span><span>100</span><span>)</span>
</span></span><span><span>    <span>anim</span><span>.</span><span>save</span><span>(</span><span>&#39;one_euro_filter.gif&#39;</span><span>,</span> <span>dpi</span><span>=</span><span>80</span><span>,</span> <span>writer</span><span>=</span><span>&#39;imagemagick&#39;</span><span>)</span>
</span></span><span><span>    <span># update(frames)</span>
</span></span><span><span>    <span>plt</span><span>.</span><span>savefig</span><span>(</span><span>&#34;one_euro_filter.png&#34;</span><span>,</span> <span>dpi</span><span>=</span><span>300</span><span>)</span>
</span></span></code></pre></div><h2 id="conclusions">Conclusions</h2><p>I first learned about the 1€ filter at <em>Computational User Interface Design</em> course at Aalto University. I found the algorithm to be elegant, but the original paper’s explanation was cumbersome for implementing it. It motivated me to create a simplified explanation and code to help other people implement this algorithm.</p><h2 id="contribute">Contribute</h2><p>If you enjoyed or found benefit from this article, it would help me share it with other people who might be interested.
If you have feedback, questions, or ideas related to the article, you can <a href="https://jaantollander.com/#contact" target="_blank" rel="noopener">contact me via email</a>.
For more content, you can follow me on <a href="https://www.youtube.com/c/jaantollander" target="_blank" rel="noopener">YouTube</a> or join my <a href="https://jaantollander.com/#newsletter" target="_blank" rel="noopener">newsletter</a>.
Creating content takes time and effort, so consider supporting me with <a href="https://github.com/sponsors/jaantollander/" target="_blank" rel="noopener">a one-time donation</a>.</p><h2 id="references">References</h2></div></div>
  </body>
</html>
