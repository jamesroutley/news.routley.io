<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.jacobvosmaer.nl/0017-pdf-table-of-contents/">Original</a>
    <h1>Adding a table of contents to a PDF</h1>
    
    <div id="readability-page-1" class="page"><div><p><i><a href="https://github.com/">Jacob Vosmaer&#39;s blog</a></i></p>

<p>2024-01-02</p>

<p>In this post I talk about how I use <a href="https://gitlab.com/pdftk-java/pdftk">pdftk-java</a> to add tables of contents to PDF scans of old synthesizer manuals.</p>

<h2>Synthesizer manual PDF&#39;s</h2>

<p>Because I am a music technology enthousiast I read manuals of (old) electronic music equipment. Often these manuals are PDF image scans that are not searchable and that do not have a table of contents. This is annoying because I use an e-reader, which prevents me from quickly flicking around. It is faster if I open the table of contents on the e-reader and jump straight to the section I want to read.</p>

<p>Because I have run into this problem more than once I have developed a workflow to add a table of contents to an existing PDF.</p>

<h2>pdftk</h2>

<p>The tool I use to modify the PDFs is called pdftk (&#34;PDF toolkit&#34;). The original pdftk is apparently deprecated but there is a Java rewrite available: <a href="https://gitlab.com/pdftk-java/pdftk">pdftk-java</a>. I can install this on my Mac by running <code>port install pdftk</code>.</p>

<p>Pdftk has a sub-command that extracts metadata from a PDF into a text file. You can also update the metadata of a PDF by reading such a text file back in. My solution is to get the metadata, insert the table of contents and apply the text file to the PDF again.</p>

<h2>Generating table of contents metadata</h2>

<p>The metadata format generated by pdftk is verbose, it looks something like this:</p>

<pre><code>
BookmarkBegin
BookmarkTitle: Important notes
BookmarkLevel: 1
BookmarkPageNumber: 7
</code></pre>

<p>And that is just one line in the table of contents. To generate this text I made a Ruby script that generates the output.</p>

<p>Consider this table of contents from the <a href="https://www.muzines.co.uk/articles/roland-r8m/5789">Roland R-8M</a> <a href="http://cdn.roland.com/assets/media/pdf/R-8M_OM.pdf">manual</a>.</p>

<p><img src="https://github.com/astoilkov/r8mtoc.png" alt="Table of contents of R-8M manual"/></p>

<p>To convert this particular table into pdftk metadata, I use the following Ruby script.</p>

<pre><code>
# om-toc.rb

Entry = Struct.new(:page, :title, :level)
DATA.each_line do |line|
  line.chomp!
  next if line.empty?

  entry = Entry.new
  page = line[0,3]
  entry.page = Integer(page, 10) + 2
  entry.title = line[3,line.size]
  entry.level = 1

  while entry.title[0] == &#39;=&#39;
    entry.level += 1
    entry.title = entry.title[1, entry.title.size]
  end

  puts &lt;&lt;~EOS
    BookmarkBegin
    BookmarkTitle: #{entry.title}
    BookmarkLevel: #{entry.level}
    BookmarkPageNumber: #{entry.page}
  EOS
end

__END__
005Important notes
006Front and rear panel
007Try out the R-8M
008=CONNECTIONS
009=HOW TO PLAY THE SOUNDS
009==Turn the Power on
009==Listen to the ROM Play Demonstration
010==How to Play Each Instrument
010===Play the internal instruments
011===Play the instruments of a sound ROM card
014===Selecting the Feel Patches
015Before You Modify the Settings
(etc.)
</code></pre>

<p>Note how this script combines code and data. Everything after <code>__END__</code> is no longer Ruby code and can be accessed as a file with <code>DATA.read</code>. I do this because I often need to tweak the code to the shape of the table of contents.</p>

<p>The data at the bottom of the script is organized with two goals:</p>

<ol>
<li>Easy to parse</li>
<li>Easy to (touch) type while looking at the original table of contents</li>
</ol>

<p>The first three characters are the page number as listed in the real table. Then there are zero or more <code>=</code> symbols to indicate chapter / section / subsection nesting. Everything else on the line is title text.</p>

<p>The page numbers in the table often don&#39;t match the actual PDF pages. To ease the data entry the DATA section uses the numbers as printed in the manual. The code of the script adds 2 to each number which happens to be the offset here. Another problem I sometimes see is that the table of contents numbers pages as &#34;6-2&#34; meaning &#34;chapter 6, page 2&#34;. I then use the Ruby code to automatically convert that to e.g. page 18 in the PDF.</p>

<p>The output of this particular script looks like this:</p>

<pre><code>
BookmarkBegin
BookmarkTitle: Important notes
BookmarkLevel: 1
BookmarkPageNumber: 7
BookmarkBegin
BookmarkTitle: Front and rear panel
BookmarkLevel: 1
BookmarkPageNumber: 8
BookmarkBegin
BookmarkTitle: Try out the R-8M
(etc.)
</code></pre>

<p>To inject this data into the PDF I use the following shell script which calls <code>pdftk</code> twice.</p>

<pre><code>
#!/bin/sh
set -e

if [ $# != 2 ]; then
  echo &#39;Usage: $0 ORIG_PDF NEW_WITH_TOC_PDF&#39;
  exit 1
fi

tmp=$(mktemp)
tmp2=${tmp}.2
trap &#34;rm -f ${tmp} ${tmp2}&#34; EXIT

pdftk &#34;$1&#34; dump_data output $tmp
awk &#39;
  { print }
  /NumberOfPages/ { system(&#34;ruby om-toc.rb&#34;) }
&#39; $tmp &gt; $tmp2
pdftk &#34;$1&#34; update_info $tmp2 output &#34;$2&#34;
</code></pre>

<p>The end result is a new PDF that has a table of contents!</p>

<p><img src="https://github.com/astoilkov/pdftoc.png" alt="Table of contents after script"/></p>

<h2>Conclusion</h2>

<p>This technique works. It involves some data entry, which is not fun, but it automates the rest and having a table of contents is nice. For me it&#39;s worth the data entry.</p>
<details><summary>Edit history</summary><table>
<tbody><tr><td>2024-01-02</td><td></td><td>Add 0017 pdf toc</td></tr>
</tbody></table></details><p><a href="https://github.com/">Back</a></p>
</div></div>
  </body>
</html>
