<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://checkmarx.com/blog/surprise-when-dependabot-contributes-malicious-code/">Original</a>
    <h1>Hackers are spoofing themselves as GitHub&#39;s Dependabot to steal user passwords</h1>
    
    <div id="readability-page-1" class="page"><section data-id="5d644f5b" data-element_type="section">
						<div>
							<div>
					<div data-id="7796b6fd" data-element_type="column">
			<div>
							<div>
						<div data-id="2bd10d61" data-element_type="widget" data-widget_type="theme-post-content.default">
				<div>
			
<p>What Happened? </p>



<ul>
<li>In July 2023, our scanners detected nontypical commits to hundreds of GitHub repositories appear to be contributed by <a href="https://github.com/features/security" target="_blank" rel="noreferrer noopener">Dependabot</a> and carrying malicious code. </li>



<li>Those commit messages were fabricated by threat actors to appear as a Dependabot automated contribution in the commit history, an attempt to disguise the malicious activity  </li>



<li>After reaching out and talking to some of the victims who got compromised, we can confirm that the victims’ <strong>GitHub personal access token</strong> was stolen and used by the attackers to contribute those malicious code contributions. </li>



<li>The malicious code exfiltrates the GitHub project’s defined secrets to a malicious C2 server and modify any existing javascript files in the attacked project with a web-form password-stealer malware code effecting any end-user submitting its password in a web form. </li>



<li>This attack also impacted <strong>private GitHub organizations</strong> repositories as some of the victim’s GitHub tokens also had access to. </li>



<li>It is unclear how the victims’ personal access tokens were stolen - it may be due to a maliciousopen-source package installed on their PC. </li>



<li>We will elaborate in this blog on the malicious payload and how using GitHub personal access tokens is currently undetectable to most GitHub users.  </li>
</ul>



<figure><img decoding="async" fetchpriority="high" width="936" height="198" src="https://checkmarx.com/wp-content/uploads/2023/09/image-50.png" alt="" srcset="https://checkmarx.com/wp-content/uploads/2023/09/image-50.png 936w, https://checkmarx.com/wp-content/uploads/2023/09/image-50-300x63.png 300w, https://checkmarx.com/wp-content/uploads/2023/09/image-50-150x32.png 150w, https://checkmarx.com/wp-content/uploads/2023/09/image-50-768x162.png 768w, https://checkmarx.com/wp-content/uploads/2023/09/image-50-473x100.png 473w, https://checkmarx.com/wp-content/uploads/2023/09/image-50-378x80.png 378w, https://checkmarx.com/wp-content/uploads/2023/09/image-50-394x83.png 394w, https://checkmarx.com/wp-content/uploads/2023/09/image-50-915x194.png 915w" sizes="(max-width: 936px) 100vw, 936px"/></figure>



<p><strong>About Dependabot</strong> </p>



<p><a href="https://www.youtube.com/watch?v=Mh8yZu01DI8&amp;ab_channel=GitHub" target="_blank" rel="noreferrer noopener">Dependabot</a> is GitHub’s free automated dependency management tool for software projects. It continuously monitors a project&#39;s dependencies (like libraries and packages) for security vulnerabilities and outdated versions. When it detects issues, it automatically generates pull requests with updates, helping developers keep their software secure and up to date.  </p>



<figure><img decoding="async" width="936" height="594" src="https://checkmarx.com/wp-content/uploads/2023/09/image-51.png" alt="" srcset="https://checkmarx.com/wp-content/uploads/2023/09/image-51.png 936w, https://checkmarx.com/wp-content/uploads/2023/09/image-51-300x190.png 300w, https://checkmarx.com/wp-content/uploads/2023/09/image-51-150x95.png 150w, https://checkmarx.com/wp-content/uploads/2023/09/image-51-768x487.png 768w, https://checkmarx.com/wp-content/uploads/2023/09/image-51-158x100.png 158w, https://checkmarx.com/wp-content/uploads/2023/09/image-51-126x80.png 126w, https://checkmarx.com/wp-content/uploads/2023/09/image-51-394x250.png 394w, https://checkmarx.com/wp-content/uploads/2023/09/image-51-915x581.png 915w" sizes="(max-width: 936px) 100vw, 936px"/></figure>



<p><em>A screenshot of dependabot’s automatic pull-request <a href="https://github.com/pallets/flask" target="_blank" rel="noreferrer noopener">from the Flask project</a> </em></p>



<p><strong>The Fake Dependabot Commits</strong> </p>



<p>Between July 8-11 a threat actor started compromising hundreds of GitHub repositories, both public and private. Most victims are Indonesian user accounts. The attackers used a technique to fake commit messages (<a href="https://checkmarx.com/blog/unverified-commits-are-you-unknowingly-trusting-attackers-code/" target="_blank" rel="noreferrer noopener">read more about how it’s done here</a>) to trick developers thinking this was contributed by the real dependabot and to ignore this activity. </p>



<p>The attackers created a commit message “fix” appear to be contributed by user account “dependabot[bot]” </p>



<figure><img decoding="async" width="936" height="594" src="https://checkmarx.com/wp-content/uploads/2023/09/image-52.png" alt="" srcset="https://checkmarx.com/wp-content/uploads/2023/09/image-52.png 936w, https://checkmarx.com/wp-content/uploads/2023/09/image-52-300x190.png 300w, https://checkmarx.com/wp-content/uploads/2023/09/image-52-150x95.png 150w, https://checkmarx.com/wp-content/uploads/2023/09/image-52-768x487.png 768w, https://checkmarx.com/wp-content/uploads/2023/09/image-52-158x100.png 158w, https://checkmarx.com/wp-content/uploads/2023/09/image-52-126x80.png 126w, https://checkmarx.com/wp-content/uploads/2023/09/image-52-394x250.png 394w, https://checkmarx.com/wp-content/uploads/2023/09/image-52-915x581.png 915w" sizes="(max-width: 936px) 100vw, 936px"/></figure>



<p><em>A screenshot of the fake commit, taken from <a href="https://github.com/Highpolar-Softwares/I-help-privacy-policy/commits/master" target="_blank" rel="noreferrer noopener">highpolar-softwares/I-help-privacy-policy</a> repository </em></p>



<p><strong>Malicious Code</strong> </p>



<p>In the various repositories we analyzed (full list remains internal but it was hundreds of repositories) we saw two groups of repeated code changes, most likely done with an automated script. </p>



<p><strong>A New GitHub Action to Steal Secrets</strong> </p>



<p>New GitHub Action file named “hook.yml” was added as a new workflow file, triggers a code push event. It sends GitHub secrets and variables to URL hxxps://send[.]wagateway.pro/webhook. This action is triggered on every push event </p>



<figure><img decoding="async" loading="lazy" width="936" height="594" src="https://checkmarx.com/wp-content/uploads/2023/09/image-53.png" alt="" srcset="https://checkmarx.com/wp-content/uploads/2023/09/image-53.png 936w, https://checkmarx.com/wp-content/uploads/2023/09/image-53-300x190.png 300w, https://checkmarx.com/wp-content/uploads/2023/09/image-53-150x95.png 150w, https://checkmarx.com/wp-content/uploads/2023/09/image-53-768x487.png 768w, https://checkmarx.com/wp-content/uploads/2023/09/image-53-158x100.png 158w, https://checkmarx.com/wp-content/uploads/2023/09/image-53-126x80.png 126w, https://checkmarx.com/wp-content/uploads/2023/09/image-53-394x250.png 394w, https://checkmarx.com/wp-content/uploads/2023/09/image-53-915x581.png 915w" sizes="(max-width: 936px) 100vw, 936px"/></figure>



<p><em>A screenshot of the malicious commit <a href="https://github.com/Highpolar-Softwares/I-help-privacy-policy/commit/546584029b38388877b53cc8ef578033dff5001d?diff=unified" target="_blank" rel="noreferrer noopener">contributed to highpolar-softwares/I-help-privacy-policy</a> </em></p>



<p><strong>Patching *.js Files to Steal Passwords</strong> </p>



<p>In addition to the added GitHub Action, the attackers modified every existing project file having the “*.js“ extension and append an obfuscated line at the end of the file. </p>



<p>This new line is designed to create a new script tag as the code is executed on a browser environment and load an additional script from this URL: hxxps://send[.]wagateway.pro/client.js?cache=ignore. </p>



<figure><img decoding="async" loading="lazy" width="936" height="594" src="https://checkmarx.com/wp-content/uploads/2023/09/image-54.png" alt="" srcset="https://checkmarx.com/wp-content/uploads/2023/09/image-54.png 936w, https://checkmarx.com/wp-content/uploads/2023/09/image-54-300x190.png 300w, https://checkmarx.com/wp-content/uploads/2023/09/image-54-150x95.png 150w, https://checkmarx.com/wp-content/uploads/2023/09/image-54-768x487.png 768w, https://checkmarx.com/wp-content/uploads/2023/09/image-54-158x100.png 158w, https://checkmarx.com/wp-content/uploads/2023/09/image-54-126x80.png 126w, https://checkmarx.com/wp-content/uploads/2023/09/image-54-394x250.png 394w, https://checkmarx.com/wp-content/uploads/2023/09/image-54-915x581.png 915w" sizes="(max-width: 936px) 100vw, 936px"/></figure>



<p><em>A screenshot of the malicious commit <a href="https://github.com/juniorriau/kejaribiak/commit/65ebb527f8769fecda1716c8ee46d894c3c4a06c" target="_blank" rel="noreferrer noopener">contributed to juniorriau/kejaribiak</a> </em></p>



<p>The code loaded from hxxps://send[.]wagateway.pro/client.js?cache=ignore is attempting to intercept any web-based password form and send the user-credentials to the same exfiltration endpoint as before; URL hxxps://send[.]wagateway.pro/webhook </p>



<figure><img decoding="async" loading="lazy" width="934" height="636" src="https://checkmarx.com/wp-content/uploads/2023/09/image-55.png" alt="" srcset="https://checkmarx.com/wp-content/uploads/2023/09/image-55.png 934w, https://checkmarx.com/wp-content/uploads/2023/09/image-55-300x204.png 300w, https://checkmarx.com/wp-content/uploads/2023/09/image-55-150x102.png 150w, https://checkmarx.com/wp-content/uploads/2023/09/image-55-768x523.png 768w, https://checkmarx.com/wp-content/uploads/2023/09/image-55-147x100.png 147w, https://checkmarx.com/wp-content/uploads/2023/09/image-55-117x80.png 117w, https://checkmarx.com/wp-content/uploads/2023/09/image-55-394x268.png 394w, https://checkmarx.com/wp-content/uploads/2023/09/image-55-915x623.png 915w" sizes="(max-width: 934px) 100vw, 934px"/></figure>



<p><em>A screenshot of the malicious code; designed to steal user-form credentials. </em></p>



<p><strong>How Was It Done?</strong> </p>



<p>At first it was unclear to us how the attacker’s got access to those accounts, especially earlier this year when <a href="https://github.blog/2023-03-09-raising-the-bar-for-software-security-github-2fa-begins-march-13/" target="_blank" rel="noreferrer noopener">GitHub raised the bar for mandatory 2FA</a>.   </p>



<p>To get a better understanding of how this happened, we approached some of the victims by sending an email notifying them of the breach and asking for help understanding the full picture.  </p>



<p>Luckily, some victims agreed to share information with us, and surprisingly when inspecting the accounts activity we realized that the attackers accessed the accounts using compromised PATs (Personal Access Token) -- most likely exfiltrated silently from the victim’s development environment. </p>



<figure><img decoding="async" loading="lazy" width="928" height="364" src="https://checkmarx.com/wp-content/uploads/2023/09/image-56.png" alt="" srcset="https://checkmarx.com/wp-content/uploads/2023/09/image-56.png 928w, https://checkmarx.com/wp-content/uploads/2023/09/image-56-300x118.png 300w, https://checkmarx.com/wp-content/uploads/2023/09/image-56-150x59.png 150w, https://checkmarx.com/wp-content/uploads/2023/09/image-56-768x301.png 768w, https://checkmarx.com/wp-content/uploads/2023/09/image-56-255x100.png 255w, https://checkmarx.com/wp-content/uploads/2023/09/image-56-204x80.png 204w, https://checkmarx.com/wp-content/uploads/2023/09/image-56-394x155.png 394w, https://checkmarx.com/wp-content/uploads/2023/09/image-56-915x359.png 915w" sizes="(max-width: 928px) 100vw, 928px"/></figure>



<p><strong>Step 1 – Workspace Initialization</strong> </p>



<p>The victim must set up their development environment with a personal access token (or SSH/GPG key) identifying their account whenever they make git operations. This token is stored locally on the developer’s machine and can be extracted easily. </p>



<p>Such access tokens <strong>do not</strong> require 2FA and can be used to access the account by any computer with internet access. </p>



<p><strong>Step 2 – Stealing the Developer’s Credentials</strong> </p>



<p>We can only guess how the attackers got the developers credentials but <a href="https://checkmarx.com/blog/a-deep-dive-into-70-layers-of-obfuscated-info-stealer-malware/" target="_blank" rel="noreferrer noopener">seeing many cases of malicious packages aiming to perform that task</a> suggest that it is one potential way that the attackers could have gotten their hands on those precious GitHub tokens. </p>



<p>We believe the most likely scenario is that the victims were infected with such a malicious package, which exfiltrated the token to the attacker’s C2 server. </p>



<p><strong>Step 3 – Poisoning the Victim’s Code Projects</strong> </p>



<p>In this step the attackers used the stolen victim’s personal access tokens to authenticate to GitHub and make the malicious code changes described above.  </p>



<p>Analysis of the scale of the attack reveals that it appears to be automated. </p>







<p>This whole situation teaches us to be careful about where we get our code, even from trusted places like GitHub. It shows that even big platforms can have problems, so we need to always watch out and protect ourselves online.</p>



<p>This is the first incident we witnessed a threat actor using fake git commits to disguise activity, knowing that many developers do not check the actual changes of dependabot when they see it.</p>



<p>To make things safer, consider switching to <a href="https://github.blog/2022-10-18-introducing-fine-grained-personal-access-tokens-for-github/">GitHub’s fine-grained personal access tokens </a>. These tokens allow you to reduce the risk of compromised tokens. So, if someone bad gets one of these keys, they can&#39;t do a lot of damage.</p>



<p>Sadly, the GitHub’s personal access tokens access log activity is only visible for the enterprise accounts. If your token was compromised, you can’t know for sure since this information is not visible for non-enterprise users in the audit log section.</p>



<p>The attacker&#39;s Tactics, Techniques, and Procedures (TTPs) involve the use of fake commits, stealing user credentials, and impersonating Dependabot to avoid detection show us supply chain attacks are getting more sophisticated as attackers realize it doesn’t take much to move silently.</p>



<h2>IOCs:</h2>



<ul>
<li>wagateway[.]pro</li>



<li>hxxps://send[.]wagateway[.]pro/webhook</li>



<li>hxxps://send[.]wagateway[.]pro/client.js</li>
</ul>



<h2>Timeline</h2>



<ul>
<li>During 2023 - Attacker attacked victims and harvested personal access tokens (we don’t know how it was done and guessing malicious packages were involved) </li>



<li>2023-07-08 – Attacker used stolen GitHub token in an automated attack, poisoning multiple repositories.</li>



<li>2023-07-24 – We first noticed this anomaly and began investigating.</li>



<li>2023-07-24 – Contacted the GitHub accounts infected by this attack + reported to GitHub.</li>



<li>2023-09-20 – Meeting with one of the victims, reviewed his access logs which helped us understand the attack flow.</li>
</ul>
		</div>
				</div>
						</div>
					</div>
		</div>
								</div>
					</div>
		</section></div>
  </body>
</html>
