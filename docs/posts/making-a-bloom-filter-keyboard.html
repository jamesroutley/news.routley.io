<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mclare.blog/posts/making-a-bloom-filter-keyboard">Original</a>
    <h1>Making a Bloom Filter Keyboard</h1>
    
    <div id="readability-page-1" class="page"><div><h2 id="the-original-idea"><a href="#the-original-idea" aria-label="the original idea permalink"><span><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></span></a>The original idea</h2>
<p>Both of us have an interest in building and tinkering, and at the beginning of the pandemic, <a href="https://shapr.github.io/" target="_blank" rel="nofollow noopener noreferrer">Shae</a> convinced <a href="https://mclare.dev" target="_blank" rel="nofollow noopener noreferrer">Maryanne</a> to subscribe to get all kinds of gadgets through <a href="https://www.adafruit.com/adabox" target="_blank" rel="nofollow noopener noreferrer">ADABOX</a> with Adafruit. While we both had random cool hardware that came with useful tutorials and clear instructions, we wanted to see what else we could do with the components.</p>
<p>In Spring 2021, Shae wrote <a href="https://github.com/shapr/bloohm" target="_blank" rel="nofollow noopener noreferrer">Bloohm</a> to help show process status for running tests using an Adafruit neotrellis he’d gotten in one of the early <a href="https://learn.adafruit.com/adabox010" target="_blank" rel="nofollow noopener noreferrer">ADABOXs</a>. At the time, both of us had <a href="https://www.zsa.io/moonlander" target="_blank" rel="nofollow noopener noreferrer">Moonlander keyboards</a> with RGB LEDs under the keys.</p>
<p>Moonlanders also have open-source firmware, so we tried to figure out how to display the same RGB process status on our keyboards with zero success (the feature requests for the ZSA fork of QMK have <a href="https://github.com/zsa/qmk_firmware/branches" target="_blank" rel="nofollow noopener noreferrer">languished</a> for years at this point).</p>
<p>More recently, Maryanne started a job which required writing a lot of tests, and she wanted to utilize Bloohm after buying her own Adafruit neotrellis. She also wanted to learn Rust, so she rewrote the host side of Bloohm but in Rust as <a href="https://mclare.blog/posts/adapting-a-bloom-filter-to-rust" target="_blank" rel="nofollow noopener noreferrer">Bloomrs</a>. When she bought a <a href="https://shop.keyboard.io/collections/the-keyboardio-model-100/products/model-100" target="_blank" rel="nofollow noopener noreferrer">Keyboardio.io Model 100</a>, she did some investigation and found that the Model 100 had its own <a href="https://github.com/keyboardio/Kaleidoscope" target="_blank" rel="nofollow noopener noreferrer">open source firmware</a> that seemed significantly more <a href="https://kaleidoscope.readthedocs.io/en/latest/index.html" target="_blank" rel="nofollow noopener noreferrer">approachable</a>. Shae likes buying keyboards and thought the Bloom keyboard was still a great project and thus bought a Model 100 specifically for this project (yes, really).</p>
<p>Once we both had Model 100s, it was time to do some hacking and figure out how to set RGB LEDs with serial port commands!</p>
<h2 id="getting-started-with-arduino-idecli-chrysalis-and-kaleidoscope"><a href="#getting-started-with-arduino-idecli-chrysalis-and-kaleidoscope" aria-label="getting started with arduino idecli chrysalis and kaleidoscope permalink"><span><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></span></a>Getting started with Arduino IDE/CLI, Chrysalis, and Kaleidoscope</h2>
<p><a href="https://github.com/keyboardio/Chrysalis" target="_blank" rel="nofollow noopener noreferrer">Chrysalis</a> is the main entry point for working with the Model 100; we only found out about Kaleidoscope from another Model 100 owner, <a href="https://socialnotwork.net/@nebkor" target="_blank" rel="nofollow noopener noreferrer">Joe Ardent</a>. Once we dug into the firmware source, there were still a number of pain points with Kaleidoscope, where documentation is either <a href="https://kaleidoscope.readthedocs.io/en/latest/customization/plugin-authors-guide.html#controlling-leds" target="_blank" rel="nofollow noopener noreferrer">missing or incomplete</a>.</p>
<p>When we got started flashing our own firmware on the Model 100, there was a lot of trial and error. Both of us were working with Chrysalis at the same time as the Arduino IDE, and it turns out that you <em>can’t</em> send new instructions on the serial port or flash the keyboard while Chrysalis is open (there is no feedback to indicate that they exclusively use the same serial port).</p>
<p>The docs also say to hold the PROG button to get the keyboard into upload mode, but they don’t say when to release it. It’s safe to release the key once the firmware starts uploading (the first column of key LEDs will start cycling green). If you keep holding the PROG button down after uploading new firmware, the keyboard will not exit that mode (the LED on the PROG button will stay red), and you’ll have to unplug and replug in your keyboard.</p>
<p>There’s a <a href="https://github.com/keyboardio/Kaleidoscope/blob/master/bin/focus-send" target="_blank" rel="nofollow noopener noreferrer">shell script</a> in Kaleidoscope for testing that sends serial port commands to the keyboard from the host. You will likely need to change the usb device filename to match the output from running <span><code>$ ls -otr /dev/tty*</code></span>.</p>
<p>It ended up being too hard to figure out how to configure the Arduino GUI to point to a locally modified git repo; we ended up using the <a href="https://github.com/arduino/arduino-cli" target="_blank" rel="nofollow noopener noreferrer">Arduino CLI</a>.</p>
<h2 id="writing-the-code"><a href="#writing-the-code" aria-label="writing the code permalink"><span><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></span></a>Writing the code</h2>
<p>Joe Ardent pointed us a deprecated plugin called <a href="https://github.com/keyboardio/Kaleidoscope/blob/master/src/kaleidoscope/plugin/LEDControl.h#L34" target="_blank" rel="nofollow noopener noreferrer">LEDControl</a>, demonstrating that it <em>was</em> possible to write LED colors to the keyboard from the host.</p>
<p>The LEDControl plugin is now a core plugin, but its methods are no longer exposed by default (you can see exposed methods by running <span><code>$ ./focus-send help</code></span>).</p>
<p>We isolated a small plugin called LEDBrightnessConfig which utilized LEDControl methods and also had an exposed method <span><code>led.brightness</code></span> in the default Model 100 firmware. We hacked up the plugin to figure out how input gets parsed by the firmware.</p>
<p>Maryanne then figured out how to add a whole new plugin as a directory, which is <em>not</em> covered in the Kaleidoscope tutorials. The Kaleidoscope <a href="https://kaleidoscope.readthedocs.io/en/latest/customization/plugin-authors-guide.html#how-to-write-a-kaleidoscope-plugin" target="_blank" rel="nofollow noopener noreferrer">tutorial</a> only covers modifying the <span><code>.ino</code></span> file directly, rather than library type plugins. With a plugin scaffold, Shae ugly hacked some of the old LEDControl code into the new plugin… which compiled but did nothing (no output running <span><code>$ ./focus-send led.at</code></span>). Maryanne debugged the C++ to figure out which methods we actually needed, and we could <em>finally</em> both get and set LEDs on a key-by-key basis with <span><code>$ ./focus-send led.at</code></span>.</p>
<p>We’ve added two in-progress plugins to our <a href="https://github.com/spite-driven-development/Kaleidoscope/tree/feature/LEDControlConfig-plugin" target="_blank" rel="nofollow noopener noreferrer">fork of Kaleidoscope</a> for just <a href="https://github.com/spite-driven-development/Kaleidoscope/tree/feature/LEDControlConfig-plugin/plugins/Kaleidoscope-LEDControlConfig" target="_blank" rel="nofollow noopener noreferrer">exposing</a> <span><code>led.at</code></span>, as well as the <a href="https://github.com/spite-driven-development/Kaleidoscope/tree/feature/LEDControlConfig-plugin/plugins/Kaleidoscope-LEDEffect-Bloom" target="_blank" rel="nofollow noopener noreferrer">Bloom keyboard</a> functionality.</p>
<h2 id="next-steps"><a href="#next-steps" aria-label="next steps permalink"><span><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></span></a>Next steps</h2>
<p>We still need to do some cleanup on the plugins and add documentation and helpful comments. We have not configured the plugin to work as its own LED mode yet. It will write to the colors set by the active LED mode, but that mode may immediately write back over the key at any time. Keys will absolutely be overwritten by animation modes like DigitalRain, Chase, or Breathe.</p>
<p><img src="https://news.ycombinator.com/static/bloom_keyboard-223776deeff311d49e8801b4125ac406.gif" alt="Bloom Keyboard and Neotrellis"/></p></div></div>
  </body>
</html>
