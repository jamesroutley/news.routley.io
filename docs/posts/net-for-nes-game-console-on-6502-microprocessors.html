<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/jonathanpeppers/dotnes">Original</a>
    <h1>.NET for NES Game Console on 6502 Microprocessors</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/jonathanpeppers/dotnes/blob/main/assets/logo.png"><img src="https://github.com/jonathanpeppers/dotnes/raw/main/assets/logo.png" alt="dot NES logo"/></a></p>
<p dir="auto">.NET for the NES game console!</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/jonathanpeppers/dotnes/blob/main/assets/vscode.gif"><img src="https://github.com/jonathanpeppers/dotnes/raw/main/assets/vscode.gif" alt="Gif of NES Emulator launching from VS Code" data-animated-image=""/></a></p>

<p dir="auto">Simply install the template:</p>
<div dir="auto" data-snippet-clipboard-copy-content="dotnet new install dotnes.templates"><pre>dotnet new install dotnes.templates</pre></div>
<p dir="auto">Create a project:</p>

<p dir="auto">Or use the project template in Visual Studio:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/jonathanpeppers/dotnes/blob/main/assets/vs-template.png"><img src="https://github.com/jonathanpeppers/dotnes/raw/main/assets/vs-template.png" alt="Screenshot of the NES project template in Visual Studio"/></a></p>
<p dir="auto">Build and run it as you would a console app:</p>

<p dir="auto">Of course, you can also just open the project in Visual Studio and hit F5.</p>
<blockquote>
<p dir="auto">Note that Ctrl+F5 currently works better in C# Dev Kit in VS Code.</p>
</blockquote>
<p dir="auto">Check out the video for a full demo:</p>
<p dir="auto"><a href="https://youtu.be/m4TU5PJ8WtY" rel="nofollow"><img src="https://camo.githubusercontent.com/d12abbb0021a6c95f03a33129347229a1bebe08889a97c50fa95b5da20fdafa8/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f6d34545535504a385774592f6d617872657364656661756c742e6a7067" alt="Check out the video" data-canonical-src="https://img.youtube.com/vi/m4TU5PJ8WtY/maxresdefault.jpg"/></a></p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Anatomy of an NES application</h2><a id="user-content-anatomy-of-an-nes-application" aria-label="Permalink: Anatomy of an NES application" href="#anatomy-of-an-nes-application"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">&#34;Hello World&#34; looks something like:</p>
<div dir="auto" data-snippet-clipboard-copy-content="// set palette colors
pal_col(0, 0x02);   // set screen to dark blue
pal_col(1, 0x14);   // fuchsia
pal_col(2, 0x20);   // grey
pal_col(3, 0x30);   // white

// write text to name table
vram_adr(NTADR_A(2, 2));            // set address
vram_write(&#34;Hello, world!&#34;);         // write bytes to video RAM

// enable PPU rendering (turn on screen)
ppu_on_all();

// infinite loop
while (true) ;"><pre><span>// set palette colors</span>
pal_col<span>(</span><span>0</span><span>,</span> <span>0x02</span><span>)</span><span>;</span>   <span>// set screen to dark blue</span>
pal_col<span>(</span><span>1</span><span>,</span> <span>0x14</span><span>)</span><span>;</span>   <span>// fuchsia</span>
pal_col<span>(</span><span>2</span><span>,</span> <span>0x20</span><span>)</span><span>;</span>   <span>// grey</span>
pal_col<span>(</span><span>3</span><span>,</span> <span>0x30</span><span>)</span><span>;</span>   <span>// white</span>

<span>// write text to name table</span>
vram_adr<span>(</span>NTADR_A<span>(</span><span>2</span><span>,</span> <span>2</span><span>)</span><span>)</span><span>;</span>            <span>// set address</span>
vram_write<span>(</span><span><span>&#34;</span>Hello, world!<span>&#34;</span></span><span>)</span><span>;</span>         <span>// write bytes to video RAM</span>

<span>// enable PPU rendering (turn on screen)</span>
ppu_on_all<span>(</span><span>)</span><span>;</span>

<span>// infinite loop</span>
<span>while</span> <span>(</span><span>true</span><span>)</span> <span>;</span></pre></div>
<p dir="auto">This looks very much like <a href="https://8bitworkshop.com/v3.10.0/?platform=nes&amp;file=hello.c" rel="nofollow">&#34;Hello World&#34; in
C</a>, taking
advantage of the latest C# features in 2023.</p>
<p dir="auto">By default the APIs like <code>pal_col</code>, etc. are provided by an implicit
<code>global using static NESLib;</code> and all code is written within a single
<code>Program.cs</code>.</p>
<p dir="auto">Additionally, a <code>chr_generic.s</code> file is included as your game&#39;s &#34;artwork&#34; (lol?):</p>
<div dir="auto" data-snippet-clipboard-copy-content=".segment &#34;CHARS&#34;
.byte $00,$00,$00,$00,$00,$00,$00,$00
...
.byte $B4,$8C,$FC,$3C,$98,$C0,$00,$00
;;"><pre><span>.segment </span><span>&#34;CHARS&#34;</span>
<span>.</span><span>byte</span> <span>$</span><span>00</span><span>,</span><span>$</span><span>00</span><span>,</span><span>$</span><span>00</span><span>,</span><span>$</span><span>00</span><span>,</span><span>$</span><span>00</span><span>,</span><span>$</span><span>00</span><span>,</span><span>$</span><span>00</span><span>,</span><span>$</span><span>00</span>
<span>...</span>
<span>.</span><span>byte</span> <span>$</span><span>B4</span><span>,</span><span>$</span><span>8C</span><span>,</span><span>$</span><span>FC</span><span>,</span><span>$</span><span>3C</span><span>,</span><span>$</span><span>98</span><span>,</span><span>$</span><span>C0</span><span>,</span><span>$</span><span>00</span><span>,</span><span>$</span><span>00</span>
<span>;;</span></pre></div>
<p dir="auto">This table of data is used to render sprites, text, etc.</p>

<p dir="auto">The types of things I wanted to get working initially:</p>
<ul dir="auto">
<li>An object model for writing NES binaries</li>
<li>Building a project should produce a <code>*.nes</code> binary, that is byte-for-byte
identical to a program written in C.</li>
<li>&#34;Hello World&#34; runs</li>
<li>Byte arrays, and a more advanced sample like <code>attributetable</code> run</li>
<li>Local variables work in some form</li>
<li>Project template, MSBuild support, IDE support</li>
</ul>
<p dir="auto">Down the road, I might think about support for:</p>
<ul dir="auto">
<li>Methods</li>
<li>Structs</li>
<li>Multiple files</li>
<li>Some subset of useful BCL methods</li>
</ul>

<p dir="auto">For lack of a better word, .NES is a &#34;transpiler&#34; that takes
<a href="https://en.wikipedia.org/wiki/MSIL" rel="nofollow">MSIL</a> and transforms it directly into a
working <a href="http://www.6502.org/" rel="nofollow">6502 microprocessor</a> binary that can run in your
favorite NES emulator. If you think about .NET&#39;s Just-In-Time (JIT) compiler or
the various an Ahead-Of-Time (AOT) compilers, .NES is doing something similiar:
taking MSIL and turning it into runnable machine code.</p>
<p dir="auto">To understand further, let&#39;s look at the MSIL of a <code>pal_col</code> method call:</p>
<div data-snippet-clipboard-copy-content="// pal_col((byte)0, (byte)2);
IL_0000: ldc.i4.0
IL_0001: ldc.i4.2
IL_0002: call void [neslib]NES.NESLib::pal_col(uint8, uint8)"><pre lang="msil"><code>// pal_col((byte)0, (byte)2);
IL_0000: ldc.i4.0
IL_0001: ldc.i4.2
IL_0002: call void [neslib]NES.NESLib::pal_col(uint8, uint8)
</code></pre></div>
<p dir="auto">In 6502 assembly, this would look something like:</p>
<div dir="auto" data-snippet-clipboard-copy-content="A900          LDA #$00
20A285        JSR pusha
A902          LDA #$02
203E82        JSR _pal_col"><pre><span>A900          LDA #</span><span>$</span><span>00</span>
<span>20A285        JSR </span><span>pusha</span>
<span>A902          LDA #</span><span>$</span><span>02</span>
<span>203E82        JSR _pal_col</span></pre></div>
<p dir="auto">You can see how one might envision using <a href="https://learn.microsoft.com/dotnet/api/system.reflection.metadata" rel="nofollow">System.Reflection.Metadata</a> to
iterate over the contents of a .NET assembly and generate <a href="https://www.masswerk.at/6502/6502_instruction_set.html" rel="nofollow">6502
instructions</a> -- that&#39;s how this whole idea was born!</p>
<p dir="auto">Note that the method <code>NESLib.pal_col()</code> has no actual C# implementation. In
fact! there is <em>only</em> a reference assembly even shipped in .NES:</p>
<div dir="auto" data-snippet-clipboard-copy-content="&gt; 7z l dotnes.0.1.1-alpha.nupkg
   Date      Time    Attr         Size   Compressed  Name
------------------- ----- ------------ ------------  ------------------------
2023-09-14 14:37:38 .....         8192         3169  ref\net8.0\neslib.dll"><pre><span>&gt;</span> 7z l dotnes.<span>0.1</span>.<span>1</span><span>-</span>alpha.nupkg
   Date      Time    Attr         Size   Compressed  Name
<span>-------------------</span> <span>-----</span> <span>------------</span> <span>------------</span>  <span>------------------------</span>
<span>2023</span><span>-</span><span>09</span><span>-</span><span>14</span> <span>14</span>:<span>37</span>:<span>38</span> ....<span>.</span>         <span>8192</span>         <span>3169</span>  ref\net8.<span>0</span>\neslib.dll</pre></div>
<p dir="auto">If you decompile <code>neslib.dll</code>, no code is inside:</p>
<div dir="auto" data-snippet-clipboard-copy-content="// Warning! This assembly is marked as a &#39;reference assembly&#39;, which means that it only contains metadata and no executable code.
// neslib, Version=0.1.0.0, Culture=neutral, PublicKeyToken=null
// NES.NESLib
public static void pal_col(byte index, byte color) =&gt; throw null;"><pre><span>// Warning! This assembly is marked as a &#39;reference assembly&#39;, which means that it only contains metadata and no executable code.</span>
<span>// neslib, Version=0.1.0.0, Culture=neutral, PublicKeyToken=null</span>
<span>// NES.NESLib</span>
<span>public</span> <span><span>static</span></span> <span>void</span> <span>pal_col</span><span>(</span><span>byte</span> <span>index</span><span>,</span> <span>byte</span> <span>color</span><span>)</span> <span>=&gt;</span> <span>throw</span> <span>null</span><span>;</span></pre></div>
<p dir="auto">When generating <code>*.nes</code> binaries, .NES simply does a lookup for <code>pal_col</code> to
&#34;jump&#34; to the appropriate subroutine to call it.</p>
<p dir="auto">.NES also emits the assembly instructions for the actual <code>pal_col</code> subroutine, a
code snippet of the implementation:</p>
<div dir="auto" data-snippet-clipboard-copy-content="/*
* 823E	8517          	STA TEMP                      ; _pal_col
* 8240	209285        	JSR popa                      
* 8243	291F          	AND #$1F                      
* 8245	AA            	TAX                           
* 8246	A517          	LDA TEMP                      
* 8248	9DC001        	STA $01C0,x                   
* 824B	E607          	INC PAL_UPDATE                
* 824D	60            	RTS
*/
Write(NESInstruction.STA_zpg, TEMP);
Write(NESInstruction.JSR, popa.GetAddressAfterMain(sizeOfMain));
Write(NESInstruction.AND, 0x1F);
Write(NESInstruction.TAX_impl);
Write(NESInstruction.LDA_zpg, TEMP);
Write(NESInstruction.STA_abs_X, PAL_BUF);
Write(NESInstruction.INC_zpg, PAL_UPDATE);
Write(NESInstruction.RTS_impl);"><pre><span>/*</span>
<span>* 823E	8517          	STA TEMP                      ; _pal_col</span>
<span>* 8240	209285        	JSR popa                      </span>
<span>* 8243	291F          	AND #$1F                      </span>
<span>* 8245	AA            	TAX                           </span>
<span>* 8246	A517          	LDA TEMP                      </span>
<span>* 8248	9DC001        	STA $01C0,x                   </span>
<span>* 824B	E607          	INC PAL_UPDATE                </span>
<span>* 824D	60            	RTS</span>
<span>*/</span>
Write<span>(</span>NESInstruction<span>.</span>STA_zpg<span>,</span> TEMP<span>)</span><span>;</span>
Write<span>(</span>NESInstruction<span>.</span>JSR<span>,</span> popa<span>.</span><span>GetAddressAfterMain</span><span>(</span>sizeOfMain<span>)</span><span>)</span><span>;</span>
Write<span>(</span>NESInstruction<span>.</span>AND<span>,</span> <span>0x1F</span><span>)</span><span>;</span>
Write<span>(</span>NESInstruction<span>.</span>TAX_impl<span>)</span><span>;</span>
Write<span>(</span>NESInstruction<span>.</span>LDA_zpg<span>,</span> TEMP<span>)</span><span>;</span>
Write<span>(</span>NESInstruction<span>.</span>STA_abs_X<span>,</span> PAL_BUF<span>)</span><span>;</span>
Write<span>(</span>NESInstruction<span>.</span>INC_zpg<span>,</span> PAL_UPDATE<span>)</span><span>;</span>
Write<span>(</span>NESInstruction<span>.</span>RTS_impl<span>)</span><span>;</span></pre></div>

<p dir="auto">This is a hobby project, so only around 5 C# programs are known to work. But to
get an idea of what is not available:</p>
<ul dir="auto">
<li>No runtime</li>
<li>No BCL</li>
<li>No objects or GC</li>
<li>No debugger</li>
<li>Strings are ASCII</li>
</ul>
<p dir="auto">What we <em>do</em> have is a way to express an NES program in a single <code>Program.cs</code>.</p>

<p dir="auto">To learn more about NES development, I found the following useful:</p>
<ul dir="auto">
<li><a href="https://8bitworkshop.com" rel="nofollow">8bitworkshop</a></li>
<li><a href="https://www.vbforums.com/showthread.php?858389-NES-6502-Programming-Tutorial-Part-1-Getting-Started" rel="nofollow">NES 6502 Programming Tutorial</a></li>
<li><a href="https://wiki.nesdev.org/w/index.php/INES" rel="nofollow">INES File Format</a></li>
<li><a href="https://www.masswerk.at/6502/6502_instruction_set.html" rel="nofollow">6502 Instruction Set</a></li>
<li><a href="https://mh-nexus.de/en/hxd/" rel="nofollow">HxD Hex Editor</a></li>
</ul>

<p dir="auto">I needed a simple, small NES emulator to redistribute with .NES that runs on Mac
and Windows. Special thanks to <a href="https://github.com/daniel5151/ANESE">@daniel5151 and
ANESE</a>. This is the default NES emulator
used in the <code>dotnet.anese</code> package, <a href="https://github.com/daniel5151/ANESE/blob/8ae814d615479b1496c98033a1f5bc4da5921c6f/LICENSE">license
here</a>.</p>
</article></div></div>
  </body>
</html>
