<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/step-security/wait-for-secrets">Original</a>
    <h1>Show HN: Publish from GitHub Actions using multi-factor authentication</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/step-security/wait-for-secrets/blob/main/images/banner.png"><img src="https://github.com/step-security/wait-for-secrets/raw/main/images/banner.png" width="400"/></a></p>
<p dir="auto"><a href="https://stepsecurity.io/?utm_source=github&amp;utm_medium=organic_oss&amp;utm_campaign=wait-for-secrets" rel="nofollow"><img src="https://camo.githubusercontent.com/205b0960dce66f073d41600402f896ff469a6d8172aa1fc8836c198c546585f3/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6d61696e7461696e656425323062792d7374657073656375726974792e696f2d626c756576696f6c6574" alt="Maintained by stepsecurity.io" data-canonical-src="https://img.shields.io/badge/maintained%20by-stepsecurity.io-blueviolet"/></a>
<a href="https://api.securityscorecards.dev/projects/github.com/step-security/wait-for-secrets" rel="nofollow"><img src="https://camo.githubusercontent.com/0435fe84ac6dd13385aa2b5022fd04f5128c86dcdad6d621f9767f8a79f9b350/68747470733a2f2f6170692e736563757269747973636f726563617264732e6465762f70726f6a656374732f6769746875622e636f6d2f737465702d73656375726974792f776169742d666f722d736563726574732f6261646765" alt="OpenSSF Scorecard" data-canonical-src="https://api.securityscorecards.dev/projects/github.com/step-security/wait-for-secrets/badge"/></a>
<a href="https://raw.githubusercontent.com/step-security/wait-for-secrets/main/LICENSE" rel="nofollow"><img src="https://camo.githubusercontent.com/2a2157c971b7ae1deb8eb095799440551c33dcf61ea3d965d86b496a5a65df55/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4c6963656e73652d417061636865253230322e302d626c75652e737667" alt="License: Apache 2.0" data-canonical-src="https://img.shields.io/badge/License-Apache%202.0-blue.svg"/></a></p>
<hr/>
<p dir="auto">Wait-for-secrets GitHub Action waits for the developer to enter secrets during a workflow run. Developers can enter secrets using a web browser and use them in the workflow.</p>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://github.com/step-security/wait-for-secrets/blob/main/images/WaitForSecretsDemo2.gif"><img src="https://github.com/step-security/wait-for-secrets/raw/main/images/WaitForSecretsDemo2.gif" alt="Demo" data-animated-image=""/></a>
</p>
<h2 dir="auto"><a id="user-content-why" aria-hidden="true" href="#why"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Why?</h2>
<ul dir="auto">
<li><strong>MFA</strong> To enable using multi-factor authentication (MFA)/ one-time password (OTPs) for a release workflow, e.g., use OTP to publish to the npm registry.</li>
<li><strong>Separation of duties</strong> Even if someone has write access to the repository, they do not get access to the deployment secrets.</li>
<li><strong>More control</strong> You have more control over <em>when</em> secrets get used in your workflows. With <code>wait-for-secrets,</code> there is manual human interaction needed for publishing.</li>
<li><strong>Less management overhead</strong> You can use your existing account for deployment. This removes the need to manage a separate set of deployment credentials.</li>
</ul>
<h2 dir="auto"><a id="user-content-how" aria-hidden="true" href="#how"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>How?</h2>
<ol dir="auto">
<li>Add the <code>wait-for-secrets</code> GitHub Action to your workflow and specify the secrets you need.</li>
<li>The Action will print a URL in the build log every 10 seconds and wait for you to enter the secrets</li>
<li>Click on the URL and enter the secrets that the workflow needs.</li>
<li>The Action will get the secrets you entered in the browser and continue execution.</li>
<li>Use the retrieved secrets in future steps.</li>
</ol>
<h3 dir="auto"><a id="user-content-demo-workflow" aria-hidden="true" href="#demo-workflow"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Demo workflow</h3>
<p dir="auto">Use this workflow to see a quick demo of <code>wait-for-secrets</code> with a dummy secret.</p>
<div dir="auto" data-snippet-clipboard-copy-content="name: Wait-for-secrets Demo
on: workflow_dispatch

jobs:
  build:
    permissions:
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: step-security/wait-for-secrets@v1
        id: get-otp
        with:
          secrets: |
            DUMMY_SECRET: 
              name: &#39;Dummy secret&#39;
              description: &#39;Dummy secret to demo wait-for-secrets&#39;
      - run: |
          echo ${{ steps.get-otp.outputs.DUMMY_SECRET }}"><pre><span>name</span>: <span>Wait-for-secrets Demo</span>
<span>on</span>: <span>workflow_dispatch</span>

<span>jobs</span>:
  <span>build</span>:
    <span>permissions</span>:
      <span>id-token</span>: <span>write</span>
    <span>runs-on</span>: <span>ubuntu-latest</span>
    <span>steps</span>:
      - <span>uses</span>: <span>actions/checkout@v3</span>
      - <span>uses</span>: <span>step-security/wait-for-secrets@v1</span>
        <span>id</span>: <span>get-otp</span>
        <span>with</span>:
          <span>secrets</span>: <span>|</span>
<span>            DUMMY_SECRET: </span>
<span>              name: &#39;Dummy secret&#39;</span>
<span>              description: &#39;Dummy secret to demo wait-for-secrets&#39;</span>
<span></span>      - <span>run</span>: <span>|</span>
<span>          echo ${{ steps.get-otp.outputs.DUMMY_SECRET }}</span></pre></div>
<h3 dir="auto"><a id="user-content-publish-to-npm-registry-using-one-time-password-otp" aria-hidden="true" href="#publish-to-npm-registry-using-one-time-password-otp"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Publish to NPM registry using one-time password (OTP)</h3>
<p dir="auto">Use this workflow to publish to the npm registry using a one-time password.</p>
<p dir="auto">Prerequisites:</p>
<ol dir="auto">
<li>Setup <a href="https://docs.npmjs.com/configuring-two-factor-authentication" rel="nofollow">two-factor authentication</a> for your account.</li>
<li>Require two-factor authentication to publish the package. This can be <a href="https://docs.npmjs.com/requiring-2fa-for-package-publishing-and-settings-modification" rel="nofollow">configured in the package settings</a>.</li>
<li>Create a <code>Publish</code> <a href="https://docs.npmjs.com/creating-and-viewing-access-tokens" rel="nofollow">access token</a> and set it as a GitHub secret <code>NODE_AUTH_TOKEN</code></li>
</ol>
<div dir="auto" data-snippet-clipboard-copy-content="name: Publish Package to npmjs
on: workflow_dispatch

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: &#34;16.x&#34;
          registry-url: &#34;https://registry.npmjs.org&#34;
      - uses: step-security/wait-for-secrets@v1
        id: wait-for-secrets
        with:
          secrets: |
            OTP: 
              name: &#39;OTP to publish package&#39;
              description: &#39;OTP from authenticator app&#39;
      - run: npm ci
      - run: npm publish --otp ${{ steps.wait-for-secrets.outputs.OTP }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}"><pre><span>name</span>: <span>Publish Package to npmjs</span>
<span>on</span>: <span>workflow_dispatch</span>

<span>permissions</span>:
  <span>contents</span>: <span>read</span>

<span>jobs</span>:
  <span>build</span>:
    <span>runs-on</span>: <span>ubuntu-latest</span>
    <span>permissions</span>:
      <span>contents</span>: <span>read</span>
      <span>id-token</span>: <span>write</span>
    <span>steps</span>:
      - <span>uses</span>: <span>actions/checkout@v3</span>
      - <span>uses</span>: <span>actions/setup-node@v3</span>
        <span>with</span>:
          <span>node-version</span>: <span><span>&#34;</span>16.x<span>&#34;</span></span>
          <span>registry-url</span>: <span><span>&#34;</span>https://registry.npmjs.org<span>&#34;</span></span>
      - <span>uses</span>: <span>step-security/wait-for-secrets@v1</span>
        <span>id</span>: <span>wait-for-secrets</span>
        <span>with</span>:
          <span>secrets</span>: <span>|</span>
<span>            OTP: </span>
<span>              name: &#39;OTP to publish package&#39;</span>
<span>              description: &#39;OTP from authenticator app&#39;</span>
<span></span>      - <span>run</span>: <span>npm ci</span>
      - <span>run</span>: <span>npm publish --otp ${{ steps.wait-for-secrets.outputs.OTP }}</span>
        <span>env</span>:
          <span>NODE_AUTH_TOKEN</span>: <span>${{ secrets.NODE_AUTH_TOKEN }}</span></pre></div>
<p dir="auto">When you run this workflow, you will see a link in the build log to enter the OTP.</p>
<ul dir="auto">
<li>Click on the link and enter the OTP.</li>
<li>The workflow will take the OTP and pass it to the <code>npm publish</code> step.</li>
<li>OTP will be used to publish the package.</li>
</ul>
<h3 dir="auto"><a id="user-content-slack-notification" aria-hidden="true" href="#slack-notification"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Slack notification</h3>
<p dir="auto">You can get a notification on Slack when the secret needs to be entered. Set the <code>slack-webhook-url</code> as shown below.</p>
<h3 dir="auto"><a id="user-content-deploy-to-aws-using-temporary-security-credentials" aria-hidden="true" href="#deploy-to-aws-using-temporary-security-credentials"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Deploy to AWS using temporary security credentials</h3>
<p dir="auto">Example of how to provide AWS temporary security credentials in a workflow.</p>
<div dir="auto" data-snippet-clipboard-copy-content="name: Deploy to AWS

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  publish:
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: step-security/wait-for-secrets@v1
        id: wait-for-secrets
        with:
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          secrets: |
            AWS_ACCESS_KEY_ID: 
              name: &#39;AWS access key id&#39;
              description: &#39;Access key id for prod&#39;
            AWS_SECRET_ACCESS_KEY:
              name: &#39;AWS secret access key&#39;
              description: &#39;Secret access key for prod&#39;
            AWS_SESSION_TOKEN:
              name: &#39;AWS session token&#39;
              description: &#39;Session token for prod&#39;

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ steps.wait-for-secrets.outputs.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ steps.wait-for-secrets.outputs.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ steps.wait-for-secrets.outputs.AWS_SESSION_TOKEN }}
          aws-region: us-west-2"><pre><span>name</span>: <span>Deploy to AWS</span>

<span>on</span>:
  <span>workflow_dispatch</span>:
  <span>push</span>:
    <span>branches</span>:
      - <span>main</span>

<span>permissions</span>:
  <span>contents</span>: <span>read</span>

<span>jobs</span>:
  <span>publish</span>:
    <span>permissions</span>:
      <span>contents</span>: <span>read</span>
      <span>id-token</span>: <span>write</span>
    <span>runs-on</span>: <span>ubuntu-latest</span>
    <span>steps</span>:
      - <span>name</span>: <span>Checkout</span>
        <span>uses</span>: <span>actions/checkout@v3</span>

      - <span>uses</span>: <span>step-security/wait-for-secrets@v1</span>
        <span>id</span>: <span>wait-for-secrets</span>
        <span>with</span>:
          <span>slack-webhook-url</span>: <span>${{ secrets.SLACK_WEBHOOK_URL }}</span>
          <span>secrets</span>: <span>|</span>
<span>            AWS_ACCESS_KEY_ID: </span>
<span>              name: &#39;AWS access key id&#39;</span>
<span>              description: &#39;Access key id for prod&#39;</span>
<span>            AWS_SECRET_ACCESS_KEY:</span>
<span>              name: &#39;AWS secret access key&#39;</span>
<span>              description: &#39;Secret access key for prod&#39;</span>
<span>            AWS_SESSION_TOKEN:</span>
<span>              name: &#39;AWS session token&#39;</span>
<span>              description: &#39;Session token for prod&#39;</span>
<span></span>
<span></span>      - <span>name</span>: <span>Configure AWS Credentials</span>
        <span>uses</span>: <span>aws-actions/configure-aws-credentials@v1</span>
        <span>with</span>:
          <span>aws-access-key-id</span>: <span>${{ steps.wait-for-secrets.outputs.AWS_ACCESS_KEY_ID }}</span>
          <span>aws-secret-access-key</span>: <span>${{ steps.wait-for-secrets.outputs.AWS_SECRET_ACCESS_KEY }}</span>
          <span>aws-session-token</span>: <span>${{ steps.wait-for-secrets.outputs.AWS_SESSION_TOKEN }}</span>
          <span>aws-region</span>: <span>us-west-2</span></pre></div>
<p dir="auto">During the workflow run, you can generate temporary AWS credentials for your account and enter them using the browser.</p>
<h3 dir="auto"><a id="user-content-actual-examples" aria-hidden="true" href="#actual-examples"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Actual examples</h3>
<p dir="auto">Here are a couple of workflows that use <code>wait-for-secrets</code></p>
<ol dir="auto">
<li>Publish to NPM: <a href="https://github.com/jsx-eslint/eslint-plugin-react/blob/master/.github/workflows/npm-publish.yml">https://github.com/jsx-eslint/eslint-plugin-react/blob/master/.github/workflows/npm-publish.yml</a></li>
<li>Deploy to AWS: <a href="https://github.com/step-security/secure-workflows/blob/main/.github/workflows/release.yml">https://github.com/step-security/secure-workflows/blob/main/.github/workflows/release.yml</a></li>
<li>GitHub release: <a href="https://github.com/step-security/wait-for-secrets/blob/main/.github/workflows/release.yml">https://github.com/step-security/wait-for-secrets/blob/main/.github/workflows/release.yml</a></li>
</ol>
<h3 dir="auto"><a id="user-content-faq" aria-hidden="true" href="#faq"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>FAQ</h3>
<ol dir="auto">
<li>
<p dir="auto">Why does <code>wait-for-secrets</code> need <code>id-token: write</code> permission?</p>
<p dir="auto">It needs the <code>id-token: write</code> permission to authenticate to the StepSecurity API. This is to ensure only the authorized workflow can retrieve the secrets.</p>
</li>
<li>
<p dir="auto">How does <code>wait-for-secrets</code> work?</p>
<p dir="auto">This is how <code>wait-for-secrets</code> works:</p>
<ol dir="auto">
<li>When the <code>wait-for-secrets</code> Action is called, it gets an OpenID Connect (OIDC) token using the <code>id-token: write</code> permission.</li>
<li>The token is sent to the StepSecurity API along with the needed list of secrets.</li>
<li>StepSecurity API authenticates the caller using the token and stores the list of secrets in a data store.</li>
<li>When a user clicks on the link in the build log, the list of secrets is shown to the user.</li>
<li>The user enters the secrets in the browser.</li>
<li>The secrets are sent to the StepSecurity API, where they are stored in the datastore.</li>
<li><code>wait-for-secrets</code> Action polls every 10 seconds to check if the secrets are available.</li>
<li>If available, the StepSecurity API returns the secret values to the Action.</li>
<li><code>wait-for-secrets</code> Action makes a call to the StepSecurity API to clear the secrets in the datastore</li>
<li><code>wait-for-secrets</code> Action makes the secrets available for future steps.</li>
</ol>
</li>
<li>
<p dir="auto">Where is the code for the StepSecurity API?</p>
<p dir="auto"><code>Wait-for-secrets</code> GitHub Action and the backend API it uses are open-source. The backend API is in the <a href="https://github.com/step-security/secure-workflows/tree/main/remediation/secrets">https://github.com/step-security/secure-workflows</a> repository.</p>
</li>
</ol>
</article>
          </div></div>
  </body>
</html>
