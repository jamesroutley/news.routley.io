<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://arslan.io/2019/07/03/how-to-write-idempotent-bash-scripts/">Original</a>
    <h1>How to write idempotent Bash scripts (2019)</h1>
    
    <div id="readability-page-1" class="page"><div>
	
	<p><span>July 3, 2019</span></p><figure>
    <img src="https://d33wubrfki0l68.cloudfront.net/68bfe0b7ffe6a88ba274c0a9b5b102c333433f78/83d58/images/how-to-write-idempotent-bash-scripts-1.jpeg" alt="Photo by Callum Wale on Unsplash"/> <figcaption>
            <p>Photo by Callum Wale on Unsplash</p>
        </figcaption>
</figure>

<p>It happens a lot, you write a bash script and half way it exits due an error. You fix the error in your system and run the script again. But half of the steps in your scripts fail immediately because they were already applied to your system. To build resilient systems you need to write software that is idempotent.</p>
<h2 id="what-is-idempotency">What is idempotency?</h2>
<p>Idempotent scripts can be called multiple times and each time it’s called, it will have the same effects on the system. This means, a second call will exit with the same result and won’t have any side effects. From the <a href="https://www.google.com/search?q=idempotent">dictionary</a>:</p>
<blockquote>
<p>Idempotent: denoting an element of a set which is unchanged in value when multiplied or otherwise operated on by itself.</p>
</blockquote>
<p>Good software is always written in an idempotent way, especially if you’re working in distributed systems, where operations might be eventually consistency and you might end up calling functions multiple times because of duplicate requests (such as in <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/standard-queues.html">queues</a> with <code>At-Least-Once</code> delivery guarantee).</p>
<h2 id="bash-idioms">Bash idioms</h2>
<p>Let me show a couple of bash tips and idioms you can use to change your scripts to be idempotent. You’re probably using most of them without being aware of the side effects:</p>
<h3 id="creating-an-empty-file">Creating an empty file</h3>
<p>This is an easy one. Touch is by default idempotent. This means you can call it multiple times without any issues. A second call won’t have any effects on the file content. Note though it’ll update the file’s modification time, so if you depend on it be careful.</p>
<h3 id="creating-a-directory">Creating a directory</h3>
<p>Never use <code>mkdir</code> directly, instead use it with the<code>-p</code> flag. This flag make sure mkdir won’t error if the directory exists:</p>
<h3 id="creating-a-symbolic-link">Creating a symbolic link</h3>
<p>We create symbolic links with the following command:</p>
<p>But this will fail if you call it again on the same target. To make it idempotent, pass the <code>-f</code> flag:</p>
<p>The <code>-f</code> flag removes the target destination before creating the symbolic link, hence it’ll always succeed.</p>
<p>When linking a directory, you need to pass <code>-n</code> too. Otherwise calling it again will create a symbolic link inside the directory.</p>
<div><pre><code data-lang="bash">mkdir a
ln -sf a b
ln -sf a b
ls a
a
</code></pre></div><p>So to be safe, always use <code>ln -sfn source target</code>.</p>
<h3 id="removing-a-file">Removing a file</h3>
<p>Instead of removing a file with:</p>
<p>Use the <code>-f</code>  flag which ignores non-existent files.</p>
<h3 id="modifying-a-file">Modifying a file</h3>
<p>Sometimes you’re adding a new line to an existing file (i.e: <code>/etc/fstab</code>). This means, you need to make sure not to add it the second time if you run your script. Suppose you have this in your script:</p>
<div><pre><code data-lang="bash"><span>echo</span> <span>&#34;/dev/sda1 /mnt/dev ext4 defaults 0 0&#34;</span> <span>|</span> sudo tee -a /etc/fstab
</code></pre></div><p>If this is run again, you’ll end up having duplicate entries in your <code>/etc/fstab</code>. One way of making this idempotent is to make sure to check for certain placeholders via <code>grep</code>:</p>
<div><pre><code data-lang="bash"><span>if</span> ! grep -qF <span>&#34;/mnt/dev&#34;</span> /etc/fstab<span>;</span> <span>then</span>
  <span>echo</span> <span>&#34;/dev/sda1 /mnt/dev ext4 defaults 0 0&#34;</span> <span>|</span> sudo tee -a /etc/fstab
<span>fi</span>
</code></pre></div><p>Here the <code>-q</code> means silent mode and <code>-F</code> enables <code>fixed string</code> mode. Grep will silently fail if <code>/mnt/dev</code> doesn’t exist so the echo statement will never be called.</p>
<h3 id="check-if-variable-file-or-dir-exists">Check if variable, file or dir exists</h3>
<p>Most of the time you’re writing to a directory, reading from a file or doing simple string manipulations with a variable. For example you might have a tool that creates a new file based on certain inputs:</p>
<div><pre><code data-lang="bash"><span>echo</span> <span>&#34;complex set of rules&#34;</span> &gt; /etc/conf/foo.txt
</code></pre></div><p>Calculating the text might be an expensive operation, hence you don’t want to write it every time you call the script. To make it idempotent you check if the file exists via the <code>-f</code> flag of the inbuilt <code>test</code> property of the shell:</p>
<div><pre><code data-lang="bash"><span>if</span> <span>[</span> ! -f <span>&#34;/etc/conf/foo.txt&#34;</span> <span>]</span><span>;</span> <span>then</span>
 <span>echo</span> <span>&#34;complex set of rules&#34;</span> &gt; /etc/conf/foo.txt
<span>fi</span>
</code></pre></div><p>Here <code>-f</code> is just an example, there are many other flags you can use, such:</p>
<ul>
<li><code>-d</code>: directory</li>
<li><code>-z</code>: string of zero length</li>
<li><code>-p</code>: pipe</li>
<li><code>-x</code>: file and has execute permission</li>
</ul>
<p>For example suppose you want to install a binary, but only if it doesn’t exist
in your host, you can use the <code>-x</code> like this:</p>
<div><pre><code data-lang="sh"><span># install 1password CLI</span>
<span>if</span> ! <span>[</span> -x <span>&#34;</span><span>$(</span><span>command</span> -v op<span>)</span><span>&#34;</span> <span>]</span><span>;</span> <span>then</span>
  <span>export</span> <span>OP_VERSION</span><span>=</span><span>&#34;v0.5.6-003&#34;</span>
  curl -sS -o 1password.zip https://cache.agilebits.com/dist/1P/op/pkg/<span>${</span><span>OP_VERSION</span><span>}</span>/op_linux_amd64_<span>${</span><span>OP_VERSION</span><span>}</span>.zip
  unzip 1password.zip op -d /usr/local/bin
  rm -f 1password.zip
<span>fi</span>
</code></pre></div><p>This installs the <code>op</code> binary to /usr/local/bin. If you re-run your script, it
won’t install it anymore. Another benefit is, you can easily upgrade the binary
to a new version by just removing it from your system, update the <code>OP_VERSION</code>
env and re-run your script.</p>
<p>For a list of complete flags and operators checkout  <code>man test</code>.</p>
<h3 id="formatting-a-device">Formatting a device</h3>
<p>To format a volume, say with an <code>ext4</code> format, you can use a command like the following:</p>
<p>Of course, this would fail immediately if you call it again. To make this call idempotent, we prepend it with <code>blkid</code>:</p>
<div><pre><code data-lang="bash">blkid <span>&#34;</span><span>$VOLUME_NAME</span><span>&#34;</span> <span>||</span> mkfs.ext4 <span>&#34;</span><span>$VOLUME_NAME</span><span>&#34;</span>
</code></pre></div><p>This command prints attributes for a given block device. Hence prepending basically means to proceed with formatting <em>only</em> when <code>blkid</code> fails, which is an indication that the given volume is not formatted yet.</p>
<h3 id="mounting-a-device">Mounting a device</h3>
<p>Trying to mount a volume to an existing directory can be done with the following example command:</p>
<div><pre><code data-lang="bash">mount -o discard,defaults,noatime <span>&#34;</span><span>$VOLUME_NAME</span><span>&#34;</span> <span>&#34;</span><span>$DATA_DIR</span><span>&#34;</span>
</code></pre></div><p>This will fail however if it’s already mounted. One way is to check the output of <code>mount</code> command and see if the volume is already mounted. But there is a better way to do it. Using the <code>mountpoint</code> command:</p>
<div><pre><code data-lang="bash"><span>if</span> ! mountpoint -q <span>&#34;</span><span>$DATA_DIR</span><span>&#34;</span><span>;</span> <span>then</span>
  mount -o discard,defaults,noatime <span>&#34;</span><span>$VOLUME_NAME</span><span>&#34;</span> <span>&#34;</span><span>$DATA_DIR</span><span>&#34;</span>
<span>fi</span>
</code></pre></div><p>The <code>mountpoint</code> command checks whether a file or directory is a mount point. The <code>-q</code> flag just makes sure it doesn’t output anything and silently exits. In this case, if the mount point doesn’t exist, it’ll go forward and mount the volume.</p>
<h2 id="verdict">Verdict</h2>
<p>Most of these tips and tricks are already known, but when we write Bash scripts
those can be easily neglected without even thinking about it. Some of these
idioms are very specific (such as mounting or formatting), but as we saw,
creating idempotent and resilient software is always beneficial in the long
term. So knowing them is useful nevertheless.</p>
<p>I used all of the above tips and tricks recently in my
<a href="https://github.com/fatih/dotfiles/blob/master/workstation/bootstrap.sh"><code>bootstrap.sh</code></a>
script that I use to create and provision my <a href="https://arslan.io/2019/01/07/using-the-ipad-pro-as-my-development-machine/">remote development machine</a>. I know that I could use more sophisticated tools to provision a VM from
scratch, but sometimes a simple bash script is the only thing you need.</p>

</div><p> If you have any questions or feedback, please feel free to share them with me on Twitter: <strong><a href="https://twitter.com/fatih">@fatih</a></strong></p></div>
  </body>
</html>
