<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://metrist.io/blog/how-we-found-azures-unannounced-breaking-change/">Original</a>
    <h1>Discovering Azure&#39;s unannounced breaking change with Cosmos DB</h1>
    
    <div id="readability-page-1" class="page"><div data-id="1987e3aa" data-element_type="widget" data-widget_type="theme-post-content.default">
				<div>
			<p><span>Although APIs are the lifeblood of so many software applications today, the impact on their dependencies when they break can often be overlooked. And while full outages can have a more widespread and obvious impact across a user base, breaking changes to an API’s contract can be just as impactful – and much more difficult to resolve.</span></p>
<p><span>This was the case when Azure published a breaking change that affected downstream systems like ours without warning its users. But, the source of the breaking change was not clear at first, and we at Metrist had to investigate using our own data for third-party application reliability in order to determine the source of the issue.</span></p>
<p><span>In this article, we’ll walk through the data surfaced by our own product and the process of how we determined that Azure’s breaking change was the source of our partial outage.</span></p>

<h2><span>Background</span></h2>
<p><span>First, a bit of background on how we use Azure CosmosDB, and how we obtained the debugging data to determine that Azure published a breaking change without telling their customers. Metrist monitors cloud dependencies, such as Azure CosmosDB, by continuously running scripted test that exercise the product’s functionality to simulate what a user would do. And part of our functional testing involves using their API.</span></p>
<p><span>Azure published a breaking change – making a previously optional field that we considered irrelevant mandatory, and creating errors in our monitoring. This was the start of how we identified the unannounced breaking change and investigated how to resolve the issue.</span></p>

<h2><span>Discovery of the Outage</span></h2>
<p><span>We first noticed the problem with the partial outage of our Azure CosmosDB service monitor September 14th at 18:42 UTC. We reported to our users that the product was not functioning correctly because our tests began returning errors, not on every attempt, but on enough to trigger Metrist’s heuristics that something was wrong in the East US region of Azure while attempting to create a database container, as seen below.</span></p>
<p><span><img src="https://metrist.io/wp-content/uploads/2022/10/Screen-Shot-2022-10-11-at-4.11.47-PM-1024x562.png" alt="" width="800" height="439" srcset="https://metrist.io/wp-content/uploads/2022/10/Screen-Shot-2022-10-11-at-4.11.47-PM-1024x562.png 1024w, https://metrist.io/wp-content/uploads/2022/10/Screen-Shot-2022-10-11-at-4.11.47-PM-300x165.png 300w, https://metrist.io/wp-content/uploads/2022/10/Screen-Shot-2022-10-11-at-4.11.47-PM-768x422.png 768w, https://metrist.io/wp-content/uploads/2022/10/Screen-Shot-2022-10-11-at-4.11.47-PM.png 1402w" sizes="(max-width: 800px) 100vw, 800px"/></span></p>

<p><span>Here is how we saw the issue unfold: </span></p>
<ul>
<li aria-level="1"><span>The first error came in at 18:42 UTC on September 14th</span></li>
<li aria-level="1"><span>At 19:12 UTC, we declared the service to be partially down because we could not continue to successfully create containers in the East US region</span></li>
<li aria-level="1"><span>Following the first error on the 14th, 75% of test runs failed through the remainder of the day, with 25% succeeding.</span></li>
<li aria-level="1"><span>On September 15th through September 20th, Metrist continued to report the service as partially down as 90% of the 140 daily tests in the East US region failed day.</span></li>
<li aria-level="1"><span>On September 19th @ 19:13 UTC, the first error when attempting to create a cluster in in the Central US was logged, with occasional successful tests for the next few hours until 100% of tests failed by the start of September 20th, UTC.</span></li>
<li aria-level="1"><span>On September 21st 100% of test runs were failing in the East US region.</span></li>
</ul>

<p><span>Using a feature of our product that details errors from our functional tests, we were able to see a log of all the recent errors thrown by the monitor, with CreateContainer specifically showing several errors stating “One of the specified inputs is invalid”.</span></p>
<p><span>While this data was not the most helpful, it confirmed that there was something wrong with our request, despite no changes to how we made the request in months. Until seeing the error details in Metrist, for all we knew that could have just been because of the specific region having issues (we’ve seen capacity issues before on single regions from cloud providers that prevented us from spinning up a new database or VM).</span></p>

<p><span><img loading="lazy" src="https://metrist.io/wp-content/uploads/2022/10/Screen-Shot-2022-10-11-at-4.12.06-PM-1024x470.png" alt="" width="800" height="367" srcset="https://metrist.io/wp-content/uploads/2022/10/Screen-Shot-2022-10-11-at-4.12.06-PM-1024x470.png 1024w, https://metrist.io/wp-content/uploads/2022/10/Screen-Shot-2022-10-11-at-4.12.06-PM-300x138.png 300w, https://metrist.io/wp-content/uploads/2022/10/Screen-Shot-2022-10-11-at-4.12.06-PM-768x353.png 768w, https://metrist.io/wp-content/uploads/2022/10/Screen-Shot-2022-10-11-at-4.12.06-PM-1536x706.png 1536w, https://metrist.io/wp-content/uploads/2022/10/Screen-Shot-2022-10-11-at-4.12.06-PM-2048x941.png 2048w" sizes="(max-width: 800px) 100vw, 800px"/></span></p>

<p><span>After a few days, this error was happening on every attempt and began affecting the Central US region. At that point, it seemed the mostly likely reason was that Microsoft was slowly rolling out a new change that broke compatibility with our existing code.</span></p>

<h2><span>Determining the Change</span></h2>
<p><span>The next step was to figure out what actually changed. Our service monitor code hadn’t been touched in several months and is fairly straightforward, using the account and database created from its previous successful steps to create a new SQL Container.</span></p>
<pre data-stringify-type="pre">public void CreateContainer(Logger logger)
{
   _dbAccount.Update()
       .UpdateSqlDatabase(GetDatabaseName())
       .DefineNewSqlContainer(GetContainerName())
       .WithThroughput(400)
       .Attach()
       .Parent()
       .Apply();
}</pre>
<p><span>Nothing seemed obviously wrong. The next investigative steps were:</span></p>
<ul>
<li aria-level="1"><span>Updating our outdated SDK – no change. </span></li>
<li aria-level="1"><span>Determining if allowed throughput values changed – no change.</span></li>
<li aria-level="1"><span>Determining if changing the default value of 400 resulted in a change – no change. </span></li>
<li aria-level="1"><span>Determining if containers could even be created – no change. </span></li>
</ul>

<p><span>Although other regions still worked and there was nothing reported on the status page, it was worth having a try through the web console as a sanity check.</span></p>

<p><span><img loading="lazy" src="https://metrist.io/wp-content/uploads/2022/10/Screen-Shot-2022-10-11-at-4.12.35-PM-488x1024.png" alt="" width="488" height="1024" srcset="https://metrist.io/wp-content/uploads/2022/10/Screen-Shot-2022-10-11-at-4.12.35-PM-488x1024.png 488w, https://metrist.io/wp-content/uploads/2022/10/Screen-Shot-2022-10-11-at-4.12.35-PM-143x300.png 143w, https://metrist.io/wp-content/uploads/2022/10/Screen-Shot-2022-10-11-at-4.12.35-PM.png 634w" sizes="(max-width: 488px) 100vw, 488px"/></span></p>
<h2><span>The Solution </span></h2>
<p><span>Filling out the “New Container” form, everything seemed fine until the Partition Key. It was required and had a default of “/id”, surely the SDK would set a similar sane default that Just Worked™.</span></p>
<p><span>However, manually setting the PartitionKey with a simple </span><span>.WithPartitionKey(“/id”) </span>was all it needed to start working. This was even more confusing with the inclusion of a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.azure.cosmos.partitionkey.none?view=azure-dotnet">PartitionKey.None</a> that implies not setting the value should be an option.</p>
<p><span>Fortunately, this was all we needed to get the our service monitor formatted the way CosmosDB suddenly expected, in just 2 of the regions (plus similar changes to the InsertItem and DeleteItem checks). However, it still took a full morning to fully debug and fix this all because of a previously optional field becoming required and the only clue was found while using the Azure web portal, in a world of Infrastructure as Code.</span></p>

<h2><span>Conclusions</span></h2>
<p><span>All in all, this was a fairly simple fix, but because of the nature of the API, it could have been worse. The more deeply ingrained a given API is into one’s app, the bigger an effect it can have, and the longer it can take to fix.</span></p>
<p><span>Could our problem have been avoided? A production deploy of CosmosDB would almost certainly have a partition key set regardless of it being required or not. But unfortunately, it’s not always possible to avoid these kinds of breaking changes.</span></p>
<p><span>Following best practices and recommendations from providers and getting alerted to upcoming changes is your best bet to prevent a breaking API change from impacting your application. And at the end of the day, you still need to trust that your cloud dependency providers will take the precautions necessary to avoid service interruption.</span></p>
<p><span>At Metrist, a service monitor breaking like this is almost welcome. It allows us to learn about changes being made by an API provider that could have a serious impact on customers, but doing so in a controlled, purpose-built environment. The same can’t be said for most other apps, where an outage can cause serious loss of time and business.</span></p>

<p><span>If you’d like to save time and reduce outages for your business, sign up for Metrist! You can monitor any of 65+ popular cloud apps or install our agent to monitor any cloud dependency you use!</span></p>
<p><span>Get started today – it’s free!</span></p>
		</div>
				</div></div>
  </body>
</html>
