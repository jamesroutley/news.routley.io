<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://blog.davidedmundson.co.uk/blog/qt6_wayland_robustness/">Original</a>
    <h1>QtWayland 6.6 Brings Robustness Through Compositor Handoffs</h1>
    
    <div id="readability-page-1" class="page"><article id="post-484">
	
	<!-- .entry-header -->

	<div>
		<p>Every release has a killer feature. Qt 6.6 features the opposite - staying alive. This blog post describes work to make Qt clients more robust and seemlessly migrate between compositors, providing resistance against compositor crashes and more.</p>

<p>Right now if you restart pulseaudio your sound might cut out, restart NetworkManager and you lose your wifi, restart an X11 window manager and your decorations disappear.</p>
<p>But within a second it&#39;s all back to normal exactly where you left off with everything recovering fine.</p>
<p>This isn&#39;t true for display servers. If X11 restarts you&#39;re back at the login prompt. All drafts lost, games unsaved, work wasted.</p>

<p>For X11 this was unfixable; clients relied on memory stored by the Xserver, they made synchronous calls that were expected to return values, and multiple clients talked to multple clients.</p>
<p>This was a real problem in my early days of Linux, X11 would lock up frequently enough that most distributions had a shortcut key to restart the server and send you back to the login prompt.</p>
<p>It&#39;s less of an issue now as X11 has been in a lengthy period of feature freeze.</p>

<p>Wayland makes it possible to fix all this. Memory allocations are client side, all operations are async, all protocols are designed that the compositor always has complete control.</p>
<p>Yet the current user-facing state is <strong>considerably worse</strong>:</p>
<ul>
<li>
<p>Compositors and displays servers are now the same process, doubling the space for errors</p>
</li>
<li>
<p>Compositors are typically extensible with 3rd party plugins and scripts</p>
</li>
<li>
<p>The wayland security model means the compositor absorbs even more functions from global shortcuts to screencasting and input-method handling</p>
</li>
<li>
<p>The wayland ecosystem  is not in a period of feature freeze with wayland protocols constantly evolving to cover missing features and new ideas.</p>
<p>Even if there was a perfect compositor:</p>
</li>
<li>
<p><a href="https://bugs.kde.org/report.cgi?bug_severity=crash&amp;bug_status=RESOLVED&amp;classification=Plasma&amp;cumulate=0&amp;product=kwin&amp;resolution=FIXED&amp;resolution=UPSTREAM&amp;resolution=DOWNSTREAM&amp;saved_report_id=14&amp;x_axis_field=resolution&amp;width=1024&amp;height=600&amp;action=wrap&amp;format=pie">40% of kwin&#39;s crash bug reports are either upstream or downstream causes</a> </p>
</li>
<li>
<p>The current compositor developer experience is limited with developers having to relogin and restart their apps and development setup just to test their latest changes.</p>
</li>
</ul>

<p>The solution for this? Instead of exiting when the compositor closes, simply...don&#39;t!</p>
<p>If we could connect to a new compositor we just need to send the right amount of information to bring it in sync and notify the application code of any changes to bring this in sync.</p>
<p>For Qt applications all this information is handled in the backend, in the Wayland Qt Platform Abstraction (QPA).</p>
<p>Qt already has to handle screens and input devices being removed, clipboards being revoked and drag and drops cancelled. Supporting a whole reset isn&#39;t introducing any new work, we just have to trigger all of these actions at once, then reconnect to the newly restored compositor and restore our contents.</p>
<p>Applications already have to support all of these events too as well as handle callbacks to redraw buffers. There&#39;s no changes needed at an application code level, it&#39;s all done as transparently as possible. </p>
<p>Handling OpenGL is a challenge, right now we don&#39;t have a way to keep that alive. Fortunately we put in lots of effort previously in supporting GPU resets throughout the Qt stack. The QtWayland backend fakes to the applications that a GPU reset has occured through the Qt abstractions.</p>
<p>For the majority of applications including all QtQuick users this happens automatically and flawlessly, building on the work <a href="https://blog.davidedmundson.co.uk/blog/plasma-rendering-handling-nvidia-context-loss/" title="that we put in previously">that we put in previously</a>.</p>
<p>Whilst the overall concepts might sound invasive, the final merge-request to support all of this for all Qt applications was fewer lines than supporting middle-click paste.</p>
<p>Almost no work needs doing on the compositor side. For a compositor there&#39;s no difference between a new client, and a client that was running previously reconnecting. The only big change we made within Kwin is having a helper process so the whole process can be seemless and race-free.</p>
<h2>Proof</h2>
<p><iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/u4HnwqidYFo?si=zmIxcs9555Zv6gsP" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe></p>

<p>This post is about Qt, but the world is bigger than that. Not only does this technique work here, but we have pending patches for GTK, SDL and even XWayland, with key parts of SDL merged but disabled already.</p>
<p>The challenge for the other toolkits is we can&#39;t use the same OpenGL trick as Qt. They either lack GPU reset handling either at a toolkit level or within the applications. </p>
<p>Supporting OpenGL requires new infrastructure. We&#39;ve tried from the start to get some infrastructure in place to allow this.It was clear that proposing library changes for client reconnection support was an uphill battle whilst being unproven in the wild.</p>
<p>After Qt6 is rolled out to a wider audience and shown to work reliably, we&#39;ll refocus efforts on pushing upstream changes to the other platforms. </p>

<p>This isn&#39;t just about crashes. If support becomes mainstream there will be additional opportunities:</p>
<ul>
<li>
<p>We can easily upgrade to new features without having to log out and back. This is one of the reasons why kwin development is happening at such a rapid pace in recent months. We&#39;re not having to test in fake nested sessions or waste time logging in and setting up between changes.</p>
</li>
<li>
<p>We can support multihead, running different compositors per group of outputs and move seemlessly between them.</p>
</li>
<li>
<p>It&#39;s feasible to switch between compositors at runtime. With the application handling the reconnect logic, they can easily handle the case where compositor feature sets vary.</p>
<p><iframe loading="lazy" width="560" height="315" src="https://www.youtube-nocookie.com/embed/JYfzAuRmBjo?si=jBnMHRqb4kmpX4ot" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe>
</p></li>
<li>
<p>Checkpoint restore in userspace, being able to suspend your application to disk and then pick up where you left off like nothing happened. It could never work for X applications, but with wayland reconnect support we can make it work. </p>
</li>
</ul>
<p><iframe loading="lazy" width="560" height="315" src="https://www.youtube-nocookie.com/embed/bWWQT3HamBw?si=h0bsJeMYR1cslZtx" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe></p>

<p>More information about the long term goal this can be found at <a href="https://invent.kde.org/plasma/kwin/-/wikis/Restarting">the kwin wiki</a>, or each out to me directly if you want to add support.</p>
<p>Discuss this at <a href="https://discuss.kde.org/t/protected-qtwayland-6-6-brings-robustness-through-compositor-handoffs/4866">discuss.kde.org</a>.</p>
	</div><!-- .entry-content -->

	
	<!-- .entry-footer -->

</article></div>
  </body>
</html>
