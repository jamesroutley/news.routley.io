<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://victorpoughon.fr/pytorch-full-forward/">Original</a>
    <h1>How to get all intermediate layers outputs in PyTorch</h1>
    
    <div id="readability-page-1" class="page">
  
  <header>
    <a href="https://victorpoughon.fr/">
      
    </a>
    <nav>
      <p><a href="https://victorpoughon.fr/">Home</a> <a href="https://victorpoughon.fr/blog/">Blog</a> <a href="https://github.com/victorpoughon">GitHub</a> <a href="https://www.linkedin.com/in/victorpoughon">LinkedIn</a> <a rel="me" href="https://mastodon.social/@victorpoughon">Mastodon</a></p>

    </nav>
  </header>
  <main>
    

    
        
    

    
        

        <p>
            <i>
                <time datetime="2025-01-23T21:37Z">
                    23 Jan, 2025
                </time>
            </i>
        </p>
    

    <p>In PyTorch, did you ever want to get all layers inputs and outputs and not just the final output of the model? I needed that too recently for my <a href="https://github.com/victorpoughon/torchlensmaker">torchlensmaker</a> project, so here&#39;s a little snippet!</p>
<div><pre><span></span><span>import</span><span> </span><span>torch.nn</span><span> </span><span>as</span><span> </span><span>nn</span>

<span>from</span><span> </span><span>typing</span><span> </span><span>import</span> <span>Any</span><span>,</span> <span>Iterator</span>
<span>from</span><span> </span><span>dataclasses</span><span> </span><span>import</span> <span>dataclass</span>


<span>@dataclass</span>
<span>class</span><span> </span><span>ModuleEvalContext</span><span>:</span>
    <span>module</span><span>:</span> <span>nn</span><span>.</span><span>Module</span>
    <span>inputs</span><span>:</span> <span>Any</span>
    <span>outputs</span><span>:</span> <span>Any</span>

    <span>def</span><span> </span><span>__iter__</span><span>(</span><span>self</span><span>)</span> <span>-&gt;</span> <span>Iterator</span><span>[</span><span>Any</span><span>]:</span>
        <span>return</span> <span>iter</span><span>((</span><span>self</span><span>.</span><span>module</span><span>,</span> <span>self</span><span>.</span><span>inputs</span><span>,</span> <span>self</span><span>.</span><span>outputs</span><span>))</span>


<span>def</span><span> </span><span>full_forward</span><span>(</span>
    <span>module</span><span>:</span> <span>nn</span><span>.</span><span>Module</span><span>,</span> <span>inputs</span><span>:</span> <span>Any</span>
<span>)</span> <span>-&gt;</span> <span>tuple</span><span>[</span><span>list</span><span>[</span><span>ModuleEvalContext</span><span>],</span> <span>Any</span><span>]:</span>
<span>    </span><span>&#34;&#34;&#34;</span>
<span>    Forward evaluate a model, but returns all intermediate inputs and outputs.</span>

<span>    This is kind of like normal forward evaluation of a model, as in:</span>

<span>        &gt; outputs = model(inputs)</span>

<span>    except that all intermediate layers inputs and outputs are returned as a</span>
<span>    list of tree element tuples (module, inputs, outputs):</span>

<span>        &gt; execute_list, output = full_forward(model, inputs)</span>
<span>        &gt; for module, inputs, outputs in execute_list:</span>
<span>        &gt;     print(module, inputs, outputs)</span>

<span>    Args:</span>
<span>        module: PyTorch nn.Module to evaluate</span>
<span>        inputs: input data to the module</span>

<span>    Returns:</span>
<span>        execute_list: list of (module, inputs, outputs)</span>
<span>        outputs: output of the top level module execution</span>
<span>    &#34;&#34;&#34;</span>

    <span>execute_list</span> <span>=</span> <span>[]</span>

    <span># Define the forward hook</span>
    <span>def</span><span> </span><span>hook</span><span>(</span><span>mod</span><span>:</span> <span>nn</span><span>.</span><span>Module</span><span>,</span> <span>inp</span><span>:</span> <span>Any</span><span>,</span> <span>out</span><span>:</span> <span>Any</span><span>)</span> <span>-&gt;</span> <span>None</span><span>:</span>
        <span># inp[0] here restricts us to forward() first argument</span>
        <span># so this only works with single argument forward() functions</span>
        <span>execute_list</span><span>.</span><span>append</span><span>(</span><span>ModuleEvalContext</span><span>(</span><span>mod</span><span>,</span> <span>inp</span><span>[</span><span>0</span><span>],</span> <span>out</span><span>))</span>

    <span># Register forward hooks to every module recursively</span>
    <span>hooks</span> <span>=</span> <span>[]</span>
    <span>for</span> <span>mod</span> <span>in</span> <span>module</span><span>.</span><span>modules</span><span>():</span>
        <span>hooks</span><span>.</span><span>append</span><span>(</span><span>mod</span><span>.</span><span>register_forward_hook</span><span>(</span><span>hook</span><span>))</span>

    <span># Evaluate the full model, then remove all hooks</span>
    <span>try</span><span>:</span>
        <span>outputs</span> <span>=</span> <span>module</span><span>(</span><span>inputs</span><span>)</span>
    <span>finally</span><span>:</span>
        <span>for</span> <span>h</span> <span>in</span> <span>hooks</span><span>:</span>
            <span>h</span><span>.</span><span>remove</span><span>()</span>

    <span>return</span> <span>execute_list</span><span>,</span> <span>outputs</span>
</pre></div>
<p>And this is how you use it:</p>
<div><pre><span></span><span>execute_list</span><span>,</span> <span>output</span> <span>=</span> <span>tlm</span><span>.</span><span>full_forward</span><span>(</span><span>model</span><span>,</span> <span>X</span><span>)</span>

<span>for</span> <span>module</span><span>,</span> <span>inputs</span><span>,</span> <span>outputs</span> <span>in</span> <span>execute_list</span><span>:</span>
	<span># Do something here:</span>
	<span>...</span>
	<span>print</span><span>(</span><span>module</span><span>,</span> <span>inputs</span><span>,</span> <span>outputs</span><span>)</span>
</pre></div>
<p>This is based on PyTorch&#39;s <a href="https://pytorch.org/docs/stable/generated/torch.nn.Module.html#torch.nn.Module.register_forward_hook">register_forward_hook</a> and is really flexible! Enjoy :)</p>


    

    
        

        
            


        
    


  </main>
  

</div>
  </body>
</html>
