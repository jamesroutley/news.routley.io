<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://djan.org/blog/peach-rng/">Original</a>
    <h1>understanding melee peach item pull rng logic</h1>
    
    <div id="readability-page-1" class="page"><div><article data-backlink-icon="&lt;svg xmlns=&#34;http://www.w3.org/2000/svg&#34; viewBox=&#34;0 0 24 24&#34; width=&#34;20&#34; height=&#34;20&#34;&gt;&lt;path d=&#34;M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&lt;/svg&gt;"><div id="post-info"><p><span id="publish">2023-12-20</span></p></div><p>as a melee peach player, i spend a lot of my time pulling random items out of the ground.</p><figure><img alt="gif of peach pulling a turnip" src="https://mindustrygame.github.io/img/peach-turnip-pull.gif"/><figcaption>image from ssbwiki</figcaption></figure><p>princess peach has a special move called <a rel="nofollow noreferrer" href="https://www.ssbwiki.com/Vegetable">&#34;Vegetable&#34;</a>, activated by pressing down-special while grounded. if peach is able to complete her pull animation successfully, she retrieves an item from the ground - either a turnip, a bobomb, a beamsword, or a mr saturn (with turnips being the most common). it&#39;s a defining move for her character, and for many players is the default option to consider when in a safe position. although she loses access to a few options while holding a turnip (most notably grab), the possibility of throwing it at an opponent demands respect. it can open up new approaches, enable otherwise impossible combo routes, and empowers her to interact with her opponent from a distance.</p><p>over the 20+ year history of the game, the community has created resources to help players understand how often to expect particular outcomes. this image is what i see referenced most often:</p><figure><img alt="table of peach item pull percentages" src="https://mindustrygame.github.io/img/expected-frequency-chart.png"/><figcaption>credit: Magus420</figcaption></figure><p>as shown above, not all pulls are equally likely. there are different kinds of turnips, and some turnips do more damage than others. some sequences of pulls are highly valuable, but extremely unlikely to occur - pulling two stitchfaces in a row (especially <a href="https://www.youtube.com/watch?v=rrzFeWC5kmc" rel="nofollow noreferrer">when you know how to use them</a>) is considered a special occassion. there are even advanced techniques like <a rel="nofollow noreferrer" href="https://smashboards.com/threads/postmodern-rng-tactics-knitting-panning-theory-discussion.414626/">knitting</a> that allow peach to continuously pull items faster than she could normally.</p><p>understanding how turnip rng works won&#39;t give you any competitive advantage in the game. but it is fun! so, let&#39;s continue.</p><p>when playing melee online these days, it&#39;s common to record game records using the <a rel="nofollow noreferrer" href="https://github.com/project-slippi/slippi-wiki/blob/master/SPEC.md">SLP replay format</a>. these replays can be processed programmatically to collect statistics on the occurrence of specific events ingame.</p><p>previously, i had been very curious about whether <a rel="nofollow noreferrer" href="https://github.com/djanatyn/turnip-counter">my actual replay files matched up to the expected values </a> predicted by the chart above. at the time, <a rel="nofollow noreferrer" href="https://github.com/hohav">hohav</a> had already put together a rust crate called <a rel="nofollow noreferrer" href="https://github.com/hohav/peppi">peppi</a> which could process these replays. it didn&#39;t take very long to put together a program which would iterate over a directory of replay files, identify any peach item pulls that matched my character, and record them to a simple sqlite database:</p><pre data-lang="sql"><code data-lang="sql"><span><span><span>CREATE</span> <span>TABLE</span> </span><span>IF NOT EXISTS </span><span><span>games</span></span> (
    id <span>INTEGER</span> <span>PRIMARY KEY</span> <span>NOT</span> <span>NULL</span>,
    filename <span>TEXT</span> <span>NOT</span> <span>NULL</span>,
    start_time <span>INTEGER</span>,
    p1_name <span>TEXT</span> <span>NOT</span> <span>NULL</span>,
    p1_code <span>TEXT</span> <span>NOT</span> <span>NULL</span>,
    p2_name <span>TEXT</span> <span>NOT</span> <span>NULL</span>,
    p2_code <span>TEXT</span> <span>NOT</span> <span>NULL</span>
);

<span><span>CREATE</span> <span>TABLE</span> </span><span>IF NOT EXISTS </span><span><span>items</span></span> (
    id <span>INTEGER</span> <span>PRIMARY KEY</span> <span>NOT</span> <span>NULL</span>,
    game_id <span>INTEGER</span> <span>NOT</span> <span>NULL</span>,
    item_id <span>INTEGER</span> <span>NOT</span> <span>NULL</span>,
    frame <span>INTEGER</span> <span>NOT</span> <span>NULL</span>,
    kind <span>TEXT</span> <span>NOT</span> <span>NULL</span>,
    <span>FOREIGN KEY</span> (game_id) <span>REFERENCES</span> games (id)
);
</span></code></pre><p>even with a small sample of 3,505 pulls and 418 games, my results were very close to expectations:</p><pre data-lang="sql"><code data-lang="sql"><span>sqlite<span>&gt;</span> <span>SELECT</span> <span>COUNT</span>(<span>*</span>) <span>FROM</span> items;
<span>3505</span>
sqlite<span>&gt;</span> <span>SELECT</span> <span>COUNT</span>(<span>*</span>) <span>FROM</span> games;
<span>418</span>
sqlite<span>&gt;</span> <span>SELECT</span> kind, CAST(<span>COUNT</span>(<span>*</span>) <span>AS</span> <span>REAL</span>) <span>/</span> (<span>SELECT</span> <span>COUNT</span>(<span>*</span>) <span>FROM</span> items) <span>FROM</span> items <span>GROUP BY</span> kind;
Beamsword      <span>0</span>.<span>00114122681883024</span> <span><span>--</span> ~0.11% actual vs 0.13% predicted
</span>Bobomb         <span>0</span>.<span>00228245363766049</span> <span><span>--</span> ~0.23% actual vs 0.26% predicted
</span>DotEyesTurnip  <span>0</span>.<span>0145506419400856</span>  <span><span>--</span> ~1.46% actual vs 1.71% predicted
</span>MrSaturn       <span>0</span>.<span>00485021398002853</span> <span><span>--</span> ~0.46% actual vs 0.39% predicted
</span>NormalTurnip   <span>0</span>.<span>888445078459344</span>   <span><span>--</span> ~88.84% actual vs 88.95% predicted (59.873 + 10.264 + 8.553 + 5.132 + 5.132)
</span>StitchTurnip   <span>0</span>.<span>0182596291012839</span>  <span><span>--</span> ~1.82% actual vs 1.71% predicted
</span>WinkyTurnip    <span>0</span>.<span>0704707560627675</span>  <span><span>--</span> ~7.04% actual vs 6.84% predicted
</span></span></code></pre><p>but i was still curious. i had a chart of frequencies to expect, and i saw that my actual games were close to these expectations, but i still didn&#39;t understand how the game logic determined which item comes out of the ground.</p><p>at some point, i encountered <a rel="nofollow noreferrer" href="https://www.reddit.com/r/SSBM/comments/71gn1d/the_basics_of_rng_in_melee/">a reddit post from september 2017 by twotwelvedegrees</a>, titled &#34;The Basics of RNG in Melee&#34;. not only did this post explain the basics of melee&#39;s <a rel="nofollow noreferrer" href="https://en.wikipedia.org/wiki/Linear_congruential_generator">linear congruential generator</a> implementation, it also broke down the particular RNG calls which were executed for peach&#39;s item pulls:</p><blockquote><p>All random events in the game are controlled by the output of two functions: get_random_int(max_val) and get_random_float()...On any turnip pull Peach starts with a call to get_random_int(128) which proceeds as follows:</p></blockquote><table><thead><tr><th>Value</th><th>Result</th></tr></thead><tbody><tr><td>0</td><td>Peach pulls an item</td></tr><tr><td>1-127</td><td>Peach pulls a turnip</td></tr></tbody></table><blockquote><p>On pulling an item, there is then a call to get_random_int(6) which proceeds as follows:</p></blockquote><table><thead><tr><th>Value</th><th>Result</th></tr></thead><tbody><tr><td>0-1</td><td>Peach pulls a bomb</td></tr><tr><td>2-4</td><td>Peach pulls a Mr. Saturn</td></tr><tr><td>5</td><td>Peach pulls a beam sword</td></tr></tbody></table><blockquote><p>On pulling a turnip, there is then a call to get_random_int(58) which proceeds as follows:</p></blockquote><table><thead><tr><th>Value</th><th>Result</th></tr></thead><tbody><tr><td>0-34</td><td>Peach pulls a regular turnip</td></tr><tr><td>35-40</td><td>Peach pulls an unamused turnip</td></tr><tr><td>41-45</td><td>Peach pulls a line eyes turnip</td></tr><tr><td>46-48</td><td>Peach pulls a circle eyes turnip</td></tr><tr><td>49-51</td><td>Peach pulls a super happy turnip</td></tr><tr><td>52-55</td><td>Peach pulls a winky turnip</td></tr><tr><td>56</td><td>Peach pulls a dot eyes</td></tr><tr><td>57</td><td>Peach pulls a stitch</td></tr></tbody></table><p>this was eye-opening for me. if i could analyze the code that was running while peach pulled an item, i could see (and provide a citation for) the conditional branches that were executed. i would no longer need to trust the chart - i could derive this information on my own. i was excited! and thankfully, much of the hard work had already been done for me.</p><p>in the very first paragraph, twotwelvedegrees mentions a spreadsheet:</p><blockquote><p>Major props to u/dansalvato and this spreadsheet since it basically did the research for me.</p></blockquote><p>this is the <a href="https://docs.google.com/spreadsheets/d/1JX2w-r2fuvWuNgGb6D3Cs4wHQKLFegZe2jhbBuIhCG8/preview#gid=19" rel="nofollow noreferrer">SSBM Data Sheet (1.02)</a>. it contains function addresses for many of the subroutines the game engine executes during normal gameplay. this document represents an extraordinary amount of effort reverse-engineering the game, made available for any curious hackers like myself.</p><p>one of the sections under the &#34;Function Addresses&#34; tab is labeled &#34;Random Number Generator&#34;. the <code>get_random_int</code> function mentioned in the reddit post is described in some detail here:</p><ul><li>there is a main RNG function at <code>0x80380580</code>,</li><li>it&#39;s input is <code>r3</code>, which is the number of possible numbers to generate for the call,</li><li>it&#39;s output is <code>r3</code>, which is the random number returned</li></ul><p>if this is accurate, it means that every time peach attempts to pulls an item, we expect there&#39;s a call to <code>get_random_int(128)</code> at <code>0x80380580</code>. we should be able to load up our copy of melee, start the game, identify the function, and set some breakpoints to see it in action!</p><p>i&#39;m on nixos, so to load dolphin, i pull down a version from nixpkgs:</p><pre data-lang="sh"><code data-lang="sh"><span><span><span>nix</span></span><span> build nixpkgs#dolphin-emu<span><span> -</span>o</span> dolphin-hacking</span> <span>;</span> <span><span>:</span></span><span> get dolphin package</span>
<span><span>./dolphin-hacking/bin/dolphin-emu</span></span>                <span>;</span> <span><span>:</span></span><span> execute dolphin</span>
</span></code></pre><p>you&#39;re on your own for acquiring a copy of melee&#39;s disk image.</p><p>on my copy of dolphin, the debugging interface wasn&#39;t visible by default, so i had to enable it:</p><figure><img alt="screenshot of &#39;Enable Debugging UI&#39; checkbox" src="https://mindustrygame.github.io/img/enable-debugging-ui.png"/><figcaption>Options &gt; Configuration &gt; Interface</figcaption></figure><p>i also toggled the &#39;Code&#39;, &#39;Registers&#39;, and &#39;Memory&#39; pane into view:</p><figure><img alt="enabling &#39;Code&#39;, &#39;Registers&#39;, and &#39;Memory&#39; view" src="https://mindustrygame.github.io/img/dolphin-view-settings.png"/><figcaption>View Toggles</figcaption></figure><p>i also moved some panes around:</p><figure><img alt="screenshot of dolphin debugger ui" src="https://mindustrygame.github.io/img/dolphin-ui.png"/><figcaption>ready for action</figcaption></figure><p>i&#39;ve got an adapter for my gamecube controller setup, and i have a few gecko codes enabled which change the default behavior of the game to make investigation a little easier:</p><ul><li>Unlock All Characters and Stages</li><li>VS 1 player (set time to none)</li></ul><p>the game loads as expected, and we&#39;re at the character select screen:</p><figure><img alt="screenshot of melee running with debug pane to the side" src="https://mindustrygame.github.io/img/dolphin-debugger-game-running.png"/><figcaption>debugging activated</figcaption></figure><p>you might notice that all instructions are marked as <code>&lt;unknown&gt;</code> while the game is running. if we hit the pause button, we can see the instructions:</p><figure><img alt="screenshot of instructions in debug pane" src="https://mindustrygame.github.io/img/dolphin-unpaused.png"/><figcaption>instructions are now visible</figcaption></figure><p>cool! we can see the address of each instruction, it&#39;s parameters, and there&#39;s even a callstack showing how we got here.</p><p>we already know where <code>get_random_int</code> is, so let&#39;s try searching for it.</p><p>there&#39;s a &#34;Search Address&#34; text input available. typing in <code>0x80380580</code> and hitting enter will highlight the line for that address. we can right-click this line, select &#34;Add Function&#34; from the context menu, and we&#39;ll see a set of instructions highlighted:</p><figure><img alt="instructions for get_random_int" src="https://mindustrygame.github.io/img/add_function.png"/><figcaption>get_random_int assembly instructions</figcaption></figure><p>the name <code>zz_80380580_</code> is not very helpful. we can change that by right-clicking the same line, selecting &#34;Rename symbol&#34; from the context menu, and giving this symbol a better name, <code>get_random_int</code>.</p><p>we can even select &#34;Copy function&#34; in the context menu to get a listing for all of the instructions:</p><pre><code><span>get_random_int
80380580: lwz	r5, -0x570C (r13)
80380584: lis	r4, 0x0003
80380588: addi	r0, r4, 17405
8038058c: lwz	r4, 0 (r5)
80380590: mullw	r4, r4, r0
80380594: addis	r4, r4, 39
80380598: subi	r0, r4, 24893
8038059c: stw	r0, 0 (r5)
803805a0: lwz	r4, -0x570C (r13)
803805a4: lwz	r0, 0 (r4)
803805a8: rlwinm	r0, r0, 16, 16, 31 (ffff0000)
803805ac: mullw	r0, r3, r0
803805b0: srawi	r3, r0,16
803805b4: addze	r3, r3
803805b8: blr	
</span></code></pre><p>understanding what all of these instructions do is outside the scope of this post. instead, let&#39;s ask dolphin to log every time this function is executed by adding a breakpoint!</p><p>first, let&#39;s enable the breakpoint view (i forgot to turn it on earlier):</p><figure><img alt="enabling breakpoints" src="https://mindustrygame.github.io/img/dolphin-view-breakpoints.png"/><figcaption>oops we need those</figcaption></figure><p>navigate to the breakpoint tab, click &#34;New&#34;, and let&#39;s observe these calls as they execute:</p><figure><img alt="breakpoint configuration" src="https://mindustrygame.github.io/img/log-breakpoint.png"/><figcaption>breakpoint configuration</figcaption></figure><ul><li>activate this breakpoint at <code>0x80380580</code> (our suspected <code>get_random_int</code> function),</li><li>our condition <code>r3, 1</code> means to display the register <code>r3</code> in the log (which should be the range on numbers generated),</li><li>don&#39;t stop execution of the game, just log it</li></ul><p>it should look like this (it even includes our renamed symbol from earlier):</p><figure><img alt="configured breakpoint" src="https://mindustrygame.github.io/img/breakpoint-success.png"/><figcaption>configured breakpoint enabled</figcaption></figure><p>in melee, attempting to place the character select token when it isn&#39;t hovering over a particular character will select a random character - the random button is a modern innovation.</p><figure><img alt="randomly selecting characters" src="https://mindustrygame.github.io/img/random-characters.gif"/><figcaption>og random button</figcaption></figure><p>that random choice has to come from somewhere. in the log, we can actually see some <code>get_random_int</code> calls happening already:</p><pre><code><span>Breakpoint condition returned: 1. Vars:  r3=25
</span></code></pre><p><code>Vars: r3=25</code> sounds about right - there are 25 characters in the game!</p><blockquote><p>if you don&#39;t see any logs for breakpoints, check your logging configuration (&#34;View&#34; &gt; &#34;Show Logging Configuration&#34;) and try enabling all log types.</p></blockquote><p>let&#39;s get ingame and try pulling a turnip! hit down-b, hit start to pause the game, and let&#39;s see what happened.</p><figure><img alt="screenshot of daisy pulling turnip" src="https://mindustrygame.github.io/img/pull-turnip.png"/><figcaption>daisy is the best peach costume</figcaption></figure><pre><code><span>...
Breakpoint condition returned: 1. Vars:  r3=128
Breakpoint condition returned: 1. Vars:  r3=58
...
</span></code></pre><p>nice:</p><ul><li><code>get_random_int(128)</code> is determining whether we pull an item or a turnip, and</li><li><code>get_random_int(58)</code> is determining the face of the turnip</li></ul><p>we&#39;re not logging the return value of the RNG call right now, but we&#39;ve identified the <code>get_random_int</code> calls that are being executed when peach pulls an item. that&#39;s great progress!</p><p>what code is calling <code>get_random_int(128)</code>? let&#39;s modify our breakpoint with a different condition, and set it to break (not just log):</p><figure><img alt="new breakpoint condition" src="https://mindustrygame.github.io/img/modify-condition.png"/><figcaption>check for a specific argument</figcaption></figure><p>after pulling another turnip, the game should pause, stopping at <code>get_random_int</code>. interestingly, even though peach may have entered the item pull animation, the animation does not show which item peach has pulled, since it hasn&#39;t decided yet. let&#39;s check out our callstack:</p><figure><img alt="callstack screenshot" src="https://mindustrygame.github.io/img/link-register.png"/><figcaption>the path that led us here</figcaption></figure><p><code>LR</code> represents the <a rel="nofollow noreferrer" href="https://en.wikipedia.org/wiki/Link_register">&#34;link register&#34;</a>. whenever we call a subroutine with the <code>bl</code> instruction, we populate a special register with the address to return the program counter to once our subroutine finishes executing (usually with a <code>blr</code> instruction). if we click on the <code>LR = 8011d088</code> address, we can get some context on what&#39;s happening before this RNG call is executed, and what we do with the result.</p><p>this instruction is happening in the middle of the subroutine, so i scrolled up the previous <code>blr</code> instruction (denoting the end of the last subroutine), moved onto the next instruction (<code>0x8011d018</code>), and defined a new function as we did previously. i named it <code>turnip_rng_caller</code> - it may be used for other interactions, but we&#39;re fairly confident it&#39;s part of peach&#39;s item pull logic.</p><blockquote><p>the address <code>0x8011d018</code> is included in the <a rel="nofollow noreferrer" href="https://smashboards.com/threads/smashboards-community-symbol-map.426763/">smashboards community symbol map</a>, given the name <code>_$_wP_Peach_DownB_GenTurnip</code> - looks like we&#39;re on the right track.</p></blockquote><p>let&#39;s take a closer look at the logic around <code>0x8011d088</code> in the body of the function:</p><pre><code><span>...
8011d088: bl	-&gt;0x80380580
8011d08c: cmpwi	r3, 0
8011d090: bne-	 -&gt;0x8011D0A0
8011d094: mr	r3, r29
8011d098: bl	-&gt;0x8011CE48
8011d09c: mr	r31, r3
8011d0a0: lwz	r4, 0x010C (r30)
8011d0a4: mr	r6, r31
8011d0a8: lfs	f1, 0x002C (r30)
8011d0ac: mr	r3, r29
8011d0b0: lwz	r4, 0x0008 (r4)
8011d0b4: lbz	r5, 0x0010 (r4)
8011d0b8: addi	r4, sp, 52
8011d0bc: bl	-&gt;0x802BD4AC
...
</span></code></pre><p>there&#39;s a few things happening here:</p><ul><li>we call <code>get_random_int(128)</code> (denoted by address <code>0x80380580</code>, with <code>r3</code> set to <code>128</code>),</li><li>when we return to the subroutine, <code>r3</code> is populated with the random return value</li><li>we check <code>r3</code> with the <code>cmpwi</code> instruction to see if the return value is 0,</li><li>if <em>the return value is not 0</em>, we branch to <code>0x8011d0a0</code> using the <code>bne</code> instruction</li><li>if <em>the return value is 0</em>, we continue execution.</li></ul><p>this maps directly to the explanation we saw in &#34;The Basics of RNG in Melee&#34; previously, but this time we&#39;re doing it live.</p><p>we can try stepping through the <code>get_random_int</code> call until we get to the return <code>blr</code> instruction at <code>0x803805b8</code>. if we check the value of the <code>r3</code> register, we can see the random result returned:</p><figure><img alt="r3 is returning 0x20" src="https://mindustrygame.github.io/img/r3-return.png"/><figcaption>0x20 == 32</figcaption></figure><p><code>32 != 0</code>, so this is going to be a turnip. but now that we know how this logic works...what if we got a little mischevious?</p><p>navigate to the <code>cmpwi</code> instruction at <code>0x8011d08c</code>:</p><figure><img alt="cmpwi instruction" src="https://mindustrygame.github.io/img/cmpwi.png"/><figcaption>our fate is in our own hands</figcaption></figure><p>let&#39;s create a new breakpoint:</p><figure><img alt="cmpwi breakpoint conditions" src="https://mindustrygame.github.io/img/cmpwi-conditions.png"/><figcaption>this is not tournament legal</figcaption></figure><p>instead of using the returned value from the <code>get_random_int(128)</code> call, we&#39;re just going to set register <code>r3</code> to 0 when evaluating this instruction.</p><p>let&#39;s disable our previous breakpoint for now so we can test this out:</p><figure><img alt="disabling get_random_int breakpoint" src="https://mindustrygame.github.io/img/disable-old-breakpoint.png"/><figcaption>otherwise, our game stops on every item pull</figcaption></figure><p>hit start, and let&#39;s get pulling!</p><figure><img alt="peach is only throwing items" src="https://mindustrygame.github.io/img/buffed-peach.gif"/><figcaption>the dream</figcaption></figure><p>i&#39;m quite fond of beamswords, so let&#39;s see if we can make them a little more popular. if we refer to our charts from earlier, we expect that there will be a <code>get_random_int(6)</code> call. we can modify our <code>get_random_int</code> breakpoint condition accordingly:</p><figure><img alt="r3 == 6" src="https://mindustrygame.github.io/img/breakpoint-modify.png"/><figcaption>r3 == 6</figcaption></figure><p>if you&#39;ve followed along this far, hopefully you&#39;re getting the hang of the dolphin debugger. hit the <code>LR == 8011cf0c</code> address in the callstack, a familiar <code>bl -&gt;0x80380580</code> instruction. let&#39;s navigate to the <em>next instruction</em> (<code>0x8011cf10</code>) and create a new breakpoint, setting <code>r3 = 5</code> and continuing execution:</p><figure><img alt="r3 = 5" src="https://mindustrygame.github.io/img/mr-saturn-breakpoint.png"/><figcaption>r3 = 5</figcaption></figure><p>once again, let&#39;s disable our <code>get_rand_int</code> item RNG call:</p><figure><img alt="disabling item rng breakpoint" src="https://mindustrygame.github.io/img/disable-item-rng.png"/><figcaption>we&#39;re almost there</figcaption></figure><p>and finally:</p><figure><img alt="peach only pulls beamswords now" src="https://mindustrygame.github.io/img/sword-peach.gif"/><figcaption>watch out marth</figcaption></figure><p>nothing here is novel - my goal is only to share the fun things i&#39;ve been learning about recently. i spend much of my time working towards understanding through experimentation, and i&#39;m hoping this blog can serve as a lab notebook.</p><p>if you have any questions, comments, or corrections, feel free to send me an email at <a href="mailto:djanatyn@gmail.com">djanatyn@gmail.com</a>. thanks for taking the time to read, take care!</p></article></div></div>
  </body>
</html>
