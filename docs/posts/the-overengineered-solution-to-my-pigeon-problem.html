<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://maxnagy.com/posts/pigeons/">Original</a>
    <h1>The overengineered solution to my pigeon problem</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>TL;DR: I built a wifi-equipped water gun to shoot
the pigeons on my balcony, controlled over the internet by a
python script running openCV reading the camera image of my
old iPhone.</p><hr/><p>The pigeons in my backyard find particular pleasures in voiding their excrements onto my balcony. Dissatisfied with this situation, I went online to find a solution. I created a handy table to give you an overview of the vast number of <del>effective</del> <em>established</em> ways to get rid if pigeons:</p><table><thead><tr><th>Approach</th><th>Why it doesn’t work</th></tr></thead><tbody><tr><td>Plastic crows</td><td>Pigeons get used to them</td></tr><tr><td>Crow stickers</td><td>Pigeons get used to them</td></tr><tr><td>Reflective wind mills / CDs / …</td><td>Pigeons get used to them</td></tr><tr><td>Sounds of animals (dogs, predators)</td><td>Pigeons get used to them</td></tr><tr><td>Dog and cat hair</td><td>Pigeons get used to them</td></tr><tr><td>Ultrasonic sounds</td><td>Hear me out: Even the people advocating for it admit that pigeons (like humans) are incapable of perceiving ultrasonic sounds. Instead they think that pigeons are <a href="https://en.wikipedia.org/wiki/Electromagnetic_hypersensitivity">wavies</a> and that the mere presence of some imperceptible waves somehow distress the pigeons. You can’t make this stuff up. As might be expected, nobody ever had any success with it.</td></tr><tr><td>Shooting pigeons</td><td>While it would certainly help coping with the distress of cleaning their crap, its highly illegal in Germany and even after one of my neighbours apparently tried it (I just saw the police leaflets) the number of pigeons didn’t noticeably decrease. To be fair, some random neighbour with an air rifle is probably no comparison to the olympic pigeon killers <a href="https://en.wikipedia.org/wiki/Shooting_at_the_1900_Summer_Olympics#Excluded_events">of the past</a>.</td></tr><tr><td>Getting a cat</td><td>That should actually work if the cat has regular access to the balcony. But I don’t have a cat and it would probably suicide itself in its attempt to hunt pigeons in the fifth floor.</td></tr><tr><td>Spikes</td><td>They work IFF you buy the right ones AND put them absolutely everywhere AND are careful to actually mount them correctly AND you don’t plan to use the area covered yourself at all AND you don’t even want to look at its disgraced looks. So it is completely pointless for a balcony.</td></tr><tr><td>Nets</td><td>They work if you can tolerate their looks (I don’t) and mount them correctly. In practice they are often mounted incorrectly so you have to remove dead or alive pigeons on a somewhat regular basis.</td></tr><tr><td>Scaring them away by shouting, water gun, clapping, etc.</td><td>Pigeons get used to it. Also you typically spend way too little time on the balcony to do keep them away permanently. But what if I outsourced the water gunning to some robotic contraption?</td></tr></tbody></table><p>After a quick burst of manic energy during exam phase, I decided to solve the pigeon problem on my balcony once and for all (and in a humane way). The idea was quite simple: Mount an electric water gun on my balcony, detect pigeons with a web cam and shoot them. Pigeons should not get used to getting sprayed at (at least not while its coldish), I don’t have to disfigure my balcony and I’m not harming the pigeons in any way or even risk killing them. As I approached this project during my exam phase, it should also be quick to implement using things I already have laying around.</p><p>I bought a cheap electric water gun <a href="https://www.amazon.de/Wasserpistole-Elektrische-Wasserblaster-Wasserdicht-Wasserspielzeug/dp/B09578C69R/ref=sr_1_6?keywords=wasserpistole+elektrisch&amp;qid=1650101643&amp;sprefix=wasserpistole+ele%2Caps%2C147&amp;sr=8-6">from Amazon</a> and tested it out: The range of around 3-4 meters is pathetic, but plenty for my balcony.</p><p>Next, I opened it up to figure out how to control it over the internet:</p><p><img src="https://maxnagy.com/posts/pigeons/water_gun.jpg" alt="The water gun opened"/></p><p>I chose one of my trusty Wemos D1 Mini boards as the brain if the
water gun. They are small, cheap, offer Wifi and have some shields
available for them that ease cabling. In particular I’m using the
relay shield. (Relays are basically electrically operated
switches).
To control the water gun, I inserted a small paper contraption
in the battery department that allows me to break the gun’s
power and added a small hole for the cables:</p><p><img src="https://maxnagy.com/posts/pigeons/microcontroller.jpg" alt="The water gun with the paper contraption and the microcontroller installed"/></p><p>The microcontroller is powered by a USB power bank which is convenient, as the microcontroller does not drain the gun’s battery (where
recheargable batteries don’t fit (yes, really)), and the guns motor
can draw as much power as it wants without crashing the
microcontroller. Also, it allows me to reprogram the Wemos if I
mess up the wifi config ;)</p><p>I decided to use my old iPhone 6S as a camera: Its small, has a
battery, works without any configuration and most importantly: I
had it at hand. After finding a suitable position on my window, I
designed a very simple holding bracket, 3D printed it and glued it
on my balcony window using <a href="https://www.amazon.de/3M-VHB-Hochleistungsklebeband-schwarz-doppelseitiges/dp/B00EDLPG7Y/ref=sr_1_6?keywords=3M+tape&amp;qid=1650114049&amp;sr=8-6">3M mounting tape</a> <sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup>.
I use <a href="https://apps.apple.com/de/app/ipcamera-high-end-networkcam/id570912928?l=en">this app</a>
to get a MJPEG stream of its camera. It works good and
I like that it lets you black out the display. As a final step,
I put masking tape on the window, so that the camera does not look
into my neighbours windows as that would be creepy.</p><h4 id="image-analysis">Image Analysis<a href="#image-analysis" arialabel="Anchor">⌗</a></h4><p>The brains of the operation is a python script using openCV. It
compares the current image to the normal background <sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup>.
If the average amount of change of all pixels is above some threshold, we fire the
gun. We use four small tricks to make this work reliably in practice:</p><ol><li>If a pixel changed by less then 10% we don’t count it as 0 in the calculation</li><li>If the amount of change if bigger than some threshold, we ignore it
(in this case someone touched the camera)</li><li>We add a mask over the image to exclude some flowers that move in
the wind, as well as the reflections in the window. (Otherwise
it gets triggered whenever someone comes close to the window)</li><li>After a movement was detected, wait for the movement to stop
(and the background to stabilise) again.</li></ol><p>This heuristic works pretty reliably.</p><p>The resulting code looks like this:</p><div><pre tabindex="0"><code data-lang="python"><span><span>    stream <span>=</span> CamGear(source<span>=</span><span>&#34;http://IP_OF_IPHONE/live&#34;</span>)<span>.</span>start()
</span></span><span><span>
</span></span><span><span>    background <span>=</span> <span>None</span>
</span></span><span><span>    <span>while</span> <span>True</span>:
</span></span><span><span>        frame <span>=</span> stream<span>.</span>read()
</span></span><span><span>        <span># apply mask</span>
</span></span><span><span>        frame <span>=</span> cv2<span>.</span>bitwise_and(frame, frame, mask<span>=</span>mask)
</span></span><span><span>
</span></span><span><span>        <span># convert to grayscale</span>
</span></span><span><span>        frame <span>=</span> cv2<span>.</span>cvtColor(frame, cv2<span>.</span>COLOR_RGB2GRAY)
</span></span><span><span>
</span></span><span><span>        <span>if</span> background <span>is</span> <span>None</span>:
</span></span><span><span>            background <span>=</span> frame
</span></span><span><span>            <span>continue</span>
</span></span><span><span>
</span></span><span><span>        <span># update background</span>
</span></span><span><span>        background <span>=</span> cv2<span>.</span>addWeighted(
</span></span><span><span>            background, background_alpha, frame, (<span>1</span> <span>-</span> background_alpha), <span>0</span>
</span></span><span><span>        )
</span></span><span><span>
</span></span><span><span>        <span># calculate difference to background </span>
</span></span><span><span>        diff <span>=</span> cv2<span>.</span>absdiff(frame, background)
</span></span><span><span>
</span></span><span><span>        <span># apply threshold to background</span>
</span></span><span><span>        _, diff <span>=</span> cv2<span>.</span>threshold(diff, <span>30</span>, <span>255</span>, cv2<span>.</span>THRESH_BINARY)
</span></span><span><span>
</span></span><span><span>        score <span>=</span> np<span>.</span>mean(diff)
</span></span><span><span>        <span>if</span> armed:
</span></span><span><span>            <span>if</span> score <span>&gt;</span> <span>10</span>:
</span></span><span><span>                <span># camera was moved</span>
</span></span><span><span>                time<span>.</span>sleep(<span>10</span>)
</span></span><span><span>                armed <span>=</span> <span>False</span>
</span></span><span><span>            <span>elif</span> score <span>&gt;</span> <span>0.5</span>:
</span></span><span><span>                <span># PIGEON!</span>
</span></span><span><span>                armed <span>=</span> <span>False</span>
</span></span><span><span>                time<span>.</span>sleep(<span>1</span>)
</span></span><span><span>                frame <span>=</span> stream<span>.</span>read()
</span></span><span><span>                cv2<span>.</span>imwrite(
</span></span><span><span>                    <span>f</span><span>&#34;</span><span>{</span>datetime<span>.</span>now()<span>}</span><span>.jpg&#34;</span>, 
</span></span><span><span>                    frame, <span># save a picture for later</span>
</span></span><span><span>                )
</span></span><span><span>
</span></span><span><span>
</span></span><span><span>                requests<span>.</span>get(<span>&#34;http://IP_OF_SERVER&#34;</span>, timeout<span>=</span><span>1</span>)
</span></span><span><span>
</span></span><span><span>        <span>else</span>:
</span></span><span><span>            <span># rearm if the image is stable again</span>
</span></span><span><span>            armed <span>=</span> (score <span>==</span> <span>0</span>)
</span></span></code></pre></div><h4 id="networking">Networking<a href="#networking" arialabel="Anchor">⌗</a></h4><p>The first iteration used a HTTP server on the Wemos Board that
triggered, whenever a request was received. This was
straightforward and worked well, until I found out that the wifi
antenna on the Wemos is too weak to connect to my wifi from the
balcony. The solution was to connect the Wemos to my phones
hotspot. The problem is, that now the Wemos and my laptop are now
in different networks so they cannot talk to one another directly.</p><p>I therefore wrote a small go program (the <em>reflector</em>) that
accepts HTTP and TCP connections: Whenever it receives a HTTP
request, it sends “PEW!” to one of the connected TCP clients
(Usually there is only one). The code is pretty simple, the only
tricky part is to ensure that reconnections are handled well.
Go makes this easy with channels and goroutines:</p><div><pre tabindex="0"><code data-lang="go"><span><span><span>func</span> <span>main</span>() {
</span></span><span><span>	<span>channel</span> <span>:=</span> make(<span>chan</span> <span>byte</span>, <span>42</span>)
</span></span><span><span>	<span>http</span>.<span>HandleFunc</span>(<span>&#34;/&#34;</span>, <span>func</span>(<span>w</span> <span>http</span>.<span>ResponseWriter</span>, <span>r</span> <span>*</span><span>http</span>.<span>Request</span>) {
</span></span><span><span>		<span>if</span> len(<span>channel</span>) <span>==</span> <span>0</span> {
</span></span><span><span>			<span>channel</span> <span>&lt;-</span> <span>42</span>
</span></span><span><span>		}
</span></span><span><span>	})
</span></span><span><span>
</span></span><span><span>	<span>go</span> <span>http</span>.<span>ListenAndServe</span>(<span>&#34;:4242&#34;</span>, <span>nil</span>)
</span></span><span><span>
</span></span><span><span>	<span>sock</span>, <span>err</span> <span>:=</span> <span>net</span>.<span>Listen</span>(<span>&#34;tcp&#34;</span>, <span>&#34;:4243&#34;</span>)
</span></span><span><span>	<span>handle</span>(<span>err</span>)
</span></span><span><span>
</span></span><span><span>	<span>for</span> {
</span></span><span><span>		<span>conn</span>, <span>err</span> <span>:=</span> <span>sock</span>.<span>Accept</span>()
</span></span><span><span>		<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
</span></span><span><span>			<span>continue</span>
</span></span><span><span>		}
</span></span><span><span>		<span>go</span> <span>func</span>() {
</span></span><span><span>			<span>defer</span> <span>conn</span>.<span>Close</span>()
</span></span><span><span>			<span>for</span> {
</span></span><span><span>				<span>&lt;-</span><span>channel</span>
</span></span><span><span>				<span>_</span>, <span>err</span> = <span>conn</span>.<span>Write</span>([]byte(<span>&#34;PEW!\n&#34;</span>))
</span></span><span><span>				<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
</span></span><span><span>					<span>break</span>
</span></span><span><span>				}
</span></span><span><span>			}
</span></span><span><span>		}()
</span></span><span><span>	}
</span></span><span><span>}
</span></span></code></pre></div><p>The water gun connects via TCP and fires whenever it
receives “PEW!”. The python script on my laptop stays as it is and
simply sends its HTTP requests to the go program on my server
instead of directly to the Wemos. I chose to use micropython to
program the Wemos:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>def</span> <span>main</span>():
</span></span><span><span>    pin <span>=</span> machine<span>.</span>Pin(<span>5</span>, machine<span>.</span>Pin<span>.</span>OUT) <span># connected to relay</span>
</span></span><span><span>    addr <span>=</span> (<span>&#34;IP_OF_MY_SERVER&#34;</span>, <span>4243</span>)
</span></span><span><span>    <span>while</span> <span>True</span>:
</span></span><span><span>        s <span>=</span> socket<span>.</span>socket()
</span></span><span><span>        s<span>.</span>connect(addr)
</span></span><span><span>        <span>try</span>:
</span></span><span><span>            <span>while</span> <span>True</span>:
</span></span><span><span>                <span>if</span> <span>b</span><span>&#34;PEW&#34;</span> <span>in</span> s<span>.</span>recv(<span>255</span>): 
</span></span><span><span>                    print(<span>&#34;PEW!&#34;</span>)
</span></span><span><span>                    pin<span>.</span>value(<span>1</span>)
</span></span><span><span>                    time<span>.</span>sleep(<span>0.5</span>)
</span></span><span><span>                    pin<span>.</span>value(<span>0</span>)
</span></span><span><span>        <span>finally</span>:
</span></span><span><span>            s<span>.</span>close()
</span></span></code></pre></div><p>The smart ones among you may have noticed some bugs in the snippets
above: TCP does not guarantee that our “PEW!” message is sent
received in a single package; if multiple clients are connected,
only one receives the message (which may be disconnected);
and the whole operation is entirely unencrypted and
unauthenticated. And you’d be absolutely right. A nice thing about
writing software just for oneself is that its completely sufficent
if it works for me (tm). Of course I made sure that the setup cannot
be used to gain access to my network / remote code execution /
host child porn / be used for DDOS or all of the other stuff that
may happen when you deploy software on the internet. If this post
motivates someone to find my server and empty the whole whopping
200ml of water on my balcony, I may add a password and or let the
reflector bind only my VPN. But if you made it this far through the
text you wouldn’t do that, right? &lt;3</p><p>Let’s have a look at our first customer:</p><p><img src="https://maxnagy.com/posts/pigeons/1.jpg" alt=""/></p><p>Look at him sitting there, just behind the railings. This is
precisely where the water gun <em>would</em> be pointing at. This picture
was taken, in the brief period between realising that the wifi on
the balcony is too weak and coming up with the reflector solution.
Luckily he was not in the mood for release.</p><p>After I installed the updated version including a working water
gun, not a single pigeon was seen again. <em>For six days</em>. Maybe
shouting at pigeons is not that bad of a solution after all?
Luckily I had an exam phase to distract me from this
disappointment.</p><p>I was quite relieved-ish to find another customer on day seven:</p><p><img src="https://maxnagy.com/posts/pigeons/4.jpg" alt=""/></p><p>Spot on! This success lasted for a few days until the pigeons took
it to the third dimension:</p><p><img src="https://maxnagy.com/posts/pigeons/5.jpg" alt=""/></p><p>I guess, I’ll just keep the table inside for now.</p><p>To be continued…</p></div></div></div>
  </body>
</html>
