<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://canarytokens.org/generate">Original</a>
    <h1>Canary Tokens</h1>
    
    <div id="readability-page-1" class="page"><p>The next step is to copy the SQL snippet below and run in your SQL Server database.</p><div>
                    <p>
--create a stored proc that&#39;ll ping canarytokens
      CREATE proc ping_canarytoken
      AS
      BEGIN
          declare @username varchar(max), @base64 varchar(max), @tokendomain varchar(128), @unc varchar(128), @size int, @done int, @random varchar(3);

          --setup the variables
          set @tokendomain = &#39;<span></span>&#39;;
          set @size = 128;
          set @done = 0;
          set @random = cast(round(rand()*100,0) as varchar(2));
          set @random = concat(@random, &#39;.&#39;);
          set @username = SUSER_SNAME();

          --loop runs until the UNC path is 128 chars or less
          while @done &lt;= 0
          begin
              --convert username into base64
              select @base64 = (SELECT
                  CAST(N&#39;&#39; AS XML).value(
                        &#39;xs:base64Binary(xs:hexBinary(sql:column(&#34;bin&#34;)))&#39;
                      , &#39;VARCHAR(MAX)&#39;
                  )   Base64Encoding
              FROM (
                  SELECT CAST(@username AS VARBINARY(MAX)) AS bin
              ) AS bin_sql_server_temp);

              --replace base64 padding as dns will choke on =
              select @base64 = replace(@base64,&#39;=&#39;,&#39;-&#39;)

              --construct the UNC path
              select @unc = concat(&#39;\\&#39;,@base64,&#39;.&#39;,@random,@tokendomain,&#39;\a&#39;)

              -- if too big, trim the username and try again
              if len(@unc) &lt;= @size
                  set @done = 1
              else
                  --trim from the front, to keep the username and lose domain details
                  select @username = substring(@username, 2, len(@username)-1)
          end
          exec master.dbo.xp_fileexist @unc;
      END

      --add a trigger if data is altered
      CREATE TRIGGER <span></span>
        ON <span></span>
        AFTER <span></span>
      AS
      BEGIN
      exec ping_canarytoken
      end

                    </p>
                    <p>
--create a table-view function to query the canary hostname
      CREATE function <span></span>(@RAND FLOAT) returns @output table (col1 varchar(max))
      AS
      BEGIN
          declare @username varchar(max), @base64 varchar(max), @tokendomain varchar(128), @unc varchar(128), @size int, @done int, @random varchar(3);

          --setup the variables
          set @tokendomain = &#39;<span></span>&#39;;
          set @size = 128;
          set @done = 0;
          set @random = cast(round(@RAND*100,0) as varchar(2));
          set @random = concat(@random, &#39;.&#39;);
          set @username = SUSER_SNAME();

          --loop runs until the UNC path is 128 chars or less
          while @done &lt;= 0
          begin
              --convert username into base64
              select @base64 = (SELECT
                  CAST(N&#39;&#39; AS XML).value(
                        &#39;xs:base64Binary(xs:hexBinary(sql:column(&#34;bin&#34;)))&#39;
                      , &#39;VARCHAR(MAX)&#39;
                  )   Base64Encoding
              FROM (
                  SELECT CAST(@username AS VARBINARY(MAX)) AS bin
              ) AS bin_sql_server_temp);

              --replace base64 padding as dns will choke on =
              select @base64 = replace(@base64,&#39;=&#39;,&#39;0&#39;)

              --construct the UNC path
              select @unc = concat(&#39;\\&#39;,@base64,&#39;.&#39;,@random,@tokendomain,&#39;\a&#39;)

              -- if too big, trim the username and try again
              if len(@unc) &lt;= @size
                  set @done = 1
              else
                  --trim from the front, to keep the username and lose domain details
                  select @username = substring(@username, 2, len(@username)-1)
          end
          exec master.dbo.xp_dirtree @unc-- WITH RESULT SETS (([result] varchar(max)));
              return
      END

      --create a view that calls the function
      alter view <span></span> as select * from master.dbo.<span></span>(rand());

      --change permissions on <span></span> to SELECT for [public]
      --change permissions on <span></span> to SELECT for [public]
      --don&#39;t allow [public] to view the definitions

                    </p>
                  </div></div>
  </body>
</html>
