<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/DataDog/pg_tracing">Original</a>
    <h1>pg_tracing: Distributed Tracing for PostgreSQL</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://gist.githubusercontent.com/bonnefoa/c4204828fff8ff1d4ed2b275fbbbdfaa/raw/313dd65703aba3a53da5eaacd1c447ef64ec7bef/nested_loop.png"><img src="https://gist.githubusercontent.com/bonnefoa/c4204828fff8ff1d4ed2b275fbbbdfaa/raw/313dd65703aba3a53da5eaacd1c447ef64ec7bef/nested_loop.png" alt="nested_loop trace"/></a></p>
<p dir="auto">pg_tracing is a PostgreSQL extension that generates server-side spans for distributed tracing.</p>
<p dir="auto">When pg_tracing is active, it generates spans on sampled queries. To access these spans, the extension provides two ways:</p>
<ul dir="auto">
<li><code>pg_tracing_consume_spans</code> and <code>pg_tracing_peek_spans</code> views output spans as a set of records</li>
<li><code>pg_tracing_json_spans</code> function outputs spans as a OTLP json</li>
</ul>
<p dir="auto">The utility functions <code>pg_tracing_reset</code> and <code>pg_tracing_info</code> provide ways to read and reset extension&#39;s statistics. These are not available globally but can be enabled for a specific database with <code>CREATE EXTENSION pg_tracing</code>.</p>
<p dir="auto">There are currently two mechanisms to propagate trace context:</p>
<ul dir="auto">
<li>As a SQL comment using <a href="https://google.github.io/sqlcommenter/" rel="nofollow">SQLCommenter</a></li>
<li>As a GUC parameter <code>pg_tracing.trace_context</code></li>
</ul>
<p dir="auto">See <a href="#trace-propagation">Trace Propagation</a> for more details.</p>
<div dir="auto"><p dir="auto"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</p><p dir="auto">This extension is still in early development and may be unstable.</p>
</div>
<div dir="auto"><h2 tabindex="-1" dir="auto">PostgreSQL Version Compatibility</h2><a id="user-content-postgresql-version-compatibility" aria-label="Permalink: PostgreSQL Version Compatibility" href="#postgresql-version-compatibility"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">pg_tracing only supports PostgreSQL 14, 15 and 16 for the moment.</p>

<p dir="auto">pg_tracing generates spans for the following events:</p>
<ul dir="auto">
<li>PostgreSQL internal functions: Planner, ProcessUtility, ExecutorRun, ExecutorFinish</li>
<li>Statements: SELECT, INSERT, DELETE...</li>
<li>Utility Statements: ALTER, SHOW, TRUNCATE, CALL...</li>
<li>Execution Plan: A span is created for each node of the execution plan (SeqScan, NestedLoop, HashJoin...)</li>
<li>Nested queries: Statements invoked within another statement (like a function)</li>
<li>Triggers: Statements executed through BEFORE and AFTER trigger are tracked</li>
<li>Parallel Workers: Processes created to handle queries like Parallel SeqScans are tracked</li>
<li>Transaction Commit: Time spent fsync changes on the WAL</li>
</ul>

<p dir="auto">The following list of files is found in the <a href="https://github.com/DataDog/pg_tracing/blob/main/doc">doc</a> folder of the pg_tracing github repository. For <a href="#installation">installation instructions</a>, please see the next section of this README.</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>File</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/DataDog/pg_tracing/blob/main/doc/pg_tracing.md">pg_tracing.md</a></td>
<td>Main reference documentation for pg_tracing.</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>


<p dir="auto">pg_tracing can be compiled against an installed copy of PostgreSQL with development packages using <code>PGXS</code>.</p>
<p dir="auto">To compile and install the extension, run:</p>
<div dir="auto" data-snippet-clipboard-copy-content="git clone https://github.com/DataDog/pg_tracing.git
cd pg_tracing
make install
# To compile and install with debug symbols:
PG_CFLAGS=&#34;-g&#34; make install"><pre>git clone https://github.com/DataDog/pg_tracing.git
<span>cd</span> pg_tracing
make install
<span><span>#</span> To compile and install with debug symbols:</span>
PG_CFLAGS=<span><span>&#34;</span>-g<span>&#34;</span></span> make install</pre></div>

<p dir="auto">The extension must be loaded by adding pg_tracing to the <a href="https://www.postgresql.org/docs/current/runtime-config-client.html#GUC-SHARED-PRELOAD-LIBRARIES" rel="nofollow">shared_preload_libraries</a> in <code>postgresql.conf</code>.
A server restart is needed to add or remove the extension.</p>
<div data-snippet-clipboard-copy-content="# postgresql.conf
shared_preload_libraries = &#39;pg_tracing&#39;

compute_query_id = on
pg_tracing.max_span = 10000
pg_tracing.track = all

# Send spans every 2 seconds to an otel collector
pg_tracing.otel_endpoint = http://127.0.0.1:4318/v1/traces
pg_tracing.otel_naptime = 2000"><pre><code># postgresql.conf
shared_preload_libraries = &#39;pg_tracing&#39;

compute_query_id = on
pg_tracing.max_span = 10000
pg_tracing.track = all

# Send spans every 2 seconds to an otel collector
pg_tracing.otel_endpoint = http://127.0.0.1:4318/v1/traces
pg_tracing.otel_naptime = 2000
</code></pre></div>
<p dir="auto">The extension requires additional shared memory proportional to <code>pg_tracing.max_span</code>. Note that this memory is consumed whenever the extension is loaded, even if no spans are generated.</p>


<p dir="auto">Trace context can be propagated through <a href="https://google.github.io/sqlcommenter/" rel="nofollow">SQLCommenter</a>. By default, all queries with a SQLCommenter with a sampled flag enabled will generate spans.</p>
<div dir="auto" data-snippet-clipboard-copy-content="-- Query with trace context and sampled flag enable
/*traceparent=&#39;00-00000000000000000000000000000123-0000000000000123-01&#39;*/ SELECT 1;

-- Check the generated spans
select trace_id, parent_id, span_id, span_start, span_end, span_type, span_operation from pg_tracing_consume_spans order by span_start;
             trace_id             |    parent_id     |     span_id      |          span_start           |           span_end            |  span_type   | span_operation
----------------------------------+------------------+------------------+-------------------------------+-------------------------------+--------------+----------------
 00000000000000000000000000000123 | 0000000000000123 | 4268a4281c5316dd | 2024-03-19 13:46:43.97958+00  | 2024-03-19 13:46:43.980121+00 | Select query | SELECT $1;
 00000000000000000000000000000123 | 4268a4281c5316dd | 87cb96b6459880a0 | 2024-03-19 13:46:43.979642+00 | 2024-03-19 13:46:43.979978+00 | Planner      | Planner
 00000000000000000000000000000123 | 4268a4281c5316dd | f5994f9159d8e80d | 2024-03-19 13:46:43.980081+00 | 2024-03-19 13:46:43.980111+00 | Executor     | ExecutorRun"><pre><span><span>--</span> Query with trace context and sampled flag enable</span>
<span><span>/*</span>traceparent=&#39;00-00000000000000000000000000000123-0000000000000123-01&#39;<span>*/</span></span> <span>SELECT</span> <span>1</span>;

<span><span>--</span> Check the generated spans</span>
<span>select</span> trace_id, parent_id, span_id, span_start, span_end, span_type, span_operation <span>from</span> pg_tracing_consume_spans <span>order by</span> span_start;
             trace_id             |    parent_id     |     span_id      |          span_start           |           span_end            |  span_type   | span_operation
<span><span>--</span>--------------------------------+------------------+------------------+-------------------------------+-------------------------------+--------------+----------------</span>
 <span>00000000000000000000000000000123</span> | <span>0000000000000123</span> | 4268a4281c5316dd | <span>2024</span><span>-</span><span>03</span><span>-</span><span>19</span> <span>13</span>:<span>46</span>:<span>43</span>.<span>97958</span><span>+</span><span>00</span>  | <span>2024</span><span>-</span><span>03</span><span>-</span><span>19</span> <span>13</span>:<span>46</span>:<span>43</span>.<span>980121</span><span>+</span><span>00</span> | <span>Select</span> query | <span>SELECT</span> $<span>1</span>;
 <span>00000000000000000000000000000123</span> | 4268a4281c5316dd | 87cb96b6459880a0 | <span>2024</span><span>-</span><span>03</span><span>-</span><span>19</span> <span>13</span>:<span>46</span>:<span>43</span>.<span>979642</span><span>+</span><span>00</span> | <span>2024</span><span>-</span><span>03</span><span>-</span><span>19</span> <span>13</span>:<span>46</span>:<span>43</span>.<span>979978</span><span>+</span><span>00</span> | Planner      | Planner
 <span>00000000000000000000000000000123</span> | 4268a4281c5316dd | f5994f9159d8e80d | <span>2024</span><span>-</span><span>03</span><span>-</span><span>19</span> <span>13</span>:<span>46</span>:<span>43</span>.<span>980081</span><span>+</span><span>00</span> | <span>2024</span><span>-</span><span>03</span><span>-</span><span>19</span> <span>13</span>:<span>46</span>:<span>43</span>.<span>980111</span><span>+</span><span>00</span> | Executor     | ExecutorRun</pre></div>

<p dir="auto">The GUC variable <code>pg_tracing.trace_context</code> can also be used to propagate trace context.</p>
<div dir="auto" data-snippet-clipboard-copy-content="BEGIN;
SET LOCAL pg_tracing.trace_context=&#39;traceparent=&#39;&#39;00-00000000000000000000000000000005-0000000000000005-01&#39;&#39;&#39;;
UPDATE pgbench_accounts SET abalance=1 where aid=1;
COMMIT;

-- Check generated span
select trace_id, span_start, span_end, span_type, span_operation from pg_tracing_consume_spans order by span_start;
             trace_id             |          span_start           |           span_end            |     span_type     |                      span_operation
----------------------------------+-------------------------------+-------------------------------+-------------------+-----------------------------------------------------------
 00000000000000000000000000000005 | 2024-07-05 14:24:55.305234+00 | 2024-07-05 14:24:55.305988+00 | Update query      | UPDATE pgbench_accounts SET abalance=$1 where aid=$2;
 00000000000000000000000000000005 | 2024-07-05 14:24:55.305266+00 | 2024-07-05 14:24:55.30552+00  | Planner           | Planner
 00000000000000000000000000000005 | 2024-07-05 14:24:55.305586+00 | 2024-07-05 14:24:55.305906+00 | ExecutorRun       | ExecutorRun
 00000000000000000000000000000005 | 2024-07-05 14:24:55.305591+00 | 2024-07-05 14:24:55.305903+00 | Update            | Update on pgbench_accounts
 00000000000000000000000000000005 | 2024-07-05 14:24:55.305593+00 | 2024-07-05 14:24:55.305806+00 | IndexScan         | IndexScan using pgbench_accounts_pkey on pgbench_accounts
 00000000000000000000000000000005 | 2024-07-05 14:24:55.649757+00 | 2024-07-05 14:24:55.649792+00 | Utility query     | COMMIT;
 00000000000000000000000000000005 | 2024-07-05 14:24:55.649787+00 | 2024-07-05 14:24:55.649792+00 | ProcessUtility    | ProcessUtility
 00000000000000000000000000000005 | 2024-07-05 14:24:55.649816+00 | 2024-07-05 14:24:55.650613+00 | TransactionCommit | TransactionCommit"><pre><span>BEGIN</span>;
<span>SET</span> LOCAL <span>pg_tracing</span>.<span>trace_context</span><span>=</span><span><span>&#39;</span>traceparent=<span>&#39;</span><span>&#39;</span>00-00000000000000000000000000000005-0000000000000005-01<span>&#39;</span><span>&#39;</span><span>&#39;</span></span>;
<span>UPDATE</span> pgbench_accounts <span>SET</span> abalance<span>=</span><span>1</span> <span>where</span> aid<span>=</span><span>1</span>;
<span>COMMIT</span>;

<span><span>--</span> Check generated span</span>
<span>select</span> trace_id, span_start, span_end, span_type, span_operation <span>from</span> pg_tracing_consume_spans <span>order by</span> span_start;
             trace_id             |          span_start           |           span_end            |     span_type     |                      span_operation
<span><span>--</span>--------------------------------+-------------------------------+-------------------------------+-------------------+-----------------------------------------------------------</span>
 <span>00000000000000000000000000000005</span> | <span>2024</span><span>-</span><span>07</span><span>-</span><span>05</span> <span>14</span>:<span>24</span>:<span>55</span>.<span>305234</span><span>+</span><span>00</span> | <span>2024</span><span>-</span><span>07</span><span>-</span><span>05</span> <span>14</span>:<span>24</span>:<span>55</span>.<span>305988</span><span>+</span><span>00</span> | <span>Update</span> query      | <span>UPDATE</span> pgbench_accounts <span>SET</span> abalance<span>=</span>$<span>1</span> <span>where</span> aid<span>=</span>$<span>2</span>;
 <span>00000000000000000000000000000005</span> | <span>2024</span><span>-</span><span>07</span><span>-</span><span>05</span> <span>14</span>:<span>24</span>:<span>55</span>.<span>305266</span><span>+</span><span>00</span> | <span>2024</span><span>-</span><span>07</span><span>-</span><span>05</span> <span>14</span>:<span>24</span>:<span>55</span>.<span>30552</span><span>+</span><span>00</span>  | Planner           | Planner
 <span>00000000000000000000000000000005</span> | <span>2024</span><span>-</span><span>07</span><span>-</span><span>05</span> <span>14</span>:<span>24</span>:<span>55</span>.<span>305586</span><span>+</span><span>00</span> | <span>2024</span><span>-</span><span>07</span><span>-</span><span>05</span> <span>14</span>:<span>24</span>:<span>55</span>.<span>305906</span><span>+</span><span>00</span> | ExecutorRun       | ExecutorRun
 <span>00000000000000000000000000000005</span> | <span>2024</span><span>-</span><span>07</span><span>-</span><span>05</span> <span>14</span>:<span>24</span>:<span>55</span>.<span>305591</span><span>+</span><span>00</span> | <span>2024</span><span>-</span><span>07</span><span>-</span><span>05</span> <span>14</span>:<span>24</span>:<span>55</span>.<span>305903</span><span>+</span><span>00</span> | <span>Update</span>            | <span>Update</span> <span>on</span> pgbench_accounts
 <span>00000000000000000000000000000005</span> | <span>2024</span><span>-</span><span>07</span><span>-</span><span>05</span> <span>14</span>:<span>24</span>:<span>55</span>.<span>305593</span><span>+</span><span>00</span> | <span>2024</span><span>-</span><span>07</span><span>-</span><span>05</span> <span>14</span>:<span>24</span>:<span>55</span>.<span>305806</span><span>+</span><span>00</span> | IndexScan         | IndexScan using pgbench_accounts_pkey <span>on</span> pgbench_accounts
 <span>00000000000000000000000000000005</span> | <span>2024</span><span>-</span><span>07</span><span>-</span><span>05</span> <span>14</span>:<span>24</span>:<span>55</span>.<span>649757</span><span>+</span><span>00</span> | <span>2024</span><span>-</span><span>07</span><span>-</span><span>05</span> <span>14</span>:<span>24</span>:<span>55</span>.<span>649792</span><span>+</span><span>00</span> | Utility query     | <span>COMMIT</span>;
 <span>00000000000000000000000000000005</span> | <span>2024</span><span>-</span><span>07</span><span>-</span><span>05</span> <span>14</span>:<span>24</span>:<span>55</span>.<span>649787</span><span>+</span><span>00</span> | <span>2024</span><span>-</span><span>07</span><span>-</span><span>05</span> <span>14</span>:<span>24</span>:<span>55</span>.<span>649792</span><span>+</span><span>00</span> | ProcessUtility    | ProcessUtility
 <span>00000000000000000000000000000005</span> | <span>2024</span><span>-</span><span>07</span><span>-</span><span>05</span> <span>14</span>:<span>24</span>:<span>55</span>.<span>649816</span><span>+</span><span>00</span> | <span>2024</span><span>-</span><span>07</span><span>-</span><span>05</span> <span>14</span>:<span>24</span>:<span>55</span>.<span>650613</span><span>+</span><span>00</span> | TransactionCommit | TransactionCommit</pre></div>

<p dir="auto">Queries can also be sampled randomly through the <code>pg_tracing.sample_rate</code> parameter. Setting this to 1 will trace all queries.</p>
<div dir="auto" data-snippet-clipboard-copy-content="-- Enable tracing for all queries
SET pg_tracing.sample_rate = 1.0;

-- Execute a query that will be traced
SELECT 1;

-- Check generated spans
select trace_id, parent_id, span_id, span_start, span_end, span_type, span_operation from pg_tracing_consume_spans order by span_start;
             trace_id             |    parent_id     |     span_id      |          span_start           |           span_end            |  span_type   | span_operation
----------------------------------+------------------+------------------+-------------------------------+-------------------------------+--------------+----------------
 458fbefd7034e670eb3d9c930862c378 | eb3d9c930862c378 | bdecb6e35d429f3d | 2024-01-10 09:54:16.321253+00 | 2024-01-10 09:54:16.321587+00 | Select query | SELECT $1;
 458fbefd7034e670eb3d9c930862c378 | bdecb6e35d429f3d | ad49f27543b0175d | 2024-01-10 09:54:16.3213+00   | 2024-01-10 09:54:16.321412+00 | Planner      | Planner
 458fbefd7034e670eb3d9c930862c378 | bdecb6e35d429f3d | 8805f7749249536b | 2024-01-10 09:54:16.321485+00 | 2024-01-10 09:54:16.321529+00 | Executor     | ExecutorRun"><pre><span><span>--</span> Enable tracing for all queries</span>
<span>SET</span> <span>pg_tracing</span>.<span>sample_rate</span> <span>=</span> <span>1</span>.<span>0</span>;

<span><span>--</span> Execute a query that will be traced</span>
<span>SELECT</span> <span>1</span>;

<span><span>--</span> Check generated spans</span>
<span>select</span> trace_id, parent_id, span_id, span_start, span_end, span_type, span_operation <span>from</span> pg_tracing_consume_spans <span>order by</span> span_start;
             trace_id             |    parent_id     |     span_id      |          span_start           |           span_end            |  span_type   | span_operation
<span><span>--</span>--------------------------------+------------------+------------------+-------------------------------+-------------------------------+--------------+----------------</span>
 458fbefd7034e670eb3d9c930862c378 | eb3d9c930862c378 | bdecb6e35d429f3d | <span>2024</span><span>-</span><span>01</span><span>-</span><span>10</span> <span>09</span>:<span>54</span>:<span>16</span>.<span>321253</span><span>+</span><span>00</span> | <span>2024</span><span>-</span><span>01</span><span>-</span><span>10</span> <span>09</span>:<span>54</span>:<span>16</span>.<span>321587</span><span>+</span><span>00</span> | <span>Select</span> query | <span>SELECT</span> $<span>1</span>;
 458fbefd7034e670eb3d9c930862c378 | bdecb6e35d429f3d | ad49f27543b0175d | <span>2024</span><span>-</span><span>01</span><span>-</span><span>10</span> <span>09</span>:<span>54</span>:<span>16</span>.<span>3213</span><span>+</span><span>00</span>   | <span>2024</span><span>-</span><span>01</span><span>-</span><span>10</span> <span>09</span>:<span>54</span>:<span>16</span>.<span>321412</span><span>+</span><span>00</span> | Planner      | Planner
 458fbefd7034e670eb3d9c930862c378 | bdecb6e35d429f3d | 8805f7749249536b | <span>2024</span><span>-</span><span>01</span><span>-</span><span>10</span> <span>09</span>:<span>54</span>:<span>16</span>.<span>321485</span><span>+</span><span>00</span> | <span>2024</span><span>-</span><span>01</span><span>-</span><span>10</span> <span>09</span>:<span>54</span>:<span>16</span>.<span>321529</span><span>+</span><span>00</span> | Executor     | ExecutorRun</pre></div>

<p dir="auto">Spans can be automatically sent to an otel collector by setting the <code>pg_tracing.otel_endpoint</code> parameter:</p>
<div data-snippet-clipboard-copy-content="# postgresql.conf
pg_tracing.otel_endpoint = http://127.0.0.1:4318/v1/traces
pg_tracing.otel_naptime = 2000"><pre><code># postgresql.conf
pg_tracing.otel_endpoint = http://127.0.0.1:4318/v1/traces
pg_tracing.otel_naptime = 2000
</code></pre></div>
<p dir="auto">If an otel endpoint is defined, a background worker will be started and will send spans every $naptime using the OTLP HTTP/JSON protocol.
The endpoint can be changed while the server is running, but if it was not set when the server was started, changing it to non-empty value
requires a restart.</p>
</article></div></div>
  </body>
</html>
