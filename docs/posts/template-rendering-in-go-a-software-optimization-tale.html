<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://the.scapegoat.dev/template-rendering-in-go-a-software-optimization-tale/">Original</a>
    <h1>Template rendering in Go: a software optimization tale</h1>
    
    <div id="readability-page-1" class="page"><div>
<p><img alt="C9C988CD-500E-4622-8F90-82BEDA954FD8" src="https://user-images.githubusercontent.com/128441/235454411-498c3f66-778a-4299-abd7-92d07ae1fd19.png"/></p>
<h2 id="introduction">Introduction</h2>
<p>I have been building out the web functionality of <a href="https://github.com/go-go-golems/sqleton">sqleton</a>
this week. Sqleton is an application that allows you to define CLI commands in a <a href="https://github.com/go-go-golems/sqleton/blob/main/cmd/sqleton/queries/wp/ls-posts.yaml">YAML file</a>
to render a SQL template and fire it off against a database.</p>
<p>It is now possible to <a href="https://github.com/go-go-golems/sqleton/blob/main/cmd/sqleton/cmds/serve.go">serve these commands</a> as little webpages:
the CLI flags are rendered as a HTML form, and the resulting structured data (which is served 
by the <a href="https://github.com/go-go-golems/glazed">glazed</a> library) is rendered as a HTML table.
To render this form, I of course use a go template, as go templating is a central concept used in 
the <a href="https://github.com/go-go-golems">go-go-golems ecosystem</a>. 
You can find the template <a href="https://github.com/go-go-golems/sqleton/blob/main/cmd/sqleton/cmds/templates/data-tables.tmpl.html">here</a>.</p>
<p>A first version simply used the <a href="https://github.com/jedib0t/go-pretty">go-pretty</a> library to render the table as HTML,
passing it off as a string to the template. This was all fine and good until I rendered a table with 300000 rows,
which would lead chrome (or any browser for that matter) to crash. Seeing how I am using the <a href="https://datatables.net/">jquery datatables library</a>
to render the table, I figured I could just render the data as JSON and embed it into the javascript of the HTML template to
avoid having the DOM renderer crash. I want to avoid AJAX API calls for now, as it would require decoupling rendering from the actual database query.</p>
<p>This worked quite well on the browser side (leaving aside the elegance of rendering 300k rows of JSON into a <code>script</code> tag)!</p>
<p>&#34;Off we go!&#34; I thought, and deployed the application to a <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definition_parameters.html#task_size">256 vCPU and 512 MB memory task</a> on <a href="https://aws.amazon.com/ecs/">AWS ECS</a>.
Unsurprisingly (in hindsight), that container did not fare very well under load, getting killed because it exceeded its memory limit as soon as someone removed the pagination limit.</p>
<p>This article tells the story of optimizing the memory consumption of that template rendering and recounts some of the
tricks I&#39;ve learned over the years to make go programs (or any kind of programs, for that matter) run with constrained
memory.</p>
<p>The entire sourcecode of the toy example can be found at <a href="https://github.com/wesen/go-template-streaming">github.com/wesen/go-template-streaming</a>.</p>
<h2 id="premature-optimization-is-the-source-of-all-great-optimizations">Premature optimization is the source of all great optimizations</h2>
<p>Forgive me the clickbait subtitle, but I do think there is a lot of value in thinking about performance early
on in the development process. <strong>Thinking is cheap! And who doesn&#39;t like cheap things?</strong></p>
<p>The conventional wisdom starts with the often stated maxim that you should get your program to work first, and optimize it later,
because optimization is expensive, slows down the development process, leads to convoluted code, is often unnecessary, and most importantly,
is evil (who doesn&#39;t like a strongly worded value judgment here and there?). Conventional wisdom instead prescribes getting a
version (any version?) of your program to run first and then using a combination
of profiling and benchmarking to find the bottlenecks, optimizing these bottlenecks away, repeating the process
and patting yourself on the back for having been so Good (not Evil).</p>
<p>This is exactly how we are going to start, before taking a step back to actually prematurely optimize, and see where this gets us.</p>
<h2 id="our-toy-example-rendering-a-database-table-as-markdown">Our toy example: rendering a database table as markdown</h2>
<p>In this toy example, created specially for this article, we are going to render 1M rows of user data into a markdown table.</p>
<h3 id="creating-and-populating-the-database">Creating and populating the database</h3>
<p>First, we need to create and populate our database, which is done in <a href="https://github.com/wesen/go-template-streaming/blob/main/create.go">create.go</a>.</p>
<p>We use sqlite3 as an easy way to create our on disk database &#34;users.db&#34;. We then use a very elegant string-based batch
insert to insert 10000 users at once.</p>
<div><pre><span></span><span>package</span><span> </span><span>main</span>

<span>import</span><span> </span><span>(</span>
<span>    </span><span>&#34;database/sql&#34;</span>
<span>    </span><span>&#34;fmt&#34;</span>
<span>    </span><span>&#34;os&#34;</span>
<span>    </span><span>&#34;strings&#34;</span>

<span>    </span><span>_</span><span> </span><span>&#34;github.com/mattn/go-sqlite3&#34;</span>
<span>)</span>

<span>type</span><span> </span><span>User</span><span> </span><span>struct</span><span> </span><span>{</span>
<span>    </span><span>Email</span><span>     </span><span>string</span>
<span>    </span><span>FirstName</span><span> </span><span>string</span>
<span>    </span><span>LastName</span><span>  </span><span>string</span>
<span>    </span><span>Address</span><span>   </span><span>string</span>
<span>    </span><span>City</span><span>      </span><span>string</span>
<span>    </span><span>Zip</span><span>       </span><span>string</span>
<span>}</span>

<span>func</span><span> </span><span>createDb</span><span>(</span><span>totalUsers</span><span> </span><span>int</span><span>)</span><span> </span><span>error</span><span> </span><span>{</span>
<span>    </span><span>// delete users.db</span>
<span>    </span><span>if</span><span> </span><span>_</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>os</span><span>.</span><span>Stat</span><span>(</span><span>&#34;users.db&#34;</span><span>);</span><span> </span><span>err</span><span> </span><span>==</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    	</span><span>err</span><span> </span><span>:=</span><span> </span><span>os</span><span>.</span><span>Remove</span><span>(</span><span>&#34;users.db&#34;</span><span>)</span>
<span>    	</span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    		</span><span>return</span><span> </span><span>err</span>
<span>    	</span><span>}</span>
<span>    </span><span>}</span>

<span>    </span><span>db</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>sql</span><span>.</span><span>Open</span><span>(</span><span>&#34;sqlite3&#34;</span><span>,</span><span> </span><span>&#34;users.db&#34;</span><span>)</span>
<span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    	</span><span>return</span><span> </span><span>err</span>
<span>    </span><span>}</span>
<span>    </span><span>defer</span><span> </span><span>db</span><span>.</span><span>Close</span><span>()</span>

<span>    </span><span>createTableQuery</span><span> </span><span>:=</span><span> </span><span>`</span>
<span>    CREATE TABLE IF NOT EXISTS users (</span>
<span>    	id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span>    	email TEXT NOT NULL,</span>
<span>    	first_name TEXT NOT NULL,</span>
<span>    	last_name TEXT NOT NULL,</span>
<span>    	address TEXT NOT NULL,</span>
<span>    	city TEXT NOT NULL,</span>
<span>    	zip TEXT NOT NULL</span>
<span>    );</span>
<span>    `</span>
<span>    </span><span>_</span><span>,</span><span> </span><span>err</span><span> </span><span>=</span><span> </span><span>db</span><span>.</span><span>Exec</span><span>(</span><span>createTableQuery</span><span>)</span>
<span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    	</span><span>return</span><span> </span><span>err</span>
<span>    </span><span>}</span>

<span>    </span><span>insertUserQuery</span><span> </span><span>:=</span><span> </span><span>`</span>
<span>    INSERT INTO users (email, first_name, last_name, address, city, zip)</span>
<span>    VALUES %s</span>
<span>    `</span>

<span>    </span><span>usersPerBatch</span><span> </span><span>:=</span><span> </span><span>10000</span>
<span>    </span><span>rowsToInsert</span><span> </span><span>:=</span><span> </span><span>make</span><span>([]</span><span>string</span><span>,</span><span> </span><span>usersPerBatch</span><span>)</span>

<span>    </span><span>for</span><span> </span><span>i</span><span> </span><span>:=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>totalUsers</span><span>;</span><span> </span><span>i</span><span>++</span><span> </span><span>{</span>
<span>    	</span><span>user</span><span> </span><span>:=</span><span> </span><span>User</span><span>{</span>
<span>    		</span><span>Email</span><span>:</span><span>     </span><span>fmt</span><span>.</span><span>Sprintf</span><span>(</span><span>&#34;%s@example.com&#34;</span><span>,</span><span> </span><span>randomString</span><span>(</span><span>10</span><span>)),</span>
<span>    		</span><span>FirstName</span><span>:</span><span> </span><span>randomString</span><span>(</span><span>5</span><span>),</span>
<span>    		</span><span>LastName</span><span>:</span><span>  </span><span>randomString</span><span>(</span><span>7</span><span>),</span>
<span>    		</span><span>Address</span><span>:</span><span>   </span><span>fmt</span><span>.</span><span>Sprintf</span><span>(</span><span>&#34;%s %s&#34;</span><span>,</span><span> </span><span>randomString</span><span>(</span><span>5</span><span>),</span><span> </span><span>randomString</span><span>(</span><span>10</span><span>)),</span>
<span>    		</span><span>City</span><span>:</span><span>      </span><span>randomString</span><span>(</span><span>6</span><span>),</span>
<span>    		</span><span>Zip</span><span>:</span><span>       </span><span>randomString</span><span>(</span><span>5</span><span>),</span>
<span>    	</span><span>}</span>

<span>    	</span><span>rowsToInsert</span><span>[</span><span>i</span><span>%</span><span>usersPerBatch</span><span>]</span><span> </span><span>=</span><span> </span><span>fmt</span><span>.</span><span>Sprintf</span><span>(</span><span>&#34;(&#39;%s&#39;, &#39;%s&#39;, &#39;%s&#39;, &#39;%s&#39;, &#39;%s&#39;, &#39;%s&#39;)&#34;</span><span>,</span><span> </span><span>user</span><span>.</span><span>Email</span><span>,</span><span> </span><span>user</span><span>.</span><span>FirstName</span><span>,</span><span> </span><span>user</span><span>.</span><span>LastName</span><span>,</span><span> </span><span>user</span><span>.</span><span>Address</span><span>,</span><span> </span><span>user</span><span>.</span><span>City</span><span>,</span><span> </span><span>user</span><span>.</span><span>Zip</span><span>)</span>

<span>    	</span><span>if</span><span> </span><span>i</span><span>%</span><span>usersPerBatch</span><span> </span><span>==</span><span> </span><span>0</span><span> </span><span>{</span>
<span>    		</span><span>_</span><span>,</span><span> </span><span>err</span><span> </span><span>=</span><span> </span><span>db</span><span>.</span><span>Exec</span><span>(</span><span>fmt</span><span>.</span><span>Sprintf</span><span>(</span><span>insertUserQuery</span><span>,</span><span> </span><span>strings</span><span>.</span><span>Join</span><span>(</span><span>rowsToInsert</span><span>,</span><span> </span><span>&#34;,&#34;</span><span>)))</span>
<span>    		</span><span>fmt</span><span>.</span><span>Printf</span><span>(</span><span>&#34;Inserted %d/%d users\n&#34;</span><span>,</span><span> </span><span>i</span><span>,</span><span> </span><span>totalUsers</span><span>)</span>
<span>    	</span><span>}</span>
<span>    </span><span>}</span>

<span>    </span><span>fmt</span><span>.</span><span>Printf</span><span>(</span><span>&#34;Successfully inserted %d random users into the database.\n&#34;</span><span>,</span><span> </span><span>totalUsers</span><span>)</span>
<span>    </span><span>return</span><span> </span><span>nil</span>
<span>}</span>
</pre></div>

<p>You can run this program by running <code>go run . create</code>, which will takes its sweet time, but this is not the part we want
to optimize (at least not prematurely).</p>
<div><pre><span></span><span>go</span><span>-</span><span>template</span><span>-</span><span>streaming</span><span> </span><span>on</span><span> </span><span>ÓÇ†</span><span> </span><span>main</span><span> </span><span>via</span><span> </span><span>üêπ</span><span> </span><span>v1</span><span>.20.3</span><span> </span>
<span>‚ùØ</span><span> </span><span>go</span><span> </span><span>run</span><span> </span><span>.</span><span> </span><span>create</span>
<span>Inserted</span><span> </span><span>0</span><span>/</span><span>1000000</span><span> </span><span>users</span>
<span>Inserted</span><span> </span><span>10000</span><span>/</span><span>1000000</span><span> </span><span>users</span>
<span>Inserted</span><span> </span><span>20000</span><span>/</span><span>1000000</span><span> </span><span>users</span>
<span>Inserted</span><span> </span><span>30000</span><span>/</span><span>1000000</span><span> </span><span>users</span>
<span>...</span>
<span>Inserted</span><span> </span><span>990000</span><span>/</span><span>1000000</span><span> </span><span>users</span>
<span>Successfully</span><span> </span><span>inserted</span><span> </span><span>1000000</span><span> </span><span>random</span><span> </span><span>users</span><span> </span><span>into</span><span> </span><span>the</span><span> </span><span>database</span><span>.</span>

<span>go</span><span>-</span><span>template</span><span>-</span><span>streaming</span><span> </span><span>on</span><span> </span><span>ÓÇ†</span><span> </span><span>main</span><span> </span><span>via</span><span> </span><span>üêπ</span><span> </span><span>v1</span><span>.20.3</span><span> </span><span>took</span><span> </span><span>1</span><span>m7s</span><span> </span>
<span>‚ùØ</span><span> </span><span>ls</span><span> </span><span>-</span><span>lah</span><span> </span><span>users</span><span>.</span><span>db</span>
<span>-</span><span>rw</span><span>-</span><span>r</span><span>--r-- 1 manuel manuel 72M Apr 30 18:40 users.db</span>
</pre></div>

<p>Once this has finished running, we end up with a 72 MB database file.</p>
<h3 id="rendering-the-database-as-markdown-naively-but-not-evil">Rendering the database as markdown (naively, but not evil)</h3>
<p>Our first attempt at rendering will be quite simple:</p>
<ul>
<li>we read the table into memory, as an array of <code>User</code> structs</li>
<li>we pass this array to a template, which renders the markdown table by using a <code>range</code> construct.</li>
</ul>
<p>First, the <a href="https://github.com/wesen/go-template-streaming/blob/main/naive.go#L13">template</a>:</p>
<div><pre><span></span><span>const</span><span> </span><span>markdownTemplate</span><span> </span><span>=</span><span> </span><span>`</span>
<span>|</span><span> </span><span>Email</span><span> </span><span>|</span><span> </span><span>First</span><span> </span><span>Name</span><span> </span><span>|</span><span> </span><span>Last</span><span> </span><span>Name</span><span> </span><span>|</span><span> </span><span>Address</span><span> </span><span>|</span><span> </span><span>City</span><span> </span><span>|</span><span> </span><span>Zip</span><span> </span><span>|</span>
<span>|-------|------------|-----------|---------|------|-----|</span>
<span>{{</span><span>range</span><span> </span><span>.}}</span>
<span>|</span><span> </span><span>{{.</span><span>Email</span><span>}}</span><span> </span><span>|</span><span> </span><span>{{.</span><span>FirstName</span><span>}}</span><span> </span><span>|</span><span> </span><span>{{.</span><span>LastName</span><span>}}</span><span> </span><span>|</span><span> </span><span>{{.</span><span>Address</span><span>}}</span><span> </span><span>|</span><span> </span><span>{{.</span><span>City</span><span>}}</span><span> </span><span>|</span><span> </span><span>{{.</span><span>Zip</span><span>}}</span><span> </span><span>|</span><span>{{</span><span>end</span><span>}}</span>
</pre></div>

<p>Second, the rendering code, which does nothing very special at all:</p>
<ul>
<li>open the users.db file</li>
<li>query the users table</li>
<li>iterate over the rows, reading in the value into a <code>User</code> struct and appending it to a list</li>
<li>rendering the template to stdout by passing the list of users to it</li>
</ul>
<div><pre><span></span><span>func</span><span> </span><span>generateMarkdown</span><span>()</span><span> </span><span>error</span><span> </span><span>{</span>
<span>    </span><span>db</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>sql</span><span>.</span><span>Open</span><span>(</span><span>&#34;sqlite3&#34;</span><span>,</span><span> </span><span>&#34;users.db&#34;</span><span>)</span>
<span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    	</span><span>return</span><span> </span><span>err</span>
<span>    </span><span>}</span>
<span>    </span><span>defer</span><span> </span><span>db</span><span>.</span><span>Close</span><span>()</span>

<span>    </span><span>rows</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>db</span><span>.</span><span>Query</span><span>(</span><span>`SELECT email, first_name, last_name, address, city, zip FROM users`</span><span>)</span>
<span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    	</span><span>return</span><span> </span><span>err</span>
<span>    </span><span>}</span>
<span>    </span><span>defer</span><span> </span><span>rows</span><span>.</span><span>Close</span><span>()</span>

<span>    </span><span>totalSize</span><span> </span><span>:=</span><span> </span><span>0</span>
<span>    </span><span>var</span><span> </span><span>users</span><span> </span><span>[]</span><span>User</span>
<span>    </span><span>for</span><span> </span><span>rows</span><span>.</span><span>Next</span><span>()</span><span> </span><span>{</span>
<span>    	</span><span>var</span><span> </span><span>user</span><span> </span><span>User</span>
<span>    	</span><span>if</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>rows</span><span>.</span><span>Scan</span><span>(</span><span>&amp;</span><span>user</span><span>.</span><span>Email</span><span>,</span><span> </span><span>&amp;</span><span>user</span><span>.</span><span>FirstName</span><span>,</span><span> </span><span>&amp;</span><span>user</span><span>.</span><span>LastName</span><span>,</span><span> </span><span>&amp;</span><span>user</span><span>.</span><span>Address</span><span>,</span><span> </span><span>&amp;</span><span>user</span><span>.</span><span>City</span><span>,</span><span> </span><span>&amp;</span><span>user</span><span>.</span><span>Zip</span><span>);</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    		</span><span>return</span><span> </span><span>err</span>
<span>    	</span><span>}</span>
<span>    	</span><span>totalSize</span><span> </span><span>+=</span><span> </span><span>int</span><span>(</span><span>unsafe</span><span>.</span><span>Sizeof</span><span>(</span><span>user</span><span>))</span>
<span>    	</span><span>users</span><span> </span><span>=</span><span> </span><span>append</span><span>(</span><span>users</span><span>,</span><span> </span><span>user</span><span>)</span>
<span>    </span><span>}</span>

<span>    </span><span>totalSize</span><span> </span><span>+=</span><span> </span><span>int</span><span>(</span><span>unsafe</span><span>.</span><span>Sizeof</span><span>(</span><span>users</span><span>))</span>
<span>    </span><span>log</span><span>.</span><span>Printf</span><span>(</span><span>&#34;Size of users: %d bytes\n&#34;</span><span>,</span><span> </span><span>totalSize</span><span>)</span>

<span>    </span><span>tmpl</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>template</span><span>.</span><span>New</span><span>(</span><span>&#34;markdown&#34;</span><span>).</span><span>Parse</span><span>(</span><span>markdownTemplate</span><span>)</span>
<span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    	</span><span>return</span><span> </span><span>err</span>
<span>    </span><span>}</span>

<span>    </span><span>err</span><span> </span><span>=</span><span> </span><span>tmpl</span><span>.</span><span>Execute</span><span>(</span><span>os</span><span>.</span><span>Stdout</span><span>,</span><span> </span><span>users</span><span>)</span>
<span>    </span><span>log</span><span>.</span><span>Println</span><span>(</span><span>&#34;Successfully generated markdown table.&#34;</span><span>)</span>

<span>    </span><span>err</span><span> </span><span>=</span><span> </span><span>writeProfile</span><span>(</span><span>&#34;mem.prof&#34;</span><span>)</span>
<span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    	</span><span>return</span><span> </span><span>err</span>
<span>    </span><span>}</span>

<span>    </span><span>return</span><span> </span><span>nil</span>
<span>}</span>
</pre></div>

<p>We were already very clever to stream the template straight to os.Stdout (does this count as premature optimization?),
but it is clear from the structure of the code (accumulating all rows into an array)
that we are going to use O(n) memory here.</p>
<p>We can run this program by running <code>go run . generate</code>:</p>
<div><pre><span></span>| Email | First Name | Last Name | Address | City | Zip |
|-------|------------|-----------|---------|------|-----|

| 6M5G0xdYtS@example.com | p1keu | O8Y37ew | M5nv8 cTs4DixwIM | hZMpGx | LuIYM |
| tVBZMyaC3g@example.com | Ux7N8 | sm6iRYU | HzbHn fV09wPxRug | 9d6j8x | mnXKt |
| KX5UV0eeR5@example.com | jT1D7 | gCvyC00 | syrw0 Yqb9lgQcL7 | 3ueWIF | QEyfV |
| 0m4lcQ16ut@example.com | QBkyA | 2awv7pN | rvXJk BxX5aJQvoF | lRZsHG | U4ihz |
| 1QSdZLNAmN@example.com | T1CCd | Bnk9LiG | 1wY7l 2U20Jfsxle | mfnac7 | RZA79 |
| vCaw5qrJZv@example.com | 3x6Hn | lKFgPZj | ktV3T 7EEdBgPFp8 | 5hXjB6 | tFzor |
| 6e6ImBw6qk@example.com | qCuIL | hssRqXq | qYrQ3 hKQUcsRULm | 2MxUqL | 42JK7 |
...
</pre></div>

<h3 id="profiling-our-naive-solution">Profiling our naive solution</h3>
<p>In order to measure the memory consumption, we are going to apply two strategies.
First, we call the function <a href="https://github.com/wesen/go-template-streaming/blob/main/utils.go#L48">writeProfile</a>
which generates a <a href="https://go.dev/blog/pprof">pprof file</a> that can be analyzed with <code>go tool</code>. We use <code>pprof.WriteHeapProfile</code>
which gives us an account of how much memory each function in our program has allocated.</p>
<div><pre><span></span><span>func</span><span> </span><span>writeProfile</span><span>(</span><span>filepath</span><span> </span><span>string</span><span>)</span><span> </span><span>error</span><span> </span><span>{</span>
<span>    </span><span>// write mem profile</span>
<span>    </span><span>f</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>os</span><span>.</span><span>Create</span><span>(</span><span>filepath</span><span>)</span>
<span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    	</span><span>return</span><span> </span><span>err</span>
<span>    </span><span>}</span>
<span>    </span><span>defer</span><span> </span><span>f</span><span>.</span><span>Close</span><span>()</span>

<span>    </span><span>err</span><span> </span><span>=</span><span> </span><span>pprof</span><span>.</span><span>WriteHeapProfile</span><span>(</span><span>f</span><span>)</span>
<span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    	</span><span>return</span><span> </span><span>err</span>
<span>    </span><span>}</span>

<span>    </span><span>log</span><span>.</span><span>Printf</span><span>(</span><span>`</span>
<span>    To view the memory profile, run the following command:</span>
<span>    go tool pprof %s</span>
<span>    go tool pprof -alloc_space %s</span>
<span>`</span><span>,</span><span> </span><span>filepath</span><span>,</span><span> </span><span>filepath</span><span>)</span>
<span>    </span><span>return</span><span> </span><span>nil</span>
<span>}</span>
</pre></div>

<h3 id="pprof-educational-interlude">pprof educational interlude</h3>
<p><code>pprof</code> is the name of go profiling subsystem. It can be used to collect information about CPU usage, memory allocation,
thread creation and lock contention. The subsystem collects its profiling data by sampling (periodically collecting)
the information it needs. The <a href="https://pkg.go.dev/runtime/pprof#Profile">pprof documentation</a>,
which gives more details: it can collect stack traces of running goroutines, memory allocation of live objects,
past allocations, thread creations, etc...</p>
<p>The information that interests us is the Heap profile:</p>
<blockquote>
<p>The heap profile reports statistics as of the most recently completed garbage collection; it elides more recent allocation to avoid skewing the profile away from live data and toward garbage. If there has been no garbage collection at all, the heap profile reports all known allocations. This exception helps mainly in programs running without garbage collection enabled, usually for debugging purposes.</p>
</blockquote>
<blockquote>
<p>The heap profile tracks both the allocation sites for all live objects in the application memory and for all objects allocated since the program start. Pprof&#39;s -inuse_space, -inuse_objects, -alloc_space, and -alloc_objects flags select which to display, defaulting to -inuse_space (live objects, scaled by size).</p>
</blockquote>
<p>While the <code>pprof</code> package can make its sampling data accessible on <a href="https://pkg.go.dev/net/http/pprof">request over HTTP</a>,
we just write it out to disk at the end of our program. While CPU profiling needs to be explicitly enabled, 
heap profiling is always on: it is triggered to run every <code>MemProfileRate</code>
bytes, which is defaulting to every 512 kB. The <code>MemProfileRate</code> value can be configured at runtime or by setting the 
<a href="https://pkg.go.dev/runtime@master">GODEBUG</a> environment variable to <code>memprofilerate=XX</code>.</p>
<h3 id="looking-at-the-heap-profile-of-our-naive-template-render">Looking at the heap profile of our naive template render</h3>
<p>As told by our program once it finishes running, we execute <code>go tool pprof -alloc_space mem.prof</code> command 
(<code>alloc_space</code> tracks the number of bytes allocated since program start), and then use <code>top</code> to see the top memory consumers:</p>
<div><pre><span></span><span>go</span><span>-</span><span>template</span><span>-</span><span>streaming</span><span> </span><span>on</span><span> </span><span>ÓÇ†</span><span> </span><span>main</span><span> </span><span>via</span><span> </span><span>üêπ</span><span> </span><span>v1</span><span>.</span><span>20.3</span><span> </span>
<span>‚ùØ</span><span> </span><span>go</span><span> </span><span>tool</span><span> </span><span>pprof</span><span> </span><span>-</span><span>alloc_space</span><span> </span><span>mem</span><span>.</span><span>prof</span>
<span>File</span><span>:</span><span> </span><span>go</span><span>-</span><span>template</span><span>-</span><span>streaming</span>
<span>Build</span><span> </span><span>ID</span><span>:</span><span> </span><span>8</span><span>b897351543dfccf4446628bf449e314479a4929</span>
<span>Type</span><span>:</span><span> </span><span>alloc_space</span>
<span>Time</span><span>:</span><span> </span><span>Apr</span><span> </span><span>30</span><span>,</span><span> </span><span>2023</span><span> </span><span>at</span><span> </span><span>6</span><span>:</span><span>48</span><span>pm</span><span> </span><span>(</span><span>EDT</span><span>)</span>
<span>Entering</span><span> </span><span>interactive</span><span> </span><span>mode</span><span> </span><span>(</span><span>type</span><span> </span><span>&#34;help&#34;</span><span> </span><span>for</span><span> </span><span>commands</span><span>,</span><span> </span><span>&#34;o&#34;</span><span> </span><span>for</span><span> </span><span>options</span><span>)</span>
<span>(</span><span>pprof</span><span>)</span><span> </span><span>top</span>
<span>Showing</span><span> </span><span>nodes</span><span> </span><span>accounting</span><span> </span><span>for</span><span> </span><span>843.12</span><span>MB</span><span>,</span><span> </span><span>99.94</span><span>%</span><span> </span><span>of</span><span> </span><span>843.65</span><span>MB</span><span> </span><span>total</span>
<span>Dropped</span><span> </span><span>9</span><span> </span><span>nodes</span><span> </span><span>(</span><span>cum</span><span> </span><span>&lt;=</span><span> </span><span>4.22</span><span>MB</span><span>)</span>
<span>Showing</span><span> </span><span>top</span><span> </span><span>10</span><span> </span><span>nodes</span><span> </span><span>out</span><span> </span><span>of</span><span> </span><span>18</span>
<span>      </span><span>flat</span><span>  </span><span>flat</span><span>%</span><span>   </span><span>sum</span><span>%</span><span>        </span><span>cum</span><span>   </span><span>cum</span><span>%</span>
<span>  </span><span>590.11</span><span>MB</span><span> </span><span>69.95</span><span>%</span><span> </span><span>69.95</span><span>%</span><span>   </span><span>843.12</span><span>MB</span><span> </span><span>99.94</span><span>%</span><span>  </span><span>main</span><span>.</span><span>generateMarkdown</span>
<span>   </span><span>78.50</span><span>MB</span><span>  </span><span>9.30</span><span>%</span><span> </span><span>79.25</span><span>%</span><span>      </span><span>253</span><span>MB</span><span> </span><span>29.99</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>(</span><span>*</span><span>SQLiteRows</span><span>)</span><span>.</span><span>nextSyncLocked</span>
<span>   </span><span>60.50</span><span>MB</span><span>  </span><span>7.17</span><span>%</span><span> </span><span>86.42</span><span>%</span><span>    </span><span>60.50</span><span>MB</span><span>  </span><span>7.17</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>_Cfunc_GoStringN</span><span> </span><span>(</span><span>inline</span><span>)</span>
<span>   </span><span>41.50</span><span>MB</span><span>  </span><span>4.92</span><span>%</span><span> </span><span>91.34</span><span>%</span><span>    </span><span>41.50</span><span>MB</span><span>  </span><span>4.92</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>(</span><span>*</span><span>SQLiteRows</span><span>)</span><span>.</span><span>nextSyncLocked</span><span>.</span><span>func10</span>
<span>   </span><span>33.50</span><span>MB</span><span>  </span><span>3.97</span><span>%</span><span> </span><span>95.31</span><span>%</span><span>    </span><span>33.50</span><span>MB</span><span>  </span><span>3.97</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>(</span><span>*</span><span>SQLiteRows</span><span>)</span><span>.</span><span>nextSyncLocked</span><span>.</span><span>func3</span>
<span>   </span><span>33.50</span><span>MB</span><span>  </span><span>3.97</span><span>%</span><span> </span><span>99.29</span><span>%</span><span>    </span><span>33.50</span><span>MB</span><span>  </span><span>3.97</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>(</span><span>*</span><span>SQLiteRows</span><span>)</span><span>.</span><span>nextSyncLocked</span><span>.</span><span>func9</span>
<span>    </span><span>5.50</span><span>MB</span><span>  </span><span>0.65</span><span>%</span><span> </span><span>99.94</span><span>%</span><span>     </span><span>5.50</span><span>MB</span><span>  </span><span>0.65</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>(</span><span>*</span><span>SQLiteRows</span><span>)</span><span>.</span><span>nextSyncLocked</span><span>.</span><span>func1</span>
<span>         </span><span>0</span><span>     </span><span>0</span><span>%</span><span> </span><span>99.94</span><span>%</span><span>      </span><span>253</span><span>MB</span><span> </span><span>29.99</span><span>%</span><span>  </span><span>database</span><span>/</span><span>sql</span><span>.</span><span>(</span><span>*</span><span>Rows</span><span>)</span><span>.</span><span>Next</span>
<span>         </span><span>0</span><span>     </span><span>0</span><span>%</span><span> </span><span>99.94</span><span>%</span><span>      </span><span>253</span><span>MB</span><span> </span><span>29.99</span><span>%</span><span>  </span><span>database</span><span>/</span><span>sql</span><span>.</span><span>(</span><span>*</span><span>Rows</span><span>)</span><span>.</span><span>Next</span><span>.</span><span>func1</span>
<span>         </span><span>0</span><span>     </span><span>0</span><span>%</span><span> </span><span>99.94</span><span>%</span><span>      </span><span>253</span><span>MB</span><span> </span><span>29.99</span><span>%</span><span>  </span><span>database</span><span>/</span><span>sql</span><span>.</span><span>(</span><span>*</span><span>Rows</span><span>)</span><span>.</span><span>nextLocked</span>
<span>(</span><span>pprof</span><span>)</span><span> </span><span>%</span>
</pre></div>

<p>This tells us that the <code>generateMarkdown</code> function allocated 590 MB of memory on its own, and that it cumulatively (meaning, 
including the memory allocated by the functions it called) allocated 843 MB of memory. The next culprit is
<code>nextSyncLocked</code> which allocated 78.5 MB of memory. These values represent the amount of memory allocated over the duration
of the program‚Äîthey don&#39;t imply that the program was using 843 MB of memory at any given time.</p>
<h3 id="measuring-the-max-heap-size">Measuring the max heap size</h3>
<p>In order to measure the maximum size of the heap, we can use the function <code>runtime.ReadMemStats</code> which gives us the <code>HeapAlloc</code>
variable. In order to measure the maximum amount reached over the entire duration, we use a little goroutine polling the 
<code>HeapAlloc</code> and keeping its high watermark:</p>
<div><pre><span></span><span>func</span><span> </span><span>monitorHeapSize</span><span>(</span><span>ctx</span><span> </span><span>context</span><span>.</span><span>Context</span><span>,</span><span> </span><span>withTriggerGC</span><span> </span><span>bool</span><span>)</span><span> </span><span>{</span>
<span>var</span><span> </span><span>mem</span><span> </span><span>runtime</span><span>.</span><span>MemStats</span>

<span>    </span><span>maxAlloc</span><span> </span><span>:=</span><span> </span><span>uint64</span><span>(</span><span>0</span><span>)</span>

<span>    </span><span>t</span><span> </span><span>:=</span><span> </span><span>time</span><span>.</span><span>NewTicker</span><span>(</span><span>200</span><span> </span><span>*</span><span> </span><span>time</span><span>.</span><span>Millisecond</span><span>)</span>
<span>    </span><span>for</span><span> </span><span>{</span>
<span>    	</span><span>select</span><span> </span><span>{</span>
<span>    	</span><span>case</span><span> </span><span>&lt;-</span><span>ctx</span><span>.</span><span>Done</span><span>():</span>
<span>    		</span><span>return</span>
<span>    	</span><span>case</span><span> </span><span>&lt;-</span><span>t</span><span>.</span><span>C</span><span>:</span>
<span>    		</span><span>// trigger gc</span>
<span>    		</span><span>if</span><span> </span><span>withTriggerGC</span><span> </span><span>{</span>
<span>    			</span><span>runtime</span><span>.</span><span>GC</span><span>()</span>
<span>    		</span><span>}</span>
<span>    		</span><span>runtime</span><span>.</span><span>ReadMemStats</span><span>(</span><span>&amp;</span><span>mem</span><span>)</span>
<span>    		</span><span>if</span><span> </span><span>mem</span><span>.</span><span>HeapAlloc</span><span> </span><span>&gt;</span><span> </span><span>maxAlloc</span><span> </span><span>{</span>
<span>    			</span><span>maxAlloc</span><span> </span><span>=</span><span> </span><span>mem</span><span>.</span><span>HeapAlloc</span>
<span>    			</span><span>memSize</span><span> </span><span>:=</span><span> </span><span>convertHumanReadable</span><span>(</span><span>maxAlloc</span><span>)</span>
<span>    			</span><span>fmt</span><span>.</span><span>Fprintf</span><span>(</span><span>os</span><span>.</span><span>Stderr</span><span>,</span><span> </span><span>&#34;MaxAlloc: %s\n&#34;</span><span>,</span><span> </span><span>memSize</span><span>)</span>
<span>    		</span><span>}</span>
<span>    	</span><span>}</span>
<span>    </span><span>}</span>
<span>}</span>
</pre></div>

<p>You&#39;ll note two things here:</p>
<ul>
<li>we use a 200 ms time interval, which is by no means perfect. We should be aware of potential aliasing issues here.</li>
<li>we pass in a flag to trigger <a href="https://publish.obsidian.md/manuel/Wiki/Programming/Garbage+Collection">garbage collection</a>.
  This is because the Go runtime is lazy about <a href="https://tip.golang.org/doc/gc-guide">garbage collection</a>,
  and we want to make sure we are measuring the maximum
  heap size, not the current heap size. Both values are important to know about. Churning through lots of temporary 
  allocations can be a source of performance issues, even if the maximum heap size is low.</li>
</ul>
<p>Running generate again, we can now see the maximum heap size reached, first without triggering the GC:</p>
<div><pre><span></span><span>‚ùØ</span><span> </span><span>go</span><span> </span><span>run</span><span> </span><span>.</span><span> </span><span>generate</span><span>  </span><span>&gt;</span><span> </span><span>/</span><span>dev</span><span>/</span><span>null</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>22.7</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>45.7</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>65.5</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>131.9</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>164.9</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>198.5</span><span> </span><span>MiB</span>
<span>2023</span><span>/</span><span>05</span><span>/</span><span>01</span><span> </span><span>07</span><span>:</span><span>34</span><span>:</span><span>47</span><span> </span><span>Size</span><span> </span><span>of</span><span> </span><span>users</span><span>:</span><span> </span><span>95040024</span><span> </span><span>bytes</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>232.6</span><span> </span><span>MiB</span>
<span>...</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>329.5</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>335.9</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>342.8</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>349.6</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>356.4</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>363.3</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>370.1</span><span> </span><span>MiB</span>
<span>2023</span><span>/</span><span>05</span><span>/</span><span>01</span><span> </span><span>07</span><span>:</span><span>34</span><span>:</span><span>51</span><span> </span><span>Successfully</span><span> </span><span>generated</span><span> </span><span>markdown</span><span> </span><span>table</span><span>.</span>
<span>2023</span><span>/</span><span>05</span><span>/</span><span>01</span><span> </span><span>07</span><span>:</span><span>34</span><span>:</span><span>51</span><span> </span><span>Time</span><span> </span><span>elapsed</span><span>:</span><span> </span><span>6.360070157</span><span>s</span>
</pre></div>

<p>And with triggering the GC every 200 ms. As you can see, with the GC triggering, the second half of the program
(streaming the template out to stdout) doesn&#39;t allocate any more memory than it did before. This makes sense,
because all the data needed to render the template is now contained in the Users array, and all allocations happening
would (hopefully!) be small allocations inside the rendering engine.</p>
<div><pre><span></span><span>‚ùØ</span><span> </span><span>go</span><span> </span><span>run</span><span> </span><span>.</span><span> </span><span>generate</span><span> </span><span>--</span><span>trigger</span><span>-</span><span>gc</span><span> </span><span>&gt;</span><span> </span><span>/</span><span>dev</span><span>/</span><span>null</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>18.6</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>42.0</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>64.9</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>81.2</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>99.7</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>108.9</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>134.0</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>160.6</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>169.5</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>202.0</span><span> </span><span>MiB</span>
<span>2023</span><span>/</span><span>05</span><span>/</span><span>01</span><span> </span><span>07</span><span>:</span><span>33</span><span>:</span><span>51</span><span> </span><span>Size</span><span> </span><span>of</span><span> </span><span>users</span><span>:</span><span> </span><span>95040024</span><span> </span><span>bytes</span>
<span>2023</span><span>/</span><span>05</span><span>/</span><span>01</span><span> </span><span>07</span><span>:</span><span>33</span><span>:</span><span>55</span><span> </span><span>Successfully</span><span> </span><span>generated</span><span> </span><span>markdown</span><span> </span><span>table</span><span>.</span>
</pre></div>

<h2 id="start-from-the-hardware">Start from the hardware</h2>
<p>While the conventional approach, now that we have a slow bulky solution, would be to use the profiles we have and 
start optimizing, I like to start with the opposite approach.</p>
<p>My background is in embedded, where performance only matters in as far as you need to ensure
realtime constraints and memory limits are met. This is not something you can do with iterative benchmarking after the fact:
if you are too slow or eat too much memory, there is no after the fact because your program simply doesn&#39;t get to run.</p>
<p>What I do instead is stare at my orb and ponder (or, more often, go for a walk):</p>
<p><strong>given the hardware that is given to me, what is the fastest possible way to get the job done?</strong></p>
<p>(Hardware in this context means the constraints that I absolutely cannot change. In our case, these constraints are
more likely to be the database storage engine, but the principle is the same).</p>
<p>Since most of my programming has been in backend and embedded programming, my programs usually consists of retrieving some bytes from A
and shoveling them over to B. In our &#34;markdown users rendering&#34; situation, we need to read some bytes from storage (our database)
and send them to the standard output (or, in real life, to a network interface over HTTP, maybe in the JSON format).</p>
<p><strong>Even if we were a magical genie capable of executing NP-complete algorithms in constant time,
there is no way we can rise above these physical limitations.</strong></p>
<h3 id="no-software-fastest-software">No software fastest software</h3>
<p>Approaching the problem from the hardware up allows us to do be deliberate about the tradeoffs
we are making as we start building our program.</p>
<p>Imagine that we actually need to hit that physical limit of sending bytes directly from storage to our network interface. 
How would we do so? The fastest program is no program at all, and in fact a magical piece of machinery could do the job for us: the DMA controller.
This would however require the data in storage to be in a format appropriate for the DMA controller to transfer to the network interface as is.
This is certainly a challenge we could take up in the embedded space. Not here, as we need to not only speak HTTP,
we also need to send our data as JSON (or markdown, in today&#39;s case); 
two tasks which are probably not within the capabilities of off-the-shelf DMA controllers.</p>
<p>If you think this is all lunacy, look at the architectures developed by high-frequency-trading companies.</p>
<h3 id="bypassing-the-kernel-and-the-network-stack">Bypassing the kernel and the network stack</h3>
<p>We can continue down this line of thinking and take the next best step:
how can we get our data from storage into central memory, transform it, and stream it back out straight to the network interface?
This would allow us to shape the data a bit more easily, and it is the approach we are going to take today.</p>
<p>Sending data straight from a user-space program to a network interface is an active area of development (and way out of my depth). 
The keywords to look for are &#34;zero-copy networking&#34;, &#34;kernel bypass&#34; and for example io_uring, 
which allow linux userland programs to stream data straight to different IO subsystems in the kernel.
This would also require our memory to be in the right format for efficient streaming.</p>
<p>Reading data from storage into main memory is something the kernel already does very well, but for best performance we need
to be aware of cache architecture and access patterns. On the userland side, calls like <code>mmap()</code> exist to give us access to
the kernel&#39;s file system cache. In our case, we use the <code>mattn/go-sqlite3</code> package, which is a wrapper around the C sqlite3 library.
This doesn&#39;t give us direct control over storage access, and we will have to rely on the C library to do the right thing (see however
the note at the end of this article).</p>
<p>Thinking about the best way to solve our problem if we had access to the kernel however surfaces the two techniques
we are going to use to optimize our program: memory-bounded streaming and preparing data to be in the right format.</p>
<p>We are going to:</p>
<ul>
<li>create a streaming channel that can be handed off to the rendering engine (similar to how we would set up a DMA channel and hand it off to the DMA controller)</li>
<li>read data in chunks, trusting the lower layer to efficiently handle reading from storage</li>
<li>transform each chunk into a format that is easy to stream</li>
<li>hand the chunk off to the streaming channel</li>
</ul>
<h2 id="optimization-1-memory-bounded-streaming">Optimization 1: memory-bounded streaming</h2>
<p>We&#39;ve seen that the biggest memory hog in our program is the <code>Users</code> array. This is because we are reading all the data
from storage into memory up front, then passing the entire data to the templating engine. Reading from storage
is entirely decoupled from the template rendering. This is nice from a separation of concerns point of view (we could
easily replace the database with another one, or rendering things as HTML or JSON or whatever, without having to 
change the other part), but it is not very efficient.</p>
<p>Wouldn&#39;t it be great if we could instead do something like our DMA controller, and have the data go straight from the DB
to the template engine? But how can we do so? It turns out that the <a href="https://pkg.go.dev/text/template">go template rendering engine</a> 
can accept a channel as iterator:</p>
<blockquote>
<p>{{range pipeline}} T1 {{end}}</p>
<p>The value of the pipeline must be an array, slice, map, or channel.
If the value of the pipeline has length zero, nothing is output;
otherwise, dot is set to the successive elements of the array,
slice, or map and T1 is executed. If the value is a map and the
keys are of basic type with a defined order, the elements will be
visited in sorted key order.</p>
</blockquote>
<p>This means that instead of passing the template engine a slice of users, we can pass it a channel of users. This should
help us keep the maximum of allocated memory bounded to the size of a single <code>User</code> slice. The downside is that if we
encounter an error while rendering, we won&#39;t be able to suppress the data that has already been sent and instead render
a nice error message. We&#39;ll have to abort mid-way. A more beneficial side-effect is that the rendering now happens in 
parallel with reading from the database, which should help improve runtime as well.</p>
<p>The new version uses the exact same template, but uses a go routine to read from the database and send the data to the
channel shared with the template rendering engine. I use the <code>errgroup</code> package here to run the goroutines and wait on
their exit, because <a href="https://publish.obsidian.md/manuel/ZK/Claims/2+-+Software/2g+-+Code/ZK+-+2g3a+-+golang+Concurrency+is+not+easy">go concurrency is not easy</a>.</p>
<div><pre><span></span><span>func</span><span> </span><span>generateStreamingMarkdown</span><span>()</span><span> </span><span>error</span><span> </span><span>{</span>
<span>    </span><span>eg</span><span>,</span><span> </span><span>ctx</span><span> </span><span>:=</span><span> </span><span>errgroup</span><span>.</span><span>WithContext</span><span>(</span><span>context</span><span>.</span><span>Background</span><span>())</span>

<span>    </span><span>c</span><span> </span><span>:=</span><span> </span><span>make</span><span>(</span><span>chan</span><span> </span><span>User</span><span>)</span>

<span>    </span><span>eg</span><span>.</span><span>Go</span><span>(</span><span>func</span><span>()</span><span> </span><span>error</span><span> </span><span>{</span>
<span>    	</span><span>defer</span><span> </span><span>close</span><span>(</span><span>c</span><span>)</span>

<span>    	</span><span>db</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>sql</span><span>.</span><span>Open</span><span>(</span><span>&#34;sqlite3&#34;</span><span>,</span><span> </span><span>&#34;users.db&#34;</span><span>)</span>
<span>    	</span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    		</span><span>return</span><span> </span><span>err</span>
<span>    	</span><span>}</span>
<span>    	</span><span>defer</span><span> </span><span>db</span><span>.</span><span>Close</span><span>()</span>
<span>    	</span><span>rows</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>db</span><span>.</span><span>QueryContext</span><span>(</span><span>ctx</span><span>,</span><span> </span><span>`SELECT email, first_name, last_name, address, city, zip FROM users`</span><span>)</span>
<span>    	</span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    		</span><span>return</span><span> </span><span>err</span>
<span>    	</span><span>}</span>
<span>    	</span><span>defer</span><span> </span><span>rows</span><span>.</span><span>Close</span><span>()</span>
<span>    	</span><span>for</span><span> </span><span>rows</span><span>.</span><span>Next</span><span>()</span><span> </span><span>{</span>
<span>    		</span><span>var</span><span> </span><span>user</span><span> </span><span>User</span>
<span>    		</span><span>if</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>rows</span><span>.</span><span>Scan</span><span>(</span><span>&amp;</span><span>user</span><span>.</span><span>Email</span><span>,</span><span> </span><span>&amp;</span><span>user</span><span>.</span><span>FirstName</span><span>,</span><span> </span><span>&amp;</span><span>user</span><span>.</span><span>LastName</span><span>,</span><span> </span><span>&amp;</span><span>user</span><span>.</span><span>Address</span><span>,</span><span> </span><span>&amp;</span><span>user</span><span>.</span><span>City</span><span>,</span><span> </span><span>&amp;</span><span>user</span><span>.</span><span>Zip</span><span>);</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    			</span><span>return</span><span> </span><span>err</span>
<span>    		</span><span>}</span>
<span>    		</span><span>c</span><span> </span><span>&lt;-</span><span> </span><span>user</span>
<span>    	</span><span>}</span>

<span>    	</span><span>return</span><span> </span><span>nil</span>
<span>    </span><span>})</span>

<span>    </span><span>eg</span><span>.</span><span>Go</span><span>(</span><span>func</span><span>()</span><span> </span><span>error</span><span> </span><span>{</span>
<span>    	</span><span>tmpl</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>template</span><span>.</span><span>New</span><span>(</span><span>&#34;markdown&#34;</span><span>).</span><span>Parse</span><span>(</span><span>markdownTemplate</span><span>)</span>
<span>    	</span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    		</span><span>return</span><span> </span><span>err</span>
<span>    	</span><span>}</span>

<span>    	</span><span>err</span><span> </span><span>=</span><span> </span><span>tmpl</span><span>.</span><span>Execute</span><span>(</span><span>os</span><span>.</span><span>Stdout</span><span>,</span><span> </span><span>c</span><span>)</span>
<span>    	</span><span>log</span><span>.</span><span>Println</span><span>(</span><span>&#34;Successfully generated markdown table.&#34;</span><span>)</span>

<span>    	</span><span>return</span><span> </span><span>err</span>
<span>    </span><span>})</span>

<span>    </span><span>err</span><span> </span><span>:=</span><span> </span><span>eg</span><span>.</span><span>Wait</span><span>()</span>
<span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    	</span><span>return</span><span> </span><span>err</span>
<span>    </span><span>}</span>

<span>    </span><span>err</span><span> </span><span>=</span><span> </span><span>writeProfile</span><span>(</span><span>&#34;mem-streaming.prof&#34;</span><span>)</span>
<span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    	</span><span>return</span><span> </span><span>err</span>
<span>    </span><span>}</span>

<span>    </span><span>return</span><span> </span><span>nil</span>
<span>}</span>
</pre></div>

<p>Running the measurements we did before, we now see that without GC, we are capping out at 3.6 MiB of memory, which is
quite a change!</p>
<div><pre><span></span><span>‚ùØ</span><span> </span><span>go</span><span> </span><span>run</span><span> </span><span>.</span><span> </span><span>generate</span><span> </span><span>--</span><span>streaming</span><span> </span><span>&gt;</span><span> </span><span>/</span><span>dev</span><span>/</span><span>null</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>2.0</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>3.1</span><span> </span><span>MiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>3.6</span><span> </span><span>MiB</span>
<span>2023</span><span>/</span><span>05</span><span>/</span><span>01</span><span> </span><span>08</span><span>:</span><span>21</span><span>:</span><span>35</span><span> </span><span>Successfully</span><span> </span><span>generated</span><span> </span><span>markdown</span><span> </span><span>table</span><span>.</span>
<span>2023</span><span>/</span><span>05</span><span>/</span><span>01</span><span> </span><span>08</span><span>:</span><span>21</span><span>:</span><span>35</span><span> </span><span>Time</span><span> </span><span>elapsed</span><span>:</span><span> </span><span>7.622725915</span><span>s</span>
</pre></div>

<p>Looking at the profile information, we see that our generateStreamingMarkdown method is now at the same level
as <code>Next</code> (from the database driver) and <code>reflect.Value.recv</code> (use by the template rendering engine to interpret
our <code>User</code> struct):</p>
<div><pre><span></span><span>‚ùØ</span><span> </span><span>go</span><span> </span><span>tool</span><span> </span><span>pprof</span><span> </span><span>-</span><span>alloc_space</span><span> </span><span>mem</span><span>-</span><span>streaming</span><span>.</span><span>prof</span>
<span>File</span><span>:</span><span> </span><span>go</span><span>-</span><span>template</span><span>-</span><span>streaming</span>
<span>Build</span><span> </span><span>ID</span><span>:</span><span> </span><span>cd0c79b1712051bd8ef4669842e0c2356efd86ed</span>
<span>Type</span><span>:</span><span> </span><span>alloc_space</span>
<span>Time</span><span>:</span><span> </span><span>May</span><span> </span><span>1</span><span>,</span><span> </span><span>2023</span><span> </span><span>at</span><span> </span><span>8</span><span>:</span><span>21</span><span>am</span><span> </span><span>(</span><span>EDT</span><span>)</span>
<span>Entering</span><span> </span><span>interactive</span><span> </span><span>mode</span><span> </span><span>(</span><span>type</span><span> </span><span>&#34;help&#34;</span><span> </span><span>for</span><span> </span><span>commands</span><span>,</span><span> </span><span>&#34;o&#34;</span><span> </span><span>for</span><span> </span><span>options</span><span>)</span>
<span>(</span><span>pprof</span><span>)</span><span> </span><span>top</span>
<span>Showing</span><span> </span><span>nodes</span><span> </span><span>accounting</span><span> </span><span>for</span><span> </span><span>698.53</span><span>MB</span><span>,</span><span> </span><span>98.94</span><span>%</span><span> </span><span>of</span><span> </span><span>706.03</span><span>MB</span><span> </span><span>total</span>
<span>Dropped</span><span> </span><span>6</span><span> </span><span>nodes</span><span> </span><span>(</span><span>cum</span><span> </span><span>&lt;=</span><span> </span><span>3.53</span><span>MB</span><span>)</span>
<span>Showing</span><span> </span><span>top</span><span> </span><span>10</span><span> </span><span>nodes</span><span> </span><span>out</span><span> </span><span>of</span><span> </span><span>30</span>
<span>      </span><span>flat</span><span>  </span><span>flat</span><span>%</span><span>   </span><span>sum</span><span>%</span><span>        </span><span>cum</span><span>   </span><span>cum</span><span>%</span>
<span>  </span><span>121.51</span><span>MB</span><span> </span><span>17.21</span><span>%</span><span> </span><span>17.21</span><span>%</span><span>   </span><span>121.51</span><span>MB</span><span> </span><span>17.21</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>(</span><span>*</span><span>SQLiteRows</span><span>)</span><span>.</span><span>Next</span>
<span>  </span><span>104.51</span><span>MB</span><span> </span><span>14.80</span><span>%</span><span> </span><span>32.01</span><span>%</span><span>   </span><span>104.51</span><span>MB</span><span> </span><span>14.80</span><span>%</span><span>  </span><span>reflect</span><span>.</span><span>Value</span><span>.</span><span>recv</span>
<span>  </span><span>102.01</span><span>MB</span><span> </span><span>14.45</span><span>%</span><span> </span><span>46.46</span><span>%</span><span>   </span><span>223.52</span><span>MB</span><span> </span><span>31.66</span><span>%</span><span>  </span><span>main</span><span>.</span><span>generateStreamingMarkdown</span><span>.</span><span>func1</span>
<span>     </span><span>100</span><span>MB</span><span> </span><span>14.16</span><span>%</span><span> </span><span>60.62</span><span>%</span><span>   </span><span>322.51</span><span>MB</span><span> </span><span>45.68</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>(</span><span>*</span><span>SQLiteRows</span><span>)</span><span>.</span><span>nextSyncLocked</span>
<span>      </span><span>73</span><span>MB</span><span> </span><span>10.34</span><span>%</span><span> </span><span>70.96</span><span>%</span><span>       </span><span>73</span><span>MB</span><span> </span><span>10.34</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>_Cfunc_GoStringN</span><span> </span><span>(</span><span>inline</span><span>)</span>
<span>   </span><span>50.50</span><span>MB</span><span>  </span><span>7.15</span><span>%</span><span> </span><span>78.12</span><span>%</span><span>    </span><span>50.50</span><span>MB</span><span>  </span><span>7.15</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>(</span><span>*</span><span>SQLiteRows</span><span>)</span><span>.</span><span>nextSyncLocked</span><span>.</span><span>func9</span>
<span>   </span><span>49.50</span><span>MB</span><span>  </span><span>7.01</span><span>%</span><span> </span><span>85.13</span><span>%</span><span>    </span><span>49.50</span><span>MB</span><span>  </span><span>7.01</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>(</span><span>*</span><span>SQLiteRows</span><span>)</span><span>.</span><span>nextSyncLocked</span><span>.</span><span>func3</span>
<span>      </span><span>46</span><span>MB</span><span>  </span><span>6.52</span><span>%</span><span> </span><span>91.64</span><span>%</span><span>       </span><span>46</span><span>MB</span><span>  </span><span>6.52</span><span>%</span><span>  </span><span>reflect</span><span>.</span><span>(</span><span>*</span><span>structType</span><span>)</span><span>.</span><span>Field</span>
<span>   </span><span>42.50</span><span>MB</span><span>  </span><span>6.02</span><span>%</span><span> </span><span>97.66</span><span>%</span><span>    </span><span>42.50</span><span>MB</span><span>  </span><span>6.02</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>(</span><span>*</span><span>SQLiteRows</span><span>)</span><span>.</span><span>nextSyncLocked</span><span>.</span><span>func10</span>
<span>       </span><span>9</span><span>MB</span><span>  </span><span>1.27</span><span>%</span><span> </span><span>98.94</span><span>%</span><span>   </span><span>160.01</span><span>MB</span><span> </span><span>22.66</span><span>%</span><span>  </span><span>text</span><span>/</span><span>template</span><span>.</span><span>(</span><span>*</span><span>state</span><span>)</span><span>.</span><span>walkRange</span>
</pre></div>

<p>Out of pure curiosity, let&#39;s trigger the GC before measuring max heap size:</p>
<div><pre><span></span><span>‚ùØ</span><span> </span><span>go</span><span> </span><span>run</span><span> </span><span>.</span><span> </span><span>generate</span><span> </span><span>--</span><span>streaming</span><span> </span><span>--</span><span>trigger</span><span>-</span><span>gc</span><span> </span><span>&gt;</span><span> </span><span>/</span><span>dev</span><span>/</span><span>null</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>222.0</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>228.6</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>232.5</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>233.4</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>235.1</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>237.3</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>240.6</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>250.8</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>254.3</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>255.3</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>256.5</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>262.1</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>263.1</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>266.8</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>269.9</span><span> </span><span>KiB</span>
<span>2023</span><span>/</span><span>05</span><span>/</span><span>01</span><span> </span><span>08</span><span>:</span><span>25</span><span>:</span><span>25</span><span> </span><span>Successfully</span><span> </span><span>generated</span><span> </span><span>markdown</span><span> </span><span>table</span><span>.</span>
<span>2023</span><span>/</span><span>05</span><span>/</span><span>01</span><span> </span><span>08</span><span>:</span><span>25</span><span>:</span><span>25</span><span> </span>
<span>        </span><span>To</span><span> </span><span>view</span><span> </span><span>the</span><span> </span><span>memory</span><span> </span><span>profile</span><span>,</span><span> </span><span>run</span><span> </span><span>the</span><span> </span><span>following</span><span> </span><span>command</span><span>:</span>
<span>        </span><span>go</span><span> </span><span>tool</span><span> </span><span>pprof</span><span> </span><span>mem</span><span>-</span><span>streaming</span><span>.</span><span>prof</span>
<span>        </span><span>go</span><span> </span><span>tool</span><span> </span><span>pprof</span><span> </span><span>-</span><span>alloc_space</span><span> </span><span>mem</span><span>-</span><span>streaming</span><span>.</span><span>prof</span>
<span>2023</span><span>/</span><span>05</span><span>/</span><span>01</span><span> </span><span>08</span><span>:</span><span>25</span><span>:</span><span>25</span><span> </span><span>Time</span><span> </span><span>elapsed</span><span>:</span><span> </span><span>7.61040447</span><span>s</span>
</pre></div>

<p>Not bad!</p>
<h2 id="optimization-2-db-string-concatenation">Optimization 2: DB-string concatenation</h2>
<p>We now have a system that efficiently reads from storage (through the sqlite3 C driver) and efficiently streams out
to the output interface (using a channel of <code>User</code> structs). The only work our software does is setting up the 
&#34;DMA channels&#34; (the goroutines streaming in and streaming out). But we are still quite slow, 8 seconds to copy 100 MB
of data from disk to stdout is not what I would call &#34;efficient&#34;. In fact, we are just as fast as we were without streaming,
despite operating in parallel.</p>
<p>We could now start CPU profiling, but let&#39;s go back to our hardware example. Is there are a way to get our data out
of the storage &#34;hardware&#34; in a format that&#39;s already ready to be consumed by the output &#34;hardware&#34;? It turns out that yes,
we can use SQL and SQLite string functions to already render our data in the markdown row format and let sqlite and its low-level
C implementation do the job, instead of relying on our expensive reflection-based go template engine. At this point in our toy
example, it is valid to ask ourselves if a template engine is necessary at all, but the real world is more complex than this.</p>
<p>Here is a final version of the code that uses SQL to render the markdown table. Note that by streamling the rendering
by letting sqlite do part of the formatting and by coupling the database IO to the template rendering IO, we 
significantly couple the rendering on the one hand and the database querying on the other. Passing a channel to the 
template engine is reasonably elegant but by transforming it into a <code>chan string</code> from a <code>chan User</code>, we are putting
the burden of creating valid markdown on to the SQL query itself. This is a tradeoff worth discussing.</p>
<div><pre><span></span><span>const</span><span> </span><span>markdownStringTemplate</span><span> </span><span>=</span><span> </span><span>`</span>
<span>| Email | First Name | Last Name | Address | City | Zip |</span>
<span>|-------|------------|-----------|---------|------|-----|</span>
<span>{{range .}}|{{.}}|{{end}}</span>
<span>`</span>

<span>func</span><span> </span><span>generateStreamingStringMarkdown</span><span>()</span><span> </span><span>error</span><span> </span><span>{</span>
<span>eg</span><span>,</span><span> </span><span>ctx</span><span> </span><span>:=</span><span> </span><span>errgroup</span><span>.</span><span>WithContext</span><span>(</span><span>context</span><span>.</span><span>Background</span><span>())</span>

<span>    </span><span>c</span><span> </span><span>:=</span><span> </span><span>make</span><span>(</span><span>chan</span><span> </span><span>string</span><span>)</span>

<span>    </span><span>eg</span><span>.</span><span>Go</span><span>(</span><span>func</span><span>()</span><span> </span><span>error</span><span> </span><span>{</span>
<span>    	</span><span>defer</span><span> </span><span>close</span><span>(</span><span>c</span><span>)</span>

<span>    	</span><span>db</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>sql</span><span>.</span><span>Open</span><span>(</span><span>&#34;sqlite3&#34;</span><span>,</span><span> </span><span>&#34;users.db&#34;</span><span>)</span>
<span>    	</span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    		</span><span>return</span><span> </span><span>err</span>
<span>    	</span><span>}</span>
<span>    	</span><span>defer</span><span> </span><span>db</span><span>.</span><span>Close</span><span>()</span>
<span>    	</span><span>rows</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>db</span><span>.</span><span>QueryContext</span><span>(</span><span>ctx</span><span>,</span><span> </span><span>`SELECT (email || &#39;|&#39; || first_name || &#39;|&#39; || last_name || &#39;|&#39; || address || &#39;|&#39; || city || &#39;|&#39; || zip) FROM users`</span><span>)</span>
<span>    	</span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    		</span><span>return</span><span> </span><span>err</span>
<span>    	</span><span>}</span>
<span>    	</span><span>defer</span><span> </span><span>rows</span><span>.</span><span>Close</span><span>()</span>
<span>    	</span><span>for</span><span> </span><span>rows</span><span>.</span><span>Next</span><span>()</span><span> </span><span>{</span>
<span>    		</span><span>var</span><span> </span><span>s</span><span> </span><span>string</span>
<span>    		</span><span>if</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>rows</span><span>.</span><span>Scan</span><span>(</span><span>&amp;</span><span>s</span><span>);</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    			</span><span>return</span><span> </span><span>err</span>
<span>    		</span><span>}</span>
<span>    		</span><span>c</span><span> </span><span>&lt;-</span><span> </span><span>s</span>
<span>    	</span><span>}</span>

<span>    	</span><span>return</span><span> </span><span>nil</span>
<span>    </span><span>})</span>

<span>    </span><span>eg</span><span>.</span><span>Go</span><span>(</span><span>func</span><span>()</span><span> </span><span>error</span><span> </span><span>{</span>
<span>    	</span><span>tmpl</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>template</span><span>.</span><span>New</span><span>(</span><span>&#34;markdown&#34;</span><span>).</span><span>Parse</span><span>(</span><span>markdownStringTemplate</span><span>)</span>
<span>    	</span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    		</span><span>return</span><span> </span><span>err</span>
<span>    	</span><span>}</span>

<span>    	</span><span>err</span><span> </span><span>=</span><span> </span><span>tmpl</span><span>.</span><span>Execute</span><span>(</span><span>os</span><span>.</span><span>Stdout</span><span>,</span><span> </span><span>c</span><span>)</span>
<span>    	</span><span>log</span><span>.</span><span>Println</span><span>(</span><span>&#34;Successfully generated markdown table.&#34;</span><span>)</span>

<span>    	</span><span>return</span><span> </span><span>err</span>
<span>    </span><span>})</span>

<span>    </span><span>err</span><span> </span><span>:=</span><span> </span><span>eg</span><span>.</span><span>Wait</span><span>()</span>
<span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    	</span><span>return</span><span> </span><span>err</span>
<span>    </span><span>}</span>

<span>    </span><span>err</span><span> </span><span>=</span><span> </span><span>writeProfile</span><span>(</span><span>&#34;mem-streaming.prof&#34;</span><span>)</span>
<span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
<span>    	</span><span>return</span><span> </span><span>err</span>
<span>    </span><span>}</span>

<span>    </span><span>return</span><span> </span><span>nil</span>
<span>}</span>
</pre></div>

<p>And the usual measurements, although I would put quite a bit more effort into making sure I am measuring the right
thing if I set out to actually optimize runtime, and not memory consumption (all we do here is measure wall time 
in the <code>main()</code> function, with heap profiling active of all things!).</p>
<div><pre><span></span><span>‚ùØ</span><span> </span><span>go</span><span> </span><span>run</span><span> </span><span>.</span><span> </span><span>generate</span><span> </span><span>--</span><span>streaming</span><span>-</span><span>string</span><span> </span><span>--</span><span>trigger</span><span>-</span><span>gc</span><span> </span><span>&gt;</span><span> </span><span>/</span><span>dev</span><span>/</span><span>null</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>238.3</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>251.8</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>256.7</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>263.1</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>269.5</span><span> </span><span>KiB</span>
<span>MaxAlloc</span><span>:</span><span> </span><span>275.0</span><span> </span><span>KiB</span>
<span>2023</span><span>/</span><span>05</span><span>/</span><span>01</span><span> </span><span>08</span><span>:</span><span>33</span><span>:</span><span>43</span><span> </span><span>Successfully</span><span> </span><span>generated</span><span> </span><span>markdown</span><span> </span><span>table</span><span>.</span>
<span>2023</span><span>/</span><span>05</span><span>/</span><span>01</span><span> </span><span>08</span><span>:</span><span>33</span><span>:</span><span>43</span><span> </span><span>Time</span><span> </span><span>elapsed</span><span>:</span><span> </span><span>2.743605651</span><span>s</span>
</pre></div>

<p>From 7 seconds to 3 seconds, a fairly impressive improvement! From a memory perspective, nothing changes very much,
except that we are allocating less temporary data (all those little strings inside the <code>User</code> struct) in our rendering
loop.</p>
<div><pre><span></span><span>‚ùØ</span><span> </span><span>go</span><span> </span><span>tool</span><span> </span><span>pprof</span><span> </span><span>-</span><span>alloc_space</span><span> </span><span>mem</span><span>-</span><span>streaming</span><span>.</span><span>prof</span>

<span>File</span><span>:</span><span> </span><span>go</span><span>-</span><span>template</span><span>-</span><span>streaming</span>
<span>Build</span><span> </span><span>ID</span><span>:</span><span> </span><span>62</span><span>a73a3f4794306f68b637fe7bf0470a5a744b34</span>
<span>Type</span><span>:</span><span> </span><span>alloc_space</span>
<span>Time</span><span>:</span><span> </span><span>May</span><span> </span><span>1</span><span>,</span><span> </span><span>2023</span><span> </span><span>at</span><span> </span><span>8</span><span>:</span><span>35</span><span>am</span><span> </span><span>(</span><span>EDT</span><span>)</span>
<span>Entering</span><span> </span><span>interactive</span><span> </span><span>mode</span><span> </span><span>(</span><span>type</span><span> </span><span>&#34;help&#34;</span><span> </span><span>for</span><span> </span><span>commands</span><span>,</span><span> </span><span>&#34;o&#34;</span><span> </span><span>for</span><span> </span><span>options</span><span>)</span>
<span>(</span><span>pprof</span><span>)</span><span> </span><span>top</span>
<span>Showing</span><span> </span><span>nodes</span><span> </span><span>accounting</span><span> </span><span>for</span><span> </span><span>303.52</span><span>MB</span><span>,</span><span> </span><span>100</span><span>%</span><span> </span><span>of</span><span> </span><span>303.52</span><span>MB</span><span> </span><span>total</span>
<span>Showing</span><span> </span><span>top</span><span> </span><span>10</span><span> </span><span>nodes</span><span> </span><span>out</span><span> </span><span>of</span><span> </span><span>21</span>
<span>      </span><span>flat</span><span>  </span><span>flat</span><span>%</span><span>   </span><span>sum</span><span>%</span><span>        </span><span>cum</span><span>   </span><span>cum</span><span>%</span>
<span>  </span><span>135.01</span><span>MB</span><span> </span><span>44.48</span><span>%</span><span> </span><span>44.48</span><span>%</span><span>   </span><span>135.01</span><span>MB</span><span> </span><span>44.48</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>(</span><span>*</span><span>SQLiteRows</span><span>)</span><span>.</span><span>Next</span>
<span>   </span><span>68.01</span><span>MB</span><span> </span><span>22.41</span><span>%</span><span> </span><span>66.89</span><span>%</span><span>    </span><span>68.01</span><span>MB</span><span> </span><span>22.41</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>_Cfunc_GoStringN</span><span> </span><span>(</span><span>inline</span><span>)</span>
<span>      </span><span>36</span><span>MB</span><span> </span><span>11.86</span><span>%</span><span> </span><span>78.75</span><span>%</span><span>       </span><span>36</span><span>MB</span><span> </span><span>11.86</span><span>%</span><span>  </span><span>reflect</span><span>.</span><span>Value</span><span>.</span><span>recv</span>
<span>      </span><span>16</span><span>MB</span><span>  </span><span>5.27</span><span>%</span><span> </span><span>84.02</span><span>%</span><span>   </span><span>151.01</span><span>MB</span><span> </span><span>49.75</span><span>%</span><span>  </span><span>main</span><span>.</span><span>generateStreamingStringMarkdown</span><span>.</span><span>func1</span>
<span>      </span><span>13</span><span>MB</span><span>  </span><span>4.28</span><span>%</span><span> </span><span>88.30</span><span>%</span><span>       </span><span>13</span><span>MB</span><span>  </span><span>4.28</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>(</span><span>*</span><span>SQLiteRows</span><span>)</span><span>.</span><span>nextSyncLocked</span><span>.</span><span>func9</span>
<span>      </span><span>12</span><span>MB</span><span>  </span><span>3.95</span><span>%</span><span> </span><span>92.26</span><span>%</span><span>   </span><span>109.51</span><span>MB</span><span> </span><span>36.08</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>(</span><span>*</span><span>SQLiteRows</span><span>)</span><span>.</span><span>nextSyncLocked</span>
<span>       </span><span>8</span><span>MB</span><span>  </span><span>2.64</span><span>%</span><span> </span><span>94.89</span><span>%</span><span>        </span><span>8</span><span>MB</span><span>  </span><span>2.64</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>(</span><span>*</span><span>SQLiteRows</span><span>)</span><span>.</span><span>nextSyncLocked</span><span>.</span><span>func10</span>
<span>       </span><span>7</span><span>MB</span><span>  </span><span>2.31</span><span>%</span><span> </span><span>97.20</span><span>%</span><span>       </span><span>43</span><span>MB</span><span> </span><span>14.17</span><span>%</span><span>  </span><span>text</span><span>/</span><span>template</span><span>.</span><span>(</span><span>*</span><span>state</span><span>)</span><span>.</span><span>walkRange</span>
<span>    </span><span>4.50</span><span>MB</span><span>  </span><span>1.48</span><span>%</span><span> </span><span>98.68</span><span>%</span><span>     </span><span>4.50</span><span>MB</span><span>  </span><span>1.48</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>(</span><span>*</span><span>SQLiteRows</span><span>)</span><span>.</span><span>nextSyncLocked</span><span>.</span><span>func3</span>
<span>       </span><span>4</span><span>MB</span><span>  </span><span>1.32</span><span>%</span><span>   </span><span>100</span><span>%</span><span>        </span><span>4</span><span>MB</span><span>  </span><span>1.32</span><span>%</span><span>  </span><span>github</span><span>.</span><span>com</span><span>/</span><span>mattn</span><span>/</span><span>go</span><span>-</span><span>sqlite3</span><span>.</span><span>(</span><span>*</span><span>SQLiteRows</span><span>)</span><span>.</span><span>nextSyncLocked</span><span>.</span><span>func1</span>
</pre></div>

<p>Through first principles, and with not very much code at all, we were able to turn a program consuming 200 MB of memory
(and being O(n) in terms of peak heap size) and running for 8 seconds into a program consuming 300 kB of peak heap size
and running for 3 seconds!</p>
<h2 id="what-about-sqlite-and-the-kernel">What about sqlite and the kernel?</h2>
<p>But manuel, you ask, you are talking all sweet about thinking holistically and seeing the system, but you are just
measuring go&#39;s heap behaviour, in go itself, of all things. How do you know you are measuring the right thing?
This is indeed a great question, but the article is already long enough (and to be honest, I&#39;m quite rusty in doing
whole system optimization work), so I&#39;ll leave you with a couple of links and we&#39;ll hopefully revisit this topic in a subsequent
post:</p>
<ul>
<li><a href="https://ebpf.io/">EBPF homepage</a> - a technology that allows you to write programs that run in the kernel. It comes
with a huge set of already written program that are a great way to look inside the kernel for performance insights.</li>
<li><a href="https://perf.wiki.kernel.org/index.php/Main_Page">perf: Linux profiling with performance counters</a> - perf is a
profiler that uses CPU performance counters across the entire system, not just your userland program. It is great to
see if bottlenecks are hidden in plain sight within the libraries or subsystems your program uses.</li>
<li><a href="https://bookshop.org/p/books/computer-systems-a-programmer-s-perspective-randal-bryant/8982319?ean=9780134092669">Computer Systems: A Programmer&#39;s Perspective</a> -
my favourite book about computer systems from the hardware up to the C runtime. It is not an excruciatingly detailed
reference, but instead comes with a lot of source code examples.</li>
<li><a href="https://bookshop.org/p/books/every-computer-performance-book-how-to-avoid-and-solve-performance-problems-on-the-computers-you-work-with-bob-wescott/9848820?ean=9781482657753">Every Computer Performance Book</a> -
a small book that gives you a clear introduction to the philosophy of performance optimization and some pitfalls to
avoid. Applicable widely, beyond just memory and runtime optimization.</li>
<li><a href="https://bookshop.org/p/books/systems-performance-brendan-gregg/14715855?ean=9780136820154">Systems Performance</a> - a
quite detailed book about performance optimization, with a focus on linux.</li>
<li><a href="https://bookshop.org/p/books/bpf-performance-tools-brendan-gregg/9643920?ean=9780136554820">BPF Performance Tools</a> -
a detailed book about eBPF and its many applications to performance optimization.</li>
</ul>
</div></div>
  </body>
</html>
