<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/aws/aws-secretsmanager-agent">Original</a>
    <h1>AWS Secrets Manager Agent</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">The AWS Secrets Manager Agent is a client-side HTTP service that you can use to standardize consumption of secrets from Secrets Manager across environments such as AWS Lambda, Amazon Elastic Container Service, Amazon Elastic Kubernetes Service, and Amazon Elastic Compute Cloud. The Secrets Manager Agent can retrieve and cache secrets in memory so that your applications can consume secrets directly from the cache. That means you can fetch the secrets your application needs from the localhost instead of making calls to Secrets Manager. The Secrets Manager Agent can only make read requests to Secrets Manager - it can&#39;t modify secrets.</p>
<p dir="auto">The Secrets Manager Agent uses the AWS credentials you provide in your environment to make calls to Secrets Manager. The Secrets Manager Agent offers protection against Server Side Request Forgery (SSRF) to help improve secret security. You can configure the Secrets Manager Agent by setting the maximum number of connections, the time to live (TTL), the localhost HTTP port, and the cache size.</p>
<p dir="auto">Because the Secrets Manager Agent uses an in-memory cache, it resets when the Secrets Manager Agent restarts. The Secrets Manager Agent periodically refreshes the cached secret value. The refresh happens when you try to read a secret from the Secrets Manager Agent after the TTL has expired. The default refresh frequency (TTL) is 300 seconds, and you can change it by using a <a href="#secrets-manager-agent-config">Configuration file</a> which you pass to the Secrets Manager Agent using the <code>--config</code> command line argument. The Secrets Manager Agent does not include cache invalidation. For example, if a secret rotates before the cache entry expires, the Secrets Manager Agent might return a stale secret value.</p>
<p dir="auto">The Secrets Manager Agent returns secret values in the same format as the response of <code>GetSecretValue</code>. Secret values are not encrypted in the cache.</p>
<p dir="auto">To download the source code, see <a href="https://github.com/aws/aws-secretsmanager-agent">https://github.com/aws/aws-secretsmanager-agent</a> on GitHub.</p>
<p dir="auto"><strong>Topics</strong></p>
<ul dir="auto">
<li><a href="#aws-secrets-manager-agent">AWS Secrets Manager Agent</a>
<ul dir="auto">
<li><a href="#step-1-build-the-secrets-manager-agent-binary">Step 1: Build the Secrets Manager Agent binary</a>
<ul dir="auto">
<li><a href="#-rpm-based-systems-">[ RPM-based systems ]</a></li>
<li><a href="#-debian-based-systems-">[ Debian-based systems ]</a></li>
<li><a href="#-windows-">[ Windows ]</a></li>
<li><a href="#-cross-compile-natively-">[ Cross-compile natively ]</a></li>
<li><a href="#-cross-compile-with-rust-cross-">[ Cross compile with Rust cross ]</a></li>
</ul>
</li>
<li><a href="#step-2-install-the-secrets-manager-agent">Step 2: Install the Secrets Manager Agent</a>
<ul dir="auto">
<li><a href="#-amazon-eks-and-amazon-ecs-">[ Amazon EKS and Amazon ECS ]</a></li>
<li><a href="#-docker-">[ Docker ]</a></li>
<li><a href="#-aws-lambda-">[ AWS Lambda ]</a></li>
</ul>
</li>
<li><a href="#step-3-retrieve-secrets-with-the-secrets-manager-agent">Step 3: Retrieve secrets with the Secrets Manager Agent</a>
<ul dir="auto">
<li><a href="#-curl-">[ curl ]</a></li>
<li><a href="#-python-">[ Python ]</a></li>
</ul>
</li>
<li><a href="#configure-the-secrets-manager-agent">Configure the Secrets Manager Agent</a></li>
<li><a href="#logging">Logging</a></li>
<li><a href="#security-considerations">Security considerations</a></li>
</ul>
</li>
</ul>
<div dir="auto"><h2 tabindex="-1" dir="auto">Step 1: Build the Secrets Manager Agent binary<a name="user-content-secrets-manager-agent-build"></a></h2><a id="user-content-step-1-build-the-secrets-manager-agent-binary" aria-label="Permalink: Step 1: Build the Secrets Manager Agent binary" href="#step-1-build-the-secrets-manager-agent-binary"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To build the Secrets Manager Agent binary natively, you need the standard development tools and the Rust tools. Alternatively, you can cross-compile for systems that support it, or you can use Rust cross to cross-compile.</p>
<hr/>

<ol dir="auto">
<li>
<p dir="auto">On RPM-based systems such as AL2023, you can install the development tools by using the Development Tools group.</p>
<div dir="auto" data-snippet-clipboard-copy-content="sudo yum -y groupinstall &#34;Development Tools&#34;"><pre>sudo yum -y groupinstall <span><span>&#34;</span>Development Tools<span>&#34;</span></span></pre></div>
</li>
<li>
<p dir="auto">Follow the instructions at <a href="https://www.rust-lang.org/tools/install" rel="nofollow">Install Rust</a> in the <em>Rust documentation</em>.</p>
<div dir="auto" data-snippet-clipboard-copy-content="curl --proto &#39;=https&#39; --tlsv1.2 -sSf https://sh.rustup.rs | sh
. &#34;$HOME/.cargo/env&#34;"><pre>curl --proto <span><span>&#39;</span>=https<span>&#39;</span></span> --tlsv1.2 -sSf https://sh.rustup.rs <span>|</span> sh
<span>.</span> <span><span>&#34;</span><span>$HOME</span>/.cargo/env<span>&#34;</span></span></pre></div>
</li>
<li>
<p dir="auto">Build the agent using the cargo build command:</p>

<p dir="auto">You will find the executable under <code>target/release/aws-secrets-manager-agent</code>.</p>
</li>
</ol>
<hr/>

<ol dir="auto">
<li>
<p dir="auto">On Debian-based systems such as Ubuntu, you can install the developer tools using the build-essential package.</p>
<div dir="auto" data-snippet-clipboard-copy-content="sudo apt install build-essential"><pre>sudo apt install build-essential</pre></div>
</li>
<li>
<p dir="auto">Follow the instructions at <a href="https://www.rust-lang.org/tools/install" rel="nofollow">Install Rust</a> in the <em>Rust documentation</em>.</p>
<div dir="auto" data-snippet-clipboard-copy-content="curl --proto &#39;=https&#39; --tlsv1.2 -sSf https://sh.rustup.rs | sh
. &#34;$HOME/.cargo/env&#34;"><pre>curl --proto <span><span>&#39;</span>=https<span>&#39;</span></span> --tlsv1.2 -sSf https://sh.rustup.rs <span>|</span> sh
<span>.</span> <span><span>&#34;</span><span>$HOME</span>/.cargo/env<span>&#34;</span></span></pre></div>
</li>
<li>
<p dir="auto">Build the agent using the cargo build command:</p>

<p dir="auto">You will find the executable under <code>target/release/aws-secrets-manager-agent</code>.</p>
</li>
</ol>
<hr/>

<p dir="auto">To build on Windows, follow the instructions at <a href="https://learn.microsoft.com/en-us/windows/dev-environment/rust/setup" rel="nofollow">Set up your dev environment on Windows for Rust</a> in the <em>Microsoft Windows documentation</em>.</p>
<hr/>
<div dir="auto"><h4 tabindex="-1" dir="auto">[ Cross-compile natively ]</h4><a id="user-content--cross-compile-natively-" aria-label="Permalink: [ Cross-compile natively ]" href="#-cross-compile-natively-"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">On distributions where the mingw-w64 package is available such as Ubuntu, you can cross compile natively.</p>
<div dir="auto" data-snippet-clipboard-copy-content="# Install the cross compile tool chain
sudo add-apt-repository universe
sudo apt install -y mingw-w64
    
# Install the rust build targets
rustup target add x86_64-pc-windows-gnu
    
# Cross compile the agent for Windows
cargo build --release --target x86_64-pc-windows-gnu"><pre><span><span>#</span> Install the cross compile tool chain</span>
sudo add-apt-repository universe
sudo apt install -y mingw-w64
    
<span><span>#</span> Install the rust build targets</span>
rustup target add x86_64-pc-windows-gnu
    
<span><span>#</span> Cross compile the agent for Windows</span>
cargo build --release --target x86_64-pc-windows-gnu</pre></div>
<p dir="auto">You will find the executable at <code>target/x86_64-pc-windows-gnu/release/aws-secrets-manager-agent.exe</code>.</p>
<hr/>
<div dir="auto"><h4 tabindex="-1" dir="auto">[ Cross compile with Rust cross ]</h4><a id="user-content--cross-compile-with-rust-cross-" aria-label="Permalink: [ Cross compile with Rust cross ]" href="#-cross-compile-with-rust-cross-"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If the cross compile tools are not available natively on the system, you can use the Rust cross project. For more information, see <a href="https://github.com/cross-rs/cross">https://github.com/cross-rs/cross</a>.</p>
<p dir="auto"><strong>Important</strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="# Install and start docker
sudo yum -y install docker
sudo systemctl start docker
sudo systemctl enable docker # Make docker start after reboot
    
# Give ourselves permission to run the docker images without sudo
sudo usermod -aG docker $USER
newgrp docker
    
# Install cross and cross compile the executable
cargo install cross
cross build --release --target x86_64-pc-windows-gnu"><pre><span><span>#</span> Install and start docker</span>
sudo yum -y install docker
sudo systemctl start docker
sudo systemctl <span>enable</span> docker <span><span>#</span> Make docker start after reboot</span>
    
<span><span>#</span> Give ourselves permission to run the docker images without sudo</span>
sudo usermod -aG docker <span>$USER</span>
newgrp docker
    
<span><span>#</span> Install cross and cross compile the executable</span>
cargo install cross
cross build --release --target x86_64-pc-windows-gnu</pre></div>
<hr/>
<div dir="auto"><h2 tabindex="-1" dir="auto">Step 2: Install the Secrets Manager Agent<a name="user-content-secrets-manager-agent-install"></a></h2><a id="user-content-step-2-install-the-secrets-manager-agent" aria-label="Permalink: Step 2: Install the Secrets Manager Agent" href="#step-2-install-the-secrets-manager-agent"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Based on the type of compute, you have several options for installing the Secrets Manager Agent.</p>
<hr/>
<div dir="auto"><h4 tabindex="-1" dir="auto">[ Amazon EKS and Amazon ECS ]</h4><a id="user-content--amazon-eks-and-amazon-ecs-" aria-label="Permalink: [ Amazon EKS and Amazon ECS ]" href="#-amazon-eks-and-amazon-ecs-"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>To install the Secrets Manager Agent</strong></p>
<ol dir="auto">
<li>
<p dir="auto">Use the <code>install</code> script provided in the repository.</p>
<p dir="auto">The script generates a random SSRF token on startup and stores it in the file <code>/var/run/awssmatoken</code>. The token is readable by the <code>awssmatokenreader</code> group that the install script creates.</p>
</li>
<li>
<p dir="auto">To allow your application to read the token file, you need to add the user account that your application runs under to the <code>awssmatokenreader</code> group. For example, you can grant permissions for your application to read the token file with the following usermod command, where <em>&lt;APP_USER&gt;</em> is the user ID under which your application runs.</p>
<div dir="auto" data-snippet-clipboard-copy-content="sudo usermod -aG awssmatokenreader &lt;APP_USER&gt;"><pre>sudo usermod -aG awssmatokenreader <span>&lt;</span>APP_USER<span>&gt;</span></pre></div>
</li>
</ol>
<hr/>

<p dir="auto">You can run the Secrets Manager Agent as a sidecar container alongside your application by using Docker. Then your application can retrieve secrets from the local HTTP server the Secrets Manager Agent provides. For information about Docker, see the <a href="https://docs.docker.com" rel="nofollow">Docker documentation</a>.</p>
<p dir="auto"><strong>To create a sidecar container for the Secrets Manager Agent with Docker</strong></p>
<ol dir="auto">
<li>
<p dir="auto">Create a Dockerfile for the Secrets Manager Agent sidecar container. The following example creates a Docker container with the Secrets Manager Agent binary.</p>
<div dir="auto" data-snippet-clipboard-copy-content="# Use the latest Debian image as the base
FROM debian:latest

# Set the working directory inside the container
WORKDIR /app 

# Copy the Secrets Manager Agent binary to the container
COPY secrets-manager-agent . 

# Install any necessary dependencies
RUN apt-get update &amp;&amp; apt-get install -y ca-certificates 

# Set the entry point to run the Secrets Manager Agent binary
ENTRYPOINT [&#34;./secrets-manager-agent&#34;]"><pre><span><span>#</span> Use the latest Debian image as the base</span>
<span>FROM</span> debian:latest

<span><span>#</span> Set the working directory inside the container</span>
<span>WORKDIR</span> /app 

<span><span>#</span> Copy the Secrets Manager Agent binary to the container</span>
<span>COPY</span> secrets-manager-agent . 

<span><span>#</span> Install any necessary dependencies</span>
<span>RUN</span> apt-get update &amp;&amp; apt-get install -y ca-certificates 

<span><span>#</span> Set the entry point to run the Secrets Manager Agent binary</span>
<span>ENTRYPOINT</span> [<span>&#34;./secrets-manager-agent&#34;</span>]</pre></div>
</li>
<li>
<p dir="auto">Create a Dockerfile for your client application.</p>
</li>
<li>
<p dir="auto">Create a Docker Compose file to run both containers, being sure that they use the same network interface. This is necessary because the Secrets Manager Agent does not accept requests from outside the localhost interface. The following example shows a Docker Compose file where the <code>network_mode</code> key attaches the <code>secrets-manager-agent</code> container to the network namespace of the <code>client-application</code> container, which allows them to share the same network interface.
<strong>Important</strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="version: &#39;3&#39;
services:
    client-application:
    container_name: client-application
    build:
        context: .
        dockerfile: Dockerfile.client
    command: tail -f /dev/null  # Keep the container running
    

    secrets-manager-agent:
    container_name: secrets-manager-agent
    build:
        context: .
        dockerfile: Dockerfile.agent
    network_mode: &#34;container:client-application&#34;  # Attach to the client-application container&#39;s network
    depends_on:
        - client-application"><pre><span>version</span>: <span><span>&#39;</span>3<span>&#39;</span></span>
<span>services</span>:
    <span>client-application</span>:
    <span>container_name</span>: <span>client-application</span>
    <span>build</span>:
        <span>context</span>: <span>.</span>
        <span>dockerfile</span>: <span>Dockerfile.client</span>
    <span>command</span>: <span>tail -f /dev/null  </span><span><span>#</span> Keep the container running</span>
    

    <span>secrets-manager-agent</span>:
    <span>container_name</span>: <span>secrets-manager-agent</span>
    <span>build</span>:
        <span>context</span>: <span>.</span>
        <span>dockerfile</span>: <span>Dockerfile.agent</span>
    <span>network_mode</span>: <span><span>&#34;</span>container:client-application<span>&#34;</span></span>  <span><span>#</span> Attach to the client-application container&#39;s network</span>
    <span>depends_on</span>:
        - <span>client-application</span></pre></div>
</li>
<li>
<p dir="auto">Copy the <code>secrets-manager-agent</code> binary to the same directory that contains your Dockerfiles and Docker Compose file.</p>
</li>
<li>
<p dir="auto">Build and run the containers based on the provided Dockerfiles by using the following <a href="https://docs.docker.com/reference/cli/docker/compose/" rel="nofollow">https://docs.docker.com/reference/cli/docker/compose/</a> command.</p>
<div dir="auto" data-snippet-clipboard-copy-content="docker-compose up --build"><pre>docker-compose up --build</pre></div>
</li>
<li>
<p dir="auto">In your client container, you can now use the Secrets Manager Agent to retrieve secrets. For more information, see <a href="#secrets-manager-agent-call">Step 3: Retrieve secrets with the Secrets Manager Agent</a>.</p>
</li>
</ol>
<hr/>

<p dir="auto">You can package the Secrets Manager Agent as an AWS Lambda extension. Then you can add it to your Lambda function as a layer and call the Secrets Manager Agent from your Lambda function to get secrets. For an example script that shows how to run the Secrets Manager Agent as an extension, see <code>secrets-manager-agent-extension.sh</code> in <a href="https://github.com/aws/aws-secretsmanager-agent">https://github.com/aws/aws-secretsmanager-agent</a>.</p>
<p dir="auto"><strong>To create a Lambda extension that packages the Secrets Manager Agent</strong></p>
<ol dir="auto">
<li>
<p dir="auto">Create a ZIP file with the Secrets Manager Agent binary. For instructions, see <a href="https://docs.aws.amazon.com/lambda/latest/dg/packaging-layers.html" rel="nofollow">Packaging your layer content</a> in the <em>AWS Lambda Developer Guide</em>.</p>
</li>
<li>
<p dir="auto">Create a Lambda layer from the ZIP file. For instructions, see <a href="https://docs.aws.amazon.com/lambda/latest/dg/creating-deleting-layers.html" rel="nofollow">Creating layers</a> in the <em>AWS Lambda Developer Guide</em>.</p>
</li>
<li>
<p dir="auto">Add the layer to your Lambda function. For instructions, see <a href="https://docs.aws.amazon.com/lambda/latest/dg/adding-layers.html" rel="nofollow">Adding layers to functions</a> in the <em>AWS Lambda Developer Guide</em>.</p>
</li>
<li>
<p dir="auto">In your Lambda function code, you can now use the Secrets Manager Agent to retrieve secrets. For more information, see <a href="#secrets-manager-agent-call">Step 3: Retrieve secrets with the Secrets Manager Agent</a>.</p>
</li>
</ol>
<hr/>
<div dir="auto"><h2 tabindex="-1" dir="auto">Step 3: Retrieve secrets with the Secrets Manager Agent<a name="user-content-secrets-manager-agent-call"></a></h2><a id="user-content-step-3-retrieve-secrets-with-the-secrets-manager-agent" aria-label="Permalink: Step 3: Retrieve secrets with the Secrets Manager Agent" href="#step-3-retrieve-secrets-with-the-secrets-manager-agent"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To use the agent, you call the local Secrets Manager Agent endpoint and include the name or ARN of the secret as a query parameter. By default, the Secrets Manager Agent retrieves the <code>AWSCURRENT</code> version of the secret. To retrieve a different version, you can set <code>versionStage</code> or <code>versionId</code>.</p>
<p dir="auto">To help protect the Secrets Manager Agent, you must include a SSRF token header as part of each request: <code>X-Aws-Parameters-Secrets-Token</code>. The Secrets Manager Agent denies requests that don&#39;t have this header or that have an invalid SSRF token. You can customize the SSRF header name in the <a href="#secrets-manager-agent-config">Configuration file</a>.</p>
<p dir="auto">The Secrets Manager Agent uses the AWS SDK for Rust, which uses the <a href="https://docs.aws.amazon.com/sdk-for-rust/latest/dg/credentials.html" rel="nofollow">https://docs.aws.amazon.com/sdk-for-rust/latest/dg/credentials.html</a>. The identity of these IAM credentials determines the permissions the Secrets Manager Agent has to retrieve secrets.</p>
<p dir="auto">**Required permissions: **</p>
<ul dir="auto">
<li><code>secretsmanager:DescribeSecret</code></li>
<li><code>secretsmanager:GetSecretValue</code></li>
</ul>
<p dir="auto">For more information, see <a href="https://jvns.ca/aws/aws-secretsmanager-agent/blob/main/reference_iam-permissions.md">Permissions reference</a>.</p>
<p dir="auto"><strong>Important</strong></p>
<hr/>

<p dir="auto">The following curl example shows how to get a secret from the Secrets Manager Agent. The example relies on the SSRF being present in a file, which is where it is stored by the install script.</p>
<div dir="auto" data-snippet-clipboard-copy-content="curl -v -H \
    &#34;X-Aws-Parameters-Secrets-Token: $(&lt;/var/run/awssmatoken)&#34; \
    &#39;http://localhost:2773/secretsmanager/get?secretId=&lt;YOUR_SECRET_ID&gt;}&#39;; \
    echo"><pre>curl -v -H \
    <span><span>&#34;</span>X-Aws-Parameters-Secrets-Token: <span><span>$(</span><span>&lt;</span>/var/run/awssmatoken<span>)</span></span><span>&#34;</span></span> \
    <span><span>&#39;</span>http://localhost:2773/secretsmanager/get?secretId=&lt;YOUR_SECRET_ID&gt;}<span>&#39;</span></span><span>;</span> \
    <span>echo</span></pre></div>
<hr/>

<p dir="auto">The following Python example shows how to get a secret from the Secrets Manager Agent. The example relies on the SSRF being present in a file, which is where it is stored by the install script.</p>
<div dir="auto" data-snippet-clipboard-copy-content="import requests
import json

# Function that fetches the secret from Secrets Manager Agent for the provided secret id. 
def get_secret():
    # Construct the URL for the GET request
    url = f&#34;http://localhost:2773/secretsmanager/get?secretId=&lt;YOUR_SECRET_ID&gt;}&#34;

    # Get the SSRF token from the token file
    with open(&#39;/var/run/awssmatoken&#39;) as fp:
        token = fp.read() 

    headers = {
        &#34;X-Aws-Parameters-Secrets-Token&#34;: token.strip()
    }

    try:
        # Send the GET request with headers
        response = requests.get(url, headers=headers)

        # Check if the request was successful
        if response.status_code == 200:
            # Return the secret value
            return response.text
        else:
            # Handle error cases
            raise Exception(f&#34;Status code {response.status_code} - {response.text}&#34;)

    except Exception as e:
        # Handle network errors
        raise Exception(f&#34;Error: {e}&#34;)"><pre><span>import</span> <span>requests</span>
<span>import</span> <span>json</span>

<span># Function that fetches the secret from Secrets Manager Agent for the provided secret id. </span>
<span>def</span> <span>get_secret</span>():
    <span># Construct the URL for the GET request</span>
    <span>url</span> <span>=</span> f&#34;http://localhost:2773/secretsmanager/get?secretId=&lt;YOUR_SECRET_ID&gt;}&#34;

    <span># Get the SSRF token from the token file</span>
    <span>with</span> <span>open</span>(<span>&#39;/var/run/awssmatoken&#39;</span>) <span>as</span> <span>fp</span>:
        <span>token</span> <span>=</span> <span>fp</span>.<span>read</span>() 

    <span>headers</span> <span>=</span> {
        <span>&#34;X-Aws-Parameters-Secrets-Token&#34;</span>: <span>token</span>.<span>strip</span>()
    }

    <span>try</span>:
        <span># Send the GET request with headers</span>
        <span>response</span> <span>=</span> <span>requests</span>.<span>get</span>(<span>url</span>, <span>headers</span><span>=</span><span>headers</span>)

        <span># Check if the request was successful</span>
        <span>if</span> <span>response</span>.<span>status_code</span> <span>==</span> <span>200</span>:
            <span># Return the secret value</span>
            <span>return</span> <span>response</span>.<span>text</span>
        <span>else</span>:
            <span># Handle error cases</span>
            <span>raise</span> <span>Exception</span>(<span>f&#34;Status code <span><span>{</span><span>response</span>.<span>status_code</span><span>}</span></span> - <span><span>{</span><span>response</span>.<span>text</span><span>}</span></span>&#34;</span>)

    <span>except</span> <span>Exception</span> <span>as</span> <span>e</span>:
        <span># Handle network errors</span>
        <span>raise</span> <span>Exception</span>(<span>f&#34;Error: <span><span>{</span><span>e</span><span>}</span></span>&#34;</span>)</pre></div>
<hr/>
<div dir="auto"><h2 tabindex="-1" dir="auto">Configure the Secrets Manager Agent<a name="user-content-secrets-manager-agent-config"></a></h2><a id="user-content-configure-the-secrets-manager-agent" aria-label="Permalink: Configure the Secrets Manager Agent" href="#configure-the-secrets-manager-agent"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To change the configuration of the Secrets Manager Agent, create a <a href="https://toml.io/en/" rel="nofollow">TOML</a> config file, and then call <code>./aws-secrets-manager-agent --config config.toml</code>.</p>
<p dir="auto">The following list shows the options you can configure for the Secrets Manager Agent.</p>
<ul dir="auto">
<li><strong>log_level</strong> – The level of detail reported in logs for the Secrets Manager Agent: DEBUG, INFO, WARN, ERROR, or NONE. The default is INFO.</li>
<li><strong>http_port</strong> – The port for the local HTTP server, in the range 1024 to 65535. The default is 2773.</li>
<li><strong>region</strong> – The AWS Region to use for requests. If no Region is specified, the Secrets Manager Agent determines the Region from the SDK. For more information, see <a href="https://docs.aws.amazon.com/sdk-for-rust/latest/dg/credentials.html" rel="nofollow">Specify your credentials and default Region</a> in the <em>AWS SDK for Rust Developer Guide</em>.</li>
<li><strong>ttl_seconds</strong> – The TTL in seconds for the cached items, in the range 1 to 3600. The default is 300. This setting is not used if the cache size is 0.</li>
<li><strong>cache_size</strong> – The maximum number of secrets that can be stored in the cache, in the range 0 to 1000. 0 indicates that there is no caching. The default is 1000.</li>
<li><strong>ssrf_headers</strong> – A list of header names the Secrets Manager Agent checks for the SSRF token. The default is &#34;X-Aws-Parameters-Secrets-Token, X-Vault-Token&#34;.</li>
<li><strong>ssrf_env_variables</strong> – A list of environment variable names the Secrets Manager Agent checks for the SSRF token. The environment variable can contain the token or a reference to the token file as in: <code>AWS_TOKEN=file:///var/run/awssmatoken</code>. The default is &#34;AWS_TOKEN, AWS_SESSION_TOKEN&#34;.</li>
<li><strong>path_prefix</strong> – The URI prefix used to determine if the request is a path based request. The default is &#34;/v1/&#34;.</li>
<li><strong>max_conn</strong> – The maximum number of connections from HTTP clients that the Secrets Manager Agent allows, in the range 1 to 1000. The default is 800.</li>
</ul>

<p dir="auto">The Secrets Manager Agent logs errors locally to the file <code>logs/secrets_manager_agent.log</code>. When your application calls the Secrets Manager Agent to get a secret, those calls appear in the local log. They do not appear in the CloudTrail logs.</p>
<p dir="auto">The Secrets Manager Agent creates a new log file when the file reaches 10 MB, and it stores up to five log files total.</p>
<p dir="auto">The log does not go to Secrets Manager, CloudTrail, or CloudWatch. Requests to get secrets from the Secrets Manager Agent do not appear in those logs. When the Secrets Manager Agent makes a call to Secrets Manager to get a secret, that call is recorded in CloudTrail with a user agent string containing <code>aws-secrets-manager-agent</code>.</p>
<p dir="auto">You can configure logging in the <a href="#secrets-manager-agent-config">Configuration file</a>.</p>

<p dir="auto">The Secrets Manager Agent provides compatibility for legacy applications that access secrets through an existing agent or that need caching for langages not supported through other solutions.</p>
<p dir="auto">For an agent architecture, the domain of trust is where the agent endpoint and SSRF token are accessible, which is usually the entire host. The domain of trust for the Secrets Manager Agent should match the domain where the Secrets Manager credentials are available in order to maintain the same security posture. For example, on Amazon EC2 the domain of trust for the Secrets Manager Agent would be the same as the domain of the credentials when using roles for Amazon EC2.</p>
<p dir="auto">Security conscious applications that are not already using an agent solution with the Secrets Manager credentials locked down to the application should consider using the language-specific AWS SDKs or caching solutions. For more information, see <a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/retrieving-secrets.html" rel="nofollow">Get secrets</a>.</p>
</article></div></div>
  </body>
</html>
