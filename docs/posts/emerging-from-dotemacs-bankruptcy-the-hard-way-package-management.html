<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.evalapply.org/posts/emerging-from-dotemacs-bankruptcy-packages/index.html">Original</a>
    <h1>Emerging from dotemacs bankruptcy the hard way: package management</h1>
    
    <div id="readability-page-1" class="page"><div id="the-very-top"><main id="main"><article id="blog-post"><header><div><p>Emerging from dotemacs bankruptcy the hard way: package management</p><p>Elpa, Melpa, git repo. Vendor package straight from source. It compiled? Fetch some more! Elpa, Melpa, git repo. In more adult terms, we learn to use use-package to fetch, install, initialise, configure useful packages that enhance our Emacs experience.</p><hr/></div></header><section><p>A nearly half-century old community-run software project that bills itself <em>&#34;the advanced, extensible, customisable, self-documenting editor&#34;</em> <a href="#fn1" id="fnref1" role="doc-noteref"><sup>1</sup></a> is going to have an <em>interesting</em> customisation story. The following note may give you a more visceral sense of what I mean.</p><p>I ended up reading documentation for the built-in <code>auto-save-mode</code> function, as I want to configure a certain kind of auto-save behaviour <a href="#fn2" id="fnref2" role="doc-noteref"><sup>2</sup></a>. I noticed its documentation says <em>&#34;Probably introduced at or before Emacs version 1.6&#34;</em>. That is, version One point Six. <em>Probably</em>. Whereas the Emacs version history page<a href="#fn3" id="fnref3" role="doc-noteref"><sup>3</sup></a> goes back only to the point Emacs was announced to the public on Usenet, which was version 13.0, which was <em>Thirty Eight years</em> ago; i.e. auto save mode has been customisable far longer than that.</p><p>Generally speaking, there are three approaches to customisation.</p><ul><li>Using the GUI: The so-called &#34;Easy Customization Interface&#34; <a href="#fn4" id="fnref4" role="doc-noteref"><sup>4</sup></a>. This limits us to modifying values of variables exposed by modes and packages (which we can <code>M-x package-install</code>). This is pretty powerful in itself, but can get tedious and brittle to maintain and to repeat across machines.</li><li>Using elisp; whether written by others (packages, starter kits <a href="#fn5" id="fnref5" role="doc-noteref"><sup>5</sup></a>), or written by oneself (init file configurations, custom functions, &#34;defadvice&#34;s, and even bespoke major/minor modes).</li><li>Using X Options and Resources; which is obscure enough to appear in Appendix D of the GNU Emacs manual, so I am not even going there.</li></ul><p>And as with anything the effort investment is about &#34;build&#34; v/s &#34;buy&#34;. Writing a custom dotemacs (instead of just using a starter kit) is the &#34;build&#34; part, and using packages is &#34;buy&#34; part (which starter kits make ever so easy).</p><p>Part of the allure of starter kits is that they reduce the need to write a lot of boilerplate and/or repetitive elisp. <em>However</em> elisp can also write the boring elisp for us. And that is exactly what use-package does.</p><p>Lisp macrology FTW <a href="#fn6" id="fnref6" role="doc-noteref"><sup>6</sup></a>! For example…</p><p>The most basic use-package definition.</p><pre><code>(use-package delight)
</code></pre><p>Translates to…</p><pre><code>(macroexpand
 &#39;(use-package delight))
</code></pre><p>This elisp code…</p><pre><code>(use-package-ensure-elpa &#39;delight &#39;(t) &#39;nil)
(require &#39;delight nil nil)
</code></pre><p>That was not very impressive, visually-speaking. A more typical definition with some basic customisations is more eye-opening.</p><pre><code>(use-package company
    :bind (:map global-map ; because we make company-mode global
                (&#34;TAB&#34; . company-complete-common-or-cycle))
    :config
    (setq company-idle-delay 0.1)
    (global-company-mode t)
    :diminish)
</code></pre><p>Let&#39;s <code>macroexpand</code> that whole form.</p><pre><code>(macroexpand
 &#39;(use-package company
    :bind (:map global-map ; because we make company-mode global
                (&#34;TAB&#34; . company-complete-common-or-cycle))
    :config
    (setq company-idle-delay 0.1)
    (global-company-mode t)
    :diminish))
</code></pre><p>The result is code we would have to hand-write if we chose to do the same with regular elisp <em>and</em> the <code>bind-keys</code> macro provided by the <code>bind-keys</code> package, which comes bundled with <code>use-package</code>. Meaning, if we did not have a utility package like <code>bind-keys</code>, we would end up writing even more elisp to <em>safely</em> bind keys <a href="#fn7" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</p><pre><code>(use-package-ensure-elpa &#39;company &#39;(t) &#39;nil)

(unless (fboundp &#39;company-complete-common-or-cycle)
  (autoload #&#39;company-complete-common-or-cycle &#34;company&#34; nil t))

(eval-after-load &#39;company
  &#39;(progn (setq company-idle-delay 0.1)
          (global-company-mode t)
          (if (fboundp &#39;diminish)
              (diminish &#39;company-mode)) t))

(bind-keys
 :package company
 :map global-map
 (&#34;TAB&#34; . company-complete-common-or-cycle))
</code></pre><p>Starter kits like <code>prelude</code>, <code>spacemacs</code>, or <code>doom-emacs</code> do just this sort of elisp heavy lifting for us. I like those, but I feel <code>use-package</code> is in a class of its own. A fantastic utility with an elegant interface that delivers handsomely on its sales pitch. For example:</p><ul><li><a href="https://github.com/jwiegley/dot-emacs">jwiegley&#39;s own dotemacs</a> of course (excellent reference material, but fairly intimidating to me, to begin with)</li><li>M&#39;colleague Suvrat&#39;s <a href="https://github.com/suvratapte/dot-emacs-dot-d/">dotemacs</a> exemplifies the tidiness I seek.</li><li>Ian Y.E. Pan&#39;s <a href="https://ianyepan.github.io/posts/setting-up-use-package/">most approachable use-package tutorial</a> eased me into a useful mental model that I am currently working with.</li></ul><p>So that completes the <code>use-package</code> story.</p><p>Going further, I want to move my workflow to the &#34;new&#34; Emacs as fast as possible. So to begin with, I chose to enhance code completions (company-mode), lisp editing (paredit), and version control (magit). Now developing my dotemacs in my new Emacs is nicer!</p><p>The init.el so far (<a href="https://github.com/emerging-from-dotemacs-bankruptcy-init-begins/index.html">previously</a>)…</p><details><summary><code>Enhanced Lisp editing, using use-package</code><hr/></summary><pre><code>;;; init.el  -*- lexical-binding: t -*-  --- My Emacs configuration.

;;; Commentary:

;;; This file is not part of GNU Emacs.

;;; Author: Aditya Athalye
;;; Created on: 30 June 2023
;;; Copyright (c) 2023 Aditya Athalye

;;; License:
;;; This program is free software; you can redistribute it and/or
;;; modify it under the terms of the MIT license, which is included
;;; with this distribution. See the LICENCE.txt file.

;;; Code:

;; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; Globals
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;; Always load newest byte code
(setq load-prefer-newer t) ; cf. bbatsov/prelude

;; Directory structure
;; Take clues from bbatsov/prelude, except keep structure relative to our
;; initial dotemacs-dir path. This way we can start the user&#39;s emacs via
;; ~/.emacs.d symlinked to the dotemacs repo, and develop/debug against
;; the repo without potentially overwriting transient state files of the
;; daily driver .emacs.d.
(defvar dotemacs-dir
  (file-name-directory (or load-file-name (buffer-file-name)))
  &#34;The dotemacs&#39; root.  Normally it should be ~/.emacs.d.&#34;)

(defvar dotemacs-savefile-dir (expand-file-name &#34;savefile&#34; dotemacs-dir)
  &#34;This folder stores all the automatically generated save/history-files.&#34;)
(unless (file-exists-p dotemacs-savefile-dir)
  (make-directory dotemacs-savefile-dir))

;; Make emacs add customisations here, instead of the init file.
;; Usually customisations made from the UI go into custom-file.
(setq custom-file (expand-file-name &#34;custom.el&#34; dotemacs-dir))
(unless (file-exists-p custom-file)
  (make-empty-file custom-file))

;; Sundries
(setq indent-tabs-mode nil) ; no hard tabs
(setq create-lockfiles nil) ; no lockfiles
(setq ring-bell-function &#39;ignore) ;

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; Visual Aesthetics
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(setq inhibit-startup-message t)

;; More screen real estate
(scroll-bar-mode 0)
(tool-bar-mode 0)
(menu-bar-mode 0)
(set-fringe-mode &#39;(5 . 13)) ;; describe variable fringe-mode

;; Go easy on the eyes
;; This high-contrast darkmode theme is built into Emacs as of
;; Emacs version 28.1
(load-theme &#39;modus-vivendi)


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; Package management
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(require &#39;package)
;; Explicitly set the exact package archives list
(setq package-archives &#39;((&#34;melpa&#34; . &#34;https://melpa.org/packages/&#34;)
                         (&#34;org&#34; . &#34;https://orgmode.org/elpa/&#34;)
                         (&#34;elpa&#34; . &#34;https://elpa.gnu.org/packages/&#34;)))
;; Set package download directory relative to the dotemacs-dir
(setq package-user-dir (expand-file-name &#34;elpa&#34; dotemacs-dir))

(package-initialize)
(unless package-archive-contents
  (package-refresh-contents))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; Use use-package
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;; Ian Y.E. Pan&#39;s tutorial is a nice quick overview.
;; https://ianyepan.github.io/posts/setting-up-use-package/

(unless (package-installed-p &#39;use-package)
  (package-install &#39;use-package))

(require &#39;use-package)
(setq use-package-always-ensure t)
(setq use-package-expand-minimally t) ; set nil to debug use-package forms

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; All the packages!
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;;; Packages useful to configure packages
(use-package diminish)
(use-package delight)

;;; COMplete ANYthing, please!
;;; h/t suvratapte/dot-emacs-dot-d
(use-package company
  :bind (:map global-map
              (&#34;TAB&#34; . company-complete-common-or-cycle))
  :config
  (setq company-idle-delay 0.1)
  (global-company-mode t)
  :diminish)

;;; General code editing
(global-display-line-numbers-mode 1)

;;; Lispy editing support

;; Tweak settings of built-in paren package
(use-package paren
  :ensure nil ; it already exists, don&#39;t try to search online
  :init
  (setq show-paren-delay 0)
  :config
  (show-paren-mode t)
  :diminish)

(use-package paredit
  :init
  (add-hook &#39;emacs-lisp-mode-hook #&#39;enable-paredit-mode)
  :bind
  ((&#34;M-[&#34; . paredit-wrap-square)
   (&#34;M-{&#34; . paredit-wrap-curly))
  :diminish)

(use-package magit
  :diminish)

(provide &#39;init)
;;; init.el ends here
</code></pre></details><p>Our current place in the rough plan:</p><ul><li>[✓] Set the very preliminaries.</li><li>[✓] Set up package management. I&#39;ll probably stick with the old familiars; elpa and melpa. I&#39;m not sure about straight.el at this time.</li><li>[✓] Choose <code>use-package</code> to get and configure each package. I like how neat configs are, when defined with use-package.</li><li>[WIP] Make completions and &#34;getting about&#34; work (the right mix of ivy, consul, swiper, company, helm, imenu). Someone mentioned newer alternatives to helm. Have a look at that.</li><li>[WIP] Fix general text editing stuff (keybindings, multiple cursors, snippets etc.)</li><li>[WIP] Add support for favourite programming languages.<ul><li>[✓] Emacs Lisp</li><li>many others…</li></ul></li><li>org-mode specifics</li><li>then let&#39;s see…</li></ul><p>Next, I will fully enhance completions and code/text navigation. It will make <em>all</em> my programming and writing <em>much</em> more ergonomic. And it will help me straighten my mental model about why and how to make those enhancements.</p></section></article></main></div></div>
  </body>
</html>
