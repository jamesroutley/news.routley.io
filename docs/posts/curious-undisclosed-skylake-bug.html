<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://outerproduct.net/trivial/2023-02-05_comp-dep.html">Original</a>
    <h1>Curious Undisclosed Skylake Bug</h1>
    
    <div id="readability-page-1" class="page">                <em>2023-02-05</em><p>CPUs running Intel’s Skylake-X microarchitecture have a curious bug that I haven’t seen mentioned anywhere: the AVX-512 compression instructions have a false dependency on their destination.
In other words, the following two instructions have identical performance characteristics:</p><pre>vcompressps	<i>X</i>{<i>k</i>}, <i>Y</i>
vcompressps	<i>X</i>{<i>k</i>}{z}, <i>Y</i></pre><p>Whereas we would expect the latter to depend only on <i><span>k</span></i> and <i><span>Y</span></i>, it also depends on <i><span>X</span></i>.
The problem seems to have been fixed in Icelake.
Surprisingly, while it affects all compression operations, it does not affect any of the expansion operations.
Presumably, this is related to the odd behaviour of compression with a memory destination; expansion can’t target memory.</p><p>One thing I have never understood is why compression and expansion operations pun on the operation mask, instead of using it for its ordinary purpose and using a separate mask to specify the lanes to be compressed from or expanded to.
There is certainly space in the instruction encoding for it.
And these operations are slow enough that it seems unlikely adding a mask would have slowed them down further.
The semantics have to be figured out, but they can be figured out (I would just and the two masks together), and the result would be strictly more expressive.</p><p>My benchmarking code is <a href="https://outerproduct.net/trivial/2023-02-05_comp-dep.c">here</a>.
On a system which has the bug, it should print two large numbers and two small numbers; on a system which does not have the bug, it should print one large number and three small numbers.</p>
                </div>
  </body>
</html>
