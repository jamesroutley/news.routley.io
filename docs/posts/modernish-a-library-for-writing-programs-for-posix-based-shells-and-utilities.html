<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/modernish/modernish">Original</a>
    <h1>Modernish – A library for writing programs for POSIX-based shells and utilities</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text"><p dir="auto"><strong><a href="https://github.com/modernish/modernish/releases">Releases</a></strong></p>
<p dir="auto"><strong>For code examples, see
<a href="https://github.com/modernish/modernish/blob/master/EXAMPLES.md">
<code>EXAMPLES.md</code></a>
and
<a href="https://github.com/modernish/modernish/tree/master/share/doc/modernish/examples">
<code>share/doc/modernish/examples</code></a>
</strong></p>

<ul dir="auto">
<li><em>Sick of quoting hell and split/glob pitfalls?</em></li>
<li><em>Tired of brittle shell scripts going haywire and causing damage?</em></li>
<li><em>Mystified by line noise commands like <code>[</code>, <code>[[</code>, <code>((</code> ?</em></li>
<li><em>Is scripting basic things just too hard?</em></li>
<li><em>Ever wish that <code>find</code> were a built-in shell loop?</em></li>
<li><em>Do you want your script to work on nearly any shell on any Unix-like OS?</em></li>
</ul>
<p dir="auto">Modernish is a library for shell script programming which provides features
like safer variable and command expansion, new language constructs for loop
iteration, and much more. Modernish programs are shell programs; the new
constructs are mixed with shell syntax so that the programmer can take
advantage of the best of both.</p>
<p dir="auto">There is no compiled code to install, as modernish is written entirely in the
shell language. It can be deployed in embedded or multi-user systems in which
new binary executables may not be introduced for security reasons, and is
portable among numerous shell implementations. The installer can also
<a href="#user-content-appendix-f-bundling-modernish-with-your-script">bundle</a>
a reduced copy of the library with your scripts, so they can run portably with
a known version of modernish without requiring prior installation.</p>
<p dir="auto"><strong>Join us and help breathe some new life into the shell!</strong> We
are looking for testers, early adopters, and developers to join us.
<a href="https://github.com/modernish/modernish/releases">Download the latest release</a>
or check out the very latest development code from the master branch.
Read through the documentation below. Play with the example scripts and
write your own. Try to break the library and send reports of breakage.</p>

<ul dir="auto">
<li><a href="#user-content-getting-started">Getting started</a></li>
<li><a href="#user-content-two-basic-forms-of-a-modernish-program">Two basic forms of a modernish program</a>
<ul dir="auto">
<li><a href="#user-content-simple-form">Simple form</a></li>
<li><a href="#user-content-portable-form">Portable form</a></li>
</ul>
</li>
<li><a href="#user-content-interactive-use">Interactive use</a></li>
<li><a href="#user-content-non-interactive-command-line-use">Non-interactive command line use</a>
<ul dir="auto">
<li><a href="#user-content-non-interactive-usage-examples">Non-interactive usage examples</a></li>
</ul>
</li>
<li><a href="#user-content-shell-capability-detection">Shell capability detection</a></li>
<li><a href="#user-content-names-and-identifiers">Names and identifiers</a>
<ul dir="auto">
<li><a href="#user-content-internal-namespace">Internal namespace</a></li>
<li><a href="#user-content-modernish-system-constants">Modernish system constants</a></li>
<li><a href="#user-content-control-character-whitespace-and-shell-safe-character-constants">Control character, whitespace and shell-safe character constants</a></li>
</ul>
</li>
<li><a href="#user-content-reliable-emergency-halt">Reliable emergency halt</a></li>
<li><a href="#user-content-low-level-shell-utilities">Low-level shell utilities</a>
<ul dir="auto">
<li><a href="#user-content-outputting-strings">Outputting strings</a></li>
<li><a href="#user-content-legibility-aliases-not-so-forever">Legibility aliases: <code>not</code>, <code>so</code>, <code>forever</code></a></li>
<li><a href="#user-content-enhanced-exit">Enhanced <code>exit</code></a></li>
<li><a href="#user-content-chdir"><code>chdir</code></a></li>
<li><a href="#user-content-insubshell"><code>insubshell</code></a></li>
<li><a href="#user-content-isset"><code>isset</code></a></li>
<li><a href="#user-content-setstatus"><code>setstatus</code></a></li>
</ul>
</li>
<li><a href="#user-content-testing-numbers-strings-and-files">Testing numbers, strings and files</a>
<ul dir="auto">
<li><a href="#user-content-integer-number-arithmetic-tests-and-operations">Integer number arithmetic tests and operations</a>
<ul dir="auto">
<li><a href="#user-content-the-arithmetic-command-let">The arithmetic command <code>let</code></a></li>
<li><a href="#user-content-arithmetic-shortcuts">Arithmetic shortcuts</a></li>
</ul>
</li>
<li><a href="#user-content-string-and-file-tests">String and file tests</a>
<ul dir="auto">
<li><a href="#user-content-string-tests">String tests</a>
<ul dir="auto">
<li><a href="#user-content-unary-string-tests">Unary string tests</a></li>
<li><a href="#user-content-binary-string-matching-tests">Binary string matching tests</a></li>
<li><a href="#user-content-multi-matching-option">Multi-matching option</a></li>
</ul>
</li>
<li><a href="#user-content-file-type-tests">File type tests</a></li>
<li><a href="#user-content-file-comparison-tests">File comparison tests</a></li>
<li><a href="#user-content-file-status-tests">File status tests</a></li>
<li><a href="#user-content-io-tests">I/O tests</a></li>
<li><a href="#user-content-file-permission-tests">File permission tests</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#user-content-the-stack">The stack</a>
<ul dir="auto">
<li><a href="#user-content-the-shell-options-stack">The shell options stack</a></li>
<li><a href="#user-content-the-trap-stack">The trap stack</a></li>
</ul>
</li>
<li><a href="#user-content-modules">Modules</a>
<ul dir="auto">
<li><a href="#user-content-use-safe"><code>use safe</code></a>
<ul dir="auto">
<li><a href="#user-content-why-the-safe-mode">Why the safe mode?</a></li>
<li><a href="#user-content-how-the-safe-mode-works">How the safe mode works</a></li>
<li><a href="#user-content-important-notes-for-safe-mode">Important notes for safe mode</a></li>
<li><a href="#user-content-extra-options-for-the-safe-mode">Extra options for the safe mode</a></li>
</ul>
</li>
<li><a href="#user-content-use-varloop"><code>use var/loop</code></a>
<ul dir="auto">
<li><a href="#user-content-simple-repeat-loop">Simple repeat loop</a></li>
<li><a href="#user-content-basic-style-arithmetic-for-loop">BASIC-style arithmetic <code>for</code> loop</a></li>
<li><a href="#user-content-c-style-arithmetic-for-loop">C-style arithmetic <code>for</code> loop</a></li>
<li><a href="#user-content-enumerative-forselect-loop-with-safe-splitglob">Enumerative <code>for</code>/<code>select</code> loop with safe split/glob</a></li>
<li><a href="#user-content-the-find-loop">The <code>find</code> loop</a>
<ul dir="auto">
<li><a href="#user-content-available-options">Available <em>options</em></a></li>
<li><a href="#user-content-available-find-expression-operands">Available <em>find-expression</em> operands</a></li>
<li><a href="#user-content-picking-a-find-utility">Picking a <code>find</code> utility</a></li>
<li><a href="#user-content-compatibility-mode-for-obsolete-find-utilities">Compatibility mode for obsolete <code>find</code> utilities</a></li>
<li><a href="#user-content-find-loop-usage-examples"><code>find</code> loop usage examples</a></li>
</ul>
</li>
<li><a href="#user-content-creating-your-own-loop">Creating your own loop</a></li>
</ul>
</li>
<li><a href="#user-content-use-varlocal"><code>use var/local</code></a>
<ul dir="auto">
<li><a href="#user-content-important-varlocal-usage-notes">Important <code>var/local</code> usage notes</a></li>
</ul>
</li>
<li><a href="#user-content-use-vararith"><code>use var/arith</code></a>
<ul dir="auto">
<li><a href="#user-content-arithmetic-operator-shortcuts">Arithmetic operator shortcuts</a></li>
<li><a href="#user-content-arithmetic-comparison-shortcuts">Arithmetic comparison shortcuts</a></li>
</ul>
</li>
<li><a href="#user-content-use-varassign"><code>use var/assign</code></a></li>
<li><a href="#user-content-use-varreadf"><code>use var/readf</code></a></li>
<li><a href="#user-content-use-varshellquote"><code>use var/shellquote</code></a>
<ul dir="auto">
<li><a href="#user-content-shellquote"><code>shellquote</code></a></li>
<li><a href="#user-content-shellquoteparams"><code>shellquoteparams</code></a></li>
</ul>
</li>
<li><a href="#user-content-use-varstack"><code>use var/stack</code></a>
<ul dir="auto">
<li><a href="#user-content-use-varstackextra"><code>use var/stack/extra</code></a></li>
<li><a href="#user-content-use-varstacktrap"><code>use var/stack/trap</code></a>
<ul dir="auto">
<li><a href="#user-content-trap-stack-compatibility-considerations">Trap stack compatibility considerations</a></li>
<li><a href="#user-content-the-new-die-pseudosignal">The new <code>DIE</code> pseudosignal</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#user-content-use-varstring"><code>use var/string</code></a>
<ul dir="auto">
<li><a href="#user-content-use-varstringtouplow"><code>use var/string/touplow</code></a></li>
<li><a href="#user-content-use-varstringtrim"><code>use var/string/trim</code></a></li>
<li><a href="#user-content-use-varstringreplacein"><code>use var/string/replacein</code></a></li>
<li><a href="#user-content-use-varstringappend"><code>use var/string/append</code></a></li>
</ul>
</li>
<li><a href="#user-content-use-varunexport"><code>use var/unexport</code></a></li>
<li><a href="#user-content-use-vargenoptparser"><code>use var/genoptparser</code></a></li>
<li><a href="#user-content-use-sysbase"><code>use sys/base</code></a>
<ul dir="auto">
<li><a href="#user-content-use-sysbasemktemp"><code>use sys/base/mktemp</code></a></li>
<li><a href="#user-content-use-sysbasereadlink"><code>use sys/base/readlink</code></a></li>
<li><a href="#user-content-use-sysbaserev"><code>use sys/base/rev</code></a></li>
<li><a href="#user-content-use-sysbaseseq"><code>use sys/base/seq</code></a>
<ul dir="auto">
<li><a href="#user-content-differences-with-gnu-and-bsd-seq">Differences with GNU and BSD <code>seq</code></a></li>
</ul>
</li>
<li><a href="#user-content-use-sysbaseshuf"><code>use sys/base/shuf</code></a></li>
<li><a href="#user-content-use-sysbasetac"><code>use sys/base/tac</code></a></li>
<li><a href="#user-content-use-sysbasewhich"><code>use sys/base/which</code></a></li>
<li><a href="#user-content-use-sysbaseyes"><code>use sys/base/yes</code></a></li>
</ul>
</li>
<li><a href="#user-content-use-syscmd"><code>use sys/cmd</code></a>
<ul dir="auto">
<li><a href="#user-content-use-syscmdextern"><code>use sys/cmd/extern</code></a></li>
<li><a href="#user-content-use-syscmdharden"><code>use sys/cmd/harden</code></a>
<ul dir="auto">
<li><a href="#user-content-important-note-on-variable-assignments">Important note on variable assignments</a></li>
<li><a href="#user-content-hardening-while-allowing-for-broken-pipes">Hardening while allowing for broken pipes</a></li>
<li><a href="#user-content-tracing-the-execution-of-hardened-commands">Tracing the execution of hardened commands</a></li>
<li><a href="#user-content-simple-tracing-of-commands">Simple tracing of commands</a></li>
</ul>
</li>
<li><a href="#user-content-use-syscmdmapr"><code>use sys/cmd/mapr</code></a>
<ul dir="auto">
<li><a href="#user-content-differences-from-mapfile">Differences from <code>mapfile</code></a></li>
<li><a href="#user-content-differences-from-xargs">Differences from <code>xargs</code></a></li>
</ul>
</li>
<li><a href="#user-content-use-syscmdprocsubst"><code>use sys/cmd/procsubst</code></a></li>
<li><a href="#user-content-use-syscmdsource"><code>use sys/cmd/source</code></a></li>
</ul>
</li>
<li><a href="#user-content-use-sysdir"><code>use sys/dir</code></a>
<ul dir="auto">
<li><a href="#user-content-use-sysdircountfiles"><code>use sys/dir/countfiles</code></a></li>
<li><a href="#user-content-use-sysdirmkcd"><code>use sys/dir/mkcd</code></a></li>
</ul>
</li>
<li><a href="#user-content-use-systerm"><code>use sys/term</code></a>
<ul dir="auto">
<li><a href="#user-content-use-systermputr"><code>use sys/term/putr</code></a></li>
<li><a href="#user-content-use-systermreadkey"><code>use sys/term/readkey</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#user-content-appendix-a-list-of-shell-cap-ids">Appendix A: List of shell cap IDs</a>
<ul dir="auto">
<li><a href="#user-content-capabilities">Capabilities</a></li>
<li><a href="#user-content-quirks">Quirks</a></li>
<li><a href="#user-content-bugs">Bugs</a></li>
<li><a href="#user-content-warning-ids">Warning IDs</a></li>
</ul>
</li>
<li><a href="#user-content-appendix-b-regression-test-suite">Appendix B: Regression test suite</a>
<ul dir="auto">
<li><a href="#user-content-difference-between-capability-detection-and-regression-tests">Difference between capability detection and regression tests</a></li>
<li><a href="#user-content-testing-modernish-on-all-your-shells">Testing modernish on all your shells</a></li>
</ul>
</li>
<li><a href="#user-content-appendix-c-supported-locales">Appendix C: Supported locales</a></li>
<li><a href="#user-content-appendix-d-supported-shells">Appendix D: Supported shells</a></li>
<li><a href="#user-content-appendix-e-zsh-integration-with-native-scripts">Appendix E: zsh: integration with native scripts</a></li>
<li><a href="#user-content-appendix-f-bundling-modernish-with-your-script">Appendix F: Bundling modernish with your script</a></li>
</ul>

<p dir="auto">Run <code>install.sh</code> and follow instructions, choosing your preferred shell
and install location. After successful installation you can run modernish
shell scripts and write your own. Run <code>uninstall.sh</code> to remove modernish.</p>
<p dir="auto">Both the install and uninstall scripts are interactive by default, but
support fully automated (non-interactive) operation as well. Command
line options are as follows:</p>
<p dir="auto"><code>install.sh</code> [ <code>-n</code> ] [ <code>-s</code> <em>shell</em> ] [ <code>-f</code> ] [ <code>-P</code> <em>pathspec</em> ]
[ <code>-d</code> <em>installroot</em> ] [ <code>-D</code> <em>prefix</em> ] [ <code>-B</code> <em>scriptfile</em> ... ]</p>
<ul dir="auto">
<li><code>-n</code>: non-interactive operation</li>
<li><code>-s</code>: specify default shell to execute modernish</li>
<li><code>-f</code>: force unconditional installation on specified shell</li>
<li><code>-P</code>: specify an alternative <a href="#user-content-modernish-system-constants"><code>DEFPATH</code></a>
for the installation (be careful; usually <em>not</em> recommended)</li>
<li><code>-d</code>: specify root directory for installation</li>
<li><code>-D</code>: extra destination directory prefix (for packagers)</li>
<li><code>-B:</code> bundle modernish with your scripts (<code>-D</code> required, <code>-n</code> implied), see
<a href="#user-content-appendix-f-bundling-modernish-with-your-script">Appendix F</a></li>
</ul>
<p dir="auto"><code>uninstall.sh</code> [ <code>-n</code> ] [ <code>-f</code> ] [ <code>-d</code> <em>installroot</em> ]</p>
<ul dir="auto">
<li><code>-n</code>: non-interactive operation</li>
<li><code>-f</code>: delete <code>*/modernish</code> directories even if files left</li>
<li><code>-d</code>: specify root directory of modernish installation to uninstall</li>
</ul>
<div dir="auto"><h2 tabindex="-1" dir="auto">Two basic forms of a modernish program</h2><a id="user-content-two-basic-forms-of-a-modernish-program" aria-label="Permalink: Two basic forms of a modernish program" href="#two-basic-forms-of-a-modernish-program"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">In the <em>simple form</em>, modernish is added to a script written for a specific
shell. In the <em>portable form</em>, your script is shell-agnostic and may run on any
<a href="#user-content-appendix-d-supported-shells">shell that can run modernish</a>.</p>

<p dir="auto">The <strong>simplest</strong> way to write a modernish program is to source modernish as a
dot script. For example, if you write for bash:</p>
<div dir="auto" data-snippet-clipboard-copy-content="#! /bin/bash
. modernish
use safe
use sys/base
...your program starts here..."><pre><span><span>#!</span> /bin/bash</span>
<span>.</span> modernish
use safe
use sys/base
...your program starts here...</pre></div>
<p dir="auto">The modernish <code>use</code> command load modules with optional functionality. The
<code>safe</code> module initialises the <a href="#user-content-use-safe">safe mode</a>.
The <code>sys/base</code> module contains modernish versions of certain basic but
non-standardised utilities (e.g. <code>readlink</code>, <code>mktemp</code>, <code>which</code>), guaranteeing
that modernish programs all have a known version at their disposal. There are
many other modules as well. See <a href="#user-content-modules">Modules</a> for more
information.</p>
<p dir="auto">The above method makes the program dependent on one particular shell (in this
case, bash). So it is okay to mix and match functionality specific to that
particular shell with modernish functionality.</p>
<p dir="auto">(On <strong>zsh</strong>, there is a way to integrate modernish with native zsh scripts. See
<a href="#user-content-appendix-e-zsh-integration-with-native-scripts">Appendix E</a>.)</p>

<p dir="auto">The <strong>most portable</strong> way to write a modernish program is to use the special
generic hashbang path for modernish programs. For example:</p>
<div dir="auto" data-snippet-clipboard-copy-content="#! /usr/bin/env modernish
#! use safe
#! use sys/base
...your program begins here..."><pre><span><span>#!</span> /usr/bin/env modernish</span>
<span><span>#!</span> use safe</span>
<span><span>#!</span> use sys/base</span>
...your program begins here...</pre></div>
<p dir="auto">For portability, it is important there is no space after <code>env modernish</code>;
NetBSD and OpenBSD consider trailing spaces part of the name, so <code>env</code> will
fail to find modernish.</p>
<p dir="auto">A program in this form is executed by whatever shell the user who installed
modernish on the local system chose as the default shell. Since you as the
programmer can&#39;t know what shell this is (other than the fact that it passed
some rigorous POSIX compliance testing executed by modernish), a program in
this form <em>must be strictly POSIX compliant</em> – except, of course, that it
should also make full use of the rich functionality offered by modernish.</p>
<p dir="auto">Note that modules are loaded in a different way: the <code>use</code> commands are part of
hashbang comment (starting with <code>#!</code> like the initial hashbang path). Only such
lines that <em>immediately</em> follow the initial hashbang path are evaluated; even
an empty line in between causes the rest to be ignored.
This special way of pre-loading modules is needed to make any aliases they
define work reliably on all shells.</p>

<p dir="auto">Modernish is primarily designed to enhance shell programs/scripts, but also
offers features for use in interactive shells. For instance, the new <code>repeat</code>
loop construct from the <code>var/loop</code> module can be quite practical to repeat
an action x times, and the <code>safe</code> module on interactive shells provides
convenience functions for manipulating, saving and restoring the state of
field splitting and globbing.</p>
<p dir="auto">To use modernish on your favourite interactive shell, you have to add it to
your <code>.profile</code>, <code>.bashrc</code> or similar init file.</p>
<p dir="auto"><strong>Important:</strong> Upon initialising, modernish adapts itself to
other settings, such as the locale. It also removes certain aliases that
may keep modernish from initialising properly. So you have to organise your
<code>.profile</code> or similar file in the following order:</p>
<ul dir="auto">
<li><em>first</em>, define general system settings (<code>PATH</code>, locale, etc.);</li>
<li><em>then</em>, <code>. modernish</code> and <code>use</code> any modules you want;</li>
<li><em>then</em> define anything that may depend on modernish, and set your aliases.</li>
</ul>
<div dir="auto"><h2 tabindex="-1" dir="auto">Non-interactive command line use</h2><a id="user-content-non-interactive-command-line-use" aria-label="Permalink: Non-interactive command line use" href="#non-interactive-command-line-use"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">After installation, the <code>modernish</code> command can be invoked as if it were a
shell, with the standard command line options from other shells (such as
<code>-c</code> to specify a command or script directly on the command line), plus some
enhancements. The effect is that the shell chosen at installation time will
be run enhanced with modernish functionality. It is not possible to use
modernish as an interactive shell in this way.</p>
<p dir="auto">Usage:</p>
<ol dir="auto">
<li><code>modernish</code> [ <code>--use=</code><em>module</em> | <em>shelloption</em> ... ]
[ <em>scriptfile</em> ] [ <em>arguments</em> ]</li>
<li><code>modernish</code> [ <code>--use=</code><em>module</em> | <em>shelloption</em> ... ]
<code>-c</code> [ <em>script</em> [ <em>me-name</em> [ <em>arguments</em> ] ] ]</li>
<li><code>modernish --test</code> [ <em>testoption</em> ... ]</li>
<li><code>modernish</code> [ <code>--version</code> | <code>--help</code> ]</li>
</ol>
<p dir="auto">In the first form, the script in the file <em>scriptfile</em> is
loaded and executed with any <em>arguments</em> assigned to the positional parameters.</p>
<p dir="auto">In the second form, <code>-c</code> executes the specified modernish
<em>script</em>, optionally with the <em>me-name</em> assigned to <code>$ME</code> and the
<em>arguments</em> assigned to the positional parameters.</p>
<p dir="auto">The <code>--use</code> option pre-loads any given modernish <a href="#user-content-modules">modules</a>
before executing the script.
The <em>module</em> argument to each specified <code>--use</code> option is split using
standard shell field splitting. The first field is the module name and any
further fields become arguments to that module&#39;s initialisation routine.</p>
<p dir="auto">Any given short-form or long-form <em>shelloption</em>s are
set or unset before executing the script. Both POSIX
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_25_03" rel="nofollow">shell options</a>
and shell-specific options are supported, depending on
<a href="#user-content-appendix-d-supported-shells">the shell executing modernish</a>.
Using the shell option <code>-e</code> or <code>-o errexit</code> is an error, because modernish
<a href="#user-content-use-syscmdharden">does not support it</a> and
would break.</p>
<p dir="auto">The <code>--test</code> option runs the regression test suite and exits. This verifies
that the modernish installation is functioning correctly. See
<a href="#user-content-appendix-b-regression-test-suite">Appendix B</a>
for more information.</p>
<p dir="auto">The <code>--version</code> and <code>--help</code> options output the relative information and exit.</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Non-interactive usage examples</h3><a id="user-content-non-interactive-usage-examples" aria-label="Permalink: Non-interactive usage examples" href="#non-interactive-usage-examples"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>Count to 10 using a <a href="#user-content-use-varloop">basic loop</a>:</li>
<li>Run a <a href="#user-content-portable-form">portable-form</a>
modernish program using zsh and enhanced-prompt xtrace:</li>
</ul>
<div dir="auto"><h2 tabindex="-1" dir="auto">Shell capability detection</h2><a id="user-content-shell-capability-detection" aria-label="Permalink: Shell capability detection" href="#shell-capability-detection"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Modernish includes a battery of shell feature, quirk and bug detection
tests, each of which is given a special capability ID.
See <a href="#user-content-appendix-a-list-of-shell-cap-ids">Appendix A</a> for a
list of shell capabilities that modernish currently detects, as well
as further general information on the capability detection framework.</p>
<p dir="auto"><code>thisshellhas</code> is the central function of the capability detection
framework. It not only tests for the presence of shell features/quirks/bugs,
but can also detect specific shell built-in commands, shell reserved words,
shell options (short or long form), and signals.</p>
<p dir="auto">Modernish itself extensively uses capability detection to adapt itself to the
shell it&#39;s running on. This is how it works around shell bugs and takes
advantage of efficient features not all shells have. But any script using
the library can do this in the same way, with the help of this function.</p>
<p dir="auto">Test results are cached in memory, so repeated checks using <code>thisshellhas</code>
are efficient and there is no need to avoid calling it to optimise
performance.</p>
<p dir="auto">Usage:</p>
<p dir="auto"><code>thisshellhas</code> <em>item</em> ...</p>
<ul dir="auto">
<li>If <em>item</em> contains only ASCII capital letters A-Z, digits 0-9 or <code>_</code>,
return the result status of the associated modernish
<a href="#user-content-appendix-a-list-of-shell-cap-ids">capability detection test</a>.</li>
<li>If <em>item</em> is any other ASCII word, check if it is a shell reserved
word or built-in command on the current shell.</li>
<li>If <em>item</em> is <code>--</code> (end-of-options delimiter), disable the recognition of
operators starting with <code>-</code> for subsequent items.</li>
<li>If <em>item</em> starts with <code>--rw=</code> or <code>--kw=</code>, check if the identifier
immediately following these characters is a shell reserved word
(a.k.a. shell keyword).</li>
<li>If <em>item</em> starts with <code>--bi=</code>, similarly check for a shell built-in command.</li>
<li>If <em>item</em> starts with <code>--sig=</code>, check if the shell knows about a signal
(usable by <code>kill</code>, <code>trap</code>, etc.) by the name or number following the <code>=</code>.
If a number &gt; 128 is given, the remainder of its division by 128 is checked.
If the signal is found, its canonicalised signal name is left in the
<code>REPLY</code> variable, otherwise <code>REPLY</code> is unset. (If multiple <code>--sig=</code> items
are given and all are found, <code>REPLY</code> contains only the last one.)</li>
<li>If <em>item</em> is <code>-o</code> followed by a separate word, check if this shell has a
long-form shell option by that name.</li>
<li>If <em>item</em> is any other letter or digit preceded by a single <code>-</code>, check if
this shell has a short-form shell option by that character.</li>
<li><em>item</em> can also be one of the following two operators.
<ul dir="auto">
<li><code>--cache</code> runs all external modernish shell capability tests
that have not yet been run, causing the cache to be complete.</li>
<li><code>--show</code> performs a <code>--cache</code> and then outputs all the IDs of
positive results, one per line.</li>
</ul>
</li>
</ul>
<p dir="auto"><code>thisshellhas</code> continues to process <em>item</em>s until one of them produces a
negative result or is found invalid, at which point any further <em>item</em>s are
ignored. So the function only returns successfully if all the <em>item</em>s
specified were found on the current shell. (To check if either one <em>item</em> or
another is present, use separate <code>thisshellhas</code> invocations separated by the
<code>||</code> shell operator.)</p>
<p dir="auto">Exit status: 0 if this shell has all the <em>items</em> in question; 1 if not; 2 if
an <em>item</em> was encountered that is not recognised as a valid identifier.</p>
<p dir="auto"><strong>Note:</strong> The tests for the presence of reserved words, built-in commands,
shell options, and signals are different from capability detection tests in an
important way: they only check if an item by that name exists on this shell,
and don&#39;t verify that it does the same thing as on another shell.</p>

<p dir="auto">All modernish functions require portable variable and shell function names,
that is, ones consisting of ASCII uppercase and lowercase letters, digits,
and the underscore character <code>_</code>, and that don&#39;t begin with digit. For shell
option names, the constraints are the same except a dash <code>-</code> is also
accepted. An invalid identifier is generally treated as a fatal error.</p>

<p dir="auto">Function-local variables are not supported by the standard POSIX shell; only
global variables are provided for. Modernish needs a way to store its
internal state without interfering with the program using it. So most of the
modernish functionality uses an internal namespace <code>_Msh_*</code> for variables,
functions and aliases. All these names may change at any time without
notice. <em>Any names starting with <code>_Msh_</code> should be considered sacrosanct and
untouchable; modernish programs should never directly use them in any way.</em>
Of course this is not enforceable, but names starting with <code>_Msh_</code> should be
uncommon enough that no unintentional conflict is likely to occur.</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Modernish system constants</h3><a id="user-content-modernish-system-constants" aria-label="Permalink: Modernish system constants" href="#modernish-system-constants"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Modernish provides certain constants (read-only variables) to make life easier.
These include:</p>
<ul dir="auto">
<li><code>$MSH_VERSION</code>: The version of modernish.</li>
<li><code>$MSH_PREFIX</code>: Installation prefix for this modernish installation (e.g.
/usr/local).</li>
<li><code>$MSH_MDL</code>: Main <a href="#user-content-modules">modules</a> directory.</li>
<li><code>$MSH_AUX</code>: Main helper scripts directory.</li>
<li><code>$MSH_CONFIG</code>: Path to modernish user configuration directory.</li>
<li><code>$ME</code>: Path to the current program. Replacement for <code>$0</code>. This is
necessary if the hashbang path <code>#!/usr/bin/env modernish</code> is used, or if
the program is launched like <code>sh /path/to/bin/modernish /path/to/script.sh</code>, as these set <code>$0</code> to the path to bin/modernish and
not your program&#39;s path.</li>
<li><code>$MSH_SHELL</code>: Path to the default shell for this modernish installation,
chosen at install time (e.g. /bin/sh). This is a shell that is known to
have passed all the modernish tests for fatal bugs. Cross-platform scripts
should use it instead of hard-coding /bin/sh, because on some operating
systems (NetBSD, OpenBSD, Solaris) /bin/sh is not POSIX compliant.</li>
<li><code>$SIGPIPESTATUS</code>: The exit status of a command killed by <code>SIGPIPE</code> (a
broken pipe). For instance, if you use <code>grep something somefile.txt | more</code> and you quit <code>more</code> before <code>grep</code> is finished, <code>grep</code> is killed by
<code>SIGPIPE</code> and exits with that particular status.
Hardened commands or functions may need to handle such a <code>SIGPIPE</code> exit
specially to avoid unduly killing the program. The exact value of this
exit status is shell-specific, so modernish runs a quick test to determine
it at initialisation time.</li>
<li><code>$DEFPATH</code>: The default system path guaranteed to find compliant POSIX
utilities, as given by <code>getconf PATH</code>.</li>
<li><code>$ERROR</code>: A guaranteed unset variable that can be used to trigger an
error that exits the (sub)shell, for instance:
<code>: &#34;${4+${ERROR:?excess arguments}}&#34;</code> (error on 4 or more arguments)</li>
</ul>
<div dir="auto"><h3 tabindex="-1" dir="auto">Control character, whitespace and shell-safe character constants</h3><a id="user-content-control-character-whitespace-and-shell-safe-character-constants" aria-label="Permalink: Control character, whitespace and shell-safe character constants" href="#control-character-whitespace-and-shell-safe-character-constants"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">POSIX does not provide for the quoted C-style escape codes commonly used in
bash, ksh and zsh (such as <code>$&#39;\n&#39;</code> to represent a newline character),
leaving the standard shell without a convenient way to refer to control
characters. Modernish provides control character constants (read-only
variables) with hexadecimal suffixes <code>$CC01</code> .. <code>$CC1F</code> and <code>$CC7F</code>, as well as <code>$CCe</code>,
<code>$CCa</code>, <code>$CCb</code>, <code>$CCf</code>, <code>$CCn</code>, <code>$CCr</code>, <code>$CCt</code>, <code>$CCv</code> (corresponding with
<code>printf</code> backslash escape codes). This makes it easy to insert control
characters in double-quoted strings.</p>
<p dir="auto">More convenience constants, handy for use in bracket glob patterns for use
with <code>case</code> or modernish <code>match</code>:</p>
<ul dir="auto">
<li><code>$CONTROLCHARS</code>: All ASCII control characters.</li>
<li><code>$WHITESPACE</code>: All ASCII whitespace characters.</li>
<li><code>$ASCIIUPPER</code>: The ASCII uppercase letters A to Z.</li>
<li><code>$ASCIILOWER</code>: The ASCII lowercase letters a to z.</li>
<li><code>$ASCIIALNUM</code>: The ASCII alphanumeric characters 0-9, A-Z and a-z.</li>
<li><code>$SHELLSAFECHARS</code>: Safe-list for shell-quoting.</li>
<li><code>$ASCIICHARS</code>: The complete set of ASCII characters (minus NUL).</li>
</ul>
<p dir="auto">Usage examples:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# Use a glob pattern to check against control characters in a string:
	if str match &#34;$var&#34; &#34;*[$CONTROLCHARS]*&#34;; then
		putln &#34;\$var contains at least one control character&#34;
	fi
# Use &#39;!&#39; (not &#39;^&#39;) to check for characters *not* part of a particular set:
	if str match &#34;$var&#34; &#34;*[!$ASCIICHARS]*&#34;; then
		putln &#34;\$var contains at least one non-ASCII character&#34; ;;
	fi
# Safely split fields at any whitespace, comma or slash (requires safe mode):
	use safe
	LOOP for --split=$WHITESPACE,/ field in $my_items; DO
		putln &#34;Item: $field&#34;
	DONE"><pre><span><span>#</span> Use a glob pattern to check against control characters in a string:</span>
	<span>if</span> str match <span><span>&#34;</span><span>$var</span><span>&#34;</span></span> <span><span>&#34;</span>*[<span>$CONTROLCHARS</span>]*<span>&#34;</span></span><span>;</span> <span>then</span>
		putln <span><span>&#34;</span><span>\$</span>var contains at least one control character<span>&#34;</span></span>
	<span>fi</span>
<span><span>#</span> Use &#39;!&#39; (not &#39;^&#39;) to check for characters *not* part of a particular set:</span>
	<span>if</span> str match <span><span>&#34;</span><span>$var</span><span>&#34;</span></span> <span><span>&#34;</span>*[!<span>$ASCIICHARS</span>]*<span>&#34;</span></span><span>;</span> <span>then</span>
		putln <span><span>&#34;</span><span>\$</span>var contains at least one non-ASCII character<span>&#34;</span></span> <span>;;</span>
	<span>fi</span>
<span><span>#</span> Safely split fields at any whitespace, comma or slash (requires safe mode):</span>
	use safe
	LOOP <span>for</span> <span>--split=$WHITESPACE,/ field</span> <span>in</span> <span>$my_items</span><span>;</span> DO
		putln <span><span>&#34;</span>Item: <span>$field</span><span>&#34;</span></span>
	DONE</pre></div>

<p dir="auto">The <code>die</code> function reliably halts program execution, even from within
<a href="#user-content-insubshell">subshells</a>, optionally
printing an error message. Note that <code>die</code> is meant for an emergency program
halt only, i.e. in situations were continuing would mean the program is in an
inconsistent or undefined state. Shell scripts running in an inconsistent or
undefined state may wreak all sorts of havoc. They are also notoriously
difficult to terminate correctly, especially if the fatal error occurs within
a subshell: <code>exit</code> won&#39;t work then. That&#39;s why <code>die</code> is optimised for
killing <em>all</em> the program&#39;s processes (including subshells and external
commands launched by it) as quickly as possible. It should never be used for
exiting the program normally.</p>
<p dir="auto">On interactive shells, <code>die</code> behaves differently. It does not kill or exit your
shell; instead, it issues <code>SIGINT</code> to the shell to abort the execution of your
running command(s), which is equivalent to pressing Ctrl+C.
In addition, if <code>die</code> is invoked from a subshell such as a background job, it
kills all processes belonging to that job, but leaves other running jobs alone.</p>
<p dir="auto">Usage: <code>die</code> [ <em>message</em> ]</p>
<p dir="auto">If the <a href="#user-content-use-varstacktrap">trap stack module</a>
is active, a special
<a href="#user-content-the-new-die-pseudosignal"><code>DIE</code> pseudosignal</a>
can be trapped (using plain old <code>trap</code> or
<a href="#user-content-the-trap-stack"><code>pushtrap</code></a>)
to perform emergency cleanup commands upon invoking <code>die</code>.</p>
<p dir="auto">If the <code>MSH_HAVE_MERCY</code> variable is set in a script and <code>die</code> is invoked
from a subshell, then <code>die</code> will only terminate the current subshell and its
subprocesses and will not execute <code>DIE</code> traps, allowing the script to resume
execution in the parent process. This is for use in special cases, such as
regression tests, and is strongly discouraged for general use. Modernish
unsets the variable on init so it cannot be inherited from the environment.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Low-level shell utilities</h2><a id="user-content-low-level-shell-utilities" aria-label="Permalink: Low-level shell utilities" href="#low-level-shell-utilities"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>

<p dir="auto">The POSIX shell lacks a simple, straightforward and portable way to output
arbitrary strings of text, so modernish adds two commands for this.</p>
<ul dir="auto">
<li><code>put</code> prints each argument separated by a space, without a trailing newline.</li>
<li><code>putln</code> prints each argument, terminating each with a newline character.</li>
</ul>
<p dir="auto">There is no processing of options or escape codes. (Modernish constants
<a href="#user-content-control-character-whitespace-and-shell-safe-character-constants"><code>$CCn</code>, etc.</a>
can be used to insert control characters in double-quoted strings. To process escape codes, use
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/printf.html" rel="nofollow"><code>printf</code></a>
instead.)</p>
<p dir="auto">The <code>echo</code> command is notoriously unportable and kind of broken, so is
<strong>deprecated</strong> in favour of <code>put</code> and <code>putln</code>. Modernish does provide its own
version of <code>echo</code>, but it is only activated for
<a href="#user-content-portable-form">portable-form</a>)
scripts. Otherwise, the shell-specific version of <code>echo</code> is left intact.
The modernish version of <code>echo</code> does not interpret any escape codes
and supports only one option, <code>-n</code>, which, like BSD <code>echo</code>, suppresses the
final newline. However, unlike BSD <code>echo</code>, if <code>-n</code> is the only argument, it is
not interpreted as an option and the string <code>-n</code> is printed instead. This makes
it safe to output arbitrary data using this version of <code>echo</code> as long as it is
given as a single argument (using quoting if needed).</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Legibility aliases: <code>not</code>, <code>so</code>, <code>forever</code></h3><a id="user-content-legibility-aliases-not-so-forever" aria-label="Permalink: Legibility aliases: not, so, forever" href="#legibility-aliases-not-so-forever"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Modernish sets three aliases that can help to make the shell language look
slightly friendlier. Their use is optional.</p>
<p dir="auto"><code>not</code> is a new synonym for <code>!</code>. They can be used interchangeably.</p>
<p dir="auto"><code>so</code> is a command that tests if the previous command exited with a status
of zero, so you can test the preceding command&#39;s success with <code>if so</code> or
<code>if not so</code>.</p>
<p dir="auto"><code>forever</code> is a new synonym for <code>while :;</code>. This allows simple infinite loops
of the form: <code>forever do</code> <em>stuff</em><code>; done</code>.</p>

<p dir="auto">The <code>exit</code> command can be used as normal, but has gained capabilities.</p>
<p dir="auto">Extended usage: <code>exit</code> [ <code>-u</code> ] [ <em>status</em> [ <em>message</em> ] ]</p>
<ul dir="auto">
<li>As per standard, if <em>status</em> is not specified, it defaults to the exit
status of the command executed immediately prior to <code>exit</code>.
Otherwise, it is evaluated as a shell arithmetic expression. If it is
invalid as such, the shell exits immediately with an arithmetic error.</li>
<li>Any remaining arguments after <em>status</em> are combined, separated by spaces,
and taken as a <em>message</em> to print on exit. The message shown is preceded by
the name of the current program (<code>$ME</code> minus directories). Note that it is
not possible to skip <em>status</em> while specifying a <em>message</em>.</li>
<li>If the <code>-u</code> option is given, and the shell function <code>showusage</code> is defined,
that function is run in a subshell before exiting. It is intended to print
a message showing how the command should be invoked. The <code>-u</code> option has no
effect if the script has not defined a <code>showusage</code> function.</li>
<li>If <em>status</em> is non-zero, the <em>message</em> and the output of the <code>showusage</code>
function are redirected to standard error.</li>
</ul>

<p dir="auto"><code>chdir</code> is a robust <code>cd</code> replacement for use in scripts.</p>
<p dir="auto">The <a href="https://pubs.opengroup.org/onlinepubs/9699919799/utilities/cd.html" rel="nofollow">standard <code>cd</code> command</a>
is designed for interactive shells and appropriate to use there.
However, for scripts, its features create serious pitfalls:</p>
<ul dir="auto">
<li>The <code>$CDPATH</code> variable is searched. A script may inherit a user&#39;s
exported <code>$CDPATH</code>, so <code>cd</code> may change to an unintended directory.</li>
<li><code>cd</code> cannot be used with arbitrary directory names (such as untrusted user
input), as some operands have special meanings, even after <code>--</code>. POSIX
specifies that <code>-</code> changes directory to <code>$OLDPWD</code>. On zsh (even in sh mode
on zsh &lt;= 5.7.1), numeric operands such as <code>+12</code> or <code>-345</code> represent
directory stack entries. All such paths need escaping by prefixing <code>./</code>.</li>
<li>Symbolic links in directory path components are not resolved by default,
leaving a potential symlink attack vector.</li>
</ul>
<p dir="auto">Thus, robust and portable use of <code>cd</code> in scripts is unreasonably difficult.
The modernish <code>chdir</code> function calls <code>cd</code> in a way that takes care of all
these issues automatically: it disables <code>$CDPATH</code> and special operand
meanings, and resolves symbolic links by default.</p>
<p dir="auto">Usage: <code>chdir</code> [ <code>-f</code> ] [ <code>-L</code> ] [ <code>-P</code> ] [ <code>--</code> ] <em>directorypath</em></p>
<p dir="auto">Normally, failure to change the present working directory to <em>directorypath</em>
is a fatal error that ends the program. To tolerate failure, add the <code>-f</code>
option; in that case, exit status 0 signifies success and exit status 1
signifies failure, and scripts should always check and handle exceptions.</p>
<p dir="auto">The options <code>-L</code> (logical: don&#39;t resolve symlinks) and <code>-P</code> (physical:
resolve symlinks) are the same as in <code>cd</code>, except that <code>-P</code> is the default.
Note that on a shell with <a href="#user-content-bugs"><code>BUG_CDNOLOGIC</code></a> (NetBSD sh),
the <code>-L</code> option to <code>chdir</code> does nothing.</p>
<p dir="auto">To use arbitrary directory names (e.g. directory names input by the user or
other untrusted input) always use the <code>--</code> separator that signals the end of
options, or paths starting with <code>-</code> may be misinterpreted as options.</p>

<p dir="auto">The <code>insubshell</code> function checks if you&#39;re currently running in a
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_12" rel="nofollow">subshell environment</a>
(usually called simply <em>subshell</em>).</p>
<p dir="auto">A <em>subshell</em> is a copy of the parent shell that starts out as an exact
duplicate (including non-exported variables, functions, etc.), except for
traps. A new subshell is invoked by constructs like <code>(</code>parentheses<code>)</code>,
<code>$(</code>command substitutions<code>)</code>, pipe<code>|</code>lines, and <code>&amp;</code> (to launch a background
subshell). Upon exiting a subshell, all changes to its state are lost.</p>
<p dir="auto">This is not to be confused with a newly initialised shell that is
merely a child process of the current shell, which is sometimes
(confusingly and <strong>wrongly</strong>) called a &#34;subshell&#34; as well.
This documentation avoids such a misleading use of the term.</p>
<p dir="auto">Usage: <code>insubshell</code> [ <code>-p</code> | <code>-u</code> ]</p>
<p dir="auto">This function returns success (0) if it was called from within a subshell
and non-success (1) if not. One of two options can be given:</p>
<ul dir="auto">
<li><code>-p</code>: Store the process ID (PID) of the current subshell or main shell
in <code>REPLY</code>.</li>
<li><code>-u</code>: Store an identifier in <code>REPLY</code> that is useful for determining if
you&#39;ve entered a subshell relative to a previously stored identifier. The
content and format are unspecified and shell-dependent.</li>
</ul>

<p dir="auto"><code>isset</code> checks if a variable, shell function or option is set, or has
certain attributes. Usage:</p>
<ul dir="auto">
<li><code>isset</code> <em>varname</em>: Check if a variable is set.</li>
<li><code>isset -v</code> <em>varname</em>: Id.</li>
<li><code>isset -x</code> <em>varname</em>: Check if variable is exported.</li>
<li><code>isset -r</code> <em>varname</em>: Check if variable is read-only.</li>
<li><code>isset -f</code> <em>funcname</em>: Check if a shell function is set.</li>
<li><code>isset -</code><em>optionletter</em> (e.g. <code>isset -C</code>): Check if shell option is set.</li>
<li><code>isset -o</code> <em>optionname</em>: Check if shell option is set by long name.</li>
</ul>
<p dir="auto">Exit status: 0 if the item is set; 1 if not; 2 if the argument is not
recognised as a <a href="#user-content-names-and-identifiers">valid identifier</a>.
Unlike most other modernish commands, <code>isset</code> does not treat an invalid
identifier as a fatal error.</p>
<p dir="auto">When checking a shell option, a nonexistent shell option is not an error,
but returns the same result as an unset shell option. (To check if a shell
option exists, use <a href="#user-content-shell-capability-detection"><code>thisshellhas</code></a>.</p>
<p dir="auto">Note: just <code>isset -f</code> checks if shell option <code>-f</code> (a.k.a. <code>-o noglob</code>) is
set, but with an extra argument, it checks if a shell function is set.
Similarly, <code>isset -x</code> checks if shell option <code>-x</code> (a.k.a <code>-o xtrace</code>)
is set, but <code>isset -x</code> <em>varname</em> checks if a variable is exported. If you
use unquoted variable expansions here, make sure they&#39;re not empty, or
the shell&#39;s empty removal mechanism will cause the wrong thing to be checked
(even in the <a href="#user-content-use-safe">safe mode</a>).</p>

<p dir="auto"><code>setstatus</code> manually sets the exit status <code>$?</code> to the desired value. The
function exits with the status indicated. This is useful in conditional
constructs if you want to prepare a particular exit status for a subsequent
<code>exit</code> or <code>return</code> command to inherit under certain circumstances.
The status argument is a parsed as a shell arithmetic expression. A negative
value is treated as a fatal error. The behaviour of values greater than 255
is not standardised and depends on your particular shell.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Testing numbers, strings and files</h2><a id="user-content-testing-numbers-strings-and-files" aria-label="Permalink: Testing numbers, strings and files" href="#testing-numbers-strings-and-files"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The <code>test</code>/<code>[</code> command is the bane of casual shell scripters. Even advanced
shell programmers are frequently caught unaware by one of the many pitfalls
of its arcane, hackish syntax. It attempts to look like shell grammar without
<em>being</em> shell grammar, causing myriad problems
(<a href="http://wiki.bash-hackers.org/commands/classictest" rel="nofollow">1</a>,
<a href="https://mywiki.wooledge.org/BashPitfalls" rel="nofollow">2</a>).
Its <code>-a</code>, <code>-o</code>, <code>(</code> and <code>)</code> operators are <em>inherently and fatally broken</em> as
there is no way to reliably distinguish operators from operands, so POSIX
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/test.html#tag_20_128_16" rel="nofollow">deprecates their use</a>;
however, most manual pages do not include this essential information, and
even the few that do will not tell you what to do instead.</p>
<p dir="auto">Ksh, zsh and bash offer a <code>[[</code> alternative that fixes many of these problems,
as it is integrated into the shell grammar. Nevertheless, it increases
confusion, as entirely different grammar and quoting rules apply
within <code>[[</code>...<code>]]</code> than outside it, yet many scripts end up using them
interchangeably. It is also not available on all POSIX shells. (To make
matters worse, Busybox ash has a false-friend <code>[[</code> that is just an alias
of <code>[</code>, with none of the shell grammar integration!)</p>
<p dir="auto">Finally, the POSIX <code>test</code>/<code>[</code> command is incompatible with the modernish
&#34;safe mode&#34; which aims to eliminate most of the need to quote variables.
See <a href="#user-content-use-safe"><code>use safe</code></a> for more information.</p>
<p dir="auto">Modernish deprecates <code>test</code>/<code>[</code> and <code>[[</code> completely. Instead, it offers a
comprehensive alternative command design that works with the usual shell
grammar in a safer way while offering various feature enhancements. The
following replacements are available:</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Integer number arithmetic tests and operations</h3><a id="user-content-integer-number-arithmetic-tests-and-operations" aria-label="Permalink: Integer number arithmetic tests and operations" href="#integer-number-arithmetic-tests-and-operations"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To test if a string is a valid number in shell syntax, <code>str isint</code> is
available. See <a href="#user-content-string-tests">String tests</a>.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto">The arithmetic command <code>let</code></h4><a id="user-content-the-arithmetic-command-let" aria-label="Permalink: The arithmetic command let" href="#the-arithmetic-command-let"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">An implementation of <code>let</code> as in ksh, bash and zsh is now available to all
POSIX shells. This makes C-style signed integer arithmetic evaluation
available to every
<a href="#user-content-appendix-d-supported-shells">supported shell</a>,
<em>with the exception of the unary <code>++</code> and <code>--</code> operators</em>
(which are a nonstandard shell capability detected by modernish under the ID of
<a href="#user-content-appendix-a-list-of-shell-cap-ids"><code>ARITHPP</code></a>).</p>
<p dir="auto">This means <code>let</code> should be used for operations and tests, e.g. both
<code>let &#34;x=5&#34;</code> and <code>if let &#34;x==5&#34;; then</code>... are supported (note: single <code>=</code> for
assignment, double <code>==</code> for comparison). See POSIX
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_06_04" rel="nofollow">2.6.4 Arithmetic Expansion</a>
for more information on the supported operators.</p>
<p dir="auto">Multiple expressions are supported, one per argument. The exit status of <code>let</code>
is zero (the shell&#39;s idea of success/true) if the last expression argument
evaluates to non-zero (the arithmetic idea of true), and 1 otherwise.</p>
<p dir="auto">It is recommended to adopt the habit to quote each <code>let</code> expression with
<code>&#34;</code>double quotes<code>&#34;</code>, as this consistently makes everything work as expected:
double quotes protect operators that would otherwise be misinterpreted as
shell grammar, while shell expansions starting with <code>$</code> continue to work.</p>

<p dir="auto">Various handy functions that make common arithmetic operations
and comparisons easier to program are available from the
<a href="#user-content-use-vararith"><code>var/arith</code></a> module.</p>

<p dir="auto">The following notes apply to all commands described in the subsections of
this section:</p>
<ol dir="auto">
<li>&#34;True&#34; is understood to mean exit status 0, and &#34;false&#34; is understood to
mean a non-zero exit status – specifically 1.</li>
<li>Passing <em>more</em> than the number of arguments specified for each command
is a <a href="#user-content-reliable-emergency-halt">fatal error</a>. (If the
<a href="#user-content-use-safe">safe mode</a> is not used, excessive arguments
may be generated accidentally if you forget to quote a variable. The
test result would have been wrong anyway, so modernish kills the
program immediately, which makes the problem much easier to trace.)</li>
<li>Passing <em>fewer</em> than the number of arguments specified to the command is
assumed to be the result of removal of an empty unquoted expansion.
Where possible, this is not treated as an error, and an exit status
corresponding to the omitted argument(s) being empty is returned instead.
(This helps make the <a href="#user-content-use-safe">safe mode</a> possible; unlike
with <code>test</code>/<code>[</code>, paranoid quoting to avoid empty removal is not needed.)</li>
</ol>

<p dir="auto">The <code>str</code> function offers various operators for tests on strings. For
example, <code>str in $foo &#34;bar&#34;</code> tests if the variable <code>foo</code> contains &#34;bar&#34;.</p>
<p dir="auto">The <code>str</code> function takes unary (one-argument) operators that check a property
of a single word, binary (two-argument) operators that check a word against a
pattern, as well as an option that makes binary operators check multiple words
against a pattern.</p>

<p dir="auto">Usage: <code>str</code> <em>operator</em> [ <em>word</em> ]</p>
<p dir="auto">The <em>word</em> is checked for the property indicated by <em>operator</em>; if the result
is true, <code>str</code> returns status 0, otherwise it returns status 1.</p>
<p dir="auto">The available unary string test <em>operator</em>s are:</p>
<ul dir="auto">
<li><code>empty</code>: The <em>word</em> is empty.</li>
<li><code>isint</code>: The <em>word</em> is a decimal, octal or hexadecimal integer number in
valid POSIX shell syntax, safe to use with <code>let</code>, <code>$((</code>...<code>))</code> and other
arithmetic contexts on all POSIX-derived shells. This operator ignores
leading (but not trailing) spaces and tabs.</li>
<li><code>isvarname</code>: The <em>word</em> is a valid portable shell variable or function name.</li>
</ul>
<p dir="auto">If <em>word</em> is omitted, it is treated as empty, on the assumption that it is
an unquoted empty variable. Passing more than one argument after the
<em>operator</em> is a fatal error.</p>
<div dir="auto"><h5 tabindex="-1" dir="auto">Binary string matching tests</h5><a id="user-content-binary-string-matching-tests" aria-label="Permalink: Binary string matching tests" href="#binary-string-matching-tests"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Usage: <code>str</code> <em>operator</em> [ [ <em>word</em> ] <em>pattern</em> ]</p>
<p dir="auto">The <em>word</em> is compared to the <em>pattern</em> according to the <em>operator</em>; if it
matches, <code>str</code> returns status 0, otherwise it returns status 1.
The available binary matching <em>operator</em>s are:</p>
<ul dir="auto">
<li><code>eq</code>: <em>word</em> is equal to <em>pattern</em>.</li>
<li><code>ne</code>: <em>word</em> is not equal to <em>pattern</em>.</li>
<li><code>in</code>: <em>word</em> includes <em>pattern</em>.</li>
<li><code>begin</code>: <em>word</em> begins with <em>pattern</em>.</li>
<li><code>end</code>: <em>word</em> ends with <em>pattern</em>.</li>
<li><code>match</code>: <em>word</em> matches <em>pattern</em> as a shell glob pattern
(as in the shell&#39;s native <code>case</code> construct).
A <em>pattern</em> that ends in an unescaped backslash is considered invalid
and causes <code>str</code> to return status 2.</li>
<li><code>ematch</code>: <em>word</em> matches <em>pattern</em> as a POSIX
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap09.html#tag_09_04" rel="nofollow">extended regular expression</a>.
An empty <em>pattern</em> is a fatal error.
(In UTF-8 locales, check if
<code>thisshellhas <a href="#user-content-warning-ids">WRN_EREMBYTE</a></code>
before matching multi-byte characters.)</li>
<li><code>lt</code>: <em>word</em> lexically sorts before (is &#39;less than&#39;) <em>pattern</em>.</li>
<li><code>le</code>: <em>word</em> is lexically &#39;less than or equal to&#39; <em>pattern</em>.</li>
<li><code>gt</code>: <em>word</em> lexically sorts after (is &#39;greater than&#39;) <em>pattern</em>.</li>
<li><code>ge</code>: <em>word</em> is lexically &#39;greater than or equal to&#39; <em>pattern</em>.</li>
</ul>
<p dir="auto">If <em>word</em> is omitted, it is treated as empty on the assumption that it is an
unquoted empty variable, and the single remaining argument is assumed to be
the <em>pattern</em>. Similarly, if both <em>word</em> and <em>pattern</em> are omitted, an empty
<em>word</em> is matched against an empty <em>pattern</em>. Passing more than two
arguments after the <em>operator</em> is a fatal error.</p>

<p dir="auto">Usage: <code>str -M</code> <em>operator</em> [ [ <em>word</em> ... ] <em>pattern</em> ]</p>
<p dir="auto">The <code>-M</code> option causes <code>str</code> to compare any number of <em>word</em>s to the
<em>pattern</em>. The available <em>operator</em>s are the same as the binary string
matching operators listed above.</p>
<p dir="auto">All matching <em>word</em>s are stored in the <code>REPLY</code> variable, separated
by newline characters (<code>$CCn</code>) if there is more than one match.
If no <em>word</em>s match, <code>REPLY</code> is unset.</p>
<p dir="auto">The exit status returned by <code>str -M</code> is as follows:</p>
<ul dir="auto">
<li>If no <em>word</em>s match, the exit status is 1.</li>
<li>If one <em>word</em> matches, the exit status is 0.</li>
<li>If between two and 254 <em>word</em>s match, the exit status is the number of matches.</li>
<li>If 255 or more <em>word</em>s match, the exit status is 255.</li>
</ul>
<p dir="auto">Usage example: the following matches a given GNU-style long-form command
line option <code>$1</code> against a series of available options. To make it possible
for the options to be abbreviated, we check if any of the options begin with
the given argument <code>$1</code>.</p>
<div dir="auto" data-snippet-clipboard-copy-content="if str -M begin --fee --fi --fo --fum --foo --bar --baz --quux &#34;$1&#34;; then
	putln &#34;OK. The given option $1 matched $REPLY&#34;
else
	case $? in
	( 1 )	putln &#34;No such option: $1&#34; &gt;&amp;2 ;;
	( * )	putln &#34;Ambiguous option: $1&#34; &#34;Did you mean:&#34; &#34;$REPLY&#34; &gt;&amp;2 ;;
	esac
fi"><pre><span>if</span> str -M begin --fee --fi --fo --fum --foo --bar --baz --quux <span><span>&#34;</span><span>$1</span><span>&#34;</span></span><span>;</span> <span>then</span>
	putln <span><span>&#34;</span>OK. The given option <span>$1</span> matched <span>$REPLY</span><span>&#34;</span></span>
<span>else</span>
	<span>case</span> <span>$?</span> <span>in</span>
	( 1 )	putln <span><span>&#34;</span>No such option: <span>$1</span><span>&#34;</span></span> <span>&gt;&amp;2</span> ;;
	( <span>*</span> )	putln <span><span>&#34;</span>Ambiguous option: <span>$1</span><span>&#34;</span></span> <span><span>&#34;</span>Did you mean:<span>&#34;</span></span> <span><span>&#34;</span><span>$REPLY</span><span>&#34;</span></span> <span>&gt;&amp;2</span> ;;
	<span>esac</span>
<span>fi</span></pre></div>

<p dir="auto">These avoid the snags with symlinks you get with <code>[</code> and <code>[[</code>.
By default, symlinks are <em>not</em> followed. Add <code>-L</code> to operate on files
pointed to by symlinks instead of symlinks themselves (the <code>-L</code> makes
no difference if the operands are not symlinks).</p>
<p dir="auto">These commands all take one argument. If the argument is absent, they return
false. More than one argument is a fatal error. See notes 1-3 in the
<a href="#user-content-string-and-file-tests">parent section</a>.</p>
<p dir="auto"><code>is present</code> <em>file</em>: Returns true if the file is present in the file
system (even if it is a broken symlink).</p>
<p dir="auto"><code>is -L present</code> <em>file</em>: Returns true if the file is present in the file
system and is not a broken symlink.</p>
<p dir="auto"><code>is sym</code> <em>file</em>: Returns true if the file is a symbolic link (symlink).</p>
<p dir="auto"><code>is -L sym</code> <em>file</em>: Returns true if the file is a non-broken symlink, i.e.
a symlink that points (either directly or indirectly via other symlinks)
to a non-symlink file that is present in the file system.</p>
<p dir="auto"><code>is reg</code> <em>file</em>: Returns true if <em>file</em> is a regular data file.</p>
<p dir="auto"><code>is -L reg</code> <em>file</em>: Returns true if <em>file</em> is either a regular data file
or a symlink pointing (either directly or indirectly via other symlinks)
to a regular data file.</p>
<p dir="auto">Other commands are available that work exactly like <code>is reg</code> and <code>is -L reg</code>
but test for other file types. To test for them, replace <code>reg</code> with one of:</p>
<ul dir="auto">
<li><code>dir</code> for a directory</li>
<li><code>fifo</code> for a named pipe (FIFO)</li>
<li><code>socket</code> for a socket</li>
<li><code>blockspecial</code> for a block special file</li>
<li><code>charspecial</code> for a character special file</li>
</ul>

<p dir="auto">The following notes apply to these commands:</p>
<ul dir="auto">
<li>Symlinks are <em>not</em> resolved/followed by default. To operate on files pointed
to by symlinks, add <code>-L</code> before the operator argument, e.g. <code>is -L newer</code>.</li>
<li>Omitting any argument is a fatal error, because no empty argument (removed or
otherwise) would make sense for these commands.</li>
</ul>
<p dir="auto"><code>is newer</code> <em>file1</em> <em>file2</em>: Compares file timestamps, returning true if <em>file1</em>
is newer than <em>file2</em>. Also returns true if <em>file1</em> exists, but <em>file2</em> does
not; this is consistent for all shells (unlike <code>test file1 -nt file2</code>).</p>
<p dir="auto"><code>is older</code> <em>file1</em> <em>file2</em>: Compares file timestamps, returning true if <em>file1</em>
is older than <em>file2</em>. Also returns true if <em>file1</em> does not exist, but <em>file2</em>
does; this is consistent for all shells (unlike <code>test file1 -ot file2</code>).</p>
<p dir="auto"><code>is samefile</code> <em>file1</em> <em>file2</em>: Returns true if <em>file1</em> and <em>file2</em> are the same
file (hardlinks).</p>
<p dir="auto"><code>is onsamefs</code> <em>file1</em> <em>file2</em>: Returns true if <em>file1</em> and <em>file2</em> are on the
same file system. If any non-regular, non-directory files are specified, their
parent directory is tested instead of the file itself.</p>

<p dir="auto">These always follow symlinks.</p>
<p dir="auto"><code>is nonempty</code> <em>file</em>: Returns true if the <em>file</em> exists, is not a broken
symlink, and is not empty. Unlike <code>[ -s file ]</code>, this also works
for directories, as long as you have read permission in them.</p>
<p dir="auto"><code>is setuid</code> <em>file</em>: Returns true if the <em>file</em> has its set-user-ID flag set.</p>
<p dir="auto"><code>is setgid</code> <em>file</em>: Returns true if the <em>file</em> has its set-group-ID flag set.</p>

<p dir="auto"><code>is onterminal</code> <em>FD</em>: Returns true if file descriptor <em>FD</em> is associated
with a terminal. The <em>FD</em> may be a non-negative integer number or one of the
special identifiers <code>stdin</code>, <code>stdout</code> and <code>stderr</code> which are equivalent to
0, 1, and 2. For instance, <code>is onterminal stdout</code> returns true if commands
that write to standard output (FD 1), such as <code>putln</code>, would write to the
terminal, and false if the output is redirected to a file or pipeline.</p>

<p dir="auto">Any symlinks given are resolved, as these tests would be meaningless
for a symlink itself.</p>
<p dir="auto"><code>can read</code> <em>file</em>: True if the file&#39;s permission bits indicate that you can read
the file - i.e., if an <code>r</code> bit is set and applies to your user.</p>
<p dir="auto"><code>can write</code> <em>file</em>: True if the file&#39;s permission bits indicate that you can
write to the file: for non-directories, if a <code>w</code> bit is set and applies to your
user; for directories, both <code>w</code> and <code>x</code>.</p>
<p dir="auto"><code>can exec</code> <em>file</em>: True if the file&#39;s type and permission bits indicate that
you can execute the file: for regular files, if an <code>x</code> bit is set and applies
to your user; for other file types, never.</p>
<p dir="auto"><code>can traverse</code> <em>file</em>: True if the file is a directory and its permission bits
indicate that a path can traverse through it to reach its subdirectories: for
directories, if an <code>x</code> bit is set and applies to your user; for other file
types, never.</p>

<p dir="auto">In modernish, every variable and shell option gets its own stack. Arbitrary
values/states can be pushed onto the stack and popped off it in reverse
order. For variables, both the value and the set/unset state is (re)stored.</p>
<p dir="auto">Usage:</p>
<ul dir="auto">
<li><code>push</code> [ <code>--key=</code><em>value</em> ] <em>item</em> [ <em>item</em> ... ]</li>
<li><code>pop</code> [ <code>--keepstatus</code> ] [ <code>--key=</code><em>value</em> ] <em>item</em> [ <em>item</em> ... ]</li>
</ul>
<p dir="auto">where <em>item</em> is a valid portable variable name, a short-form shell option
(dash plus letter), or a long-form shell option (<code>-o</code> followed by an option
name, as two arguments).</p>
<p dir="auto">Before pushing or popping anything, both functions check if all the given
arguments are valid and <code>pop</code> checks all items have a non-empty stack. This
allows pushing and popping groups of items with a check for the integrity of
the entire group. <code>pop</code> exits with status 0 if all items were popped
successfully, and with status 1 if one or more of the given items could not
be popped (and no action was taken at all).</p>
<p dir="auto">The <code>--key=</code> option is an advanced feature that can help different modules
or functions to use the same variable stack safely. If a key is given to
<code>push</code>, then for each <em>item</em>, the given key <em>value</em> is stored along with the
variable&#39;s value for that position in the stack. Subsequently, restoring
that value with <code>pop</code> will only succeed if the key option with the same key
value is given to the <code>pop</code> invocation. Similarly, popping a keyless value
only succeeds if no key is given to <code>pop</code>. If there is any key mismatch, no
changes are made and <code>pop</code> returns status 2.  Note that this is
a robustness/convenience feature, not a security feature; the keys are not
hidden in any way.</p>
<p dir="auto">If the <code>--keepstatus</code> option is given, <code>pop</code> will exit with the
exit status of the command executed immediately prior to calling <code>pop</code>. This
can avoid the need for awkward workarounds when restoring variables or shell
options at the end of a function. However, note that this makes failure to pop
(stack empty or key mismatch) a fatal error that kills the program, as <code>pop</code>
no longer has a way to communicate this through its exit status.</p>

<p dir="auto"><code>push</code> and <code>pop</code> allow saving and restoring the state of any shell option
available to the <code>set</code> builtin. The precise shell options supported
(other than the ones guaranteed by POSIX) depend on
<a href="#user-content-appendix-d-supported-shells">the shell modernish is running on</a>.
To facilitate portability, nonexistent shell options are treated as unset.</p>
<p dir="auto">Long-form shell options are matched to their equivalent short-form shell
options, if they exist. For instance, on all POSIX shells, <code>-f</code> is
equivalent to <code>-o noglob</code>, and <code>push -o noglob</code> followed by <code>pop -f</code> works
correctly. This also works for shell-specific short &amp; long option
equivalents.</p>
<p dir="auto">On shells with a dynamic <code>no</code> option name prefix, that is on ksh, zsh and
yash (where, for example, <code>noglob</code> is the opposite of <code>glob</code>), the <code>no</code>
prefix is ignored, so something like <code>push -o glob</code> followed by <code>pop -o noglob</code> does the right thing. But this depends on the shell and should never
be used in portable scripts.</p>

<p dir="auto">Modernish can also make traps stack-based, so that each
program component or library module can set its own trap commands
without interfering with others. This functionality is provided
by the <a href="#user-content-use-varstacktrap"><code>var/stack/trap</code></a> module.</p>

<p dir="auto">As modularity is one of modernish&#39;s
<a href="https://github.com/modernish/modernish/blob/master/share/doc/modernish/DESIGN.md">design principles</a>,
much of its essential functionality is provided in the form of loadable
modules, so the core library is kept lean. Modules are organised
hierarchically, with names such as <code>safe</code>, <code>var/loop</code> and <code>sys/cmd/harden</code>. The
<code>use</code> command loads and initialises a module or a combined directory of modules.</p>
<p dir="auto">Internally, modules exist in files with the name extension <code>.mm</code> in
subdirectories of <code>lib/modernish/mdl</code> – for example, the module
<code>var/stack/trap</code> corresponds to the file <code>lib/modernish/mdl/var/stack/trap.mm</code>.</p>
<p dir="auto">Usage:</p>
<ul dir="auto">
<li><code>use</code> <em>modulename</em> [ <em>argument</em> ... ]</li>
<li><code>use</code> [ <code>-q</code> | <code>-e</code> ] <em>modulename</em></li>
<li><code>use -l</code></li>
</ul>
<p dir="auto">The first form loads and initialises a module. All arguments, including the
module name, are passed on to the dot script unmodified, so modules know
their own name and can implement option parsing to influence their
initialisation. See also
<a href="#user-content-two-basic-forms-of-a-modernish-program">Two basic forms of a modernish program</a>
for information on how to use modules in portable-form scripts.</p>
<p dir="auto">In the second form, the <code>-q</code> option queries if a module is loaded, and the <code>-e</code>
option queries if a module exists. <code>use</code> returns status 0 for yes, 1 for no,
and 2 if the module name is invalid.</p>
<p dir="auto">The <code>-l</code> option lists all currently loaded modules in the order in which
they were originally loaded. Just add <code>| sort</code> for alphabetical order.</p>
<p dir="auto">If a directory of modules, such as <code>sys/cmd</code> or even just <code>sys</code>, is given as the
<em>modulename</em>, then all the modules in that directory and any subdirectories are
loaded recursively. In this case, passing extra arguments is a fatal error.</p>
<p dir="auto">If a module file <code>X.mm</code> exists along with a directory <code>X</code>, resolving to the
same <em>modulename</em>, then <code>use</code> will load the <code>X.mm</code> module file without
automatically loading any modules in the <code>X</code> directory, because it is expected
that <code>X.mm</code> handles the submodules in <code>X</code> manually. (This is currently the case
for <code>var/loop</code> which auto-loads submodules containing loop types on first use).</p>
<p dir="auto">The complete <code>lib/modernish/mdl</code> directory path, which depends on where
modernish is installed, is stored in the system constant <code>$MSH_MDL</code>.</p>
<p dir="auto">The following subchapters document the modules that come with modernish.</p>

<p dir="auto">The <code>safe</code> module sets the &#39;safe mode&#39; for the shell. It removes most of the
need to quote variables, parameter expansions, command substitutions, or glob
patterns. It uses shell settings and modernish library functionality to secure
and demystify split and glob mechanisms. This creates a new and safer way of
shell script programming, essentially building a new shell language dialect
while still running on all POSIX-compliant shells.</p>

<p dir="auto">One of the most common headaches with shell scripting is caused by a
fundamental flaw in the shell as a scripting language: <em>constantly
active field splitting</em> (a.k.a. word splitting) <em>and pathname expansion</em>
(a.k.a. globbing). To cope with this situation, it is hammered into
programmers of shell scripts to be absolutely paranoid about properly
<a href="https://mywiki.wooledge.org/Quotes" rel="nofollow">quoting</a> nearly everything, including
variable and parameter expansions, command substitutions, and patterns passed
to commands like <code>find</code>.</p>
<p dir="auto">These mechanisms were designed for interactive command line usage, where they
do come in very handy. But when the shell language is used as a programming
language, splitting and globbing often ends up being applied unexpectedly to
unquoted expansions and command substitutions, helping cause thousands of
buggy, brittle, or outright dangerous shell scripts.</p>
<p dir="auto">One could blame the programmer for forgetting to quote an expansion properly,
<em>or</em> one could blame a pitfall-ridden scripting language design where hammering
punctilious and counterintuitive habits into casual shell script programmers is
necessary. Modernish does the latter, then fixes it.</p>

<p dir="auto">Every POSIX shell comes with a little-used ability to disable global field
splitting and pathname expansion: <code>IFS=&#39;&#39;; set -f</code>. An empty <code>IFS</code> variable
disables split; the <code>-f</code> (or <code>-o noglob</code>) shell option disables pathname
expansion. The safe mode sets these, and two others (see below).</p>
<p dir="auto">The reason these safer settings are hardly ever used is that they are not
practical to use with the standard shell language. For instance, <code>for textfile in *.txt</code>, or <code>for item in $(some command)</code> which both (!)
field-splits <em>and</em> pathname-expands the output of a command, all break.</p>
<p dir="auto">However, that is where modernish comes in. It introduces several powerful
new <a href="#user-content-use-varloop">loop constructs</a>, as well as arbitrary code
blocks with <a href="#user-content-use-varlocal">local settings</a>, each of which
has straightforward, intuitive operators for safely applying field splitting
<em>or</em> pathname expansion – to specific command arguments only. By default,
they are <em>not both</em> applied to the arguments, which is much safer. And your
script code as a whole is kept safe from them at all times.</p>
<p dir="auto">With global field splitting and pathname expansion removed, a third issue
still affects the safe mode: the shell&#39;s <em>empty removal</em> mechanism. If the
value of an unquoted expansion like <code>$var</code> is empty, it will not expand to
an empty argument, but will be removed altogether, as if it were never
there. This behaviour cannot be disabled.</p>
<p dir="auto">Thankfully, the vast majority of shell and Un*x commands order their arguments
in a way that is actually designed with empty removal in mind, making it a
good thing. For instance, when doing <code>ls $option some_dir</code>, if <code>$option</code> is
<code>-l</code> the listing will be long-format and if is empty it will be removed, which
is the desired behaviour. (An empty argument there would cause an error.)</p>
<p dir="auto">However, one command that is used in almost all shell scripts, <code>test</code>/<code>[</code>,
is <em>completely unable to cope with empty removal</em> due to its idiosyncratic
and counterintuitive syntax. Potentially empty operands come before options,
so operands removed as empty expansions cause errors or, worse, false
positives. Thus, the safe mode does <em>not</em> remove the need for paranoid
quoting of expansions used with <code>test</code>/<code>[</code> commands. Modernish fixes
this issue by <em>deprecating <code>test</code>/<code>[</code> completely</em> and offering
<a href="#user-content-testing-numbers-strings-and-files">a safe command design</a>
to use instead, which correctly deals with empty removal.</p>
<p dir="auto">With the &#39;safe mode&#39; shell settings, plus the safe, explicit and readable
split and glob operators and <code>test</code>/<code>[</code> replacements, the only quoting
requirements left are:</p>
<ol dir="auto">
<li>a very occasional need to stop empty removal from happening;</li>
<li>to quote <code>&#34;$@&#34;</code> and <code>&#34;$*&#34;</code> until shell bugs are fixed (see notes below).</li>
</ol>
<p dir="auto">In addition to the above, the safe mode also sets these shell options:</p>
<ul dir="auto">
<li><code>set -C</code> (<code>set -o noclobber</code>) to prevent accidentally overwriting files using
output redirection. To force overwrite, use <code>&gt;|</code> instead of <code>&gt;</code>.</li>
<li><code>set -u</code> (<code>set -o nounset</code>) to make it an error to use unset (that is,
uninitialised) variables by default. You&#39;ll notice this will catch many
typos before they cause you hard-to-trace problems. To bypass the check
for a specific variable, use <code>${var-}</code> instead of <code>$var</code> (be careful).</li>
</ul>
<div dir="auto"><h4 tabindex="-1" dir="auto">Important notes for safe mode</h4><a id="user-content-important-notes-for-safe-mode" aria-label="Permalink: Important notes for safe mode" href="#important-notes-for-safe-mode"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>The safe mode is <em>not</em> compatible with existing conventional shell scripts,
written in what we could now call the &#39;legacy mode&#39;. Essentially, the safe
mode is a new way of shell script programming. That is why it is not enabled
by default, but activated by loading the <code>safe</code> module. <em>It is highly
recommended that new modernish scripts start out with <code>use safe</code>.</em></li>
<li>The shell applies entirely different quoting rules to string matching glob
patterns within <code>case</code> constructs. The safe mode changes nothing here.</li>
<li>Due to <a href="#user-content-bugs">shell bugs</a> ID&#39;ed as <code>BUG_PP_*</code>, the positional
parameters expansions <code>$@</code> and <code>$*</code> should still <em>always</em> be quoted. As of
late 2018, these bugs have been fixed in the latest or upcoming release
versions of all
<a href="#user-content-appendix-d-supported-shells">supported shells</a>.
But, until buggy versions fall out of use
and modernish no longer supports any <code>BUG_PP_*</code> shell bugs, quoting <code>&#34;$@&#34;</code>
and <code>&#34;$*&#34;</code> remains mandatory even in safe mode (unless you know with
certainty that your script will be used on a shell with none of these bugs).</li>
<li>The behaviour of <code>&#34;$*&#34;</code> changes in safe mode. It uses the first character
of <code>$IFS</code> as the separator for combining all positional parameters into
one string. Since <code>IFS</code> is emptied in safe mode, there is no separator,
so it will string them together unseparated. You can use something like
<a href="#user-content-the-stack"><code>push IFS; IFS=&#39; &#39;; var=&#34;$*&#34;; pop IFS</code></a>
or <a href="#user-content-use-varlocal"><code>LOCAL IFS=&#39; &#39;; BEGIN var=&#34;$*&#34;; END</code></a>
to use the space character as a separator.
(If you&#39;re outputting the positional parameters, note that the
<a href="#user-content-outputting-strings"><code>put</code></a>
command always separates its arguments by spaces, so you can
safely pass it multiple arguments with <code>&#34;$@&#34;</code> instead.)</li>
</ul>
<div dir="auto"><h4 tabindex="-1" dir="auto">Extra options for the safe mode</h4><a id="user-content-extra-options-for-the-safe-mode" aria-label="Permalink: Extra options for the safe mode" href="#extra-options-for-the-safe-mode"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Usage: <code>use safe</code> [ <code>-k</code> | <code>-K</code> ] [ <code>-i</code> ]</p>
<p dir="auto">The <code>-k</code> and <code>-K</code> module options install an extra handler that
<a href="#user-content-reliable-emergency-halt">reliably kills the program</a>
if it tries to execute a command that is not found, on shells that have the
ability to catch and handle &#39;command not found&#39; errors (currently bash, yash,
and zsh). This helps catch typos, forgetting to load a module, etc., and stops
your program from continuing in an inconsistent state and potentially causing
damage. The <code>MSH_NOT_FOUND_OK</code> variable may be set to temporarily disable this
check. The uppercase <code>-K</code> module option aborts the program on shells that
cannot handle &#39;command not found&#39; errors (so should not be used for portable
scripts), whereas the lowercase <code>-k</code> variant is ignored on such shells.</p>
<p dir="auto">If the <code>-i</code> option is given, or the shell is interactive, two extra one-letter
functions are loaded, <code>s</code> and <code>g</code>. These are pre-command modifiers for use when
split and glob are globally disabled; they allow running a single command with
local split and glob applied to that command&#39;s arguments only. They also have
some options designed to manipulate, examine, save, restore, and generally
experiment with the global split and glob state on interactive shells. Type
<code>s --help</code> and <code>g --help</code> for more information. In general, the safe mode is
designed for scripts and is not recommended for interactive shells.</p>

<p dir="auto">The <code>var/loop</code> module provides an innovative, robust and extensible
shell loop construct. Several powerful loop types are provided, while
advanced shell programmers may find it easy and fun to
<a href="#user-content-creating-your-own-loop">create their own</a>.
This construct is also ideal for the
<a href="#user-content-use-safe">safe mode</a>:
the <code>for</code>, <code>select</code> and <code>find</code> loop types allow you to selectively
apply field splitting and/or pathname expansion to specific arguments
without subjecting a single line of your code to them.</p>
<p dir="auto">The basic form is a bit different from native shell loops. Note the caps:</p>
<p dir="auto">The familiar <code>do</code>...<code>done</code> block syntax cannot be used because the shell
will not allow modernish to add its own functionality to it. The
<code>DO</code>...<code>DONE</code> block does behave in the same way as <code>do</code>...<code>done</code>: you can
append redirections at the end, pipe commands into a loop, etc. as usual.
The <code>break</code> and <code>continue</code> shell builtin commands also work as normal.</p>
<p dir="auto"><strong>Remember:</strong> <em>using lowercase <code>do</code>...<code>done</code> with modernish <code>LOOP</code> will
cause the shell to throw a misleading syntax error.</em> So will using uppercase
<code>DO</code>...<code>DONE</code> with the shell&#39;s native loops. To help you remember to use the
uppercase variants for modernish loops, the <code>LOOP</code> keyword itself is also in
capitals.</p>
<p dir="auto">Loops exist in submodules of <code>var/loop</code> named after the loop type; for
instance, the <code>find</code> loop lives in the <code>var/loop/find</code> module. However, the
core <code>var/loop</code> module will automatically load a loop type&#39;s module when
that loop is first used, so <code>use</code>-ing individual loop submodules at your
script&#39;s startup time is optional.</p>
<p dir="auto">The <code>LOOP</code> block internally uses file descriptor 8 to do
<a href="#user-content-creating-your-own-loop">its thing</a>.
If your script happens to use FD 8 for other purposes, you should
know that FD 8 is made local to each loop block, and always appears
initially closed within <code>DO</code>...<code>DONE</code>.</p>

<p dir="auto">This simply iterates the loop the number of times indicated. Before the first
iteration, the argument is evaluated as a shell integer arithmetic expression
as in <a href="#user-content-integer-number-arithmetic-tests-and-operations"><code>let</code></a>
and its value used as the number of iterations.</p>
<div dir="auto" data-snippet-clipboard-copy-content="LOOP repeat 3; DO
	putln &#34;This line is repeated 3 times.&#34;
DONE"><pre>LOOP repeat 3<span>;</span> DO
	putln <span><span>&#34;</span>This line is repeated 3 times.<span>&#34;</span></span>
DONE</pre></div>
<div dir="auto"><h4 tabindex="-1" dir="auto">BASIC-style arithmetic <code>for</code> loop</h4><a id="user-content-basic-style-arithmetic-for-loop" aria-label="Permalink: BASIC-style arithmetic for loop" href="#basic-style-arithmetic-for-loop"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This is a slightly enhanced version of the
<a href="https://en.wikipedia.org/wiki/BASIC#Origin" rel="nofollow"><code>FOR</code> loop in BASIC</a>.
It is more versatile than the <code>repeat</code> loop but still very easy to use.</p>
<p dir="auto"><code>LOOP for</code> <em>varname</em><code>=</code><em>initial</em> to <em>limit</em> [ <code>step</code> <em>increment</em> ]; DO</p>
<p dir="auto">To count from 1 to 20 in steps of 2:</p>
<div dir="auto" data-snippet-clipboard-copy-content="LOOP for i=1 to 20 step 2; DO
	putln &#34;$i&#34;
DONE"><pre>LOOP <span>for</span> i=1 to 20 step 2<span>;</span> DO
	putln <span><span>&#34;</span><span>$i</span><span>&#34;</span></span>
DONE</pre></div>
<p dir="auto">Note the <em>varname</em><code>=</code><em>initial</em> needs to be one argument as in a shell
assignment (so no spaces around the <code>=</code>).</p>
<p dir="auto">If &#34;<code>step</code> <em>increment</em>&#34; is omitted, <em>increment</em> defaults to 1 if <em>limit</em> is
equal to or greater than <em>initial</em>, or to -1 if <em>limit</em> is less than
<em>initial</em> (so counting backwards &#39;just works&#39;).</p>
<p dir="auto">Technically precise description: On entry, the <em>initial</em>, <em>limit</em> and
<em>increment</em> values are evaluated once as shell arithmetic expressions as in
<a href="#user-content-integer-number-arithmetic-tests-and-operations"><code>let</code></a>,
the value of <em>initial</em> is assigned to <em>varname</em>, and the loop iterates.
Before every subsequent iteration, the value of <em>increment</em> (as determined
on the first iteration) is added to the value of <em>varname</em>, then the <em>limit</em>
expression is re-evaluated; as long as the current value of <em>varname</em> is
less (if <em>increment</em> is non-negative) or greater (if <em>increment</em> is
negative) than or equal to the current value of <em>limit</em>, the loop reiterates.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto">C-style arithmetic <code>for</code> loop</h4><a id="user-content-c-style-arithmetic-for-loop" aria-label="Permalink: C-style arithmetic for loop" href="#c-style-arithmetic-for-loop"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">A C-style for loop akin to <code>for (( ))</code> in ksh93, bash and zsh is now
available on all POSIX-compliant shells, with a slightly different syntax.
The one loop argument contains three arithmetic expressions (as in
<a href="#user-content-integer-number-arithmetic-tests-and-operations"><code>let</code></a>),
separated by semicolons within that argument. The first is only evaluated
before the first iteration, so is typically used to assign an initial value.
The second is evaluated before each iteration to check whether to continue
the loop, so it typically contains some comparison operator. The third is
evaluated before the second and further iterations, and typically increases
or decreases a value. For example, to count from 1 to 10:</p>
<div dir="auto" data-snippet-clipboard-copy-content="LOOP for &#34;i=1; i&lt;=10; i+=1&#34;; DO
	putln &#34;$i&#34;
DONE"><pre>LOOP <span>for</span> <span><span>&#34;</span>i=1; i&lt;=10; i+=1<span>&#34;</span></span><span>;</span> DO
	putln <span><span>&#34;</span><span>$i</span><span>&#34;</span></span>
DONE</pre></div>
<p dir="auto">However, using complex expressions allows doing much more powerful things.
Any or all of the three expressions may also be left empty (with their
separating <code>;</code> character remaining). If the second expression is empty, it
defaults to 1, creating an infinite loop.</p>
<p dir="auto">(Note that <code>++i</code> and <code>i++</code> can only be used on shells with
<a href="#user-content-appendix-a-list-of-shell-cap-ids"><code>ARITHPP</code></a>,
but <code>i+=1</code> or <code>i=i+1</code> can be used on all POSIX-compliant shells.)</p>
<div dir="auto"><h4 tabindex="-1" dir="auto">Enumerative <code>for</code>/<code>select</code> loop with safe split/glob</h4><a id="user-content-enumerative-forselect-loop-with-safe-splitglob" aria-label="Permalink: Enumerative for/select loop with safe split/glob" href="#enumerative-forselect-loop-with-safe-splitglob"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The enumarative <code>for</code> and <code>select</code> loop types mirror those already present in
native shell implementations. However, the modernish versions provide safe
field splitting and globbing (pathname expansion) functionality that can be
used without globally enabling split or glob for any of your code – ideal
for the <a href="#user-content-use-safe">safe</a> mode. They also add a unique operator
for processing text in fixed-size slices. The <code>select</code> loop type brings
<code>select</code> functionality to all POSIX shells and not just ksh, zsh and bash.</p>
<p dir="auto">Usage:</p>
<p dir="auto"><code>LOOP</code> [ <code>for</code> | <code>select</code> ] [ <em>operators</em> ] <em>varname</em> <code>in</code> <em>argument</em> ... <code>;</code>
<code>DO</code> <em>commands</em> <code>;</code> <code>DONE</code></p>
<p dir="auto">Simple usage example:</p>
<div dir="auto" data-snippet-clipboard-copy-content="LOOP select --glob textfile in *.txt; DO
	putln &#34;You chose text file $textfile.&#34;
DONE"><pre>LOOP <span>select</span> <span>--glob</span> textfile <span>in</span> <span>*</span>.txt<span>;</span> DO
	putln <span><span>&#34;</span>You chose text file <span>$textfile</span>.<span>&#34;</span></span>
DONE</pre></div>
<p dir="auto">If the loop type is <code>for</code>, the loop iterates once for each <em>argument</em>, storing
it in the variable named <em>varname</em>.</p>
<p dir="auto">If the loop type is <code>select</code>, the loop presents before each iteration a
numbered menu that allows the user to select one of the <em>argument</em>s. The prompt
from the <code>PS3</code> variable is displayed and a reply read from standard input. The
literal reply is stored in the <code>REPLY</code> variable. If the reply was a number
corresponding to an <em>argument</em> in the menu, that <em>argument</em> is stored in the
variable named <em>varname</em>. Then the loop iterates. If the user enters ^D (end of
file), <code>REPLY</code> is cleared and the loop breaks with an exit status of 1. (To
break the menu loop under other conditions, use the <code>break</code> command.)</p>
<p dir="auto">The following operators are supported. Note that the split and glob
operators are only for use in the <a href="#user-content-use-safe">safe mode</a>.</p>
<ul dir="auto">
<li>One of <code>--split</code> or <code>--split=</code><em>characters</em>. This operator safely applies
the shell&#39;s field splitting mechanism to the <em>argument</em>s given. The simple
<code>--split</code> operator applies the shell&#39;s default field splitting by space,
tab, and newline. If you supply one or more of your own <em>characters</em> to
split by, each of these characters will be taken as a field separator if
it is whitespace, or field terminator if it is non-whitespace. (Note that
shells with <a href="#user-content-quirks"><code>QRK_IFSFINAL</code></a> treat both whitespace and
non-whitespace characters as separators.)</li>
<li>One of <code>--glob</code> or <code>--fglob</code>. These operators safely apply shell pathname
expansion (globbing) to the <em>argument</em>s given. Each <em>argument</em> is taken as
a pattern, whether or not it contains any wildcard characters. For any
resulting pathname that starts with <code>-</code> or <code>+</code> or is identical to <code>!</code> or
<code>(</code>, <code>./</code> is prefixed to keep various commands from misparsing it as an
option or operand. Non-matching patterns are treated as follows:
<ul dir="auto">
<li><code>--glob</code>: Any non-matching patterns are quietly removed. If none match,
the loop will not iterate but break with exit status 103.</li>
<li><code>--fglob</code>: All patterns must match. Any nonexistent path terminates the
program. Use this if your program would not work after a non-match.</li>
</ul>
</li>
<li><code>--base=</code><em>string</em>. This operator prefixes the given <em>string</em> to each of the
<em>arguments</em>, after first applying field splitting and/or pathname expansion
if specified.
If <code>--glob</code> or <code>--fglob</code> are given, then the <em>string</em> is used as a base
directory path for pathname expansion, without expanding any wildcard
characters in that base directory path itself.
If such base directory can&#39;t be entered, then if <code>--glob</code> was given, the loop
breaks with status 98, or if <code>--fglob</code> was given, the program terminates.</li>
<li>One of <code>--slice</code> or <code>--slice=</code><em>number</em>. This operator divides the
<em>argument</em>s in slices of up to <em>number</em> characters. The default slice size
is 1 character, allowing for easy character-by-character processing.
(Note that shells with <a href="#user-content-warning-ids"><code>WRN_MULTIBYTE</code></a> will
not slice multi-byte characters correctly.)</li>
</ul>
<p dir="auto">If multiple operators are given, their mechanisms are applied in the
following order: split, glob, base, slice.</p>

<p dir="auto">This powerful loop type turns your local POSIX-compliant
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/find.html" rel="nofollow"><code>find</code> utility</a>
into a shell loop, safely integrating both <code>find</code>
and <code>xargs</code> functionality into the POSIX shell. The infamous
<a href="https://dwheeler.com/essays/filenames-in-shell.html#find" rel="nofollow">pitfalls and limitations</a>
of using <code>find</code> and <code>xargs</code> as external commands are gone, as all
the results from <code>find</code> are readily available to your main shell
script. Any &#34;dangerous&#34; characters in file names (including
whitespace and even newlines) &#34;just work&#34;, especially if the
<a href="#user-content-use-safe">safe mode</a>
is also active. This gives you the flexibility to use either the <code>find</code>
expression syntax, or shell commands (including your own shell functions), or
some combination of both, to decide whether and how to handle each file found.</p>
<p dir="auto">Usage:</p>
<p dir="auto"><code>LOOP find</code> [ <em>options</em> ] <em>varname</em> [ <code>in</code> <em>path</em> ... ]
[ <em>find-expression</em> ] <code>;</code> <code>DO</code> <em>commands</em> <code>;</code> <code>DONE</code></p>
<p dir="auto"><code>LOOP find</code> [ <em>options</em> ] <code>--xargs</code>[<code>=</code><em>arrayname</em>] [ <code>in</code> <em>path</em> ... ]
[ <em>find-expression</em> ] <code>;</code> <code>DO</code> <em>commands</em> <code>;</code> <code>DONE</code></p>
<p dir="auto">The loop recursively walks down the directory tree for each <em>path</em> given.
For each file encountered, it uses the <em>find-expression</em> to decide
whether to iterate the loop with the path to the file stored in the
variable referenced by <em>varname</em>. The <em>find-expression</em> is a standard
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/find.html" rel="nofollow"><code>find</code></a>
utility expression except as described below.</p>
<p dir="auto">Any number of paths to search may be specified after the <code>in</code> keyword.
By default, a nonexistent path is a <a href="#user-content-reliable-emergency-halt">fatal error</a>.
The entire <code>in</code> clause may be omitted, in which case it defaults to <code>in .</code>
so the current working directory will be searched. Any argument that starts
with a <code>-</code>, or is identical to <code>!</code> or <code>(</code>, indicates the end of the <em>path</em>s
and the beginning of the <em>find-expression</em>; if you need to explicitly
specify a path with such a name, prefix <code>./</code> to it.</p>
<p dir="auto">Except for syntax errors, any errors or warnings issued by <code>find</code> are
considered non-fatal and will cause the exit status of the loop to be
non-zero, so your script has the opportunity to handle the exception.</p>

<ul dir="auto">
<li>Any single-letter options supported by your local <code>find</code> utility. Note that
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/find.html" rel="nofollow">POSIX specifies</a>
<code>-H</code> and <code>-L</code> only, so portable scripts should only use these.
Options that require arguments (<code>-f</code> on BSD <code>find</code>) are not supported.</li>
<li><code>--xargs</code>. This operator is specified <strong>instead</strong> of the <em>varname</em>; it is a
syntax error to have both. Instead of one iteration per found item, as many
items as possible per iteration are stored into the positional parameters
(PPs), so your program can access them in the usual way (using <code>&#34;$@&#34;</code> and
friends). Note that <code>--xargs</code> therefore overwrites the current PPs (however,
a shell function or <a href="#user-content-use-varlocal"><code>LOCAL</code></a> block will give
you local PPs). Modernish clears the PPs upon completion of the loop, but if
the loop is exited prematurely (such as by <code>break</code>), the last chunk survives.
<ul dir="auto">
<li>On shells with the <code>KSHARRAY</code>
<a href="#user-content-appendix-a-list-of-shell-cap-ids">capability</a>, an
extra variant is available: <code>--xargs=</code><em>arrayname</em> which uses the named
array instead of the PPs. It otherwise works identically.</li>
</ul>
</li>
<li><code>--try</code>. If this option is specified, then if one of the primaries used in
the <em>find-expression</em> is not supported by either the <code>find</code> utility used by
the loop or by modernish itself, <code>LOOP find</code> will not throw a
<a href="#user-content-reliable-emergency-halt">fatal error</a>
but will instead quietly abort the loop without iterating it, set the loop&#39;s
exit status to 128, and leave the invalid primary in the <code>REPLY</code> variable.
(Expression errors other than &#39;unknown primary&#39; remain fatal errors.)</li>
<li>One of <code>--split</code> or <code>--split=</code><em>characters</em>. This operator, which is only
accepted in the <a href="#user-content-use-safe">safe mode</a>, safely applies the
shell&#39;s field splitting mechanism to the <em>path</em> name(s) given <em>(but <strong>not</strong>
to any patterns in the <em>find-expression</em>, which are passed on to the <code>find</code>
utility as given)</em>. The simple <code>--split</code> operator applies the shell&#39;s default
field splitting by space, tab, and newline. Alternatively, you can supply
one or more <em>characters</em> to split by. If any pathname resulting from the
split starts with <code>-</code> or <code>+</code> or is identical to <code>!</code> or <code>(</code>, <code>./</code> is prefixed.</li>
<li>One of <code>--glob</code> or <code>--fglob</code>. These operators are only accepted in the
<a href="#user-content-use-safe">safe mode</a>. They safely apply shell pathname
expansion (globbing) to the <em>path</em> name(s) given <em>(but <strong>not</strong> to any
patterns in the <em>find-expression</em>, which are passed on to the <code>find</code> utility
as given)</em>. All <em>path</em> names are taken as patterns, whether or not they
contain any wildcard characters. If any pathname resulting from the
expansion start with <code>-</code> or <code>+</code> or is identical to <code>!</code> or <code>(</code>, <code>./</code> is
prefixed. Non-matching patterns are treated as follows:
<ul dir="auto">
<li><code>--glob</code>: Any pattern not matching an existing path will output a
warning to standard error and set the loop&#39;s exit status to 103 upon
normal completion, even if other existing paths are processed
successfully. If none match, the loop will not iterate.</li>
<li><code>--fglob</code>: Any pattern not matching an existing path is a fatal error.</li>
</ul>
</li>
<li><code>--base=</code><em>basedirectory</em>. This operator prefixes the given <em>basedirectory</em>
to each of the <em>path</em> names (and thus to each path found by <code>find</code>), after
first applying field splitting and/or pathname expansion if specified.
If <code>--glob</code> or <code>--fglob</code> are given, then wildcard characters are only
expanded in the <em>path</em> names and not in the prefixed <em>basedirectory</em>.
If the <em>basedirectory</em> can&#39;t be entered, then either the loop breaks with
status 98, or if <code>--fglob</code> was given, the program terminates.</li>
</ul>
<div dir="auto"><h5 tabindex="-1" dir="auto">Available <em>find-expression</em> operands</h5><a id="user-content-available-find-expression-operands" aria-label="Permalink: Available find-expression operands" href="#available-find-expression-operands"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>LOOP find</code> can use all expression operands supported by your local <code>find</code>
utility; see its manual page. However, portable scripts should use only
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/find.html#tag_20_47_05" rel="nofollow">operands specified by POSIX</a>
along with the modernish additions described below.</p>
<p dir="auto">The modernish <code>-iterate</code> expression primary evaluates as true and causes the
loop to iterate, executing your <em>commands</em> for each matching file. It may be
used any number of times in the <em>find-expression</em> to start a corresponding
series of loop iterations. If it is not given, the loop acts as if the entire
<em>find-expression</em> is enclosed in parentheses with <code>-iterate</code> appended. If the
entire <em>find-expression</em> is omitted, it defaults to <code>-iterate</code>.</p>
<p dir="auto">The modernish <code>-ask</code> primary asks confirmation of the user. The text of the
prompt may be specified in one optional argument (which cannot start with <code>-</code>
or be equal to <code>!</code> or <code>(</code>). Any occurrences of the characters <code>{}</code> within the
prompt text are replaced with the current pathname. If not specified, the
default prompt is: <code>&#34;{}&#34;?</code> If the answer is affirmative (<code>y</code> or <code>Y</code> in the
POSIX locale), <code>-ask</code> yields true, otherwise false. This can be used to make
any part of the expression conditional upon user input, and (unlike commands in
the shell loop body) is capable of influencing directory traversal mid-run.</p>
<p dir="auto">The standard <code>-exec</code> and <code>-ok</code> primaries are integrated into the main shell
environment. When used with <code>LOOP find</code>, they can call a shell builtin command
or your own shell function directly in the main shell (no subshell). Its exit
status is used in the <code>find</code> expression as a true/false value capable of
influencing directory traversal (for example, when combined with <code>-prune</code>),
just as if it were an external command -exec&#39;ed with the standard utility.</p>
<p dir="auto">Some familiar, easy-to-use but non-standard <code>find</code> operands from GNU and/or
BSD may be used with <code>LOOP find</code> on all systems. Before invoking the <code>find</code>
utility, modernish translates them internally to portable equivalents.
The following expression operands are made portable:</p>
<ul dir="auto">
<li>The <code>-or</code>, <code>-and</code> and <code>-not</code> operators: same as <code>-o</code>, <code>-a</code>, <code>!</code>.</li>
<li>The <code>-true</code> and <code>-false</code> primaries, which always yield true/false.</li>
<li>The BSD-style <code>-depth</code> <em>n</em> primary, e.g. <code>-depth +4</code> yields true on depth
greater than 4 (minimum 5), <code>-depth -4</code> yields true on depth less than 4
(maximum 3), and <code>-depth 4</code> yields true on a depth of exactly 4.</li>
<li>The GNU-style <code>-mindepth</code> and <code>-maxdepth</code> global options.
Unlike BSD <code>-depth</code>, these GNU-isms are pseudo-primaries that
always yield true and affect the entire <code>LOOP find</code> operation.</li>
</ul>
<p dir="auto">Expression primaries that write output (<code>-print</code> and friends) may be used for
debugging or logging the loop. Their output is redirected to standard error.</p>

<p dir="auto">Upon initialisation, the <code>var/loop/find</code> module searches for a POSIX-compliant
<code>find</code> utility under various names in <code>$DEFPATH</code> and then in <code>$PATH</code>. To see a
trace of the full command lines of utility invocations when the loop runs, set
the <code>_loop_DEBUG</code> variable to any value.</p>
<p dir="auto">For debugging or system-specific usage, it is possible to use a certain <code>find</code>
utility in preference to any others on the system. To do this, add an argument
to a <code>use var/loop/find</code> command before the first use of the loop. For example:</p>
<ul dir="auto">
<li><code>use var/loop/find bsdfind</code> (prefer utility by this name)</li>
<li><code>use var/loop/find /opt/local/bin</code> (look for a utility here first)</li>
<li><code>use var/loop/find /opt/local/bin/gfind</code>  (try this one first)</li>
</ul>
<div dir="auto"><h5 tabindex="-1" dir="auto">Compatibility mode for obsolete <code>find</code> utilities</h5><a id="user-content-compatibility-mode-for-obsolete-find-utilities" aria-label="Permalink: Compatibility mode for obsolete find utilities" href="#compatibility-mode-for-obsolete-find-utilities"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Some systems come with obsolete or broken <code>find</code> utilities that don&#39;t fully
support <code>-exec ... {} +</code> aggregating functionality as specified by POSIX.
Normally, this is a fatal error, but passing the <code>-b</code>/<code>-B</code> option to the
<code>use</code> command, e.g. <code>use var/loop/find -b</code>, enables a compatibility mode
that tolerates this defect. If no compliant <code>find</code> is found, then an obsolete
or broken <code>find</code> is used as a last resort, a warning is printed to standard
error, and the variable <code>_loop_find_broken</code> is set. The <code>-B</code> option is
equivalent to <code>-b</code> but does not print a warning. Loop performance may suffer as
modernish adapts to using older <code>exec ... {} \;</code> which is very inefficient.</p>
<p dir="auto">Scripts using this compatibility mode should handle their logic using shell
code in the loop body as much as possible (after <code>DO</code>) and use only simple
<code>find</code> expressions (before <code>DO</code>), as obsolete utilities are often buggy and
breakage is likely if complex expressions or advanced features are used.</p>

<p dir="auto">Simple example script: without the safe mode, the <code>*.txt</code> pattern
must be quoted to prevent it from being expanded by the shell.</p>
<div dir="auto" data-snippet-clipboard-copy-content=". modernish
use var/loop
LOOP find TextFile in ~/Documents -name &#39;*.txt&#39;
DO
	putln &#34;Found my text file: $TextFile&#34;
DONE"><pre><span>.</span> modernish
use var/loop
LOOP find TextFile <span>in</span> <span>~</span>/Documents -name <span><span>&#39;</span>*.txt<span>&#39;</span></span>
DO
	putln <span><span>&#34;</span>Found my text file: <span>$TextFile</span><span>&#34;</span></span>
DONE</pre></div>
<p dir="auto">Example script with <a href="#user-content-use-safe">safe mode</a>: the <code>--glob</code> option
expands the patterns of the <code>in</code> clause, but <em>not</em> the expression – so it
is not necessary to quote any pattern.</p>
<div dir="auto" data-snippet-clipboard-copy-content=". modernish
use safe
use var/loop
LOOP find --glob lsProg in /*bin /*/*bin -type f -name ls*
DO
	putln &#34;This command may list something: $lsProg&#34;
DONE"><pre><span>.</span> modernish
use safe
use var/loop
LOOP find --glob lsProg <span>in</span> /<span>*</span>bin /<span>*</span>/<span>*</span>bin -type f -name ls<span>*</span>
DO
	putln <span><span>&#34;</span>This command may list something: <span>$lsProg</span><span>&#34;</span></span>
DONE</pre></div>
<p dir="auto">Example use of the modernish <code>-ask</code> primary: ask the user if they want to
descend into each directory found. The shell loop body could skip unwanted
results, but cannot physically influence directory traversal, so skipping large
directories would take long. A <code>find</code> expression can prevent directory
traversal using the standard <code>-prune</code> primary, which can be combined with
<code>-ask</code>, so that unwanted directories never iterate the loop in the first place.</p>
<div dir="auto" data-snippet-clipboard-copy-content=". modernish
use safe
use var/loop
LOOP find file in ~/Documents \
	-type d \( -ask &#39;Descend into &#34;{}&#34; directory?&#39; -or -prune \) \
	-or -iterate
DO
	put &#34;File found: &#34;
	ls -li $file
DONE"><pre><span>.</span> modernish
use safe
use var/loop
LOOP find file <span>in</span> <span>~</span>/Documents \
	-type d <span>\(</span> -ask <span><span>&#39;</span>Descend into &#34;{}&#34; directory?<span>&#39;</span></span> -or -prune <span>\)</span> \
	-or -iterate
DO
	put <span><span>&#34;</span>File found: <span>&#34;</span></span>
	ls -li <span>$file</span>
DONE</pre></div>

<p dir="auto">The modernish loop construct is extensible. To define a new loop type, you
only need to define a shell function called <code>_loopgen_</code><em>type</em> where <em>type</em>
is the loop type. This function, called the <em>loop iteration generator</em>, is
expected to output lines of text to file descriptor 8, containing properly
<a href="#user-content-use-varshellquote">shell-quoted</a>
iteration commands for the shell to run, one line per iteration.</p>
<p dir="auto">The internal commands expanded from <code>LOOP</code>, <code>DO</code> and <code>DONE</code> (which are
defined as aliases) launch that loop iteration generator function in the
background with <a href="#user-content-use-safe">safe</a> mode enabled, while causing
the main shell to read lines from that background process through a pipe,
<code>eval</code>ing each line as a command before iterating the loop. As long as that
iteration command finishes with an exit status of zero, the loop keeps
iterating. If it has a nonzero exit status or if there are no more commands
to read, iteration terminates and execution continues beyond the loop.</p>
<p dir="auto">Instead of the normal <a href="#user-content-internal-namespace">internal namespace</a>
which is considered off-limits for modernish scripts, <code>var/loop</code> and its
submodules use a <code>_loop_*</code> internal namespace for variables, which is also
for use by user-implemented loop iteration generator functions.</p>
<p dir="auto">The above is just the general principle. For the details, study the comments
and the code in <code>lib/modernish/mdl/var/loop.mm</code> and the loop generators in
<code>lib/modernish/mdl/var/loop/*.mm</code>.</p>

<p dir="auto">This module defines a new <code>LOCAL</code>...<code>BEGIN</code>...<code>END</code> shell code block
construct with local variables, local positional parameters and local shell
options. The local positional parameters can be filled using safe field
splitting and pathname expansion operators similar to those in the <code>LOOP</code>
construct described <a href="#user-content-use-varloop">above</a>.</p>
<p dir="auto">Usage: <code>LOCAL</code> [ <em>localitem</em> | <em>operator</em> ... ] [ <code>--</code> [ <em>word</em> ... ] ] <code>;</code>
<code>BEGIN</code> <em>commands</em> <code>;</code> <code>END</code></p>
<p dir="auto">The <em>commands</em> are executed once, with the specified <em>localitem</em>s applied.
Each <em>localitem</em> can be:</p>
<ul dir="auto">
<li>A variable name with or without a <code>=</code> immediately followed by a value.
This renders that variable local to the block, initially either unsetting
it or assigning the value, which may be empty.</li>
<li>A shell option letter immediately preceded by a <code>-</code> or <code>+</code> sign. This
locally turns that shell option on or off, respectively. This follows the
counterintuitive syntax of <code>set</code>. Long-form shell options like <code>-o</code>
<em>optionname</em> and <code>+o</code> <em>optionname</em> are also supported. It depends on the
shell what options are supported. Specifying a nonexistent option is a
fatal error. Use <a href="#user-content-shell-capability-detection"><code>thisshellhas</code></a> to check
for a non-POSIX option&#39;s existence on the current shell before using it.</li>
</ul>
<p dir="auto">Modernish implements <code>LOCAL</code> blocks as one-time shell functions that use
<a href="#user-content-the-stack">the stack</a>
to save and restore variables and settings. So the <code>return</code> command exits the
block, causing the global variables and settings to be restored and resuming
execution at the point immediately following <code>END</code>. Like any shell function, a
<code>LOCAL</code> block exits with the exit status of the last command executed within
it, or with the status passed on by or given as an argument to <code>return</code>.</p>
<p dir="auto">The positional parameters (<code>$@</code>, <code>$1</code>, etc.) are always local to the block, but
a copy is inherited from outside the block by default. Any changes to the
positional parameters made within the block will be discarded upon exiting it.</p>
<p dir="auto">However, if a double-dash <code>--</code> argument is given in the <code>LOCAL</code> command line,
the positional parameters outside the block are ignored and the set of <em>word</em>s
after <code>--</code> (which may be empty) becomes the positional parameters instead.</p>
<p dir="auto">These <em>word</em>s can be modified prior to entering the <code>LOCAL</code> block using the
following <em>operator</em>s. The safe glob and split operators are only accepted in
the <a href="#user-content-use-safe">safe mode</a>. The operators are:</p>
<ul dir="auto">
<li>One of <code>--split</code> or <code>--split=</code><em>characters</em>. This operator safely applies
the shell&#39;s field splitting mechanism to the <em>word</em>s given. The simple
<code>--split</code> operator applies the shell&#39;s default field splitting by space,
tab, and newline. If you supply one or more of your own <em>characters</em> to
split by, each of these characters will be taken as a field separator if
it is whitespace, or field terminator if it is non-whitespace. (Note that
shells with <a href="#user-content-quirks"><code>QRK_IFSFINAL</code></a> treat both whitespace and
non-whitespace characters as separators.)</li>
<li>One of <code>--glob</code> or <code>--fglob</code>. These operators safely apply shell pathname
expansion (globbing) to the <em>word</em>s given. Each <em>word</em> is taken as a pattern,
whether or not it contains any wildcard characters. For any resulting
pathname that starts with <code>-</code> or <code>+</code> or is identical to <code>!</code> or <code>(</code>, <code>./</code>
is prefixed to keep various commands from misparsing it as an option
or operand. Non-matching patterns are treated as follows:
<ul dir="auto">
<li><code>--glob</code>: Any non-matching patterns are quietly removed.</li>
<li><code>--fglob</code>: All patterns must match. Any nonexistent path terminates the
program. Use this if your program would not work after a non-match.</li>
</ul>
</li>
<li><code>--base=</code><em>string</em>. This operator prefixes the given <em>string</em> to each of the
<em>word</em>s, after first applying field splitting and/or pathname expansion
if specified.
If <code>--glob</code> or <code>--fglob</code> are given, then the <em>string</em> is used as a base
directory path for pathname expansion, without expanding any wildcard
characters in that base directory path itself.
If such base directory can&#39;t be entered, then if <code>--glob</code> was given, all
<em>word</em>s are removed, or if <code>--fglob</code> was given, the program terminates.</li>
<li>One of <code>--slice</code> or <code>--slice=</code><em>number</em>. This operator divides the
<em>word</em>s in slices of up to <em>number</em> characters. The default slice size
is 1 character, allowing for easy character-by-character processing.
(Note that shells with <a href="#user-content-warning-ids"><code>WRN_MULTIBYTE</code></a> will
not slice multi-byte characters correctly.)</li>
</ul>
<p dir="auto">If multiple operators are given, their mechanisms are applied in the
following order: split, glob, base, slice.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto">Important <code>var/local</code> usage notes</h4><a id="user-content-important-varlocal-usage-notes" aria-label="Permalink: Important var/local usage notes" href="#important-varlocal-usage-notes"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>Due to the limitations of aliases and shell reserved words, <code>LOCAL</code> has
to use its own <code>BEGIN</code>...<code>END</code> block instead of the shell&#39;s <code>do</code>...<code>done</code>.
Using the latter results in a misleading shell syntax error.</li>
<li><code>LOCAL</code> blocks do <strong>not</strong> mix well with use of the shell capability
<a href="#user-content-user-content-capabilities"><code>LOCALVARS</code></a>
(shell-native functionality for local variables), especially not on shells
with <code>QRK_LOCALUNS</code> or <code>QRK_LOCALUNS2</code>. Using both with the same variables
causes unpredictable behaviour, depending on the shell.</li>
<li><strong>Warning!</strong> Never use <code>break</code> or <code>continue</code> within a <code>LOCAL</code> block to
resume or break from enclosing loops outside the block! Shells with
<a href="#user-content-quirks"><code>QRK_BCDANGER</code></a> allow this, preventing <code>END</code> from
restoring the global settings and corrupting the stack; shells without
this quirk will throw an error if you try this. A proper way to do what
you want is to exit the block with a nonzero status using something like
<code>return 1</code>, then append something like <code>|| break</code> or <code>|| continue</code> to
<code>END</code>. Note that this caveat only applies when crossing <code>BEGIN</code>...<code>END</code>
boundaries. Using <code>continue</code> and <code>break</code> to continue or break loops
entirely <em>within</em> the block is fine.</li>
</ul>

<p dir="auto">These shortcut functions are alternatives for using
<a href="#user-content-the-arithmetic-command-let"><code>let</code></a>.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto">Arithmetic operator shortcuts</h4><a id="user-content-arithmetic-operator-shortcuts" aria-label="Permalink: Arithmetic operator shortcuts" href="#arithmetic-operator-shortcuts"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>inc</code>, <code>dec</code>, <code>mult</code>, <code>div</code>, <code>mod</code>: simple integer arithmetic shortcuts. The first
argument is a variable name. The optional second argument is an
arithmetic expression, but a sane default value is assumed (1 for inc
and dec, 2 for mult and div, 256 for mod). For instance, <code>inc X</code> is
equivalent to <code>X=$((X+1))</code> and <code>mult X Y-2</code> is equivalent to <code>X=$((X*(Y-2)))</code>.</p>
<p dir="auto"><code>ndiv</code> is like <code>div</code> but with correct rounding down for negative numbers.
Standard shell integer division simply chops off any digits after the
decimal point, which has the effect of rounding down for positive numbers
and rounding up for negative numbers. <code>ndiv</code> consistently rounds down.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto">Arithmetic comparison shortcuts</h4><a id="user-content-arithmetic-comparison-shortcuts" aria-label="Permalink: Arithmetic comparison shortcuts" href="#arithmetic-comparison-shortcuts"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">These have the same name as their <code>test</code>/<code>[</code> option equivalents. Unlike
with <code>test</code>, the arguments are shell integer arith expressions, which can be
anything from simple numbers to complex expressions. As with <code>$(( ))</code>,
variable names are expanded to their values even without the <code>$</code>.</p>
<div data-snippet-clipboard-copy-content="Function:         Returns successfully if:
eq &lt;expr&gt; &lt;expr&gt;  the two expressions evaluate to the same number
ne &lt;expr&gt; &lt;expr&gt;  the two expressions evaluate to different numbers
lt &lt;expr&gt; &lt;expr&gt;  the 1st expr evaluates to a smaller number than the 2nd
le &lt;expr&gt; &lt;expr&gt;  the 1st expr eval&#39;s to smaller than or equal to the 2nd
gt &lt;expr&gt; &lt;expr&gt;  the 1st expr evaluates to a greater number than the 2nd
ge &lt;expr&gt; &lt;expr&gt;  the 1st expr eval&#39;s to greater than or equal to the 2nd"><pre><code>Function:         Returns successfully if:
eq &lt;expr&gt; &lt;expr&gt;  the two expressions evaluate to the same number
ne &lt;expr&gt; &lt;expr&gt;  the two expressions evaluate to different numbers
lt &lt;expr&gt; &lt;expr&gt;  the 1st expr evaluates to a smaller number than the 2nd
le &lt;expr&gt; &lt;expr&gt;  the 1st expr eval&#39;s to smaller than or equal to the 2nd
gt &lt;expr&gt; &lt;expr&gt;  the 1st expr evaluates to a greater number than the 2nd
ge &lt;expr&gt; &lt;expr&gt;  the 1st expr eval&#39;s to greater than or equal to the 2nd
</code></pre></div>

<p dir="auto">This module is provided to solve a common POSIX shell language annoyance: in a
normal shell variable assignment, only literal variable names are accepted, so
it is impossible to use a variable whose name is stored in another variable.
The only way around this is to use <code>eval</code> which is too difficult to use safely.
Instead, you can now use the <code>assign</code> command.</p>
<p dir="auto">Usage: <code>assign</code> [ [ <code>+r</code> ] <em>variable</em><code>=</code><em>value</em> ... ] | [ <code>-r</code> <em>variable</em><code>=</code><em>variable2</em> ... ] ...</p>
<p dir="auto"><code>assign</code> safely processes assignment-arguments in the same form as customarily
given to the <code>readonly</code> and <code>export</code> commands, but it only assigns <em>value</em>s to
<em>variable</em>s without setting any attributes. Each argument is grammatically an
ordinary shell word, so any part or all of it may result from an expansion. The
absence of a <code>=</code> character in any argument is a fatal error. The text preceding
the first <code>=</code> is taken as the variable name in which to store the <em>value</em>; an
invalid <em>variable</em> name is a fatal error. No whitespace is accepted before the
<code>=</code> and any whitespace after the <code>=</code> is part of the <em>value</em> to be assigned.</p>
<p dir="auto">The <code>-r</code> (reference) option causes the part to the right of the <code>=</code> to be
taken as a second variable name <em>variable2</em>, and its value is assigned to
<em>variable</em> instead. <code>+r</code> turns this option back off.</p>
<p dir="auto"><strong>Examples:</strong> Each of the lines below assigns the value &#39;hello world&#39; to the
variable <code>greeting</code>.</p>
<div dir="auto" data-snippet-clipboard-copy-content="var=greeting; assign $var=&#39;hello world&#39;
var=greeting; assign &#34;$var=hello world&#34;
tag=&#39;greeting=hello world&#39;; assign &#34;$tag&#34;
var=greeting; gvar=myinput; myinput=&#39;hello world&#39;; assign -r $var=$gvar"><pre>var=greeting<span>;</span> assign <span>$var</span>=<span><span>&#39;</span>hello world<span>&#39;</span></span>
var=greeting<span>;</span> assign <span><span>&#34;</span><span>$var</span>=hello world<span>&#34;</span></span>
tag=<span><span>&#39;</span>greeting=hello world<span>&#39;</span></span><span>;</span> assign <span><span>&#34;</span><span>$tag</span><span>&#34;</span></span>
var=greeting<span>;</span> gvar=myinput<span>;</span> myinput=<span><span>&#39;</span>hello world<span>&#39;</span></span><span>;</span> assign -r <span>$var</span>=<span>$gvar</span></pre></div>

<p dir="auto"><code>readf</code> reads arbitrary data from standard input into a variable until end
of file, converting it into a format suitable for passing to the
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/printf.html" rel="nofollow"><code>printf</code></a>
utility. For example, <code>readf var &lt;foo; printf &#34;$var&#34; &gt;bar</code> will copy foo to
bar. Thus, <code>readf</code> allows storing both text and binary files into shell
variables in a textual format suitable for manipulation with standard shell
facilities.</p>
<p dir="auto">All non-printable, non-ASCII characters are converted to <code>printf</code> octal or
one-letter escape codes, except newlines. Not encoding newline characters
allows for better processing by line-based utilities such as <code>grep</code>, <code>sed</code>,
<code>awk</code>, etc. However, if the file ends in a newline, that final newline is
encoded to <code>\n</code> to protect it from being stripped by command substitutions.</p>
<p dir="auto">Usage: <code>readf</code> [ <code>-h</code> ] <em>varname</em></p>
<p dir="auto">The <code>-h</code> option disables conversion of high-byte characters (accented letters,
non-Latin scripts). Do not use for binary files; this is only guaranteed to
work for text files in an encoding compatible with the current locale.</p>
<p dir="auto">Caveats:</p>
<ul dir="auto">
<li>Best for small-ish files. The encoded file is stored in memory (a shell
variable). For a binary file, encoding in <code>printf</code> format typically
about doubles the size, though it could be up to four times as large.</li>
<li>If the shell executing your program does not have <code>printf</code> as a builtin
command, the external <code>printf</code> command will fail if the encoded file
size exceeds the maximum length of arguments to external commands
(<code>getconf ARG_MAX</code> will obtain this limit for your system). Shell builtin
commands do not have this limit. Check for a <code>printf</code> builtin using
<a href="#user-content-shell-capability-detection"><code>thisshellhas</code></a> if you need to be sure,
and always <a href="#user-content-use-syscmdharden"><code>harden</code></a>
<code>printf</code>!</li>
</ul>

<p dir="auto">This module provides an efficient, fast, safe and portable shell-quoting
algorithm for quoting arbitrary data in such a way that the quoted values are
safe to pass to the shell for parsing as string literals. This is essential
for any context where the shell must grammatically parse untrusted input,
such as when supplying arbitrary values to <code>trap</code> or <code>eval</code>.</p>
<p dir="auto">The shell-quoting algorithm is optimised to minimise exponential growth when
quoting repeatedly. By default, it also ensures that quoted strings are
always one single printable line, making them safe for terminal output and
processing by line-oriented utilities.</p>

<p dir="auto">Usage: <code>shellquote</code> [ <code>-f</code>|<code>+f</code>|<code>-P</code>|<code>+P</code> ] <em>varname</em>[<code>=</code><em>value</em>] ...</p>
<p dir="auto">The values of the variables specified by name are shell-quoted and stored
back into those variables.
Repeating a variable name will add another level of shell-quoting.
If a <code>=</code> plus a <em>value</em> (which may be empty) is appended to the <em>varname</em>,
that value is shell-quoted and assigned to the variable.</p>
<p dir="auto">Options modify the algorithm for variable names following them, as follows:</p>
<ul dir="auto">
<li>
<p dir="auto">By default, newlines and any control characters are converted into
<a href="#user-content-control-character-whitespace-and-shell-safe-character-constants"><code>${CC*}</code></a>
expansions and quoted with double quotes, ensuring that the quoted string
consists of a single line of printable text. The <code>-P</code> option forces pure
POSIX quoted strings that may span multiple lines; <code>+P</code> turns this back off.</p>
</li>
<li>
<p dir="auto">By default, a value is only quoted if it contains characters not present
in <code>$SHELLSAFECHARS</code>. The <code>-f</code> option forces unconditional quoting,
disabling optimisations that may leave shell-safe characters unquoted;
<code>+f</code> turns this back off.</p>
</li>
</ul>
<p dir="auto"><code>shellquote</code> will <a href="#user-content-reliable-emergency-halt">die</a> if you
attempt to quote an unset variable (because there is no value to quote).</p>

<p dir="auto">The <code>shellquoteparams</code> command shell-quotes the current positional
parameters in place using the default quoting method of <code>shellquote</code>. No
options are supported and any attempt to add arguments results in a syntax
error.</p>

<p dir="auto">Modules that extend <a href="#user-content-the-stack">the stack</a>.</p>

<p dir="auto">This module contains stack query and maintenance functions.</p>
<p dir="auto">If you only need one or two of these functions, they can also be loaded as
individual submodules of <code>var/stack/extra</code>.</p>
<p dir="auto">For the four functions below, <em>item</em> can be:</p>
<ul dir="auto">
<li>a valid portable variable name</li>
<li>a short-form shell option: dash plus letter</li>
<li>a long-form shell option: <code>-o</code> followed by an option name (two arguments)</li>
<li><code>--trap=</code><em>SIGNAME</em> to refer to the trap stack for the indicated signal
(as set by <code>pushtrap</code> from <a href="#user-content-use-varstacktrap"><code>var/stack/trap</code></a>)</li>
</ul>
<p dir="auto"><code>stackempty</code> [ <code>--key=</code><em>value</em> ] [ <code>--force</code> ] <em>item</em>: Tests if the stack
for an item is empty. Returns status 0 if it is, 1 if it is not. The key
feature works as in <a href="#user-content-the-stack"><code>pop</code></a>: by default, a key
mismatch is considered equivalent to an empty stack. If <code>--force</code> is given,
this function ignores keys altogether.</p>
<p dir="auto"><code>clearstack</code> [ <code>--key=</code><em>value</em> ] [ <code>--force</code> ] <em>item</em> [ <em>item</em> ... ]:
Clears one or more stacks, discarding all items on it.
If (part of) the stack is keyed or a <code>--key</code> is given, only clears until a
key mismatch is encountered. The <code>--force</code> option overrides this and always
clears the entire stack (be careful, e.g. don&#39;t use within
<a href="#user-content-use-varlocal"><code>LOCAL</code> ... <code>BEGIN</code> ... <code>END</code></a>).
Returns status 0 on success, 1 if that stack was already empty, 2 if
there was nothing to clear due to a key mismatch.</p>
<p dir="auto"><code>stacksize</code> [ <code>--silent</code> | <code>--quiet</code> ] <em>item</em>: Leaves the size of a stack in
the <code>REPLY</code> variable and, if option <code>--silent</code> or <code>--quiet</code> is not given,
writes it to standard output.
The size of the complete stack is returned, even if some values are keyed.</p>
<p dir="auto"><code>printstack</code> [ <code>--quote</code> ] <em>item</em>: Outputs a stack&#39;s content.
Option <code>--quote</code> shell-quotes each stack value before printing it, allowing
for parsing multi-line or otherwise complicated values.
Column 1 to 7 of the output contain the number of the item (down to 0).
If the item is set, column 8 and 9 contain a colon and a space, and
if the value is non-empty or quoted, column 10 and up contain the value.
Sets of values that were pushed with a key are started with a special
line containing <code>--- key: </code><em>value</em>. A subsequent set pushed with no key is
started with a line containing <code>--- (key off)</code>.
Returns status 0 on success, 1 if that stack is empty.</p>

<p dir="auto">This module provides <code>pushtrap</code> and <code>poptrap</code>. These functions integrate
with the <a href="#user-content-the-stack">main modernish stack</a>
to make traps stack-based, so that each
program component or library module can set its own trap commands without
interfering with others.</p>
<p dir="auto">This module also provides a new
<a href="#user-content-the-new-die-pseudosignal"><code>DIE</code> pseudosignal</a>
that allows pushing traps to execute when
<a href="#user-content-reliable-emergency-halt"><code>die</code></a>
is called.</p>
<p dir="auto">Note an important difference between the trap stack and stacks for variables
and shell options: pushing traps does not save them for restoring later, but
adds them alongside other traps on the same signal. All pushed traps are
active at the same time and are executed from last-pushed to first-pushed
when the respective signal is triggered. Traps cannot be pushed and popped
using <code>push</code> and <code>pop</code> but use dedicated commands as follows.</p>
<p dir="auto">Usage:</p>
<ul dir="auto">
<li><code>pushtrap</code> [ <code>--key=</code><em>value</em> ] [ <code>--nosubshell</code> ] [ <code>--</code> ] <em>command</em> <em>sigspec</em> [ <em>sigspec</em> ... ]</li>
<li><code>poptrap</code> [ <code>--key=</code><em>value</em> ] [ <code>-R</code> ] [ <code>--</code> ] <em>sigspec</em> [ <em>sigspec</em> ... ]</li>
</ul>
<p dir="auto"><code>pushtrap</code> works like regular <code>trap</code>, with the following exceptions:</p>
<ul dir="auto">
<li>Adds traps for a signal without overwriting previous ones.</li>
<li>An invalid signal is a fatal error. When using non-standard signals, check if
<a href="#user-content-shell-capability-detection"><code>thisshellhas --sig=</code><em>yoursignal</em></a>
before using it.</li>
<li>Unlike regular traps, a stack-based trap does not cause a signal to be
ignored. Setting one will cause it to be executed upon the shell receiving
that signal, but after the stack traps complete execution, modernish re-sends
the signal to the main shell, causing it to behave as if no trap were set
(unless a regular POSIX trap is also active).
Thus, <code>pushtrap</code> does not accept an empty <em>command</em> as it would be pointless.</li>
<li>Each stack trap is executed in a new
<a href="#user-content-insubshell">subshell</a>
to keep it from interfering
with others. This means a stack trap cannot change variables except within
its own environment, and <code>exit</code> will only exit the trap and not the program.
The <code>--nosubshell</code> option overrides this behaviour, causing that particular
trap to be executed in the main shell environment instead. This is not
recommended if not absolutely needed, as you have to be extra careful to
avoid exiting the shell or otherwise interfere with other stack traps.
This option cannot be used with
<a href="#user-content-the-new-die-pseudosignal"><code>DIE</code> traps</a>.</li>
<li>Each stack trap is executed with <code>$?</code> initially set to the exit status
that was active at the time the signal was triggered.</li>
<li>Stack traps do not have access to the positional parameters.</li>
<li><code>pushtrap</code> stores current <code>$IFS</code> (field splitting) and <code>$-</code> (shell options)
along with the pushed trap. Within the subshell executing each stack trap,
modernish restores <code>IFS</code> and the shell options <code>f</code> (<code>noglob</code>), <code>u</code>
(<code>nounset</code>) and <code>C</code> (<code>noclobber</code>) to the values in effect during the
corresponding <code>pushtrap</code>. This is to avoid unexpected effects in case a trap
is triggered while temporary settings are in effect.
The <code>--nosubshell</code> option disables this functionality for the trap pushed.</li>
<li>The <code>--key</code> option applies the keying functionality inherited from
<a href="#user-content-the-stack">plain <code>push</code></a> to the trap stack.
It works the same way, so the description is not repeated here.</li>
</ul>
<p dir="auto"><code>poptrap</code> takes just signal names or numbers as arguments. It takes the
last-pushed trap for each signal off the stack. By default, it discards
the trap commands. If the <code>-R</code> option is given, it stores commands to
restore those traps into the <code>REPLY</code> variable, in a format suitable for
re-entry into the shell. Again, the <code>--key</code> option works as in
<a href="#user-content-the-stack">plain <code>pop</code></a>.</p>
<p dir="auto">With the sole exception of
<a href="#user-content-the-new-die-pseudosignal"><code>DIE</code> traps</a>,
all stack-based traps, like native shell traps, are reset upon entering a
<a href="#user-content-insubshell">subshell</a>.
However, commands for printing traps will print the traps for
the parent shell, until another <code>trap</code>, <code>pushtrap</code> or <code>poptrap</code> command is
invoked, at which point all memory of the parent shell&#39;s traps is erased.</p>
<div dir="auto"><h5 tabindex="-1" dir="auto">Trap stack compatibility considerations</h5><a id="user-content-trap-stack-compatibility-considerations" aria-label="Permalink: Trap stack compatibility considerations" href="#trap-stack-compatibility-considerations"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Modernish tries hard to avoid incompatibilities with existing trap practice.
To that end, it intercepts the regular POSIX <code>trap</code> command using an alias,
reimplementing and interfacing it with the shell&#39;s builtin trap facility
so that plain old regular traps play nicely with the trap stack. You should
not notice any changes in the POSIX <code>trap</code> command&#39;s behaviour, except for
the following:</p>
<ul dir="auto">
<li>The regular <code>trap</code> command does not overwrite stack traps (but still
overwrites existing regular traps).</li>
<li>Unlike zsh&#39;s native trap command, signal names are case insensitive.</li>
<li>Unlike dash&#39;s native trap command, signal names may have the <code>SIG</code> prefix;
that prefix is quietly accepted and discarded.</li>
<li>Setting an empty trap action to ignore a signal only works fully (passing
the ignoring on to child processes) if there are no stack traps associated
with the signal; otherwise, an empty trap action merely suppresses the
signal&#39;s default action for the current process – e.g., after executing
the stack traps, it keeps the shell from exiting.</li>
<li>The <code>trap</code> command with no arguments, which prints the traps that are set
in a format suitable for re-entry into the shell, now also prints the
stack traps as <code>pushtrap</code> commands. (<code>bash</code> users might notice the <code>SIG</code>
prefix is not included in the signal names written.)</li>
<li>The bash/yash-style <code>-p</code> option, including its yash-style <code>--print</code>
equivalent, is now supported on all shells. If further arguments are
given after that option, they are taken as signal specifications and
only the commands to recreate the traps for those signals are printed.</li>
<li>Saving the traps to a variable using command substitution (as in:
<code>var=$(trap)</code>) now works on every
<a href="#user-content-appendix-d-supported-shells">shell supported by modernish</a>,
including (d)ash, mksh and zsh which don&#39;t support this natively.</li>
<li>To reset (unset) a trap, the modernish <code>trap</code> command accepts both
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_28_03" rel="nofollow">valid POSIX syntax</a>
and legacy bash/(d)ash/zsh syntax, like <code>trap INT</code> to unset a <code>SIGINT</code>
trap (which only works if the <code>trap</code> command is given exactly one
argument). Note that this is for compatibility with existing scripts only.</li>
<li>Bypassing the <code>trap</code> alias to set a trap using the shell builtin command
will cause an inconsistent state. This may be repaired with a simple <code>trap</code>
command; as modernish prints the traps, it will quietly detect ones it
doesn&#39;t yet know about and make them work nicely with the trap stack.</li>
</ul>
<p dir="auto">POSIX traps for each signal are always executed after that signal&#39;s stack-based
traps; this means they should not rely on modernish modules that use the trap
stack to clean up after themselves on exit, as those cleanups would already
have been done.</p>

<p dir="auto">The <code>var/stack/trap</code> module adds new <code>DIE</code> pseudosignal whose traps are
executed upon invoking <a href="#user-content-reliable-emergency-halt"><code>die</code></a>.
This allows for emergency cleanup operations upon fatal program failure,
as <code>EXIT</code> traps cannot be executed after <code>die</code> is invoked.</p>
<ul dir="auto">
<li>On non-interactive shells (as well as
<a href="#user-content-insubshell">subshells</a>
of interactive shells), <code>DIE</code> is its own pseudosignal with its own trap
stack and POSIX trap. In order to kill the malfunctioning program as quickly
as possible (hopefully before it has a chance to delete all your data), <code>die</code>
doesn&#39;t wait for those traps to complete before killing the program. Instead,
it executes each <code>DIE</code> trap simultaneously as a background job, then gathers
the process IDs of the main shell and all its subprocesses, sending <code>SIGKILL</code>
to all of them except any <code>DIE</code> trap processes. Unlike other traps, <code>DIE</code>
traps are inherited by and survive in subshell processes, and <code>pushtrap</code> may
add to them within the subshell. Whatever shell process invokes <code>die</code> will
fork all <code>DIE</code> trap actions before being <code>SIGKILL</code>ed itself. (Note that any
<code>DIE</code> traps pushed or set within a subshell will still be forgotten upon
exiting the subshell.)</li>
<li>On an interactive shell (<em>not</em> including its
<a href="#user-content-insubshell">subshells</a>),
<code>DIE</code> is simply an alias for <code>INT</code>, and <code>INT</code> traps
(both POSIX and stack) are cleared out after executing them once. This is
because <code>die</code> uses <code>SIGINT</code> for command interruption on interactive shells, and
it would not make sense to execute emergency cleanup commands repeatedly. As
a side effect of this special handling, <code>INT</code> traps on interactive shells do
not have access to the positional parameters and cannot return from functions.</li>
</ul>

<p dir="auto">String comparison and manipulation functions.</p>

<p dir="auto"><code>toupper</code> and <code>tolower</code>: convert case in variables.</p>
<p dir="auto">Usage:</p>
<ul dir="auto">
<li><code>toupper</code> <em>varname</em> [ <em>varname</em> ... ]</li>
<li><code>tolower</code> <em>varname</em> [ <em>varname</em> ... ]</li>
</ul>
<p dir="auto">Arguments are taken as variable names (note: they should be given without
the <code>$</code>) and case is converted in the contents of the specified variables,
without reading input or writing output.</p>
<p dir="auto"><code>toupper</code> and <code>tolower</code> try hard to use the fastest available method on the
particular shell your program is running on. They use built-in shell
functionality where available and working correctly, otherwise they fall back
on running an external utility.</p>
<p dir="auto">Which external utility is chosen depends on whether the current locale uses
the Unicode UTF-8 character set or not. For non-UTF-8 locales, modernish
assumes the POSIX/C locale and <code>tr</code> is always used. For UTF-8 locales,
modernish tries hard to find a way to correctly convert case even for
non-Latin alphabets. A few shells have this functionality built in with
<code>typeset</code>. The rest need an external utility. Modernish initialisation
tries <code>tr</code>, <code>awk</code>, GNU <code>awk</code> and GNU <code>sed</code> before giving up and setting
the variable <code>MSH_2UP2LOW_NOUTF8</code>. If <code>isset MSH_2UP2LOW_NOUTF8</code>, it
means modernish is in a UTF-8 locale but has not found a way to convert
case for non-ASCII characters, so <code>toupper</code> and <code>tolower</code> will convert
only ASCII characters and leave any other characters in the string alone.</p>

<p dir="auto"><code>trim</code>: strip whitespace from the beginning and end of a variable&#39;s value.
Whitespace is defined by the <code>[:space:]</code> character class. In the POSIX
locale, this is tab, newline, vertical tab, form feed, carriage return, and
space, but in other locales it may be different.
(On shells with <a href="#user-content-bugs"><code>BUG_NOCHCLASS</code></a>,
<a href="#user-content-control-character-whitespace-and-shell-safe-character-constants"><code>$WHITESPACE</code></a>
is used to define whitespace instead.) Optionally, a string of literal
characters can be provided in the second argument. Any characters appearing
in that string will then be trimmed instead of whitespace.
Usage: <code>trim</code> <em>varname</em> [ <em>characters</em> ]</p>

<p dir="auto"><code>replacein</code>: Replace leading, <code>-t</code>railing or <code>-a</code>ll occurrences of a string by
another string in a variable.</p>

<p dir="auto"><code>append</code> and <code>prepend</code>: Append or prepend zero or more strings to a
variable, separated by a string of zero or more characters, avoiding the
hairy problem of dangling separators.
Usage: <code>append</code>|<code>prepend</code> [ <code>--sep=</code><em>separator</em> ] [ <code>-Q</code> ] <em>varname</em> [ <em>string</em> ... ]</p>

<p dir="auto">The <code>unexport</code> function clears the &#34;export&#34; bit of a variable, conserving
its value, and/or assigns values to variables without setting the export
bit. This works even if <code>set -a</code> (allexport) is active, allowing an &#34;export
all variables, except these&#34; way of working.</p>
<p dir="auto">Usage is like <code>export</code>, with the caveat that variable assignment arguments
containing non-shell-safe characters or expansions must be quoted as
appropriate, unlike in some specific shell implementations of <code>export</code>.
(To get rid of that headache, <a href="#user-content-use-safe"><code>use safe</code></a>.)</p>
<p dir="auto">Unlike <code>export</code>, <code>unexport</code> does not work for read-only variables.</p>

<p dir="auto">As the <code>getopts</code> builtin is not portable when used in functions, this module
provides a command that generates modernish code to parse options for your
shell function in a standards-compliant manner. The generated parser
supports short-form (one-character) options which can be stacked/combined.</p>
<p dir="auto">Usage:
<code>generateoptionparser</code> [ <code>-o</code> ] [ <code>-f</code> <em>func</em> ] [ <code>-v</code> <em>varprefix</em> ]
[ <code>-n</code> <em>options</em> ] [ -a <em>options</em> ] [ <em>varname</em> ]</p>
<ul dir="auto">
<li><code>-o</code>: Write parser to standard output.</li>
<li><code>-f</code>: Function name to prefix to error messages. Default: none.</li>
<li><code>-v</code>: Variable name prefix for options. Default: <code>opt_</code>.</li>
<li><code>-n</code>: String of options that do not take arguments.</li>
<li><code>-a</code>: String of options that require arguments.</li>
<li><em>varname</em>: Store parser in specified variable. Default: <code>REPLY</code>.</li>
</ul>
<p dir="auto">At least one of <code>-n</code> and <code>-a</code> is required. All other arguments are optional.
Option characters must be valid components of portable variable names, so
they must be ASCII upper- or lowercase letters, digits, or the underscore.</p>
<p dir="auto"><code>generateoptionparser</code> stores the generated parser code in a variable: either
<code>REPLY</code> or the <em>varname</em> specified as the first non-option argument. This makes
it possible to generate and use the parser on the fly with a command like
<code>eval &#34;$REPLY&#34;</code> immediately following the <code>generateoptionparser</code> invocation.</p>
<p dir="auto">For better efficiency and readability, it will often be preferable to insert
the option parser code directly into your shell function instead. The <code>-o</code>
option writes the parser code to standard output, so it can be redirected to
a file, inserted into your editor, etc.</p>
<p dir="auto">Parsed options are shifted out of the positional parameters while setting or
unsetting corresponding variables, until a non-option argument, a <code>--</code>
end-of-options delimiter argument, or the end of arguments is encountered.
Unlike with <code>getopts</code>, no additional <code>shift</code> command is required.</p>
<p dir="auto">Each specified option gets a corresponding variable with a name consisting
of the <em>varprefix</em> (default: <code>opt_</code>) plus the option character. If an option
is not passed to your function, the parser unsets its variable; otherwise it
sets it to either the empty value or its option-argument if it requires one.
Thus, your function can check if any option <code>x</code> was given using
<a href="#user-content-isset"><code>isset</code></a>,
for example, <code>if isset opt_x; then</code>...</p>

<p dir="auto">Some very common and essential utilities are not specified by POSIX, differ
widely among systems, and are not always available. For instance, the
<code>which</code> and <code>readlink</code> commands have incompatible options on various GNU and
BSD variants and may be absent on other Unix-like systems. The <code>sys/base</code>
module provides a complete re-implementation of such non-standard but basic
utilities, written as modernish shell functions. Using the modernish version
of these utilities can help a script to be fully portable. These versions
also have various enhancements over the GNU and BSD originals, some of which
are made possible by their integration into the modernish shell environment.</p>

<p dir="auto">A cross-platform shell implementation of <code>mktemp</code> that aims to be just as
safe as native <code>mktemp</code>(1) implementations, while avoiding the problem of
having various mutually incompatible versions and adding several unique
features of its own.</p>
<p dir="auto">Creates one or more unique temporary files, directories or named pipes,
atomically (i.e. avoiding race conditions) and with safe permissions.
The path name(s) are stored in <code>REPLY</code> and optionally written to stdout.</p>
<p dir="auto">Usage: <code>mktemp</code> [ <code>-dFsQCt</code> ] [ <em>template</em> ... ]</p>
<ul dir="auto">
<li><code>-d</code>: Create a directory instead of a regular file.</li>
<li><code>-F</code>: Create a FIFO (named pipe) instead of a regular file.</li>
<li><code>-s</code>: Silent. Store output in <code>$REPLY</code>, don&#39;t write any output or message.</li>
<li><code>-Q</code>: Shell-quote each unit of output. Separate by spaces, not newlines.</li>
<li><code>-C</code>: Automated cleanup.
<a href="#user-content-the-trap-stack">Pushes a trap</a>
to remove the files
on exit. On an interactive shell, that&#39;s all this option does. On a
non-interactive shell, the following applies: Clean up on receiving
<code>SIGPIPE</code> and <code>SIGTERM</code> as well. On receiving <code>SIGINT</code>, clean up if the
option was given at least twice, otherwise notify the user of files
left. On the invocation of
<a href="#user-content-reliable-emergency-halt"><code>die</code></a>,
clean up if the option was given at least three times, otherwise notify
the user of files left.</li>
<li><code>-t</code>: Prefix one temporary files directory to all the <em>template</em>s:
<code>$XDG_RUNTIME_DIR</code> or <code>$TMPDIR</code> if set, or <code>/tmp</code>. The <em>template</em>s
may not contain any slashes. If the template has neither any trailing
<code>X</code>es nor a trailing dot, a dot is added before the random suffix.</li>
</ul>
<p dir="auto">The template defaults to “<code>/tmp/temp.</code>”. An suffix of random shell-safe ASCII
characters is added to the template to create the file. For compatibility with
other <code>mktemp</code> implementations, any optional trailing <code>X</code> characters in the
template are removed. The length of the suffix will be equal to the amount of
<code>X</code>es removed, or 10, whichever is more. The longer the random suffix, the
higher the security of using <code>mktemp</code> in a shared directory such as <code>tmp</code>.</p>
<p dir="auto">Since <code>/tmp</code> is a world-writable directory shared by other users, for best
security it is recommended to create a private subdirectory using <code>mktemp -d</code>
and work within that.</p>
<p dir="auto">Option <code>-C</code> cannot be used without option <code>-s</code> when in a
<a href="#user-content-insubshell">subshell</a>.
Modernish will detect this and treat it as a
fatal error. The reason is that a typical command substitution like
<code>tmpfile=$(mktemp -C)</code>
is incompatible with auto-cleanup, as the cleanup EXIT trap would be
triggered not upon exiting the program but upon exiting the command
substitution subshell that just ran <code>mktemp</code>, thereby immediately undoing
the creation of the file. Instead, do something like:
<code>mktemp -sC; tmpfile=$REPLY</code></p>
<p dir="auto">This module depends on the trap stack to do auto-cleanup (the <code>-C</code> option),
so it will automatically <code>use var/stack/trap</code> on initialisation.</p>

<p dir="auto"><code>readlink</code> reads the target of a symbolic link, robustly handling strange
filenames such as those containing newline characters. It stores the result
in the <code>REPLY</code> variable and optionally writes it on standard output.</p>
<p dir="auto">Usage: <code>readlink</code> [ <code>-nsefmQ</code> ] <em>path</em> [ <em>path</em> ... ]</p>
<ul dir="auto">
<li><code>-n</code>: If writing output, don&#39;t add a trailing newline.
This does not remove the separating newlines if multiple <em>path</em>s are given.</li>
<li><code>-s</code>: <em>S</em>ilent operation: don&#39;t write output, only store it in <code>REPLY</code>.</li>
<li><code>-e</code>, <code>-f</code>, <code>-m</code>: Canonicalise. Convert each <em>path</em> found into a canonical
and absolute path that can be used starting from any working directory.
Relative <em>path</em>s are resolved starting from the present working directory.
Double slashes are removed. Any special pathname components
<code>.</code> and <code>..</code> are resolved. All symlinks encountered are
followed, but a <em>path</em> does not need to contain any symlinks. UNC network
paths (as on Cygwin) are supported. These options differ as follows:
<ul dir="auto">
<li><code>-e</code>: All pathname components must exist to produce a result.</li>
<li><code>-f</code>: All but the last pathname component must exist to produce a result.</li>
<li><code>-m</code>: No pathname component needs to exist; this always produces a result.
Nonexistent pathname components are simulated as regular directories.</li>
</ul>
</li>
<li><code>-Q</code>: Shell-<em>q</em>uote each unit of output. Separate by spaces instead
of newlines. This generates a list of arguments in shell syntax,
guaranteed to be suitable for safe parsing by the shell, even if the
resulting pathnames should contain strange characters such as spaces or
newlines and other control characters.</li>
</ul>
<p dir="auto">The exit status of <code>readlink</code> is 0 on success and 1 if the <em>path</em> either is
not a symlink, or could not be canonicalised according to the option given.</p>

<p dir="auto"><code>rev</code> copies the specified files to the standard output, reversing the order
of characters in every line. If no files are specified, the standard input
is read.</p>
<p dir="auto">Usage: like <code>rev</code> on Linux and BSD, which is like <code>cat</code> except that <code>-</code> is
a filename and does not denote standard input. No options are supported.</p>

<p dir="auto">A cross-platform implementation of <code>seq</code> that is more powerful and versatile
than native GNU and BSD <code>seq</code>(1) implementations. The core is written in
<code>bc</code>, the POSIX arbitrary-precision calculator language. That means this
<code>seq</code> inherits the capacity to handle numbers with a precision and size only
limited by computer memory, as well as the ability to handle input numbers
in any base from 1 to 16 and produce output in any base 1 and up.</p>
<p dir="auto">Usage: <code>seq</code> [ <code>-w</code> ] [ <code>-L</code> ] [ <code>-f</code> <em>format</em> ] [ <code>-s</code> <em>string</em> ] [ <code>-S</code> <em>scale</em> ]
[ <code>-B</code> <em>base</em> ] [ <code>-b</code> <em>base</em> ] [ <em>first</em> [ <em>incr</em> ] ] <em>last</em></p>
<p dir="auto"><code>seq</code> prints a sequence of arbitrary-precision floating point numbers, one
per line, from <em>first</em> (default 1), to as near <em>last</em> as possible, in increments of
<em>incr</em> (default 1). If <em>first</em> is larger than <em>last</em>, the default <em>incr</em> is -1.
An <em>incr</em> of zero is treated as a fatal error.</p>
<ul dir="auto">
<li><code>-w</code>: Equalise width by padding with leading zeros. The longest of the
<em>first</em>, <em>incr</em> or <em>last</em> arguments is taken as the length that each
output number should be padded to.</li>
<li><code>-L</code>: Use the current locale&#39;s radix point in the output instead of the
full stop (<code>.</code>).</li>
<li><code>-f</code>: <code>printf</code>-style floating-point format. The format string is passed on
(with an added <code>\n</code>) to <code>awk</code>&#39;s builtin <code>printf</code> function. Because
of that, the <code>-f</code> option can only be used if the output base is 10.
Note that <code>awk</code>&#39;s floating point precision is limited, so very
large or long numbers will be rounded.</li>
<li><code>-s</code>: Instead of writing one number per line, write all numbers on one
line separated by <em>string</em> and terminated by a newline character.</li>
<li><code>-S</code>: Explicitly set the scale (number of digits after the
<a href="https://en.wikipedia.org/wiki/Radix_point" rel="nofollow">radix point</a>).
Defaults to the largest number of digits after the radix point
among the <em>first</em>, <em>incr</em> or <em>last</em> arguments.</li>
<li><code>-B</code>: Set input and output base from 1 to 16. Defaults to 10.</li>
<li><code>-b</code>: Set arbitrary output base from 1. Defaults to input base.
See the <code>bc</code>(1) manual for more information on the output format
for bases greater than 16.</li>
</ul>
<p dir="auto">The <code>-S</code>, <code>-B</code> and <code>-b</code> options take shell integer numbers as operands. This
means a leading <code>0X</code> or <code>0x</code> denotes a hexadecimal number and a leading <code>0</code>
denotes an octal number.</p>
<p dir="auto">For portability reasons, modernish <code>seq</code> uses a full stop (<code>.</code>) for the
<a href="https://en.wikipedia.org/wiki/Radix_point" rel="nofollow">radix point</a>, regardless of the
system locale. This applies both to command arguments and to output.
The <code>-L</code> option causes <code>seq</code> to use the current locale&#39;s radix point
character for output only.</p>
<div dir="auto"><h5 tabindex="-1" dir="auto">Differences with GNU and BSD <code>seq</code></h5><a id="user-content-differences-with-gnu-and-bsd-seq" aria-label="Permalink: Differences with GNU and BSD seq" href="#differences-with-gnu-and-bsd-seq"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The <code>-S</code>, <code>-B</code> and <code>-b</code> options are modernish innovations.
The <code>-w</code>, <code>-f</code> and <code>-s</code> options are inspired by GNU and BSD <code>seq</code>.
The following differences apply:</p>
<ul dir="auto">
<li>Like GNU and unlike BSD, the separator specified by the <code>-s</code> option
is not appended to the final number and there is no <code>-t</code> option to
add a terminator character.</li>
<li>Like GNU and unlike BSD, the <code>-s</code> option-argument is taken as literal
characters and is not parsed for backslash escape codes like <code>\n</code>.</li>
<li>Unlike GNU and like BSD, the output radix point defaults to a full stop,
regardless of the current locale.</li>
<li>Unlike GNU and like BSD, if <em>incr</em> is not specified,
it defaults to -1 if <em>first</em> &gt; <em>last</em>, 1 otherwise.
For example, <code>seq 5 1</code> counts backwards from 5 to 1, and
specifying <code>seq 5 -1 1</code> as with GNU is not needed.</li>
<li>Unlike GNU and like BSD, an <em>incr</em> of zero is not accepted.
To output the same number or string infinite times, use
<a href="#user-content-use-sysbaseyes"><code>yes</code></a> instead.</li>
<li>Unlike both GNU and BSD, the <code>-f</code> option accepts any format specifiers
accepted by <code>awk</code>&#39;s <code>printf()</code> function.</li>
</ul>
<p dir="auto">The <code>sys/base/seq</code> module depends on, and automatically loads,
<a href="#user-content-use-varstringtouplow"><code>var/string/touplow</code></a>.</p>

<p dir="auto">Shuffle lines of text.
A portable reimplementation of a commonly used GNU utility.</p>
<p dir="auto">Usage:</p>
<ul dir="auto">
<li><code>shuf</code> [ <code>-n</code> <em>max</em> ] [ <code>-r</code> <em>rfile</em> ] <em>file</em></li>
<li><code>shuf</code> [ <code>-n</code> <em>max</em> ] [ <code>-r</code> <em>rfile</em> ] <code>-i</code> <em>low</em><code>-</code><em>high</em></li>
<li><code>shuf</code> [ <code>-n</code> <em>max</em> ] [ <code>-r</code> <em>rfile</em> ] <code>-e</code> <em>argument</em> ...</li>
</ul>
<p dir="auto">By default, <code>shuf</code> reads lines of text from standard input, or from <em>file</em>
(the <em>file</em> <code>-</code> signifies standard input).
It writes the input lines to standard output in random order.</p>
<ul dir="auto">
<li><code>-i</code>: Use sequence of non-negative integers <em>low</em> through <em>high</em> as input.</li>
<li><code>-e</code>: Instead of reading input, use the <em>argument</em>s as lines of input.</li>
<li><code>-n</code>: Output a maximum of <em>max</em> lines.</li>
<li><code>-r</code>: Use <em>rfile</em> as the source of random bytes. Defaults to <code>/dev/urandom</code>.</li>
</ul>
<p dir="auto">Differences with GNU <code>shuf</code>:</p>
<ul dir="auto">
<li>Long option names are not supported.</li>
<li>The <code>-o</code>/<code>--output-file</code> option is not supported; use output redirection.
Safely shuffling files in-place is not supported; use a temporary file.</li>
<li><code>--random-source=</code><em>file</em> is changed to <code>-r</code> <em>file</em>.</li>
<li>The <code>-z</code>/<code>--zero-terminated</code> option is not supported.</li>
</ul>

<p dir="auto"><code>tac</code> (the reverse of <code>cat</code>) is a cross-platform reimplementation of the GNU
<code>tac</code> utility, with some extra features.</p>
<p dir="auto">Usage: <code>tac</code> [ <code>-rbBP</code> ] [ <code>-S</code> <em>separator</em> ] <em>file</em> [ <em>file</em> ... ]</p>
<p dir="auto"><code>tac</code> outputs the <em>file</em>s in reverse order of lines/records.
If <em>file</em> is <code>-</code> or is not given, <code>tac</code> reads from standard input.</p>
<ul dir="auto">
<li><code>-s</code>: Specify the record (line) separator. Default: linefeed.</li>
<li><code>-r</code>: Interpret the record separator as an
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap09.html#tag_09_04" rel="nofollow">extended regular expression</a>.
This allows using separators that may vary. Each separator is preserved
in the output as it is in the input.</li>
<li><code>-b</code>: Assume the separator comes before each record in the input, and also
output the separator before each record. Cannot be combined with <code>-B</code>.</li>
<li><code>-B</code>: Assume the separator comes after each record in the input, but output
the separator before each record. Cannot be combined with <code>-b</code>.</li>
<li><code>-P</code>: Paragraph mode: output text last paragraph first. Input paragraphs
are separated from each other by at least two linefeeds. Cannot be combined
with any other option.</li>
</ul>
<p dir="auto">Differences between GNU <code>tac</code> and modernish <code>tac</code>:</p>
<ul dir="auto">
<li>The <code>-B</code> and <code>-P</code> options were added.</li>
<li>The <code>-r</code> option interprets the record separator as an extended regular
expression. This is an incompatibility with GNU <code>tac</code> unless expressions
are used that are valid as both basic and extended regular expressions.</li>
<li>In UTF-8 locales, multi-byte characters are recognised and reversed
correctly.</li>
</ul>

<p dir="auto">The modernish <code>which</code> utility finds external programs and reports their
absolute paths, offering several unique options for reporting, formatting
and robust processing. The default operation is similar to GNU <code>which</code>.</p>
<p dir="auto">Usage: <code>which</code> [ <code>-apqsnQ1f</code> ] [ <code>-P</code> <em>number</em> ] <em>program</em> [ <em>program</em> ... ]</p>
<p dir="auto">By default, <code>which</code> finds the first available path to each given <em>program</em>.
If <em>program</em> is itself a path name (contains a slash), only that path&#39;s base
directory is searched; if it is a simple command name, the current <code>$PATH</code>
is searched. Any relative paths found are converted to absolute paths.
Symbolic links are not followed. The first path found for each <em>program</em> is
written to standard output (one per line), and a warning is written to
standard error for every <em>program</em> not found. The exit status is 0 (success)
if all <em>program</em>s were found, 1 otherwise.</p>
<p dir="auto"><code>which</code> also leaves its output in the <code>REPLY</code> variable. This may be useful
if you run <code>which</code> in the main shell environment. The <code>REPLY</code> value will
<em>not</em> survive a command substitution
<a href="#user-content-insubshell">subshell</a>
as in <code>ls_path=$(which ls)</code>.</p>
<p dir="auto">The following options modify the default behaviour described above:</p>
<ul dir="auto">
<li><code>-a</code>: List <em>a</em>ll <em>program</em>s that can be found in the directories searched,
instead of just the first one. This is useful for finding duplicate
commands that the shell would not normally find when searching its <code>$PATH</code>.</li>
<li><code>-p</code>: Search in <a href="#user-content-modernish-system-constants"><code>$DEFPATH</code></a>
(the default standard utility <code>PATH</code> provided by the operating system)
instead of in the user&#39;s <code>$PATH</code>, which is vulnerable to manipulation.</li>
<li><code>-q</code>: Be <em>q</em>uiet: suppress all warnings.</li>
<li><code>-s</code>: <em>S</em>ilent operation: don&#39;t write output, only store it in the <code>REPLY</code>
variable. Suppress warnings except, if you run <code>which -s</code> in a subshell,
a warning that the <code>REPLY</code> variable will not survive the subshell.</li>
<li><code>-n</code>: When writing to standard output, do <em>n</em>ot write a final <em>n</em>ewline.</li>
<li><code>-Q</code>: Shell-<em>q</em>uote each unit of output. Separate by spaces instead
of newlines. This generates a one-line list of arguments in shell syntax,
guaranteed to be suitable for safe parsing by the shell, even if the
resulting pathnames should contain strange characters such as spaces or
newlines and other control characters.</li>
<li><code>-1</code> (one): Output the results for at most <em>one</em> of the arguments in
descending order of preference: once a search succeeds, ignore
the rest. Suppress warnings except a subshell warning for <code>-s</code>.
This is useful for finding a command that can exist under
several names, for example:
<code>which -f -1 gnutar gtar tar</code></li>
<li><code>-f</code>: Throw a <a href="#user-content-reliable-emergency-halt"><em>f</em>atal error</a>
in cases where <code>which</code> would otherwise return status 1 (non-success).</li>
<li><code>-P</code>: Strip the indicated number of <em>p</em>athname elements from the output,
starting from the right.
<code>-P1</code>: strip <code>/program</code>;
<code>-P2</code>: strip <code>/*/program</code>,
etc. This is useful for determining the installation root directory for
an installed package.</li>
<li><code>--help</code>: Show brief usage information.</li>
</ul>

<p dir="auto"><code>yes</code> very quickly outputs infinite lines of text, each consisting of its
space-separated arguments, until terminated by a signal or by a failure to
write output. If no argument is given, the default line is <code>y</code>. No options
are supported.</p>
<p dir="auto">This infinite-output command is useful for piping into commands that need an
indefinite input data stream, or to automate a command requiring interactive
confirmation.</p>
<p dir="auto">Modernish <code>yes</code> is like GNU <code>yes</code> in that it outputs all its arguments,
whereas BSD <code>yes</code> only outputs the first. It can output multiple gigabytes
per second on modern systems.</p>

<p dir="auto">Modules in this category contain functions for enhancing the invocation of
commands.</p>

<p dir="auto"><code>extern</code> is like <code>command</code> but always runs an external command, without
having to know or determine its location. This provides an easy way to
bypass a builtin, alias or function. It does the same <code>$PATH</code> search
the shell normally does when running an external command. For instance, to
guarantee running external <code>printf</code> just do: <code>extern printf ...</code></p>
<p dir="auto">Usage: <code>extern</code> [ <code>-p</code> ] [ <code>-v</code> ] [ <code>-u</code> <em>varname</em> ... ]
[ <em>varname</em><code>=</code><em>value</em> ... ] <em>command</em> [ <em>argument</em> ... ]</p>
<ul dir="auto">
<li><code>-p</code>: The <em>command</em>, as well as any commands it further invokes, are searched in
<a href="#user-content-modernish-system-constants"><code>$DEFPATH</code></a>
(the default standard utility <code>PATH</code> provided by the operating system)
instead of in the user&#39;s <code>$PATH</code>, which is vulnerable to manipulation.
<ul dir="auto">
<li><code>extern -p</code> is much more reliable than the shell&#39;s builtin
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/command.html#tag_20_22_04" rel="nofollow"><code>command -p</code></a>
because: (a) many existing shell installations use a wrong search path for
<code>command -p</code>; (b) <code>command -p</code> does not export the default <code>PATH</code>, so
something like <code>command -p sudo cp foo /bin/bar</code> searches only <code>sudo</code> in
the secure default path and not <code>cp</code>.</li>
</ul>
</li>
<li><code>-v</code>: don&#39;t execute <em>command</em> but show the full path name of the command that
would have been executed. Any extra <em>argument</em>s are taken as more command
paths to show, one per line. <code>extern</code> exits with status 0 if all the commands
were found, 1 otherwise. This option can be combined with <code>-p</code>.</li>
<li><code>-u</code>: Temporary export override. Unset the given variable in the
environment of the command executed, even if it is currently exported. Can
be specified multiple times.</li>
<li><em>varname</em><code>=</code><em>value</em> assignment-arguments: These variables/values are
temporarily exported to the environment during the execution of the command.
<ul dir="auto">
<li>This is provided because assignments <em>preceding</em> <code>extern</code> cause unwanted,
shell-dependent side effects, as <code>extern</code> is a shell function. Be
sure to provide assignment-arguments <em>following</em> <code>extern</code> instead.</li>
<li>Assignment-arguments after a <code>--</code> end-of-options delimiter are not parsed;
this allows <em>command</em>s containing a <code>=</code> sign to be executed.</li>
</ul>
</li>
</ul>

<p dir="auto">The <code>harden</code> function allows implementing emergency halt on error
for any external commands and shell builtin utilities. It is
modernish&#39;s replacement for <code>set -e</code> a.k.a. <code>set -o errexit</code> (which is
<a href="https://lists.gnu.org/archive/html/bug-bash/2012-12/msg00093.html" rel="nofollow">fundamentally</a>
<a href="http://mywiki.wooledge.org/BashFAQ/105" rel="nofollow">flawed</a>,
not supported and will break the library).
It depends on, and auto-loads, the <code>sys/cmd/extern</code> module.</p>
<p dir="auto"><code>harden</code> sets a shell function with the same name as the command hardened,
so it can be used transparently. This function hardens the given command by
checking its exit status against values indicating error or system failure.
Exactly what exit statuses signify an error or failure depends on the
command in question; this should be looked up in the
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/contents.html" rel="nofollow">POSIX specification</a>
(under &#34;Utilities&#34;) or in the command&#39;s <code>man</code> page or other documentation.</p>
<p dir="auto">If the command fails, the function installed by <code>harden</code> calls <code>die</code>, so it
will reliably halt program execution, even if the failure occurred within a
<a href="#user-content-insubshell">subshell</a>.</p>
<p dir="auto">Usage:</p>
<p dir="auto"><code>harden</code> [ <code>-f</code> <em>funcname</em> ] [ <code>-[cSpXtPE]</code> ] [ <code>-e</code> <em>testexpr</em> ]
[ <em>var</em><code>=</code><em>value</em> ... ] [ <code>-u</code> <em>var</em> ... ] <em>command_name_or_path</em>
[ <em>command_argument</em> ... ]</p>
<p dir="auto">The <code>-f</code> option hardens the command as the shell function <em>funcname</em> instead
of defaulting to <em>command_name_or_path</em> as the function name. (If the latter
is a path, that&#39;s always an invalid function name, so the use of <code>-f</code> is
mandatory.) If <em>command_name_or_path</em> is itself a shell function, that
function is bypassed and the builtin or external command by that name is
hardened instead. If no such command is found, <code>harden</code> dies with the message
that hardening shell functions is not supported. (Instead, you should invoke
<code>die</code> directly from your shell function upon detecting a fatal error.)</p>
<p dir="auto">The <code>-c</code> option causes <em>command_name_or_path</em> to be hardened and run
immediately instead of setting a shell function for later use. This option
is meant for commands that run once; it is not efficient for repeated use.
It cannot be used together with the <code>-f</code> option.</p>
<p dir="auto">The <code>-S</code> option allows specifying several possible names/paths for a
command. It causes the <em>command_name_or_path</em> to be split by comma and
interpreted as multiple names or paths to search. The first name or path
found is used. Requires <code>-f</code>.</p>
<p dir="auto">The <code>-e</code> option, which defaults to <code>&gt;0</code>, indicates the exit statuses
corresponding to a fatal error. It depends on the command what these are;
consult the POSIX spec and the manual pages.
The status test expression <em>testexpr</em>, argument
to the <code>-e</code> option, is like a shell arithmetic
expression, with the binary operators <code>==</code> <code>!=</code> <code>&lt;=</code> <code>&gt;=</code> <code>&lt;</code> <code>&gt;</code> turned
into unary operators referring to the exit status of the command in
question. Assignment operators are disallowed. Everything else is the same,
including <code>&amp;&amp;</code> (logical and) and <code>||</code> (logical or) and parentheses.
Note that the expression needs to be quoted as the characters used in it
clash with shell grammar tokens.</p>
<p dir="auto">The <code>-X</code> option causes <code>harden</code> to always search for and harden an external
command, even if a built-in command by that name exists.</p>
<p dir="auto">The <code>-E</code> option causes the hardening function to consider it a fatal error
if the hardened command writes anything to the standard error stream. This
option allows hardening commands (such as
<a href="https://github.com/modernish/modernish/blob/master/pubs.opengroup.org/onlinepubs/9699919799/utilities/bc.html#tag_20_09_14"><code>bc</code></a>)
where you can&#39;t rely on the exit status to detect an error. The text written
to standard error is passed on as part of the error message printed by
<code>die</code>. Note that:</p>
<ul dir="auto">
<li>Intercepting standard error necessitates that the command be executed from a
<a href="#user-content-insubshell">subshell</a>.
This means any builtins or shell functions hardened with <code>-E</code> cannot
influence the calling shell (e.g. <code>harden -E cd</code> renders <code>cd</code> ineffective).</li>
<li><code>-E</code> does not disable exit status checks; by default, any exit status greater
than zero is still considered a fatal error as well. If your command does not
even reliably return a 0 status upon success, then you may want to add <code>-e &#39;&gt;125&#39;</code>, limiting the exit status check to reserved values indicating errors
launching the command and signals caught.</li>
</ul>
<p dir="auto">The <code>-p</code> option causes <code>harden</code> to search for commands using the
system default path (as obtained with <code>getconf PATH</code>) as opposed to the
current <code>$PATH</code>. This ensures that you&#39;re using a known-good external
command that came with your operating system. By default, the system-default
PATH search only applies to the command itself, and not to any commands that
the command may search for in turn. But if the <code>-p</code> option is specified at
least twice, the command is run in a subshell with <code>PATH</code> exported as the
default path, which is equivalent to adding a <code>PATH=$DEFPATH</code> assignment
argument (see <a href="#user-content-important-note-on-variable-assignments">below</a>).</p>
<p dir="auto">Examples:</p>
<div dir="auto" data-snippet-clipboard-copy-content="harden make                           # simple check for status &gt; 0
harden -f tar &#39;/usr/local/bin/gnutar&#39; # id.; be sure to use this &#39;tar&#39; version
harden -e &#39;&gt; 1&#39; grep                  # for grep, status &gt; 1 means error
harden -e &#39;==1 || &gt;2&#39; gzip            # 1 and &gt;2 are errors, but 2 isn&#39;t (see manual)"><pre>harden make                           <span><span>#</span> simple check for status &gt; 0</span>
harden -f tar <span><span>&#39;</span>/usr/local/bin/gnutar<span>&#39;</span></span> <span><span>#</span> id.; be sure to use this &#39;tar&#39; version</span>
harden -e <span><span>&#39;</span>&gt; 1<span>&#39;</span></span> grep                  <span><span>#</span> for grep, status &gt; 1 means error</span>
harden -e <span><span>&#39;</span>==1 || &gt;2<span>&#39;</span></span> gzip            <span><span>#</span> 1 and &gt;2 are errors, but 2 isn&#39;t (see manual)</span></pre></div>
<div dir="auto"><h5 tabindex="-1" dir="auto">Important note on variable assignments</h5><a id="user-content-important-note-on-variable-assignments" aria-label="Permalink: Important note on variable assignments" href="#important-note-on-variable-assignments"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">As far as the shell is concerned, hardened commands are shell functions and
not external or builtin commands. This essentially changes one behaviour of
the shell: variable assignments preceding the command will not be local to
the command as usual, but <em>will persist</em> after the command completes.
(POSIX technically makes that behaviour
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_09_01" rel="nofollow">optional</a>
but all current shells behave the same in POSIX mode.)</p>
<p dir="auto">For example, this means that something like</p>
<div dir="auto" data-snippet-clipboard-copy-content="harden -e &#39;&gt;1&#39; grep
# [...]
LC_ALL=C grep regex some_ascii_file.txt"><pre>harden -e <span><span>&#39;</span>&gt;1<span>&#39;</span></span> grep
<span><span>#</span> [...]</span>
LC_ALL=C grep regex some_ascii_file.txt</pre></div>
<p dir="auto">should never be done, because the meant-to-be-temporary <code>LC_ALL</code> locale
assignment will persist and is likely to cause problems further on.</p>
<p dir="auto">To solve this problem, <code>harden</code> supports adding these assignments as
part of the hardening command, so instead of the above you do:</p>
<div dir="auto" data-snippet-clipboard-copy-content="harden -e &#39;&gt;1&#39; LC_ALL=C grep
# [...]
grep regex some_ascii_file.txt"><pre>harden -e <span><span>&#39;</span>&gt;1<span>&#39;</span></span> LC_ALL=C grep
<span><span>#</span> [...]</span>
grep regex some_ascii_file.txt</pre></div>
<p dir="auto">With the <code>-u</code> option, <code>harden</code> also supports unsetting variables for the
duration of a command, e.g.:</p>
<div dir="auto" data-snippet-clipboard-copy-content="harden -e &#39;&gt;1&#39; -u LC_ALL grep"><pre>harden -e <span><span>&#39;</span>&gt;1<span>&#39;</span></span> -u LC_ALL grep</pre></div>
<p dir="auto">The <code>-u</code> option may be specified multiple times.
It causes the hardened command to be invoked from a
<a href="#user-content-insubshell">subshell</a>
with the specified variables unset.</p>
<div dir="auto"><h5 tabindex="-1" dir="auto">Hardening while allowing for broken pipes</h5><a id="user-content-hardening-while-allowing-for-broken-pipes" aria-label="Permalink: Hardening while allowing for broken pipes" href="#hardening-while-allowing-for-broken-pipes"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If you&#39;re piping a command&#39;s output into another command that may close
the pipe before the first command is finished, you can use the <code>-P</code> option
to allow for this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="harden -e &#39;==1 || &gt;2&#39; -P gzip		# also tolerate gzip being killed by SIGPIPE
gzip -dc file.txt.gz | head -n 10	# show first 10 lines of decompressed file"><pre>harden -e <span><span>&#39;</span>==1 || &gt;2<span>&#39;</span></span> -P gzip		<span><span>#</span> also tolerate gzip being killed by SIGPIPE</span>
gzip -dc file.txt.gz <span>|</span> head -n 10	<span><span>#</span> show first 10 lines of decompressed file</span></pre></div>
<p dir="auto"><code>head</code> will close the pipe of <code>gzip</code> input after ten lines; the operating
system kernel then kills <code>gzip</code> with the PIPE signal before it&#39;s finished,
causing a particular exit status that is greater than 128. This exit status
would normally make <code>harden</code> kill your entire program, which in the example
above is clearly not the desired behaviour. If the exit status caused by a
broken pipe were known, you could specifically allow for that exit status in
the status expression. The trouble is that this exit status varies depending
on the shell and the operating system. The <code>-p</code> option was made to solve
this problem: it automatically detects and whitelists the correct exit
status corresponding to <code>SIGPIPE</code> termination on the current system.</p>
<p dir="auto">Tolerating <code>SIGPIPE</code> is an option and not the default, because in many
contexts it may be entirely unexpected and a symptom of a severe error if a
command is killed by a broken pipe. It is up to the programmer to decide
which commands should expect <code>SIGPIPE</code> and which shouldn&#39;t.</p>
<p dir="auto"><em>Tip:</em> It could happen that the same command should expect <code>SIGPIPE</code> in one
context but not another. You can create two hardened versions of the same
command, one that tolerates <code>SIGPIPE</code> and one that doesn&#39;t. For example:</p>
<div dir="auto" data-snippet-clipboard-copy-content="harden -f hardGrep -e &#39;&gt;1&#39; grep		# hardGrep does not tolerate being aborted
harden -f pipeGrep -e &#39;&gt;1&#39; -P grep	# pipeGrep for use in pipes that may break"><pre>harden -f hardGrep -e <span><span>&#39;</span>&gt;1<span>&#39;</span></span> grep		<span><span>#</span> hardGrep does not tolerate being aborted</span>
harden -f pipeGrep -e <span><span>&#39;</span>&gt;1<span>&#39;</span></span> -P grep	<span><span>#</span> pipeGrep for use in pipes that may break</span></pre></div>
<p dir="auto"><em>Note:</em> If <code>SIGPIPE</code> was set to ignore by the process invoking the current
shell, the <code>-p</code> option has no effect, because no process or subprocess of
the current shell can ever be killed by <code>SIGPIPE</code>. However, this may cause
various other problems and you may want to refuse to let your program run
under that condition.
<a href="#user-content-warning-ids"><code>thisshellhas WRN_NOSIGPIPE</code></a> can help
you easily detect that condition so your program can make a decision. See
the <a href="#user-content-warning-ids"><code>WRN_NOSIGPIPE</code> description</a> for more information.</p>
<div dir="auto"><h5 tabindex="-1" dir="auto">Tracing the execution of hardened commands</h5><a id="user-content-tracing-the-execution-of-hardened-commands" aria-label="Permalink: Tracing the execution of hardened commands" href="#tracing-the-execution-of-hardened-commands"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The <code>-t</code> option will trace command output. Each execution of a command
hardened with <code>-t</code> causes the command line to be output to standard
error, in the following format:</p>
<div data-snippet-clipboard-copy-content="[functionname]&gt; commandline"><pre><code>[functionname]&gt; commandline
</code></pre></div>
<p dir="auto">where <code>functionname</code> is the name of the shell function used to harden the
command and <code>commandline</code> is the actual command executed. The
<code>commandline</code> is properly shell-quoted in a format suitable for re-entry
into the shell; however, command lines longer than 512 bytes will be
truncated and the unquoted string <code> (TRUNCATED)</code> will be appended to the
trace. If standard error is on a terminal that supports ANSI colours,
the tracing output will be colourised.</p>
<p dir="auto">The <code>-t</code> option was added to <code>harden</code> because the commands that you harden
are often the same ones you would be particularly interested in tracing. The
advantage of using <code>harden -t</code> over the shell&#39;s builtin tracing facility
(<code>set -x</code> or <code>set -o xtrace</code>) is that the output is a <em>lot</em> less noisy,
especially when using a shell library such as modernish.</p>
<p dir="auto"><em>Note:</em> Internally, <code>-t</code> uses the shell file descriptor 9, redirecting it to
standard error (using <code>exec 9&gt;&amp;2</code>). This allows tracing to continue to work
normally even for commands that redirect standard error to a file (which is
another enhancement over <code>set -x</code> on most shells). However, this does mean
<code>harden -t</code> conflicts with any other use of the file descriptor 9 in your
shell program.</p>
<p dir="auto">If file descriptor 9 is already open before <code>harden</code> is called, <code>harden</code>
does not attempt to override this. This means tracing may be redirected
elsewhere by doing something like <code>exec 9&gt;trace.out</code> before calling
<code>harden</code>. (Note that redirecting FD 9 on the <code>harden</code> command itself will
<em>not</em> work as it won&#39;t survive the run of the command.)</p>
<div dir="auto"><h5 tabindex="-1" dir="auto">Simple tracing of commands</h5><a id="user-content-simple-tracing-of-commands" aria-label="Permalink: Simple tracing of commands" href="#simple-tracing-of-commands"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Sometimes you just want to trace the execution of some specific commands as
in <code>harden -t</code> (see above) without actually hardening them against command
errors; you might prefer to do your own error handling. <code>trace</code> makes this
easy. It is modernish&#39;s replacement or complement for <code>set -x</code> a.k.a. <code>set -o xtrace</code>.
Unlike <code>harden -t</code>, it can also trace shell functions.</p>
<p dir="auto"><strong>Usage 1:</strong> <code>trace</code> [ <code>-f</code> <em>funcname</em> ] [ <code>-[cSpXE]</code> ]
[ <em>var</em><code>=</code><em>value</em> ... ] [ <code>-u</code> <em>var</em> ... ] <em>command_name_or_path</em>
[ <em>command_argument</em> ... ]</p>
<p dir="auto">For non-function commands, <code>trace</code> acts as a shortcut for
<code>harden -t -P -e &#39;&gt;125 &amp;&amp; !=255&#39;</code> <em>command_name_or_path</em>.
Any further options and arguments are passed on to <code>harden</code> as given. The
result is that the indicated command is automatically traced upon execution.
A bonus is that you still get minimal hardening against fatal system errors.
Errors in the traced command itself are ignored, but your program is
immediately halted with an informative error message if the traced command:</p>
<ul dir="auto">
<li>cannot be found (exit status 127);</li>
<li>was found but cannot be executed (exit status 126);</li>
<li>was killed by a signal other than <code>SIGPIPE</code> (exit status &gt; 128, except
the shell-specific exit status for <code>SIGPIPE</code>, and except 255 which is
used by some utilities, such as <code>ssh</code> and <code>rsync</code>, to return an error).</li>
</ul>
<p dir="auto"><em>Note:</em> The caveat for command-local variable assignments for <code>harden</code> also
applies to <code>trace</code>. See
<a href="#user-content-important-note-on-variable-assignments">Important note on variable assignments</a>
above.</p>
<p dir="auto"><strong>Usage 2:</strong> [ <code>#!</code> ] <code>trace -f</code> <em>funcname</em></p>
<p dir="auto">If no further arguments are given, <code>trace -f</code> will trace the shell
function <em>funcname</em> without applying further hardening (except against
nonexistence). <code>trace -f</code> can be used to trace the execution of modernish
library functions as well as your own script&#39;s functions. The trace output
for shell functions shows an extra <code>()</code> following the function name.</p>
<p dir="auto">Internally, this involves setting an alias under the function&#39;s name, so
the limitations of the shell&#39;s alias expansion mechanism apply: only
function calls that the shell had not yet parsed before calling <code>trace -f</code>
will be traced. So you should use <code>trace -f</code> at the beginning of your
script, before defining your own functions. To facilitate this, <code>trace -f</code>
does not check that the function <em>funcname</em> exists while setting up
tracing, but only when attempting to execute the traced function.</p>
<p dir="auto">In <a href="#user-content-portable-form">portable-form</a>
modernish scripts, <code>trace -f</code> should be used as a hashbang command to be
compatible with alias expansion on all shells. Only the <code>trace -f</code> form
may be used that way. For example:</p>
<div dir="auto" data-snippet-clipboard-copy-content="#! /usr/bin/env modernish
#! use safe -k
#! use sys/cmd/harden
#! trace -f push
#! trace -f pop
...your program begins here..."><pre><span><span>#!</span> /usr/bin/env modernish</span>
<span><span>#!</span> use safe -k</span>
<span><span>#!</span> use sys/cmd/harden</span>
<span><span>#!</span> trace -f push</span>
<span><span>#!</span> trace -f pop</span>
...your program begins here...</pre></div>

<p dir="auto"><code>mapr</code> (map records) is an alternative to <code>xargs</code> that shares features with the
<code>mapfile</code> command in bash 4.x. It is fully integrated into your script&#39;s main
shell environment, so it can call your shell functions as well as builtin and
external utilities.
It depends on, and auto-loads, the <code>sys/cmd/procsubst</code> module.</p>
<p dir="auto">Usage: <code>mapr</code> [ <code>-d</code> <em>delimiter</em> | <code>-P</code> ] [ <code>-s</code> <em>count</em> ] [ <code>-n</code> <em>number</em> ]
[ <code>-m</code> <em>length</em> ] [ <code>-c</code> <em>quantum</em> ] <em>callback</em></p>
<p dir="auto"><code>mapr</code> reads delimited records from the standard input, invoking the specified
<em>callback</em> command once or repeatedly as needed, with batches of input records
as arguments. The <em>callback</em> may consist of multiple arguments. By default, an
input record is one line of text.</p>
<p dir="auto">Options:</p>
<ul dir="auto">
<li><code>-d</code> <em>delimiter</em>: Use the single character <em>delimiter</em> to delimit input records,
instead of the newline character. A <code>NUL</code> (0) character and multi-byte
characters are not supported.</li>
<li><code>-P</code>: Paragraph mode. Input records are delimited by sequences consisting of
a newline plus one or more blank lines, and leading or trailing blank lines
will not result in empty records at the beginning or end of the input. Cannot
be used together with <code>-d</code>.</li>
<li><code>-s</code> <em>count</em>: Skip and discard the first <em>count</em> records read.</li>
<li><code>-n</code> <em>number</em>: Stop processing after passing a total of <em>number</em> records to
invocation(s) of <em>callback</em>. If <code>-n</code> is not supplied or <em>number</em> is 0, all
records are passed, except those skipped using <code>-s</code>.</li>
<li><code>-m</code> <em>length</em>: Set the maximum argument length in bytes of each <em>callback</em>
command call, including the <em>callback</em> command argument(s) and the current
batch of up to <em>quantum</em> input records. The length of each argument is
increased by 1 to account for the terminating null byte. The default
maximum length depends on constraints set by the operating system for
invoking external commands. If <em>length</em> is 0, this limit is disabled.</li>
<li><code>-c</code> <em>quantum</em>: Pass at most <em>quantum</em> arguments at a time to each call to
<em>callback</em>. If <code>-c</code> is not supplied or if <em>quantum</em> is 0, the number of
arguments per invocation is not limited except by <code>-m</code>; whichever limit is
reached first applies.</li>
</ul>
<p dir="auto">Arguments:</p>
<ul dir="auto">
<li><em>callback</em>: Call the <em>callback</em> command with the collected arguments each
time <em>quantum</em> lines are read. The callback command may be a shell function or
any other kind of command, and is executed from the same shell environment
that invoked <code>mapr</code>. If the callback command exits or returns with status
255 or is interrupted by the <code>SIGPIPE</code> signal, <code>mapr</code> will not process any
further batches but immediately exit with the status of the callback
command. If it exits with another exit status 126 or greater, a
<a href="#user-content-reliable-emergency-halt">fatal error</a>
is thrown. Otherwise, <code>mapr</code> exits with the status of the last-executed
callback command.</li>
<li><em>argument</em>:  If there are extra arguments supplied on the mapr command line,
they will be added before the collected arguments on each invocation on the
callback command.</li>
</ul>

<p dir="auto"><code>mapr</code> was inspired by the bash 4.x builtin command <code>mapfile</code> a.k.a.
<code>readarray</code>, and uses similar options, but there are important differences.</p>
<ul dir="auto">
<li><code>mapr</code> passes all the records as arguments to the callback command.</li>
<li><code>mapr</code> does not support assigning records directly to an array. Instead,
all handling is done through the callback command (which could be a shell
function that assigns its arguments to an array.)</li>
<li>The callback command is specified directly instead of with a <code>-C</code> option,
and it may consist of several arguments (as with <code>xargs</code>).</li>
<li>The record separator itself is never included in the arguments passed
to the callback command (so there is no <code>-t</code> option to remove it).</li>
<li><code>mapr</code> supports paragraph mode.</li>
<li>If the callback command exits with status 255, processing is aborted.</li>
</ul>

<p dir="auto"><code>mapr</code> shares important characteristics with
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/xargs.html" rel="nofollow"><code>xargs</code></a>
while avoiding its myriad pitfalls.</p>
<ul dir="auto">
<li>Instead of being an external utility, <code>mapr</code> is fully integrated into the
shell. The callback command can be a shell function or builtin, which can
directly modify the shell environment.</li>
<li><code>mapr</code> is line-oriented by default, so it is safe to use for input
arguments that contain spaces or tabs.</li>
<li><code>mapr</code> does not parse or modify the input arguments in any way, e.g. it
does not process and remove quotes from them like <code>xargs</code> does.</li>
<li><code>mapr</code> supports paragraph mode.</li>
</ul>

<p dir="auto">This module provides a portable
<a href="https://en.wikipedia.org/wiki/Process_substitution" rel="nofollow">process substitution</a>
construct, the advantage being that this is not limited to bash, ksh or zsh
but works on all POSIX shells capable of running modernish. It is not
possible for modernish to introduce the original ksh syntax into other
shells. Instead, this module provides a <code>%</code> command for use within a
<code>$(</code>command substitution<code>)</code>.</p>
<p dir="auto">The <code>%</code> command takes one simple command as its arguments, executes it in
the background, and writes a file name from which to read its output. So
if <code>%</code> is used within a command substitution as intended, that file name
is passed on to the invoking command as an argument.</p>
<p dir="auto">The <code>%</code> command supports one option, <code>-o</code>. If that option is given, then it is
expected that, instead of reading input, the invoking command writes output to
the file name passed on to it, so that the command invoked by <code>% -o</code> can read
that data from its standard input.</p>
<markdown-accessiblity-table>
Example syntax comparison:
<table><tbody><tr>
<th>ksh/bash/zsh</th><th>modernish</th>
</tr>
<tr>
<td>
<code>diff -u &lt;(ls) &lt;(ls -a)</code>
</td>
<td>
<code>diff -u $(% ls) $(% ls -a)</code>
</td>
</tr>
<tr>
<td>
<code>IFS=&#39; &#39; read -r user vsz args &lt; &lt;(ps -o &#39;user= vsz= args=&#39; -p $$)</code>
</td>
<td>
<code>IFS=&#39; &#39; read -r user vsz args &lt; $(% ps -o &#39;user= vsz= args=&#39; -p $$)</code>
</td>
</tr>
<tr>
<td>
<code>{ some commands; } &gt; &gt;(tee stdout.log) 2&gt; &gt;(tee stderr.log)</code>
</td>
<td>
<code>{ some commands; } &gt; $(% -o tee stdout.log) 2&gt; $(% -o tee stderr.log)</code>
</td>
</tr>
</tbody></table></markdown-accessiblity-table>
<p dir="auto">Unlike the bash/ksh/zsh version, modernish process substitution only works
with simple commands. This includes shell function calls, but not aliases or
anything involving shell grammar or reserved words (such as redirections,
pipelines, loops, etc.). To use such complex commands, enclose them in a shell
function and call that function from the process substitution.</p>
<p dir="auto">Also note that anything that a command invoked by the <code>% -o</code> writes to its
standard output is redirected to standard error. The main shell environment&#39;s
standard output is not available because the command substitution subsumes it.</p>

<p dir="auto">The <code>source</code> command sources a dot script like the <code>.</code> command, but
additionally supports passing arguments to sourced scripts like you would
pass them to a function. It mostly mimics the behaviour of the <code>source</code>
command built in to bash and zsh.</p>
<p dir="auto">If a filename without a directory path is given, then, unlike the <code>.</code>
command, <code>source</code> looks for the dot script in the current directory by
default, as well as searching <code>$PATH</code>.</p>
<p dir="auto">It is a fatal error to attempt to source a directory, a file with no read
permission, or a nonexistent file.</p>

<p dir="auto">Functions for working with directories.</p>

<p dir="auto"><code>countfiles</code>: Count the files in a directory using nothing but shell
functionality, so without external commands. (It&#39;s amazing how many pitfalls
this has, so a library function is needed to do it robustly.)</p>
<p dir="auto">Usage: <code>countfiles</code> [ <code>-s</code> ] <em>directory</em> [ <em>globpattern</em> ... ]</p>
<p dir="auto">Count the number of files in a directory, storing the number in <code>REPLY</code>
and (unless <code>-s</code> is given) printing it to standard output.
If any <em>globpattern</em>s are given, only count the files matching them.</p>

<p dir="auto">The <code>mkcd</code> function makes one or more directories, then, upon success,
change into the last-mentioned one. <code>mkcd</code> inherits <code>mkdir</code>&#39;s usage, so
options depend on your system&#39;s <code>mkdir</code>; only the
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/mkdir.html#tag_20_79_04" rel="nofollow">POSIX options</a>
are guaranteed.
When <code>mkcd</code> is run from a script, it uses <code>cd -P</code> to change the working
directory, resolving any symlinks in the present working directory path.</p>

<p dir="auto">Utilities for working with the terminal.</p>

<p dir="auto">This module provides commands to efficiently output a string repeatedly.</p>
<p dir="auto">Usage:</p>
<ul dir="auto">
<li><code>putr</code> [ <em>number</em> | <code>-</code> ] <em>string</em></li>
<li><code>putrln</code> [ <em>number</em> | <code>-</code> ] <em>string</em></li>
</ul>
<p dir="auto">Output the <em>string</em> <em>number</em> times. When using <code>putrln</code>, add a newline at
the end.</p>
<p dir="auto">If a <code>-</code> is given instead of a <em>number</em>, then the total length of the output
is the line length of the terminal divided by the length of the <em>string</em>,
rounded down.</p>
<p dir="auto">Note that, unlike with <code>put</code> and <code>putln</code>, only a single <em>string</em>
argument is accepted.</p>
<p dir="auto">Example: <code>putrln - &#39;=&#39;</code> prints a full terminal line of equals signs.</p>

<p dir="auto"><code>readkey</code>: read a single character from the keyboard without echoing back to
the terminal. Buffering is done so that multiple waiting characters are read
one at a time.</p>
<p dir="auto">Usage: <code>readkey</code> [ <code>-E</code> <em>ERE</em> ] [ <code>-t</code> <em>timeout</em> ] [ <code>-r</code> ] [ <em>varname</em> ]</p>
<p dir="auto"><code>-E</code>: Only accept characters that match the extended regular expression
<em>ERE</em> (the type of RE used by <code>grep -E</code>/<code>egrep</code>). <code>readkey</code> will silently
ignore input not matching the ERE and wait for input matching it.</p>
<p dir="auto"><code>-t</code>: Specify a <em>timeout</em> in seconds (one significant digit after the
decimal point). After the timeout expires, no character is read and
<code>readkey</code> returns status 1.</p>
<p dir="auto"><code>-r</code>: Raw mode. Disables INTR (Ctrl+C), QUIT, and SUSP (Ctrl+Z) processing
as well as translation of carriage return (13) to linefeed (10).</p>
<p dir="auto">The character read is stored into the variable referenced by <em>varname</em>,
which defaults to <code>REPLY</code> if not specified.</p>
<p dir="auto">This module depends on the trap stack to save and restore the terminal state
if the program is stopped while reading a key, so it will automatically
<code>use var/stack/trap</code> on initialisation.</p>
<hr/>
<div dir="auto"><h2 tabindex="-1" dir="auto">Appendix A: List of shell cap IDs</h2><a id="user-content-appendix-a-list-of-shell-cap-ids" aria-label="Permalink: Appendix A: List of shell cap IDs" href="#appendix-a-list-of-shell-cap-ids"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This appendix lists all the shell
<a href="#user-content-capabilities">capabilities</a>,
<a href="#user-content-quirks">quirks</a>, and
<a href="#user-content-bugs">bugs</a>
that modernish can detect in the current shell, so that modernish scripts
can easily query the results of these tests and decide what to do. Certain
<a href="#user-content-warning-ids">problematic system conditions</a>
are also detected this way and listed here.</p>
<p dir="auto">The all-caps IDs below are all usable with the
<a href="#user-content-shell-capability-detection"><code>thisshellhas</code></a>
function. This makes it easy for a cross-platform modernish script to
be aware of relevant conditions and decide what to do.</p>
<p dir="auto">Each detection test has its own little test script in the
<code>lib/modernish/cap</code> directory. These tests are executed on demand, the
first time the capability or bug in question is queried using
<code>thisshellhas</code>. See <code>README.md</code> in that directory for further information.
The test scripts also document themselves in the comments.</p>

<p dir="auto">Modernish currently identifies and supports the following non-standard
shell capabilities:</p>
<ul dir="auto">
<li><code>ADDASSIGN</code>: Add a string to a variable using additive assignment,
e.g. <em>VAR</em><code>+=</code><em>string</em></li>
<li><code>ANONFUNC</code>: zsh anonymous functions (basically the native zsh equivalent
of modernish&#39;s var/local module)</li>
<li><code>ARITHCMD</code>: standalone arithmetic evaluation using a command like
<code>((</code><em>expression</em><code>))</code>.</li>
<li><code>ARITHFOR</code>: ksh93/C-style arithmetic <code>for</code> loops of the form
<code>for ((</code><em>exp1</em><code>; </code><em>exp2</em><code>; </code><em>exp3</em><code>)) do </code><em>commands</em><code>; done</code>.</li>
<li><code>ARITHPP</code>: support for the <code>++</code> and <code>--</code> unary operators in shell arithmetic.</li>
<li><code>CESCQUOT</code>: Quoting with C-style escapes, like <code>$&#39;\n&#39;</code> for newline.</li>
<li><code>DBLBRACKET</code>: The ksh88-style <code>[[</code> double-bracket command <code>]]</code>,
implemented as a reserved word, integrated into the main shell grammar,
and with a different grammar applying within the double brackets.
(ksh93, mksh, bash, zsh, yash &gt;= 2.48)</li>
<li><code>DBLBRACKETERE</code>: <code>DBLBRACKET</code> plus the <code>=~</code> binary operator to match a
string against an extended regular expression.</li>
<li><code>DBLBRACKETV</code>: <code>DBLBRACKET</code> plus the <code>-v</code> unary operator to test if a
variable is set. Named variables only. (Testing positional parameters
(like <code>[[ -v 1 ]]</code>) does not work on bash or ksh93; check <code>$#</code> instead.)</li>
<li><code>DOTARG</code>: Dot scripts support arguments.</li>
<li><code>HERESTR</code>: Here-strings, an abbreviated kind of here-document.</li>
<li><code>KSH88FUNC</code>: define ksh88-style shell functions with the <code>function</code> keyword,
supporting dynamically scoped local variables with the <code>typeset</code> builtin.
(mksh, bash, zsh, yash, et al)</li>
<li><code>KSH93FUNC</code>: the same, but with static scoping for local variables. (ksh93 only)
See Q28 at the <a href="http://kornshell.com/doc/faq.html" rel="nofollow">ksh93 FAQ</a> for an explanation
of the difference.</li>
<li><code>KSHARRAY</code>: ksh93-style arrays. Supported on bash, zsh (under <code>emulate sh</code>),
mksh, and ksh93.</li>
<li><code>LEPIPEMAIN</code>: execute last element of a pipe in the main shell, so that
things like <em>somecommand</em> <code>| read</code> <em>somevariable</em> work. (zsh, AT&amp;T ksh,
bash 4.2+)</li>
<li><code>LINENO</code>: the <code>$LINENO</code> variable contains the current shell script line
number.</li>
<li><code>LOCALVARS</code>: the <code>local</code> command creates dynamically scoped local variables
within functions defined using standard POSIX syntax.</li>
<li><code>NONFORKSUBSH</code>: as a performance optimisation,
<a href="#user-content-insubshell">subshells</a> are
implemented without forking a new process, so they share a PID with the main
shell. (AT&amp;T ksh93; it has <a href="https://github.com/att/ast/issues/480" data-hovercard-type="issue" data-hovercard-url="/att/ast/issues/480/hovercard">many bugs</a>
related to this, but there&#39;s a nice workaround: <code>ulimit -t unlimited</code> forces
a subshell to fork, making those bugs disappear! See also <code>BUG_FNSUBSH</code>.)</li>
<li><code>PRINTFV</code>: The shell&#39;s <code>printf</code> builtin has the <code>-v</code> option to print to a variable,
which avoids forking a command substitution subshell.</li>
<li><code>PROCREDIR</code>: the shell natively supports <code>&lt;(</code>process redirection<code>)</code>,
a special kind of redirection that connects standard input (or standard
output) to a background process running your command(s).
This exists on yash.
Note this is <strong>not</strong> combined with a redirection like <code>&lt; &lt;(</code><em>command</em><code>)</code>.
Contrast with bash/ksh/zsh&#39;s <code>PROCSUBST</code> where this <code>&lt;(</code>syntax<code>)</code>
substitutes a file name.</li>
<li><code>PROCSUBST</code>: the shell natively supports <code>&lt;(</code>process substitution<code>)</code>,
a special kind of command substitution that substitutes a file name,
connecting it to a background process running your command(s).
This exists on ksh93 and zsh.
(Bash has it too, but its POSIX mode turns it off, so modernish can&#39;t use it.)
Note this is usually combined with a redirection, like <code>&lt; &lt;(</code><em>command</em><code>)</code>.
Contrast this with yash&#39;s <code>PROCREDIR</code> where the same <code>&lt;(</code>syntax<code>)</code>
is itself a redirection.</li>
<li><code>PSREPLACE</code>: Search and replace strings in variables using special parameter
substitutions with a syntax vaguely resembling sed.</li>
<li><code>RANDOM</code>: the <code>$RANDOM</code> pseudorandom generator.
Modernish seeds it if detected. The variable is then set it to read-only
whether the generator is detected or not, in order to block it from losing
its special properties by being unset or overwritten, and to stop it being
used if there is no generator. This is because some of modernish depends
on <code>RANDOM</code> either working properly or being unset.</li>
<li><code>ROFUNC</code>: Set functions to read-only with <code>readonly -f</code>. (bash, yash)</li>
<li><code>TESTERE</code>: The regular <code>test</code>/<code>[</code> builtin command supports the <code>=~</code> binary
operator to match a string against an extended regular expression.</li>
<li><code>TESTO</code>: The <code>test</code>/<code>[</code> builtin supports the <code>-o</code> unary operator to check if
a shell option is set.</li>
<li><code>TRAPPRSUBSH</code>: The ability to obtain a list of the current shell&#39;s native
traps from a command substitution subshell, for example: <code>var=$(trap)</code>,
as long as no new traps have been set within that command substitution.
Note that the <code>var/stack/trap</code> module transparently reimplements this
feature on shells without this native capability.</li>
<li><code>TRAPZERR</code>: This feature ID is detected if the <code>ERR</code> trap is an alias for
the <code>ZERR</code> trap. According to the zsh manual, this is the case for zsh on
most systems, i.e. those that don&#39;t have a <code>SIGERR</code> signal. (The
<a href="#user-content-the-trap-stack">trap stack</a>
uses this feature test.)</li>
<li><code>VARPREFIX</code>: Expansions of type <code>${!</code><em>prefix</em><code>@}</code> and <code>${!</code><em>prefix</em><code>*}</code> yield
all names of set variables beginning with <code>prefix</code> in the same way and with
the same quoting effects as <code>$@</code> and <code>$*</code>, respectively.
This includes the name <em>prefix</em> itself, unless the shell has <code>BUG_VARPREFIX</code>.
(bash; AT&amp;T ksh93)</li>
</ul>

<p dir="auto">Modernish currently identifies and supports the following shell quirks:</p>
<ul dir="auto">
<li><code>QRK_32BIT</code>: mksh: the shell only has 32-bit arithmetic. Since every modern
system these days supports 64-bit long integers even on 32-bit kernels, we
can now count this as a quirk.</li>
<li><code>QRK_ANDORBG</code>: On zsh, the <code>&amp;</code> operator takes the last simple command
as the background job and not an entire AND-OR list (if any).
In other words, <code>a &amp;&amp; b || c &amp;</code> is interpreted as
<code>a &amp;&amp; b || { c &amp; }</code> and not <code>{ a &amp;&amp; b || c; } &amp;</code>.</li>
<li><code>QRK_ARITHEMPT</code>: In yash, with POSIX mode turned off, a set but empty
variable yields an empty string when used in an arithmetic expression,
instead of 0. For example, <code>foo=&#39;&#39;; echo $((foo))</code> outputs an empty line.</li>
<li><code>QRK_ARITHWHSP</code>: In <a href="https://osdn.jp/ticket/browse.php?group_id=3863&amp;tid=36002" rel="nofollow">yash</a>
and FreeBSD /bin/sh, trailing whitespace from variables is not trimmed in arithmetic
expansion, causing the shell to exit with an &#39;invalid number&#39; error. POSIX is silent
on the issue. The modernish <code>isint</code> function (to determine if a string is a valid
integer number in shell syntax) is <code>QRK_ARITHWHSP</code> compatible, tolerating only
leading whitespace.</li>
<li><code>QRK_BCDANGER</code>: <code>break</code> and <code>continue</code> can affect non-enclosing loops,
even across shell function barriers (zsh, Busybox ash; older versions
of bash, dash and yash). (This is especially dangerous when using
<a href="#user-content-use-varlocal">var/local</a>
which internally uses a temporary shell function to try to protect against
breaking out of the block without restoring global parameters and settings.)</li>
<li><code>QRK_EMPTPPFLD</code>: Unquoted <code>$@</code> and <code>$*</code> do not discard empty fields.
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_05_02" rel="nofollow">POSIX says</a>
for both unquoted <code>$@</code> and unquoted <code>$*</code> that empty positional parameters
<em>may</em> be discarded from the expansion. AFAIK, just one shell (yash)
doesn&#39;t.</li>
<li><code>QRK_EMPTPPWRD</code>: <a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_05_02" rel="nofollow">POSIX says</a>
that empty <code>&#34;$@&#34;</code> generates zero fields but empty <code>&#39;&#39;</code> or <code>&#34;&#34;</code> or
<code>&#34;$emptyvariable&#34;</code> generates one empty field. But it leaves unspecified
whether something like <code>&#34;$@$emptyvariable&#34;</code> generates zero fields or one
field. Zsh, pdksh/mksh and (d)ash generate one field, as seems logical.
But bash, AT&amp;T ksh and yash generate zero fields, which we consider a
quirk. (See also BUG_PP_01)</li>
<li><code>QRK_EVALNOOPT</code>: <code>eval</code> does not parse options, not even <code>--</code>, which makes it
incompatible with other shells: on the one hand, (d)ash does not accept</li>
<li><code>QRK_EXECFNBI</code>: In pdksh and zsh, <code>exec</code> looks up shell functions and
builtins before external commands, and if it finds one it does the
equivalent of running the function or builtin followed by <code>exit</code>. This
is probably a bug in POSIX terms; <code>exec</code> is supposed to launch a
program that overlays the current shell, implying the program launched by
<code>exec</code> is always external to the shell. However, since the
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_20" rel="nofollow">POSIX language</a>
is rather
<a href="https://www.mail-archive.com/austin-group-l@opengroup.org/msg01437.html" rel="nofollow">vague and possibly incorrect</a>,
this is labeled as a shell quirk instead of a shell bug.</li>
<li><code>QRK_FNRDREXIT</code>: On FreeBSD sh and NetBSD sh, an error in a redirection
attached to a function call causes the shell to exit. This affects
redirections of all functions, including modernish library functions
as well as functions set by <a href="#user-content-use-syscmdharden"><code>harden</code></a>.</li>
<li><code>QRK_GLOBDOTS</code>: Pathname expansion of <code>.*</code> matches the pseudonames <code>.</code> and
<code>..</code> so that, e.g., <code>cp -pr .* backup/</code> cannot be used to copy all your
hidden files. (bash &lt; 5.2, (d)ash, AT&amp;T ksh != 93u+m, yash)</li>
<li><code>QRK_HDPARQUOT</code>: Double <strong>quot</strong>es within certain <strong>par</strong>ameter substitutions in
<strong>h</strong>ere-<strong>d</strong>ocuments aren&#39;t removed (FreeBSD sh; bosh). For instance, if
<code>var</code> is set, <code>${var+&#34;x&#34;}</code> in a here-document yields <code>&#34;x&#34;</code>, not <code>x</code>.
<a href="https://www.mail-archive.com/austin-group-l@opengroup.org/msg01626.html" rel="nofollow">POSIX considers it undefined</a>
to use double quotes there, so they should be avoided for a script to be
fully POSIX compatible.
(Note this quirk does <strong>not</strong> apply for substitutions that remove patterns,
such as <code>${var#&#34;$x&#34;}</code> and <code>${var%&#34;$x&#34;}</code>; those are defined by POSIX
and double quotes are fine to use.)
(Note 2: single quotes produce widely varying behaviour and should never
be used within any form of parameter substitution in a here-document.)</li>
<li><code>QRK_IFSFINAL</code>: in field splitting, a final non-whitespace <code>IFS</code> delimiter
character is counted as an empty field (yash &lt; 2.42, zsh, pdksh). This is a QRK
(quirk), not a BUG, because POSIX is ambiguous on this.</li>
<li><code>QRK_LOCALINH</code>: On a shell with <code>LOCALVARS</code>, local variables, when declared
without assigning a value, inherit the state of their global namesake, if
any. (dash, FreeBSD sh)</li>
<li><code>QRK_LOCALSET</code>: On a shell with <code>LOCALVARS</code>, local variables are immediately set
to the empty value upon being declared, instead of being initially without
a value. (zsh)</li>
<li><code>QRK_LOCALSET2</code>: Like <code>QRK_LOCALSET</code>, but <em>only</em> if the variable by the
same name in the global/parent scope is unset. If the global variable is
set, then the local variable starts out unset. (bash 2 and 3)</li>
<li><code>QRK_LOCALUNS</code>: On a shell with <code>LOCALVARS</code>, local variables lose their local
status when unset. Since the variable name reverts to global, this means that
<em><code>unset</code> will not necessarily unset the variable!</em> (yash, pdksh/mksh. Note:
this is actually a behaviour of <code>typeset</code>, to which modernish aliases <code>local</code>
on these shells.)</li>
<li><code>QRK_LOCALUNS2</code>: This is a more treacherous version of <code>QRK_LOCALUNS</code> that
is unique to bash. The <code>unset</code> command works as expected when used on a local
variable in the same scope that variable was declared in, <strong>however</strong>, it
makes local variables global again if they are unset in a subscope of that
local scope, such as a function called by the function where it is local.
(Note: since <code>QRK_LOCALUNS2</code> is a special case of <code>QRK_LOCALUNS</code>, modernish
will not detect both.)
On bash &gt;= 5.0, modernish eliminates this quirk upon initialisation
by setting <code>shopt -s localvar_unset</code>.</li>
<li><code>QRK_OPTABBR</code>: Long-form shell option names can be abbreviated down to a
length where the abbreviation is not redundant with other long-form option
names. (ksh93, yash)</li>
<li><code>QRK_OPTCASE</code>: Long-form shell option names are case-insensitive. (yash, zsh)</li>
<li><code>QRK_OPTDASH</code>: Long-form shell option names ignore the <code>-</code>. (ksh93, yash)</li>
<li><code>QRK_OPTNOPRFX</code>: Long-form shell option names use a dynamic <code>no</code> prefix for
all options (including POSIX ones). For instance, <code>glob</code> is the opposite
of <code>noglob</code>, and <code>nonotify</code> is the opposite of <code>notify</code>. (ksh93, yash, zsh)</li>
<li><code>QRK_OPTULINE</code>: Long-form shell option names ignore the <code>_</code>. (yash, zsh)</li>
<li><code>QRK_PPIPEMAIN</code>: On zsh &lt;= 5.5.1, in all elements of a pipeline, parameter
expansions are evaluated in the current environment (with any changes they
make surviving the pipeline), though the commands themselves of every
element but the last are executed in a subshell. For instance, given unset
or empty <code>v</code>, in the pipeline <code>cmd1 ${v:=foo} | cmd2</code>, the assignment to
<code>v</code> survives, though <code>cmd1</code> itself is executed in a subshell.</li>
<li><code>QRK_SPCBIXP</code>: Variable assignments directly preceding
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_14" rel="nofollow">special builtin commands</a>
are exported, and persist as exported. (bash; yash)</li>
<li><code>QRK_UNSETF</code>: If &#39;unset&#39; is invoked without any option flag (-v or -f), and
no variable by the given name exists but a function does, the shell unsets
the function. (bash)</li>
</ul>

<p dir="auto">Modernish currently identifies and supports the following shell bugs:</p>
<ul dir="auto">
<li><code>BUG_ALIASCSHD</code>: A spurious syntax error occurs if a here-document
containing a command substitution is used within two aliases that define a
block. The syntax error reporting a missing <code>}</code> occurs because the alias
terminating the block is not correctly expanded. This bug affects
<a href="#user-content-use-varlocal"><code>var/local</code></a> and
<a href="#user-content-use-varloop"><code>var/loop</code></a>
as they define blocks this way. Workaround: make a shell function that
handles the here-document and call that shell function from the block/loop
instead. Bug found on: dash &lt;= 0.5.10.2; Busybox ash &lt;= 1.31.1.</li>
<li><code>BUG_ALIASPOSX</code>: Running any command &#34;foo&#34; in POSIX mode like
<code>POSIXLY_CORRECT=y foo</code> will globally disable alias expansion on a
non-interactive shell (killing modernish), unless POSIX mode is globally
enabled. Bug found on bash 4.2 through 5.0.
<strong>Note:</strong> on bash versions with this bug, modernish automatically enables
POSIX mode to avoid triggering it. A side effect is that process substitution
(<code>PROCSUBST</code>) isn&#39;t available.</li>
<li><code>BUG_ARITHINIT</code>: Using unset or empty variables (dash &lt;= 0.5.9.1 on macOS)
or unset variables (yash &lt;= 2.44) in arithmetic expressions causes the
shell to exit, instead of taking them as a value of zero.</li>
<li><code>BUG_ARITHLNNO</code>: The shell supports <code>$LINENO</code>, but the variable is
considered unset in arithmetic contexts, like <code>$(( LINENO &gt; 0 ))</code>.
This makes it error out under <code>set -u</code> and default to zero otherwise.
Workaround: use shell expansion like <code>$(( $LINENO &gt; 0 ))</code>. (FreeBSD sh)</li>
<li><code>BUG_ARITHNAN</code>: The case-insensitive special floating point constants
<code>Inf</code> and <code>NaN</code> are recognised in arithmetic evaluation, overriding any
variables with the names <code>Inf</code>, <code>NaN</code>, <code>INF</code>, <code>nan</code>, etc. (AT&amp;T ksh93;
zsh 5.6 - 5.8)</li>
<li><code>BUG_ARITHSPLT</code>: Unquoted <code>$((</code>arithmetic expressions<code>))</code> are not
subject to field splitting as expected. (zsh, mksh&lt;=R49)</li>
<li><code>BUG_ASGNCC01</code>: if <code>IFS</code> contains a <code>$CC01</code> (<code>^A</code>) character, unquoted expansions in
shell assignments discard that character (if present). Found on: bash 4.0-4.3</li>
<li><code>BUG_ASGNLOCAL</code>: If you have a function-local variable (see <code>LOCALVARS</code>)
with the same name as a global variable, and within the function you run a
shell builtin command preceded by a temporary variable assignment, then
the global variable is unset. (zsh &lt;= 5.7.1)</li>
<li><code>BUG_BRACQUOT</code>: shell quoting within bracket patterns has no effect (zsh &lt; 5.3;
ksh93) This bug means the <code>-</code> retains it special meaning of &#39;character
range&#39;, and an initial <code>!</code> (and, on some shells, <code>^</code>) retains the meaning of
negation, even in quoted strings within bracket patterns, including quoted
variables.</li>
<li><code>BUG_CASEEMPT</code>: An empty <code>case</code> list on a single line, as in <code>case x in esac</code>,
is a syntax error. (AT&amp;T ksh93)</li>
<li><code>BUG_CASELIT</code>: If a <code>case</code> pattern doesn&#39;t match as a pattern, it&#39;s tried
again as a literal string, even if the pattern isn&#39;t quoted. This can
result in false positives when a pattern doesn&#39;t match itself, like with
bracket patterns. This contravenes POSIX and breaks use cases such as
input validation. (AT&amp;T ksh93) Note: modernish <code>match</code> works around this.</li>
<li><code>BUG_CASEPAREN</code>: <code>case</code> patterns without an opening parenthesis
(i.e. with only an unbalanced closing parenthesis) are misparsed
as a syntax error within command substitutions of the form <code>$( )</code>.
Workaround: include the opening parenthesis. Found on: bash 3.2</li>
<li><code>BUG_CASESTAT</code>: The <code>case</code> conditional construct prematurely clobbers the
exit status <code>$?</code>. (found in zsh &lt; 5.3, Busybox ash &lt;= 1.25.0, dash &lt;
0.5.9.1)</li>
<li><code>BUG_CDNOLOGIC</code>: The <code>cd</code> built-in command lacks the POSIX-specified <code>-L</code>
option and does not support logical traversal; it always acts as if the <code>-P</code>
(physical traversal) option was passed. This also renders the <code>-L</code> option
to modernish <a href="#user-content-chdir"><code>chdir</code></a> ineffective. (NetBSD sh)</li>
<li><code>BUG_CDPCANON</code>: <code>cd -P</code> (and hence also modernish
<a href="#user-content-chdir"><code>chdir</code></a>) does not correctly canonicalise/normalise a
directory path that starts with three or more slashses; it reduces these to
two initial slashes instead of one in <code>$PWD</code>. (zsh &lt;= 5.7.1)</li>
<li><code>BUG_CMDEXEC</code>: using <code>command exec</code> (to open a file descriptor, using
<code>command</code> to avoid exiting the shell on failure) within a function causes
bash &lt;= 4.0 to fail to restore the global positional parameters when
leaving that function. It also renders bash &lt;=4.0 prone to hanging.</li>
<li><code>BUG_CMDEXPAN</code>: if the <code>command</code> command results from an expansion, it acts
like <code>command -v</code>, showing the path of the command instead of executing it.
For example: <code>v=command; &#34;$v&#34; ls</code> or <code>set -- command ls; &#34;$@&#34;</code> don&#39;t work.
(AT&amp;T ksh93)</li>
<li><code>BUG_CMDOPTEXP</code>: the <code>command</code> builtin does not recognise options if they
result from expansions. For instance, you cannot conditionally store <code>-p</code>
in a variable like <code>defaultpath</code> and then do <code>command $defaultpath someCommand</code>. (found in zsh &lt; 5.3)</li>
<li><code>BUG_CMDPV</code>: <code>command -pv</code> does not find builtins ({pd,m}ksh), does not
accept the -p and -v options together (zsh &lt; 5.3) or ignores the <code>-p</code>
option altogether (bash 3.2); in any case, it&#39;s not usable to find commands
in the default system PATH.</li>
<li><code>BUG_CMDSETPP</code>: using <code>command set --</code> has no effect; it does not set the
positional parameters. For compat, use <code>set</code> without <code>command</code>. (mksh &lt;= R57)</li>
<li><code>BUG_CMDSPASGN</code>: preceding a
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_14" rel="nofollow">special builtin</a>
with <code>command</code> does not stop preceding invocation-local variable
assignments from becoming global. (AT&amp;T ksh93)</li>
<li><code>BUG_CMDSPEXIT</code>: preceding a
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_14" rel="nofollow">special builtin</a>
(other than <code>eval</code>, <code>exec</code>, <code>return</code> or <code>exit</code>)
with <code>command</code> does not always stop
it from exiting the shell if the builtin encounters error.
(bash &lt;= 4.0; zsh &lt;= 5.2; mksh; ksh93)</li>
<li><code>BUG_CSNHDBKSL</code>: Backslashes within non-expanding here-documents within
command substitutions are incorrectly expanded to perform newline joining,
as opposed to left intact. (bash &lt;= 4.4)</li>
<li><code>BUG_CSUBBTQUOT</code>: A spurious syntax erorr is thrown when using double
quotes within a backtick-style command substitution that is itself within
double quotes. (AT&amp;T ksh93 &lt; 93u+m 2022-05-20)</li>
<li><code>BUG_CSUBLNCONT</code>: Backslash line continuation is not processed correctly
within modern-form <code>$(</code>command substitutions<code>)</code>.
(AT&amp;T ksh93 &lt; 93u+m 2022-05-21)</li>
<li><code>BUG_CSUBRMLF</code>: A bug affecting the stripping of final linefeeds from
command substitutions. If a command substitution does not produce any
output to substitute <strong>and</strong> is concatenated in a string or here-document,
then the shell removes any concurrent linefeeds occurring directly before
the command substitution in that string or here-document.
(dash &lt;= 0.5.10.2, Busybox ash, FreeBSD sh)</li>
<li><code>BUG_CSUBSTDO</code>: If standard output (file descriptor 1) is closed before
entering a command substitution, and any other file descriptors are
redirected within the command substitution, commands such as <code>echo</code> or
<code>putln</code> will not work within the command substitution, acting as if standard
output is still closed (AT&amp;T ksh93 &lt;= AJM 93u+ 2012-08-01). Workaround: see
<a href="https://github.com/modernish/modernish/blob/master/lib/modernish/cap/BUG_CSUBSTDO.t"><code>cap/BUG_CSUBSTDO.t</code></a>.</li>
<li><code>BUG_DEVTTY</code>: the shell can&#39;t redirect output to <code>/dev/tty</code> if
<code>set -C</code>/<code>set -o noclobber</code> (part of <a href="#user-content-use-safe">safe mode</a>)
is active. Workaround: use <code>&gt;| /dev/tty</code> instead of <code>&gt; /dev/tty</code>.
Bug found on: bash on certain systems (at least QNX and Interix).</li>
<li><code>BUG_DOLRCSUB</code>: parsing problem where, inside a command substitution of
the form <code>$(...)</code>, the sequence <code>$$&#39;...&#39;</code> is treated as <code>$&#39;...&#39;</code> (i.e. as
a use of CESCQUOT), and <code>$$&#34;...&#34;</code> as <code>$&#34;...&#34;</code> (bash-specific translatable
string). (Found in bash up to 4.4)</li>
<li><code>BUG_DQGLOB</code>: <em>glob</em>bing is not properly deactivated within
<em>d</em>ouble-<em>q</em>uoted strings. Within double quotes, a <code>*</code> or <code>?</code> immediately
following a backslash is interpreted as a globbing character. This applies
to both pathname expansion and pattern matching in <code>case</code>. Found in: dash.
(The bug is not triggered when using modernish
<a href="#user-content-string-tests"><code>match</code></a>.)</li>
<li><code>BUG_EXPORTUNS</code>: Setting the export flag on an otherwise unset variable
causes a set and empty environment variable to be exported, though the
variable continues to be considered unset within the current shell.
(FreeBSD sh &lt; 13.0)</li>
<li><code>BUG_FNSUBSH</code>: Function definitions within subshells (including command
substitutions) are ignored if a function by the same name exists in the
main shell, so the wrong function is executed. <code>unset -f</code> is also silently
ignored. ksh93 (all current versions as of November 2018) has this bug.
It only applies to non-forked subshells. See <code>NONFORKSUBSH</code>.</li>
<li><code>BUG_FORLOCAL</code>: a <code>for</code> loop in a function makes the iteration variable
local to the function, so it won&#39;t survive the execution of the function.
Found on: yash. This is intentional and documented behaviour on yash in
non-POSIX mode, but in POSIX terms it&#39;s a bug, so we mark it as such.</li>
<li><code>BUG_GETOPTSMA</code>: The <code>getopts</code> builtin leaves a <code>:</code> instead of a <code>?</code> in
the specified option variable if a given option that requires an argument
lacks an argument, and the option string does not start with a <code>:</code>. (zsh)</li>
<li><code>BUG_HDOCBKSL</code>: Line continuation using <em>b</em>ac<em>ksl</em>ashes in expanding
<em>h</em>ere-<em>doc</em>uments is handled incorrectly. (zsh up to 5.4.2)</li>
<li><code>BUG_HDOCMASK</code>: Here-documents (and here-strings, see <code>HERESTRING</code>) use
temporary files. This fails if the current <code>umask</code> setting disallows the
user to read, so the here-document can&#39;t read from the shell&#39;s temporary
file. Workaround: ensure user-readable <code>umask</code> when using here-documents.
(bash, mksh, zsh)</li>
<li><code>BUG_IFSCC01PP</code>: If <code>IFS</code> contains a <code>$CC01</code> (<code>^A</code>) control character, the
expansion <code>&#34;$@&#34;</code> (even quoted) is gravely corrupted. <em>Since many modernish
functions use this to loop through the positional parameters, this breaks
the library.</em> (Found in bash &lt; 4.4)</li>
<li><code>BUG_IFSGLOBC</code>: In glob pattern matching (such as in <code>case</code> and <code>[[</code>), if a
wildcard character is part of <code>IFS</code>, it is matched literally instead of as a
matching character. This applies to glob characters <code>*</code>, <code>?</code>, <code>[</code> and <code>]</code>.
<em>Since nearly all modernish functions use <code>case</code> for argument validation and
other purposes, nearly every modernish function breaks on shells with this
bug if <code>IFS</code> contains any of these three characters!</em>
(Found in bash &lt; 4.4)</li>
<li><code>BUG_IFSGLOBP</code>: In pathname expansion (filename globbing), if a
wildcard character is part of <code>IFS</code>, it is matched literally instead of as a
matching character. This applies to glob characters <code>*</code>, <code>?</code>, <code>[</code> and <code>]</code>.
(Bug found in bash, all versions up to at least 4.4)</li>
<li><code>BUG_IFSGLOBS</code>: in glob pattern matching (as in <code>case</code> or parameter
substitution with <code>#</code> and <code>%</code>), if <code>IFS</code> starts with <code>?</code> or <code>*</code> and the
<code>&#34;$*&#34;</code> parameter expansion inserts any <code>IFS</code> separator characters, those
characters are erroneously interpreted as wildcards when quoted &#34;$*&#34; is
used as the glob pattern. (AT&amp;T ksh93)</li>
<li><code>BUG_IFSISSET</code>: AT&amp;T ksh93 (2011/2012 versions): <code>${IFS+s}</code> always yields <code>s</code>
even if <code>IFS</code> is unset. This applies to <code>IFS</code> only.</li>
<li><code>BUG_ISSETLOOP</code>: AT&amp;T ksh93: Expansions like <code>${var+set}</code>
remain static when used within a <code>for</code>, <code>while</code> or
<code>until</code> loop; the expansions don&#39;t change along with the state of the
variable, so they cannot be used to check whether a variable is set
within a loop if the state of that variable may change
in the course of the loop.</li>
<li><code>BUG_KBGPID</code>: AT&amp;T ksh93: If a single command ending in <code>&amp;</code> (i.e. a background
job) is enclosed in a <code>{</code> braces<code>; }</code> block with an I/O redirection, the <code>$!</code>
special parameter is not set to the background job&#39;s PID.</li>
<li><code>BUG_KUNSETIFS</code>: AT&amp;T ksh93: Unsetting <code>IFS</code> fails to activate default field
splitting if the following conditions are met: 1. <code>IFS</code> is set and empty
(i.e. split is disabled) in the main shell, and at least one expansion has
been processed with that setting; 2. The code is currently executing in a
non-forked subshell (see <a href="#user-content-capabilities"><code>NONFORKSUBSH</code></a>).</li>
<li><code>BUG_LNNONEG</code>: <code>$LINENO</code> becomes wildly inaccurate, even negative, when
dotting/sourcing scripts. Bug found on: dash with LINENO support compiled in.</li>
<li><code>BUG_LOOPRET1</code>: If a <code>return</code> command is given with a status argument within
the set of conditional commands in a <code>while</code> or <code>until</code> loop (i.e., between
<code>while</code>/<code>until</code> and <code>do</code>), the status argument is ignored and the function
returns with status 0 instead of the specified status.
Found on: dash &lt;= 0.5.8; zsh &lt;= 5.2</li>
<li><code>BUG_LOOPRET2</code>: If a <code>return</code> command is given without a status argument
within the set of conditional commands in a <code>while</code> or <code>until</code> loop (i.e.,
between <code>while</code>/<code>until</code> and <code>do</code>), the exit status passed down from the
previous command is ignored and the function returns with status 0 instead.
Found on: dash &lt;= 0.5.10.2; AT&amp;T ksh93; zsh &lt;= 5.2</li>
<li><code>BUG_LOOPRET3</code>: If a <code>return</code> command is given within the set of conditional
commands in a <code>while</code> or <code>until</code> loop (i.e., between <code>while</code>/<code>until</code> and
<code>do</code>), <em>and</em> the return status (either the status argument to <code>return</code> or the
exit status passed down from the previous command by <code>return</code> without a
status argument) is non-zero, <em>and</em> the conditional command list itself yields
false (for <code>while</code>) or true (for <code>until</code>), <em>and</em> the whole construct is
executed in a dot script sourced from another script, then too many levels of
loop are broken out of, causing <strong>program flow corruption</strong> or premature exit.
Found on: zsh &lt;= 5.7.1</li>
<li><code>BUG_MULTIBIFS</code>: We&#39;re on a UTF-8 locale and the shell supports UTF-8
characters in general (i.e. we don&#39;t have <code>WRN_MULTIBYTE</code>) – however, using
multi-byte characters as <code>IFS</code> field delimiters still doesn&#39;t work. For
example, <code>&#34;$*&#34;</code> joins positional parameters on the first byte of <code>IFS</code>
instead of the first character. (ksh93, mksh, FreeBSD sh, Busybox ash)</li>
<li><code>BUG_NOCHCLASS</code>: POSIX-mandated character <code>[:</code>classes<code>:]</code> within bracket
<code>[</code>expressions<code>]</code> are not supported in glob patterns. (mksh)</li>
<li><code>BUG_NOEXPRO</code>: Cannot export read-only variables. (zsh &lt;= 5.7.1 in sh mode)</li>
<li><code>BUG_OPTNOLOG</code>: on dash, setting <code>-o nolog</code> causes <code>$-</code> to wreak havoc:
trying to expand <code>$-</code> silently aborts parsing of an entire argument,
so e.g. <code>&#34;one,$-,two&#34;</code> yields <code>&#34;one,&#34;</code>. (Same applies to <code>-o debug</code>.)</li>
<li><code>BUG_PP_01</code>: <a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_05_02" rel="nofollow">POSIX says</a>
that empty <code>&#34;$@&#34;</code> generates zero fields but empty <code>&#39;&#39;</code> or <code>&#34;&#34;</code> or
<code>&#34;$emptyvariable&#34;</code> generates one empty field. This means concatenating
<code>&#34;$@&#34;</code> with one or more other, separately quoted, empty strings (like
<code>&#34;$@&#34;&#34;$emptyvariable&#34;</code>) should still produce one empty field. But on
bash 3.x, this erroneously produces zero fields. (See also QRK_EMPTPPWRD)</li>
<li><code>BUG_PP_02</code>: Like <code>BUG_PP_01</code>, but with unquoted <code>$@</code> and only
with <code>&#34;$emptyvariable&#34;$@</code>, not <code>$@&#34;$emptyvariable&#34;</code>.
(mksh &lt;= R50f; FreeBSD sh &lt;= 10.3)</li>
<li><code>BUG_PP_03</code>: When <code>IFS</code> is unset or empty (zsh 5.3.x) or empty (mksh &lt;= R50),
assigning <code>var=$*</code> only assigns the first field, failing to join and
discarding the rest of the fields. Workaround: <code>var=&#34;$*&#34;</code>
(POSIX leaves <code>var=$@</code>, etc. undefined, so we don&#39;t test for those.)</li>
<li><code>BUG_PP_03A</code>: When <code>IFS</code> is unset, assignments like <code>var=$*</code>
incorrectly remove leading and trailing spaces (but not tabs or
newlines) from the result. Workaround: quote the expansion. Found on:
bash 4.3 and 4.4.</li>
<li><code>BUG_PP_03B</code>: When <code>IFS</code> is unset, assignments like <code>var=${var+$*}</code>,
etc. incorrectly remove leading and trailing spaces (but not tabs or
newlines) from the result. Workaround: quote the expansion. Found on:
bash 4.3 and 4.4.</li>
<li><code>BUG_PP_03C</code>: When <code>IFS</code> is unset, assigning <code>var=${var-$*}</code> only assigns
the first field, failing to join and discarding the rest of the fields.
(zsh 5.3, 5.3.1) Workaround: <code>var=${var-&#34;$*&#34;}</code></li>
<li><code>BUG_PP_04A</code>: Like BUG_PP_03A, but for conditional assignments within
parameter substitutions, as in <code>: ${var=$*}</code> or <code>: ${var:=$*}</code>.
Workaround: quote either <code>$*</code> within the expansion or the expansion
itself. (bash &lt;= 4.4)</li>
<li><code>BUG_PP_04E</code>: When assigning the positional parameters ($*) to a variable
using a conditional assignment within a parameter substitution, e.g.
<code>: ${var:=$*}</code>, the fields are always joined and separated by spaces,
except if <code>IFS</code> is set and empty. Workaround as in BUG_PP_04A.
(bash 4.3)</li>
<li><code>BUG_PP_04_S</code>: When <code>IFS</code> is null (empty), the result of a substitution
like <code>${var=$*}</code> is incorrectly field-split on spaces.
The assignment itself succeeds normally.
Found on: bash 4.2, 4.3</li>
<li><code>BUG_PP_05</code>: <a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_05_02" rel="nofollow">POSIX says</a>
that empty <code>$@</code> and <code>$*</code> generate zero fields, but with null <code>IFS</code>, empty
unquoted <code>$@</code> and <code>$*</code> yield one empty field. Found on: dash 0.5.9
and 0.5.9.1; Busybox ash.</li>
<li><code>BUG_PP_06A</code>: <a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_05_02" rel="nofollow">POSIX says</a>
that unquoted <code>$@</code> and <code>$*</code> initially generate as many fields as there are
positional parameters, and then (because <code>$@</code> or <code>$*</code> is unquoted) each field is
split further according to <code>IFS</code>. With this bug, the latter step is not
done if <code>IFS</code> is unset (i.e. default split). Found on: zsh &lt; 5.4</li>
<li><code>BUG_PP_07</code>: unquoted <code>$*</code> and <code>$@</code> (including in substitutions like
<code>${1+$@}</code> or <code>${var-$*}</code>) do not perform default field splitting if
<code>IFS</code> is unset. Found on: zsh (up to 5.3.1) in sh mode</li>
<li><code>BUG_PP_07A</code>: When <code>IFS</code> is unset, unquoted <code>$*</code> undergoes word splitting
as if <code>IFS=&#39; &#39;</code>, and not the expected <code>IFS=&#34; ${CCt}${CCn}&#34;</code>.
Found on: bash 4.4</li>
<li><code>BUG_PP_08</code>: When <code>IFS</code> is empty, unquoted <code>$@</code> and <code>$*</code> do not generate
one field for each positional parameter as expected, but instead join
them into a single field without a separator. Found on: yash &lt; 2.44
and dash &lt; 0.5.9 and Busybox ash &lt; 1.27.0</li>
<li><code>BUG_PP_08B</code>: When <code>IFS</code> is empty, unquoted <code>$*</code> within a substitution (e.g.
<code>${1+$*}</code> or <code>${var-$*}</code>) does not generate one field for each positional
parameter as expected, but instead joins them into a single field without
a separator. Found on: bash 3 and 4</li>
<li><code>BUG_PP_09</code>: When <code>IFS</code> is non-empty but does not contain a space,
unquoted <code>$*</code> within a substitution (e.g. <code>${1+$*}</code> or <code>${var-$*}</code>) does
not generate one field for each positional parameter as expected,
but instead joins them into a single field separated by spaces
(even though, as said, <code>IFS</code> does not contain a space).
Found on: bash 4.3</li>
<li><code>BUG_PP_10</code>: When <code>IFS</code> is null (empty), assigning <code>var=$*</code> removes any
<code>$CC01</code> (^A) and <code>$CC7F</code> (DEL) characters. (bash 3, 4)</li>
<li><code>BUG_PP_10A</code>: When <code>IFS</code> is non-empty, assigning <code>var=$*</code> prefixes each
<code>$CC01</code> (^A) and <code>$CC7F</code> (DEL) character with a <code>$CC01</code> character. (bash 4.4)</li>
<li><code>BUG_PP_1ARG</code>: When <code>IFS</code> is empty on bash &lt;= 4.3 (i.e. field
splitting is off), <code>${1+&#34;$@&#34;}</code> or <code>&#34;${1+$@}&#34;</code> is counted as a single
argument instead of each positional parameter as separate arguments.
This also applies to prepending text only if there are positional
parameters with something like <code>&#34;${1+foobar $@}&#34;</code>.</li>
<li><code>BUG_PP_MDIGIT</code>: Multiple-digit positional parameters don&#39;t require expansion
braces, so e.g. <code>$10</code> = <code>${10}</code> (dash; Busybox ash). This is classed as a bug
because it causes a straight-up incompatibility with POSIX scripts. POSIX
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_06_02" rel="nofollow">says</a>:
&#34;The parameter name or symbol can be enclosed in braces, which are
optional except for positional parameters with more than one digit [...]&#34;.</li>
<li><code>BUG_PP_MDLEN</code>: For <code>${#x}</code> expansions where x &gt;= 10, only the first digit of
the positional parameter number is considered, e.g. <code>${#10}</code>, <code>${#12}</code>,
<code>${#123}</code> are all parsed as if they are <code>${#1}</code>. Then, string parsing is
aborted so that further characters or expansions, if any, are lost.
Bug found in: dash 0.5.11 - 0.5.11.4 (fixed in dash 0.5.11.5)</li>
<li><code>BUG_PSUBASNCC</code>: in an assignment parameter substitution of the form
<code>${foo=value}</code>, if the characters <code>$CC01</code> (^A) or <code>$CC7F</code> (DEL) are in the
value, all their occurrences are stripped from the expansion (although the
assignment itself is done correctly). If the expansion is quoted, only
<code>$CC01</code> is stripped. This bug is independent of the state of <code>IFS</code>, except if
<code>IFS</code> is null, the assignment in <code>${foo=$*}</code> (unquoted) is buggy too: it
strips <code>$CC01</code> from the assigned value. (Found on bash 4.2, 4.3, 4.4)</li>
<li><code>BUG_PSUBBKSL1</code>: A backslash-escaped <code>}</code> character within a quoted parameter
substitution is not unescaped. (bash 3.2, dash &lt;= 0.5.9.1, Busybox 1.27 ash)</li>
<li><code>BUG_PSUBEMIFS</code>: if <code>IFS</code> is empty (no split, as in safe mode), then if a
parameter substitution of the forms <code>${foo-$*}</code>, <code>${foo+$*}</code>, <code>${foo:-$*}</code> or
<code>${foo:+$*}</code> occurs in a command argument, the characters <code>$CC01</code> (^A) or
<code>$CC7F</code> (DEL) are stripped from the expanded argument. (Found on: bash 4.4)</li>
<li><code>BUG_PSUBEMPT</code>: Expansions of the form <code>${V-}</code> and <code>${V:-}</code> are not
subject to normal shell empty removal if that parameter is unset, causing
unexpected empty arguments to commands. Workaround: <code>${V+$V}</code> and
<code>${V:+$V}</code> work as expected. (Found on FreeBSD 10.3 sh)</li>
<li><code>BUG_PSUBIFSNW</code>: When field-splitting unquoted parameter substitutions like
<code>${var#foo}</code>, <code>${var##foo}</code>, <code>${var%foo}</code> or <code>${var%%foo}</code> on non-whitespace
<code>IFS</code>, if there is an initial empty field, a spurious extra initial empty
field is generated. (mksh)</li>
<li><code>BUG_PSUBNEWLN</code>: Due to a bug in the parser, parameter substitutions
spread over more than one line cause a syntax error.
Workaround: instead of a literal newline, use <a href="#user-content-control-character-whitespace-and-shell-safe-character-constants"><code>$CCn</code></a>.
(found in dash &lt;= 0.5.9.1 and Busybox ash &lt;= 1.28.1)</li>
<li><code>BUG_PSUBSQUOT</code>: in pattern matching parameter substitutions
(<code>${param#pattern}</code>, <code>${param%pattern}</code>, <code>${param##pattern}</code> and
<code>${param%%pattern}</code>), if the whole parameter substitution is quoted with
double quotes, then single quotes in the <em>pattern</em> are not parsed. POSIX
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_06_02" rel="nofollow">says</a>
they are to keep their special meaning, so that glob characters may
be quoted. For example: <code>x=foobar; echo &#34;${x#&#39;foo&#39;}&#34;</code> should yield <code>bar</code>
but with this bug yields <code>foobar</code>. (dash &lt;= 0.5.9.1; Busybox 1.27 ash)</li>
<li><code>BUG_PSUBSQHD</code>: Like BUG_PSUBSQUOT, but included a here-document instead of
quoted with double quotes. (dash &lt;= 0.5.9.1; mksh)</li>
<li><code>BUG_PUTIOERR</code>: Shell builtins that output strings (<code>echo</code>, <code>printf</code>, ksh/zsh
<code>print</code>), and thus also modernish <code>put</code> and <code>putln</code>, do not check for I/O
errors on output. This means a script cannot check for them, and a script
process in a pipe can get stuck in an infinite loop if <code>SIGPIPE</code> is ignored.</li>
<li><code>BUG_READWHSP</code>: If there is more than one field to read, <code>read</code> does not
trim trailing <code>IFS</code> whitespace. (dash 0.5.7, 0.5.8)</li>
<li><code>BUG_REDIRIO</code>: the I/O redirection operator <code>&lt;&gt;</code> (open a file descriptor
for both read and write) defaults to opening standard output (i.e. is
short for <code>1&lt;&gt;</code>) instead of defaulting to opening standard input (<code>0&lt;&gt;</code>) as
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_07_07" rel="nofollow">POSIX specifies</a>.
(AT&amp;T ksh93)</li>
<li><code>BUG_REDIRPOS</code>: Buggy behaviour occurs if a <em>redir</em>ection is <em>pos</em>itioned
in between to variable assignments in the same command. On zsh 5.0.x, a
parse error is thrown. On zsh 5.1 to 5.4.2, anything following the
redirection (other assignments or command arguments) is silently ignored.</li>
<li><code>BUG_SCLOSEDFD</code>: bash &lt; 5.0 and dash fail to establish a block-local scope
for a file descriptor that is added to the end of the block as a redirection
that closes that file descriptor (e.g. <code>} 8&lt;&amp;-</code> or <code>done 7&gt;&amp;-</code>). If that FD
is already closed outside the block, the FD remains global, so you can&#39;t
locally <code>exec</code> it. So with this bug, it is not straightforward to make a
block-local FD appear initially closed within a block. Workaround: first open
the FD, then close it – for example: <code>done 7&gt;/dev/null 7&gt;&amp;-</code> will establish
a local scope for FD 7 for the preceding <code>do</code>...<code>done</code> block while still
making FD 7 appear initially closed within the block.</li>
<li><code>BUG_SETOUTVAR</code>: The <code>set</code> builtin (with no arguments) only prints native
function-local variables when called from a shell function. (yash &lt;= 2.46)</li>
<li><code>BUG_SHIFTERR0</code>: The <code>shift</code> builtin silently returns a successful exit
status (0) when attempting to shift a number greater than the current
amount of positional parameters. (Busybox ash &lt;= 1.28.4)</li>
<li><code>BUG_SPCBILOC</code>: Variable assignments preceding
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_14" rel="nofollow">special builtins</a>
create a partially function-local variable if a variable by the same name
already exists in the global scope. (bash &lt; 5.0 in POSIX mode)</li>
<li><code>BUG_TESTERR1A</code>: <code>test</code>/<code>[</code> exits with a non-error <code>false</code> status
(1) if an invalid argument is given to an operator. (AT&amp;T ksh93)</li>
<li><code>BUG_TESTILNUM</code>: On dash (up to 0.5.8), giving an illegal number to <code>test -t</code>
or <code>[ -t</code> causes some kind of corruption so the next <code>test</code>/<code>[</code> invocation
fails with an &#34;unexpected operator&#34; error even if it&#39;s legit.</li>
<li><code>BUG_TESTONEG</code>: The <code>test</code>/<code>[</code> builtin supports a <code>-o</code> unary operator to
check if a shell option is set, but it ignores the <code>no</code> prefix on shell
option names, so something like <code>[ -o noclobber ]</code> gives a false positive.
Bug found on yash up to 2.43. (The <code>TESTO</code> feature test implicitly checks
against this bug and won&#39;t detect the feature if the bug is found.)</li>
<li><code>BUG_TRAPEMPT</code>: The <code>trap</code> builtin does not quote empty traps in its
output, rendering the output unsuitable for shell re-input. For instance,
<code>trap &#39;&#39; INT; trap</code> outputs &#34;<code>trap --  INT</code>&#34; instead of &#34;<code>trap -- &#39;&#39; INT</code>&#34;.
(found in mksh &lt;= R56c)</li>
<li><code>BUG_TRAPEXIT</code>: the shell&#39;s <code>trap</code> builtin does not know the EXIT trap by
name, but only by number (0). Using the name throws a &#34;bad trap&#34; error. Found in
<a href="https://git.kernel.org/pub/scm/libs/klibc/klibc.git/tree/usr/dash" rel="nofollow">klibc 2.0.4 dash</a>.</li>
<li><code>BUG_TRAPFNEXI</code>: When a function issues a signal whose trap exits the
shell, the shell is not exited immediately, but only on return from the
function. (zsh)</li>
<li><code>BUG_TRAPRETIR</code>: Using <code>return</code> within <code>eval</code> triggers infinite recursion if
both a RETURN trap and the <code>functrace</code> shell option are active. This bug in
bash-only functionality triggers a crash when using modernish, so to avoid
this, modernish automatically disables the <code>functrace</code> shell option if a
<code>RETURN</code> trap is set or pushed and this bug is detected. (bash 4.3, 4.4)</li>
<li><code>BUG_TRAPSUB0</code>: Subshells in traps fail to pass down a nonzero exit status of
the last command they execute, under certain conditions or consistently,
depending on the shell. (bash &lt;= 4.0; dash 0.5.9 - 0.5.10.2; yash &lt;= 2.47)</li>
<li><code>BUG_TRAPUNSRE</code>: When a trap <em>uns</em>ets itself and then <em>re</em>sends its own signal,
the execution of the trap action (including functions called by it) is
not interrupted by the now-untrapped signal; instead, the process
terminates after completing the entire trap routine. (bash &lt;= 4.2; zsh)</li>
<li><code>BUG_UNSETUNXP</code>: If an unset variable is given the export flag using the
<code>export</code> command, a subsequent <code>unset</code> command does not remove that export
flag again. Workaround: assign to the variable first, then unset it to
unexport it. (Found on AT&amp;T ksh JM-93u-2011-02-08; Busybox 1.27.0 ash)</li>
<li><code>BUG_VARPREFIX</code>: On a shell with the <code>VARPREFIX</code> feature, expansions of type
<code>${!</code><em>prefix</em><code>@}</code> and <code>${!</code><em>prefix</em><code>*}</code> do not find the variable name
<em>prefix</em> itself. (AT&amp;T ksh93)</li>
<li><code>BUG_ZSHNAMES</code>: A series of lowerase names, normally okay for script use
as per POSIX convention, is reserved for special use. Unsetting these
names is impossible in most cases, and changing them may corrupt important
shell or system settings. This may conflict with
<a href="#user-content-simple-form">simple-form</a> modernish scripts.
This bug is detected on zsh when it was not initially invoked in emulation
mode, and emulation mode was enabled using <code>emulate sh</code> post invocation
instead (which does not disable these conflicting parameters).
As of zsh 5.6, the list of variable names affected is: <code>aliases</code> <code>argv</code>
<code>builtins</code> <code>cdpath</code> <code>commands</code> <code>dirstack</code> <code>dis_aliases</code> <code>dis_builtins</code>
<code>dis_functions</code> <code>dis_functions_source</code> <code>dis_galiases</code> <code>dis_patchars</code>
<code>dis_reswords</code> <code>dis_saliases</code> <code>fignore</code> <code>fpath</code> <code>funcfiletrace</code>
<code>funcsourcetrace</code> <code>funcstack</code> <code>functions</code> <code>functions_source</code> <code>functrace</code>
<code>galiases</code> <code>histchars</code> <code>history</code> <code>historywords</code> <code>jobdirs</code> <code>jobstates</code>
<code>jobtexts</code> <code>keymaps</code> <code>mailpath</code> <code>manpath</code> <code>module_path</code> <code>modules</code> <code>nameddirs</code>
<code>options</code> <code>parameters</code> <code>patchars</code> <code>path</code> <code>pipestatus</code> <code>prompt</code> <code>psvar</code>
<code>reswords</code> <code>saliases</code> <code>signals</code> <code>status</code> <code>termcap</code> <code>terminfo</code> <code>userdirs</code>
<code>usergroups</code> <code>watch</code> <code>widgets</code> <code>zsh_eval_context</code> <code>zsh_scheduled_events</code></li>
<li><code>BUG_ZSHNAMES2</code>: Two lowercase variable names <code>histchars</code> and <code>signals</code>,
normally okay for script use as per POSIX convention, are reserved for
special use on zsh, <em>even</em> if zsh is initialised in sh mode (via a <code>sh</code>
symlink or using the <code>--emulate sh</code> option at startup).
Bug found on: zsh &lt;= 5.7.1. The bug is only detected if <code>BUG_ZSHNAMES</code> is
not detected, because this bug&#39;s effects are included in that one&#39;s.</li>
</ul>

<p dir="auto">Warning IDs do not identify any characteristic of the shell, but instead
warn about a potentially problematic system condition that was detected at
initialisation time.</p>
<ul dir="auto">
<li><code>WRN_EREMBYTE</code>: The current system locale setting supports Unicode UTF-8
multi-byte/variable-length characters, but the utility used by
<a href="#user-content-string-tests"><code>str ematch</code></a>
to match extended regular expressions (EREs) does not support them
and treats all characters as single bytes. This means multi-byte characters
will be matched as multiple characters, and character <code>[:</code>classes<code>:]</code>
within bracket expressions will only match ASCII characters.</li>
<li><code>WRN_MULTIBYTE</code>: The current system locale setting supports Unicode UTF-8
multi-byte/variable-length characters, but the current shell does not
support them and treats all characters as single bytes. This means
counting or processing multi-byte characters with the current shell will
produce incorrect results. Scripts that need compatibility with this
system condition should check <code>if thisshellhas WRN_MULTIBYTE</code> and resort
to a workaround that uses external utilities where necessary.</li>
<li><code>WRN_NOSIGPIPE</code>: Modernish has detected that the process that launched
the current program has set <code>SIGPIPE</code> to ignore, an irreversible condition
that is in turn inherited by any process started by the current shell, and
their subprocesses, and so on. The system constant
<a href="#user-content-modernish-system-constants"><code>$SIGPIPESTATUS</code></a>
is set to the special value 99999 and neither the current shell nor any
process it spawns is now capable of receiving <code>SIGPIPE</code>. The
<a href="#hardening-while-allowing-for-broken-pipes"><code>-P</code> option to <code>harden</code></a>
is also rendered ineffective.
Depending on how a given command <code>foo</code> is implemented, it is now possible
that a pipeline such as <code>foo | head -n 10</code> never ends; if <code>foo</code> doesn&#39;t
check for I/O errors, the only way it would ever stop trying to write
lines is by receiving <code>SIGPIPE</code> as <code>head</code> terminates.
Programs that use commands in this fashion should check <code>if thisshellhas WRN_NOSIGPIPE</code> and either employ workarounds or refuse to run if so.</li>
</ul>
<div dir="auto"><h2 tabindex="-1" dir="auto">Appendix B: Regression test suite</h2><a id="user-content-appendix-b-regression-test-suite" aria-label="Permalink: Appendix B: Regression test suite" href="#appendix-b-regression-test-suite"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Modernish comes with a suite of regression tests to detect bugs in modernish
itself, which can be run using <code>modernish --test</code> after installation. By
default, it will run all the tests verbosely but without tracing the command
execution. The <code>install.sh</code> installer will run <code>modernish --test -eqq</code> on the
selected shell before installation.</p>
<p dir="auto">A few options are available to specify after <code>--test</code>:</p>
<ul dir="auto">
<li><code>-h</code>: show help.</li>
<li><code>-e</code>: disable or reduce expensive (i.e. slow or memory-hogging) tests.</li>
<li><code>-q</code>: quieter operation; report expected fails [known shell bugs]
and unexpected fails [bugs in modernish]). Add <code>-q</code> again for
quietest operation (report unexpected fails only).</li>
<li><code>-s</code>: entirely silent operation.</li>
<li><code>-t</code>: run only specific test sets or tests. Test sets are those listed
in the full default output of <code>modernish --test</code>. This option requires
an option-argument in the following format:</li>
<li><code>-x</code>: trace each test using the shell&#39;s <code>xtrace</code> facility. Each trace is
stored in a separate file in a specially created temporary directory. By
default, the trace is deleted if a test does not produce an unexpected
fail. Add <code>-x</code> again to keep expected fails as well, and again to
keep all traces regardless of result. If any traces were saved,
modernish will tell you the location of the temporary directory at the
end, otherwise it will silently remove the directory again.</li>
<li><code>-E</code>: don&#39;t run any tests, but output a command to open the tests that would
have been run in your editor. The editor from the <code>VISUAL</code> or <code>EDITOR</code>
environment variable is used, with <code>vi</code> as a default. This option should be
used together with <code>-t</code> to specify tests. All other options are ignored.</li>
<li><code>-F</code>: takes an argument with the name or path to a <code>find</code> utility to
prefer when testing <a href="#user-content-the-find-loop"><code>LOOP find</code></a>.
<a href="#user-content-picking-a-find-utility">More info here</a>.</li>
</ul>
<p dir="auto">These short options can be combined so, for example,
<code>--test -qxx</code> is the same as <code>--test -q -x -x</code>.</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Difference between capability detection and regression tests</h3><a id="user-content-difference-between-capability-detection-and-regression-tests" aria-label="Permalink: Difference between capability detection and regression tests" href="#difference-between-capability-detection-and-regression-tests"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Note the difference between these regression tests and the cap tests listed in
<a href="#user-content-appendix-a-list-of-shell-cap-ids">Appendix A</a>. The latter are
tests for whatever shell is executing modernish: they detect capabilities
(features, quirks, bugs) of the current shell. They are meant to be run via
<a href="#user-content-shell-capability-detection"><code>thisshellhas</code></a> and are designed to
be taken advantage of in scripts. On the other hand, these tests run by
<code>modernish --test</code> are regression tests for modernish itself. It does not
make sense to use these in a script.</p>
<p dir="auto">New/unknown shell bugs can still cause modernish regression tests to fail,
of course. That&#39;s why some of the regression tests also check for
consistency with the results of the capability detection tests: if there is a
shell bug in a widespread release version that modernish doesn&#39;t know about
yet, this in turn is considered to be a bug in modernish, because one of its
goals is to know about all the shell bugs in all released shell versions
currently seeing significant use.</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Testing modernish on all your shells</h3><a id="user-content-testing-modernish-on-all-your-shells" aria-label="Permalink: Testing modernish on all your shells" href="#testing-modernish-on-all-your-shells"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The <code>testshells.sh</code> program in <code>share/doc/modernish/examples</code> can be used to
run the regression test suite on all the shells installed on your system.
You could put it as <code>testshells</code> in some convenient location in your
<code>$PATH</code>, and then simply run:</p>
<div data-snippet-clipboard-copy-content="testshells modernish --test"><pre><code>testshells modernish --test
</code></pre></div>
<p dir="auto">(adding any further options you like – for instance, you might like to add
<code>-q</code> to avoid very long terminal output). On first run, <code>testshells</code> will
generate a list of shells it can find on your system and it will give you a
chance to edit it before proceeding.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Appendix C: Supported locales</h2><a id="user-content-appendix-c-supported-locales" aria-label="Permalink: Appendix C: Supported locales" href="#appendix-c-supported-locales"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">modernish, like most shells, fully supports two system locales: POSIX
(a.k.a. C, a.k.a. ASCII) and Unicode&#39;s UTF-8. It will work in other locales,
but things like converting to upper/lower case, and matching single
characters in patterns, are not guaranteed.</p>
<p dir="auto"><em>Caveat:</em> some shells or operating systems have bugs that prevent (or lack
features required for) full locale support. If portability is a concern,
check for <code>thisshellhas WRN_MULTIBYTE</code> or <code>thisshellhas BUG_NOCHCLASS</code>
where needed. See <a href="#user-content-appendix-a-list-of-shell-cap-ids">Appendix A</a>.</p>
<p dir="auto">Scripts/programs should <em>not</em> change the locale (<code>LC_*</code> or <code>LANG</code>) after
initialising modernish. Doing this might break various functions, as
modernish sets specific versions depending on your OS, shell and locale.
(Temporarily changing the locale is fine as long as you don&#39;t use
modernish features that depend on it – for example, setting a specific
locale just for an external command. However, if you use <code>harden</code>, see
the <a href="#user-content-important-note-on-variable-assignments">important note</a>
in its documentation!)</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Appendix D: Supported shells</h2><a id="user-content-appendix-d-supported-shells" aria-label="Permalink: Appendix D: Supported shells" href="#appendix-d-supported-shells"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Modernish builds on the
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/contents.html" rel="nofollow">POSIX 2018 Edition</a>
standard, so it should run on any sufficiently POSIX-compliant shell and
operating system. It uses both
<a href="#user-content-shell-capability-detection">bug/feature detection</a>
and
<a href="#user-content-appendix-b-regression-test-suite">regression testing</a>
to determine whether it can run on any particular shell, so it does not
block or support particular shell versions as such. However, modernish has
been confirmed to run correctly on the following shells:</p>
<ul dir="auto">
<li><a href="https://www.gnu.org/software/bash/" rel="nofollow">bash</a> 3.2 or higher</li>
<li><a href="https://busybox.net/" rel="nofollow">Busybox</a> ash 1.20.0 or higher, excluding 1.28.x
(also possibly excluding anything older than 1.27.x on UTF-8 locales,
depending on your operating system)</li>
<li><a href="http://gondor.apana.org.au/~herbert/dash/" rel="nofollow">dash</a> (Debian sh)
0.5.7 or higher, <em>excluding</em> 0.5.10, 0.5.10.1, 0.5.11-0.5.11.4</li>
<li><a href="https://www.freebsd.org/" rel="nofollow">FreeBSD</a> sh 11.0 or higher</li>
<li><a href="https://github.com/hvdijk/gwsh">gwsh</a></li>
<li><a href="http://github.com/ksh93/ksh">ksh</a> 93u+ 2012-08-01, 93u+m</li>
<li><a href="http://www.mirbsd.org/mksh.htm" rel="nofollow">mksh</a> version R55 or higher</li>
<li><a href="https://www.netbsd.org/" rel="nofollow">NetBSD</a> sh 9.0 or higher</li>
<li><a href="http://yash.osdn.jp/" rel="nofollow">yash</a> 2.40 or higher (2.44+ for POSIX mode)</li>
<li><a href="http://www.zsh.org/" rel="nofollow">zsh</a> 5.3 or higher</li>
</ul>
<p dir="auto">Currently known <em>not</em> to run modernish due to excessive bugs:</p>
<ul dir="auto">
<li>bosh (<a href="http://schilytools.sourceforge.net/" rel="nofollow">Schily</a> Bourne shell)</li>
<li><a href="http://www.kornshell.com/" rel="nofollow">ksh</a> A 2020.0.0</li>
<li>pdksh, including <a href="https://www.netbsd.org/" rel="nofollow">NetBSD</a> ksh and
<a href="https://www.openbsd.org/" rel="nofollow">OpenBSD</a> ksh</li>
</ul>
<div dir="auto"><h2 tabindex="-1" dir="auto">Appendix E: zsh: integration with native scripts</h2><a id="user-content-appendix-e-zsh-integration-with-native-scripts" aria-label="Permalink: Appendix E: zsh: integration with native scripts" href="#appendix-e-zsh-integration-with-native-scripts"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This appendix is specific to <a href="http://zsh.sourceforge.net/" rel="nofollow">zsh</a>.</p>
<p dir="auto">While modernish duplicates some functionality already available natively
on zsh, it still has plenty to add. However, writing a normal
<a href="#user-content-simple-form">simple-form</a> modernish script turns
<code>emulate sh</code> on for the entire script, so you lose important aspects
of the zsh language.</p>
<p dir="auto">But there is another way – modernish functionality may be integrated
with native zsh scripts using &#39;sticky emulation&#39;, as follows:</p>
<div dir="auto" data-snippet-clipboard-copy-content="emulate -R sh -c &#39;. modernish&#39;"><pre>emulate -R sh -c <span><span>&#39;</span>. modernish<span>&#39;</span></span></pre></div>
<p dir="auto">This causes modernish functions to run in sh mode while your script will still
run in native zsh mode with all its advantages. The following notes apply:</p>
<ul dir="auto">
<li>Using the <a href="#user-content-use-safe">safe mode</a> is <em>not</em> recommended, as zsh
does not apply split/glob to variable expansions by default, and the
modernish safe mode would defeat the <code>${~var}</code> and <code>${=var}</code> flags that apply
these on a case by case basis. This does mean that:
<ul dir="auto">
<li>The <code>--split</code> and <code>--glob</code> operators to constructs such as
<a href="#user-content-the-find-loop"><code>LOOP find</code></a>
are not available. Use zsh expansion flags instead.</li>
<li>Quoting literal glob patterns to commands like <code>find</code> remains necessary.</li>
</ul>
</li>
<li>Using <a href="#user-content-use-varlocal"><code>LOCAL</code></a> is not recommended.
<a href="http://zsh.sourceforge.net/Doc/Release/Functions.html#Anonymous-Functions" rel="nofollow">Anonymous functions</a>
are the native zsh equivalent.</li>
<li>Native zsh loops should be preferred over modernish loops, except where
modernish adds functionality not available in zsh (such as <code>LOOP find</code> or
<a href="#user-content-creating-your-own-loop">user-programmed loops</a>).</li>
</ul>
<p dir="auto">See <code>man zshbuiltins</code> under <code>emulate</code>, option <code>-c</code>, for more information.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Appendix F: Bundling modernish with your script</h2><a id="user-content-appendix-f-bundling-modernish-with-your-script" aria-label="Permalink: Appendix F: Bundling modernish with your script" href="#appendix-f-bundling-modernish-with-your-script"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The modernish installer <code>install.sh</code> can bundle one or more scripts with a
stripped-down version of the modernish library. This allows the bundled scripts
to run with a known version of modernish, whether or not modernish is installed
on the user&#39;s system. Like modernish itself, bundling is cross-platform and
portable (or as portable as your script is).</p>
<p dir="auto">Bundled scripts are not modified. Instead, for each script, a wrapper script is
installed under the same name in the installation root directory. This wrapper
automatically looks for a <a href="#user-content-appendix-d-supported-shells">suitable</a>
POSIX-compliant shell that passes the modernish battery of fatal bug tests,
then sets up the environment to run the real script with modernish on that
shell. Your modernish script can be run through the supplied wrapper script
from any directory location on any POSIX-compliant operating system, as long as
all files remain in the same location relative to each other.</p>
<p dir="auto">Bundling is always a non-interactive installer operation, with options
specified on the command line. The installer usage for bundling is as follows:</p>
<p dir="auto"><code>install.sh</code> <code>-B</code> <code>-D</code> <em>rootdir</em> [ <code>-d</code> <em>subdir</em> ]
[ <code>-s</code> <em>shell</em> ] <em>scriptfile</em> [ <em>scriptfile</em> ... ]</p>
<p dir="auto">The <code>-B</code> option enables bundling mode. The option does not itself take an
option-argument. Instead, any number of <em>scriptfile</em>s to bundle can be given
as arguments following all other options. All scripts are bundled with a
single copy of modernish. The bundling operation does not deal with any
auxiliary files the scripts may require (other than modernish modules); any
such need to be added manually after bundling is complete.</p>
<p dir="auto">The <code>-D</code> option specifies the path to the bundled installation&#39;s root
directory, where wrapper scripts are installed. This option is mandatory.
If the directory doesn&#39;t exist, it is created.</p>
<p dir="auto">The <code>-d</code> option specifies the subdirectory of the <code>-D</code> root directory where the
bundled scripts and modernish are installed. It can contain slashes to install
the bundle at a deeper directory level. The default subdirectory is <code>bndl</code>.
The option-argument can be empty or <code>/</code>, in which case the bundle is installed
directly into the installation root directory.</p>
<p dir="auto">The <code>-s</code> option specifies a preferred shell for the bundled scripts. A shell
name or a full path to a shell can be given. Wrapper scripts try the full path
first (if any), then try to find a shell with its basename, and then try to
find a shell with that basename minus any version number (e.g. <code>bash</code> instead
of <code>bash-5.0</code> or <code>ksh</code> instead of <code>ksh93</code>). If all that doesn&#39;t produce a shell
that passes fatal bugs tests, it continues with the normal shell search.</p>
<p dir="auto">This means the script won&#39;t fail to launch if the preferred shell can&#39;t be
found. Instead, it is up to the script itself to refuse to run if required
shell-specific conditions are not met. Script should use the
<a href="#user-content-shell-capability-detection"><code>thisshellhas</code></a>
function to check for any nonstandard
<a href="#user-content-capabilities">capabilities</a>
required, or any
<a href="#user-content-bugs">bugs</a>
or
<a href="#user-content-quirks">quirks</a>
that the script is incompatible with (or indeed requires!).</p>
<p dir="auto">Bundling is supported for both
<a href="#user-content-portable-form">portable-form</a>
and
<a href="#user-content-simple-form">simple-form</a>
modernish scripts. The installer automatically adapts the wrapper scripts to
the form used. For simple-form scripts, the directory containing the bundled
modernish core library (by default, <code>.../bndl/bin/modernish</code>) is prefixed to
<code>$PATH</code> so that <code>. modernish</code> works. Since simple-form scripts are often more
shell-specific, you may want to specify a preferred shell with the <code>-s</code> option.</p>
<p dir="auto">To save space, the bundled copy of the modernish library is reduced such that
all comments are stripped from the code,
<a href="#user-content-interactive-use">interactive use</a>
is not supported,
the <a href="#user-content-appendix-b-regression-test-suite">regression test suite</a>
is not included,
<a href="#user-content-shell-capability-detection"><code>thisshellhas</code></a>
does not have the <code>--cache</code> and <code>--show</code> operators,
and the
<a href="#user-content-appendix-a-list-of-shell-cap-ids"><code>cap/*.t</code> capability detection scripts</a>
are &#34;statically linked&#34; (directly included) into bin/modernish instead of
shipped as separate files.
A <code>README.modernish</code> file is added with a short explanation, the licence,
and a link for people to get the complete version of modernish. Please do
not remove this when distributing bundled scripts.</p>
<hr/>
<p dir="auto"><code>EOF</code></p>
</article></div></div>
  </body>
</html>
