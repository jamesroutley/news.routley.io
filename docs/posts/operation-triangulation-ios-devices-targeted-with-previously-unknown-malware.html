<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://securelist.com/operation-triangulation/109842/">Original</a>
    <h1>Operation Triangulation: iOS devices targeted with previously unknown malware</h1>
    
    <div id="readability-page-1" class="page"><div>
	
			<section>
				<div>
					<article>
						<header>
							<figure>
								<img width="800" height="450" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/06/01112409/sl-operation-triangulation_featured-800x450.jpg" alt="" decoding="async" data-src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/06/01112409/sl-operation-triangulation_featured-800x450.jpg" data-srcset="" srcset=""/>							</figure>
														<p>
								<a href="https://securelist.com/category/apt-reports/">APT reports</a>
							</p>
																					<div>
																<p>
									<a href="https://securelist.com/category/apt-reports/">APT reports</a>
								</p>
																<p><time datetime="2023-06-01T12:36:45+00:00">01 Jun 2023</time></p>
								<p>
									<svg><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://securelist.com/wp-content/themes/securelist2020/assets/sprite/icons.svg#icon-hourglass"></use></svg> <span></span> minute read								</p>
							</div>
						</header>

						<div>

							<div>

																
								
								<div>
									<div>
										<div>
											<figure>
												<img width="1200" height="600" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/06/01112409/sl-operation-triangulation_featured-1200x600.jpg" alt="" decoding="async" loading="lazy" data-src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/06/01112409/sl-operation-triangulation_featured-1200x600.jpg" data-srcset="" srcset=""/>											</figure>

											

											
											<div>
												<div>
													<p>While monitoring the network traffic of our own corporate Wi-Fi network dedicated for mobile devices using the Kaspersky Unified Monitoring and Analysis Platform (KUMA), we noticed suspicious activity that originated from several iOS-based phones. Since it is impossible to inspect modern iOS devices from the inside, we created offline backups of the devices in question, inspected them using the Mobile Verification Toolkit’s <a href="https://docs.mvt.re/en/latest/" rel="noopener" target="_blank">mvt-ios</a> and discovered traces of compromise.</p>
<h2 id="what-we-know-so-far">What we know so far</h2>
<p>Mobile device backups contain a partial copy of the filesystem, including some of the user data and service databases. The timestamps of the files, folders and the database records allow to roughly reconstruct the events happening to the device. The mvt-ios utility produces a sorted timeline of events into a file called “timeline.csv”, similar to a super-timeline used by conventional digital forensic tools.</p>
<ul>
<li>The target iOS device receives a message via the iMessage service, with an attachment containing an exploit.</li>
<li>Without any user interaction, the message triggers a vulnerability that leads to code execution.</li>
<li>The code within the exploit downloads several subsequent stages from the C&amp;C server, that include additional exploits for privilege escalation.</li>
<li>After successful exploitation, a final payload is downloaded from the C&amp;C server, that is a fully-featured APT platform.</li>
<li>The initial message and the exploit in the attachment is deleted</li>
</ul>
<p>The malicious toolset does not support persistence, most likely due to the limitations of the OS. The timelines of multiple devices indicate that they may be reinfected after rebooting. The oldest traces of infection that we discovered happened in 2019. As of the time of writing in June 2023, the attack is ongoing, and the most recent version of the devices successfully targeted is iOS 15.7.</p>
<h2 id="forensic-methodology">Forensic methodology</h2>
<p>It is important to note, that, although the malware includes portions of code dedicated specifically to clear the traces of compromise, it is possible to reliably identify if the device was compromised. Furthermore, if a new device was set up by migrating user data from an older device, the iTunes backup of that device will contain the traces of compromise that happened to both devices, with correct timestamps.</p>
<h3 id="preparation">Preparation</h3>
<p>All potential target devices must be backed up, either using iTunes, or an open-source utility idevicebackup2 (from the package libimobiledevice). The latter is shipped as a pre-built package with the most popular Linux distributions, or can be built from the source code for MacOS/Linux.</p>
<p>You may need to enter the security code of the device several times, and the process may take several hours, depending on the amount of user data stored in it.</p>
<h3 id="install-mvt">Install MVT</h3>
<p>Once the backup is ready, it has to be processed by the Mobile Verification Toolkit. If Python 3 is installed in the system, run the following command:</p>
<p>A more comprehensive installation manual is available <a href="https://docs.mvt.re/en/latest/" rel="noopener" target="_blank">the MVT homepage</a>.</p>
<h3 id="optional-decrypt-the-backup">Optional: decrypt the backup</h3>
<p>If the owner of the device has set up encryption for the backup previously, the backup copy will be encrypted. In that case, the backup copy has to be decrypted before running the checks:</p>
<h3 id="parse-the-backup-using-mvt">Parse the backup using MVT</h3>
<p><code>mvt-ios check-backup -o $mvt_output_directory $decrypted_backup_directory</code></p>
<h3 id="check-timeline-csv-for-indicators">Check timeline.csv for indicators</h3>
<ol>
<li>The single most reliable indicator that we discovered is the presence of data usage lines mentioning the process named “BackupAgent”. This is a deprecated binary that should not appear in the timeline during regular usage of the device. However, it is important to note that there is also a binary named “BackupAgent2”, and that is not an indicator of compromise. In many cases, BackupAgent is preceded by the process “IMTransferAgent”, that downloads the attachment that happens to be an exploit, and this leads to modification of the timestamps of multiple directories in the “Library/SMS/Attachments”. The attachment is then deleted, leaving only modified directories, without actual files inside them:</li>
<li>There are also less reliable indicators, that may be treated as IOCs if several of them happened within a timeframe of minutes:
<ul>
<li>Modification of one or several files: <em>com.apple.ImageIO.plist, com.apple.locationd.StatusBarIconManager.plist, com.apple.imservice.ids.FaceTime.plist</em></li>
<li>Data usage information of the services <em>com.apple.WebKit.WebContent, powerd/com.apple.datausage.diagnostics, lockdownd/com.apple.datausage.security</em>
</li>
</ul>
<p>Example:</p>
<p>Another example: modification of an SMS attachment directory (but no attachment filename), followed by data usage of com.apple.WebKit.WebContent, followed by modification of com.apple.locationd.StatusBarIconManager.plist. All the events happened within a 1-3 minute timeframe, indicating the result of a successful zero-click compromise via an iMessage attachment, followed by the traces of exploitation and malicious activity.</p></li>
<li>An even less implicit indicator of compromise is inability to install iOS updates. We discovered malicious code that modifies one of the system settings file named <em>com.apple.softwareupdateservicesd.plist</em>. We observed update attempts to end with an error message “Software Update Failed. An error ocurred downloading iOS”.</li>
</ol>
<h2 id="network-activity-during-exploitation">Network activity during exploitation</h2>
<p>On the network level, a successful exploitation attempt can be identified by a sequence of several HTTPS connection events. These can be discovered in netflow data enriched with DNS/TLS host information, or PCAP dumps:</p>
<ul>
<li>Legitimate network interaction with the iMessage service, usually using the domain names *.ess.apple.com</li>
<li>Download of the iMessage attachment, using the domain names .icloud-content.com, content.icloud.com</li>
<li>Multiple connections to the C&amp;C domains, usually 2 different domains (the list of known domains follows). Typical netflow data for the C&amp;C sessions will show network sessions with significant amount of outgoing traffic.</li>
</ul>
<div id="attachment_109845"><p><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/06/01091105/operation-triangulation_01.png"><img aria-describedby="caption-attachment-109845" decoding="async" loading="lazy" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/06/01091105/operation-triangulation_01.png" alt="" width="788" height="371"/></a></p><p id="caption-attachment-109845">Network exploitation sequence, Wireshark dump</p></div>
<p>The iMessage attachment is encrypted and downloaded over HTTPS, the only implicit indicator that can be used is the amount of downloaded data that is about 242 Kb.</p>
<div id="attachment_109846"><p><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/06/01091115/operation-triangulation_02.png"><img aria-describedby="caption-attachment-109846" decoding="async" loading="lazy" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/06/01091115/operation-triangulation_02.png" alt="" width="695" height="656"/></a></p><p id="caption-attachment-109846">Encrypted iMessage attachment, Wireshark dump</p></div>
<h2 id="cc-domains">C&amp;C domains</h2>
<p>Using the forensic artifacts, it was possible to identify the set of domain name used by the exploits and further malicious stages. They can be used to check the DNS logs for historical information, and to identify the devices currently running the malware:</p>
												</div>
											</div>
										</div>

										
				<!-- .entry-comments -->
											</div>
									<div>
																				
																					
													
					
					
		<li id="text-22">			<p><a href="https://xtraining.kaspersky.com/courses/hunt-apts-with-yara-like-a-great-ninja?redef=1&amp;THRU&amp;reseller=gl_xc-overview_acq_ona_smm__onl_b2b_securelist_banner_______&amp;utm_source=securelist&amp;utm_medium=blog&amp;utm_campaign=gl_course-overview_ay0073&amp;utm_content=banner&amp;utm_term=gl_securelist_organic_elqwbvemf73woii" target="_blank" rel="noopener"><img decoding="async" src="https://kasperskycontenthub.com/securelist/files/2020/09/Hunt-APT_YARA_Early_live_v3.jpg" width="370"/></a></p>
		</li>
									</div>
								</div>

							</div>
						</div>

						
					</article>
				</div>
			</section>
			<section>
	
</section>
	<section data-element-id="latest-webinars-post-section">
		
	</section>
		<section data-element-id="footer-reports-section">
		<div>
			<h5>Reports</h5>
			<div>
				<div>
					<div>
																							<div>
												<article>
		<div>
		
				<p>While monitoring the traffic of our own corporate Wi-Fi network, we noticed suspicious activity that originated from several iOS-based phones. We created offline backups of the devices, inspected them and discovered traces of compromise.</p>
					</div>
</article>
						</div>
																							<div>
												<article>
		<div>
		
				<p>GoldenJackal is an APT group, active since 2019, that usually targets government and diplomatic entities in the Middle East and South Asia. The main feature of this group is a specific toolset of .NET malware, JackalControl, JackalWorm, JackalSteal, JackalPerInfo and JackalScreenWatcher.</p>
					</div>
</article>
						</div>
																							<div>
												<article>
		<div>
		
				<p>Kaspersky analysis of the CloudWizard APT framework used in a campaign in the region of the Russo-Ukrainian conflict.</p>
					</div>
</article>
						</div>
																							<div>
												<article>
		<div>
		
				<p>For more than five years, the Global Research and Analysis Team (GReAT) at Kaspersky has been publishing quarterly summaries of advanced persistent threat (APT) activity. These summaries are based on our threat intelligence research; and they provide a representative snapshot of what we have published and discussed in greater detail in our private APT reports.</p>
					</div>
</article>
						</div>
															</div>
				</div>
								
							</div>
		</div>
	</section>
		<section data-element-id="footer-subscribe-section">
		
	</section>
	</div></div>
  </body>
</html>
