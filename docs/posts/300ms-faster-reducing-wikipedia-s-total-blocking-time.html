<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.nray.dev/blog/300ms-faster-reducing-wikipedias-total-blocking-time/">Original</a>
    <h1>300ms Faster: Reducing Wikipedia&#39;s total blocking time</h1>
    
    <div id="readability-page-1" class="page"><div>
    <article>
      <section>
        
        <div>
          <a href="https://www.nray.dev/about">
            <p><img alt="Avatar" width="72" height="72" src="https://www.nray.dev/_astro/avatar.19c5be45_21sMbK.jpg" loading="eager" decoding="async"/>
            </p>
            <p>Nicholas Ray</p>
          </a>
          <div>
            <p><span>·</span>
            <time datetime="2023-05-21T00:00:00.000Z">
              May 21, 2023
            </time>
            <span>·</span></p><p>8 min read</p>
          </div>
        </div>
        <div>
          <picture>
	<source type="image/avif" srcset="/_astro/clock-in-pastel-background_1QzqQA.avif 400w,/_astro/clock-in-pastel-background_1KiQx3.avif 800w,/_astro/clock-in-pastel-background_Z1vWvqG.avif 1600w,/_astro/clock-in-pastel-background_fQAmk.avif 2200w" sizes="(min-width: 48rem) 76rem, 100vw"/><source type="image/webp" srcset="/_astro/clock-in-pastel-background_FPBHk.webp 400w,/_astro/clock-in-pastel-background_zz2nM.webp 800w,/_astro/clock-in-pastel-background_2miCbC.webp 1600w,/_astro/clock-in-pastel-background_ZV4oOi.webp 2200w" sizes="(min-width: 48rem) 76rem, 100vw"/><source type="image/jpeg" srcset="/_astro/clock-in-pastel-background_ZBmBF8.jpg 400w,/_astro/clock-in-pastel-background_ZHDbYF.jpg 800w,/_astro/clock-in-pastel-background_fyqar.jpg 1600w,/_astro/clock-in-pastel-background_22nwXs.jpg 2200w" sizes="(min-width: 48rem) 76rem, 100vw"/>
	<img alt="Clock lying on pink and blue pastel background" src="https://www.nray.dev/_astro/clock-in-pastel-background_22nwXs.jpg" loading="eager" decoding="async" width="5866" height="3916"/>
</picture>
        </div>
      </section>
      <section>
        
        <div>
  
          <p>Have you ever been frustrated from interacting with a website that was slow to
respond to your clicks or had jerky scrolling? Performance flaws like these can
lead to the following:</p>
<ul>
<li><a href="https://speakerdeck.com/bluesmoon/ux-and-performance-metrics-that-matter-a062d37f-e6c7-4b8a-8399-472ec76bb75e?slide=13">Rage clicking</a></li>
<li><a href="https://edgemesh.com/blog/time-to-interactive-and-conversion-rate">Increased bounce rates and decreased conversion rates</a></li>
<li><a href="https://developers.google.com/search/blog/2021/11/bringing-page-experience-to-desktop">Lower search engine ranking</a></li>
</ul>
<p>For more than three years, Wikipedia’s mobile site suffered from a piece of
JavaScript that could take over
<a href="https://phabricator.wikimedia.org/T241139">600ms to execute</a> during page load
on low-end devices, effectively blocking user interactions.</p>
<p>In this article, we’ll walk through a couple of easy steps I took to reduce the
execution time of this task by about 50%.</p>
<h2 id="total-blocking-time-why-long-tasks-matter"><a aria-label="jump link" href="#total-blocking-time-why-long-tasks-matter"></a>Total Blocking Time: Why long tasks matter</h2>
<p>600ms of synchronous JavaScript execution may not sound like a long time, but
imagine if a user tried to click a button during page load when the 600ms of
JavaScript began executing. Because only one task can be processed on the
browser’s
<a href="https://developer.mozilla.org/en-US/docs/Glossary/Main_thread">main thread</a> at
any given time, the user would need to wait for the following steps to finish
before they see a visual update:</p>
<ol>
<li>The 600ms JavaScript task executes</li>
<li>The relevant click handler task executes</li>
<li>The browser performs the necessary rendering steps to update the page
visually</li>
</ol>

<figure>
  <a href="https://www.nray.dev/_astro/main-thread-click.cca92070.png">
    <picture>
	<source type="image/avif" srcset="/_astro/main-thread-click.cca92070_1PuisD.avif 400w,/_astro/main-thread-click.cca92070_19QXOR.avif 800w,/_astro/main-thread-click.cca92070_2lyssr.avif 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/><source type="image/webp" srcset="/_astro/main-thread-click.cca92070_Z2rAujx.webp 400w,/_astro/main-thread-click.cca92070_1VXjQC.webp 800w,/_astro/main-thread-click.cca92070_Z1VwkjJ.webp 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/><source type="image/png" srcset="/_astro/main-thread-click.cca92070_Zx28d8.png 400w,/_astro/main-thread-click.cca92070_Zyn2VF.png 800w,/_astro/main-thread-click.cca92070_2g4Eef.png 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/>
	<img alt="Main thread timeline showing a click occurring at the beginning of a long task. The click callback executes after completing the long task, followed by a browser paint. A visual update only appears after the paint." src="https://www.nray.dev/_astro/main-thread-click.cca92070_2g4Eef.png" loading="lazy" decoding="async" width="2396" height="480"/>
</picture>
  </a>
  <figcaption>A long task can delay the execution of a click handler that produces a visual update.</figcaption>
</figure>
<p>Each step takes time, and the user can perceive any interaction that takes
longer than <a href="https://web.dev/rail/#response-process-events-in-under-50ms">100ms</a>
to produce a visual update as <strong>slow</strong>. Because of this, Google considers any
task that takes
<a href="https://web.dev/optimize-long-tasks/#what-is-the-main-thread">more than 50ms</a> a
“long task” that can affect the page’s responsiveness to user input. They even
developed a metric for this called “Total Blocking Time” (TBT).</p>

<figure>
  <a href="https://www.nray.dev/_astro/main-thread-tasks.e7827a98.png">
    <picture>
	<source type="image/avif" srcset="/_astro/main-thread-tasks.e7827a98_Z1kBQpj.avif 400w,/_astro/main-thread-tasks.e7827a98_1Q1QFJ.avif 800w,/_astro/main-thread-tasks.e7827a98_166wKW.avif 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/><source type="image/webp" srcset="/_astro/main-thread-tasks.e7827a98_Zxvvny.webp 400w,/_astro/main-thread-tasks.e7827a98_Z2r3V6r.webp 800w,/_astro/main-thread-tasks.e7827a98_1ScRMH.webp 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/><source type="image/png" srcset="/_astro/main-thread-tasks.e7827a98_Z1ijF9v.png 400w,/_astro/main-thread-tasks.e7827a98_V2qUS.png 800w,/_astro/main-thread-tasks.e7827a98_2dBcOg.png 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/>
	<img alt="A timeline from first contentful paint to time to interactive showing a 80ms task, a 30ms task, and a 100ms task on the main thread." src="https://www.nray.dev/_astro/main-thread-tasks.e7827a98_2dBcOg.png" loading="lazy" decoding="async" width="2564" height="586"/>
</picture>
  </a>
  <figcaption>There are two long tasks (&gt; 50ms) — the 80ms task and the 100ms task.</figcaption>
</figure>
<h2 id="what-is-total-blocking-time"><a aria-label="jump link" href="#what-is-total-blocking-time"></a>What is Total Blocking Time?</h2>
<p>TBT measures the sum of the blocking portion of all long tasks on the browser’s
main thread between <a href="https://web.dev/fcp/">First Contentful Paint</a> (FCP) and
<a href="https://web.dev/tti/">Time to Interactive</a> (TTI). The “blocking portion” is the
time after 50ms of each long task.</p>
<p>Let’s try calculating the TBT in the example below:</p>

<figure>
  <a href="https://www.nray.dev/_astro/main-thread-tasks-tbt.0fca0d31.png">
    <picture>
	<source type="image/avif" srcset="/_astro/main-thread-tasks-tbt.0fca0d31_Z1QyE8j.avif 400w,/_astro/main-thread-tasks-tbt.0fca0d31_RfwLx.avif 800w,/_astro/main-thread-tasks-tbt.0fca0d31_1efhCs.avif 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/><source type="image/webp" srcset="/_astro/main-thread-tasks-tbt.0fca0d31_Z14sj6y.webp 400w,/_astro/main-thread-tasks-tbt.0fca0d31_1ElRNi.webp 800w,/_astro/main-thread-tasks-tbt.0fca0d31_21lCEd.webp 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/><source type="image/png" srcset="/_astro/main-thread-tasks-tbt.0fca0d31_jHn5b.png 400w,/_astro/main-thread-tasks-tbt.0fca0d31_p5DcS.png 800w,/_astro/main-thread-tasks-tbt.0fca0d31_1eORU4.png 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/>
	<img alt="Main thread tasks" src="https://www.nray.dev/_astro/main-thread-tasks-tbt.0fca0d31_1eORU4.png" loading="lazy" decoding="async" width="2564" height="586"/>
</picture>
  </a>
  
</figure>
<ol>
<li>The 80ms task is <strong>30ms</strong> longer than 50ms so contributes <strong>30ms</strong> to TBT.</li>
<li>The 30ms task doesn’t contribute to TBT since it is less than 50ms and NOT a
long task.</li>
<li>The 100ms task is <strong>50ms</strong> longer than 50ms so contributes <strong>50ms</strong> to TBT.</li>
</ol>
<p>Since TBT is the sum of the time exceeding 50ms of each long task, the TBT for
this example is 30ms + 50ms = <strong>80ms</strong>.</p>
<p>When tested on average mobile hardware, Google
<a href="https://web.dev/tbt/#what-is-a-good-tbt-score">recommends</a> sites have a TBT of
less than <strong>200 milliseconds</strong>. But Wikipedia had one task that could take over
<strong>600 milliseconds</strong> — roughly 3x the recommended TBT limit for this one task
alone.</p>
<p>How do we improve TBT?</p>
<h2 id="how-to-reduce-total-blocking-time"><a aria-label="jump link" href="#how-to-reduce-total-blocking-time"></a>How to reduce Total Blocking Time</h2>
<p>To decrease TBT, we need to either:</p>
<ul>
<li>Do less work on the main thread between First Contentful Paint and Time to
Interactive</li>
<li>Do the same amount of work, but break up long tasks into smaller tasks that
don’t exceed 50ms</li>
</ul>
<p>This article focuses on making gains from the first bullet point.</p>
<h2 id="step-1-remove-unnecessary-javascript"><a aria-label="jump link" href="#step-1-remove-unnecessary-javascript"></a>Step 1: Remove unnecessary JavaScript</h2>
<p>While many things run on the main thread, including HTML parsing, paints, and
garbage collection, long JavaScript execution is frequently the culprit of TBT
problems. After all,
<a href="https://timkadlec.com/remembers/2020-04-21-the-cost-of-javascript-frameworks/">JavaScript is the fastest way to slow down a site</a>.</p>

<figure>
  <a href="https://www.nray.dev/_astro/profile-beginning.bfc7d91f.png">
    <picture>
	<source type="image/avif" srcset="/_astro/profile-beginning.bfc7d91f_x4w2Y.avif 400w,/_astro/profile-beginning.bfc7d91f_2oSKHw.avif 800w,/_astro/profile-beginning.bfc7d91f_Z1QYf13.avif 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/><source type="image/webp" srcset="/_astro/profile-beginning.bfc7d91f_1kaR4J.webp 400w,/_astro/profile-beginning.bfc7d91f_Z1Sc24E.webp 800w,/_astro/profile-beginning.bfc7d91f_Z14RSYi.webp 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/><source type="image/png" srcset="/_astro/profile-beginning.bfc7d91f_ZTBchb.png 400w,/_astro/profile-beginning.bfc7d91f_Z1aW0yP.png 800w,/_astro/profile-beginning.bfc7d91f_Z28ojIk.png 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/>
	<img alt="Chrome performance profile showing that a `_enable` method took 475ms to execute." src="https://www.nray.dev/_astro/profile-beginning.bfc7d91f_Z28ojIk.png" loading="lazy" decoding="async" width="3456" height="2482"/>
</picture>
  </a>
  
</figure>
<p>When I profiled Wikipedia’s mobile site, I found that an <code>_enable</code> method was
responsible for most of the execution time. This method initialized the mobile
site’s section expansion and collapsing behavior. The profile also showed that,
within the <code>_enable</code> method, a call to jQuery’s <code>.on(&#34;click&#34;)</code> method was slow.</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span><span>function</span><span> </span><span>_enable</span><span>( </span><span>$container</span><span>,</span><span> </span><span>prefix</span><span>,</span><span> </span><span>page</span><span>,</span><span> </span><span>isClosed</span><span> ) {</span></span>
<span><span>  </span><span>...</span></span>
<span><span>  </span><span>// Restricted to links created by editors and thus outside our control</span></span>
<span><span>  </span><span>// T166544 - don&#39;t do this for reference links - they will be handled elsewhere</span></span>
<span><span>  </span><span>var</span><span> $link </span><span>=</span><span> $container</span><span>.</span><span>find</span><span>(</span><span>&#34;a:not(.reference a)&#34;</span><span>)</span><span>;</span></span>
<span><span>  $link</span><span>.</span><span>on</span><span>(</span><span>&#34;click&#34;</span><span>,</span><span> </span><span>function</span><span> () {</span></span>
<span><span>    </span><span>// the link might be an internal link with a hash.</span></span>
<span><span>    </span><span>// if it is check if we need to reveal any sections.</span></span>
<span><span>    </span><span>if</span><span> (</span></span>
<span><span>      $link</span><span>.</span><span>attr</span><span>(</span><span>&#34;href&#34;</span><span>) </span><span>!==</span><span> </span><span>undefined</span><span> </span><span>&amp;&amp;</span></span>
<span><span>      $link</span><span>.</span><span>attr</span><span>(</span><span>&#34;href&#34;</span><span>)</span><span>.</span><span>indexOf</span><span>(</span><span>&#34;#&#34;</span><span>) </span><span>&gt;</span><span> </span><span>-</span><span>1</span></span>
<span><span>    ) {</span></span>
<span><span>      </span><span>checkHash</span><span>()</span><span>;</span></span>
<span><span>    }</span></span>
<span><span>  })</span><span>;</span></span>
<span><span>  util</span><span>.</span><span>getWindow</span><span>()</span><span>.</span><span>on</span><span>(</span><span>&#34;hashchange&#34;</span><span>,</span><span> </span><span>function</span><span> () {</span></span>
<span><span>    </span><span>checkHash</span><span>()</span><span>;</span></span>
<span><span>  })</span><span>;</span></span>
<span><span>}</span></span></code></pre></div>
<p>The <code>.on(&#34;click&#34;)</code> call attached a click event listener to nearly every link in
the content so that the corresponding section would open if the clicked link
contained a hash fragment. For short articles with few links, the performance
impact was negligible. But long articles like
”<a href="https://en.wikipedia.org/wiki/United_States">United States</a>” included over
4,000 links, leading to over 200ms of execution time on low-end devices.</p>
<p>Worse yet, this behavior was <strong>unnecessary</strong>. The downstream code that listened
to the <code>hashchange</code> event already called the same method that the click event
listener called. Unless the window’s location already pointed at the link’s
destination, clicking a link called the <code>checkHash</code> method twice — once for the
link click event handler and once more for the <code>hashchange</code> handler.</p>

<figure>
  <a href="https://www.nray.dev/_astro/profile-removing-unnecessary-code.edea8071.png">
    <picture>
	<source type="image/avif" srcset="/_astro/profile-removing-unnecessary-code.edea8071_2m2Ydb.avif 400w,/_astro/profile-removing-unnecessary-code.edea8071_psj7i.avif 800w,/_astro/profile-removing-unnecessary-code.edea8071_Z1pbzaG.avif 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/><source type="image/webp" srcset="/_astro/profile-removing-unnecessary-code.edea8071_Z1V2Nz0.webp 400w,/_astro/profile-removing-unnecessary-code.edea8071_1cyE93.webp 800w,/_astro/profile-removing-unnecessary-code.edea8071_ZC5e8V.webp 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/><source type="image/png" srcset="/_astro/profile-removing-unnecessary-code.edea8071_Zm0E2b.png 400w,/_astro/profile-removing-unnecessary-code.edea8071_Z2dTiTv.png 800w,/_astro/profile-removing-unnecessary-code.edea8071_OBq42.png 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/>
	<img alt="Chrome performance profile showing that an `on` method took 264ms to execute. All of this code was removed." src="https://www.nray.dev/_astro/profile-removing-unnecessary-code.edea8071_OBq42.png" loading="lazy" decoding="async" width="3468" height="2298"/>
</picture>
  </a>
  
</figure>
<p>Therefore, in this case, the best approach was to simply
<a href="https://gerrit.wikimedia.org/r/c/mediawiki/extensions/MobileFrontend/+/908333/6/src/mobile.startup/Toggler.js#22">remove this block of JavaScript</a>
and free up nearly 200ms from the main thread with virtually the same
functionality.</p>
<p>When profiling, always check where the most time is spent. Then, see if there is
code you can either optimize or, better yet, remove.</p>
<p><strong>Remember, the fastest way to speed up a site is to <em>remove</em> JavaScript.</strong></p>
<h2 id="step-2-optimize-existing-javascript"><a aria-label="jump link" href="#step-2-optimize-existing-javascript"></a>Step 2: Optimize existing JavaScript</h2>

<figure>
  <a href="https://www.nray.dev/_astro/profile-media-viewer.f3166811.png">
    <picture>
	<source type="image/avif" srcset="/_astro/profile-media-viewer.f3166811_Z1BrLIb.avif 400w,/_astro/profile-media-viewer.f3166811_18z2QP.avif 800w,/_astro/profile-media-viewer.f3166811_Z22qkek.avif 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/><source type="image/webp" srcset="/_astro/profile-media-viewer.f3166811_ZOlqGq.webp 400w,/_astro/profile-media-viewer.f3166811_1UFnSA.webp 800w,/_astro/profile-media-viewer.f3166811_Z1fjYcz.webp 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/><source type="image/png" srcset="/_astro/profile-media-viewer.f3166811_2igNQR.png 400w,/_astro/profile-media-viewer.f3166811_Z2wui2a.png 800w,/_astro/profile-media-viewer.f3166811_Z2sJE8C.png 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/>
	<img alt="Chrome performance profile showing that an `initMediaViewer` method took 114ms to execute." src="https://www.nray.dev/_astro/profile-media-viewer.f3166811_Z2sJE8C.png" loading="lazy" decoding="async" width="3456" height="2160"/>
</picture>
  </a>
  
</figure>
<p>An additional performance review revealed that an <code>initMediaViewer</code> method took
~100ms to execute . This method was responsible for attaching a click event
listener to <strong>each</strong> thumbnail in the content so that a click to a thumbnail
would open a media viewer:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span><span>/**</span></span>
<span><span> * Event handler for clicking on an image thumbnail</span></span>
<span><span> *</span></span>
<span><span> * </span><span>@param</span><span> </span><span>{jQuery.Event}</span><span> </span><span>ev</span></span>
<span><span> * </span><span>@ignore</span></span>
<span><span> */</span></span>
<span><span>function</span><span> </span><span>onClickImage</span><span>(</span><span>ev</span><span>) {</span></span>
<span><span>  ev</span><span>.</span><span>preventDefault</span><span>()</span><span>;</span></span>
<span><span>  </span><span>routeThumbnail</span><span>(</span><span>$</span><span>(</span><span>this</span><span>)</span><span>.</span><span>data</span><span>(</span><span>&#34;thumb&#34;</span><span>))</span><span>;</span></span>
<span><span>}</span></span>
<span> </span>
<span><span>/**</span></span>
<span><span> * Add routes to images and handle clicks</span></span>
<span><span> *</span></span>
<span><span> * </span><span>@method</span></span>
<span><span> * </span><span>@ignore</span></span>
<span><span> * </span><span>@param</span><span> </span><span>{jQuery.Object}</span><span> </span><span>[$container]</span><span> Optional container to search within</span></span>
<span><span> */</span></span>
<span><span>function</span><span> </span><span>initMediaViewer</span><span>(</span><span>$container</span><span>) {</span></span>
<span><span>  currentPageHTMLParser</span><span>.</span><span>getThumbnails</span><span>($container)</span><span>.</span><span>forEach</span><span>(</span><span>function</span><span> (</span><span>thumb</span><span>) {</span></span>
<span><span>    thumb</span><span>.</span><span>$el</span><span>.</span><span>off</span><span>()</span><span>.</span><span>data</span><span>(</span><span>&#34;thumb&#34;</span><span>,</span><span> thumb)</span><span>.</span><span>on</span><span>(</span><span>&#34;click&#34;</span><span>,</span><span> onClickImage)</span><span>;</span></span>
<span><span>  })</span><span>;</span></span>
<span><span>}</span></span></code></pre></div>
<p>Similar to the link example in step 1, attaching an event listener to each
thumbnail on the page doesn’t scale well. Editors of Wikipedia articles can (and
do) make articles with
<a href="https://en.wikipedia.org/wiki/B8_polytope">thousands of images</a>. When this
block of code ran, it could take well over 100 milliseconds to execute for pages
with a lot of images and increase the TBT of the page. What is an alternative
approach?</p>
<p>Use <strong>event delegation</strong>.</p>
<p>Event delegation is a powerful technique that lets us attach a single event
listener to an element that is the common ancestor of many elements. Using event
delegation is often more efficient when dealing with user-generated content that
could add any number of elements. It takes advantage of
<a href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Building_blocks/Events#event_bubbling">event bubbling</a>
and works like this:</p>
<ol>
<li>Attach an event listener to a container element.</li>
<li>Using the <code>event</code> param in the event handler, check the <code>event.target</code>
property to see the source of the event. Optionally use the
<code>event.target.closest(selector)</code>
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/closest">API</a> to
check for an ancestor element.</li>
<li>If the source of the event is an element or the child of an element we’re
interested in, handle it.</li>
</ol>
<p>The
<a href="https://gerrit.wikimedia.org/r/c/mediawiki/skins/MinervaNeue/+/908675/10/resources/skins.minerva.scripts/initMobile.js#66">updated code</a>
looked like the following:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span><span>/**</span></span>
<span><span> * Event handler for clicking on an image thumbnail</span></span>
<span><span> *</span></span>
<span><span> * </span><span>@param</span><span> </span><span>{MouseEvent}</span><span> </span><span>ev</span></span>
<span><span> * </span><span>@ignore</span></span>
<span><span> */</span></span>
<span><span>function</span><span> </span><span>onClickImage</span><span>(</span><span>ev</span><span>) {</span></span>
<span><span>  </span><span>var</span><span> el </span><span>=</span><span> ev</span><span>.</span><span>target</span><span>.</span><span>closest</span><span>(PageHTMLParser</span><span>.</span><span>THUMB_SELECTOR)</span><span>;</span></span>
<span><span>  </span><span>if</span><span> (</span><span>!</span><span>el) {</span></span>
<span><span>    </span><span>return</span><span>;</span></span>
<span><span>  }</span></span>
<span> </span>
<span><span>  </span><span>var</span><span> thumb </span><span>=</span><span> currentPageHTMLParser</span><span>.</span><span>getThumbnail</span><span>(</span><span>$</span><span>(el))</span><span>;</span></span>
<span><span>  </span><span>if</span><span> (</span><span>!</span><span>thumb) {</span></span>
<span><span>    </span><span>return</span><span>;</span></span>
<span><span>  }</span></span>
<span> </span>
<span><span>  ev</span><span>.</span><span>preventDefault</span><span>()</span><span>;</span></span>
<span><span>  </span><span>routeThumbnail</span><span>(thumb)</span><span>;</span></span>
<span><span>}</span></span>
<span> </span>
<span><span>/**</span></span>
<span><span> * Add routes to images and handle clicks</span></span>
<span><span> *</span></span>
<span><span> * </span><span>@method</span></span>
<span><span> * </span><span>@ignore</span></span>
<span><span> * </span><span>@param</span><span> </span><span>{HTMLElement}</span><span> </span><span>container</span><span> Container to search within</span></span>
<span><span> */</span></span>
<span><span>function</span><span> </span><span>initMediaViewer</span><span>(</span><span>container</span><span>) {</span></span>
<span><span>  container</span><span>.</span><span>addEventListener</span><span>(</span><span>&#34;click&#34;</span><span>,</span><span> onClickImage)</span><span>;</span></span>
<span><span>}</span></span></code></pre></div>
<p>In this case:</p>
<ol>
<li>I revised the <code>initMediaViewer</code> method to attach one click event listener to
a single container element that contained all the images.</li>
<li>In the <code>onClickImage</code> method, I used the <code>ev.target.closest(selector)</code> API to
check if the click originated from a thumbnail or a child of a thumbnail
element. If it didn’t, the code returns early since we only care about clicks
to thumbnails. If it did, the code handles the event.</li>
</ol>
<p>But what were the results of this work?</p>
<h2 id="conclusion"><a aria-label="jump link" href="#conclusion"></a>Conclusion</h2>
<p>We released the optimizations outlined in steps 1 and 2 to production in two
deploys — step 1 followed by step 2.</p>
<p>According to Wikipedia’s
<a href="https://developer.mozilla.org/en-US/docs/Web/Performance/Rum-vs-Synthetic#synthetic_monitoring">synthetic performance test</a>
data, the first deployment resulted in a reduction of TBT by approximately
200ms, while the second deployment improved TBT by around 80ms when testing on a
real Moto G (5) phone. Overall, these two steps reduced TBT by nearly <strong>300ms</strong>
on devices like the Moto G (5) phone visiting long articles.</p>

<figure>
  <a href="https://www.nray.dev/_astro/total-blocking-time-results.02ffa324.png">
    <picture>
	<source type="image/avif" srcset="/_astro/total-blocking-time-results.02ffa324_ZFkhaz.avif 400w,/_astro/total-blocking-time-results.02ffa324_Z1doECz.avif 800w,/_astro/total-blocking-time-results.02ffa324_1Napiq.avif 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/><source type="image/webp" srcset="/_astro/total-blocking-time-results.02ffa324_6L3Qb.webp 400w,/_astro/total-blocking-time-results.02ffa324_ZqijAO.webp 800w,/_astro/total-blocking-time-results.02ffa324_Z2tUntK.webp 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/><source type="image/png" srcset="/_astro/total-blocking-time-results.02ffa324_Z1710na.png 400w,/_astro/total-blocking-time-results.02ffa324_Z92IFW.png 800w,/_astro/total-blocking-time-results.02ffa324_15Wcy8.png 1800w" sizes="(min-width: 48rem) 55rem, 100vw"/>
	<img alt="Synthetic test graph showing a 200ms decrease in Total Blocking Time after the first deploy and a 100ms decrease in Total Blocking Time on a Moto G (5) phone after the second deploy." src="https://www.nray.dev/_astro/total-blocking-time-results.02ffa324_15Wcy8.png" loading="lazy" decoding="async" width="3194" height="1612"/>
</picture>
  </a>
  <figcaption>Wikipedia&#39;s Moto G (5) synthetic performance test visiting the &#34;Sweden&#34; article on English Wikipedia</figcaption>
</figure>
<p>While there is still room for further improvement, with the task still exceeding
the recommended limit on low-end devices, the progress made so far is
significant. To achieve even greater reductions in TBT, it may be necessary to
<a href="https://web.dev/optimize-long-tasks/#task-management-strategies">break up the task into smaller tasks</a>.</p>
<p>What this experience demonstrates is that significant performance improvements
can be achieved through small, targeted optimizations. By removing or optimizing
specific sections of code, even seemingly minor changes can have a substantial
impact on a website’s overall performance. It serves as a reminder that
delivering a more responsive browsing experience that can work on any device
doesn’t always require complex and extensive changes to the codebase. Sometimes,
it’s the smaller wins that make the biggest difference.</p>
        
</div>
      </section>
    </article>
  </div><div>
  <div>
    <a href="https://www.nray.dev/">
      <span>nray.dev home page</span>
      <svg fill="none" viewBox="0 0 104 29" astro-icon="logo"><path fill="#D4D4D8" d="M2.156 17.52v-3l12-5.284v3.451L5.94 15.986l.111-.18v.427l-.11-.179 8.215 3.298v3.452l-12-5.284ZM80.912 4.727l-5.625 20.898H72.16l5.625-20.898h3.128ZM92.97 17.52l-12 5.284v-3.452l8.216-3.298-.11.179v-.426l.11.179-8.216-3.299V9.236l12 5.284v3Z"></path><path fill="#fff" d="M23.347 15.432V23h-3.63V9.91h3.46v2.309h.153a3.652 3.652 0 0 1 1.457-1.807c.682-.449 1.509-.673 2.48-.673.91 0 1.702.198 2.378.596.676.398 1.202.966 1.577 1.705.375.733.562 1.608.562 2.625V23h-3.63v-7.688c.005-.8-.2-1.426-.614-1.874-.415-.455-.986-.682-1.713-.682-.489 0-.92.105-1.296.315-.369.21-.659.517-.869.92-.204.398-.31.878-.315 1.44ZM34.406 23V9.91h3.52v2.283h.136c.239-.812.64-1.426 1.202-1.84.562-.421 1.21-.631 1.943-.631.182 0 .378.011.588.034.21.022.395.054.554.093v3.222a4.737 4.737 0 0 0-.707-.136 6.35 6.35 0 0 0-.827-.06c-.534 0-1.011.117-1.432.35a2.573 2.573 0 0 0-.989.954c-.238.41-.358.88-.358 1.415V23h-3.63Zm12.938.247c-.835 0-1.58-.145-2.233-.434a3.595 3.595 0 0 1-1.551-1.304c-.375-.58-.563-1.302-.563-2.165 0-.728.134-1.338.401-1.833.267-.494.63-.892 1.09-1.193.461-.301.984-.528 1.57-.682.59-.153 1.21-.261 1.857-.323.761-.08 1.375-.154 1.84-.222.467-.074.805-.182 1.015-.324.21-.142.316-.352.316-.63v-.052c0-.54-.171-.957-.512-1.253-.335-.295-.812-.443-1.432-.443-.653 0-1.173.145-1.56.435a2 2 0 0 0-.766 1.074l-3.358-.273a4.563 4.563 0 0 1 1.005-2.063c.5-.585 1.145-1.034 1.935-1.346.795-.318 1.716-.477 2.761-.477.728 0 1.424.085 2.088.255.67.17 1.265.435 1.782.793.522.358.934.818 1.235 1.38.302.557.452 1.225.452 2.004V23h-3.443v-1.815h-.102c-.21.409-.492.77-.844 1.082a3.906 3.906 0 0 1-1.27.724c-.494.17-1.065.256-1.713.256Zm1.04-2.506c.534 0 1.005-.105 1.414-.315.41-.216.73-.505.964-.87.233-.363.349-.775.349-1.235v-1.39c-.114.075-.27.143-.469.205-.193.057-.412.111-.656.162-.244.046-.489.088-.733.128l-.665.094a4.49 4.49 0 0 0-1.116.298 1.785 1.785 0 0 0-.742.554c-.176.227-.264.512-.264.852 0 .495.18.873.537 1.134.364.256.824.383 1.38.383Zm11.15 7.168a7.19 7.19 0 0 1-1.295-.11 4.722 4.722 0 0 1-.989-.265l.819-2.71c.426.13.81.202 1.15.213a1.46 1.46 0 0 0 .895-.239c.256-.17.463-.46.622-.869l.213-.554-4.696-13.466h3.818l2.71 9.614h.137l2.736-9.614h3.844l-5.089 14.506a6.09 6.09 0 0 1-.997 1.84c-.414.53-.94.935-1.576 1.22-.637.29-1.404.434-2.302.434Z"></path></svg>
    </a>
    
    <p>
      © 2022 Nicholas Ray. All rights reserved.
    </p>
    
  </div>
</div></div>
  </body>
</html>
