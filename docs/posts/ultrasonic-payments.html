<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://charliegerard.dev/blog/ultrasonic-payments/">Original</a>
    <h1>Ultrasonic Payments</h1>
    
    <div id="readability-page-1" class="page"><div><p>Recently, my colleague <a href="https://twitter.com/irreverentmike">Mike Bifulco</a> wrote a blog post about using Near-Field Communication (NFC) technology to <a href="https://dev.to/stripe/no-code-payments-how-to-use-stripe-with-customized-nfc-tags-3c1o">request payment using NFC tags and Stripe Payment Links</a>. In a similar spirit, I came across the concept of “Ultrasonic payments”, a technology based on transferring data through inaudible sounds, and decided to experiment and look into how to implement such a payment method with Stripe.</p>
<p>Here’s the result below. My iPad is in airplane mode, so not connected to the internet, and transmits a payment link to my phone via ultrasound.</p>
<section>
<iframe width="560" height="315" src="https://www.youtube.com/embed/ixuGAr9EmFU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
</section>
<p>If you would like to try this out, check out the <a href="https://ultrasonic-payments.netlify.app/">live demo</a> or have a look at the <a href="https://github.com/charliegerard/ultrasonic-payments">repository on GitHub</a>.</p>
<p><em>Disclaimer: This is an experiment. The ultimate goal would have been to implement a solution similar to tap-to-pay using ultrasounds, however, even though this is possible and has been done by companies such as <a href="https://lisnr.com/">LISNR</a>, this is not something that can be easily prototyped. Instead, I decided to explore by sending <a href="https://stripe.com/payments/payment-links">Payment Links</a>, a no-code payment solution that allows you to request payment from customers with a simple link. I still wanted to share what I tried and learned, as this technology can still be applied to different applications than payments.</em></p>
<h2>Soundwaves</h2>
<p>Before focusing on payments, it’s important to understand how devices transform analog sound into digital data so, without going into <a href="https://physics.info/sound/">too much detail</a>, here’s a brief explanation of how it works.</p>
<p>Sound is created by vibrations that produce shifts in the flow of molecules. These molecules bump into each other, creating a chain reaction called a sound wave. When this wave reaches a microphone, the movement of air molecules creates pressure against the thin membrane found in the device, creating electrical signals that are then converted to digital values using an Analog to Digital converter (ADC).</p>
<section>
<img src="https://d33wubrfki0l68.cloudfront.net/7a53aa8548426257be6e76741015aeab189249c3/893e1/sound-animation.gif"/></section>
<p><em><a href="https://www.youtube.com/watch?v=d_crXXbuEKE">Source: “How do microphones work?”</a></em></p>

<p>Humans can usually hear sounds from a frequency range of 20Hz-20kHz. However, it doesn’t mean that sound does not exist outside of these frequencies, it only means we cannot hear it. As a result, <strong>you can transmit data at frequencies outside of what the human ear can detect, through inaudible sounds</strong>. This is a technique called ultrasonic data transmission.</p>
<section>
<img src="https://d33wubrfki0l68.cloudfront.net/fa82ea8992fc0090481d1a3d45bde6e47989bc5d/5c0ed/electromagnetic-spectrum.png"/>
<p><em><a href="https://www.olympus-ims.com/en/ndt-tutorials/flaw-detection/ultrasound/">Source: What is ultrasound?</a></em></p>
</section>
<p>So, how can we use this to transmit a payment?</p>
<h2>Ultrasonic data transmission in JavaScript</h2>
<p>This prototype is going to rely on <a href="https://github.com/quiet/quiet-js/">quiet.js</a>, a JavaScript library to transmit data using sound.</p>
<p>The same way that usual tap-to-pay systems require both the terminal and personal device to be NFC-enabled, sending data through sound requires the devices involved to have a microphone and speaker.</p>
<p>For the purpose of this experiment, the merchant’s device should have a speaker as it will be transmitting the payment link, and the customer’s device should have a microphone to receive it.
This scenario would allow merchants to use an iPad in-store to sell their products, without having to acquire a terminal device.</p>
<h3>Transmitting data</h3>
<p>Using quiet.js to transmit text via sound can be done by creating a <a href="https://quiet.github.io/quiet-js/docs/Quiet.html#:~:text=transmitter(profile)">transmitter instance</a>, specifying some parameters including the frequency, gain and frame length, and finally calling the <code>.transmit()</code> method with the payload.</p>
<p>Let’s look into the code needed to do this.</p>
<h4>Initial setup</h4>
<p>To start, the library needs to be imported. Quiet.js includes a blob of <a href="https://github.com/quiet/quiet">libquiet</a> that it relies on, and JavaScript bindings, so in my prototype, I used script tags to import <code>quiet.js</code> and <code>quiet-emscripten.js</code>. I also initiated Quiet with the path to a couple of required files; <code>profilesPrefix</code> indicates where the <code>quiet-profiles.json</code> file is located and <code>memoryInitializerPrefix</code>, indicates where <code>quiet-emscripten.js.mem</code> can be found.</p>
<div data-language="js"><pre><code><span>&lt;</span>script type<span>=</span><span>&#34;text/javascript&#34;</span> src<span>=</span><span>&#34;quiet.js&#34;</span><span>&gt;</span><span>&lt;</span><span>/</span>script<span>&gt;</span>
<span>&lt;</span>script<span>&gt;</span>
  Quiet<span>.</span><span>init</span><span>(</span><span>{</span>
    <span>profilesPrefix</span><span>:</span> <span>&#34;/&#34;</span><span>,</span>
    <span>memoryInitializerPrefix</span><span>:</span> <span>&#34;/&#34;</span>
  <span>}</span><span>)</span><span>;</span>
<span>&lt;</span><span>/</span>script<span>&gt;</span>
<span>&lt;</span>script
  <span>async</span>
  type<span>=</span><span>&#34;text/javascript&#34;</span>
  src<span>=</span><span>&#34;quiet-emscripten.js&#34;</span>
<span>&gt;</span><span>&lt;</span><span>/</span>script<span>&gt;</span></code></pre></div>
<h4>Creating a transmitter</h4>
<p>To create a transmitter, there is a <code>transmitter()</code> method where you need to indicate which profile you’d like to use, as well as a callback function that is called when the transmission has ended.</p>
<div data-language="js"><pre><code><span>var</span> transmit <span>=</span> Quiet<span>.</span><span>transmitter</span><span>(</span><span>{</span>
  <span>profile</span><span>:</span> profilename<span>,</span>
  <span>onFinish</span><span>:</span> onFinish
<span>}</span><span>)</span><span>;</span></code></pre></div>
<p>The <code>profile</code> is the set of parameters I mentioned previously, containing information about how the data should be transmitted (the frame length, gain, etc.).</p>
<p>The one I used looks like this:</p>
<div data-language="json"><pre><code> <span>&#34;ultrasonic&#34;</span><span>:</span> <span>{</span>
   <span>&#34;mod_scheme&#34;</span><span>:</span> <span>&#34;gmsk&#34;</span><span>,</span>
   <span>&#34;checksum_scheme&#34;</span><span>:</span> <span>&#34;crc32&#34;</span><span>,</span>
   <span>&#34;inner_fec_scheme&#34;</span><span>:</span> <span>&#34;v27&#34;</span><span>,</span>
   <span>&#34;outer_fec_scheme&#34;</span><span>:</span> <span>&#34;none&#34;</span><span>,</span>
   <span>&#34;frame_length&#34;</span><span>:</span> <span>34</span><span>,</span>
   <span>&#34;modulation&#34;</span><span>:</span> <span>{</span>
     <span>&#34;center_frequency&#34;</span><span>:</span> <span>19000</span><span>,</span>
     <span>&#34;gain&#34;</span><span>:</span> <span>0.15</span>
   <span>}</span><span>,</span>
   <span>&#34;interpolation&#34;</span><span>:</span> <span>{</span>
     <span>&#34;shape&#34;</span><span>:</span> <span>&#34;rrcos&#34;</span><span>,</span>
     <span>&#34;samples_per_symbol&#34;</span><span>:</span> <span>14</span><span>,</span>
     <span>&#34;symbol_delay&#34;</span><span>:</span> <span>4</span><span>,</span>
     <span>&#34;excess_bandwidth&#34;</span><span>:</span> <span>0.35</span>
   <span>}</span><span>,</span>
   <span>&#34;encoder_filters&#34;</span><span>:</span> <span>{</span>
     <span>&#34;dc_filter_alpha&#34;</span><span>:</span> <span>0.01</span>
   <span>}</span><span>,</span>
   <span>&#34;resampler&#34;</span><span>:</span> <span>{</span>
     <span>&#34;delay&#34;</span><span>:</span> <span>13</span><span>,</span>
     <span>&#34;bandwidth&#34;</span><span>:</span> <span>0.45</span><span>,</span>
     <span>&#34;attenuation&#34;</span><span>:</span> <span>60</span><span>,</span>
     <span>&#34;filter_bank_size&#34;</span><span>:</span> <span>64</span>
   <span>}</span>
 <span>}</span></code></pre></div>
<p>No need to dive into what all these properties do right now, they mainly indicate how the data should be encoded.</p>
<p>Next, a data string can be transmitted using the <code>transmit()</code> method and passing a value converted to an array buffer. For this prototype, I’m sending a payment link.</p>
<div data-language="js"><pre><code>transmit<span>.</span><span>transmit</span><span>(</span>Quiet<span>.</span><span>str2ab</span><span>(</span><span>&#34;https://buy.stripe.com/test_00gfZ73t04dxaGI3cc&#34;</span><span>)</span><span>)</span><span>;</span></code></pre></div>
<h4>Creating a receiver</h4>
<p>Creating a receiver is similar to creating a transmitter. First you need to use the <code>receiver()</code> method, passing the profile and some callback functions, and then decode the data received.</p>
<div data-language="js"><pre><code> Quiet<span>.</span><span>receiver</span><span>(</span><span>{</span>
   <span>profile</span><span>:</span> profilename<span>,</span>
   <span>onReceive</span><span>:</span> onReceive
 <span>}</span><span>)</span><span>;</span></code></pre></div>
<p>The <code>onReceive()</code> function receives a payload, converts the array buffer in UTF8 to string, creates a URL object and checks if the host is “buy.stripe.com” to ensure the link sent is a payment link. If so, it opens it in the browser window.</p>
<div data-language="js"><pre><code><span>const</span> <span>onReceive</span> <span>=</span> <span>(</span><span>recvPayload</span><span>)</span> <span>=&gt;</span> <span>{</span>
 <span>const</span> link <span>=</span> Quiet<span>.</span><span>ab2str</span><span>(</span>recvPayload<span>)</span><span>;</span>
 <span>const</span> linkURL <span>=</span> <span>new</span> <span>URL</span><span>(</span>link<span>)</span><span>;</span>
 
 <span>if</span> <span>(</span>linkURL<span>.</span>host <span>===</span> <span>&#34;buy.stripe.com&#34;</span><span>)</span> <span>{</span>
   window<span>.</span>location<span>.</span>href <span>=</span> linkURL<span>;</span>
 <span>}</span>
<span>}</span><span>;</span></code></pre></div>
<p>More code would be needed to implement error handling or working with more complex data structures but for the purpose of this experiment, that’s pretty much it!</p>
<h2>Learnings</h2>
<p>Before starting this experiment, I asked myself a few questions I wanted to be able to answer.</p>
<h3>Will it work in a noisy environment?</h3>
<p>I tested this while playing music in the background and the receiver still detected the payment link with no problem. Considering that the music was playing at a different frequency, it makes sense.</p>
<h3>Will it work if the transmitter is playing music at the same time?</h3>
<p>Yes. I tested this with my laptop as the transmitter. While playing a video, it still successfully transmitted the payment link.</p>
<h3>How far can the data be transmitted?</h3>
<p>In this experiment, it successfully transmitted the payment link up to 55cm (21.65 inches) away from the transmitter (yes, I measured). However, the further away the receiver was from the transmitter, the more failed attempts there were.</p>
<h3>How much data can be transmitted?</h3>
<p>I did not experiment too much in that sense, but according to their <a href="https://quiet.github.io/quiet-js/">official demo</a>, it is possible to transmit images using quiet.js.</p>
<h3>Why experiment with this?</h3>
<p>With the growth in adoption of contactless payments, I wanted to look into alternatives to NFC technology. The COVID-19 pandemic made people more concerned about touching surfaces, including in stores, and even though NFC is contactless, the distance between a merchant&#39;s terminal and a customer’s phone or card is quite small. NFC technology enables communication between two electronic devices over a distance of 4 cm (1.5 inches) or less. Ultrasonic payment solutions would enable communication over a greater distance.</p>
<p>Moreover, this technology transmitting data through sounds also means that it does not require the devices to be connected to the internet, potentially making this more secure. To process payments, a connection would end up being needed but there could be other opportunities than payments where it would be a valid solution.</p>
<p>Considering that this technology only uses a microphone and speaker, it could allow more devices to become payment terminals, such as laptops, TVs, etc.</p>
<h2>Conclusion</h2>
<p>This technology isn’t new, and can be used for more purposes than payments. Advertising companies have used this technology to send out <a href="https://www.wired.com/2017/05/hundreds-apps-can-listen-beacons-cant-hear/">inaudible marketing beacons</a> from TV ads to nearby phones running specific applications for targeted advertising for years (yikes). Google has also implemented this technology in some of their products to <a href="https://developers.googleblog.com/2015/07/connect-with-world-around-you-through.html">automatically detect nearby devices</a>. When it comes to payments, while there are more regulations and security concerns to take into consideration, it is still interesting to explore this space, and understand its opportunities and limitations.</p></div></div>
  </body>
</html>
