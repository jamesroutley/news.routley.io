<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://codeinsecurity.wordpress.com/2025/01/25/proper-decoupling-practices-and-why-you-should-leave-100nf-behind/">Original</a>
    <h1>Proper decoupling capacitor practices, and why you should leave 100nF behind</h1>
    
    <div id="readability-page-1" class="page"><article id="post-2132">
	<!-- .entry-header -->

	<div>
		
<p>Ever wondered <em>why</em> 100nF is a go-to value for decoupling capacitors? This number has pervaded in datasheets and electronics advice going back to the 1980s, and is still widely present in the datasheets of modern components. Folks are out there sprinkling 100nF capacitors on their boards like seasoning, and when they decide 100nF isn’t enough, they inevitably recommend the big/little practice, e.g. 1uF + 100nF in parallel.</p>



<p>Unfortunately, 100nF <em>kinda sucks</em>, and this common decoupling practice is incredibly outdated.</p>



<p>To understand why this practice is so outdated, we need to first consider the problem that decoupling solves and how it solves it. I want to be thorough here, so grab a beverage, put your feet up, and prepare for the long-haul.</p>



<p>One of the easiest contexts to explain this topic in is digital electronics, such as decoupling a microcontroller. A microcontroller can be crudely and simplistically described as a big ol’ heap of transistors. Every time one of those transistors needs to change state, a current flows into or out of the gate in order to charge or discharge its gate capacitance. Most of these transistors are arranged in CMOS circuits, and these circuits also tend to have a small amount of shoot-through current during the rising and falling edges of switching, while the transistors are neither fully on nor off. The amount of current associated with a single switching event is small, but there are a <em>lot</em> of CMOS gates in a microcontroller, and they’re constantly switching on and off, so it adds up once you start measuring it at the power pins.</p>



<p>This type of dynamic load current is numerically measured as dI/dt (pronounced “dee-eye dee-tee”), which comes from <a href="https://en.wikipedia.org/wiki/Leibniz%27s_notation">Leibniz’s notation</a> in calculus. If you didn’t study calculus, or had a bad teacher for calculus like I did, don’t worry. Put plainly: it is the rate of change of current with respect to time, i.e. the change in current (delta I) divided by the change in time (delta t). For example, if a device goes from drawing 1A to 3A in the space of one second, that’s 2A/s of dI/dt. If a device goes from drawing 50mA to 45mA in the space of one nanosecond, that’s -5mA/ns of dI/dt (often just referred to as 5mA/ns, without the minus sign, since it’s the magnitude of change we’re typically interested in).</p>



<p>A common misunderstanding about dynamic power delivery in digital circuits is that the frequencies we will be dealing with are dictated by the clock frequency. This is actually not true at all. What matters is the rise and fall time.</p>



<figure><img data-attachment-id="2178" data-permalink="https://codeinsecurity.wordpress.com/2025/01/25/proper-decoupling-practices-and-why-you-should-leave-100nf-behind/image-50/" data-orig-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-4.png" data-orig-size="691,476" data-comments-opened="0" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-4.png?w=300" data-large-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-4.png?w=691" width="691" height="476" src="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-4.png?w=691" alt="Diagram showing a clock pulse and the rise and fall times annotated." srcset="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-4.png 691w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-4.png?w=150 150w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-4.png?w=300 300w" sizes="(max-width: 691px) 100vw, 691px"/></figure>



<p>Typically we measure these times using the 10-90 rule, i.e. how long it takes to go from 10% signal level to 90% signal level, or vice versa. We can convert a given rise or fall time to a bandwidth, i.e. the maximum frequency component needed to produce a given rising or falling edge at that rate. If you’re familiar with <a href="https://en.wikipedia.org/wiki/Nyquist_frequency">Nyquist frequencies</a>, it’s the same idea. You’re looking at the signal in the frequency domain and figuring out what the highest frequency component of the signal is. A general rule of thumb is that the bandwidth in GHz is equal to 0.35 divided by the rise time in nanoseconds, so a 1ns rise time has an associated bandwidth of around 350MHz. This relationship between rise time and bandwidth is critical, because it tells us what frequencies we’ll need to deal with in our decoupling.</p>



<p>The clock frequency only tells us how frequently an edge occurs. The rise/fall times tell us what frequency components will be present during edges. For an extreme example, if you have a 1Hz clock signal with a 350ps rise time, your circuit must be carrying frequencies up to 1GHz in order to achieve that rise time.</p>



<p>In an ideal world the current that your device demands would be sourced from the power supply. The problem is that your power supply is <em>all the way over there</em>, and the journey is perilously mired in parasitics. The traces between your device and the power supply aren’t perfect conductors – every single conductor in your circuit has some amount of parasitic resistance, inductance, and capacitance. At DC the resistance dominates and the parasitic inductance and capacitance don’t matter, but the dynamic currents (dI/dt) of a load are, by definition, an alternating current.</p>



<p>Parasitic inductance is typically the biggest factor here. Inductance causes a voltage drop proportional to the dI/dt; formally, we say V = L ∙ dI/dt, i.e. the voltage drop (in volts) is equal to the inductance (in henries) multiplied by the rate of change of current (in amps per second). This is why a dynamic current load manifests as voltage noise on the power rails. The amount of parasitic inductance in a trace is related to its geometry – the width and thickness of the copper, the length of the trace, and the height of the trace above the return path (ground plane below) all contribute. For example, a 1mm wide, 5cm long trace on a typical 4-layer PCB might have around 50nH of inductance. If your device has a dI/dt of 2mA/ns, that parasitic inductance will cause 100mV of voltage noise across the trace. You can find calculators online to estimate trace inductance if you want rough numbers. For more precise numbers you need a field solver, which is <em>far</em> out of the scope of this post.</p>



<p>The voltage on the trace is also affected by simple resistive behaviours (V=I∙R, so a change in I produces a proportional change in V), and capacitive behaviours (I = C ∙ dV/dt). I won’t go into all the mathematical and analytical details here (although I will explain in more detail later), but it is possible to combine all of these measurements into a single measurement called <em>impedance</em>, measured in ohms. Put very simply: impedance sums the “resistance-like” effects of resistance, inductance, and capacitance at a given frequency together into a single measurement. We usually plot impedance vs. frequency, since it is frequency-dependent. The impedance tells us the relationship between voltage and current we should expect at a given frequency, and it follows the familiar Ohm’s law relationship of V=I∙|Z|, where |Z| is impedance (instead of resistance in the traditional formula) in ohms. For example, if a circuit path has an impedance of 50Ω at 10MHz, an AC current of 2mA at 10MHz flowing through that path will produce a 100mV voltage difference across it.</p>



<p>Side note: as much as it would be convenient to say so, it is not correct to describe impedance as “frequency dependent resistance”, since resistance <em>is</em> already frequency-dependent due to the <a href="https://en.wikipedia.org/wiki/Skin_effect">skin effect</a>, and while impedance does behave like a resistance in some regards it does not in others.</p>



<p>At low frequencies and DC, the impedance of a PCB trace is typically very low and dominated by the resistance of the path. As the frequency climbs, the dI/dt increases, leading the inductance to be a greater and greater factor, increasing the impedance. The resistance itself also climbs due to the skin effect, contributing to the total impedance. As such, the impedance of a power delivery path typically starts out low at low frequencies and climbs as the frequency increases.</p>



<p>A high impedance power delivery path causes a range of problems. First and foremost, it reduces power delivery network (PDN) integrity. When a device has a sudden demand for current, a PDN with high impedance will suffer a voltage drop across it, leading to an unstable supply to the load. In the context of digital devices, this may lead to glitching. In the context of analog devices, this leads to noise. This voltage noise generated by one device’s dynamic current demands may affect other devices on the same power rail, too. In addition to the direct problem of PDN integrity, having your large dI/dt flow across the board can lead to signal integrity and electromagnetic interference (EMI) issues. A change in current through a trace manifests as a change in the electromagnetic field around that trace. When a changing electromagnetic field cuts through other traces, <a href="https://en.wikipedia.org/wiki/Electromagnetic_induction">electromagnetic induction</a> occurs. We refer to this as crosstalk. A high dI/dt through a trace causes large perturbations in the fields around it, increasing the likelihood and magnitude of crosstalk. In addition, the fields may spread out and cause electromagnetic interference (EMI). We want to avoid these problems.</p>



<p>The comparatively high impedance of the power delivery network at high frequencies is the problem that decoupling aims to solve. We want to ensure that fast dynamic current demands do not impact the stability of the voltage rails, and we want to contain the high frequency currents so they don’t spread out and cause crosstalk and EMI. We can do this by using a capacitor as a low impedance path for high frequency currents. Rather than having both the high- and low-frequency currents flowing through our entire power delivery network, we <em>decouple</em> the high-frequency currents so that only the lower frequency currents need to flow all the way back up to the supply.</p>



<p>We can model the behaviour of a decoupling capacitor in a power delivery network using an impedance network. This behaves almost identically to a resistor network. If you have several current paths to a load, each with its own impedance, you can use <a href="https://en.wikipedia.org/wiki/Kirchhoff%27s_circuit_laws">Kirchhoff’s circuit laws</a> to model how much current flows through each path. Here’s an example of a 9 ohm impedance and 1 ohm impedance in parallel, with a 1:9 ratio of current sharing:</p>



<figure><img data-attachment-id="2139" data-permalink="https://codeinsecurity.wordpress.com/2025/01/25/proper-decoupling-practices-and-why-you-should-leave-100nf-behind/image-46/" data-orig-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image.png" data-orig-size="438,267" data-comments-opened="0" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image.png?w=300" data-large-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image.png?w=438" width="438" height="267" src="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image.png?w=438" alt="Falstad circuitjs simulation showing 1V being fed to a 1A load from two paths, one with a 9 ohm impedance and the other with a 1 ohm impedance. The current sharing ratio is 9:1, resulting in the 1 ohm impedance path carrying 900mA of current and the 9 ohm impedance path carrying 100mA of current." srcset="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image.png 438w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image.png?w=150 150w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image.png?w=300 300w" sizes="(max-width: 438px) 100vw, 438px"/></figure>



<p>Note that resistors are being used as a proxy for impedance here, just to demonstrate that the current sharing works the same way.</p>



<p>To understand how the capacitor acts as a low impedance source for high frequency currents, we need to understand how its impedance changes with frequency. The impedance of an ideal capacitor (i.e. a capacitor with no parasitic resistance or inductance) is given by the following formula:</p>


<p><img src="https://s0.wp.com/latex.php?latex=%7CZ_C%7C+%3D+%5Cfrac%7B1%7D%7B2+%5Cpi+f+C%7D+&amp;bg=ffffff&amp;fg=495762&amp;s=2&amp;c=20201002" srcset="https://s0.wp.com/latex.php?latex=%7CZ_C%7C+%3D+%5Cfrac%7B1%7D%7B2+%5Cpi+f+C%7D+&amp;bg=ffffff&amp;fg=495762&amp;s=2&amp;c=20201002 1x, https://s0.wp.com/latex.php?latex=%7CZ_C%7C+%3D+%5Cfrac%7B1%7D%7B2+%5Cpi+f+C%7D+&amp;bg=ffffff&amp;fg=495762&amp;s=2&amp;c=20201002&amp;zoom=4.5 4x" alt="|Z_C| = \frac{1}{2 \pi f C} "/></p>



<p>Where <em>f</em> is the frequency in Hz and <em>C</em> is the capacitance in Farads. From this, we can see that a perfect capacitor has infinite impedance at DC (f=0), which means no current flows through it at DC. The impedance of the capacitor then falls toward zero as the frequency gets higher and higher. The rate at which it falls towards zero is proportional to the capacitance.</p>



<p>Note: This is a simplified formula. The complete formula involves complex numbers that describe a phase relationship between inductance and capacitance, but for the purposes of this article we can skip that complexity (pun intended) and stick with the simple version. However, it is worth noting that the phase relationship between inductance and capacitance does become important when the magnitudes of inductance and capacitance are similar, as we will see shortly.</p>



<p>We usually show this on a log-log plot of impedance (<em>|Z|</em>) versus frequency (<em>f</em>), such as the following plot for an ideal 1uF capacitor (red) and an ideal 100nF capacitor (purple):</p>



<figure><img data-attachment-id="2154" data-permalink="https://codeinsecurity.wordpress.com/2025/01/25/proper-decoupling-practices-and-why-you-should-leave-100nf-behind/untitled-1-3/" data-orig-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-3.png" data-orig-size="800,800" data-comments-opened="0" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="Untitled-1" data-image-description="" data-image-caption="" data-medium-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-3.png?w=300" data-large-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-3.png?w=800" width="800" height="800" src="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-3.png?w=800" alt="Graph showing frequency on the horizontal axis and impedance on the vertical axis, both log scale. Both capacitors&#39; impedances fall with frequency, with the 1uF capacitor consistently having a lower impedance than the 100nF capacitor at any given frequency." srcset="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-3.png 800w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-3.png?w=150 150w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-3.png?w=300 300w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-3.png?w=768 768w" sizes="(max-width: 800px) 100vw, 800px"/></figure>



<p>For the purposes of clear understanding, it may be beneficial to also see the graph with a linear vertical axis:</p>



<figure><img data-attachment-id="2149" data-permalink="https://codeinsecurity.wordpress.com/2025/01/25/proper-decoupling-practices-and-why-you-should-leave-100nf-behind/untitled-1-2/" data-orig-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-2.png" data-orig-size="800,800" data-comments-opened="0" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="Untitled-1" data-image-description="" data-image-caption="" data-medium-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-2.png?w=300" data-large-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-2.png?w=800" loading="lazy" width="800" height="800" src="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-2.png?w=800" alt="Graph showing frequency on the horizontal axis and impedance on the vertical axis. This time the vertical axis is linear and the horizontal is logarithmic. The capacitors&#39; impedances fall rapidly toward zero. The 1uF capacitor (red) reaches 1 ohm at around 100 kilohertz, and the 100nF capacitor (purple) reaches 1 ohm at around a megahertz." srcset="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-2.png 800w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-2.png?w=150 150w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-2.png?w=300 300w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-2.png?w=768 768w" sizes="(max-width: 800px) 100vw, 800px"/></figure>



<p>We can see from this that a decoupling capacitor provides a low impedance path at high frequencies, and a high impedance path at low frequencies. This is the opposite to a typical power delivery trace, where the impedance is low (approaching the series resistance) at low frequencies, and high at high frequencies. Combining the two gives us the best of both worlds.</p>



<p>Furthermore, the larger our capacitance, the lower the impedance at a given frequency, at least for an ideal capacitor. If we think about this in the context of an impedance network, as depicted above, we know that we would like to have as much high-frequency current as possible flow through the decoupling capacitor as possible, which we can achieve by making the capacitor as low impedance as possible. This leads us toward the conclusion that a larger value capacitor is better for decoupling than a smaller value, due it providing a lower impedance.</p>



<p>Unfortunately, real components are not “ideal”, and in the real world we have parasitics to contend with. Capacitors have some equivalent series resistance (ESR) and some equivalent series inductance (ESL). For example, we might model a 1uF capacitor with 1mΩ of ESR and 1nH of ESL as follows:</p>



<figure><img data-attachment-id="2157" data-permalink="https://codeinsecurity.wordpress.com/2025/01/25/proper-decoupling-practices-and-why-you-should-leave-100nf-behind/image-47/" data-orig-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-1.png" data-orig-size="331,92" data-comments-opened="0" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-1.png?w=300" data-large-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-1.png?w=331" loading="lazy" width="331" height="92" src="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-1.png?w=331" alt="Circuit diagram with resistance, inductance, and capacitance in series." srcset="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-1.png 331w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-1.png?w=150 150w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-1.png?w=300 300w" sizes="(max-width: 331px) 100vw, 331px"/></figure>



<p>The impedance of an ideal inductor is given by the following formula:</p>


<p><img src="https://s0.wp.com/latex.php?latex=%7CZ_L%7C+%3D+2+%5Cpi+f+L+&amp;bg=ffffff&amp;fg=495762&amp;s=2&amp;c=20201002" srcset="https://s0.wp.com/latex.php?latex=%7CZ_L%7C+%3D+2+%5Cpi+f+L+&amp;bg=ffffff&amp;fg=495762&amp;s=2&amp;c=20201002 1x, https://s0.wp.com/latex.php?latex=%7CZ_L%7C+%3D+2+%5Cpi+f+L+&amp;bg=ffffff&amp;fg=495762&amp;s=2&amp;c=20201002&amp;zoom=4.5 4x" alt="|Z_L| = 2 \pi f L "/></p>



<p>Where <em>L</em> is the inductance in Henries. It should be clear from this formula that the impedance of an inductor rises linearly with frequency, with a gradient proportional to the inductance.</p>



<p>Note: Again, this is a simplified version of the formula, with the complex portion skipped. It is sufficient to illustrate the points in this post.</p>



<p>If we sum the three series impedances together, we get:</p>


<p><img src="https://s0.wp.com/latex.php?latex=%7CZ%7C+%3D+R+%2B+%7CZ_L%7C+%2B+%7CZ_C%7C+&amp;bg=ffffff&amp;fg=495762&amp;s=2&amp;c=20201002" srcset="https://s0.wp.com/latex.php?latex=%7CZ%7C+%3D+R+%2B+%7CZ_L%7C+%2B+%7CZ_C%7C+&amp;bg=ffffff&amp;fg=495762&amp;s=2&amp;c=20201002 1x, https://s0.wp.com/latex.php?latex=%7CZ%7C+%3D+R+%2B+%7CZ_L%7C+%2B+%7CZ_C%7C+&amp;bg=ffffff&amp;fg=495762&amp;s=2&amp;c=20201002&amp;zoom=4.5 4x" alt="|Z| = R + |Z_L| + |Z_C| "/></p>


<p><img src="https://s0.wp.com/latex.php?latex=%7CZ%7C+%3D+R+%2B+2+%5Cpi+f+L+%2B+%5Cfrac%7B1%7D%7B2+%5Cpi+f+C%7D+&amp;bg=ffffff&amp;fg=495762&amp;s=2&amp;c=20201002" srcset="https://s0.wp.com/latex.php?latex=%7CZ%7C+%3D+R+%2B+2+%5Cpi+f+L+%2B+%5Cfrac%7B1%7D%7B2+%5Cpi+f+C%7D+&amp;bg=ffffff&amp;fg=495762&amp;s=2&amp;c=20201002 1x, https://s0.wp.com/latex.php?latex=%7CZ%7C+%3D+R+%2B+2+%5Cpi+f+L+%2B+%5Cfrac%7B1%7D%7B2+%5Cpi+f+C%7D+&amp;bg=ffffff&amp;fg=495762&amp;s=2&amp;c=20201002&amp;zoom=4.5 4x" alt="|Z| = R + 2 \pi f L + \frac{1}{2 \pi f C} "/></p>



<p>If we graph this for our example 1uF capacitor, with 1nH of parasitic inductance and 1mΩ of parasitic resistance, we get the following:</p>



<figure><img data-attachment-id="2163" data-permalink="https://codeinsecurity.wordpress.com/2025/01/25/proper-decoupling-practices-and-why-you-should-leave-100nf-behind/untitled-1-4/" data-orig-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-4.png" data-orig-size="800,800" data-comments-opened="0" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="Untitled-1" data-image-description="" data-image-caption="" data-medium-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-4.png?w=300" data-large-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-4.png?w=800" loading="lazy" width="800" height="800" src="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-4.png?w=800" alt="A log-log graph of impedance vs. frequency. The impedance of the capacitor (red line) falls with frequency. The impedance of the inductor (blue line) increases with frequency. They cross over at around 5MHz. The overall impedance (black line) is the sum of the two, resulting in a V-shaped plot." srcset="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-4.png 800w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-4.png?w=150 150w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-4.png?w=300 300w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-4.png?w=768 768w" sizes="(max-width: 800px) 100vw, 800px"/></figure>



<p>The red line shows the impedance of the capacitance. The blue line shows the impedance of the parasitic inductance. The two cross over at around 5MHz; we call this the self-resonant frequency (SRF) of the capacitor. The black line shows the overall impedance of the capacitor, i.e. the sum of the two impedances. This parasitic inductance prevents real capacitors from being as effective at very high frequencies.</p>



<p>Now let’s look at what happens if we reduce the parasitic inductance by a factor of ten:</p>



<figure><img data-attachment-id="2173" data-permalink="https://codeinsecurity.wordpress.com/2025/01/25/proper-decoupling-practices-and-why-you-should-leave-100nf-behind/untitled-1-5/" data-orig-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-5.png" data-orig-size="800,800" data-comments-opened="0" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="Untitled-1" data-image-description="" data-image-caption="" data-medium-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-5.png?w=300" data-large-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-5.png?w=800" loading="lazy" width="800" height="800" src="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-5.png?w=800" alt="A log-log graph of impedance vs. frequency, similar to the previous one. A second line (purple) has been added for the lower inductance. The new plot shows that the SRF shifts to a higher frequency, with a lower overall minimum impedance at the SRF." srcset="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-5.png 800w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-5.png?w=150 150w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-5.png?w=300 300w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/untitled-1-5.png?w=768 768w" sizes="(max-width: 800px) 100vw, 800px"/></figure>



<p>The lower inductance (purple line) shifts the self-resonant frequency higher and allows for a lower impedance at higher frequencies. This fact is absolutely critical to good decoupling. The more inductance you have in your decoupling path, the higher its impedance will be at higher frequencies. This is why you must place your decoupling capacitors as close to the load as possible, ideally across adjacent ground and power pins in the case of an IC. The shorter the loop, the less parasitic inductance in the path, and the better your decoupling will perform. This is not the only factor though, as we will see shortly.</p>



<p>It is worth noting that the series RLC model is simplistic. In practice, the parasitic resistance varies quite a bit with frequency, and the effective inductance and capacitance vary a little with frequency too. There is also some resonant interplay between the capacitance and inductance, which is better described by the complex form of the equations that I skipped over. The details of this are beyond the scope of this blog post. For now, the important part is that we have this V-shaped plot, where the impedance of the capacitor drops as we approach the self-resonant frequency, then climbs again as the impedance of the parasitic inductance becomes the dominant effect.</p>



<p>We can see this same effect in a real capacitor, albeit with a slightly different shape due to the aforementioned frequency-dependent phenomena:</p>



<figure><img data-attachment-id="2168" data-permalink="https://codeinsecurity.wordpress.com/2025/01/25/proper-decoupling-practices-and-why-you-should-leave-100nf-behind/image-49/" data-orig-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-3.png" data-orig-size="737,373" data-comments-opened="0" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-3.png?w=300" data-large-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-3.png?w=737" loading="lazy" width="737" height="373" src="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-3.png?w=737" alt="Impedance plot for a 1uF capacitor, from Samsung WebLib. The curve has the similar V-shape but with a shaper notch around the SRF." srcset="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-3.png 737w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-3.png?w=150 150w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-3.png?w=300 300w" sizes="(max-width: 737px) 100vw, 737px"/></figure>



<p>This graph was produced using the <a href="https://weblib.samsungsem.com/mlcc/mlcc-ec.do">Samsung WebLib MLCC tool</a>, and shows the impedance profile of a CL05A105KA5NQN 1uF 25V 0402 capacitor.</p>



<p>You may notice that there’s a “dip” around the self-resonant frequency which doesn’t appear in the model graphs. This is where that phase relationship between inductance and capacitance becomes apparent, and where the simplified equation I showed doesn’t quite match the more in-depth model. Luckily we don’t have to worry too much about it for the purposes of this blog post, because manufacturer-provided impedance plots show us the <em>real</em> behaviour, incorporating properties that go beyond even the complex impedance model.</p>



<p>Now let’s add a plot for another capacitor that has the exact same specs but in 0603 – the CL10A105KA8NNN.</p>



<figure><img data-attachment-id="2181" data-permalink="https://codeinsecurity.wordpress.com/2025/01/25/proper-decoupling-practices-and-why-you-should-leave-100nf-behind/image-52/" data-orig-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-6.png" data-orig-size="1224,604" data-comments-opened="0" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-6.png?w=300" data-large-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-6.png?w=900" loading="lazy" width="1024" height="505" src="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-6.png?w=1024" alt="Impedance plot for two capacitors, one 0402 (red) and the other 0603 (blue)." srcset="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-6.png?w=1024 1024w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-6.png?w=150 150w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-6.png?w=300 300w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-6.png?w=768 768w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-6.png 1224w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>The blue line here is the 0603 package, the red is the 0402. Notice how the 0603 package capacitor’s SRF is shifted left, and its impedance in the inductive region (right hand side) is higher. This is due to higher parasitic inductance – the 0402 has around 320pH of parasitic inductance, whereas the 0603 has around 475pH of parasitic inductance. The parasitic inductance in a ceramic capacitor is almost always proportional to its physical size. I have previously published <a href="https://chaos.social/@gsuberland/112975046998489674">rules of thumb for parasitic inductance versus package size</a>, and the correlation is strong.</p>



<p>The importance of the capacitor package size does double duty here. Not only does the capacitor itself end up having lower parasitic inductance, but the smaller size often allows you to reduce the length of the traces between it and the load, thus reducing the overall loop size for high frequency currents. This minimises the impedance of the decoupling path, improving PDN integrity and confining fields that would otherwise spread out and cause crosstalk or EMI issues.</p>



<p>One thing you might notice from the graph above is that the 0603 package capacitor has slightly lower impedance on the left side of the graph, at frequencies below its SRF. This is due to DC bias derating – a topic I covered in detail as part of my <em><a href="https://codeinsecurity.wordpress.com/2023/03/16/notes-on-capacitors-part-1-ceramics-mlccs/">Notes on capacitors, part 1: ceramics &amp; MLCCs</a></em> post. In short, class 2 ceramic capacitors (X5R, X7R, etc. rather than C0G/NP0) suffer from DC bias derating, whereby the effective capacitance drops as the DC voltage across the capacitor increases. This phenomenon is directly tied to the volume of the dielectric material within the capacitor, so physically larger capacitors are generally able to provide more capacitance at a given higher DC bias voltage. The graphs above were generated for a DC bias of 3.3V, which results in effective capacitances of 785nF and 680nF for the 0603 and 0402 package components respectively. If you think back to the equation for capacitor impedance from earlier, this explains why the 0603 part has a slightly steeper downward gradient.</p>



<p>Note: bias derating <em>only</em> applies to class 2 ceramic capacitors, not other types of capacitors. But these are the type we tend to use for decoupling in most cases.</p>



<p>At this point, you might be wondering what we’re supposed to do about frequencies in the hundreds of MHz or even GHz. You may also be wondering why I largely glossed over the third of the parasitic properties within your board traces: capacitance. Well, here’s where those two details combine. Your power delivery traces couple capacitatively to the ground plane beneath them (you <em>are</em> using ground planes, right? if not, please go watch <a href="https://resources.altium.com/p/2-the-extreme-importance-of-pc-board-stack-up">The Extreme Importance Of PC Board Stackup by Rick Hartley</a>… or just go watch it anyway, because it’s the best electronics talk I’ve ever seen, and everyone needs to see it) and this interplanar capacitance acts as inbuilt decoupling within the board. The amount of capacitance is very small, but it is distributed across the board and fairly effective at decoupling very high frequency currents as long as your board stackup is good. The exact details here get <em>very</em> involved, requiring the use of field solvers to model properly, so I won’t get into that particular rabbit hole here.</p>



<p>Still with me? Good, because we’re finally in a position to talk about why 100nF is so outdated. Here’s an impedance plot for the two capacitors we already discussed, plus a 100nF 0402 capacitor (red trace).</p>



<figure><img data-attachment-id="2185" data-permalink="https://codeinsecurity.wordpress.com/2025/01/25/proper-decoupling-practices-and-why-you-should-leave-100nf-behind/image-53/" data-orig-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-7.png" data-orig-size="1186,713" data-comments-opened="0" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-7.png?w=300" data-large-file="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-7.png?w=900" loading="lazy" width="1024" height="615" src="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-7.png?w=1024" alt="Impedance plot for three capacitors - the two 1uF capacitors from before, plus a 100nF 0402 capacitor of the same voltage rating. The 100nF capacitor has a higher SRF, but its impedance is signficiantly higher than the others outside a small region between 25MHz and 40MHz." srcset="https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-7.png?w=1024 1024w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-7.png?w=150 150w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-7.png?w=300 300w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-7.png?w=768 768w, https://codeinsecurity.wordpress.com/wp-content/uploads/2025/01/image-7.png 1186w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>Well, uh, it’s ok at about 25-40MHz, I guess?</p>



<p>Obviously this just plain sucks compared to the 1uF capacitors, so why on earth has 100nF been the recommended decoupling capacitor for the last 40-something years? Why was it <em>ever</em> considered good?</p>



<p>The answer boils down to a few different technical, financial, and human reasons.</p>



<p>Back in the 80s, ceramic capacitors weren’t anywhere near as good. They had much lower capacitance density, worse DC bias characteristics, their impedance was much higher, and good ones cost more money. Modern MLCCs are orders of magnitude higher density, they’re heavily mass-produced, and the unit cost has gotten so low that there’s no point comparing the pricing between parts for common values at low voltages. 100nF became popular at the time because it was a common, easy-to-remember value part that had good enough DC bias properties and impedance for decoupling the emerging low-cost CMOS devices of the time, and it didn’t cost a lot.</p>



<p>This is also where the infamous big/little practice arose. When 100nF wasn’t enough, you’d add a 1uF capacitor in parallel. The reason for doing this back then was because you couldn’t get 1uF of low impedance capacitance. You couldn’t fit 1uF in a small package, so the parasitic inductance was high and it didn’t make for a very good decoupling cap. Now? It’s trivial. In a recent design I needed a decoupling capacitor for a 3.3V microcontroller, so I picked the <a href="https://product.samsungsem.com/mlcc/CL05A106MQ5NUN.do">CL05A106MQ5NUN</a>. This 0402 capacitor has around 3.5uF of effective capacitance at 3.3V bias. It costs $0.0041/pc (yes, that’s zero point four one pennies) from LCSC at the time of writing, and you can buy a full reel of ten thousand for about $20. This isn’t necessarily the most optimal part here, but it’s way better than a 100nF. For most low voltage power rails there’s no benefit at all from placing a small (&lt;1uF) decoupling capacitor and then a large (&gt;1uF) decoupling capacitor next to that. Since the cost of the parts is so incredibly low, it’s often <em>more expensive</em> to place two parts than to just place one higher density part, either due to the cost of the parts themselves or the additional assembly fees and board size increase. The parasitic inductance in the traces going to the further away capacitor ends up being much greater than the parasitic inductance in the capacitors themselves, so the effective SRF of the further away capacitor shifts lower, making it less effective for decoupling. To make matters worse, modern MLCCs are so incredibly low impedance that placing two very close together can lead to undamped resonances, leading to an <em>increase</em> in noise at certain frequencies. The details of this are beyond the scope of this blog post, but it’s a topic that you should be able to find information on with a quick search (even with the miserable state of search engines these days) if you’re interested.</p>



<p>Another difference between now and then is the rise and fall times. Modern commodity ICs have very fast rise and fall times compared to equivalent commodity ICs from the 80s. This is partly due to more modern MOSFET construction techniques that improve switching speeds and efficiency, but also came as a side-effect of die shrinks, where manufacturers use physically smaller transistors in order to squeeze more chips out of a silicon wafer. As a result, the dI/dt generated by your average digital IC has skyrocketed in the past 40 years. The parasitic inductance in your PCB traces, on the other hand, remains immutably governed by electromagnetic field physics, and hasn’t changed much. If you take a circuit design from the 80s or 90s, made with parts from that era, and measure its EMI, it probably won’t look all that bad. If you take the exact same circuit design and replace the ICs with modern equivalents that have undergone die shrinks, suddenly the EMI will look a lot worse. The <em>bandwidth</em> your average electronic device has gone up a lot over time, simply due to die shrinks. There are simply more high frequency currents flying around your board today.</p>



<p>“But Graham,” I hear you protest, “I see these practices recommended in vendor’s datasheets all the time! Surely they can’t be wrong? They’re professionals!”</p>



<p>This is, to a certain extent, an example of <a href="https://skeptics.stackexchange.com/questions/6828/was-the-experiment-with-five-monkeys-a-ladder-a-banana-and-a-water-spray-condu">the (probably apocryphal) parable of the five monkeys</a>, in which a practice or rule of thumb becomes important and reliable for good reasons, but pervades long after the practice becomes outdated because nobody remembers why it started in the first place. But to write it off as <em>only</em> that would be overly cynical.</p>



<p>I personally prefer to be a bit more charitable. I think this practice has pervaded because we all have a certain amount of cognitive bandwidth that we can allocate to each task, and one of the key strategies we have as humans for completing those tasks is to eliminate unnecessary cognitive load where we can. The 100nF value for decoupling became so entrenched because <em>it works well enough* most of the time</em>, so you don’t need to even think about it. By eliminating trivialities you can focus your brain-juices, spoons, or whatever else you want to call them on more challenging tasks.</p>



<p>As a corollary to this, most people don’t spend years digging into the minute details of capacitor properties, materials, and related physics phenomena. I did because my ADHD-riddled brain gets fixated on weird things, but not everyone wants or needs to know the gritty details behind every little thing, and that’s fine. In fact, that’s good and <em>literally mandatory for us to function</em>. If everyone was compelled to understand every detail of every device and system around them we’d all be crushed under the mental weight of it all. This applies to everyone, including the folks who write IC datasheets, and I want you to feel confident in ignoring their outdated advice not because they’re stupid, but because they just haven’t gotten around to updating their understanding and are sticking with a practice that feels safe.</p>



<p>Now, when I said that 100nF “works well enough” above, what I really mean is your circuit usually doesn’t completely break if you use a 100nF decoupling capacitor. But given that the cost to use a larger, better capacitor is effectively nil in most cases, you can keep experiencing that exact same level of cognitive load avoidance by just using 1uF or 2.2uF instead, in the smallest capacitor package that is practical for the voltage and assembly constraints you have, and placing it right up against the power pins. It’s free real estate, or something.</p>



<p>There are two cases where I would recommend caution:</p>



<ol>
<li>If you have a lot of devices powered off a single rail, placing lots of high-value decoupling capacitors will add up, so pay attention to inrush current. If you’re sticking 10uF decoupling caps on 20 devices then that’s 200uF. Maybe dial it back a smidge.</li>



<li>Don’t put a bunch of high-value MLCCs really close to the output of a linear regulator or a switching regulator’s feedback network. This reduces the phase margin of the control loop. Consult the datasheet and the part vendor’s simulation tools for exact details, but as a rule of thumb physically moving the large MLCCs away from those areas by a small distance will drastically improve the phase margin, because the parasitic inductance in the traces acts to decouple that extra capacitance from the control loop.</li>
</ol>



<p>I had planned to finish this piece off by going through some examples of cases where you might want to buck the trend and use multiple capacitors or smaller specialised capacitors, such as combining dielectric classes, but honestly if you’re in that camp then you probably already know what you’re doing anyway, and this post is <em>far</em> too long as it stands. It has taken me literal years to write a coherent version that didn’t get lost in the weeds. In fact I’m so happy about completing this post that I actually went and made myself a nice dinner to celebrate.</p>



<p>I shall see you all in the year 2055 when I have to write a companion piece called <em>“… and why you should also leave 10uF behind”</em>.</p>



<hr/>



<p>Thanks for reading this post! If you enjoyed it and want to say thanks, consider purchasing some of <a href="https://unsafewarnings.etsy.com">my amusing warning stickers</a>. They’re 100% guaranteed to not to cause superpowers in sea creatures.</p>
			</div><!-- .entry-content -->

	<!-- .entry-footer -->
</article></div>
  </body>
</html>
