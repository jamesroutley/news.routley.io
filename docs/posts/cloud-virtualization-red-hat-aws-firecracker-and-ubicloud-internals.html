<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.ubicloud.com/blog/cloud-virtualization-red-hat-aws-firecracker-and-ubicloud-internals">Original</a>
    <h1>Cloud Virtualization: Red Hat, AWS Firecracker, and Ubicloud internals</h1>
    
    <div id="readability-page-1" class="page"><div data-animation="default" data-collapse="medium" data-duration="400" data-easing="ease" data-easing2="ease" data-doc-height="1" role="banner"><div><p>EuroGPT Enterprise is open source, runs in Europe, and keeps your data private. <a href="https://www.ubicloud.com/use-cases/eurogpt-enterprise">Try it now</a></p></div><div><div><p><a href="https://www.ubicloud.com/"><img src="https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/64fe48116c52fe1a51e17279_ubicolud%20logo.png" loading="lazy" alt=""/></a></p></div></div></div><section><div><div><div id="w-node-decdb48f-56e8-4c35-c577-932285e9b439-1c4dd7e7"><p>January 24, 2025 · 8 min read</p><div><p><img src="https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6532565d769b11880570700b_oz-headshot.jpeg" loading="lazy" alt=""/></p><div><p>Ozgun Erdogan</p><p>Co-founder / Co-CEO</p></div></div><div><p>VMs are much harder to understand today than they were back in 2009. Linux provides many building blocks for virtualization, but only a select few kernel engineers know how to stitch them together.</p><ul role="list"><li>Know about dozens of complex Linux projects that interact with each other.</li><li>Combine these projects to achieve a multi-dimensional goal - operational and security isolation across CPU, memory, disk, and network.</li><li>Compare tradeoffs between different projects and VM solutions. This is hard given the problem space’s combinatorial complexity.</li></ul><p>So, we sifted through dozens of manual pages, Linux projects, blog posts, and papers. We then compiled our understanding into this blog that describes four reference architectures - Red Hat, AWS Firecracker, Ubicloud, and AWS Nitro. This document helped our team understand in a “concise” way how people put together decade(s) of work in the virtualization space. Hopefully, it will help you too.</p><p><a href="#some-terminology">Some Terminology</a><a href="#Red-Hat-Reference-Architecture">Red Hat Reference Architecture</a><a href="#aws-firecracker">AWS Firecracker</a><a href="#ubicloud-compute">Ubicloud Compute</a><a href="#aws-ec2-nitro">AWS EC2 Nitro</a><a href="#conclusion">Conclusion</a><a href="#key-references">Key References</a><br/></p></div><div id="some-terminology"><h3>Some Terminology</h3><p>There’s quite a bit of confusion around the terminology used for virtualization solutions. So, we’ll share <em>our</em> terminology first. We consider a virtualization solution to include a hypervisor kernel, virtual machine monitor (VMM), and device drivers. For brevity, we may refer to the hypervisor kernel just as the hypervisor in this blog post.</p><p><img src="https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6793577656c775d6e3e33d45_Some%20terminology-min.jpg" loading="lazy" sizes="(max-width: 479px) 93vw, (max-width: 767px) 97vw, (max-width: 991px) 94vw, (max-width: 1439px) 58vw, 748.7890625px" srcset="https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6793577656c775d6e3e33d45_Some%20terminology-min-p-500.jpg 500w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6793577656c775d6e3e33d45_Some%20terminology-min-p-800.jpg 800w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6793577656c775d6e3e33d45_Some%20terminology-min-p-1080.jpg 1080w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6793577656c775d6e3e33d45_Some%20terminology-min-p-1600.jpg 1600w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6793577656c775d6e3e33d45_Some%20terminology-min-p-2000.jpg 2000w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6793577656c775d6e3e33d45_Some%20terminology-min.jpg 2746w" alt=""/></p><p>VMs are used to isolate workloads from one another; and workload isolation comes in two types.</p></div><div id="sign-up-and-sign-in"><h3 id="Red-Hat-Reference-Architecture">Red Hat Reference Architecture</h3><p><img src="https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6793577671e6148615d5743b_Red%20hat-min.jpg" loading="lazy" sizes="(max-width: 479px) 93vw, (max-width: 767px) 97vw, (max-width: 991px) 94vw, (max-width: 1439px) 58vw, 748.7890625px" srcset="https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6793577671e6148615d5743b_Red%20hat-min-p-500.jpg 500w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6793577671e6148615d5743b_Red%20hat-min-p-800.jpg 800w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6793577671e6148615d5743b_Red%20hat-min-p-1080.jpg 1080w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6793577671e6148615d5743b_Red%20hat-min-p-1600.jpg 1600w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6793577671e6148615d5743b_Red%20hat-min-p-2000.jpg 2000w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6793577671e6148615d5743b_Red%20hat-min.jpg 2746w" alt=""/></p><p>Red Hat’s “<a href="https://www.redhat.com/en/blog/all-you-need-know-about-kvm-userspace">All you need to know about KVM userspace</a>” is one of the most referenced articles on the internet about open source virtualization. The article also describes RedHat’s reference VM architecture.</p><ul role="list"><li>Hardware virtualization interface: Leverages CPU features (Intel VT-x or AMD-V) for hardware assisted full virtualization. Provides the mechanism to create and manage VMs through an interface to QEMU</li><li>CPU and memory virtualization: Ensures isolation and efficient use of these resources</li><li>Other kernel level features: These include handling VM exits, VM scheduling, translating and routing interrupts to virtual devices. They also include exposing certain kernel level features to QEMU, such as memory management and process scheduling</li></ul><p><strong>QEMU (Quick EMUlator)</strong> operates in user space. It acts both as a device emulator and virtual machine monitor (VMM).</p><ul role="list"><li>Device emulation: Emulates the hardware that the guest OS will interact with. This includes disk drives, network interfaces, and GPUs</li><li>VM creation and management: Initializes and runs VMs. Set up the environment for guest OS to run</li><li>Performance optimizations: When used with KVM, QEMU can pass through hardware calls directly to KVM</li></ul><p>Using a hypervisor kernel (KVM) along with a VMM (QEMU) in user space is quite typical. For QEMU, the Red Hat architecture diagram doesn’t specify how block devices are emulated. <a href="https://www.redhat.com/en/blog/virtio-devices-and-drivers-overview-headjack-and-phone">Subsequent blog posts</a> from Red Hat indicate the use of <strong>virtio</strong> for this purpose.</p><ul role="list"><li><strong>cgroups (control groups) </strong>limits resource usage for a group of processes. These resources include CPU, memory, disk I/O, and network bandwidth. As such, cgroups helps with operational isolation.</li><li><strong>nftables</strong> filters and classifies network packets. This helps in providing firewall-like functionality and restricting network access to the host. You can think of nftables as a way to achieve security isolation, but from external resources rather than internal VMs running on the host.</li><li>For security isolation across VMs on the same host, Linux network namespaces and seccomp-bpf are typically used. These aren’t called out in Red Hat’s architecture, but we’ll talk more about them below.</li></ul></div><div id="aws-firecracker"><h3>AWS Firecracker</h3><p><a href="https://www.usenix.org/system/files/nsdi20-paper-agache.pdf">AWS Firecracker</a> is an open source VMM specialized for serverless workloads. It’s arguably Amazon’s most influential open source contribution.</p><p><img src="https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/67935776bd52e5ef4f0ab9cb_Firecracker-min.jpg" loading="lazy" sizes="(max-width: 479px) 93vw, (max-width: 767px) 97vw, (max-width: 991px) 94vw, (max-width: 1439px) 58vw, 748.7890625px" srcset="https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/67935776bd52e5ef4f0ab9cb_Firecracker-min-p-500.jpg 500w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/67935776bd52e5ef4f0ab9cb_Firecracker-min-p-800.jpg 800w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/67935776bd52e5ef4f0ab9cb_Firecracker-min-p-1080.jpg 1080w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/67935776bd52e5ef4f0ab9cb_Firecracker-min-p-1600.jpg 1600w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/67935776bd52e5ef4f0ab9cb_Firecracker-min.jpg 2746w" alt=""/></p><p>Firecracker aims to provide VM-level isolation guarantees <em>and</em> solve three challenges associated with virtualization. These are: (a) VMM and the kernel have high CPU and memory overhead for VMs, (b) VM startup takes seconds, and (c) hypervisors and VMMs can be large and complex, with a significant attack surface. They are also typically written in memory unsafe programming languages.</p><ul role="list"><li>Device emulation for disk, networking, and serial console (keyboard)</li><li>REST based configuration API to configure, manage, start and stop MicroVMs. This replaces some of the functionality offered by <em>libvirt</em></li><li>Rate limiting for network and disk. Can configure throughput and request rates. For this Firecracker implements its own solution for simplicity, rather than using <em>cgroups</em></li></ul><p>For network and block devices, Firecracker uses <em>virtio</em>. Virtio provides an open API for exposing emulated devices from hypervisors. Virtio is simple, scalable, and offers good performance through its use of paravirtualization.</p></div><div id="ubicloud-compute"><h3>Ubicloud Compute</h3><p><a href="https://www.ubicloud.com/docs/architecture/control-and-data-plane">Ubicloud</a> VMs share a lot of similarities with AWS Firecracker. From a security isolation perspective, we have a strong bias towards simple solutions that minimize the attack surface. We also believe in defense in depth.</p><p><img src="https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/67935776d1558b08fb7b19d7_Ubicloud%20VM-min.jpg" loading="lazy" sizes="(max-width: 479px) 93vw, (max-width: 767px) 97vw, (max-width: 991px) 94vw, (max-width: 1439px) 58vw, 748.7890625px" srcset="https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/67935776d1558b08fb7b19d7_Ubicloud%20VM-min-p-500.jpg 500w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/67935776d1558b08fb7b19d7_Ubicloud%20VM-min-p-800.jpg 800w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/67935776d1558b08fb7b19d7_Ubicloud%20VM-min-p-1080.jpg 1080w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/67935776d1558b08fb7b19d7_Ubicloud%20VM-min-p-1600.jpg 1600w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/67935776d1558b08fb7b19d7_Ubicloud%20VM-min.jpg 2746w" alt=""/></p><p>Ubicloud also uses KVM, but swaps out Firecracker with the Cloud Hypervisor (CH). A large part of the CH code is based on Firecracker. Both projects are also written in Rust.</p><ul role="list"><li>Can run both Linux and Windows distros (the Windows theory currently remains untested)</li><li>Supports a more diverse set of devices, including PCI passthrough for GPUs</li><li>Supports vhost-user devices: virtio backends in guest user space as separate processes</li><li>Supports guest backing by hugepages</li></ul><p>The control plane starts, stops, and manages VMs. Rather than REST APIs, we use SSH as the communication interface between the control plane and data plane. For reasons about our choice of SSH, you can watch PVH’s <a href="https://www.youtube.com/watch?v=twTWnZb0Ib4">Heroku architecture talk</a>.</p><p><img src="https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/659537fb1d646507b4bd5cb7_Ubicloud%20block%20storage%20v3.0.png" loading="lazy" sizes="(max-width: 479px) 93vw, (max-width: 767px) 97vw, (max-width: 991px) 94vw, (max-width: 1439px) 58vw, 748.7890625px" srcset="https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/659537fb1d646507b4bd5cb7_Ubicloud%20block%20storage%20v3.0-p-500.png 500w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/659537fb1d646507b4bd5cb7_Ubicloud%20block%20storage%20v3.0-p-800.png 800w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/659537fb1d646507b4bd5cb7_Ubicloud%20block%20storage%20v3.0-p-1080.png 1080w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/659537fb1d646507b4bd5cb7_Ubicloud%20block%20storage%20v3.0-p-1600.png 1600w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/659537fb1d646507b4bd5cb7_Ubicloud%20block%20storage%20v3.0.png 1920w" alt=""/></p><p>Finally, we take an additional set of steps to “sandbox” the Cloud Hypervisor (CH). We run CH as a regular Linux user on the host. We manipulate CH’s permissions in systemd and restrict its file system access through permissions. As mentioned earlier, we use network namespaces. CH also has seccomp-bpf built-in for syscall filtering. The Cloud Hypervisor project is already sensitive about its sycall footprint, so we don’t yet enable seccomp-bpf filtering.</p></div><div id="aws-ec2-nitro"><h3>AWS EC2 Nitro</h3><p>This blog post wouldn’t be complete without AWS EC2.</p><p><img src="https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/67935f693cb85125fefe0118_ec2.png" loading="lazy" sizes="(max-width: 479px) 93vw, (max-width: 767px) 97vw, (max-width: 991px) 75vw, (max-width: 1439px) 43vw, 561.578125px" srcset="https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/67935f693cb85125fefe0118_ec2-p-500.png 500w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/67935f693cb85125fefe0118_ec2-p-800.png 800w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/67935f693cb85125fefe0118_ec2-p-1080.png 1080w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/67935f693cb85125fefe0118_ec2.png 1238w" alt=""/></p><p>To optimize network and disk I/O on EC2 instances, AWS incrementally moved towards a model that <a href="https://www.youtube.com/watch?v=LabltEXk0VQ">offloaded these software devices to hardware</a>. This included first adding a network accelerator card to the host, next moving all network processing to a networking card, and then offloading calls to EBS to a remote storage card (2013 - 2016). Next, AWS offloaded the local storage device to a storage card (2017). These shifts to specialized hardware helped improve performance on the hosts, particularly for I/O bound workloads.</p><p><img src="https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6793601470290e73d3ccde40_ec2-2.png" loading="lazy" sizes="(max-width: 479px) 37vw, (max-width: 767px) 39vw, (max-width: 991px) 37vw, (max-width: 1439px) 29vw, 374.390625px" srcset="https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6793601470290e73d3ccde40_ec2-2-p-500.png 500w, https://cdn.prod.website-files.com/64f9d9b4e737e7b37d4e39a4/6793601470290e73d3ccde40_ec2-2.png 616w" alt=""/></p><p>Today, AWS Nitro hosts offload all device management to specialized cards. These accelerator cards provide higher performance than virtio devices. Further, AWS also offloads the task of managing and monitoring VMs to hardware. This offloading removes the need for a VMM like QEMU. (It however introduces the complexity of managing specialized cards.) So, AWS only runs a hypervisor that’s based on KVM on the host.</p></div><div id="conclusion"><h3>Conclusion</h3><p>AWS opened a new era with cloud computing. Then, as cloud virtualization became commonplace, customers needed more performance and better isolation guarantees. AWS Nitro delivered on that demand by offloading logic to specialized hardware. Other public cloud providers followed suit.</p></div></div></div></div></section></div>
  </body>
</html>
