<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://eclecticlight.co/2023/03/13/ventura-has-changed-app-quarantine-with-a-new-xattr/">Original</a>
    <h1>Ventura has changed app quarantine with a new xattr</h1>
    
    <div id="readability-page-1" class="page"><article id="post-70878">
	
	<!-- .entry-header -->

	
		<div data-first_letter="N">
		<p>Now that we’re approaching half time in Ventura’s cycle, it’s good that we’re still discovering new features that Apple forgot to mention at WWDC last June. This article outlines how macOS 13 has changed the process of app quarantine, with the addition of a new extended attribute to track the origin of quarantined apps in their provenance.</p>
<h4>Clearing quarantine</h4>
<p>What used to happen when a file was downloaded using Safari or another app that supports quarantine, was that an extended attribute of type <code>com.apple.quarantine</code> was added to the downloaded file. This contains the quarantine flag itself, indicating whether it’s set or has been cleared, the time of its attachment, the app or agent that attached the flag, and a UUID reference to an entry in the QuarantineEvents database at ~/Library/Preferences/com.apple.LaunchServices.QuarantineEventsV2.</p>
<p>When that app was run for the first time and underwent Gatekeeper’s full checks, if it was accepted, the quarantine flag was changed to indicate the app was no longer quarantined, and future launches of that app didn’t undergo full first run checks. For instance, the normal quarantine flag attached when a file transits AirDrop is 0081, and when that’s cleared it becomes 00c1. Other than that changed extended attribute, there seems to be no record kept of the clearance of that flag.</p>
<h4>Provenance</h4>
<p>What happens in macOS Ventura is essentially the same until the moment that quarantine is cleared, when macOS now attaches a new extended attribute (xattr) of type <code>com.apple.provenance</code> to the file. This contains an 11-byte binary reference unique to that quarantine event, and may be protected by SIP to make it persist and prevent it from being stripped.</p>
<p><span><img data-attachment-id="70880" data-permalink="https://eclecticlight.co/xattr01/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr01.jpg" data-orig-size="934,998" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="xattr01" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr01.jpg?w=281" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr01.jpg?w=934" src="https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr01.jpg?w=940" alt="xattr01" srcset="https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr01.jpg 934w, https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr01.jpg?w=140 140w, https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr01.jpg?w=281 281w, https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr01.jpg?w=768 768w" sizes="(max-width: 934px) 100vw, 934px"/></span></p>
<p>For example, when an app is transferred between Macs using AirDrop, any existing <code>com.apple.quarantine</code> xattr is replaced with a new one with its flag is set to 0081. When that app is successfully opened on the recipient Mac, and its quarantine flag is changed to 00c1, an 11-byte <code>com.apple.provenance</code> xattr is added and SIP may be applied to it to prevent its removal.</p>
<p>Some early releases of Ventura appear to have been more thorough in applying the <code>com.apple.provenance</code> xattr, and have added it to every folder and file within an app when it was taken out of quarantine; in that situation, the 11-byte identifier is identical across all files and folders taken out of quarantine in that app. Behaviour in macOS 13.2.1 currently appears limited to attaching just a single <code>com.apple.provenance</code> xattr to the .app folder. You may also come across apps in which the original <code>com.apple.quarantine</code> xattrs have been stripped, leaving just the protected <code>com.apple.provenance</code> xattrs behind.</p>
<p><span><img data-attachment-id="70881" data-permalink="https://eclecticlight.co/xattr02/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr02.jpg" data-orig-size="1706,1080" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="xattr02" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr02.jpg?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr02.jpg?w=940" src="https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr02.jpg?w=940" alt="xattr02" srcset="https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr02.jpg?w=940 940w, https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr02.jpg?w=150 150w, https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr02.jpg?w=300 300w, https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr02.jpg?w=768 768w, https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr02.jpg?w=1024 1024w, https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr02.jpg 1706w" sizes="(max-width: 940px) 100vw, 940px"/></span></p>
<h4>Removal</h4>
<p>Defeating any SIP protection is simple for the user: when an app with a protected <code>com.apple.provenance</code> xattr is copied to another volume, the SIP protection breaks, and the xattr can be deleted in the normal way. However, code that tries to remove that xattr while it’s still protected may fail, and that has resulted in problems reported in Ventura by some users.</p>
<p>Unlike the other <code>com.apple.macl</code> xattr that can be attached to any file as part of TCC’s privacy protections, and is also protected by SIP, <code>com.apple.provenance</code> should only ever be attached to apps and their contents. It always seems to be just 11 bytes in size, although in one case rose to 4096 bytes through trailing padding with zeros, presumably as the result of an error on the part of macOS.</p>
<p><span><img data-attachment-id="70882" data-permalink="https://eclecticlight.co/xattr03/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr03.png" data-orig-size="869,239" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="xattr03" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr03.png?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr03.png?w=869" src="https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr03.png?w=940" alt="xattr03" srcset="https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr03.png 869w, https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr03.png?w=150 150w, https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr03.png?w=300 300w, https://eclecticlightdotcom.files.wordpress.com/2023/03/xattr03.png?w=768 768w" sizes="(max-width: 869px) 100vw, 869px"/></span></p>
<p>The purpose and use of the <code>com.apple.provenance</code> xattr is currently unknown, and appears to be still evolving. I’d be very interested to hear of other evidence of its behaviour and use in quarantine.</p>
<h4>Summary</h4>
<ul>
<li>Ventura introduces a new extended attribute <code>com.apple.provenance</code>, attached to apps when they clear quarantine.</li>
<li>The xattr contains binary data of 11 bytes that is unique to that quarantine event.</li>
<li>The xattr is protected by SIP, so can’t be removed unless the app is copied to another volume.</li>
<li>It’s otherwise undocumented, and its purpose and use are unknown.</li>
</ul>
<p><em>GUI access to xattrs and the crawler used above are features of my free utility <a href="https://eclecticlight.co/xattred-sandstrip-xattr-tools/">xattred</a>.</em></p>
<p><strong><em>Postscript</em></strong></p>
<p>I’m very grateful to Randy Saldinger of <a href="https://mothersruin.com" target="_blank">Mothers Ruin</a> for pointing out that SIP isn’t always applied to the <code>com.apple.provenance</code> xattr. I’m not sure whether this only occurs in certain circumstances, or in earlier versions of Ventura, but has been a previous cause of complaint about this xattr.</p>
<p>Randy has also identified the binary content of this new xattr as containing an 8-byte integer that is that app’s primary key in the provenance_tracking table in /var/db/SystemPolicyConfiguration/ExecPolicy. This would enable macOS to check the previous cdhash and other information about the app, perhaps to determine whether fuller checks are required by Gatekeeper, when the app is launched on subsequent occasions. That would make it a key part of Ventura’s new extended Gatekeeper checks.</p>
<p>Please read Randy’s comments below for further information.</p>
	</div><!-- .entry-content -->

	
	<!-- .entry-footer -->

</article></div>
  </body>
</html>
