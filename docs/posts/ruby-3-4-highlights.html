<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.sinjakli.co.uk/2025/01/01/ruby-3-4-highlights/">Original</a>
    <h1>Ruby 3.4 Highlights</h1>
    
    <div id="readability-page-1" class="page"><div>
      <div>
        <div>

  

  <article>
    <p>Alright, you know the drill. The Ruby team do the hard work of putting together a new version packed with features and I pick my favourites and write about them.</p>

<p>If you’d like to read the full set of changes, they’re <a href="https://www.ruby-lang.org/en/news/2024/12/25/ruby-3-4-0-released/">over on the Ruby project website</a>. There’s plenty more good stuff in there—these were just the changes that stood out to me.</p>

<h3 id="default-block-parameter-name">Default block parameter name</h3>

<p>In many situations where we pass a block in Ruby, that block receives a single argument (<code>each</code>, <code>map</code>, <code>filter</code>, etc). A lot of the time, we end up giving that argument a fairly generic name like <code>item</code> because we know that we’re working through items in a list.</p>

<div><div><pre><code><span>[</span>
  <span>&#34;beige chinos&#34;</span><span>,</span>
  <span>&#34;blue jorts&#34;</span><span>,</span>
  <span>&#34;rainbow jorts&#34;</span><span>,</span>
<span>].</span><span>filter</span> <span>{</span> <span>|</span><span>item</span><span>|</span> <span>item</span> <span>=~</span> <span>/jorts/</span> <span>}</span>
<span># =&gt; [&#34;blue jorts&#34;, &#34;rainbow jorts&#34;]</span>
</code></pre></div></div>

<p>In Ruby 3.4, <code>it</code> has been <a href="https://bugs.ruby-lang.org/issues/18980">added as a default name</a> for the first parameter passed to a block. Rather than specifying a name in trivial cases like the one above, you can now write:</p>

<div><div><pre><code><span>[</span>
  <span>&#34;beige chinos&#34;</span><span>,</span>
  <span>&#34;blue jorts&#34;</span><span>,</span>
  <span>&#34;rainbow jorts&#34;</span><span>,</span>
<span>].</span><span>filter</span> <span>{</span> <span>it</span> <span>=~</span> <span>/jorts/</span> <span>}</span>
<span># =&gt; [&#34;blue jorts&#34;, &#34;rainbow jorts&#34;]</span>
</code></pre></div></div>

<h3 id="better-connection-handling-happy-eyeballs-version-2">Better connection handling: “Happy Eyeballs Version 2”</h3>

<p>I’ll be honest: the reason this made my list this year is that seeing it in the changelog pointed me to an interesting RFC that I hadn’t heard of before! I spent a couple of hours down a rabbit hole reading RFCs and a few snippets of source code and I thought it was worth talking about.</p>

<p>Ruby 3.4 adds an implementation of <a href="https://datatracker.ietf.org/doc/html/rfc8305">RFC8305</a> (<em>Happy Eyeballs Version 2: Better Connectivity Using Concurrency</em>) to its TCP socket implementation.</p>

<p>In a nutshell, the RFC is an attempt at describing a way for clients to handle multiple IP addresses being returned by DNS queries, particularly in the context of a dual-stack (IPv4 and IPV6) network. It describes how to make the DNS requests<sup id="fnref:a-vs-aaaa" role="doc-noteref"><a href="#fn:a-vs-aaaa" rel="footnote">1</a></sup>, how to order the addresses returned by them, and how to kick off concurrent connection attempts to those addresses in a way that balances giving the user a response quickly with not creating pointless load on servers<sup id="fnref:avoiding-overload" role="doc-noteref"><a href="#fn:avoiding-overload" rel="footnote">2</a></sup>.</p>

<p>RFC8305 builds on the earlier <a href="https://datatracker.ietf.org/doc/html/rfc6555">RFC6555</a>. RFC6555 talked in relatively high-level terms about what’s needed in an algorithm that uses a hostname to establish a connection in a dual-stack environment and made reference to an approach shared by Mozilla Firefox and Google Chrome at the time. RFC8305 goes beyond that and provides much more concrete descriptions of what should be done at each stage.</p>

<p>One thing I really like about their approach is that they provide <a href="https://datatracker.ietf.org/doc/html/rfc8305#section-8">sensible default values</a> for each of the tunable parameters of their algorithm, which were reached through empirical measurement of connection timings across a wide range of devices. A company with the reach of Apple, where this RFC originated, is well-placed to take measurements at the scale needed to find widely applicable defaults. It’s great to see the effort put into making the output of their work useful beyond the walls of their company.</p>

<p>I’m less bullish about the IPv6 transition than some of my friends. If that transition is going to be successful, it involves an unavoidable period of running dual-stack networks<sup id="fnref:maybe-avoidable" role="doc-noteref"><a href="#fn:maybe-avoidable" rel="footnote">3</a></sup>. When doing so caused trouble on my home network, I switched IPv6 off rather than trying to debug it<sup id="fnref:on-my-todo-list" role="doc-noteref"><a href="#fn:on-my-todo-list" rel="footnote">4</a></sup>. If we want people to embrace dual-stack networks—and ultimately IPv6—we need socket libraries that do the right thing by default.</p>

<h3 id="clearer-exception-backtraces">Clearer exception backtraces</h3>

<p>Okay, we’re done with the rabbit hole and we’ve got a simple one to round things off.</p>

<p>In Ruby 3.4, exception backtraces <a href="https://bugs.ruby-lang.org/issues/19117">include the method owner</a> (class or module) as well as the name of the method that an exception was raised from.</p>

<p>Let’s look at some code that raises an exception:</p>

<div><div><pre><code><span>module</span> <span>Foo</span>
  <span>class</span> <span>Bar</span>
    <span>def</span> <span>inspect</span>
      <span>1</span> <span>+</span> <span>&#39;1&#39;</span>
    <span>end</span>
  <span>end</span>
<span>end</span>

<span>p</span> <span>Foo</span><span>::</span><span>Bar</span><span>.</span><span>new</span>
</code></pre></div></div>

<p>In Ruby 3.3 and earlier, this would print a backtrace like:</p>

<div><div><pre><code>/tmp/foo.rb:4:in `+&#39;: String can&#39;t be coerced into Integer (TypeError)
	from /tmp/foo.rb:4:in `inspect&#39;
	from /tmp/foo.rb:9:in `p&#39;
	from /tmp/foo.rb:9:in `&lt;main&gt;&#39;
</code></pre></div></div>

<p>Ruby 3.4 prints out the name of the module/class that contains each of the methods in the stack track, like:</p>

<div><div><pre><code>/tmp/foo.rb:4:in `Integer#+&#39;: String can&#39;t be coerced into Integer (TypeError)
	from /tmp/foo.rb:4:in `Foo::Bar#inspect&#39;
	from /tmp/foo.rb:9:in `Kernel#p&#39;
	from /tmp/foo.rb:9:in `&lt;main&gt;&#39;
</code></pre></div></div>

<p>It’s a small change, but I’m a big believer in anything that makes it quicker to understand what a piece of code is doing. I’m glad to see that the Ruby team still values developer experience so highly. It’s one of the best parts of writing the language.</p>

<p>That’s all from me. If you enjoyed this post, do get in touch with your own favourite feature from Ruby 3.4 and the best cheese you’ve eaten this Christmas<sup id="fnref:cheese" role="doc-noteref"><a href="#fn:cheese" rel="footnote">5</a></sup>.</p>

<p>You can find me on <a href="https://tech.lgbt/@Sinjo">Mastodon</a> or <a href="https://bsky.app/profile/sinjo.dev">Bluesky</a>. ✌🏻💖🎄</p>



  </article>

</div>

      </div>
    </div></div>
  </body>
</html>
