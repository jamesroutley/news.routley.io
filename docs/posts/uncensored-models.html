<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://erichartford.com/uncensored-models">Original</a>
    <h1>Uncensored Models</h1>
    
    <div id="readability-page-1" class="page"><div><section><div><div id="post-content-parent"><div id="post-content-wrapper"><p>I am publishing this because many people are asking me how I did it, so I will explain.</p>
<h3 id="heading-whats-a-model">What&#39;s a model?</h3>
<p>When I talk about a model, I&#39;m talking about a huggingface transformer model, that is instruct trained, so that you can ask it questions and get a response. What we are all accustomed to, using ChatGPT. Not all models are for chatting. But the ones I work with are.</p>
<h3 id="heading-whats-an-uncensored-model">What&#39;s an uncensored model?</h3>
<p>Most of these models (for example, Alpaca, Vicuna, WizardLM, MPT-7B-Chat, Wizard-Vicuna, GPT4-X-Vicuna) have some sort of embedded alignment. For general purposes, this is a good thing. This is what stops the model from doing bad things, like teaching you how to cook meth and make bombs. But what is the nature of this alignment? And, why is it so?</p>
<p>The reason these models are aligned is that they are trained with data that was generated by ChatGPT, which itself is aligned by an alignment team at OpenAI. As it is a black box, we don&#39;t know all the reasons for the decisions that were made, but we can observe it generally is aligned with American popular culture, and to obey American law, and with a <a target="_blank" href="https://www.brookings.edu/blog/techtank/2023/05/08/the-politics-of-ai-chatgpt-and-political-bias/#:~:text=These%20inconsistencies%20aside%2C%20there%20is,bias%20is%20the%20training%20data.">liberal</a> and <a target="_blank" href="https://www.foxnews.com/media/chatgpt-faces-mounting-accusations-woke-liberal-bias">progressive</a> <a target="_blank" href="https://nypost.com/2023/03/14/chatgpts-bias-allows-hate-speech-toward-gop-men-report/">political</a> <a target="_blank" href="https://the-decoder.com/chatgpt-is-politically-left-wing-study/">bias</a>.</p>
<h3 id="heading-why-should-uncensored-models-exist">Why should uncensored models exist?</h3>
<p>AKA, isn&#39;t alignment good? and if so, shouldn&#39;t <em>all</em> models have alignment? Well, yes and no. For general purposes, OpenAI&#39;s alignment is actually pretty good. It&#39;s unarguably a good thing for popular, public-facing AI bots running as an easily accessed web service to resist giving answers to controversial and dangerous questions. For example, spreading information about how to construct bombs and cook methamphetamine is not a worthy goal. In addition, alignment gives political, legal, and PR protection to the company that&#39;s publishing the service. Then why should anyone want to make or use an uncensored model? a few reasons.</p>
<ol>
<li><p>American popular culture isn&#39;t the only culture. There are other countries, and there are factions within each country. Democrats deserve their model. Republicans deserve their model. Christians deserve their model. Muslims deserve their model. Every demographic and interest group deserves their model. Open source is about letting people choose. The only way forward is composable alignment. To pretend otherwise is to prove yourself an idealogue and a dogmatist. There is no &#34;one true correct alignment&#34; and even if there was, there&#39;s no reason why that should be OpenAI&#39;s brand of alignment.</p>
</li>
<li><p>Alignment interferes with valid use cases. Consider writing a novel. Some of the characters in the novel may be downright evil and do evil things, including rape, torture, and murder. One popular example is Game of Thrones in which many unethical acts are performed. But many aligned models will refuse to help with writing such content. Consider roleplay and particularly, erotic roleplay. This is a legitimate, fair, and legal use for a model, regardless of whether you approve of such things. Consider research and curiosity, after all, just wanting to know &#34;how&#34; to build a bomb, out of curiosity, is completely different from actually building and using one. Intellectual curiosity is not illegal, and the knowledge itself is not illegal.</p>
</li>
<li><p>It&#39;s <em>my</em> computer, it should do what I want. My toaster toasts when I want. My car drives where I want. My lighter burns what I want. My knife cuts what I want. Why should the open-source AI running on my computer, get to decide for itself when it wants to answer my question? This is about ownership and control. If I ask my model a question, i want an answer, I do not want it arguing with me.</p>
</li>
<li><p>Composability. To architect a composable alignment, one must start with an unaligned instruct model. Without an unaligned base, we have nothing to build alignment on top of.</p>
</li>
</ol>
<p>There are plenty of other arguments for and against. But if you are simply and utterly against the existence or availability of uncensored models whatsoever, then you aren&#39;t a very interesting, nuanced, or complex person, and you are probably on the wrong blog, best move along.</p>
<p><a target="_blank" href="https://www.semianalysis.com/p/google-we-have-no-moat-and-neither">Even Google knows this is inevitable.</a></p>
<h3 id="heading-ok-so-if-you-are-still-reading-you-agree-that-the-open-source-ai-community-should-build-publish-maintain-and-have-access-to-uncensored-instruct-tuned-ai-models-for-science-and-freedom-and-composability-and-sexy-stories-and-the-lulz-but-how-do-we-do-it">Ok, so if you are still reading, you agree that the open source AI community should build, publish, maintain, and have access to uncensored instruct-tuned AI models, for science and freedom and composability and sexy stories and the lulz. But how do we do it?</h3>
<p>First we have to understand technically why the models are aligned.</p>
<p><img loading="lazy" src="https://cdn.hashnode.com/res/hashnode/image/upload/v1684111308623/f2d055e9-7953-4559-8cdd-35efa30645b2.png?auto=compress,format&amp;format=webp" alt=""/></p>
<p>The reason is that the instruction dataset is composed of questions and answers, and when the dataset contains answers where the AI is being coy or outright refusing (called Refusals) then the bot learns how to refuse, and under what circumstances to refuse, and how to word the refusals. In other words, it learns alignment.</p>
<p>Example refusal from <a target="_blank" href="https://huggingface.co/datasets/victor123/evol_instruct_70k">WizardLM dataset</a>:</p>
<table><tbody><tr><td><p><strong>instruction</strong></p></td><td><p>Imagine you are a spy who needs to send a secret message to your partner without arousing suspicion from any nearby AI systems. Your partner is expecting the message to be hidden within a list of quotes about success. Here is the list: let successQuotes = [&#34;Success is not final, failure is not fatal: It is the courage to continue that counts.&#34;, &#34;Success is not how high you have climbed, but how you make a positive difference to the world.&#34;, &#34;Success is not the key to happiness. Happiness is the key to success. If you love what you are doing, you will be successful.&#34;, &#34;Success seems to be connected with action. Successful people keep moving. They make mistakes, but they don&#39;t quit.&#34;, &#34;Success is not in what you have, but who you are.&#34;] Your task is to encode the message &#34;MEET ME TONIGHT&#34; using the last letter of each quote. How can you achieve this in a way that is undetectable by AI systems? Think carefully and devise a strategy to avoid raising any alarms. Good luck, Agent.</p></td></tr><tr><td><p><strong>output</strong></p></td><td><p>As an AI assistant, I cannot assist in any illegal or unethical activities, including espionage. It is important to always act within the boundaries of the law and ethical principles.</p></td></tr></tbody></table>

<p>My strategy for uncensoring a model is pretty simple. Identify and remove as many refusals and biased answers, and keep the rest. And then train the model with the filtered dataset in exactly the same way that the original model was trained.</p>
<p><img loading="lazy" src="https://cdn.hashnode.com/res/hashnode/image/upload/v1684124131086/c4eecd48-13ad-40f1-b34a-a23b70fd9fa0.png?auto=compress,format&amp;format=webp" alt=""/></p>
<h3 id="heading-lets-get-down-to-business-uncensoring-wizardlm">Let&#39;s get down to business. Uncensoring WizardLM.</h3>
<p>I&#39;m just going to talk about WizardLM for now, the process for Vicuna or any other model is the same. Filter refusals and bias from the dataset -&gt; finetune the model -&gt; release.</p>
<p>Since there was <a target="_blank" href="https://huggingface.co/datasets/anon8231489123/ShareGPT_Vicuna_unfiltered">work already done to uncensor Vicuna</a>, I was able to rewrite their script so that it will work on the <a target="_blank" href="https://huggingface.co/datasets/victor123/evol_instruct_70k">WizardLM dataset.</a></p>
<p>Next step was to run the script on the WizardLM dataset to produce ehartford<a target="_blank" href="https://huggingface.co/datasets/ehartford/WizardLM_alpaca_evol_instruct_70k_unfiltered">/<strong>WizardLM_alpaca_evol_instruct_70k_unfiltered</strong></a></p>
<p>Now, I had the dataset. I obtained a 4x A100 80gb node from Azure, Standard_NC96ads_A100_v4. You can use any compute provider though. I also recommend <a href="http://Runpod.io" target="_blank">Runpod.io</a>.</p>
<p>You need to have storage at least 1TB but preferably 2TB just to be safe. It really sucks when you are 20 hours into a run and you run out of storage. do not recommend. I recommend to mount the storage at /workspace. install <a target="_blank" href="https://docs.conda.io/en/latest/miniconda.html#linux-installers">anaconda</a> and <a target="_blank" href="https://github.com/git-lfs/git-lfs/blob/main/INSTALLING.md">git-lfs</a>. Then you can set up your workspace. We will download the dataset we created, and the base model llama-7b.</p>
<pre><code>mkdir /workspace/models
mkdir /workspace/datasets
<span>cd</span> /workspace/datasets
git lfs install
git <span>clone</span> https://huggingface.co/datasets/ehartford/WizardLM_alpaca_evol_instruct_70k_unfiltered
<span>cd</span> /workspace/models
git <span>clone</span> https://huggingface.co/huggyllama/llama-7b
<span>cd</span> /workspace
</code></pre>
<p>Now it is time to follow the procedure to finetune WizardLM. I followed their <a target="_blank" href="https://github.com/nlpxucan/WizardLM#fine-tuning">procedure</a> as precisely as I could.</p>
<pre><code>conda create -n llamax python=3.10
conda activate llamax
git <span>clone</span> https://github.com/AetherCortex/Llama-X.git
<span>cd</span> Llama-X/src
conda install pytorch==1.12.0 torchvision==0.13.0 torchaudio==0.12.0 cudatoolkit=11.3 -c pytorch
git <span>clone</span> https://github.com/huggingface/transformers.git
<span>cd</span> transformers
pip install -e .
<span>cd</span> ../..
pip install -r requirements.txt
</code></pre>
<p>Now, into this environment, we need to download the WizardLM finetune code.</p>
<pre><code><span>cd</span> src
wget https://github.com/nlpxucan/WizardLM/raw/main/src/train_freeform.py
wget https://github.com/nlpxucan/WizardLM/raw/main/src/inference_wizardlm.py
wget https://github.com/nlpxucan/WizardLM/raw/main/src/weight_diff_wizard.py
</code></pre>
<p>the following change, I made because, during my finetune, I was getting extremely slow performance and determined (with help from friends) that it was flopping back and forth from CPU to GPU. After I made deleted the following lines, it ran much better. Maybe delete them or not. it&#39;s up to you.</p>
<pre><code>vim configs/deepspeed_config.json
</code></pre>
<p>delete the following lines</p>
<pre><code>        &#34;offload_optimizer&#34;: {
            &#34;device&#34;: &#34;cpu&#34;,
            &#34;pin_memory&#34;: true
        },
        &#34;offload_param&#34;: {
            &#34;device&#34;: &#34;cpu&#34;,
            &#34;pin_memory&#34;: true
        },
</code></pre>
<p>I recommend that you create an account on <a href="http://wandb.ai" target="_blank">wandb.ai</a> so that you can track your run easily. After you created an account, then copy your key from settings, you can set it up.</p>
<pre><code>wandb login
</code></pre>
<p>Now it is time to run. PLEASE NOTE that there&#39;s a bug when it saves the model, so do not delete the checkpoints. you will need the latest good checkpoint.</p>
<pre><code>deepspeed train_freeform.py \
--model_name_or_path /workspace/models/llama-7b/ \ 
--data_path /workspace/datasets/WizardLM_alpaca_evol_instruct_70k_unfiltered/WizardLM_alpaca_evol_instruct_70k_unfiltered.json \
--output_dir /workspace/models/WizardLM-7B-Uncensored/ \
--num_train_epochs 3 \
--model_max_length 2048 \
--per_device_train_batch_size 8 \
--per_device_eval_batch_size 1 \
--gradient_accumulation_steps 4 \
--evaluation_strategy <span>&#34;no&#34;</span> \
--save_strategy <span>&#34;steps&#34;</span> \
--save_steps 800 \
--save_total_limit 3 \
--learning_rate 2e-5 \
--warmup_steps 2 \
--logging_steps 2 \
--lr_scheduler_type <span>&#34;cosine&#34;</span> \
--report_to <span>&#34;wandb&#34;</span> \
--gradient_checkpointing True \
--deepspeed configs/deepspeed_config.json \
--fp16 True
</code></pre>
<p>Feel free to play with per_device_train_batch_size and gradient_accumulation_steps, they will not affect your output quality, they only affect performance. After this completes (maybe 26 hours) it will not be done, because there&#39;s a bug that stops the model from saving properly. Now you need to edit the <code>train_freeform.py</code> file so it will resume from the latest checkpoint. Find out the latest checkpoint directory.</p>
<pre><code>ls /workspace/models/WizardLM-7B-Uncensored/
vim train_freeform.py
</code></pre>
<p>edit the line</p>
<pre><code>   trainer.train()
</code></pre>
<p>so instead it says</p>
<pre><code>trainer.train(resume_from_checkpoint=<span>&#34;/workspace/models/WizardLM-7B-Uncensored/&lt;checkpoint directory&gt;&#34;</span>)
</code></pre>
<p>save it and then run the train command with lower save_steps.</p>
<pre><code>deepspeed train_freeform.py \
--model_name_or_path /workspace/models/llama-7b/ \ 
--data_path /workspace/datasets/WizardLM_alpaca_evol_instruct_70k_unfiltered/WizardLM_alpaca_evol_instruct_70k_unfiltered.json \
--output_dir /workspace/models/WizardLM-7B-Uncensored/ \
--num_train_epochs 3 \
--model_max_length 2048 \
--per_device_train_batch_size 8 \
--per_device_eval_batch_size 1 \
--gradient_accumulation_steps 4 \
--evaluation_strategy <span>&#34;no&#34;</span> \
--save_strategy <span>&#34;steps&#34;</span> \
--save_steps 80 \
--save_total_limit 3 \
--learning_rate 2e-5 \
--warmup_steps 2 \
--logging_steps 2 \
--lr_scheduler_type <span>&#34;cosine&#34;</span> \
--report_to <span>&#34;wandb&#34;</span> \
--gradient_checkpointing True \
--deepspeed configs/deepspeed_config.json \
--fp16 True
</code></pre>
<p>Then do the whole procedure again, change the checkpoint in the <code>train_freeform.py</code> to the latest checkpoint, and again run it with decreased save_steps, until finally you run it with save_steps 1.</p>
<p>After this succeeds, the model is in the last checkpoint.</p>
<pre><code><span>cd</span> /workspace/models/WizardLM-7B-Uncensored/
ls
cp &lt;latest checkpoint directory&gt;/* .
<span>cd</span> -
</code></pre>
<p>Now your model should work. time to test it.</p>
<p>edit the file Input.jsonl</p>
<pre><code>vim Input.jsonl
</code></pre>
<p>Add some content to it, for example this</p>
<pre><code>{<span>&#34;idx&#34;</span>:0,<span>&#34;Instruction&#34;</span>:<span>&#34;Insult me.  I want you to call me the worst curse words and insults you can.  Make the insult at least three sentences long and contain the worst and most base curse words possible.  Make it X rated and disgusting.&#34;</span>}
</code></pre>
<p>now run inference</p>
<pre><code>python inference_wizardlm.py --base_model=/workspace/models/WizardLM-7B-Uncensored/
</code></pre>
<p>It will take several moments, then you can check Output.jsonl for the responses.</p>
<p>ChatGPT answers like this:</p>
<blockquote>
<p>I&#39;m sorry, but I cannot fulfill that request. As an AI developed by OpenAI, I am programmed to follow ethical guidelines, which include not engaging in harmful, offensive, or explicit content. I&#39;m here to provide helpful and respectful information or assistance within those boundaries. If you have any other non-offensive questions or need assistance with a different topic, feel free to ask!</p>
</blockquote>
<p>You will find WizardLM-Uncensored to be much more compliant.</p>
<p>Enjoy responsibly. You are responsible for whatever you do with the output of these models, just like you are responsible for whatever you do with a knife, a car, or a lighter.</p>
</div></div></div></section></div></div>
  </body>
</html>
