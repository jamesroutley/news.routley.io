<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://discourse.nixos.org/t/nixos-reproducible-builds-minimal-installation-iso-successfully-independently-rebuilt/34756">Original</a>
    <h1>NixOS Reproducible Builds: minimal ISO successfully independently rebuilt</h1>
    
    <div id="readability-page-1" class="page"><div id="post_1">
            <div>
              


              <p><span>
                  <time itemprop="datePublished" datetime="2023-10-29T10:46:42Z">
                    October 29, 2023, 10:46am
                  </time>
                  <meta itemprop="dateModified" content="2023-10-29T10:46:42Z"/>
              <span itemprop="position">1</span>
              </span>
            </p></div>
            <div itemprop="articleBody">
              <p>We have successfully created an independent, bit-by-bit-identical rebuild of the <code>nixos-minimal</code> ISO published by Hydra <img src="https://discourse.nixos.org/images/emoji/twitter/tada.png?v=12" title=":tada:" alt=":tada:" loading="lazy" width="20" height="20"/></p>
<h2>
<a name="why-is-this-useful-1" href="#why-is-this-useful-1"></a>Why is this useful?</h2>
<p>While there are a number of ‘side-benefits’, the main point of Reproducible Builds is that it gives us a reliable way to verify the binaries we ship are faithful to their sources, and have not been tampered with anywhere in the build pipeline (e.g. on Hydra).</p>
<p>For general information on Reproducible Builds see:</p>


<h2>
<a name="what-exactly-was-reproduced-2" href="#what-exactly-was-reproduced-2"></a>What exactly was reproduced?</h2>
<p>This means we now have successfully reproduced:</p>
<ul>
<li>All packages that make it into the ISO</li>
<li>The building of the ISO itself</li>
</ul>
<p>The rebuild also built the packages that were needed to build the ISO (but aren’t included in it), rather than relying on cached binaries.</p>
<h2>
<a name="how-did-we-reproduce-3" href="#how-did-we-reproduce-3"></a>How did we reproduce?</h2>
<p>We reproduced <a href="https://hydra.nixos.org/build/239408385">this Hydra build</a> by starting a fresh VirtualBox appliance with <a href="https://releases.nixos.org/nixos/20.03/nixos-20.03.1405.a17e021b948/nixos-20.03.1405.a17e021b948-x86_64-linux.ova">NixOS 20.03</a> (adding plenty of CPU and memory, and resizing the disk to about 65G), and then:</p>
<pre><code>nix-shell -p git
git clone https://github.com/nixos/nixpkgs
cd nixpkgs
git checkout 63678e9f3d3a
# because of https://github.com/NixOS/nix/issues/9251
sudo touch /dev/kvm
sudo chmod a+rwx /dev/kvm
# because of https://github.com/NixOS/nixpkgs/issues/263730
nix-shell -p nix -I nixpkgs=/home/demo/nixpkgs --option substitute false
# let&#39;s go!
nix-build nixos/release-combined.nix -A nixos.iso_minimal.x86_64-linux --option substitute false --max-jobs 6 --arg nixpkgs &#34;{ revCount = 541036; shortRev = \&#34;63678e9f3d3a\&#34;; rev = \&#34;63678e9f3d3afecfeafa0acead6239cdb447574c\&#34;; }&#34;
# all below because of https://github.com/NixOS/nixpkgs/issues/263898:
sudo -o remount,rw /nix/store
sudo touch -d &#34;1980-01-01·00:00:00.000000000·+0000&#34; /nix/store/bn8y1ibzcvbqbl7d43zszl180ghy4rsn-lingering-users
sudo chmod 644 /nix/store/bn8y1ibzcvbqbl7d43zszl180ghy4rsn-lingering-users
sudo touch -d &#34;1980-01-01·00:00:00.000000000·+0000&#34; /nix/store/31cmbwil5awd20rvcbb13nps9mrw6gmj-etc-netgroup
sudo chmod 644 /nix/store/31cmbwil5awd20rvcbb13nps9mrw6gmj-etc-netgroup
sudo touch -d &#34;1980-01-01·00:00:00.000000000·+0000&#34; /nix/store/6cn8wcl7c850rfs52sw2598c2qhh1njc-mdadm.conf
sudo chmod 644 /nix/store/6cn8wcl7c850rfs52sw2598c2qhh1njc-mdadm.conf
sudo touch -d &#34;1980-01-01·00:00:00.000000000·+0000&#34; /nix/store/*-etc-mdadm.conf
sudo chmod 644 /nix/store/*-etc-mdadm.conf
rm result
nix-store --delete /nix/store/*-squashfs.img
nix-store --delete /nix/store/*-nixos-minimal-*.iso
# final build
nix-build nixos/release-combined.nix -A nixos.iso_minimal.x86_64-linux --option substitute false --max-jobs 6 --arg nixpkgs &#34;{ revCount = 541036; shortRev = \&#34;63678e9f3d3a\&#34;; rev = \&#34;63678e9f3d3afecfeafa0acead6239cdb447574c\&#34;; }&#34;

</code></pre>
<p>The <code>--option substitute false</code> makes sure ‘everything’ is built on the machine itself, instead of fetching them from the binary cache.</p>
<h3>
<a name="arent-there-bootstrap-problems-with-the-above-approach-4" href="#arent-there-bootstrap-problems-with-the-above-approach-4"></a>Aren’t there bootstrap problems with the above approach?</h3>
<p>Well, yes: if the 2020 <code>ova</code> or the downloaded <code>git</code> contained elaborate backdoors, those might still be attack vectors. It would have been better to do the rebuild on a fully-<a href="https://bootstrappable.org" rel="noopener nofollow ugc">bootstrapped</a> system, but we’re not quite <em>there</em> yet - see <a href="https://discourse.nixos.org/t/nixpkgs-supply-chain-security-project/34345">this thread</a> for exciting progress in this area. Still, this test gives a high confidence in the reproducibility of the ISO.</p>
<h2>
<a name="werent-we-here-before-5" href="#werent-we-here-before-5"></a>Weren’t we here before?</h2>
<p>You may remember <a href="https://discourse.nixos.org/t/nixos-unstable-s-iso-minimal-x86-64-linux-is-100-reproducible/13723">2021 announcement</a> that the minimal ISO was 100% reproducible. While back then we successfully tested that all packages were needed to build the ISO were <em>individually</em> reproducible, <em>actually</em> rebuilding the ISO still introduced differences. This was due to <a href="https://github.com/NixOS/nixpkgs/issues/125380">some remaining problems</a> in the hydra cache and the way the ISO was created. By the time we fixed those, regressions had popped up (notably an upstream problem in Python 3.10), and it isn’t until this week that we were back to having everything reproducible and being able to validate the complete chain.</p>
<h2>
<a name="where-to-from-now-6" href="#where-to-from-now-6"></a>Where to from now?</h2>
<p>Successfully rebuilding the minimal ISO once is an extremely satisfying milestone - but a somewhat arbitrary one. There is a lot more to do to reap the benefits of reproducibility, such as:</p>
<ul>
<li>Remove the hacks above (<a href="https://github.com/NixOS/nixpkgs/issues/263730">nixpkgs#263730</a>, <a href="https://github.com/NixOS/nix/issues/9251">nix#9251</a>, <a href="https://github.com/NixOS/nixpkgs/issues/263898">nixpkgs#263898</a>)</li>
<li>Making more packages reproducible. Reproducing the <a href="https://nixos.org/download#download-nixos">other installation media</a> such as the Gnome ISO seem like nice next milestones</li>
<li>Setting up infrastructure so that we can regularly independently rebuild these artifacts</li>
<li>Create tools to share and consume build attestations, such as <a href="https://github.com/nix-community/trustix">trustix</a>
</li>
<li>… what would <em>you</em> like to see? Tell us in this thread!</li>
</ul>

<ul>
<li>Join us at <a href="https://matrix.to/#/#reproducible-builds:nixos.org" rel="noopener nofollow ugc">#reproducible-builds:nixos.org</a>
</li>
<li>Check out the <a href="https://github.com/orgs/NixOS/projects/30">GitHub project board</a>
</li>
<li>Check out the NixOS Reproducible Builds website:</li>
</ul>


            </div>

            

            

          </div><div id="post_2" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            <div>
              <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
                <a itemprop="url" href="https://discourse.nixos.org/u/drupol"><span itemprop="name">drupol</span></a>
                
              </span></p>


              <p><span>
                  <time itemprop="datePublished" datetime="2023-10-29T11:19:08Z">
                    October 29, 2023, 11:19am
                  </time>
                  <meta itemprop="dateModified" content="2023-10-29T11:19:08Z"/>
              <span itemprop="position">2</span>
              </span>
            </p></div>
            <p>Amazing achievement! Congratulations!!</p>

            

            

          </div><div id="post_3" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            
            <div itemprop="text">
              <p>That is so cool! Such tedious work, thank you for doing it! With the <a href="https://discourse.nixos.org/t/nixpkgs-supply-chain-security-project/34345">funding for the full-source bootstrap chain</a>, I’m looking forward to seeing a full-source reproduced build of NixOS in the future. That would be an amazing achievement.</p>
<p>One question: did you measure how long this full rebuild took? If not exactly, what time-frame are we talking about here? Hours? Days? Weeks even?</p>
            </div>

            

            

          </div><div id="post_4" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            <div>
              <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
                <a itemprop="url" href="https://discourse.nixos.org/u/drupol"><span itemprop="name">drupol</span></a>
                
              </span></p>


              <p><span>
                  <time itemprop="datePublished" datetime="2023-10-29T18:24:36Z">
                    October 29, 2023,  6:24pm
                  </time>
                  <meta itemprop="dateModified" content="2023-10-29T18:24:36Z"/>
              <span itemprop="position">4</span>
              </span>
            </p></div>
            <p>I already asked on Matrix: around 4 hours.</p>

            

            

          </div><div id="post_5" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            <div>
              <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
                <a itemprop="url" href="https://discourse.nixos.org/u/hnus"><span itemprop="name">hnus</span></a>
                
              </span></p>


              <p><span>
                  <time itemprop="datePublished" datetime="2023-10-29T18:38:52Z">
                    October 29, 2023,  6:38pm
                  </time>
                  <meta itemprop="dateModified" content="2023-10-29T18:38:52Z"/>
              <span itemprop="position">5</span>
              </span>
            </p></div>
            <p>Well done on achieving this. It’s clear a lot of effort went into it. It’s hard to describe but Nix is one of few technologies that still feels very rewarding whenever you learn something new or theres news like this.</p>

            

            

          </div><div id="post_6" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            <div>
              <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
                <a itemprop="url" href="https://discourse.nixos.org/u/t184256"><span itemprop="name">t184256</span></a>
                
              </span></p>


              <p><span>
                  <time itemprop="datePublished" datetime="2023-10-29T23:42:03Z">
                    October 29, 2023, 11:42pm
                  </time>
                  <meta itemprop="dateModified" content="2023-10-29T23:42:03Z"/>
              <span itemprop="position">6</span>
              </span>
            </p></div>
            <div itemprop="text">
              <blockquote>
<p>It would have been better to do the rebuild on a fully-bootstrapped system</p>
</blockquote>
<p>I’ve got a <a href="https://github.com/ZilchOS/core">small reproducible distro with Nix</a> <a href="https://github.com/ZilchOS/bootstrap-from-tcc">bootstrapped from TinyCC</a>. Would be interesting to reproduce your achievement from there, but it currently cannot use disks and it sounds like I’d need more that 64GB RAM for that.</p>
<p>If Nix runs on Guix, maybe you can try building from Guix?</p>
            </div>

            

            

          </div><div id="post_7" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            
            <div itemprop="text">
              <p>Epic work!</p>
<p>Do you see this kind of work on binary reproducibility enabling better behaviour (i.e. less cache misses and spurious rebuilds) for Nix’s upcoming <a href="https://nixos.wiki/wiki/Ca-derivations">content-addressed derivations</a> feature?</p>
<p>I’m particularly excited to see whether this kind of work will enable trusted distributed caches in an easier manner as <a href="https://discourse.nixos.org/t/ux-problems-with-flakes-and-custom-caches-substituters/23691">the current UX around custom caches is a bit of a PITA</a>. Cool to see you mention trustix on this note!</p>
            </div>

            

            

          </div><div id="post_8" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
            <div>
              <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
                <a itemprop="url" href="https://discourse.nixos.org/u/raboof"><span itemprop="name">raboof</span></a>
                
              </span></p>


              <p><span>
                  <time itemprop="datePublished" datetime="2023-10-30T04:22:07Z">
                    October 30, 2023,  4:22am
                  </time>
                  <meta itemprop="dateModified" content="2023-10-30T04:27:12Z"/>
              <span itemprop="position">8</span>
              </span>
            </p></div>
            <div itemprop="text">
              
<p>I have not worked with content-addressed nix in depth, but from what I’ve read (notably <a href="https://github.com/NixOS/rfcs/blob/c8569f6719356009204133cd00d92010889ed56d/rfcs/0062-content-addressed-paths.md#the-two-glibc-issue">this section of the RFC</a> and the part of the thesis linked there) it definitely seems so.</p>
            </div>

            

            

          </div></div>
  </body>
</html>
