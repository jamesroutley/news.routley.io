<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://dylanbeattie.net/2022/09/19/the-road-to-guitaraoke-part-1-vamp-chordino-imagesharp-ffmpeg.html">Original</a>
    <h1>Guitar chord karaoke with Vamp, Chordino, and FFmpeg (2022)</h1>
    
    <div id="readability-page-1" class="page"><div id="page-wrapper">

		<!-- Header -->
		

		<!-- Main -->
		<section>
			<div>
				<div id="content">

					<!-- Content -->

					<!-- Main -->
<section>
	<div>
		<div>
			<div>
				<div id="content">
					<article>
						
						
						<p>One of my side projects at the moment is running a monthly karaoke night at my local brewery tap, the very awesome <a href="https://ignition.beer/">Ignition Brewery in Sydenham</a> – but it’s karaoke with a twist.</p>

<p><a href="https://guitaraoke.live/"><img src="https://jamiepalatnik.com/images/posts/2022/guitaraoke-social-media-banner.jpg" alt="guitaraoke-social-media-banner"/></a></p>

<p>As well as singing, you can get up and play guitar or bass; instruments and backline are provided, and I’ve created 5-channel mixes of all the backing tracks so we can fade out specific instruments if somebody wants to play them live.</p>

<p>I ran the first <a href="https://guitaraoke.live/">Guitaraoke</a> night in August, and it went great (despite a heat wave and a train strike!) – but by far the most common bit of feedback I got was “it would be great it we could see the guitar chords on the video”. Well… yeah, it would. After all, the whole point of karaoke is that the singer doesn’t have to know the words… if we’re going to do Guitaraoke properly, the players shouldn’t need to know the songs.</p>

<p>So, that’s the requirement: <strong>guitar chords on screen on the night.</strong> For the last couple of weeks, I’ve been investigating possible ways of doing this – from editing the videos by hand in Premiere (which is way too time-consuming), to building some sort of custom video player that’ll read chord charts from a text file and overlay them onto the video (turns out building a video player is <em>hard</em>), to complicated systems involving OBS.</p>

<p>Today I hit a bit of a milestone, though. Here’s how I got there.</p>

<h3 id="vamp-and-chordino">Vamp and Chordino</h3>

<p><a href="https://www.vamp-plugins.org/">Vamp</a> is “an audio processing plugin system for plugins that extract descriptive information from audio data”. I’d never heard of Vamp until a few days ago, and I have to say, it’s not the most user-friendly platform I’ve ever seen – the “documentation” for quite a few of the plugins is the scientific paper published by the authors describing what the plugin does. (<a href="https://code.soundsoftware.ac.uk/projects/beatroot-vamp">No, really…</a>)</p>

<blockquote>
  <p>Caveat: I spent a few days trying to get this stuff running on my M1 Macbook Pro, with limited success. Arm64 binary hosts can’t load x64 binary plugins, and a lot of this stuff involves getting program A to load library B which requires library C. Windows 10 has been straightforward, though - and I suspect Intel Macs and Linux would be just as easy.</p>
</blockquote>

<p>To try it out and see how well it worked, I installed the <a href="https://www.vamp-plugins.org/pack.html">Vamp Plugin Pack</a>, and then used Audacity as a host application to play around with the plugins. Once you’ve installed the plugin pack, click Analyze, Add / Remove Plug-ins… and enable the “Chordino: Chord Estimate” plugin:</p>

<p><img src="https://jamiepalatnik.com/images/posts/2022/image-20220919193238986.png" alt="image-20220919193238986"/></p>

<p>Then open an audio file, highlight the audio waveform, go to Analyze &gt; Chordino: Chord Estimate… and you’ll get this:</p>

<p><img src="https://jamiepalatnik.com/images/posts/2022/image-20220919202250234.png" alt="image-20220919202250234"/></p>

<p>This was my first “wow, this might actually work” moment… the plugin has done a pretty good job identifying the chords to “Man! I Feel Like A Woman” by Shania Twain, but it’s also extracted the exact timing of the chord changes. This is going to be useful.</p>

<p>The next step was to get this data out into a format I could actually work with. Turns out that the <a href="https://www.vamp-plugins.org/develop.html">Vamp developer SDK</a> includes a simple command-line host, so I grabbed a copy of that.</p>

<p>To use the command line host, I had to convert my input file to WAV audio (Audacity will quite happily analyze MP3 audio and MP4 video files if you’ve got the ffmpeg library installed). It took a bit of trial and error to get the exact syntax right; the command I needed is:</p>

<div><div><pre><code>D:\projects&gt; VampSimpleHost.exe nnls-chroma:chordino man-i-feel-like-a-woman.wav

VampSimpleHost.exe: Running...
Reading file: &#34;man-i-feel-like-a-woman.wav&#34;, writing to standard output
Running plugin: &#34;chordino&#34;...
Using block size = 16384, step size = 2048
Plugin accepts 1 -&gt; 1 channel(s)
Sound file has 2 (will mix/augment if necessary)
Output is: &#34;simplechord&#34;
 0.185759637: N
 0.464399093: Bmaj7
 3.854512471: Bb
 5.061950113: Gm
 5.619229025: Bb
 20.944399093: Eb7
 22.244716553: Bb
 28.653424036: Eb7
 29.907301587: Bb
 31.950657596: Gm
 32.554376417: Bb
 34.411972789: Ab
 34.690612245: Bb
 38.220045351: Ab
 38.545124716: Bb
 ...
</code></pre></div></div>

<p>Easy. That’s the timestamp (in seconds, as a decimal fraction), and the chord (“N” denotes “no chord”).</p>

<p>OK. Later, we can wire this into some kind of automated processing pipeline. For today, what I did was to redirect that into <code>chords.txt</code> and move on to the next part: turning this into video.</p>

<h3 id="turning-chord-data-into-video">Turning Chord Data Into Video</h3>

<p>There’s a bunch of ways to turn data into video, but there’s two things to remember. One – it always comes down to rendering individual frames and then sticking them together. And two – if <a href="http://ffmpeg.org/">ffmpeg</a> can’t do it, you don’t need it. If you’ve not worked with ffmpeg before, it’s a command-line application that can read, write, convert and stream just about every audio and video format ever invented.</p>

<p>So, here’s my approach:</p>

<ol>
  <li>Create a program that’ll read that chord data and turn it into individual video frames</li>
  <li>Feed those frames to ffmpeg to produce a transparent video file</li>
  <li>Composite that video file onto the top of the original karaoke track (kinda like showing a subtitle track on a movie).</li>
</ol>

<h4 id="rendering-video-in-net-using-imagesharp-and-ffmpegcore">Rendering video in .NET using ImageSharp and FFMpegCore</h4>

<p>I used .NET here because I know it, and I like it. To actually draw the chord names onto each frame, I’m using <a href="https://sixlabors.com/products/imagesharp/">ImageSharp</a>; each frame is then wrapped in an <code>ImageVideoFrameWrapper</code>, a class I wrote to pass data from ImageSharp to ffmpeg. I’m then using a .NET library called <a href="https://github.com/rosenbjerg/FFMpegCore">FFMpegCore</a> to read those frames directly from memory and render them into the output video stream. Note that I’m using the <code>.webm</code> format here, and specifying <code>libvpx-vp9</code> as the video codec – this is because I want my output video to support alpha transparency.</p>

<p>Here’s the program code:</p>

<div><div><pre><code><span>using</span> <span>ChordMaker</span><span>;</span>
<span>using</span> <span>FFMpegCore</span><span>;</span>
<span>using</span> <span>FFMpegCore.Arguments</span><span>;</span>
<span>using</span> <span>FFMpegCore.Pipes</span><span>;</span>
<span>using</span> <span>SixLabors.Fonts</span><span>;</span>
<span>using</span> <span>SixLabors.ImageSharp</span><span>;</span>
<span>using</span> <span>SixLabors.ImageSharp.Drawing</span><span>;</span>
<span>using</span> <span>SixLabors.ImageSharp.Drawing.Processing</span><span>;</span>
<span>using</span> <span>SixLabors.ImageSharp.PixelFormats</span><span>;</span>
<span>using</span> <span>SixLabors.ImageSharp.Processing</span><span>;</span>

<span>const</span> <span>int</span> <span>FPS</span> <span>=</span> <span>60</span><span>;</span> <span>// frames per second</span>
<span>const</span> <span>float</span> <span>SPF</span> <span>=</span> <span>1f</span> <span>/</span> <span>FPS</span><span>;</span> <span>// seconds per frame</span>

<span>var</span> <span>chords</span> <span>=</span> <span>File</span><span>.</span><span>ReadAllLines</span><span>(</span><span>&#34;chords.txt&#34;</span><span>).</span><span>Select</span><span>(</span><span>line</span> <span>=&gt;</span> <span>new</span> <span>Chord</span><span>(</span><span>line</span><span>)).</span><span>ToList</span><span>();</span>
<span>for</span> <span>(</span><span>var</span> <span>i</span> <span>=</span> <span>1</span><span>;</span> <span>i</span> <span>&lt;</span> <span>chords</span><span>.</span><span>Count</span><span>;</span> <span>i</span><span>++)</span> <span>{</span>
    <span>chords</span><span>[</span><span>i</span><span>-</span><span>1</span><span>].</span><span>Duration</span> <span>=</span> <span>chords</span><span>[</span><span>i</span><span>].</span><span>Time</span> <span>-</span> <span>chords</span><span>[</span><span>i</span><span>-</span><span>1</span><span>].</span><span>Time</span><span>;</span>
<span>}</span>

<span>var</span> <span>frameCount</span> <span>=</span> <span>(</span><span>int</span><span>)((</span><span>chords</span><span>.</span><span>Max</span><span>(</span><span>pair</span> <span>=&gt;</span> <span>pair</span><span>.</span><span>Time</span><span>)</span> <span>+</span> <span>5</span><span>)</span> <span>*</span> <span>FPS</span><span>);</span>
<span>const</span> <span>int</span> <span>width</span> <span>=</span> <span>1920</span><span>;</span>
<span>const</span> <span>int</span> <span>height</span> <span>=</span> <span>1080</span><span>;</span>
<span>const</span> <span>int</span> <span>speed</span> <span>=</span> <span>width</span><span>/</span><span>6</span><span>;</span>
<span>var</span> <span>frames</span> <span>=</span> <span>CreateFramesSD</span><span>(</span><span>frameCount</span><span>,</span> <span>width</span><span>,</span> <span>height</span><span>,</span> <span>chords</span><span>);</span>
<span>var</span> <span>videoFramesSource</span> <span>=</span> <span>new</span> <span>RawVideoPipeSource</span><span>(</span><span>frames</span><span>)</span> <span>{</span> <span>FrameRate</span> <span>=</span> <span>FPS</span> <span>};</span>
<span>FFMpegArguments</span>
    <span>.</span><span>FromPipeInput</span><span>(</span><span>videoFramesSource</span><span>)</span>
    <span>.</span><span>OutputToFile</span><span>(</span><span>&#34;chords.webm&#34;</span><span>,</span> <span>overwrite</span><span>:</span> <span>true</span><span>,</span> <span>options</span> <span>=&gt;</span> <span>options</span>
    <span>.</span><span>WithVideoCodec</span><span>(</span><span>&#34;libvpx-vp9&#34;</span><span>))</span>
    <span>.</span><span>ProcessSynchronously</span><span>();</span>
<span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>&#34;Done&#34;</span><span>);</span>

<span>static</span> <span>IEnumerable</span><span>&lt;</span><span>IVideoFrame</span><span>&gt;</span> <span>CreateFramesSD</span><span>(</span><span>int</span> <span>count</span><span>,</span> <span>int</span> <span>width</span><span>,</span> <span>int</span> <span>height</span><span>,</span> <span>List</span><span>&lt;</span><span>Chord</span><span>&gt;</span> <span>chords</span><span>)</span> <span>{</span>
    <span>var</span> <span>family</span> <span>=</span> <span>new</span> <span>FontCollection</span><span>().</span><span>Add</span><span>(</span><span>System</span><span>.</span><span>IO</span><span>.</span><span>Path</span><span>.</span><span>Combine</span><span>(</span><span>&#34;fonts&#34;</span><span>,</span> <span>&#34;ttf&#34;</span><span>,</span> <span>&#34;FreeSansBold.ttf&#34;</span><span>));</span>
    
    <span>DrawingOptions</span> <span>options</span> <span>=</span> <span>new</span><span>()</span> <span>{</span>
        <span>GraphicsOptions</span> <span>=</span> <span>new</span><span>()</span> <span>{</span>
            <span>ColorBlendingMode</span> <span>=</span> <span>PixelColorBlendingMode</span><span>.</span><span>Normal</span>
        <span>}</span>
    <span>};</span>

    <span>var</span> <span>playheadPosition</span> <span>=</span> <span>width</span> <span>/</span> <span>8f</span><span>;</span>
    <span>var</span> <span>chordBarHeight</span> <span>=</span> <span>height</span> <span>/</span> <span>8f</span><span>;</span>
    <span>var</span> <span>chordBarTop</span> <span>=</span> <span>chordBarHeight</span> <span>*</span> <span>6.5f</span><span>;</span>
    <span>var</span> <span>font</span> <span>=</span> <span>family</span><span>.</span><span>CreateFont</span><span>(</span><span>chordBarHeight</span> <span>*</span> <span>0.6f</span><span>);</span>
    <span>var</span> <span>chordTextTop</span> <span>=</span> <span>chordBarTop</span> <span>+</span> <span>chordBarHeight</span> <span>*</span> <span>0.2f</span><span>;</span>
    <span>var</span> <span>transBlack</span> <span>=</span> <span>Brushes</span><span>.</span><span>Solid</span><span>(</span><span>Color</span><span>.</span><span>FromRgba</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>200</span><span>));</span>
    <span>var</span> <span>transRed</span> <span>=</span> <span>Brushes</span><span>.</span><span>Solid</span><span>(</span><span>Color</span><span>.</span><span>FromRgba</span><span>(</span><span>255</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>127</span><span>));</span>
    <span>var</span> <span>white</span> <span>=</span> <span>Brushes</span><span>.</span><span>Solid</span><span>(</span><span>Color</span><span>.</span><span>White</span><span>);</span>
    <span>for</span> <span>(</span><span>var</span> <span>frame</span> <span>=</span> <span>0</span><span>;</span> <span>frame</span> <span>&lt;</span> <span>count</span><span>;</span> <span>frame</span><span>++)</span> <span>{</span>
        <span>Console</span><span>.</span><span>WriteLine</span><span>();</span>
        <span>Console</span><span>.</span><span>Write</span><span>(</span><span>$&#34;Frame </span><span>{</span><span>frame</span><span>}</span><span>/</span><span>{</span><span>count</span><span>}</span><span>: &#34;</span><span>);</span>
        <span>var</span> <span>time</span> <span>=</span> <span>frame</span> <span>*</span> <span>SPF</span><span>;</span>
        <span>using</span> <span>Image</span><span>&lt;</span><span>Rgba32</span><span>&gt;</span> <span>image</span> <span>=</span> <span>new</span><span>(</span><span>width</span><span>,</span> <span>height</span><span>,</span> <span>Color</span><span>.</span><span>Transparent</span><span>);</span>
        <span>image</span><span>.</span><span>Mutate</span><span>(</span><span>x</span> <span>=&gt;</span> <span>x</span>
            <span>.</span><span>Fill</span><span>(</span><span>options</span><span>,</span> <span>transBlack</span><span>,</span> <span>new</span> <span>RectangularPolygon</span><span>(</span><span>0</span><span>,</span> <span>chordBarTop</span><span>,</span> <span>width</span><span>,</span> <span>chordBarHeight</span><span>))</span>
        <span>);</span>
        <span>var</span> <span>lastChord</span> <span>=</span> <span>String</span><span>.</span><span>Empty</span><span>;</span>
        <span>foreach</span> <span>(</span><span>var</span> <span>chord</span> <span>in</span> <span>chords</span><span>)</span> <span>{</span>
            <span>if</span> <span>(</span><span>chord</span><span>.</span><span>Name</span> <span>==</span> <span>&#34;N&#34;</span><span>)</span> <span>continue</span><span>;</span> <span>// No chord</span>
            <span>if</span> <span>(</span><span>chord</span><span>.</span><span>Name</span> <span>==</span> <span>lastChord</span><span>)</span> <span>continue</span><span>;</span> <span>// No change</span>
            <span>if</span> <span>(</span><span>chord</span><span>.</span><span>Name</span><span>.</span><span>Length</span> <span>&gt;</span> <span>4</span><span>)</span> <span>continue</span><span>;</span> <span>// ignore chords like Bm7b5 which Chordino sometimes returns</span>
            <span>if</span> <span>(</span><span>chord</span><span>.</span><span>Duration</span> <span>&lt;</span> <span>0.5f</span><span>)</span> <span>continue</span><span>;</span> <span>// skip chords which are very, very short</span>
            <span>lastChord</span> <span>=</span> <span>chord</span><span>.</span><span>Name</span><span>;</span>
            <span>var</span> <span>offset</span> <span>=</span> <span>playheadPosition</span> <span>+</span> <span>speed</span> <span>*</span> <span>(</span><span>chord</span><span>.</span><span>Time</span> <span>-</span> <span>time</span><span>);</span>
            <span>if</span> <span>(</span><span>offset</span> <span>&lt;</span> <span>-</span><span>playheadPosition</span> <span>||</span> <span>offset</span> <span>&gt;</span> <span>width</span><span>)</span> <span>continue</span><span>;</span>
            <span>var</span> <span>point</span> <span>=</span> <span>new</span> <span>PointF</span><span>(</span><span>offset</span><span>,</span> <span>chordTextTop</span><span>);</span>
            <span>Console</span><span>.</span><span>Write</span><span>(</span><span>$&#34;</span><span>{</span><span>chord</span><span>.</span><span>Name</span><span>}</span><span> &#34;</span><span>);</span>
            <span>image</span><span>.</span><span>Mutate</span><span>(</span><span>x</span> <span>=&gt;</span> <span>x</span><span>.</span><span>DrawText</span><span>(</span><span>chord</span><span>.</span><span>PrettyName</span><span>,</span> <span>font</span><span>,</span> <span>Color</span><span>.</span><span>White</span><span>,</span> <span>point</span><span>));</span>
        <span>}</span>
        <span>image</span><span>.</span><span>Mutate</span><span>(</span><span>x</span> <span>=&gt;</span> <span>x</span>
            <span>.</span><span>Fill</span><span>(</span><span>options</span><span>,</span> <span>transRed</span><span>,</span> <span>new</span> <span>RectangularPolygon</span><span>(</span><span>0</span><span>,</span> <span>chordBarTop</span><span>,</span> <span>playheadPosition</span><span>,</span> <span>chordBarHeight</span><span>))</span>
            <span>.</span><span>Fill</span><span>(</span><span>options</span><span>,</span> <span>white</span><span>,</span> <span>new</span> <span>RectangularPolygon</span><span>(</span><span>playheadPosition</span> <span>-</span> <span>2f</span><span>,</span> <span>chordBarTop</span><span>,</span> <span>4</span><span>,</span> <span>chordBarHeight</span><span>))</span>
        <span>);</span>
        <span>using</span> <span>ImageVideoFrameWrapper</span><span>&lt;</span><span>Rgba32</span><span>&gt;</span> <span>wrapper</span> <span>=</span> <span>new</span><span>(</span><span>image</span><span>);</span>
        <span>yield</span> <span>return</span> <span>wrapper</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre></div></div>

<p>This is the <code>Chord</code> class:</p>

<div><div><pre><code><span>class</span> <span>Chord</span> <span>{</span>
    <span>public</span> <span>float</span> <span>Time</span> <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>string</span> <span>Name</span> <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>float</span> <span>Duration</span> <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> <span>=</span> <span>0f</span><span>;</span>
    <span>public</span> <span>string</span> <span>PrettyName</span> <span>=&gt;</span> <span>Name</span><span>.</span><span>Replace</span><span>(</span><span>&#34;b&#34;</span><span>,</span> <span>&#34;♭&#34;</span><span>).</span><span>Replace</span><span>(</span><span>&#34;#&#34;</span><span>,</span> <span>&#34;♯&#34;</span><span>);</span>

    <span>public</span> <span>Chord</span><span>(</span><span>string</span> <span>line</span><span>)</span> <span>{</span>
        <span>var</span> <span>tokens</span> <span>=</span> <span>line</span><span>.</span><span>Split</span><span>(</span><span>&#34;:&#34;</span><span>);</span>
        <span>Time</span> <span>=</span> <span>float</span><span>.</span><span>Parse</span><span>(</span><span>tokens</span><span>[</span><span>0</span><span>].</span><span>Trim</span><span>());</span>
        <span>Name</span> <span>=</span> <span>tokens</span><span>[</span><span>1</span><span>].</span><span>Trim</span><span>();</span>
    <span>}</span>
<span>}</span>
</code></pre></div></div>

<p>and the <code>ImageVideoFrameWrapper&lt;T&gt;</code> class that I’m using to get data from ImageSharp into the FFMPEG input buffer:</p>

<div><div><pre><code><span>using</span> <span>System.Runtime.CompilerServices</span><span>;</span>
<span>using</span> <span>FFMpegCore.Pipes</span><span>;</span>
<span>using</span> <span>SixLabors.ImageSharp</span><span>;</span>
<span>using</span> <span>SixLabors.ImageSharp.PixelFormats</span><span>;</span>

<span>namespace</span> <span>ChordMaker</span><span>;</span> 

<span>public</span> <span>class</span> <span>ImageVideoFrameWrapper</span><span>&lt;</span><span>T</span><span>&gt;</span> <span>:</span> <span>IVideoFrame</span><span>,</span> <span>IDisposable</span> <span>where</span> <span>T</span> <span>:</span> <span>unmanaged</span><span>,</span> <span>IPixel</span><span>&lt;</span><span>T</span><span>&gt;</span> <span>{</span>
    <span>public</span> <span>int</span> <span>Width</span> <span>=&gt;</span> <span>Source</span><span>.</span><span>Width</span><span>;</span>
    <span>public</span> <span>int</span> <span>Height</span> <span>=&gt;</span> <span>Source</span><span>.</span><span>Height</span><span>;</span>
    <span>public</span> <span>string</span> <span>Format</span> <span>=&gt;</span> <span>&#34;rgba&#34;</span><span>;</span>
    <span>public</span> <span>Image</span><span>&lt;</span><span>T</span><span>&gt;</span> <span>Source</span> <span>{</span> <span>get</span><span>;</span> <span>private</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>ImageVideoFrameWrapper</span><span>(</span><span>Image</span><span>&lt;</span><span>T</span><span>&gt;</span> <span>source</span><span>)</span> <span>{</span>
        <span>Source</span> <span>=</span> <span>source</span> <span>??</span> <span>throw</span> <span>new</span> <span>ArgumentNullException</span><span>(</span><span>nameof</span><span>(</span><span>source</span><span>));</span>
    <span>}</span>

    <span>public</span> <span>void</span> <span>Serialize</span><span>(</span><span>Stream</span> <span>stream</span><span>)</span> <span>{</span>
        <span>byte</span><span>[]</span> <span>pixelBytes</span> <span>=</span> <span>new</span> <span>byte</span><span>[</span><span>Source</span><span>.</span><span>Width</span> <span>*</span> <span>Source</span><span>.</span><span>Height</span> <span>*</span> <span>Unsafe</span><span>.</span><span>SizeOf</span><span>&lt;</span><span>Rgba32</span><span>&gt;()];</span>
        <span>Source</span><span>.</span><span>CopyPixelDataTo</span><span>(</span><span>pixelBytes</span><span>);</span>
        <span>stream</span><span>.</span><span>Write</span><span>(</span><span>pixelBytes</span><span>,</span> <span>0</span><span>,</span> <span>pixelBytes</span><span>.</span><span>Length</span><span>);</span>
    <span>}</span>

    <span>public</span> <span>async</span> <span>Task</span> <span>SerializeAsync</span><span>(</span><span>Stream</span> <span>stream</span><span>,</span> <span>CancellationToken</span> <span>token</span><span>)</span> <span>{</span>
        <span>var</span> <span>pixelBytes</span> <span>=</span> <span>new</span> <span>byte</span><span>[</span><span>Source</span><span>.</span><span>Width</span> <span>*</span> <span>Source</span><span>.</span><span>Height</span> <span>*</span> <span>Unsafe</span><span>.</span><span>SizeOf</span><span>&lt;</span><span>Rgba32</span><span>&gt;()];</span>
        <span>Source</span><span>.</span><span>CopyPixelDataTo</span><span>(</span><span>pixelBytes</span><span>);</span>
        <span>await</span> <span>stream</span><span>.</span><span>WriteAsync</span><span>(</span><span>pixelBytes</span><span>,</span> <span>0</span><span>,</span> <span>pixelBytes</span><span>.</span><span>Length</span><span>);</span>
    <span>}</span>

    <span>public</span> <span>void</span> <span>Dispose</span><span>()</span> <span>{</span>
        <span>Source</span><span>.</span><span>Dispose</span><span>();</span>
    <span>}</span>
<span>}</span>
</code></pre></div></div>

<p>That’ll create a transparent video file with moving chords on it in  <code>chords.webm</code>.  The final step is to composite this video onto the original backing video, which is another job for <code>ffmpeg</code>:</p>

<div><div><pre><code>ffmpeg
  <span># input file #0:</span>
  <span>-i</span> original.mp4
  <span># video codec for input file #1: libvpx-vp9</span>
  <span>-c</span>:v libvpx-vp9 
  <span># input file #1</span>
  <span>-i</span> chords.webm
  <span># video filter: scale video #1 to 1280x720, store that in [z], then overlay [z] onto video #0</span>
  <span>-filter_complex</span> <span>&#34;[1:v]scale=1280:720[z];[0:v][z]overlay&#34;</span> 
  <span># video codec for output: libx264</span>
  <span>-c</span>:v libx264 
  <span># video bitrate for output@: 2500kbps</span>
  <span>-b</span>:v 2500k 
  <span># output filename</span>
  composite.mp4
</code></pre></div></div>

<p>That’ll produce <code>composite.mp4</code>, which is the original backing video with the transparent chord overlay composited onto the top of it. It’s also a 4-minute video I don’t have permission to publish online, with a 5.1 surround sound mix that’s going to sound really weird unless you’re running it through the right audio gear, so just for all you folks following along at home, I ran it through <code>ffmpeg</code> one more time:</p>

<div><div><pre><code>ffmpeg 
  <span># input file: </span>
  <span>-i</span> .<span>\c</span>omposite.mp4 
  <span># audio channels: 2</span>
  <span>-ac</span> 2 
  <span># audio filter: render 5.1 down to 2.0 audio.</span>
  <span>#  FL (front left) = 0.7 * FC (front center), + 0.70 * FL (front left) + 1.0 * BL (back left)</span>
  <span>#  FR (front left) = 0.7 * FC (front center), + 0.70 * FR (front right) + 1.0 * BR (back right)</span>
  <span>-af</span> <span>&#34;pan=stereo|FL=0.7*FC+0.70*FL+1.0*BL|FR=0.7*FC+0.70*FR+1.0*BR&#34;</span> 
  <span># skip start time to 45 seconds </span>
  <span>-ss</span> 00:00:45 
  <span># trim video length to 30 seconds</span>
  <span>-t</span> 00:00:30 
  <span># use the codec for video: libx264</span>
  <span>-c</span>:v libx264 
  <span># set the video bitrate to 2500kbps</span>
  <span>-b</span>:v 2500k 
  <span># use the codec for audio: aac</span>
  <span>-c</span>:a aac 
  <span># output filename</span>
  guitaraoke-demo.mp4
</code></pre></div></div>

<p>That’ll produce a 30-second clip, in regular stereo, which I’ve uploaded to YouTube so you can see the results:</p>

<iframe width="640" height="360" src="https://www.youtube.com/embed/r_e4PJLCEdg" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<p>That’s a pretty convincing proof of concept… but there’s a world of difference between doing it once, with one clip, and being able to churn out the 50+ tracks you need to actually run a karaoke night. So next steps are to add beat detection, so I can quantise the timing of the chord changes to land on the beat exactly. Not essential, but nice to have.</p>

<p>I also need to automate the various steps - video &gt; WAV &gt; chords &gt; overlay &gt; composite - so I can churn this thing across a folder full of tracks and spit out dozens of videos at a time. I suspect some tracks will need some manual editing of the chord data before rendering the video, so I also need to figure out a way to run a high-speed version, probably 12fps at 640x360, to check the results, and then the high-quality 1280x720 60fps version to produce the final video.</p>

<p>And if you want to see it in action, come along to the <a href="https://ignition.beer/">Ignition Brewery and Taproom</a> on the third Saturday of the month and check it out. Bonus points if you actually get up and play something. 🎸🤘🍻</p>

<h3 id="links">Links</h3>

<ul>
  <li>ImageSharp: <a href="https://sixlabors.com/products/imagesharp/">https://sixlabors.com/products/imagesharp/</a></li>
  <li>FFMPEGCore: <a href="https://github.com/rosenbjerg/FFMpegCore">https://github.com/rosenbjerg/FFMpegCore</a></li>
  <li>Vamp Plugins: <a href="https://www.vamp-plugins.org/">https://www.vamp-plugins.org/</a></li>
  <li>Chordino plugin for Vamp: <a href="https://code.soundsoftware.ac.uk/projects/nnls-chroma/">https://code.soundsoftware.ac.uk/projects/nnls-chroma/</a></li>
  <li>Guitaraoke: <a href="https://guitaraoke.live/">https://guitaraoke.live/</a></li>
  <li>Karaoke tracks and videos purchased from <a href="https://www.karaoke-version.co.uk/karaoke/">https://www.karaoke-version.co.uk/karaoke/</a></li>
</ul>

					</article>
				</div>
			</div>
			
		</div>
	</div>
</section>

				</div>
			</div>
		</section>

		<!-- Footer -->
		

	</div></div>
  </body>
</html>
