<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://www.netbsd.org/~nia/tigersrc/">Original</a>
    <h1>The challenges of building modern open source software on PowerPC Mac OS X</h1>
    
    <div id="readability-page-1" class="page">

<h2>Introduction</h2>
<p>
PowerPC Macs were produced in huge numbers, and a lot of this hardware
is still viable for use today, with professional software such as
Photoshop CS2 and Propellerheads Reason. They&#39;re still good
workstations, with lots of productivity software,
and no always-online tracking or distractions. Originally, I got mine
for running NetBSD, but found the pull of 20 year old commercial software
too tempting to resist.
</p>
<p>
Regardless, how usable is Mac OS X 10.4 for Unix professionals,
software developers, and command-line junkies? A surprising
amount of free software can still run, often with some
simple adjustments. The <a href="https://www.pkgsrc.org">pkgsrc</a>
framework offers a platform-netural repository with powerful
frameworks that allow wide porting of software.
</p>
<p>
Pre-built PowerPC binaries for popular software are available,
including PostgreSQL, ImageMagick, Python 3, Wget, cURL, FFmpeg,
OpenSSH, OpenSSL, Apache Web Server, nginx, yt-dlp, SDL,
Midnight Commander, and many more.
</p>
<p>
Note: I make no guarantees about the security or up-to-dateness
of these packages, though I pinky promise they&#39;re better than what
Tiger includes by default.  No warranty. Your fridge may explode.
You may find you&#39;re suddenly able to connect to servers that
use modern encryption, with all the risks that entails.
</p>
<h2>How to install software</h2>
<h3>Bootstrapping</h3>
<p><a href="https://ftp.NetBSD.org/pub/pkgsrc/misc/nia/tigersrc/bootstrap-tiger.tar.gz">Download the bootstrap kit</a></p>
<p>Extract the bootstrap kit on 10.4, set your <code>PATH</code>:</p>
<pre><code>
$ sudo tar -C / -xzpvf bootstrap-tiger.tar.gz
$ export PATH=/usr/pkg/sbin:/usr/pkg/bin:$PATH
$ export PKG_PATH=https://ftp.NetBSD.org/pub/pkgsrc/misc/nia/tigersrc/packages/All/
</code>
</pre>
<p>Add the last two lines to <code>~/.bash_profile</code>.
</p><h3>Installing packages</h3>
<p><a href="https://ftp.NetBSD.org/pub/pkgsrc/misc/nia/tigersrc/packages/All/">Browse the repository</a></p>
<pre><code>
$ sudo pkg_add ffmpeg2
</code>
</pre>
<h2>Challenges building modern software on 10.4</h2>
<p>Part of this project is <em>just for fun</em>. Since I&#39;m a developer
specialized in build systems, I get enjoyment out of pushing pkgsrc as far
as possible. Therefore, others should get to learn from this too.</p>
<p>Refer to the <a href="http://www.netbsd.org/~nia/tigersrc/mk.conf">mk.conf</a> used for this repository,
containing some non-upstreamed workarounds, and the
<a href="http://www.netbsd.org/~nia/tigersrc/tiger-packages.txt">allowlist of packages</a>.</p>
<ul>
<li><strong>Compiler:</strong> XCode&#39;s GCC 4.0 does not support C++11 or C11.
    Some software expects the compiler to default to C99,
    and does not explicitly specify <code>-std=c99</code> in <code>CFLAGS</code>.
    This older version of GCC supports C99 but does not default to it,
    which should be worked around by setting <code>FORCE_C_STD</code>
    in pkgsrc. Many pieces of modern software like to specify lots of unsupported
    -W and -Wno arguments to customize warnings. These can be stripped out with pkgsrc&#39;s
    <code>BUILDLINK_TRANSFORM</code>.</li>
<li><strong>Linker:</strong> The strict Mach-O linker included in Tiger is
    quite different from what modern software expects (e.g. it does not
    support <code>-shared</code>), <em>unless</em> that software uses libtool to make
    shared libraries in a portable manner.
    pkgsrc has long had a policy of &#34;libtoolization&#34;, patching software that
    builds with plain Makefiles to use libtool.
    <code>BUILDLINK_TRANSFORM</code> can also translate many GNU ELF-style
    linker arguments to be compatible with the Darwin linker.
    I also found the <code>-m</code> option (for making multiply-defined
    symbols into a warning instead of an error) useful.</li>
<li><strong>Library:</strong> Now-ubiqitious functions are missing, including
    <code>clock_gettime</code> and <code>strnlen</code>.
    These can easily be substituted from either <code>libnbcompat</code> or
    <code>macports-legacy-support</code>.</li>
<li><strong>Atomics:</strong> Some wide atomic instructions are missing
    from 32-bit PowerPC. This isn&#39;t a PowerPC or Darwin-specific problem,
    since it affects other 32-bit instruction sets like i486.</li>
<li><strong>Rust:</strong> Even if it worked on this platform, build times
    would be completely unacceptable. We use the pre-Rust versions of
    software like py-cryptography, since pkgsrc makes this easy. Reduce CO2 emissions,
    keep writing C.</li>
<li><strong>Locales:</strong> Certain UTF-8 file names fail to extract with
    <em>bsdtar</em>, with the UTF-8 sequences
    being detected as invalid. I haven&#39;t done much research into this yet,
    but it affects very few packages, such as the Icelandic aspell
    dictionary. This is probably not a bsdtar problem, since it
    works on NetBSD with the same tar version.</li>
<li><strong>Toolchain bugs:</strong> There is a problem with
    <code>signal.h</code> that causes some software to fail to compile.
    This can be easily worked around by disabling the relevant type definitions
    by pre-defining macros in <code>CFLAGS</code>.</li>
<li><strong>Kernel bugs:</strong> Sadly, <code>kqueue</code> does not work
    properly on Tiger. kqueue support is nearly always optional in software,
    but sometimes the detection needs to be turned off for this OS version.
    GNU configure makes this easy, other build systems may vary.</li>
<li><strong>Other curiosities:</strong> The default dashboard widgets and
    screensaver in 10.4 use a surprising amount of CPU time that could be
    better spent on GCC. They&#39;re easy to disable, though.</li>
</ul>
<p>Most of these problems are <em>very general</em>, so there&#39;s a lot of
benefit to be gained from automatically making these adjustments for everything.</p>
<p>A big problem for this project is the wider ecosystem (well, mostly GNOME-adjacent
libraries) moving away from the GNU build system, which mostly solved the
problem of building shared libraries on different platforms years ago,
as well as nicely handling feature detection.  More work needs to be done before
CMake and Meson can work well on this platform, but also a way to say to them
&#34;yes, this OS has this feature, but please ignore it&#34; would be very useful
(also for testing!).
</p>
<p>Related to the issue of 64-bit atomics is the world moving away from 32-bit
platforms. If you&#39;re a stranger to the embedded world, this is happening
more slowly than you might think. While Mac OS X suffers from the Year 2038
Problem, NetBSD solved it years ago. 64-bit wide atomic instructions
are unavailable on many NetBSD ports, with libatomic being a hacky workaround
at best.</p>
<p>Most importantly, if you maintain a C/C++ software project, and don&#39;t specify
<code>-std=(gnu|c)XX</code> in your build sytem already, <em>please do</em>.
Keep in mind that <code>-Werror</code> will fall over the moment you try building with
a compiler version that you haven&#39;t tested personally, and distribution maintainers
will want to disable it. For pkgsrc on modern platforms, at any one time we&#39;re building
with around 4 different major versions of GCC plus Clang, so we&#39;d disable it
even if we weren&#39;t supporting crusty old stuff.</p>
<h2>See also</h2>
<ul>
<li><a href="https://www.macports.org/">MacPorts</a> - lots of prior art</li>
<li><a href="https://github.com/mistydemeo/tigerbrew">TigerBrew</a> - lots of frozen packages to prevent them breaking, pkgsrc being more &#34;live&#34;</li>
<li><a href="https://www.macintoshrepository.org/">Macintosh Repository</a> - useful for obtaining XCode</li>
</ul>
<small>
<p>nia from the domain pkgsrc.org</p>
<p>
<a href="https://validator.w3.org/markup/check?uri=referer"><img src="https://www.w3.org/Icons/valid-html401" alt="Valid HTML 4.01 Strict" height="31" width="88"/></a>
</p>
</small>


</div>
  </body>
</html>
