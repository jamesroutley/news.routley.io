<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://camillovisini.com/coding/phlex-for-rails-emails-action-mailer-without-erb">Original</a>
    <h1>Phlex for Rails Emails: Action Mailer Without ERB</h1>
    
    <div id="readability-page-1" class="page"><div> <p>Writing Ruby all day is fun, but writing Ruby in HTML is not. In the past months, I found switching from Ruby to ERB views and partials to be interrupting my flow and therefore increasingly annoying. Enter <a href="https://www.phlex.fun/" target="_blank">Phlex</a>, which is a Ruby library that allows you to write HTML (components, views, layouts) in pure Ruby. After already completely ditching ERB for Phlex in Rails views for multiple applications, I wanted to see if I could do the same for Action Mailer. ERB be gone!</p>
<p>Why might this be interesting, besides just trying it out for the sake of it, and to see if it’s possible? I see these benefits:</p>
<ul>
<li>No more ERB: Use Phlex all the way, even for mailers</li>
<li>Manage the HTML and text version of the email in one place</li>
<li>Use Phlex components for layouts and views</li>
</ul>
<p>As for my part, I could gladly live without ERB in my Rails applications. After all, if it does not <a href="https://konmari.com/marie-kondo-rules-of-tidying-sparks-joy/" target="_blank">spark joy</a> when you touch it, you should get rid of it.</p>
<p>Check out the repository for the full code. I hope you find this as exciting as I do!</p>

<p>Let’s begin by setting up a mailer in our Rails app so we can demonstrate how to move everything to Phlex.</p>
<h2 id="the-erb-way">The ERB Way</h2>
<p>The <code>UserMailer</code> class is our entry point into Action Mailer, which handles email delivery in Rails. Nothing special to see here, this is Rails 101. It’s basically what we get when we generate a mailer (e.g., <code>rails g mailer UserMailer</code>).</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rb" data-theme="one-dark-pro one-light">app/mailers/user_mailer.rb</figcaption><pre tabindex="0" data-language="rb" data-theme="one-dark-pro one-light"><code data-language="rb" data-theme="one-dark-pro one-light"><span data-line=""><span>class</span><span> UserMailer</span><span> &lt;</span><span> ApplicationMailer</span></span>
<span data-line=""><span>  def</span><span> welcome</span></span>
<span data-line=""><span>    @user</span><span> =</span><span> params[</span><span>:</span><span>user</span><span>]</span></span>
<span data-line=""><span>    mail</span><span>(</span><span>to</span><span>:</span><span> @user</span><span>.</span><span>email</span><span>, </span><span>subject</span><span>:</span><span> &#34;Welcome&#34;</span><span>)</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""><span>end</span></span></code></pre></figure>
<p>We also need some corresponding view files or “email templates”. Not all email clients render HTML, so we need to provide both a HTML and a text version. We can use ERB to use Ruby code in the templates (for example, to access instance variables or to use helper methods). In terms of files, this means that we need one template for the HTML version:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="html" data-theme="one-dark-pro one-light">app/views/user_mailer/welcome.html.erb</figcaption><pre tabindex="0" data-language="html" data-theme="one-dark-pro one-light"><code data-language="html" data-theme="one-dark-pro one-light"><span data-line=""><span>&lt;</span><span>div</span><span>&gt;We are excited to have you join us! Thank you for signing up.&lt;/</span><span>div</span><span>&gt;</span></span>
<span data-line=""> </span>
<span data-line=""><span>&lt;</span><span>%= link_to &#39;Click here to sign in&#39;, &#39;https://example.com&#39; %&gt;</span></span></code></pre></figure>
<p>And one for the text version:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="text" data-theme="one-dark-pro one-light">app/views/user_mailer/welcome.text.erb</figcaption><pre tabindex="0" data-language="text" data-theme="one-dark-pro one-light"><code data-language="text" data-theme="one-dark-pro one-light"><span data-line=""><span>We are excited to have you join us! Thank you for signing up.</span></span>
<span data-line=""> </span>
<span data-line=""><span>Click here to sign in: https://example.com</span></span></code></pre></figure>
<p>We also need to add some basic layouts. In the layout, you might add a logo at the top of the email, place links in a footer, add contact information, and so on.</p>
<p>Because these parts are in the layout, they become easy to manage: When you want to change the layout, you can change everything in one place. For now, we keep it simple, and just add the application name and a “signature” at the end, to demonstrate how the layout wraps around the email content.</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="html" data-theme="one-dark-pro one-light">app/views/layouts/mailer.html.erb</figcaption><pre tabindex="0" data-language="html" data-theme="one-dark-pro one-light"><code data-language="html" data-theme="one-dark-pro one-light"><span data-line=""><span>&lt;!</span><span>DOCTYPE</span><span> html</span><span>&gt;</span></span>
<span data-line=""><span>&lt;</span><span>html</span><span>&gt;</span></span>
<span data-line=""><span>  &lt;</span><span>head</span><span>&gt;</span></span>
<span data-line=""><span>    &lt;</span><span>meta</span><span> http-equiv</span><span>=</span><span>&#34;Content-Type&#34;</span><span> content</span><span>=</span><span>&#34;text/html; charset=utf-8&#34;</span><span>&gt;</span></span>
<span data-line=""><span>  &lt;/</span><span>head</span><span>&gt;</span></span>
<span data-line=""><span>  &lt;</span><span>body</span><span>&gt;</span></span>
<span data-line=""><span>    &lt;</span><span>div</span><span>&gt;&lt;</span><span>b</span><span>&gt;Application Name&lt;/</span><span>b</span><span>&gt;&lt;/</span><span>div</span><span>&gt;</span></span>
<span data-line=""> </span>
<span data-line=""><span>    &lt;</span><span>%= yield %&gt;</span></span>
<span data-line=""> </span>
<span data-line=""><span>    &lt;</span><span>div</span><span>&gt;Best Regards,&lt;/</span><span>div</span><span>&gt;</span></span>
<span data-line=""><span>    &lt;</span><span>div</span><span>&gt;Company Name&lt;/</span><span>div</span><span>&gt;</span></span>
<span data-line=""><span>  &lt;/</span><span>body</span><span>&gt;</span></span>
<span data-line=""><span>&lt;/</span><span>html</span><span>&gt;</span></span></code></pre></figure>
<p>For the text version, we mirror the of the HTML version. Since we can’t use HTML, we need to keep it simple and work with plain text. We may use line breaks or adding horizontal rules to separate sections, but for now we keep it simple:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="text" data-theme="one-dark-pro one-light">app/views/layouts/mailer.text.erb</figcaption><pre tabindex="0" data-language="text" data-theme="one-dark-pro one-light"><code data-language="text" data-theme="one-dark-pro one-light"><span data-line=""><span>Application Name</span></span>
<span data-line=""> </span>
<span data-line=""><span>&lt;%= yield %&gt;</span></span>
<span data-line=""> </span>
<span data-line=""><span>Best Regards,</span></span>
<span data-line=""><span>Company Name</span></span></code></pre></figure>
<p>The above template plus their layout produces the following email messages. First, the HTML version:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="html" data-theme="one-dark-pro one-light"><code data-language="html" data-theme="one-dark-pro one-light"><span data-line=""><span>&lt;!</span><span>DOCTYPE</span><span> html</span><span>&gt;</span></span>
<span data-line=""><span>&lt;</span><span>html</span><span>&gt;</span></span>
<span data-line=""><span>  &lt;</span><span>head</span><span>&gt;</span></span>
<span data-line=""><span>    &lt;</span><span>meta</span><span> http-equiv</span><span>=</span><span>&#34;Content-Type&#34;</span><span> content</span><span>=</span><span>&#34;text/html; charset=utf-8&#34;</span><span>&gt;</span></span>
<span data-line=""><span>  &lt;/</span><span>head</span><span>&gt;</span></span>
<span data-line=""><span>  &lt;</span><span>body</span><span>&gt;</span></span>
<span data-line=""><span>    &lt;</span><span>div</span><span>&gt;&lt;</span><span>b</span><span>&gt;Application Name&lt;/</span><span>b</span><span>&gt;&lt;/</span><span>div</span><span>&gt;</span></span>
<span data-line=""> </span>
<span data-line=""><span>    &lt;</span><span>div</span><span>&gt;We are excited to have you join us! Thank you for signing up.&lt;/</span><span>div</span><span>&gt;</span></span>
<span data-line=""> </span>
<span data-line=""><span>    &lt;</span><span>a</span><span> href</span><span>=</span><span>&#34;https://example.com&#34;</span><span>&gt;Click here to sign in&lt;/</span><span>a</span><span>&gt;</span></span>
<span data-line=""> </span>
<span data-line=""><span>    &lt;</span><span>div</span><span>&gt;Best Regards,&lt;/</span><span>div</span><span>&gt;</span></span>
<span data-line=""><span>    &lt;</span><span>div</span><span>&gt;Company Name&lt;/</span><span>div</span><span>&gt;</span></span>
<span data-line=""><span>  &lt;/</span><span>body</span><span>&gt;</span></span>
<span data-line=""><span>&lt;/</span><span>html</span><span>&gt;</span></span></code></pre></figure>
<p>And the text version:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="txt" data-theme="one-dark-pro one-light"><code data-language="txt" data-theme="one-dark-pro one-light"><span data-line=""><span>Application Name</span></span>
<span data-line=""> </span>
<span data-line=""><span>We are excited to have you join us! Thank you for signing up.</span></span>
<span data-line=""> </span>
<span data-line=""><span>Click here to sign in: https://example.com</span></span>
<span data-line=""> </span>
<span data-line=""><span>Best Regards,</span></span>
<span data-line=""><span>Company Name</span></span></code></pre></figure>
<p>As you can see, the email content is rendered with the layout wrapped around it.</p>
<p>By creating a test, we can assert the email content for the HTML and text version via fixtures. We can leverage the <code>read_fixture</code> helper (see the <a href="https://guides.rubyonrails.org/v8.0.0/testing.html#revenge-of-the-fixtures" target="_blank">Rails Guide on Testing</a>) to load the fixture files and compare them to the email content. We create a simple helper method <code>assert_mailer_fixtures</code> to conveniently assert both versions.</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rb" data-theme="one-dark-pro one-light">test/mailers/user_mailer_test.rb</figcaption><pre tabindex="0" data-language="rb" data-theme="one-dark-pro one-light"><code data-language="rb" data-theme="one-dark-pro one-light"><span data-line=""><span>require </span><span>&#34;test_helper&#34;</span></span>
<span data-line=""> </span>
<span data-line=""><span>class</span><span> UserMailerTest</span><span> &lt;</span><span> ActionMailer</span><span>::</span><span>TestCase</span></span>
<span data-line=""><span>  test</span><span> &#34;welcome&#34;</span><span> do</span></span>
<span data-line=""><span>    user</span><span> = </span><span>User</span><span>.</span><span>new</span><span>(</span><span>email</span><span>:</span><span> &#34;<a href="https://camillovisini.com/cdn-cgi/l/email-protection" data-cfemail="fc8893bc99849d918c9099d29f9391">[email protected]</a>&#34;</span><span>)</span></span>
<span data-line=""><span>    email</span><span> = </span><span>UserMailer</span><span>.</span><span>with</span><span>(</span><span>user</span><span>:</span><span> user).</span><span>welcome</span></span>
<span data-line=""> </span>
<span data-line=""><span>    assert_equal [</span><span>&#34;<a href="https://camillovisini.com/cdn-cgi/l/email-protection" data-cfemail="ccaabea3a18ca9b4ada1bca0a9e2afa3a1">[email protected]</a>&#34;</span><span>], email.</span><span>from</span></span>
<span data-line=""><span>    assert_equal [</span><span>&#34;<a href="https://camillovisini.com/cdn-cgi/l/email-protection" data-cfemail="582c37183d20393528343d763b3735">[email protected]</a>&#34;</span><span>], email.</span><span>to</span></span>
<span data-line=""><span>    assert_equal </span><span>&#34;Welcome&#34;</span><span>, email.</span><span>subject</span></span>
<span data-line=""> </span>
<span data-line="" data-highlighted-line=""><span>    assert_mailer_fixtures</span><span>(</span><span>&#34;welcome&#34;</span><span>, email)</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""> </span>
<span data-line=""><span>  private</span></span>
<span data-line=""> </span>
<span data-line=""><span>  # This checks the email content against the fixtures.</span></span>
<span data-line=""><span>  # For example, for UserMailer#welcome, it checks against:</span></span>
<span data-line=""><span>  # test/fixtures/user_mailer/welcome.txt</span></span>
<span data-line=""><span>  # test/fixtures/user_mailer/welcome.html</span></span>
<span data-line=""><span>  def</span><span> assert_mailer_fixtures</span><span>(</span><span>name</span><span>, </span><span>email</span><span>)</span></span>
<span data-line=""><span>    email_body_html</span><span> = email.</span><span>html_part</span><span>.</span><span>body</span><span>.</span><span>to_s</span></span>
<span data-line=""><span>    email_body_text</span><span> = email.</span><span>text_part</span><span>.</span><span>body</span><span>.</span><span>to_s</span><span>.</span><span>strip</span></span>
<span data-line="" data-highlighted-line=""><span>    expected_html</span><span> = </span><span>read_fixture</span><span>(</span><span>&#34;</span><span>#{</span><span>name</span><span>}</span><span>.html&#34;</span><span>).</span><span>join</span><span>.</span><span>strip</span></span>
<span data-line="" data-highlighted-line=""><span>    expected_text</span><span> = </span><span>read_fixture</span><span>(</span><span>&#34;</span><span>#{</span><span>name</span><span>}</span><span>.txt&#34;</span><span>).</span><span>join</span><span>.</span><span>strip</span></span>
<span data-line=""><span>    fixture_html</span><span> = </span><span>Nokogiri</span><span>::</span><span>HTML</span><span>.</span><span>parse</span><span>(expected_html).</span><span>to_html</span><span>.</span><span>strip</span></span>
<span data-line=""><span>    email_html</span><span> = </span><span>Nokogiri</span><span>::</span><span>HTML</span><span>.</span><span>parse</span><span>(email_body_html).</span><span>to_html</span><span>.</span><span>strip</span></span>
<span data-line=""><span>    assert_dom_equal fixture_html, email_html</span></span>
<span data-line=""><span>    assert_equal expected_text, email_body_text</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""><span>end</span></span></code></pre></figure>
<p>We now have a basic setup for sending emails with Action Mailer – the ERB way. The next step is to refactor the views and layouts to use Phlex. This test ensures that while we refactor, we produce exactly the same email content (HTML and text) while we move from ERB to Phlex.</p>
<h2 id="using-phlex-views-for-email-templates">Using Phlex Views for Email Templates</h2>
<p>To install Phlex in our Rails app, we follow the <a href="https://www.phlex.fun/introduction/getting-started.html#installing-phlex-in-a-rails-app" target="_blank">installation instructions</a>. In particular, we run the install generator to create base classes and directories for our views (the generator provides an opinionated starting point with a folder structure and naming convention for views and components).</p>
<p>Then, we can create the Phlex views for the email templates. We might place all mailer views under <code>app/views/mailers</code> and create a subfolder for each mailer. Similar to with the ERB templates, we need to create a view for the HTML version and one for the text version. First, we create the HTML view:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rb" data-theme="one-dark-pro one-light">app/views/mailers/users/welcome/html.rb</figcaption><pre tabindex="0" data-language="rb" data-theme="one-dark-pro one-light"><code data-language="rb" data-theme="one-dark-pro one-light"><span data-line=""><span>class</span><span> Views</span><span>::</span><span>Mailers</span><span>::</span><span>Users</span><span>::</span><span>Welcome</span><span>::</span><span>Html</span><span> &lt;</span><span> Views</span><span>::</span><span>Base</span></span>
<span data-line=""><span>  def</span><span> initialize</span><span>(</span><span>user</span><span>)</span></span>
<span data-line=""><span>    @user</span><span> =</span><span> user</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""> </span>
<span data-line=""><span>  def</span><span> view_template</span></span>
<span data-line=""><span>    div </span><span>do</span></span>
<span data-line=""><span>      plain </span><span>&#34;We are excited to have you join us! Thank you for signing up.&#34;</span></span>
<span data-line=""><span>    end</span></span>
<span data-line=""> </span>
<span data-line=""><span>    a </span><span>href</span><span>:</span><span> &#34;https://example.com&#34;</span><span> do</span></span>
<span data-line=""><span>      plain </span><span>&#34;Click here to sign in&#34;</span></span>
<span data-line=""><span>    end</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""><span>end</span></span></code></pre></figure>
<p>And then the text view:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rb" data-theme="one-dark-pro one-light">app/views/mailers/users/welcome/text.rb</figcaption><pre tabindex="0" data-language="rb" data-theme="one-dark-pro one-light"><code data-language="rb" data-theme="one-dark-pro one-light"><span data-line=""><span>class</span><span> Views</span><span>::</span><span>Mailers</span><span>::</span><span>Users</span><span>::</span><span>Welcome</span><span>::</span><span>Text</span><span> &lt;</span><span> Views</span><span>::</span><span>Base</span></span>
<span data-line=""><span>  def</span><span> initialize</span><span>(</span><span>user</span><span>)</span></span>
<span data-line=""><span>    @user</span><span> =</span><span> user</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""> </span>
<span data-line=""><span>  def</span><span> view_template</span></span>
<span data-line=""><span>    plain </span><span>&#34;We are excited to have you join us! Thank you for signing up.&#34;</span></span>
<span data-line=""><span>    plain </span><span>&#34;</span><span>\n\n</span><span>&#34;</span></span>
<span data-line=""><span>    plain </span><span>&#34;Click here to sign in: https://example.com&#34;</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""><span>end</span></span></code></pre></figure>
<p>Inside the ERB templates, we render the Phlex views. For the HTML version:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rb" data-theme="one-dark-pro one-light">app/views/user_mailer/welcome.html.erb</figcaption><pre tabindex="0" data-language="rb" data-theme="one-dark-pro one-light"><code data-language="rb" data-theme="one-dark-pro one-light"><span data-line=""><span>&lt;%=</span><span> render </span><span>Views</span><span>::</span><span>Mailers</span><span>::</span><span>Users</span><span>::</span><span>Welcome</span><span>::</span><span>Html</span><span>.</span><span>new</span><span>(</span><span>user</span><span>:</span><span> @user</span><span>) </span><span>%&gt;</span></span></code></pre></figure>
<p>And for the text version:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rb" data-theme="one-dark-pro one-light">app/views/user_mailer/welcome.text.erb</figcaption><pre tabindex="0" data-language="rb" data-theme="one-dark-pro one-light"><code data-language="rb" data-theme="one-dark-pro one-light"><span data-line=""><span>&lt;%=</span><span> render </span><span>Views</span><span>::</span><span>Mailers</span><span>::</span><span>Users</span><span>::</span><span>Welcome</span><span>::</span><span>Text</span><span>.</span><span>new</span><span>(</span><span>user</span><span>:</span><span> @user</span><span>) </span><span>%&gt;</span></span></code></pre></figure>
<p>Now what? This seems like a tiny step forward. We have the same content, only now it’s rendered via Phlex views instead of ERB templates, but we still need the ERB files as an “entry point”. Even worse, we have gone from two files to four files for the templates, which adds overhead – not ideal! But we are not done yet. Let’s have a look at layouts next, Phlex style.</p>
<h2 id="setting-up-phlex-layouts-for-mailers">Setting up Phlex Layouts for Mailers</h2>
<p>Similar to the ERB layouts, we can create Phlex layouts for our email templates. But first, let’s tell Action Mailer to not use any layouts, because we will compose the templates on our own from layouts and views with Phlex.</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rb" data-theme="one-dark-pro one-light">app/mailers/application_mailer.rb</figcaption><pre tabindex="0" data-language="rb" data-theme="one-dark-pro one-light"><code data-language="rb" data-theme="one-dark-pro one-light"><span data-line=""><span>class</span><span> ApplicationMailer</span><span> &lt;</span><span> ActionMailer</span><span>::</span><span>Base</span></span>
<span data-line=""><span>  default </span><span>from</span><span>:</span><span> &#34;<a href="https://camillovisini.com/cdn-cgi/l/email-protection" data-cfemail="8ceafee3e1cce9f4ede1fce0e9a2efe3e1">[email protected]</a>&#34;</span></span>
<span data-line="" data-highlighted-line=""><span>  layout </span><span>false</span></span>
<span data-line=""><span>end</span></span></code></pre></figure>
<p>We can delete <code>app/views/layouts/mailer.html.erb</code> and <code>app/views/layouts/mailer.text.erb</code> as they are no longer needed. Instead, we create Phlex layouts for the email templates – you could use a tool like <a href="https://www.phlexing.fun" target="_blank">phlexing.fun</a> to convert HTML to Phlex. First, we create a layout for the HTML version:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rb" data-theme="one-dark-pro one-light">app/components/layouts/mailers/html.rb</figcaption><pre tabindex="0" data-language="rb" data-theme="one-dark-pro one-light"><code data-language="rb" data-theme="one-dark-pro one-light"><span data-line=""><span>class</span><span> Components</span><span>::</span><span>Layouts</span><span>::</span><span>Mailers</span><span>::</span><span>Html</span><span> &lt;</span><span> Phlex</span><span>::</span><span>HTML</span></span>
<span data-line=""><span>  def</span><span> view_template</span><span>(</span><span>&amp;</span><span>block</span><span>)</span></span>
<span data-line=""><span>    doctype</span></span>
<span data-line=""><span>    html </span><span>do</span></span>
<span data-line=""><span>      head </span><span>do</span></span>
<span data-line=""><span>        meta </span><span>charset</span><span>:</span><span> &#34;utf-8&#34;</span></span>
<span data-line=""><span>      end</span></span>
<span data-line=""><span>      body </span><span>do</span></span>
<span data-line=""><span>        div </span><span>do</span></span>
<span data-line=""><span>          b { </span><span>&#34;Application Name&#34;</span><span> }</span></span>
<span data-line=""><span>        end</span></span>
<span data-line=""><span>        yield</span><span> block</span></span>
<span data-line=""><span>        div { </span><span>&#34;Best Regards,&#34;</span><span> }</span></span>
<span data-line=""><span>        div { </span><span>&#34;Company Name&#34;</span><span> }</span></span>
<span data-line=""><span>      end</span></span>
<span data-line=""><span>    end</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""><span>end</span></span></code></pre></figure>
<p>And one for the text version:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rb" data-theme="one-dark-pro one-light">app/components/layouts/mailers/text.rb</figcaption><pre tabindex="0" data-language="rb" data-theme="one-dark-pro one-light"><code data-language="rb" data-theme="one-dark-pro one-light"><span data-line=""><span>class</span><span> Components</span><span>::</span><span>Layouts</span><span>::</span><span>Mailers</span><span>::</span><span>Text</span><span> &lt;</span><span> Phlex</span><span>::</span><span>HTML</span></span>
<span data-line=""><span>  def</span><span> view_template</span><span>(</span><span>&amp;</span><span>block</span><span>)</span></span>
<span data-line=""><span>    plain </span><span>&#34;Application Name&#34;</span></span>
<span data-line=""><span>    plain </span><span>&#34;</span><span>\n\n</span><span>&#34;</span></span>
<span data-line=""><span>    yield</span><span> block</span></span>
<span data-line=""><span>    plain </span><span>&#34;</span><span>\n\n\n</span><span>&#34;</span></span>
<span data-line=""><span>    plain </span><span>&#34;Best Regards,&#34;</span></span>
<span data-line=""><span>    plain </span><span>&#34;</span><span>\n</span><span>&#34;</span></span>
<span data-line=""><span>    plain </span><span>&#34;Company Name&#34;</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""><span>end</span></span></code></pre></figure>
<p>In the views, we use the <code>around_template</code> hook to tell the view to render with the particular layout (see <a href="https://www.phlex.fun/rails/layouts.html#layouts-through-inheritance" target="_blank">Phlex layout docs</a>).</p>
<p>For the HTML variant, this means we need something like this:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rb" data-theme="one-dark-pro one-light">app/views/mailers/users/welcome/html.rb</figcaption><pre tabindex="0" data-language="rb" data-theme="one-dark-pro one-light"><code data-language="rb" data-theme="one-dark-pro one-light"><span data-line=""><span>class</span><span> Views</span><span>::</span><span>Mailers</span><span>::</span><span>Users</span><span>::</span><span>Welcome</span><span>::</span><span>Html</span><span> &lt;</span><span> Views</span><span>::</span><span>Base</span></span>
<span data-line="" data-highlighted-line=""><span>  include</span><span> Components</span></span>
<span data-line=""> </span>
<span data-line=""><span>  def</span><span> initialize</span><span>(</span><span>user</span><span>)</span></span>
<span data-line=""><span>    @user</span><span> =</span><span> user</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""> </span>
<span data-line="" data-highlighted-line=""><span>  def</span><span> around_template</span></span>
<span data-line="" data-highlighted-line=""><span>    render </span><span>Components</span><span>::</span><span>Layouts</span><span>::</span><span>Mailers</span><span>::</span><span>Html</span><span>.</span><span>new</span><span> do</span></span>
<span data-line="" data-highlighted-line=""><span>      super</span></span>
<span data-line="" data-highlighted-line=""><span>    end</span></span>
<span data-line="" data-highlighted-line=""><span>  end</span></span>
<span data-line=""> </span>
<span data-line=""><span>  def</span><span> view_template</span></span>
<span data-line=""><span>    div </span><span>do</span></span>
<span data-line=""><span>      plain </span><span>&#34;We are excited to have you join us! Thank you for signing up.&#34;</span></span>
<span data-line=""><span>    end</span></span>
<span data-line=""> </span>
<span data-line=""><span>    a </span><span>href</span><span>:</span><span> &#34;https://example.com&#34;</span><span> do</span></span>
<span data-line=""><span>      plain </span><span>&#34;Click here to sign in&#34;</span></span>
<span data-line=""><span>    end</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""><span>end</span></span></code></pre></figure>
<p>And for the text variant:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rb" data-theme="one-dark-pro one-light">app/views/mailers/users/welcome/text.rb</figcaption><pre tabindex="0" data-language="rb" data-theme="one-dark-pro one-light"><code data-language="rb" data-theme="one-dark-pro one-light"><span data-line=""><span>class</span><span> Views</span><span>::</span><span>Mailers</span><span>::</span><span>Users</span><span>::</span><span>Welcome</span><span>::</span><span>Text</span><span> &lt;</span><span> Views</span><span>::</span><span>Base</span></span>
<span data-line="" data-highlighted-line=""><span>  include</span><span> Components</span></span>
<span data-line=""> </span>
<span data-line=""><span>  def</span><span> initialize</span><span>(</span><span>user</span><span>)</span></span>
<span data-line=""><span>    @user</span><span> =</span><span> user</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""> </span>
<span data-line="" data-highlighted-line=""><span>  def</span><span> around_template</span></span>
<span data-line="" data-highlighted-line=""><span>    render </span><span>Components</span><span>::</span><span>Layouts</span><span>::</span><span>Mailers</span><span>::</span><span>Text</span><span>.</span><span>new</span><span> do</span></span>
<span data-line="" data-highlighted-line=""><span>      super</span></span>
<span data-line="" data-highlighted-line=""><span>    end</span></span>
<span data-line="" data-highlighted-line=""><span>  end</span></span>
<span data-line=""> </span>
<span data-line=""><span>  def</span><span> view_template</span></span>
<span data-line=""><span>    plain </span><span>&#34;We are excited to have you join us! Thank you for signing up.&#34;</span></span>
<span data-line=""><span>    plain </span><span>&#34;</span><span>\n\n</span><span>&#34;</span></span>
<span data-line=""><span>    plain </span><span>&#34;Click here to sign in: https://example.com&#34;</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""><span>end</span></span></code></pre></figure>
<p>Now we have the email content rendered with the layout wrapped around it. But, for each email template, we need to repeat a lot of the same code (e.g., explicitly defining <code>around_template</code> hook for every single templates, duplicated <code>initialize</code> for HTML and text variant). We’re not there yet, though. In order to DRY up the code, we need to refactor the views and how we’re rendering the emails.</p>
<h2 id="refactoring-applicationmailer-and-views">Refactoring ApplicationMailer and Views</h2>
<p>Here comes the cool part. We can refactor the <code>ApplicationMailer</code> class to render the email content with the layout by way of a custom method <code>render_email</code> (we use <a href="https://www.phlex.fun/rails/layouts#layouts-through-composition" target="_blank">layouts through composition</a>). This way, we can remove the <code>around_template</code> hook which is cluttering up the views and thereby make them more compact. Also, we go from two separate views to one view class with two subclasses for the HTML and text version. No need to always remember to also change the text version when updating the HTML version – it’s all in one place and almost impossible to miss. Nice!</p>
<p>Let’s first have a look at the refactored <code>ApplicationMailer</code> class:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rb" data-theme="one-dark-pro one-light">app/mailers/application_mailer.rb</figcaption><pre tabindex="0" data-language="rb" data-theme="one-dark-pro one-light"><code data-language="rb" data-theme="one-dark-pro one-light"><span data-line=""><span>class</span><span> ApplicationMailer</span><span> &lt;</span><span> ActionMailer</span><span>::</span><span>Base</span></span>
<span data-line=""><span>  default </span><span>from</span><span>:</span><span> &#34;<a href="https://camillovisini.com/cdn-cgi/l/email-protection" data-cfemail="7412061b1934110c15190418115a171b19">[email protected]</a>&#34;</span></span>
<span data-line=""><span>  layout </span><span>false</span></span>
<span data-line=""> </span>
<span data-line="" data-highlighted-line=""><span>  def</span><span> render_email</span><span>(</span><span>view_class</span><span>, </span><span>subject</span><span>:</span><span>, </span><span>to</span><span>:</span><span>, </span><span>view_params</span><span>:</span><span> {})</span></span>
<span data-line="" data-highlighted-line=""><span>    mail</span><span>({</span><span>subject</span><span>:</span><span>, </span><span>to</span><span>:</span><span>, </span><span>content_type</span><span>:</span><span> &#34;multipart/alternative&#34;</span><span>}) </span><span>do</span><span> |</span><span>format</span><span>|</span></span>
<span data-line="" data-highlighted-line=""><span>      format</span><span>.</span><span>html</span><span> {</span></span>
<span data-line="" data-highlighted-line=""><span>        render </span><span>Components</span><span>::</span><span>Layouts</span><span>::</span><span>Mailers</span><span>::</span><span>Html</span><span>.</span><span>new</span><span> {</span></span>
<span data-line="" data-highlighted-line=""><span>          render view_class.</span><span>const_get</span><span>(</span><span>:</span><span>Html</span><span>).</span><span>new</span><span>(</span><span>**</span><span>view_params)</span></span>
<span data-line="" data-highlighted-line=""><span>        }</span></span>
<span data-line="" data-highlighted-line=""><span>      }</span></span>
<span data-line="" data-highlighted-line=""><span>      format</span><span>.</span><span>text</span><span> {</span></span>
<span data-line="" data-highlighted-line=""><span>        render </span><span>Components</span><span>::</span><span>Layouts</span><span>::</span><span>Mailers</span><span>::</span><span>Text</span><span>.</span><span>new</span><span> {</span></span>
<span data-line="" data-highlighted-line=""><span>          render view_class.</span><span>const_get</span><span>(</span><span>:</span><span>Text</span><span>).</span><span>new</span><span>(</span><span>**</span><span>view_params)</span></span>
<span data-line="" data-highlighted-line=""><span>        }</span></span>
<span data-line="" data-highlighted-line=""><span>      }</span></span>
<span data-line="" data-highlighted-line=""><span>    end</span></span>
<span data-line="" data-highlighted-line=""><span>  end</span></span>
<span data-line=""><span>end</span></span></code></pre></figure>
<p>The <code>render_email</code> method takes the view class and additional arguments, forwarding them to the Action Mailer <code>mail</code> method. In the block, it then renders the email content with the layout for the HTML and text versions.</p>
<p>Here’s how we render the email from the mailer class:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rb" data-theme="one-dark-pro one-light">app/mailers/user_mailer.rb</figcaption><pre tabindex="0" data-language="rb" data-theme="one-dark-pro one-light"><code data-language="rb" data-theme="one-dark-pro one-light"><span data-line=""><span>class</span><span> UserMailer</span><span> &lt;</span><span> ApplicationMailer</span></span>
<span data-line=""><span>  def</span><span> welcome</span></span>
<span data-line=""><span>    @user</span><span> =</span><span> params[</span><span>:</span><span>user</span><span>]</span></span>
<span data-line="" data-highlighted-line=""><span>    render_email</span><span>(</span></span>
<span data-line="" data-highlighted-line=""><span>      Views</span><span>::</span><span>Mailers</span><span>::</span><span>Users</span><span>::</span><span>Welcome</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      subject</span><span>:</span><span> &#34;Welcome&#34;</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      to</span><span>:</span><span> @user</span><span>.</span><span>email</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      view_params</span><span>:</span><span> {</span><span>user</span><span>:</span><span> @user</span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>    )</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""><span>end</span></span></code></pre></figure>
<p>In the views, we now centralize the HTML and text content in one class. It’s easy to manage and change the content in one place, no need to jump between different files.</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rb" data-theme="one-dark-pro one-light">app/views/user_mailer/welcome.rb</figcaption><pre tabindex="0" data-language="rb" data-theme="one-dark-pro one-light"><code data-language="rb" data-theme="one-dark-pro one-light"><span data-line=""><span>class</span><span> Views</span><span>::</span><span>Mailers</span><span>::</span><span>Users</span><span>::</span><span>Welcome</span><span> &lt;</span><span> Views</span><span>::</span><span>Base</span></span>
<span data-line=""><span>  def</span><span> initialize</span><span>(</span><span>user</span><span>:</span><span>)</span></span>
<span data-line=""><span>    @user</span><span> =</span><span> user</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""> </span>
<span data-line="" data-highlighted-line=""><span>  class</span><span> Html</span><span> &lt;</span><span> self</span></span>
<span data-line=""><span>    def</span><span> view_template</span></span>
<span data-line=""><span>      div </span><span>do</span></span>
<span data-line=""><span>        plain </span><span>&#34;We are excited to have you join us! Thank you for signing up.&#34;</span></span>
<span data-line=""><span>      end</span></span>
<span data-line=""> </span>
<span data-line=""><span>      a </span><span>href</span><span>:</span><span> &#34;https://example.com&#34;</span><span> do</span></span>
<span data-line=""><span>        plain </span><span>&#34;Click here to sign in&#34;</span></span>
<span data-line=""><span>      end</span></span>
<span data-line=""><span>    end</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""> </span>
<span data-line="" data-highlighted-line=""><span>  class</span><span> Text</span><span> &lt;</span><span> self</span></span>
<span data-line=""><span>    def</span><span> view_template</span></span>
<span data-line=""><span>      plain </span><span>&#34;We are excited to have you join us! Thank you for signing up.&#34;</span></span>
<span data-line=""><span>      plain </span><span>&#34;</span><span>\n\n</span><span>&#34;</span></span>
<span data-line=""><span>      plain </span><span>&#34;Click here to sign in: https://example.com&#34;</span></span>
<span data-line=""><span>    end</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""><span>end</span></span></code></pre></figure>
<p>We can now delete these four files:</p>
<ul>
<li><code>app/views/mailers/users/welcome/html.rb</code></li>
<li><code>app/views/mailers/users/welcome/text.rb</code></li>
<li><code>app/views/user_mailer/welcome.html.erb</code></li>
<li><code>app/views/user_mailer/welcome.text.erb</code></li>
</ul>
<p>By deleting the email templates (and before that, the layouts), we have removed all ERB and now can write our emails in plain Ruby with Phlex.</p>
<h2 id="inlining-styles">Inlining Styles</h2>
<p>Let’s add some finishing touches – after all, we want our emails to look good. But, email clients have limited support for CSS stylesheets, so we need to use inline styles. We can add a <code>style</code> tag to our HTML layout to get started. Something like this:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rb" data-theme="one-dark-pro one-light">app/components/layouts/mailers/html.rb</figcaption><pre tabindex="0" data-language="rb" data-theme="one-dark-pro one-light"><code data-language="rb" data-theme="one-dark-pro one-light"><span data-line=""><span>class</span><span> Components</span><span>::</span><span>Layouts</span><span>::</span><span>Mailers</span><span>::</span><span>Html</span><span> &lt;</span><span> Phlex</span><span>::</span><span>HTML</span></span>
<span data-line=""><span>  def</span><span> view_template</span><span>(</span><span>&amp;</span><span>block</span><span>)</span></span>
<span data-line=""><span>    doctype</span></span>
<span data-line=""><span>    html </span><span>do</span></span>
<span data-line=""><span>      head </span><span>do</span></span>
<span data-line=""><span>        meta </span><span>charset</span><span>:</span><span> &#34;utf-8&#34;</span></span>
<span data-line="" data-highlighted-line=""><span>        style </span><span>do</span></span>
<span data-line="" data-highlighted-line=""><span>          plain </span><span>&lt;&lt;~CSS</span></span>
<span data-line="" data-highlighted-line=""><span>            body</span><span> {</span></span>
<span data-line="" data-highlighted-line=""><span>              font-family:</span><span> Arial</span><span>,</span><span> sans-serif</span><span>;</span></span>
<span data-line="" data-highlighted-line=""><span>            }</span></span>
<span data-line="" data-highlighted-line=""><span>            .highlight</span><span> {</span></span>
<span data-line="" data-highlighted-line=""><span>              background-color:</span><span> yellow</span><span>;</span></span>
<span data-line="" data-highlighted-line=""><span>            }</span></span>
<span data-line="" data-highlighted-line=""><span>            .signature</span><span> {</span></span>
<span data-line="" data-highlighted-line=""><span>              font-style:</span><span> italic</span><span>;</span></span>
<span data-line="" data-highlighted-line=""><span>            }</span></span>
<span data-line="" data-highlighted-line=""><span>          CSS</span></span>
<span data-line="" data-highlighted-line=""><span>        end</span></span>
<span data-line=""><span>      end</span></span>
<span data-line=""><span>      body </span><span>do</span></span>
<span data-line=""><span>        div </span><span>do</span></span>
<span data-line=""><span>          b { </span><span>&#34;Application Name&#34;</span><span> }</span></span>
<span data-line=""><span>        end</span></span>
<span data-line=""><span>        yield</span><span> block</span></span>
<span data-line=""> </span>
<span data-line=""><span>        div { </span><span>&#34;Best Regards,&#34;</span><span> }</span></span>
<span data-line=""><span>        div</span><span>(</span><span>class</span><span>:</span><span> &#34;signature&#34;</span><span>) { </span><span>&#34;Company Name&#34;</span><span> }</span></span>
<span data-line=""><span>      end</span></span>
<span data-line=""><span>    end</span></span>
<span data-line=""><span>  end</span></span>
<span data-line=""><span>end</span></span></code></pre></figure>
<p>However, for emails, it’s generally recommended to inline the styles of all classes we use by adding the styles to the respective elements. Let’s add the <a href="https://github.com/Mange/roadie-rails" target="_blank">roadie-rails</a> gem to the mix, so that classes like <code>highlight</code> and <code>signature</code> are inlined with their actual style values (this works for both the layout, as shown above with <code>signature</code>, as well as within the views, e.g., when you use <code>highlight</code> for a particular element).</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rb" data-theme="one-dark-pro one-light">app/mailers/application_mailer.rb</figcaption><pre tabindex="0" data-language="rb" data-theme="one-dark-pro one-light"><code data-language="rb" data-theme="one-dark-pro one-light"><span data-line=""><span>class</span><span> ApplicationMailer</span><span> &lt;</span><span> ActionMailer</span><span>::</span><span>Base</span></span>
<span data-line="" data-highlighted-line=""><span>  include</span><span> Roadie</span><span>::</span><span>Rails</span><span>::</span><span>Automatic</span></span>
<span data-line=""> </span>
<span data-line=""><span>  default </span><span>from</span><span>:</span><span> &#34;<a href="https://camillovisini.com/cdn-cgi/l/email-protection" data-cfemail="e78195888aa7829f868a978b82c984888a">[email protected]</a>&#34;</span></span>
<span data-line=""><span>  layout </span><span>false</span></span>
<span data-line=""> </span>
<span data-line=""><span>  #...</span></span>
<span data-line=""><span>end</span></span></code></pre></figure>
<p>With <code>roadie-rails</code> in place, we can now use classes in our views and layouts, and the styles will be inlined automatically. Note that <code>roadie-rails</code> inlines the styles only when delivering – use <code>UserMailer.with(user: user).welcome.deliver</code> in Rails console to check the inlined styles. Here’s an example of the resulting HTML email content:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="html" data-theme="one-dark-pro one-light"><code data-language="html" data-theme="one-dark-pro one-light"><span data-line=""><span>&lt;</span><span>html</span><span>&gt;</span></span>
<span data-line=""><span>  &lt;!-- ... --&gt;</span></span>
<span data-line=""><span>   &lt;</span><span>body</span><span> style</span><span>=</span><span>&#34;</span><span>font-family:Arial, sans-serif</span><span>&#34;</span><span>&gt;</span></span>
<span data-line=""><span>      &lt;</span><span>div</span><span>&gt;&lt;</span><span>b</span><span>&gt;Application Name&lt;/</span><span>b</span><span>&gt;&lt;/</span><span>div</span><span>&gt;</span></span>
<span data-line=""><span>      &lt;</span><span>div</span><span> class</span><span>=</span><span>&#34;highlight&#34;</span><span> style</span><span>=</span><span>&#34;</span><span>background-color:yellow</span><span>&#34;</span><span>&gt;We are excited to have you join us! Thank you for signing up.&lt;/</span><span>div</span><span>&gt;</span></span>
<span data-line=""><span>      &lt;</span><span>a</span><span> href</span><span>=</span><span>&#34;https://example.com&#34;</span><span>&gt;Click here to sign in&lt;/</span><span>a</span><span>&gt;</span></span>
<span data-line=""><span>      &lt;</span><span>div</span><span>&gt;Best Regards,&lt;/</span><span>div</span><span>&gt;</span></span>
<span data-line=""><span>      &lt;</span><span>div</span><span> class</span><span>=</span><span>&#34;signature&#34;</span><span> style</span><span>=</span><span>&#34;</span><span>font-style:italic</span><span>&#34;</span><span>&gt;Company Name&lt;/</span><span>div</span><span>&gt;</span></span>
<span data-line=""><span>   &lt;/</span><span>body</span><span>&gt;</span></span>
<span data-line=""><span>&lt;/</span><span>html</span><span>&gt;</span></span></code></pre></figure>
<h2 id="conclusion">Conclusion</h2>
<p>By moving from ERB to Phlex for Action Mailer, we can write our email templates in pure Ruby. We can manage the HTML and text version in one place, and use Phlex components for layouts and views. Not a single ERB file left in our entire Rails app! Check out the repository for the full code:</p>

<p>I hope this is helpful for those looking into using Phlex for mailers as the last piece of the puzzle to get rid of ERB completely. If you have any questions or feedback, feel free to reach out.</p>
<p>Keep Phlexing!</p> </div></div>
  </body>
</html>
