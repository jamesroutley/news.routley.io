<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://qmacro.org/blog/posts/2024/05/13/using-arg-in-a-dockerfile-beware-the-gotcha/">Original</a>
    <h1>Using ARG in a Dockerfile â€“ beware the gotcha</h1>
    
    <div id="readability-page-1" class="page"><div><p>Today I learned about the subtleties of <a href="https://docs.docker.com/build/guide/build-args/">build arguments</a> in Dockerfile definitions, specifically how the <code>ARG</code> instruction relates to - and is affected by - the <code>FROM</code> instruction. It&#39;s not entirely like a constant or a variable, in the way that I had thought.</p><h2>The problem with empty ARG values</h2><p>I spent more than a coffee&#39;s worth of time trying to understand why my custom builds of a CAP Node.js container image weren&#39;t of the CAP version I was specifying, either implicitly with the default value I&#39;d declared in the <code>ARG</code> instruction in the Dockerfile, or even explicitly with the <code>--build-arg</code> option on the command line.</p><p>To illustrate the problem, here&#39;s a vastly simplified version of the Dockerfile I was building with:</p><pre><code></code></pre><p>The first variable declared with <code>ARG</code> here is <code>DEBVER</code> and represents a fairly common use case of allowing for different versions of a base image, illustrated here in being able to start from different versions of the Debian distribution, where the default version is to be 10.</p><p>The second variable <code>CAPVER</code> was something similar that I was using later in the build instructions (i.e. further on in the Dockerfile), to specify the particular version of CAP that I wanted to install. The actual instruction in my Dockerfile looked like this: <code>RUN npm install -g @sap/cds-dk@{CAPVER}</code>.</p><p>After building the image based on this simplified Dockerfile, without specifying any values explicitly with <code>--build-arg</code>, like this:</p><pre><code><span>;</span> <span>docker</span> build <span>-t</span> argtest <span>.</span></code></pre><p>I could successfully confirm that the version of Debian in containers created from this image was 10:</p><pre><code><span>;</span> <span>docker</span> run <span>--rm</span> argtest <span>grep</span> VERSION_ID /etc/os-release</code></pre><p>But what of the content of <code>/tmp/log</code>?</p><pre><code><span>;</span> <span>docker</span> run <span>--rm</span> argtest <span>cat</span> /tmp/log</code></pre><p>Hmm.</p><p>How about when I use <code>--build-arg</code> options?</p><pre><code><span>;</span> <span>docker</span> build <span>\</span></code></pre><p>The build completes successfully, and I can see that containers now are Debian 11 based:</p><pre><code><span>;</span> <span>docker</span> run <span>--rm</span> argtest <span>grep</span> VERSION_ID /etc/os-release</code></pre><p>but the problem with the empty values for <code>DEBVER</code> and <code>CAPVER</code> in <code>/tmp/log</code> remains.</p><p>Not only is the value for <code>CAPVER</code> empty when we reference it in the <code>RUN</code> instruction, but also, and this is the most mysterious thing thus far, while <code>DEBVER</code> was certainly recognised and set to 11 for the Debian distribution in the <code>FROM</code> instruction, it&#39;s empty when we reference it later in the <code>RUN</code> instruction.</p><h2>The subtleties of how ARG relates to FROM</h2><p>The cause is the rather subtle relationship between <code>ARG</code> and <code>FROM</code>, the explanation for which is brief and a little hidden in the main <a href="https://docs.docker.com/reference/dockerfile/">Dockerfile reference</a>. I certainly missed it when I went straight to the <a href="https://docs.docker.com/reference/dockerfile/#arg">reference for <code>ARG</code></a>, as it&#39;s not mentioned, and only explained at the end of the <a href="https://docs.docker.com/reference/dockerfile/#from">reference for <code>FROM</code></a> which is earlier on the page.</p><p>The key section is here: <a href="https://docs.docker.com/reference/dockerfile/#understand-how-arg-and-from-interact">Understand how ARG and FROM react</a>, and includes this line:</p><blockquote><p>&#34;<em>An <code>ARG</code> declared before a <code>FROM</code> is outside of a build stage, so it can&#39;t be used in any instruction after a <code>FROM</code>.</em>&#34;</p></blockquote><p>In other words, variables declared with <code>ARG</code> look like variables in, say, a shell script, variables which are also often declared at the start, and then used throughout the script.</p><p>But they&#39;re not.</p><h2>The solution</h2><p>What must be done to the Dockerfile above is to modify it so it looks like this:</p><pre><code></code></pre><p>Moving the <code>ARG</code> instruction for <code>CAPVER</code> so that it comes after the <code>FROM</code> instruction gives it life and validity.</p><p>And the <code>ARG</code> instruction for <code>DEBVER</code> must stay where it is (as it&#39;s referenced in the <code>FROM</code> instruction details of course) but if it needs to be referred to after the <code>FROM</code> instruction it must be referenced again - hence the <code>ARG DEBVER</code> line.</p><p>From a container image built using this new version of the Dockerfile, with no <code>--build-arg</code> options specified, we can see that the values for <code>DEBVER</code> and <code>CAPVER</code> are available after the <code>FROM</code> instruction:</p><pre><code><span>;</span> <span>docker</span> run <span>--rm</span> argtest <span>cat</span> /tmp/log</code></pre><p>And this works of course if we set values for build arguments on the command line too, testing a container built using the same <code>docker build --build-arg ...</code> invocation as before:</p><pre><code><span>;</span> <span>docker</span> run <span>--rm</span> argtest <span>cat</span> /tmp/log</code></pre><p>and</p><pre><code><span>;</span> <span>docker</span> run <span>--rm</span> argtest <span>grep</span> VERSION_ID /etc/os-release</code></pre><h2>Wrapping up</h2><p>Perhaps I should have read the entire reference document for all the Dockerfile instructions first. Then I would have at least read about this relationship, and I may also have remembered it too. But for those of you like me who jump directly to consult the reference documentation on the thing they&#39;re trying to use, perhaps this will help.</p><p>Happy building!</p></div></div>
  </body>
</html>
