<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://markuta.com/cracking-lastpass-vaults/">Original</a>
    <h1>Cracking encrypted LastPass vaults</h1>
    
    <div id="readability-page-1" class="page"><div><img loading="lazy" src="https://markuta.com/cracking-lastpass-vaults/images/cover-image.jpg" alt="Lastpass rusty lock cover"/>
<p>Image by Arkadiusz Gąsiorowski on unsplash.com</p>
</div><div><p><strong>Update</strong>: Fixed a few mistakes and added more clarification.</p>
<p>In this post I will go into technical details on what attackers could do with the stolen encrypted vaults, specifically how they could use tools like Hashcat to crack vault passwords and get access to sensitive log-in credentials.</p>
<p>To simulate the stolen data, I will use my test Lastpass account to extract an encrypted vault from the Chrome Browser extension on macOS. Following this, I will use a wordlist attack to bruteforce the vault which has a weak and guessiable password.</p>
<h2 id="what-happened">What happened?</h2>
<p>The Verge published an <a href="https://www.theverge.com/2022/12/22/23523322/lastpass-data-breach-cloud-encrypted-password-vault-hackers">article</a> which includes a great summary of the breach. There is also a <a href="https://blog.lastpass.com/2022/12/notice-of-recent-security-incident/">blog post</a> by Lastpass themselves. To summarise, in August 2022 Lastpass suffered a data breach where customer data and source code was stolen. Lastpass didn’t do a good job at letting the public (and customers) know of how bad the breach actually was.</p>
<p><strong>What was stolen?</strong></p>
<ul>
<li>a backup of customer vault data</li>
<li>company names, end-user names, billing addresses, email addresses, telephone numbers, and the IP addresses</li>
<li>source-code and other intellectual property</li>
</ul>
<h2 id="what-can-attackers-do-with-the-stolen-vaults">What can attackers do with the stolen vaults?</h2>
<p>It really depends, there are a lot of things to consider. A few things that spring to mind are:</p>
<ul>
<li>How are the encrypted vaults stored in the cloud?</li>
<li>Did a customer set a weak and easily guessed vault password?</li>
<li>What is the key iteration (default or custom)?</li>
<li>Other factors not covered?</li>
</ul>
<p>And since I don’t know what the stolen data looks like, or how it may be encrypted, this blog post is only a theory and estimation based on data I have access to. This includes the SQLite database used by the Browser extension and data within it.</p>
<p>In the next sections I will demostrate how to extract the encrypted vault database from the Chrome extension and pull out specific information to start cracking with Hashcat.</p>
<h3 id="lastpass-browser-extension">Lastpass Browser extension</h3>
<p>On Chrome Browsers each extension has a unique ID. The Lastpass extension uses <code>hdokiejnpimakedhajhdlcegeplioahd</code> as the ID. You can confirm this by visiting the URL <code>chrome-extension://hdokiejnpimakedhajhdlcegeplioahd/vault.html</code> in your address bar. You will be presented with the vault log-in page.</p>
<p><img loading="lazy" src="https://markuta.com/cracking-lastpass-vaults/images/chrome-browser-extension.png" alt=""/>
</p>
<p>You can think of it as a local site that uses HTML and JavaScript within your Browser.</p>

<p>All extensions have their own folders which are stored locally on the system in various locations depending on OS.</p>
<p>As per online documentation the <a href="https://support.lastpass.com/help/where-is-my-lastpass-data-stored-on-my-computer-lp070008">Lastpass support</a> page states devices using Chrome Browsers on Windows systems store the <strong>vault data</strong> in the following PATH:</p>
<pre tabindex="0"><code>%LocalAppData%\Google\Chrome\User Data\Default\databases\chrome-extension_hdokiejnpimakedhajhdlcegeplioahd_0
</code></pre><p>On <strong>macOS</strong> systems the location is slightly different:</p>
<p><img loading="lazy" src="https://markuta.com/cracking-lastpass-vaults/images/find-lastpass-local-path-macos.png" alt=""/>
</p>
<p><strong>Note</strong>: I use two Profiles on Chrome, hence why you see <code>Profile 1</code> instead of <code>Default</code>.</p>
<h3 id="lastpass-sqlite-database">Lastpass SQLite database</h3>
<p>In this folder a SQLite file named <code>1</code> with the version: <code>SQLite version 3039004</code> should be present. This is where encrypted vault data is stored and used by the extension.</p>
<div><pre tabindex="0"><code data-lang="bash">➜  file <span>1</span>
1: SQLite 3.x database, last written using SQLite version 3039004, file counter 21, database pages 22, cookie 0x5, schema 4, largest root page 11, UTF-8, vacuum mode 1, version-valid-for <span>21</span>
</code></pre></div><p>You can then use a tool like <strong>DB Browser for SQLite</strong> to view the database contents. I also copied it to Desktop and renamed the file to <code>lastpass-vault-macos-chrome.sqlite</code> so it’s easier to remember.</p>
<p>All the interesting data is stored in a table called <code>LastPassData</code>.
<img loading="lazy" src="https://markuta.com/cracking-lastpass-vaults/images/DB-browser-SQLite-edit.png" alt=""/>
</p>
<p>To start cracking Lastpass vault passwords using Hashcat you need <strong>three</strong> things:</p>
<ol>
<li>Key value</li>
<li>Iteration count</li>
<li>Account email address (hashed in database)</li>
</ol>
<p>These need be formatted like so: <code>KEY:ITERATION:EMAIL</code></p>
<h4 id="key-value">Key value</h4>
<p>To retrieve the key value, search column <code>type</code> where value <code>key</code>, and then in the <code>data</code> column select the <strong>second row</strong> e.g. <code>T4vInfZ+6MGDeEendq4gvA==</code> as shown below:</p>
<p><img loading="lazy" src="https://markuta.com/cracking-lastpass-vaults/images/key-value-example.png" alt=""/>
</p>
<p>You can also execute the following SQL query:</p>
<div><pre tabindex="0"><code data-lang="sql"><span>SELECT</span> substr(<span>data</span>, <span>-</span><span>24</span>) <span>FROM</span> LastPassData <span>WHERE</span> <span>type</span> <span>=</span> <span>&#39;key&#39;</span>;
</code></pre></div><p>It is base64 encoded, which you can decode and get the hex value by:</p>
<pre tabindex="0"><code>echo &#34;T4vInfZ+6MGDeEendq4gvA==&#34; | base64 -d | xxd -p
</code></pre><p>We now have the first requirement: <code>4f8bc89df67ee8c1837847a776ae20bc</code></p>
<h4 id="iteration-count">Iteration count</h4>
<p>To retireve the Iteration count, search column <code>type</code> where value <code>accts</code>, and then in the <code>data</code> column the first few charaters before the <code>;</code>. Lastpass changed the default iteration in 2018 from <code>5000</code> to <code>100100</code>.</p>
<p>You can also execute the following SQL query:</p>
<div><pre tabindex="0"><code data-lang="sql"><span>SELECT</span> SUBSTR(<span>data</span>,<span>0</span>,INSTR(<span>data</span>,<span>&#39;;&#39;</span>)) <span>FROM</span> LastPassData <span>WHERE</span> <span>type</span> <span>=</span> <span>&#39;accts&#39;</span>;
</code></pre></div><p>We also now have the second requirement: <code>100100</code></p>
<h4 id="email">Email</h4>
<p>The database contains a hashed email address value. But we do know that attackers already have this info since the recent Lastpass compromise included email addresses. For the purposes of this blog, I am not going to share the email address which I used.</p>
<h4 id="formatted-hash">Formatted hash</h4>
<p>With all the requirements the hash should look like this:</p>
<pre tabindex="0"><code>4f8bc89df67ee8c1837847a776ae20bc:100100:<a href="https://markuta.com/cdn-cgi/l/email-protection" data-cfemail="bfcbdacccbffdac7ded2cfd3da91dcd0d2">[email protected]</a>
</code></pre><h2 id="cracking-lastpass-vaults-with-hashcat">Cracking Lastpass vaults with Hashcat</h2>
<p>As a proof of concept I used my MacBook Air with the M1 chip to crack passwords. The speed was absolutely horrible <code>1110 H/s</code> (hashes per second), but <em>it did</em> work. Attackers on the other hand can leverage multi-GPU device setups with optimised drivers that could easily reach speeds of <code>2,000,000+ H/s</code>.</p>
<p>As an example of <strong>bruteforcing vaults with weak passwords</strong>, I downloaded the popular <code>rockyou.txt</code> wordlist and put my actual vault master plaintext password inside. I then set the following Hashcat options:</p>
<pre tabindex="0"><code>hashcat -a 0 -m 6800 lastpass-hash.txt ~/Downloads/rockyou.txt
</code></pre><ul>
<li><code>-a 0</code> attack mode Wordlist</li>
<li><code>-m 6800</code> Lastpass hash algorithm</li>
<li><code>lastpass-hash.txt</code> hash formatted (KEY:ITERATION:EMAIL)</li>
<li><code>rockyou.txt</code> wordlist of plaintext passwords + my password</li>
</ul>
<p><img loading="lazy" src="https://markuta.com/cracking-lastpass-vaults/images/hashcat-cracked-lastpass-hash-edit.png" alt=""/>
</p>
<p>And there we have it, the <strong>master vault plaintext password</strong> successfully recovered.</p>
<h2 id="useful-links-and-references">Useful Links and References</h2>
<ul>
<li><a href="https://www.theverge.com/2022/12/22/23523322/lastpass-data-breach-cloud-encrypted-password-vault-hackers">Lastpass Data Breach covered by The Verge (2022)</a></li>
<li><a href="https://hashcat.net/forum/thread-9201.html">Lastpass new App hash extraction on Hashcat Forums (2020)</a></li>
<li><a href="https://hashcat.net/forum/thread-2701-post-16028.html#pid16028">Lastpass hashes on Hashcat Forums (2013)</a></li>
<li><a href="https://pastebin.com/KdAHAm9w">Hashcat lastpass benchmark (2013)</a></li>
<li><a href="https://blog.elcomsoft.com/2020/04/breaking-lastpass-instant-unlock-of-the-password-vault/">Breaking Lastpass by Elcomsoft (2020)</a></li>
</ul>
</div></div>
  </body>
</html>
