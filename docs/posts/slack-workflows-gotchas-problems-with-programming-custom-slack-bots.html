<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://blog.bonnieeisenman.com/blog/slack-workflows/">Original</a>
    <h1>Slack Workflows Gotchas: Problems with Programming Custom Slack Bots</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>I built a Slack bot with a coworker for our internal company hackathon. It was‚Ä¶.an experience! Here are some notes that might be useful to other folks.</p>
<p>Our team runs a company-public ‚Äúhelp‚Äù channel, which is meant for folks outside of our team to ask questions. Unsurprisingly, many of these questions are repetitive, and answering them is a drain on the on-call engineer‚Äôs time. I looked back at the last month of questions and found that ~35% of them were good candidates for an automated response. So, I wanted to build a bot that would automatically reply to certain keywords in a specified channel with a canned response.</p>
<p>The first hiccup was: how do we interact with Slack? Slack has a lot of different ways to build automations: there are SDKs for standalone apps that interact with Slack via webhooks, there‚Äôs the ‚ÄúWorkflow Builder‚Äù GUI, there are ‚Äúworkflows‚Äù, there are ‚ÄúSlack apps‚Äù, there‚Äôs Slackbot‚Ä¶.</p>
<p>In order to respond to the <a href="https://api.slack.com/automation/triggers/event">message_posted event trigger</a>, you need to build a Workflow (not to be confused with the Workflow Builder). Sometimes the docs refer to this as a ‚ÄúWorkflow App.‚Äù</p>
<p>A Workflow is basically a special app that can be deployed to Slack. You can‚Äôt put it in the Slack apps directory. It must be written in Typescript, and you don‚Äôt run it as a standalone program.</p>
<p>The entire Workflows developer experience has the vibe of ‚Äúsome folks put a lot of work into this, a while ago.‚Äù There are a lot of really cool use-cases for Slack automations, but there are also a bunch of gotchas and rough edges to the API. Here‚Äôs some of my notes from working with the Workflows API:</p>
<h2 id="the-sample-apps-are-your-friend">The sample apps are your friend</h2>
<p>There‚Äôs a <a href="https://github.com/slack-samples">robust repo of example projects</a> that are the best point of reference for using the API. While the <a href="https://api.slack.com/automation/quickstart">docs</a> are also useful, I found that the Slack sample apps were the best reference to use.</p>
<h2 id="nested-arrays-and-objects-dont-work">Nested arrays and objects don‚Äôt work.</h2>
<p>We ran into all sorts of bugs when trying to store arrays inside of objects or objects inside of arrays, both when interacting with the datastores but also when just trying to pass parameters between functions.</p>
<p>There‚Äôs an <a href="https://github.com/slackapi/deno-slack-sdk/issues/250">open bug</a> from 2023 where storing an object containing an array doesn‚Äôt work. Hopefully that will get fixed eventually?</p>
<h2 id="no-conditionals-or-early-termination">No conditionals or early termination</h2>
<p>Workflows consist of a series of steps. There‚Äôs no way to build in conditional branching logic into a Workflow despite <a href="https://forums.slackcommunity.com/s/question/0D53a000080b4VtCAI/when-will-ifthen-steps-come-to-workflow-builder-this-was-meant-to-arrive-sometime-in-late-2021-so-just-curious-if-it-will-still-make-it-this-year?language=en_US">customer</a> <a href="https://stackoverflow.com/questions/76282908/support-for-conditional-logic-in-slack-workflow-builder">demand</a>. Conditionals in Workflow Builder were announced as an upcoming feature back in <a href="https://techcrunch.com/2022/09/01/slack-gains-new-automation-features-including-conditional-logic-for-workflows/">2022</a>, but there‚Äôs been no news about them since.</p>
<p><a href="https://github.com/slackapi/deno-slack-sdk/issues/276">There‚Äôs also no way to end a workflow early.</a> This becomes a problem if a necessary precondition is not met, because of how errors are handled.</p>
<h2 id="error-handling">Error handling</h2>
<p>If your workflow encounters an error, Slackbot will DM the workflow‚Äôs admin. There is no way to mute these messages.</p>
<p>Because of this, it‚Äôs really important that you <a href="https://forums.slackcommunity.com/s/question/0D5Hq00009pJ24vKAC/how-to-silently-handle-errors-in-workflow-automation?language=en_US">wrap each step in a try/catch</a> if there‚Äôs a chance that it will error.</p>
<h2 id="call-the-slack-client-from-a-custom-step-not-from-a-builtin-step">Call the Slack client from a custom step, NOT from a builtin step.</h2>
<p>I found that the Slack builtin methods for doing things will throw errors on normal user interactions (e.g. closing a modal window) which will then trigger a DM to the workflow admin. Yikes!</p>
<p>The docs generally advise you to use one of the builtin Slack functions from <code>Schema.slack.functions</code> for interacting with the Slack API, but you can instead use the <code>client</code> param which is available in custom functions to call the Slack API.</p>
<p>For example, the docs might suggest doing this:</p>
<div><div><pre><code>MyWorklflow.addStep(
  Schema.slack.functions.SendMessage,
  {
    channel_id: inputs.channel_id,
    message: `Setting topic to ${generateMessageStep.outputs.message}`,
  },
);

</code></pre></div></div>
<p>But instead, we did this from a custom Workflow step:</p>
<div><div><pre><code>let post_args: {
	&#34;channel&#34;: string;
  &#34;text&#34;: string;
        } = {
          channel: inputs.channel_id,
          text: inputs.message,
        };

await client.chat.postMessage(post_args);
</code></pre></div></div>
<p>Similarly, I really don‚Äôt recommend using the <code>Schema.slack.functions.OpenForm</code> Slack function in your workflows, because it will error if the user closes a modal prematurely.</p>
<p>Instead you can do something like:</p>
<div><div><pre><code>export default SlackFunction(
  OpenModal,
  async ({ inputs, client }) =&gt; {
    // Open a new modal with the end-user who interacted with the link trigger

    const view: ModalView = {
      &#34;type&#34;: &#34;modal&#34;,
      
      // Note that this ID can be used for dispatching view submissions and view closed events.
      &#34;callback_id&#34;: &#34;first-page&#34;,

      // This option is required to be notified when this modal is closed by the user
      &#34;notify_on_close&#34;: true,
      
      &#34;title&#34;: {
        &#34;type&#34;: &#34;plain_text&#34;,
        &#34;text&#34;: MODAL_TITLE,
      },
      &#34;close&#34;: { &#34;type&#34;: &#34;plain_text&#34;, &#34;text&#34;: &#34;Close&#34; },
      &#34;blocks&#34;: modalBlocksWithRows(inputs.entries),
    };

    const response = await client.views.open({
      interactivity_pointer: inputs.interactivity.interactivity_pointer,
      view: view,
    });
  }
 );
</code></pre></div></div>
<p>Not only does calling a custom function let you do bespoke error handling, we also encountered problems where the Slack built-in functions would inexplicably error but our custom functions worked fine. Unclear what was going on there.</p>
<h2 id="mismatches-between-cli-help-messages-and-behavior">Mismatches between CLI help messages and behavior</h2>
<p>There are a few places where the CLI help messages provide commands that don‚Äôt actually work.</p>
<p>For example, when trying to count the number of entries in a datastore:</p>
<div><div><pre><code>$ slack datastore count --help
...
# Count all items in a datastore
$ slack datastore count --datastore tasks

</code></pre></div></div>
<p>If you try to actually do this, it will error.</p>
<div><div><pre><code>$ slack datastore count --datastore response_store
Check .slack/logs/slack-debug-20240514.log for full error logs

üö´ No expression was provided (invalid_datastore_expression)

Suggestion:

Provide a JSON expression in the command arguments
Use slack datastore count --help for an example
Build a new expression using slack datastore count --show --unstable

</code></pre></div></div>
<h2 id="you-cant-delete-a-slack-workflows-datastore">You can‚Äôt delete a Slack workflow‚Äôs datastore.</h2>
<p>Slack can create a datastore for you, and the CLI provides a nice interface for creating datastores, and adding or removing data. However there is no support for <em>deleting</em> an entire datastore.</p>
<p>To remove a datastore, you must remove the datastore from your manifest and force-deploy, then add the datastore back in and re-deploy.</p>
<h2 id="jsonl-bulk-put-doesnt-work">JSONL bulk put doesn‚Äôt work?</h2>
<p>Maybe there‚Äôs a way to do this that I haven‚Äôt been able to figure out. The docs claim that bulk-put is supported for datastores but I wasn‚Äôt able to make this work.</p>
<p>The <a href="https://api.slack.com/automation/datastores">docs</a> suggest running this command like so:</p>
<div><div><pre><code>slack datastore bulk-put &#39;{&#34;datastore&#34;: &#34;running_datastore&#34;}&#39; ‚Äî-from-file /path/to/file.jsonl

</code></pre></div></div>
<p>The <code>--from-file</code> flag is also documented via the help command in CLI:</p>
<div><div><pre><code>$ slack datastore bulk-put --help
Create or replace a list of items in a datastore

USAGE
  $ slack datastore bulk-put &lt;expression&gt; [flags]

FLAGS
      --datastore string   the datastore used to store items
      --from-file string   store multiple items from a file of JSON Lines
</code></pre></div></div>
<p>But, it doesn‚Äôt work.</p>
<div><div><pre><code>$ slack datastore bulk-put --datastore &#39;{&#34;datastore&#34;: &#34;response_store&#34;}&#39; --from-file assets/test.jsonl
Check .slack/logs/slack-debug-20240514.log for full error logs

üö´ No expression was provided (invalid_datastore_expression)

Suggestion:

Provide a JSON expression in the command arguments
Use slack datastore bulk-put --help for an example
Build a new expression using slack datastore bulk-put --show --unstable

</code></pre></div></div>
<h2 id="well-that-sure-was-a-hackathon">Well, that sure was a hackathon.</h2>
<p>My coworker and I did eventually get our Slack workflow up and running, and it was even kind of fun! But oof I had trouble figuring out how to get the API working. For being ‚Äújust‚Äù a chat app, Slack is pretty complicated, and unsurprisingly the API surface area is complicated too. Maybe my notes will help you (or, at least, help my future self when I‚Äôm debugging this six months from now‚Ä¶).</p>
<hr/>

</div></div>
  </body>
</html>
