<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://h14s.p5r.org/2023/02/bitwise-division.html">Original</a>
    <h1>Bitwise Division</h1>
    
    <div id="readability-page-1" class="page"><div>
				
<p>Integer division is expensive. Much more expensive than multiplication. Much, much more expensive than addition. If you’re trying to make some integer operations really fast it’s bad news if you need to do division.</p>



<p>A while ago, for a hobby project, I happened to be playing around with variable-length integer encodings. Where you store integers such that small ones take up less space than large ones. This is the kind of thing you want to be very fast indeed. At one point I ended up with this expression on a hot code path:</p>



<pre><code>(63 - nlz) / 7</code></pre>



<p>For everything else I could come up with fast ways of doing it using bitwise operations but this one place I ended up with division. And in this case not only is it expensive it’s overkill: the value we’re dividing by is a constant and in this case <code>nlz</code> is known to be between 0 and 63.</p>



<p>I thought: I’ll experiment a bit and see if I can’t come up with some bitwise operations that work just like dividing by 7 when the input is between 0 and 63. The one kind of division that is very cheap is by a power of 2, that’s just bit shifting. And it happens to be the case that <code>7 * 9 = 63</code>, which is almost <code>64</code>, a power of 2. Putting those together I got something I thought might do the trick:</p>



<p><img src="http://s0.wp.com/latex.php?latex=%5Cfrac%7Bv%7D%7B7%7D+%3D+%5Cfrac%7B9+v%7D%7B9+%5Ctimes+7%7D+%3D+%5Cfrac%7B9+v%7D%7B63%7D+%5Capprox+%5Cfrac%7B9+v%7D%7B64%7D&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="\frac{v}{7} = \frac{9 v}{9 \times 7} = \frac{9 v}{63} \approx \frac{9 v}{64}" title="\frac{v}{7} = \frac{9 v}{9 \times 7} = \frac{9 v}{63} \approx \frac{9 v}{64}"/></p>



<p>This you can compute with bitwise operations!</p>



<pre><code>(9 * v) / 64
= (9 * v) &gt;&gt; 6
= (v + 8 * v) &gt;&gt; 6
= (v + (v &lt;&lt; 3)) &gt;&gt; 6</code></pre>



<p>Not bad! An expression that is purely bitwise operations but that computes <em>almost</em> division by 7. How “almost”? It turns out that this works for <code>0</code> to <code>6</code> but gives the wrong answer for 7: it yields <code>0</code> where it should be <code>1</code>. Okay, it’s off by 1 — let’s try adding 1 then:</p>



<pre><code>(v + (v &lt;&lt; 3) + 1) &gt;&gt; 6</code></pre>



<p>Now it’s correct from <code>0</code> to <code>13</code> but gives the wrong answer for <code>14</code>: <code>1</code> where it should be <code>2</code>. So let’s try adding <code>2</code> instead of 1. That makes it works for <code>0</code> to <code>20</code>. If we keep increasing the fudge factor as long as we keep getting the right answer we end up with:</p>



<pre><code>(v + (v &lt;&lt; 3) + 9) &gt;&gt; 6</code></pre>



<p>This computes <code>v / 7</code> correctly for <code>v</code> from <code>0</code> to <code>69</code> which was what I needed originally. Actually I only needed up to <code>63</code>.</p>



<p>Excellent! Problem solved! So let’s get back to varint encoding? Well, now I was on my way down the rabbit hole of bitwise division. What if it wasn’t <code>7</code> I needed to divide by, could I do something similar for other values? Where did the limit of <code>69</code> come from, and the fudge factor of <code>9</code>?</p>



<h2>Let’s generalize</h2>



<p>A quick recap: because <code>7 * 9 = 64 - 1</code> we can implement <code>v / 7</code> like this:</p>



<pre><code>(9 * v + 9) / 64
= (v + (v &lt;&lt; 3) + 9) &gt;&gt; 6</code></pre>



<p>for <code>v</code> between <code>0</code> and <code>69</code>.</p>



<p>Put more abstractly: given a divisor <em>d</em>, which happened to be 7, we found a power of 2, 64 = 2<sup>6</sup>, such that</p>



<p><img src="http://s0.wp.com/latex.php?latex=d+m+%3D+2%5En+-+1&amp;bg=ffffff&amp;fg=000000&amp;s=3" alt="d m = 2^n - 1" title="d m = 2^n - 1"/></p>



<p>for a multiplier value <em>m</em> which in this case was <code>9</code>.</p>



<p>Using this together with a fudge factor <em>a</em> which also turned out to be <code>9</code>, we were able to replace division by <em>d</em> with</p>



<pre><code>(m * v + a) &gt;&gt; n</code></pre>



<p>which gives the correct result for values between 0 and some limit <em>L</em>, where <em>L</em> in this case was <code>69</code>.</p>



<p>Now, what if I wanted to divide by some other value than 7? Let’s say 43? Then we have to find an <em>n</em> such that </p>



<p><img src="http://s0.wp.com/latex.php?latex=43+m+%3D+2%5En+-+1&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="43 m = 2^n - 1" title="43 m = 2^n - 1"/></p>



<p>for some <em>m</em>. That just means an <em>n</em> such that 43 is a factor in 2<sup><em>n</em></sup>-1. I’ve put a table of the prime factors of 2<sup><em>n</em></sup>-1s at the bottom. There is one: 2<sup>14</sup>-1.</p>



<p><img src="http://s0.wp.com/latex.php?latex=43+%5Ctimes+381+%3D+2%5E%7B14%7D+-+1&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="43 \times 381 = 2^{14} - 1" title="43 \times 381 = 2^{14} - 1"/></p>



<p>So you can replace <code>v / 43</code> with</p>



<p><code>(381 * v + a) &gt;&gt; 14</code></p>



<p>for some choice of <em>a</em>, and then it will be correct for values up to some limit <em>L</em>. What should <em>a</em> be and what will that make <em>L</em>? Well, let’s try to derive them. Let’s start with <em>a</em>. (And just skip the derivations if this kind of stuff bores you).</p>



<p>One thing that definitely must hold is that if you bitwise-divide 0 by <em>d</em> the result must be 0:</p>



<pre><code>(m * 0 + a) &gt;&gt; n = 0</code></pre>



<p><img src="http://s0.wp.com/latex.php?latex=%5Cleft%5Clfloor%7B%5Cfrac%7B0+m+%2B+a%7D%7B2%5En%7D%7D%5Cright%5Crfloor+%3D+0&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="\left\lfloor{\frac{0 m + a}{2^n}}\right\rfloor = 0" title="\left\lfloor{\frac{0 m + a}{2^n}}\right\rfloor = 0"/></p>



<p><img src="http://s0.wp.com/latex.php?latex=%5Cleft%5Clfloor%7B%5Cfrac%7Ba%7D%7B2%5En%7D%7D%5Cright%5Crfloor+%3D+0&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="\left\lfloor{\frac{a}{2^n}}\right\rfloor = 0" title="\left\lfloor{\frac{a}{2^n}}\right\rfloor = 0"/></p>



<p><img src="http://s0.wp.com/latex.php?latex=0+%5Cle+a+%3C+2%5En&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="0 \le a &lt; 2^n" title="0 \le a &lt; 2^n"/></p>



<p>So we know that definitely the fudge factor must be non-negative. Similarly if you bitwise-divide <em>d</em>-1 by <em>d</em> the result must also be 0; that gives us:</p>



<pre><code>(m * (d - 1) + a) &gt;&gt; n = 0</code></pre>



<p><img src="http://s0.wp.com/latex.php?latex=%5Cleft%5Clfloor%7B%5Cfrac%7B%28d+-+1%29m+%2B+a%7D%7B2%5En%7D%7D%5Cright%5Crfloor+%3D+0&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="\left\lfloor{\frac{(d - 1)m + a}{2^n}}\right\rfloor = 0" title="\left\lfloor{\frac{(d - 1)m + a}{2^n}}\right\rfloor = 0"/></p>



<p><img src="http://s0.wp.com/latex.php?latex=0+%5Cle+%28d+-+1%29m+%2B+a+%3C+2%5En&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="0 \le (d - 1)m + a &lt; 2^n" title="0 \le (d - 1)m + a &lt; 2^n"/></p>



<p><img src="http://s0.wp.com/latex.php?latex=0+%5Cle+md+-+m+%2B+a+%3C+2%5En&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="0 \le md - m + a &lt; 2^n" title="0 \le md - m + a &lt; 2^n"/></p>



<p><img src="http://s0.wp.com/latex.php?latex=0+%5Cle+2%5En+-+1+-+m+%2B+a+%3C+2%5En&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="0 \le 2^n - 1 - m + a &lt; 2^n" title="0 \le 2^n - 1 - m + a &lt; 2^n"/></p>



<p><img src="http://s0.wp.com/latex.php?latex=-1+-+m+%2B+a+%3C+0&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="-1 - m + a &lt; 0" title="-1 - m + a &lt; 0"/></p>



<p><img src="http://s0.wp.com/latex.php?latex=a+%3C+m+%2B+1&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="a &lt; m + 1" title="a &lt; m + 1"/></p>



<p>Putting those two together we get that</p>



<p><img src="http://s0.wp.com/latex.php?latex=0+%5Cle+a+%5Cle+m&amp;bg=ffffff&amp;fg=000000&amp;s=3" alt="0 \le a \le m" title="0 \le a \le m"/></p>



<p>But which <em>a</em> to choose? There we can use the fact that bitwise division increases more slowly then real division so when it gets the answer wrong, it’ll be because it returns too small a value. So we want <em>a</em> to be the largest allowed value: <em>m</em>.</p>



<p>Next, let’s derive <em>L</em>. Or, let’s derive <em>L</em>+1, the first value where bitwise division yields the wrong result. Since bitwise division grows more slowly than division that will be at some multiple of <em>d</em>, <em>k d</em>, where it yields a value less than the true result: <em>k</em> – 1. </p>



<pre><code>(m * k * d + m) &gt;&gt; n = k - 1</code></pre>



<p><img src="http://s0.wp.com/latex.php?latex=%5Cleft%5Clfloor%5Cfrac%7Bm+k+d+%2B+m%7D%7B2%5En%7D%5Cright%5Crfloor+%3D+k+-+1&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="\left\lfloor\frac{m k d + m}{2^n}\right\rfloor = k - 1" title="\left\lfloor\frac{m k d + m}{2^n}\right\rfloor = k - 1"/></p>



<p><img src="http://s0.wp.com/latex.php?latex=2%5En%28k-1%29+%5Cle+m+k+d+%2B+m+%3C+2%5Enk&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="2^n(k-1) \le m k d + m &lt; 2^nk" title="2^n(k-1) \le m k d + m &lt; 2^nk"/></p>



<p><img src="http://s0.wp.com/latex.php?latex=2%5En%28k-1%29+%5Cle+%282%5En-1%29k+%2B+m+%3C+2%5Enk&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="2^n(k-1) \le (2^n-1)k + m &lt; 2^nk" title="2^n(k-1) \le (2^n-1)k + m &lt; 2^nk"/></p>



<p><img src="http://s0.wp.com/latex.php?latex=2%5En%28k-1%29+%5Cle+2%5Enk+-+k+%2B+m+%3C+2%5Enk&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="2^n(k-1) \le 2^nk - k + m &lt; 2^nk" title="2^n(k-1) \le 2^nk - k + m &lt; 2^nk"/></p>



<p><img src="http://s0.wp.com/latex.php?latex=-2%5En+%5Cle+m+-+k+%3C+0&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="-2^n \le m - k &lt; 0" title="-2^n \le m - k &lt; 0"/></p>



<p><img src="http://s0.wp.com/latex.php?latex=m+%3C+k&amp;bg=ffffff&amp;fg=000000&amp;s=2" alt="m &lt; k" title="m &lt; k"/></p>



<p>The smallest <em>k</em> which yields a wrong result is hence the first value greater than <em>m</em>: <em>m</em> + 1 so that makes <em>L</em>:</p>



<pre><code>L + 1 = k * d
L + 1 = (m + 1) * d
L = (m + 1) * d - 1</code></pre>



<p>Just to verify let’s try the example from before: 7</p>



<pre><code>L = (9 + 1) * 7 - 1
= 69</code></pre>



<p>Another useful way to write this is</p>



<pre><code>L = (m + 1) * d - 1
= (m * d) + d - 1
= 2<sup>n</sup> - 1 + d - 1
= 2<sup>n</sup> + (d - 2)</code></pre>



<p>This means that for any <em>d</em> &gt; 2 <em>L</em> is at least 2<sup>n</sup>. That gives a nice rule of thumb: the bitwise division by 43 above holds for all values up to 2<sup>14</sup>. And then a bit more.</p>



<p>Can you always find a value of <code><em>n</em></code> that lets you do bitwise division? In theory probably yes, I’m not good enough at number theory to say definitively. But since in practice we’re working with finite numbers  you usually want <em>n</em> to be less than 32 and then the answer, at least initially, is no. Here are some values that you can’t bitwise divide with an <em>n</em> at most 32:</p>



<p>37, 53, 59, 61, 67, 71, 79, 83, 97</p>



<p>Does that mean that if we end up having to divide by 37 there is no way to express that as a bitwise operation? No. This exact approach doesn’t work but there are others. For instance, so far we’ve only looked at <em>dm</em>  = 2<sup>n</sup>-1. There’s also <em>dm</em> = 2<sup>n</sup>+1 — maybe we can use that when 2<sup>n</sup>-1 doesn’t work? (Spoiler: yes we can, not always but often). What about <em>dm</em> = 2<sup>n</sup>-2, might that be useful somehow? There’s more fun to be had with this. But that’s for another post.</p>



<h2>Appendix</h2>



<p>Prime factors of 2<sup><em>n</em></sup> – 1 for <em>n</em> up to 32 (<a href="https://en.wikipedia.org/wiki/Mersenne_prime" target="_blank" rel="noreferrer noopener">Mersenne primes</a> marked in bold).</p>



<figure><table><tbody><tr><td><em>n</em></td><td>prime factors of 2<sup><em>n</em></sup> – 1</td></tr><tr><td><strong>2</strong></td><td>3</td></tr><tr><td><strong>3</strong></td><td>7</td></tr><tr><td>4</td><td>3, 5</td></tr><tr><td><strong>5</strong></td><td>31</td></tr><tr><td>6</td><td>3, 3, 7</td></tr><tr><td><strong>7</strong></td><td>127</td></tr><tr><td>8</td><td>3, 5, 17</td></tr><tr><td>9</td><td>7, 73</td></tr><tr><td>10</td><td>3, 11, 31</td></tr><tr><td>11</td><td>23, 89</td></tr><tr><td>12</td><td>3, 3, 5, 7, 13</td></tr><tr><td><strong>13</strong></td><td>8191</td></tr><tr><td>14</td><td>3, 43, 127</td></tr><tr><td>15</td><td>7, 31, 151</td></tr><tr><td>16</td><td>3, 5, 17, 257</td></tr><tr><td><strong>17</strong></td><td>131071</td></tr><tr><td>18</td><td>3, 3, 3, 7, 19, 73</td></tr><tr><td><strong>19</strong></td><td>524287</td></tr><tr><td>20</td><td>3, 5, 5, 11, 31, 41</td></tr><tr><td>21</td><td>7, 7, 127, 337</td></tr><tr><td>22</td><td>3, 23, 89, 683</td></tr><tr><td>23</td><td>47, 178481</td></tr><tr><td>24</td><td>3, 3, 5, 7, 13, 17, 241</td></tr><tr><td>25</td><td>31, 601, 1801</td></tr><tr><td>26</td><td>3, 2731, 8191</td></tr><tr><td>27</td><td>7, 73, 262657</td></tr><tr><td>28</td><td>3, 5, 29, 43, 113, 127</td></tr><tr><td>29</td><td>233, 1103, 2089</td></tr><tr><td>30</td><td>3, 3, 7, 11, 31, 151, 331</td></tr><tr><td><strong>31</strong></td><td>2147483647</td></tr><tr><td>32</td><td>3, 5, 17, 257, 65537</td></tr></tbody></table></figure>



<p>Reverse index: for a prime, which 2<sup><em>n</em></sup>-1s is it a factor of:</p>



<figure><table><tbody><tr><td>p</td><td>n where p is a prime factor of 2<sup><em>n</em></sup>-1</td></tr><tr><td><strong>3</strong></td><td>2, 4, 6, 6, 8, 10, 12, 12, 14, 16, 18, 18, 18, 20, 22, 24, 24, 26, 28, 30, 30, 32</td></tr><tr><td>5</td><td>4, 8, 12, 16, 20, 20, 24, 28, 32</td></tr><tr><td><strong>7</strong></td><td>3, 6, 9, 12, 15, 18, 21, 21, 24, 27, 30</td></tr><tr><td>11</td><td>10, 20, 30</td></tr><tr><td>13</td><td>12, 24</td></tr><tr><td>17</td><td>8, 16, 24, 32</td></tr><tr><td>19</td><td>18</td></tr><tr><td>23</td><td>11, 22</td></tr><tr><td>29</td><td>28</td></tr><tr><td><strong>31</strong></td><td>5, 10, 15, 20, 25, 30</td></tr><tr><td>41</td><td>20</td></tr><tr><td>43</td><td>14, 28</td></tr><tr><td>47</td><td>23</td></tr><tr><td>73</td><td>9, 18, 27</td></tr><tr><td>89</td><td>11, 22</td></tr><tr><td>113</td><td>28</td></tr><tr><td><strong>127</strong></td><td>7, 14, 21, 28</td></tr><tr><td>151</td><td>15, 30</td></tr><tr><td>233</td><td>29</td></tr><tr><td>241</td><td>24</td></tr><tr><td>257</td><td>16, 32</td></tr><tr><td>331</td><td>30</td></tr><tr><td>337</td><td>21</td></tr><tr><td>601</td><td>25</td></tr><tr><td>683</td><td>22</td></tr><tr><td>1103</td><td>29</td></tr><tr><td>1801</td><td>25</td></tr><tr><td>2089</td><td>29</td></tr><tr><td>2731</td><td>26</td></tr><tr><td><strong>8191</strong></td><td>13, 26</td></tr><tr><td>65537</td><td>32</td></tr><tr><td><strong>131071</strong></td><td>17</td></tr><tr><td>178481</td><td>23</td></tr><tr><td>262657</td><td>27</td></tr><tr><td><strong>524287</strong></td><td>19</td></tr><tr><td><strong>2147483647</strong></td><td>31</td></tr></tbody></table></figure>
							</div></div>
  </body>
</html>
