<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://techcommunity.microsoft.com/t5/security-compliance-and-identity/a-new-modern-and-secure-print-experience-from-windows/ba-p/4002645">Original</a>
    <h1>Windows Protected Print Mode</h1>
    
    <div id="readability-page-1" class="page"><div>
		<div itemprop="text" id="bodyDisplay">
	
		<div>
			
				
					
					
						<p>Over the past year, the <a href="https://news.microsoft.com/source/features/innovation/morse-microsoft-offensive-research-security-engineering/" target="_self" rel="noopener noreferrer">MORSE</a> team has been working in collaboration with the Windows Print team to modernize the Windows Print System. This new design represents one of the largest changes to the Windows Print stack in more than 20 years. The goal was to build a more modern and secure print system that maximizes compatibility and puts users first. We are calling this new platform Windows Protected Print Mode (WPP). We believe users should be Secure-by-Default which is why WPP will eventually be on by default in Windows.</p>

<p>Recently, we announced our plan to <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/print/end-of-servicing-plan-for-third-party-printer-drivers-on-windows?ranMID=24542&amp;ranEAID=kXQk6*ivFEQ&amp;ranSiteID=kXQk6.ivFEQ-ZFGoRqTOIaaag49v2D3I8Q&amp;epi=kXQk6.ivFEQ-ZFGoRqTOIaaag49v2D3I8Q&amp;irgwc=1&amp;OCID=AIDcmm549zy227_aff_7593_1243925&amp;tduid=(ir__ykg06ks3ewkfdni0ilsbb0ikp22xbxjx9tu212ht00)(7593)(1243925)(kXQk6.ivFEQ-ZFGoRqTOIaaag49v2D3I8Q)()&amp;irclickid=_ykg06ks3ewkfdni0ilsbb0ikp22xbxjx9tu212ht00" target="_blank" rel="noopener noreferrer">end servicing</a> for third-party drivers in Windows. Moving away from drivers has allowed us to significantly improve the print stack. This article will explain the case for adopting driverless printing, provide some insights on compatibility, and preview the security improvements provided by Windows Protected Print Mode.  </p>

<p>One of the largest motivations behind the change is security. The Windows print system has been a key target for attackers. The Spooler runs with high privileges and must load code from the network which is difficult to accomplish with low friction and high security. Print bugs played a role in Stuxnet and Print Nightmare, and account for 9% of all Windows cases reported to MSRC.  Securing the print stack is challenging, in large part due to the use of third-party drivers. WPP blocks all third-party drivers and implements a wide range of new security protections.</p>

<p>To put these changes in some context, MORSE did an analysis of past MSRC cases for Windows Print to assess if these changes would help. <strong>What we found is that Windows Protected Print Mode mitigated over half of those vulnerabilities.</strong> </p>

<p>Although we know some may find changing configurations inconvenient, we believe it is best for overall user security.</p>

<p><strong><SPAN size="5">The Driver Problem</SPAN></strong></p>
<p>The security model for print drivers relies on a shared responsibility approach where the Windows printing stack and third-party drivers must each play a role in providing functionality and enforcing security promises while avoiding introducing vulnerabilities. This is like some other subsystems in Windows, but printing is a particularly challenging scenario because both we and customers want the process to be as frictionless as possible. Balancing security, convenience and backwards compatibility with older devices is challenging.  Here are some examples.</p>

<p><strong><SPAN size="4">Print Nightmare</SPAN></strong></p>
<p>This vulnerability was the result of an authorization bypass bug which allowed authenticated remote users to install print drivers using the RPC call RpcAddPrinterDriver and specify a driver file located in a remote location. The attacker’s chosen file was then loaded as a DLL and executed in the highly privileged Spooler process, effectively granting the attacker SYSTEM privileges.</p>

<p>Fixing this vulnerability was complicated by the fact that such a feature exists by design called <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/print/introduction-to-point-and-print" target="_blank" rel="noopener noreferrer">Point and Print</a> which allows for frictionless driver installation by a print server to the client. Remote servers can install drivers without an admin prompt on the client assuming the appropriate configuration (registry setting) on the client. Once a fix was in place, users of V3 drivers, often in larger environments, suddenly found themselves with Admin login prompts when trying to use their printers. Users of V4 drivers did not experience this problem. Although the V4 model was introduced in 2012, 9 years before this vulnerability in 2021, most printers still used V3 drivers. This really speaks to some of the challenges with the driver-based model.</p>

<p><strong><SPAN size="4">Compatibility</SPAN></strong></p>
<p>One challenge with print drivers is their age. Some print drivers are decades old and are incompatible with modern security mitigations, such as Control Flow Guard (CFG), Control Flow Enforcement Technology (CET), Arbitrary Code Guard (ACG), and the many other protections Microsoft has implemented over the years. These protections are often “all or nothing,” meaning that all participating binaries must take steps to be compatible for the protection to be effective. Since not every print manufacturer has taken the necessary steps to update these drivers, the print service does not currently benefit from these modern exploit mitigations.</p>

<p><strong><SPAN size="4">Excessive Permissions</SPAN></strong></p>
<p>Loading code from third parties presents several challenges from a security perspective. Not only must you ensure you’re loading the code you intended to load, that code may change the behavior of your application in unexpected ways. For example, drivers support complex parsing logic, which can lead to bugs allowing full control of the Spooler or related print process. Many users don’t understand that print drivers run as SYSTEM which is more powerful than a typical administrator account. So, bugs in drivers are extremely useful for attackers.</p>

<p>In the event a vulnerability is discovered in a driver, Microsoft is dependent on the third-party to update the driver. When publishers no longer exist or consider older products out of support, there is no clear way to address the vulnerability.</p>

<p><strong><SPAN size="5">IPP Basics</SPAN></strong></p>
<p>Internet Printing Protocol (IPP) is an HTTP-based protocol and supports many of the authentication methods one would expect from HTTP. Each IPP request is an HTTP POST message, and printers are identified using URI’s such as ipps://printer.example.com/ipp/print.  IPP supports all the <a href="https://www.iana.org/assignments/ipp-registrations/ipp-registrations.xhtml" target="_blank" rel="noopener nofollow noreferrer">common operations</a> one would expect from a printer.</p>

<p>Driverless printing supports a limited number of  Printer Document Languages (PDL) based on public standards such as PWG Raster and PDF. This limits the unique number of formats the operating system must handle for conversion and greatly simplifies code. Client-side rendering is used to generate the final document sent to the printer.</p>

<p>Unlike <a href="https://en.wikipedia.org/wiki/Line_Printer_Daemon_protocol" target="_blank" rel="noopener nofollow noreferrer">LPR/LPD</a><span>,</span> IPP supports built-in encryption. This support is like the encryption used today when using HTTPS over the web. Access control and authentication are also part of the protocol. Although not intended as a security benefit, the IPP Driverless specifications support a small number of PDLs, limiting the amount of complex parsing required by the client. Today, drivers implement <a href="https://en.wikipedia.org/wiki/Page_description_language" target="_blank" rel="noopener nofollow noreferrer">over 40 different PDL’s</a>, which can result in vulnerabilities. </p>

<p><strong><SPAN size="4">State of IPP Printing in Windows Today</SPAN></strong></p>
<p>The Windows Print Team has been working to bring IPP printing to more users for some time now. Today, if you view any of our print documentation, you are <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/print/printer-driver-architecture" target="_blank" rel="noopener noreferrer">presented with a notice</a><span>.</span></p>
<p><span image-alt="spoofy_0-1701888382784.png"><img src="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/532572i549F2D653AF3772A/image-dimensions/572x133?v=v2" width="572" height="133" role="button" title="spoofy_0-1701888382784.png" alt="spoofy_0-1701888382784.png" li-image-url="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/532572i549F2D653AF3772A?v=v2" li-image-display-id="&#39;532572i549F2D653AF3772A&#39;" li-message-uid="&#39;4002645&#39;" li-messages-message-image="true" li-bindable="" tabindex="0" li-bypass-lightbox-when-linked="true" li-use-hover-links="false"/></span></p>

<p>This notice is intended to encourage users to switch to IPP, when possible, and encourage industry partners to switch to IPP-based printing. There will be cases when custom functionality is needed, and vendors can extend support by creating a <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devapps/print-support-app-design-guide" target="_blank" rel="noopener noreferrer">Print Support App (PSA)</a>. IPP Printing in Windows today works side-by-side with driver-based printing, allowing users to choose either configuration. Let’s discuss some of the components of the IPP Print system and the security advantages and disadvantages.</p>

<p><strong><SPAN size="4">Print Support App (PSA)</SPAN></strong></p>
<p>PSAs allow printer OEMs and IHVs to extend our existing IPP support for their specific needs. Not all printers support the same features and configuration options. PSAs allow for tailored user experiences without compromising the experience users expect.</p>
<p>These applications take advantage of the <a href="https://learn.microsoft.com/en-us/windows/uwp/get-started/universal-application-platform-guide" target="_blank" rel="noopener noreferrer">Universal Windows Application Platform (UWP),</a> which are more restricted than Win32 applications. Users have more control over what permissions the application can use, and management of updates is automatic through the Microsoft store. Windows will automatically install the correct PSA for users, if one exists, based on the printer’s hardware ID.</p>

<p><strong><SPAN size="4">Point and Print</SPAN></strong></p>
<p><a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/print/introduction-to-point-and-print" target="_blank" rel="noopener noreferrer">Point and Print</a> is a feature that allows users to connect to a remote printer without providing drivers, and has all necessary drivers installed on the client. Point and Print remains with IPP, but it works differently.  We no longer must install drivers, but some basic configuration is required to set up the printer. This process works as follows with IPP.</p>
<ol>
<li>Windows client and server make a connection over RPC</li>
<li>Both Server and Client use their inbox Microsoft IPP driver</li>
<li>Server uses IPP to communicate with Printer</li>
<li>PSA is installed, if available</li>
</ol>

<p><span image-alt="spoofy_1-1701888382787.png"><img src="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/532573i6F35CF7932D7D483/image-dimensions/495x146?v=v2" width="495" height="146" role="button" title="spoofy_1-1701888382787.png" alt="spoofy_1-1701888382787.png" li-image-url="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/532573i6F35CF7932D7D483?v=v2" li-image-display-id="&#39;532573i6F35CF7932D7D483&#39;" li-message-uid="&#39;4002645&#39;" li-messages-message-image="true" li-bindable="" tabindex="0" li-bypass-lightbox-when-linked="true" li-use-hover-links="false"/></span></p>

<h2 id="toc-hId-1217480985"><strong><SPAN size="4">Security</SPAN></strong></h2>
<p>IPP-based printing in Windows today removes the need for third-party drivers, and any third-party code installed to support printing runs within an AppContainer, limiting the risk to users. Encryption is supported for all communication, and with a limited number of PDL’s supported, parsing complexity is substantially decreased. This is a meaningful improvement over the model requiring the use of drivers.</p>

<p>However, today, IPP-based printing still runs side-by-side with driver-based Printing.  Point and Print, for example, will either install a driver or install an IPP printer in the current configuration, depending on what the server requires. While this approach minimizes compatibility risk, it also greatly limits the changes we can make to improve security.</p>

<p>IPP Printing in Windows today is already a great step forward from a security perspective, and we encourage users to switch whenever possible. We also encourage administrators to prioritize this action across your fleet.</p>

<p><strong><SPAN size="5">Windows Protected Print Mode (WPP)</SPAN></strong></p>
<p>WPP  builds on the existing IPP print stack <span>where o</span>nly <a href="https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fmopria.org%2Fcertified-products&amp;data=05%7C01%7Cjonorman%40microsoft.com%7C8ff9bd8e6b9d4e57d71208dbca838b12%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638326438572266818%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&amp;sdata=39t4PXrfNR7bVL1%2BJmj4d1Z1uBiD1mJ3oPhtXtfbryI%3D&amp;reserved=0" target="_blank" rel="noopener nofollow noreferrer">Mopria certified printers</a> are supported, and disables the ability to load third-party drivers. By doing this, we can make meaningful improvements to print security in Windows that otherwise could not happen. Our goal is to ultimately provide the most secure default configuration and provide the flexibility to revert back to legacy (driver-based) printing at any time, if users find their printer is not compatible. </p>

<p>When users enable WPP mode normal spooler operations are deferred to a new Spooler which implements the WPP improvements. Let’s look at some of those changes.</p>

<h3 id="toc-hId-1908042459"><strong><SPAN size="4">Limited/Secure Print Configuration</SPAN></strong></h3>
<p>In WPP, many legacy configurations are no longer valid. A common attack on Windows would abuse the fact that a printer port can be a Dynamic Link Library (DLL), and attackers would abuse this to load malicious code. Attackers would also use symbolic links to trick the Spooler into loading malicious code, and that is no longer possible. There are many legacy API’s which are updated to restrict the configuration to values that make sense only when using IPP. This will limit the opportunity for attackers to leverage the Spooler to modify files on the system.</p>

<p><strong><SPAN size="4">Module Blocking</SPAN></strong></p>
<p><a target="_blank" name="_Toc129364197"></a>API’s that allow module loading will be modified to prevent loading of new modules. For example, AddPrintProviderW, and other calls, would result in loading modules which may be malicious.  We will also enforce a restriction that ensures that only Microsoft Signed binaries required for IPP are loaded.</p>

<p><strong><SPAN size="4">Per-User XPS Rendering</SPAN></strong></p>
<p>XPS rendering will run as the user instead of SYSTEM in WPP. Most print jobs in Windows today involve some XPS conversion and the process that handles this task (PrintFilterPipelineSVC) is the source of many memory corruption vulnerabilities. As with the other issues, by running this process as the user, the impact of these bugs is minimized. </p>

<h3 id="toc-hId-100587996"><strong><SPAN size="4">Lower Privileges for Common Spooler tasks</SPAN></strong></h3>
<p>Removing drivers also allows us to take common tasks performed by the Spooler process and move those to a process running as the user. If these processes have memory corruption vulnerability, that impact will be limited to actions only the user can perform.</p>
<p>The new Spooler Worker process has a new restricted token that removes many privileges such as SeTcbPrivilege, SeAssignPrimaryTokenPrivilege and no longer runs at SYSTEM IL.  </p>

<p>It does retain SeImpersonatePrivilege which is something we intend to remove in the future.</p>

<p><strong><SPAN size="4"><a target="_blank" name="_Toc129364198"></a>Binary Mitigations</SPAN></strong></p>
<p>By removing third-party binaries, we are now able to enable many of the binary mitigations Microsoft has invested in over the years. Processes in WPP will run with many new binary mitigations. Here are some of the highlights:</p>

<p>Control Flow Enforcement Technology (<a href="https://learn.microsoft.com/en-us/cpp/build/reference/guard-enable-guard-checks?view=msvc-170" target="_blank" rel="noopener noreferrer">CFG</a>, <a href="https://learn.microsoft.com/en-us/cpp/build/reference/cetcompat" target="_blank" rel="noopener noreferrer">CET</a>) – Hardware based mitigation which helps to mitigate Return Oriented Programming (ROP) based attacks.</p>
<p>Child Process Creation Disabled – Child process creation will be blocked. This prevents attackers from spawning a new process if they manage to get code execution in the Spooler.</p>
<p>Redirection Guard – prevents many common path redirection attacks which often target the Print Spooler.</p>
<p>Arbitrary Code Guard – prevents dynamic code generation within a process.</p>

<p>These protections make it more difficult to abuse a vulnerability once one is found.</p>

<p><strong><SPAN size="4">Point and Print</SPAN></strong></p>
<p>As mentioned above, Point and Print will normally allow driver loading as well as IPP printer configuration. Some users may have an environment with only IPP printers, but malicious attackers can pretend to be a printer and trick users into installing drivers. WPP prevents Point and Print from ever installing third-party drivers, mitigating this risk.</p>

<p><strong><SPAN size="4">Better Transport Security</SPAN></strong></p>
<p>Printers make use of a variety of transport protocols and transport encryption is not always used. Often, it is not clear to users if their traffic is encrypted, and determining this can be difficult. IPP supports strong encryption, like what is used by web browsers today. WPP will make it clear to users when their traffic is encrypted and, when possible, encourage users to enable encryption.</p>

<p><strong><SPAN size="5">Continued Investments to Make Windows Secure by Design</SPAN></strong></p>
<p>As you can see, moving away from driver-based printing offers many benefits to users and allows Microsoft to make many meaningful improvements to our print system. The existing driver-based system, established decades ago, depends on many third parties and Microsoft all playing their role, which has proven to be too slow for modern threats.</p>

<p>IPP-based printing is well supported, and users who switch will reduce their exposure to attacks. Users who switch to Windows Protected Print Mode will go even further in ensuring they are safe from attackers.  <strong>WPP is now in Insider builds and we hope you will help us test by trying the feature and providing feedback.</strong> Users can enable the feature by following the instructions provided <a href="https://aka.ms/wip26016" target="_blank" rel="noopener noreferrer">here</a>.</p>

<p>This is an early release; many features are incomplete and subject to change based on feedback. For example, today we lack a UI, and many security improvements are still in progress. Over time these improvements will continue to roll out to Insider Builds as we work to improve WPP.</p>

<p>Also, Windows Protected Print Mode will qualify for the <a href="https://www.microsoft.com/en-us/msrc/bounty-windows-insider-preview" target="_blank" rel="noopener noreferrer">Windows Insider Preview Bounty Program</a><span>,</span> and we encourage security researchers to identify and report bugs.</p>
					
				
			
			
			
				
			
			
			
			
			
			
		</div>
		
		
	

	
	
</div>
	</div></div>
  </body>
</html>
