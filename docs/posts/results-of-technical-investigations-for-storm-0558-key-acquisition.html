<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://msrc.microsoft.com/blog/2023/09/results-of-major-technical-investigations-for-storm-0558-key-acquisition/">Original</a>
    <h1>Results of technical investigations for Storm-0558 key acquisition</h1>
    
    <div id="readability-page-1" class="page"><div>
					<p>On July 11, 2023, Microsoft published a <a href="https://msrc.microsoft.com/blog/2023/07/microsoft-mitigates-china-based-threat-actor-storm-0558-targeting-of-customer-email/" target="_blank" rel="noopener">blog post</a> which details how the China-Based threat actor, Storm-0558, used an acquired Microsoft account (MSA) consumer key to forge tokens to access OWA and Outlook.com. Upon identifying that the threat actor had acquired the consumer key, Microsoft performed a comprehensive technical investigation into the acquisition of the Microsoft account consumer signing key, including how it was used to access enterprise email. Our technical investigation has concluded. As part of our commitment to transparency and trust, we are releasing our investigation findings.</p>

    <h2 id="key-acquisition">
        Key acquisition  
        <a href="#key-acquisition">Key acquisition  </a>
    </h2>
<p>Microsoft maintains a highly isolated and restricted production environment. Controls for Microsoft employee access to production infrastructure include background checks, dedicated accounts, secure access workstations, and multi-factor authentication using hardware token devices. Controls in this environment also prevent the use of email, conferencing, web research and other collaboration tools which can lead to common account compromise vectors such as malware infections or phishing, as well as restricting access to systems and data using Just in Time and Just Enough Access policies.</p>
<p>Our corporate environment, which also requires secure authentication and secure devices, allows for email, conferencing, web research and other collaboration tools. While these tools are important, they also make users vulnerable to spear phishing, token stealing malware, and other account compromise vectors. For this reason - by policy and as part of our Zero-Trust and “assume breach” mindset - key material should not leave our production environment.</p>
<p>Our investigation found that a consumer signing system crash in April of 2021 resulted in a snapshot of the crashed process (“crash dump”). The crash dumps, which redact sensitive information, should not include the signing key. In this case, a race condition allowed the key to be present in the crash dump (this issue has been corrected). The key material’s presence in the crash dump was not detected by our systems (this issue has been corrected).</p>
<p>We found that this crash dump, believed at the time not to contain key material, was subsequently moved from the isolated production network into our debugging environment on the internet connected corporate network. This is consistent with our standard debugging processes. Our credential scanning methods did not detect its presence (this issue has been corrected).  </p>
<p>After April 2021, when the key was leaked to the corporate environment in the crash dump, the Storm-0558 actor was able to successfully compromise a Microsoft engineer’s corporate account. This account had access to the debugging environment containing the crash dump which incorrectly contained the key. Due to log retention policies, we don’t have logs with specific evidence of this exfiltration by this actor, but this was the most probable mechanism by which the actor acquired the key.</p>

    <h2 id="why-a-consumer-key-was-able-to-access-enterprise-mail">
        Why a consumer key was able to access enterprise mail
        <a href="#why-a-consumer-key-was-able-to-access-enterprise-mail">Why a consumer key was able to access enterprise mail</a>
    </h2>
<p>To meet growing customer demand to support applications which work with both consumer and enterprise applications, Microsoft <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/for-developers-the-first-use-cases-of-the-converged-microsoft/ba-p/244232" target="_blank" rel="noopener">introduced</a> a common key metadata publishing endpoint in September 2018. As part of this converged offering, Microsoft updated documentation to clarify the requirements for key scope validation – which key to use for enterprise accounts, and which to use for consumer accounts.  </p>
<p>As part of a pre-existing library of documentation and helper APIs, Microsoft provided an API to help validate the signatures cryptographically but did not update these libraries to perform this scope validation automatically (this issue has been corrected). The mail systems were updated to use the common metadata endpoint in 2022. Developers in the mail system incorrectly assumed libraries performed complete validation and did not add the required issuer/scope validation. Thus, the mail system would accept a request for enterprise email using a security token signed with the consumer key (this issue has been corrected using the updated libraries).  </p>

    <h2 id="post-incident-review">
        Post Incident Review
        <a href="#post-incident-review">Post Incident Review</a>
    </h2>
<p>Microsoft is continuously hardening systems as part of our defense in depth strategy. Investments which have been made related to MSA key management are covered in the <a href="https://aka.ms/storm-0558" target="_blank" rel="noopener">https://aka.ms/storm-0558</a> blog. Items detailed in this blog are a subset of these overall investments. We are summarizing the improvements specific to these findings here for clarity:</p>
<ol>
<li>
<p>Identified and resolved race Condition that allowed the signing key to be present in crash dumps</p>
</li>
<li>
<p>Enhanced prevention, detection, and response for key material erroneously included in crash dumps</p>
</li>
<li>
<p>Enhanced credential scanning to better detect presence of signing key in the debugging environment</p>
</li>
<li>
<p>Released enhanced libraries to automate key scope validation in authentication libraries, and clarified related documentation</p>
</li>
</ol>

				</div></div>
  </body>
</html>
