<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/luainkernel/lunatik">Original</a>
    <h1>Lunatik: Lunatik is a framework for scripting the Linux kernel with Lua</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">Lunatik is a framework for scripting the Linux kernel with <a href="https://www.lua.org/" rel="nofollow">Lua</a>.
It is composed by the Lua interpreter modified to run in the kernel;
a <a href="https://github.com/luainkernel/lunatik/blob/master/lunatik.lua">device driver</a> (written in Lua =)) and a <a href="https://github.com/luainkernel/lunatik/blob/master/lunatik">command line tool</a>
to load and run scripts and manage runtime environments from the user space;
a <a href="#lunatik-c-api">C API</a> to load and run scripts and manage runtime environments from the kernel;
and <a href="#lunatik-lua-apis">Lua APIs</a> for binding kernel facilities to Lua scripts.</p>
<p dir="auto">Here is an example of a character device driver written in Lua using Lunatik
to generate random ASCII printable characters:</p>
<div dir="auto" data-snippet-clipboard-copy-content="-- /lib/modules/lua/passwd.lua
--
-- implements /dev/passwd for generate passwords
-- usage: $ sudo lunatik run passwd
--        $ head -c &lt;width&gt; /dev/passwd

local device = require(&#34;device&#34;)
local linux  = require(&#34;linux&#34;)

local function nop() end -- do nothing

local s = linux.stat
local driver = {name = &#34;passwd&#34;, open = nop, release = nop, mode = s.IRUGO}

function driver:read() -- read(2) callback
	-- generate random ASCII printable characters
	return string.char(linux.random(32, 126))
end

-- creates a new character device
device.new(driver)"><pre><span><span>--</span> /lib/modules/lua/passwd.lua</span>
<span><span>--</span></span>
<span><span>--</span> implements /dev/passwd for generate passwords</span>
<span><span>--</span> usage: $ sudo lunatik run passwd</span>
<span><span>--</span>        $ head -c &lt;width&gt; /dev/passwd</span>

<span>local</span> <span>device</span> <span>=</span> <span>require</span>(<span><span>&#34;</span>device<span>&#34;</span></span>)
<span>local</span> <span>linux</span>  <span>=</span> <span>require</span>(<span><span>&#34;</span>linux<span>&#34;</span></span>)

<span>local</span> <span>function</span> <span>nop</span>() <span>end</span> <span><span>--</span> do nothing</span>

<span>local</span> <span>s</span> <span>=</span> <span>linux</span>.<span>stat</span>
<span>local</span> <span>driver</span> <span>=</span> {<span>name</span> <span>=</span> <span><span>&#34;</span>passwd<span>&#34;</span></span>, <span>open</span> <span>=</span> <span>nop</span>, <span>release</span> <span>=</span> <span>nop</span>, <span>mode</span> <span>=</span> <span>s</span>.<span>IRUGO</span>}

<span>function</span> <span>driver</span>:<span>read</span>() <span><span>--</span> read(2) callback</span>
	<span><span>--</span> generate random ASCII printable characters</span>
	<span>return</span> <span>string.char</span>(<span>linux</span>.<span>random</span>(<span>32</span>, <span>126</span>))
<span>end</span>

<span><span>--</span> creates a new character device</span>
<span>device</span>.<span>new</span>(<span>driver</span>)</pre></div>

<div data-snippet-clipboard-copy-content="make
sudo make install
sudo lunatik # execute Lunatik REPL
Lunatik 3.4  Copyright (C) 2023-2024 ring-0 Ltda.
&gt; return 42 -- execute this line in the kernel
42"><pre><code>make
sudo make install
sudo lunatik # execute Lunatik REPL
Lunatik 3.4  Copyright (C) 2023-2024 ring-0 Ltda.
&gt; return 42 -- execute this line in the kernel
42
</code></pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="usage: lunatik [load|unload|reload|status|list] [run|spawn|stop &lt;script&gt;]"><pre>usage: lunatik [load<span>|</span>unload<span>|</span>reload<span>|</span>status<span>|</span>list] [run<span>|</span>spawn<span>|</span>stop <span>&lt;</span>script<span>&gt;</span>]</pre></div>
<ul dir="auto">
<li><code>load</code>: load Lunatik kernel modules</li>
<li><code>unload</code>: unload Lunatik kernel modules</li>
<li><code>reload</code>: reload Lunatik kernel modules</li>
<li><code>status</code>: show which Lunatik kernel modules are currently loaded</li>
<li><code>list</code>: show which runtime environments are currently running</li>
<li><code>run</code>: create a new runtime environment to run the script <code>/lib/modules/lua/&lt;script&gt;.lua</code></li>
<li><code>spawn</code>: create a new runtime environment and spawn a thread to run the script <code>/lib/modules/lua/&lt;script&gt;.lua</code></li>
<li><code>stop</code>: stop the runtime environment created to run the script <code>&lt;script&gt;</code></li>
<li><code>default</code>: start a <em>REPL (Read–Eval–Print Loop)</em></li>
</ul>

<p dir="auto">Lunatik 3.4 is based on
<a href="https://github.com/luainkernel/lua">Lua 5.4 adapted</a>
to run in the kernel.</p>

<p dir="auto">Lunatik <strong>does not</strong> support floating-point arithmetic,
thus it <strong>does not</strong> support <code>__div</code> nor <code>__pow</code>
<a href="https://www.lua.org/manual/5.4/manual.html#2.4" rel="nofollow">metamethods</a>
and the type <em>number</em> has only the subtype <em>integer</em>.</p>

<p dir="auto">Lunatik <strong>does not</strong> support both <a href="https://www.lua.org/manual/5.4/manual.html#6.8" rel="nofollow">io</a> and
<a href="https://www.lua.org/manual/5.4/manual.html#6.9" rel="nofollow">os</a> libraries,
and the given identifiers from the following libraries:</p>
<ul dir="auto">
<li><a href="https://www.lua.org/manual/5.4/manual.html#pdf-debug.debug" rel="nofollow">debug.debug</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.acos" rel="nofollow">math.acos</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.asin" rel="nofollow">math.asin</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.atan" rel="nofollow">math.atan</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.ceil" rel="nofollow">math.ceil</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.cos" rel="nofollow">math.cos</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.deg" rel="nofollow">math.deg</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.exp" rel="nofollow">math.exp</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.floor" rel="nofollow">math.floor</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.fmod" rel="nofollow">math.fmod</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.huge" rel="nofollow">math.huge</a>.
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.log" rel="nofollow">math.log</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.modf" rel="nofollow">math.modf</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.pi" rel="nofollow">math.pi</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.rad" rel="nofollow">math.rad</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.random" rel="nofollow">math.random</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.randomseed" rel="nofollow">math.randomseed</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.sin" rel="nofollow">math.sin</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.sqrt" rel="nofollow">math.sqrt</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.tan" rel="nofollow">math.tan</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.type" rel="nofollow">math.type</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-package.cpath" rel="nofollow">package.cpath</a>.</li>
</ul>
<p dir="auto">Lunatik <strong>modifies</strong> the following identifiers:</p>
<ul dir="auto">
<li><a href="https://www.lua.org/manual/5.4/manual.html#pdf-_VERSION" rel="nofollow">_VERSION</a>: is defined as <code>&#34;Lua 5.4-kernel&#34;</code>.</li>
<li><a href="https://www.lua.org/manual/5.4/manual.html#pdf-collectgarbage" rel="nofollow">collectgarbage(&#34;count&#34;)</a>: returns the total memory in use by Lua in <strong>bytes</strong>, instead of <em>Kbytes</em>.</li>
<li><a href="https://www.lua.org/manual/5.4/manual.html#pdf-package.path" rel="nofollow">package.path</a>: is defined as <code>&#34;/lib/modules/lua/?.lua;/lib/modules/lua/?/init.lua&#34;</code>.</li>
<li><a href="https://www.lua.org/manual/5.4/manual.html#pdf-require" rel="nofollow">require</a>: only supports built-in or already linked C modules, that is, Lunatik <strong>cannot</strong> load kernel modules dynamically.</li>
</ul>

<p dir="auto">Lunatik <strong>does not</strong> support
<a href="https://www.lua.org/manual/5.4/manual.html#luaL_Stream" rel="nofollow">luaL_Stream</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#luaL_execresult" rel="nofollow">luaL_execresult</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#luaL_fileresult" rel="nofollow">luaL_fileresult</a>,
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-luaopen_io" rel="nofollow">luaopen_io</a> and
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-luaopen_os" rel="nofollow">luaopen_os</a>.</p>
<p dir="auto">Lunatik <strong>modifies</strong> <a href="https://www.lua.org/manual/5.4/manual.html#luaL_openlibs" rel="nofollow">luaL_openlibs</a> to remove <a href="https://www.lua.org/manual/5.4/manual.html#pdf-luaopen_io" rel="nofollow">luaopen_io</a> and <a href="https://www.lua.org/manual/5.4/manual.html#pdf-luaopen_os" rel="nofollow">luaopen_os</a>.</p>



<div dir="auto" data-snippet-clipboard-copy-content="int lunatik_runtime(lunatik_object_t **pruntime, const char *script, bool sleep);"><pre><span>int</span> <span>lunatik_runtime</span>(<span>lunatik_object_t</span> <span>*</span><span>*</span><span>pruntime</span>, <span>const</span> <span>char</span> <span>*</span><span>script</span>, <span>bool</span> <span>sleep</span>);</pre></div>
<p dir="auto"><em>lunatik_runtime()</em> creates a new <code>runtime</code> environment then loads and runs the script
<code>/lib/modules/lua/&lt;script&gt;.lua</code> as the entry point for this environment.
It <em>must</em> only be called from <em>process context</em>.
The <code>runtime</code> environment is a Lunatik object that holds
a <a href="https://www.lua.org/manual/5.4/manual.html#lua_State" rel="nofollow">Lua state</a>.
Lunatik objects are special
Lua <a href="https://www.lua.org/manual/5.4/manual.html#2.1" rel="nofollow">userdata</a>
which also hold
a <a href="https://docs.kernel.org/locking/locktypes.html" rel="nofollow">lock type</a> and
a <a href="https://www.kernel.org/doc/Documentation/kref.txt" rel="nofollow">reference counter</a>.
If <code>sleep</code> is <em>true</em>, <em>lunatik_runtime()</em> will use a
<a href="https://docs.kernel.org/locking/mutex-design.html" rel="nofollow">mutex</a>
for locking the <code>runtime</code> environment and the
<a href="https://www.kernel.org/doc/html/latest/core-api/memory-allocation.html" rel="nofollow">GFP_KERNEL</a>
flag for allocating new memory later on on
<a href="https://github.com/luainkernel/lunatik#lunatik_run">lunatik_run()</a> calls.
Otherwise, it will use a <a href="https://docs.kernel.org/locking/locktypes.html#raw-spinlock-t-and-spinlock-t" rel="nofollow">spinlock</a> and <a href="https://www.kernel.org/doc/html/latest/core-api/memory-allocation.html" rel="nofollow">GFP_ATOMIC</a>.
<em>lunatik_runtime()</em> opens the Lua standard libraries
<a href="https://github.com/luainkernel/lunatik#c-api">present on Lunatik</a>.
If successful, <em>lunatik_runtime()</em> sets the address pointed by <code>pruntime</code> and
<a href="https://www.lua.org/manual/5.4/manual.html#lua_getextraspace" rel="nofollow">Lua&#39;s extra space</a>
with a pointer for the new created <code>runtime</code> environment,
sets the <em>reference counter</em> to <code>1</code> and then returns <code>0</code>.
Otherwise, it returns <code>-ENOMEM</code>, if insufficient memory is available;
or <code>-EINVAL</code>, if it fails to load or run the <code>script</code>.</p>

<div dir="auto" data-snippet-clipboard-copy-content="-- /lib/modules/lua/mydevice.lua
function myread(len, off)
	return &#34;42&#34;
end"><pre><span><span>--</span> /lib/modules/lua/mydevice.lua</span>
<span>function</span> <span>myread</span>(<span>len</span>, <span>off</span>)
	<span>return</span> <span><span>&#34;</span>42<span>&#34;</span></span>
<span>end</span></pre></div>
<div dir="auto" data-snippet-clipboard-copy-content="static lunatik_object_t *runtime;

static int __init mydevice_init(void)
{
	return lunatik_runtime(&amp;runtime, &#34;mydevice&#34;, true);
}
"><pre><span>static</span> <span>lunatik_object_t</span> <span>*</span><span>runtime</span>;

<span>static</span> <span>int</span> <span>__init</span> <span>mydevice_init</span>(<span>void</span>)
{
	<span>return</span> <span>lunatik_runtime</span>(<span>&amp;</span><span>runtime</span>, <span>&#34;mydevice&#34;</span>, true);
}</pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="int lunatik_stop(lunatik_object_t *runtime);"><pre><span>int</span> <span>lunatik_stop</span>(<span>lunatik_object_t</span> <span>*</span><span>runtime</span>);</pre></div>
<p dir="auto"><em>lunatik_stop()</em>
<a href="https://www.lua.org/manual/5.4/manual.html#lua_close" rel="nofollow">closes</a>
the
<a href="https://www.lua.org/manual/5.4/manual.html#lua_State" rel="nofollow">Lua state</a>
created for this <code>runtime</code> environment and decrements the
<a href="https://www.kernel.org/doc/Documentation/kref.txt" rel="nofollow">reference counter</a>.
Once the reference counter is decremented to zero, the
<a href="https://docs.kernel.org/locking/locktypes.html" rel="nofollow">lock type</a>
and the memory allocated for the <code>runtime</code> environment are released.
If the <code>runtime</code> environment has been released, it returns <code>1</code>;
otherwise, it returns <code>0</code>.</p>

<div dir="auto" data-snippet-clipboard-copy-content="void lunatik_run(lunatik_object_t *runtime, &lt;inttype&gt; (*handler)(...), &lt;inttype&gt; &amp;ret, ...);"><pre><span>void</span> <span>lunatik_run</span>(<span>lunatik_object_t</span> <span>*</span><span>runtime</span>, <span>&lt;</span><span>inttype</span><span>&gt;</span> (<span>*</span><span>handler</span>)(...), <span>&lt;</span><span>inttype</span><span>&gt;</span> <span>&amp;</span><span>ret</span>, ...);</pre></div>
<p dir="auto"><em>lunatik_run()</em> locks the <code>runtime</code> environment and calls the <code>handler</code>
passing the associated Lua state as the first argument followed by the variadic arguments.
If the Lua state has been closed, <code>ret</code> is set with <code>-ENXIO</code>;
otherwise, <code>ret</code> is set with the result of <code>handler(L, ...)</code> call.
Then, it restores the Lua stack and unlocks the <code>runtime</code> environment.
It is defined as a macro.</p>

<div dir="auto" data-snippet-clipboard-copy-content="static int l_read(lua_State *L, char *buf, size_t len, loff_t *off)
{
	size_t llen;
	const char *lbuf;

	lua_getglobal(L, &#34;myread&#34;);
	lua_pushinteger(L, len);
	lua_pushinteger(L, *off);
	if (lua_pcall(L, 2, 2, 0) != LUA_OK) { /* calls myread(len, off) */
		pr_err(&#34;%s\n&#34;, lua_tostring(L, -1));
		return -ECANCELED;
	}

	lbuf = lua_tolstring(L, -2, &amp;llen);
	llen = min(len, llen);
	if (copy_to_user(buf, lbuf, llen) != 0)
		return -EFAULT;

	*off = (loff_t)luaL_optinteger(L, -1, *off + llen);
	return (ssize_t)llen;
}

static ssize_t mydevice_read(struct file *f, char *buf, size_t len, loff_t *off)
{
	ssize_t ret;
	lunatik_object_t *runtime = (lunatik_object_t *)f-&gt;private_data;

	lunatik_run(runtime, l_read, ret, buf, len, off);
	return ret;
}"><pre><span>static</span> <span>int</span> <span>l_read</span>(<span>lua_State</span> <span>*</span><span>L</span>, <span>char</span> <span>*</span><span>buf</span>, <span>size_t</span> <span>len</span>, <span>loff_t</span> <span>*</span><span>off</span>)
{
	<span>size_t</span> <span>llen</span>;
	<span>const</span> <span>char</span> <span>*</span><span>lbuf</span>;

	<span>lua_getglobal</span>(<span>L</span>, <span>&#34;myread&#34;</span>);
	<span>lua_pushinteger</span>(<span>L</span>, <span>len</span>);
	<span>lua_pushinteger</span>(<span>L</span>, <span>*</span><span>off</span>);
	<span>if</span> (<span>lua_pcall</span>(<span>L</span>, <span>2</span>, <span>2</span>, <span>0</span>) <span>!=</span> <span>LUA_OK</span>) { <span>/* calls myread(len, off) */</span>
		<span>pr_err</span>(<span>&#34;%s\n&#34;</span>, <span>lua_tostring</span>(<span>L</span>, <span>-1</span>));
		<span>return</span> <span>-</span><span>ECANCELED</span>;
	}

	<span>lbuf</span> <span>=</span> <span>lua_tolstring</span>(<span>L</span>, <span>-2</span>, <span>&amp;</span><span>llen</span>);
	<span>llen</span> <span>=</span> <span>min</span>(<span>len</span>, <span>llen</span>);
	<span>if</span> (<span>copy_to_user</span>(<span>buf</span>, <span>lbuf</span>, <span>llen</span>) <span>!=</span> <span>0</span>)
		<span>return</span> <span>-</span><span>EFAULT</span>;

	<span>*</span><span>off</span> <span>=</span> (<span>loff_t</span>)<span>luaL_optinteger</span>(<span>L</span>, <span>-1</span>, <span>*</span><span>off</span> <span>+</span> <span>llen</span>);
	<span>return</span> (<span>ssize_t</span>)<span>llen</span>;
}

<span>static</span> <span>ssize_t</span> <span>mydevice_read</span>(<span>struct</span> <span>file</span> <span>*</span><span>f</span>, <span>char</span> <span>*</span><span>buf</span>, <span>size_t</span> <span>len</span>, <span>loff_t</span> <span>*</span><span>off</span>)
{
	<span>ssize_t</span> <span>ret</span>;
	<span>lunatik_object_t</span> <span>*</span><span>runtime</span> <span>=</span> (<span>lunatik_object_t</span> <span>*</span>)<span>f</span><span>-&gt;</span><span>private_data</span>;

	<span>lunatik_run</span>(<span>runtime</span>, <span>l_read</span>, <span>ret</span>, <span>buf</span>, <span>len</span>, <span>off</span>);
	<span>return</span> <span>ret</span>;
}</pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="void lunatik_getobject(lunatik_object_t *object);"><pre><span>void</span> <span>lunatik_getobject</span>(<span>lunatik_object_t</span> <span>*</span><span>object</span>);</pre></div>
<p dir="auto"><em>lunatik_getobject()</em> increments the
<a href="https://www.kernel.org/doc/Documentation/kref.txt" rel="nofollow">reference counter</a>
of this <code>object</code> (e.g., <code>runtime</code> environment).</p>

<div dir="auto" data-snippet-clipboard-copy-content="int lunatik_putobject(lunatik_object_t *object);"><pre><span>int</span> <span>lunatik_putobject</span>(<span>lunatik_object_t</span> <span>*</span><span>object</span>);</pre></div>
<p dir="auto"><em>lunatik_putobject()</em> decrements the
<a href="https://www.kernel.org/doc/Documentation/kref.txt" rel="nofollow">reference counter</a>
of this <code>object</code> (e.g., <code>runtime</code> environment).
If the <code>object</code> has been released, it returns <code>1</code>;
otherwise, it returns <code>0</code>.</p>

<div dir="auto" data-snippet-clipboard-copy-content="lunatik_object_t *lunatik_toruntime(lua_State *L);"><pre><span>lunatik_object_t</span> <span>*</span><span>lunatik_toruntime</span>(<span>lua_State</span> <span>*</span><span>L</span>);</pre></div>
<p dir="auto"><em>lunatik_toruntime()</em> returns the <code>runtime</code> environment referenced by the <code>L</code>&#39;s
<a href="https://www.lua.org/manual/5.4/manual.html#lua_getextraspace" rel="nofollow">extra space</a>.</p>


<p dir="auto">The <code>lunatik</code> library provides support to load and run scripts and manage runtime environments from Lua.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>lunatik.runtime(script [, sleep])</code></h4><a id="user-content-lunatikruntimescript--sleep" aria-label="Permalink: lunatik.runtime(script [, sleep])" href="#lunatikruntimescript--sleep"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>lunatik.runtime()</em> creates a new
<a href="https://github.com/luainkernel/lunatik#lunatik_runtime">runtime environment</a>
then loads and runs the script
<code>/lib/modules/lua/&lt;script&gt;.lua</code> as the entry point for this environment.
It returns a Lunatik object representing the <code>runtime</code> environment.
If <code>sleep</code> is <em>true</em> or omitted, it will use a <a href="https://docs.kernel.org/locking/mutex-design.html" rel="nofollow">mutex</a>
and
<a href="https://www.kernel.org/doc/html/latest/core-api/memory-allocation.html" rel="nofollow">GFP_KERNEL</a>;
otherwise, it will use a <a href="https://docs.kernel.org/locking/locktypes.html#raw-spinlock-t-and-spinlock-t" rel="nofollow">spinlock</a> and <a href="https://www.kernel.org/doc/html/latest/core-api/memory-allocation.html" rel="nofollow">GFP_ATOMIC</a>.
<em>lunatik.runtime()</em> opens the Lua standard libraries
<a href="https://github.com/luainkernel/lunatik#c-api">present on Lunatik</a>.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>lunatik.stop(runtime)</code>, <code>runtime:stop()</code></h4><a id="user-content-lunatikstopruntime-runtimestop" aria-label="Permalink: lunatik.stop(runtime), runtime:stop()" href="#lunatikstopruntime-runtimestop"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>lunatik.stop()</em>
<a href="https://github.com/luainkernel/lunatik#lunatik_stop">stops</a>
the <code>runtime</code> environment and clear its reference from the runtime object.</p>

<p dir="auto">The <code>device</code> library provides support for writting
<a href="https://static.lwn.net/images/pdf/LDD3/ch03.pdf" rel="nofollow">character device drivers</a>
in Lua.</p>

<p dir="auto"><em>device.new()</em> returns a new <code>device</code> object
and installs its <code>driver</code> in the system.
The <code>driver</code> <strong>must</strong> be defined as a table containing the following field:</p>
<ul dir="auto">
<li><code>name</code>: string defining the device name; it is used for creating the device file (e.g., <code>/dev/&lt;name&gt;</code>).</li>
</ul>
<p dir="auto">The <code>driver</code> table might optionally contain the following fields:</p>
<ul dir="auto">
<li><code>read</code>: callback function to handle the
<a href="https://docs.kernel.org/filesystems/vfs.html#id2" rel="nofollow">read operation</a>
on the device file.
It receives the <code>driver</code> table as the first argument
followed by two integers,
the <code>length</code> to be read and the file <code>offset</code>.
It should return a string and, optionally, the <code>updated offset</code>.
If the length of the returned string is greater than the requested <code>length</code>,
the string will be corrected to that <code>length</code>.
If the <code>updated offset</code> is not returned, the <code>offset</code> will be updated with <code>offset + length</code>.</li>
<li><code>write</code>: callback function to handle the
<a href="https://docs.kernel.org/filesystems/vfs.html#id2" rel="nofollow">write operation</a>
on the device file.
It receives the <code>driver</code> table as the first argument
followed by the string to be written and
an integer as the file <code>offset</code>.
It might return optionally the written <code>length</code> followed by the <code>updated offset</code>.
If the returned length is greater than the requested <code>length</code>,
the returned length will be corrected.
If the <code>updated offset</code> is not returned, the <code>offset</code> will be updated with <code>offset + length</code>.</li>
<li><code>open</code>: callback function to handle the
<a href="https://docs.kernel.org/filesystems/vfs.html#id2" rel="nofollow">open operation</a>
on the device file.
It receives the <code>driver</code> table and it is expected to return nothing.</li>
<li><code>release</code>: callback function to handle the
<a href="https://docs.kernel.org/filesystems/vfs.html#id2" rel="nofollow">release operation</a>
on the device file.
It receives the <code>driver</code> table and it is expected to return nothing.</li>
<li><code>mode</code>: an integer specifying the device
<a href="https://github.com/luainkernel/lunatik#linuxstat">file mode</a>.</li>
</ul>
<p dir="auto">If an operation callback is not defined, the <code>device</code> returns <code>-ENXIO</code> to VFS on its access.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>device.stop(dev)</code>, <code>dev:stop()</code></h4><a id="user-content-devicestopdev-devstop" aria-label="Permalink: device.stop(dev), dev:stop()" href="#devicestopdev-devstop"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>device.stop()</em> removes a device <code>driver</code> specified by the <code>dev</code> object from the system.</p>

<p dir="auto">The <code>linux</code> library provides support for some Linux kernel facilities.</p>

<p dir="auto"><em>linux.random()</em> mimics the behavior of
<a href="https://www.lua.org/manual/5.4/manual.html#pdf-math.random" rel="nofollow">math.random</a>,
but binding <em>&lt;linux/random.h&gt;</em>&#39;s
<a href="https://elixir.bootlin.com/linux/latest/source/include/linux/random.h#L42" rel="nofollow">get_random_u32()</a>
and
<a href="https://elixir.bootlin.com/linux/latest/source/include/linux/random.h#L43" rel="nofollow">get_random_u64()</a>
APIs.</p>
<p dir="auto">When called without arguments,
produces an integer with all bits (pseudo)random.
When called with two integers <code>m</code> and <code>n</code>,
<em>linux.random()</em> returns a pseudo-random integer with uniform distribution in the range <code>[m, n]</code>.
The call <code>math.random(n)</code>, for a positive <code>n</code>, is equivalent to <code>math.random(1, n)</code>.</p>

<p dir="auto"><em>linux.stat</em> is a table that exports
<a href="https://elixir.bootlin.com/linux/latest/source/include/linux/stat.h" rel="nofollow">&lt;linux/stat.h&gt;</a>
integer flags to Lua.</p>
<ul dir="auto">
<li><code>&#34;IRWXUGO&#34;</code>: permission to <em>read</em>, <em>write</em> and <em>execute</em> for <em>user</em>, <em>group</em> and <em>other</em>.</li>
<li><code>&#34;IRUGO&#34;</code>: permission only to <em>read</em> for <em>user</em>, <em>group</em> and <em>other</em>.</li>
<li><code>&#34;IWUGO&#34;</code>: permission only to <em>write</em> for <em>user</em>, <em>group</em> and <em>other</em>.</li>
<li><code>&#34;IXUGO&#34;</code>: permission only to <em>execute</em> for <em>user</em>, <em>group</em> and <em>other</em>.</li>
</ul>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>linux.schedule([timeout [, state]])</code></h4><a id="user-content-linuxscheduletimeout--state" aria-label="Permalink: linux.schedule([timeout [, state]])" href="#linuxscheduletimeout--state"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>linux.schedule()</em> sets the current task <code>state</code> and makes the it sleep until <code>timeout</code> milliseconds have elapsed.
If <code>timeout</code> is omitted, it uses <code>MAX_SCHEDULE_TIMEOUT</code>.
If <code>state</code> is omitted, it uses <code>task.INTERRUPTIBLE</code>.</p>

<p dir="auto"><em>linux.task</em> is a table that exports
<a href="https://elixir.bootlin.com/linux/latest/source/include/linux/sched.h#L7v3" rel="nofollow">task state</a>
flags to Lua.</p>
<ul dir="auto">
<li><code>&#34;RUNNING&#34;</code>: task is executing on a CPU or waiting to be executed.</li>
<li><code>&#34;INTERRUPTIBLE&#34;</code>: task is waiting for a signal or a resource (sleeping).</li>
<li><code>&#34;UNINTERRUPTIBLE&#34;</code>: behaves like &#34;INTERRUPTIBLE&#34; with the exception that signal will not wake up the task.</li>
<li><code>&#34;KILLABLE&#34;</code>: behaves like &#34;UNINTERRUPTIBLE&#34; with the exception that fatal signals will wake up the task.</li>
<li><code>&#34;IDLE&#34;</code>: behaves like &#34;UNINTERRUPTIBLE&#34; with the exception that it avoids the loadavg accounting.</li>
</ul>

<p dir="auto"><em>linux.errno</em> is a table that exports
<a href="https://elixir.bootlin.com/linux/latest/source/include/uapi/asm-generic/errno-base.h" rel="nofollow">&lt;uapi/asm-generic/errno-base.h&gt;</a>
flags to Lua.</p>
<ul dir="auto">
<li><code>&#34;PERM&#34;</code>: Operation not permitted.</li>
<li><code>&#34;NOENT&#34;</code>: No such file or directory.</li>
<li><code>&#34;SRCH&#34;</code>: No such process.</li>
<li><code>&#34;INTR&#34;</code>: Interrupted system call.</li>
<li><code>&#34;IO&#34;</code>: I/O error.</li>
<li><code>&#34;NXIO&#34;</code>:No such device or address.</li>
<li><code>&#34;2BIG&#34;</code>:, Argument list too long.</li>
<li><code>&#34;NOEXEC&#34;</code>: Exec format error.</li>
<li><code>&#34;BADF&#34;</code>: Bad file number.</li>
<li><code>&#34;CHILD&#34;</code>: No child processes.</li>
<li><code>&#34;AGAIN&#34;</code>: Try again.</li>
<li><code>&#34;NOMEM&#34;</code>: Out of memory.</li>
<li><code>&#34;ACCES&#34;</code>: Permission denied.</li>
<li><code>&#34;FAULT&#34;</code>: Bad address.</li>
<li><code>&#34;NOTBLK&#34;</code>: Block device required.</li>
<li><code>&#34;BUSY&#34;</code>: Device or resource busy.</li>
<li><code>&#34;EXIST&#34;</code>: File exists.</li>
<li><code>&#34;XDEV&#34;</code>: Cross-device link.</li>
<li><code>&#34;NODEV&#34;</code>: No such device.</li>
<li><code>&#34;NOTDIR&#34;</code>: Not a directory.</li>
<li><code>&#34;ISDIR&#34;</code>: Is a directory.</li>
<li><code>&#34;INVAL&#34;</code>: Invalid argument.</li>
<li><code>&#34;NFILE&#34;</code>: File table overflow.</li>
<li><code>&#34;MFILE&#34;</code>: Too many open files.</li>
<li><code>&#34;NOTTY&#34;</code>: Not a typewriter.</li>
<li><code>&#34;TXTBSY&#34;</code>: Text file busy.</li>
<li><code>&#34;FBIG&#34;</code>: File too large.</li>
<li><code>&#34;NOSPC&#34;</code>: No space left on device.</li>
<li><code>&#34;SPIPE&#34;</code>: Illegal seek.</li>
<li><code>&#34;ROFS&#34;</code>: Read-only file system.</li>
<li><code>&#34;MLINK&#34;</code>: Too many links.</li>
<li><code>&#34;PIPE&#34;</code>: Broken pipe.</li>
<li><code>&#34;DOM&#34;</code>: Math argument out of domain of func.</li>
<li><code>&#34;RANGE&#34;</code>: Math result not representable.</li>
</ul>

<p dir="auto">The <code>notifier</code> library provides support for the kernel
<a href="https://elixir.bootlin.com/linux/latest/source/include/linux/notifier.h" rel="nofollow">notifier chains</a>.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>notifier.keyboard(callback)</code></h4><a id="user-content-notifierkeyboardcallback" aria-label="Permalink: notifier.keyboard(callback)" href="#notifierkeyboardcallback"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>notifier.keyboard()</em> returns a new keyboard <code>notifier</code> object and installs it in the system.
The <code>callback</code> function is called whenever a console keyboard event happens
(e.g., a key has been pressed or released).
This <code>callback</code> receives the following arguments:</p>
<ul dir="auto">
<li><code>event</code>: the available <em>events</em> are defined by the
<a href="https://github.com/luainkernel/lunatik#notifierkbd">notifier.kbd</a> table.</li>
<li><code>down</code>: <code>true</code>, if the key is pressed; <code>false</code>, if it is released.</li>
<li><code>shift</code>: <code>true</code>, if the shift key is held; <code>false</code>, otherwise.</li>
<li><code>key</code>: <em>keycode</em> or <em>keysym</em> depending on <code>event</code>.</li>
</ul>
<p dir="auto">The <code>callback</code> function might return the values defined by the
<a href="https://github.com/luainkernel/lunatik#notifiernotify">notifier.notify</a> table.</p>

<p dir="auto"><em>notifier.kbd</em> is a table that exports
<a href="https://elixir.bootlin.com/linux/latest/source/include/linux/notifier.h#L229" rel="nofollow">KBD</a>
flags to Lua.</p>
<ul dir="auto">
<li><code>&#34;KEYCODE&#34;</code>: keyboard <em>keycode</em>, called before any other.</li>
<li><code>&#34;UNBOUND_KEYCODE&#34;</code>: keyboard <em>keycode</em> which is not bound to any other.</li>
<li><code>&#34;UNICODE&#34;</code>: keyboard unicode.</li>
<li><code>&#34;KEYSYM&#34;</code>: keyboard <em>keysym</em>.</li>
<li><code>&#34;POST_KEYSYM&#34;</code>: called after keyboard <em>keysym</em> interpretation.</li>
</ul>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>notifier.netdevice(callback)</code></h4><a id="user-content-notifiernetdevicecallback" aria-label="Permalink: notifier.netdevice(callback)" href="#notifiernetdevicecallback"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>notifier.netdevice()</em> returns a new netdevice <code>notifier</code> object and installs it in the system.
The <code>callback</code> function is called whenever a console netdevice event happens
(e.g., a network interface has been connected or disconnected).
This <code>callback</code> receives the following arguments:</p>
<ul dir="auto">
<li><code>event</code>: the available <em>events</em> are defined by the
<a href="https://github.com/luainkernel/lunatik#notifiernetdev">notifier.netdev</a> table.</li>
<li><code>name</code>: the device name.</li>
</ul>
<p dir="auto">The <code>callback</code> function might return the values defined by the
<a href="https://github.com/luainkernel/lunatik#notifiernotify">notifier.notify</a> table.</p>

<p dir="auto"><em>notifier.netdev</em> is a table that exports
<a href="https://elixir.bootlin.com/linux/v6.3/source/include/linux/netdevice.h#L2812" rel="nofollow">NETDEV</a>
flags to Lua.</p>

<p dir="auto"><em>notifier.notify</em> is a table that exports
<a href="https://elixir.bootlin.com/linux/latest/source/include/linux/notifier.h#L183" rel="nofollow">NOTIFY</a>
flags to Lua.</p>
<ul dir="auto">
<li><code>&#34;DONE&#34;</code>: don&#39;t care.</li>
<li><code>&#34;OK&#34;</code>: suits me.</li>
<li><code>&#34;BAD&#34;</code>: bad/veto action.</li>
<li><code>&#34;STOP&#34;</code>: clean way to return from the notifier and stop further calls.</li>
</ul>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>notifier.delete(notfr)</code>, <code>notfr:delete()</code></h4><a id="user-content-notifierdeletenotfr-notfrdelete" aria-label="Permalink: notifier.delete(notfr), notfr:delete()" href="#notifierdeletenotfr-notfrdelete"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>notifier.delete()</em> removes a <code>notifier</code> specified by the <code>notfr</code> object from the system.</p>

<p dir="auto">The <code>socket</code> library provides support for the kernel
<a href="https://elixir.bootlin.com/linux/latest/source/include/linux/net.h" rel="nofollow">networking handling</a>.
This library was inspired by
<a href="https://github.com/tcz717">Chengzhi Tan</a>&#39;s
<a href="https://summerofcode.withgoogle.com/archive/2018/projects/5993341447569408" rel="nofollow">GSoC project</a>.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>socket.new(family, type, protocol)</code></h4><a id="user-content-socketnewfamily-type-protocol" aria-label="Permalink: socket.new(family, type, protocol)" href="#socketnewfamily-type-protocol"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>socket.new()</em> creates a new <code>socket</code> object.
This function receives the following arguments:</p>
<ul dir="auto">
<li><code>family</code>: the available <em>address families</em> are defined by the
<a href="https://github.com/luainkernel/lunatik#socketaf">socket.af</a> table.</li>
<li><code>sock</code>: the available <em>types</em> are present on the
<a href="https://github.com/luainkernel/lunatik#socketsock">socket.sock</a> table.</li>
<li><code>protocol</code>: the available <em>protocols</em> are defined by the
<a href="https://github.com/luainkernel/lunatik#socketipproto">socket.ipproto</a> table.</li>
</ul>

<p dir="auto"><em>socket.af</em> is a table that exports
<a href="https://elixir.bootlin.com/linux/latest/source/include/linux/socket.h#L187" rel="nofollow">address families (AF)</a>
to Lua.</p>
<ul dir="auto">
<li><code>&#34;UNSPEC&#34;</code>: Unspecified.</li>
<li><code>&#34;UNIX&#34;</code>: Unix domain sockets.</li>
<li><code>&#34;LOCAL&#34;</code>: POSIX name for AF_UNIX.</li>
<li><code>&#34;INET&#34;</code>: Internet IP Protocol.</li>
<li><code>&#34;AX25&#34;</code>: Amateur Radio AX.25.</li>
<li><code>&#34;IPX&#34;</code>: Novell IPX.</li>
<li><code>&#34;APPLETALK&#34;</code>: AppleTalk DDP.</li>
<li><code>&#34;NETROM&#34;</code>: Amateur Radio NET/ROM.</li>
<li><code>&#34;BRIDGE&#34;</code>: Multiprotocol bridge.</li>
<li><code>&#34;ATMPVC&#34;</code>: ATM PVCs.</li>
<li><code>&#34;X25&#34;</code>: Reserved for X.25 project.</li>
<li><code>&#34;INET6&#34;</code>: IP version 6.</li>
<li><code>&#34;ROSE&#34;</code>: Amateur Radio X.25 PLP.</li>
<li><code>&#34;DEC&#34;</code>: Reserved for DECnet project.</li>
<li><code>&#34;NETBEUI&#34;</code>: Reserved for 802.2LLC project.</li>
<li><code>&#34;SECURITY&#34;</code>: Security callback pseudo AF.</li>
<li><code>&#34;KEY&#34;</code>: PF_KEY key management API.</li>
<li><code>&#34;NETLINK&#34;</code>: Netlink.</li>
<li><code>&#34;ROUTE&#34;</code>: Alias to emulate 4.4BSD.</li>
<li><code>&#34;PACKET&#34;</code>: Packet family.</li>
<li><code>&#34;ASH&#34;</code>: Ash.</li>
<li><code>&#34;ECONET&#34;</code>: Acorn Econet.</li>
<li><code>&#34;ATMSVC&#34;</code>: ATM SVCs.</li>
<li><code>&#34;RDS&#34;</code>: RDS sockets.</li>
<li><code>&#34;SNA&#34;</code>: Linux SNA Project (nutters!).</li>
<li><code>&#34;IRDA&#34;</code>: IRDA sockets.</li>
<li><code>&#34;PPPOX&#34;</code>: PPPoX sockets.</li>
<li><code>&#34;WANPIPE&#34;</code>: Wanpipe API Sockets.</li>
<li><code>&#34;LLC&#34;</code>: Linux LLC.</li>
<li><code>&#34;IB&#34;</code>: Native InfiniBand address.</li>
<li><code>&#34;MPLS&#34;</code>: MPLS.</li>
<li><code>&#34;CAN&#34;</code>: Controller Area Network.</li>
<li><code>&#34;TIPC&#34;</code>: TIPC sockets.</li>
<li><code>&#34;BLUETOOTH&#34;</code>: Bluetooth sockets.</li>
<li><code>&#34;IUCV&#34;</code>: IUCV sockets.</li>
<li><code>&#34;RXRPC&#34;</code>: RxRPC sockets.</li>
<li><code>&#34;ISDN&#34;</code>: mISDN sockets.</li>
<li><code>&#34;PHONET&#34;</code>: Phonet sockets.</li>
<li><code>&#34;IEEE802154&#34;</code>: IEEE802154 sockets.</li>
<li><code>&#34;CAIF&#34;</code>: CAIF sockets.</li>
<li><code>&#34;ALG&#34;</code>: Algorithm sockets.</li>
<li><code>&#34;NFC&#34;</code>: NFC sockets.</li>
<li><code>&#34;VSOCK&#34;</code>: vSockets.</li>
<li><code>&#34;KCM&#34;</code>: Kernel Connection Multiplexor.</li>
<li><code>&#34;QIPCRTR&#34;</code>: Qualcomm IPC Router.</li>
<li><code>&#34;SMC&#34;</code>: reserve number for PF_SMC protocol family that reuses AF_INET address family.</li>
<li><code>&#34;XDP&#34;</code>: XDP sockets.</li>
<li><code>&#34;MCTP&#34;</code>: Management component transport protocol.</li>
<li><code>&#34;MAX&#34;</code>: Maximum.</li>
</ul>

<p dir="auto"><em>socket.sock</em> is a table that exports socket
<a href="https://elixir.bootlin.com/linux/latest/source/include/linux/net.h#L49" rel="nofollow">types (SOCK)</a>:</p>
<ul dir="auto">
<li><code>&#34;STREAM&#34;</code>: stream (connection) socket.</li>
<li><code>&#34;DGRAM&#34;</code>: datagram (conn.less) socket.</li>
<li><code>&#34;RAW&#34;</code>: raw socket.</li>
<li><code>&#34;RDM&#34;</code>: reliably-delivered message.</li>
<li><code>&#34;SEQPACKET&#34;</code>: sequential packet socket.</li>
<li><code>&#34;DCCP&#34;</code>: Datagram Congestion Control Protocol socket.</li>
<li><code>&#34;PACKET&#34;</code>: linux specific way of getting packets at the dev level.</li>
</ul>
<p dir="auto">and <a href="https://elixir.bootlin.com/linux/latest/source/include/linux/net.h#L78" rel="nofollow">flags (SOCK)</a>:</p>
<ul dir="auto">
<li><code>&#34;CLOEXEC&#34;</code>: n/a.</li>
<li><code>&#34;NONBLOCK&#34;</code>: n/a.</li>
</ul>

<p dir="auto"><em>socket.ipproto</em> is a table that exports
<a href="https://elixir.bootlin.com/linux/latest/source/include/uapi/linux/in.h#L27" rel="nofollow">IP protocols (IPPROTO)</a>
to Lua.</p>
<ul dir="auto">
<li><code>&#34;IP&#34;</code>: Dummy protocol for TCP.</li>
<li><code>&#34;ICMP&#34;</code>: Internet Control Message Protocol.</li>
<li><code>&#34;IGMP&#34;</code>: Internet Group Management Protocol.</li>
<li><code>&#34;IPIP&#34;</code>: IPIP tunnels (older KA9Q tunnels use 94).</li>
<li><code>&#34;TCP&#34;</code>: Transmission Control Protocol.</li>
<li><code>&#34;EGP&#34;</code>: Exterior Gateway Protocol.</li>
<li><code>&#34;PUP&#34;</code>: PUP protocol.</li>
<li><code>&#34;UDP&#34;</code>: User Datagram Protocol.</li>
<li><code>&#34;IDP&#34;</code>: XNS IDP protocol.</li>
<li><code>&#34;TP&#34;</code>: SO Transport Protocol Class 4.</li>
<li><code>&#34;DCCP&#34;</code>: Datagram Congestion Control Protocol.</li>
<li><code>&#34;IPV6&#34;</code>: IPv6-in-IPv4 tunnelling.</li>
<li><code>&#34;RSVP&#34;</code>: RSVP Protocol.</li>
<li><code>&#34;GRE&#34;</code>: Cisco GRE tunnels (rfc 1701,1702).</li>
<li><code>&#34;ESP&#34;</code>: Encapsulation Security Payload protocol.</li>
<li><code>&#34;AH&#34;</code>: Authentication Header protocol.</li>
<li><code>&#34;MTP&#34;</code>: Multicast Transport Protocol.</li>
<li><code>&#34;BEETPH&#34;</code>: IP option pseudo header for BEET.</li>
<li><code>&#34;ENCAP&#34;</code>: Encapsulation Header.</li>
<li><code>&#34;PIM&#34;</code>: Protocol Independent Multicast.</li>
<li><code>&#34;COMP&#34;</code>: Compression Header Protocol.</li>
<li><code>&#34;SCTP&#34;</code>: Stream Control Transport Protocol.</li>
<li><code>&#34;UDPLITE&#34;</code>: UDP-Lite (RFC 3828).</li>
<li><code>&#34;MPLS&#34;</code>: MPLS in IP (RFC 4023).</li>
<li><code>&#34;ETHERNET&#34;</code>: Ethernet-within-IPv6 Encapsulation.</li>
<li><code>&#34;RAW&#34;</code>: Raw IP packets.</li>
<li><code>&#34;MPTCP&#34;</code>: Multipath TCP connection.</li>
</ul>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>socket:close(sock)</code>, <code>sock:close()</code></h4><a id="user-content-socketclosesock-sockclose" aria-label="Permalink: socket:close(sock), sock:close()" href="#socketclosesock-sockclose"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>socket.close()</em> removes <code>sock</code> object from the system.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>socket.send(sock, message, [addr [, port]])</code>, <code>sock:send(message, [addr [, port]])</code></h4><a id="user-content-socketsendsock-message-addr--port-socksendmessage-addr--port" aria-label="Permalink: socket.send(sock, message, [addr [, port]]), sock:send(message, [addr [, port]])" href="#socketsendsock-message-addr--port-socksendmessage-addr--port"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>socket.send()</em> sends a string <code>message</code> through the socket <code>sock</code>.
If the <code>sock</code> address family is <code>af.INET</code>, then it expects the following arguments:</p>
<ul dir="auto">
<li><code>addr</code>: <code>integer</code> describing the destination IPv4 address.</li>
<li><code>port</code>: <code>integer</code> describing the destination IPv4 port.</li>
</ul>
<p dir="auto">Otherwise:</p>
<ul dir="auto">
<li><code>addr</code>: <a href="https://www.lua.org/manual/5.4/manual.html#6.4.2" rel="nofollow">packed string</a> describing the destination address.</li>
</ul>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>socket.receive(sock, length, [flags [, from]])</code>, <code>sock:receive(length, [flags [, from]])</code></h4><a id="user-content-socketreceivesock-length-flags--from-sockreceivelength-flags--from" aria-label="Permalink: socket.receive(sock, length, [flags [, from]]), sock:receive(length, [flags [, from]])" href="#socketreceivesock-length-flags--from-sockreceivelength-flags--from"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>socket.receive()</em> receives a string with up to <code>length</code> bytes through the socket <code>sock</code>.
The available <em>message flags</em> are defined by the
<a href="https://github.com/luainkernel/lunatik#socketmsg">socket.msg</a> table.
If <code>from</code> is <code>true</code>, it returns the received message followed by the peer&#39;s address.
Otherwise, it returns only the received message.</p>

<p dir="auto"><em>socket.msg</em> is a table that exports
<a href="https://elixir.bootlin.com/linux/latest/source/include/linux/socket.h#L298" rel="nofollow">message flags</a>
to Lua.</p>
<ul dir="auto">
<li><code>&#34;OOB&#34;</code>: n/a.</li>
<li><code>&#34;PEEK&#34;</code>: n/a.</li>
<li><code>&#34;DONTROUTE&#34;</code>: n/a.</li>
<li><code>&#34;TRYHARD&#34;</code>: Synonym for <code>&#34;DONTROUTE&#34;</code> for DECnet.</li>
<li><code>&#34;CTRUNC&#34;</code>: n/a.</li>
<li><code>&#34;PROBE&#34;</code>: Do not send. Only probe path f.e. for MTU.</li>
<li><code>&#34;TRUNC&#34;</code>: n/a.</li>
<li><code>&#34;DONTWAIT&#34;</code>: Nonblocking io.</li>
<li><code>&#34;EOR&#34;</code>: End of record.</li>
<li><code>&#34;WAITALL&#34;</code>: Wait for a full request.</li>
<li><code>&#34;FIN&#34;</code>: n/a.</li>
<li><code>&#34;SYN&#34;</code>: n/a.</li>
<li><code>&#34;CONFIRM&#34;</code>: Confirm path validity.</li>
<li><code>&#34;RST&#34;</code>: n/a.</li>
<li><code>&#34;ERRQUEUE&#34;</code>: Fetch message from error queue.</li>
<li><code>&#34;NOSIGNAL&#34;</code>: Do not generate SIGPIPE.</li>
<li><code>&#34;MORE&#34;</code>: Sender will send more.</li>
<li><code>&#34;WAITFORONE&#34;</code>: recvmmsg(): block until 1+ packets avail.</li>
<li><code>&#34;SENDPAGE_NOPOLICY&#34;</code>: sendpage() internal: do no apply policy.</li>
<li><code>&#34;SENDPAGE_NOTLAST&#34;</code>: sendpage() internal: not the last page.</li>
<li><code>&#34;BATCH&#34;</code>: sendmmsg(): more messages coming.</li>
<li><code>&#34;EOF&#34;</code>: n/a.</li>
<li><code>&#34;NO_SHARED_FRAGS&#34;</code>: sendpage() internal: page frags are not shared.</li>
<li><code>&#34;SENDPAGE_DECRYPTED&#34;</code>: sendpage() internal: page may carry plain text and require encryption.</li>
<li><code>&#34;ZEROCOPY&#34;</code>: Use user data in kernel path.</li>
<li><code>&#34;FASTOPEN&#34;</code>: Send data in TCP SYN.</li>
<li><code>&#34;CMSG_CLOEXEC&#34;</code>: Set close_on_exec for file descriptor received through SCM_RIGHTS.</li>
</ul>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>socket.bind(sock, addr [, port])</code>, <code>sock:bind(addr [, port])</code></h4><a id="user-content-socketbindsock-addr--port-sockbindaddr--port" aria-label="Permalink: socket.bind(sock, addr [, port]), sock:bind(addr [, port])" href="#socketbindsock-addr--port-sockbindaddr--port"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>socket.bind()</em> binds the socket <code>sock</code> to a given address.
If the <code>sock</code> address family is <code>af.INET</code>, then it expects the following arguments:</p>
<ul dir="auto">
<li><code>addr</code>: <code>integer</code> describing host IPv4 address.</li>
<li><code>port</code>: <code>integer</code> describing host IPv4 port.</li>
</ul>
<p dir="auto">Otherwise:</p>
<ul dir="auto">
<li><code>addr</code>: <a href="https://www.lua.org/manual/5.4/manual.html#6.4.2" rel="nofollow">packed string</a> describing host address.</li>
</ul>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>socket.listen(sock [, backlog])</code>, <code>sock:listen([backlog])</code></h4><a id="user-content-socketlistensock--backlog-socklistenbacklog" aria-label="Permalink: socket.listen(sock [, backlog]), sock:listen([backlog])" href="#socketlistensock--backlog-socklistenbacklog"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>socket.listen()</em> moves the socket <code>sock</code> to listening state.</p>
<ul dir="auto">
<li><code>backlog</code>: pending connections queue size.
If omitted, it uses
<a href="https://elixir.bootlin.com/linux/latest/source/include/linux/socket.h#L296" rel="nofollow">SOMAXCONN</a>
as default.</li>
</ul>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>socket.accept(sock [, flags])</code>, <code>sock:accept([flags])</code></h4><a id="user-content-socketacceptsock--flags-sockacceptflags" aria-label="Permalink: socket.accept(sock [, flags]), sock:accept([flags])" href="#socketacceptsock--flags-sockacceptflags"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>socket.accept()</em> accepts a connection on socket <code>sock</code>.
It returns a new <code>socket</code> object.
The available <em>flags</em> are present on the
<a href="https://github.com/luainkernel/lunatik#socketsock">socket.sock</a> table.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>socket.connect(sock, addr [, port] [, flags])</code>, <code>sock:connect(addr [, port] [, flags])</code></h4><a id="user-content-socketconnectsock-addr--port--flags-sockconnectaddr--port--flags" aria-label="Permalink: socket.connect(sock, addr [, port] [, flags]), sock:connect(addr [, port] [, flags])" href="#socketconnectsock-addr--port--flags-sockconnectaddr--port--flags"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>socket.connect()</em> connects the socket <code>sock</code> to the address <code>addr</code>.
If the <code>sock</code> address family is <code>af.INET</code>, then it expects the following arguments:</p>
<ul dir="auto">
<li><code>addr</code>: <code>integer</code> describing the destination IPv4 address.</li>
<li><code>port</code>: <code>integer</code> describing the destination IPv4 port.</li>
</ul>
<p dir="auto">Otherwise:</p>
<ul dir="auto">
<li><code>addr</code>: <a href="https://www.lua.org/manual/5.4/manual.html#6.4.2" rel="nofollow">packed string</a> describing the destination address.</li>
</ul>
<p dir="auto">The available <em>flags</em> are present on the
<a href="https://github.com/luainkernel/lunatik#socketsock">socket.sock</a> table.</p>
<p dir="auto">For datagram sockets, <code>addr</code> is the address to which datagrams are sent
by default, and the only address from which datagrams are received.
For stream sockets, attempts to connect to <code>addr</code>.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>socket.getsockname(sock)</code>, <code>sock:getsockname()</code></h4><a id="user-content-socketgetsocknamesock-sockgetsockname" aria-label="Permalink: socket.getsockname(sock), sock:getsockname()" href="#socketgetsocknamesock-sockgetsockname"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>socket.getsockname()</em> get the address which the socket <code>sock</code> is bound.
If the <code>sock</code> address family is <code>af.INET</code>, then it returns the following:</p>
<ul dir="auto">
<li><code>addr</code>: <code>integer</code> describing the bounded IPv4 address.</li>
<li><code>port</code>: <code>integer</code> describing the bounded IPv4 port.</li>
</ul>
<p dir="auto">Otherwise:</p>
<ul dir="auto">
<li><code>addr</code>: <a href="https://www.lua.org/manual/5.4/manual.html#6.4.2" rel="nofollow">packed string</a> describing the bounded address.</li>
</ul>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>socket.getpeername(sock)</code>, <code>sock:getpeername()</code></h4><a id="user-content-socketgetpeernamesock-sockgetpeername" aria-label="Permalink: socket.getpeername(sock), sock:getpeername()" href="#socketgetpeernamesock-sockgetpeername"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>socket.getpeername()</em> get the address which the socket <code>sock</code> is connected.
If the <code>sock</code> address family is <code>af.INET</code>, then it returns the following:</p>
<ul dir="auto">
<li><code>addr</code>: <code>integer</code> describing the peer&#39;s IPv4 address.</li>
<li><code>port</code>: <code>integer</code> describing the peer&#39;s IPv4 port.</li>
</ul>
<p dir="auto">Otherwise:</p>
<ul dir="auto">
<li><code>addr</code>: <a href="https://www.lua.org/manual/5.4/manual.html#6.4.2" rel="nofollow">packed string</a> describing the peer&#39;s address.</li>
</ul>

<p dir="auto">The <code>socket.inet</code> library provides support for high-level IPv4 sockets.</p>

<p dir="auto"><em>inet.tcp()</em> creates a new <code>socket</code> using
<a href="https://github.com/luainkernel/lunatik#socketaf">af.INET</a> address family,
<a href="https://github.com/luainkernel/lunatik#socketsock">sock.STREAM</a> type
and
<a href="https://github.com/luainkernel/lunatik#socketipproto">ipproto.TCP</a> protocol.
It overrides <code>socket</code> methods to use addresses as <em>numbers-and-dots notation</em>
(e.g., <code>&#34;127.0.0.1&#34;</code>), instead of integers.</p>

<p dir="auto"><em>inet.udp()</em> creates a new <code>socket</code> using
<a href="https://github.com/luainkernel/lunatik#socketaf">af.INET</a> address family,
<a href="https://github.com/luainkernel/lunatik#socketsock">sock.DGRAM</a> type
and
<a href="https://github.com/luainkernel/lunatik#socketipproto">ipproto.UDP</a> protocol.
It overrides <code>socket</code> methods to use addresses as <em>numbers-and-dots notation</em>
(e.g., <code>&#34;127.0.0.1&#34;</code>), instead of integers.</p>
<div dir="auto"><h5 tabindex="-1" dir="auto"><code>udp:receivefrom(length [, flags])</code></h5><a id="user-content-udpreceivefromlength--flags" aria-label="Permalink: udp:receivefrom(length [, flags])" href="#udpreceivefromlength--flags"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>udp:receivefrom()</em> is just an alias to <code>sock:receive(length, flags, true)</code>.</p>

<p dir="auto">The <code>rcu</code> library provides support for the kernel
<a href="https://lwn.net/Articles/262464/" rel="nofollow">Read-copy update (RCU)</a>
synchronization mechanism.
This library was inspired by
<a href="https://github.com/cmessias">Caio Messias</a>&#39;
<a href="https://summerofcode.withgoogle.com/archive/2018/projects/5736202426646528" rel="nofollow">GSoC project</a>.</p>

<p dir="auto"><em>rcu.table()</em> creates a new <code>rcu.table</code> object
which binds the kernel <a href="https://lwn.net/Articles/510202/" rel="nofollow">generic hash table</a>.
This function receives as argument the number of buckets rounded up to the next power of 2.
The default size is <code>1024</code>.
Key must be a string and value must be a Lunatik object or nil.</p>

<p dir="auto">The <code>thread</code> library provides support for the
<a href="https://lwn.net/Articles/65178/" rel="nofollow">kernel thread primitives</a>.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>thread.run(runtime, name)</code></h4><a id="user-content-threadrunruntime-name" aria-label="Permalink: thread.run(runtime, name)" href="#threadrunruntime-name"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>thread.run()</em> creates a new <code>thread</code> object and wakes it up.
This function receives the following arguments:</p>
<ul dir="auto">
<li><code>runtime</code>: the
<a href="https://github.com/luainkernel/lunatik#lunatikruntimescript--sleep">runtime environment</a>
for running a task in the created kernel thread.
The task must be specified by returning a function on the script loaded
in the <code>runtime</code> environment.</li>
<li><code>name</code>: string representing the name for the thread (e.g., as shown on <code>ps</code>).</li>
</ul>

<p dir="auto"><em>thread.shouldstop()</em> returns <code>true</code> if
<a href="https://github.com/luainkernel/lunatik#threadstopthrd-thrdstop">thread.stop()</a>
was called; otherwise, it returns <code>false</code>.</p>

<p dir="auto"><em>thread.current()</em> returns a <code>thread</code> object representing the current task.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>thread.stop(thrd), thrd:stop()</code></h4><a id="user-content-threadstopthrd-thrdstop" aria-label="Permalink: thread.stop(thrd), thrd:stop()" href="#threadstopthrd-thrdstop"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>thread.stop()</em> sets
<a href="https://github.com/luainkernel/lunatik#threadshouldstop">thread.shouldstop()</a>
on the thread <code>thrd</code> to return true, wakes <code>thrd</code>, and waits for it to exit.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>thread.task(thread), thrd:task()</code></h4><a id="user-content-threadtaskthread-thrdtask" aria-label="Permalink: thread.task(thread), thrd:task()" href="#threadtaskthread-thrdtask"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>thread.task()</em> returns a table containing the task information of this <code>thread</code>
(e.g., &#34;cpu&#34;, &#34;command&#34;, &#34;pid&#34; and &#34;tgid&#34;).</p>

<p dir="auto">The <code>fib</code> library provides support for the
<a href="https://thermalcircle.de/doku.php?id=blog:linux:routing_decisions_in_the_linux_kernel_1_lookup_packet_flow" rel="nofollow">kernel Forwarding Information Base</a>.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>fib.newrule(table, priority)</code></h4><a id="user-content-fibnewruletable-priority" aria-label="Permalink: fib.newrule(table, priority)" href="#fibnewruletable-priority"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>fib.newrule()</em> binds the kernel
<a href="https://elixir.bootlin.com/linux/latest/source/include/net/fib_rules.h#L182" rel="nofollow">fib_nl_newrule</a>
API;
it creates a new FIB rule that matches the specified routing <em>table</em>
with the specified <em>priorioty</em>.
This function is similar to the user-space command
<a href="https://datahacker.blog/industry/technology-menu/networking/iptables/follow-the-ip-rules" rel="nofollow">ip rule add</a>
provided by <a href="https://wiki.linuxfoundation.org/networking/iproute2" rel="nofollow">iproute2</a>.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>fib.delrule(table, priority)</code></h4><a id="user-content-fibdelruletable-priority" aria-label="Permalink: fib.delrule(table, priority)" href="#fibdelruletable-priority"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>fib.delrule()</em> binds the kernel
<a href="https://elixir.bootlin.com/linux/latest/source/include/net/fib_rules.h#L184" rel="nofollow">fib_nl_delrule</a>
API;
it removes a FIB rule that matches the specified routing <em>table</em>
with the specified <em>priorioty</em>.
This function is similar to the user-space command
<a href="https://datahacker.blog/industry/technology-menu/networking/iptables/follow-the-ip-rules" rel="nofollow">ip rule del</a>
provided by <a href="https://wiki.linuxfoundation.org/networking/iproute2" rel="nofollow">iproute2</a>.</p>

<p dir="auto">The <code>data</code> library provides support for binding the system memory to Lua.</p>

<p dir="auto"><em>data.new()</em> creates a new <code>data</code> object which allocates <code>size</code> bytes.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>data.getnumber(d, offset), d:getnumber(offset)</code></h4><a id="user-content-datagetnumberd-offset-dgetnumberoffset" aria-label="Permalink: data.getnumber(d, offset), d:getnumber(offset)" href="#datagetnumberd-offset-dgetnumberoffset"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>data.getnumber()</em> extracts a <a href="https://www.lua.org/manual/5.4/manual.html#lua_Integer" rel="nofollow">lua_Integer</a>
from the memory referenced by a <code>data</code> object and a byte <code>offset</code>,
starting from zero.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>data.setnumber(d, offset, number), d:setnumber(offset, number)</code></h4><a id="user-content-datasetnumberd-offset-number-dsetnumberoffset-number" aria-label="Permalink: data.setnumber(d, offset, number), d:setnumber(offset, number)" href="#datasetnumberd-offset-number-dsetnumberoffset-number"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>data.setnumber()</em> insert a <a href="https://www.lua.org/manual/5.4/manual.html#lua_Integer" rel="nofollow">lua_Integer</a>
<code>number</code> into the memory referenced by a <code>data</code> object and a byte <code>offset</code>,
starting from zero.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>data.getbyte(d, offset), d:getbyte(offset)</code></h4><a id="user-content-datagetbyted-offset-dgetbyteoffset" aria-label="Permalink: data.getbyte(d, offset), d:getbyte(offset)" href="#datagetbyted-offset-dgetbyteoffset"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>data.getbyte()</em> extracts a byte
from the memory referenced by a <code>data</code> object and a byte <code>offset</code>,
starting from zero.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>data.setbyte(d, offset, byte), d:setbyte(offset, byte)</code></h4><a id="user-content-datasetbyted-offset-byte-dsetbyteoffset-byte" aria-label="Permalink: data.setbyte(d, offset, byte), d:setbyte(offset, byte)" href="#datasetbyted-offset-byte-dsetbyteoffset-byte"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>data.setbyte()</em> insert a byte
into the memory referenced by a <code>data</code> object and a byte <code>offset</code>,
starting from zero.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>data.getstring(d, offset, length), d:getstring(offset, length)</code></h4><a id="user-content-datagetstringd-offset-length-dgetstringoffset-length" aria-label="Permalink: data.getstring(d, offset, length), d:getstring(offset, length)" href="#datagetstringd-offset-length-dgetstringoffset-length"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>data.getstring()</em> extracts a string with <code>length</code> bytes
from the memory referenced by a <code>data</code> object and a byte <code>offset</code>,
starting from zero.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>data.setstring(d, offset, s), d:setstring(offset, s)</code></h4><a id="user-content-datasetstringd-offset-s-dsetstringoffset-s" aria-label="Permalink: data.setstring(d, offset, s), d:setstring(offset, s)" href="#datasetstringd-offset-s-dsetstringoffset-s"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>data.setstring()</em> insert the string <code>s</code>
into the memory referenced by a <code>data</code> object and a byte <code>offset</code>,
starting from zero.</p>

<p dir="auto">The <code>probe</code> library provides support for
<a href="https://docs.kernel.org/trace/kprobes.html" rel="nofollow">kernel probes</a>.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>probe.new(symbol|address, handlers)</code></h4><a id="user-content-probenewsymboladdress-handlers" aria-label="Permalink: probe.new(symbol|address, handlers)" href="#probenewsymboladdress-handlers"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>probe.new()</em> returns a new <code>probe</code> object for monitoring a kernel <code>symbol</code> (string) or <code>address</code> (light userdata)
and installs its <code>handlers</code> in the system.
The <code>handler</code> <strong>must</strong> be defined as a table containing the following field:</p>
<ul dir="auto">
<li><code>pre</code>: function to be called before the probed instruction.
It receives the <code>symbol</code> or <code>address</code>,
followed by a closure that may be called to
<a href="https://elixir.bootlin.com/linux/v5.6.19/source/include/linux/sched/debug.h#L26" rel="nofollow">show the CPU registers and stack</a>
in the system log.</li>
<li><code>post</code>: function to be called after the probed instruction.
It receives the <code>symbol</code> or <code>address</code>,
followed by a closure that may be called to
<a href="https://elixir.bootlin.com/linux/v5.6.19/source/include/linux/sched/debug.h#L26" rel="nofollow">show the CPU registers and stack</a>
in the system log.</li>
</ul>

<p dir="auto"><em>probe.stop()</em> removes the <code>probe</code> handlers from the system.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>probe.enable(p, bool), p:enable(bool)</code></h4><a id="user-content-probeenablep-bool-penablebool" aria-label="Permalink: probe.enable(p, bool), p:enable(bool)" href="#probeenablep-bool-penablebool"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>probe.enable()</em> enables or disables the <code>probe</code> handlers, accordingly to <code>bool</code>.</p>

<p dir="auto">The <code>syscall</code> library provides support for system call addresses and numbers.</p>

<p dir="auto"><em>syscall.address()</em> returns the system call address (light userdata) referenced by the given <code>number</code>.</p>

<p dir="auto"><em>syscall.number()</em> returns the system call number referenced by the given <code>name</code>.</p>

<p dir="auto">The <code>syscall.table</code> library provides support for translating system call names to addresses (light userdata).</p>


<p dir="auto"><a href="https://github.com/luainkernel/lunatik/blob/master/examples/spyglass.lua">spyglass</a>
is a kernel script that implements a <em>keylogger</em> inspired by the
<a href="https://github.com/jarun/spy">spy</a> kernel module.
This kernel script logs the <em>keysym</em> of the pressed keys in a device (<code>/dev/spyglass</code>).
If the <em>keysym</em> is a printable character, <code>spyglass</code> logs the <em>keysym</em> itself;
otherwise, it logs a mnemonic of the ASCII code, (e.g., <code>&lt;del&gt;</code> stands for <code>127</code>).</p>

<div data-snippet-clipboard-copy-content="sudo make examples_install          # installs examples
sudo lunatik run examples/spyglass  # runs spyglass
sudo tail -f /dev/spyglass          # prints the key log
sudo sh -c &#34;echo &#39;enable=false&#39; &gt; /dev/spyglass&#34;       # disable the key logging
sudo sh -c &#34;echo &#39;enable=true&#39; &gt; /dev/spyglass&#34;        # enable the key logging
sudo sh -c &#34;echo &#39;net=127.0.0.1:1337&#39; &gt; /dev/spyglass&#34; # enable network support
nc -lu 127.0.0.1 1337 &amp;             # listen to UDP 127.0.0.1:1337
sudo tail -f /dev/spyglass          # sends the key log through the network"><pre><code>sudo make examples_install          # installs examples
sudo lunatik run examples/spyglass  # runs spyglass
sudo tail -f /dev/spyglass          # prints the key log
sudo sh -c &#34;echo &#39;enable=false&#39; &gt; /dev/spyglass&#34;       # disable the key logging
sudo sh -c &#34;echo &#39;enable=true&#39; &gt; /dev/spyglass&#34;        # enable the key logging
sudo sh -c &#34;echo &#39;net=127.0.0.1:1337&#39; &gt; /dev/spyglass&#34; # enable network support
nc -lu 127.0.0.1 1337 &amp;             # listen to UDP 127.0.0.1:1337
sudo tail -f /dev/spyglass          # sends the key log through the network
</code></pre></div>

<p dir="auto"><a href="https://github.com/luainkernel/lunatik/blob/master/examples/keylocker.lua">keylocker</a>
is a kernel script that implements
<a href="https://en.wikipedia.org/wiki/Konami_Code" rel="nofollow">Konami Code</a>
for locking and unlocking the console keyboard.
When the user types <code>↑ ↑ ↓ ↓ ← → ← → LCTRL LALT</code>,
the keyboard will be <em>locked</em>; that is, the system will stop processing any key pressed
until the user types the same key sequence again.</p>

<div data-snippet-clipboard-copy-content="sudo make examples_install                     # installs examples
sudo lunatik run examples/keylocker            # runs keylocker
&lt;↑&gt; &lt;↑&gt; &lt;↓&gt; &lt;↓&gt; &lt;←&gt; &lt;→&gt; &lt;←&gt; &lt;→&gt; &lt;LCTRL&gt; &lt;LALT&gt; # locks keyboard
&lt;↑&gt; &lt;↑&gt; &lt;↓&gt; &lt;↓&gt; &lt;←&gt; &lt;→&gt; &lt;←&gt; &lt;→&gt; &lt;LCTRL&gt; &lt;LALT&gt; # unlocks keyboard"><pre><code>sudo make examples_install                     # installs examples
sudo lunatik run examples/keylocker            # runs keylocker
&lt;↑&gt; &lt;↑&gt; &lt;↓&gt; &lt;↓&gt; &lt;←&gt; &lt;→&gt; &lt;←&gt; &lt;→&gt; &lt;LCTRL&gt; &lt;LALT&gt; # locks keyboard
&lt;↑&gt; &lt;↑&gt; &lt;↓&gt; &lt;↓&gt; &lt;←&gt; &lt;→&gt; &lt;←&gt; &lt;→&gt; &lt;LCTRL&gt; &lt;LALT&gt; # unlocks keyboard
</code></pre></div>

<p dir="auto"><a href="https://github.com/luainkernel/lunatik/blob/master/examples/tap.lua">tap</a>
is a kernel script that implements a <em>sniffer</em> using <code>AF_PACKET</code> socket.
It prints destination and source MAC addresses followed by Ethernet type and the frame size.</p>

<div data-snippet-clipboard-copy-content="sudo make examples_install    # installs examples
sudo lunatik run examples/tap # runs tap
cat /dev/tap"><pre><code>sudo make examples_install    # installs examples
sudo lunatik run examples/tap # runs tap
cat /dev/tap
</code></pre></div>

<p dir="auto"><a href="https://github.com/luainkernel/lunatik/blob/master/examples/shared.lua">shared</a>
is a kernel script that implements an in-memory key-value store using
<a href="https://github.com/luainkernel/lunatik#rcu">rcu</a>,
<a href="https://github.com/luainkernel/lunatik#data">data</a>,
<a href="https://github.com/luainkernel/lunatik#socket">socket</a> and
<a href="https://github.com/luainkernel/lunatik#thread">thread</a>.</p>

<div data-snippet-clipboard-copy-content="sudo make examples_install         # installs examples
sudo lunatik spawn examples/shared # spawns shared
nc 127.0.0.1 90                    # connects to shared
foo=bar                            # assigns &#34;bar&#34; to foo
foo                                # retrieves foo
bar
^C                                 # finishes the connection"><pre><code>sudo make examples_install         # installs examples
sudo lunatik spawn examples/shared # spawns shared
nc 127.0.0.1 90                    # connects to shared
foo=bar                            # assigns &#34;bar&#34; to foo
foo                                # retrieves foo
bar
^C                                 # finishes the connection
</code></pre></div>

<p dir="auto"><a href="https://github.com/luainkernel/lunatik/blob/master/examples/echod">echod</a>
is an echo server implemented as kernel scripts.</p>

<div data-snippet-clipboard-copy-content="sudo make examples_install               # installs examples
sudo lunatik spawn examples/echod/daemon # runs echod
nc 127.0.0.1 1337
hello kernel!
hello kernel!"><pre><code>sudo make examples_install               # installs examples
sudo lunatik spawn examples/echod/daemon # runs echod
nc 127.0.0.1 1337
hello kernel!
hello kernel!
</code></pre></div>

<p dir="auto"><a href="https://github.com/luainkernel/lunatik/blob/master/examples/systrack.lua">systrack</a>
is a kernel script that implements a device driver to monitor system calls.
It prints the amount of times each <a href="https://github.com/luainkernel/lunatik/blob/master/examples/systrack.lua#L29">system call</a>
was called since the driver has been installed.</p>

<div data-snippet-clipboard-copy-content="sudo make examples_install         # installs examples
sudo lunatik run examples/systrack # runs systracker
cat /dev/systrack
writev: 0
close: 1927
write: 1085
openat: 2036
read: 4131
readv: 0"><pre><code>sudo make examples_install         # installs examples
sudo lunatik run examples/systrack # runs systracker
cat /dev/systrack
writev: 0
close: 1927
write: 1085
openat: 2036
read: 4131
readv: 0
</code></pre></div>

<ul dir="auto">
<li><a href="https://netdevconf.info/0x17/sessions/talk/scripting-the-linux-routing-table-with-lua.html" rel="nofollow">Scripting the Linux Routing Table with Lua</a></li>
<li><a href="https://www.youtube.com/watch?v=-ufBgy044HI" rel="nofollow">Lua no Núcleo</a> (Portuguese)</li>
<li><a href="https://legacy.netdevconf.info/0x14/session.html?talk-linux-network-scripting-with-lua" rel="nofollow">Linux Network Scripting with Lua</a></li>
<li><a href="https://www.netbsd.org/~lneto/dls14.pdf" rel="nofollow">Scriptables Operating Systems with Lua</a></li>
</ul>
</article></div></div>
  </body>
</html>
