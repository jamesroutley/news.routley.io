<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kevinmahoney.co.uk/articles/immutable-data/">Original</a>
    <h1>Immutable Data (2015)</h1>
    
    <div id="readability-page-1" class="page"><article itemscope="" itemtype="http://schema.org/BlogPosting" id="database-design-immutable-data">
  <div itemprop="articleBody">
    <p><time itemprop="datePublished">27 June 2015</time></p>

<p>In this article I’ll be talking about the advantages and disadvantages
of immutable data in databases. As a demonstration I’ll walk through a simple blog
application in PostgreSQL. I highly recommend this approach in many
cases, but the standard ‘caveat emptor’ disclaimer applies. Be aware
of the trade-offs you are making.</p>

<ul>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#advantages">Advantages</a></li>
  <li><a href="#drawbacks">Drawbacks</a></li>
  <li><a href="#an-immutable-blog-application-in-postgresql">An Immutable Blog Application in PostgreSQL</a></li>
  <li><a href="#performance-improvements">Performance Improvements</a></li>
</ul>

<h2 id="introduction">Introduction</h2>

<p>In a traditional blog application, a blog post may be defined as
follows:</p>

<figure><pre><code data-lang="sql"><span>CREATE</span> <span>TABLE</span> <span>blog</span><span>.</span><span>article</span> <span>(</span>
       <span>slug</span> <span>TEXT</span> <span>PRIMARY</span> <span>KEY</span><span>,</span>
       <span>title</span> <span>TEXT</span> <span>NOT</span> <span>NULL</span><span>,</span>
       <span>content</span> <span>TEXT</span> <span>NOT</span> <span>NULL</span>
<span>);</span></code></pre></figure>

<p>What happens when the content or title of the post changes? An
<code>UPDATE</code> is performed. This destructively mutates your database,
i.e. information has been lost - it is no longer known what the blog
post contained prior to its edit.</p>

<p>The idea behind the approach detailed here is that the current state
of the blog post is not recorded, instead there is an immutable log of
events for the entire history of the application. The current
application state is a function of these events. No information is
lost.</p>

<p>This approach will only ever <code>INSERT</code> into the database. It will never
<code>UPDATE</code>. The blog post table will now look more like this:</p>

<figure><pre><code data-lang="sql"><span>CREATE</span> <span>SEQUENCE</span> <span>logblog</span><span>.</span><span>revision_id_seq</span><span>;</span>
<span>CREATE</span> <span>TABLE</span> <span>logblog</span><span>.</span><span>article_revision</span> <span>(</span>
       <span>revision_id</span> <span>INTEGER</span> <span>PRIMARY</span> <span>KEY</span> <span>DEFAULT</span> <span>nextval</span><span>(</span><span>&#39;logblog.revision_id_seq&#39;</span><span>),</span>
       <span>timestamp</span> <span>TIMESTAMP</span> <span>NOT</span> <span>NULL</span> <span>DEFAULT</span> <span>now</span><span>(),</span>
       <span>slug</span> <span>TEXT</span> <span>NOT</span> <span>NULL</span><span>,</span>
       <span>title</span> <span>TEXT</span> <span>NOT</span> <span>NULL</span><span>,</span>
       <span>content</span> <span>TEXT</span> <span>NOT</span> <span>NULL</span>
<span>);</span></code></pre></figure>

<p>Note the slug is no longer unique. An article is updated by
inserting a new <code>article_revision</code> with an existing slug.</p>

<p>There are some existing databases based around this concept, including
<a href="http://datomic.com">Datomic</a> and <a href="https://geteventstore.com">EventStore</a>, but in this article I’ll be focusing on how to
do this in PostgreSQL.</p>

<h2 id="advantages">Advantages</h2>

<p>Why would you want to do this?</p>

<p>Immutable data in databases has all the same advantages as
immutable data in general purpose languages. It is usually much
easier to reason about than mutable state. See:
<a href="https://en.wikipedia.org/wiki/Referential_transparency_(computer_science)">Referential Transparency</a>.</p>

<p>This paragraph from the Datomic website explains other advantages of this
approach quite well:</p>

<blockquote>
  <p>How can data be immutable? Don’t facts change? They don’t, in fact,
when you incorporate time in the data. For instance, when Obama became
president, it didn’t mean that Bush was never president. As long as
who is president isn’t stored in a single (logical) place, there’s no
reason a database system couldn’t retain both facts
simultaneously. While many queries might be interested in the
‘current’ facts, others might be interested in, e.g. what the product
catalog looked like last month compared to this month. Incorporating
time in data allows the past to be retained (or not), and supports
point-in-time queries. Many real world systems have to retain all
changes, and struggle mightily to efficiently provide the ‘latest’
view in a traditional database. This all happens automatically in
Datomic. Datomic is a database of facts, not places.</p>
</blockquote>

<p>Immutable facts are great for auditing and debugging. It’s
tremendously helpful to be able to see the state of you application at
any point in time, and step through the state changes one by one. It’s
especially invaluable when working with financial data.</p>

<h2 id="drawbacks">Drawbacks</h2>

<p>There are some trade-offs to this approach: space usage, complexity
and performance.</p>

<p>Of course, storing every change to the state instead of mutating data
will require more persistent storage space. If you’re only inserting
data your storage requirements can only ever grow.</p>

<p>In PostgreSQL, naive read queries that reduce events down into the
current application state will often be more complicated and
have worse performance; However, this can compensated for with some
additional effort.
See the <a href="#performance-improvements">Performance Improvements</a>
section for more details.</p>

<h2 id="an-immutable-blog-application-in-postgresql">An Immutable Blog Application in PostgreSQL</h2>

<p>This code is available as a <a href="https://gist.github.com/KMahoney/dcc12d3ff6a49c11cdc9">gist</a>.</p>

<p>This application should be able to:</p>

<ul>
  <li>Privately write and edit blog posts</li>
  <li>Publish revisions of posts for public viewing</li>
  <li>Delete posts</li>
  <li>Add or remove tags to posts</li>
</ul>

<h3 id="schema">Schema</h3>

<figure><pre><code data-lang="sql"><span>CREATE</span> <span>SCHEMA</span> <span>logblog</span><span>;</span></code></pre></figure>

<h3 id="article-table">Article Table</h3>

<p>A table representing the set of article slugs. Foreign keys can
reference this to maintain integrity. PostgreSQL does
not allow referencing the <code>slug</code> field in the <code>article_revision</code> table
as it is not unique in that table.</p>

<figure><pre><code data-lang="sql"><span>CREATE</span> <span>TABLE</span> <span>logblog</span><span>.</span><span>article</span> <span>(</span>
       <span>slug</span> <span>TEXT</span> <span>NOT</span> <span>NULL</span> <span>PRIMARY</span> <span>KEY</span> <span>CHECK</span><span>(</span><span>slug</span> <span>SIMILAR</span> <span>TO</span> <span>&#39;[-a-z]+&#39;</span><span>)</span>
<span>);</span></code></pre></figure>

<h3 id="revision-table">Revision Table</h3>

<p>Next is an immutable log of article revisions. New articles can be
created by atomically inserting the slug into <code>article</code> and the
revision into <code>article_revision</code>. Articles can be updated by simply
inserting a new revision with an existing <code>article</code> slug.</p>

<figure><pre><code data-lang="sql"><span>CREATE</span> <span>SEQUENCE</span> <span>logblog</span><span>.</span><span>revision_id_seq</span><span>;</span>
<span>CREATE</span> <span>TABLE</span> <span>logblog</span><span>.</span><span>article_revision</span> <span>(</span>
       <span>revision_id</span> <span>INTEGER</span> <span>PRIMARY</span> <span>KEY</span> <span>DEFAULT</span> <span>nextval</span><span>(</span><span>&#39;logblog.revision_id_seq&#39;</span><span>),</span>
       <span>timestamp</span> <span>TIMESTAMP</span> <span>NOT</span> <span>NULL</span> <span>DEFAULT</span> <span>now</span><span>(),</span>
       <span>slug</span> <span>TEXT</span> <span>NOT</span> <span>NULL</span> <span>REFERENCES</span> <span>logblog</span><span>.</span><span>article</span><span>,</span>
       <span>title</span> <span>TEXT</span> <span>NOT</span> <span>NULL</span><span>,</span>
       <span>content</span> <span>TEXT</span> <span>NOT</span> <span>NULL</span>
<span>);</span></code></pre></figure>

<h3 id="publishing">Publishing</h3>

<p>Now for an immutable log of article publish events. The public will be
able to see the last published version of an article. This means it is
possible to publish an earlier revision to ‘rollback’ an article.</p>

<p>Note the timestamp when an article was published or deleted is
distinct from when the revision was created. Readers are probably more
interested in when an article was first published than when it was
first drafted.</p>

<figure><pre><code data-lang="sql"><span>CREATE</span> <span>TABLE</span> <span>logblog</span><span>.</span><span>article_publish</span> <span>(</span>
       <span>timestamp</span> <span>TIMESTAMP</span> <span>NOT</span> <span>NULL</span> <span>DEFAULT</span> <span>now</span><span>(),</span>
       <span>revision_id</span> <span>INTEGER</span> <span>REFERENCES</span> <span>logblog</span><span>.</span><span>article_revision</span>
<span>);</span></code></pre></figure>

<h3 id="deleting">Deleting</h3>

<p>An immutable log of article deletion events. Articles are only
considered deleted when the deletion timestamp is later than any
publish actions. This means articles can be ‘undeleted’ by
re-publishing them. No data is ever truly removed.</p>

<figure><pre><code data-lang="sql"><span>CREATE</span> <span>TABLE</span> <span>logblog</span><span>.</span><span>article_deletion</span> <span>(</span>
       <span>timestamp</span> <span>TIMESTAMP</span> <span>NOT</span> <span>NULL</span> <span>DEFAULT</span> <span>now</span><span>(),</span>
       <span>slug</span> <span>TEXT</span> <span>NOT</span> <span>NULL</span> <span>REFERENCES</span> <span>logblog</span><span>.</span><span>article</span>
<span>);</span></code></pre></figure>

<h3 id="tagging">Tagging</h3>

<p>An immutable log of tag events. It’s awkward to create a tag table
with a set of unique tag names like we do with articles, so instead we
just record tag events. This is a bit lazy as it doesn’t enforce
consistency with removed tags (i.e. you can remove a non-existing
tag).</p>

<figure><pre><code data-lang="sql"><span>CREATE</span> <span>TYPE</span> <span>logblog</span><span>.</span><span>tag_event_type</span> <span>AS</span> <span>ENUM</span> <span>(</span><span>&#39;add&#39;</span><span>,</span> <span>&#39;remove&#39;</span><span>);</span>
<span>CREATE</span> <span>TABLE</span> <span>logblog</span><span>.</span><span>tag_event</span> <span>(</span>
       <span>timestamp</span> <span>TIMESTAMP</span> <span>NOT</span> <span>NULL</span> <span>DEFAULT</span> <span>now</span><span>(),</span>
       <span>slug</span> <span>TEXT</span> <span>NOT</span> <span>NULL</span> <span>REFERENCES</span> <span>logblog</span><span>.</span><span>article</span><span>,</span>
       <span>event</span> <span>logblog</span><span>.</span><span>tag_event_type</span> <span>NOT</span> <span>NULL</span><span>,</span>
       <span>tag</span> <span>TEXT</span> <span>NOT</span> <span>NULL</span>
<span>);</span></code></pre></figure>

<h3 id="building-views">Building Views</h3>

<p>Querying this data can get quite complicated, so it is a good idea to
break it down with views that show the current state of the
application. They make heavy use of <code>DISTINCT ON</code> to find the latest
state of each component.</p>

<p>This view is the latest deletion date for an article (if applicable)</p>

<figure><pre><code data-lang="sql"><span>CREATE</span> <span>VIEW</span> <span>logblog</span><span>.</span><span>last_deleted_view</span> <span>AS</span>
     <span>SELECT</span> <span>DISTINCT</span> <span>ON</span> <span>(</span><span>slug</span><span>)</span> <span>timestamp</span> <span>AS</span> <span>deleted_on</span><span>,</span> <span>slug</span>
     <span>FROM</span> <span>logblog</span><span>.</span><span>article_deletion</span>
     <span>ORDER</span> <span>BY</span> <span>slug</span><span>,</span> <span>timestamp</span> <span>DESC</span><span>;</span></code></pre></figure>

<p>We will want to show users the latest published content of an article.</p>

<figure><pre><code data-lang="sql"><span>CREATE</span> <span>VIEW</span> <span>logblog</span><span>.</span><span>last_published_view</span> <span>AS</span>
     <span>SELECT</span> <span>DISTINCT</span> <span>ON</span> <span>(</span><span>rev</span><span>.</span><span>slug</span><span>)</span>
            <span>rev</span><span>.</span><span>revision_id</span><span>,</span>
            <span>pub</span><span>.</span><span>timestamp</span> <span>AS</span> <span>last_updated_on</span><span>,</span>
            <span>rev</span><span>.</span><span>slug</span><span>,</span>
            <span>rev</span><span>.</span><span>title</span><span>,</span>
            <span>rev</span><span>.</span><span>content</span>
     <span>FROM</span> <span>logblog</span><span>.</span><span>article_publish</span> <span>AS</span> <span>pub</span>
     <span>INNER</span> <span>JOIN</span> <span>logblog</span><span>.</span><span>article_revision</span> <span>AS</span> <span>rev</span> <span>ON</span> <span>rev</span><span>.</span><span>revision_id</span> <span>=</span> <span>pub</span><span>.</span><span>revision_id</span>
     <span>ORDER</span> <span>BY</span> <span>rev</span><span>.</span><span>slug</span><span>,</span> <span>timestamp</span> <span>DESC</span><span>;</span></code></pre></figure>

<p>Another piece of useful information is when an article was first
published. This is the date you usually show on an article. The last
published timestamp shows when an article was last updated.</p>

<figure><pre><code data-lang="sql"><span>CREATE</span> <span>VIEW</span> <span>logblog</span><span>.</span><span>first_published_view</span> <span>AS</span>
     <span>SELECT</span> <span>DISTINCT</span> <span>ON</span> <span>(</span><span>rev</span><span>.</span><span>slug</span><span>)</span>
            <span>rev</span><span>.</span><span>revision_id</span><span>,</span>
            <span>pub</span><span>.</span><span>timestamp</span> <span>AS</span> <span>first_published_on</span>
     <span>FROM</span> <span>logblog</span><span>.</span><span>article_publish</span> <span>AS</span> <span>pub</span>
     <span>INNER</span> <span>JOIN</span> <span>logblog</span><span>.</span><span>article_revision</span> <span>AS</span> <span>rev</span> <span>ON</span> <span>rev</span><span>.</span><span>revision_id</span> <span>=</span> <span>pub</span><span>.</span><span>revision_id</span>
     <span>ORDER</span> <span>BY</span> <span>rev</span><span>.</span><span>slug</span><span>,</span> <span>timestamp</span><span>;</span></code></pre></figure>

<p>Aggregate the tags as a PostgreSQL array for convenience.</p>

<figure><pre><code data-lang="sql"><span>CREATE</span> <span>VIEW</span> <span>logblog</span><span>.</span><span>article_tag_view</span> <span>AS</span>
       <span>WITH</span> <span>last_tag_event</span> <span>AS</span>
         <span>(</span><span>SELECT</span> <span>DISTINCT</span> <span>ON</span> <span>(</span><span>slug</span><span>,</span> <span>tag</span><span>)</span> <span>*</span>
          <span>FROM</span> <span>logblog</span><span>.</span><span>tag_event</span>
          <span>ORDER</span> <span>BY</span> <span>slug</span><span>,</span> <span>tag</span><span>,</span> <span>timestamp</span> <span>DESC</span><span>)</span>
       <span>SELECT</span> <span>slug</span><span>,</span> <span>array_agg</span><span>(</span><span>tag</span><span>)</span> <span>AS</span> <span>tags</span>
       <span>FROM</span> <span>last_tag_event</span>
       <span>WHERE</span> <span>event</span> <span>=</span> <span>&#39;add&#39;</span>
       <span>GROUP</span> <span>BY</span> <span>slug</span><span>;</span></code></pre></figure>

<h3 id="the-publics-view">The Public’s View</h3>

<p>Here the previous views are used as building blocks to create a public
article view. Note that articles that have a deletion date later than
the last published date are not shown.</p>

<figure><pre><code data-lang="sql"><span>CREATE</span> <span>VIEW</span> <span>logblog</span><span>.</span><span>public_article_view</span> <span>AS</span>
       <span>SELECT</span> <span>last_pub</span><span>.</span><span>slug</span><span>,</span>
              <span>first_pub</span><span>.</span><span>first_published_on</span><span>,</span>
              <span>last_pub</span><span>.</span><span>last_updated_on</span><span>,</span>
              <span>last_pub</span><span>.</span><span>title</span><span>,</span>
              <span>last_pub</span><span>.</span><span>content</span><span>,</span>
              <span>COALESCE</span><span>(</span><span>tags</span><span>.</span><span>tags</span><span>,</span> <span>&#39;{}&#39;</span><span>::</span><span>TEXT</span><span>[])</span> <span>AS</span> <span>tags</span>
       <span>FROM</span> <span>logblog</span><span>.</span><span>last_published_view</span> <span>AS</span> <span>last_pub</span>
       <span>LEFT</span> <span>JOIN</span> <span>logblog</span><span>.</span><span>last_deleted_view</span> <span>AS</span> <span>del</span>
            <span>ON</span> <span>del</span><span>.</span><span>slug</span> <span>=</span> <span>latest_pub</span><span>.</span><span>slug</span>
       <span>LEFT</span> <span>JOIN</span> <span>logblog</span><span>.</span><span>first_published_view</span> <span>AS</span> <span>first_pub</span>
            <span>ON</span> <span>first_pub</span><span>.</span><span>slug</span> <span>=</span> <span>latest_pub</span><span>.</span><span>slug</span>
       <span>LEFT</span> <span>JOIN</span> <span>logblog</span><span>.</span><span>article_tag_view</span> <span>AS</span> <span>tags</span>
            <span>ON</span> <span>tags</span><span>.</span><span>slug</span> <span>=</span> <span>last_pub</span><span>.</span><span>slug</span>
       <span>WHERE</span> <span>NOT</span> <span>COALESCE</span><span>(</span><span>del</span><span>.</span><span>timestamp</span> <span>&gt;</span> <span>last_pub</span><span>.</span><span>timestamp</span><span>,</span> <span>false</span><span>)</span>
       <span>ORDER</span> <span>BY</span> <span>first_pub</span><span>.</span><span>timestamp</span><span>;</span></code></pre></figure>

<h3 id="the-life-of-a-blog-post">The Life of a Blog Post</h3>

<p>To finish, a fun query to show the entire history of an article.</p>

<figure><pre><code data-lang="sql"><span>CREATE</span> <span>VIEW</span> <span>logblog</span><span>.</span><span>article_history_view</span> <span>AS</span>
       <span>WITH</span>
        <span>revision_events</span> <span>AS</span>
        <span>(</span><span>SELECT</span> <span>timestamp</span><span>,</span>
                <span>slug</span><span>,</span>
                <span>(</span><span>&#39;Created article revision &#39;</span> <span>||</span> <span>revision_id</span><span>)::</span><span>TEXT</span> <span>AS</span> <span>event</span>
         <span>FROM</span> <span>logblog</span><span>.</span><span>article_revision</span><span>),</span>
        <span>publish_events</span> <span>AS</span>
        <span>(</span><span>SELECT</span> <span>pub</span><span>.</span><span>timestamp</span><span>,</span>
                <span>rev</span><span>.</span><span>slug</span><span>,</span>
                <span>(</span><span>&#39;Published revision &#39;</span> <span>||</span> <span>pub</span><span>.</span><span>revision_id</span><span>)::</span><span>TEXT</span> <span>AS</span> <span>event</span>
         <span>FROM</span> <span>logblog</span><span>.</span><span>article_publish</span> <span>AS</span> <span>pub</span>
         <span>INNER</span> <span>JOIN</span> <span>logblog</span><span>.</span><span>article_revision</span> <span>AS</span> <span>rev</span>
               <span>ON</span> <span>rev</span><span>.</span><span>revision_id</span> <span>=</span> <span>pub</span><span>.</span><span>revision_id</span><span>),</span>
        <span>deletion_events</span> <span>AS</span>
        <span>(</span><span>SELECT</span> <span>timestamp</span><span>,</span>
                <span>slug</span><span>,</span>
                <span>&#39;Deleted article&#39;</span><span>::</span><span>TEXT</span> <span>AS</span> <span>event</span>
         <span>FROM</span> <span>logblog</span><span>.</span><span>article_deletion</span><span>),</span>
        <span>tag_events</span> <span>AS</span>
        <span>(</span><span>SELECT</span> <span>timestamp</span><span>,</span>
                <span>slug</span><span>,</span>
                <span>(</span><span>CASE</span> 
                 <span>WHEN</span> <span>event</span> <span>=</span> <span>&#39;add&#39;</span> <span>THEN</span> <span>(</span><span>&#39;Added tag &#39;</span> <span>||</span> <span>tag</span><span>)</span>
                 <span>WHEN</span> <span>event</span> <span>=</span> <span>&#39;remove&#39;</span> <span>THEN</span> <span>(</span><span>&#39;Deleted tag &#39;</span> <span>||</span> <span>tag</span><span>)</span>
                 <span>END</span><span>)::</span><span>TEXT</span> <span>AS</span> <span>event</span>
         <span>FROM</span> <span>logblog</span><span>.</span><span>tag_event</span><span>)</span>
       <span>(</span><span>SELECT</span> <span>*</span> <span>FROM</span> <span>revision_events</span><span>)</span>
       <span>UNION</span> <span>(</span><span>SELECT</span> <span>*</span> <span>FROM</span> <span>publish_events</span><span>)</span>
       <span>UNION</span> <span>(</span><span>SELECT</span> <span>*</span> <span>FROM</span> <span>deletion_events</span><span>)</span>
       <span>UNION</span> <span>(</span><span>SELECT</span> <span>*</span> <span>FROM</span> <span>tag_events</span><span>);</span></code></pre></figure>

<h3 id="testing">Testing</h3>

<p>This is how you create a new article. If the article slug already
exists the transaction will abort.</p>

<figure><pre><code data-lang="sql"><span>BEGIN</span><span>;</span>
        <span>INSERT</span> <span>INTO</span> <span>logblog</span><span>.</span><span>article</span> <span>VALUES</span> <span>(</span><span>&#39;simple&#39;</span><span>);</span>
        <span>INSERT</span> <span>INTO</span> <span>logblog</span><span>.</span><span>article_revision</span> <span>(</span><span>revision_id</span><span>,</span> <span>timestamp</span><span>,</span> <span>slug</span><span>,</span> <span>title</span><span>,</span> <span>content</span><span>)</span> <span>VALUES</span>
          <span>(</span><span>1</span><span>,</span> <span>&#39;2015-01-01 00:00:00&#39;</span><span>,</span> <span>&#39;simple&#39;</span><span>,</span>
          <span>&#39;A Simple Title&#39;</span><span>,</span>
          <span>&#39;This is a simple published article&#39;</span><span>);</span>
<span>COMMIT</span><span>;</span></code></pre></figure>

<p>Publishing and tagging the article:</p>

<figure><pre><code data-lang="sql"><span>INSERT</span> <span>INTO</span> <span>logblog</span><span>.</span><span>article_publish</span> <span>(</span><span>timestamp</span><span>,</span> <span>revision_id</span><span>)</span> <span>VALUES</span>
  <span>(</span><span>&#39;2015-01-01 01:00:00&#39;</span><span>,</span> <span>1</span><span>);</span>
<span>INSERT</span> <span>INTO</span> <span>logblog</span><span>.</span><span>tag_event</span> <span>(</span><span>timestamp</span><span>,</span> <span>slug</span><span>,</span> <span>event</span><span>,</span> <span>tag</span><span>)</span> <span>VALUES</span>
  <span>(</span><span>&#39;2015-01-01 02:00:00&#39;</span><span>,</span> <span>&#39;simple&#39;</span><span>,</span> <span>&#39;add&#39;</span><span>,</span> <span>&#39;simple-tag&#39;</span><span>);</span></code></pre></figure>

<p>Some more articles:</p>

<figure><pre><code data-lang="sql"><span>INSERT</span> <span>INTO</span> <span>logblog</span><span>.</span><span>article</span> <span>VALUES</span>
  <span>(</span><span>&#39;revised&#39;</span><span>),</span> <span>(</span><span>&#39;deleted&#39;</span><span>),</span> <span>(</span><span>&#39;unpublished&#39;</span><span>),</span> <span>(</span><span>&#39;unpublished-revision&#39;</span><span>),</span> <span>(</span><span>&#39;republished&#39;</span><span>);</span>
<span>INSERT</span> <span>INTO</span> <span>logblog</span><span>.</span><span>article_revision</span> <span>(</span><span>revision_id</span><span>,</span> <span>timestamp</span><span>,</span> <span>slug</span><span>,</span> <span>title</span><span>,</span> <span>content</span><span>)</span> <span>VALUES</span>
  <span>(</span><span>2</span><span>,</span> <span>&#39;2015-01-01 00:00:00&#39;</span><span>,</span> <span>&#39;revised&#39;</span><span>,</span>
  <span>&#39;Revised&#39;</span><span>,</span>
  <span>&#39;You will not see this content because it has been revised.&#39;</span><span>),</span>
  <span>(</span><span>3</span><span>,</span> <span>&#39;2015-01-01 02:00:00&#39;</span><span>,</span> <span>&#39;revised&#39;</span><span>,</span>
  <span>&#39;Revised&#39;</span><span>,</span>
  <span>&#39;This is revised and published content.&#39;</span><span>),</span>
  <span>(</span><span>4</span><span>,</span> <span>&#39;2015-01-01 00:00:00&#39;</span><span>,</span> <span>&#39;deleted&#39;</span><span>,</span>
  <span>&#39;Deleted&#39;</span><span>,</span>
  <span>&#39;This is a deleted article. You should not see this.&#39;</span><span>),</span>
  <span>(</span><span>5</span><span>,</span> <span>&#39;2015-01-01 00:00:00&#39;</span><span>,</span> <span>&#39;unpublished&#39;</span><span>,</span>
  <span>&#39;Unpublished&#39;</span><span>,</span>
  <span>&#39;This content was never published :(&#39;</span><span>),</span>
  <span>(</span><span>6</span><span>,</span> <span>&#39;2015-01-01 00:00:00&#39;</span><span>,</span> <span>&#39;unpublished-revision&#39;</span><span>,</span>
  <span>&#39;Unpublished Revision&#39;</span><span>,</span>
  <span>&#39;This article has revised content you can not see yet.&#39;</span><span>),</span>
  <span>(</span><span>7</span><span>,</span> <span>&#39;2015-01-01 02:00:00&#39;</span><span>,</span> <span>&#39;unpublished-revision&#39;</span><span>,</span>
  <span>&#39;Unpublished Revision&#39;</span><span>,</span>
  <span>&#39;This is revised content you can not see.&#39;</span><span>),</span>
  <span>(</span><span>8</span><span>,</span> <span>&#39;2015-01-01 00:00:00&#39;</span><span>,</span> <span>&#39;republished&#39;</span><span>,</span>
  <span>&#39;Republished&#39;</span><span>,</span>
  <span>&#39;This article was deleted then re-published.&#39;</span><span>);</span>
<span>INSERT</span> <span>INTO</span> <span>logblog</span><span>.</span><span>article_publish</span> <span>(</span><span>timestamp</span><span>,</span> <span>revision_id</span><span>)</span> <span>VALUES</span>
  <span>(</span><span>&#39;2015-01-01 01:00:00&#39;</span><span>,</span> <span>2</span><span>),</span>
  <span>(</span><span>&#39;2015-01-01 03:00:00&#39;</span><span>,</span> <span>3</span><span>),</span>
  <span>(</span><span>&#39;2015-01-01 01:00:00&#39;</span><span>,</span> <span>4</span><span>),</span>
  <span>(</span><span>&#39;2015-01-01 01:00:00&#39;</span><span>,</span> <span>6</span><span>),</span>
  <span>(</span><span>&#39;2015-01-01 01:00:00&#39;</span><span>,</span> <span>8</span><span>),</span>
  <span>(</span><span>&#39;2015-01-01 03:00:00&#39;</span><span>,</span> <span>8</span><span>);</span>
<span>INSERT</span> <span>INTO</span> <span>logblog</span><span>.</span><span>article_deletion</span> <span>(</span><span>timestamp</span><span>,</span> <span>slug</span><span>)</span> <span>VALUES</span>
  <span>(</span><span>&#39;2015-01-01 02:00:00&#39;</span><span>,</span> <span>&#39;deleted&#39;</span><span>),</span>
  <span>(</span><span>&#39;2015-01-01 02:00:00&#39;</span><span>,</span> <span>&#39;republished&#39;</span><span>);</span>
<span>INSERT</span> <span>INTO</span> <span>logblog</span><span>.</span><span>tag_event</span> <span>(</span><span>timestamp</span><span>,</span> <span>slug</span><span>,</span> <span>event</span><span>,</span> <span>tag</span><span>)</span> <span>VALUES</span>
  <span>(</span><span>&#39;2015-01-01 01:00:00&#39;</span><span>,</span> <span>&#39;revised&#39;</span><span>,</span> <span>&#39;add&#39;</span><span>,</span> <span>&#39;lots&#39;</span><span>),</span>
  <span>(</span><span>&#39;2015-01-01 02:00:00&#39;</span><span>,</span> <span>&#39;revised&#39;</span><span>,</span> <span>&#39;add&#39;</span><span>,</span> <span>&#39;of&#39;</span><span>),</span>
  <span>(</span><span>&#39;2015-01-01 03:00:00&#39;</span><span>,</span> <span>&#39;revised&#39;</span><span>,</span> <span>&#39;add&#39;</span><span>,</span> <span>&#39;tags&#39;</span><span>),</span>
  <span>(</span><span>&#39;2015-01-01 04:00:00&#39;</span><span>,</span> <span>&#39;revised&#39;</span><span>,</span> <span>&#39;add&#39;</span><span>,</span> <span>&#39;deleted-tag&#39;</span><span>),</span>
  <span>(</span><span>&#39;2015-01-01 05:00:00&#39;</span><span>,</span> <span>&#39;revised&#39;</span><span>,</span> <span>&#39;remove&#39;</span><span>,</span> <span>&#39;deleted-tag&#39;</span><span>);</span></code></pre></figure>

<p>Let’s take a look at the output:</p>

<figure><pre><code data-lang="sql"><span>SELECT</span> <span>slug</span><span>,</span> <span>first_published_on</span><span>,</span> <span>content</span> <span>FROM</span> <span>logblog</span><span>.</span><span>public_article_view</span><span>;</span></code></pre></figure>

<div><div><pre><code>        slug         | first_published_on  |                        content
---------------------+---------------------+-----------------------------------------------------
republished          | 2015-01-01 01:00:00 | This article was deleted then re-published.
revised              | 2015-01-01 01:00:00 | This is revised and published content.
simple               | 2015-01-01 01:00:00 | This is a simple published article
unpublished-revision | 2015-01-01 01:00:00 | This article has revised content you can not see yet.
</code></pre></div></div>

<figure><pre><code data-lang="sql"><span>SELECT</span> <span>*</span> <span>FROM</span> <span>logblog</span><span>.</span><span>article_history_view</span> <span>ORDER</span> <span>BY</span> <span>slug</span><span>,</span> <span>timestamp</span><span>;</span></code></pre></figure>

<div><div><pre><code>     timestamp      |         slug         |           event
--------------------+----------------------+--------------------------
2015-01-01 00:00:00 | deleted              | Created article revision 4
2015-01-01 01:00:00 | deleted              | Published revision 4
2015-01-01 02:00:00 | deleted              | Deleted article
2015-01-01 00:00:00 | republished          | Created article revision 8
2015-01-01 01:00:00 | republished          | Published revision 8
2015-01-01 02:00:00 | republished          | Deleted article
2015-01-01 03:00:00 | republished          | Published revision 8
2015-01-01 00:00:00 | revised              | Created article revision 2
2015-01-01 01:00:00 | revised              | Added tag lots
2015-01-01 01:00:00 | revised              | Published revision 2
2015-01-01 02:00:00 | revised              | Added tag of
2015-01-01 02:00:00 | revised              | Created article revision 3
2015-01-01 03:00:00 | revised              | Added tag tags
2015-01-01 03:00:00 | revised              | Published revision 3
2015-01-01 04:00:00 | revised              | Added tag deleted-tag
2015-01-01 05:00:00 | revised              | Deleted tag deleted-tag
2015-01-01 00:00:00 | simple               | Created article revision 1
2015-01-01 01:00:00 | simple               | Published revision 1
2015-01-01 02:00:00 | simple               | Added tag simple-tag
2015-01-01 00:00:00 | unpublished          | Created article revision 5
2015-01-01 00:00:00 | unpublished-revision | Created article revision 6
2015-01-01 01:00:00 | unpublished-revision | Published revision 6
2015-01-01 02:00:00 | unpublished-revision | Created article revision 7
</code></pre></div></div>

<h2 id="performance-improvements">Performance Improvements</h2>

<p>Here is the query plan for one of our views:</p>

<figure><pre><code data-lang="sql"><span>EXPLAIN</span> <span>SELECT</span> <span>*</span> <span>FROM</span> <span>logblog</span><span>.</span><span>public_article_view</span><span>;</span></code></pre></figure>

<div><div><pre><code>                                                           QUERY PLAN
---------------------------------------------------------------------------------------------------------------------------------
 Sort  (cost=556.95..557.20 rows=100 width=144)
   Sort Key: pub.&#34;timestamp&#34;
   -&gt;  Merge Right Join  (cost=516.16..553.62 rows=100 width=144)
         Merge Cond: (rev.slug = rev_1.slug)
         -&gt;  Unique  (cost=185.29..194.99 rows=200 width=40)
               -&gt;  Sort  (cost=185.29..190.14 rows=1940 width=40)
                     Sort Key: rev.slug, pub.&#34;timestamp&#34;
                     -&gt;  Hash Join  (cost=23.27..79.35 rows=1940 width=40)
                           Hash Cond: (pub.revision_id = rev.revision_id)
                           -&gt;  Seq Scan on article_publish pub  (cost=0.00..29.40 rows=1940 width=12)
                           -&gt;  Hash  (cost=15.90..15.90 rows=590 width=36)
                                 -&gt;  Seq Scan on article_revision rev  (cost=0.00..15.90 rows=590 width=36)
         -&gt;  Materialize  (cost=330.86..354.88 rows=100 width=136)
               -&gt;  Merge Left Join  (cost=330.86..354.63 rows=100 width=136)
                     Merge Cond: (rev_1.slug = tags.slug)
                     -&gt;  Merge Left Join  (cost=265.94..289.44 rows=100 width=104)
                           Merge Cond: (rev_1.slug = article_deletion.slug)
                           Filter: (NOT COALESCE((article_deletion.&#34;timestamp&#34; &gt; pub_1.&#34;timestamp&#34;), false))
                           -&gt;  Unique  (cost=185.29..194.99 rows=200 width=108)
                                 -&gt;  Sort  (cost=185.29..190.14 rows=1940 width=108)
                                       Sort Key: rev_1.slug, pub_1.&#34;timestamp&#34;
                                       -&gt;  Hash Join  (cost=23.27..79.35 rows=1940 width=108)
                                             Hash Cond: (pub_1.revision_id = rev_1.revision_id)
                                             -&gt;  Seq Scan on article_publish pub_1  (cost=0.00..29.40 rows=1940 width=12)
                                             -&gt;  Hash  (cost=15.90..15.90 rows=590 width=100)
                                                   -&gt;  Seq Scan on article_revision rev_1  (cost=0.00..15.90 rows=590 width=100)
                           -&gt;  Materialize  (cost=80.64..88.94 rows=200 width=40)
                                 -&gt;  Unique  (cost=80.64..86.44 rows=200 width=40)
                                       -&gt;  Sort  (cost=80.64..83.54 rows=1160 width=40)
                                             Sort Key: article_deletion.slug, article_deletion.&#34;timestamp&#34;
                                             -&gt;  Seq Scan on article_deletion  (cost=0.00..21.60 rows=1160 width=40)
                     -&gt;  Sort  (cost=64.93..64.93 rows=1 width=64)
                           Sort Key: tags.slug
                           -&gt;  Subquery Scan on tags  (cost=64.90..64.92 rows=1 width=64)
                                 -&gt;  HashAggregate  (cost=64.90..64.91 rows=1 width=64)
                                       Group Key: last_tag_event.slug
                                       CTE last_tag_event
                                         -&gt;  Unique  (cost=54.62..60.39 rows=200 width=76)
                                               -&gt;  Sort  (cost=54.62..56.54 rows=770 width=76)
                                                     Sort Key: tag_event.slug, tag_event.tag, tag_event.&#34;timestamp&#34;
                                                     -&gt;  Seq Scan on tag_event  (cost=0.00..17.70 rows=770 width=76)
                                       -&gt;  CTE Scan on last_tag_event  (cost=0.00..4.50 rows=1 width=64)
                                             Filter: (event = &#39;add&#39;::logblog.tag_event_type)
(43 rows)
</code></pre></div></div>

<p>Ouch.</p>

<p>Unfortunately PostgreSQL does not provide many tools to use these
queries more efficiently, but it is possible to trade some write
performance for read performance.</p>

<p>The first way is very simple: use a <a href="http://www.postgresql.org/docs/9.4/static/sql-creatematerializedview.html">materialised view</a>. This
requires minimal changes to our database and has the desired
effect.</p>

<p>This can be made more efficient still by manually creating a table and
using triggers to update it. This way there is still a log of past
events, but there is also an efficient way to query the current state
of the application. This state can be indexed the same way as any
other table and rebuilt from scratch using the log data if needed.</p>

<p>Here’s a minimal example - deletions and tagging are not included:</p>

<figure><pre><code data-lang="sql"><span>CREATE</span> <span>TABLE</span> <span>logblog</span><span>.</span><span>public_article_state</span> <span>(</span>
       <span>slug</span> <span>TEXT</span> <span>PRIMARY</span> <span>KEY</span> <span>REFERENCES</span> <span>logblog</span><span>.</span><span>article</span><span>,</span>
       <span>title</span> <span>TEXT</span><span>,</span>
       <span>content</span> <span>TEXT</span>
<span>);</span>

<span>CREATE</span> <span>FUNCTION</span> <span>logblog</span><span>.</span><span>insert_slug</span><span>()</span> <span>RETURNS</span> <span>trigger</span> <span>AS</span> <span>$$</span>
    <span>BEGIN</span>
        <span>INSERT</span> <span>INTO</span> <span>logblog</span><span>.</span><span>public_article_state</span> <span>(</span><span>slug</span><span>)</span> <span>VALUES</span> <span>(</span><span>NEW</span><span>.</span><span>slug</span><span>);</span>
        <span>RETURN</span> <span>NEW</span><span>;</span>
    <span>END</span><span>;</span>
<span>$$</span> <span>LANGUAGE</span> <span>plpgsql</span><span>;</span>

<span>CREATE</span> <span>TRIGGER</span> <span>insert_slug</span>
<span>AFTER</span> <span>INSERT</span> <span>ON</span> <span>logblog</span><span>.</span><span>article</span>
<span>FOR</span> <span>EACH</span> <span>ROW</span> <span>EXECUTE</span> <span>PROCEDURE</span> <span>logblog</span><span>.</span><span>insert_slug</span><span>();</span>

<span>CREATE</span> <span>FUNCTION</span> <span>logblog</span><span>.</span><span>update_content</span><span>()</span> <span>RETURNS</span> <span>trigger</span> <span>AS</span> <span>$$</span>
    <span>BEGIN</span>
        <span>UPDATE</span> <span>logblog</span><span>.</span><span>public_article_state</span>
               <span>SET</span> <span>title</span> <span>=</span> <span>rev</span><span>.</span><span>title</span><span>,</span> <span>content</span> <span>=</span> <span>rev</span><span>.</span><span>content</span>
               <span>FROM</span> <span>logblog</span><span>.</span><span>article_revision</span> <span>AS</span> <span>rev</span>
               <span>WHERE</span> <span>rev</span><span>.</span><span>slug</span> <span>=</span> <span>logblog</span><span>.</span><span>public_article_state</span><span>.</span><span>slug</span>
                 <span>AND</span> <span>rev</span><span>.</span><span>revision_id</span> <span>=</span> <span>NEW</span><span>.</span><span>revision_id</span><span>;</span>
        <span>RETURN</span> <span>NEW</span><span>;</span>
    <span>END</span><span>;</span>
<span>$$</span> <span>LANGUAGE</span> <span>plpgsql</span><span>;</span>

<span>CREATE</span> <span>TRIGGER</span> <span>update_content</span>
<span>AFTER</span> <span>INSERT</span> <span>ON</span> <span>logblog</span><span>.</span><span>article_publish</span>
<span>FOR</span> <span>EACH</span> <span>ROW</span> <span>EXECUTE</span> <span>PROCEDURE</span> <span>logblog</span><span>.</span><span>update_content</span><span>();</span></code></pre></figure>

<figure><pre><code data-lang="sql"><span>SELECT</span> <span>*</span> <span>FROM</span> <span>logblog</span><span>.</span><span>public_article_state</span><span>;</span></code></pre></figure>

<div><div><pre><code>         slug         |        title         |                        content
----------------------+----------------------+-------------------------------------------------------
 simple               | A Simple Title       | This is a simple published article
 unpublished          |                      |
 revised              | Revised              | This is revised and published content.
 deleted              | Deleted              | This is a deleted article. You should not see this.
 unpublished-revision | Unpublished Revision | This article has revised content you can not see yet.
 republished          | Republished          | This article was deleted then re-published.
</code></pre></div></div>

<figure><pre><code data-lang="sql"><span>EXPLAIN</span> <span>SELECT</span> <span>*</span> <span>FROM</span> <span>logblog</span><span>.</span><span>public_article_state</span><span>;</span></code></pre></figure>

<div><div><pre><code>                            QUERY PLAN
----------------------------------------------------------------------
Seq Scan on public_article_state  (cost=0.00..16.40 rows=640 width=96)
</code></pre></div></div>

<p>When using this technique, the event log data should be considered the
canonical source of truth and the mutable table an efficient way to
query the current state.</p>

  </div>
</article></div>
  </body>
</html>
