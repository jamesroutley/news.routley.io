<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.boristhebrave.com/2023/11/19/how-does-cave-glade-generator-work/">Original</a>
    <h1>How does Cave/Glade Generator Work</h1>
    
    <div id="readability-page-1" class="page"><article id="post-1909">
	<!-- .entry-header -->

	<div>
		
<p><a href="https://watabou.itch.io/cave-generator">Watabou’s Cave Generator</a> is one in a series of RPG-ready map generators that Watabou has created over the years. <a href="https://watabou.itch.io/">All his work</a> oozes style, but the cave generator was always the one I found most mysterious.</p>



<p>I discovered that the entire thing was exported with extremely readable javascript, so naturally I started to poke and prod. Let’s go over how it works.</p>












<p>We’ll focus on how this map is generated for version 2.0.2:</p>





<h2><span id="Getting_started"></span>Getting started<span></span></h2>



<p>The main thing to initialize are tags. These are randomly picked, but can also be set by the user.</p>


<div>
<figure><img loading="lazy" decoding="async" width="285" height="300" src="https://www.boristhebrave.com/wp-content/uploads/2023/11/tags-285x300.png" alt="" srcset="https://www.boristhebrave.com/wp-content/uploads/2023/11/tags-285x300.png 285w, https://www.boristhebrave.com/wp-content/uploads/2023/11/tags.png 550w" sizes="(max-width: 285px) 100vw, 285px"/></figure></div>


<p>Tags control the later generation steps. Sometimes they switch between different algorithms, but more commonly they act as presets for numeric parameters. I’ll refer to tags <kbd>like this</kbd> when they are referenced. Some tags are mutually exclusive – e.g. only one of <kbd>small</kbd> / <kbd>medium</kbd> / <kbd>large</kbd> can be chosen.</p>



<p>Some other global parameters are randomly chosen at the start, such as chamber size and connectedness preference for area growth. This gives each dungeon a more consistent feel across the map.</p>



<p>Like all procedural generators, there is a seed parameter that controls all sources of randomness. This enables permalinks for maps by storing the seed.</p>



<h2><span id="The_hidden_grid"></span>The hidden grid<span></span></h2>



<p>It’s not obvious, but in fact everything in the generator is done on a hex grid. Let’s see the final output again, this time with all the graphical details turned off – no wobbly lines, no random rocks, no water, no superimposed square gridlines.</p>


<div>
<figure><img loading="lazy" decoding="async" width="1024" height="891" src="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_6-1024x891.png" alt="" srcset="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_6-1024x891.png 1024w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_6-300x261.png 300w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_6-768x668.png 768w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_6-1536x1337.png 1536w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_6-2048x1783.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure></div>


<p>Now you can see the actual specifics of the map. But how is the layout actually achieved?</p>



<h2><span id="Grid_To_Mesh"></span>Grid To Mesh<span></span></h2>



<p>After creating the hex grid, it is immediately converted into a data structure called a <a href="https://en.wikipedia.org/wiki/Doubly_connected_edge_list">Doubly connected edge list</a>, which is essentially a fancy way of representing a mesh of polygons and their neighbours. Everything in the generator operates on this mesh data structure – it’s not tied to hexes at all. I was able to hack in square grids without much difficulty, the author just didn’t find a use for this feature.</p>


<div>
<figure><img loading="lazy" decoding="async" width="252" height="300" src="https://www.boristhebrave.com/wp-content/uploads/2023/11/square_cave_generator-252x300.png" alt="" srcset="https://www.boristhebrave.com/wp-content/uploads/2023/11/square_cave_generator-252x300.png 252w, https://www.boristhebrave.com/wp-content/uploads/2023/11/square_cave_generator-768x914.png 768w, https://www.boristhebrave.com/wp-content/uploads/2023/11/square_cave_generator.png 835w" sizes="(max-width: 252px) 100vw, 252px"/><figcaption>An output created using a square grid</figcaption></figure></div>


<h2><span id="Seed_Growth"></span>Seed Growth<span></span></h2>



<p>The majority of the map is generated with an algorithm called seed growth<sup data-fn="8b84f512-06eb-431d-9cd4-7fa20b515d17"><a href="#8b84f512-06eb-431d-9cd4-7fa20b515d17" id="8b84f512-06eb-431d-9cd4-7fa20b515d17-link">1</a></sup>. It picks a random starting location and then adds adjacent cells at random until a predetermined size has been met. This is then repeated to give several areas. Areas are not permitted to touch each other. </p>


<div>
<figure><img loading="lazy" decoding="async" width="1024" height="891" src="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_1-1024x891.png" alt="" srcset="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_1-1024x891.png 1024w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_1-300x261.png 300w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_1-768x668.png 768w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_1-1536x1337.png 1536w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_1-2048x1783.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure></div>


<p>Most of the details of the generation are determined by tags:</p>



<p>The number of areas is 9-19 for a <kbd>large</kbd> map, 3-8 for a <kbd>medium</kbd> and 2-3 for a <kbd>small</kbd>. If no tags are present has a 1 in 20 chance of picking 2 or 20, otherwise it uses a random formula.</p>



<p>The size of each area is also a random function. For <kbd>hub</kbd> generations, there is one area of size 60-79, and other areas of size 8-13. For <kbd>chamber</kbd>, a random chamber size is chosen between 11-14, and then each area is randomly offset from that by 0-2. And for <kbd>burrow</kbd>, it uses formula <code>10 + 80 * pow((rand() + rand() + rand()) / 3, 3)</code> which gives rooms around size 23, but occasionally much larger.</p>



<p>When choosing which cell to add to the area, they are weighted differently according to various algorithms. By default, it weights each cell as <code>pow(c, gamma)</code> where c is the number of adjacent cells already in the area, and gamma is a random variable indicating the preference for connection. High gamma tends to cause rounder areas with fewer jutting pieces. <kbd>cavities</kbd> fixes the gamma of 6, while <kbd>coral</kbd> uses a negative gamma so each area prefers narrow tendrils. <kbd>chaotic</kbd> prefers cells with 2 connections.</p>


<div>
<figure><img loading="lazy" decoding="async" width="300" height="250" src="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_coral-300x250.png" alt="" srcset="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_coral-300x250.png 300w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_coral-1024x853.png 1024w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_coral-768x640.png 768w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_coral-1536x1280.png 1536w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_coral.png 1777w" sizes="(max-width: 300px) 100vw, 300px"/><figcaption><kbd>coral</kbd> is probably the most distinctive style.</figcaption></figure></div>


<h2><span id="Building_doorways"></span>Building doorways<span></span></h2>



<p>Now its time to connect up all the areas. First, the algorithm identifies all cells that border two elements.</p>


<div>
<figure><img loading="lazy" decoding="async" width="1024" height="891" src="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_2-1024x891.png" alt="" srcset="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_2-1024x891.png 1024w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_2-300x261.png 300w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_2-768x668.png 768w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_2-1536x1337.png 1536w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_2-2048x1783.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure></div>


<p>The possible area-pairs are then culled. For <kbd>tree</kbd>, a simple <a href="https://en.wikipedia.org/wiki/Depth-first_search">depth first search</a> ensures each area is only reachable a single way (no loops). For <kbd>connected</kbd>, if it finds 3 areas all adjacent, it disconnects one pair. Otherwise, all pairs are kept.</p>


<div>
<figure><img loading="lazy" decoding="async" width="1024" height="891" src="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_3-1024x891.png" alt="" srcset="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_3-1024x891.png 1024w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_3-300x261.png 300w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_3-768x668.png 768w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_3-1536x1337.png 1536w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_3-2048x1783.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure></div>


<p>For each pair, a single door cell is randomly chosen from amongst the possibilities and added to the map.</p>


<div>
<figure><img loading="lazy" decoding="async" width="1024" height="891" src="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_5-1024x891.png" alt="" srcset="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_5-1024x891.png 1024w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_5-300x261.png 300w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_5-768x668.png 768w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_5-1536x1337.png 1536w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_5-2048x1783.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure></div>


<h2><span id="Building_Corridors"></span>Building Corridors<span></span></h2>



<p>Some areas are randomly chosen to shrink to corridors. It prefers areas with a large number of doors for the area, and some tags, particularly <kbd>burrows</kbd>, greatly increase the chances.</p>



<p>To shrink an area, points are repeatedly removed, and flood-fill is used to ensure that the doors are all still connected, which I describe more in <a href="https://www.boristhebrave.com/2022/03/20/chiseled-paths-revisited/">Chiseled Paths Revisited</a>.</p>



<figure><img loading="lazy" decoding="async" width="1024" height="891" src="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_6-1024x891.png" alt="" srcset="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_6-1024x891.png 1024w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_6-300x261.png 300w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_6-768x668.png 768w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_6-1536x1337.png 1536w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_6-2048x1783.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>At this point, exits are chosen too, which are randomly selected from eligible border cells. Cells further from the center get higher weights. The exact number of exits can be controlled with tags <kbd>sealed</kbd>, <kbd>entrance</kbd>, <kbd>passage</kbd>, <kbd>junction</kbd>.</p>



<h2><span id="Water"></span>Water<span></span></h2>



<p>The water is simply an independent <a href="https://en.wikipedia.org/wiki/Perlin_noise">Perlin noise</a>, which is compared against a threshold. It’s more obvious in v2.1.0, where you can play with a slider.</p>



<figure><img loading="lazy" decoding="async" width="602" height="662" src="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_water_anim.gif" alt=""/></figure>



<h2><span id="Rough_outlines"></span>Rough outlines<span></span></h2>



<p>The hexagonal nature of the walls is hidden via several steps:</p>



<ul>
<li>Every edge is subdivided</li>



<li>The outline is smoothed (“bumpiness”)</li>



<li>Vertices in corridors are moved towards the face center.</li>



<li>The points are randomly offset (“irregularity”)</li>



<li>Two more iterations of subdivision and randomness (“roughness”)</li>



<li>The boundary is converted to curves with <a href="https://observablehq.com/@pamacha/chaikins-algorithm">Chaikin’s Algorithm</a> (not shown in gif)</li>
</ul>



<figure><img loading="lazy" decoding="async" width="1077" height="746" src="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_geometry.gif" alt=""/></figure>



<h2><span id="Cosmetics"></span>Cosmetics<span></span></h2>



<p>Some random small polygons are dropped on the map to make stones and rubble. <a href="https://www.patreon.com/posts/hatching-in-1pdg-31716880">Dyson hatching</a> is applied near the boundary.</p>



<h2><span id="Title"></span>Title<span></span></h2>



<p>The title of each map is generated using a <a href="https://tracery.io/">Tracery</a> script. Many features contribute to the choices – “demonic” names are more likely for certain tags, and the presence of water increases the chance of damp names like “Bog”.</p>



<p>The top-level rule gives you an idea of what it’s like:</p>



<pre><code>	&#34;name&#34; : [
		&#34;#compound_noun# #noun#&#34;,
		&#34;#adj# #noun#&#34;,
		&#34;0.2?-#noun# of #fantasy#&#34;,
		&#34;!LARGE&amp;0.2?-#person#&#39;s #noun#&#34;,
		&#34;!SMALL&amp;0.1?-#noun# of #epic_noun#&#34;],</code></pre>



<h2><span id="Glade_Mode"></span>Glade Mode<span></span></h2>



<p>Glade mode re-purposes the entire generator for making forest clearings. The main differences are the trees randomly drawn along the border, and the name generator switches to a different script. I love how you can switch it on and see the same map completely re-interpreted.</p>



<figure><img loading="lazy" decoding="async" width="1024" height="891" src="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_glade-1024x891.png" alt="" srcset="https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_glade-1024x891.png 1024w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_glade-300x261.png 300w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_glade-768x668.png 768w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_glade-1536x1337.png 1536w, https://www.boristhebrave.com/wp-content/uploads/2023/11/razorfall_hollows_glade-2048x1783.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<h2><span id="Summary"></span>Summary<span></span></h2>



<p>Oleg’s generator illustrates a common maxim in procedural generation. Great results don’t come from applying a super advanced algorithm, but rather by combining several simple rules effectively, and with an eye to the look and style you are aiming for.</p>



<p>In my opinion, Some of the rules used here, notably seed growth, and path chiseling offer a nice balance of simplicity to useful results and are generally underappreciated as techniques.</p>


			</div><!-- .entry-content -->

	<!-- .entry-footer -->
</article></div>
  </body>
</html>
