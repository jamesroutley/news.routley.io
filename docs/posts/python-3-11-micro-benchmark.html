<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kracekumar.com/post/micro-benchmark-python-311/">Original</a>
    <h1>Python 3.11 micro-benchmark</h1>
    
    <div id="readability-page-1" class="page"><article role="main">
        <p><a href="https://speed.python.org/comparison/">speed.python.org</a> tracks Python module performance improvement
against several modules across Python versions.
In the real world, the module level speed improvements don’t
directly translate to application performance improvements.
The application is composed of several hundreds of dependencies
the performance of one specific module doesn’t improve total
application performance. Nonetheless, it can improve performance
parts of the API or certain flows.</p>
<p>When I first heard the <a href="https://github.com/faster-cpython/ideas">faster CPython initiative</a>, I was intrigued to
find out, how does it translate to small application performance across
various versions since a lot of critical components are already in C
like Postgresql driver. The faster CPython presentation clear states,
the performance boost is only guaranteed for pure python code and
not C-extensions.</p>
<p>In this post, I’ll share my benchmark results on a couple of hand picked snippets.
There is a PyPI package data, do some transformation or do some network operations
or file operations. How does that perform against different Python versions.</p>

<ul>
<li>
<p>The benchmark was run on <code>Intel 11th Gen, i7 @ 2.30GHz</code> with 16 cores.
During entire benchmark no other user initialized programs was run like browser or text editor.</p>
</li>
<li>
<p>The benchmark result was measured using <code>hyperfine</code> <a href="https://github.com/sharkdp/hyperfine">command line tool</a> with <code>--warmup 1</code> flag and 10 runs for each version.</p>
</li>
<li>
<p>No CPU pinning during benchmark.</p>
</li>
<li>
<p>Python 3.9.13, Python 3.10.5, Python 3.11.0 versions were used for benchmarking.</p>
</li>
<li>
<p>Median of 10 runs is used over mean.</p>
</li>
</ul>
<p>Here is the result of the benchmark.</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>                           Python performance - 3.9 vs 3.10 vs 3.11
</span></span><span><span>┏━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┓
</span></span><span><span>┃ Name                     ┃ Median 3.9 <span>(</span>s<span>)</span> ┃ Median 3.10 <span>(</span>s<span>)</span> ┃ Median 3.11 <span>(</span>s<span>)</span> ┃ 3.11 Change ┃
</span></span><span><span>┡━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━┩
</span></span><span><span>│ pypicache                │ 7.4096         │ 7.2654          │ 6.9122          │ 6.71%       │
</span></span><span><span>│ pypi_compression         │ 57.2634        │ 57.3878         │ 57.3969         │ -0.23%      │
</span></span><span><span>│ pypi_postgres            │ 11.4657        │ 11.3525         │ 11.1345         │ 2.89%       │
</span></span><span><span>│ pypi_sqlite_utils        │ 35.6113        │ 34.8789         │ 34.3522         │ 3.54%       │
</span></span><span><span>│ pypi_write_file          │ 17.7075        │ 17.2318         │ 16.7363         │ 5.48%       │
</span></span><span><span>│ pypi_write_file_parallel │ 12.7005        │ 13.0702         │ 12.5040         │ 4.33%       │
</span></span><span><span>│ pypi_zstd_compression    │ 1.4794         │ 1.4687          │ 1.4643          │ 1.02%       │
</span></span><span><span>└──────────────────────────┴────────────────┴─────────────────┴─────────────────┴─────────────┘
</span></span></code></pre></div>
<h2 id="pypi-cache">PyPI Cache</h2>
<div><pre tabindex="0"><code data-lang="python"><span><span><span>import</span> <span>json</span>
</span></span><span><span><span>from</span> <span>operator</span> <span>import</span> <span>itemgetter</span>
</span></span><span><span><span>from</span> <span>urllib.parse</span> <span>import</span> <span>urlparse</span>
</span></span><span><span><span>from</span> <span>rich.console</span> <span>import</span> <span>Console</span>
</span></span><span><span><span>from</span> <span>rich.table</span> <span>import</span> <span>Table</span>
</span></span><span><span><span>from</span> <span>collections</span> <span>import</span> <span>defaultdict</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>get_domain</span><span>(</span><span>addr</span><span>):</span>
</span></span><span><span>    <span>domain</span> <span>=</span> <span>urlparse</span><span>(</span><span>addr</span><span>)</span>
</span></span><span><span>    <span>return</span> <span>domain</span><span>.</span><span>netloc</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>count_domains</span><span>(</span><span>data</span><span>):</span>
</span></span><span><span>    <span>result</span> <span>=</span> <span>defaultdict</span><span>(</span><span>int</span><span>)</span>
</span></span><span><span>    <span>for</span> <span>package</span> <span>in</span> <span>data</span><span>:</span>
</span></span><span><span>        <span>domain</span> <span>=</span> <span>get_domain</span><span>(</span><span>package</span><span>[</span><span>&#39;info&#39;</span><span>][</span><span>&#39;home_page&#39;</span><span>])</span>
</span></span><span><span>        <span>result</span><span>[</span><span>domain</span><span>]</span> <span>+=</span> <span>1</span>
</span></span><span><span>
</span></span><span><span>    <span>return</span> <span>result</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>count_licenses</span><span>(</span><span>data</span><span>):</span>
</span></span><span><span>    <span>result</span> <span>=</span> <span>defaultdict</span><span>(</span><span>int</span><span>)</span>
</span></span><span><span>    <span>for</span> <span>package</span> <span>in</span> <span>data</span><span>:</span>
</span></span><span><span>        <span>classifiers</span> <span>=</span> <span>package</span><span>[</span><span>&#39;info&#39;</span><span>]</span><span>.</span><span>get</span><span>(</span><span>&#39;classifiers&#39;</span><span>,</span> <span>&#39;&#39;</span><span>)</span>
</span></span><span><span>        <span>license</span> <span>=</span> <span>&#39;&#39;</span>
</span></span><span><span>        <span>if</span> <span>classifiers</span><span>:</span>
</span></span><span><span>           <span>for</span> <span>classifier</span> <span>in</span> <span>classifiers</span><span>:</span>
</span></span><span><span>               <span>if</span> <span>&#39;License&#39;</span> <span>in</span> <span>classifier</span><span>:</span>
</span></span><span><span>                  <span>license</span> <span>=</span> <span>classifier</span><span>.</span><span>split</span><span>(</span><span>&#39;::&#39;</span><span>)[</span><span>-</span><span>1</span><span>]</span><span>.</span><span>strip</span><span>()</span>
</span></span><span><span>                  <span>result</span><span>[</span><span>license</span><span>]</span> <span>+=</span> <span>1</span>
</span></span><span><span>    <span>return</span> <span>result</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>get_top</span><span>(</span><span>data</span><span>,</span> <span>n</span><span>=</span><span>10</span><span>):</span>
</span></span><span><span>    <span>return</span> <span>sorted</span><span>(</span><span>data</span><span>.</span><span>items</span><span>(),</span> <span>key</span><span>=</span><span>itemgetter</span><span>(</span><span>1</span><span>),</span> <span>reverse</span><span>=</span><span>True</span><span>)[:</span><span>n</span><span>]</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>main</span><span>():</span>
</span></span><span><span>    <span>data</span> <span>=</span> <span>json</span><span>.</span><span>load</span><span>(</span><span>open</span><span>(</span><span>&#39;../pypicache/pypicache.json&#39;</span><span>))</span>
</span></span><span><span>    <span>domains</span> <span>=</span> <span>count_domains</span><span>(</span><span>data</span><span>)</span>
</span></span><span><span>    <span>top_domains</span> <span>=</span> <span>get_top</span><span>(</span><span>domains</span><span>,</span> <span>10</span><span>)</span>
</span></span><span><span>    <span>licenses</span> <span>=</span> <span>count_licenses</span><span>(</span><span>data</span><span>)</span>
</span></span><span><span>    <span>top_licenses</span> <span>=</span> <span>get_top</span><span>(</span><span>licenses</span><span>,</span> <span>10</span><span>)</span>
</span></span><span><span>
</span></span><span><span>    <span># Print result in a table</span>
</span></span><span><span>    <span>table</span> <span>=</span> <span>Table</span><span>(</span><span>title</span><span>=</span><span>&#34;Project domains&#34;</span><span>)</span>
</span></span><span><span>    <span>table</span><span>.</span><span>add_column</span><span>(</span><span>&#34;Domain&#34;</span><span>)</span>
</span></span><span><span>    <span>table</span><span>.</span><span>add_column</span><span>(</span><span>&#34;Count&#34;</span><span>)</span>
</span></span><span><span>    <span>table</span><span>.</span><span>add_column</span><span>(</span><span>&#34;Percentage&#34;</span><span>)</span>
</span></span><span><span>
</span></span><span><span>    <span>for</span> <span>domain</span><span>,</span> <span>count</span> <span>in</span> <span>top_domains</span><span>:</span>
</span></span><span><span>        <span>table</span><span>.</span><span>add_row</span><span>(</span><span>str</span><span>(</span><span>domain</span><span>),</span> <span>str</span><span>(</span><span>count</span><span>),</span> <span>str</span><span>(</span><span>count</span><span>/</span><span>len</span><span>(</span><span>data</span><span>)</span> <span>*</span> <span>100</span><span>))</span>
</span></span><span><span>
</span></span><span><span>    <span>console</span> <span>=</span> <span>Console</span><span>()</span>
</span></span><span><span>    <span>console</span><span>.</span><span>print</span><span>(</span><span>table</span><span>)</span>
</span></span><span><span>
</span></span><span><span>    <span>table</span> <span>=</span> <span>Table</span><span>(</span><span>title</span><span>=</span><span>&#34;Project licenses&#34;</span><span>)</span>
</span></span><span><span>    <span>table</span><span>.</span><span>add_column</span><span>(</span><span>&#34;License&#34;</span><span>)</span>
</span></span><span><span>    <span>table</span><span>.</span><span>add_column</span><span>(</span><span>&#34;Count&#34;</span><span>)</span>
</span></span><span><span>    <span>table</span><span>.</span><span>add_column</span><span>(</span><span>&#34;Percentage&#34;</span><span>)</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span>    <span>for</span> <span>license</span><span>,</span> <span>count</span> <span>in</span> <span>top_licenses</span><span>:</span>
</span></span><span><span>        <span>table</span><span>.</span><span>add_row</span><span>(</span><span>str</span><span>(</span><span>license</span><span>),</span> <span>str</span><span>(</span><span>count</span><span>),</span> <span>str</span><span>(</span><span>count</span><span>/</span><span>len</span><span>(</span><span>data</span><span>)</span> <span>*</span> <span>100</span><span>))</span>
</span></span><span><span>
</span></span><span><span>    <span>console</span><span>.</span><span>print</span><span>(</span><span>table</span><span>)</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>if</span> <span>__name__</span> <span>==</span> <span>&#34;__main__&#34;</span><span>:</span>
</span></span><span><span>   <span>main</span><span>()</span>
</span></span></code></pre></div><p>The snippet loads the PyPI JSON file downloaded (720 MB) from <a href="https://pypicache.repology.org/pypicache.json.zst">https://pypicache.repology.org/pypicache.json.zst</a> and does IO operations. Extract the zstd file and place it in pypicache directory.</p>
<p>The IO operations performs five activities</p>
<ul>
<li>Find home page domain frequencies across various packages.</li>
<li>Get top 10 home page domains.</li>
<li>Find license frequencies of the packages.</li>
<li>Get top 10 used licenses.</li>
<li>Print the results in the table.</li>
</ul>
<p><strong>Python 3.11 faster compared to Python 3.9 by <code>6.71%</code>. The median execution times - <code>Python 3.9 - 7.40s, Python 3.10 - 7.26s, Python 3.11 - 6.91s</code>.</strong></p>
<h2 id="pypi-compression">PyPI Compression</h2>
<div><pre tabindex="0"><code data-lang="python"><span><span><span>import</span> <span>bz2</span>
</span></span><span><span><span>import</span> <span>json</span>
</span></span><span><span><span>import</span> <span>pathlib</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>main</span><span>():</span>
</span></span><span><span>    <span>with</span> <span>open</span><span>(</span><span>&#39;../pypicache/pypicache.json&#39;</span><span>,</span> <span>&#39;rb&#39;</span><span>)</span> <span>as</span> <span>fp</span><span>:</span>
</span></span><span><span>        <span>filename</span> <span>=</span> <span>&#39;../pypicache/pypicache.json.bz2&#39;</span>
</span></span><span><span>        <span>with</span> <span>bz2</span><span>.</span><span>open</span><span>(</span><span>filename</span><span>,</span> <span>&#39;wb&#39;</span><span>)</span> <span>as</span> <span>wfp</span><span>:</span>
</span></span><span><span>            <span>wfp</span><span>.</span><span>write</span><span>(</span><span>bz2</span><span>.</span><span>compress</span><span>(</span><span>fp</span><span>.</span><span>read</span><span>()))</span>
</span></span><span><span>
</span></span><span><span>        <span>pathlib</span><span>.</span><span>Path</span><span>(</span><span>filename</span><span>)</span><span>.</span><span>unlink</span><span>()</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>if</span> <span>__name__</span> <span>==</span> <span>&#34;__main__&#34;</span><span>:</span>
</span></span><span><span>    <span>main</span><span>()</span>
</span></span></code></pre></div><p>The snippet compresses the decompressed PyPI JSON data to <code>bz2</code> format
and deletes the compressed file.</p>
<p><strong>Python 3.11 was the slowest, the performance degraded by <code>0.23%</code> compared to 3.9
and the median execution times are <code>Python 3.9 - 57.26 s, Python 3.10 - 57.38 s, Python 3.11 - 57.39s</code>.</strong></p>
<p>Interesting part is Python 3.9 is faster than Python 3.10 and Python 3.10 is faster than 3.11. (No hunch why is it so)</p>
<h2 id="pypi-postgres">PyPI Postgres</h2>
<div><pre tabindex="0"><code data-lang="python"><span><span><span>import</span> <span>json</span>
</span></span><span><span><span>import</span> <span>psycopg2</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>main</span><span>():</span>
</span></span><span><span>    <span>data</span> <span>=</span> <span>json</span><span>.</span><span>load</span><span>(</span><span>open</span><span>(</span><span>&#39;../pypicache/pypicache.json&#39;</span><span>))</span>
</span></span><span><span>    <span>conn</span> <span>=</span> <span>psycopg2</span><span>.</span><span>connect</span><span>(</span><span>&#34;dbname=scratch user=admin password=admin&#34;</span><span>)</span>
</span></span><span><span>    <span>cur</span> <span>=</span> <span>conn</span><span>.</span><span>cursor</span><span>()</span>
</span></span><span><span>    <span>stop</span> <span>=</span> <span>100000</span>
</span></span><span><span>    <span>for</span> <span>idx</span><span>,</span> <span>package</span> <span>in</span> <span>enumerate</span><span>(</span><span>data</span><span>[:</span><span>stop</span><span>]):</span>
</span></span><span><span>        <span>info</span> <span>=</span> <span>package</span><span>[</span><span>&#39;info&#39;</span><span>]</span>
</span></span><span><span>        <span>cur</span><span>.</span><span>execute</span><span>(</span><span>&#34;&#34;&#34;insert into
</span></span></span><span><span><span>        pypi(author, author_email, bugtrack_url, license, maintainer, maintainer_email, name, summary, version)
</span></span></span><span><span><span>        values(</span><span>%s</span><span>, </span><span>%s</span><span>, </span><span>%s</span><span>, </span><span>%s</span><span>, </span><span>%s</span><span>, </span><span>%s</span><span>, </span><span>%s</span><span>, </span><span>%s</span><span>, </span><span>%s</span><span>)&#34;&#34;&#34;</span><span>,</span>
</span></span><span><span>                    <span>(</span><span>info</span><span>[</span><span>&#39;author&#39;</span><span>],</span> <span>info</span><span>[</span><span>&#39;author_email&#39;</span><span>],</span>
</span></span><span><span>                     <span>info</span><span>[</span><span>&#39;bugtrack_url&#39;</span><span>],</span> <span>info</span><span>[</span><span>&#39;license&#39;</span><span>],</span> <span>info</span><span>[</span><span>&#39;maintainer&#39;</span><span>],</span>
</span></span><span><span>                     <span>info</span><span>[</span><span>&#39;maintainer_email&#39;</span><span>],</span> <span>info</span><span>[</span><span>&#39;name&#39;</span><span>],</span> <span>info</span><span>[</span><span>&#39;summary&#39;</span><span>],</span>
</span></span><span><span>                     <span>info</span><span>[</span><span>&#39;version&#39;</span><span>]))</span>
</span></span><span><span>        <span>if</span> <span>idx</span> <span>%</span> <span>100</span> <span>==</span> <span>1</span> <span>or</span> <span>idx</span> <span>==</span> <span>stop</span><span>:</span>
</span></span><span><span>            <span>conn</span><span>.</span><span>commit</span><span>()</span>
</span></span><span><span>    <span>conn</span><span>.</span><span>commit</span><span>()</span>
</span></span><span><span>    <span>cur</span><span>.</span><span>execute</span><span>(</span><span>&#39;select count(*) from pypi&#39;</span><span>)</span>
</span></span><span><span>    <span>print</span><span>(</span><span>&#34;Total rows: &#34;</span><span>,</span> <span>cur</span><span>.</span><span>fetchone</span><span>())</span>
</span></span><span><span>    <span>cur</span><span>.</span><span>execute</span><span>(</span><span>&#39;delete from pypi&#39;</span><span>)</span>
</span></span><span><span>    <span>conn</span><span>.</span><span>commit</span><span>()</span>
</span></span></code></pre></div><p>The snippet uses psycopg2 to insert hundred thousand packages into a postgres database.</p>
<ul>
<li>Insert pypi package details into a table and commit 100 records at a time to <code>pypi</code> table.</li>
<li>Find total number of inserted records in <code>pypi</code> table.</li>
<li>Delete the <code>pypi</code> table.</li>
</ul>
<p><strong>Python 3.11 is faster compared to Python 3.10 by <code>2.89%</code>. The median execution times, <code>Python 3.9 - 11.46s, Python 3.10 - 11.35s, Python 3.11 - 11.13s</code>.</strong></p>
<p>Since most of the code was doing network call, it’s surprising to see a small performance improvement in Python 3.11.</p>
<h2 id="pypi-sqlite-utils">PyPI SQLite Utils</h2>
<div><pre tabindex="0"><code data-lang="python"><span><span><span>import</span> <span>json</span>
</span></span><span><span><span>from</span> <span>sqlite_utils.db</span> <span>import</span> <span>Database</span><span>,</span> <span>Table</span>
</span></span><span><span><span>from</span> <span>pathlib</span> <span>import</span> <span>Path</span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>main</span><span>():</span>
</span></span><span><span>    <span>data</span> <span>=</span> <span>json</span><span>.</span><span>load</span><span>(</span><span>open</span><span>(</span><span>&#39;../pypicache/pypicache.json&#39;</span><span>))</span>
</span></span><span><span>    <span>db_name</span> <span>=</span> <span>&#39;pypi.db&#39;</span>
</span></span><span><span>    <span>db</span> <span>=</span> <span>Database</span><span>(</span><span>db_name</span><span>)</span>
</span></span><span><span>    <span>table</span> <span>=</span> <span>Table</span><span>(</span><span>db</span><span>,</span> <span>&#39;pypi&#39;</span><span>)</span>
</span></span><span><span>
</span></span><span><span>    <span>for</span> <span>idx</span> <span>in</span> <span>range</span><span>(</span><span>1000</span><span>):</span>
</span></span><span><span>        <span>table</span><span>.</span><span>insert_all</span><span>(</span><span>data</span><span>[</span><span>idx</span> <span>*</span> <span>100</span><span>:</span><span>idx</span> <span>*</span> <span>100</span> <span>+</span> <span>100</span><span>])</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span>    <span>print</span><span>(</span><span>&#34;Rows: &#34;</span><span>,</span> <span>table</span><span>.</span><span>count</span><span>)</span>
</span></span><span><span>    <span>Path</span><span>(</span><span>db_name</span><span>)</span><span>.</span><span>unlink</span><span>()</span>
</span></span><span><span>
</span></span><span><span><span>if</span> <span>__name__</span> <span>==</span> <span>&#34;__main__&#34;</span><span>:</span>
</span></span><span><span>   <span>main</span><span>()</span>
</span></span></code></pre></div><p>The snippet inserts hundred thousand PyPI package data to sqlite database over ten thousand iterations using <code>sqlite_utils</code> package and deletes the sqlite file.</p>
<p><strong>Python 3.11 is faster compared to Python 3.9 by 3.54%. The median execution times, <code>Python 3.9 - 35.61s, 34.87s, 34.35s</code>.</strong></p>
<h2 id="pypi-write-to-file">PyPI Write To File</h2>
<div><pre tabindex="0"><code data-lang="python"><span><span><span>import</span> <span>json</span>
</span></span><span><span><span>from</span> <span>pathlib</span> <span>import</span> <span>Path</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>write_to_file</span><span>(</span><span>directory</span><span>,</span> <span>package</span><span>):</span>
</span></span><span><span>    <span>name</span> <span>=</span> <span>package</span><span>[</span><span>&#39;info&#39;</span><span>][</span><span>&#39;name&#39;</span><span>]</span>
</span></span><span><span>
</span></span><span><span>    <span>with</span> <span>open</span><span>(</span><span>directory</span> <span>/</span> <span>(</span><span>name</span> <span>+</span> <span>&#34;.json&#34;</span><span>),</span> <span>&#34;w&#34;</span><span>)</span> <span>as</span> <span>fp</span><span>:</span>
</span></span><span><span>        <span>fp</span><span>.</span><span>write</span><span>(</span><span>json</span><span>.</span><span>dumps</span><span>(</span><span>package</span><span>))</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>delete_files</span><span>(</span><span>directory</span><span>):</span>
</span></span><span><span>    <span>for</span> <span>filename</span> <span>in</span> <span>list</span><span>(</span><span>directory</span><span>.</span><span>iterdir</span><span>()):</span>
</span></span><span><span>        <span>filename</span><span>.</span><span>unlink</span><span>()</span>
</span></span><span><span>
</span></span><span><span>    <span>directory</span><span>.</span><span>rmdir</span><span>()</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>main</span><span>():</span>
</span></span><span><span>    <span>data</span> <span>=</span> <span>json</span><span>.</span><span>load</span><span>(</span><span>open</span><span>(</span><span>&#39;../pypicache/pypicache.json&#39;</span><span>))</span>
</span></span><span><span>    <span>directory</span> <span>=</span> <span>Path</span><span>(</span><span>&#34;/tmp/pypi&#34;</span><span>)</span>
</span></span><span><span>    <span>directory</span><span>.</span><span>mkdir</span><span>()</span>
</span></span><span><span>    <span>for</span> <span>package</span> <span>in</span> <span>data</span><span>:</span>
</span></span><span><span>        <span>write_to_file</span><span>(</span><span>directory</span><span>=</span><span>directory</span><span>,</span> <span>package</span><span>=</span><span>package</span><span>)</span>
</span></span><span><span>    <span>delete_files</span><span>(</span><span>directory</span><span>)</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>if</span> <span>__name__</span> <span>==</span> <span>&#34;__main__&#34;</span><span>:</span>
</span></span><span><span>   <span>main</span><span>()</span>
</span></span></code></pre></div><p>The snippet writes each PyPI package info to a separate JSON file and deletes all the file.</p>
<p><strong>Python 3.11 is faster compared to Python 3.9 by 5.48%. The median execution times, <code>Python 3.9 - 17.07 s, Python 3.10 - 17.23 s, Python 3.11 - 16.73 s</code>.</strong></p>

<div><pre tabindex="0"><code data-lang="python"><span><span><span>import</span> <span>json</span>
</span></span><span><span><span>from</span> <span>pathlib</span> <span>import</span> <span>Path</span>
</span></span><span><span><span>from</span> <span>multiprocessing</span> <span>import</span> <span>Pool</span>
</span></span><span><span><span>from</span> <span>functools</span> <span>import</span> <span>partial</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>write_to_file</span><span>(</span><span>directory</span><span>,</span> <span>package</span><span>):</span>
</span></span><span><span>    <span>name</span> <span>=</span> <span>package</span><span>[</span><span>&#39;info&#39;</span><span>][</span><span>&#39;name&#39;</span><span>]</span>
</span></span><span><span>
</span></span><span><span>    <span>with</span> <span>open</span><span>(</span><span>directory</span> <span>/</span> <span>(</span><span>name</span> <span>+</span> <span>&#34;.json&#34;</span><span>),</span> <span>&#34;w&#34;</span><span>)</span> <span>as</span> <span>fp</span><span>:</span>
</span></span><span><span>        <span>fp</span><span>.</span><span>write</span><span>(</span><span>json</span><span>.</span><span>dumps</span><span>(</span><span>package</span><span>))</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>delete_files</span><span>(</span><span>directory</span><span>):</span>
</span></span><span><span>    <span>for</span> <span>filename</span> <span>in</span> <span>list</span><span>(</span><span>directory</span><span>.</span><span>iterdir</span><span>()):</span>
</span></span><span><span>        <span>filename</span><span>.</span><span>unlink</span><span>()</span>
</span></span><span><span>
</span></span><span><span>    <span>directory</span><span>.</span><span>rmdir</span><span>()</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>main</span><span>():</span>
</span></span><span><span>    <span>data</span> <span>=</span> <span>json</span><span>.</span><span>load</span><span>(</span><span>open</span><span>(</span><span>&#39;../pypicache/pypicache.json&#39;</span><span>))</span>
</span></span><span><span>    <span>directory</span> <span>=</span> <span>Path</span><span>(</span><span>&#34;/tmp/pypi&#34;</span><span>)</span>
</span></span><span><span>    <span>directory</span><span>.</span><span>mkdir</span><span>()</span>
</span></span><span><span>    <span>with</span> <span>Pool</span><span>(</span><span>33</span><span>)</span> <span>as</span> <span>p</span><span>:</span>
</span></span><span><span>        <span>p</span><span>.</span><span>map</span><span>(</span><span>partial</span><span>(</span><span>write_to_file</span><span>,</span> <span>directory</span><span>),</span> <span>data</span><span>)</span>
</span></span><span><span>    <span>delete_files</span><span>(</span><span>directory</span><span>)</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>if</span> <span>__name__</span> <span>==</span> <span>&#34;__main__&#34;</span><span>:</span>
</span></span><span><span>   <span>main</span><span>()</span>
</span></span></code></pre></div><p>The snippet uses Python multi-processing to write PyPI package to a separate JSON file and deletes all the JSON file serially. 33 worker in the pool.</p>
<p><strong>Python 3.11 is faster compared to Python 3.9 by 4.33%. The median execution time, <code>Python 3.9 - 12,70 s, Python 3.10 - 13.07 s, Python 3.11 - 12.50s</code>.</strong></p>
<h2 id="pypi-zstd-compression">PyPI zstd Compression</h2>
<div><pre tabindex="0"><code data-lang="python"><span><span><span>import</span> <span>zstandard</span> <span>as</span> <span>zstd</span>
</span></span><span><span><span>import</span> <span>json</span>
</span></span><span><span><span>import</span> <span>pathlib</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>main</span><span>():</span>
</span></span><span><span>    <span>with</span> <span>open</span><span>(</span><span>&#39;../pypicache/pypicache.json&#39;</span><span>,</span> <span>&#39;rb&#39;</span><span>)</span> <span>as</span> <span>fp</span><span>:</span>
</span></span><span><span>        <span>filename</span> <span>=</span> <span>&#39;../pypicache/pypicache_benchmark.json.zstd&#39;</span>
</span></span><span><span>        <span>with</span> <span>zstd</span><span>.</span><span>open</span><span>(</span><span>filename</span><span>,</span> <span>&#39;wb&#39;</span><span>)</span> <span>as</span> <span>wfp</span><span>:</span>
</span></span><span><span>            <span>wfp</span><span>.</span><span>write</span><span>(</span><span>zstd</span><span>.</span><span>compress</span><span>(</span><span>fp</span><span>.</span><span>read</span><span>()))</span>
</span></span><span><span>
</span></span><span><span>        <span>pathlib</span><span>.</span><span>Path</span><span>(</span><span>filename</span><span>)</span><span>.</span><span>unlink</span><span>()</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>if</span> <span>__name__</span> <span>==</span> <span>&#34;__main__&#34;</span><span>:</span>
</span></span><span><span>    <span>main</span><span>()</span>
</span></span></code></pre></div><p>The snippet compress the PyPI JSON file to zstd file format using <code>zstandard</code> library.</p>
<p><strong>Python 3.11 is faster compared to Python 3.10 by 1.02%. In general, it’s safe to say, there is no useful performance improvement here. The median execution times, <code>Python 3.9 - 1.47s, Python 3.10 - 1.46 s, Python 3.11 - 1.46s</code>.</strong></p>
<p><strong>Compared to <code>bz2</code> compression, zstd is atleast ~50 times faster.</strong></p>
<h2 id="benchmark-runner">Benchmark runner</h2>
<p>The benchmark runner is similar for all experiments.</p>
<div><pre tabindex="0"><code data-lang="fish"><span><span><span>#!/usr/bin/env fish
</span></span></span><span><span><span></span><span>ls</span> <span>-lat</span> <span>|</span> <span>grep</span> venv <span>|</span> <span>xargs</span> rm <span>-rf</span>
</span></span><span><span><span>echo</span> <span>&#34;Running 3.9 benchmark&#34;</span>
</span></span><span><span><span>python3</span>.<span>9</span> <span>-m</span> venv .venv_3_9
</span></span><span><span><span>source</span> .venv_3_9/bin/activate.<span>fish
</span></span></span><span><span><span></span><span>pip</span> install <span>-r</span> requirements.txt
</span></span><span><span><span>hyperfine</span> <span>--warmup</span> <span>1</span> <span>&#39;python run_benchmark.py&#39;</span> <span>--export-json</span> py_3_9.json
</span></span><span><span><span>echo</span> <span>&#34;Running 3.10 benchmark&#34;</span>
</span></span><span><span><span>python3</span>.<span>10</span> <span>-m</span> venv .venv_3_10
</span></span><span><span><span>source</span> .venv_3_10/bin/activate.<span>fish
</span></span></span><span><span><span></span><span>pip</span> install <span>-r</span> requirements.txt
</span></span><span><span><span>hyperfine</span> <span>--warmup</span> <span>1</span> <span>&#39;python run_benchmark.py&#39;</span> <span>--export-json</span> py_3_10.json
</span></span><span><span><span>echo</span> <span>&#34;Running 3.11 benchmark&#34;</span>
</span></span><span><span><span>python3</span>.<span>11</span> <span>-m</span> venv .venv_3_11
</span></span><span><span><span>source</span> .venv_3_11/bin/activate.<span>fish
</span></span></span><span><span><span></span><span>pip</span> install <span>-r</span> requirements.txt
</span></span><span><span><span>hyperfine</span> <span>--warmup</span> <span>1</span> <span>&#39;python run_benchmark.py&#39;</span> <span>--export-json</span> py_3_11.json
</span></span></code></pre></div><ul>
<li>python3.9, python3.10, python3.11 are aliases to pyenv python versions.</li>
</ul>

<ul>
<li>If the code uses standard library JSON, switching to Python 3.11 will provide significant performance improvement.</li>
<li>If you’re using <code>bz2</code> for compression, consider using <code>zstd</code> that is 50 times faster. (I wasn’t aware of zstd format untill I downloaded pypi cache data).</li>
<li>If you’re using Python 3.8 or 3.9, it’s better to upgrade to Python 3.11 over Python 3.10.</li>
<li>Even when the code is entirely using C-extension like psycopg2, there is performance improvement.
So it’s good to benchmark against 3.11 when all the dependencies run on Python 3.11.</li>
<li>Since all programs load JSON data, the performance gain can be due to pure JSON improvement.</li>
</ul>


        

        

        
          

          
                  
       <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"/></a></article></div>
  </body>
</html>
