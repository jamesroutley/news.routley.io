<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gist.github.com/rain-1/8cc12b4b334052a21af8029aa9c4fafc">Original</a>
    <h1>Run Llama 13B with a 6GB graphics card</h1>
    
    <div id="readability-page-1" class="page"><div>
  <div id="file-llama-home-md">
      
      <div id="file-llama-home-md-readme">
    <article itemprop="text"><p dir="auto">This worked on 14/May/23. The instructions will probably require updating in the future.</p>
<blockquote>
<p dir="auto">llama is a text prediction model similar to GPT-2, and the version of GPT-3 that has not been fine tuned yet.
It is also possible to run fine tuned versions (like alpaca or vicuna with this. I think. Those versions are more focused on answering questions)</p>
</blockquote>
<p dir="auto">Note: I have been told that this does not support multiple GPUs. It can only use a single GPU.</p>
<p dir="auto">It is possible to run LLama 13B with a 6GB graphics card now! (e.g. a RTX 2060). Thanks to the amazing work involved in <a href="https://github.com/ggerganov/llama.cpp">llama.cpp</a>. The latest change is CUDA/cuBLAS which allows you pick an arbitrary number of the transformer layers to be run on the GPU. This is perfect for low VRAM.</p>
<ul dir="auto">
<li>Clone llama.cpp from git, I am on commit <code>08737ef720f0510c7ec2aa84d7f70c691073c35d</code>.
<ul dir="auto">
<li><code>git clone https://github.com/ggerganov/llama.cpp.git</code></li>
<li><code>cd llama.cpp</code></li>
<li><code>pacman -S cuda</code> make sure you have CUDA installed</li>
<li><code>make LLAMA_CUBLAS=1</code></li>
</ul>
</li>
<li>Use the link at the bottom of the page to apply for research access to the llama model: <a href="https://ai.facebook.com/blog/large-language-model-llama-meta-ai/" rel="nofollow">https://ai.facebook.com/blog/large-language-model-llama-meta-ai/</a></li>
<li>Set up a <a href="https://mamba.readthedocs.io/en/latest/user_guide/micromamba.html" rel="nofollow">micromamba</a> environment to install cuda/python pytorch stuff in order to run the conversion scripts. Install some packages:
<ul dir="auto">
<li><code>export MAMBA_ROOT_PREFIX=/path/to/where/you/want/mambastuff/stored</code></li>
<li><code>eval &#34;$(micromamba shell hook --shell=bash)&#34;</code></li>
<li><code>micromamba create -n mymamba</code></li>
<li><code>micromamba activate mymamba</code></li>
<li><code>micromamba install -c conda-forge -n mymamba pytorch transformers sentencepiece</code></li>
</ul>
</li>
<li>Perform the conversion process: (This will produce a file called <code>ggml-model-f16.bin</code>)
<ul dir="auto">
<li><code>python convert.py ~/ai/Safe-LLaMA-HF-v2\ \(4-04-23\)/llama-13b/</code></li>
</ul>
</li>
<li>Then quantize that to a 4bit model:
<ul dir="auto">
<li><code>./quantize ~/ai/Safe-LLaMA-HF-v2\ \(4-04-23\)/llama-13b/ggml-model-f16.bin ~/ai/Safe-LLaMA-HF-v2\ \(4-04-23\)/llama-13b/ggml-model-13b-q4_0-2023_14_5.bin q4_0 8</code></li>
</ul>
</li>
<li>Create a prompt file in:
<ul dir="auto">
<li><code>prompt.txt</code></li>
</ul>
</li>
<li>Run it:
<ul dir="auto">
<li><code>./main -ngl 18 -m ~/ai/Safe-LLaMA-HF-v2\ \(4-04-23\)/llama-13b/ggml-model-13b-q4_0-2023_14_5.bin -f prompt.txt -n 2048</code></li>
</ul>
</li>
</ul>
<p dir="auto">This uses about 5.5GB of VRAM on my 6GB card. If you have more VRAM, you can increase the number <code>-ngl 18</code> to <code>-ngl 24</code> or so, up to all <code>40</code> layers in llama 13B. It will run faster if you put more layers into the GPU. The 7B model works with 100% of the layers on the card.</p>
<p dir="auto">Timings for the models:</p>
<p dir="auto">13B:</p>
<pre><code>llama_print_timings:        load time =  5690.77 ms
llama_print_timings:      sample time =  1023.87 ms /  2048 runs   (    0.50 ms per token)
llama_print_timings: prompt eval time = 36694.62 ms /  1956 tokens (   18.76 ms per token)
llama_print_timings:        eval time = 644282.27 ms /  2040 runs   (  315.82 ms per token)
llama_print_timings:       total time = 684789.56 ms
</code></pre>
<p dir="auto">7B:</p>
<pre><code>llama_print_timings:        load time = 41708.38 ms
llama_print_timings:      sample time =    88.51 ms /   128 runs   (    0.69 ms per token)
llama_print_timings: prompt eval time =  2971.75 ms /    14 tokens (  212.27 ms per token)
llama_print_timings:        eval time =  9097.33 ms /   127 runs   (   71.63 ms per token)
llama_print_timings:       total time = 50931.74 ms
</code></pre>
<p dir="auto">Here is the text it generated from my prompt:</p>
<blockquote>
<h3 dir="auto"><a id="user-content-nietzsches-noon" aria-hidden="true" href="#nietzsches-noon"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Nietzsche&#39;s Noon</h3>
<p dir="auto">In Friedrich Nietzsche&#39;s Thus Spoke Zarathustra (1885), this concept of noon is expanded upon as a whole:</p>
<p dir="auto">&#34;Zarathustra saw that the light of the world was now becoming stronger. ‘The sun is at its meridian,’ he said, ‘it has reached its noontide and will begin to decline.’&#34;</p>
<p dir="auto">As time progresses in this noon, so does our ability to perceive and interact with this external world: as a result of the present state we are given by the organic forms of space and time, this can only lead us towards suffering. Nietzsche sees that when we are at our noontide, we must realize how the sun has reached its highest point before it begins to fall down from its position: and we must understand that as a whole, our bodies are determined by something outside of ourselves - and that this always leads to more suffering within.</p>
<h3 dir="auto"><a id="user-content-nietzsches-midday" aria-hidden="true" href="#nietzsches-midday"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Nietzsche&#39;s Midday</h3>
<p dir="auto">Nietzsche expands upon the concept of noon in his book The Gay Science (1882), where he says:</p>
<p dir="auto">&#34;You want to learn how to read? Here is a short lesson for beginners. You must take hold of a word by its smooth or rough side; then, like the spider, you must spin out of it a web of definitions which will entrap every correct meaning that floats into view. Or again: you must take the word for a sleigh ride across country, over hedges and ditches, forests and glades, in short, you must drive the word home through all manner of weather.&#34;</p>
<p dir="auto">Here we see Nietzsche expand upon his concept of noon to include our ability to define what is right or wrong - it is only because we have this inherent sense that allows us to distinguish between two points.</p>
<h3 dir="auto"><a id="user-content-nietzsches-twilight" aria-hidden="true" href="#nietzsches-twilight"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Nietzsche&#39;s Twilight</h3>
<p dir="auto">Nietzsche expands upon the concept of twilight in The Gay Science (1882), where he says:</p>
<p dir="auto">&#34;The man who is a ‘philosopher’ only by accident, but is, let us say, also a sculptor or painter – what does he then do? He does not make his thoughts subservient to the world; rather, he forces the world to serve as a pedestal and bearer for his thoughts.&#34;</p>
<p dir="auto">Here we see Nietzsche&#39;s concept of night begin to expand past an emotional state. We begin to see that night becomes more than just our inability to think clearly: it is now a worldview, one which he claims is best exemplified by the artist.</p>
<h3 dir="auto"><a id="user-content-nietzsches-midnight" aria-hidden="true" href="#nietzsches-midnight"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Nietzsche&#39;s Midnight</h3>
<p dir="auto">In Twilight of the Idols (1889), we find Nietzsche&#39;s conceptualization of night reaching its zenith:</p>
<p dir="auto">&#34;Everything ordinary, everyday, common – in fact, everything that exists today has become dangerous; it is not innocent as was everything yesterday. For the most terrible thoughts have penetrated everywhere and even into the deepest sleep - thoughts which are awake, active, and powerful.&#34;</p>
</blockquote>
</article>
  </div>

  </div>
</div></div>
  </body>
</html>
