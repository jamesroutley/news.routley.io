<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://bun.sh/blog/bun-v0.5.7">Original</a>
    <h1>Bun v0.5.7</h1>
    
    <div id="readability-page-1" class="page"><section><div><p><a href="https://twitter.com/ashconpartovi">Ashcon Partovi</a><span> · <!-- -->February 24, 2023</span></p><article><p>Bun v0.5.7 introduces <code>FormData</code> support, <code>git</code> dependencies, and <code>AbortSignal</code> with <code>fetch()</code>, <code>setTimeout()</code> is now more compatible with Node.js, <code>bun wiptest</code> is now <code>bun test</code> — with pretty-printed diffs! — and improved support on AWS Lambda and GitHub Actions.</p><div><div><div><pre><code><span><span># Install using curl</span></span>
<span><span>curl -fsSL https://bun.sh/install </span><span>|</span><span> bash</span></span>
<span></span>
<span><span># Install using npm</span></span>
<span><span># npm install -g bun</span></span>
<span></span>
<span><span># Upgrade</span></span>
<span><span>bun upgrade</span></span>
<span></span></code></pre></div></div></div><h2 level="2" anchor-id="formdata-support"><a id="formdata-support"></a><a href="#formdata-support"><code>FormData</code> support</a></h2><p>Bun now supports <a href="https://developer.mozilla.org/en-US/docs/Web/API/FormData"><code>FormData</code></a>, a standard Web API for working with form fields and files in multipart uploads. You can add a <code>string</code> as a field or a <code>Blob</code> as a file.</p><div><div><div><pre><code><span><span>const</span><span> formData </span><span>=</span><span> </span><span>new</span><span> </span><span>FormData</span><span>();</span></span>
<span><span>formData.</span><span>set</span><span>(</span><span>&#34;</span><span>attachment-id</span><span>&#34;</span><span>, crypto.</span><span>randomUUID</span><span>());</span></span>
<span><span>formData.</span><span>set</span><span>(</span><span>&#34;</span><span>attachment</span><span>&#34;</span><span>, Bun.</span><span>file</span><span>(</span><span>&#34;</span><span>./package.json</span><span>&#34;</span><span>));</span></span>
<span><span>const</span><span> response </span><span>=</span><span> </span><span>await</span><span> </span><span>fetch</span><span>(</span><span>&#34;</span><span>https://example.com/upload</span><span>&#34;</span><span>, {</span></span>
<span><span>  method</span><span>:</span><span> </span><span>&#34;</span><span>POST</span><span>&#34;</span><span>,</span></span>
<span><span>  body</span><span>:</span><span> formData,</span></span>
<span><span>});</span></span>
<span></span></code></pre></div></div></div><p>You can also parse <code>FormData</code> from a <code>Request</code> or <code>Response</code>.</p><div><div><div><pre><code><span><span>export</span><span> </span><span>default</span><span> {</span></span>
<span><span>  </span><span>async</span><span> </span><span>fetch</span><span>(</span><span>request</span><span>:</span><span> </span><span>Request</span><span>)</span><span>:</span><span> </span><span>Promise</span><span>&lt;</span><span>Response</span><span>&gt; {</span></span>
<span><span>    </span><span>const</span><span> formData </span><span>=</span><span> </span><span>await</span><span> request.</span><span>formData</span><span>();</span></span>
<span><span>    </span><span>const</span><span> file </span><span>=</span><span> formData.</span><span>get</span><span>(</span><span>&#34;</span><span>attachment</span><span>&#34;</span><span>);</span></span>
<span><span>    </span><span>// ...</span></span>
<span><span>    </span><span>return</span><span> </span><span>new</span><span> </span><span>Response</span><span>(file);</span></span>
<span><span>  },</span></span>
<span><span>};</span></span>
<span></span></code></pre></div></div></div><p>In Bun, <a href="https://developer.mozilla.org/en-US/docs/Web/API/Response/formData"><code>response.formData()</code></a> runs:</p><ul><li><strong>25x</strong> faster than Node v19.6.0</li><li><strong>4x</strong> faster than Deno v1.30.3</li></ul><figure><a href="https://user-images.githubusercontent.com/709451/220815500-39575f67-c3a6-4217-87e9-e74217103e64.png"><img src="https://user-images.githubusercontent.com/709451/220815500-39575f67-c3a6-4217-87e9-e74217103e64.png" alt="image" width="100%"/></a></figure><p><a href="https://github.com/oven-sh/bun/blob/24d624b176df241936d4ec82b2d6f93861de6229/bench/snippets/form-data.mjs#L1">View benchmark</a></p><h2 level="2" anchor-id="git-dependencies"><a id="git-dependencies"></a><a href="#git-dependencies">Git dependencies</a></h2><p>Bun now supports <code>git</code> dependencies in <code>package.json</code>. Bun accepts a variety of git dependency formats, including <a href="https://docs.npmjs.com/cli/v9/configuring-npm/package-json#github-urls"><code>github</code></a>, <a href="https://docs.npmjs.com/cli/v9/configuring-npm/package-json#git-urls-as-dependencies"><code>git</code></a>, <code>git+ssh</code>, <code>git+https</code>, and many more.</p><div><div><div><pre><code><span><span>{</span></span>
<span><span>  </span><span>&#34;</span><span>dependencies</span><span>&#34;</span><span>:</span><span> {</span></span>
<span><span>    </span><span>&#34;</span><span>zod</span><span>&#34;</span><span>:</span><span> </span><span>&#34;</span><span>github:colinhacks/zod</span><span>&#34;</span><span>,</span></span>
<span><span>    </span><span>&#34;</span><span>lodash</span><span>&#34;</span><span>:</span><span> </span><span>&#34;</span><span>git@github.com:lodash/lodash.git#4.17.21</span><span>&#34;</span></span>
<span><span>  }</span></span>
<span><span>}</span></span>
<span></span></code></pre></div></div></div><p>You can also add a <code>git</code> dependency using <code>bun install</code>.</p><div><div><div><pre><code><span><span>bun install git@github.com:moment/moment.git</span></span>
<span></span></code></pre></div></div></div><h2 level="2" anchor-id="changes-to-settimeout"><a id="changes-to-settimeout"></a><a href="#changes-to-settimeout">Changes to <code>setTimeout()</code></a></h2><p>The Web standard <a href="https://developer.mozilla.org/en-US/docs/Web/API/setTimeout"><code>setTimeout()</code></a> returns a <code>number</code>, which represents a timeout ID. The Node.js implementation of <a href="https://nodejs.org/api/timers.html#cleartimeouttimeout"><code>setTimeout()</code></a> returns a <code>Timeout</code> object, which has methods like <code>ref()</code> and <code>unref()</code>, but is coercable to a <code>number</code>.</p><p>We (reluctantly) decided to change Bun&#39;s implementation to match Node.js because there are many <code>npm</code> packages that depend on this legacy behaviour.</p><div><div><div><pre><code><span><span>const</span><span> timeout </span><span>=</span><span> </span><span>setTimeout</span><span>(() </span><span>=&gt;</span><span> {</span></span>
<span><span>  process.</span><span>abort</span><span>(); </span><span>// this is not called, see `unref()` below</span></span>
<span><span>}, </span><span>1000</span><span>);</span></span>
<span></span>
<span><span>timeout.</span><span>unref</span><span>();</span></span>
<span></span>
<span><span>// For compatibility, it still works as a number</span></span>
<span><span>const</span><span> timeoutId </span><span>=</span><span> </span><span>+</span><span>timeout; </span><span>// 1</span></span>
<span></span></code></pre></div></div></div><p>We also improved the <code>console.log()</code> formatting of the <code>Timeout</code> object.</p><figure><a href="https://user-images.githubusercontent.com/709451/220816678-03ce091d-2e5b-47a8-8d0f-9bb15b561d3b.png"><img src="https://user-images.githubusercontent.com/709451/220816678-03ce091d-2e5b-47a8-8d0f-9bb15b561d3b.png" alt="image" width="456"/></a></figure><h2 level="2" anchor-id="abortsignal-with-fetch"><a id="abortsignal-with-fetch"></a><a href="#abortsignal-with-fetch"><code>AbortSignal</code> with <code>fetch()</code></a></h2><p>You can now cancel a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch"><code>fetch()</code></a> request using an <a href="https://developer.mozilla.org/en-US/docs/Web/API/AbortSignal"><code>AbortSignal</code></a>. This is useful for timeouts or when you need to cancel a request before a response is received.</p><div><div><div><pre><code><span><span>await</span><span> </span><span>fetch</span><span>(</span><span>&#34;</span><span>https://example.com</span><span>&#34;</span><span>, {</span></span>
<span><span>  </span><span>// Abort if the response is not received after 1 second</span></span>
<span><span>  signal</span><span>:</span><span> AbortSignal.</span><span>timeout</span><span>(</span><span>1000</span><span>),</span></span>
<span><span>});</span></span>
<span></span></code></pre></div></div></div><p>You can also use an <code>AbortSignal</code> when receiving a <code>Request</code> from the HTTP server.</p><div><div><div><pre><code><span><span>export</span><span> </span><span>default</span><span> {</span></span>
<span><span>  </span><span>async</span><span> </span><span>fetch</span><span>(</span><span>request</span><span>:</span><span> </span><span>Request</span><span>)</span><span>:</span><span> </span><span>Promise</span><span>&lt;</span><span>Response</span><span>&gt; {</span></span>
<span><span>    request.signal.</span><span>addEventListener</span><span>(</span><span>&#34;</span><span>abort</span><span>&#34;</span><span>, () </span><span>=&gt;</span><span> {</span></span>
<span><span>      console.</span><span>log</span><span>(</span><span>&#34;</span><span>Client aborted the request</span><span>&#34;</span><span>);</span></span>
<span><span>    });</span></span>
<span><span>    </span><span>// ...</span></span>
<span><span>    </span><span>return</span><span> </span><span>new</span><span> </span><span>Response</span><span>();</span></span>
<span><span>  },</span></span>
<span><span>};</span></span>
<span></span></code></pre></div></div></div><h2 level="2" anchor-id="bun-wiptest-is-now-bun-test"><a id="bun-wiptest-is-now-bun-test"></a><a href="#bun-wiptest-is-now-bun-test"><code>bun wiptest</code> is now <code>bun test</code></a></h2><p>It&#39;s time for <code>bun wiptest</code> to graduate to <code>bun test</code>.</p><h3 level="3" anchor-id="pretty-printed-diffs"><a id="pretty-printed-diffs"></a><a href="#pretty-printed-diffs">Pretty-printed diffs</a></h3><p><code>bun test</code> now supports pretty-printed diffs, thanks to <a href="https://github.com/dylan-conway">@dylan-conway</a> for implementing and <a href="https://github.com/SuperAuguste">@SuperAuguste</a> for porting the <a href="https://github.com/google/diff-match-patch">diff-match-patch</a> algorithm to Zig.</p><p><strong>Now:</strong></p><div><div><div><pre><code><span><span>error: </span><span>expect</span><span>(received).</span><span>toEqual</span><span>(expected)</span></span>
<span></span>
<span><span>  {</span></span>
<span><span>    abc: </span><span>123</span><span>,</span></span>
<span><span>+</span><span>   def: </span><span>456</span></span>
<span><span>-</span><span>   def: </span><span>789</span></span>
<span><span>  }</span></span>
<span></span>
<span><span>-</span><span> Expected  </span><span>-</span><span> </span><span>1</span></span>
<span><span>+</span><span> Received  </span><span>+</span><span> </span><span>1</span></span>
<span></span></code></pre></div></div></div><p><strong>Before:</strong></p><div><div><div><pre><code><span><span>error: Expected values to be equal:</span></span>
<span><span>	Expected: {</span></span>
<span><span>  abc: </span><span>123</span><span>,</span></span>
<span><span>  def: </span><span>789</span></span>
<span><span>}</span></span>
<span><span>	Received: {</span></span>
<span><span>  abc: </span><span>123</span><span>,</span></span>
<span><span>  def: </span><span>456</span></span>
<span><span>}</span></span>
<span></span></code></pre></div></div></div><h3 level="3" anchor-id="auto-import-for-jest-globals"><a id="auto-import-for-jest-globals"></a><a href="#auto-import-for-jest-globals">Auto-import for <code>jest</code> globals</a></h3><p><code>bun test</code> now automatically imports <a href="https://jestjs.io/docs/api#testname-fn-timeout"><code>test()</code></a> and <a href="https://jestjs.io/docs/expect#expectvalue"><code>expect()</code></a>. This also works for the other Jest globals, including: <code>describe</code>, <code>beforeAll</code>, <code>afterAll</code>, and more.</p><div><div><div><pre><code><span><span>// import { test, expect } from &#34;bun:test&#34;;</span></span>
<span></span>
<span><span>test</span><span>(</span><span>&#34;</span><span>that it auto-imports expect()</span><span>&#34;</span><span>, () </span><span>=&gt;</span><span> {</span></span>
<span><span>  </span><span>expect</span><span>({</span></span>
<span><span>    abc</span><span>:</span><span> </span><span>123</span><span>,</span></span>
<span><span>    def</span><span>:</span><span> </span><span>456</span><span>,</span></span>
<span><span>  }).</span><span>toEqual</span><span>({</span></span>
<span><span>    abc</span><span>:</span><span> </span><span>123</span><span>,</span></span>
<span><span>    def</span><span>:</span><span> </span><span>789</span><span>,</span></span>
<span><span>  });</span></span>
<span><span>});</span></span>
<span></span></code></pre></div></div></div><p>We still recommended that you import from <code>bun:test</code>, but if you have existing tests using Jest, you probably rely on its globals.</p><h2 level="2" anchor-id="new-methods-on-set"><a id="new-methods-on-set"></a><a href="#new-methods-on-set">New methods on <code>Set</code></a></h2><p>The <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set"><code>Set</code></a> class now has <a href="https://github.com/tc39/proposal-set-methods">more built-in</a> methods, thanks to <a href="https://github.com/kmiller68">@kmiller68</a> at WebKit.</p><div><div><div><pre><code><span><span>const</span><span> a </span><span>=</span><span> </span><span>new</span><span> </span><span>Set</span><span>([</span><span>1</span><span>, </span><span>2</span><span>, </span><span>3</span><span>]);</span></span>
<span><span>const</span><span> b </span><span>=</span><span> </span><span>new</span><span> </span><span>Set</span><span>([</span><span>1</span><span>, </span><span>3</span><span>, </span><span>4</span><span>, </span><span>5</span><span>]);</span></span>
<span><span>const</span><span> c </span><span>=</span><span> </span><span>new</span><span> </span><span>Set</span><span>([</span><span>1</span><span>, </span><span>3</span><span>]);</span></span>
<span></span>
<span><span>console.</span><span>log</span><span>(a.</span><span>union</span><span>(b)); </span><span>// [1, 2, 3, 4, 5]</span></span>
<span><span>console.</span><span>log</span><span>(a.</span><span>intersection</span><span>(b)); </span><span>// [1, 3]</span></span>
<span><span>console.</span><span>log</span><span>(a.</span><span>difference</span><span>(b)); </span><span>// [2]</span></span>
<span><span>console.</span><span>log</span><span>(a.</span><span>symmetricDifference</span><span>(b)); </span><span>// [2, 4, 5]</span></span>
<span></span></code></pre></div></div></div><h2 level="2" anchor-id="aws-lambda-support"><a id="aws-lambda-support"></a><a href="#aws-lambda-support">AWS Lambda support</a></h2><p>Bun can now run AWS Lambda using a <a href="https://github.com/oven-sh/bun/tree/main/packages/bun-lambda#bun-lambda">custom layer.</a></p><p>The layer will detect when an event is an HTTP request and transform it into a standard <a href="https://developer.mozilla.org/en-US/docs/Web/API/Request"><code>Request</code></a>. This means you can test your Lambda locally using <code>bun run</code>, without any code changes.</p><div><div><div><pre><code><span><span>export</span><span> </span><span>default</span><span> {</span></span>
<span><span>  </span><span>async</span><span> </span><span>fetch</span><span>(</span><span>request</span><span>:</span><span> </span><span>Request</span><span>)</span><span>:</span><span> </span><span>Promise</span><span>&lt;</span><span>Response</span><span>&gt; {</span></span>
<span><span>    console.</span><span>log</span><span>(request.headers.</span><span>get</span><span>(</span><span>&#34;</span><span>x-amzn-function-arn</span><span>&#34;</span><span>));</span></span>
<span><span>    </span><span>// ...</span></span>
<span><span>    </span><span>return</span><span> </span><span>new</span><span> </span><span>Response</span><span>(</span><span>&#34;</span><span>Hello from Lambda!</span><span>&#34;</span><span>, {</span></span>
<span><span>      status</span><span>:</span><span> </span><span>200</span><span>,</span></span>
<span><span>      headers</span><span>:</span><span> {</span></span>
<span><span>        </span><span>&#34;</span><span>Content-Type</span><span>&#34;</span><span>:</span><span> </span><span>&#34;</span><span>text/plain</span><span>&#34;</span><span>,</span></span>
<span><span>      },</span></span>
<span><span>    });</span></span>
<span><span>  },</span></span>
<span><span>};</span></span>
<span></span></code></pre></div></div></div><p>For events that are not HTTP requests, like a S3 or SQS trigger, the event will be in the body of the <code>Request</code>.</p><div><div><div><pre><code><span><span>export</span><span> </span><span>default</span><span> {</span></span>
<span><span>  </span><span>async</span><span> </span><span>fetch</span><span>(</span><span>request</span><span>:</span><span> </span><span>Request</span><span>)</span><span>:</span><span> </span><span>Promise</span><span>&lt;</span><span>Response</span><span>&gt; {</span></span>
<span><span>    </span><span>const</span><span> event </span><span>=</span><span> </span><span>await</span><span> request.</span><span>json</span><span>();</span></span>
<span><span>    </span><span>// ...</span></span>
<span><span>    </span><span>return</span><span> </span><span>new</span><span> </span><span>Response</span><span>();</span></span>
<span><span>  },</span></span>
<span><span>};</span></span>
<span></span></code></pre></div></div></div><h2 level="2" anchor-id="github-action-support"><a id="github-action-support"></a><a href="#github-action-support">GitHub Action support</a></h2><p>There is a new release of the <a href="https://github.com/oven-sh/setup-bun"><code>setup-bun</code></a> GitHub Action, which you can also <a href="https://github.com/marketplace/actions/setup-bun">find</a> on the GitHub Marketplace. Thanks to <a href="https://github.com/xHyroM">@xHyroM</a> for maintaining the initial version of it.</p><div><div><div><pre><code><span><span>-</span><span> </span><span>uses</span><span>:</span><span> </span><span>oven-sh/setup-bun@v1</span></span>
<span><span>  </span><span>with</span><span>:</span></span>
<span><span>    </span><span>bun-version</span><span>:</span><span> </span><span>latest</span></span>
<span></span></code></pre></div></div></div><div><div><div><pre><code><span><span>-</span><span> </span><span>uses</span><span>:</span><span> </span><span>oven-sh/setup-bun@v1</span></span>
<span><span>  </span><span>with</span><span>:</span></span>
<span><span>    </span><span>bun-version</span><span>:</span><span> </span><span>&#34;</span><span>0.5.7</span><span>&#34;</span></span>
<span></span></code></pre></div></div></div><p>Now, with the newly added support for <code>git</code> dependencies, we encourage you to try this out in your GitHub CI and see much time you can save with <code>bun install</code>.</p><div><div><div><pre><code><span><span>steps:</span></span>
<span><span>  - uses: actions/checkout@v3</span></span>
<span><span>  - uses: actions/setup-node@v3</span></span>
<span><span>    with:</span></span>
<span><span>      node-version: 16</span></span>
<span><span>+ - uses: oven-sh/setup-bun@v1</span></span>
<span><span>+   with:</span></span>
<span><span>+     bun-version: latest</span></span>
<span><span>+  - run: bun install</span></span>
<span><span>-  - run: npm install</span></span>
<span></span></code></pre></div></div></div><h2 level="2" anchor-id="changelog"><a id="changelog"></a><a href="#changelog">Changelog</a></h2></article></div></section>

</div>
  </body>
</html>
