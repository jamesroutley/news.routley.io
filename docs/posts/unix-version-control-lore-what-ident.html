<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://dotat.at/@/2024-05-13-what-ident.html">Original</a>
    <h1>Unix version control lore: what, ident</h1>
    
    <div id="readability-page-1" class="page"><article>
  <p>There are a couple of version control commands that deserve wider
appreciation: <a href="https://pubs.opengroup.org/onlinepubs/9699919799/utilities/what.html">SCCS <code>what</code></a> and <a href="https://www.gnu.org/software/rcs/manual/html_node/ident.html">RCS <code>ident</code></a>. They allow
you to find out what source a binary was built from, without having to
run it – handy if it is a library! They basically scan a file looking
for magic strings that contain version control metadata and print out
what they discover.</p>
<h2 id="keyword-expansion">keyword expansion</h2>
<p>SCCS, RCS, <code>cvs</code>, and <code>svn</code> all have a way to expand keywords in a
file when it is checked out of version control.</p>
<p>The POSIX <a href="https://pubs.opengroup.org/onlinepubs/9699919799/utilities/get.html#tag_20_52_13_02">SCCS <code>get</code></a> documentation describes its runes under
the “identification keywords” heading. The relevant one is <code>%W%</code> which
inserts the magic marker <code>@(#)</code> used by <code>what</code>.</p>
<p><a href="https://www.gnu.org/software/trans-coord/manual/cvs/cvs.html#Keyword-substitution">RCS / <code>cvs</code> / <code>svn</code> keyword substitution</a> uses more descriptive
markers like <code>$Revision$</code>.</p>
<h2 id="a-berkeley-example">a berkeley example</h2>
<p>It was a lonstanding BSD practice to use keyword expansion everywhere.
I first encountered it when I got involved in the Apache httpd project
in the late 1990s – Apache’s CVS repository was hosted on a FreeBSD
box and used a version of FreeBSD’s CVS administrative scripts.</p>
<p>Here’s an example from <a href="https://cgit.freebsd.org/src/tree/lib/libc/resolv/res_send.c?id=e45764721aedfa6460e1767664864bda9457c10e"><code>res_send.c</code></a> in FreeBSD’s libc
resolver.</p>
<pre><code>static const char sccsid[] = &#34;@(#)res_send.c	8.1 (Berkeley) 6/4/93&#34;;
static const char rcsid[] = &#34;$Id: res_send.c,v 1.22 2009/01/22 23:49:23 tbox Exp $&#34;;
__FBSDID(&#34;$FreeBSD$&#34;);
</code></pre>
<p>There are geological strata of version control ident strings here:</p>
<ul>
<li>the <code>sccsid</code> from the Berkeley CSRG SCCS repository</li>
<li>the <code>rcsid</code> from ISC’s BIND repository
(<code>tbox</code> was ISC’s tinderbox build / CI system)</li>
<li>the <code>FBSDID</code> from FreeBSD’s <code>cvs</code> and later <code>svn</code> repositories
(which has not been expanded)</li>
</ul>
<h2 id="an-unifdef-example">an unifdef example</h2>
<p>When <code>unifdef</code> was uplifted to git, I wanted to keep its embedded
version control keywords – I have a sentimental liking for this old
tradition. If you’ve installed <a href="https://www.gnu.org/software/cssc/"><code>cssc</code></a>, <code>rcs</code>, and <code>unifdef</code> on
a Debian box, you can run,</p>
<pre><code>    :; sccs what /usr/bin/unifdef
    :; ident /usr/bin/unifdef
</code></pre>
<p>Both of those will produce similar output to</p>
<pre><code>    :; unifdef -V
</code></pre>
<p>On a Mac with the developer command-line tools installed,</p>
<pre><code>    :; what /Library/Developer/CommandLineTools/usr/bin/unifdef
</code></pre>
<p>You get the output twice because it’s a fat binary!</p>
<h2 id="versioning-three-ways">versioning three ways</h2>
<p>In <a href="https://dotat.at/cgi/git/unifdef.git/blob/HEAD:/unifdef.c"><code>unifdef.c</code></a>, the embedded version string looks like,</p>
<pre><code>    static const char copyright[] =
        &#34;@(#) $Version: unifdef-2.12 $\n&#34;
        &#34;@(#) $Date: 2020-02-14 16:49:56 +0000 $\n&#34;
        &#34;@(#) $Author: Tony Finch (dot@dotat.at) $\n&#34;
        &#34;@(#) $URL: http://dotat.at/prog/unifdef $\n&#34;
    ;
</code></pre>
<p>Each line is prefixed with an SCCS magic marker <code>@(#)</code> so that <code>what</code>
can find it, and wrapped in an RCS-style <code>$Keyword$</code> so that <code>ident</code>
can find it. There’s a fairly trivial <code>version()</code> function that
spits out the <code>copyright[]</code> string when you run <code>unifdef -V</code>.</p>
<h2 id="embedding-versions-from-git">embedding versions from git</h2>
<p>My projects have various horrible build scripts for embedding the
version number from <code>git</code>. The basic idea is,</p>
<ul>
<li>
<p>use an annotated or signed tag to mark a release,
i.e. <code>git tag -a</code> or <code>git tag -s</code></p>
</li>
<li>
<p>use <code>git describe</code> to get a version string that includes an
extra number counting commits since the last release</p>
</li>
<li>
<p>maybe use <code>git show --pretty=format:%ai -s HEAD</code> to get a release date</p>
</li>
<li>
<p>stuff the outputs from <code>git</code> into the <code>$Version$</code> and <code>$Date$</code> RCS
keywords</p>
</li>
</ul>
<h2 id="retro-cool">retro cool</h2>
<p>I enjoy keeping this old feature working, even though it isn’t very
useful if no-one knows about it! Maybe if I blog about it, it’ll
become more widespread?</p>

</article></div>
  </body>
</html>
