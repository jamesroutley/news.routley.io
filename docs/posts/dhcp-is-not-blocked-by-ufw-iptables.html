<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://unix.stackexchange.com/questions/447440/ufw-iptables-not-blocking-dhcp-udp-port-67#447524">Original</a>
    <h1>DHCP is not blocked by ufw/iptables</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="text">
<blockquote>
  <blockquote>
    <p>I was too dump to open up the proper ports on my firewall before I started testing out my shiny new DHCP server, and it took a moment to dawn on me that it shouldn&#39;t work yet. I never opened port 67 on my server&#39;s firewall.</p>
  </blockquote>
  
  <p>...</p>
  
  <p>The simple answer is that DHCP is indeed special. To quote what a stranger quoted,</p>
  
  <p>Per Mark Andrews of isc.org:</p>
  
  <p>&#34;DHCP uses packet filters and these tie into the IP stack before the firewall.&#34;</p>
  
  <p><a href="https://web.archive.org/web/20160202202151/thr3ads.net/netfilter-buglog/2011/07/1961358-Bug-730-New-DHCP-request-and-other-traffic-bypasses-iptables-netfilter" rel="noreferrer">http://thr3ads.net/netfilter-buglog/2011/07/1961358-Bug-730-New-DHCP-request-and-other-traffic-bypasses-iptables-netfilter</a></p>
</blockquote>

<p>-- <a href="https://www.centos.org/forums/viewtopic.php?t=8728" rel="noreferrer">https://www.centos.org/forums/viewtopic.php?t=8728</a></p>

<hr/>

<p>It&#39;s often stated that this is because the DHCP server uses raw sockets.  I think this phrasing is quite confusing.  Some official ISC docs for their DHCP server use &#34;raw sockets&#34; as a broad term, because it can run on a number of different platforms where it must use a number of different interfaces.  On Linux, there is more than one type that you might hear referred to as raw sockets.  <em>Some are affected by Linux iptables, and some are not affected by Linux iptables</em>.</p>

<p>I&#39;m confident that Linux&#39; TCP/IP stack imposes some restrictions when sending packets with PF_INET+SOCK_RAW.  My vague memory was that DHCP on Linux does not necessarily work with that type of socket, and might need to use &#34;packet sockets&#34; instead.  Packet sockets work at a lower level.  I&#39;m confident that packet sockets are not affected by iptables.</p>

<blockquote>
  <p>PF_PACKET sockets bypass the TCP/IP stack.</p>
  
  <p>PF_INET/SOCK_RAW sockets still travers the TCP/IP stack.</p>
</blockquote>

<p>-- <a href="https://lists.netfilter.org/pipermail/netfilter-devel/2003-March/010845.html" rel="noreferrer">https://lists.netfilter.org/pipermail/netfilter-devel/2003-March/010845.html</a></p>

<p>This quote was written in the context of receiving packets. There is also evidence that this applies to sending packets, as you might expect.</p>

<hr/>

<p>It seems that iptables is one of the restrictions that applies to the TCP/IP stack, including to sending with PF_INET+SOCK_RAW.</p>

<blockquote>
  <blockquote>
    <p>If I have a an IP datagram in userspace and I send it via a raw socket
    created with socket(PF_INET, SOCK_RAW, IPPROTO_RAW) using the send()
    system call, will this packet traverse the netfilter chains?</p>
  </blockquote>
  
  <p>...</p>
  
  <p>looks like good news:</p>

<pre><code>ipt_hook: happy cracking.
ipt_hook: happy cracking.
ipt_hook: happy cracking.
ipt_tcpmss_target: bad length (10 bytes)
</code></pre>
  
  <p>So your packets will traverse iptables.</p>
</blockquote>

<p><a href="https://lists.netfilter.org/pipermail/netfilter-devel/2003-March/010829.html" rel="noreferrer">https://lists.netfilter.org/pipermail/netfilter-devel/2003-March/010829.html</a></p>

<p>And the evidence for the receive direction:</p>

<blockquote>
  <p>It turns out that using raw sockets
  gives me the packets post-NAT so the IP addresses are back in the
  private range (10.x.x.x in my example). Maybe this is common knowledge
  but I&#39;ve struggled to find it documented. If I use libpcap/tcpdump I
  get packets pre-NAT</p>
</blockquote>

<p>[NAT is performed by iptables]</p>

<p>-- <a href="https://lists.gt.net/iptables/user/62529#62529" rel="noreferrer">https://lists.gt.net/iptables/user/62529#62529</a></p>

<hr/>

<p>Bonus griping: I <em>think</em> the term &#34;packet filter&#34; in my initial quote is a straight out abuse, albeit a long-standing one.  Berkeley Packet Filter is a mechanism used to install a filter on a raw socket, e.g. so that it only receives packets on the DHCP port.  I think ISC at times refer to &#34;Linux Packet Filter&#34; as if it was a type of raw socket itself.  It&#39;s not, and you can actually use BPF on normal UDP or TCP sockets.</p>
    </div></div>
  </body>
</html>
