<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tracebit.com/blog/2024/02/finding-aws-account-id-of-any-s3-bucket/">Original</a>
    <h1>It&#39;s now possible to find the AWS Account ID for any S3 Bucket (private too)</h1>
    
    <div id="readability-page-1" class="page"><article><p>In 2021 <a href="https://twitter.com/benbridts">Ben Bridts</a> published a <a href="https://cloudar.be/awsblog/finding-the-account-id-of-any-public-s3-bucket/">highly inventive method</a> for finding the AWS Account ID of a public S3 bucket.</p><p><strong>This post describes a technique to find the Account ID of <em>any S3 bucket</em> (both private and public).</strong></p><p>I&#39;d highly recommend reading Ben&#39;s technique first as we will re-use a lot of concepts.</p><h3>S3 Bucket to AWS Account ID</h3><p>Shell output can be worth a thousand words, here&#39;s what our technique enables - finding the previously unknown AWS Account ID for the bucket <code>bucket-alpha</code>:</p><pre><code>sh-5.2$ python3 find-s3-account.py bucket-alpha

VPC endpoint vpce-0e76855aadb0dafb5 policy already configured
Requesting bucket-alpha using session name 0-----------
Requesting bucket-alpha using session name 1-----------
Requesting bucket-alpha using session name 2-----------
Requesting bucket-alpha using session name 3-----------

SNIP

Requesting bucket-alpha using session name -----------7
Requesting bucket-alpha using session name -----------8
Requesting bucket-alpha using session name -----------9
Finding session names which passed the VPC endpoint in CloudTrail...
Found -----------1 for bucket-alpha in CloudTrail
Found ---------1-- for bucket-alpha in CloudTrail
Found --------9--- for bucket-alpha in CloudTrail
Found -----6------ for bucket-alpha in CloudTrail
Found --3--------- for bucket-alpha in CloudTrail
Found -2---------- for bucket-alpha in CloudTrail
Found 1----------- for bucket-alpha in CloudTrail
Found ----------0- for bucket-alpha in CloudTrail
Found -------8---- for bucket-alpha in CloudTrail
Found ------7----- for bucket-alpha in CloudTrail
Found ----5------- for bucket-alpha in CloudTrail
Found ---4-------- for bucket-alpha in CloudTrail
Bucket bucket-alpha: 123456789101</code></pre><h3>How exactly does this work?</h3><p>When exploring possibilities for this technique, I started by breaking down exactly why Ben&#39;s method works. There are three key elements which combine to make it work:</p><ol><li><strong>The ability to apply an IAM policy to the request</strong></li></ol><p>In the Ben&#39;s technique, this is achieved by applying a custom policy when assuming the role.</p><ol start="2"><li><strong>The ability to infer whether this IAM policy permitted the request or not</strong></li></ol><p>In the case of public buckets, this is quite simple. If our policy blocked the request, the request will fail with <code>AccessDenied</code>. Otherwise, the request will succeed as expected with requests to public buckets.</p><ol start="3"><li><strong>The ability to apply a wildcard match on the <code>s3:ResourceAccount</code> condition key</strong></li></ol><p>This allows us to discover the Account ID incrementally, one digit at a time, reducing the search space from trillions to hundreds.</p><h3>A solution</h3><p>After exploring a few different ideas, I found a solution which works. It involves using a VPC Endpoint for S3, and a difference of behaviour in CloudTrail when a request is denied by a VPC Endpoint policy.</p><p><a href="#img700414"><img src="https://tracebit.com/img/blog/2024/02/cloudtrail-and-vpc-endpoint-policy.png" alt="How VPC Endpoint policies interact with CloudTrail" title="How VPC Endpoint policies interact with CloudTrail"/></a></p><ol><li><strong>The ability to apply an IAM policy to the request</strong></li></ol><p>Creating a VPC Endpoint of type &#34;Interface&#34; for S3 will allow us to apply an IAM policy to the request. This policy intersects with the other policies which apply to the request (e.g. the bucket policy, the IAM policy of the principal making the request etc) when the request is made through the VPC Endpoint.</p><ol start="2"><li><strong>The ability to infer whether this IAM policy permitted the request or not</strong></li></ol><p>As the target bucket is owned by a third party and is a private bucket, we&#39;re (thankfully) going to receive an <code>AccessDenied</code> response, regardless of whichever policies we apply to the request. However, we can infer whether the VPC Endpoint policy blocked or permitted the request by whether it appears in <em>our own</em> CloudTrail logs.</p><ul><li>If the request <em>does</em> appear in our CloudTrail logs, it was permitted by our VPC Endpoint policy but blocked as expected by the bucket policy.</li><li>If the request <em>does not</em> appear in our CloudTrail logs, it was blocked by our VPC Endpoint policy.</li></ul><ol start="3"><li><strong>The ability to apply a wildcard match on the <code>s3:ResourceAccount</code> condition key</strong></li></ol><p>We can use the full power of IAM policy conditions, including <code>StringLike</code> wildcards and resource condition keys in a VPC Endpoint policy, so the same basic technique will work here.</p><h3>Step-by-step</h3><p>Let&#39;s say that we want to find the Account ID of the bucket <code>bucket-alpha</code>.</p><p><strong>Note that some of our activities here will be visible to the owner of the bucket in their own CloudTrail logs.</strong></p><h4>Determine the bucket region</h4><p>We need to find the region in which the bucket lives so that we can create a VPC in the same region. This can be done by curling the bucket&#39;s HTTP endpoint and examining the <code>x-amz-bucket-region</code> header (which is returned despite the request being forbidden).</p><pre><code><span>curl</span> <span>-v</span> bucket-alpha.s3.amazonaws.com

<span>..</span>.
x-amz-bucket-region: us-east-1</code></pre><h4>Deploy a VPC and VPC Endpoint in the same region</h4><p>We need to deploy a VPC and a VPC Endpoint for S3 in the same region as the target bucket. It&#39;s best to create a VPC specifically for this purpose as our VPC Endpoint will interfere with requests to S3 from the VPC. The VPC Endpoint should be of type &#34;Interface&#34; so we can apply a policy to the request.</p><h4>Launch an EC2 instance within the VPC and confirm that it&#39;s using the VPC Endpoint for S3</h4><p>We&#39;ll need to send requests to S3 from within the VPC so that the VPC Endpoint is used. An EC2 instance is a convenient way of doing so.</p><h4>Modify the VPC Endpoint policy to determine whether the account ID of the target bucket starts with &#34;0&#34;</h4><p>Apply a policy to the VPC Endpoint which performs a wildcard match on the <code>s3:ResourceAccount</code> condition key. This will only permit requests through the endpoint if the bucket&#39;s Account ID starts with &#34;0&#34;.</p><pre><code><span>{</span>
    <span>&#34;Version&#34;</span><span>:</span> <span>&#34;2012-10-17&#34;</span><span>,</span>
    <span>&#34;Statement&#34;</span><span>:</span> <span>[</span>
        <span>{</span>
            <span>&#34;Action&#34;</span><span>:</span> <span>&#34;s3:*&#34;</span><span>,</span>
            <span>&#34;Effect&#34;</span><span>:</span> <span>&#34;Allow&#34;</span><span>,</span>
            <span>&#34;Resource&#34;</span><span>:</span> <span>&#34;*&#34;</span><span>,</span>
            <span>&#34;Principal&#34;</span><span>:</span> <span>&#34;*&#34;</span><span>,</span>
            <span>&#34;Condition&#34;</span><span>:</span> <span>{</span>
                <span>&#34;StringLike&#34;</span><span>:</span> <span>{</span>
                    <span>&#34;s3:ResourceAccount&#34;</span><span>:</span> <span>&#34;0*&#34;</span>
                <span>}</span>
            <span>}</span>
        <span>}</span>
    <span>]</span>
<span>}</span></code></pre><h4>Make a request to the target bucket</h4><p>Via the EC2 instance, make a request to the target bucket. This request will be denied as expected. It&#39;s best to use a &#34;Management&#34; request rather than a &#34;Data&#34; request so we don&#39;t need to do anything special with our CloudTrail setup. In this case I used <code>GetBucketAcl</code>.</p><pre><code>aws s3api get-bucket-acl <span>--bucket</span> bucket-alpha

An error occurred <span>(</span>AccessDenied<span>)</span> when calling the GetBucketAcl operation: Access Denied</code></pre><h4>Check whether the request appears in CloudTrail</h4><p>Now we want to check whether our request appears in CloudTrail.</p><pre><code>aws cloudtrail lookup-events --lookup-attributes <span>AttributeKey</span><span>=</span>EventName,AttributeValue<span>=</span>GetBucketAcl --start-time <span><span>$(</span><span>date</span> <span>-d</span> <span>&#34;-10 minutes&#34;</span> +%s<span>)</span></span></code></pre><p>If we find our request in CloudTrail, it means that the VPC Endpoint policy permitted the request - i.e. the Account ID of the bucket starts with <code>0</code>. If we don&#39;t find the request, then the VPC Endpoint policy blocked the request - i.e. the Account ID of the bucket does not start with <code>0</code>.</p><pre><code><span>{</span>
    <span>&lt;</span>SNIP<span>&gt;</span>
    <span>&#34;eventSource&#34;</span><span>:</span> <span>&#34;s3.amazonaws.com&#34;</span>,
    <span>&#34;eventName&#34;</span><span>:</span> <span>&#34;GetBucketAcl&#34;</span>,
    <span>&#34;resources&#34;</span><span>:</span> <span>[</span>
        <span>{</span>
            <span>&#34;accountId&#34;</span><span>:</span> <span>&#34;HIDDEN_DUE_TO_SECURITY_REASONS&#34;</span>,
            <span>&#34;type&#34;</span><span>:</span> <span>&#34;AWS::S3::Bucket&#34;</span>,
            <span>&#34;ARN&#34;</span><span>:</span> <span>&#34;arn:aws:s3:::bucket-alpha&#34;</span>
        <span>}</span>
    <span>]</span>,
    <span>&#34;vpcEndpointId&#34;</span><span>:</span> <span>&#34;vpce-0e76855aadb0dafb5&#34;</span>,
<span>}</span></code></pre><p>Bear in mind that it will take a few minutes for the request to appear in CloudTrail. To be safe, I&#39;d recommend waiting a 10 minutes before deciding the event won&#39;t appear in CloudTrail.</p><h4>Rinse and repeat</h4><p>Depending on the result of the previous step, modify the VPC Endpoint policy to discover more information about the account ID. For instance, if the event <em>didn&#39;t</em> appear in CloudTrail, modify the condition to test whether the first digit is <code>1</code>:</p><pre><code><span>&#34;Condition&#34;</span><span>:</span> <span>{</span>
    <span>&#34;StringLike&#34;</span><span>:</span> <span>{</span>
        <span>&#34;s3:ResourceAccount&#34;</span><span>:</span> <span>&#34;1*&#34;</span>
    <span>}</span>
<span>}</span></code></pre><p>If it <em>did</em> appear in CloudTrail (so the first digit of the account ID is <code>0</code>), we can start work on the second digit:</p><pre><code><span>&#34;Condition&#34;</span><span>:</span> <span>{</span>
    <span>&#34;StringLike&#34;</span><span>:</span> <span>{</span>
        <span>&#34;s3:ResourceAccount&#34;</span><span>:</span> <span>&#34;00*&#34;</span>
    <span>}</span>
<span>}</span></code></pre><p>Bear it mind, it takes a few minutes for policy changes to fully propagate and take effect. I&#39;ve found waiting 5 minutes after modifying the policy to work well.</p><h3>Results</h3><p>I wrote a script to automate this process and it could reliably find the Account ID of a bucket. As it&#39;s quite a slow process, I used a slightly modified technique of performing a binary search on each digit so fewer tests were needed, e.g:</p><pre><code><span>&#34;Condition&#34;</span><span>:</span> <span>{</span>
    <span>&#34;StringLike&#34;</span><span>:</span> <span>{</span>
        <span>&#34;s3:ResourceAccount&#34;</span><span>:</span> <span>[</span><span>&#34;0*&#34;</span><span>,</span> <span>&#34;1*&#34;</span><span>,</span> <span>&#34;2*&#34;</span><span>,</span> <span>&#34;3*&#34;</span><span>,</span> <span>&#34;4*&#34;</span><span>]</span>
    <span>}</span>
<span>}</span></code></pre><p>Leaving it for a few hours returned the account ID successfully:</p><pre><code>[ssm-user@ip-172-31-8-184 ~]$ python3 find-s3-account.py bucket-alpha
Searching for bucket bucket-alpha
Modifying VPC endpoint policy...
Modified VPC endpoint policy
Made S3 request to bucket: GPSWS2M4TH9ABX3C
Looking for event in CloudTrail...
Did not find event in CloudTrail (not permitted through VPC endpoint)
State: {&#39;found&#39;: &#39;&#39;, &#39;next_digits&#39;: [0, 1, 2, 3, 4]}
Modifying VPC endpoint policy...
Modified VPC endpoint policy
Made S3 request to bucket: 8T809NPVDGQSGB1N
Looking for event in CloudTrail...
Did not find event in CloudTrail (not permitted through VPC endpoint)
State: {&#39;found&#39;: &#39;&#39;, &#39;next_digits&#39;: [0, 1]}
Modifying VPC endpoint policy...
Modified VPC endpoint policy
Made S3 request to bucket: C9F0RTC7QK0G70TB
Looking for event in CloudTrail...
Found event in CloudTrail (permitted through VPC endpoint)
State: {&#39;found&#39;: &#39;1&#39;, &#39;next_digits&#39;: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]}

...

State: {&#39;found&#39;: &#39;123456789101&#39;, &#39;next_digits&#39;: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]}
Found account: 123456789101</code></pre><h3>Making it faster</h3><p>Waiting for the VPC Endpoint policy to take effect, and waiting for long enough to determine whether the request appears in CloudTrail is quite a slow process. Even using a binary search, it will take approximately (40 * 12 minutes = 8 hours) to find the Account ID.</p><p>To make this process faster, and eliminate the need to wait between each step, I modified the VPC endpoint policy like so:</p><pre><code><span>{</span>
    <span>&#34;Version&#34;</span><span>:</span> <span>&#34;2012-10-17&#34;</span><span>,</span>
    <span>&#34;Statement&#34;</span><span>:</span> <span>[</span>
      <span>{</span>
        <span>&#34;Effect&#34;</span><span>:</span> <span>&#34;Allow&#34;</span><span>,</span>
        <span>&#34;Action&#34;</span><span>:</span> <span>[</span>
          <span>&#34;s3:*&#34;</span>
        <span>]</span><span>,</span>
        <span>&#34;Resource&#34;</span><span>:</span> <span>&#34;*&#34;</span><span>,</span>
        <span>&#34;Principal&#34;</span><span>:</span> <span>&#34;*&#34;</span><span>,</span>
        <span>&#34;Condition&#34;</span><span>:</span> <span>{</span>
          <span>&#34;StringLike&#34;</span><span>:</span> <span>{</span>
            <span>&#34;aws:userid&#34;</span><span>:</span> <span>&#34;*:0-----------&#34;</span><span>,</span>
            <span>&#34;s3:ResourceAccount&#34;</span><span>:</span> <span>&#34;0???????????&#34;</span>
          <span>}</span>
        <span>}</span>
      <span>}</span><span>,</span>
      <span>{</span>
        <span>&#34;Effect&#34;</span><span>:</span> <span>&#34;Allow&#34;</span><span>,</span>
        <span>&#34;Action&#34;</span><span>:</span> <span>[</span>
          <span>&#34;s3:*&#34;</span>
        <span>]</span><span>,</span>
        <span>&#34;Resource&#34;</span><span>:</span> <span>&#34;*&#34;</span><span>,</span>
        <span>&#34;Principal&#34;</span><span>:</span> <span>&#34;*&#34;</span><span>,</span>
        <span>&#34;Condition&#34;</span><span>:</span> <span>{</span>
          <span>&#34;StringLike&#34;</span><span>:</span> <span>{</span>
            <span>&#34;aws:userid&#34;</span><span>:</span> <span>&#34;*:1-----------&#34;</span><span>,</span>
            <span>&#34;s3:ResourceAccount&#34;</span><span>:</span> <span>&#34;1???????????&#34;</span>
          <span>}</span>
        <span>}</span>
      <span>}</span><span>,</span>
      SNIP
      <span>{</span>
        <span>&#34;Effect&#34;</span><span>:</span> <span>&#34;Allow&#34;</span><span>,</span>
        <span>&#34;Action&#34;</span><span>:</span> <span>[</span>
          <span>&#34;s3:*&#34;</span>
        <span>]</span><span>,</span>
        <span>&#34;Resource&#34;</span><span>:</span> <span>&#34;*&#34;</span><span>,</span>
        <span>&#34;Principal&#34;</span><span>:</span> <span>&#34;*&#34;</span><span>,</span>
        <span>&#34;Condition&#34;</span><span>:</span> <span>{</span>
          <span>&#34;StringLike&#34;</span><span>:</span> <span>{</span>
            <span>&#34;aws:userid&#34;</span><span>:</span> <span>&#34;*:-----------9&#34;</span><span>,</span>
            <span>&#34;s3:ResourceAccount&#34;</span><span>:</span> <span>&#34;???????????9&#34;</span>
          <span>}</span>
        <span>}</span>
      <span>}</span>
    <span>]</span>
<span>}</span></code></pre><p>There are 120 statements in the policy - one for each possible digit in each possible position. The condition on <code>aws:userid</code> is used to match particular values of the <code>RoleSessionName</code> parameter (which we can freely specify) used in an STS <code>AssumeRole</code> call. In effect this means we can selectively choose which policy statement (i.e. a particular digit in a particular position) we want to test for each request, by assuming a role with a particular <code>RoleSessionName</code> before doing so.</p><p><a href="#img172768"><img src="https://tracebit.com/img/blog/2024/02/using-role-session-name-in-vpc-endpoint-policy.png" alt="Using RoleSessionName to selectively test digits" title="Using RoleSessionName to selectively test digits"/></a></p><p>As this policy (only just!) fits within the maximum character length of a VPC Endpoint policy, we can test all 120 possibilities in parallel, without modifying the policy or waiting for the results individually in CloudTrail.</p><p>This reduced the time taken to find the Account ID to less than 10 minutes:</p><pre><code>sh-5.2$ python3 find-s3-account.py bucket-alpha

VPC endpoint vpce-0e76855aadb0dafb5 policy already configured
Requesting bucket-alpha using session name 0-----------
Requesting bucket-alpha using session name 1-----------
Requesting bucket-alpha using session name 2-----------
Requesting bucket-alpha using session name 3-----------

SNIP

Requesting bucket-alpha using session name -----------7
Requesting bucket-alpha using session name -----------8
Requesting bucket-alpha using session name -----------9
Finding session names which passed the VPC endpoint in CloudTrail...
Found -----------1 for bucket-alpha in CloudTrail
Found ---------1-- for bucket-alpha in CloudTrail
Found --------9--- for bucket-alpha in CloudTrail
Found -----6------ for bucket-alpha in CloudTrail
Found --3--------- for bucket-alpha in CloudTrail
Found -2---------- for bucket-alpha in CloudTrail
Found 1----------- for bucket-alpha in CloudTrail
Found ----------0- for bucket-alpha in CloudTrail
Found -------8---- for bucket-alpha in CloudTrail
Found ------7----- for bucket-alpha in CloudTrail
Found ----5------- for bucket-alpha in CloudTrail
Found ---4-------- for bucket-alpha in CloudTrail
Bucket bucket-alpha: 123456789101</code></pre><h3>Remarks</h3><ul><li><p>I consulted the AWS Security team before publishing this blog post.</p></li><li><p>There has already been a lot of <a href="https://www.lastweekinaws.com/blog/are-aws-account-ids-sensitive-information/">interesting</a> <a href="https://blog.plerion.com/aws-account-ids-are-secrets/">discussion</a> about whether AWS account IDs should be considered sensitive. It&#39;s noteworthy that in the CloudTrail events themselves, AWS have chosen to leave the third-party account ID <code>HIDDEN_DUE_TO_SECURITY_REASONS</code>. You&#39;ve probably also spotted that I&#39;ve chosen to redact my own account ID from the examples in this post!</p></li><li><p>This technique should also work to uncover other resource condition keys (e.g. <code>aws:ResourceOrgID</code>, <code>aws:ResourceOrgPaths</code>, <code>aws:ResourceTag</code>) associated with the bucket - or indeed for services other than S3 to which this technique could be applied</p></li><li><p>It&#39;s possible that by creating mutually peered VPCs and VPC Endpoints in all regions you could create a setup which works regardless of the particular region of the target bucket.</p></li><li><p>These techniques are only feasible due to the ability to use <code>StringLike</code> conditions against <code>s3:ResourceAccount</code> in a policy. I can&#39;t think of a use case where a partial match against a randomly-generated identifier is necessary.</p></li><li><p>It seems like it might otherwise be beneficial for events which are denied by a VPC Endpoint policies to be logged in CloudTrail.</p></li></ul><h3>Acknowledgments</h3><ul><li><p>Ben Bridt&#39;s original technique inspired this work.</p></li><li><p>I&#39;m very grateful to <a href="http://www.chrisfarris.com/">Chris Farris</a> for his invaluable help and advice.</p></li></ul><p><strong><em>Thanks for reading this far, we hope you got something from this article. Tracebit is building a new kind of security product to be the ‘easy button’ for adding detections to cloud environments using decoys. If you’re interested to learn more about what that looks like please <a href="https://tracebit.com/earlyaccess">reach out</a> (we currently support AWS, with Azure &amp; GCP coming soon).</em></strong></p><ul><li><a href="https://tracebit.com/blog/category/research" href="#">research</a></li><li><a href="https://tracebit.com/blog/category/aws" href="#">AWS</a></li><li><a href="https://tracebit.com/blog/category/cloudtrail" href="#">CloudTrail</a></li><li><a href="https://tracebit.com/blog/category/engineering" href="#">engineering</a></li><li><a href="https://tracebit.com/blog/category/security" href="#">security</a></li></ul></article></div>
  </body>
</html>
