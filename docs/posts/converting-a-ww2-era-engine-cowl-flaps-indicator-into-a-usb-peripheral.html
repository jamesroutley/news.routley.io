<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://bikerglen.com/blog/ww2-engine-cowl-flaps-indicator/">Original</a>
    <h1>Converting a WW2-Era Engine Cowl Flaps Indicator into a USB Peripheral</h1>
    
    <div id="readability-page-1" class="page"><div>
						<div id="attachment_3707"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/merged_16x9.jpg"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/merged_16x9-1024x576.jpg" alt="General Electric 8DJ4xxx quad engine cowling indicator with PIC16F1459 and MCP41HV31-502 board to its right. Microsoft surface controlling the indicators via USB in the background." width="640" height="360"/></a></p><p>General Electric 8DJ4PBV quad engine cowling indicator with PIC16F1459 and MCP41HV31-502 board to its right. A Microsoft Surface in the background is controlling the indicators via USB.</p></div>
<p>In this project, I convert a WW2-era engine cowl flaps indicator into a USB peripheral using a Microchip PIC16F1459 microcontroller and four Microchip MCP31HV41-502 digital potentiometers. This project is reminiscent of my <a href="https://bikerglen.com/blog/building-usb-analog-panel-meters/">USB analog panel meters project</a> but the drive circuitry is significantly less complex. This post starts with a look at the engine cowl indicator, it’s theory of operation, and some ideas to control it using modern electronics. The post then covers the design of the board, the software for the microcontroller, and a Visual Studio C# .NET Windows Forms app for controlling the indicators from a PC.<span><br/>
</span></p>

<h2>General Electric DC Selsyn Indicators</h2>
<div id="attachment_3711"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/meters-front-and-rear-views.jpg"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/meters-front-and-rear-views-1024x683.jpg" alt="Front and rear view of the General Electric model 8DJ4PBV engine cowl flaps indicator." width="640" height="427"/></a></p><p>Front and rear view of the General Electric model 8DJ4PBV engine cowl flaps indicator.</p></div>
<p>This indicator is a General Electric model 8DJ4PBV DC Selsyn indicator. It is one of about 50 different varieties of General Electric DC Selsyn indicators. These indicators were commonly used on US and UK military aircraft employing DC electrical systems during the WWII-era in the 1940s. Their operation manual states these indicators were used to give the pilot a “visual indication of the position of landing wheels, landing flaps, cowl flaps, oil cooler flags, or similar movable parts of the airplane structure.”</p>
<p>This specific meter is used to indicate the position of the engine cowl flaps on a four-engine aircraft. If you’re wondering what engine cowl flaps are, the Aircraft Owners and Pilots Association has <a href="https://www.aopa.org/news-and-media/all-news/2017/november/flight-training-magazine/how-it-works-cowl-flaps">a brief explanation</a>: “Cowl flaps are small doors located in the bottom of the engine cowling that allow for greater cylinder cooling during takeoff and climb. The pilot operates the flaps by opening and closing them via mechanical or electrical controls in the cockpit.”</p>
<p>When a pilot commands the engine cowl flaps to open or close, a mechanical actuator moves the cowl flaps, a transmitter senses the position of the flaps, and this indicator indicates the position of the flaps as sent by the transmitter–if everything is working. If everything is not working, the pilot could detect the failure by the disparity between the controls for the cowl flaps and the indicated position of the cowl flaps. Some possible causes of failure could be that the cowl is stuck open or closed or there’s a defect in the transmitter, indicator, or the wiring between the transmitter and indicator.</p>
<h2>Theory of Operation</h2>
<p>The theory of operation for these indicators is described in great detail in Army Air Forces publication AN 05-55A-1, <em>Operation and Service Instructions for D-C Selsyn Position Indicators and Transmitters</em>, 20 June 1944, revised 10 June 1945. This document can be rented for $6/month or purchased for $37.82 at https://aircorpslibrary.com. I have excerpted the relevant parts of this document in this post for the purposes of educating others on the operation of these historic indicators.</p>
<div id="attachment_3630"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/Blog-8DJ4PBV-Two-Wire-Schematic.jpg"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/Blog-8DJ4PBV-Two-Wire-Schematic.jpg" alt="8DJ4PBV Two Wire Schematic" width="882" height="474"/></a></p><p>Schematic of a two-wire DC Selsyn system from <em>Operation and Service Instructions for D-C Selsyn Position Indicators and Transmitters</em>. There are four indicating elements in the 8DJ4PBV indicator.</p></div>
<p>The figure above is a schematic of the two-wire DC Selsyn system from the service and operation manual. There’s also a three-wire DC Selsyn system, but we’ll save that for another time because this indicator is considered a two-wire indicator and not a three-wire indicator. This indicator has four two-wire indicating elements that connect to four transmitters, one transmitter per engine cowl flap.</p>
<p>On the left side of the schematic is the transmitter. The transmitter consists of a potentiometer connected across a DC power source with the wiper of the potentiometer connected to the indicating element.</p>
<p>On the right side of the schematic is the indicating element. It consists of two coils of wire wrapped around a ring with a small gap opposite the two coils. The coils are spaced 120 degrees apart and connected across the same DC power source as the potentiometer. The wiper of the potentiometer is connected between the two coils.</p>
<p>Inside the ring is a rotor with a permanent magnet and an indicating needle. The small gap in the ring focuses the magnetic flux in the region between the two coils where the rotor’s magnet is located. The rotor will then rotate toward the vector sum of the magnetic flux generated in the coils.</p>
<div id="attachment_3659"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/dc-selsyn-sch-1.png"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/dc-selsyn-sch-1.png" alt="Simplified two-wire DC Selsyn schematic." width="691" height="610"/></a></p><p>Simplified two-wire DC Selsyn schematic.</p></div>
<p>The above diagram is a simplified version of the previous schematic drawn using modern CAD symbols. To see how the two-wire DC Selsyn works, consider three different wiper positions of R1. R1 has been split into two discrete resistors with a constant sum of 500 Ohms for the purposes of analysis in the figure below.</p>
<div id="attachment_3662"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/dc-selsyn-sch-21.png"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/dc-selsyn-sch-21-1024x359.png" alt="Three different positions of the wiper on R1. R1 has been split into R1 and R2 on this schematic." width="640" height="224"/></a></p><p>Three different positions of the wiper on R1. R1 has been split into R1 and R2 on this schematic.</p></div>
<p>With the potentiometer at the extreme left as shown in (A), the current in the first coil will be zero and thus the magnetic field generated in that coil will also be zero. The permanent magnet rotor will then swing toward the second energized coil where current is flowing and magnetic flux is being generated.</p>
<p>With the potentiometer halfway through its rotation as shown in (B), the current in the first coil and the current in the second coil will be identical and thus the magnetic flux generated in both coils will be equal too. The rotor will be evenly attracted to both coils and swing to the middle.</p>
<p>With the potentiometer at the other extreme as shown in (C), the current in the second coil will be zero and thus the magnetic field generated in that coil will also be zero. The rotor will now be attracted to the first coil and swing to the left.</p>
<h2>In Practice</h2>
<div id="attachment_3677"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/blog-internal-connections-2.jpg"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/blog-internal-connections-2.jpg" alt="Internal connections of indicator model 8DJ4PBV41." width="581" height="647"/></a></p><p>Internal connections of indicator model 8DJ4PBV41.</p></div>
<p>The figure above shows the internal connections of the four indicator elements in this model of indicator. Note that there’s a resistor in series with the middle of the two coils and the wiper of the transmitter’s potentiometer that is not present in the theory of operation schematics. Each coil has an internal resistance of about 1800 Ohms and the resistor has a resistance of about 300 Ohms. This model is spec’ed for 24 V DC operation.</p>
<p>The other interesting point to make about this diagram is that each indicating element is rotated with respect to the others. The needles are then mounted to the rotors such that they swing from about 45 degrees left of top center through top center to about 45 degrees right of top center. In other words, the needles are aligned to their scales on the face plate regardless of the actual orientation of the coils and rotors under the face plate.</p>
<p>In this meter, there’s also a small spring on each rotor that pulls the needles out of the minimum and maximum scale region when the meter has no DC power.</p>
<h2>Initial Testing</h2>
<div id="attachment_3675"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/Blog-8DJ4PBV-Indicator-with-Mallory-M-500-P-Potentiometer-2.jpg"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/Blog-8DJ4PBV-Indicator-with-Mallory-M-500-P-Potentiometer-2-1024x882.jpg" alt="8DJ4PBV indicator with Mallory M-500-P potentiometer." width="640" height="551"/></a></p><p>Connection diagram for an 8DJ4PBV indicator with four Mallory M-500-P potentiometers used as transmitters.</p></div>
<p>Once I had an indicator in hand, it was time to test it. Luckily, the service and operations manual contains a connection diagram, a portion of which is shown above. The connection diagram illustrates how to connect the indicator to a 24 V DC power source and four Mallory M-500-P 500 Ω, 4 Watt potentiometers. The manual also lists the part number of the connector required to connect to the meter.</p>
<p>I did not have the mating connector nor did I have a 500 Ω, 4 Watt potentiometer. Time to improvise! I used leads with insulated alligator clips to connect to the connector pins and a small 10 kΩ potentiometer.</p>
<div id="attachment_3638"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/Blog-Broken-Meter.jpg"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/Blog-Broken-Meter-1024x683.jpg" alt="broken meter" width="640" height="427"/></a></p><p>This indicator is broken. With 24 V DC power applied and no connections to the centers of the coils, all four indicators should be pointed at mid-scale. Indicator number 3 is a dud.</p></div>
<p>I selected indicator 3 and turned power on. It kind of worked. The needle moved back and forth as I turned the potentiometer but the needle jumped around a lot and positioning wasn’t repeatable. Turns out indicator 3 was broken. I moved the alligator clips to one of the other indicators and operation was perfect. Even with a small 10 kΩ, 1/4 Watt potentiometer instead of a massive 500 Ω, 5W potentiometer.</p>
<h2>Going Back to eBay</h2>
<div id="attachment_3626"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/8DJ4PBV-beat-up-front.jpg"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/8DJ4PBV-beat-up-front-1024x768.jpg" alt="8DJ4PBV beat up - front" width="640" height="480"/></a></p><p>I found another 8DJ4PBV indicator that looks like its seen better days.</p></div>
<p>I went back to eBay and found the above meter. That’s the listing image. It definitely looks like it has seen better days. It was about $10 so figured I’d give it a try. I also found and ordered a new-old-stock Amphenol MS3106A16S-1S connector to connect to the meter.</p>
<div id="attachment_3709"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/cleaned-up.jpg"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/cleaned-up-1024x683.jpg" alt="The 2nd eBay indicator after a thorough scrubbing." width="640" height="427"/></a></p><p>The 2nd eBay indicator after a thorough scrubbing. Notice how all four needles point to about mid-scale? Much better results than the first indicator.</p></div>
<p>When it arrived, I cleaned it up and tried it out. Success! When powered up, all four  indicators moved to their half-scale positions. I connected my 10 kΩ potentiometer’s wiper to each dial’s connector pin in succession and verified the needles moved smoothly from one side of the scale to the other as I turned the potentiometer’s shaft. The other really cool bit is using a 10 kΩ potentiometer instead of a 500 Ω potentiometer seems to work well but cuts the current consumption significantly. This is an important consideration for the next section of this post.</p>
<h2> Selecting a Digital Potentiometer</h2>
<div id="attachment_3625"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/Blog-8DJ4PBV-Calibration-Instructions.jpg"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/Blog-8DJ4PBV-Calibration-Instructions-1024x458.jpg" alt="8DJ4PBV Calibration Instructions" width="640" height="286"/></a></p><p>8DJ4PBV calibration instructions.</p></div>
<p>The last interesting tidbit in the service and operation manual for this meter is the calibration instructions shown in the image above. See that group of resistors and switches used as part of the test jig? What does it look very, very similar too?</p>
<div id="attachment_3642"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/Blog-Microchip-AN1080-Resistor-Network1.png"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/Blog-Microchip-AN1080-Resistor-Network1.png" alt="Microchip AN1080 Resistor Network" width="1000" height="503"/></a></p><p>Microchip AN1080 Resistor Network</p></div>
<p>Well, it’s practically identical to the resistor and switch network in a digital potentiometer! Would it be possible to use a digital potentiometer to control the position of the needles on this indicator? That would boil down to two concerns: 1) are there digital potentiometers that can handle 24 Volts? and 2) are there digital potentiometers that can handle whatever currents the indicators require?</p>
<p>Digital potentiometers have three key specification regarding the extremes they can tolerate. The first is the maximum terminal voltage range. This is the voltage across terminals A and B in the resistor network figure shown above. The second is the maximum current into or out of the A, B, and W terminals. The last is the maximum package power dissipation.</p>
<p>The terminal voltage for our application is simply our DC supply voltage of 24 Volts. To specify the required terminal currents for our application requires some calculations. Calculating the A, B, and wiper current with the wiper at either of the two extremes and in the middle will be sufficient in our application.</p>
<h3>Left Extreme Current Calculation</h3>
<div id="attachment_3696"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/currents-a.png"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/currents-a-1024x657.png" alt="currents-a" width="640" height="411"/></a></p><p>On the left, the resistances of the circuit components with the wiper moved to the extreme left. On the right, a simplified version of the same drawing annotated with the current calculations.</p></div>
<p>The schematic above shows the equivalent circuit of the indicator using a 5 kΩ potentiometer as a transmitter and with the potentiometer positioned at its extreme left toward the 24 V DC supply voltage. In this case, the wiper is sourcing 10 mA of current to the indicator.</p>
<p>There’s also a current of 24 V / 5 kΩ = 4.8 mA from terminal A to the terminal B from the 5k resistance. This results in the following currents through the terminals:</p>
<ul>
<li>Into terminal A: 10 mA + 4.8 mA = 14.8 mA</li>
<li>Out of the wiper terminal: 10 mA</li>
<li>Out of terminal B: 4.8 mA</li>
</ul>
<p>The maximum current through any terminal in this case is 14.8 mA.</p>
<h3>Center Current Calculation</h3>
<div id="attachment_3697"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/currents-b.png"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/currents-b-1024x657.png" alt="caption" width="640" height="411"/></a></p><p>On the left, the resistances of the circuit components with the wiper centered. On the right, a simplified version of the same drawing annotated with the current calculations.</p></div>
<p>The schematic above shows the equivalent circuit of the indicator using a 5 kΩ potentiometer as a transmitter and with the potentiometer positioned halfway between the 24 V DC supply and the DC supply ground. In this case, no current is flowing into or out of the wiper because the voltages at either side of the indicator’s internal 300 Ω resister are the same. Of course, the resistors won’t be perfectly matched in real life so a small current will still flow into or out of the wiper terminal but they’ll be small compared to when the wiper is at one extreme or the other.</p>
<p>Including the current from the 5 kΩ terminal resistance results in the following currents through the terminals:</p>
<ul>
<li>Into terminal A: 4.8 mA</li>
<li>Out of the wiper terminal: 0 mA</li>
<li>Out of terminal B: 4.8 mA</li>
</ul>
<p>The maximum current through any terminal in this case is 4.8 mA.</p>
<h3>Right Extreme Current Calculation</h3>
<div id="attachment_3698"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/currents-c.png"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/currents-c-1024x657.png" alt="caption" width="640" height="411"/></a></p><p>On the left, the resistances of the circuit components with the wiper moved to the extreme right. On the right, a simplified version of the same drawing annotated with the current calculations.</p></div>
<p>The schematic above shows the equivalent circuit of the indicator using a 5 kΩ potentiometer as a transmitter and with the potentiometer positioned at its extreme right toward the DC supply ground. In this case, the wiper is sinking 10 mA of current from the indicator.</p>
<p>Including the current from the 5 kΩ terminal resistance results in the following currents through the terminals:</p>
<ul>
<li>Into terminal A: 4.8 mA</li>
<li>Into the wiper terminal: 10 mA</li>
<li>Out of terminal B: 14.8 mA</li>
</ul>
<p>The maximum current through any terminal in this case is 14.8 mA.</p>
<h3>Package Power Dissipation</h3>
<div id="attachment_3751"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/mesh-analysis.png"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/mesh-analysis.png" alt="Circuit used for mesh analysis and power dissipation calculations." width="460" height="457"/></a></p><p>Circuit used for mesh analysis and power dissipation calculations.</p></div>
<p>Calculating the maximum package power dissipation for the design is a bit tougher. The power dissipation is dependent on the current through the resistors in the resistor network which will vary based on the selected resistance tap.</p>
<p>Let’s make some graphs to illustrate the change in power dissipation as the resistance is adjusted. We’ll use the figure above and mesh analysis to solve for the power dissipation in the potentiometer as a function of R1. First use mesh analysis to come up with a system of simultaneous equations for the circuit:</p>
<ul>
<li>R1*(I1-I2)+R2*(I1-I3)=V</li>
<li>R1*(I2-I1)+1800*I2+300*(I2-I3)=0</li>
<li>R2*(I3-I1)+300*(I3-I2)+1800*I3=0</li>
<li>R1+R2 = 5000</li>
<li>V = 24</li>
</ul>
<p>I cheated and plugged these into Wolfram Alpha to solve for I1, I2, and I3:</p>
<ul>
<li>I1 = (V (R1 (R2 + 2100) + 300 (7 R2 + 14400)))/(3600 (R1 (R2 + 1200) + 1200 R2))</li>
<li>I2 = (V (R1 (R2 + 2100) + 300 R2))/(3600 (R1 (R2 + 1200) + 1200 R2))</li>
<li>I3 = (V (R1 (R2 + 300) + 2100 R2))/(3600 (R1 (R2 + 1200) + 1200 R2))</li>
</ul>
<p>From there, I created an Octave script to vary R1 from 0 to 5000 and calculate the power dissipated in R1 and R2 and the total power dissipation:</p>
<pre>% R1*(A1-A2)+R2*(A1-A3)=V, 
% R1*(A2-A1)+1800*A2+300*(A2-A3)=0, 
% R2*(A3-A1)+300*(A3-A2)+1800*A3=0,
% solve for A1,A2,A3

% inputs
V = 24;
R1 = 0:1:5000;
R2 = 5000 - R1;

% currents in loops
I1 = (V.*(R1.*(R2 + 2100) + 300.*(7.*R2 + 14400)))./(3600.*(R1.*(R2 + 1200) + 1200.*R2));
I2 = (V.*(R1.*(R2 + 2100) + 300.*R2))./(3600.*(R1.*(R2 + 1200) + 1200.*R2));
I3 = (V.*(R1.*(R2 + 300) + 2100.*R2))./(3600.*(R1.*(R2 + 1200) + 1200.*R2));

% wiper voltage and coil center voltage
VA=R2.*(I1-I3);
VB=1800.*I3;

% voltage across R1 inside pot
VR1 = R1 .* (I1-I2);

% voltage across R2 inside pot
VR2 = R2 .* (I1-I3);

% this should be 24 V
VPOT = VR1 + VR2;

% power dissipated in pot A resistor
PAW = R1.*(I2-I1).^2;

% power dissipated in pot B resistor
PWB = R2.*(I3-I1).^2;

% total power dissipation in pot
PD = PAW + PWB;</pre>
<p>PAW is the power dissipated in R1, PWB is the power dissipated in R2. These are calculated as P = (I^2)(R) where R is either R1 or R2 and I is the current through the respective resistor using the terms from the mesh analysis.</p>
<div id="attachment_3753"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/power-dissipation.png"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/power-dissipation-1024x768.png" alt="power-dissipation" width="640" height="480"/></a></p><p>Top graph is R1 and R2 vs R1. All in Ohms. Middle graph is power dissipated in R1 and power dissipated in R2 versus R1. Power in Watts, resistance in Ohms. Finally, the bottom graph is the total power dissipation in both resistors versus R1. Again, power in Watts, resistance in Ohms.</p></div>
<p>From looking at the graph, I can see the maximum power dissipation occurs at R1 = 452 Ohms and is 130.5 mW. We need to select a potentiometer in a package with a maximum power dissipation rating of at least 130.5 mW.</p>
<h3>Final Requirements</h3>
<p>Based on the calculated terminal and wiper currents, my final requirements for a digital potentiometer were:</p>
<ul>
<li>Single-ended terminal voltage &gt;&gt; 24 Volts.</li>
<li>Terminal and wiper current &gt;&gt; 14.8 mA.</li>
<li>Maximum package power dissipation &gt;&gt; 130.5 mW.</li>
</ul>
<h3>Selected Part: Microchip MCP41HV31-502E/ST</h3>
<div id="attachment_3700"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/mcp41hv31.png"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/mcp41hv31-1024x813.png" alt="caption" width="640" height="508"/></a></p><p>Top 2/3rd’s of the first page of the Microchip MCP41HVX1 datasheet.</p></div>
<p>At this point, I searched manufacturers’ datasheets for a high-voltage digital potentiometer with sufficient terminal and wiper current capacity to meet the above requirements. The Microchip MCP41HV31-502 and MCP41HV51-502 parts both meet my requirements. An excerpt from the first page of the data sheet is shown above.</p>
<p>They both support a maximum single-ended terminal voltage of 36 Volts which is greater than my requirement of 24 Volts. The 5 kΩ version supports terminal and wiper currents of 25 mA which is greater than my requirement of 14.8 mA. According to the Absolute Maximum Ratings section of the datasheet, the maximum package power dissipation for the device in the TSSOP-14 package is 1000 mW which greatly exceeds my maximum anticipated power dissipation of 130.5 mW.</p>
<p>The only difference between the two parts is that one is 7 bits with 128 resistance steps while the other is 8 bits with 256 resistance steps. I did some prototyping with the 8-bit part and decided that 7 bits / 128 steps was sufficient for my application.</p>
<h3>Building a Test Board</h3>
<p>The next step was to build a small test board to ensure I understood how these parts worked and test how they would interact with the indicator. This test board contains only one digital potentiometer and, as a result, can only control one of the four dials on the indicator.</p>
<div id="attachment_3682"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/mcp41hv51-1ch-board-sch.png"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/mcp41hv51-1ch-board-sch-1024x407.png" alt="caption" width="640" height="254"/></a></p><p>Test board schematic.</p></div>
<p>Shown above is the schematic for the single channel test board. A six-pin 0.1″ header is used to supply power to the pot’s digital logic and provide access to its bidirectional SPI bus. A 3.5 mm, three-position screw terminal strip supplies 24 V DC to the digital pot’s A and B terminals and provides access to the wiper terminal for connecting to the indicator. Two small decoupling caps are placed across the logic and 24 V supplies.</p>
<div id="attachment_3683"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/mcp41hv51-1ch-board-brd.png"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/mcp41hv51-1ch-board-brd.png" alt="caption" width="488" height="372"/></a></p><p>Test board layout.</p></div>
<p>The completed board layout is shown above. The final board measured 1.2 x 0.7 inches and cost $4.20 to have manufactured at OSH Park.</p>
<div id="attachment_3672"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/blog-my-test-board.jpg"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/blog-my-test-board.jpg" alt="My MCP31HV51-502 test board." width="1000" height="667"/></a></p><p>My fully populated MCP41HV51-502E/ST test board.</p></div>
<p>When the board arrived, I stuffed the board with a few connectors, capacitors, and a MCP41HV51-502E/ST 256-step digital potentiometer chip. I attached the SPI bus to a microcontroller dev board and the screw terminals to one of the four dials on the indicator. I powered everything up and it worked great with the 256-step part. After a few more tests, I decided the lower-cost (and still available) 128-step part would work just as well as the 256-step part. Time to design a board with a built-in microcontroller to control all four dials on the indicator.</p>
<h2>Expanding to Four Channels</h2>
<p>After building a test board and demonstrating that the MCP41HV31-502 digital potentiometer could be used to control one of the dials, it was time to build a board to control all four dials simultaneously. The board also needed its own USB microcontroller and 24 VDC power supply.</p>
<h3>Microcontroller Selection</h3>
<div id="attachment_3587"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/01/pic16f1459-with-smd-switch-2.jpg"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/01/pic16f1459-with-smd-switch-2-1024x684.jpg" alt="PIC16F1459 in a TSSOP-20 package next to an eight position SMD switch." width="640" height="428"/></a></p><p>PIC16F1459 in a TSSOP-20 package next to an eight position SMD switch.</p></div>
<p>For this project, I’m going to use the Microchip PIC16F1459 8-bit USB microcontroller. I’ve used this microcontroller before so I’m familiar with the required support circuitry and USB software. An 8-bit microcontroller is fine for this application because it only needs to implement the USB stack, listen for USB OUT reports, and control the digital potentiometers over a SPI bus in response to the USB OUT reports.</p>
<h3>Power Supply</h3>
<p>The board’s power input will be the same voltage as the meters, 24 V DC. The microcontroller and digital potentiometers require 5 V DC. I’m using a CUI VX7805-500 three-terminal linear regulator replacement to power the micro and pots. It requires 10 µF and 0.1 µF caps on the input and 22 µF and 0.1 µF caps on the output as described in the datasheet. The VX7805 is a switching DC/DC converter. Compared to a linear regulator like the LM7805, the VX7805 has a much wider input voltage range of 6.5 to 36 Volts, a higher efficiency of 90%, and runs cool to the touch.</p>
<h3>Schematic</h3>
<div id="attachment_3689"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/mcp41hv31-4ch-board-sch1.png"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/mcp41hv31-4ch-board-sch1-1024x681.png" alt="caption" width="640" height="426"/></a></p><p>Four channel USB digital potentiometer board schematic.</p></div>
<p>With the selection of the power supply, microcontroller, and digital potentiometers done, it was time to draw the schematic. This is a USB self-powered design meaning the board is powered by its own power supply rather than a USB bus-powered design that is powered by the USB host.</p>
<p>Technically, there should be a net from the USB bus’s VBUS pin to the micro so the micro can place its D+/D- pins in a high-impedance state until the USB host drives VBUS high. From the PIC16F1459 datasheet: “<span dir="ltr">In order to meet compliance specifications, the USB </span><span dir="ltr">module (and the D+ or D- internal pull-ups) should not </span><span dir="ltr">be enabled until the host actively drives <span>VBUS</span> high.</span>” I’m not going to seek USB certification for this board so I’m not going to worry about it.</p>
<p>For more detailed information on using the PIC16F1459 and the support circuitry I’ve included in this design, I recommend reading my <a href="https://bikerglen.com/blog/updates-to-the-annoying-caps-lock-warning-buzzer/">Updates to the Annoying CAPS LOCK Warning Buzzer</a> post.</p>
<h3>Board Layout</h3>
<div id="attachment_3685"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/mcp41hv31-4ch-board-brd.png"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/mcp41hv31-4ch-board-brd.png" alt="caption" width="852" height="594"/></a></p><p>Four channel USB digital potentiometer board schematic.</p></div>
<p><span><span>The completed board layout is shown above. The USB and microcontroller stuff is on the left. The digital pots and connections to the indicators and power suppy are on the right. I placed 0.1″ header in the center of the board for debugging the SPI bus. If the microcontroller section of the board is not stuffed, an off-board microcontroller could be connected to the header and used instead of the on-board PIC16F1459.</span><br/>
</span></p>
<h3>Board Preview</h3>
<div id="attachment_3686"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/4763e3c7e529c246762d973d902a48a3.png"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/4763e3c7e529c246762d973d902a48a3-1024x575.png" alt="caption" width="640" height="359"/></a></p><p>Render of the top of the four channel USB digital potentiometer board.</p></div>
<div id="attachment_3687"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/f06361f47bca567f1130561de1c2ac7c.png"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/f06361f47bca567f1130561de1c2ac7c-1024x575.png" alt="caption" width="640" height="359"/></a></p><p>Render of the bottom of the four channel USB digital potentiometer board.</p></div>
<p>Once the board layout was complete, I uploaded the Gerbers to OSH Park and examined the board renders for any mistakes. After one or two revisions to get the silkscreen correct, I ordered the boards.</p>
<h3>Fabricated Boards</h3>
<div id="attachment_3719"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/boards-cropped.jpg"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/boards-cropped-1024x1024.jpg" alt="The front and back of the fabbed boards." width="640" height="640"/></a></p><p>The front and back of the fabbed boards.</p></div>
<p>About two weeks later I received the boards.</p>
<h3>Board Assembly</h3>
<div id="attachment_3717"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/board-cropped-2.jpg"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/board-cropped-2-1024x683.jpg" alt="    The completed and assembled board. The board features a USB 2.0 Type C connector, a PIC16F1459, four MCP41HV31 digital potentiometers, and a screw terminal strip to connect to power and the indicator." width="640" height="427"/></a></p><p>The completed and assembled board. The board features a USB 2.0 Type C connector, a PIC16F1459, four MCP41HV31 digital potentiometers, and a screw terminal strip to connect to power and the indicator.</p></div>
<p>The completely assembled board is shown above. I assembled and tested the board in stages though. First up was to stuff the power supply, USB components, LED, and microcontroller. After stuffing thsee parts, I programmed an existing PIC16F1459 USB software design into the micro and verified the USB and micro worked.</p>
<p>With USB and the micro working, I disconnected the board and soldered a single MCP41HV31 digital pot to the board. I then modified the software to control the digital pot. Once I was happy that everything was working properly, I soldered the remaining digital pots to the board.</p>
<p>I expanded the software to drive four digital pots and did a bit more testing. Everything worked so it was time to connect to the meter. I built the board up in stages mostly due to the silicon and parts shortage. I did not want to solder all the chips to the board just to find out the board didn’t work and have to scramble to find additional components.</p>
<h3><span>Connecting to the Meter</span></h3>
<div id="attachment_3713"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/merged-with-connector.jpg"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/merged-with-connector-1024x682.jpg" alt="The completed USB controller board with green Phoenix power connector and drab olive Amphenol indicator connector." width="640" height="426"/></a></p><p>The completed USB controller board with green Phoenix power connector and drab olive Amphenol indicator connector.</p></div>
<p>The connection to the meter is made using an Amphenol MS3106A16S-1S connector. This is a solder connector. I’m getting better at soldering solder cup terminals in tight spaces like on this connector but I’m by now means great at it yet. Two tricks I’ve learned:</p>
<ol>
<li>Don’t use PVC-insulated wire. PVC insulation melts. Instead use XLPE (like in the image above) or PTFE (Teflon) insulated wire. The insulation on these wires is much more heat resistant than cheap PVC insulation.</li>
<li>Heat shrink covers all sins. If you’re stuck using PVC-insulated wire and the insulation melts, slip some heatshrink down over the mess and call it good. Heatshrink is often used in aerospace applications even with PTFE-insulated wire anyway to protect the wire and prevent shorts around the solder joint.</li>
</ol>
<div id="attachment_3721"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/connected.png"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/connected-1024x683.png" alt="USB controller board connected to meter with the large Amphenol connector." width="640" height="427"/></a></p><p>USB controller board connected to indicator with the large Amphenol connector.</p></div>
<p>The board connected to the indicator. After working with these indicators, my estimate is half the weight of an aircraft is connectors and wire harnesses. These things are just bulky and heavy.</p>
<h2>PIC16 Embedded Software</h2>
<p>The PIC16 software for this project builds on the Microchip Library for Applications USB HID custom device example and the past work I’ve done using this library. The most recent incarnation of this work was the <a href="https://bikerglen.com/blog/building-a-dip-switch-usb-stick-using-the-microchip-pic16f1459/">USB DIP switch</a> and I used a cleaned up version of that code as a starting point for this project.</p>
<h3>USB Report Descriptor</h3>
<p>A vendor-defined custom HID peripheral needs a USB report descriptor. I’m using a report descriptor that is compatible with the <a href="https://bikerglen.com/blog/building-usb-analog-panel-meters/">USB analog meters</a> project so that I can reuse the C# .NET app for this project.</p>
<p>The first report ID is a USB OUT report from the USB host to the USB device. It allows the USB host to set all four digital potentiometer levels at once. It’s four bytes, one byte per meter. Only values from 0 to 127 are valid.</p>
<p>The second report ID is a USB OUT report from the USB host to the USB device. It allows the USB host to set a single digital potentiometer at a time. It’s two bytes. The first byte is the digital potentiometer to set from 0 to 3 and the second byte is the level from to 127.</p>
<p>Unlike the USB analog meters project, this board has no PWM hardware so I did not include the third report ID from that project. The complete USB report descriptor is shown below.</p>
<pre>// Class specific descriptor - HID 
// 4 bytes in to set all indicators at once, 4 values from 0 to 0x7F
// 2 bytes in to set a single meter at a time, 1 value from 0 to 3, 1 value from 0 to 0x7F
const struct{uint8_t report[HID_RPT01_SIZE];}hid_rpt01={
{

        0x06, 0x00, 0xFF,  // Usage Page (Vendor Defined 0xFF00)
        0x09, 0x01,        // Usage (0x01)
        0xA1, 0x01,        // Collection (Application)

        0x85, 0x01,        //   Report ID (1)
        0x95, 0x04,        //   Report Count (4)
        0x75, 0x08,        //   Report Size (8)
        0x26, 0xFF, 0x00,  //   Logical Maximum (255)
        0x15, 0x00,        //   Logical Minimum (0)
        0x09, 0x01,        //   Usage (0x01)
        0x91, 0x02,        //   Output (Data,Var,Abs,No Wrap,Linear,Preferred State,No Null Position,Non-volatile)

        0x85, 0x02,        //   Report ID (2)
        0x95, 0x02,        //   Report Count (2)
        0x75, 0x08,        //   Report Size (8)
        0x26, 0xFF, 0x00,  //   Logical Maximum (255)
        0x15, 0x00,        //   Logical Minimum (0)
        0x09, 0x01,        //   Usage (0x01)
        0x91, 0x02,        //   Output (Data,Var,Abs,No Wrap,Linear,Preferred State,No Null Position)

        0xC0,              // End Collection
                
        // 38 bytes
}};</pre>
<h3>USB Callbacks</h3>
<p>The USB callbacks are located in the APP_DeviceCustomHIDTasks function:</p>
<pre>void APP_DeviceCustomHIDTasks()
{   
    /* If the USB device isn&#39;t configured yet, we can&#39;t really do anything
     * else since we don&#39;t have a host to talk to.  So jump back to the
     * top of the while loop. */
    if( USBGetDeviceState() &lt; CONFIGURED_STATE )
    {
        return;
    }

    /* If we are currently suspended, then we need to see if we need to
     * issue a remote wakeup.  In either case, we shouldn&#39;t process any
     * keyboard commands since we aren&#39;t currently communicating to the host
     * thus just continue back to the start of the while loop. */
    if( USBIsDeviceSuspended()== true )
    {
        return;
    }
    
    //Check if we have received an OUT data packet from the host
    if(HIDRxHandleBusy(USBOutHandle) == false)
    {   
        // switch report ID
         switch (ReceivedDataBuffer[0]) {
            case 0x01:
                irqMetersUpdateFlags = 0x0f;
                irqMetersLevels[0] = ReceivedDataBuffer[1];
                irqMetersLevels[1] = ReceivedDataBuffer[2];
                irqMetersLevels[2] = ReceivedDataBuffer[3];
                irqMetersLevels[3] = ReceivedDataBuffer[4];
                break;
            case 0x02:
                if ((ReceivedDataBuffer[1] &gt;= 0) &amp;&amp; (ReceivedDataBuffer[1] &lt;= 3)) {
                    irqMetersUpdateFlags |= (1 &lt;&lt; ReceivedDataBuffer[1]);
                    irqMetersLevels[ReceivedDataBuffer[1]] = ReceivedDataBuffer[2];
                }
                break;
        }

        //Re-arm the OUT endpoint, so we can receive the next OUT data packet 
        //that the host may try to send us.
        USBOutHandle = HIDRxPacket(CUSTOM_DEVICE_HID_EP, (uint8_t*)&amp;ReceivedDataBuffer[0], 64);
    }
}</pre>
<p>This code sets some flags and values telling the main loop code to update the indicators. Since this code is called from the main loop and is not running at interrupt time (despite the variable names!), sending the values over SPI to the digital potentiometers could be done here instead. The code is this way mostly because it was ported from the EFM8UB1 where this code was running at interrupt time.</p>
<h3>Main Loop</h3>
<p>The main loop code receives the flags and values from the APP_DeviceCustomHIDTasks function. The flags tell the main loop code which meters need to be updated and the values are the values to send to the digital potentiometer. For each flag that is set, the microcontroller clears the flag and bit bangs out the specified value.</p>
<pre>        // update meters if needed
        mainMetersUpdateFlags = irqMetersUpdateFlags;
        for (i = 0; i &lt; 4; i++) {
            mainMetersLevels[i] = irqMetersLevels[i];
        }
        irqMetersUpdateFlags = 0;

        if (mainMetersUpdateFlags &amp; 1) {
            pot_Write (0, mainMetersLevels[0]);
        }

        if (mainMetersUpdateFlags &amp; 2) {
            pot_Write (1, mainMetersLevels[1]);
        }

        if (mainMetersUpdateFlags &amp; 4) {
            pot_Write (2, mainMetersLevels[2]);
        }

        if (mainMetersUpdateFlags &amp; 8) {
            pot_Write (3, mainMetersLevels[3]);
        }
</pre>
<p>There’s some other code in the main loop that blinks the LED according to the USB state.</p>
<h3>Bit Banged SPI</h3>
<p>Since the indicator update rate and data rates are so slow, I bit banged the SPI bus rather than using the PIC16F1459’s SPI.</p>
<pre>void pot_Write (uint8_t select, uint8_t level)
{
    uint8_t hi, lo, d, i;

    // set chip select low
    if (select == 0) {
        CS0n = 0;
    } else if (select == 1) {
        CS1n = 0;
    } else if (select == 2) {
        CS2n = 0;
    } else if (select == 3) {
        CS3n = 0;
    }

    hi = 0;
    lo = level &amp; 0x7F;
    
    d = hi;
    for (i = 0; i &lt; 8; i++) {
        SDO = (d &amp; 0x80) ? 1 : 0;
        d = d &lt;&lt; 1;
        SCK = 1;
        SCK = 0;
    }

    d = lo;
    for (i = 0; i &lt; 8; i++) {
        SDO = (d &amp; 0x80) ? 1 : 0;
        d = d &lt;&lt; 1;
        SCK = 1;
        SCK = 0;
    }
    
    // all chip selects high
    CS0n = 1;
    CS1n = 1;
    CS2n = 1;
    CS3n = 1;
}</pre>
<p>The pot_Write function takes a pot number from 0 to 3 and a value from 0 to 127 then writes the value to the selected pot.</p>
<h2>C# .NET Windows Forms App</h2>
<div id="attachment_3739"><p><a href="https://bikerglen.com/wp/wp-content/uploads/2022/11/meters.png"><img src="https://bikerglen.com/wp/wp-content/uploads/2022/11/meters.png" alt="The Visual Studio 2019 C# .NET Windows Forms app for controlling the indicators." width="786" height="462"/></a></p><p>The Visual Studio 2019 C# .NET Windows Forms app for controlling the indicators.</p></div>
<p>This project reuses the C# .NET Windows Forms app from <a href="https://bikerglen.com/blog/usb-analog-panel-meters-finishing-touches/">part two of the USB analog meters project</a>. The only significant difference to the code is the USB VID and PID were updated for the values I selected for this hardware and the scroll bar update scales were changed:</p>
<pre>private void trackBar1_ValueChanged(object sender, EventArgs e)
{
    // get trackbar value
    int v = trackBar1.Value;

    // compute value to display in GUI from 0 to 100%
    int display = (int)(100.0 * (float)v / 255.0);

    // compute value to send to hardware
    // 235 for SO-45 meter in enclosure
    // 238 for extremely large switchboard meter
    // 127 for engine cowling indicator
    int send = (int)(127.0 * (float)v / 255.0); 

    // update label in GUI
    label1.Text = display.ToString();

    // send data out USB to hardware
    var outData = _device.CreateReport();
    outData.ReportId = 0x02;
    outData.Data[0] = 0;
    outData.Data[1] = (byte)send;
    _device.WriteReport(outData);
}</pre>
<p>Moving each of the meter sliders will change the level displayed on its corresponding engine cowl dial. The PWM section is not used in this project.</p>
<h2>The Completed Project</h2>
<p><iframe title="YouTube video player" src="https://www.youtube.com/embed/wZpZG8vQ3OY" width="630" height="355" frameborder="0" allowfullscreen="allowfullscreen"></iframe></p>
<p>The video above is a quick demonstration of the indicator in use. The indicator is connected to the USB controller board and the USB controller board is connected to my Surface. The .NET Forms app is running and superimposed over the video. As I slide the sliders in the app, the corresponding dial moves on the indicator.</p>
<h2>Next Steps</h2>
<p>Since the indicator is an inductive device, I need to bodge some flyback diodes from each of the digital pot wipers to 24 V DC and ground. I also have a three-wire selsyn indicator that I’ve built a board to control. The currents are much higher and the drive circuitry is significantly more complex. The three-wire selsyn controller would make a great topic for a future blog post.</p>
<p>Some comments after the post was published suggested running the design from the USB 5 Volt VBUS supply instead of a separate 24 Volt power supply. While it is true that the indicators are ratiometric and it shouldn’t matter what the supply voltage is, the dials do not reach their full-scale open position with a supply voltage of less than about 18 Volts. My theory is that the reduced currents at lower voltages do not generate enough flux to overcome the loading of the springs that snap the dials to the off-scale loss-of-power position.</p>
<p>Some other comments suggested using PWM outputs or a DAC and an op amp to generate the control signals for the dials. This is definitely possible but was not the route I chose to follow for this design.</p>
<h2>Design Files</h2>
<p>The board design, PIC source code, and C# source code for this project are available on Github in my usb-ww2-engine-cowling repository.</p>
											</div></div>
  </body>
</html>
