<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.rubyvideo.dev/">Original</a>
    <h1>Ruby Video – On a mission to index all Ruby conferences</h1>
    
    <div id="readability-page-1" class="page"><div id="content">
	    
	    <p>
    Posted on 2024-12-12
    
</p>

<p><img src="https://www.scannedinavian.com/images/rosahringurminni.png"/></p>
<p>I read <a href="https://christop.club/publications/pdfs/Zuger-etal_2017.pdf">Reducing Interruptions at Work: A Large-Scale Field Study of FlowLight</a> and built my own FlowLight.</p>
<p>When I first heard about this paper from the second author, Chris Corley, he said something to the effect of “the easiest way to detect if a programmer is in flow is to see if they’re typing into their programmer’s editor.”
This is the approach I wanted to implement.</p>
<p><img src="https://www.scannedinavian.com/images/magtag-busy.png"/></p>
<p><img src="https://www.scannedinavian.com/images/magtag-free.jpg"/></p>
<p>Go look at the <a href="https://github.com/shapr/flowlight/">elisp and circuitpython source code</a>!</p>

<p>Wikipedia says Flow is also called <strong>in the zone</strong> or <strong>locked in</strong>. It’s that time where you have enough of the system loaded into short term memory that you can smoothly and fluently do the thing!</p>
<p>That same page has a section that mentions <a href="https://en.wikipedia.org/wiki/Flow_(psychology)#Characteristics">seven flow conditions</a>, one of which is “Freedom from distractions”.</p>
<p>Most programmers have other humans nearby, in the same physical space. They could be coworkers, children, or partners.</p>
<p>If you are doing the thing, and someone bumps into you and asks if you want coffee, this can lead to an extra fifteen minutes spent reloading short term memory.</p>
<p>Wouldn’t it be nice if those other humans had a way to see if you were <strong>not</strong> at a good point for a distraction?</p>

<p><a href="https://en.wikipedia.org/wiki/Emacs">Emacs</a>! A
<a href="https://www.adafruit.com/product/4800">MagTag</a> board from AdaFruit,
and its built-in <a href="https://www.adafruit.com/product/4801">NeoPixel Strip</a>!</p>
<p>How do I track activity?</p>
<p>The original authors tracked keypresses and mouse clicks, but I want to do this entirely inside emacs.</p>

<ul>
<li>The idle timer waits for ten seconds, then appends the pair of (now,seconds-of-idle-time) to a list.</li>
<li>The other timer runs every sixty seconds to calculate the status to send, and removes elements older than seven minutes.</li>
</ul>
<p>It works, but there’s gotta be a better approach. This is newbie elisp code, I’d appreciate any suggestions or improvements.</p>
<p>From reading the emacs documentation about idle timers, it says seconds-of-idle-time is <code>nil</code> if emacs isn’t idle. I never got a <code>nil</code> value, so I think my computer is fast enough to run all the background tasks everytime I press a key?</p>
<p>There’s the usual start and stop boilerplate that you need for every emacs timer, and the core is:</p>
<pre><code> ;; will this break if I type fast enough for (current-idle-time) to return nil ?
 (defun is-active (pair)
   &#34;Check PAIR, idle values less than 10 seconds counts as active. idle returns -1 and active returns 1.&#34;
   (if (&lt; (cdr pair) 10) 1 -1))

 (defun flowlight-update-color ()
   &#34;Update the color. This is done by checking whether more than half of the samples from the last seven minutes have activity.&#34;
   (interactive)
   (progn
     (flowlight-prune-activity-intervals) ;; remove old values
     (if	;; if values are more active than inactive, set BUSY status
  (&gt; (apply &#39;+ (cl-mapcar &#39;is-active flowlight-activity-intervals)) 0)
  (url-retrieve &#34;http://flowlight.local/status?status=busy&#34; &#39;message)
(url-retrieve &#34;http://flowlight.local/status?status=free&#34; &#39;message))))

 (defun flowlight-prune-activity-intervals ()
   &#34;Remove any samples older than seven minutes.&#34;
   (interactive)
   (let ((seven-minutes-before-now (- (time-convert nil &#39;integer) (* 60 7))))
     (setq flowlight-activity-intervals
    (cl-remove-if (lambda (row) (&gt; seven-minutes-before-now (car row))) flowlight-activity-intervals))))

</code></pre>

<p>I like to buy AdaFruit hardware, and along the way I picked up a
<a href="https://www.adafruit.com/product/4800">MagTag</a> board.</p>
<p>The MagTag board runs CircuitPython, and is one of the few that can run an HTTP server. I hooked a webserver endpoint to the LED colors and e-ink text.</p>
<p>Bonus fun included adding support for multicast DNS:</p>
<div id="cb2"><pre><code><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>mdns_server <span>=</span> mdns.Server(wifi.radio)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>mdns_server.hostname <span>=</span> <span>&#34;flowlight&#34;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span>print</span>(<span>&#34;MDNS Hostname: &#34;</span> <span>+</span> mdns_server.hostname)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>mdns_server.advertise_service(service_type<span>=</span><span>&#34;_http&#34;</span>, protocol<span>=</span><span>&#34;_tcp&#34;</span>, port<span>=</span><span>80</span>)</span></code></pre></div>
<p>The core of the code is an endpoint for <strong>BUSY</strong> or <strong>FREE</strong>:</p>
<div id="cb3"><pre><code><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span>@server.route</span>(<span>&#34;/status&#34;</span>, GET)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span>def</span> set_status(request: Request):</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span>&#34;&#34;&#34;Changes the color of the built-in NeoPixels and the status text using query/GET params.&#34;&#34;&#34;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span># e.g. /status?status=busy or /status?status=free</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    status <span>=</span> request.query_params.get(<span>&#34;status&#34;</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    response <span>=</span> <span>&#34;&#34;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span>if</span> status <span>==</span> <span>&#34;busy&#34;</span>:</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a> magtag.peripherals.neopixels.fill((<span>255</span>, <span>0</span>, <span>0</span>))</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a> magtag.set_text(<span>&#34;BUSY&#34;</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a> response <span>=</span> <span>&#34;busy&#34;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span>elif</span> status <span>==</span> <span>&#34;free&#34;</span>:</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a> magtag.peripherals.neopixels.fill((<span>0</span>, <span>255</span>, <span>0</span>))</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a> magtag.set_text(<span>&#34;FREE&#34;</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a> response <span>=</span> <span>&#34;free&#34;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span>else</span>:</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a> magtag.peripherals.neopixels.fill((<span>0</span>, <span>0</span>, <span>255</span>))</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a> magtag.set_text(<span>&#34;ERROR&#34;</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a> response <span>=</span> <span>&#34;error&#34;</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span>return</span> Response(request, <span>f&#34;Changed status to </span><span>{</span>response<span>}</span><span>&#34;</span>)</span></code></pre></div>

<ul>
<li>Using timers feels janky, maybe I should try what I did for <a href="https://github.com/shapr/markovkeyboard/">markovkeyboard</a> and hook into every keypress? I’m not sure how to structure that efficiently.</li>
<li>I really wanted a <a href="https://en.wikipedia.org/wiki/Sparkline">sparkline</a> of activity, but I don’t have a board with a big display than can run an HTTP server.</li>
<li>I’d like to use the <a href="https://www.adafruit.com/product/5778">Matrix Portal S3</a>, as it can run an HTTP server and has a big display, but it’s out of stock!</li>
<li>This code totally ignores the per-minute buckets and smoothing from the original paper, I’d like to go back and improve that.</li>
</ul>

<p>Most of the emacs timer stuff (and how to write elisp) came from discussions with <a href="https://reedmullanix.com/">Reed Mullanix</a> and <a href="http://canonical.org/~kragen/">Kragen Sitaker</a>, thanks!
My friend <a href="https://christop.club/">Chris Corley</a> told me about the FlowLight paper right after it was written, hopefully this post lets me put stop thinking about it for awhile.</p>

<p>I started out with AdaFruit’s <a href="https://www.adafruit.com/product/4985">FunHouse Board</a>, but after throwing the board in my backpack without a case, something bad happened and that board has fatal issues getting data over USB.</p>
<p>On the good side, my MagTag board already has a case with an attached battery, and its own set of magnet feet, so I can stick it on the wall for anyone to see.</p>
<p>If you want to buy your own hardware to run this, there are a few suitable boards in stock at the time of publication.</p>
<p>I’d suggest the <a href="https://www.adafruit.com/product/5420">Memento</a> camera, or one of the AdaFruit Feather boards that appear when you click on the arrow to the left of “Available on these boards” section of
the <a href="https://docs.circuitpython.org/en/latest/shared-bindings/socketpool/index.html">socketpool</a> docs.</p>

	</div></div>
  </body>
</html>
