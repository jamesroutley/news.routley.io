<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.thariq.io/blog/entropix/">Original</a>
    <h1>Detecting when LLMs are uncertain</h1>
    
    <div id="readability-page-1" class="page"><div>  <div><p>This post tries to explain the new reasoning techniques developed by <a href="https://x.com/_xjdr">XJDR</a> in a new project called
<a href="https://github.com/xjdr-alt/entropix">Entropix</a>.</p><p>Entropix attempts to improve reasoning in models through being smarter at sampling during moments of uncertainty.</p><p>A big caveat, there have been no large scale evals yet for Entropix, so it’s not clear how much this helps in practice. But it does seem to introduce some promising techniques and mental models for reasoning.</p></div>
<h2 id="uncertainity-at-a-glance">Uncertainity at a glance</h2>
<p>Sampling is the process of choosing which token from the distribution of possible tokens (the logits) that a LLM chooses. You can tell how confident a model is in its predictions by looking at that distribution.</p>
<p>This is a <strong>confident</strong> model prediction for the next token:</p>
<p><img src="https://www.thariq.io/images/entropix/lowe-lowv.png" alt="Screenshot 2024-10-11 at 10.08.08 AM.png"/></p><p>But in reality, models are not always so sure of their predictions. You will often run into cases where the next token prediction looks like this:</p>
<p><img src="https://www.thariq.io/images/entropix/lowe-highv.png" alt="Screenshot 2024-10-11 at 10.08.08 AM.png"/><img src="https://www.thariq.io/images/entropix/highe-lowv.png" alt="Screenshot 2024-10-11 at 10.09.29 AM.png"/></p>
<p>In these cases, the model is uncertain.</p>
<p>Entropix is a method for using <strong>adaptive sampling</strong> to make better decisions when the model is uncertain.</p>
<h3 id="what-does-uncertainity-mean-and-does-it-matter">What does uncertainity mean, and does it matter?</h3>
<p>This uncertainty in the logits might have many different underlying causes, and not all are bad.</p>
<p>Causes include:</p>
<ul>
<li>The tokens are synonyms or equivalent (e.g. good vs great)</li>
<li>There are branching paths (e.g. the AI could either write your program in Java or C)</li>
<li>The AI may genuinely not be sure what to do (it is ‘out of distribution’, it hasn’t seen this in its training data before).</li>
</ul>
<p>Entropix suggests that you should have <em>different methods</em> for choosing the next token, depending on how uncertain you are.</p>
<p>How do we do that? To start, we need to measure uncertainty.</p>
<h2 id="entropy-and-varentropy">Entropy and Varentropy</h2>
<p>The key tools that Entropix uses are two metrics that measure uncertainty: <strong>the entropy</strong> &amp; <strong>varentropy</strong> of the logits.</p>
<p>Entropy measures how different the predicted logits are from each other, i.e. how uncertain we are in the most probably outcome. In low entropy, we are pretty certain in a few of the logits. In high entropy, the distribution of the logits is more uniform and we are much less certain.</p>
<p>Varentropy is a different type of entropy metric. It gives us an idea of the “shape” of the uncertainty. High varentropy indicates that some of the values are highly different from others.</p>
<astro-island uid="ZPT0W8" prefix="r3" component-url="/_astro/SimpleExpandableBlock.-iQQRPjY.js" component-export="default" renderer-url="/_astro/client.BIGLHmRd.js" props="{&#34;heading&#34;:[0,&#34;The Math&#34;]}" ssr="" client="load" opts="{&#34;name&#34;:&#34;SimpleExpandableBlock&#34;,&#34;value&#34;:true}" await-children=""><template data-astro-template=""><p>Entropy &amp; Varentropy are based on the idea of <strong>surprisal</strong>.</p><p>Surprisal, also known as self-information, measures how unexpected or surprising an event is based on its probability. For an event x with probability P(x), the surprisal is:</p><p><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>I</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">I(x) = -\log_2(P(x))</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>I</span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span>−</span><span></span><span><span>lo<span>g</span></span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>P</span><span>(</span><span>x</span><span>))</span></span></span></span></span></p><p>The more unlikely an event is, the higher its surprisal. For example, if P(x) = 1/8, the surprisal is 3 bits, while if P(x) = 1/2, the surprisal is only 1 bit.</p><p>Entropy is the expected value (weighted average) of surprisal across all possible outcomes.</p><p><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>H</mi><mo>=</mo><mo>−</mo><munder><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><mi>X</mi></mrow></munder><mi>P</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>=</mo><mi>E</mi><mo stretchy="false">[</mo><mi>I</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">H = -\sum_{x \in X} P(x)\log_2(P(x)) = E[I(x)]</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>H</span><span></span><span>=</span><span></span></span><span><span></span><span>−</span><span></span><span><span><span><span><span><span></span><span><span><span>x</span><span>∈</span><span>X</span></span></span></span><span><span></span><span><span>∑</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>P</span><span>(</span><span>x</span><span>)</span><span></span><span><span>lo<span>g</span></span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>P</span><span>(</span><span>x</span><span>))</span><span></span><span>=</span><span></span></span><span><span></span><span>E</span><span>[</span><span>I</span><span>(</span><span>x</span><span>)]</span></span></span></span></span></p><p>Varentropy is calculated as the variance of the surprisal:</p><p><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>V</mi><mo>=</mo><munder><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><mi>X</mi></mrow></munder><mi>P</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>+</mo><mi>H</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><mi>E</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>I</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>−</mo><mi>H</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">V = \sum_{x \in X} P(x)(\log_2(P(x)) + H)^2 = E[(I(x) - H)^2]</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>V</span><span></span><span>=</span><span></span></span><span><span></span><span><span><span><span><span><span></span><span><span><span>x</span><span>∈</span><span>X</span></span></span></span><span><span></span><span><span>∑</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span><span>P</span><span>(</span><span>x</span><span>)</span><span>(</span><span><span>lo<span>g</span></span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>P</span><span>(</span><span>x</span><span>))</span><span></span><span>+</span><span></span></span><span><span></span><span>H</span><span><span>)</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>E</span><span>[(</span><span>I</span><span>(</span><span>x</span><span>)</span><span></span><span>−</span><span></span></span><span><span></span><span>H</span><span><span>)</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span>]</span></span></span></span></span></p><p>High varentropy indicates that some of the values are highly different from others - in other words, some outcomes are much more surprising than others relative to the average surprisal (entropy).</p></template><!--astro:end--></astro-island>
<p>Combined, the two of us give 4 possible states:</p>
<ul>
<li>Low entropy, low varentropy: A very peaked distribution (one highly probable outcome).</li>
<li>Low entropy, high varentropy: A distribution with a few disparate peaks.</li>
<li>High entropy, low varentropy: A uniform or near-uniform distribution.</li>
<li>High entropy, high varentropy: A spread-out but uneven distribution.</li>
</ul>
<h2 id="adaptive-sampling-based-on-entropy--varentropy">Adaptive Sampling based on Entropy &amp; Varentropy</h2>
<p>Now that we have those metrics for uncertainty, we can use them to perform different types of sampling based on the situation.</p>
<h3 id="low-entropy-low-varentropy">Low Entropy, Low Varentropy</h3>
<p><img src="https://www.thariq.io/images/entropix/lowe-lowv.png" alt="Low entropy, low varentropy"/></p><p>This is usually the ideal case. The model is certain not only in what its first option would be, but also what it would choose if the first option was incorrect. Often times this means that the list is ordered in a neat way.</p>
<p>In this case, adaptive sampling would suggest the standard argmax sampling, e.g. choose the token with the highest probabilitly.</p>
<h3 id="low-entropy-high-varentropy">Low Entropy, High Varentropy</h3>
<p><img src="https://www.thariq.io/images/entropix/lowe-highv.png" alt="Low entropy, high varentropy"/></p><p>In this case, the model predicts a few options very highly.</p>
<p>This is a tricky case- it may be representing a whole new branch of output, or it may be representing a few options such as a synonym.</p>
<p>In this case, we may want to “<strong>branch</strong>” by predicting both logits, seeing what paths they take and comparing the results after some point. There are many ways to implement this branching, which deserves its own post.</p>
<p>Depending on the results of the branching, we could take different actions. If we get two branches with fairly equal confidence (as measured by their entropy and varentropy) but with different contents, we could formulate this as a question to the user.</p>
<h3 id="high-entropy-low-varentropy">High Entropy, Low Varentropy</h3>
<p><img src="https://www.thariq.io/images/entropix/highe-lowv.png" alt="High entropy, low varentropy"/></p><p>This state represents a possible low confidence state in the model. It may be seeing something that it doesn’t recognize at all, or all the options may be interchangeable with each other.</p>
<p>The best thing to do here is to help the model get to a higher confidence state. Entropix suggests using a <strong>“thinking” token</strong> here as the next token, e.g. <em>“Wait..”</em></p>
<p>A thinking token is a token that we insert into the output, to make the model realizes it needs to spend more compute time thinking about the answer before giving one.</p>
<p>For example, if the model is predicting <em>“The capital of Germany is Paris”</em> but it is not sure about the answer, it might insert a thinking token and predict <em>“The capital of Germany is Paris… Wait, no, it’s actually Berlin”</em></p>
<h3 id="high-entropy-high-varentropy">High Entropy, High Varentropy</h3>
<p><img src="https://www.thariq.io/images/entropix/highe-highv.png" alt="High entropy, high varentropy"/></p><p>The model has no clear favorite, but it is more certain in some outputs than others. This is a difficult place to be in. One way to think about is that any of the top options may be solid choices (e.g. they are synonyms to each other), and so we should just choose one at random (aka a higher temperature).</p>
<p>We could also branch, or insert thinking tokens like we have done in previous options.</p>
<h2 id="branching-vs-thinking-tokens">Branching vs Thinking Tokens</h2>
<p>Branching &amp; thinking tokens are two different ways of achieving more compute in an uncertain state.</p>
<p>Branching predictions involves following a few logits to see what other tokens they lead to. This is often called MCTS (Monte Carlo Tree Search) and is a method that has been often tried in LLMs to middling success. One of the tradeoffs of branching is that it requires using inference compute in a way where the branches cannot benefit from each others compute.</p>
<p>Thinking tokens are a way of achieving more compute in an uncertain state without sacrificing some of that compute to explore a branch that you might kill. Inserting “Wait…” causes the AI to realize that it might have made a mistake.</p>
<p>Branching vs thinking tokens is overall an open research question, and deserving of another post.</p>
<h2 id="attention-entropy">Attention Entropy</h2>
<p>It’s worth noting that there are other measures of entropy that we might take into account. Entropix uses them slightly to figure out how to modify temperature, but they might be other tools.</p>
<p><strong>Attention Entropy</strong> - How much are your attention heads tend to follow specific tokens, vs pay attention to a large number of tokens in the context.</p>
<p><strong>Attention Agreement</strong> - How much your attention heads are paying attention to the same tokens as each other, vs different ones.</p>
<p>If your heads have low entropy and high agreement, that can be another signal for you to be confident sampling the highest probability. Low agreement might indicate that different heads are contributing to different predictions, and it might be worth branching.</p>
<h2 id="does-this-matter">Does this matter?</h2>
<p>The insights in Entropix feel in many ways fairly easy to understand, and not entirely novel, which has been surprising to many.</p>
<p>Even if the evals don’t show a large benefit yet. But, inference-time techniques like this are easy to experiment with and could be a promising direction for open source hackers to improve reasoning without huge budgets.</p>  </div></div>
  </body>
</html>
