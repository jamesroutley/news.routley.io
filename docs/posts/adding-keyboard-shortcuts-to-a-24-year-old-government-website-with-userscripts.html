<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://wcedmisten.fyi/post/keyboard-shortcuts-userscripts/">Original</a>
    <h1>Adding keyboard shortcuts to a 24 year-old government website with userscripts</h1>
    
    <div id="readability-page-1" class="page"><div><div><h2 id="background">Background</h2>
<!-- --><p>For the past year, I&#39;ve been cleaning the data from the FDA&#39;s 510k database. <!-- --><sup><a href="#user-content-fn-510k-database" id="user-content-fnref-510k-database" data-footnote-ref="true" aria-describedby="footnote-label">1</a></sup></p>
<!-- --><p>This database contains applications for the 510k program, the FDA&#39;s clearance process
that is used for 99% of human medical devices. <!-- --><sup><a href="#user-content-fn-510k-study" id="user-content-fnref-510k-study" data-footnote-ref="true" aria-describedby="footnote-label">2</a></sup></p>
<!-- --><p>A search on archive.org <!-- --><sup><a href="#user-content-fn-archive-search" id="user-content-fnref-archive-search" data-footnote-ref="true" aria-describedby="footnote-label">3</a></sup>
reveals that this website has existed since at least October 18, 2000.
In fact, we can even see what it looked like. Complete with the official comic sans logo at the top.<!-- --></p>
<!-- --><p><img src="https://quintenkonyn.recurse.com/keyboard-shortcuts-userscripts/fda-510k-2000.png" alt="screenshot of the FDA 510k database in October, 2000"/></p>
<!-- --><p>Here is the website as of 2024. Surpisingly, the appearance has not changed much in the last
24 years.</p>
<!-- --><p><img src="https://quintenkonyn.recurse.com/keyboard-shortcuts-userscripts/fda-510k-2024-02-16.png" alt="screenshot of the FDA 510k database in 2024"/></p>
<!-- --><p>The main interface seems almost unchanged since then, a living relic of a simpler time.
Its styling is quite bare, and the pages are all server rendered.
It contains almost no JavaScript, apart from some code for the date picker.</p>
<!-- --><p>Based on the <!-- --><code>.cfm</code> file extension, it seems to be built from a 1995 tool called
Adobe ColdFusion. <!-- --><sup><a href="#user-content-fn-cold-fusion" id="user-content-fnref-cold-fusion" data-footnote-ref="true" aria-describedby="footnote-label">4</a></sup></p>
<!-- --><h2 id="data-entry">Data entry</h2>
<!-- --><p>To clean the data, I&#39;m using the search functionality of the database to find medical devices by name.</p>
<!-- --><p>However, there are a few problems with the data that slow me down.</p>
<!-- --><p>The device and company names are not standardized, and may have abbreviations,
acronyms, or plain old typos.
The website&#39;s search functionality does not provide fuzzy string matching, so finding a device
often takes some trial and error.
My workflow involves me clicking on the search input box, entering a name (possibly several times),
and then highlighting text with a mouse to copy it into another program.</p>
<!-- --><p>This process felt very inefficient. I have to move my hands from the mouse to the keyboard
and back multiple times for each search.</p>
<!-- --><p>I was manually searching for thousands of devices, so every step to optimize the process would be worth it.
Plus, it&#39;s more fun to write code than do manual data entry, so this gave me an opportunity for a fun break.</p>
<!-- --><p>My goal was to extend the website&#39;s functionality so that I could do most of the tasks without leaving the keyboard.</p>
<!-- --><h2 id="userscripts">Userscripts</h2>
<!-- --><p>What are userscripts? A userscript <!-- --><sup><a href="#user-content-fn-userscript" id="user-content-fnref-userscript" data-footnote-ref="true" aria-describedby="footnote-label">5</a></sup>
is basically a JavaScript program written to provide additional features to a website other than
what the original developers intended.<!-- --></p>
<!-- --><p>In this case, to provide keyboard shortcuts to the FDA&#39;s 510k database website.</p>
<!-- --><p>I wanted shortcuts for the following tasks:</p>
<!-- --><ul>
<!-- --><li>opening the search page</li>
<!-- --><li>focusing on the search input for &#34;device name&#34;</li>
<!-- --><li>copying a device&#39;s 510K ID number</li>
<!-- --></ul>
<!-- --><h3 id="violentmonkey">ViolentMonkey</h3>
<!-- --><p>There are a number of browser extensions for supporting userscripts, but the one I used is a tool
called ViolentMonkey. It&#39;s an open source alternative to the more popular extension TamperMonkey.</p>
<!-- --><p>This tool basically provides a nice way to run custom JavaScript on different websites.
It provides an in-browser JavaScript editor, and also allows users to install other people&#39;s
scripts from various userscript repositories.</p>
<!-- --><p>Luckily, because the website is fairly plain HTML, the code for writing these shortcuts was simple.</p>
<!-- --><h3 id="shortcuts">Shortcuts</h3>
<!-- --><p>ViolentMonkey makes it very easy to register shortcuts with its shortcut extension <!-- --><sup><a href="#user-content-fn-vm-shortcut" id="user-content-fnref-vm-shortcut" data-footnote-ref="true" aria-describedby="footnote-label">6</a></sup>.
With this one line in the header, I can easily register shortcuts:<!-- --></p>
<!-- --><pre><code>// @require https:<!-- --><span>//</span>cdn.jsdelivr.net/npm/@violentmonkey/shortcut@1
<!-- --></code></pre>
<!-- --><h3 id="opening-the-search-page">Opening the search page</h3>
<!-- --><p>This was the simplest shortcut to write. We just set the location to the URL of the search page.
When ctrl + alt + n is pressed, the tab is redirected to the search page.</p>
<!-- --><pre><code><span>VM</span>.<!-- --><span>shortcut</span>.<!-- --><span>register</span>(<!-- --><span>&#39;ctrl-alt-n&#39;</span>, <!-- --><span>() =&gt;</span> {
  location.<!-- --><span>href</span> = <!-- --><span>&#39;https://www.accessdata.fda.gov/scripts/cdrh/cfdocs/cfPMN/pmn.cfm&#39;</span>;
});
<!-- --></code></pre>
<!-- --><h3 id="focus-on-the-search-input">Focus on the search input</h3>
<!-- --><p>After opening the search page, I&#39;ll want to focus on the device name input field.</p>
<!-- --><p>Here is the HTML tag for this input. The developers have helpfully given it an ID of <!-- --><code>DeviceName</code>,
so we can use <!-- --><code>document.getElementById()</code> to find it on the page.<!-- --></p>
<!-- --><pre><code><span>&lt;<!-- --><span>input</span> <!-- --><span>type</span>=<!-- --><span>&#34;text&#34;</span> <!-- --><span>name</span>=<!-- --><span>&#34;DeviceName&#34;</span> <!-- --><span>id</span>=<!-- --><span>&#34;DeviceName&#34;</span> <!-- --><span>size</span>=<!-- --><span>&#34;20&#34;</span> <!-- --><span>maxlength</span>=<!-- --><span>&#34;20&#34;</span>&gt;<!-- --></span>
<!-- --></code></pre>
<!-- --><p>Here&#39;s the userscript. We find the element, and then use <!-- --><code>focus()</code> to put our browser focus on it.<!-- --></p>
<!-- --><pre><code><span>VM</span>.<!-- --><span>shortcut</span>.<!-- --><span>register</span>(<!-- --><span>&#39;ctrl-alt-s&#39;</span>, <!-- --><span>() =&gt;</span> {
  <!-- --><span>const</span> input = <!-- --><span>document</span>.<!-- --><span>getElementById</span>(<!-- --><span>&#34;DeviceName&#34;</span>);
  input.<!-- --><span>focus</span>();
});
<!-- --></code></pre>
<!-- --><h3 id="copying-device-id">Copying device ID</h3>
<!-- --><p>The last shortcut is slightly more complex, because it has to handle two cases.
Upon submitting the search form on the website, the next page could be rendered in two ways:</p>
<!-- --><p>If there is only one result, the website displays the details for that result, including the 510k number.</p>
<!-- --><p><img src="https://quintenkonyn.recurse.com/keyboard-shortcuts-userscripts/single-result.png" alt="Single Result"/></p>
<!-- --><p>If there are multiple results, the website displays a table with each 510k number and a link to the details of each submission.</p>
<!-- --><p><img src="https://quintenkonyn.recurse.com/keyboard-shortcuts-userscripts/multiple-results.png" alt="Single Result"/></p>
<!-- --><p>In our code, we check the URL for the string <!-- --><code>?ID=</code>, which is only present on the single-result details page.<!-- --></p>
<!-- --><pre><code><span>if</span> (location.<!-- --><span>href</span>.<!-- --><span>includes</span>(<!-- --><span>&#34;?ID=&#34;</span>)) {
    <!-- -->
} <!-- --><span>else</span> {
    <!-- -->
}
<!-- --></code></pre>
<!-- --><p>Unfortunately, the HTML element that shows the device 510k number does not use the <!-- --><code>id</code> HTML attribute.
So instead, we&#39;ll need to use the xpath of that element.<!-- --></p>
<!-- --><p>The xpath is basically a unique path that provides directions to a nested element in a document.
If the element moves on the page, the xpath would no longer be accurate.
Luckily, due to this page being server templated HTML, the element doesn&#39;t really move around on the page.
If this was a modern JavaScript webapp, we would need a different approach.</p>
<!-- --><p>We can use Firefox&#39;s handy &#34;copy xpath&#34; option from the dev tools to quickly find this value.</p>
<!-- --><p>Now we can use <!-- --><code>window.navigator.clipboard.writeText()</code> to copy the node&#39;s <!-- --><code>innerText</code> value to our clipboard.<!-- --></p>
<!-- --><p>So far we have:</p>
<!-- --><pre><code><span>if</span> (location.<!-- --><span>href</span>.<!-- --><span>includes</span>(<!-- --><span>&#34;?ID=&#34;</span>)) {
    <!-- -->
    <!-- --><span>var</span> xpath = <!-- --><span>&#39;/html/body/div[3]/maxamineignore/div[2]/div[2]/span[2]/table[2]/tbody/tr/td/table/tbody/tr[2]/td/table/tbody/tr/td/table/tbody/tr[2]/td&#39;</span>;
    <!-- --><span>var</span> deviceId = <!-- --><span>document</span>.evaluate(
        xpath,
        <!-- --><span>document</span>,
        <!-- --><span>null</span>,
        <!-- --><span>XPathResult</span>.<!-- --><span>FIRST_ORDERED_NODE_TYPE</span>,
        <!-- --><span>null</span>
    ).<!-- --><span>singleNodeValue</span>.<!-- --><span>innerText</span>;
    
    <!-- --><span>window</span>.<!-- --><span>navigator</span>.<!-- --><span>clipboard</span>.<!-- --><span>writeText</span>(deviceId);
  } <!-- --><span>else</span> {
    <!-- -->
}
<!-- --></code></pre>
<!-- --><p>Now to handle the case where we have multiple responses.
Sometimes we have multiple 510k submissions for the same device.
I&#39;ve arbitrarily been using the oldest one as a tiebreaker, so I&#39;ll write my script to do that too.</p>
<!-- --><p>Similar to before, we&#39;re using the xpath of the table to find it in the document.
Then we find the last row in the table, and get its third child, the column containing the 510K number.
Once we have this column, we get its first child, and write its text to the clipboard.</p>
<!-- --><pre><code>  } <!-- --><span>else</span> {
    <!-- -->
    <!-- --><span>var</span> xpath = <!-- --><span>&#39;/html/body/div[3]/maxamineignore/div[2]/div[2]/span[2]/table[2]/tbody/tr/td/table/tbody&#39;</span>;
    <!-- --><span>var</span> table = <!-- --><span>document</span>.evaluate(
        xpath,
        <!-- --><span>document</span>,
        <!-- --><span>null</span>,
        <!-- --><span>XPathResult</span>.<!-- --><span>FIRST_ORDERED_NODE_TYPE</span>,
        <!-- --><span>null</span>
    ).<!-- --><span>singleNodeValue</span>;

    <!-- --><span>var</span> tableLength = table.<!-- --><span>children</span>.<!-- --><span>length</span>;
    <!-- --><span>var</span> lastRow = table.<!-- --><span>children</span>[tableLength-<!-- --><span>1</span>]
    
    <!-- -->
    <!-- --><span>var</span> deviceId = lastRow.<!-- --><span>children</span>[<!-- --><span>2</span>].<!-- --><span>firstChild</span>.<!-- --><span>text</span>;

    <!-- --><span>window</span>.<!-- --><span>navigator</span>.<!-- --><span>clipboard</span>.<!-- --><span>writeText</span>(deviceId);
  }
<!-- --></code></pre>
<!-- --><p>Finally, we wrap this in a callback for <!-- --><code>VM.shortcut.register()</code> to get our final script.
Now when I press ctrl + shift + c, the 510k number gets automatically written to my clipboard,
saving me from having to manually highlight the 510k number with the mouse.<!-- --></p>
<!-- --><pre><code><span>VM</span>.<!-- --><span>shortcut</span>.<!-- --><span>register</span>(<!-- --><span>&#39;ctrl-shift-c&#39;</span>, <!-- --><span>() =&gt;</span> {
  <!-- --><span>if</span> (location.<!-- --><span>href</span>.<!-- --><span>includes</span>(<!-- --><span>&#34;?ID=&#34;</span>)) {
    <!-- -->
    <!-- --><span>var</span> xpath = <!-- --><span>&#39;/html/body/div[3]/maxamineignore/div[2]/div[2]/span[2]/table[2]/tbody/tr/td/table/tbody/tr[2]/td/table/tbody/tr/td/table/tbody/tr[2]/td&#39;</span>;
    <!-- --><span>var</span> deviceId = <!-- --><span>document</span>.evaluate(
        xpath,
        <!-- --><span>document</span>,
        <!-- --><span>null</span>,
        <!-- --><span>XPathResult</span>.<!-- --><span>FIRST_ORDERED_NODE_TYPE</span>,
        <!-- --><span>null</span>
    ).<!-- --><span>singleNodeValue</span>.<!-- --><span>innerText</span>;

    <!-- --><span>window</span>.<!-- --><span>navigator</span>.<!-- --><span>clipboard</span>.<!-- --><span>writeText</span>(deviceId);
  } <!-- --><span>else</span> {
    <!-- -->
    <!-- --><span>var</span> xpath = <!-- --><span>&#39;/html/body/div[3]/maxamineignore/div[2]/div[2]/span[2]/table[2]/tbody/tr/td/table/tbody&#39;</span>;
    <!-- --><span>var</span> table = <!-- --><span>document</span>.evaluate(
        xpath,
        <!-- --><span>document</span>,
        <!-- --><span>null</span>,
        <!-- --><span>XPathResult</span>.<!-- --><span>FIRST_ORDERED_NODE_TYPE</span>,
        <!-- --><span>null</span>
    ).<!-- --><span>singleNodeValue</span>;

    <!-- --><span>var</span> tableLength = table.<!-- --><span>children</span>.<!-- --><span>length</span>;
    <!-- --><span>var</span> lastRow = table.<!-- --><span>children</span>[tableLength-<!-- --><span>1</span>]

    <!-- -->
    <!-- --><span>var</span> deviceId = lastRow.<!-- --><span>children</span>[<!-- --><span>2</span>].<!-- --><span>firstChild</span>.<!-- --><span>text</span>;

    <!-- --><span>window</span>.<!-- --><span>navigator</span>.<!-- --><span>clipboard</span>.<!-- --><span>writeText</span>(deviceId);
  }
});
<!-- --></code></pre>
<!-- --><h2 id="conclusion">Conclusion</h2>
<!-- --><p>If you find yourself burdened with some repetitive task on a website, I highly recommend trying to
automate some of it with userscripts.</p>
<!-- --><p>The cool part is that you can take this into your own hands and save yourself some time.</p>
<!-- --><p>It&#39;s hard to quantify how much time I&#39;ve saved myself here, but my workflow is definitely
easier now that I have to take my hands off the keyboard less.</p>
<!-- -->
<!-- --></div></div></div>
  </body>
</html>
