<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://bytepawn.com/five-ways-to-reduce-variance-in-ab-testing.html">Original</a>
    <h1>Five ways to reduce variance in A/B testing</h1>
    
    <div id="readability-page-1" class="page"><div>
    <h2>Introduction</h2>
<p>When performing A/B testing, we&#39;re measuring the mean of a metric (such as spend or conversion) on two distinct subsets, and then compare the means to each other. Because of the Central Limit Theorem, the measurement of the two means follows a normal distribution, as does the difference of the two (if A and B are normal, so is A - B).</p>
<p>Relevant Wikipedia articles:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Central_limit_theorem">Central Limit Theorem</a></li>
<li><a href="https://en.wikipedia.org/wiki/Sum_of_normally_distributed_random_variables">Sum of normally distributed random variables</a></li>
</ul>
<p>Relevant Bytepawn articles:</p>
<ul>
<li><a href="https://bytepawn.com/ab-testing-and-the-central-limit-theorem.html">A/B testing and the Central Limit Theorem</a></li>
<li><a href="https://bytepawn.com/beyond-the-central-limit-theorem.html">Beyond the Central Limit Theorem</a></li>
</ul>
<p>Per the above, the variance of the lift (defined here as the difference) is $ s^2 = s_A^2 + s_B^2 $, where $s_A^2$ and $s_B^2$ are the variances of the A and B measurements, respectively, and $ s_i^2 = \frac{ \sigma^2 }{ N_i } $. So $ s^2 \approx \frac{\sigma^2}{N} $, where $\sigma^2$ is is the variance of the metric itself over the entire population.</p>
<p>I will use toy Monte Carlo simulations to illustrate 5 ways to reduce variance in A/B testing:</p>
<ol>
<li>increase sample size</li>
<li>move towards an even split</li>
<li>reduce variance in the metric definition</li>
<li>stratification</li>
<li>CUPED</li>
</ol>
<p>The <a href="https://github.com/mtrencseni/playground/blob/master/Reducing%20variance.ipynb">ipython notebook for this post is up on Github</a>.</p>
<h2>Increase sample size</h2>
<p>The simplest way to reduce variance is to collect more samples, if possible. For every 4x increase of $N$, we get a 2x decrement of $s$. In code:</p>
<div><pre><span></span><code><span>def</span> <span>get_AB_samples</span><span>(</span><span>mu</span><span>,</span> <span>sigma</span><span>,</span> <span>treatment_lift</span><span>,</span> <span>N</span><span>):</span>
    <span>A</span> <span>=</span> <span>list</span><span>(</span><span>normal</span><span>(</span><span>loc</span><span>=</span><span>mu</span>                 <span>,</span> <span>scale</span><span>=</span><span>sigma</span><span>,</span> <span>size</span><span>=</span><span>N</span><span>))</span>
    <span>B</span> <span>=</span> <span>list</span><span>(</span><span>normal</span><span>(</span><span>loc</span><span>=</span><span>mu</span> <span>+</span> <span>treatment_lift</span><span>,</span> <span>scale</span><span>=</span><span>sigma</span><span>,</span> <span>size</span><span>=</span><span>N</span><span>))</span>
    <span>return</span> <span>A</span><span>,</span> <span>B</span>

<span>N</span> <span>=</span> <span>1000</span>
<span>N_multiplier</span> <span>=</span> <span>4</span>
<span>mu</span> <span>=</span> <span>100</span>
<span>sigma</span> <span>=</span> <span>10</span>
<span>treatment_lift</span> <span>=</span> <span>2</span>
<span>num_simulations</span> <span>=</span> <span>1000</span>

<span>print</span><span>(</span><span>&#39;Simulating </span><span>%s</span><span> A/B tests, true treatment lift is </span><span>%d</span><span>...&#39;</span> <span>%</span> <span>(</span><span>num_simulations</span><span>,</span> <span>treatment_lift</span><span>))</span>

<span>n1_lifts</span><span>,</span> <span>n4_lifts</span> <span>=</span> <span>[],</span> <span>[]</span>
<span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>num_simulations</span><span>):</span>
    <span>print</span><span>(</span><span>&#39;</span><span>%d</span><span>/</span><span>%d</span><span>&#39;</span> <span>%</span> <span>(</span><span>i</span><span>,</span> <span>num_simulations</span><span>),</span> <span>end</span><span>=</span><span>&#39;</span><span>\r</span><span>&#39;</span><span>)</span>
    <span>A</span><span>,</span> <span>B</span> <span>=</span> <span>get_AB_samples</span><span>(</span><span>mu</span><span>,</span> <span>sigma</span><span>,</span> <span>treatment_lift</span><span>,</span> <span>N</span><span>)</span>
    <span>n1_lifts</span><span>.</span><span>append</span><span>(</span><span>lift</span><span>(</span><span>A</span><span>,</span> <span>B</span><span>))</span>
    <span>A</span><span>,</span> <span>B</span> <span>=</span> <span>get_AB_samples</span><span>(</span><span>mu</span><span>,</span> <span>sigma</span><span>,</span> <span>treatment_lift</span><span>,</span> <span>N_multiplier</span><span>*</span><span>N</span><span>)</span>
    <span>n4_lifts</span><span>.</span><span>append</span><span>(</span><span>lift</span><span>(</span><span>A</span><span>,</span> <span>B</span><span>))</span>

<span>print</span><span>(</span><span>&#39;N samples  A/B testing, mean lift = </span><span>%.2f</span><span>, variance of lift = </span><span>%.2f</span><span>&#39;</span> <span>%</span> <span>(</span><span>mean</span><span>(</span><span>n1_lifts</span><span>),</span> <span>cov</span><span>(</span><span>n1_lifts</span><span>)))</span>
<span>print</span><span>(</span><span>&#39;4N samples A/B testing, mean lift = </span><span>%.2f</span><span>, variance of lift = </span><span>%.2f</span><span>&#39;</span> <span>%</span> <span>(</span><span>mean</span><span>(</span><span>n4_lifts</span><span>),</span> <span>cov</span><span>(</span><span>n4_lifts</span><span>)))</span>
<span>print</span><span>(</span><span>&#39;Raio of lift variance = </span><span>%.2f</span><span> (expected = </span><span>%.2f</span><span>)&#39;</span> <span>%</span> <span>(</span><span>cov</span><span>(</span><span>n4_lifts</span><span>)</span><span>/</span><span>cov</span><span>(</span><span>n1_lifts</span><span>),</span> <span>1</span><span>/</span><span>N_multiplier</span><span>))</span>

<span>bins</span> <span>=</span> <span>linspace</span><span>(</span><span>-</span><span>2</span><span>,</span> <span>6</span><span>,</span> <span>100</span><span>)</span>
<span>plt</span><span>.</span><span>figure</span><span>(</span><span>figsize</span><span>=</span><span>(</span><span>14</span><span>,</span> <span>7</span><span>))</span>
<span>plt</span><span>.</span><span>hist</span><span>(</span><span>n1_lifts</span><span>,</span> <span>bins</span><span>,</span> <span>alpha</span><span>=</span><span>0.5</span><span>,</span> <span>label</span><span>=</span><span>&#39;N samples&#39;</span><span>)</span>
<span>plt</span><span>.</span><span>hist</span><span>(</span><span>n4_lifts</span><span>,</span> <span>bins</span><span>,</span> <span>alpha</span><span>=</span><span>0.5</span><span>,</span> <span>label</span><span>=</span><span>f</span><span>&#39;</span><span>{</span><span>N_multiplier</span><span>}</span><span>N samples&#39;</span><span>)</span>
<span>plt</span><span>.</span><span>xlabel</span><span>(</span><span>&#39;lift&#39;</span><span>)</span>
<span>plt</span><span>.</span><span>ylabel</span><span>(</span><span>&#39;count&#39;</span><span>)</span>
<span>plt</span><span>.</span><span>legend</span><span>(</span><span>loc</span><span>=</span><span>&#39;upper right&#39;</span><span>)</span>
<span>plt</span><span>.</span><span>title</span><span>(</span><span>&#39;lift histogram&#39;</span><span>)</span>
<span>plt</span><span>.</span><span>show</span><span>()</span>
</code></pre></div>

<p>Prints:</p>
<div><pre><span></span><code><span>Simulating</span><span> </span><span>1000</span><span> </span><span>A</span><span>/</span><span>B</span><span> </span><span>tests</span><span>,</span><span> </span><span>true</span><span> </span><span>treatment</span><span> </span><span>lift</span><span> </span><span>is</span><span> </span><span>2.</span><span>..</span>
<span>N</span><span> </span><span>samples</span><span>  </span><span>A</span><span>/</span><span>B</span><span> </span><span>testing</span><span>,</span><span> </span><span>mean</span><span> </span><span>lift</span><span> </span><span>=</span><span> </span><span>2.00</span><span>,</span><span> </span><span>variance</span><span> </span><span>of</span><span> </span><span>lift</span><span> </span><span>=</span><span> </span><span>0.18</span>
<span>4</span><span>N</span><span> </span><span>samples</span><span> </span><span>A</span><span>/</span><span>B</span><span> </span><span>testing</span><span>,</span><span> </span><span>mean</span><span> </span><span>lift</span><span> </span><span>=</span><span> </span><span>2.01</span><span>,</span><span> </span><span>variance</span><span> </span><span>of</span><span> </span><span>lift</span><span> </span><span>=</span><span> </span><span>0.05</span>
<span>Raio</span><span> </span><span>of</span><span> </span><span>lift</span><span> </span><span>variance</span><span> </span><span>=</span><span> </span><span>0.26</span><span> </span><span>(</span><span>expected</span><span> </span><span>=</span><span> </span><span>0.25</span><span>)</span>
</code></pre></div>

<p><img src="https://bytepawn.com/images/5ways_1.png" alt="5 ways to reduce variance in A/B testing"/></p>
<p>Note: in real life, collecting more samples is not always possible, since the amount of samples may be limited, or there may be a time limit by which we want to conclude the experiment. Also, in many situations, the relationship of the length of time $t$ that the experiment runs and sample size $N$ is sub-linear, because over time users tend to return. In other words, if we run an experiment for 2 weeks, and get $2N$ users, running it for another 2 weeks will probably yield less than $2N$ additional users.</p>
<h2>Move towards an even split</h2>
<p>If we have $N$ samples available to use for A/B testing, one question is, what percent to put into A (control) and what percent to put into B (treatment). Almost always there are risk-management concerns, but it&#39;s worth knowing that in terms of the best lift measurement (lowest variance), the most optimal split is the even split of 50%-50%, and a 20%-80% split is better than a 10%-90%. We can see this with simple math. Suppose our $N$ total samples are split into $pN$ and $(1-p)N$ for A and B variants, then the variance is:</p>
<p>$ s^2 = \frac{ \sigma^2 }{ pN } + \frac{ \sigma^2 }{ (1-p)N } = \frac{ \sigma^2 }{ N } ( \frac{1}{p} + \frac{1}{1-p} ) $.</p>
<!--Let's compare 2 experiments P and Q. In experiment P, our $N$ total samples are split into $pN$ and $(1-p)N$ for A and B variants. In experiment Q, the splits are $qN$ and $(1-q)N$ for A and B. If we compare the variance of the P and the Q measurements:-->

<!--$ s_P^2 = \frac{ \sigma^2 }{ pN } + \frac{ \sigma^2 }{ (1-p)N } = \frac{ \sigma^2 }{ N } ( \frac{1}{p} + \frac{1}{1-p} ) $.-->

<!--$ s_Q^2 = \frac{ \sigma^2 }{ qN } + \frac{ \sigma^2 }{ (1-q)N } = \frac{ \sigma^2 }{ N } ( \frac{1}{q} + \frac{1}{1-q} ) $.-->

<p>So, $ s^2(p) = C ( \frac{1}{p} + \frac{1}{1-p} ) $, which has a minimum at $p=\frac{1}{2}$:</p>
<p><img src="https://bytepawn.com/images/5ways_plot.png" alt="5 ways to reduce variance in A/B testing"/></p>
<!--$ \frac{s_P^2}{s_Q^2} = \frac{ \frac{1}{p} + \frac{1}{1-p} }{ \frac{1}{q} + \frac{1}{1-q} } $-->

<p>The more the split is away from even, the higher the variance compared to the optimal case:</p>
<div><pre><span></span><code><span>def</span> <span>get_AB_samples</span><span>(</span><span>mu</span><span>,</span> <span>sigma</span><span>,</span> <span>treatment_lift</span><span>,</span> <span>N_A</span><span>,</span> <span>N_B</span><span>):</span>
    <span>A</span> <span>=</span> <span>list</span><span>(</span><span>normal</span><span>(</span><span>loc</span><span>=</span><span>mu</span>                 <span>,</span> <span>scale</span><span>=</span><span>sigma</span><span>,</span> <span>size</span><span>=</span><span>N_A</span><span>))</span>
    <span>B</span> <span>=</span> <span>list</span><span>(</span><span>normal</span><span>(</span><span>loc</span><span>=</span><span>mu</span> <span>+</span> <span>treatment_lift</span><span>,</span> <span>scale</span><span>=</span><span>sigma</span><span>,</span> <span>size</span><span>=</span><span>N_B</span><span>))</span>
    <span>return</span> <span>A</span><span>,</span> <span>B</span>

<span>def</span> <span>expected_ratio</span><span>(</span><span>p</span><span>,</span> <span>q</span><span>):</span>
    <span>top</span> <span>=</span> <span>1</span><span>/</span><span>p</span> <span>+</span> <span>1</span><span>/</span><span>(</span><span>1</span><span>-</span><span>p</span><span>)</span>
    <span>bot</span> <span>=</span> <span>1</span><span>/</span><span>q</span> <span>+</span> <span>1</span><span>/</span><span>(</span><span>1</span><span>-</span><span>q</span><span>)</span>
    <span>return</span> <span>top</span><span>/</span><span>bot</span>

<span>N</span> <span>=</span> <span>4000</span>
<span>mu</span> <span>=</span> <span>100</span>
<span>sigma</span> <span>=</span> <span>10</span>
<span>treatment_lift</span> <span>=</span> <span>2</span>
<span>even_ratio</span> <span>=</span> <span>0.5</span>
<span>uneven_ratio</span> <span>=</span> <span>0.9</span>
<span>num_simulations</span> <span>=</span> <span>1000</span>

<span>print</span><span>(</span><span>&#39;Simulating </span><span>%s</span><span> A/B tests, true treatment lift is </span><span>%d</span><span>...&#39;</span> <span>%</span> <span>(</span><span>num_simulations</span><span>,</span> <span>treatment_lift</span><span>))</span>

<span>even_lifts</span><span>,</span> <span>uneven_lifts</span> <span>=</span> <span>[],</span> <span>[]</span>
<span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>num_simulations</span><span>):</span>
    <span>print</span><span>(</span><span>&#39;</span><span>%d</span><span>/</span><span>%d</span><span>&#39;</span> <span>%</span> <span>(</span><span>i</span><span>,</span> <span>num_simulations</span><span>),</span> <span>end</span><span>=</span><span>&#39;</span><span>\r</span><span>&#39;</span><span>)</span>
    <span>A</span><span>,</span> <span>B</span> <span>=</span> <span>get_AB_samples</span><span>(</span><span>mu</span><span>,</span> <span>sigma</span><span>,</span> <span>treatment_lift</span><span>,</span> <span>int</span><span>(</span><span>N</span><span>*</span><span>even_ratio</span><span>),</span> <span>int</span><span>(</span><span>N</span><span>*</span><span>(</span><span>1</span><span>-</span><span>even_ratio</span><span>)))</span>
    <span>even_lifts</span><span>.</span><span>append</span><span>(</span><span>lift</span><span>(</span><span>A</span><span>,</span> <span>B</span><span>))</span>
    <span>A</span><span>,</span> <span>B</span> <span>=</span> <span>get_AB_samples</span><span>(</span><span>mu</span><span>,</span> <span>sigma</span><span>,</span> <span>treatment_lift</span><span>,</span> <span>int</span><span>(</span><span>N</span><span>*</span><span>uneven_ratio</span><span>),</span> <span>int</span><span>(</span><span>N</span><span>*</span><span>(</span><span>1</span><span>-</span><span>uneven_ratio</span><span>)))</span>
    <span>uneven_lifts</span><span>.</span><span>append</span><span>(</span><span>lift</span><span>(</span><span>A</span><span>,</span> <span>B</span><span>))</span>

<span>print</span><span>(</span><span>&#39;Even split   A/B testing, mean lift = </span><span>%.2f</span><span>, variance of lift = </span><span>%.2f</span><span>&#39;</span> <span>%</span> <span>(</span><span>mean</span><span>(</span><span>even_lifts</span><span>),</span>   <span>cov</span><span>(</span><span>even_lifts</span><span>)))</span>
<span>print</span><span>(</span><span>&#39;Uneven split A/B testing, mean lift = </span><span>%.2f</span><span>, variance of lift = </span><span>%.2f</span><span>&#39;</span> <span>%</span> <span>(</span><span>mean</span><span>(</span><span>uneven_lifts</span><span>),</span> <span>cov</span><span>(</span><span>uneven_lifts</span><span>)))</span>
<span>print</span><span>(</span><span>&#39;Raio of lift variance = </span><span>%.2f</span><span> (expected = </span><span>%.2f</span><span>)&#39;</span> <span>%</span> <span>((</span><span>cov</span><span>(</span><span>even_lifts</span><span>)</span><span>/</span><span>cov</span><span>(</span><span>uneven_lifts</span><span>)),</span> <span>expected_ratio</span><span>(</span><span>even_ratio</span><span>,</span> <span>uneven_ratio</span><span>)))</span>
</code></pre></div>

<p>Prints:</p>
<div><pre><span></span><code><span>Simulating</span><span> </span><span>1000</span><span> </span><span>A</span><span>/</span><span>B</span><span> </span><span>tests</span><span>,</span><span> </span><span>true</span><span> </span><span>treatment</span><span> </span><span>lift</span><span> </span><span>is</span><span> </span><span>2.</span><span>..</span>
<span>Even</span><span> </span><span>split</span><span>   </span><span>A</span><span>/</span><span>B</span><span> </span><span>testing</span><span>,</span><span> </span><span>mean</span><span> </span><span>lift</span><span> </span><span>=</span><span> </span><span>1.98</span><span>,</span><span> </span><span>variance</span><span> </span><span>of</span><span> </span><span>lift</span><span> </span><span>=</span><span> </span><span>0.10</span>
<span>Uneven</span><span> </span><span>split</span><span> </span><span>A</span><span>/</span><span>B</span><span> </span><span>testing</span><span>,</span><span> </span><span>mean</span><span> </span><span>lift</span><span> </span><span>=</span><span> </span><span>1.98</span><span>,</span><span> </span><span>variance</span><span> </span><span>of</span><span> </span><span>lift</span><span> </span><span>=</span><span> </span><span>0.29</span>
<span>Raio</span><span> </span><span>of</span><span> </span><span>lift</span><span> </span><span>variance</span><span> </span><span>=</span><span> </span><span>0.36</span><span> </span><span>(</span><span>expected</span><span> </span><span>=</span><span> </span><span>0.36</span><span>)</span>
</code></pre></div>

<p><img src="https://bytepawn.com/images/5ways_2.png" alt="5 ways to reduce variance in A/B testing"/></p>
<h2>Reduce variance in the metric definition</h2>
<p>In the equation $ s^2 = \frac{ \sigma^2 }{ N } $, the previous two methods were increasing the sample size $N$ to reduce $s^2$. Another way to reduce $s^2$ is to reduce the variance $ \sigma^2 $ of the underlying metric itself. I will mention two approaches here:</p>
<p><strong>1. <a href="https://en.wikipedia.org/wiki/Winsorizing">Winsorizing</a>, ie. cutting or normalizing outliers.</strong> For example, if the underlying metric is spend per head, there may be outliers, such as high-value B2B customers among the overall population of B2C customers, or bots appearing to spend a lot of time on a site compared to real users. If we cut-off these values at some $\sigma$ (technically, we can either discard these values or set them to the highest acceptable value), we will get a better measurement of our &#34;real&#34; population:</p>
<div><pre><span></span><code><span>def</span> <span>get_AB_samples</span><span>(</span><span>scale</span><span>,</span> <span>treatment_lift</span><span>,</span> <span>N</span><span>):</span>
    <span>A</span> <span>=</span> <span>list</span><span>(</span><span>exponential</span><span>(</span><span>scale</span><span>=</span><span>scale</span>                 <span>,</span> <span>size</span><span>=</span><span>N</span><span>))</span>
    <span>B</span> <span>=</span> <span>list</span><span>(</span><span>exponential</span><span>(</span><span>scale</span><span>=</span><span>scale</span> <span>+</span> <span>treatment_lift</span><span>,</span> <span>size</span><span>=</span><span>N</span><span>))</span>
    <span># add outliers</span>
    <span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>int</span><span>(</span><span>N</span><span>*</span><span>0.001</span><span>)):</span>
        <span>A</span><span>.</span><span>append</span><span>(</span><span>random</span><span>()</span><span>*</span><span>scale</span><span>*</span><span>100</span><span>)</span>
        <span>B</span><span>.</span><span>append</span><span>(</span><span>random</span><span>()</span><span>*</span><span>scale</span><span>*</span><span>100</span> <span>+</span> <span>treatment_lift</span><span>)</span>
    <span>return</span> <span>A</span><span>,</span> <span>B</span>

<span>N</span> <span>=</span> <span>10</span><span>*</span><span>1000</span>
<span>scale</span> <span>=</span> <span>100</span>
<span>treatment_lift</span> <span>=</span> <span>2</span>
<span>num_simulations</span> <span>=</span> <span>1000</span>

<span>orig_lifts</span><span>,</span> <span>trunc_lifts</span> <span>=</span> <span>[],</span> <span>[]</span>
<span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>num_simulations</span><span>):</span>
    <span>print</span><span>(</span><span>&#39;</span><span>%d</span><span>/</span><span>%d</span><span>&#39;</span> <span>%</span> <span>(</span><span>i</span><span>,</span> <span>num_simulations</span><span>),</span> <span>end</span><span>=</span><span>&#39;</span><span>\r</span><span>&#39;</span><span>)</span>
    <span>A</span><span>,</span> <span>B</span> <span>=</span> <span>get_AB_samples</span><span>(</span><span>scale</span><span>,</span> <span>treatment_lift</span><span>,</span> <span>N</span><span>)</span>
    <span>orig_lifts</span><span>.</span><span>append</span><span>(</span><span>lift</span><span>(</span><span>A</span><span>,</span> <span>B</span><span>))</span>
    <span>A</span><span>,</span> <span>B</span> <span>=</span> <span>[</span><span>x</span> <span>for</span> <span>x</span> <span>in</span> <span>A</span> <span>if</span> <span>x</span> <span>&lt;</span> <span>5</span><span>*</span><span>scale</span><span>],</span> <span>[</span><span>x</span> <span>for</span> <span>x</span> <span>in</span> <span>B</span> <span>if</span> <span>x</span> <span>&lt;</span> <span>5</span><span>*</span><span>scale</span><span>]</span>
    <span>trunc_lifts</span><span>.</span><span>append</span><span>(</span><span>lift</span><span>(</span><span>A</span><span>,</span> <span>B</span><span>))</span>
</code></pre></div>

<p><img src="https://bytepawn.com/images/5ways_3.png" alt="5 ways to reduce variance in A/B testing"/></p>
<p>Another method is to measure the median instead of the mean. Note that with these approaches we are changing the definition of the metric itself. So, for example, Finance&#39;s &#34;spend per head&#34; definition may no longer match the winsorized or median-based definition of the experimentation framework!</p>
<p><strong>2. Measuring a metric further down the funnel.</strong> Suppose we are measuring a metric such as spend per head. We can split this metric into two parts:</p>
<p>(spend per head, overall) = (ratio of users who spend more than 0, conversion) x (spend per head of those who spend more than zero, conditional)</p>
<p>In real-life, the ratio is usually low, less than 10%. In such cases, measuring the two terms (the conversion and the conditional) separately yields lower variance:</p>
<div><pre><span></span><code><span>def</span> <span>get_AB_samples</span><span>(</span><span>p</span><span>,</span> <span>p_lift</span><span>,</span> <span>mu</span><span>,</span> <span>sigma</span><span>,</span> <span>treatment_lift</span><span>,</span> <span>N_A</span><span>,</span> <span>N_B</span><span>):</span>
    <span>A</span> <span>=</span> <span>list</span><span>(</span><span>normal</span><span>(</span><span>loc</span><span>=</span><span>mu</span>                 <span>,</span> <span>scale</span><span>=</span><span>sigma</span><span>,</span> <span>size</span><span>=</span><span>N_A</span><span>))</span>
    <span>B</span> <span>=</span> <span>list</span><span>(</span><span>normal</span><span>(</span><span>loc</span><span>=</span><span>mu</span> <span>+</span> <span>treatment_lift</span><span>,</span> <span>scale</span><span>=</span><span>sigma</span><span>,</span> <span>size</span><span>=</span><span>N_B</span><span>))</span>
    <span>A</span> <span>=</span> <span>[</span><span>x</span> <span>if</span> <span>random</span><span>()</span> <span>&lt;</span> <span>p</span>        <span>else</span> <span>0</span> <span>for</span> <span>x</span> <span>in</span> <span>A</span><span>]</span>
    <span>B</span> <span>=</span> <span>[</span><span>x</span> <span>if</span> <span>random</span><span>()</span> <span>&lt;</span> <span>p</span><span>+</span><span>p_lift</span> <span>else</span> <span>0</span> <span>for</span> <span>x</span> <span>in</span> <span>B</span><span>]</span>
    <span>return</span> <span>A</span><span>,</span> <span>B</span>

<span>N</span> <span>=</span> <span>10</span><span>*</span><span>1000</span>
<span>p</span> <span>=</span> <span>0.1</span>
<span>p_lift</span> <span>=</span> <span>0.01</span>
<span>mu</span> <span>=</span> <span>100</span>
<span>sigma</span> <span>=</span> <span>25</span>
<span>treatment_lift</span> <span>=</span> <span>2</span>
<span>num_simulations</span> <span>=</span> <span>1000</span>

<span>print</span><span>(</span><span>&#39;Simulating </span><span>%s</span><span> A/B tests, true treatment lift is </span><span>%d</span><span>...&#39;</span> <span>%</span> <span>(</span><span>num_simulations</span><span>,</span> <span>treatment_lift</span><span>))</span>

<span>cont_lifts</span><span>,</span> <span>cond_lifts</span><span>,</span> <span>conv_lifts</span> <span>=</span> <span>[],</span> <span>[],</span> <span>[]</span>
<span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>num_simulations</span><span>):</span>
    <span>print</span><span>(</span><span>&#39;</span><span>%d</span><span>/</span><span>%d</span><span>&#39;</span> <span>%</span> <span>(</span><span>i</span><span>,</span> <span>num_simulations</span><span>),</span> <span>end</span><span>=</span><span>&#39;</span><span>\r</span><span>&#39;</span><span>)</span>
    <span>A</span><span>,</span> <span>B</span> <span>=</span> <span>get_AB_samples</span><span>(</span><span>p</span><span>,</span> <span>p_lift</span><span>,</span> <span>mu</span><span>,</span> <span>sigma</span><span>,</span> <span>treatment_lift</span><span>,</span> <span>int</span><span>(</span><span>N</span><span>/</span><span>2</span><span>),</span> <span>int</span><span>(</span><span>N</span><span>/</span><span>2</span><span>))</span>
    <span>cont_lifts</span><span>.</span><span>append</span><span>(</span><span>lift</span><span>(</span><span>A</span><span>,</span> <span>B</span><span>)</span><span>/</span><span>p</span><span>)</span>
    <span>A_</span><span>,</span> <span>B_</span> <span>=</span> <span>[</span><span>x</span> <span>for</span> <span>x</span> <span>in</span> <span>A</span> <span>if</span> <span>x</span> <span>&gt;</span> <span>0</span><span>],</span> <span>[</span><span>x</span> <span>for</span> <span>x</span> <span>in</span> <span>B</span> <span>if</span> <span>x</span> <span>&gt;</span> <span>0</span><span>]</span>
    <span>cond_lifts</span><span>.</span><span>append</span><span>(</span><span>lift</span><span>(</span><span>A_</span><span>,</span> <span>B_</span><span>))</span>
    <span>A_</span><span>,</span> <span>B_</span> <span>=</span> <span>[</span><span>1</span> <span>if</span> <span>x</span> <span>&gt;</span> <span>0</span> <span>else</span> <span>0</span> <span>for</span> <span>x</span> <span>in</span> <span>A</span><span>],</span> <span>[</span><span>1</span> <span>if</span> <span>x</span> <span>&gt;</span> <span>0</span> <span>else</span> <span>0</span> <span>for</span> <span>x</span> <span>in</span> <span>B</span><span>]</span>
    <span>conv_lifts</span><span>.</span><span>append</span><span>(</span><span>lift</span><span>(</span><span>A_</span><span>,</span> <span>B_</span><span>))</span>

<span>bins</span> <span>=</span> <span>linspace</span><span>(</span><span>-</span><span>8</span><span>,</span> <span>12</span><span>,</span> <span>100</span><span>)</span>
<span>plt</span><span>.</span><span>figure</span><span>(</span><span>figsize</span><span>=</span><span>(</span><span>14</span><span>,</span> <span>7</span><span>))</span>
<span>plt</span><span>.</span><span>hist</span><span>(</span><span>cont_lifts</span><span>,</span> <span>bins</span><span>,</span> <span>alpha</span><span>=</span><span>0.5</span><span>,</span> <span>label</span><span>=</span><span>&#39;overall&#39;</span><span>)</span>
<span>plt</span><span>.</span><span>hist</span><span>(</span><span>cond_lifts</span><span>,</span> <span>bins</span><span>,</span> <span>alpha</span><span>=</span><span>0.5</span><span>,</span> <span>label</span><span>=</span><span>&#39;conditional&#39;</span><span>)</span>
<span>plt</span><span>.</span><span>xlabel</span><span>(</span><span>&#39;lift&#39;</span><span>)</span>
<span>plt</span><span>.</span><span>ylabel</span><span>(</span><span>&#39;count&#39;</span><span>)</span>
<span>plt</span><span>.</span><span>legend</span><span>(</span><span>loc</span><span>=</span><span>&#39;upper right&#39;</span><span>)</span>
<span>plt</span><span>.</span><span>title</span><span>(</span><span>&#39;lift histogram&#39;</span><span>)</span>
<span>plt</span><span>.</span><span>show</span><span>()</span>

<span>bins</span> <span>=</span> <span>linspace</span><span>(</span><span>-</span><span>0.1</span><span>,</span> <span>0.1</span><span>,</span> <span>100</span><span>)</span>
<span>plt</span><span>.</span><span>figure</span><span>(</span><span>figsize</span><span>=</span><span>(</span><span>14</span><span>,</span> <span>7</span><span>))</span>
<span>plt</span><span>.</span><span>hist</span><span>(</span><span>conv_lifts</span><span>,</span> <span>bins</span><span>,</span> <span>alpha</span><span>=</span><span>0.5</span><span>,</span> <span>label</span><span>=</span><span>&#39;conversion&#39;</span><span>)</span>
<span>plt</span><span>.</span><span>xlabel</span><span>(</span><span>&#39;lift&#39;</span><span>)</span>
<span>plt</span><span>.</span><span>ylabel</span><span>(</span><span>&#39;count&#39;</span><span>)</span>
<span>plt</span><span>.</span><span>legend</span><span>(</span><span>loc</span><span>=</span><span>&#39;upper right&#39;</span><span>)</span>
<span>plt</span><span>.</span><span>title</span><span>(</span><span>&#39;lift histogram&#39;</span><span>)</span>
<span>plt</span><span>.</span><span>show</span><span>()</span>
</code></pre></div>

<p><img src="https://bytepawn.com/images/5ways_4a.png" alt="5 ways to reduce variance in A/B testing"/></p>
<p><img src="https://bytepawn.com/images/5ways_4b.png" alt="5 ways to reduce variance in A/B testing"/></p>
<h2>Stratification</h2>
<p><a href="https://en.wikipedia.org/wiki/Stratified_sampling">Stratification</a> lowers variance by making sure that each sub-population is sampled according to its split in the overall population. As a toy example, assume there are two sub-populations, M and F, with different distributions. For simplicity let&#39;s assume that the population is exactly 50% M and 50% F. In an A/B test, if we randomly sample the overall population and assign them to A and B, we will on <em>approximately</em> get 50% Ms and 50% Fs in both A and B, but not exactly. This small difference will impact our measurement variance. However, if we make sure that both A and B have <strong>exactly</strong> 50% Ms and 50% Fs, the variance of the measurement is decreased:</p>
<div><pre><span></span><code><span>def</span> <span>get_AB_samples_str</span><span>(</span>
    <span>pop1_mu</span><span>,</span> <span>pop1_sigma</span><span>,</span>
    <span>pop2_mu</span><span>,</span> <span>pop2_sigma</span><span>,</span>
    <span>pop1_ratio</span><span>,</span>
    <span>treatment_lift</span><span>,</span>
    <span>N</span><span>,</span>
<span>):</span>
    <span>A</span> <span>=</span>  <span>list</span><span>(</span><span>normal</span><span>(</span><span>loc</span><span>=</span><span>pop1_mu</span><span>,</span> <span>scale</span><span>=</span><span>pop1_sigma</span><span>,</span> <span>size</span><span>=</span><span>int</span><span>(</span><span>N</span><span>*</span><span>pop1_ratio</span><span>)))</span>
    <span>A</span> <span>+=</span> <span>list</span><span>(</span><span>normal</span><span>(</span><span>loc</span><span>=</span><span>pop2_mu</span><span>,</span> <span>scale</span><span>=</span><span>pop2_sigma</span><span>,</span> <span>size</span><span>=</span><span>int</span><span>(</span><span>N</span><span>*</span><span>(</span><span>1</span><span>-</span><span>pop1_ratio</span><span>))))</span>
    <span>B</span> <span>=</span>  <span>list</span><span>(</span><span>normal</span><span>(</span><span>loc</span><span>=</span><span>pop1_mu</span> <span>+</span> <span>treatment_lift</span><span>,</span> <span>scale</span><span>=</span><span>pop1_sigma</span><span>,</span> <span>size</span><span>=</span><span>int</span><span>(</span><span>N</span><span>*</span><span>pop1_ratio</span><span>)))</span>
    <span>B</span> <span>+=</span> <span>list</span><span>(</span><span>normal</span><span>(</span><span>loc</span><span>=</span><span>pop2_mu</span> <span>+</span> <span>treatment_lift</span><span>,</span> <span>scale</span><span>=</span><span>pop2_sigma</span><span>,</span> <span>size</span><span>=</span><span>int</span><span>(</span><span>N</span><span>*</span><span>(</span><span>1</span><span>-</span><span>pop1_ratio</span><span>))))</span>
    <span>return</span> <span>A</span><span>,</span> <span>B</span>

<span>def</span> <span>get_AB_samples_rnd</span><span>(</span>
    <span>pop1_mu</span><span>,</span> <span>pop1_sigma</span><span>,</span>
    <span>pop2_mu</span><span>,</span> <span>pop2_sigma</span><span>,</span>
    <span>pop1_ratio</span><span>,</span>
    <span>treatment_lift</span><span>,</span>
    <span>N</span><span>,</span>
<span>):</span>
    <span>A</span> <span>=</span> <span>[]</span>
    <span>for</span> <span>_</span> <span>in</span> <span>range</span><span>(</span><span>N</span><span>):</span>
        <span>if</span> <span>random</span><span>()</span> <span>&lt;</span> <span>pop1_ratio</span><span>:</span>
            <span>A</span><span>.</span><span>append</span><span>(</span><span>normal</span><span>(</span><span>loc</span><span>=</span><span>pop1_mu</span><span>,</span> <span>scale</span><span>=</span><span>pop1_sigma</span><span>))</span>
        <span>else</span><span>:</span>
            <span>A</span><span>.</span><span>append</span><span>(</span><span>normal</span><span>(</span><span>loc</span><span>=</span><span>pop2_mu</span><span>,</span> <span>scale</span><span>=</span><span>pop2_sigma</span><span>))</span>
    <span>B</span> <span>=</span> <span>[]</span>
    <span>for</span> <span>_</span> <span>in</span> <span>range</span><span>(</span><span>N</span><span>):</span>
        <span>if</span> <span>random</span><span>()</span> <span>&lt;</span> <span>pop1_ratio</span><span>:</span>
            <span>B</span><span>.</span><span>append</span><span>(</span><span>normal</span><span>(</span><span>loc</span><span>=</span><span>pop1_mu</span> <span>+</span> <span>treatment_lift</span><span>,</span> <span>scale</span><span>=</span><span>pop1_sigma</span><span>))</span>
        <span>else</span><span>:</span>
            <span>B</span><span>.</span><span>append</span><span>(</span><span>normal</span><span>(</span><span>loc</span><span>=</span><span>pop2_mu</span> <span>+</span> <span>treatment_lift</span><span>,</span> <span>scale</span><span>=</span><span>pop2_sigma</span><span>))</span>
    <span>return</span> <span>A</span><span>,</span> <span>B</span>


<span>N</span> <span>=</span> <span>4000</span>
<span>pop1_ratio</span> <span>=</span> <span>0.5</span>
<span>pop1_mu</span> <span>=</span> <span>100</span>
<span>pop2_mu</span> <span>=</span> <span>200</span>
<span>pop1_sigma</span> <span>=</span> <span>pop2_sigma</span> <span>=</span> <span>10</span>
<span>treatment_lift</span> <span>=</span> <span>2</span>
<span>num_simulations</span> <span>=</span> <span>1000</span>

<span>print</span><span>(</span><span>&#39;Simulating </span><span>%s</span><span> A/B tests, true treatment lift is </span><span>%d</span><span>...&#39;</span> <span>%</span> <span>(</span><span>num_simulations</span><span>,</span> <span>treatment_lift</span><span>))</span>

<span>str_lifts</span><span>,</span> <span>rnd_lifts</span> <span>=</span> <span>[],</span> <span>[]</span>
<span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>num_simulations</span><span>):</span>
    <span>print</span><span>(</span><span>&#39;</span><span>%d</span><span>/</span><span>%d</span><span>&#39;</span> <span>%</span> <span>(</span><span>i</span><span>,</span> <span>num_simulations</span><span>),</span> <span>end</span><span>=</span><span>&#39;</span><span>\r</span><span>&#39;</span><span>)</span>
    <span>A</span><span>,</span> <span>B</span> <span>=</span> <span>get_AB_samples_str</span><span>(</span><span>pop1_mu</span><span>,</span> <span>pop1_sigma</span><span>,</span> <span>pop2_mu</span><span>,</span> <span>pop2_sigma</span><span>,</span> <span>pop1_ratio</span><span>,</span> <span>treatment_lift</span><span>,</span> <span>N</span><span>)</span>
    <span>str_lifts</span><span>.</span><span>append</span><span>(</span><span>lift</span><span>(</span><span>A</span><span>,</span> <span>B</span><span>))</span>
    <span>A</span><span>,</span> <span>B</span> <span>=</span> <span>get_AB_samples_rnd</span><span>(</span><span>pop1_mu</span><span>,</span> <span>pop1_sigma</span><span>,</span> <span>pop2_mu</span><span>,</span> <span>pop2_sigma</span><span>,</span> <span>pop1_ratio</span><span>,</span> <span>treatment_lift</span><span>,</span> <span>N</span><span>)</span>
    <span>rnd_lifts</span><span>.</span><span>append</span><span>(</span><span>lift</span><span>(</span><span>A</span><span>,</span> <span>B</span><span>))</span>

<span>print</span><span>(</span><span>&#39;Stratified sampling   A/B testing, mean lift = </span><span>%.2f</span><span>, variance of lift = </span><span>%.2f</span><span>&#39;</span> <span>%</span> <span>(</span><span>mean</span><span>(</span><span>str_lifts</span><span>),</span> <span>cov</span><span>(</span><span>str_lifts</span><span>)))</span>
<span>print</span><span>(</span><span>&#39;Random sampling       A/B testing, mean lift = </span><span>%.2f</span><span>, variance of lift = </span><span>%.2f</span><span>&#39;</span> <span>%</span> <span>(</span><span>mean</span><span>(</span><span>rnd_lifts</span><span>),</span> <span>cov</span><span>(</span><span>rnd_lifts</span><span>)))</span>
<span>print</span><span>(</span><span>&#39;Raio of lift variance = </span><span>%.2f</span><span>&#39;</span> <span>%</span> <span>(</span><span>cov</span><span>(</span><span>str_lifts</span><span>)</span><span>/</span><span>cov</span><span>(</span><span>rnd_lifts</span><span>)))</span>
</code></pre></div>

<p>Prints:</p>
<div><pre><span></span><code><span>Simulating</span><span> </span><span>1000</span><span> </span><span>A</span><span>/</span><span>B</span><span> </span><span>tests</span><span>,</span><span> </span><span>true</span><span> </span><span>treatment</span><span> </span><span>lift</span><span> </span><span>is</span><span> </span><span>2.</span><span>..</span>
<span>Stratified</span><span> </span><span>sampling</span><span>   </span><span>A</span><span>/</span><span>B</span><span> </span><span>testing</span><span>,</span><span> </span><span>mean</span><span> </span><span>lift</span><span> </span><span>=</span><span> </span><span>2.01</span><span>,</span><span> </span><span>variance</span><span> </span><span>of</span><span> </span><span>lift</span><span> </span><span>=</span><span> </span><span>0.05</span>
<span>Random</span><span> </span><span>sampling</span><span>       </span><span>A</span><span>/</span><span>B</span><span> </span><span>testing</span><span>,</span><span> </span><span>mean</span><span> </span><span>lift</span><span> </span><span>=</span><span> </span><span>1.97</span><span>,</span><span> </span><span>variance</span><span> </span><span>of</span><span> </span><span>lift</span><span> </span><span>=</span><span> </span><span>1.28</span>
<span>Raio</span><span> </span><span>of</span><span> </span><span>lift</span><span> </span><span>variance</span><span> </span><span>=</span><span> </span><span>0.04</span>
</code></pre></div>

<p><img src="https://bytepawn.com/images/5ways_5.png" alt="5 ways to reduce variance in A/B testing"/></p>
<p>If we cannot control the sampling of the population, we can also re-weigh samples after data collection is over. Stratification and CUPED are closely related, check section 3.1 and 3.3 of the <a href="https://www.exp-platform.com/Documents/2013-02-CUPED-ImprovingSensitivityOfControlledExperiments.pdf">CUPED paper</a>.</p>
<h2>CUPED</h2>
<p>CUPED is a way to reduce variance in A/B testing if the past historic values of the metric are correlated wit the current values we measure in the experiment. In other words, CUPED works if eg. high spenders before the experiment also tend to be high spenders during the experiment, and the same for low spenders. I have written four articles on CUPED, so I will just link to those:</p>
<ol>
<li><a href="https://bytepawn.com/reducing-variance-in-ab-testing-with-cuped.html">Reducing variance in A/B testing with CUPED</a></li>
<li><a href="https://bytepawn.com/reducing-variance-in-conversion-ab-testing-with-cuped.htm">Reducing variance in conversion A/B testing with CUPED</a></li>
<li><a href="https://bytepawn.com/aa-testing-and-false-positives-with-cuped.html">A/A testing and false positives with CUPED</a></li>
<li><a href="https://bytepawn.com/correlations-seasonality-lift-and-cuped.html">Correlations, seasonality, lift and CUPED</a></li>
</ol>
<h2>Conclusion</h2>
<p>The post used toy examples to show some of the fundamental methods and levers to reduce variance in experiments. It&#39;s worth noting that I used Monte Carlo simulations over many experiments (typically 1,000) to show the decrease in variance, by visualizing the spread of the lift histogram. The point is, in one specific experiment evaluation, the decrease is not visible, since one measurement does not have variance-of-lift by itself (it&#39;s just one specific lift we measure). The rewards of lower variance in A/B testing are reaped in the long term, by having more accurate measurements, making better decisions and releasing better products more quickly.</p>
  </div></div>
  </body>
</html>
