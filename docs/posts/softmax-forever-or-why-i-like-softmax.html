<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kyunghyuncho.me/softmax-forever-or-why-i-like-softmax/">Original</a>
    <h1>Softmax forever, or why I like softmax</h1>
    
    <div id="readability-page-1" class="page"><article id="post-1863">
    <div>
        
        <!-- .entry-header -->

        <div>
                        
<p>[UPDATE: Feb 8 2025] my amazing colleague <a href="https://www.maxwshen.com/">Max Shen</a> noticed a sign mistake in my derivation of the partial derivative of the log-harmonic function below.</p>



<p>i taught my first full-semester course on &lt;Natural Language Processing with Distributed Representation&gt; in fall 2015 (whoa, a decade ago!) you can find the lecture note from this course at <a href="https://arxiv.org/abs/1511.07916">https://arxiv.org/abs/1511.07916</a>. </p>



<p>in one of the lectures, <a href="https://www.linkedin.com/in/dr-david-rosenberg/">David Rosenberg</a>, who was teaching machine learning at NYU back then and had absolutely no reason other than kindness to sit in at my course, asked why we use softmax and whether this is the only way to turn unnormalized real values into a categorial distribution. it was right after i introduce softmax to the class simply as <em>a</em> way to transform a real vector to satisfy (1) non-negativity and (2) normalization: $\frac{\exp(a_i)}{\sum_j \exp(a_j)}$. and, sadly, i was totally stuck, babbled a bit and moved on.</p>



<p>although i could not pull out the answer immediately on the spot (you gotta give my 10-years-younger me a bit of a slack; it was my first full course,) there are a number of reasons why we like softmax. the first reason i often bring up is the principle of maximum entropy, which is how i just introduced softmax to the students at &lt;Machine Learning&gt; this semester. simply put, we can derive softmax by maximizing a weighted sum of the expected negative energy and the shannon entropy. the latter term (the entropy) corresponds to the maximum entropy principle. this is just very nice, and can be extended to work with different inductive biases, such as sparsity (check out this beautiful work <a href="https://arxiv.org/abs/1602.02068">https://arxiv.org/abs/1602.02068</a> by <a href="https://andre-martins.github.io/">Andre Martins</a> and <a href="https://ramon-astudillo.github.io/">Ramon Astudillo</a>, and an extensive follow-up studies summarized in this beautiful talk by Andre; <a href="https://andre-martins.github.io/docs/taln2021.pdf">https://andre-martins.github.io/docs/taln2021.pdf</a>) </p>



<p>the second reason, which is my actual favourite, is that the learning signal we get from softmax is extremely intuitive and interpretable. the partial derivative of log softmax w.r.t. each input real value can be written down as</p>



<p>$$</p>



<p>where $i$ is the target class.</p>



<p>why is this intuitive and interpretable? this gradient says that this categorical distribution defined using softmax should gradually match the extreme categorical distribution where the entire probability mass is concentrated on the target class (correct answer.) as it gets closer and closer to this extreme distribution, that is one of the vertices of the simplex, the gradient norm shrinks and eventually converges toward zero. we can easily see that from the plot below. as learning progresses, the gradient norm shrinks toward 0.</p>



<figure><img fetchpriority="high" decoding="async" width="587" height="432" src="https://kyunghyuncho.me/wp-content/uploads/2025/02/softmax.png" alt="" srcset="https://kyunghyuncho.me/wp-content/uploads/2025/02/softmax.png 587w, https://kyunghyuncho.me/wp-content/uploads/2025/02/softmax-300x221.png 300w" sizes="(max-width: 587px) 100vw, 587px"/><figcaption>the partial derivatives of log-softmax w.r.t. the input to softmax for the target class (blue) and off-target class (orange). aren’t they beautiful?</figcaption></figure>



<p>during the past few days, there was a paper posted on arXiv that claims that so-called harmonic formulation is better than softmax, in terms of training a neural net.<a href="#footnote1" data-type="internal" data-id="#footnote1">*</a> i kinda stopped reading this paper when i noticed that they “<em>trained the MLP models for 7000 epochs and the transformers for 10000 epochs. For all four models, we used the AdamW optimizer with a learning rate of 2×10<sup>−3</sup>, a weight decay of 10<sup>−2</sup>, and an L2 regularization on the embeddings with strength 0.01.</em>” it’s really impossible to choose an arbitrary hyperparameter configuration and empirically compare different learning algorithms. </p>



<p>anyhow, i digressed. instead of further reading this paper, i just wanted to see what this harmonic formulation was. this turned out to be</p>



<p>$$</p>



<p>where $n \geq 1$ is a hyperparameter. this is precisely what David Rosenberg asked me nearly 10 years ago; “<em>why not using squares instead of exponentials?</em>” (paraphrased from my memory)</p>



<p>without thinking much about it, it is easy to see that this formulation is not really friendly to gradient based optimization. let’s look at the partial derivative of the log-harmonic, similarly to that of log-softmax above,</p>



<p>$$</p>



<p>just like before, let’s consider the target and off-target classes separately. first, the target class:</p>



<p>$$</p>



<p>where $q(a_i)$ is the probability of $i$ under the harmonic formulation. the direction (sign) of the derivative is entirely determined by the sign of $a_i$, and it points to the opposite direction. that is, it always drives $a_i$ toward $0$.</p>



<p>it’s the opposite with the off-target class:</p>



<p>$$</p>



<p>depending on which side of the origin $a_i$ is, it is driven toward the negative extreme (either $\infty$ or $-\infty$.) there is a degeneracy at the origin, since this decision (whether to go to $\infty$ or $-\infty$) cannot be broken on its own.</p>



<p>there are two things that make me feel somewhat uncomfortable. first, the minimum for the target class is singular, in that it will likely oscillate, unlike softmax above. second, the magnitude of the derivative w.r.t. the off-target logit is extremely large near the origin (in fact, it diverges) and converges to 0 rapidly as it deviates away from the origin. the magnitude in fact is essentially zero already by $-1$ and $1$, and there won’t be much of a learning signal (i.e. vanishing gradient) unless things were initialized very carefully. one big step early on (when $|a_k| \approx 0$) will result in zero learning signal immediately. these observations are summarized in the following plot:</p>



<figure><img decoding="async" width="598" height="438" src="https://kyunghyuncho.me/wp-content/uploads/2025/02/image-3.png" alt="" srcset="https://kyunghyuncho.me/wp-content/uploads/2025/02/image-3.png 598w, https://kyunghyuncho.me/wp-content/uploads/2025/02/image-3-300x220.png 300w" sizes="(max-width: 598px) 100vw, 598px"/><figcaption>the partial derivatives of log-harmonic w.r.t. the input to the harmonic for the target class (blue) and off-target class (orange). for the target class, we see that the minimum is at exact 0. for the off-target class, the derivative magnitude takes effectively two extreme values; $\infty$ or $0$. ignore the verical orange line at the origin, since it’s just an artifact from my plotting code. pretty scary!</figcaption></figure>



<p>why does it exhibit such an extreme behaviour at the origin? it’s because of the symmetry of the absolute function, $|a_k|$. it’s perfectly fine to either decrease or increase $a_k$ to make the probability associated with $k$ to decrease. the only way for the probability to increase is of $a_k$ to approach $0$ from <em>either</em> side of the origin. such a symmetry makes learning very challenging.</p>



<p>but then … does it really matter? as i told the students at my course last week, learning isn’t optimization, and perhaps it really doesn’t matter as long as we can make little progress at a time with iterative optimization. especially with powerful tools like reverse-mode autodiff, Adam and more, we perhaps don’t have to worry about the gradient of the loss too much.</p>



<p>anyhow, to cap this post, i have to wonder if there is any way to save this approach. one way i can think of is to introduce a margin $m$, such as</p>



<p>$$</p>



<p>and start sounding like <a href="https://cs.nyu.edu/~sumit/publications/assets/ebmtutorial.pdf">Yann LeCun</a>. perhaps another way is to simply give up and enjoy Friday evening with the happy hour drink at the office.</p>



<p>oh, you can reproduce the plots above at <a href="https://github.com/kyunghyuncho/softmax-forever/blob/main/softmax_forever.ipynb">https://github.com/kyunghyuncho/softmax-forever/blob/main/softmax_forever.ipynb</a>.</p>




        </div>
        <!-- .entry-content -->

        
        <!-- .entry-footer -->
    </div>
    <!-- .p-15 -->
</article></div>
  </body>
</html>
