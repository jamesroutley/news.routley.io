<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://rgoswami.me/posts/lowering-resource-usage-foot-systemd/">Original</a>
    <h1>Lowering resource usage with foot and systemd</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>This post is part of the <a href="https://rgoswami.me/series/wayland-wayfinders/">Wayland Wayfinders</a> series.</p></div><blockquote><p>Melding <code>systemd</code> and <code>foot</code> for rapid configuration updates and reduced memory
consumption in <code>sway</code> with persistent <code>tmux</code> state</p></blockquote><h2 id="background">Background</h2><p>Since I often work in strong sunlight, I often want to reconfigure my terminal
to use a light or a dark scheme depending on the time of day. In the process, I
decided to fiddle around with custom <code>systemd</code> targets, since <code>sway</code> isn’t
really good at managing long running processes like my terminal (<code>foot</code>) server.</p><h2 id="starting-point">Starting point</h2><p>Some years ago I ended up with a rather ad-hoc scratchpad configuration,
reproduced for clarity (<a href="https://github.com/HaoZeke/Dotfiles/tree/chezmoi/dot_config/sway">current config here</a>):</p><div><pre tabindex="0"><code data-lang="cfg"><span><span> 1</span><span><span># The main scratchpad in the upper left</span>
</span></span><span><span> 2</span><span><span>for_window [app_id</span><span>=</span><span>&#34;mS&#34;] {
</span></span></span><span><span> 3</span><span><span>    move scratchpad
</span></span></span><span><span> 4</span><span><span>    move position 0 0
</span></span></span><span><span> 5</span><span><span>    resize set 50 ppt 35 ppt
</span></span></span><span><span> 6</span><span><span>    floating enable
</span></span></span><span><span> 7</span><span><span>    border pixel 1</span>
</span></span><span><span> 8</span><span><span>}</span>
</span></span><span><span> 9</span><span><span>bindsym F1 [app_id</span><span>=</span><span>&#34;mS&#34;] scratchpad show; move position 0 0, resize set 50 ppt 35 ppt</span>
</span></span><span><span>10</span><span><span>exec_always foot --app-id</span><span>=</span><span>&#34;mS&#34; -e tmux new -A -s mS</span>
</span></span><span><span>11</span><span>
</span></span><span><span>12</span><span><span># The secondary scratchpad in the center</span>
</span></span><span><span>13</span><span><span>for_window [app_id</span><span>=</span><span>&#34;subFloat&#34;] {
</span></span></span><span><span>14</span><span><span>    move scratchpad
</span></span></span><span><span>15</span><span><span>    move position center
</span></span></span><span><span>16</span><span><span>    floating enable
</span></span></span><span><span>17</span><span><span>    border pixel 1</span>
</span></span><span><span>18</span><span><span>}</span>
</span></span><span><span>19</span><span><span>bindsym F5 exec swaymsg [app_id</span><span>=</span><span>&#34;subFloat&#34;] scratchpad show || exec foot --app-id=&#34;subFloat&#34; -e tmux new -A -s subFloat</span>
</span></span></code></pre></div><p>Which essentially boils down to:</p><ul><li>Put a scratchpad in the upper left bound to <code>F1</code> and resize it to a long thin window<ul><li>Attach or start a <code>tmux</code> session here called <code>mS</code></li></ul></li><li>Put another scratchpad in the center, bound to <code>F5</code><ul><li>Attach or start a <code>tmux</code> session called <code>subFloat</code></li></ul></li></ul><p>When everything works (e.g. at start-up) it essentially leads to a scratchpad
setup like so:</p><figure><img src="https://rgoswami.me/ox-hugo/2024-06-02_14-10-26_screenshot.png"/></figure><p>Additionally, I also have some additional setp for managing terminals:</p><div><pre tabindex="0"><code data-lang="cfg"><span><span>1</span><span><span>set $term_server foot -s</span>
</span></span><span><span>2</span><span><span>set $term footclient</span>
</span></span><span><span>3</span><span><span>exec_always $term_server</span>
</span></span><span><span>4</span><span><span>bindsym $mod+Return exec $term</span>
</span></span></code></pre></div><p>Which ideally starts a <code>foot</code> server, and subsequently spawns <code>footclient</code>
instances on demand.</p><h2 id="annoyances">Annoyances</h2><p>This setup served me quite well, for several years I had no major issues
whatsover, though there were minor annoyances, some of which eventually broke
the camel’s back.</p><h3 id="memory-consumption">Memory consumption</h3><p>The problem is perhaps immediately evident in the narrowed down specification:</p><div><pre tabindex="0"><code data-lang="cfg"><span><span>1</span><span><span>exec_always foot --app-id</span><span>=</span><span>&#34;mS&#34; -e tmux new -A -s mS</span>
</span></span><span><span>2</span><span><span># ...</span>
</span></span><span><span>3</span><span><span>exec_always foot --app-id</span><span>=</span><span>&#34;subFloat&#34; -e tmux new -A -s subFloat</span>
</span></span></code></pre></div><p>Right of the bat, it is rather evident that this configuration will spawn two
instances of <code>foot</code>, one for each scratchpad.</p><figure><img src="https://rgoswami.me/ox-hugo/2024-06-02_14-15-22_screenshot.png" alt="Figure 1: Snapshot of memory consumption (from btop), clients take around 10x less memory"/><figcaption><p><span>Figure 1: </span>Snapshot of memory consumption (from <code>btop</code>), clients take around 10x less memory</p></figcaption></figure><p>On its own, given that I mostly use relatively high-end machines, this was not
really a problem, more an aesthetic annoyance.</p><p>If the main (<code>sway</code>) server is restarted to apply a configuration update it will
not propagate to the scratchpad unless those are also restarted, and <code>sway</code>
isn’t meant to handle long running processes. Essentially, applying a change of
theme via <code>foot.ini</code> (<a href="https://github.com/HaoZeke/Dotfiles/tree/chezmoi/dot_config/foot">crrent config here</a>):</p><div><pre tabindex="0"><code data-lang="cfg"><span><span>1</span><span><span># include = ~/.config/foot/foot.d/theme-acario-light.ini</span>
</span></span><span><span>2</span><span><span>include</span> <span>=</span> <span>~/.config/foot/foot.d/theme-solarized-dark-normal-brights.ini</span>
</span></span></code></pre></div><p>Would entail a whole <code>killall -9 foot</code> song and dance which was also rather
annoying, especially under the current configuration, the <code>tmux</code> sessions would
also die with the <code>foot</code> instances.</p><h3 id="exec-always-doesn-t-restart-failed-processes"><code>exec_always</code> doesn’t restart failed processes</h3><p>Nor should it, as the <a href="https://man.archlinux.org/man/sway.5.en">documentation explicitly mentions</a>, it is basically like
<code>exec</code> but it also gets re-executed after a reload. For something like a
terminal server service, this isn’t exactly what is required at all. Afterall:</p><ul><li>It is independent of the <code>sway</code> configuration</li></ul><p>Or it really should be. On the other hand, some of the settings for the
scratchpads were baked into the configuration. Having to reload the <code>sway</code>
configuration (and redo the <code>tmux</code> state) just because aesthetic changes needed
to be propagated is asinine, and finally annoyed me enough to make the switch to
a real service manager.</p><h2 id="using-systemd-to-offload-management">Using <code>systemd</code> to offload management</h2><p>The solution is to abstract the configuration for the main and helper
scratchpads out of the configuration and also offload management of the process
lifetime to <code>systemd</code>. User configurations for <code>systemd</code> live in
<code>$HOME/.config/systemd/user</code> and require some standard commands for interacting
with them:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span><span># Reload user units, every time files are changed</span>
</span></span><span><span>2</span><span>systemctl --user daemon-reload
</span></span><span><span>3</span><span><span># Start and enable a service</span>
</span></span><span><span>4</span><span>systemctl --user --now foot-server.service
</span></span><span><span>5</span><span><span># Reload or restart, also when files are changed</span>
</span></span><span><span>6</span><span>systemctl --user reload-or-restart foot-server.service
</span></span><span><span>7</span><span><span># Check the status</span>
</span></span><span><span>8</span><span>systemctl --user status foot-server.service
</span></span></code></pre></div><p>There are a few common stanzas which are needed for a minimal service file:</p><div><pre tabindex="0"><code data-lang="systemd"><span><span>1</span><span><span>[Unit]</span>
</span></span><span><span>2</span><span><span>Description</span><span>=</span>
</span></span><span><span>3</span><span><span>[Service]</span>
</span></span><span><span>4</span><span><span>ExecStart</span><span>=</span>
</span></span><span><span>5</span><span><span>Restart</span><span>=</span><span>on-failure</span>
</span></span><span><span>6</span><span><span>[Install]</span>
</span></span><span><span>7</span><span><span>WantedBy</span><span>=</span><span>default.target</span>
</span></span></code></pre></div><p>With much more extensive documentation found in the <code>man</code> pages (or <a href="https://www.freedesktop.org/software/systemd/man/latest/systemd.service.html">online, here</a>).</p><h3 id="terminal-server">Terminal Server</h3><p>The ordering of the services are also fairly obvious, both the scratchpads (and
indeed, the sway terminals) need one primary <code>foot-server</code> instance to be
running at all times. The easiest approach is to reuse <code>XDG_RUNTIME_DIR</code> which
is typically the same as <code>/run/user/$(id -u $USER)/</code>, so the server runs via:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span>/usr/bin/foot --server<span>=</span>/run/user/%U/foot-server.sock
</span></span></code></pre></div><p>Since <code>foot -s</code> doesn’t fork itself, the default <code>Type=simple</code> will suffice.</p><p>Additionally, we will need to ensure that all the <code>footclient</code> instances we call
use the same server socket (as shown in <a href="#sway-scratchpads-and-config">Sway Scratchpads and Config</a>).</p><h3 id="scratchpad-clients">Scratchpad clients</h3><p>The clients themselves are equally simple, except that the <code>[UNIT]</code> stanza will
specify they require <code>foot-server.service</code> and will be run after
<code>foot-server.service</code>.</p><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span>/usr/bin/footclient --server-socket<span>=</span>/run/user/%U/foot-server.sock --app-id<span>=</span><span>&#34;mS&#34;</span> -e tmux new -A -s mS
</span></span></code></pre></div><p>The full configurations are reproduced in the next section.</p><h3 id="tmux-sessions"><code>tmux</code> sessions</h3><p>Additionally, since the goal is to reload <code>foot</code> often via simple <code>killall -9 foot</code> to apply new configurations, it makes sense to add a <code>tmux</code> server into
the mix, which will also be part of the requires and after keys for the
scratchpad clients.</p><p>For this we need to consider some additional options:</p><div><pre tabindex="0"><code data-lang="systemd"><span><span>1</span><span><span>[Service]</span>
</span></span><span><span>2</span><span><span>Type</span><span>=</span><span> # simple (default), forking, oneshot</span>
</span></span><span><span>3</span><span><span>ExecStop</span><span>=</span>
</span></span><span><span>4</span><span><span>RemainAfterExit</span><span>=</span><span>yes</span>
</span></span></code></pre></div><p>Some notes on service types:</p><ul><li>The server will be a <code>forking</code> service, since <code>tmux start-server</code> essentially
puts itself in the background.</li><li>The clients should be <code>oneshot</code>, since they should complete before other
dependent services start<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup></li><li>We need to set remain after exit since we have a “rollback” for our service
(<code>ExecStop</code>) and since we modify system state, i.e. we don’t want to re-run
the service actions without stopping<sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup></li></ul><h3 id="false-starts">False starts</h3><p>I thought I wanted to use sockets (<a href="https://www.freedesktop.org/software/systemd/man/latest/systemd.socket.html">online man-page</a>), but for a constantly
running set of terminals there is very little point. On my machine, the <code>foot</code>
server takes around 20MB-31MB while each client instance is below 1.5MB, so
having a a socket for either the server or the clients made little to no sense.</p><h2 id="complete-configurations">Complete configurations<sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup></h2><figure><img src="https://rgoswami.me/ox-hugo/2024-06-02_14-38-48_screenshot.png" alt="Figure 2: Final single server many client view (via btop)"/><figcaption><p><span>Figure 2: </span>Final single server many client view (via <code>btop</code>)</p></figcaption></figure><h3 id="sway-scratchpads-and-config">Sway Scratchpads and Config</h3><p>The final <code>sway</code> scratchpad setup is essentially:</p><div><pre tabindex="0"><code data-lang="cfg"><span><span> 1</span><span><span># Settings</span>
</span></span><span><span> 2</span><span><span>set {</span>
</span></span><span><span> 3</span><span> <span>$ms_pos border none, move position 0 0, resize set 50 ppt 35 ppt</span>
</span></span><span><span> 4</span><span> <span>$sf_pos border pixel 1, move position center</span>
</span></span><span><span> 5</span><span> <span>$start_ms systemctl --user start foot-ms.service</span>
</span></span><span><span> 6</span><span> <span>$start_sf systemctl --user start foot-subfloat.service</span>
</span></span><span><span> 7</span><span><span>}</span>
</span></span><span><span> 8</span><span><span># The main scratchpad in the upper left</span>
</span></span><span><span> 9</span><span><span>for_window [app_id</span><span>=</span><span>&#34;mS&#34;] {
</span></span></span><span><span>10</span><span><span>    move to scratchpad
</span></span></span><span><span>11</span><span><span>    floating enable
</span></span></span><span><span>12</span><span><span>    $ms_pos</span>
</span></span><span><span>13</span><span><span>}</span>
</span></span><span><span>14</span><span><span>bindsym F1 exec swaymsg [app_id</span><span>=</span><span>&#34;mS&#34;] scratchpad show || $start_ms, $ms_pos</span>
</span></span><span><span>15</span><span>
</span></span><span><span>16</span><span><span># The secondary scratchpad in the center</span>
</span></span><span><span>17</span><span><span>for_window [app_id</span><span>=</span><span>&#34;subFloat&#34;] {
</span></span></span><span><span>18</span><span><span>    move to scratchpad
</span></span></span><span><span>19</span><span><span>    floating enable
</span></span></span><span><span>20</span><span><span>    border pixel 1</span>
</span></span><span><span>21</span><span><span>}</span>
</span></span><span><span>22</span><span><span>bindsym F5 exec swaymsg [app_id</span><span>=</span><span>&#34;subFloat&#34;] scratchpad show || $start_sf, $sf_pos</span>
</span></span></code></pre></div><p>With the bindings changed to point to the same socket as the process:</p><div><pre tabindex="0"><code data-lang="cfg"><span><span>1</span><span><span># Remove exec_always $term_server, infact get rid of it all together, since systemd handles it now</span>
</span></span><span><span>2</span><span><span>set $term footclient --server-socket</span><span>=</span><span>$XDG_RUNTIME_DIR/foot-server.sock</span>
</span></span></code></pre></div><h3 id="systemd-services">Systemd services</h3><div><pre tabindex="0"><code data-lang="systemd"><span><span>1</span><span><span>[Unit]</span>
</span></span><span><span>2</span><span><span>Description</span><span>=</span><span>Foot terminal server</span>
</span></span><span><span>3</span><span>
</span></span><span><span>4</span><span><span>[Service]</span>
</span></span><span><span>5</span><span><span>ExecStart</span><span>=</span><span>/usr/bin/foot --server=/run/user/%U/foot-server.sock</span>
</span></span><span><span>6</span><span><span>Restart</span><span>=</span><span>on-failure</span>
</span></span><span><span>7</span><span>
</span></span><span><span>8</span><span><span>[Install]</span>
</span></span><span><span>9</span><span><span>WantedBy</span><span>=</span><span>default.target</span>
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="systemd"><span><span> 1</span><span><span>[Unit]</span>
</span></span><span><span> 2</span><span><span>Description</span><span>=</span><span>Foot client for tmux session mS</span>
</span></span><span><span> 3</span><span><span>After</span><span>=</span><span>foot-server.service tmux-session-ms.service</span>
</span></span><span><span> 4</span><span><span>Requires</span><span>=</span><span>foot-server.service tmux-session-ms.service</span>
</span></span><span><span> 5</span><span>
</span></span><span><span> 6</span><span><span>[Service]</span>
</span></span><span><span> 7</span><span><span>ExecStart</span><span>=</span><span>/usr/bin/footclient --server-socket=/run/user/%U/foot-server.sock --app-id=&#34;mS&#34; -e tmux new -A -s mS</span>
</span></span><span><span> 8</span><span><span>Restart</span><span>=</span><span>on-failure</span>
</span></span><span><span> 9</span><span>
</span></span><span><span>10</span><span><span>[Install]</span>
</span></span><span><span>11</span><span><span>WantedBy</span><span>=</span><span>default.target</span>
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="systemd"><span><span> 1</span><span><span>[Unit]</span>
</span></span><span><span> 2</span><span><span>Description</span><span>=</span><span>Foot client for tmux session subFloat</span>
</span></span><span><span> 3</span><span><span>After</span><span>=</span><span>foot-server.service tmux-session-subfloat.service</span>
</span></span><span><span> 4</span><span><span>Requires</span><span>=</span><span>foot-server.service tmux-session-subfloat.service</span>
</span></span><span><span> 5</span><span>
</span></span><span><span> 6</span><span><span>[Service]</span>
</span></span><span><span> 7</span><span><span>ExecStart</span><span>=</span><span>/usr/bin/footclient --server-socket=/run/user/%U/foot-server.sock --app-id=&#34;subFloat&#34; -e tmux new -A -s subFloat</span>
</span></span><span><span> 8</span><span><span>Restart</span><span>=</span><span>on-failure</span>
</span></span><span><span> 9</span><span>
</span></span><span><span>10</span><span><span>[Install]</span>
</span></span><span><span>11</span><span><span>WantedBy</span><span>=</span><span>default.target</span>
</span></span></code></pre></div><h4 id="tmux-setup"><code>tmux</code> setup</h4><div><pre tabindex="0"><code data-lang="systemd"><span><span> 1</span><span><span>[Unit]</span>
</span></span><span><span> 2</span><span><span>Description</span><span>=</span><span>Tmux server</span>
</span></span><span><span> 3</span><span><span>After</span><span>=</span><span>network.target</span>
</span></span><span><span> 4</span><span>
</span></span><span><span> 5</span><span><span>[Service]</span>
</span></span><span><span> 6</span><span><span>Type</span><span>=</span><span>forking</span>
</span></span><span><span> 7</span><span><span>ExecStart</span><span>=</span><span>/usr/bin/tmux start-server</span>
</span></span><span><span> 8</span><span><span>ExecStop</span><span>=</span><span>/usr/bin/tmux kill-server</span>
</span></span><span><span> 9</span><span><span>RemainAfterExit</span><span>=</span><span>yes</span>
</span></span><span><span>10</span><span>
</span></span><span><span>11</span><span><span>[Install]</span>
</span></span><span><span>12</span><span><span>WantedBy</span><span>=</span><span>default.target</span>
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="systemd"><span><span> 1</span><span><span>[Unit]</span>
</span></span><span><span> 2</span><span><span>Description</span><span>=</span><span>Tmux session mS</span>
</span></span><span><span> 3</span><span><span>After</span><span>=</span><span>tmux-server.service</span>
</span></span><span><span> 4</span><span><span>Requires</span><span>=</span><span>tmux-server.service</span>
</span></span><span><span> 5</span><span>
</span></span><span><span> 6</span><span><span>[Service]</span>
</span></span><span><span> 7</span><span><span>Type</span><span>=</span><span>oneshot</span>
</span></span><span><span> 8</span><span><span>RemainAfterExit</span><span>=</span><span>yes</span>
</span></span><span><span> 9</span><span><span>ExecStart</span><span>=</span><span>/usr/bin/tmux new-session -s mS -d</span>
</span></span><span><span>10</span><span><span>ExecStop</span><span>=</span><span>/usr/bin/tmux kill-session -t mS</span>
</span></span><span><span>11</span><span>
</span></span><span><span>12</span><span><span>[Install]</span>
</span></span><span><span>13</span><span><span>WantedBy</span><span>=</span><span>default.target</span>
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="systemd"><span><span> 1</span><span><span>[Unit]</span>
</span></span><span><span> 2</span><span><span>Description</span><span>=</span><span>Tmux session subFloat</span>
</span></span><span><span> 3</span><span><span>After</span><span>=</span><span>tmux-server.service</span>
</span></span><span><span> 4</span><span><span>Requires</span><span>=</span><span>tmux-server.service</span>
</span></span><span><span> 5</span><span>
</span></span><span><span> 6</span><span><span>[Service]</span>
</span></span><span><span> 7</span><span><span>Type</span><span>=</span><span>oneshot</span>
</span></span><span><span> 8</span><span><span>RemainAfterExit</span><span>=</span><span>yes</span>
</span></span><span><span> 9</span><span><span>ExecStart</span><span>=</span><span>/usr/bin/tmux new-session -s subFloat -d</span>
</span></span><span><span>10</span><span><span>ExecStop</span><span>=</span><span>/usr/bin/tmux kill-session -t subFloat</span>
</span></span><span><span>11</span><span>
</span></span><span><span>12</span><span><span>[Install]</span>
</span></span><span><span>13</span><span><span>WantedBy</span><span>=</span><span>default.target</span>
</span></span></code></pre></div><h2 id="conclusions">Conclusions</h2><p>Perhaps on modern machines, with many gigabytes of RAM, there is no real benefit
to this approach, however, given that I use a lot of terminals and don’t always
reach for <code>tmux</code>, for me this works out very nicely. It also helps handling
configuration updates to <code>foot</code>, since all instances use the same server.</p><p>Moreover, this setup greatly facilitates changing themes, a feature that is
particularly useful for those who work in varying lighting conditions, like
moving between indoor and outdoor environments. For people who consistently work
in the same environment, this might not be a significant advantage. However, the
persistent <code>tmux</code> services is likely to be useful in any case.</p><p>Nevertheless, the minor annoyances have been quelled, and I had never really
worked with <code>systemd</code> services before barring a few backup setups, so this was
pretty gratifying.</p><hr/><div><h2>Series info</h2><h3>Wayland Wayfinders series</h3><ol><li><a href="https://rgoswami.me/posts/revisiting-wayland-2021-archlinux/">Revisiting Wayland for ArchLinux</a></li><li><b>Lowering resource usage with foot and systemd</b> &lt;-- You are here!</li></ol></div></div></div>
  </body>
</html>
