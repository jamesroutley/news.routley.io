<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.annwan.me/computers/what-why-how-containers/">Original</a>
    <h1>The What, Why and How of Containers</h1>
    
    <div id="readability-page-1" class="page"><div class="page">

            

            <section>
    
    <div>
        <p>Alternate title: <em>An history of OS-Level Virtualisation on UNIX and then Linux</em>.</p>
<p>This post is part of an entry for <a href="https://handmade.network/jam/learning-2024">the Handmade Network’s Learning Jam 2024</a></p>
<h2 id="the-problem">The problem</h2>

   <p><img src="https://www.annwan.me/computers/what-why-how-containers/images/comic_1.png"/></p><h2 id="it-all-starts-with-chroot-unix-1982">It all starts with <code>chroot</code> <em>(UNIX, 1982)</em></h2>
<pre tabindex="0"><code>$ apropos chroot
chroot (1)           - run command or interactive shell with special root directory
chroot (2)           - change root directory
</code></pre><p>Chroot is a kernel mechanism available since early versions of UNIX that allows to run a process as with an alternate root directory. The process shares the kernel and hardware, but only has access to a subtree of the file system.</p>

   <p><img src="https://www.annwan.me/computers/what-why-how-containers/images/comic_2.png"/></p><h2 id="jails-on-free-bsd-freebsd-2000">Jails on Free BSD <em>(FreeBSD, 2000)</em></h2>
<p>FreeBSD jails basically take chroot and build upon it by adding mechanism to isolate and control the use of other system resources beside the filesystem.</p>
<p>The end result is a kernel mechanism that is a complete container implementation:</p>
<ul>
<li>Fully (More or less, depending onthe exact configuration of the jail) isolated userspace</li>
<li>Running on the same kernel as the host</li>
</ul>

   <p><img src="https://www.annwan.me/computers/what-why-how-containers/images/comic_3.png"/></p><h2 id="quick-tangent-control-groups-cgroups-linux-2007-major-update-in-2016">Quick tangent: Control Groups (cgroups) <em>(Linux, 2007, major update in 2016)</em></h2>
<p>Control groups are a mechanism in Linux that allows to control which how much of the system resources a process (and it’s child processes) can use. It wasn’t originally meant for virtualisation, but rather as a system to avoid processes fighting over hardware, and to implement quotas. It however turned out to be very useful when it came to implement containers.</p>
<h2 id="namespaces-linux-starting-2002">Namespaces <em>(Linux, starting 2002)</em></h2>
<p>Namespaces allow to isolate processes within the namespace from the rest with regard to a specific global resource such as mount points, process ids, user ids, interprocess communication, networking or time.</p>
<p>But more crucially they also allow to isolate across cgroups, giving the illusion of being alone on the system.</p>
<h2 id="how-to-make-a-linux-container">How to make a linux container</h2>
<p>With those mechanisms (chroot, cgroups and namespaces) in place creating a container is conceptually relatively simple:</p>
<ul>
<li>First you populate the subtree that your container will have access too, ready to be chroot’ed in</li>
<li>Then you create namespaces for all you need to isolate (this usually includes at least PID, UID, mountpoints and cgroups)</li>
<li>Finally you run your containerized process within your namespaces, chroot’ed to its subtree</li>
</ul>
<h2 id="conclusion">Conclusion</h2>

   <p><img src="https://www.annwan.me/computers/what-why-how-containers/images/comic_end.png"/></p><p>In practice you don’t need to make them from scratch, people already have made systems for managing containers with nicer user interfaces. Those include Docker, LXC and systemd-nspawn just to name a few, and there is probably one just right for your use-case.</p>
<h2 id="sources">Sources</h2>
<ul>
<li>Linux manual pages:
<ul>
<li><a href="https://man7.org/linux/man-pages/man1/chroot.1.html">chroot(1)</a></li>
<li><a href="https://man7.org/linux/man-pages/man2/chroot.2.html">chroot(2)</a></li>
<li><a href="https://man7.org/linux/man-pages/man7/cgroups.7.html">cgroups(7)</a></li>
<li><a href="https://man7.org/linux/man-pages/man7/namespaces.7.html">namespaces(7)</a></li>
</ul>
</li>
<li><a href="https://docs.freebsd.org/en/books/handbook/jails/">Free BSD Handbook: Chapter 17. Jails and Containers</a></li>
<li><a href="https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v2.html">Linux kernel documentation: Control group v2</a></li>
<li>Comic bits inspired by the awesome <a href="https://xkcd.com">XKCD</a></li>
</ul>

    </div>
    

            </section>

            <section>
                
                <hr/>
                <p>
            
            2024-03-24
        </p>
            </section>

            

        </div></div>
  </body>
</html>
