<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tvl.fyi/blog/rewriting-nix">Original</a>
    <h1>Tvix: We Are Rewriting Nix</h1>
    
    <div id="readability-page-1" class="page"><article>

<p>Evaluating the Nix programming language, used by the Nix package
manager, is currently very slow. This becomes apparent in all projects
written in Nix that are not just simple package definitions, for
example:</p>
<ul>
<li>the NixOS module system</li>
<li>TVL projects like
<a href="https://at.tvl.fyi/?q=%2F%2Fnix%2Fyants"><code>//nix/yants</code></a> and
<a href="https://at.tvl.fyi/?q=%2F%2Fweb%2Fbubblegum"><code>//web/bubblegum</code></a>.</li>
<li>the code that <a href="https://at.tvl.fyi/?q=%2F%2Fops%2Fpipelines">generates build
instructions</a> for TVL&#39;s
<a href="https://tvl.fyi/builds">CI setup</a></li>
</ul>
<p>Whichever project you pick, they all suffer from issues with the
language implementation. At TVL, it takes us close to a minute to
create the CI instructions for our monorepo at the moment - despite it
being a plain Nix evaluation. Running our Nix-native build systems for
<a href="https://code.tvl.fyi/about/nix/buildGo">Go</a> and <a href="https://code.tvl.fyi/about/nix/buildLisp">Common
Lisp</a> takes much more time
than we would like.</p>
<p>Some time last year a few of us got together and started investigating
ways to modernise the current architecture of Nix and figure out how
to improve the speed of some of the components. We created over <a href="https://cl.tvl.fyi/q/topic:tvix">250
commits</a> in our fork of the Nix 2.3
codebase at the time, tried <a href="https://cl.tvl.fyi/c/depot/+/1123/">performance
experiments</a> aimed at improving
the current evaluator and fought <a href="https://cl.tvl.fyi/c/depot/+/1504">gnarly
bugs</a>.</p>
<p>After a while we realised that we were treading water: Some of our
ideas are too architecturally divergent from Nix to be done on top of
the existing codebase, and the memory model of Nix causes significant
headaches when trying to do any kind of larger change.</p>
<p>We needed an alternative approach and started brainstorming on a bent
whiteboard in a small flat in Hurghada, Egypt.</p>
<p><img src="https://static.tvl.fyi/latest/files/flokli_tazjin_tvix.webp" alt="flokli &amp; tazjin brainstorming"/></p>
<p>Half a year later we are now ready to announce our new project:
<strong>Tvix</strong>, a re-imagined Nix with full nixpkgs compatibility. Tvix is
generously funded <a href="https://nlnet.nl/project/Tvix/">by NLNet</a> (thanks!)
and we are ready to start implementing it.</p>
<p>The <a href="https://code.tvl.fyi/about/tvix/docs/components.md">Tvix
architecture</a> is
designed to be modular: It should be possible to write an evaluator
that plugs in the Guile language (for compatibility with GNU Guix), to
use arbitrary builders, and to replace the store implementation.</p>
<p>Tvix has these high-level goals:</p>
<ul>
<li>
<p>Creating an alternative implementation of Nix that is <strong>fully
compatible with nixpkgs</strong>.</p>
<p>The package collection is an enormous effort with hundreds of
thousands of commits, encoding expert knowledge about lots of
different software and ways of building and managing it. It is a
very valuable piece of software and we must be able to reuse it.</p>
</li>
<li>
<p>More efficient Nix language evaluation, leading to greatly increased
performance.</p>
</li>
<li>
<p>No more strict separation of evaluation and build phases: Generating
Nix data structures from build artefacts (&#34;IFD&#34;) should be supported
first-class and not incur significant performance cost.</p>
</li>
<li>
<p>Well-defined interaction protocols for how the three different
components (evaluator, builder, store) interact.</p>
</li>
<li>
<p>A builder implementation using OCI instead of custom sandboxing
code.</p>
</li>
</ul>
<p><img src="https://static.tvl.fyi/latest/files/adisbladis_tazjin_tvix.webp" alt="adisbladis &amp; tazjin brainstorming"/></p>
<p>Tvix is not intended to <em>replace</em> Nix, instead we want to improve the
ecosystem by offering an alternative, fast and reliable implementation
for Nix features that are in use today.</p>
<p>As things ramp up we will be posting more information on this blog,
for now you can keep an eye on
<a href="https://cs.tvl.fyi/depot/-/tree/tvix"><code>//tvix</code></a> in the TVL monorepo
and subscribe to <a href="https://tvl.fyi/feed.atom">our feed</a>.</p>
<p>Stay tuned!</p>
<p><span>PS: TVL is international, but a lot of
the development will take place in our office in Moscow. Say hi if
you&#39;re around and interested!</span></p>
</article></div>
  </body>
</html>
