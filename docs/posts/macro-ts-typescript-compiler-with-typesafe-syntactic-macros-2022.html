<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blainehansen.me/post/macro-ts/">Original</a>
    <h1>Macro-ts: TypeScript compiler with typesafe syntactic macros (2022)</h1>
    
    <div id="readability-page-1" class="page"><div><h2 id="i-gotta-have-macros"><a href="#i-gotta-have-macros">Â§</a> I gotta have macros!</h2> <p>Anyone who&#39;s worked with <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">Rust<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a> knows that a <strong>huge</strong> chunk of why it&#39;s so excellent is the macro system. When using a statically typed language, there are simply so many programs that will have mountains of boilerplate if they can&#39;t automatically generate code.</p> <p>Why is this the case? Well, when you&#39;ve committed to using a typesafe language (which you should), there are many small tasks (such as mapping one type to another, or validating a type, or constructing a type with defaults) where the code simply mirrors the structure of the types, and can easily be generated by a rote algorithm. <em>With</em> this capability, the potential tedium of writing typesafe code can be largely removed, and the language is a joy. But <em>without</em> it, the language can become a chore. Typescript is one such language, and it&#39;s insanely incomplete without real macros.</p> <p>Since <a href="https://www.reddit.com/r/WebAssembly/comments/7wlmjt/will_wasm_be_able_to_manipulate_the_dom_ever/" target="_blank" rel="noopener noreferrer">WebAssembly can&#39;t directly interact with the dom (yet)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a>, it&#39;s an unfortunate reality for some of us that we can&#39;t use Rust in <em>all</em> our projects. So when we need to write browser code that performs well, typescript is the only available option that&#39;s acceptably typesafe (I&#39;m a bit of a typesafety fundamentalist ðŸ˜…). But typescript <a href="https://github.com/microsoft/TypeScript/issues/4892" target="_blank" rel="noopener noreferrer">doesn&#39;t have macros<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a>, and it doesn&#39;t seem the core team is terribly interested in the idea. So I decided to do it myself.</p> <p>You may be saying: but <a href="https://blog.logrocket.com/using-typescript-transforms-to-enrich-runtime-code-3fd2863221ed/" target="_blank" rel="noopener noreferrer">typescript <em>does</em> have macros!<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a> However, it&#39;s very important to notice that the transformation process allowed by the typescript compiler <strong>doesn&#39;t typecheck the transformed output</strong>. This makes it unsafe and not very useful.</p> <p><a href="https://www.typescriptlang.org/docs/handbook/advanced-types.html#mapped-types" target="_blank" rel="noopener noreferrer">Mapped<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a> and <a href="https://www.typescriptlang.org/docs/handbook/advanced-types.html#conditional-types" target="_blank" rel="noopener noreferrer">Conditional<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a> types can do some of the work that traditional macros would usually do, but they aren&#39;t nearly complete. They can only transform the program on a <em>type</em> level, which basically just guards the dynamic nature of javascript with (leaky) type safety. True meta-programming, in contrast, can produce actual code.</p> <h2 id="enter-macro-ts"><a href="#enter-macro-ts">Â§</a> Enter <code>macro-ts</code></h2> <p><code>macro-ts</code> is my attempt to solve the above problems, at least in the short term.</p> <p>Here&#39;s the hypothetical example <a href="https://github.com/blainehansen/macro-ts" target="_blank" rel="noopener noreferrer">given in the project README<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a>, which demonstrates all four types of macros: import, block, decorator, and function.</p> <p>You could write code like this:</p> <p>and have it transformed into something like the following, <em>and then fully typechecked</em>:</p> <p>As you can see, a lot of tedium can be removed from your code, while still retaining all the delights of typesafety.</p> <p>Some reasons I&#39;m excited about this project:</p> <ul><li>Makes typesafe &#34;loaders&#34; extremely intuitive. I don&#39;t terribly like webpack, and it&#39;s especially irritating that typesafety is such an afterthought when processing files in other languages. <code>macro-ts</code> could allow things like arbitrary domain specific languages or file preprocessing, all in a typesafe way. The implications of this flexibility are vast.</li> <li>Simply removing verbosity. I very often find myself wanting constructor or validation functions for type aliases, or wanting to trim down some pattern of steps that are all necessary for typesafety. <code>macro-ts</code> enables nice clean reusable solutions for these situations.</li> <li>We don&#39;t have to compromise so often between performance and readability. Macros can be written that wrap the most efficient version of a pattern in an abstraction that looks like a less efficient one. For performance critical hotspots that don&#39;t lend themselves to a webassembly shim, this could be a life-saver.</li> <li>Finally having a convenient way to interact with typescript code. <code>tsc</code> has always been missing both some kind of <code>check</code> command that typechecks the code without actually compiling it, and a <code>run</code> command. <code>ts-node</code> did a great job filling that latter gap (and the <code>run</code> command in <code>macro-ts</code> uses basically the same internal mechanisms as <code>ts-node</code> ðŸ˜‡), but it&#39;s nice to have one tool that unifies all that functionality. Also, I really don&#39;t like json config files. json is such a cluttered and inflexible language to use for human consumption, so the config for <code>macro-ts</code> is in <code>toml</code>.</li></ul> <h2 id="why-ident-it-s-so-ugly"><a href="#why-ident-it-s-so-ugly">Â§</a> Why <code>ident!!</code>? It&#39;s so ugly!</h2> <p>The syntax of the macros has to fit a few critera, which is made more difficult by the fact that <code>macro-ts</code> is an unsanctioned hack on top of typescript. The syntax must be:</p> <ul><li>Accepted by the typescript parser. We can&#39;t change the parser, so we have to hijack some existing syntax.</li> <li>Visually obvious and explicit. A macro usage should be obviously different than the surrounding syntax.</li> <li>Unambiguous. A macro usage shouldn&#39;t conflict with some useful syntax that people are already using.</li></ul> <p>Typescript <code>2.0</code> added the <a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-2-0.html#non-null-assertion-operator" target="_blank" rel="noopener noreferrer">non-null assertion operator<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a>, which one can argue shouldn&#39;t be used since <a href="https://github.com/typescript-eslint/typescript-eslint/blob/master/packages/eslint-plugin/docs/rules/no-non-null-assertion.md" target="_blank" rel="noopener noreferrer">it cancels the benefits of the strict null-checking mode<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a> and can introduce unsafety. However there are times when it&#39;s reasonable, so we shouldn&#39;t just entirely hijack the operator.</p> <p>However using the operator <em>twice</em> never really makes sense, and it&#39;s still technically valid according to typescript. So of all the options I was considering, <code>!!</code> seemed the most reasonable.</p> <p>It also doesn&#39;t hurt that <code>!!</code> mimics the <a href="https://doc.rust-lang.org/rust-by-example/macros.html" target="_blank" rel="noopener noreferrer">Rust macro syntax<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a>.</p> <h2 id="could-this-be-used-for-web-app-bundling"><a href="#could-this-be-used-for-web-app-bundling">Â§</a> Could this be used for web app bundling?</h2> <p>Yeah I think so! Import macros certainly offer that possibility, and as I was designing how they work I kept potential applications like web app bundling in mind.</p> <p>Right now I don&#39;t think it would be terribly easy to do, since I was just focused on getting this typescript-first application out the door. But in the near future I plan to generalize some of the compilation functions so <code>macro-ts</code> could be the foundation of arbitrary specialized compilers, like a typesafe web application bundler.</p> <h2 id="caveat-utilitor"><a href="#caveat-utilitor">Â§</a> Caveat Utilitor</h2> <p>This project is <em>extremely</em> rough around the edges. I wanted to get this project in front of people for feedback sooner rather than later, so I haven&#39;t really put in the elbow grease yet.</p> <ul><li>The macro transformation process completely ruins sourcemaps and type error location values. This is a tricky question that I&#39;m not sure how to completely solve. However, personally I prefer having macros with misaligned type error messages than not having macros at all.</li> <li>Many incredibly obvious performance improvements haven&#39;t been made. Right now the cli does a lot of avoidable duplicated work, doesn&#39;t cache all accesses to the filesystem, and isn&#39;t thinking about using efficient algorithms even a little bit.</li> <li>The cli doesn&#39;t parse command line arguments very intelligently.</li> <li><s>The cli outputs are ugly and inconsistent.</s> I&#39;ve improved the logging quite a bit, but still, I&#39;m no designer.</li> <li>The <code>dev</code> mode concept I&#39;ve implemented so far is too strict and inflexible, and probably not really useful.</li> <li>Internally the code is not as organized as I would prefer.</li></ul> <p>Feedback and pull requests are welcome! This project exists mainly to make my life easier, so whether a pull request gets merged will depend more on if I <em>like</em> it than if it&#39;s a reasonable idea. I&#39;m sure we can still get along ðŸ¤—</p> <h2 id="enjoy"><a href="#enjoy">Â§</a> Enjoy!</h2> <p>I look forward to hearing from you!</p> <p>Once again here&#39;s the repo: <a href="https://github.com/blainehansen/macro-ts" target="_blank" rel="noopener noreferrer"><code>macro-ts</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span>(opens new window)</span></span></a>.</p></div></div>
  </body>
</html>
