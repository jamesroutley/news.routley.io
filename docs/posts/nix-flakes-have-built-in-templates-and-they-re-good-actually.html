<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mulias.github.io/blog/nix-flakes-templates-good-actually/">Original</a>
    <h1>Nix flakes have built in templates and they&#39;re good actually</h1>
    
    <div id="readability-page-1" class="page"><div>
    
    <p><small>
      January 09, 2024
      
        - 
        <span>
          
            <a href="https://mulias.github.io/tags/nix/">nix</a>
          
            <a href="https://mulias.github.io/tags/nix-flake-templates/">nix flake templates</a>
          
            <a href="https://mulias.github.io/tags/tooling/">tooling</a>
          
            <a href="https://mulias.github.io/tags/today-i-learned/">today i learned</a>
          
        </span>
      
    </small>
  </p></div><div>
    <p>Nix <a href="https://nixos.wiki/wiki/Flakes">flakes</a> come with a templating system to quickly initialize dev environments for specific languages or frameworks. I&#39;ve been using Nix for years and had no idea this was a feature!</p>
<p>Shout out to <a href="https://github.com/thomassdk">Thomas Kelly</a> for walking me through this little exercise and probably saving me hours of configuration time on future projects. Thanks Thomas!</p>
<h2 id="setup">Setup</h2>
<p>Nix flakes are &#34;experimental&#34; even though they&#39;ve been around for years and seem pretty popular. You might have to do a little extra config work to get the feature enabled.</p>
<p>For <code>NixOS</code> this means updating <code>/etc/nixos/configuration.nix</code> to add this line:</p>
<pre data-lang="nix"><code data-lang="nix"><span>nix</span><span>.</span><span>settings</span><span>.</span><span>experimental-features </span><span>= </span><span>[ </span><span>&#34;nix-command&#34; &#34;flakes&#34; </span><span>]</span><span>;
</span></code></pre>
<p>For <code>Nix</code> without the <code>OS</code> part see <a href="https://nixos.wiki/wiki/Flakes#Enable_flakes_permanently_in_NixOS">config instructions in the docs</a>.</p>
<h2 id="finding-templates">Finding templates</h2>
<p>List the official templates:</p>
<pre><code><span>$ nix flake show templates
</span><span>github:NixOS/templates/98bc26d94008617aac7cd0244fb09ff04d6c8cf6
</span><span>├───defaultTemplate: template: A very basic flake
</span><span>└───templates
</span><span>    ├───bash-hello: template: An over-engineered Hello World in bash
</span><span>    ├───c-hello: template: An over-engineered Hello World in C
</span><span>    ├───compat: template: A default.nix and shell.nix for backward compatibility with Nix installations that don&#39;t support flakes
</span><span>    ├───full: template: A template that shows all standard flake outputs
</span><span>    ├───go-hello: template: A simple Go package
</span><span>    ├───haskell-hello: template: A Hello World in Haskell with one dependency
</span><span>    ├───haskell-nix: template: An haskell.nix template using hix
</span><span>    ├───hercules-ci: template: An example for Hercules-CI, containing only the necessary attributes for adding to your project.
</span><span>    ├───pandoc-xelatex: template: A report built with Pandoc, XeLaTex and a custom font
</span><span>    ├───python: template: Python template, using poetry2nix
</span><span>    ├───rust: template: Rust template, using Naersk
</span><span>    ├───rust-web-server: template: A Rust web server including a NixOS module
</span><span>    ├───simpleContainer: template: A NixOS container running apache-httpd
</span><span>    └───trivial: template: A very basic flake
</span></code></pre>
<p>I&#39;m told these are not necessarily the best templates to use, since they have pretty limited scope and tend to be out of date.</p>
<p>List community maintained templates from a Github repo:</p>
<pre><code><span>$ nix flake show github:the-nix-way/dev-templates
</span><span>github:the-nix-way/dev-templates/0ea67a261e12a8d02d773cdc588baccf8397cc25
</span><span>└───templates
</span><span>    ├───clojure: template: Clojure development environment
</span><span>    ├───csharp: template: C# development environment
</span><span>    ├───cue: template: Cue development environment
</span><span>    ├───dhall: template: Dhall development environment
</span><span>    ├───elixir: template: Elixir development environment
</span><span>    ├───elm: template: Elm development environment
</span><span>    ├───gleam: template: Gleam development environment
</span><span>    ├───go: template: Go (Golang) development environment
</span><span>    ├───hashi: template: HashiCorp DevOps tools development environment
</span><span>    ├───haskell: template: Haskell development environment
</span><span>    ├───java: template: Java development environment
</span><span>    ├───kotlin: template: Kotlin development environment
</span><span>    ├───latex: template: LaTeX development environment
</span><span>    ├───nickel: template: Nickel development environment
</span><span>    ├───nim: template: Nim development environment
</span><span>    ├───nix: template: Nix development environment
</span><span>    ├───node: template: Node.js development environment
</span><span>    ├───opa: template: Open Policy Agent development environment
</span><span>    ├───php: template: PHP development environment
</span><span>    ├───protobuf: template: Protobuf development environment
</span><span>    ├───pulumi: template: Pulumi development environment
</span><span>    ├───purescript: template: Purescript development environment
</span><span>    ├───python: template: Python development environment
</span><span>    ├───rt: template: Rust development environment with Rust version defined by a rust-toolchain.toml file
</span><span>    ├───ruby: template: Ruby development environment
</span><span>    ├───rust: template: Rust development environment
</span><span>    ├───rust-toolchain: template: Rust development environment with Rust version defined by a rust-toolchain.toml file
</span><span>    ├───scala: template: Scala development environment
</span><span>    ├───shell: template: Shell script development environment
</span><span>    └───zig: template: Zig development environment
</span></code></pre>
<p>Thomas rec&#39;d <a href="https://github.com/the-nix-way/dev-templates">The Nix Way</a> as a high quality source of templates!</p>
<h2 id="using-a-template">Using a template</h2>
<p>Initialize a rust template in the current directory:</p>
<pre><code><span>$ nix flake init -t github:the-nix-way/dev-templates#rust
</span><span>wrote: /home/elias/src/nix-test-too/flake.nix
</span><span>wrote: /home/elias/src/nix-test-too/flake.lock
</span><span>wrote: /home/elias/src/nix-test-too/.envrc
</span></code></pre>
<p>The generated <code>flake.nix</code> defines a baseline development environment for rust projects, while <code>flake.lock</code> acts as a package lock file to track when versions change. Bonus points for the <code>.envrc</code> file to hook into <a href="https://direnv.net/">direnv</a> and auto-load the flake when entering the directory!</p>
<p>Assuming we don&#39;t have <code>direnv</code>, we can use <code>nix develop</code> to enter a new dev shell based on the flake:</p>
<pre><code><span>$ nix develop
</span><span>[dev shell] $ cargo init
</span><span>     Created binary (application) package
</span><span>[dev shell] $ cargo run
</span><span>Hello, world!
</span></code></pre>
<h2 id="flake-integration-with-git-is-kind-of-weird">Flake integration with Git is kind of weird</h2>
<p>If you&#39;re working in a directory that uses Git for version control then your flake files will only work once you <code>git add</code> them to the project. This is mentioned <a href="https://nixos.wiki/wiki/Flakes#Git_WARNING">extremely briefly</a> in the docs. If you aren&#39;t using Git then flakes will work fine.</p>
<p>In the rust example above the directory starts out without version control, but gets initialized with a git repo as part of <code>cargo init</code>. This means if you exit the dev shell and then try to re-run <code>nix develop</code> in the newly version controlled repo you&#39;ll get a cryptic error message:</p>
<pre><code><span>$ nix develop
</span><span>warning: Git tree is dirty
</span><span>error: getting status of &#39;/nix/store/0ccnxa25whszw7mgbgyzdm4nqc0zwnm8-source/flake.nix&#39;: No such file or directory
</span><span>$ git add flake.nix flake.lock
</span><span>$ nix develop
</span><span>warning: Git tree is dirty
</span><span>[dev shell] $ cargo run
</span><span>Hello, world!
</span></code></pre>
<h2 id="open-questions-further-reading">Open questions, further reading</h2>
<p>For the first time in a good while I&#39;m actually excited to learn more about how Nix works!</p>
<p>With regards to flakes I&#39;m still wondering how I&#39;ll go about finding a good flake template for less common dev environments. I also anticipate some issues with using flakes on version controlled projects where I can&#39;t check in the generated files. Not every project is interested in taking on Nix tooling, and in the past I&#39;ve dealt with that by just not checking in my nix shell config to version control.</p>
<p>A few resources I&#39;d like to follow up with to deepen my understanding:</p>
<ul>
<li>
<p>More details about flakes <a href="https://jvns.ca/blog/2023/11/11/notes-on-nix-flakes/">https://jvns.ca/blog/2023/11/11/notes-on-nix-flakes/</a></p>
</li>
<li>
<p>A practical guide to using Nix with a focus on flakes <a href="https://zero-to-nix.com/">https://zero-to-nix.com/</a></p>
</li>
</ul>

  </div></div>
  </body>
</html>
