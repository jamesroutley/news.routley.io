<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/SubscriberLink/967192/6c39d47b5f299a23/">Original</a>
    <h1>How the XZ Backdoor Works</h1>
    
    <div id="readability-page-1" class="page"><div>
<!-- $Id: slink-trial,v 1.1 2005-11-04 21:27:01 corbet Exp $ -->
<center>
<table>
<tbody><tr><td>
<h3>Welcome to LWN.net</h3>
<p>
The following subscription-only content has been made available to you 
by an LWN subscriber.  Thousands of subscribers depend on LWN for the 
best news from the Linux and free software communities.  If you enjoy this 
article, please consider accepting the trial offer on the right.  Thank you
for visiting LWN.net!
</p></td><td>
<div>
<h3>Free trial subscription</h3>
           <p>
           Try LWN for free for 1 month: no payment
           or credit card required.  <a href="https://lwn.net/Promo/slink-trial2-3/claim">Activate
           your trial subscription now</a> and see why thousands of
           readers subscribe to LWN.net.
           
</p></div>
</td>
</tr>

</tbody></table>
</center>

<p>
Versions 5.6.0 and 5.6.1 of the
<a href="https://git.tukaani.org/?p=xz.git;a=summary">XZ</a>
compression utility and library
were shipped with <a href="https://lwn.net/Articles/967180">a backdoor</a> that targeted
<a href="https://www.openssh.com/">OpenSSH</a>.
Andres Freund
<a href="https://lwn.net/ml/oss-security/20240329155126.kjjfduxw2yrlxgzm@awork3.anarazel.de/">
discovered</a> the backdoor by
noticing that <a href="https://lwn.net/Articles/967194/">failed SSH logins were taking a lot of
CPU time</a> while doing some
micro-benchmarking, and tracking down the backdoor from there. It was introduced
by XZ co-maintainer &#34;Jia Tan&#34; — a probable alias for person or persons unknown.
The backdoor is a sophisticated attack with multiple parts, from the build
system, to link time, to run time.
</p>

<p>
The community response to the attack is just as interesting as the technical
aspects. For more information on that, refer to <a href="https://lwn.net/Articles/967866">this
companion article</a>.
</p>

<h4>Build time</h4>

<p>
The backdoor consists of several distinct phases, starting when the package is
being built. Gynvael Coldwind wrote
<a href="https://gynvael.coldwind.pl/?lang=en&amp;id=782">an in-depth investigation</a>
of the build-time parts of the backdoor.
Releases of XZ were provided via GitHub, which has since disabled
the maintainers&#39; accounts and taken the releases offline. Like many projects that
use <a href="https://www.gnu.org/software/autoconf/">GNU Autoconf</a>,
XZ made releases that provided
several versions of the source for
download — an automatically generated tarball containing the source and related
files in the repository, along with versions containing the generated
build files. Those extra files include the <tt>configure</tt> script and makefiles for
the project.
Releasing
versions that contain the generated files allows downstream users of the software to
build without needing to install Autoconf.
</p>

<p>
In this case, however, the scripts in the maintainer-provided source tarballs
were not generated by Autoconf. Instead, one of the build scripts
contained the first stage of the exploit in <tt>m4/build-to-host.m4</tt>. This
script is originally from the <a href="https://www.gnu.org/software/gnulib/">Gnulib</a>
library; it provides a macro that converts
between the style of pathname used by the build environment and the
run-time environment of the program.
The version in these XZ releases was modified to extract the next stage
of the exploit, which is contained in
<tt>tests/files/bad-3-1corrupt_lzma2.xz</tt>.
</p>

<p>
This file is included in the repository, ostensibly as part of XZ&#39;s test suite,
though it was never used by those tests. It was committed well before the
release of version 5.6.0. The file, supposedly a corrupted XZ file,
is actually a valid XZ stream with some bytes
swapped — for example, <tt>0x20</tt> is swapped with occurrences of <tt>0x09</tt>
and vice versa.
When decoded, it yields <a href="https://lwn.net/Articles/967979">a shell script</a> that
unpacks and executes the next stage of the backdoor.
</p>

<p>
The next stage of the backdoor is located in
<tt>tests/files/good-large_compressed.lzma</tt>. This is the
<tt>injected.txt</tt> file
attached to Freund&#39;s message. That file contains more than just the
next stage of the script — it also contains additional binary data that forms
the actual backdoor itself. The final script skips over the header of the file
from which it was extracted, and then uses <tt>awk</tt> to decrypt the remainder
of the file. Finally, that decrypted stream is
decompressed using the XZ command-line program,
in order to extract a pre-compiled file called
<tt>liblzma_la-crc64-fast.o</tt>, which is also attached to Freund&#39;s message.
</p>

<h4>Link time</h4>

<p>
The extracted file is a 64-bit relocatable ELF library.
The remainder of the build process links it into the final <tt>liblzma</tt>
library which ends up being loaded into OpenSSH on some distributions.
Those distributions
<a href="https://sources.debian.org/patches/openssh/1:9.2p1-2%2Bdeb12u2/systemd-readiness.patch/">
patch</a> OpenSSH to use systemd for daemon-readiness notifications;
<tt>libsystemd</tt> in turn depends on liblzma for compressing journal files.
Lennart Poettering has since
<a href="https://mastodon.social/@pid_eins/112202687764571433">posted</a> some
example code showing how to let applications use systemd readiness notifications without
pulling in the entire library.
When the malicious
<tt>liblzma</tt> is used by a dynamically linked process, it uses the
<a href="https://sourceware.org/glibc/wiki/GNU_IFUNC">indirect function</a>
mechanism to involve itself in the <a href="https://lwn.net/Articles/961117">linking process</a>.
</p>

<p>
Indirect functions are a feature of the GNU C library (glibc) that permits a developer to
include several versions of a function and select which version to use at
dynamic linking time. Indirect functions are useful for including optimized versions of a
function that rely on specific hardware features, for example. In this case, the
backdoor provides its own version of the indirect function
resolvers <tt>crc32_resolve()</tt> and <tt>crc64_resolve()</tt> that select
versions of <tt>crc32()</tt> and <tt>crc64()</tt> to use, respectively.
<tt>liblzma</tt> does not usually use indirect functions, but using faster
functions to calculate checksums does sound like a plausible use of the feature.
This plausible deniability is probably why the exploit itself lives in a file
called <tt>liblzma_la-crc64-fast.o</tt>.
</p>

<p>
When the dynamic linker finalizes the locations of those functions, it
calls the backdoor&#39;s resolver functions. At
this point, dynamic linking is still in progress, so many of the
linker&#39;s internal data structures have not yet been made read-only. This would
let the backdoor manipulate libraries that had already been loaded by
overwriting entries in the procedure linkage table (PLT) or global offset table
(GOT). However, <tt>liblzma</tt> is loaded fairly early in the link order of
OpenSSH, which
means that the <a href="https://www.openssl.org/">OpenSSL</a>
cryptography functions that are the backdoor&#39;s ultimate
target may not have been loaded yet.
</p>

<p>
To deal with that, the backdoor adds an
<a href="https://www.man7.org/linux/man-pages/man7/rtld-audit.7.html">
audit hook</a>. The dynamic linker calls all the registered audit hooks
when it is resolving a symbol. The backdoor uses this to wait until it
sees the <a href="https://linux.die.net/man/3/rsa_public_decrypt">
<tt>RSA_public_decrypt@got.plt</tt></a> symbol being resolved. Despite the
name, this function is actually part of handling an RSA signature (which is a
decryption operation) — OpenSSH calls
it while validating an RSA certificate provided by the client
during a connection.
</p>

<h4>Run time</h4>

<p>
Once the backdoor detects this function being linked, it replaces the function
with its
own version. What the altered version does is still being investigated, but at
least one of its functions is to attempt to extract a command from the
public-key
field of the provided RSA certificate (which means that certificates that are
used in this attack cannot actually be used to authenticate normally).
The backdoor checks whether the command is
signed by the attacker&#39;s private key and has valid formatting. If it does, then
the backdoor directly runs the given command as the user running <tt>sshd</tt>,
which is usually root.
</p>

<p>
Anthony Weems has put together
<a href="https://github.com/amlweems/xzbot">an explanation</a> of the run-time
portion of the exploit, including a honeypot to detect attempts to use the
exploit, and code to generate command payloads.
Using the backdoor involves signing the command to be executed with a private
key, but the attacker&#39;s is not available, so the backdoored server needs to be
patched to use another private key.
This also means that detecting backdoored servers remotely is nearly
impossible, since they will not react any differently to connections that don&#39;t
use the attacker&#39;s private key.
</p>

<p>
Ultimately, the effect of the backdoor appears to be that a compromised SSH
server which receives a connection with a hand-crafted RSA certificate for
authentication can be made to run attacker-controlled code.
</p>

<h4>Anti-analysis</h4>

<p>
The design of the backdoor makes it difficult to notice without directly inspecting
<tt>liblzma</tt>. For example, the choice to enable remote code execution rather
than an authentication bypass means that use of the exploit does not detect a
login session that could be noticed by traditional administration tools.
The backdoor&#39;s code
also uses several techniques to make discovery more
difficult.
For example, the string &#34;RSA_public_decrypt@got.plt&#34;,
which is used by the audit hook, never appears in the binary of the exploit.
Instead, it uses a <a href="https://en.wikipedia.org/wiki/Trie">trie</a>
to hold various strings. Serge Bazanski posted
<a href="https://gist.github.com/q3k/af3d93b6a1f399de28fe194add452d01">a
list</a> of strings in the malicious <tt>liblzma</tt> encoded this way.
</p>

<p>
Examining that list shows that <tt>RSA_public_decrypt</tt> is likely not the
only function interfered with; several other cryptography routines are listed.
It also shows various functions and strings that are used to interfere with
OpenSSH&#39;s logging. This is not yet confirmed, but it seems likely that a
compromised SSH server would not actually log any connection attempts that use
the exploit.
</p>

<p>
The backdoor also includes many checks to ensure it is running in the expected
environment — a standard precaution for modern malware that is intended to make
reverse-engineering more difficult. The backdoor is only active
under specific circumstances, including: running in a non-graphical
environment, as root, in a binary located at <tt>/usr/sbin/sshd</tt>, with
<tt>sshd</tt> having the expected ELF header, and where none
of its functions have had a breakpoint inserted by a debugger. Despite these
obstacles,
community efforts to reverse-engineer and explain the remainder of the
backdoor&#39;s code
<a href="https://gist.github.com/smx-smx/a6112d54777845d389bd7126d6e9f504">
remain underway</a>.
</p>

<p>
The backdoor also includes code that patches the binary of <tt>sshd</tt> itself
to disable <a href="https://man7.org/linux/man-pages/man2/seccomp.2.html">
<tt>seccomp()</tt></a> and prevent the program from creating a
<a href="https://en.wikipedia.org/wiki/Chroot">chroot sandbox</a> for
its children. In total, the code of the backdoor is 87KB, which is plenty of
space for additional unpleasant surprises. Many people have put together their
own summaries of the exploit, including
<a href="https://gist.github.com/thesamesam/223949d5a074ebc3dce9ee78baad9e27">
this comprehensive FAQ</a> by Sam James, which links to other resources.
</p>

<h4>Being safe</h4>

<p>
The exploit was caught promptly, so almost no users were affected. Debian sid,
Fedora Rawhide, the Fedora 40 beta,
openSUSE Tumbleweed, and Kali Linux all briefly shipped the
compromised package. NixOS unstable also shipped the compromised version, but was not
vulnerable because it does not patch OpenSSH to link <tt>libsystemd</tt>.
Tan also included
some other changes to the XZ code to make detecting and mitigating the backdoor
more difficult, such as
<a href="https://git.tukaani.org/?p=xz.git;a=blobdiff;f=CMakeLists.txt;h=d2b1af7ab0ab759b6805ced3dff2555e2a4b3f8e;hp=76700591059711e3a4da5b45cf58474dac4e12a7;hb=328c52da8a2bbb81307644efdb58db2c422d9ba7;hpb=eb8ad59e9bab32a8d655796afd39597ea6dcc64d">
sabotaging</a> sandboxing measures and making preemptive efforts to redirect
security reports. Even though the exploit did not reach their stable versions,
several distributions are nonetheless
taking steps to move to a version of XZ that does not contain
any commits from Tan, so users should expect to see security updates related to
that soon. Readers may also
wish to refer to the security notice for their distribution for more specific
information.
</p></div></div>
  </body>
</html>
