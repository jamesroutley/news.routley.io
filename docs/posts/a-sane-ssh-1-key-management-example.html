<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://try.popho.be/ssh-keys.html">Original</a>
    <h1>A sane SSH(1) key management example</h1>
    
    <div id="readability-page-1" class="page"><div id="content">
<p>

Tagged in: <a href="https://try.popho.be/tag_ssh.html">ssh</a>, <a href="https://try.popho.be/tag_security.html">security</a></p>
<p>It’s common knowledge that you <a href="https://en.wiktionary.org/wiki/don%27t_put_all_your_eggs_in_one_basket">shouldn’t
put all your eggs in the same basket</a>, but most of the time on IRC or
on reddit (or the Internet at large, really), I see people using one
single ssh key for all uses. How would you look at someone using a
single key for their car, house, safe, work place, and so on?</p>
<pre><code># /etc/ssh/ssh_config
[...]
#   IdentityFile ~/.ssh/id_rsa
#   IdentityFile ~/.ssh/id_dsa
#   IdentityFile ~/.ssh/id_ecdsa
#   IdentityFile ~/.ssh/id_ed25519
[...]</code></pre>
<p>This causes things like <a href="https://whoami.filippo.io">whoami by
Filippo</a> to work. (NB: it really shouldn’t)</p>

<p>Now, contrary to real life<sup>TM</sup>, <code>ssh(1)</code> can
automatically find a key without much fiddling with a keyring. <a href="https://man.openbsd.org/ssh_config#IdentityFile">See
<code>man 5 ssh_config</code></a>, and the ssh <a href="https://man.openbsd.org/ssh_config#TOKENS">TOKENS</a>.</p>
<pre><code># ~/.ssh/config
# Magic happens here, and it happens for all hosts
IdentityFile ~/.ssh/keys/%h
# Fallback
IdentityFile ~/.ssh/id_rsa</code></pre>
<p>Now, we only need to generate one key per host after we create our
directory structure: <code>umask 077; mkdir -p ~/.ssh/keys</code>. <a href="https://man.openbsd.org/ssh-keygen">ssh-keygen(1)</a> does just
that.</p>
<pre><code>% ssh-keygen -ted25519 -f ~/.ssh/keys/full.host.name</code></pre>
<pre><code>% ssh whoami.filippo.io
no such identity: /home/moviuro/.ssh/keys/whoami.filippo.io: No such file or directory
no such identity: /home/moviuro/.ssh/id_rsa: No such file or directory

    +---------------------------------------------------------------------+
    |                                                                     |
    |             _o/ Hello!                                              |
    |                                                                     |
    |                                                                     |
    |  Did you know that ssh sends all your public keys to any server     |
    |  it tries to authenticate to? You can see yours echoed below.       |
    |                                                                     |
    |  We tried to use them to lookup your GitHub account,                |
    |  but got no match :(                                                |
    |                                                                     |
    |  -- @FiloSottile (https://twitter.com/FiloSottile)                  |
    |                                                                     |
    |                                                                     |
    |  P.S. The source of this server is at                               |
    |  https://github.com/FiloSottile/whoami.filippo.io                   |
    |                                                                     |
    +---------------------------------------------------------------------+</code></pre>
<p>As an added benefit now, if one of your ssh keys ever leaks, there’s
only one place to remove it from <code>~/.ssh/authorized_keys</code>
(where the <code>login@hostname</code> comment is still present).</p>

<ul>
<li><a href="https://carlosbecker.dev/posts/ssh-tips-and-tricks/">SSH
Tips and Tricks</a></li>
<li><a href="https://stribika.github.io/2015/01/04/secure-secure-shell.html">Secure
Secure Shell</a></li>
<li><a href="https://infosec.mozilla.org/guidelines/openssh">Mozilla
OpenSSH guidelines</a></li>
</ul>
</div></div>
  </body>
</html>
