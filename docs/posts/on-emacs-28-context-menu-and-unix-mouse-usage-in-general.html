<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ruzkuku.com/texts/emacs-mouse.html">Original</a>
    <h1>On Emacs 28’ context menu and Unix mouse-usage in general</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>It seems as though an irrational fear of the <em>mouse</em> dominates amongst Un*x dogmatists. Be it because their tools don’t integrate, or because it is a symbol or rebellion, a means to differentiate their prior ignorance from the enlightenment they have attained between the <em>standard input</em> and the <em>standard output</em> stream, the self-emancipation from the mouse is a rite of passage or a shameful burden on those who fail<a href="#fn1" id="fnref1" role="doc-noteref"><sup>1</sup></a> <a href="#fn2" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
<p>As might be clear by my tone, I have little regard for this position. It certainly is worthwhile knowing that and how it is possible to avoid using the mouse, when keyboard shortcuts more convenient<a href="#fn3" id="fnref3" role="doc-noteref"><sup>3</sup></a>, but there is no need for the artificial asceticism of ready-to-use technology, for the sake of purity and dogma.</p>
<p>The denunciation of the mouse usually involves invoking concepts such as the “home row”, or the cumbersome migration of the hand between keyboard and mouse. These might all be well and good, if I were a typist and as such all I did was to type. But this isn’t the case, I ponder and perceive, more than I write.</p>
<p>When debugging code or studying a program, it is quite comfortable to depend on only one hand, and have the other free to scribble or relax. The issue isn’t using a mouse or only using a keyboard, it is context switching.</p>
<hr/>
<p>And now for something mostly different: Speaking of “context”, here is something more concrete:</p>
<p>The more or less recent addition of <code>context-menu-mode</code> by the ever creative <a href="https://jurta.org/en/emacs/">Juri Linkov</a> to Emacs 28 is worth talking about.</p>
<p>The general idea is to provide a <a href="https://en.wikipedia.org/wiki/Context_menu">“context menu”</a> to Emacs, that can be invoked by a simple right click. You might know these kinds of menus from your file manager or browser, where you get fewer or more options, depend on what you clicked. To enabled this feature in Emacs 28 or greater, one simply has to enable the aforementioned <code>context-menu-mode</code> minor mode.</p>
<p>It wouldn’t be Emacs if it ended here! It has to be configurable, extendable and improvable in accordance to the users needs and wants. That is where <code>context-menu-functions</code> comes into play. This is a list of functions used to populate the menu programmatically. In my case, I set it to:</p>
<div id="cb1"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a>(<span>setq</span> context-menu-functions</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a>      &#39;(context-menu-ffap</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a>        occur-context-menu</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a>        context-menu-region</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a>        context-menu-undo</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a>        context-menu-dictionary))</span></code></pre></div>
<p>For example, the first function <code>context-menu-ffap</code> checks if there is a generalized file name wherever I clicked, and in that case it will insert a menu item for me to open whatever I clicked on:</p>
<figure>
<img src="https://ruzkuku.com/images/emacs-context-menu.png" alt=""/><figcaption>An example of the context menu (keep in mind that the UI is specific to my Toolkit, to Emacs)</figcaption>
</figure>
<p>When first playing around with <code>context-menu-mode</code>, my experiments led me to <a href="https://git.savannah.gnu.org/cgit/emacs.git/commit/?id=3eb80b78473b425cdbc251e48aec7cfd9afea2cc">contribute</a> <code>occur-context-menu</code> that generates an occur buffer for the word or symbol at point. As mentioned, this is a nice instrument when debugging<a href="#fn4" id="fnref4" role="doc-noteref"><sup>4</sup></a>.</p>
<p>I’d like to end with a few examples, demonstrating how to extend <code>context-menu-functions</code> with your own functions:</p>

<p>By default this functionality is bound to <code>M-s h .</code>, and I find it useful for debugging terse or complicated code. If we want to use the mouse instead, a <code>...-at-mouse</code> command can be defined, together with a function placed in <code>context-menu-functions</code> that adds entries to the menu using <code>define-key-after</code>:</p>
<div id="cb2"><pre><code><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a>(<span>defun</span><span> highlight-symbol-at-mouse </span>(e)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>  <span>&#34;Highlight symbol at mouse click E.&#34;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>  (interactive <span>&#34;e&#34;</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>  (save-excursion</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>    (mouse-set-point e)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>    (highlight-symbol-at-point)))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>(<span>defun</span><span> context-menu-highlight-symbol </span>(menu click)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>  <span>&#34;Populate MENU with command to search online.&#34;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>  (save-excursion</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>    (mouse-set-point click)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>    (<span>when</span> (symbol-at-point)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>      (define-key-after menu [highlight-search-separator] menu-bar-separator)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>      (define-key-after menu [highlight-search-mouse]</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a>        &#39;(menu-item <span>&#34;Highlight Symbol&#34;</span> highlight-symbol-at-mouse</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a>                    :help <span>&#34;Highlight symbol at point&#34;</span>))))</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true"></a>  menu)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true"></a>(add-hook &#39;context-menu-functions #&#39;context-menu-highlight-symbol)</span></code></pre></div>
<p>Notice how <code>context-menu-highlight-symbol</code> only adds <code>highlight-symbol-at-mouse</code> if <code>symbol-at-point</code> indicates that there is a symbol that could be highlighted.</p>

<p>A popular feature from other text editors is to easily search for something online. The command <code>mouse-online-search-at-point</code> implements something like this. As before, the command could be bound directly to some mouse key<a href="#fn5" id="fnref5" role="doc-noteref"><sup>5</sup></a>, but to add it to the context menu we define another hook function:</p>
<div id="cb3"><pre><code><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a>(<span>require</span> &#39;eww)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>(<span>defun</span><span> mouse-online-search-at-point </span>(e)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>  <span>&#34;Search for word at point or selection.&#34;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>  (interactive <span>&#34;e&#34;</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>  (<span>let</span> ((query (<span>if</span> (region-active-p)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>                   (buffer-substring (region-beginning)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a>                                     (region-end))</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>                 (save-excursion</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>                   (mouse-set-point e)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a>                   (thing-at-point &#39;symbol)))))</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a>    (<span>unless</span> query</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a>      (user-error <span>&#34;Nothing to search for&#34;</span>))</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a>    (browse-url (concat</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a>                 eww-search-prefix</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true"></a>                 (mapconcat #&#39;url-hexify-string (split-string query) <span>&#34;+&#34;</span>)))))</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true"></a>(<span>defun</span><span> context-menu-online-search </span>(menu click)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true"></a>  <span>&#34;Populate MENU with command to search online.&#34;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true"></a>  (save-excursion</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true"></a>    (mouse-set-point click)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true"></a>    (define-key-after menu [online-search-separator] menu-bar-separator)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true"></a>    (define-key-after menu [online-search-at-mouse]</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true"></a>      &#39;(menu-item <span>&#34;Online search&#34;</span> mouse-online-search-at-point</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true"></a>                  :help <span>&#34;Search for region or word online&#34;</span>)))</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true"></a>  menu)</span></code></pre></div>
<p>Modify <code>eww-search-prefix</code> to use a different search engine.</p>

<p>Another idea is to open man page, when clicking something like <code>emacs(1)</code>. This uses <code>man.el</code> (but could just as well use <code>woman.el</code>) to display the requested page.</p>
<div id="cb4"><pre><code><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a>(<span>defun</span><span> man-at-mouse </span>(e)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>  <span>&#34;Open man manual at point.&#34;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>  (interactive <span>&#34;e&#34;</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a>  (save-excursion</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a>    (mouse-set-point e)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>    (man (Man-default-man-entry))))</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a>(<span>defun</span><span> man-context-menu </span>(menu click)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>  <span>&#34;Populate MENU with commands that open a man page at point.&#34;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>  (save-excursion</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a>    (mouse-set-point click)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a>    (<span>when</span> (save-excursion</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a>            (skip-syntax-backward <span>&#34;^ &#34;</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a>            (<span>and</span> (looking-at</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a>                  <span>&#34;[[:space:]]*</span><span>\\</span><span>([[:alnum:]_-]+([[:alnum:]]+)</span><span>\\</span><span>)&#34;</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a>                  (match-string <span>1</span>)))</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true"></a>      (define-key-after menu [man-separator] menu-bar-separator)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true"></a>      (define-key-after menu [man-at-mouse]</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true"></a>    &#39;(menu-item <span>&#34;Open man page&#34;</span> man-at-mouse</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true"></a>            :help <span>&#34;Open man page around mouse click&#34;</span>))))</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true"></a>  menu)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true"></a>(add-hook &#39;context-menu-functions #&#39;man-context-menu)</span></code></pre></div>
<p>This could be extended to only offer displaying a man page, if it actually exists, and not just if something looks like a man page reference.</p>
<hr/>
<p>Emacs 28 has not yet been released, but pre-releases have been marked. If you want to try out this or other features, <a href="https://git.savannah.gnu.org/cgit/emacs.git/tree/INSTALL">download</a> the pre-release or clone the <code>emacs-28</code> branch of development repository to try it out, and <a href="https://www.gnu.org/software/emacs/manual/html_node/efaq/Reporting-bugs.html">report bugs</a> if you find any!</p>

</div></div>
  </body>
</html>
