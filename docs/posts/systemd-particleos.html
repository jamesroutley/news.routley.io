<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/systemd/particleos">Original</a>
    <h1>systemd ParticleOS</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">ParticleOS is a fully customizable immutable distribution implementing the
concepts described in
<a href="https://0pointer.net/blog/fitting-everything-together.html" rel="nofollow">Fitting Everything Together</a>.</p>
<p dir="auto">The crucial difference that makes ParticleOS unique compared to other immutable
distributions is that users build the ParticleOS image themselves and sign it
with their own keys instead of installing vendor signed images. This allows
configuring the image to your liking by having full control over which
distribution is used as the base and which packages are installed into the
image.</p>
<p dir="auto">The ParticleOS image is built using <a href="https://github.com/systemd/mkosi">mkosi</a>.</p>
<p dir="auto">First, configure the variant you&#39;d like to build in <code>mkosi.local.conf</code>. For a
desktop system, you&#39;ll want the <code>desktop</code> profile and either the <code>gnome</code> or the
<code>kde</code> profile.</p>
<div data-snippet-clipboard-copy-content="[Distribution]
Distribution=arch

[Config]
Profiles=desktop,kde"><pre lang="conf"><code>[Distribution]
Distribution=arch

[Config]
Profiles=desktop,kde
</code></pre></div>
<p dir="auto">To build the image, run <code>mkosi -f</code> from the ParticleOS repository. Currently
both <code>arch</code> and <code>fedora</code> are supported distributions. Implementing support for a
new distribution (that&#39;s already supported in mkosi) is as simple as writing the
necessary config files to install the required packages for that distribution.</p>
<p dir="auto">To update the system after installation, you clone the ParticleOS repository
or your fork of it, make sure <code>mkosi.local.conf</code> is configured to your liking and
run <code>mkosi -ff sysupdate -- update --reboot</code> which will update the system using
<code>systemd-sysupdate</code> and then reboot.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Using the OBS profile to fetch a newer systemd</h2><a id="user-content-using-the-obs-profile-to-fetch-a-newer-systemd" aria-label="Permalink: Using the OBS profile to fetch a newer systemd" href="#using-the-obs-profile-to-fetch-a-newer-systemd"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Sometimes ParticleOS adopts systemd features as soon as they get merged into
systemd without waiting for an official release. That&#39;s why we recommend
enabling the <code>obs</code> profile to enable the systemd repositories on OBS
(<a href="https://software.opensuse.org//download.html?project=system%3Asystemd&amp;package=systemd" rel="nofollow">https://software.opensuse.org//download.html?project=system%3Asystemd&amp;package=systemd</a>)
containing systemd packages which are built every day from systemd&#39;s git main
branch.</p>
<p dir="auto">To enable the <code>obs</code> profile, add the following to <code>mkosi.local.conf</code>:</p>

<div dir="auto"><h2 tabindex="-1" dir="auto">Building systemd from source</h2><a id="user-content-building-systemd-from-source" aria-label="Permalink: Building systemd from source" href="#building-systemd-from-source"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">As an alternative to using the <code>obs</code> profile, you can build systemd from source:</p>
<div dir="auto" data-snippet-clipboard-copy-content="git clone https://github.com/systemd/systemd
cd systemd
mkosi -f sandbox -- meson setup build
mkosi -f sandbox -- meson compile -C build
mkosi -t none -f"><pre>git clone https://github.com/systemd/systemd
<span>cd</span> systemd
mkosi -f sandbox -- meson setup build
mkosi -f sandbox -- meson compile -C build
mkosi -t none -f</pre></div>
<p dir="auto">Then write the following to <code>mkosi.local.conf</code> in the ParticleOS repository to
use the artifacts from the systemd repository built by mkosi in ParticleOS:</p>
<div data-snippet-clipboard-copy-content="[Content]
VolatilePackageDirectories=../systemd/build/mkosi.builddir/&lt;distribution&gt;~&lt;release&gt;~&lt;arch&gt;

[Build]
ExtraSearchPaths=../systemd/build"><pre lang="conf"><code>[Content]
VolatilePackageDirectories=../systemd/build/mkosi.builddir/&lt;distribution&gt;~&lt;release&gt;~&lt;arch&gt;

[Build]
ExtraSearchPaths=../systemd/build
</code></pre></div>
<p dir="auto">Make sure the distribution and release in <code>mkosi.local.conf</code> are identical in the
systemd checkout and the particleos checkout.</p>
<p dir="auto">To build a newer systemd, run <code>git pull</code> in the systemd repository followed by
<code>mkosi -f sandbox -- meson compile -C build</code> and <code>mkosi -t none</code>.</p>

<p dir="auto">ParticleOS images are signed for Secure Boot with the user&#39;s keys. To generate a new key,
run <code>mkosi genkey</code>. The key must be stored safely, it will be required to sign updates.</p>
<p dir="auto">The key can be stored in a smartcard. Then you have to set the key in <code>mkosi.local.conf</code>:</p>
<div data-snippet-clipboard-copy-content="[Validation]
SecureBootKey=pkcs11:object=Private key 1;type=private
SecureBootKeySource=provider:pkcs11
SignExpectedPcrKey=pkcs11:object=Private key 1;type=private
SignExpectedPcrKeySource=provider:pkcs11
VerityKey=pkcs11:object=Private key 1;type=private
VerityKeySource=provider:pkcs11"><pre><code>[Validation]
SecureBootKey=pkcs11:object=Private key 1;type=private
SecureBootKeySource=provider:pkcs11
SignExpectedPcrKey=pkcs11:object=Private key 1;type=private
SignExpectedPcrKeySource=provider:pkcs11
VerityKey=pkcs11:object=Private key 1;type=private
VerityKeySource=provider:pkcs11
</code></pre></div>

<p dir="auto">Before installing ParticleOS, make sure that Secure Boot is in setup mode on the
target system. The Secure Boot mode can be configured in the UEFI firmware
interface of the target system. If there&#39;s an existing Linux installation on the
target system already, run <code>systemctl reboot --firmware-setup</code> to reboot into
the UEFI firmware interface. At the same time, make sure the UEFI firmware
interface is password protected so an attacker cannot just disable Secure Boot
again.</p>
<p dir="auto">To install ParticleOS with a USB drive, first build the image on an existing
Linux system as described above. Then, burn it to the USB drive with
<code>mkosi burn /dev/&lt;usb&gt;</code>. Once burned to the USB drive, plug the USB drive into
the system onto which you&#39;d like to install ParticleOS and boot into the USB
drive via the firmware. Then, boot into the &#34;Installer&#34; UKI profile. When you
end up in the root shell, run
<code>systemd-repart --dry-run=no --empty=force --defer-partitions=swap,root,home /dev/&lt;drive&gt;</code>
to install ParticleOS to the system&#39;s drive. Finally, reboot into the target
drive (not the USB) and the regular profile (not the installer one) to complete
the installation.</p>

<p dir="auto">systemd doesn&#39;t support adding a recovery key to a partition enrolled with a token
only (tpm/fido2). It is possible to use cryptenroll to add a recovery password
to the root partition: <code>cryptsetup luksAddKey --token-type systemd-tpm2 /dev/&lt;id&gt;</code></p>

<p dir="auto">Only firmwares that are dependencies of a kernel module are included, but some
modules don&#39;t declare their dependencies properly. Dependencies of a module can be
found with <code>modinfo</code>. If you experience missing firmwares, you should report
this to the module maintainer. <code>FirmwareInclude=</code> can be added in <code>mkosi.local.conf</code>
to include the firmware regardless of whether a module depends on it.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Configuring systemd-homed after installation</h2><a id="user-content-configuring-systemd-homed-after-installation" aria-label="Permalink: Configuring systemd-homed after installation" href="#configuring-systemd-homed-after-installation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">After installing ParticleOS and logging into your systemd-homed managed user,
run the following to configure systemd-homed for the best experience:</p>
<div dir="auto" data-snippet-clipboard-copy-content="homectl update \
    --auto-resize-mode=off \
    --disk-size=max \
    --luks-discard=on \
    --luks-extra-mount-options &#34;user_subvol_rm_allowed,compress=zstd:1&#34;"><pre>homectl update \
    --auto-resize-mode=off \
    --disk-size=max \
    --luks-discard=on \
    --luks-extra-mount-options <span><span>&#34;</span>user_subvol_rm_allowed,compress=zstd:1<span>&#34;</span></span></pre></div>
<p dir="auto">Disabling the auto resize mode avoids slow system boot and shutdown. Enabling
LUKS discard makes sure the home directory doesn&#39;t become inaccessible because
systemd-homed is unable to resize the home directory. The extra LUKS mount
options are BTRFS mount options to make image builds with <code>mkosi</code> faster by
compressing data on disk and allowing users to delete subvolumes.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Default root password and user when booting in a virtual machine</h2><a id="user-content-default-root-password-and-user-when-booting-in-a-virtual-machine" aria-label="Permalink: Default root password and user when booting in a virtual machine" href="#default-root-password-and-user-when-booting-in-a-virtual-machine"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If you boot ParticleOS in a virtual machine using <code>mkosi vm</code>, the root password
is automatically set to <code>particleos</code> and a default user <code>particleos</code> with password
<code>particleos</code> is created as well.</p>
</article></div></div>
  </body>
</html>
