<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://forum.ulisp.com/t/wireless-message-display/1062">Original</a>
    <h1>uLisp wireless message display with a Pi Pico W</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
        <p>This is a wireless message display based on a Raspberry Pi Pico W and written in Lisp. You can send a message to it via Wi-Fi from a web browser on a mobile phone or computer, and it’s displayed on an 8-character alphanumeric display:</p>

<p>You could use it for reminders, or short messages to another person in your household.</p>
<h3>Introduction</h3>
<p>It uses two <a href="https://www.adafruit.com/product/1911">Adafruit four-character I2C alphanumeric modules</a>; alternatively you could use my eight-character alphanumeric display; see <a href="http://www.technoblogy.com/show?2ULE">Eight-Character Alphanumeric Display</a>.</p>
<p>Here’s a circuit showing how they are connected up:</p>

<p>The two alphanumeric display modules should be set to different I2C addresses using the solder links on the back of each module. Leave the left-hand module in its default configuration, so it has I2C address <span>#x70</span>, and bridge the A0 link of the right-hand module with a blob of solder to give it address <span>#x71</span>.</p>
<p>I built it on a <a href="https://www.adafruit.com/product/239">full sized breadboard</a> with the power rails removed to make it more compact.</p>
<p>Once you’ve set up the program to load and run automatically, as described below, the message display can be powered either via the USB port, or from a 3.7V Lipo battery connected to the VSYS and GND pins on the board.</p>
<h3>Setting up the Wireless Message Display</h3>
<h4>Installing uLisp</h4>
<p>Install the latest version of ARM uLisp, Version 4.2, which contains the wireless extensions for the Raspberry Pi Pico W, by following the instructions on the <a href="http://www.ulisp.com/show?3KN3">RP2040 boards</a> page, but first uncomment the directive at the start of the source file:</p>
<pre><code>#define resetautorun
</code></pre>
<p>This allows you to make the program load and run automatically when power is applied.</p>
<h4>Installing the message display program</h4>
<p>The simplest way to install the Wireless Message Display program is to open the Arduino IDE <strong>Serial Monitor</strong>, copy the entire text of the program from the link at the end of this article, paste it into the <strong>Serial Monitor</strong> input box, and press <strong>return</strong>.</p>
<p>Change the statements:</p>
<pre><code>(defvar *ssid* &#34;MyNetwork&#34;)
(defvar *password* &#34;MyPassword&#34;)
</code></pre>
<p>to the correct network name and password to log on to your Wi-Fi network.</p>
<h4>Testing the program</h4>
<p>Then test the program by evaluating:</p>
<pre><code>(message-display)
</code></pre>
<p>After a few seconds the Raspberry Pi Pico W will connect to the Wi-Fi network, and the alphanumeric displays should show the IP address assigned to the message display:</p>

<p>Now try sending a message to the message display from a computer or phone by opening a web browser and entering something like:</p>
<pre><code>http://10.0.1.33/?Hi_David
</code></pre>
<p>Replace the IP address 10.0.1.33 with whatever was displayed when the message display started up.</p>
<p>The message should have up to eight characters, and only contain characters that are valid in URLs. If you want to include a space, enter it as an underline.</p>
<p>The message will appear on the display, and the web browser will respond with:</p>
<pre><code>Received OK
</code></pre>
<p>Exit from the <strong>message-display</strong> program by typing a ~ character and pressing <strong>return</strong>.</p>
<h4>Making the program run automatically</h4>
<p>Now save the Lisp image with the command:</p>
<pre><code>(save-image &#39;message-display)
</code></pre>
<p>Now when you power-up the Raspberry Pi Pico W, uLisp will load the saved image, and then automatically execute the <strong>message-display</strong> function (provided you remembered to upload uLisp with the <code>#define resetautorun</code> directive uncommented, as explained above).</p>
<h3>The program</h3>
<p>Here’s the uLisp program for the Wireless Message Display.</p>
<p>The function <strong>on</strong> initialises the two HT16K33 display drivers used in the alphanumeric display modules:</p>
<pre><code>(defun on (bri)
  (dotimes (a 2)
    (with-i2c (str (+ a #x70))
      (write-byte #x21 str)
      (restart-i2c str) 
      (write-byte (+ bri #xe0) str)
      (restart-i2c str)
      (write-byte #x81 str))))
</code></pre>
<p>It takes a parameter <strong>bri</strong> to set the brightness of the displays from 0 (off) to 15 (maximum).</p>
<p>The list <strong>*codes</strong>* defines the segment codes for each of the characters from ASCII 32, space, to ASCII 95, underline:</p>
<pre><code>(defvar *codes* &#39;(#x0 #x6 #x220 #x12CE #x12ED #xC24 #x235D #x400 #x2400 #x900 #x3FC0 #x12C0 
 #x800 #xC0 #x4000 #xC00 #xC3F #x6 #xDB #x8F #xE6 #x2069 #xFD #x7 #xFF #xEF #x1200 #xA00
 #x2400 #xC8 #x900 #x1083 #x2BB #xF7 #x128F #x39 #x120F #xF9 #x71 #xBD #xF6 #x1200 #x1E
 #x2470 #x38 #x536 #x2136 #x3F #xF3 #x203F #x20F3 #xED #x1201 #x3E #xC30 #x2836 #x2D00
 #x1500 #xC09 #x39 #x2100 #xF #xC03 #x0))
</code></pre>
<p>The function <strong>display</strong> writes the segment code for the character <strong>x</strong> to the display as two bytes, to the I2C stream <strong>str</strong>:</p>
<pre><code>(defun display (x dp str)
  (if (&gt;= x #x60) (setq x (- x #x20)))
  (let ((c (nth (- x 32) *codes*)))
    (when dp (incf c #x4000))
    (write-byte c str)
    (write-byte (ash c -8) str)))
</code></pre>
<p>The first line converts lower-case letters to upper case. If the flag <strong>dp</strong> is non-nil, the decimal point is also illuminated. This is used when displaying the message display’s IP address.</p>
<p>The function <strong>show</strong> displays a string of characters on the alphanumeric displays:</p>
<pre><code>(defun show (txt)
  (let ((i 0) (len (length txt)) dp)
    (dotimes (a 2)
      (with-i2c (str (+ a #x70))
        (write-byte #x00 str)
        (dotimes (x 4)
          (let ((c (char-code (if (&lt; i len) (char txt i) #\space))))
            (incf i)
            (display c (and (&lt; i len) (eq (char txt i) #\.) (incf i)) str)))))))
</code></pre>
<p>It handles decimal points in the message, and if the message is shorter than eight characters it displays spaces on the subsequent displays.</p>
<p>You can test the displays by entering, for example:</p>
<pre><code>(on 8)
(show &#34;Testing&#34;)
</code></pre>
<h4>The Wi-Fi routines</h4>
<p>The following two statements define the Wi-Fi network name and password:</p>
<pre><code>(defvar *ssid* &#34;MyNetwork&#34;)
(defvar *password* &#34;MyPassword&#34;)
</code></pre>
<p>You should change these to the correct strings to access your Wi-Fi network.</p>
<p>The routine <strong>println</strong> outputs a string with the the line ending required by most web protocols: return, newline:</p>
<pre><code>(defun println (x s) (princ x s) (princ #\return s) (princ #\newline s))
</code></pre>
<p>Finally, <strong>message-display</strong> runs the server:</p>
<pre><code>(defun message-display ()
  (show (wifi-connect *ssid* *password*))
  (wifi-server)
  (on 8)
  (loop
   (with-client (s)
     (let* ((line (read-line s)))
       (print line)
       (when line
         (loop (unless (= 0 (available s))) (return))
         (println &#34;HTTP/1.1 200 OK&#34; s)
         (println &#34;Content-Type: text/html&#34; s)
         (println &#34;Connection: close&#34; s)
         (println &#34;&#34; s)
         (println &#34;&lt;!DOCTYPE HTML&gt;&lt;html&gt;Received OK&lt;/html&gt;&#34; s)
         (when (eq (char line 5) #\?)
           (show (subseq line 6 (- (length line) 10)))))))
   (delay 1000)))
</code></pre>
<p>It checks once a second to see if a web client is connected. If it is, the program reads the first line of the request from the web browser, which will be something like:</p>
<pre><code>GET /?Buy_Beer HTTP/1.1 
</code></pre>
<p>The <strong>subseq</strong> statement extracts the message from this line after sending a response to the web client. Finally, the program calls <strong>show</strong> to display the text on the alphanumeric displays.</p>
<h4>The whole program</h4>
<p>Here’s the whole program in a single file: <a href="http://www.ulisp.com/list?416S">Wireless Message Display program</a>.</p>
<h3>Other suggestions</h3>
<p>It’s quite fun thinking how to express messages in eight characters, but if this seems a bit restrictive you could display longer messages by making them scroll along the display. See <a href="http://www.ulisp.com/show?1QHW">Scrolling text display</a> for an example of how to do this.</p>
      </div></div>
  </body>
</html>
