<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://subalpinecircuits.com/ssd1306-and-font-rendering/">Original</a>
    <h1>SSD1306 display drivers and font rendering</h1>
    
    <div id="readability-page-1" class="page"><div id="site-main">
<article>

    <header>

        

        


        

            <figure>
                <img srcset="/content/images/size/w300/2025/04/DSCF0261.JPG 300w,
                            /content/images/size/w600/2025/04/DSCF0261.JPG 600w,
                            /content/images/size/w1000/2025/04/DSCF0261.JPG 1000w,
                            /content/images/size/w2000/2025/04/DSCF0261.JPG 2000w" sizes="(min-width: 1400px) 1400px, 92vw" src="https://subalpinecircuits.com/content/images/size/w2000/2025/04/DSCF0261.JPG" alt="Prototype synthesizer with IBM VGA font text"/>
            </figure>

    </header>

    <section>
        <p>When I first started implementing the SSD1306 OLED on my prototype, I grabbed the quickest and easiest to implement driver I could find - a <a href="https://github.com/espressif/esp-bsp/tree/1452b261c778453c32a98fe897b571561db95bb5/components/ssd1306?ref=subalpinecircuits.com">driver Espressif shipped as part of ESP-BSP</a> that has since been removed. It worked great, updated the screen at about 40 hz, and was very light on resources. However, it only supports a single font, and isn&#39;t set up easily to support adding others without doing a fair amount of work to get each glyph into a specific format of C array. I wanted to add a different font, so I started looking around at other options.</p><p>That driver is no longer supported, and Espressif has replaced it with a lower level driver that doesn&#39;t actually support any fonts, just direct bitmap drawing. The recommendation is now to use <a href="https://lvgl.io/?ref=subalpinecircuits.com">LVGL</a>, a fully featured graphics stack that has widgets, buttons, all sorts of things. So I went about implementing LVGL, which - sure enough - has good support for adding your own fonts, but can&#39;t hit more than about 18 - 20 hz on the ESP32 (running at full speed I2C, 400khz). It&#39;s also set up with its own timer and draw loop, and after fiddling around for quite a while I wasn&#39;t able to get the display to update faster. In addition, the draw loop persistently uses about 5% of a core on the ESP32 regardless of how much work there is to do - it just didn&#39;t feel like the right thing for me. Additionally, and I didn&#39;t look too much into this, when I use LVGL an audible whine comes out of my SSD1306 display. Maybe that&#39;s something I could debug, but I had already planned to move on at this point.</p><figure><img src="https://subalpinecircuits.com/content/images/2025/04/Screenshot-2025-04-14-at-8.18.46-AM.png" alt="" loading="lazy" width="1179" height="604" srcset="https://subalpinecircuits.com/content/images/size/w600/2025/04/Screenshot-2025-04-14-at-8.18.46-AM.png 600w, https://subalpinecircuits.com/content/images/size/w1000/2025/04/Screenshot-2025-04-14-at-8.18.46-AM.png 1000w, https://subalpinecircuits.com/content/images/2025/04/Screenshot-2025-04-14-at-8.18.46-AM.png 1179w" sizes="(min-width: 720px) 720px"/><figcaption><span>LVGL is... a bit much for my use case</span></figcaption></figure><p><a href="https://github.com/olikraus/u8g2?ref=subalpinecircuits.com">U8G2</a> is a popular library that supports dozens of small displays, including the SSD1306. I had used it before, so figured I&#39;d give it a shot again. It&#39;s going a ton of fonts built in and has a system for importing additional fonts into its internal format. It doesn&#39;t natively support ESP-IDF, but there&#39;s a <a href="https://github.com/mkfrey/u8g2-hal-esp-idf?ref=subalpinecircuits.com">wrapper</a> that works pretty well. However, after getting this implemented, again I hit the issue of slow update speed - the fastest I could get is around 18 hz (at 400khz I2C). After doing some research, others had noticed the same thing, but consensus seemed to be that that was good enough. Not good enough for me!</p><p>I found <a href="https://github.com/nopnop2002/esp-idf-ssd1306/tree/master?ref=subalpinecircuits.com">another promising SSD1306</a> driver that, when running a simple text test in isolation, could hit 30+ hz. It also had an example supporting BDF (a popular font format for vintage fonts) fonts, so seemed pretty promising. However, that example was quite slow for a reason I was <a href="https://github.com/nopnop2002/esp-idf-ssd1306/issues/46?ref=subalpinecircuits.com">able to fix</a> but left me a little confused. Additionally, the kerning wasn&#39;t quite right with the BDF example, and I wasn&#39;t keen on trying to fix that. And finally, when I included the driver in my full synthesizer project, it was using more resources than I expected, and wasn&#39;t drawing fast enough.</p><figure><img src="https://subalpinecircuits.com/content/images/2025/04/IMG_4669.jpg" alt="" loading="lazy" width="1949" height="1445" srcset="https://subalpinecircuits.com/content/images/size/w600/2025/04/IMG_4669.jpg 600w, https://subalpinecircuits.com/content/images/size/w1000/2025/04/IMG_4669.jpg 1000w, https://subalpinecircuits.com/content/images/size/w1600/2025/04/IMG_4669.jpg 1600w, https://subalpinecircuits.com/content/images/2025/04/IMG_4669.jpg 1949w" sizes="(min-width: 720px) 720px"/><figcaption><span>Kerning is important</span></figcaption></figure><p>At this point I was close to despair. I know AdafruitGFX is a popular graphics library, but it doesn&#39;t support ESP-IDF (only Arduino) natively. To implement it in my project I&#39;d have to bring in an Arduino compatibility layer, and even then, I don&#39;t know anything about the performance or resource usage, so it felt like a risk that might not pay off.</p><p>I decided to back to the one driver I knew worked really well - the ESP-BSP driver that has been deprecated. I had since upgraded my ESP-IDF version to 5.4.x, and could actually no longer use the driver as written, as it only supports what is now called the &#34;legacy&#34; I2C driver. So I forked the code into my own repo and replaced updated all of the I2c API calls (something I had already done with my ES8388 driver), which worked. And it was still fast! Faster than any other driver I had used. Why is it faster? My hunch is because of how it pushes framebuffer data to the I2C bus in a single transaction, whereas U8G2 pushes bytes to the display in chunks, I&#39;m guessing because of its support for many different variants of displays (I&#39;m not sure about LVGL or the others, but might be similar).</p><figure><pre><code>static esp_err_t ssd1306_write_data(ssd1306_handle_t dev, const uint8_t *const data, const uint16_t data_len)
{
    ssd1306_dev_t *device = (ssd1306_dev_t *) dev;
    esp_err_t ret;

    i2c_cmd_handle_t cmd = i2c_cmd_link_create();
    ret = i2c_master_start(cmd);
    assert(ESP_OK == ret);
    ret = i2c_master_write_byte(cmd, device-&gt;dev_addr | I2C_MASTER_WRITE, true);
    assert(ESP_OK == ret);
    ret = i2c_master_write_byte(cmd, SSD1306_WRITE_DAT, true);
    assert(ESP_OK == ret);
    ret = i2c_master_write(cmd, data, data_len, true);
    assert(ESP_OK == ret);
    ret = i2c_master_stop(cmd);
    assert(ESP_OK == ret);
    ret = i2c_master_cmd_begin(device-&gt;bus, cmd, 1000 / portTICK_PERIOD_MS);
    i2c_cmd_link_delete(cmd);

    return ret;
}

...

static esp_err_t ssd1306_write_data(ssd1306_handle_t dev, const uint8_t *const data, const uint16_t data_len) {
  ssd1306_dev_t *device = (ssd1306_dev_t *)dev;
  esp_err_t ret;

  uint8_t *out_buf = (uint8_t *)calloc(data_len + 1, sizeof(uint8_t));
  out_buf[0] = SSD1306_WRITE_DAT;
  memcpy(out_buf + 1, data, data_len);
  ret = i2c_master_transmit(device-&gt;i2c_dev_handle, out_buf, data_len + 1, 1000);
  free(out_buf);

  return ret;
}</code></pre><figcaption><p><span>Legacy I2C API vs the new I2C API</span></p></figcaption></figure><p>But I was basically back to square one. I have a display driver that works great and is fast, but it only supports one font.</p><p>At this point I started thinking more about handling the font drawing myself - can I add a library to render a font to a bitmap, and then draw the bitmap directly using my driver? After some research I came across <a href="http://unhaut.epizy.com/nvbdflib/?ref=subalpinecircuits.com">nvbdflib</a>, which actually parses BDF fonts directly and allows you to provide your own drawing function! This seemed pretty promising - maybe I can include this library, give it a BDF font and a function that draws directly to my framebuffer, skipping the intermediate bitmap altogether.</p><figure><pre><code>void bdf_drawing_function(int x, int y, int c, void *ctx) {
  ssd1306_dev_t *device = (ssd1306_dev_t *)ctx;
  ssd1306_fill_point(device, x, y, c);
}

...

bdfSetDrawingFunction(bdf_drawing_function, (void *)device);
</code></pre><figcaption><p><span>nvbdflib allows you to pass in a drawing function directly</span></p></figcaption></figure><p>It took a little fiddling - I don&#39;t have a filesystem on my device yet, so to load a BDF file into a buffer I used <a href="https://notisrac.github.io/FileToCArray/?ref=subalpinecircuits.com">this</a> (alternatively could compile in as an object file, but wasn&#39;t sure how to do that with ESP-IDF). It worked! It does load the entire font into memory, but the BDF format is just plain text, so I edited and trimmed it down to the 94 characters I needed. The trimmed down font I loaded in, the 8x16 IBM VGA font from 1987, was about 10 kb. I&#39;m not memory constrained in my project - CPU is my primary constraint - so this was a perfectly fine compromise for being able to drop in another font very easily without a compilation step into an intermediate format (an improvement to memory usage would be to add that compilation step, but it&#39;s not important for my use case). After some tweaks to nvbdflib to pass along the consumer&#39;s context into the provided drawing function, I had the library <a href="https://github.com/subalpinecircuits/esp-bsp-ssd1306/blob/92190097391d34518588660f6adc62b2b84c7708/ssd1306.c?ref=subalpinecircuits.com#L165">working nicely inside of the display driver</a>. </p><figure><pre><code>STARTFONT 2.1
FONT -IBM-VGA-Normal-R-Normal--16-120-96-96-C-80-ISO10646-1
SIZE 12 96 96
FONTBOUNDINGBOX 8 16 0 -4
STARTPROPERTIES 34
FOUNDRY &#34;IBM&#34;
FAMILY_NAME &#34;VGA 8x16&#34;
WEIGHT_NAME &#34;Normal&#34;
SLANT &#34;R&#34;
SETWIDTH_NAME &#34;Normal&#34;
ADD_STYLE_NAME &#34;&#34;
PIXEL_SIZE 16
POINT_SIZE 120
RESOLUTION_X 96
RESOLUTION_Y 96</code></pre><figcaption><p><span>BDF fonts are just plain text, which makes editing them easy</span></p></figcaption></figure><p>So that&#39;s where I am now - I have a SSD1306 display driver capable of hitting full speed (40 hz), but also supporting any font in BDF format! I&#39;m going to keep refining the driver and added things I need - calculate bounding box for a string, for example - but I feel good about where it is already. No big dependencies, no compatibility layers, and using modern I2C APIs. Neat!</p><figure data-kg-thumbnail="https://subalpinecircuits.com/content/media/2025/04/Timeline-2-2_thumb.jpg" data-kg-custom-thumbnail="">
            <div>
                <video src="https://subalpinecircuits.com/content/media/2025/04/Timeline-2-2.mp4" poster="https://img.spacergif.org/v1/1920x1080/0a/spacer.png" width="1920" height="1080" playsinline="" preload="metadata"></video>
                
                <div>
                    <div>
                        <p>
                        
                        <span>0:00</span></p><p>
                            /<span>0:13</span>
                        </p>
                        </div>
                </div>
            </div>
            <figcaption><p dir="ltr"><span>New code on the left, old on the right.</span></p></figcaption>
        </figure>
    </section>


</article>
</div></div>
  </body>
</html>
