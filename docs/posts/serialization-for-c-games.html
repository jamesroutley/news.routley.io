<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://chickensoft.games/blog/serialization-for-csharp-games/">Original</a>
    <h1>Serialization for C# Games</h1>
    
    <div id="readability-page-1" class="page"><div id="__blog-post-container" itemprop="articleBody"><figure><a href="https://effectivetypescript.com/assets/images/header-ab109445239ec9bf6f92e83e301a61b9.jpg"><img src="https://effectivetypescript.com/assets/images/header-ab109445239ec9bf6f92e83e301a61b9.jpg" alt="Article header image. Balloons with icons inside representing the new packages and updates."/></a><figcaption></figcaption></figure><p>Serialization is incredibly important to games, and often painfully difficult to implement well. Unless you just like building serializers, you may find yourself putting off developing a save/load system, especially if you need more than just a simple &#34;what level am I on?&#34; mechanism.</p><h2 id="-the-serialization-trap">ü™§ The Serialization Trap<a href="#-the-serialization-trap" aria-label="Direct link to ü™§ The Serialization Trap" title="Direct link to ü™§ The Serialization Trap">‚Äã</a></h2><p>Like compilers, game engines, video games, and operating systems, serialization is a bit of a siren&#39;s call for programming enthusiasts. It seems easy at first:¬†just write some data to a file ‚Äî done!</p><p>But...what do you do with the data once you read it back from the file? What if the save file is outdated and your models have changed? How do you reconstruct a hierarchical state machine? What about translating saved data into polymorphic models that describe your game? And if you manage to solve that, how do you pass them through the scene tree to rehydrate your game&#39;s save state?</p><h2 id="Ô∏è-serialization-for-everyone">üßë‚Äç‚öïÔ∏è Serialization for Everyone<a href="#Ô∏è-serialization-for-everyone" aria-label="Direct link to üßë‚Äç‚öïÔ∏è Serialization for Everyone" title="Direct link to üßë‚Äç‚öïÔ∏è Serialization for Everyone">‚Äã</a></h2><p>For the last 6 months, I&#39;ve been exploring answers to the questions above. I am releasing 3 major updates to existing packages, as well as 4 completely new packages that I&#39;m really excited to share with you.</p><figure><a href="https://effectivetypescript.com/assets/images/summer_2024-8ce9bdfb83142897515cc43bbcfec074.jpg"><img src="https://effectivetypescript.com/assets/images/summer_2024-8ce9bdfb83142897515cc43bbcfec074.jpg" alt="Balloons with package icons and the text &#39;Summer 2024 Update: Serialization for C# Games"/></a><figcaption></figcaption></figure><p>There&#39;s a better way to make games now ‚Äî¬†with a fully open source stack. If this sounds interesting to you, strap in ‚Äî¬†it&#39;s going to be a long ride.</p><h2 id="-what-makes-a-good-save-system">üíæ What Makes a Good Save System?<a href="#-what-makes-a-good-save-system" aria-label="Direct link to üíæ What Makes a Good Save System?" title="Direct link to üíæ What Makes a Good Save System?">‚Äã</a></h2><p>A good save system, in my opinion, should meet the following criteria:</p><ul><li><p>üîÆ Works when compiled ahead-of-time. A general purpose serialization toolchain needs to work on the lowest common denominator of platforms ‚Äî iOS.</p><p>AOT is a steep requirement for serialization, as it essentially condemns you to generating metadata about types at build time.</p></li><li><p>üîò Opt-in by default. Sometimes you want to extend a non-serializable class that you don&#39;t control and make it serializable.</p></li><li><p>‚§µÔ∏è Polymorphic deserialization. It needs to be easy to deserialize explicit implementations of an abstract type.</p></li><li><p>üîÑ Collections. Even if you don&#39;t intend to support generic types, properly implementing collections is non-trivial.</p></li><li><p>üì¶ Versioning. Models change as a game evolves, and you don&#39;t want to break existing save files.</p></li><li><p>ü™ù Serialization Hooks ‚Äî for types with custom serialization logic or types outside the assembly whose metadata can&#39;t be generated.</p></li></ul><p>Now that we know what a good serialization system looks like, let&#39;s talk about how its done.</p><h2 id="Ô∏è-why-make-a-serializer-">üôã‚Äç‚ôÄÔ∏è Why Make a Serializer? <sup id="fnref-1-82b6b8"><a href="#fn-1-82b6b8">1</a></sup><a href="#Ô∏è-why-make-a-serializer-" aria-label="Direct link to Ô∏è-why-make-a-serializer-" title="Direct link to Ô∏è-why-make-a-serializer-">‚Äã</a></h2><p>The .NET ecosystem has slowly begun to embrace an AOT-friendly world, and System.Text.Json can now generate metadata about types at build time.</p><p>The new serialization system we&#39;ve introduced is built on top of System.Text.Json. Because of this shared foundation, it can interop seamlessly with existing generated JSON contexts and converters.</p><p>Why build a new serializer on top of System.Text.Json if it can already do AOT serialization just fine? Unfortunately, System.Text.Json has a few pain points:</p><ul><li><p>Doesn&#39;t help with versioning.</p></li><li><p>Derived types are painful ‚Äî¬†you have to manually register them on the base type.</p><p>Essentially, you have to keep a registry of all derived types in a place unrelated to the type itself. Manually tracking types is incredibly error-prone and hostile to refactoring type hierarchies ‚Äî a common activity if you&#39;re using hierarchial state machines.</p></li><li><p>Doesn&#39;t support serialization hooks. You have to make a custom converter for every type that needs custom serialization logic.</p></li></ul><p>Since we are designing for a specific use case ‚Äî saving and loading game files ‚Äî we can make a solution that&#39;s tailored to exactly that. Plus, we can still leverage the amazing foundation that System.Text.Json provides.</p><h3 id="-generating-metadata-at-build-time">üîÆ Generating Metadata at Build Time<a href="#-generating-metadata-at-build-time" aria-label="Direct link to üîÆ Generating Metadata at Build Time" title="Direct link to üîÆ Generating Metadata at Build Time">‚Äã</a></h3><p>If we&#39;re going to make an AOT-friendly serialization system, we&#39;re going to need metadata about types. We&#39;ve already established that the metadata generated by System.Text.Json requires us to write rather unfriendly code that is going to be a pain to refactor, so we can&#39;t rely on the System.Text.Json source generator.</p><p>We&#39;re going to have to make our own.</p><h2 id="-introducing-the-introspection-generator">üîÆ Introducing the Introspection Generator<a href="#-introducing-the-introspection-generator" aria-label="Direct link to üîÆ Introducing the Introspection Generator" title="Direct link to üîÆ Introducing the Introspection Generator">‚Äã</a></h2><p>The new <a href="https://github.com/chickensoft-games/Introspection" target="_blank" rel="noopener noreferrer">Introspection</a> generator is now the backbone of all the major Chickensoft libraries that need metaprogramming capabilities. It automatically generates a registry of every type that is visible from the global scope, including nested types.</p><section><a href="https://github.com/chickensoft-games/Introspection"><summary>Create mixins and generate metadata about types at build time to enable reflection in ahead-of-time (AOT) environments.</summary></a></section><details data-collapsed="true"><summary><code>TypeRegistry.g.cs</code> Example</summary><div><div><p>An abbreviated version of the entries in a generated type registry. Not particularly interesting unless you just like writing serializers.</p><div><p><span><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</p><p>The generic form of <code>Activator.CreateInstance&lt;T&gt;</code> works well (and is performant) in both AOT and JIT scenarios. I verified this by emailing Michal Strehovsk√Ω, the .NET compiler engineer <a href="https://x.com/MStrehovsky/status/1231673490551582721" target="_blank" rel="noopener noreferrer">who overhauled it</a>.</p></div><div><div><pre tabindex="0"><code><span><span>[</span><span>typeof</span><span>(</span><span>PartialModel</span><span>)</span><span>]</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>IdentifiableTypeMetadata</span><span>(</span><span>&#34;PartialModel&#34;</span><span>,</span><span> </span><span>(</span><span>r</span><span>)</span><span> </span><span>=&gt;</span><span> r</span><span>.</span><span>Receive</span><span>&lt;</span><span>PartialModel</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span> </span><span>(</span><span>)</span><span> </span><span>=&gt;</span><span> System</span><span>.</span><span>Activator</span><span>.</span><span>CreateInstance</span><span>&lt;</span><span>PartialModel</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span> </span><span>new</span><span> </span><span>PartialModel</span><span>.</span><span>MetatypeMetadata</span><span>(</span><span>)</span><span>,</span><span> </span><span>&#34;multiple_partial_definitions&#34;</span><span>,</span><span> </span><span>1</span><span>)</span><span>,</span><span></span><br/></span><span><span></span><span>[</span><span>typeof</span><span>(</span><span>PropertyModel</span><span>)</span><span>]</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>AbstractIntrospectiveTypeMetadata</span><span>(</span><span>&#34;PropertyModel&#34;</span><span>,</span><span> </span><span>(</span><span>r</span><span>)</span><span> </span><span>=&gt;</span><span> r</span><span>.</span><span>Receive</span><span>&lt;</span><span>PropertyModel</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span> </span><span>new</span><span> </span><span>PropertyModel</span><span>.</span><span>MetatypeMetadata</span><span>(</span><span>)</span><span>)</span><span>,</span><span></span><br/></span><span><span></span><span>[</span><span>typeof</span><span>(</span><span>SomeType</span><span>)</span><span>]</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>IntrospectiveTypeMetadata</span><span>(</span><span>&#34;SomeType&#34;</span><span>,</span><span> </span><span>(</span><span>r</span><span>)</span><span> </span><span>=&gt;</span><span> r</span><span>.</span><span>Receive</span><span>&lt;</span><span>SomeType</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span> </span><span>(</span><span>)</span><span> </span><span>=&gt;</span><span> System</span><span>.</span><span>Activator</span><span>.</span><span>CreateInstance</span><span>&lt;</span><span>SomeType</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span> </span><span>new</span><span> </span><span>SomeType</span><span>.</span><span>MetatypeMetadata</span><span>(</span><span>)</span><span>,</span><span> </span><span>1</span><span>)</span><span>,</span><span></span><br/></span><span><span></span><span>[</span><span>typeof</span><span>(</span><span>StaticPropertyIsSkipped</span><span>)</span><span>]</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>IntrospectiveTypeMetadata</span><span>(</span><span>&#34;StaticPropertyIsSkipped&#34;</span><span>,</span><span> </span><span>(</span><span>r</span><span>)</span><span> </span><span>=&gt;</span><span> r</span><span>.</span><span>Receive</span><span>&lt;</span><span>StaticPropertyIsSkipped</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span> </span><span>(</span><span>)</span><span> </span><span>=&gt;</span><span> System</span><span>.</span><span>Activator</span><span>.</span><span>CreateInstance</span><span>&lt;</span><span>StaticPropertyIsSkipped</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span> </span><span>new</span><span> </span><span>StaticPropertyIsSkipped</span><span>.</span><span>MetatypeMetadata</span><span>(</span><span>)</span><span>,</span><span> </span><span>1</span><span>)</span><span>,</span><span></span><br/></span><span><span></span><span>[</span><span>typeof</span><span>(</span><span>TraditionalNamespace</span><span>.</span><span>A</span><span>)</span><span>]</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>ConcreteTypeMetadata</span><span>(</span><span>&#34;A&#34;</span><span>,</span><span> </span><span>(</span><span>r</span><span>)</span><span> </span><span>=&gt;</span><span> r</span><span>.</span><span>Receive</span><span>&lt;</span><span>TraditionalNamespace</span><span>.</span><span>A</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span> </span><span>(</span><span>)</span><span> </span><span>=&gt;</span><span> System</span><span>.</span><span>Activator</span><span>.</span><span>CreateInstance</span><span>&lt;</span><span>TraditionalNamespace</span><span>.</span><span>A</span><span>&gt;</span><span>(</span><span>)</span><span>)</span><span>,</span><span></span><br/></span><span><span></span><span>[</span><span>typeof</span><span>(</span><span>TraditionalNamespace</span><span>.</span><span>A</span><span>.</span><span>AA</span><span>)</span><span>]</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>ConcreteTypeMetadata</span><span>(</span><span>&#34;AA&#34;</span><span>,</span><span> </span><span>(</span><span>r</span><span>)</span><span> </span><span>=&gt;</span><span> r</span><span>.</span><span>Receive</span><span>&lt;</span><span>TraditionalNamespace</span><span>.</span><span>A</span><span>.</span><span>AA</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span> </span><span>(</span><span>)</span><span> </span><span>=&gt;</span><span> System</span><span>.</span><span>Activator</span><span>.</span><span>CreateInstance</span><span>&lt;</span><span>TraditionalNamespace</span><span>.</span><span>A</span><span>.</span><span>AA</span><span>&gt;</span><span>(</span><span>)</span><span>)</span><span>,</span><br/></span></code></pre></div></div></div></div></details><p>Better yet, the new Introspection generator is designed for performance: it generates all of its data without using any analyzer symbol data ‚Äî¬†just the syntax tree ‚Äî making it pretty dang fast. It also deprecates our previous generator, <a href="https://github.com/chickensoft-games/SuperNodes" target="_blank" rel="noopener noreferrer">SuperNodes</a>, that was not as capable or performant.</p><p>You can read all about it on the <a href="https://github.com/chickensoft-games/Introspection" target="_blank" rel="noopener noreferrer">Introspection</a> repository. The general idea is that it allows you to tag types that are introspective with the <code>[Meta]</code> attribute. Introspective types have additional metadata generated about them, including their attribute information, their properties, and the attributes on their properties, among other things.</p><details data-collapsed="true"><summary><code>IntrospectiveType.g.cs</code> Example</summary><div><div><p>An abbreviated version of the generated metadata for an introspective type.</p><div><div><pre tabindex="0"><code><span><span>  </span><span>[</span><span>ExcludeFromCodeCoverage</span><span>]</span><span></span><br/></span><span><span>  </span><span>public</span><span> </span><span>MixinBlackboard</span><span> MixinState </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>}</span><span> </span><span>=</span><span> </span><span>new</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>  </span><span>[</span><span>ExcludeFromCodeCoverage</span><span>]</span><span></span><br/></span><span><span>  </span><span>public</span><span> </span><span>IMetatype</span><span> Metatype </span><span>=&gt;</span><span> </span><span>(</span><span>(</span><span>IIntrospectiveTypeMetadata</span><span>)</span><span>Types</span><span>.</span><span>Graph</span><span>.</span><span>GetMetadata</span><span>(</span><span>typeof</span><span>(</span><span>IntrospectiveType</span><span>)</span><span>)</span><span>)</span><span>.</span><span>Metatype</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>  </span><span>public</span><span> </span><span>class</span><span> </span><span>MetatypeMetadata</span><span> </span><span>:</span><span> </span><span>IMetatype</span><span> </span><span>{</span><span></span><br/></span><span><span>    </span><span>[</span><span>ExcludeFromCodeCoverage</span><span>]</span><span></span><br/></span><span><span>    </span><span>public</span><span> </span><span>System</span><span>.</span><span>Type</span><span> Type </span><span>=&gt;</span><span> </span><span>typeof</span><span>(</span><span>IntrospectiveType</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span>[</span><span>ExcludeFromCodeCoverage</span><span>]</span><span></span><br/></span><span><span>    </span><span>public</span><span> </span><span>bool</span><span> HasInitProperties </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>}</span><span> </span><span>=</span><span> </span><span>true</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>[</span><span>ExcludeFromCodeCoverage</span><span>]</span><span></span><br/></span><span><span>    </span><span>public</span><span> </span><span>IReadOnlyList</span><span>&lt;</span><span>PropertyMetadata</span><span>&gt;</span><span> Properties </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>}</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>PropertyMetadata</span><span>&gt;</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>      </span><span>new</span><span> </span><span>PropertyMetadata</span><span>(</span><span></span><br/></span><span><span>        </span><span>Name</span><span>:</span><span> </span><span>&#34;Address&#34;</span><span>,</span><span></span><br/></span><span><span>        </span><span>IsInit</span><span>:</span><span> </span><span>false</span><span>,</span><span></span><br/></span><span><span>        </span><span>IsRequired</span><span>:</span><span> </span><span>false</span><span>,</span><span></span><br/></span><span><span>        </span><span>Getter</span><span>:</span><span> </span><span>(</span><span>object</span><span> obj</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>(</span><span>(</span><span>IntrospectiveType</span><span>)</span><span>obj</span><span>)</span><span>.</span><span>Address</span><span>,</span><span></span><br/></span><span><span>        </span><span>Setter</span><span>:</span><span> </span><span>(</span><span>object</span><span> obj</span><span>,</span><span> </span><span>object</span><span>?</span><span> </span><span>value</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>(</span><span>(</span><span>IntrospectiveType</span><span>)</span><span>obj</span><span>)</span><span>.</span><span>Address </span><span>=</span><span> </span><span>(</span><span>string</span><span>)</span><span>value</span><span>,</span><span></span><br/></span><span><span>        </span><span>GenericType</span><span>:</span><span> </span><span>new</span><span> </span><span>GenericType</span><span>(</span><span></span><br/></span><span><span>          </span><span>OpenType</span><span>:</span><span> </span><span>typeof</span><span>(</span><span>string</span><span>)</span><span>,</span><span></span><br/></span><span><span>          </span><span>ClosedType</span><span>:</span><span> </span><span>typeof</span><span>(</span><span>string</span><span>)</span><span>,</span><span></span><br/></span><span><span>          </span><span>Arguments</span><span>:</span><span> System</span><span>.</span><span>Array</span><span>.</span><span>Empty</span><span>&lt;</span><span>GenericType</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span></span><br/></span><span><span>          </span><span>GenericTypeGetter</span><span>:</span><span> receiver </span><span>=&gt;</span><span> receiver</span><span>.</span><span>Receive</span><span>&lt;</span><span>string</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span></span><br/></span><span><span>          </span><span>GenericTypeGetter2</span><span>:</span><span> </span><span>default</span><span></span><br/></span><span><span>        </span><span>)</span><span>,</span><span></span><br/></span><span><span>        </span><span>Attributes</span><span>:</span><span> </span><span>new</span><span> </span><span>Dictionary</span><span>&lt;</span><span>System</span><span>.</span><span>Type</span><span>,</span><span> System</span><span>.</span><span>Attribute</span><span>[</span><span>]</span><span>&gt;</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>          </span><span>[</span><span>typeof</span><span>(</span><span>TagAttribute</span><span>)</span><span>]</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>System</span><span>.</span><span>Attribute</span><span>[</span><span>]</span><span> </span><span>{</span><span></span><br/></span><span><span>            </span><span>new</span><span> </span><span>TagAttribute</span><span>(</span><span>&#34;address&#34;</span><span>)</span><span></span><br/></span><span><span>          </span><span>}</span><span></span><br/></span><span><span>        </span><span>}</span><span></span><br/></span><span><span>      </span><span>)</span><span>,</span><span></span><br/></span><span><span>      </span><span>new</span><span> </span><span>PropertyMetadata</span><span>(</span><span></span><br/></span><span><span>        </span><span>Name</span><span>:</span><span> </span><span>&#34;Age&#34;</span><span>,</span><span></span><br/></span><span><span>        </span><span>IsInit</span><span>:</span><span> </span><span>true</span><span>,</span><span></span><br/></span><span><span>        </span><span>IsRequired</span><span>:</span><span> </span><span>true</span><span>,</span><span></span><br/></span><span><span>        </span><span>Getter</span><span>:</span><span> </span><span>(</span><span>object</span><span> obj</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>(</span><span>(</span><span>IntrospectiveType</span><span>)</span><span>obj</span><span>)</span><span>.</span><span>Age</span><span>,</span><span></span><br/></span><span><span>        </span><span>Setter</span><span>:</span><span> </span><span>null</span><span>,</span><span></span><br/></span><span><span>        </span><span>GenericType</span><span>:</span><span> </span><span>new</span><span> </span><span>GenericType</span><span>(</span><span></span><br/></span><span><span>          </span><span>OpenType</span><span>:</span><span> </span><span>typeof</span><span>(</span><span>int</span><span>)</span><span>,</span><span></span><br/></span><span><span>          </span><span>ClosedType</span><span>:</span><span> </span><span>typeof</span><span>(</span><span>int</span><span>)</span><span>,</span><span></span><br/></span><span><span>          </span><span>Arguments</span><span>:</span><span> System</span><span>.</span><span>Array</span><span>.</span><span>Empty</span><span>&lt;</span><span>GenericType</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span></span><br/></span><span><span>          </span><span>GenericTypeGetter</span><span>:</span><span> receiver </span><span>=&gt;</span><span> receiver</span><span>.</span><span>Receive</span><span>&lt;</span><span>int</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span></span><br/></span><span><span>          </span><span>GenericTypeGetter2</span><span>:</span><span> </span><span>default</span><span></span><br/></span><span><span>        </span><span>)</span><span>,</span><span></span><br/></span><span><span>        </span><span>Attributes</span><span>:</span><span> </span><span>new</span><span> </span><span>Dictionary</span><span>&lt;</span><span>System</span><span>.</span><span>Type</span><span>,</span><span> System</span><span>.</span><span>Attribute</span><span>[</span><span>]</span><span>&gt;</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>          </span><span>[</span><span>typeof</span><span>(</span><span>TagAttribute</span><span>)</span><span>]</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>System</span><span>.</span><span>Attribute</span><span>[</span><span>]</span><span> </span><span>{</span><span></span><br/></span><span><span>            </span><span>new</span><span> </span><span>TagAttribute</span><span>(</span><span>&#34;age&#34;</span><span>)</span><span></span><br/></span><span><span>          </span><span>}</span><span></span><br/></span><span><span>        </span><span>}</span><span></span><br/></span><span><span>      </span><span>)</span><span>,</span><span></span><br/></span><span><span>      </span><span>new</span><span> </span><span>PropertyMetadata</span><span>(</span><span></span><br/></span><span><span>        </span><span>Name</span><span>:</span><span> </span><span>&#34;Description&#34;</span><span>,</span><span></span><br/></span><span><span>        </span><span>IsInit</span><span>:</span><span> </span><span>true</span><span>,</span><span></span><br/></span><span><span>        </span><span>IsRequired</span><span>:</span><span> </span><span>false</span><span>,</span><span></span><br/></span><span><span>        </span><span>Getter</span><span>:</span><span> </span><span>(</span><span>object</span><span> obj</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>(</span><span>(</span><span>IntrospectiveType</span><span>)</span><span>obj</span><span>)</span><span>.</span><span>Description</span><span>,</span><span></span><br/></span><span><span>        </span><span>Setter</span><span>:</span><span> </span><span>null</span><span>,</span><span></span><br/></span><span><span>        </span><span>GenericType</span><span>:</span><span> </span><span>new</span><span> </span><span>GenericType</span><span>(</span><span></span><br/></span><span><span>          </span><span>OpenType</span><span>:</span><span> </span><span>typeof</span><span>(</span><span>string</span><span>)</span><span>,</span><span></span><br/></span><span><span>          </span><span>ClosedType</span><span>:</span><span> </span><span>typeof</span><span>(</span><span>string</span><span>)</span><span>,</span><span></span><br/></span><span><span>          </span><span>Arguments</span><span>:</span><span> System</span><span>.</span><span>Array</span><span>.</span><span>Empty</span><span>&lt;</span><span>GenericType</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span></span><br/></span><span><span>          </span><span>GenericTypeGetter</span><span>:</span><span> receiver </span><span>=&gt;</span><span> receiver</span><span>.</span><span>Receive</span><span>&lt;</span><span>string</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span></span><br/></span><span><span>          </span><span>GenericTypeGetter2</span><span>:</span><span> </span><span>default</span><span></span><br/></span><span><span>        </span><span>)</span><span>,</span><span></span><br/></span><span><span>        </span><span>Attributes</span><span>:</span><span> </span><span>new</span><span> </span><span>Dictionary</span><span>&lt;</span><span>System</span><span>.</span><span>Type</span><span>,</span><span> System</span><span>.</span><span>Attribute</span><span>[</span><span>]</span><span>&gt;</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>          </span><span>[</span><span>typeof</span><span>(</span><span>TagAttribute</span><span>)</span><span>]</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>System</span><span>.</span><span>Attribute</span><span>[</span><span>]</span><span> </span><span>{</span><span></span><br/></span><span><span>            </span><span>new</span><span> </span><span>TagAttribute</span><span>(</span><span>&#34;description&#34;</span><span>)</span><span></span><br/></span><span><span>          </span><span>}</span><span></span><br/></span><span><span>        </span><span>}</span><span></span><br/></span><span><span>      </span><span>)</span><span>,</span><span></span><br/></span><span><span>      </span><span>new</span><span> </span><span>PropertyMetadata</span><span>(</span><span></span><br/></span><span><span>        </span><span>Name</span><span>:</span><span> </span><span>&#34;Name&#34;</span><span>,</span><span></span><br/></span><span><span>        </span><span>IsInit</span><span>:</span><span> </span><span>true</span><span>,</span><span></span><br/></span><span><span>        </span><span>IsRequired</span><span>:</span><span> </span><span>true</span><span>,</span><span></span><br/></span><span><span>        </span><span>Getter</span><span>:</span><span> </span><span>(</span><span>object</span><span> obj</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>(</span><span>(</span><span>IntrospectiveType</span><span>)</span><span>obj</span><span>)</span><span>.</span><span>Name</span><span>,</span><span></span><br/></span><span><span>        </span><span>Setter</span><span>:</span><span> </span><span>null</span><span>,</span><span></span><br/></span><span><span>        </span><span>GenericType</span><span>:</span><span> </span><span>new</span><span> </span><span>GenericType</span><span>(</span><span></span><br/></span><span><span>          </span><span>OpenType</span><span>:</span><span> </span><span>typeof</span><span>(</span><span>string</span><span>)</span><span>,</span><span></span><br/></span><span><span>          </span><span>ClosedType</span><span>:</span><span> </span><span>typeof</span><span>(</span><span>string</span><span>)</span><span>,</span><span></span><br/></span><span><span>          </span><span>Arguments</span><span>:</span><span> System</span><span>.</span><span>Array</span><span>.</span><span>Empty</span><span>&lt;</span><span>GenericType</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span></span><br/></span><span><span>          </span><span>GenericTypeGetter</span><span>:</span><span> receiver </span><span>=&gt;</span><span> receiver</span><span>.</span><span>Receive</span><span>&lt;</span><span>string</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span></span><br/></span><span><span>          </span><span>GenericTypeGetter2</span><span>:</span><span> </span><span>default</span><span></span><br/></span><span><span>        </span><span>)</span><span>,</span><span></span><br/></span><span><span>        </span><span>Attributes</span><span>:</span><span> </span><span>new</span><span> </span><span>Dictionary</span><span>&lt;</span><span>System</span><span>.</span><span>Type</span><span>,</span><span> System</span><span>.</span><span>Attribute</span><span>[</span><span>]</span><span>&gt;</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>          </span><span>[</span><span>typeof</span><span>(</span><span>TagAttribute</span><span>)</span><span>]</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>System</span><span>.</span><span>Attribute</span><span>[</span><span>]</span><span> </span><span>{</span><span></span><br/></span><span><span>            </span><span>new</span><span> </span><span>TagAttribute</span><span>(</span><span>&#34;name&#34;</span><span>)</span><span></span><br/></span><span><span>          </span><span>}</span><span></span><br/></span><span><span>        </span><span>}</span><span></span><br/></span><span><span>      </span><span>)</span><span></span><br/></span><span><span>    </span><span>}</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>[</span><span>ExcludeFromCodeCoverage</span><span>]</span><span></span><br/></span><span><span>    </span><span>public</span><span> </span><span>IReadOnlyDictionary</span><span>&lt;</span><span>System</span><span>.</span><span>Type</span><span>,</span><span> System</span><span>.</span><span>Attribute</span><span>[</span><span>]</span><span>&gt;</span><span> Attributes </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>}</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Dictionary</span><span>&lt;</span><span>System</span><span>.</span><span>Type</span><span>,</span><span> System</span><span>.</span><span>Attribute</span><span>[</span><span>]</span><span>&gt;</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>      </span><span>[</span><span>typeof</span><span>(</span><span>IdAttribute</span><span>)</span><span>]</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>System</span><span>.</span><span>Attribute</span><span>[</span><span>]</span><span> </span><span>{</span><span></span><br/></span><span><span>        </span><span>new</span><span> </span><span>IdAttribute</span><span>(</span><span>&#34;init_args_model&#34;</span><span>)</span><span></span><br/></span><span><span>      </span><span>}</span><span>,</span><span></span><br/></span><span><span>      </span><span>[</span><span>typeof</span><span>(</span><span>MetaAttribute</span><span>)</span><span>]</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>System</span><span>.</span><span>Attribute</span><span>[</span><span>]</span><span> </span><span>{</span><span></span><br/></span><span><span>        </span><span>new</span><span> </span><span>MetaAttribute</span><span>(</span><span>)</span><span></span><br/></span><span><span>      </span><span>}</span><span></span><br/></span><span><span>    </span><span>}</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>[</span><span>ExcludeFromCodeCoverage</span><span>]</span><span></span><br/></span><span><span>    </span><span>public</span><span> </span><span>IReadOnlyList</span><span>&lt;</span><span>System</span><span>.</span><span>Type</span><span>&gt;</span><span> Mixins </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>}</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>System</span><span>.</span><span>Type</span><span>&gt;</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>    </span><span>}</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>[</span><span>ExcludeFromCodeCoverage</span><span>]</span><span></span><br/></span><span><span>    </span><span>public</span><span> </span><span>IReadOnlyDictionary</span><span>&lt;</span><span>System</span><span>.</span><span>Type</span><span>,</span><span> System</span><span>.</span><span>Action</span><span>&lt;</span><span>object</span><span>&gt;</span><span>&gt;</span><span> MixinHandlers </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>}</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Dictionary</span><span>&lt;</span><span>System</span><span>.</span><span>Type</span><span>,</span><span> System</span><span>.</span><span>Action</span><span>&lt;</span><span>object</span><span>&gt;</span><span>&gt;</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>    </span><span>}</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>[</span><span>ExcludeFromCodeCoverage</span><span>]</span><span></span><br/></span><span><span>    </span><span>public</span><span> </span><span>object</span><span> </span><span>Construct</span><span>(</span><span>IReadOnlyDictionary</span><span>&lt;</span><span>string</span><span>,</span><span> </span><span>object</span><span>?</span><span>&gt;</span><span>?</span><span> args </span><span>=</span><span> </span><span>null</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>      args </span><span>=</span><span> args </span><span>??</span><span> </span><span>throw</span><span> </span><span>new</span><span> </span><span>System</span><span>.</span><span>ArgumentNullException</span><span>(</span><span>nameof</span><span>(</span><span>args</span><span>)</span><span>,</span><span> </span><span>&#34;Constructing IntrospectiveType requires init args.&#34;</span><span>)</span><span>;</span><span></span><br/></span><span><span>      </span><span>return</span><span> </span><span>new</span><span> </span><span>IntrospectiveType</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>        Address </span><span>=</span><span> args</span><span>.</span><span>ContainsKey</span><span>(</span><span>&#34;Address&#34;</span><span>)</span><span> </span><span>?</span><span> </span><span>(</span><span>string</span><span>)</span><span>args</span><span>[</span><span>&#34;Address&#34;</span><span>]</span><span> </span><span>:</span><span> </span><span>default</span><span>!</span><span>,</span><span></span><br/></span><span><span>        Age </span><span>=</span><span> args</span><span>.</span><span>ContainsKey</span><span>(</span><span>&#34;Age&#34;</span><span>)</span><span> </span><span>?</span><span> </span><span>(</span><span>int</span><span>)</span><span>args</span><span>[</span><span>&#34;Age&#34;</span><span>]</span><span> </span><span>:</span><span> </span><span>default</span><span>!</span><span>,</span><span></span><br/></span><span><span>        Description </span><span>=</span><span> args</span><span>.</span><span>ContainsKey</span><span>(</span><span>&#34;Description&#34;</span><span>)</span><span> </span><span>?</span><span> </span><span>(</span><span>string</span><span>)</span><span>args</span><span>[</span><span>&#34;Description&#34;</span><span>]</span><span> </span><span>:</span><span> </span><span>default</span><span>!</span><span>,</span><span></span><br/></span><span><span>        Name </span><span>=</span><span> args</span><span>.</span><span>ContainsKey</span><span>(</span><span>&#34;Name&#34;</span><span>)</span><span> </span><span>?</span><span> </span><span>(</span><span>string</span><span>)</span><span>args</span><span>[</span><span>&#34;Name&#34;</span><span>]</span><span> </span><span>:</span><span> </span><span>default</span><span>!</span><span></span><br/></span><span><span>      </span><span>}</span><span>;</span><span></span><br/></span><span><span>    </span><span>}</span><span></span><br/></span><span><span>    </span><span>[</span><span>ExcludeFromCodeCoverage</span><span>]</span><span></span><br/></span><span><span>    </span><span>public</span><span> </span><span>override</span><span> </span><span>bool</span><span> </span><span>Equals</span><span>(</span><span>object</span><span> obj</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>true</span><span>;</span><span></span><br/></span><span><span>    </span><span>[</span><span>ExcludeFromCodeCoverage</span><span>]</span><span></span><br/></span><span><span>    </span><span>public</span><span> </span><span>override</span><span> </span><span>int</span><span> </span><span>GetHashCode</span><span>(</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>base</span><span>.</span><span>GetHashCode</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span>  </span><span>}</span><br/></span></code></pre></div></div></div></div></details><p>You don&#39;t have to fully understand the generated introspection data to appreciate it. Basically, it makes all the stuff you&#39;d ever need to write a decently polymorphic serialization system.</p><p>‚úÖ Now any serializer we build on top of this will work when compiled ahead of time ‚Äî¬†done! Not so bad, right?</p><h2 id="-introducing-the-serialization-system">üì¶ Introducing the Serialization System<a href="#-introducing-the-serialization-system" aria-label="Direct link to üì¶ Introducing the Serialization System" title="Direct link to üì¶ Introducing the Serialization System">‚Äã</a></h2><p>The new <a href="https://github.com/chickensoft-games/Serialization" target="_blank" rel="noopener noreferrer">Serialization</a> system builds off the Introspection generator, allowing you to define serializable types with relative ease.</p><section><a href="https://github.com/chickensoft-games/Serialization"><summary>Easy to use serializable models with AOT compilation support and System.Text.Json compatibility.</summary></a></section><p>It isn&#39;t as powerful as the System.Text.Json generators, but it&#39;s tailored for writing simple, refactor-friendly code.</p><p>Here&#39;s what a serializable game model looks like.</p><div><div><pre tabindex="0"><code><span><span>using</span><span> </span><span>Chickensoft</span><span>.</span><span>Introspection</span><span>;</span><span></span><br/></span><span><span></span><span>using</span><span> </span><span>Chickensoft</span><span>.</span><span>Serialization</span><span>;</span><span></span><br/></span><span><span></span><span>using</span><span> </span><span>Godot</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>[</span><span>Meta</span><span>,</span><span> </span><span>Id</span><span>(</span><span>&#34;player_data&#34;</span><span>)</span><span>]</span><span></span><br/></span><span><span></span><span>public</span><span> </span><span>partial</span><span> </span><span>record</span><span> </span><span>PlayerData</span><span> </span><span>{</span><span></span><br/></span><span><span>  </span><span>[</span><span>Save</span><span>(</span><span>&#34;global_transform&#34;</span><span>)</span><span>]</span><span></span><br/></span><span><span>  </span><span>public</span><span> required </span><span>Transform3D</span><span> GlobalTransform </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>init</span><span>;</span><span> </span><span>}</span><span></span><br/></span><span><span>  </span><span>[</span><span>Save</span><span>(</span><span>&#34;state_machine&#34;</span><span>)</span><span>]</span><span></span><br/></span><span><span>  </span><span>public</span><span> required </span><span>PlayerLogic</span><span> StateMachine </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>init</span><span>;</span><span> </span><span>}</span><span></span><br/></span><span><span>  </span><span>[</span><span>Save</span><span>(</span><span>&#34;velocity&#34;</span><span>)</span><span>]</span><span></span><br/></span><span><span>  </span><span>public</span><span> required </span><span>Vector3</span><span> Velocity </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>init</span><span>;</span><span> </span><span>}</span><span></span><br/></span><span><span></span><span>}</span><br/></span></code></pre></div></div><div><p><span><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</p><p>The <code>[Id]</code> attribute tells the Introspection generator to generate additional metadata on top of the additional introspection data specific to &#34;identifiable&#34; types. The Serialization system and Introspection generator were designed in tandem, so they work together seamlessly, even though the Introspection generator has no knowledge of serialization. It just generates metadata.</p></div><p>‚úÖ Note how the serialization system is opt-in: just add the <code>[Save]</code> attribute and specify a json key name for the properties you wish to persist!</p><p>‚úÖ It also works with collections. It provides support for the only 3 collections you should ever need when working with JSON: <code>HashSet&lt;T&gt;</code>, <code>List&lt;T&gt;</code>, <code>Dictionary&lt;TKey, TValue&gt;</code>. If you need something else, you&#39;re doing it wrong. (Or you can just use the System.Text.Json generator and make a serialization context, if you must get fancy).</p><p>‚úÖ Oh, and it works with inheritance and abstract types, too. Check the <a href="https://github.com/chickensoft-games/Serialization" target="_blank" rel="noopener noreferrer">Serialization</a> readme for more usage details.</p><p>‚úÖ Oh, and of course ‚Äî versioning! Here&#39;s what a versioned model looks like.</p><div><div><pre tabindex="0"><code><span><span>[</span><span>Meta</span><span>,</span><span> </span><span>Id</span><span>(</span><span>&#34;log_entry&#34;</span><span>)</span><span>]</span><span></span><br/></span><span><span></span><span>public</span><span> </span><span>abstract</span><span> </span><span>partial</span><span> </span><span>class</span><span> </span><span>LogEntry</span><span> </span><span>:</span><span> </span><span>SystemLogEntry</span><span> </span><span>{</span><span> </span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>[</span><span>Meta</span><span>,</span><span> </span><span>Version</span><span>(</span><span>1</span><span>)</span><span>]</span><span></span><br/></span><span><span></span><span>public</span><span> </span><span>partial</span><span> </span><span>class</span><span> </span><span>LogEntry1</span><span> </span><span>:</span><span> </span><span>LogEntry</span><span>,</span><span> </span><span>IOutdated</span><span> </span><span>{</span><span></span><br/></span><span><span>  </span><span>[</span><span>Save</span><span>(</span><span>&#34;text&#34;</span><span>)</span><span>]</span><span></span><br/></span><span><span>  </span><span>public</span><span> required </span><span>string</span><span> Text </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>init</span><span>;</span><span> </span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span>  </span><span>[</span><span>Save</span><span>(</span><span>&#34;type&#34;</span><span>)</span><span>]</span><span></span><br/></span><span><span>  </span><span>public</span><span> required </span><span>string</span><span> Type </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>init</span><span>;</span><span> </span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span>  </span><span>public</span><span> </span><span>object</span><span> </span><span>Upgrade</span><span>(</span><span>IReadOnlyBlackboard</span><span> deps</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>new</span><span> </span><span>LogEntry2</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>    Text </span><span>=</span><span> Text</span><span>,</span><span></span><br/></span><span><span>    Type </span><span>=</span><span> Type </span><span>switch</span><span> </span><span>{</span><span></span><br/></span><span><span>      </span><span>&#34;info&#34;</span><span> </span><span>=&gt;</span><span> LogType</span><span>.</span><span>Info</span><span>,</span><span></span><br/></span><span><span>      </span><span>&#34;warning&#34;</span><span> </span><span>=&gt;</span><span> LogType</span><span>.</span><span>Warning</span><span>,</span><span></span><br/></span><span><span>      </span><span>&#34;error&#34;</span><span> </span><span>or</span><span> _ </span><span>=&gt;</span><span> LogType</span><span>.</span><span>Error</span><span>,</span><span></span><br/></span><span><span>    </span><span>}</span><span></span><br/></span><span><span>  </span><span>}</span><span>;</span><span></span><br/></span><span><span></span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>public</span><span> </span><span>enum</span><span> </span><span>LogType</span><span> </span><span>{</span><span></span><br/></span><span><span>  Info</span><span>,</span><span></span><br/></span><span><span>  Warning</span><span>,</span><span></span><br/></span><span><span>  Error</span><br/></span><span><span></span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>[</span><span>Meta</span><span>,</span><span> </span><span>Version</span><span>(</span><span>2</span><span>)</span><span>]</span><span></span><br/></span><span><span></span><span>public</span><span> </span><span>partial</span><span> </span><span>class</span><span> </span><span>LogEntry2</span><span> </span><span>:</span><span> </span><span>LogEntry</span><span> </span><span>{</span><span></span><br/></span><span><span>  </span><span>[</span><span>Save</span><span>(</span><span>&#34;text&#34;</span><span>)</span><span>]</span><span></span><br/></span><span><span>  </span><span>public</span><span> required </span><span>string</span><span> Text </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>init</span><span>;</span><span> </span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span>  </span><span>[</span><span>Save</span><span>(</span><span>&#34;type&#34;</span><span>)</span><span>]</span><span></span><br/></span><span><span>  </span><span>public</span><span> required </span><span>LogType</span><span> Type </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>init</span><span>;</span><span> </span><span>}</span><span></span><br/></span><span><span></span><span>}</span><br/></span></code></pre></div></div><p>The serialization system can even upgrade your out of date models while they&#39;re being deserialized, ensuring you never see an out-of-date type in your game logic.</p><p>‚úÖ Finally, you can also implement custom serialization hooks on types that wish to customize how they are serialized. They have access to their JSON node, and can even return an entirely different object if they wish (as long as it is a derived type of the type being deserialized).</p><div><div><pre tabindex="0"><code><span><span>  </span><span>[</span><span>Meta</span><span>,</span><span> </span><span>Id</span><span>(</span><span>&#34;custom_serializable&#34;</span><span>)</span><span>]</span><span></span><br/></span><span><span>  </span><span>public</span><span> </span><span>partial</span><span> </span><span>class</span><span> </span><span>CustomSerializable</span><span> </span><span>:</span><span> </span><span>ICustomSerializable</span><span> </span><span>{</span><span></span><br/></span><span><span>    </span><span>public</span><span> </span><span>int</span><span> Value </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>public</span><span> </span><span>object</span><span> </span><span>OnDeserialized</span><span>(</span><span></span><br/></span><span><span>      </span><span>IdentifiableTypeMetadata</span><span> metadata</span><span>,</span><span></span><br/></span><span><span>      </span><span>JsonObject</span><span> json</span><span>,</span><span></span><br/></span><span><span>      </span><span>JsonSerializerOptions</span><span> options</span><br/></span><span><span>    </span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>      Value </span><span>=</span><span> json</span><span>[</span><span>&#34;value&#34;</span><span>]</span><span>?.</span><span>GetValue</span><span>&lt;</span><span>int</span><span>&gt;</span><span>(</span><span>)</span><span> </span><span>??</span><span> </span><span>-</span><span>1</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>      </span><span>return</span><span> </span><span>this</span><span>;</span><span></span><br/></span><span><span>    </span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>public</span><span> </span><span>void</span><span> </span><span>OnSerialized</span><span>(</span><span></span><br/></span><span><span>      </span><span>IdentifiableTypeMetadata</span><span> metadata</span><span>,</span><span></span><br/></span><span><span>      </span><span>JsonObject</span><span> json</span><span>,</span><span></span><br/></span><span><span>      </span><span>JsonSerializerOptions</span><span> options</span><br/></span><span><span>    </span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>      </span><span></span><br/></span><span><span>      </span><span></span><br/></span><span><span>      json</span><span>[</span><span>&#34;value&#34;</span><span>]</span><span> </span><span>=</span><span> Value</span><span>;</span><span></span><br/></span><span><span>    </span><span>}</span><span></span><br/></span><span><span>  </span><span>}</span><br/></span></code></pre></div></div><p>ü•≥ Now we&#39;ve met all of our serialization requirements.</p><p>‚ú® But wait, there&#39;s more! A LOT more.</p><h2 id="-godot-specific-serialization">ü§ñ Godot-Specific Serialization<a href="#-godot-specific-serialization" aria-label="Direct link to ü§ñ Godot-Specific Serialization" title="Direct link to ü§ñ Godot-Specific Serialization">‚Äã</a></h2><p>We also need to be able to serialize Godot-specific types, like transforms, vectors, etc. Fortunately, there&#39;s a new package containing a few System.Text.Json converters that can convert Godot types to JSON and back.</p><section><a href="https://github.com/chickensoft-games/Serialization.Godot"><summary>Godot-specific JSON converters for Chickensoft.Serialization.</summary></a></section><p>It only supports a handful of types right now, so please ‚Äî PLEASE ‚Äî contribute to it if you can!</p><h2 id="-introducing-savefilebuilder">üëΩ Introducing SaveFileBuilder<a href="#-introducing-savefilebuilder" aria-label="Direct link to üëΩ Introducing SaveFileBuilder" title="Direct link to üëΩ Introducing SaveFileBuilder">‚Äã</a></h2><p>Now that we can define beautiful, serializable models, how do we extract data from disparate nodes across the scene tree, and how do we return it to the relevant nodes (or create them) when we load the game?</p><section><a href="https://github.com/chickensoft-games/SaveFileBuilder"><summary>Compose chunks of save data into a single data type by creating loosely coupled save chunks at various points in the scene tree.</summary></a></section><p>Meet SaveFileBuilder. It allows you to define a <code>SaveFile</code> as a tree of <code>SaveChunks</code>. Each <code>SaveChunk</code> may have its own children chunks. You can access each child chunk by its type to recursively construct the save file (or load it).</p><p><a href="https://github.com/chickensoft-games/AutoInject" target="_blank" rel="noopener noreferrer">AutoInject</a> should be used to find the nearest parent save chunk in the scene tree so that the child chunk can add itself to the parent.</p><div><div><pre tabindex="0"><code><span><span>SaveFile </span><span>=</span><span> </span><span>new</span><span> </span><span>SaveFile</span><span>&lt;</span><span>GameData</span><span>&gt;</span><span>(</span><span></span><br/></span><span><span>  </span><span>root</span><span>:</span><span> </span><span>new</span><span> </span><span>SaveChunk</span><span>&lt;</span><span>GameData</span><span>&gt;</span><span>(</span><span></span><br/></span><span><span>    </span><span>onSave</span><span>:</span><span> </span><span>(</span><span>chunk</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span></span><br/></span><span><span>      </span><span></span><br/></span><span><span>      </span><span></span><br/></span><span><span>      </span><span>var</span><span> gameData </span><span>=</span><span> </span><span>new</span><span> </span><span>GameData</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>        MapData </span><span>=</span><span> chunk</span><span>.</span><span>GetChunkSaveData</span><span>&lt;</span><span>MapData</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span></span><br/></span><span><span>        PlayerData </span><span>=</span><span> chunk</span><span>.</span><span>GetChunkSaveData</span><span>&lt;</span><span>PlayerData</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span></span><br/></span><span><span>        PlayerCameraData </span><span>=</span><span> chunk</span><span>.</span><span>GetChunkSaveData</span><span>&lt;</span><span>PlayerCameraData</span><span>&gt;</span><span>(</span><span>)</span><span></span><br/></span><span><span>      </span><span>}</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>      </span><span>return</span><span> gameData</span><span>;</span><span></span><br/></span><span><span>    </span><span>}</span><span>,</span><span></span><br/></span><span><span>    </span><span>onLoad</span><span>:</span><span> </span><span>(</span><span>chunk</span><span>,</span><span> data</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span></span><br/></span><span><span>      </span><span></span><br/></span><span><span>      </span><span></span><br/></span><span><span>      chunk</span><span>.</span><span>LoadChunkSaveData</span><span>(</span><span>data</span><span>.</span><span>MapData</span><span>)</span><span>;</span><span></span><br/></span><span><span>      chunk</span><span>.</span><span>LoadChunkSaveData</span><span>(</span><span>data</span><span>.</span><span>PlayerData</span><span>)</span><span>;</span><span></span><br/></span><span><span>      chunk</span><span>.</span><span>LoadChunkSaveData</span><span>(</span><span>data</span><span>.</span><span>PlayerCameraData</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span>}</span><span></span><br/></span><span><span>  </span><span>)</span><span>,</span><span></span><br/></span><span><span>  </span><span>onSave</span><span>:</span><span> </span><span>async</span><span> </span><span>(</span><span>GameData</span><span> data</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>    </span><span>var</span><span> json </span><span>=</span><span> JsonSerializer</span><span>.</span><span>Serialize</span><span>(</span><span>data</span><span>,</span><span> JsonOptions</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span>await</span><span> FileSystem</span><span>.</span><span>File</span><span>.</span><span>WriteAllTextAsync</span><span>(</span><span>SaveFilePath</span><span>,</span><span> json</span><span>)</span><span>;</span><span></span><br/></span><span><span>  </span><span>}</span><span>,</span><span></span><br/></span><span><span>  </span><span>onLoad</span><span>:</span><span> </span><span>async</span><span> </span><span>(</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>    </span><span>if</span><span> </span><span>(</span><span>!</span><span>FileSystem</span><span>.</span><span>File</span><span>.</span><span>Exists</span><span>(</span><span>SaveFilePath</span><span>)</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>      GD</span><span>.</span><span>Print</span><span>(</span><span>&#34;No save file to load :&#39;(&#34;</span><span>)</span><span>;</span><span></span><br/></span><span><span>      </span><span>return</span><span> </span><span>null</span><span>;</span><span></span><br/></span><span><span>    </span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>var</span><span> json </span><span>=</span><span> </span><span>await</span><span> FileSystem</span><span>.</span><span>File</span><span>.</span><span>ReadAllTextAsync</span><span>(</span><span>SaveFilePath</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span>return</span><span> JsonSerializer</span><span>.</span><span>Deserialize</span><span>&lt;</span><span>GameData</span><span>&gt;</span><span>(</span><span>json</span><span>,</span><span> JsonOptions</span><span>)</span><span>;</span><span></span><br/></span><span><span>  </span><span>}</span><span></span><br/></span><span><span></span><span>)</span><span>;</span><br/></span></code></pre></div></div><p>In the future, this can be expanded on by creating an async variety. Asynchronicity would allow you to define save chunks that can split loading and saving into multiple operations, streamlining the most complex save scenarios imaginable.</p><h2 id="-serializing-hierarchical-state-machines">üí° Serializing Hierarchical State Machines<a href="#-serializing-hierarchical-state-machines" aria-label="Direct link to üí° Serializing Hierarchical State Machines" title="Direct link to üí° Serializing Hierarchical State Machines">‚Äã</a></h2><p><a href="https://github.com/chickensoft-games/LogicBlocks" target="_blank" rel="noopener noreferrer">LogicBlocks</a>, our hierarchical state machine implementation, is now fully serializable, thanks to the version 5 update that was just released. It integrates seamlessly with the new Introspection generator and Serialization system.</p><section><a href="https://github.com/chickensoft-games/LogicBlocks"><summary>Human-friendly, hierarchical state machines for games and apps in C#.</summary></a></section><p>LogicBlocks 5 will now automatically preallocate states when constructed, thanks to the generated metadata that allows it to see every possible state ahead of time.</p><div><p><span><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</p><p>Unrelated, but the new performance updates LogicBlocks 5 receives also eliminates runtime memory allocations, except in scenarios where the number of inputs or input types exceeds the input buffer size.</p></div><div><div><pre tabindex="0"><code><span><span>[</span><span>Meta</span><span>,</span><span> </span><span>Id</span><span>(</span><span>&#34;serializable_logic&#34;</span><span>)</span><span>]</span><span></span><br/></span><span><span></span><span>[</span><span>LogicBlock</span><span>(</span><span>typeof</span><span>(</span><span>State</span><span>)</span><span>,</span><span> Diagram </span><span>=</span><span> </span><span>true</span><span>)</span><span>]</span><span></span><br/></span><span><span></span><span>public</span><span> </span><span>partial</span><span> </span><span>class</span><span> </span><span>MyLogicBlock</span><span> </span><span>:</span><span> </span><span>LogicBlock</span><span>&lt;</span><span>MyLogicBlock</span><span>.</span><span>State</span><span>&gt;</span><span> </span><span>{</span><span></span><br/></span><span><span>  </span><span>public</span><span> </span><span>override</span><span> </span><span>Transition</span><span> </span><span>GetInitialState</span><span>(</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>To</span><span>&lt;</span><span>State</span><span>.</span><span>PoweredOff</span><span>&gt;</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>  </span><span>[</span><span>Meta</span><span>]</span><span></span><br/></span><span><span>  </span><span>public</span><span> </span><span>abstract</span><span> </span><span>partial</span><span> </span><span>record</span><span> </span><span>State</span><span> </span><span>:</span><span> </span><span>StateLogic</span><span>&lt;</span><span>State</span><span>&gt;</span><span> </span><span>{</span><span></span><br/></span><span><span>    </span><span>[</span><span>Meta</span><span>,</span><span> </span><span>Id</span><span>(</span><span>&#34;serializable_logic_state_off&#34;</span><span>)</span><span>]</span><span></span><br/></span><span><span>    </span><span>public</span><span> </span><span>partial</span><span> </span><span>record</span><span> </span><span>PoweredOff</span><span> </span><span>:</span><span> </span><span>State</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>[</span><span>Meta</span><span>,</span><span> </span><span>Id</span><span>(</span><span>&#34;serializable_logic_state_on&#34;</span><span>)</span><span>]</span><span></span><br/></span><span><span>    </span><span>public</span><span> </span><span>partial</span><span> </span><span>record</span><span> </span><span>PoweredOn</span><span> </span><span>:</span><span> </span><span>State</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>[</span><span>Meta</span><span>,</span><span> </span><span>Id</span><span>(</span><span>&#34;serializable_logic_versioned_state&#34;</span><span>)</span><span>]</span><span></span><br/></span><span><span>    </span><span>public</span><span> </span><span>abstract</span><span> </span><span>partial</span><span> </span><span>record</span><span> </span><span>VersionedState</span><span> </span><span>:</span><span> </span><span>State</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>[</span><span>Meta</span><span>,</span><span> </span><span>Version</span><span>(</span><span>1</span><span>)</span><span>]</span><span></span><br/></span><span><span>    </span><span>public</span><span> </span><span>partial</span><span> </span><span>record</span><span> </span><span>Version1</span><span> </span><span>:</span><span> </span><span>VersionedState</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>[</span><span>Meta</span><span>,</span><span> </span><span>Version</span><span>(</span><span>2</span><span>)</span><span>]</span><span></span><br/></span><span><span>    </span><span>public</span><span> </span><span>partial</span><span> </span><span>record</span><span> </span><span>Version2</span><span> </span><span>:</span><span> </span><span>VersionedState</span><span>;</span><span></span><br/></span><span><span>  </span><span>}</span><span></span><br/></span><span><span></span><span>}</span><br/></span></code></pre></div></div><p>Oh ‚Äî¬†and LogicBlocks now has an <a href="https://effectivetypescript.com/docs/logic_blocks/">all new documentation site</a>! There&#39;s never been a better time to embrace the magic and rigor of statecharts.</p><h2 id="-a-better-autoinject">üíâ A Better AutoInject<a href="#-a-better-autoinject" aria-label="Direct link to üíâ A Better AutoInject" title="Direct link to üíâ A Better AutoInject">‚Äã</a></h2><p><a href="https://github.com/chickensoft-games/AutoInject" target="_blank" rel="noopener noreferrer">AutoInject</a> is our node-based dependency injection system. It allows you to find dependencies by searching ancestor nodes for the first node that has the dependency you&#39;re looking for. It&#39;s as simple as it sounds, at least in theory (the devil is in the implementation details).</p><section><a href="https://github.com/chickensoft-games/AutoInject"><summary>Node-based dependency injection for C# Godot scripts at build-time, including utilities for automatic node-binding, additional lifecycle hooks, and .net-inspired notification callbacks.</summary></a></section><p>Previously, AutoInject was built on top of <a href="https://github.com/chickensoft-games/SuperNodes" target="_blank" rel="noopener noreferrer">SuperNodes</a>. Now that <a href="https://github.com/chickensoft-games/SuperNodes" target="_blank" rel="noopener noreferrer">SuperNodes</a> has been deprecated and replaced with the new <a href="https://github.com/chickensoft-games/Introspection" target="_blank" rel="noopener noreferrer">Introspection</a> generator, the <a href="https://github.com/chickensoft-games/PowerUps" target="_blank" rel="noopener noreferrer">PowerUps</a> package (a set of mixins designed to work with AutoInject and SuperNodes) has also been deprecated. Fortunately, all of its functionality now lives inside AutoInject.</p><p>Like before, you can use the new <a href="https://github.com/chickensoft-games/Introspection" target="_blank" rel="noopener noreferrer">Introspection</a> generator to apply mixins. But, it&#39;s even simpler now ‚Äî <em>all</em> of the mixins available in AutoInject can be applied at once:</p><div><div><pre tabindex="0"><code><span><span></span><br/></span><span><span></span><span>[</span><span>Meta</span><span>(</span><span>typeof</span><span>(</span><span>IAutoNode</span><span>)</span><span>)</span><span>]</span><span></span><br/></span><span><span></span><span>public</span><span> </span><span>partial</span><span> </span><span>class</span><span> </span><span>MyNode</span><span> </span><span>:</span><span> </span><span>Node</span><span> </span><span>{</span><span> </span><span>}</span><br/></span></code></pre></div></div><p>That one little line above allows you to automatically bind nodes to properties, inject dependencies, provide dependencies, and use .NET-style notification callbacks and get additional lifecycle notifications that help with unit testing nodes, if that&#39;s your jam. Be sure to checkout the AutoInject repository for more details.</p><h2 id="Ô∏è-saving--loading-in-the-game-demo">üïπÔ∏è Saving &amp; Loading in the Game Demo<a href="#Ô∏è-saving--loading-in-the-game-demo" aria-label="Direct link to üïπÔ∏è Saving &amp; Loading in the Game Demo" title="Direct link to üïπÔ∏è Saving &amp; Loading in the Game Demo">‚Äã</a></h2><p>Of course, no long-winded blog announcing a bunch of new packages would be complete without a demo. The Chickensoft Game Demo has been updated to version 3, and now includes full state persistence and restoration, thanks to all these new tools.</p><section><a href="https://github.com/chickensoft-games/GameDemo"><summary>The Chickensoft Game Demo ‚Äî a fully tested, third-person 3D game built with Godot and C#. Now with saving and loading!</summary></a></section><p>If you&#39;re still fuzzy on the details, go check out the code and take a closer look. There&#39;s also nearly 300 unit tests that can help show you how any particularly part of the code works, too.</p><h2 id="conclusion">Conclusion<a href="#conclusion" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2><p>We&#39;ll close by celebrating the fact that Chickensoft has now reached a new layer of the gamedev hierarchy of needs: serialization. Now we can start solving the real problems.</p><figure><a href="https://effectivetypescript.com/assets/images/pyramid-cdd04d816a39737a17702602585d3071.jpg"><img src="https://effectivetypescript.com/assets/images/pyramid-cdd04d816a39737a17702602585d3071.jpg" alt="Maslow&#39;s hierarchy of game development"/></a><figcaption></figcaption></figure><p>If you made it this far, thanks for reading ‚Äî and happy serializing!</p><div><div><h3>You have been invited to join a server</h3><div><p><img src="https://effectivetypescript.com/img/chickensoft/chickensoft_logo.svg"/></p><div><h3>Chickensoft</h3><p><i></i><strong><span id="discordNumOnline">#</span> <!-- -->Online</strong><i></i><strong><span id="discordNumMembers">#</span> <!-- -->Members</strong></p></div></div></div></div></div></div>
  </body>
</html>
