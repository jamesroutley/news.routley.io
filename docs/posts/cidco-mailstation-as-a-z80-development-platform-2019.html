<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jcs.org/2019/05/03/mailstation">Original</a>
    <h1>Cidco MailStation as a Z80 Development Platform (2019)</h1>
    
    <div id="readability-page-1" class="page"><article>
					<header>
						
						
					</header>
					<p>The Cidco MailStation is a series of dedicated e-mail terminals sold
						in the 2000s as simple, standalone devices for people to use to send and receive
						e-mail over dialup modem.
						While their POP3 e-mail functionality is of little use today, the hardware is a
						neat Z80 development platform that integrates a 320x128 LCD, full QWERTY keyboard,
						and an internal modem.</p>
					<p>After purchasing one (ok, four) on eBay some months ago, I&#39;ve learned enough
						about the platform to write my own software that allows it to be a terminal for
						accessing BBSes via its modem or as a terminal for a Unix machine connected over
						parallel cable.</p>
					<figure></figure>
					
					<h2 id="z80">Z80</h2>
					<p>I&#39;ve been
						<a href="https://jcs.org/2017/06/23/wifi232">tinkering</a>
						with old computers in the past few years, but the
						<a href="https://en.wikipedia.org/wiki/ZX_Spectrum">BASIC-interpreter-hooked-up-to-a-TV</a>
						or the single-board-6502 never really appealed to me.
						This is probably because I skipped that generation of computing growing up, with
						my first computers being full IBM-compatible PCs.</p>
					<p>The MailStation has a Z80 processor which is small and easy to program, but it
						also comes with an integrated LCD and keyboard in a small footprint that can
						optionally be powered by three AA batteries.
						Since the Z80 is also used in
						<a href="https://en.wikipedia.org/wiki/TI-81">TI calculators</a>
						and a bunch of old computers like the
						<a href="https://en.wikipedia.org/wiki/TRS-80">TRS-80</a>,
						there are many resources available for learning Z80 assembly.
						The
						<a href="http://z80-heaven.wikidot.com/instructions-set">instruction set</a>
						is small and easy to understand, especially while reading disassembled code from
						the MailStation&#39;s factory ROM.</p>
					<p>While the MailStation is now twenty years old, I had never heard of them before
						last year.
						Fortunately, some very smart and friendly people learned and shared a lot
						about these devices a decade ago by reverse engineering the firmware and doing
						various hardware modifications.
						MailStation devices are still
						<a href="https://rover.ebay.com/rover/1/711-53200-19255-0/1?icep_id=114&amp;ipn=icep&amp;toolid=20004&amp;campid=5338525733&amp;mpre=https%3A%2F%2Fwww.ebay.com%2Fsch%2Fi.html%3F_from%3DR40%26_trksid%3Dp2380057.m570.l1313.TR10.TRC0.A0.H0.Xcidco%2Bmailstation.TRS0%26_nkw%3Dcidco%2Bmailstation%26_sacat%3D0">appearing on eBay</a>
						for $5-$35 today.</p>
					<p>Most of the information I learned came from
						<a href="http://www.fybertech.net/mailstation/">Jeff&#39;s MailStation page</a>
						and the now-quiet
						<a href="https://groups.yahoo.com/neo/groups/mailstation/info">Yahoo! group</a>
						which was active from 2004-2012.
						Unfortunately Yahoo! Groups no longer makes available any of the files that
						members uploaded which included a lot of utilities and documentation, though I
						have archived the public e-mail messages from the group in
						<a href="https://raw.githubusercontent.com/jcs/mailstation-tools/master/docs/yahoo-group.mbox">mbox</a>
						format for easy searching.</p>
					<h2 id="hardware-specifications">Hardware Specifications</h2>
					<p>The MailStation was sold in a few different models over the years starting with
						the Mivo 100, which is what I have:</p>
					<ul>
						<li><a href="https://en.wikipedia.org/wiki/Zilog_Z80">Z80 processor</a> which can operate at
							8, 10, or 12 MHz</li>
						<li>128 KB static RAM (8 bankable pages)</li>
						<li>1 MB flash memory (64 bankable pages of OS code, referred to as &#34;codeflash&#34;)</li>
						<li>512 KB flash memory (32 bankable pages of user data such as downloaded
							e-mails, referred to as &#34;dataflash&#34;)</li>
						<li>Rockwell RCV336DPFSP 33.6kbps modem with caller ID</li>
						<li>Bidirectional parallel port</li>
						<li>320x128 monochrome LCD</li>
						<li>Real-time clock</li>
						<li>72-key QWERTY keyboard</li>
						<li>&#34;New Mail&#34; LED</li>
					</ul>
					<p>Because the Z80 is an 8-bit processor and can only access 64 KB of address space
						(<code>0x0000</code> - <code>0xffff</code>), the additional pages of RAM, flash memory, and I/O devices
						are
						<a href="https://en.wikipedia.org/wiki/Bank_switching">banked</a>
						into one of two slots at <code>0x4000</code> and <code>0x8000</code> at any given time.
						The first 16 KB of address space always corresponds to the first page of the
						1 MB of OS code (&#34;codeflash&#34;) and the last 16 KB is always the first page of the
						128 KB of RAM.</p>
					<p>Unfortunately since the first 16 KB is not RAM, it is not an easy target for
						porting the
						<a href="https://en.wikipedia.org/wiki/CP/M">CP/M</a> operating system.
						A
						<a href="http://www.fybertech.net/mailstation/hardwaremod.php">hardware modification</a>
						can be done to bank in a page of RAM for the first 16 KB of memory and
						reportedly a CP/M BIOS has been written to work in this configuration.
						I have concentrated my efforts on running code without any hardware modifications.</p>
					<h2 id="loading-custom-code">Loading Custom Code</h2>
					<p>When used as an e-mail terminal, the Mailstation could download specially
						formatted and authenticated
						<a href="https://patents.google.com/patent/US6697942">&#34;Clipmail&#34; e-mails</a>
						that would allow the settings on the device to be changed, such as the
						user&#39;s e-mail password or the dialup number.</p>
					<p>Cidco
						<a href="http://archive.is/FBrtF">partnered with Yahoo!</a>
						for Mailstation users to receive Yahoo! content in the form of small applications
						that were downloaded to the devices through Clipmail.
						These were simple single-screen applications (mostly just a full-screen bitmap)
						that showed TV listings, horoscopes, weather, etc.
						Cidco would send out Clipmail e-mails and when each Mailstation automatically
						dialed up overnight and fetched them via POP3, there would be new Yahoo! content
						waiting for the user the next day.</p>
					<p>Old Mailstations purchased off of eBay will sometimes have these old applications
						with TV listings and weather data frozen in time, providing a snapshot of life in
						the mid-2000s.</p>
					<figure><a href="https://jcs.org/images/2019-05-03-mailstation_tv_listing-1500x806.jpg"><img src="https://jcs.org/images/2019-05-03-mailstation_tv_listing-680x365.jpg" srcset="/images/2019-05-03-mailstation_tv_listing-680x365.jpg 1x, /images/2019-05-03-mailstation_tv_listing-1360x730@2x.jpg 2x" width="680" height="365"/></a></figure>
					<p>These applications are each stored in a separate page of dataflash and presented
						to the user under a Yahoo! menu, or on some devices, through an Extras menu.
						Up to five applications can be stored at a time.</p>
					<figure><a href="https://jcs.org/images/2019-05-03-mailstation_app_menu-1500x848.jpg"><img src="https://jcs.org/images/2019-05-03-mailstation_app_menu-680x384.jpg" srcset="/images/2019-05-03-mailstation_app_menu-680x384.jpg 1x, /images/2019-05-03-mailstation_app_menu-1360x768@2x.jpg 2x" width="680" height="384"/></a></figure>
					<p><em>&#34;Loader&#34; and &#34;FlashLoader&#34; are custom applications that I loaded</em></p>
					<p>The easiest way to load arbitrary code onto the Mailstation is by acting as one
						of those Yahoo! applications and writing the program code to the dataflash chip
						where it will automatically show up in this Yahoo! menu.</p>
					<p>As luck would have it, the Mailstation ROM contains a built-in hex editor that
						can view or edit any data on the dataflash through a secret menu.
						By holding down <code>Fn+Shift+T</code> when pressing the Power button, the Diagnostic Menu
						can be accessed:</p>
					<figure><a href="https://jcs.org/images/2019-05-03-mailstation_diagnostic_menu-1500x655.jpg"><img src="https://jcs.org/images/2019-05-03-mailstation_diagnostic_menu-680x296.jpg" srcset="/images/2019-05-03-mailstation_diagnostic_menu-680x296.jpg 1x, /images/2019-05-03-mailstation_diagnostic_menu-1360x592@2x.jpg 2x" width="680" height="296"/></a></figure>
					<p>Pressing <code>Shift+F5</code> (the right-most grey button under the screen) will open the
						hex editor and pressing <code>g</code> will prompt for an address.
						By entering <code>710304x</code> as the address (the <code>x</code> must be typed but will not be shown)
						it enables write-mode, which can then be accessed by pressing <code>s</code>.</p>
					<figure><a href="https://jcs.org/images/2019-05-03-mailstation_hex_editor-1500x637.jpg"><img src="https://jcs.org/images/2019-05-03-mailstation_hex_editor-680x288.jpg" srcset="/images/2019-05-03-mailstation_hex_editor-680x288.jpg 1x, /images/2019-05-03-mailstation_hex_editor-1360x576@2x.jpg 2x" width="680" height="288"/></a></figure>
					<p><em>In case you thought the <code>g710304x</code> label in these pictures was my passwordâ€¦</em></p>
					<p>Once in write mode, raw Z80 opcodes can be entered, composing an executable
						program.
						If it follows a particular layout, it will be made available as an application
						under the Yahoo/Extras menu complete with name and icon.</p>
					<p>Of course, hand-typing hex digits can be tedious and error-prone, so an easier
						way to load custom code is by bootstrapping with a
						<a href="https://github.com/jcs/mailstation-tools/blob/master/loader.asm">loader program</a>
						(the
						<a href="https://github.com/jcs/mailstation-tools/blob/master/z80/loader.bin">binary</a>
						of which is just 97 bytes to type in).
						When run from the Yahoo! menu, this loader application will just wait for new
						code to be sent over the parallel port, copy it into RAM, and then execute it.
						The
						<a href="https://github.com/jcs/mailstation-tools/blob/master/docs/loader.txt">documentation</a>
						for this loader program goes into more detail about how apps are structured on
						the flash.</p>
					<p>To send code from another computer through the parallel port, a
						<a href="https://en.wikipedia.org/wiki/LapLink_cable">LapLink cable</a>
						(I&#39;m using a
						<a href="https://amzn.to/2yAvvs1">Belkin F3D508-10</a>)
						must be used along with a
						<a href="https://github.com/jcs/mailstation-tools/blob/master/util/sendload.c">sending</a>
						program.</p>
					<p>Unfortunately the cross-section of computers that are fast and comfortable enough
						to do development and compilation, and old enough to have a real parallel port is
						not very large these days.
						In my case I am running OpenBSD on an HP OmniBook 800CT that just acts as a
						proxy, listening on a TCP port for data and then sending anything it receives
						over its parallel port in the custom format the MailStation expects.
						This allows me to edit and compile code on my main laptop and send it over the
						network with <code>nc</code> to the OmniBook, where it then gets uploaded to the Mailstation
						and executed.</p>
					<p>Perhaps someone more skilled than me can program some USB device like an Arduino
						to emulate an LPT port to make it easier to transfer code.</p>
					<p><strong>Update (2020-03-31):</strong> Apparently I am more skilled than I was last year and
						have finally
						<a href="https://jcs.org/2020/03/31/mailstation_usb">made a USB loader</a>.</p>
					<p><strong>Update (2021-04-30):</strong> I&#39;ve also made a WiFi device for the MailStation called
						<a href="https://jcs.org/wifistation">WiFiStation</a>
						that can load code over the network.</p>
					<p>Once a program has been tested by this dynamic loading, it can eventually be
						written to the dataflash itself to show up in the Yahoo! menu as a standalone
						application.
						Add three AA batteries and you can have a completely portable Z80 computer running
						your own applications.</p>
					<h2 id="development-environment">Development Environment</h2>
					<p>I am developing on my
						<a href="https://jcs.org/2017/07/14/matebook">OpenBSD laptop</a>
						writing C and Z80 assembly in Vim.
						I compile code with
						<a href="http://sdcc.sourceforge.net/">SDCC</a>
						and then upload to the Mailstation over parallel port as described above (with
						<code>make upload</code>).</p>
					<p>SDCC provides a small Z80-specific C library implementing things like <code>printf</code>,
						but device-specific code had to be written to implement <code>putchar</code> and <code>getchar</code>
						to interface with the Mailstation&#39;s custom LCD and keyboard.</p>
					<p>Most of the original code fragments I found for the MailStation on the Yahoo!
						Group were written to compile with the
						<a href="http://www.kingswood-consulting.co.uk/assemblers/">Kingswood AS80</a>
						assembler for DOS/Windows, so I have rewritten everything I used to assemble
						with SDCC&#39;s <code>asz80</code> assembler.
						Additionally, all of the host-side tools like the program to send code to the
						MailStation were written to run on Windows, so I have written new tools that
						run on OpenBSD (which could probably run on Linux quite easily).</p>
					<p>Since much of the information available for the MailStation is scattered across
						hundreds of mailing list posts and defunct forums, I&#39;ve tried to assemble much of
						it, along with my tools, in a 
						<a href="https://github.com/jcs/mailstation-tools">central repository</a>
						that will hopefully not get lost to time and Yahoo! acquisitions.</p>
					<p><strong>Update:</strong> An SDL-based emulator for the MailStation was being developed back in
						2010 and has
						<a href="https://github.com/kbembedded/msemu">resumed development</a>
						under new developers.</p>
					<h2 id="mailstation-firmware">MailStation Firmware</h2>
					<p>The OS that runs the MailStation is fairly easy to use given its target audience,
						and rather performant, especially given its slow CPU clock speed.</p>
					<p>Some members of the Yahoo! Group were focused on reverse engineering that firmware
						code to map out all of the built-in functions and understand how it works, in
						order to write custom applications that acted like the built-in utilities.
						I&#39;m not sure exactly what tools they were using a decade ago to disassemble the
						firmware, but it makes for some tricky reading.</p>
					<p>It&#39;s relatively easy to read disassembled Z80 code and understand what it does,
						but it&#39;s much harder to understand <em>why</em> it&#39;s doing what it is, especially with
						the MailStation&#39;s memory layout.</p>
					<p>The first 16 KB page of firmware code from the codeflash chip is located at
						<code>0x0000</code> with each additional 16 KB page able to be swapped into slot 8
						(<code>0x8000</code>) at any time.
						However, each 16 KB page of dataflash can also be swapped into this region. 
						This can make it difficult to follow when reading since each page (after the
						first) is written as if it is located at <code>0x8000</code> and this code often swaps in a
						new page at the same location it&#39;s being run from.
						So code running at, say <code>0x8123</code>, will call a function in the permanent first page
						which will swap in a new 16 KB page of code at <code>0x8000</code>, execute a function
						in that space, then swap the old page back in and return to <code>0x8123</code>.</p>
					<p>While I was working on this over the past few months,
						<a href="https://ghidra-sre.org/">Ghidra</a>
						was released and included Z80 CPU support, which has been fairly helpful in
						turning assembly functions into pseudo-C code to better understand what&#39;s going
						on.</p>
					<p>Eventually I hit enough roadblocks trying to understand and use the built-in
						firmware functions that I decided to re-implement most of what I needed myself.
						However, I still need to read the firmware code quite often to figure out how to
						interface with particular hardware or try to figure out what some existing
						variable in memory is for.</p>
					<h2 id="creating-msterm">Creating msTERM</h2>
					<p>My goal for the MailStation was to write a terminal program allowing me to dial
						into BBSes and make full use of the MailStation&#39;s internal modem.
						This required writing a custom <code>putchar</code> that could handle absolute cursor
						positioning and attributes (underline, reverse, etc.),
						a <code>getchar</code> routine to read from the keyboard that could handle using Caps Lock
						as a Control key, an
						<a href="https://en.wikipedia.org/wiki/ANSI_escape_code">ANSI escape code</a>
						parser, and eventually a custom interrupt service routine (ISR) to communicate
						with the modem.</p>
					<p>I also modified the
						<a href="https://github.com/fcambus/spleen">5x8 Spleen font</a>
						to add many of the
						<a href="https://en.wikipedia.org/wiki/Code_page_437">437 code page</a>
						characters used by many BBSes and ANSI art for drawing shapes and shading.</p>
					<p>Before I figured out how to properly communicate with the modem, I made msTERM
						able to communicate bi-directionally over its parallel port using the LapLink
						cable.
						On the host side, a
						<a href="https://github.com/jcs/mailstation-tools/blob/master/util/tribble_getty.c">small program</a>
						interfaces between <code>getty</code> and its parallel port using specific routines for
						sending a byte in 3 pieces, which specific functions in the firmware of the
						MailStation expect.
						This allowed me to login to my OpenBSD laptop from the MailStation and then
						telnet to the <a href="https://bbs.fozztexx.com/">Level 29 BBS</a>:</p>
					<figure><a href="https://jcs.org/images/2019-05-03-mailstation_openbsd-1500x525.jpg"><img src="https://jcs.org/images/2019-05-03-mailstation_openbsd-680x238.jpg" srcset="/images/2019-05-03-mailstation_openbsd-680x238.jpg 1x, /images/2019-05-03-mailstation_openbsd-1360x476@2x.jpg 2x" width="680" height="238"/></a></figure>
					<figure><a href="https://jcs.org/images/2019-05-03-mailstation_level_29-1500x606.jpg"><img src="https://jcs.org/images/2019-05-03-mailstation_level_29-680x274.jpg" srcset="/images/2019-05-03-mailstation_level_29-680x274.jpg 1x, /images/2019-05-03-mailstation_level_29-1360x548@2x.jpg 2x" width="680" height="274"/></a></figure>
					<h2 id="communicating-with-the-modem">Communicating with the Modem</h2>
					<p>After weeks of reverse engineering the MailStation firmware&#39;s code and reading
						the
						<a href="https://github.com/jcs/mailstation-tools/blob/master/docs/modem-RCV336DPFSP.pdf">modem chip documentation</a>,
						I realized that the built-in interrupt service routine (ISR) of the
						MailStation firmware was responding to the modem before my program could get
						a chance to, so I had to implement my own ISR to take over all interrupt handling.
						Since I couldn&#39;t easily change the firmware code without reflashing, I used the
						Z80&#39;s
						<a href="http://archive.is/F07WH">interrupt mode 2</a>
						to have it call my own ISR while msTERM is running.</p>
					<p>This finally allowed me to communicate with the modem and issue <code>AT</code> commands
						like normal.
						Fortunately there is great
						<a href="https://github.com/jcs/mailstation-tools/blob/master/docs/modem-RCV336DPFSP.pdf">documentation</a>
						available for the modem chip that made this pretty easy once I had the ISR
						working.</p>
					<p>At this point I&#39;ve got most of the modem functionality working and can use it to
						dial into BBSes, though it drops data on faster connections because my
						<code>putchar</code> routine is too slow to draw lots of text on the LCD.
						This is because I&#39;m using a font that is not 8 pixels wide (to get a bigger
						terminal) but the LCD has to be addressed in columns of 8 pixels wide, so drawing
						one character usually requires reading the characters around it and redrawing
						halves of them to redraw a column on the LCD.</p>
					<h2 id="msterm-release">msTERM Release</h2>
					<p>I&#39;ve
						<a href="https://github.com/jcs/msTERM">released the code to msTERM</a>
						and am continuing to improve things.
						I recently added the ability to read the MailStation&#39;s RTC to display the current
						time on the status bar, and am blinking the New Mail light when the modem passes
						data, like an external modem.</p>
					<p>If you&#39;re interested in playing with one of these devices, pick one up on 
						<a href="https://rover.ebay.com/rover/1/711-53200-19255-0/1?icep_id=114&amp;ipn=icep&amp;toolid=20004&amp;campid=5338525733&amp;mpre=https%3A%2F%2Fwww.ebay.com%2Fsch%2Fi.html%3F_from%3DR40%26_trksid%3Dp2380057.m570.l1313.TR10.TRC0.A0.H0.Xcidco%2Bmailstation.TRS0%26_nkw%3Dcidco%2Bmailstation%26_sacat%3D0">eBay</a>
						and
						<a href="https://jcs.org/contact">reach out</a>.
						I&#39;d love to get help with msTERM or help anyone else wanting to write a BASIC
						interpreter or something fun.</p>
					<p><strong>Update (2021-04-30):</strong> I&#39;ve abstracted code from my msTERM project to a small
						<a href="https://github.com/jcs/MailStation-Example">example project</a>
						that should make it easier to get started writing your own programs for the
						MailStation.
						I&#39;ve also created a WiFi adapter for the MailStation called
						<a href="https://jcs.org/wifistation">WiFiStation</a>
						that makes it easier to upload code and get the MailStation talking to the
						internet.</p>
				</article></div>
  </body>
</html>
