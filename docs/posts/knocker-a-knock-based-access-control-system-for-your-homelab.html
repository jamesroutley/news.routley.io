<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/FarisZR/knocker">Original</a>
    <h1>Knocker, a knock based access control system for your homelab</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text"><p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/FarisZR/knocker/blob/main/assets/knocker-banner.webp"><img src="https://github.com/FarisZR/knocker/raw/main/assets/knocker-banner.webp" alt=""/></a></p>
<p dir="auto">Knocker is a configurable, and self-hosted service that provides an HTTP based &#34;knock-knock&#34; single-packet authorization (SPA) gateway for your Homelab with web, cli and android clients.
it can be used as authentication for your reverse proxy like Caddy, or even on the firewall level using the FirewallD integration. It allows you to keep your services completely private, opening them up on-demand only for authorized IP addresses.</p>
<p dir="auto">This is ideal for homelab environments where you want to expose services to the internet without a persistent VPN connection, while minimizing your public-facing attack surface.</p>

<section data-identity="1163c8a8-6c47-49b3-9f8a-bb3362a0fe5a" data-host="https://viewscreen.githubusercontent.com" data-src="https://viewscreen.githubusercontent.com/markdown/mermaid?docs_host=https%3A%2F%2Fdocs.github.com" data-type="mermaid" aria-label="mermaid rendered output container">
  <div data-json="{&#34;data&#34;:&#34;sequenceDiagram\n    participant User\n    participant Caddy as Reverse Proxy (Caddy)\n    participant Knocker\n    participant Service as Protected Service\n\n    User-&amp;gt;&amp;gt;Caddy: HTTP request to protected service\n    Caddy-&amp;gt;&amp;gt;Knocker: GET /verify (copies X-Forwarded-For)\n    Knocker--&amp;gt;&amp;gt;Knocker: check always_allowed_ips / excluded_paths / whitelist\n    alt IP whitelisted\n        Knocker--&amp;gt;&amp;gt;Caddy: 200 OK (empty body)\n        Caddy-&amp;gt;&amp;gt;Service: forward request\n        Service--&amp;gt;&amp;gt;Caddy: 200 OK\n        Caddy--&amp;gt;&amp;gt;User: 200 OK\n    else IP not whitelisted\n        Knocker--&amp;gt;&amp;gt;Caddy: 401 Unauthorized (empty body)\n        Caddy--&amp;gt;&amp;gt;User: 401 Unauthorized\n    end\n\n    Note over User,Knocker: Performing a \&#34;knock\&#34; (to add whitelist entry)\n    User-&amp;gt;&amp;gt;Knocker: POST /knock (X-Api-Key, optional ip_address, ttl)\n    Knocker-&amp;gt;&amp;gt;Knocker: validate API key, determine client IP\n    Knocker-&amp;gt;&amp;gt;Knocker: update whitelist.json with expiry\n    Knocker--&amp;gt;&amp;gt;User: 200 OK (whitelisted_entry, expires_at, expires_in_seconds)\n&#34;}" data-plain="sequenceDiagram
    participant User
    participant Caddy as Reverse Proxy (Caddy)
    participant Knocker
    participant Service as Protected Service

    User-&gt;&gt;Caddy: HTTP request to protected service
    Caddy-&gt;&gt;Knocker: GET /verify (copies X-Forwarded-For)
    Knocker--&gt;&gt;Knocker: check always_allowed_ips / excluded_paths / whitelist
    alt IP whitelisted
        Knocker--&gt;&gt;Caddy: 200 OK (empty body)
        Caddy-&gt;&gt;Service: forward request
        Service--&gt;&gt;Caddy: 200 OK
        Caddy--&gt;&gt;User: 200 OK
    else IP not whitelisted
        Knocker--&gt;&gt;Caddy: 401 Unauthorized (empty body)
        Caddy--&gt;&gt;User: 401 Unauthorized
    end

    Note over User,Knocker: Performing a &#34;knock&#34; (to add whitelist entry)
    User-&gt;&gt;Knocker: POST /knock (X-Api-Key, optional ip_address, ttl)
    Knocker-&gt;&gt;Knocker: validate API key, determine client IP
    Knocker-&gt;&gt;Knocker: update whitelist.json with expiry
    Knocker--&gt;&gt;User: 200 OK (whitelisted_entry, expires_at, expires_in_seconds)
" dir="auto">
    <div dir="auto">
      <pre lang="mermaid" aria-label="Raw mermaid code">sequenceDiagram
    participant User
    participant Caddy as Reverse Proxy (Caddy)
    participant Knocker
    participant Service as Protected Service

    User-&gt;&gt;Caddy: HTTP request to protected service
    Caddy-&gt;&gt;Knocker: GET /verify (copies X-Forwarded-For)
    Knocker--&gt;&gt;Knocker: check always_allowed_ips / excluded_paths / whitelist
    alt IP whitelisted
        Knocker--&gt;&gt;Caddy: 200 OK (empty body)
        Caddy-&gt;&gt;Service: forward request
        Service--&gt;&gt;Caddy: 200 OK
        Caddy--&gt;&gt;User: 200 OK
    else IP not whitelisted
        Knocker--&gt;&gt;Caddy: 401 Unauthorized (empty body)
        Caddy--&gt;&gt;User: 401 Unauthorized
    end

    Note over User,Knocker: Performing a &#34;knock&#34; (to add whitelist entry)
    User-&gt;&gt;Knocker: POST /knock (X-Api-Key, optional ip_address, ttl)
    Knocker-&gt;&gt;Knocker: validate API key, determine client IP
    Knocker-&gt;&gt;Knocker: update whitelist.json with expiry
    Knocker--&gt;&gt;User: 200 OK (whitelisted_entry, expires_at, expires_in_seconds)
</pre>
    </div>
  </div>
  <span role="presentation">
    <span data-view-component="true">
  <svg style="box-sizing: content-box; color: var(--color-icon-primary);" width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true" data-view-component="true">
    <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-opacity="0.25" stroke-width="2" vector-effect="non-scaling-stroke" fill="none"></circle>
    <path d="M15 8a7.002 7.002 0 00-7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" vector-effect="non-scaling-stroke"></path>
</svg>    <span>Loading</span>
</span>
  </span>
</section>


<ul dir="auto">
<li><strong>API Key Authentication</strong>: Secure your knock endpoint with multiple, configurable API keys.</li>
<li><strong>Configurable TTL</strong>: Each API key can have its own Time-To-Live (TTL), defining how long a whitelisted IP remains active.</li>
<li><strong>Remote Whitelisting</strong>: Grant specific admin keys permission to whitelist any IP or CIDR range, not just their own.</li>
<li><strong>Static IP/CIDR Whitelisting</strong>: Always allow certain IP addresses or ranges to bypass the dynamic whitelist.</li>
<li><strong>Path-Based Exclusion</strong>: Exclude specific URL paths (like health checks or public APIs) from authentication entirely.</li>
<li><strong>IPv6 First-Class Citizen</strong>: Full support for IPv6 and IPv4 in whitelisting, trusted proxies, and Docker networking.</li>
<li><strong>Firewalld Integration</strong>: Advanced firewall control with timed rules that automatically expire based on TTL. Creates dynamic firewall rules using firewalld rich rules for enhanced security. (Optional, requires root container access)</li>
</ul>

<ul dir="auto">
<li><a href="https://github.com/FarisZR/knocker-web">Knocker-Web</a>
Static PWA web app that supports knocking(whitelisting) on reload</li>
<li><a href="https://github.com/FarisZR/knocker-cli">Knocker-CLI</a>
A cli written in go with support for background knocks optionally trigged by ip chanages.</li>
<li><a href="https://github.com/FarisZR/knocker-EXPO">Knocker-EXPO</a>
An experimental Android App written in React EXPO with support for background knocking requests</li>
</ul>

<p dir="auto">This project is designed to be deployed as a set of Docker containers using the provided <code>docker-compose.yml</code> file. It uses the pre-built docker images with support for AMD64, ARMv8 and ARMv7</p>

<p dir="auto">Knocker provides different image tags for different use cases:</p>
<ul dir="auto">
<li><strong><code>latest</code></strong> - Latest stable release (recommended for production)</li>
<li><strong><code>v1.2.3</code></strong> - Specific version tags (pinned versions)</li>
<li><strong><code>main</code></strong> - Development branch (rolling updates, may be unstable)</li>
</ul>

<ul dir="auto">
<li>Docker and Docker Compose installed.</li>
<li>A public-facing server to run the containers (doesn&#39;t even have to be on the same server running the services! IN PROXY MODE)</li>
<li>(Optional) Firewalld 2.0+ installed and running on the host for advanced firewall integration.</li>
</ul>
<ol dir="auto">
<li>
<p dir="auto"><strong>Configuration</strong>:</p>
<ul dir="auto">
<li>Rename <code>knocker.example.yaml</code> to <code>knocker.yaml</code>.</li>
<li><strong>Crucially, change the default API keys</strong> in <code>knocker.yaml</code> to your own secure, random strings.</li>
<li>Review the <code>trusted_proxies</code> list in <code>knocker.yaml</code>, they should match the subnet of the reverse proxy&#39;s network (<code>docker network inspect xxx</code>)</li>
<li>(Optional) Configure firewalld integration by setting <code>firewalld.enabled: true</code> and adjusting the related settings. <strong>Note</strong>: This requires the container to run as root.</li>
</ul>
</li>
<li>
<p dir="auto"><strong>Run the Service</strong>:</p>

<p dir="auto">This will pull the pre-built <code>knocker</code> image and start both the <code>knocker</code> and <code>caddy</code> services.</p>
</li>
</ol>
<div dir="auto"><h2 tabindex="-1" dir="auto">Use knocker with a Reverse Proxy</h2><a id="user-content-use-knocker-with-a-reverse-proxy" aria-label="Permalink: Use knocker with a Reverse Proxy" href="#use-knocker-with-a-reverse-proxy"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Knocker works by acting as an auth gateway for your reverse Proxy.
It offers a verify endpoint, to check if the requesting IP is whitelisted or not, if not it will reply with a 401 and the reverse proxy will refuse the connection.</p>

<p dir="auto">Caddy has the <code>forward_auth</code> directive to check connections using an auth endpoint.</p>
<ol dir="auto">
<li>
<p dir="auto"><strong>Define a Reusable Snippet</strong>: It&#39;s best practice to define a snippet in your <code>Caddyfile</code> for the auth check.</p>
</li>
<li>
<p dir="auto"><strong>Protect Your Services</strong>: Import the snippet for any service you want to protect.</p>
</li>
</ol>
<p dir="auto"><strong>Example <code>Caddyfile</code></strong>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# Caddyfile

# Define a reusable snippet for the knock-knock check.
# It points to the knocker service using Docker&#39;s internal DNS.
(knocker_auth) {
  forward_auth knocker:8000 {
    uri /verify
    copy_headers X-Forwarded-For
  }
}

# The public endpoint for performing the knock.
# Make sure this domain points to your Caddy server&#39;s IP.
knock.your-domain.com {
  reverse_proxy knocker:8000
}

# An example protected service.
jellyfin.your-domain.com {
  import knocker_auth  # Apply the forward_auth check
  reverse_proxy jellyfin_service_name:8096
}"><pre><span># Caddyfile</span>

<span># Define a reusable snippet for the knock-knock check.</span>
<span># It points to the knocker service using Docker&#39;s internal DNS.</span>
(knocker_auth) {
<span>  forward_auth</span> knocker<span>:8000</span> {
<span>    uri</span> <span>/verify</span>
<span>    copy_headers</span> X-Forwarded-For
  }
}

<span># The public endpoint for performing the knock.</span>
<span># Make sure this domain points to your Caddy server&#39;s IP.</span>
<span>knock.your-domain.com</span> {
<span>  reverse_proxy</span> knocker<span>:8000</span>
}

<span># An example protected service.</span>
<span>jellyfin.your-domain.com</span> {
<span>  import</span> knocker_auth <span> # Apply the forward_auth check</span>
<span>  reverse_proxy</span> jellyfin_service_name<span>:8096</span>
}</pre></div>

<p dir="auto">When a user is not whitelisted, Caddy&#39;s <code>forward_auth</code> directive will return a <code>401 Unauthorized</code> response with an empty body.</p>
<p dir="auto"><strong>Important Note</strong>: Caddy&#39;s <code>handle_errors</code> directive does <strong>not</strong> work with <code>forward_auth</code> responses. The error response comes directly from the authentication service (knocker), not from Caddy itself, so <code>handle_errors</code> cannot intercept or modify these responses.</p>

<p dir="auto">Knocker provides advanced firewall integration through firewalld, creating dynamic, time-based firewall rules that automatically expire based on the TTL specified in knock requests. This feature operates at the network level, allowing you to use knocker for non-http services like ssh or game servers.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Sequence diagram (firewalld)</h2><a id="user-content-sequence-diagram-firewalld" aria-label="Permalink: Sequence diagram (firewalld)" href="#sequence-diagram-firewalld"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<section data-identity="da8b673a-4ac0-44c6-b0c8-b2a9624926e8" data-host="https://viewscreen.githubusercontent.com" data-src="https://viewscreen.githubusercontent.com/markdown/mermaid?docs_host=https%3A%2F%2Fdocs.github.com" data-type="mermaid" aria-label="mermaid rendered output container">
  <div data-json="{&#34;data&#34;:&#34;sequenceDiagram\n    participant Client as User\n    participant Firewall as Firewalld (knocker zone)\n    participant Knocker\n    participant Service as Protected Service (port 22)\n\n    Note over Client,Firewall: Initial state — monitored port is blocked by default\n    Client-&amp;gt;&amp;gt;Firewall: TCP SYN to Service:22\n    Firewall--&amp;gt;&amp;gt;Client: DROP (no response)\n\n    Note over Client,Knocker: User performs a knock to whitelist their IP\n    Client-&amp;gt;&amp;gt;Knocker: POST /knock (X-Api-Key, optional ip_address, ttl)\n    Knocker-&amp;gt;&amp;gt;Knocker: validate API key &amp;amp; determine client IP\n    Knocker-&amp;gt;&amp;gt;Firewall: add rich accept rule for client IP on port 22 with timeout\n    Firewall--&amp;gt;&amp;gt;Knocker: success\n\n    Note over Firewall,Client: New rule overrides DROP due to higher priority\n    Client-&amp;gt;&amp;gt;Firewall: TCP SYN to Service:22\n    Firewall-&amp;gt;&amp;gt;Service: forward packet\n    Service--&amp;gt;&amp;gt;Client: TCP SYN-ACK (connection established)\n    Knocker-&amp;gt;&amp;gt;Knocker: update whitelist.json with expiry\n&#34;}" data-plain="sequenceDiagram
    participant Client as User
    participant Firewall as Firewalld (knocker zone)
    participant Knocker
    participant Service as Protected Service (port 22)

    Note over Client,Firewall: Initial state — monitored port is blocked by default
    Client-&gt;&gt;Firewall: TCP SYN to Service:22
    Firewall--&gt;&gt;Client: DROP (no response)

    Note over Client,Knocker: User performs a knock to whitelist their IP
    Client-&gt;&gt;Knocker: POST /knock (X-Api-Key, optional ip_address, ttl)
    Knocker-&gt;&gt;Knocker: validate API key &amp; determine client IP
    Knocker-&gt;&gt;Firewall: add rich accept rule for client IP on port 22 with timeout
    Firewall--&gt;&gt;Knocker: success

    Note over Firewall,Client: New rule overrides DROP due to higher priority
    Client-&gt;&gt;Firewall: TCP SYN to Service:22
    Firewall-&gt;&gt;Service: forward packet
    Service--&gt;&gt;Client: TCP SYN-ACK (connection established)
    Knocker-&gt;&gt;Knocker: update whitelist.json with expiry
" dir="auto">
    <div dir="auto">
      <pre lang="mermaid" aria-label="Raw mermaid code">sequenceDiagram
    participant Client as User
    participant Firewall as Firewalld (knocker zone)
    participant Knocker
    participant Service as Protected Service (port 22)

    Note over Client,Firewall: Initial state — monitored port is blocked by default
    Client-&gt;&gt;Firewall: TCP SYN to Service:22
    Firewall--&gt;&gt;Client: DROP (no response)

    Note over Client,Knocker: User performs a knock to whitelist their IP
    Client-&gt;&gt;Knocker: POST /knock (X-Api-Key, optional ip_address, ttl)
    Knocker-&gt;&gt;Knocker: validate API key &amp; determine client IP
    Knocker-&gt;&gt;Firewall: add rich accept rule for client IP on port 22 with timeout
    Firewall--&gt;&gt;Knocker: success

    Note over Firewall,Client: New rule overrides DROP due to higher priority
    Client-&gt;&gt;Firewall: TCP SYN to Service:22
    Firewall-&gt;&gt;Service: forward packet
    Service--&gt;&gt;Client: TCP SYN-ACK (connection established)
    Knocker-&gt;&gt;Knocker: update whitelist.json with expiry
</pre>
    </div>
  </div>
  <span role="presentation">
    <span data-view-component="true">
  <svg style="box-sizing: content-box; color: var(--color-icon-primary);" width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true" data-view-component="true">
    <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-opacity="0.25" stroke-width="2" vector-effect="non-scaling-stroke" fill="none"></circle>
    <path d="M15 8a7.002 7.002 0 00-7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" vector-effect="non-scaling-stroke"></path>
</svg>    <span>Loading</span>
</span>
  </span>
</section>

<p dir="auto">Knocker requires FirewallD 2.0+ due to dependency on the zone priority feature.
It&#39;s available in Debian 13, Ubuntu 24.04 LTS and other recent stable distros.</p>

<p dir="auto">FirewallD was chosen for the ability to separates the cli interface from the daemon. This allows Knocker to control firewalld from within a Docker container by mounting the system&#39;s D-Bus socket, and FirewallD also has support for timed rules, so knocker rules automatically expire by the end of the TTL.</p>
<p dir="auto"><strong>FIREWALLD WILL NOT WORK WITH DOCKER PUBLISHED PORTS</strong>, check <a href="https://github.com/FarisZR/knocker/issues/17" data-hovercard-type="issue" data-hovercard-url="/FarisZR/knocker/issues/17/hovercard">this issue</a> for more details</p>

<ol dir="auto">
<li><strong>Creates a dedicated firewalld zone</strong> with high priority</li>
<li><strong>Adds DROP/REJECT rules</strong> for monitored ports to block unauthorized access</li>
<li><strong>Dynamically adds ALLOW rules</strong> for whitelisted IPs that override the blocking rules</li>
<li><strong>Automatically expires rules</strong> based on TTL using firewalld&#39;s timeout mechanism</li>
<li><strong>Recovers rules on startup</strong> by comparing whitelist.json with active firewalld rules</li>
</ol>
<div dir="auto"><h3 tabindex="-1" dir="auto">Enabling FirewallD Integration</h3><a id="user-content-enabling-firewalld-integration" aria-label="Permalink: Enabling FirewallD Integration" href="#enabling-firewalld-integration"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ol dir="auto">
<li>
<p dir="auto"><strong>Prerequisites</strong>:</p>
<ul dir="auto">
<li>FirewallD 2.0+ installed and running on the host system</li>
<li>Docker container must run as root for D-Bus access</li>
</ul>
</li>
<li>
<p dir="auto"><strong>Configuration</strong></p>
</li>
</ol>
<ul dir="auto">
<li>enable FirewallD in the knocker.yaml config, settings are already available in the <a href="https://github.com/FarisZR/knocker/blob/main/knocker.example.yaml">example config</a></li>
<li>Mount the Dbus socket into the docker container, and make sure it runs as root, the required entires are commented out in the <a href="https://github.com/FarisZR/knocker/blob/main/docker-compose.yml">docker-compose.yml</a> file.</li>
</ul>
<div dir="auto"><h3 tabindex="-1" dir="auto">Testing and Troubleshooting</h3><a id="user-content-testing-and-troubleshooting" aria-label="Permalink: Testing and Troubleshooting" href="#testing-and-troubleshooting"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Monitor active rules:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# Check knocker zone
firewall-cmd --zone=knocker --list-all

# View rich rules
firewall-cmd --zone=knocker --list-rich-rules

# Monitor rule changes
journalctl -u firewalld -f"><pre><span><span>#</span> Check knocker zone</span>
firewall-cmd --zone=knocker --list-all

<span><span>#</span> View rich rules</span>
firewall-cmd --zone=knocker --list-rich-rules

<span><span>#</span> Monitor rule changes</span>
journalctl -u firewalld -f</pre></div>
<p dir="auto">For detailed configuration, architecture, and troubleshooting information, see the complete <a href="https://github.com/FarisZR/knocker/blob/main/docs/FIREWALLD_INTEGRATION.md">FirewallD Integration Guide</a>.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Userland-proxy related issues</h2><a id="user-content-userland-proxy-related-issues" aria-label="Permalink: Userland-proxy related issues" href="#userland-proxy-related-issues"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If you are enabling knocking for IPs behind tailscale or other IPs, you may face issues due to how userland-proxy works, you may get different request IP from the actual ip address.</p>
<p dir="auto">Disabling Userland-proxy should fix it, but make sure to test your setup.
You could also use host networking.</p>


<p dir="auto">This endpoint validates an API key and whitelists an IP.</p>
<ul dir="auto">
<li>
<p dir="auto"><strong>Headers</strong>:</p>
<ul dir="auto">
<li><code>X-Api-Key</code>: Your secret API key.</li>
</ul>
</li>
<li>
<p dir="auto"><strong>Body (Optional)</strong>:</p>
<ul dir="auto">
<li>To whitelist a remote IP/CIDR (requires <code>allow_remote_whitelist: true</code>):
<div dir="auto" data-snippet-clipboard-copy-content="{&#34;ip_address&#34;: &#34;YOUR_TARGET_IP_OR_CIDR&#34;}"><pre>{<span>&#34;ip_address&#34;</span>: <span><span>&#34;</span>YOUR_TARGET_IP_OR_CIDR<span>&#34;</span></span>}</pre></div>
</li>
</ul>
</li>
<li>
<p dir="auto"><strong>Example (Whitelisting your own IP)</strong>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="curl -i -H &#34;X-Api-Key: YOUR_SECRET_KEY&#34; https://knock.your-domain.com/knock"><pre>curl -i -H <span><span>&#34;</span>X-Api-Key: YOUR_SECRET_KEY<span>&#34;</span></span> https://knock.your-domain.com/knock</pre></div>
</li>
<li>
<p dir="auto"><strong>Success Response (<code>200 OK</code>)</strong>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="{
  &#34;whitelisted_entry&#34;: &#34;1.2.3.4&#34;,
  &#34;expires_at&#34;: 1672534800,
  &#34;expires_in_seconds&#34;: 3600
}"><pre>{
  <span>&#34;whitelisted_entry&#34;</span>: <span><span>&#34;</span>1.2.3.4<span>&#34;</span></span>,
  <span>&#34;expires_at&#34;</span>: <span>1672534800</span>,
  <span>&#34;expires_in_seconds&#34;</span>: <span>3600</span>
}</pre></div>
</li>
</ul>

<p dir="auto">This endpoint is used by Caddy&#39;s <code>forward_auth</code> to check if the client&#39;s IP is whitelisted. It returns <code>200 OK</code> on success and <code>401 Unauthorized</code> on failure.</p>

<p dir="auto">The project includes a full test suite</p>

<p dir="auto">To run the tests locally:</p>
<ol dir="auto">
<li>
<p dir="auto"><strong>Install Dependencies</strong>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="pip install -r src/requirements.txt"><pre>pip install -r src/requirements.txt</pre></div>
</li>
<li>
<p dir="auto"><strong>Run Pytest</strong>:</p>

</li>
</ol>

<p dir="auto">There&#39;s a dev environment under <a href="https://github.com/FarisZR/knocker/blob/main/dev">dev</a>, with bash scripts for integrations tests with caddy and a separate one with firewalld.
The CI runs the caddy tests, but firewalld needs a privileged runner, which is why it needs to be run locally and isn&#39;t a part of the CI.</p>

<p dir="auto">Interactive documentation endpoints (<code>/docs</code>, <code>/redoc</code>, <code>/openapi.json</code>) are disabled by default. To expose them, set the following in <code>knocker.yaml</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="documentation:
  enabled: true
  openapi_output_path: &#34;openapi.json&#34;"><pre><span>documentation</span>:
  <span>enabled</span>: <span>true</span>
  <span>openapi_output_path</span>: <span><span>&#34;</span>openapi.json<span>&#34;</span></span></pre></div>
<p dir="auto">When documentation is disabled (default), Knocker removes these endpoints and deletes any previously generated schema file to prevent stale artifacts.</p>
<p dir="auto">For a formal API specification and a summary of the architectural choices, please see the <a href="https://github.com/FarisZR/knocker/blob/main/docs">documentation</a>.</p>

<p dir="auto">Knocker was fully vibe coded.
The initial implementation was done with Gemini 2.5 pro, thanks to the tokens provided in the roo code/requesty hackathon.</p>
<p dir="auto">Further features were mostly done with the GitHub copilot Agent (sonnet 4/later 4.5), which needed a lot of fixes, done mostly by GPT-5 mini/CODEX.</p>
<p dir="auto">If you&#39;re Anti-AI please don&#39;t use this.</p>
</article></div></div>
  </body>
</html>
