<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://docs.trueelena.org/self_hosting/modern_xmpp_server/index.html">Original</a>
    <h1>Modern XMPP Server</h1>
    
    <div id="readability-page-1" class="page"><div>
      <div>
        <div>
          

          <div role="main">
            
  <section id="modern-xmpp-server">

<p>This is what I did to configure my XMPP server, using only <a href="https://www.debian.org/security/">packages
supported in Debian</a> and 100%
compliant with the <a href="https://compliance.conversations.im">tests for XEP-0459: XMPP Compliance Suites 2022 on
conversations’ website</a>.</p>
<p>This guide was originally written for prosody 0.9 under Debian jessie,
but is being kept up to date as I upgrade my server to new Debian
releases.</p>
<nav id="contents">
<p>Contents</p>
<ul>
<li><p><a href="#modern-xmpp-server" id="id1">Modern XMPP Server</a></p>
<ul>
<li><p><a href="#how" id="id2">How</a></p>
<ul>
<li><p><a href="#installation-and-prerequisites" id="id3">Installation and prerequisites</a></p></li>
<li><p><a href="#prosody-configuration" id="id4">prosody configuration</a></p></li>
<li><p><a href="#disabling-in-band-registration" id="id5">disabling in-band registration</a></p></li>
<li><p><a href="#turn-stun" id="id6">TURN/STUN</a></p></li>
<li><p><a href="#virtualhosts" id="id7">virtualhosts</a></p></li>
<li><p><a href="#additional-modules" id="id8">additional modules</a></p></li>
<li><p><a href="#proxied-file-transfers" id="id9">Proxied file transfers</a></p></li>
</ul>
</li>
<li><p><a href="#see-also" id="id10">See also</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="how">
<h2><a href="#id2" role="doc-backlink">How</a><a href="#how" title="Permalink to this heading">¶</a></h2>
<p>I’ve decided to install <a href="https://prosody.im/">prosody</a>, mostly because it was recommended by
the <a href="http://rtcquickstart.org/">RTC QuickStart Guide</a>; I’ve heard that similar results can be
reached with <a href="https://www.ejabberd.im/">ejabberd</a> and other servers.</p>
<p>I’m also targetting <a href="https://www.debian.org">Debian</a> stable (+ <a href="https://backports.debian.org/">backports</a>); currently that’s
bookworm and prosody 0.12.</p>
<section id="installation-and-prerequisites">
<h3><a href="#id3" role="doc-backlink">Installation and prerequisites</a><a href="#installation-and-prerequisites" title="Permalink to this heading">¶</a></h3>
<p>You will need to install the packages <code><span>prosody</span></code>, <code><span>prosody-modules</span></code>,
and <code><span>coturn</span></code>.</p>
<p>You also need to setup some TLS certificates (I used <a href="https://letsencrypt.org/">Let’s Encrypt</a>);
and make them readable by the <code><span>prosody</span></code> user; you can see <a href="http://rtcquickstart.org/guide/multi/xmpp-server-prosody.html">Chapter 12
of the RTC QuickStart Guide</a> for
more details.</p>
<p>With prosody 0.10+ you will also need to configure the location of the
certificate for https with a configuration stanza such as:</p>
<div><div><pre><span></span><span>https_ssl</span> <span>=</span> <span>{</span>
    <span>certificate</span> <span>=</span> <span>&#34;/etc/ssl/public/example.org.pem&#34;</span><span>;</span>
    <span>key</span> <span>=</span> <span>&#34;/etc/ssl/private/example.org-key.pem&#34;</span><span>;</span>
<span>}</span>
<span>legacy_ssl_ssl</span> <span>=</span> <span>{</span>
    <span>certificate</span> <span>=</span> <span>&#34;/etc/ssl/public/example.org.pem&#34;</span><span>;</span>
    <span>key</span> <span>=</span> <span>&#34;/etc/ssl/private/example.org-key.pem&#34;</span><span>;</span>
<span>}</span>
</pre></div>
</div>
<p>or see the <a href="https://prosody.im/doc/certificates">prosody documentation on certificates</a> to see where to put certificates
so that prosody is able to autodetect them.</p>
<p>On your firewall, you’ll need to open the following TCP ports:</p>
<ul>
<li><p>5222 (client2server)</p></li>
<li><p>5223 (client2server, https)</p></li>
<li><p>5269 (server2server)</p></li>
<li><p>5280 (default http port for prosody)</p></li>
<li><p>5281 (default https port for prosody)</p></li>
<li><p>3478 (coturn)</p></li>
</ul>
<p>As well as the following port for UDP</p>
<ul>
<li><p>3478 (coturn)</p></li>
</ul>
<p>The http ports are needed to enable some services provided via http(s),
including rich media transfers.</p>
<p>With just a handful of users, I didn’t bother to configure LDAP or
anything else, but just created users manually via:</p>
<div><div><pre><span></span><span>prosodyctl</span> <span>adduser</span> <span>alice</span><span>@example</span><span>.</span><span>org</span>
</pre></div>
</div>
</section>
<section id="prosody-configuration">
<h3><a href="#id4" role="doc-backlink">prosody configuration</a><a href="#prosody-configuration" title="Permalink to this heading">¶</a></h3>
<p>You can then start configuring prosody by editing
<code><span>/etc/prosody/prosody.cfg.lua</span></code> and changing a few values from the
distribution defaults.</p>
<p>First of all, enforce the use of certificate checking for server2server
communications with:</p>

<p>and then, if you need to, add to the whitelist any server that you want
to talk to and doesn’t support secure s2s communication (but note that
gmail.com is no longer needed nor useful, as it doesn’t support xmpp any
longer):</p>
<div><div><pre><span></span><span>s2s_insecure_domains</span> <span>=</span> <span>{</span> <span>&#34;gmail.com&#34;</span> <span>}</span>
</pre></div>
</div>
<p>Also add at least an user (that you have already created with <code><span>prosodyctl</span>
<span>adduser</span></code> as described above) as an admin:</p>
<div><div><pre><span></span><span>admins</span> <span>=</span> <span>{</span> <span>&#34;alice@example.org&#34;</span> <span>}</span>
</pre></div>
</div>
</section>
<section id="disabling-in-band-registration">
<h3><a href="#id5" role="doc-backlink">disabling in-band registration</a><a href="#disabling-in-band-registration" title="Permalink to this heading">¶</a></h3>
<p><code><span>mod_register</span></code> is now enabled by default to provide password changing
services, but unless you have the resources to moderate new users you
probably want to disable registration to prevent the server from being
used to send <a href="https://en.wikipedia.org/wiki/Messaging_spam">spim</a>; to do so add the line:</p>
<div><div><pre><span></span><span>allow_registration</span> <span>=</span> <span>false</span>
</pre></div>
</div>
</section>
<section id="turn-stun">
<h3><a href="#id6" role="doc-backlink">TURN/STUN</a><a href="#turn-stun" title="Permalink to this heading">¶</a></h3>
<p>Support for video calls requires an external STUN / TURN server such as
<a href="https://github.com/coturn/coturn/">coturn</a>, which can be installed on the same machine; its configuration
require setting a realm and a secret for auth in
<code><span>/etc/turnserver.conf</span></code>:</p>
<div><div><pre><span></span><span>realm</span><span>=</span><span>turn</span><span>.</span><span>chat</span><span>.</span><span>example</span><span>.</span><span>org</span>
<span>use</span><span>-</span><span>auth</span><span>-</span><span>secret</span>
<span>static</span><span>-</span><span>auth</span><span>-</span><span>secret</span><span>=&lt;</span><span>a</span> <span>long</span> <span>random</span> <span>string</span><span>&gt;</span>
</pre></div>
</div>
<p>And then you will have to set the same values in
<code><span>/etc/prosody/prosody.cfg.lua</span></code>:</p>
<div><div><pre><span></span><span>turncredentials_host</span> <span>=</span> <span>&#39;turn.chat.example.org&#39;</span>
<span>turncredentials_secret</span> <span>=</span> <span>&#39;&lt;the same long string as above&gt;&#39;</span>
</pre></div>
</div>
</section>
<section id="virtualhosts">
<h3><a href="#id7" role="doc-backlink">virtualhosts</a><a href="#virtualhosts" title="Permalink to this heading">¶</a></h3>
<p>For each virtualhost you want to configure, create a file
<code><span>/etc/prosody/conf.avail/chat.example.org.cfg.lua</span></code> with contents like
the following:</p>
<div><div><pre><span></span><span>VirtualHost</span> <span>&#34;chat.example.org&#34;</span>
        <span>enabled</span> <span>=</span> <span>true</span>
        <span>ssl</span> <span>=</span> <span>{</span>
            <span>key</span> <span>=</span> <span>&#34;/etc/ssl/private/example.org-key.pem&#34;</span><span>;</span>
            <span>certificate</span> <span>=</span> <span>&#34;/etc/ssl/public/example.org.pem&#34;</span><span>;</span>
        <span>}</span>
</pre></div>
</div>
<p>For the domains where you also want to enable MUCs, add the follwing
lines:</p>
<div><div><pre><span></span><span>Component</span> <span>&#34;conference.chat.example.org&#34;</span> <span>&#34;muc&#34;</span>
        <span>restrict_room_creation</span> <span>=</span> <span>&#34;local&#34;</span>
        <span>modules_enabled</span> <span>=</span> <span>{</span>
            <span>&#34;mam_muc&#34;</span><span>,</span>
            <span>&#34;vcard_muc&#34;</span><span>,</span>
        <span>}</span>
</pre></div>
</div>
<p>the <code><span>&#34;local&#34;</span></code> configures prosody so that only local users are allowed
to create new rooms (but then everybody can join them, if the room
administrator allows it): this may help reduce unwanted usages of your
server by random people.</p>
<p>Enabling the <code><span>mam_muc</span></code> module (on prosody 0.10 only) allows people to
syncronize message history between multiple clients (XEP-0313)</p>
<p>You can also add the following line to enable rich media transfers via
http uploads (<a href="https://xmpp.org/extensions/xep-0363.html">XEP-0363</a>):</p>
<div><div><pre><span></span><span>Component</span> <span>&#34;upload.chat.example.org&#34;</span> <span>&#34;http_upload&#34;</span>
</pre></div>
</div>
<p>The defaults are pretty sane, but see
<a href="https://modules.prosody.im/mod_http_upload.html">https://modules.prosody.im/mod_http_upload.html</a> for details on what
knobs you can configure for this module; you may want e.g. to change the
maximum file size limit and setup an expiry date:</p>
<div><div><pre><span></span><span>Component</span> <span>&#34;upload.chat.example.org&#34;</span> <span>&#34;http_upload&#34;</span>
    <span>http_upload_file_size_limit</span> <span>=</span> <span>1024</span> <span>*</span> <span>1024</span> <span>*</span> <span>2</span>
    <span>http_upload_expire_after</span> <span>=</span> <span>60</span> <span>*</span> <span>60</span> <span>*</span> <span>24</span> <span>*</span> <span>7</span>
</pre></div>
</div>
<p>Don’t forget to enable the virtualhost by linking the file inside
<code><span>/etc/prosody/conf.d/</span></code>.</p>
</section>
<section id="additional-modules">
<h3><a href="#id8" role="doc-backlink">additional modules</a><a href="#additional-modules" title="Permalink to this heading">¶</a></h3>
<p>Most of the other interesting XEPs are enabled by loading additional
modules inside <code><span>/etc/prosody/prosody.cfg.lua</span></code> (under
<code><span>modules_enabled</span></code>); to enable <code><span>mod_something</span></code> just add a line like:</p>

<p>Most of these come from the <code><span>prosody-modules</span></code> package (and thus from
<a href="https://modules.prosody.im/">https://modules.prosody.im/</a> ).</p>
<dl>
<dt><code><span>mod_mam</span></code> (XEP-0313)</dt><dd><p>Archive messages on the server for a limited period of time (default
1 week) and allow clients to retrieve them; this is required to
syncronize message history between multiple clients.</p>
<p>With prosody 0.9 only an in-memory storage backend is available,
which may make this module problematic on servers with many users.
prosody 0.10 will fix this by adding support for an SQL backed
storage with archiving capabilities.</p>
</dd>
<dt><code><span>mod_throttle_presence</span></code> + <code><span>mod_filter_chatstates</span></code> (XEP-0352)</dt><dd><p>Filter out presence updates and chat states when the client announces
(via Client State Indication) that the user isn’t looking.
This is useful to reduce power and bandwidth usage for “useless”
traffic.</p>
</dd>
<dt><code><span>cloud_notify</span></code> (XEP-0357)</dt><dd><p>Allow clients to register an “app server” that is notified about new
messages</p>
</dd>
</dl>
</section>
<section id="proxied-file-transfers">
<h3><a href="#id9" role="doc-backlink">Proxied file transfers</a><a href="#proxied-file-transfers" title="Permalink to this heading">¶</a></h3>
<p>To enable proxied file transfers for clients behind NAT or firewalls,
you need to add <code><span>&#34;proxy65&#34;;</span></code> to the list of additional modules, and
then enable it in at least one virtual host with the lines:</p>
<div><div><pre><span></span><span>Component</span> <span>&#34;proxy.chat.trueelena.org&#34;</span> <span>&#34;proxy65&#34;</span>
        <span>proxy65_address</span> <span>=</span> <span>&#34;proxy.chat.trueelena.org&#34;</span>
</pre></div>
</div>
</section>
</section>
<section id="see-also">
<h2><a href="#id10" role="doc-backlink">See also</a><a href="#see-also" title="Permalink to this heading">¶</a></h2>
<ul>
<li><p><a href="https://gultsch.de/xmpp_2016.html">The State of Mobile XMPP in 2016</a>
(blog post by the maintainer of Conversations)</p></li>
<li><p><a href="https://wiki.debian.org/FreedomBox/Configs/Prosody">Prosody installation instructions in the FreedomBox wiki</a>
(for basic prosody configuration)</p></li>
<li><p><a href="https://serverfault.com/questions/835635/what-prosody-modules-do-i-need-to-support-conversations/835636">What Prosody modules do I need to support Conversations?</a>
(on Server Fault)</p></li>
<li><p><a href="https://www.trueelena.org/computers/howto/modern_xmpp_server.html">This HOWTO on my old website</a></p></li>
<li><p><a href="http://www.enricozini.org/blog/2017/debian/modern-and-secure-instant-messaging/">Enrico’s post on how we configured the server before compliance.conversations.im was a thing</a></p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
      
      
    </div></div>
  </body>
</html>
