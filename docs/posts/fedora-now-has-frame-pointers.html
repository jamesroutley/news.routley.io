<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://rwmj.wordpress.com/2023/02/02/fedora-now-has-frame-pointers/">Original</a>
    <h1>Fedora now has frame pointers</h1>
    
    <div id="readability-page-1" class="page"><div id="post-8156">
	<p>

		February 2, 2023 · 7:33 pm	</p><!-- .entry-meta -->

		
	
	<div>
		
<p>Fedora now has frame pointers.  I don’t want to dwell on the how of this, it was a somewhat controversial decision and <a href="https://lwn.net/Articles/919940/">you can read all about it here</a>.  But I do want to say a bit about the why, and how it makes performance analysis so much easier.</p>



<p>Recently we’ve been looking at a <a href="https://listman.redhat.com/archives/libguestfs/2023-February/030581.html">performance problem in qemu</a>. To try to understand this I’ve been looking at <a href="https://github.com/brendangregg/FlameGraph">FlameGraphs</a> all day, like this one:</p>



<figure><img data-attachment-id="8160" data-permalink="https://rwmj.wordpress.com/2023/02/02/fedora-now-has-frame-pointers/flamegraph1/" data-orig-file="https://rwmj.files.wordpress.com/2023/02/flamegraph1.png" data-orig-size="800,799" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="flamegraph1" data-image-description="" data-image-caption="" data-medium-file="https://rwmj.files.wordpress.com/2023/02/flamegraph1.png?w=450" data-large-file="https://rwmj.files.wordpress.com/2023/02/flamegraph1.png?w=500" src="https://rwmj.files.wordpress.com/2023/02/flamegraph1.png?w=800" alt="" srcset="https://rwmj.files.wordpress.com/2023/02/flamegraph1.png 800w, https://rwmj.files.wordpress.com/2023/02/flamegraph1.png?w=150 150w, https://rwmj.files.wordpress.com/2023/02/flamegraph1.png?w=450 450w, https://rwmj.files.wordpress.com/2023/02/flamegraph1.png?w=768 768w" sizes="(max-width: 800px) 100vw, 800px"/></figure>



<p>FlameGraphs rely on the Linux tool <a href="https://perf.wiki.kernel.org/index.php/Main_Page">perf</a> being able to collect stack traces.  The stack traces start in the kernel and go up through userspace often for dozens or even hundreds of frames.  They must be collected quickly (my 1 minute long trace has nearly half a million samples) and accurately.</p>



<p>Perf (or actually I think it’s some component of the kernel) has various methods to unwind the stack.  It can use <a href="https://en.wikipedia.org/wiki/Call_stack#Stack_and_frame_pointers">frame pointers</a>, <a href="https://www.kernel.org/doc/html/latest/x86/orc-unwinder.html">kernel ORC information</a> or DWARF debug information.  The thing is that DWARF unwinding (the only userspace option that doesn’t use frame pointers) is really unreliable.  In fact it has such serious problems that it’s not that usable at all.</p>



<p>For example, here is a broken stack trace from Fedora 37 (with full debuginfo installed):</p>



<figure><img data-attachment-id="8163" data-permalink="https://rwmj.wordpress.com/2023/02/02/fedora-now-has-frame-pointers/flamegraph-bad11/" data-orig-file="https://rwmj.files.wordpress.com/2023/02/flamegraph-bad11.png" data-orig-size="358,159" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="flamegraph-bad11" data-image-description="" data-image-caption="" data-medium-file="https://rwmj.files.wordpress.com/2023/02/flamegraph-bad11.png?w=358" data-large-file="https://rwmj.files.wordpress.com/2023/02/flamegraph-bad11.png?w=358" src="https://rwmj.files.wordpress.com/2023/02/flamegraph-bad11.png?w=358" alt="" srcset="https://rwmj.files.wordpress.com/2023/02/flamegraph-bad11.png 358w, https://rwmj.files.wordpress.com/2023/02/flamegraph-bad11.png?w=150 150w" sizes="(max-width: 358px) 100vw, 358px"/></figure>



<p>Notice that we go from the qemu-img program, through an “[unknown]” frame, into zlib’s inflate.</p>



<p>In the same trace we get completely detached frames too (which are wrong):</p>



<figure><img data-attachment-id="8165" data-permalink="https://rwmj.wordpress.com/2023/02/02/fedora-now-has-frame-pointers/flamegraph-bad12/" data-orig-file="https://rwmj.files.wordpress.com/2023/02/flamegraph-bad12.png" data-orig-size="180,129" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="flamegraph-bad12" data-image-description="" data-image-caption="" data-medium-file="https://rwmj.files.wordpress.com/2023/02/flamegraph-bad12.png?w=180" data-large-file="https://rwmj.files.wordpress.com/2023/02/flamegraph-bad12.png?w=180" src="https://rwmj.files.wordpress.com/2023/02/flamegraph-bad12.png?w=180" alt="" srcset="https://rwmj.files.wordpress.com/2023/02/flamegraph-bad12.png 180w, https://rwmj.files.wordpress.com/2023/02/flamegraph-bad12.png?w=150 150w" sizes="(max-width: 180px) 100vw, 180px"/></figure>



<p>Upgrading zlib to F38 (with frame pointers) shows what this should look like:</p>



<figure><img data-attachment-id="8166" data-permalink="https://rwmj.wordpress.com/2023/02/02/fedora-now-has-frame-pointers/flamegraph-good1/" data-orig-file="https://rwmj.files.wordpress.com/2023/02/flamegraph-good1.png" data-orig-size="652,186" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="flamegraph-good1" data-image-description="" data-image-caption="" data-medium-file="https://rwmj.files.wordpress.com/2023/02/flamegraph-good1.png?w=450" data-large-file="https://rwmj.files.wordpress.com/2023/02/flamegraph-good1.png?w=500" src="https://rwmj.files.wordpress.com/2023/02/flamegraph-good1.png?w=652" alt="" srcset="https://rwmj.files.wordpress.com/2023/02/flamegraph-good1.png 652w, https://rwmj.files.wordpress.com/2023/02/flamegraph-good1.png?w=150 150w, https://rwmj.files.wordpress.com/2023/02/flamegraph-good1.png?w=450 450w" sizes="(max-width: 652px) 100vw, 652px"/></figure>



<p>Another common problem with lack of frame pointers can be seen in this trace from Fedora 37:</p>



<figure><img data-attachment-id="8169" data-permalink="https://rwmj.wordpress.com/2023/02/02/fedora-now-has-frame-pointers/flamegraph-bad2/" data-orig-file="https://rwmj.files.wordpress.com/2023/02/flamegraph-bad2.png" data-orig-size="1186,381" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="flamegraph-bad2" data-image-description="" data-image-caption="" data-medium-file="https://rwmj.files.wordpress.com/2023/02/flamegraph-bad2.png?w=450" data-large-file="https://rwmj.files.wordpress.com/2023/02/flamegraph-bad2.png?w=500" src="https://rwmj.files.wordpress.com/2023/02/flamegraph-bad2.png?w=1024" alt="" srcset="https://rwmj.files.wordpress.com/2023/02/flamegraph-bad2.png?w=1024 1024w, https://rwmj.files.wordpress.com/2023/02/flamegraph-bad2.png?w=150 150w, https://rwmj.files.wordpress.com/2023/02/flamegraph-bad2.png?w=450 450w, https://rwmj.files.wordpress.com/2023/02/flamegraph-bad2.png?w=768 768w, https://rwmj.files.wordpress.com/2023/02/flamegraph-bad2.png 1186w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>It looks like it might be OK, until you compare it to the same workload using Fedora 38 libraries:</p>



<figure><img data-attachment-id="8171" data-permalink="https://rwmj.wordpress.com/2023/02/02/fedora-now-has-frame-pointers/flamegraph-good2/" data-orig-file="https://rwmj.files.wordpress.com/2023/02/flamegraph-good2.png" data-orig-size="1189,651" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="flamegraph-good2" data-image-description="" data-image-caption="" data-medium-file="https://rwmj.files.wordpress.com/2023/02/flamegraph-good2.png?w=450" data-large-file="https://rwmj.files.wordpress.com/2023/02/flamegraph-good2.png?w=500" src="https://rwmj.files.wordpress.com/2023/02/flamegraph-good2.png?w=1024" alt="" srcset="https://rwmj.files.wordpress.com/2023/02/flamegraph-good2.png?w=1024 1024w, https://rwmj.files.wordpress.com/2023/02/flamegraph-good2.png?w=150 150w, https://rwmj.files.wordpress.com/2023/02/flamegraph-good2.png?w=450 450w, https://rwmj.files.wordpress.com/2023/02/flamegraph-good2.png?w=768 768w, https://rwmj.files.wordpress.com/2023/02/flamegraph-good2.png 1189w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>Look at those <a href="https://en.wikipedia.org/wiki/Monument_Valley">beautiful towering peaks</a>!  What seems to be happening (I don’t know why) is that stack traces start in the wrong place when you don’t have frame pointers (note that FlameGraphs show stack traces upside down, with the starting point in the kernel shown at the top).  Also if you look closely you’ll notice missed frames in the first one, like the “direct” call to __libc_action which actually goes through an intermediate frame.</p>



<p>Before Fedora 38 the only way to get good stack traces was to recompile your software and all of its dependencies with frame pointers, a massive pain in the neck and a major barrier to entry when investigating performance problems.</p>



<p>With Fedora 38, it’s simply a matter of using the regular libraries, installing debuginfo if you want (it does still add detail), and you can start using perf straight away by following <a href="https://www.brendangregg.com/flamegraphs.html">Brendan Gregg’s tutorials</a>.</p>
			
			
				</div><!-- .entry-content -->

	<!-- .entry-links -->

</div></div>
  </body>
</html>
