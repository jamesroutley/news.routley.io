<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://onionservices.torproject.org/research/proposals/usability/certificates/">Original</a>
    <h1>Certificates for Onion Services</h1>
    
    <div id="readability-page-1" class="page"><div data-md-component="container">
      
      
        
          
        
      
      <main data-md-component="main">
        <div>
          
            
              
              
            
            
              
              
            
          
          
            <div data-md-component="content">
              <article>
                
                  



<h2 id="about">About<a href="#about" title="Permanent link">¶</a></h2>
<p>This document tracks existing procedures or proposals for integrating and
validating TLS/HTTPS certificates for Onion Services.</p>
<p>While some depends on <a href="https://en.wikipedia.org/wiki/Certificate_authority">Certificate Authorities</a> (CA) model, others rely on
alternative certification and validation procedures that does not require
built-in certificate chains in the client software or reliance on financial
transactions.</p>
<h2 id="introduction">Introduction<a href="#introduction" title="Permanent link">¶</a></h2>
<p>Whenever you browse the internet regularly, the connection between your
computer and a service is usually encrypted, and the safety of this
communication happens through the verification of a special type of
certificate.</p>
<p>With <a href="https://onionservices.torproject.org/technology/">Onion Services</a>, the connection is peer-to-peer encrypted by default,
which means that no additional certificates are needed.</p>
<p>But as the web and other internet technologies mature, certificates are
starting to be a requirement in order to unleash functionalities, especially in
web browsers, such as the faster connection protocol <a href="https://en.wikipedia.org/wiki/HTTP/2">HTTP/2</a> and payment
processing.</p>
<p>That&#39;s why it&#39;s important to improve the certificate ecosystem to fully support
<a href="https://onionservices.torproject.org/technology/">Onion Services</a>.</p>
<p>This is a hard problem, and an ongoing effort, but there has been some
important work done to solve this.</p>
<p>The most relevant one should bring automation to the process of issuing
certificates for Onion Services, through an enhancement in a protocol called
<a href="https://en.wikipedia.org/wiki/Automatic_Certificate_Management_Environment">ACME</a>.</p>
<p>The <a href="#acme-for-onions">ACME for Onions</a> proposal is composed of tools and also
an <a href="https://datatracker.ietf.org/doc/draft-misell-acme-onion/">Internet Draft</a>, which hopefully will turn into an
Internet Standard soon.</p>
<p>We are also looking into other, non-conflicting alternatives that can also be
used for certification, so service operators can decide which one fits best their
use case.</p>
<p>Improving the certificate functionality will put Onion Services in parity
with the modern stack of web development.</p>
<h2 id="benefits">Benefits<a href="#benefits" title="Permanent link">¶</a></h2>
<p>It may be argued that Onion Services connections are already
<em>self-authenticated</em> -- since the public key and the URL are tied together and
the connection is peer-to-peer encrypted --, and thus making the need for HTTPS
pointless, or at most giving only an impression on users of additional security.</p>
<p>But having valid HTTPS connection in Onion Services could enable many other
enhancements, such as:</p>
<ol>
<li>
<p>Some browser features are available only with HTTPS, like <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts">Secure
   Contexts</a>, <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">Content Security Policy</a> (CSP), <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#security">Secure cookies</a>,
   <a href="https://w3c.github.io/webauthn/">WebAuthn</a>, <a href="https://webrtc.org/">WebRTC</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/API/PaymentRequest">PaymentRequest</a>.</p>
</li>
<li>
<p>A user may be using a browser that isn&#39;t the Tor browser.  For
   example on iOS there is only Safari, and in such cases the browser
   will not be aware of the different semantics of security for an onion
   site, and won&#39;t allow the use of secure browser features (such as
   secure cookies). This limits the kind of web apps people can develop
   on onionsites as many modern browser APIs mentioned above.</p>
</li>
<li>
<p>Allows for the usage of <a href="https://en.wikipedia.org/wiki/HTTP/2">HTTP/2</a>, since some browsers only support it if
   on HTTPS<sup id="fnref:http3-availability"><a href="#fn:http3-availability">1</a></sup>. In the future, HTTP2 and HTTP3 may only
   work with TLS, and thus valid certificates.</p>
</li>
<li>
<p><a href="https://lists.torproject.org/pipermail/tor-dev/2023-April/014833.html">It also opens up new opportunities such as payment processing</a>, <em>&#34;as current
   PCI DSS requirements do not allow non-standard TLS&#34;</em><sup id="fnref:pci-dss-tls"><a href="#fn:pci-dss-tls">2</a></sup> and may
   only work with certificates having some sort of validation<sup id="fnref:pci-dss-self-signed"><a href="#fn:pci-dss-self-signed">3</a></sup>.
   Payments card networks require HTTPS for a payment to be taken. So if
   someone wants to do that over an onion site they would need a TLS
   certificate.</p>
</li>
<li>
<p>It could be argued that this is also security-in-depth by having yet another
   layer of encryption atop of other existing encryption layers. Even if the
   theoretical gain in terms of interception and tampering resistance is not
   relevant, it would still allow for service operators to split their encryption
   keys in different servers -- like one with the Onion Service keys and a backend
   having the TLS keys, thus making a compromise in one of the servers exposing
   only the cryptographic material of one of the communication layers.</p>
</li>
<li>
<p>The Tor daemon that hosts the onion site might not be the final
   computer in the chain. In larger organizations, deployment concerns
   may result in plain HTTP traveling across their network from the Tor
   daemon to the final web server. Having HTTPs protects those hops in
   the chain. This is something that distributed setups may need. The same
   could be said for a web browser using Tor SOCKS proxy somewhere else on the
   network.</p>
</li>
<li>
<p>Non-web based applications, such as IMAP/POP/SMTP etc. can benefit
   from certificates being valid.</p>
</li>
<li>
<p>There is simply too much software that isn&#39;t aware of onionsites,
   and trying to force HTTP-over-Onion to be as secure as HTTPS-over-TCP
   creates a compatibility mess of things which do and don&#39;t know about
   the semantics.</p>
</li>
<li>
<p>There is value in exposing the existence of an onion site via <a href="https://certificate.transparency.dev/">CT
   Logs</a>. If someone navigates to the plain web version of a site, and is
   presented with a certificate containing a Subject Alternative Name (SAN) for
   both the plain web and the onion site that provides a strong cryptographic
   guarantee that they are the same site. Effectively this would replace the
   Onion-Location header with something more authenticated<sup id="fnref:non-ct-logs"><a href="#fn:non-ct-logs">4</a></sup>.</p>
</li>
</ol>
<p>The following discussion is not yet conclusive, and the problem space may be
hard to solve.</p>
<h2 id="overview">Overview<a href="#overview" title="Permanent link">¶</a></h2>
<table>
<thead>
<tr>
<th>Proposal</th>
<th>Certification</th>
<th>Validation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Existing CA validation</td>
<td>CA/B Baseline Requirements for .onion</td>
<td>CA chain</td>
<td>Implemented, fully supported</td>
</tr>
<tr>
<td>ACME for .onion</td>
<td>CA/B Baseline Requirements for .onion</td>
<td>CA chain</td>
<td>Standardized as <a href="https://www.rfc-editor.org/info/rfc9799">RFC 9799</a>, need adoption by CAs</td>
</tr>
<tr>
<td>Self-signed certificates</td>
<td>Self-signed certificate</td>
<td>None</td>
<td>Depends on per-application support</td>
</tr>
<tr>
<td>Self-signed X.509 from .onion</td>
<td>Signed by a &#34;CA&#34; derived from the .onion private key</td>
<td>Check if cert is issued by the .onion private key</td>
<td>Proof-of-concept, no browser integration</td>
</tr>
<tr>
<td>Same Origin Onion Certificates (SOOC)</td>
<td>Self-signed certs</td>
<td>Skip for .onion addresses when conditions match</td>
<td>Proposal (not yet submitted for specification)</td>
</tr>
<tr>
<td>DANE for .onion</td>
<td>Self-signed certs</td>
<td>DNSSEC</td>
<td>Concept, no proposal yet</td>
</tr>
<tr>
<td>Onion-only CAs</td>
<td>Checks SAN and an .onion signature in an extension</td>
<td>CA chain</td>
<td>Concept, no proposal yet</td>
</tr>
<tr>
<td>Self-auth certs via PKCS#11 module</td>
<td>Checks .onion <a href="http://ed25519.cr.yp.to">Ed25519</a> signature in the cert key</td>
<td>Module returns a custom CA chain</td>
<td>Design, prototype available</td>
</tr>
</tbody>
</table>
<h3 id="main-pros-and-cons">Main pros and cons<a href="#main-pros-and-cons" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Proposal</th>
<th>Pros</th>
<th>Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td>Existing CA validation</td>
<td>None (already implemented)</td>
<td>None (already implemented)</td>
</tr>
<tr>
<td>ACME for .onion</td>
<td>No need for client/lib implementation</td>
<td>Depends on a CA willing to implement</td>
</tr>
<tr>
<td>Self-signed X.509 for .onion</td>
<td>No CA-reliance for .onion, self-auth.</td>
<td>Very hard to maintain and standardize, currently <a href="http://ed25519.cr.yp.to">Ed25519</a> is unsupported by major browsers</td>
</tr>
<tr>
<td>Same Origin Onion Certificates (SOOC)</td>
<td>No CA-reliance for .onion</td>
<td>Very hard to maintain and standardize</td>
</tr>
<tr>
<td>DANE for .onion</td>
<td>No CA-reliance for any domain or .onion</td>
<td>Very hard to implement and maintain</td>
</tr>
<tr>
<td>Onion-only CAs</td>
<td>Simplify CA-reliance</td>
<td>Needs to convince existing CAs or trusted parties to maintain a whole CA organization and infrastructure</td>
</tr>
<tr>
<td>Self-auth certs via PKCS#11 module</td>
<td>PKCS#11 is well established, future proof, no CA-reliance</td>
<td>Each Operating System or application would need to configure it; built-in OpenSSL support still underway</td>
</tr>
</tbody>
</table>
<h3 id="main-implementation-characteristics">Main implementation characteristics<a href="#main-implementation-characteristics" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Proposal</th>
<th>Implementation level</th>
<th>Additional requirements</th>
</tr>
</thead>
<tbody>
<tr>
<td>Existing CA validation</td>
<td>Procedure happens at the CA side</td>
<td></td>
</tr>
<tr>
<td>ACME for .onion</td>
<td>Procedure happens at the CA side</td>
<td></td>
</tr>
<tr>
<td>Self-signed X.509 for .onion</td>
<td>Client or TLS library</td>
<td></td>
</tr>
<tr>
<td>Same Origin Onion Certificates (SOOC)</td>
<td>Client or TLS library</td>
<td></td>
</tr>
<tr>
<td>DANE for .onion</td>
<td>Client</td>
<td>Portable DNSSEC library</td>
</tr>
<tr>
<td>Onion-only CAs</td>
<td>Client or TLS (only needs CA installation)</td>
<td></td>
</tr>
<tr>
<td>Self-auth certs via PKCS#11 module</td>
<td>Library (<a href="https://en.wikipedia.org/wiki/PKCS_11">PKCS#11</a> module)</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="existing-ca-validation">Existing CA validation<a href="#existing-ca-validation" title="Permanent link">¶</a></h2>
<p>The <a href="https://cabforum.org">CA/Browser Forum</a>, a <a href="https://en.wikipedia.org/wiki/CA/Browser_Forum">consortium that produces guidelines for X.509
(TLS/HTTPS) certification</a>, created <a href="https://cabforum.org/2015/02/18/ballot-144-validation-rules-dot-onion-names/">validation rules for Onion Service v2
addresses</a> (in 2015), later <a href="https://cabforum.org/2020/02/20/ballot-sc27v3-version-3-onion-certificates/">extended for Onion Services v3</a> (in 2020),
standardizing the way <a href="https://en.wikipedia.org/wiki/Certificate_authority">Certificate Authorities</a> can issue certificates for
.onion addresses and supports wildcards<sup id="fnref:cab-historical"><a href="#fn:cab-historical">5</a></sup>.</p>
<p>Only a few commercial providers currently provide this service<sup id="fnref:existing-certifiers"><a href="#fn:existing-certifiers">6</a></sup>.</p>
<p>The Appendix B of the <a href="https://cabforum.org/working-groups/server/baseline-requirements/documents/CA-Browser-Forum-TLS-BR-2.0.7.pdf">CA/B Baseline Requirements</a> (current <a href="https://github.com/cabforum/servercert/blob/main/docs/BR.md">repository
version</a>) for the Issuance and Management of Publicly‐Trusted Certificates
(since Version 1.7.4, released in 2021) establishes two validation methods to ensure
that someone request the certificate really control a given .onion address:</p>
<ol>
<li>An &#34;Agreed‑Upon Change to Website&#34; (manually or via <a href="https://en.wikipedia.org/wiki/Automatic_Certificate_Management_Environment">ACME</a>), where the
   service operator must include some secret, such as at the
   <code>/.well-known/pki-validation</code> of the site.</li>
<li>TLS <a href="https://www.rfc-editor.org/rfc/rfc8737.html">using ALPN</a>.</li>
<li>Checking of a Certificate Signing Request (CSR) signed by the Onion Service
   private key and containing an specific cryptographic nonce (i.e, a shared
   secret to be used only once), like using the <a href="https://github.com/HARICA-official/onion-csr">onion-csr</a> tool.</li>
</ol>
<p>Note that both methods does not require that operators disclose the location of
the Onion Service, nor them need to have a regular site for the service using
DNS. Validation can either happen by accessing directly the Onion Service or
by using the service private key to sign a CSR.</p>
<p>But still commercial CAs (or financial institution) may still collect
identifiable information during the purchase of the certificates.</p>
<h2 id="acme-for-onion-ca-validated">ACME for .onion (CA-validated)<a href="#acme-for-onion-ca-validated" title="Permanent link">¶</a></h2>
<p>In general, getting certificates from CAs supporting the <a href="https://cabforum.org/working-groups/server/baseline-requirements/documents/CA-Browser-Forum-TLS-BR-2.0.7.pdf">CA/B Baseline
Requirements</a> for .onion addresses is still a manual, or in the best-case
scenario, semi-automated task.</p>
<p>The Automatic Certificate Management Environment (<a href="https://en.wikipedia.org/wiki/Automatic_Certificate_Management_Environment">ACME</a>) standard (<a href="https://www.rfc-editor.org/rfc/rfc8555">RFC
8555</a>) solves part of the automation problem, and with the arrival of
<a href="https://www.rfc-editor.org/info/rfc9799">RFC 9799</a> it also supports methods for validating Onion Services.</p>
<p>Having support for .onion address in the <a href="https://en.wikipedia.org/wiki/Automatic_Certificate_Management_Environment">ACME</a> standard is the first step
for projects like <a href="https://letsencrypt.org/">Let&#39;s Encrypt</a> to offer free certificates for Onion
Services, without financial transactions.</p>
<p>Existing proposals to bring <a href="https://en.wikipedia.org/wiki/Automatic_Certificate_Management_Environment">ACME</a> for Onion Services are discussed below.</p>
<h3 id="acme-for-onions">ACME for Onions<a href="#acme-for-onions" title="Permanent link">¶</a></h3>
<p>The &#34;Automated Certificate Management Environment (ACME) Extensions for
&#34;.onion&#34; Domain Names&#34; (<a href="https://datatracker.ietf.org/doc/draft-misell-acme-onion/">draft-misell-acme-onion</a>) is the second known
proposal to bring ACME for .onion addresses.</p>
<p>This is the proposal that lead to <a href="https://www.rfc-editor.org/info/rfc9799">RFC 9799</a>.</p>
<p>A detailed analysis on ACME for Onions is <a href="https://theleo.zone/appendixes/acme/">available in a special
appendix</a>.</p>
<p>References:</p>
<ul>
<li><a href="https://acmeforonions.org/">ACME for Onions</a></li>
<li><a href="https://github.com/AS207960/acme-onion">AS207960/acme-onion</a></li>
<li><a href="https://www.opentech.fund/internet-freedom-news/april-2023/#acme">Work funded by OTF</a></li>
</ul>
<h3 id="acme-onion-identifier-validation-extension">ACME Onion Identifier Validation Extension<a href="#acme-onion-identifier-validation-extension" title="Permanent link">¶</a></h3>
<p>The &#34;Automated Certificate Management Environment (ACME) Onion Identifier
Validation Extension&#34; internet draft (<a href="https://datatracker.ietf.org/doc/draft-suchan-acme-onion/">draft-suchan-acme-onion-00</a>)
was proposed on 2022-05 and is the first known proposal to bring ACME
for .onion addresses.</p>
<p>As of 2023-06-07, this internet draft is in the expired state, being now
supplanted by <a href="https://www.rfc-editor.org/info/rfc9799">RFC 9799</a>.</p>
<p>References:</p>
<ul>
<li><a href="https://mailarchive.ietf.org/arch/browse/acme/?q=draft-suchan-acme-onion-00.txt">Relevant mail threads</a></li>
<li><a href="https://github.com/orangepizza/acme-onion-doc">orangepizza/acme-onion-doc: docs about standardize handling onion address in acme context</a></li>
</ul>
<h2 id="self-signed-certificates">Self-signed certificates<a href="#self-signed-certificates" title="Permanent link">¶</a></h2>
<p>This proposal basically consists in allowing the use of self-signed
certificates with Onion Services:</p>
<ol>
<li>For web applications like the <a href="https://tb-manual.torproject.org">Tor Browser</a>, this would consist
   in <a href="https://gitlab.torproject.org/tpo/applications/tor-browser/-/issues/13410">disabling self-signed certificate warnings when visiting .onion
   sites</a>. As an alternative, there&#39;s also the <a href="https://gitlab.torproject.org/tpo/team/-/wikis/Meetings/2024/Lisbon/self-auth-certs-for-onion-services">Self-authenticating TLS
   Certificates for Onion Services using a PKCS#11 module</a> discussed
   below and relying on <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/pkcs11">PKCS#11 modules</a> or <a href="https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.2.1">Authority Information Access
   (AIA)</a> extensions, which could handle self-signed certificates matching
   the Onion Service address without the need to merge this logic directly in
   the applications, as it would remain decoupled in a PKCS#11 module, thus
   being easier to maintain.</li>
<li>For other applications -- like the <a href="https://gitlab.torproject.org/tpo/applications/vpn/">TorVPN</a> and third-party software --,
   this would probably require patches or documentation instructing users to
   accept non-CA signed certificates when accessing Onion Services, which is
   very hard to provide and to maintain for a wide ranging of tools.</li>
</ol>
<div>
<p>Supported key types</p>
<p>In this proposal, any key types supported by applications could be used.</p>
<p>In case of popular web browsers, the <a href="https://cabforum.org/working-groups/server/baseline-requirements/documents/CA-Browser-Forum-TLS-BR-2.0.7.pdf">CA/B Baseline Requirements</a>
must be taken into account, which as of 2024-09 only allows for
<a href="https://en.wikipedia.org/wiki/RSA_(cryptosystem)">RSA</a> or <a href="https://blog.cloudflare.com/ecdsa-the-digital-signature-algorithm-of-a-better-internet/">ECDSA</a> keys.</p>
<p>It could also be possible to use self-signed certs using <a href="http://ed25519.cr.yp.to">Ed25519</a>,
which is discussed below and currently not widely supported by
browsers.</p>
</div>
<p>This proposal <em>would not provide</em>:</p>
<ol>
<li><em>A self-authentication mechanism</em> (since the certificate is self-signed).
   This have a huge weight since an important piece of security provided
   by HTTPS is not just end-to-end encryption but also authentication.</li>
</ol>
<p>Supporting self-signed certificates with Onion Services has a huge gain,
but also introduces an authentication complexity. That&#39;s why proper UI
indicators and hints are needed:</p>
<ol>
<li>For the encryption state of the site (HTTP and various HTTPS situations).</li>
<li>For the authentication state of the site, telling how it was (not)
   authenticated.</li>
</ol>
<p>There are already sketches for <a href="https://theleo.zone/scenarios/certificates/">different scenarios</a> for how various user
interface hints and indicators could exist for <a href="https://tb-manual.torproject.org">Tor Browser</a> and other software
maintained by Tor, as well as existing certificate proposals that can change
the certificate landscape for Onion Services in the future, which could be
adopted by operators instead of relying on self-signed certs.</p>
<p>But all these enhancements would still limit the practical application domain
of this proposal, since it would be readily available only to a small set
of applications like <a href="https://tb-manual.torproject.org">Tor Browser</a>, except if by pursuing some standardization
such as the <a href="#same-origin-onion-certificates-sooc">SOOC</a> proposal below.</p>
<h2 id="self-signed-x509-from-onion-self-signed-by-the-onion-address">Self-signed X.509 from .onion (self-signed by the .onion address)<a href="#self-signed-x509-from-onion-self-signed-by-the-onion-address" title="Permanent link">¶</a></h2>
<p>Another option for having HTTPS in Onion Services that may be available in the
future is to use Onion Service key pair to self-validate an HTTPS certificate
using <a href="http://ed25519.cr.yp.to">Ed25519</a> directly:</p>
<ul>
<li>The <a href="https://gitlab.torproject.org/ahf/onion-x509">Onion x509</a> is an example in how a CA self-signed by an .onion could
  be constructed.</li>
<li>There&#39;s also a ticket requesting to <a href="https://gitlab.torproject.org/tpo/applications/tor-browser/-/issues/18696">add support for self-signed HTTPS onion
  sites derived from onion service&#39;s ed25519 key</a> in the <a href="https://tb-manual.torproject.org">Tor Browser</a>.</li>
</ul>
<p>For an overview of <a href="http://ed25519.cr.yp.to">Ed25519</a>, check <a href="https://blog.mozilla.org/warner/2011/11/29/ed25519-keys/">How do Ed5519 keys work?</a>. For details
about how Tor implements <a href="http://ed25519.cr.yp.to">Ed25519</a>, check <a href="https://gitlab.torproject.org/tpo/core/torspec/-/blob/main/proposals/220-ecc-id-keys.txt">prop220</a> (and <a href="https://spec.torproject.org/rend-spec-v3">rend-spec-v3</a>
for how it implements at the Onion Services level).</p>
<p>This proposal has the advantage to not rely on Certificate Authorities, but the
disadvantage that needs additional logic both server and client side to make it
work, since a CA would needed to be installed for every visited Onion Service
using this scheme.</p>
<h3 id="on-using-onion-keys-for-certification">On using .onion keys for certification<a href="#on-using-onion-keys-for-certification" title="Permanent link">¶</a></h3>
<p>It&#39;s important to note that the current (as of 2024-09) Onion Services v3
specification does not allow the Master Onion Service identity key to be used
for purposes other than generating blinded signing keys (see Section 1.9 from
the <a href="https://spec.torproject.org/rend-spec-v3">rend-spec-v3</a>):</p>
<blockquote>
<p>Master (hidden service) identity key -- A master signing key pair
  used as the identity for a hidden service.  This key is long
  term and not used on its own to sign anything; it is only used
  to generate blinded signing keys as described in [KEYBLIND]
  and [SUBCRED]. The public key is encoded in the &#34;.onion&#34;
  address according to [NAMING].
  KP_hs_id, KS_hs_id.</p>
</blockquote>
<h3 id="on-ed25519-certificates-support-in-browsers">On Ed25519 certificates support in browsers<a href="#on-ed25519-certificates-support-in-browsers" title="Permanent link">¶</a></h3>
<p>Also, while <a href="https://ianix.com/pub/ed25519-deployment.html#ed25519-tls">many TLS libraries support the Ed25519 signing scheme</a> used for
certificates (like in <a href="https://blog.pinterjann.is/ed25519-certificates.html">OpenSSL since version 1.1.1</a>), <a href="https://security.stackexchange.com/questions/236931/whats-the-deal-with-x25519-support-in-chrome-firefox">major web browsers
still does not support</a> it (as of 2022-12)<sup id="fnref:X25519-vs-Ed25519"><a href="#fn:X25519-vs-Ed25519">7</a></sup>, probably because
they&#39;re not supported<sup id="fnref:Ed25519-CA-support"><a href="#fn:Ed25519-CA-support">8</a></sup> by the current (as of 2024-09) <a href="https://cabforum.org/working-groups/server/baseline-requirements/documents/CA-Browser-Forum-TLS-BR-2.0.7.pdf">CA/B
Baseline Requirements</a>:</p>
<blockquote>
<p>6.1.1.3 Subscriber Key Pair Generation</p>
<p>The CA SHALL reject a certificate request if one or more of the following
conditions are met:</p>
<ol>
<li>The Key Pair does not meet the requirements set forth in Section 6.1.5
   and/or Section 6.1.6;</li>
</ol>
<p>[...]</p>
<p>6.1.5 Key sizes</p>
<p>For RSA key pairs the CA SHALL:</p>
<p>• Ensure that the modulus size, when encoded, is at least 2048 bits, and;
• Ensure that the modulus size, in bits, is evenly divisible by 8.</p>
<p>For ECDSA key pairs, the CA SHALL:</p>
<p>• Ensure that the key represents a valid point on the NIST P‐256, NIST P‐384
  or NIST P‐521 elliptic curve.</p>
<p>No other algorithms or key sizes are permitted.</p>
</blockquote>
<h3 id="implementing-x509-certs-derived-from-the-onion-key-pair">Implementing X.509 certs derived from the .onion key pair<a href="#implementing-x509-certs-derived-from-the-onion-key-pair" title="Permanent link">¶</a></h3>
<p>In summary, implementing this proposal would require pushing at least two
specification changes:</p>
<ol>
<li>A ballot with CA/B Forum about including <a href="http://ed25519.cr.yp.to">Ed25519</a> support.</li>
<li>An update in the Onion Services v3 spec, allowing the Onion Service identity
   keys to either:<ol>
<li>Also act as Certificate Authority root keys for the service.</li>
<li>Derive long-term (1 year) blinded keys to be used as a Certificate
   Authority for the service, maybe using the same approach described by
   Appendix A (<code>[KEYBLIND]</code>) from <a href="https://spec.torproject.org/rend-spec-v3">rend-spec-v3</a> but covering the needed
   use case of a long-term key, i.e, depending in a long-term nonce and not in
   <code>[TIME-PERIODS]</code>.</li>
</ol>
</li>
</ol>
<p>It&#39;s also important to avoid using the Onion Service key directly as the HTTPS
certificate. That would:</p>
<ul>
<li>Expose the Onion Service secret key material to more software than it&#39;s
  needed, like a web server.</li>
<li>Make it very difficult to manage offline Onion Service master keys.</li>
</ul>
<p>Instead, it&#39;s better to use the Onion Service key pair to act as a CA that then
certifies a separate key pair to be used with HTTPS.</p>
<p>Similar to the self-signed certificate proposal, this approach would have
limited adoption if only as small number of applications implement it -- such
as the <a href="https://tb-manual.torproject.org">Tor Browser</a> --, except if endorsed by many stakeholders in the form of a
specification -- like the SOOC proposal discussed below.</p>
<h2 id="self-authenticating-tls-certificates-for-onion-services-using-a-pkcs11-module">Self-authenticating TLS Certificates for Onion Services using a PKCS#11 module<a href="#self-authenticating-tls-certificates-for-onion-services-using-a-pkcs11-module" title="Permanent link">¶</a></h2>
<p>The <a href="https://gitlab.torproject.org/tpo/team/-/wikis/Meetings/2024/Lisbon/self-auth-certs-for-onion-services">Self-authenticating TLS Certificates for Onion Services using a PKCS#11
module</a> proposal mentioned above, that relies on <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/pkcs11">PKCS#11 modules</a> or
<a href="https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.2.1">Authority Information Access (AIA)</a> extensions, could also be used to work
with a X.509 certificate directly derived from the .onion key pair.</p>
<p>But contrary to the previous proposal, it would not need to use <a href="http://ed25519.cr.yp.to">Ed25519</a>: it
would support a signature scheme where an <a href="http://ed25519.cr.yp.to">Ed25519</a> private key could sign an
<a href="https://blog.cloudflare.com/ecdsa-the-digital-signature-algorithm-of-a-better-internet/">ECDSA</a> key. This <a href="http://ed25519.cr.yp.to">Ed25519</a> signature could either be created using the .onion
private key itself or a fresh <a href="http://ed25519.cr.yp.to">Ed25519</a> subkey, thus avoiding key reuse.</p>
<p>Advantages:</p>
<ul>
<li>
<p>Would reduce logic in the Tor Browser by a well-established API.</p>
</li>
<li>
<p>Does not need to use <a href="http://ed25519.cr.yp.to">Ed25519</a> X.509 certificates: can work with <a href="https://blog.cloudflare.com/ecdsa-the-digital-signature-algorithm-of-a-better-internet/">ECDSA</a>
  which are fully supported by major browsers according to the
  <a href="https://cabforum.org/working-groups/server/baseline-requirements/documents/CA-Browser-Forum-TLS-BR-2.0.7.pdf">CA/B Baseline Requirements</a>, and maybe could even work with <a href="https://en.wikipedia.org/wiki/RSA_(cryptosystem)">RSA</a>.</p>
</li>
<li>
<p>Seems future-proof as <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/pkcs11">PKCS#11 modules</a> are widely used.</p>
</li>
<li>
<p>No reliance on the CA-model (and hence has increased censorship resistance).</p>
</li>
<li>
<p>No need to use <a href="https://certificate.transparency.dev/">CT Logs</a>.</p>
</li>
<li>
<p>Could be used by other browsers as well (such as Brave).</p>
</li>
<li>
<p>Could be used with any software, library or Operating System with <a href="https://en.wikipedia.org/wiki/PKCS_11">PKCS#11</a>
  support.</p>
</li>
</ul>
<p>Disadvantages:</p>
<ul>
<li>
<p>In the short-to-mid term this would not be supported on OpenSSL
  (as of 2024-09, support <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/pkcs11">PKCS#11 modules</a> is still underway).</p>
</li>
<li>
<p>System-wide support would depend on how each Operating System could support
  this custom module. So could be hard to add this to <a href="https://gitlab.torproject.org/tpo/applications/vpn/">TorVPN</a>. But anyway,
  <a href="https://gitlab.torproject.org/tpo/applications/vpn/">TorVPN</a> can&#39;t validate existing self-signed .onion certs either, as
  of 2024-09.</p>
</li>
<li>
<p>Operators currently using self-signed certs would need to migrate to new
  certificates.</p>
</li>
</ul>
<p>References:</p>
<ul>
<li><a href="https://github.com/namecoin/pkcs11mod">namecoin/pkcs11mod: Go library for creating pkcs11 modules</a>:<ul>
<li><a href="https://www.namecoin.org/2022/06/13/pkcs11mod-windows-macos-certutil.html">pkcs11mod progress: Windows, macOS, certutil support, and more!</a></li>
</ul>
</li>
<li><a href="https://www.redhat.com/en/blog/consistent-pkcs-11-support-red-hat-enterprise-linux-8">Consistent PKCS #11 support in Red Hat Enterprise Linux 8</a>.</li>
<li>OpenSSL support for <a href="https://en.wikipedia.org/wiki/PKCS_11">PKCS#11</a>:<ul>
<li><a href="https://github.com/OpenSC/libp11">OpenSC/libp11: PKCS#11 wrapper library</a> (<a href="https://tracker.debian.org/pkg/libp11">libengine-pkcs11-openssl</a> on <a href="https://www.debian.org">Debian</a>)</li>
</ul>
</li>
</ul>
<h2 id="same-origin-onion-certificates-sooc">Same Origin Onion Certificates (SOOC)<a href="#same-origin-onion-certificates-sooc" title="Permanent link">¶</a></h2>
<p>The <a href="https://github.com/alecmuffett/onion-dv-certificate-proposal">Same Origin Onion Certificates</a> (SOOC) proposal aims to specify when &#34;in
very limited circumstances, we shall not care about signatures at all&#34;,
allowing clients to <a href="https://gitlab.torproject.org/tpo/applications/tor-browser/-/issues/13410">disable self-signed certificate warnings when visiting
.onion sites</a>.</p>
<p>The main difference between the SOOC proposal and to simply start allowing
self-signed certificates is that SOOC is aimed to be an IETF proposal that
could gain momentum and hence have a greater chance to be adopt by many
different vendors.</p>
<p>See <a href="https://docs.google.com/document/d/1xE5eaDMiOKphDxijK9tfIWHUB-h-fTG8tb3laofXLSc/edit#heading=h.dphbi0rss5tj">the SOOC document</a> for details.</p>
<h2 id="dane-for-onion">DANE for .onion<a href="#dane-for-onion" title="Permanent link">¶</a></h2>
<p>Another option is to use <a href="https://en.wikipedia.org/wiki/DNS-based_Authentication_of_Named_Entities">DNS-based Authentication of Named Entities</a> (DANE),
with DNS records like this to associate an Onion Service address with a given
HTTPS certificate&#39;s public key hash:</p>
<pre><code>_443._tcp.testk4ae7qr6nhlgahvyicxy7nsrmfmhigtdophufo3vumisvop2gryd.onion. TSLA 3 1 1 AB9BEB9919729F3239AF08214C1EF6CCA52D2DBAE788BB5BE834C13911292ED9
</code></pre>
<p>In order for that to work, logic should be implemented in the client software.</p>
<p>Drawbacks:</p>
<ol>
<li>Service operators must update this record whenever a new certificate is issued.</li>
<li>Has some <a href="https://datatracker.ietf.org/doc/html/rfc6698#appendix-A.2.1.3">limits for wildcard certificates on specific ports</a>.</li>
<li>DANE is not widely supported, especially by web browsers.</li>
<li>It would only work for service operators willing to publish the .onion address in the DNS.</li>
</ol>
<h2 id="onion-only-cas">Onion-only CAs<a href="#onion-only-cas" title="Permanent link">¶</a></h2>
<p>This proposal consists of:</p>
<ol>
<li>Having .onion-only CAs with name constraints (only allowing issuance for
   .onion). Services available both via DNS-based and .onion domains will need
   to have two TLS certificates in order to use this approach -- one certificate
   for the DNS-based domain (as usual) and another only for the .onion address.</li>
<li>Certification procedure would be automated, so generated .onion addresses
   could easily have it&#39;s certificates issued by this special type of CA.</li>
<li>Certification would then happen by checking a signature in a CSR and
   comparing the Subject Alternative Name (SAN). Signature must be validated by
   the .onion address in the SAN.</li>
<li>So this type of CA would be mainly a basic notary that attests signatures and
   issues a corresponding certificate.</li>
<li>The name constraint for this type of CA ensures that it only issues
   certificates for .onion domains.</li>
</ol>
<p>Security considerations:</p>
<ul>
<li>Suppose there&#39;s a malicious or bugged CA of this type that issues a
   certificate containing a SAN for <code>$address1.onion</code> but:<ol>
<li>Without checking whether the CSR has a signature made by
   <code>$address1.onion</code>&#39;s private key.</li>
<li>Or if allowing that another, unrelated <code>$address2.onion</code> actually signs
   this CSR.</li>
</ol>
</li>
<li>Even if that&#39;s the case, i.e, the CA wrongly issued a certificate for
   <code>$address1.onion</code> that did not match the requirements, this certificate
   won&#39;t work in practice, since in a successful Onion Service TLS connection
   to <code>$address1.onion</code> the following must happen:<ol>
<li>The underlying Tor Rendezvous connection should ensure that the
   client is connected to <code>$address1.onion</code> (Onion Services connections
   are self-authenticated by the .onion address).</li>
<li>The Onion Service should then offer it&#39;s TLS certificate, which would
   not be the malicious one (except if the service is already compromised,
   but in that case the attacker would not need to forge an invalid certificate
   anyway...).</li>
<li>Then the client&#39;s TLS library tests whether the certificate chain can be
   verified and any SAN in the presented certificate matches <code>$address1.onion</code>,
   among other checks (such as expiration).</li>
</ol>
</li>
<li>That said, the work done by this special type of CA is only to <em>expand the
  self-authentication property</em> from the .onion address into a certificate. So
<em>the attack surface of this special type of CA may be inherently low</em>.</li>
</ul>
<p>Implementation considerations:</p>
<ul>
<li>Since <a href="http://ed25519.cr.yp.to">Ed25519</a> certificates probably won&#39;t be supported by major
  browsers/clients in the foreseeable future (see discussion above at the
  <a href="#self-signed-x509-from-onion-self-signed-by-the-onion-address">Self-signed X.509 for .onion</a> section), issuance should probably follow the
  Appendix B of the <a href="https://cabforum.org/working-groups/server/baseline-requirements/documents/CA-Browser-Forum-TLS-BR-2.0.7.pdf">CA/B Baseline Requirements</a>.</li>
<li>The entire certification procedure could happen via Onion Services.</li>
<li>Actually the whole CA infrastructure (website, APIs, OCSP etc) could be
  interacted only via Onion Services, to reduce the attack surface and protect
  the service location.</li>
<li>Important to consider whether would be possible to organizations setup and
  maintain a Onion-only CA that&#39;s as most automated as possible, including root
  certificate packaging/distribution/rotation.</li>
</ul>
<p>Pros:</p>
<ol>
<li>Easy to implement on the client side (just need to install the CA).</li>
<li>Easy to implement and maintain on Tor-native applications such as Tor
   Browser and the Tor VPN.</li>
<li>Possibly lowest attack surface than with regular CAs!</li>
<li>Largest certification expiration dates could be used (like one year).</li>
</ol>
<p>Cons:</p>
<ol>
<li>Might not be easy to find CAs willing to do this, or to a new one to be
   formed for this purpose.</li>
<li>Might need a merge request to include this method in the <a href="https://cabforum.org/working-groups/server/baseline-requirements/documents/CA-Browser-Forum-TLS-BR-2.0.7.pdf">CA/B Baseline
   Requirements</a>, if wider acceptance is intended.</li>
<li>No guarantees that these special CAs would be installed among all clients
   and libraries.</li>
<li>Need additional security analysis.</li>
</ol>
<p>Open questions:</p>
<ol>
<li>Need to check if <a href="https://en.wikipedia.org/wiki/Certificate_revocation_list">Certificate Revocation Lists (CRLs)</a> are needed,
   and how to handle it.</li>
<li>Need to figure out how <a href="https://en.wikipedia.org/wiki/Online_Certificate_Status_Protocol">OCSP</a> and <a href="https://en.wikipedia.org/wiki/OCSP_stapling">OCSP Stapling</a> could happen. OSCP
   connection could be available behind an Onion Service.</li>
<li>Does sending certificates to <a href="https://certificate.transparency.dev/">CT Logs</a> still makes sense for this special
   type of certification?</li>
<li>Needs built-in DoS/service abuse protection:<ul>
<li>An idea for that: implement a simple PoW by additionally requiring that
  service operators provide a proof-ownership of another .onion address
  made by an specific vanity address (like limited to 5 or 6 chars).</li>
</ul>
</li>
</ol>
<p>References:</p>
<ul>
<li><a href="https://gitlab.torproject.org/tpo/core/torspec/-/issues/171">Proposal for Bring Accessible TLS Supports to All Onion Services</a>, where
  this idea is initially written and discussed with the possibility for some
  clients to have <em>only</em> this type of CA installed (but in that case it might
  not accept valid certificates issued by regular CAs, with advantages and
  disadvantages)</li>
<li><a href="https://github.com/cabforum/servercert/issues/433">Proposal for automated onion service certificate issuance based on fully
  qualified onion service key signed certificate request</a>, where this
  proposal is sent to the CA/B Forum.</li>
</ul>
<h2 id="custom-cas">Custom CAs<a href="#custom-cas" title="Permanent link">¶</a></h2>
<p>There are also discussions about how to properly manage custom Certificate
Authorities, i.e, those not distributed in TLS libraries by default (such as
the certificate store in a web browser):</p>
<ul>
<li><a href="https://gitlab.torproject.org/tpo/applications/tor-browser/-/issues/27636">.onion indicator for non-self-signed but non-trusted sites (#27636) · Tor Browser</a></li>
</ul>
<h2 id="further-references">Further references<a href="#further-references" title="Permanent link">¶</a></h2>
<h3 id="meeting-notes">Meeting notes<a href="#meeting-notes" title="Permanent link">¶</a></h3>
<ul>
<li>From the <a href="https://gitlab.torproject.org/tpo/team/-/wikis/Meetings/2024/Lisbon/">2024 Lisbon Meeting</a>:<ul>
<li><a href="https://gitlab.torproject.org/tpo/team/-/wikis/Meetings/2024/Lisbon/self-auth-certs-for-onion-services">Self-authenticating TLS Certificates for Onion Services using a PKCS#11 module</a>.</li>
<li><a href="https://gitlab.torproject.org/tpo/team/-/wikis/Meetings/2024/Lisbon/update-on-the-acme-for-onions-rfc">An update on the ACME for onions RFC</a>.</li>
</ul>
</li>
<li>From the <a href="https://gitlab.torproject.org/tpo/team/-/wikis/meetings/2017/2017Montreal/">2017 Montreal Meeting</a>:<ul>
<li><a href="https://gitlab.torproject.org/tpo/team/-/wikis/meetings/2017/2017Montreal/Notes/IntegratingOnions">IntegratingOnions</a>.</li>
</ul>
</li>
</ul>
<h3 id="blog-posts">Blog posts<a href="#blog-posts" title="Permanent link">¶</a></h3>
<ul>
<li><a href="https://blog.torproject.org/facebook-hidden-services-and-https-certs/">Facebook, hidden services, and https certs | The Tor Project</a>:<ul>
<li>Part four: what do we think about an https cert for a .onion address?</li>
<li>Part five: What remains to be done?</li>
</ul>
</li>
</ul>

<ul>
<li><a href="https://gitlab.torproject.org/tpo/applications/tor-browser/-/issues/27636">.onion indicator for non-self-signed but non-trusted sites (#27636) · Tor Browser</a></li>
</ul>
<h2 id="notes">Notes<a href="#notes" title="Permanent link">¶</a></h2>













                
              </article>
            </div>
          
          

        </div>
        
      </main>
      
        
      
    </div></div>
  </body>
</html>
