<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/CelVoxes/ceLLama">Original</a>
    <h1>Show HN: CeLLama – Single cell annotation with local LLMs</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/CelVoxes/ceLLama/blob/main/ceLLama_files/cellama.png"><img src="https://github.com/CelVoxes/ceLLama/raw/main/ceLLama_files/cellama.png" alt=""/></a></p>
<p dir="auto">ceLLama is a streamlined automation pipeline for cell type annotations
using large-language models (LLMs).</p>

<ul dir="auto">
<li><strong>Privacy</strong>: Operates locally, ensuring no data leaks.</li>
<li><strong>Comprehensive Analysis</strong>: Considers negative genes.</li>
<li><strong>Speed</strong>: Efficient processing.</li>
<li><strong>Extensive Reporting</strong>: Generates customized reports.</li>
</ul>
<p dir="auto">ceLLama is ideal for quick and preliminary cell type checks!</p>
<div dir="auto"><p dir="auto"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p dir="auto">Check the <a href="https://github.com/CelVoxes/ceLLama/blob/main/ceLLama/pbmc2700.ipynb">tutorial</a> for Scanpy example.</p>
</div>

<p dir="auto">To install ceLLama, use the following command:</p>
<div dir="auto" data-snippet-clipboard-copy-content="devtools::install_github(&#34;CelVoxes/ceLLama&#34;)"><pre><span>devtools</span><span>::</span>install_github(<span><span>&#34;</span>CelVoxes/ceLLama<span>&#34;</span></span>)</pre></div>


<p dir="auto">Download <a href="https://ollama.com/" rel="nofollow"><code>Ollama</code></a>.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto">Step 2: Choose Your Model</h4><a id="user-content-step-2-choose-your-model" aria-label="Permalink: Step 2: Choose Your Model" href="#step-2-choose-your-model"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Select your preferred model. For instance, to run the Llama3 model, use
the following terminal command:</p>

<p dir="auto">This initiates a local server, which can be verified by visiting
<a href="http://localhost:11434/" rel="nofollow">http://localhost:11434/</a>. The page should display “Ollama is running”.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto">Step 3: Annotate Cell Types</h4><a id="user-content-step-3-annotate-cell-types" aria-label="Permalink: Step 3: Annotate Cell Types" href="#step-3-annotate-cell-types"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Load the required libraries and data:</p>
<div dir="auto" data-snippet-clipboard-copy-content="library(Seurat)
library(tidyverse)
library(httr)

pbmc.data &lt;- Read10X(&#34;../../Downloads/filtered_gene_bc_matrices/hg19/&#34;)

pbmc &lt;- CreateSeuratObject(counts = pbmc.data, project = &#34;pbmc3k&#34;, min.cells = 3, min.features = 200)
pbmc[[&#34;percent.mt&#34;]] &lt;- PercentageFeatureSet(pbmc, pattern = &#34;^MT-&#34;)
pbmc &lt;- subset(pbmc, subset = nFeature_RNA &gt; 200 &amp; nFeature_RNA &lt; 2500 &amp; percent.mt &lt; 5)

# note that you can chain multiple commands together with %&gt;%
pbmc &lt;- pbmc %&gt;% 
    SCTransform(verbose = F) %&gt;%
    RunPCA(verbose = F) %&gt;%
    FindNeighbors(dims = 1:10, verbose = F) %&gt;%
    FindClusters(resolution = 0.5, verbose = F) %&gt;% 
    RunUMAP(dims = 1:10, verbose = F)

DimPlot(pbmc, label = T, label.size = 3) + theme_void() + theme(aspect.ratio = 1)"><pre>library(<span>Seurat</span>)
library(<span>tidyverse</span>)
library(<span>httr</span>)

<span>pbmc.data</span> <span>&lt;-</span> Read10X(<span><span>&#34;</span>../../Downloads/filtered_gene_bc_matrices/hg19/<span>&#34;</span></span>)

<span>pbmc</span> <span>&lt;-</span> CreateSeuratObject(<span>counts</span> <span>=</span> <span>pbmc.data</span>, <span>project</span> <span>=</span> <span><span>&#34;</span>pbmc3k<span>&#34;</span></span>, <span>min.cells</span> <span>=</span> <span>3</span>, <span>min.features</span> <span>=</span> <span>200</span>)
<span>pbmc</span>[[<span><span>&#34;</span>percent.mt<span>&#34;</span></span>]] <span>&lt;-</span> PercentageFeatureSet(<span>pbmc</span>, <span>pattern</span> <span>=</span> <span><span>&#34;</span>^MT-<span>&#34;</span></span>)
<span>pbmc</span> <span>&lt;-</span> subset(<span>pbmc</span>, <span>subset</span> <span>=</span> <span>nFeature_RNA</span> <span>&gt;</span> <span>200</span> <span>&amp;</span> <span>nFeature_RNA</span> <span>&lt;</span> <span>2500</span> <span>&amp;</span> <span>percent.mt</span> <span>&lt;</span> <span>5</span>)

<span><span>#</span> note that you can chain multiple commands together with %&gt;%</span>
<span>pbmc</span> <span>&lt;-</span> <span>pbmc</span> %<span>&gt;</span>% 
    SCTransform(<span>verbose</span> <span>=</span> <span>F</span>) %<span>&gt;</span>%
    RunPCA(<span>verbose</span> <span>=</span> <span>F</span>) %<span>&gt;</span>%
    FindNeighbors(<span>dims</span> <span>=</span> <span>1</span><span>:</span><span>10</span>, <span>verbose</span> <span>=</span> <span>F</span>) %<span>&gt;</span>%
    FindClusters(<span>resolution</span> <span>=</span> <span>0.5</span>, <span>verbose</span> <span>=</span> <span>F</span>) %<span>&gt;</span>% 
    RunUMAP(<span>dims</span> <span>=</span> <span>1</span><span>:</span><span>10</span>, <span>verbose</span> <span>=</span> <span>F</span>)

DimPlot(<span>pbmc</span>, <span>label</span> <span>=</span> <span>T</span>, <span>label.size</span> <span>=</span> <span>3</span>) <span>+</span> theme_void() <span>+</span> theme(<span>aspect.ratio</span> <span>=</span> <span>1</span>)</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/CelVoxes/ceLLama/blob/main/README_files/figure-gfm/pbmc2700-1.png"><img src="https://github.com/CelVoxes/ceLLama/raw/main/README_files/figure-gfm/pbmc2700-1.png" alt=""/></a></p>
<p dir="auto">Identify cluster markers:</p>
<div dir="auto" data-snippet-clipboard-copy-content="DefaultAssay(pbmc) &lt;- &#34;RNA&#34;

# Find cluster markers
pbmc.markers &lt;- FindAllMarkers(pbmc, verbose = F, min.pct = 0.5)

# split into a lists per cluster
pbmc.markers.list &lt;- split(pbmc.markers, pbmc.markers$cluster)"><pre>DefaultAssay(<span>pbmc</span>) <span>&lt;-</span> <span><span>&#34;</span>RNA<span>&#34;</span></span>

<span><span>#</span> Find cluster markers</span>
<span>pbmc.markers</span> <span>&lt;-</span> FindAllMarkers(<span>pbmc</span>, <span>verbose</span> <span>=</span> <span>F</span>, <span>min.pct</span> <span>=</span> <span>0.5</span>)

<span><span>#</span> split into a lists per cluster</span>
<span>pbmc.markers.list</span> <span>&lt;-</span> split(<span>pbmc.markers</span>, <span>pbmc.markers</span><span>$</span><span>cluster</span>)</pre></div>
<p dir="auto">Run ceLLama:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# set seed, make temperature 0 for reproducible results
library(ceLLama)

res &lt;- ceLLama(pbmc.markers.list, temperature = 0, seed = 101, n_genes = 30)"><pre><span><span>#</span> set seed, make temperature 0 for reproducible results</span>
library(<span>ceLLama</span>)

<span>res</span> <span>&lt;-</span> ceLLama(<span>pbmc.markers.list</span>, <span>temperature</span> <span>=</span> <span>0</span>, <span>seed</span> <span>=</span> <span>101</span>, <span>n_genes</span> <span>=</span> <span>30</span>)</pre></div>
<div data-snippet-clipboard-copy-content="## &gt;&gt; Response: CD8+ T cells

## &gt;&gt; Response: Neutrophil

## &gt;&gt; Response: CD8+ T cells

## &gt;&gt; Response: Plasma B cells (CD19+ CD27+)

## &gt;&gt; Response: CD8+ T cells

## &gt;&gt; Response: NK cells

## &gt;&gt; Response: Macrophage/Monocyte

## &gt;&gt; Response: CD8+ T cells (cytotoxic/suppressor)

## &gt;&gt; Response: Macrophage/Monocyte

## &gt;&gt; Response: Myeloid cells (e.g., neutrophils or macrophages)"><pre><code>## &gt;&gt; Response: CD8+ T cells

## &gt;&gt; Response: Neutrophil

## &gt;&gt; Response: CD8+ T cells

## &gt;&gt; Response: Plasma B cells (CD19+ CD27+)

## &gt;&gt; Response: CD8+ T cells

## &gt;&gt; Response: NK cells

## &gt;&gt; Response: Macrophage/Monocyte

## &gt;&gt; Response: CD8+ T cells (cytotoxic/suppressor)

## &gt;&gt; Response: Macrophage/Monocyte

## &gt;&gt; Response: Myeloid cells (e.g., neutrophils or macrophages)
</code></pre></div>
<div dir="auto"><p dir="auto"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</p><p dir="auto">Increase <code>temperature</code> to diversify outputs. Set different
<code>base_prompt</code> to customize annotations.</p>
</div>
<p dir="auto">Transfer the labels:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# transfer the labels
annotations &lt;- map_chr(res, 1)

names(annotations) &lt;- levels(pbmc)
pbmc &lt;- RenameIdents(pbmc, annotations)

DimPlot(pbmc, label = T, repel = T, label.size = 3) + theme_void() + theme(aspect.ratio = 1) &amp; NoLegend()"><pre><span><span>#</span> transfer the labels</span>
<span>annotations</span> <span>&lt;-</span> map_chr(<span>res</span>, <span>1</span>)

names(<span>annotations</span>) <span>&lt;-</span> levels(<span>pbmc</span>)
<span>pbmc</span> <span>&lt;-</span> RenameIdents(<span>pbmc</span>, <span>annotations</span>)

DimPlot(<span>pbmc</span>, <span>label</span> <span>=</span> <span>T</span>, <span>repel</span> <span>=</span> <span>T</span>, <span>label.size</span> <span>=</span> <span>3</span>) <span>+</span> theme_void() <span>+</span> theme(<span>aspect.ratio</span> <span>=</span> <span>1</span>) <span>&amp;</span> NoLegend()</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/CelVoxes/ceLLama/blob/main/README_files/figure-gfm/transfer%20annotations-1.png"><img src="https://github.com/CelVoxes/ceLLama/raw/main/README_files/figure-gfm/transfer%20annotations-1.png" alt=""/></a></p>

<p dir="auto">Generate detailed reports explaining the annotations:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# Get the reason for the annotation! (a bit slower)
res &lt;- ceLLama(pbmc.markers.list, temperature = 0, seed = 101, get_reason = T)

# These creates html report in the current directory
generate_report_md(res)
create_html_report()"><pre><span><span>#</span> Get the reason for the annotation! (a bit slower)</span>
<span>res</span> <span>&lt;-</span> ceLLama(<span>pbmc.markers.list</span>, <span>temperature</span> <span>=</span> <span>0</span>, <span>seed</span> <span>=</span> <span>101</span>, <span>get_reason</span> <span>=</span> <span>T</span>)

<span><span>#</span> These creates html report in the current directory</span>
generate_report_md(<span>res</span>)
create_html_report()</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/CelVoxes/ceLLama/blob/main/ceLLama_files/report-example.png"><img src="https://github.com/CelVoxes/ceLLama/raw/main/ceLLama_files/report-example.png" alt=""/></a></p>
<p dir="auto">View the full report <a href="https://github.com/CelVoxes/ceLLama/blob/main/report.html">here</a>.</p>

<div dir="auto"><p dir="auto"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p><p dir="auto">LLMs make mistakes, please check important info.</p>
</div>

<p dir="auto">This project is licensed under the CC BY-NC 4.0 License. For more
details, visit <a href="https://creativecommons.org/licenses/by-nc/4.0/" rel="nofollow">here</a>.</p>
</article></div></div>
  </body>
</html>
