<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://til.simonwillison.net/sqlite/compile-sqlite3-rsync">Original</a>
    <h1>Compiling and running sqlite3-rsync from a branch</h1>
    
    <div id="readability-page-1" class="page"><section>



<p>Today I heard about the <a href="https://sqlite.org/draft/rsync.html" rel="nofollow">sqlite3-rsync</a> command, currently available in a branch in the SQLite code repository. It provides a mechanism for efficiently creating or updating a copy of a SQLite database that is running in WAL mode, either locally or via SSH to another server.</p>
<p><strong>Update:</strong> Thanks to <a href="https://news.ycombinator.com/item?id=41749288#41760082" rel="nofollow">gary_0 on Hacker News</a> here&#39;s a MUCH simpler recipe:</p>
<div><pre>git clone https://github.com/sqlite/sqlite.git
<span>cd</span> sqlite
./configure
make sqlite3-rsync</pre></div>
<p>So it looks like the <code>sqlite-rsync</code> command is no longer limited to a branch.</p>
<div><h2>How I compiled it without using make sqlite3-rsync</h2></div>
<p>After some poking around (and some hints from Claude) I found a recipe for compiling and running it that seems to work:</p>
<div><pre><span>cd</span> /tmp
git clone https://github.com/sqlite/sqlite.git
<span>cd</span> sqlite
git checkout sqlite3-rsync
./configure
make sqlite3.c
<span>cd</span> tool
gcc -o sqlite3-rsync sqlite3-rsync.c ../sqlite3.c -DSQLITE_ENABLE_DBPAGE_VTAB
./sqlite3-rsync --help</pre></div>
<p>Here I&#39;m cloning from the <a href="https://github.com/sqlite/sqlite.git">GitHub mirror</a> of the <a href="https://sqlite.org/src/doc/trunk/README.md" rel="nofollow">SQLite Fossil repo</a>, purely to save myself from learning how to use Fossil.</p>
<p>The first step is to run <code>./configure</code> and then <code>make sqlite3.c</code> in the root directory. This creates the SQLite amalgamation file - a single C file containing the full implementation of SQLite, which I can then use as part of compiling the <code>sqlite3-rsync</code> tool.</p>
<p>It took me quite a few iterations to get to this recipe for compiling the tool itself:</p>
<div><pre>gcc -o sqlite3-rsync sqlite3-rsync.c ../sqlite3.c -DSQLITE_ENABLE_DBPAGE_VTAB</pre></div>
<p>The <code>-DSQLITE_ENABLE_DBPAGE_VTAB</code> flag is necessary to enable the <code>dbpage</code> virtual table, which is used by the <code>sqlite3-rsync</code> tool. Without that I got this error when trying to run it:</p>
<blockquote>
<p><code>ERROR: unable to prepare SQL [SELECT hash(data) FROM sqlite_dbpage WHERE pgno&lt;=min(1,7338) ORDER BY pgno]: no such table: sqlite_dbpage</code></p>
</blockquote>

<p>Having compiled the utility I tested it out like this:</p>
<div><pre>curl https://datasette.io/content.db -o /tmp/content.db
<span><span>#</span> Enable WAL mode</span>
sqlite3 /tmp/content.db <span><span>&#34;</span>PRAGMA journal_mode=WAL<span>&#34;</span></span>
<span><span>#</span> And run the copy</span>
./sqlite3-rsync /tmp/content.db /tmp/content-copy.db</pre></div>
<p>Then I made a change to <code>/tmp/content.db</code>:</p>
<div><pre>sqlite3 /tmp/content.db <span><span>&#39;</span>create table test (id integer primary key)<span>&#39;</span></span></pre></div>
<p>Confirmed it was not present in <code>/tmp/content-copy.db</code>:</p>
<div><pre>sqlite3 /tmp/content-copy.db <span><span>&#39;</span>.tables<span>&#39;</span></span></pre></div>
<p>And ran this command to sync them up again:</p>
<div><pre>./sqlite3-rsync /tmp/content.db /tmp/content-copy.db</pre></div>
<p>Which resulted in that new table being created in the copy:</p>
<div><pre>sqlite3 /tmp/content-copy.db <span><span>&#39;</span>.tables<span>&#39;</span></span> <span>|</span> grep <span>test</span></pre></div>
<p>I haven&#39;t yet tried running the command over SSH: you first need to compile and deploy the <code>sqlite3-rsync</code> binary to the remote server and drop it somewhere on the path (the documentation suggests <code>/usr/local/bin</code>).</p>
<p>Having done that this should work:</p>
<div><pre>sqlite3-rsync user@host:/path/to/remote.db /path/to/local-copy.db</pre></div>




  
  


<p>Created 2024-10-04T13:50:54-07:00, updated 2024-10-06T14:50:09-07:00 · <a href="https://github.com/simonw/til/commits/main/sqlite/compile-sqlite3-rsync.md">History</a> · <a href="https://github.com/simonw/til/blob/main/sqlite/compile-sqlite3-rsync.md">Edit</a></p>



</section></div>
  </body>
</html>
