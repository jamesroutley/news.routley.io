<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://golb.hplar.ch/2019/01/expose-server-tor.html">Original</a>
    <h1>Expose server behind NAT with Tor</h1>
    
    <div id="readability-page-1" class="page"><article>
  <p>After I showed you how to expose a service behind a NAT or firewall with a VPN and a virtual private server in <a href="https://golb.hplar.ch/2019/01/expose-server-vpn.html" target="_blank">my previous blog post</a> we look at another way how you can achieve the same with different technology.</p> 
<p>In this tutorial, we are utilizing the Tor network and set up a hidden service to expose a service running on a computer that isn&#39;t accessible from the public Internet. Compared to the previous VPN solution, this is very easy to set up, but accessing these services needs a bit of a configuration and special software.</p> 
<h2><a href="#tor" id="tor">Tor</a></h2> 
<p><a href="https://en.wikipedia.org/wiki/Tor_(anonymity_network)" target="_blank">Tor</a> is a free software for enabling anonymous communication and consists of thousands of relays to hide a user&#39;s IP address. For accessing the Tor network, you need special software. The easiest way to start with Tor is by <a href="https://www.torproject.org/download/" target="_blank">downloading the Tor Browser</a>. This a customized Firefox browser with an integrated Tor proxy and some pre-installed addons like NoScript and HTTPS Everywhere. When you access a website from the surface Web, for example, <a href="https://www.google.com">https://www.google.com</a>, your traffic will be routed through 3 Tor relays. You can inspect them by clicking on the onion icon.</p> 
<p><img src="https://golb.hplar.ch/2019/01/expose_6.png" alt="surface web"/></p> 
<p>These relays hide my IP because all the server sees is the IP of the last node in the circuit (exit node). Be aware, while everything from the browser until the exit node is encrypted when using HTTP over cleartext TCP, the last node can read everything you send.</p> 
<p>This is one use case of the Tor browser, accessing web sites in the surface web and hide the IP address. You can also access a special kind of service: <a href="https://2019.www.torproject.org/docs/onion-services" target="_blank">Hidden Services</a>.</p> 
<p>These are services that utilize the usual TCP/IP infrastructure but are only accessible from inside the Tor network. These services can even run on servers that are not accessible from the Internet and don&#39;t have a static IP address. To accomplish this, each server, that wants to be part of the Tor network installs a Tor client. The client takes care of opening a permanent connection from the server to the Tor network and routes incoming traffic to the exposed services.</p> 
<p>When you access a hidden service, the traffic is usually routed over 6 servers. 3 from your browser to the rendezvous server and from there again 3 to the server. This way, they try to hide the location of the client and the location of the server. Be aware that connections to these hidden services are prolonged because the traffic is routed over many such servers.</p> 
<h2><a href="#expose-webserver" id="expose-webserver">Expose Webserver</a></h2> 
<p>For demonstration purposes, I use my Raspberry Pi and install a web server, Nginx, to show the process of setting things up with Tor.</p> 
<pre><code>sudo -i
apt install nginx
</code></pre> 
<p>After the package has been installed, open a browser from another computer and check if you see the Nginx welcome page. Nginx listens by default on port 80.</p> 
<p>To expose this service, we install the Tor client.</p> 
<pre><code>apt install tor
</code></pre> 
<p>Open the configuration file <code>torrc</code></p> 
<pre><code>nano /etc/tor/torrc
</code></pre> 
<p>Search for the following two lines and uncomment them (remove # at the start)</p> 
<pre><code>HiddenServiceDir /var/lib/tor/hidden_service/
HiddenServicePort 80 127.0.0.1:80
</code></pre> 
<p>This configuration tells Tor to redirect requests that are sent to port 80 over the Tor network to 127.0.0.1:80, the interface where Nginx is listening for requests.</p> 
<p>Save the file and restart Tor.</p> 
<pre><code>systemctl restart tor
</code></pre> 
<p>Change into the hidden service directory <code>/var/lib/tor/hidden_service</code>. Here you find a private_key and a hostname file.</p> 
<pre><code>cat hostname
</code></pre> 
<p>This is the public onion address that gives you access to your Nginx server over the Tor network.</p> 
<p>Enter the URL from the <code>hostname</code> file into your Tor browser, and you should see the welcome page from Nginx. When you click on the onion icon, you see the 6 servers that routed the traffic from the browser to the Nginx server.</p> 
<p><img src="https://golb.hplar.ch/2019/01/expose_3.png" alt="circuit"/></p> 
<h2><a href="#ssh" id="ssh">SSH</a></h2> 
<p>Let&#39;s expose another service, this time the SSH server of the Raspberry Pi.</p> 
<p>Open the configuration file again</p> 
<pre><code>nano /etc/tor/torrc
</code></pre> 
<p>and add the following three lines</p> 
<pre><code>HiddenServiceDir /var/lib/tor/hidden_ssh/
HiddenServicePort 22 127.0.0.1:22
HiddenServiceAuthorizeClient stealth clien1,client2
</code></pre> 
<p>Because SSH is such a security-sensitive service, we add an extra layer of security. With the <code>HiddenServiceAuthorizeClient</code> directive, we tell Tor to give access to this service to authorized clients only. In this example, we allowed two clients to access the SSH service.</p> 
<p>Restart Tor and look into the <code>/var/lib/tor/hidden_ssh/</code> directory. You find a new third file <code>client_keys</code>, which contains the private keys of the clients. When you open <code>hostname</code>, you see an additional key after the address. Each client has its own onion address and public key.</p> 
<pre><code>uwz4e5vato5n3x64.onion 5+bgjVb... # client: clien1
w7e5qlniiwacdzpf.onion eCGVCcH... # client: client2
</code></pre> 
<p>When we want to access this service, we can&#39;t use the Tor browser because he is not an SSH client. But the Tor browser also starts a SOCKS5 proxy in the background. Go to the installation directory of your Tor browser and look for the folder</p> 
<pre><code>Browser/TorBrowser/Data/Tor
</code></pre> 
<p>In this folder, you find the file <code>torrc</code>. Close the browser and open this file with a text editor. Insert the following line to tell Tor to use this public key when somebody wants to connect to <code>uwz4e5vato5n3x64.onion</code></p> 
<pre><code>HidServAuth uwz4e5vato5n3x64.onion 5+bgjVb...
</code></pre> 
<p>Start the Tor browser again; this automatically starts the SOCKS5 proxy. You can use this proxy from every application on your computer that provides proxy support. The SSH client I usually use is <a href="https://www.putty.org/" target="_blank">Putty</a>, and it has SOCKS5 support built-in. Start Putty, open the menu Connection-&gt;Proxy select SOCKS5, and enter the hostname 127.0.0.1 and the port 9150.</p> 
<p><img src="https://golb.hplar.ch/2019/01/expose_4.png" alt="socks5"/></p> 
<p>Go to Sessions and enter the onion address into the Host Name field.</p> 
<p><img src="https://golb.hplar.ch/2019/01/expose_5.png" alt="address"/></p> 
<p>Open the connection, and you should see the login from the SSH server.</p> 
<p>Instead of installing the whole Tor browser, on Windows, you can install the Tor proxy. Go to the <a href="https://www.torproject.org/download/" target="_blank">download page</a> and download the Expert bundle, unzip it and start the proxy with <code>Tor/tor.exe</code>. Notice that the SOCKS5 proxy listens on port 9050. The program looks in your home directory for the torrc file: <code>C:/Users/&lt;USER&gt;/AppData/Roaming/tor/torrc</code></p>
  </article></div>
  </body>
</html>
