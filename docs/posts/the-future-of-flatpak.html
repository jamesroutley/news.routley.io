<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/Articles/1020571/">Original</a>
    <h1>The Future of Flatpak</h1>
    
    <div id="readability-page-1" class="page"><div>

<p>At the <a href="https://linuxappsummit.org/">Linux Application
Summit</a> (LAS) in April, Sebastian Wick said that, by many metrics, <a href="https://flatpak.org/">Flatpak</a> is doing great. The Flatpak
application-packaging format is popular with upstream developers, and
with many users. More and more applications are being published in the
<a href="https://flathub.org/">Flathub</a> application store, and the
format is even being adopted by Linux distributions like
Fedora. However, he worried that work on the Flatpak project itself
had stagnated, and that there were too few developers able to review
and merge code beyond basic maintenance.</p>

<p>I was not able to attend LAS in person or watch it live-streamed,
so I watched the YouTube <a href="https://www.youtube.com/watch?v=3HkYJ7M119I">video</a> of the
talk. The slides are available from the <a href="https://conf.linuxappsummit.org/event/7/contributions/219/">talk
page</a>. Wick is a member of the GNOME Project and a Red Hat employee
who works on &#34;<q>all kinds of desktop plumbing</q>&#34;, including Flatpak
and <a href="https://flatpak.github.io/xdg-desktop-portal/">desktop
portals</a>.</p>

<h4>Flatpak basics</h4>

<p>Flatpak was <a href="https://github.com/flatpak/flatpak/wiki/Flatpak%27s-History">originally
developed</a> by Alexander Larsson, who had been working on similar
projects stretching back to 2007. The <a href="https://help.gnome.org/misc/release-notes/3.18/developers.html.en#:~:text=Sandboxed%20Applications">first
release</a> was as XDG-App in 2015. It was renamed to Flatpak in 2016,
a nod to IKEA&#39;s &#34;<a href="https://www.ikea.com/ph/en/this-is-ikea/about-us/the-story-of-ikea-flatpacks-puba710ccb0/">flatpacks</a>&#34;
for delivering furniture.</p>

<p>The Flatpak project provides <a href="https://docs.flatpak.org/en/latest/flatpak-command-reference.html#flatpak">command-line
tools</a> for managing and running Flatpak applications, tools for <a href="https://docs.flatpak.org/en/latest/flatpak-builder-command-reference.html">building
Flatpak bundles</a>, and <a href="https://docs.flatpak.org/en/latest/available-runtimes.html">runtimes</a>
that provide components for Flatpak applications. The project uses <a href="https://lwn.net/Articles/603762/">control groups</a>, <a href="https://lwn.net/Articles/531114/">namespaces</a>,
<a href="https://lwn.net/Articles/281157/">bind mounts</a>, <a href="https://lwn.net/Articles/332974/">seccomp</a>, and <a href="https://github.com/containers/bubblewrap?tab=readme-ov-file#bubblewrap">Bubblewrap</a>
to provide application isolation (&#34;sandboxing&#34;). Flatpak content is 
primarily delivered using <a href="https://ostreedev.github.io/ostree/introduction/">OSTree</a>,
though support for using <a href="https://github.com/opencontainers/distribution-spec/">Open
Container Initiative (OCI) images</a> has been <a href="https://opencontainers.org/posts/blog/2018-11-07-bringing-oci-images-to-the-desktop-with-flatpak/">available</a>
since 2018 and is used by Fedora for its Flatpak applications. The &#34;<a href="https://docs.flatpak.org/en/latest/under-the-hood.html">Under
the Hood</a>&#34; page from Flatpak&#39;s documentation provides a good
overview of how the pieces fit together.</p>

<h4>Slowing development</h4>

<p>Wick started his talk by saying that it looks like everything is
great with the Flatpak project, but if one looks deeper, &#34;<q>you will
notice that it&#39;s not being actively developed anymore</q>&#34;. There are
people who maintain the code base and fix security issues, for
example, but &#34;<q>bigger changes are not really happening
anymore</q>&#34;. He said that there are a bunch of merge requests for new
features, but no one feels responsible for reviewing them, and that is
kind of problematic.</p>

<!-- middle-ad -->

<p>The reason for the lack of reviewers is that key people, such as
Larsson, have left the project. Every now and then, Wick said, Larsson
may get involved if it&#39;s necessary, but he is basically not part of
the day-to-day development of the project. Wick said that it is hard
to get new Flatpak contributors involved because it can take months to
get feedback on major changes, and then more months to get another
review. &#34;<q>This is really not a great way to get someone up to speed,
and it&#39;s not a great situation to be in</q>.&#34;</p>

<p>&#34;<q>Maybe I&#39;m complaining about something that is actually not that
much of an issue</q>&#34;, he said. Flatpak works; it does its job, and
&#34;<q>we just use it and don&#39;t think about it much</q>&#34;. In that sense,
the project is in a good spot. But he has still been thinking
about how the project is &#34;<q>living with constraints</q>&#34; because
contributors do not have the opportunity to go in and make bigger
changes.</p>

<p>As an example, Wick said that Red Hat has been doing work that
would allow Flatpaks to be installed as part of a base
installation. The vendor or administrator could specify the
applications to be installed, and a program called
<tt>flatpak-preinstall</tt> would take care of the rest. The feature
has been implemented and is planned for inclusion in Red Hat
Enterprise Linux (RHEL) 10. The work was <a href="https://github.com/flatpak/flatpak/pull/5832">started</a> by
Kalev Lember and Owen Taylor last June, but the original pull request
was <a href="https://github.com/flatpak/flatpak/pull/5832#issuecomment-2630695788">closed</a>
by Lember in February as he was leaving Red Hat and would not be
working on it anymore. It was picked up by Wick in February as a <a href="https://github.com/flatpak/flatpak/pull/6116">new request</a>
but wasn&#39;t reviewed until early May.</p>

<h4>OSTree and OCI</h4>

<p>Wick&#39;s next topic was OCI support in Flatpak. While OSTree has been
a success in some ways, and it is still being maintained, it is not
undergoing active development. He noted that developers have a
&#34;<q>very narrow set of tools</q>&#34; for working with OSTree, so building
Flatpaks that use OSTree requires non-standard and bespoke tools, but
there is a whole range of utilities available for working with OCI
images. Even better, tools for working with OCI images &#34;<q>are all
developed by people other than us, which means we don&#39;t actually have
to do the work if we just embrace them</q>&#34;.</p>

<p>Unfortunately, there are a number of OCI-related improvements that,
again, are waiting on review to be merged into Flatpak. For example,
Wick mentioned that the OCI container standard has added <a href="https://github.com/containers/storage/blob/main/docs/containers-storage-zstd-chunked.md"><tt>zstd:chunked</tt></a>
support. Instead of the original OCI image format that uses gzipped
tarballs, the <tt>zstd:chunked</tt> images are compressed with <a href="https://datatracker.ietf.org/doc/html/rfc8478">zstd</a> and have
<a href="https://github.com/facebook/zstd/blob/dev/doc/zstd_compression_format.md#skippable-frames">skippable
frames</a> that include additional metadata—such as a table of
contents—which allows file-level deduplication. In short,
zstd:chunked allows pulling only those files that have changed since
the last update, rather than an entire OCI layer, when updating a
container image or a Flatpak.</p>

<p>There is a <a href="https://github.com/flatpak/flatpak/pull/5540">pull request</a>
from Taylor, submitted in September 2023, that would add support
to Flatpak for zstd-compressed layers. It has received little
attention since then and &#34;<q>it&#39;s just sitting there,
currently</q>&#34;.</p>

<h4>Narrowing permissions</h4>

<p>One of the key functions of Flatpak is to sandbox applications and
limit their access to the system. Wick said that the project has added
features to &#34;<q>narrow down</q>&#34; the sandboxes and provide more
restricted permissions. As an example, Flatpak now has
<tt>--device=input</tt> to allow an application to access input
devices without having access to all devices.</p>

<p>One problem with this, he said, is that a system&#39;s installation of
Flatpak may not support the newer features. A user&#39;s Linux
distribution may still be providing an older version of Flatpak that
does not have support for <tt>--device=input</tt>, or whatever new
feature that a Flatpak developer may wish to use. Wick said there
needs to be a way for applications to use the new permissions by
default, but fall back to the older permission models if used on a
system with an older version of Flatpak.</p>

<p>This isn&#39;t an entirely new situation, he said. &#34;<q>We had this
before with Wayland and X11</q>&#34;, where if a system is running
Wayland, then Flatpak should not bind-mount an X11 socket. Now, there is a
similar scenario with the <a href="https://flatpak.github.io/xdg-desktop-portal/docs/doc-org.freedesktop.portal.Usb.html">xdg-desktop portal
for USB access</a>, which was <a href="https://github.com/flatpak/xdg-desktop-portal/pull/559">added</a>
to the xdg-desktop-project in 2021. Support for that portal was <a href="https://github.com/flatpak/flatpak/issues/4405">merged</a> into
Flatpak in 2024 after several iterations. What is missing is the
ability to specify backward-compatible permissions so that a Flatpak
application can be given USB access (<tt>--device=usb</tt>) with newer
versions of Flatpak but retain the <tt>--device=all</tt> permissions
if necessary. Once again, there is a <a href="https://github.com/flatpak/flatpak/issues/5681">pull request</a>
(from Hubert Figuière) that implements this, but Wick said that
&#34;<q>it&#39;s also just sitting there</q>&#34;.</p>

<p>Wick would also like to improve the way that Flatpak handles access
to audio. Currently, Flatpak still uses <a href="https://www.freedesktop.org/wiki/Software/PulseAudio/">PulseAudio</a>
even if a host system uses <a href="https://pipewire.org/">PipeWire</a>. The problem with that is
that PulseAudio bundles together access to speakers and
microphones—you can have access to both, or neither, but not just one. So
if an application has access to play sound, it also has access to
capture audio, which Wick said, with a bit of understatement, is
&#34;<q>not great</q>&#34;. He would like to be able to use PipeWire, which
can expose restricted access to speakers only.</p>

<p>One thing that has been a bit of a pain point, Wick said, is that
nested sandboxing does not work in Flatpak. For instance, an
application cannot use Bubblewrap inside Flatpak. Many applications,
such as web browsers, make heavy use of sandboxing.</p>

<blockquote>
They really like to put their tabs into their own sandboxes because it
turns out that if one of those tabs is running some code that
manages to exploit and break out of the process there, at
least it&#39;s contained and doesn&#39;t spread to the rest of the
browser.
</blockquote>

<p>What Flatpak does instead, currently, is to have a kind of side
sandbox that applications can call to and spawn another Flatpak
instance that can be restricted even further. &#34;<q>So, in that sense,
that is a solution to the problem, but it is also kind of fragile</q>.&#34;
There have been issues with this approach for quite a while, he said,
but no one knows quite how to solve them.</p>

<p>Ideally, Flatpak would simply support nested namespacing and nested
sandboxes, but currently it does not. Flatpak uses seccomp to prevent
applications in a sandbox from having direct access to user
namespaces. There is an API that can be used to create a sub-sandbox,
but it is more restrictive. He said that the restrictions to user
namespaces are outdated: &#34;<q>for a long time it wasn&#39;t really a good
idea to expose user namespacing because it exposed a big kernel API to
user space that could be exploited</q>&#34;. Wick feels that user
namespaces are, nowadays, a well-tested and a much-used interface. He
does not think that there is much of a good argument against user
namespaces anymore.</p>

<h4>xdg-dbus-proxy</h4>

<p>Flatpak applications do not talk directly to D-Bus. Instead,
<tt>flatpak-run</tt> spawns an <a href="https://man.archlinux.org/man/xdg-dbus-proxy.1.en">xdg-dbus-proxy</a>
for every Flatpak instance that is &#34;<q>not exactly in the same
sandbox, it&#39;s just on the side, basically</q>&#34;. The proxy is
responsible for setting up filtering according to rules that are
processed when <tt>flatpak-run</tt> is used to start an
application. When setting up the proxy, Flatpak starts with a
<tt>deny-all</tt> state and then adds specific connections that are
allowed. This is so that applications do not expose things that other
applications are not supposed to use.</p>

<p>Wick said that he would like to move filtering from xdg-dbus-proxy
directly to the D-Bus message brokers and provide policy based on a
cgroups path. This is not something that has been implemented
already, but he said he planned to work on a prototype in <a href="https://github.com/dbus2/busd?tab=readme-ov-file#busd">busd</a>,
which is a D-Bus broker implementation in Rust.</p>

<p>That would also allow for a more dynamic policy, which would allow
applications to export services to other applications on the
fly. Currently, the policy is set when a Flatpak is run, and can&#39;t be
modified afterward.</p>

<p>As a side note, that means that Flatpak applications cannot
talk to one another over D-Bus. They can still communicate
with other applications; for example, Wick said that applications can
communicate over the host&#39;s shared network namespace, &#34;<q>which means
you can use HTTP or whatever, there are like thousands of side
channels you could use if you wanted to</q>&#34;.</p>

<p>Flatpak&#39;s network namespacing is &#34;<q>kind of ugly, and I don&#39;t 
really have a good solution here</q>&#34;, Wick said, but he wanted to
point out that it is something the project should take a look
at. &#34;<q>Like, you bind something on localhost and suddenly all
applications can just poke at it</q>&#34;. He gave the example of <a href="https://flathub.org/apps/de.bund.ausweisapp.ausweisapp2">AusweisApp</a>,
which is an official authentication app for German IDs 
that can be used to authenticate with government web sites. It
exposes a service on the local host, which makes it available to all
Flatpak applications on the system.</p>

<blockquote>
<p>This is some of the stuff that I feel like we really need to take a
look at. I&#39;m not sure if this is like directly exploitable, but at the
very least it&#39;s kind of scary.</p>
</blockquote>

<p>Wick said that the project needs to create a network namespace for
Flatpak applications, &#34;<q>but we don&#39;t really have any networking
experts around, which is kind of awkward, we really have to find a
solution here</q>&#34;.</p>

<p>Another awkward spot the project finds itself in, he said, is with
NVIDIA drivers. The project has to build multiple versions of NVIDIA
drivers for multiple runtimes that are supported, and that translates
to a great deal of network overhead for users who have to download
each of those versions—even if they don&#39;t need all of the
drivers. (<a href="https://forums.linuxmint.com/viewtopic.php?t=399518">This
complaint</a> on the Linux Mint forum illustrates the problem
nicely.) It also means that games packaged as Flatpaks need to be
continually updated against new runtimes, or they will eventually stop
working because their drivers stop being updated and the games will
not support current GPUs.</p>

<p>Wick&#39;s suggestion is to take a cue from Valve Software. He said
that Valve uses a model similar to Flatpak to run its games, but it
uses the drivers from the host system and loads all of the driver&#39;s
dependencies in the sandbox for the game. Valve uses the <a href="https://gitlab.collabora.com/vivek/libcapsule">libcapsule</a>
library to do this, which is &#34;<q>kind of fragile</q>&#34; and difficult to make
sure that it works well. Instead of using libcapsule, he would like to
statically compile drivers and share them between all Flatpak
applications. This is just in the idea stage at the moment, but
Wick said he would like to solve the driver problem eventually.</p>

<h4>Portals</h4>

<p>Portals are D-Bus interfaces that provide APIs for things like file
access, printing, opening URLs, and more. Flatpak can grant sandboxed
applications access to portals to make D-Bus calls. Wick noted
that portals are not part of the Flatpak project but they are crucial
to it. &#34;<q>Whatever we do with portals just directly improves
Flatpak, and there are a bunch of portal things we need to
improve</q>&#34;.</p>

<p>He gave the example of the <a href="https://flatpak.github.io/xdg-desktop-portal/docs/doc-org.freedesktop.portal.Documents.html">Documents</a>
portal, which makes files outside the sandbox available to Flatpak
applications. The Documents portal is great for sharing single files,
but it is too fine-grained and restrictive for other applications,
such as Blender, GIMP, or music applications, that may need to access
an entire library of files. &#34;<q>You want a more coarse-grained
permission model for files at some point</q>&#34;. There are some
possibilities, he said, such as bind mounting user-selected host
locations into the sandbox.</p>

<p>Wick had a number of ideas that he would like to see implemented
for portals, such as support for autofilling passwords, Fast Identity
Online (FIDO) security keys, speech synthesis, and more. He
acknowledged that it&#39;s &#34;<q>kind of hard to write</q>&#34; code for portals
right now, but there is work to make it easier by using <a href="https://gitlab.gnome.org/GNOME/libdex">libdex</a>. (See
Christian Hergert&#39;s <a href="https://blogs.gnome.org/chergert/2025/03/27/fiber-cancellation-in-libdex/">blog
post</a> on libdex for a short look at this.) It might even make sense
to rewrite things in Rust, he said.</p>

<h4>Flatpak-next</h4>

<p>Assume that it&#39;s ten years in the future, Wick said, and no one is
working on Flatpak anymore. &#34;<q>What would you do with Flatpak if you
could just rewrite it? I think the vision where we should go is OCI
for almost everything.</q>&#34; Larsson&#39;s choices in creating Flatpak
were good and sound technical decisions at the time, but they
ended up being &#34;<q>not the thing that everyone else has</q>&#34;. That is
an issue because only a few people understand what Flatpak does, and
the project has to do everything itself.</p>

<p>But, he said, if the project did &#34;<q>everything OCI</q>&#34;, it would
get a lot of things for free, such as OCI registries and tooling. Then
it just comes down to what <tt>flatpak-run</tt> has to do, and that
would not be very much. Rethinking Flatpak with modern container tools
and aligning with the wider container ecosystem, he said, would make
everything easier and is worth exploring. Once again, he floated the
idea of using Rust for a rewrite.</p>

<h4>Q&amp;A</h4>

<p>There was a little time for questions at the end of Wick&#39;s
session. The first was about what happens to existing Flatpaks if the
project moves to OCI tooling. &#34;<q>Would I need to just throw away
[applications] and download again, or is that too much in the future,
and you haven&#39;t thought about that?</q>&#34; Wick said that it would be an
issue on the client side, but Flathub (for example) has all of the
build instructions for its Flatpaks and could simply rebuild them.</p>

<p>Another audience member was concerned about using container
infrastructure. They said that OCI registries that store images are
missing indexing and metadata that is consumed by applications like
GNOME Software for Flatpaks. What would be the way forward to ensure
that they could preserve the same user experience? Wick said that
there is now a standard for storing non-images in OCI registries,
which would allow storing &#34;<q>the same things we&#39;re currently
storing</q>&#34; for Flatpak, but writing the code to do it and getting it
merged would be the hard part.</p>

<p>The final question was whether there was anything concrete planned
about using PipeWire directly with Flatpak rather than the PulseAudio
routing. Wick said that he had been talking with Wim Taymans, the
creator of PipeWire, about how to add support for it within
Flatpak. It is mostly about &#34;<q>adding PipeWire policy to do the right
thing when it knows that it is a Flatpak instance</q>&#34;, he said.</p>

</div></div>
  </body>
</html>
