<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.polyhaven.com/how-we-handle-80tb-and-5m-page-views-a-month-for-under-400/">Original</a>
    <h1>We handle 80TB and 5M page views a month for under $400</h1>
    
    <div id="readability-page-1" class="page"><div>
<pre>Note: All stats and figures below are true only at the time of writing, and will certainly change over time.</pre>
<p>Running a massively popular website and asset resource while being funded primarily by donations has always been a core challenge of Poly Haven.</p>
<p>It‚Äôs easy to throw a bunch of files on Amazon S3 and call it a day, but you‚Äôre gonna rack up a bunch of bills that you simply cannot afford to pay.</p>
<p>Serving 80TB of bandwidth from S3 is <a href="https://www.backblaze.com/b2/cloud-storage-pricing.html">estimated</a> to cost around $4,000 per month alone, which is coincidentally about the same amount that is being donated to us on <a href="https://www.patreon.com/polyhaven/overview">Patreon</a> currently.</p>
<p>This obviously leaves zero budget for actually creating assets, nevermind all <a href="https://polyhaven.com/finance-reports">our other costs</a>.</p>
<p>So how the heck do we manage to run a website with 5 million pageviews and 80 terabytes of traffic every month for under $400?</p>
<h2>Cloudflare All the Way</h2>
<p>This web giant is probably the reason we can do what we do so easily and so affordably. Sure, we could live without them, but it‚Äôd be a lot more work.</p>
<p><a href="https://www.cloudflare.com/">Cloudflare</a>, for us, is primarily a massive caching layer.</p>
<p>What does that mean? When someone in London downloads a file for example, the file is fetched from our origin server (more on that later) but routed through one of Cloudflare‚Äôs nearby edge nodes.</p>
<p>Then, the next time someone in London downloads the same file, Cloudflare has cached it and serves it to them directly, without needing to bother our origin server.</p>
<p>We can define how long a particular file or URL should be cached for using a set of rules, so that rarely changing content (like asset files) can stay cached as long as possible, while content that changes every day (e.g. our list of assets) is updated more often.</p>
<p>For asset downloads, these cached downloads make up for about 85% of all traffic.</p>
<figure><img loading="lazy" width="780" height="306" src="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-30-15_firefox-780x306.png" alt="" srcset="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-30-15_firefox-780x306.png 780w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-30-15_firefox-300x118.png 300w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-30-15_firefox-768x301.png 768w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-30-15_firefox.png 895w" sizes="(max-width: 780px) 100vw, 780px"/><figcaption>Cached (orange) vs uncached asset downloads</figcaption></figure>
<p>This doesn‚Äôt only apply to file downloads however, it‚Äôs also used for <strong>everything else on the website too</strong>.</p>
<p>Every time you load a page, your browser sends a few dozen requests (think stylesheets, javascript, json data‚Ä¶), most of which is static.</p>
<figure><img loading="lazy" width="780" height="502" src="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-38-23_firefox-780x502.png" alt="" srcset="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-38-23_firefox-780x502.png 780w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-38-23_firefox-300x193.png 300w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-38-23_firefox-768x494.png 768w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-38-23_firefox.png 1529w" sizes="(max-width: 780px) 100vw, 780px"/></figure>
<p>Because of Argo (which I‚Äôll explain below) Cloudflare can cache this kind of traffic even better than the huge asset files, resulting in about a <strong>93% cache ratio</strong>.</p>
<figure><img loading="lazy" width="780" height="327" src="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-42-51_firefox-780x327.png" alt="" srcset="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-42-51_firefox-780x327.png 780w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-42-51_firefox-300x126.png 300w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-42-51_firefox-768x322.png 768w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-42-51_firefox.png 888w" sizes="(max-width: 780px) 100vw, 780px"/><figcaption>Traffic for polyhaven.com (everything excluding asset downloads and image requests)</figcaption></figure>
<p>All this means that our origin server(s) have a lot less work to do, which means they‚Äôre theoretically more affordable.</p>
<p>And what does this amazing caching layer cost us?</p>
<p><strong>$40 per month</strong>.</p>
<p>Cloudflare‚Äôs Pro membership costs $20 per domain, and we have two domains: polyhaven.com for the main website, and polyhaven.org for the asset downloads.</p>
<h2>Backblaze Bandwidth Alliance</h2>
<p>So after Cloudflare, we only have to handle about 15% of our 80TB of monthly traffic. That‚Äôs still not nothing though, and it would cost us about $650 using Amazon S3.</p>
<p>S3 is not the only player in the game though, there are other more budget-friendly cloud providers.</p>
<p>The one we use is <a href="https://www.backblaze.com/b2/cloud-storage-pricing.html">Backblaze</a> ‚Äì another internet giant that‚Äôs more known for its consumer backup service.</p>
<p>Alone, Backblaze‚Äôs B2 clone of S3 service would cost us about $130 per month for that last 15% that Cloudflare doesn‚Äôt handle.</p>
<p>But, we can get around that because of a partnership between Backblaze and Cloudflare they call the <a href="https://www.cloudflare.com/bandwidth-alliance/backblaze/">Bandwidth Alliance</a>.</p>
<p>As long as we use both services together, and pay for the $20 cloudflare subscription, we don‚Äôt get charged for download traffic at all.</p>
<p>All we have to pay is the storage fee, some upload costs and API requests, which comes to around <strong>$11 per month</strong>.</p>
<figure><img loading="lazy" width="615" height="366" src="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-56-47_firefox.png" alt="" srcset="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-56-47_firefox.png 615w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_13-56-47_firefox-300x179.png 300w" sizes="(max-width: 615px) 100vw, 615px"/></figure>
<h2>Web ‚ÄúServer‚Äù</h2>
<p>So that covers all of our costs for hosting the asset files themselves so far, but we still need a website to show them on.</p>
<p><a href="https://polyhaven.com/">polyhaven.com</a> is built with Next.js ‚Äì a javascript framework created by Vercel.</p>
<p>While you can absolutely run a Next.js application on your own servers or half a dozen other cloud providers, <a href="https://vercel.com/?utm_source=polyhaven&amp;utm_campaign=oss">Vercel</a> offers a fairly straight forward and affordable service to deploy your web application with them directly.</p>
<p>This saves us the hassle of managing our own server, while having the added benefit of being a <a href="https://en.wikipedia.org/wiki/Serverless_computing">serverless</a> environment which improves performance for users all around the world.</p>
<p>Their base fee is <strong>$20 per month</strong>, with additional costs based on usage.</p>
<p>Since we use Cloudflare in front of Vercel and are super careful about what can be cached and what can‚Äôt (e.g. anything requiring user authentication), we generally don‚Äôt go over the included usage limits unless something goes terribly wrong.</p>
<figure><img loading="lazy" width="780" height="410" src="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_14-12-48_firefox-780x410.png" alt="" srcset="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_14-12-48_firefox-780x410.png 780w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_14-12-48_firefox-300x158.png 300w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_14-12-48_firefox-768x404.png 768w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_14-12-48_firefox.png 1014w" sizes="(max-width: 780px) 100vw, 780px"/><figcaption>Vercel serverless function execution time (free tier is 1000hr)</figcaption></figure>
<p>In fact, we recently acquired <a href="https://vercel.com/support/articles/can-vercel-sponsor-my-open-source-project">sponsorship</a> from Vercel, so they now cover our costs anyway, but for the sake of this article we‚Äôll pretend to have to pay for it üôÇ </p>
<h2>The Database</h2>
<p>An important part of any content website for sure ‚Äì this is where we store all the information about every asset, lists of every file for each of them, download logs, etc.</p>
<p>Back when we still ran hdrihaven.com and the other sites separately, all on their own manually managed <a href="https://en.wikipedia.org/wiki/LAMP_(software_bundle)">LAMP stacks</a>, the databases were the first to start suffering from performance issues.</p>
<p>To avoid this problem in the future, I decided to splurge a bit and go for a cloud solution where I wouldn‚Äôt have to worry about reliability, performance, scaling or integrity ever again: <a href="https://firebase.google.com/products/firestore">Google Firestore</a>.</p>
<p>This is certainly not the cheapest option, at around <strong>$100 per month</strong> it accounts for about half of our monthly web budget, but I still think it‚Äôs the right way to go.</p>
<figure><img loading="lazy" width="780" height="400" src="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_14-27-45_firefox-780x400.png" alt="" srcset="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_14-27-45_firefox-780x400.png 780w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_14-27-45_firefox-300x154.png 300w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_14-27-45_firefox-768x394.png 768w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_14-27-45_firefox.png 934w" sizes="(max-width: 780px) 100vw, 780px"/><figcaption>Firestore usage per day</figcaption></figure>
<p>With Firestore, you pay per usage beyond the free tier. For us, this is primarily database reads (the blue line above).</p>
<p>Every time a bit of data is fetched from the database, we pay a tiny amount. Per read it‚Äôs practically insignificant, at $0.0000006. But multiply this by the number of document reads you have to do per page view (e.g. on our <a href="https://polyhaven.com/all">library page</a>, that‚Äôs one read per asset, 866 currently), multiplied by the number of page views (~5M per month) and it can get very expensive very quickly.</p>
<p>To avoid database reads as much as possible, we cache as much as possible. Our data doesn‚Äôt change that often, or when it does (e.g. download counts) it‚Äôs not very important to show users the latest information anyway. Cloudflare all the way üôÇ</p>
<h2>Our API</h2>
<p>To give us the most control over caching database reads, and also to avoid racking up bills in Vercel, we have a separate <strong>$5 server</strong> (yes, seriously) on <a href="https://www.vultr.com/products/cloud-compute/">Vultr</a> that runs our API.</p>
<p>The purpose of this API is to connect our front-end website (on Vercel) to our database. That‚Äôs all it does.</p>
<p>And because we cache everything so heavily (in order to reduce database costs), the API server can be extremely basic.</p>
<figure><img loading="lazy" width="729" height="840" src="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_14-40-05_firefox-729x840.png" alt="" srcset="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_14-40-05_firefox-729x840.png 729w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_14-40-05_firefox-260x300.png 260w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_14-40-05_firefox-768x885.png 768w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_14-40-05_firefox.png 777w" sizes="(max-width: 729px) 100vw, 729px"/><figcaption>API server usage</figcaption></figure>
<p>It‚Äôll be a long time before this server becomes inadequate for our needs, and before that happens it‚Äôll be trivial to migrate the server snapshot to a beefier server, or load balanced network of servers more likely.</p>
<h2>Argo</h2>
<p>One of the main reasons our database and API costs are so low (relative to what they could be without Cloudflare) is because of the extremely high cache ratio, 93%. </p>
<p>It‚Äôs a direct effect ‚Äì the more we can get Cloudflare to cache, the less often our API has to fetch things from the database itself, the lower our usage costs.</p>
<p>Argo is an <strong>optional</strong> extra service from Cloudflare that does two things:</p>
<ol><li>Optimizes DNS routes to improve latency (this helps our site feel faster to users).</li><li>Adds an additional layer to the cache, so all global traffic goes through only a handful of their biggest data centers before splitting up to their hundreds of edge nodes.</li></ol>
<p>This second point is what we care about.</p>
<p>Using our example from earlier: With Argo, if someone in London first downloads a file, Cloudflare will now cache that file not just for London, but for the whole of Western Europe.</p>
<p>This results in a much higher cache ratio (going from ~75% to 93% with our configuration), but comes at a cost: <strong>You now pay per GB</strong> of traffic going through the Argo network.</p>
<figure><img loading="lazy" width="780" height="512" src="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_15-54-09_firefox-780x512.png" alt="" srcset="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_15-54-09_firefox-780x512.png 780w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_15-54-09_firefox-300x197.png 300w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_15-54-09_firefox-768x505.png 768w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_15-54-09_firefox.png 790w" sizes="(max-width: 780px) 100vw, 780px"/></figure>
<p>This is why we have separate .com and .org domains ‚Äì we have Argo enabled on the .com domain which runs the website with relatively low bandwidth, and then we leave Argo disabled on the .org domain which serves the 80TB of download traffic.</p>
<p>Argo costs us about <strong>$160 per month</strong> currently, by far the biggest single expense. But remember it saves us a huge chunk of database usage fees, by my back-of-the-napkin math around $250.</p>
<p>Plus we get the benefit of improved latency, less load on our API server, and less Vercel usage.</p>
<figure><img loading="lazy" width="780" height="596" src="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_16-20-33_firefox-780x596.png" alt="" srcset="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_16-20-33_firefox-780x596.png 780w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_16-20-33_firefox-300x229.png 300w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_16-20-33_firefox-768x587.png 768w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_16-20-33_firefox.png 807w" sizes="(max-width: 780px) 100vw, 780px"/></figure>
<h2>Image Hosting</h2>
<p>Finally, the last piece of the puzzle is mostly separate from everything else.</p>
<p>All of our images shown on the website (thumbnails, renders, previews, etc.) are stored on <a href="https://bunny.net/">Bunny.net</a> ‚Äì another budget CDN.</p>
<p>Bunny.net doesn‚Äôt just store our images though, they also have an <a href="https://bunny.net/optimizer/">optimization service</a> which allows us to dynamically resize and compress images for the website. This greatly improves both user experience (faster page loads) and our own workflow (we only need to upload a single PNG and it‚Äôs available in any size and format).</p>
<p>This costs us about <strong>$27 per month</strong>, depending on traffic.</p>
<figure><img loading="lazy" width="780" height="666" src="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_16-27-17_firefox-780x666.png" alt="" srcset="https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_16-27-17_firefox-780x666.png 780w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_16-27-17_firefox-300x256.png 300w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_16-27-17_firefox-768x655.png 768w, https://blog.polyhaven.com/wp-content/uploads/2022/01/2022-01-05_16-27-17_firefox.png 941w" sizes="(max-width: 780px) 100vw, 780px"/><figcaption>Bunny.net usage</figcaption></figure>
<h2>Total</h2>
<ul><li>DNS, caching &amp; egress: <em>Cloudflare (2 domains)</em> ‚Äì <strong>$40</strong></li><li>Caching: <em>Cloudflare (Argo)</em> ‚Äì <strong>$160</strong></li><li>Asset storage: <em>Backblaze B2</em> ‚Äì <strong>$11</strong></li><li>Web hosting: <em>Vercel</em> ‚Äì <strong>$20</strong></li><li>Database: <em>Firestore</em> ‚Äì <strong>$100</strong></li><li>API: <em>Vultr</em> ‚Äì <strong>$5</strong></li><li>Image hosting &amp; optimization: <em>Bunny.net</em> ‚Äì <strong>$27</strong></li><li>Domains: <em>Cloudflare</em> ‚Äì <strong>$4</strong></li><li>Email fees: <em>MXroute</em> ‚Äì <strong>$3</strong></li></ul>
<p><strong>That brings the total to about $370.</strong></p>
<p>A lot of these costs are based on our usage of these services, which is directly affected by traffic on the website.</p>
<p>These costs will likely grow as we grow, which is good. If you‚Äôre reading this in the distant future, just take a look at our <a href="https://polyhaven.com/finance-reports">public finance reports</a> to see how things have changed üôÇ</p>
<p>Oh and about those finance reports, the ‚ÄúWeb Hosting‚Äù category there is a bit higher than $370 as it includes some other servers and services we use to assist in managing our team and uploading assets ‚Äì those aren‚Äôt strictly related to running the polyhaven.com site itself, but rather Poly Haven the company.</p>
<h2>Future Thoughts and Contingencies</h2>
<p>Our infrastructure is intentionally quite modular, so that we don‚Äôt rely on any service too heavily. Even Cloudflare could be replaced if we had to.</p>
<p>Our API server is currently our weakest single point of failure ‚Äì I don‚Äôt have any experience running a public API. We want to allow other people to depend on the API to integrate our assets with their software, so this area needs some research and improvement.</p>
<p>Google Firebase is nice and convenient, but it is quite expensive. We could investigate some other managed database options in future.</p>
<p>One of our biggest cost savings is with the Cloudflare + Backblaze Bandwidth Alliance. The plan, should this cease to exist at some point in the future, would be to set up our own network of load balanced dedicated servers to handle the traffic. This sounds scary, but we actually did this in the past and it worked quite well. It‚Äôs a pain to manage for sure, but potentially just as cheap.</p>
<hr/>
<p>Hopefully this monster of a blog post answers some of your questions and helps you figure out the architecture you need for your own project, or was at least interesting to read üôÇ</p>
</div></div>
  </body>
</html>
