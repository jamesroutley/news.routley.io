<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://matklad.github.io/2023/10/23/unified-vs-split-diff.html">Original</a>
    <h1>Unified versus Split Diff</h1>
    
    <div id="readability-page-1" class="page"><div>
  <article>

    
<p><span>Which is better for code reviews, a unified diff or a split diff?</span></p>
<p><span>A split diff looks like this for me:</span></p>

<figure>

<img alt="" src="https://user-images.githubusercontent.com/1711539/277481233-026508cf-47ed-4897-934a-fee18b708553.png"/>
</figure>
<p><span>And this is a unified one:</span></p>

<figure>

<img alt="" src="https://user-images.githubusercontent.com/1711539/277481510-12ee62af-0305-412b-9f37-57a37744751b.png"/>
</figure>
<p><span>If the changes are simple and small, both views are good. But for larger, more complex changes</span>
<span>neither works for me.</span></p>
<p><span>For a large change, I don</span>’<span>t want to do a </span>“<span>diff review</span>”<span>, I want to do a proper code review of a</span>
<span>codebase at a particular instant in time, paying specific attention to the recently changed areas,</span>
<span>but mostly just doing general review, as if I am writing the code. I need to run tests, use goto</span>
<span>definition and other editor navigation features, apply local changes to check if some things could</span>
<span>have been written differently, look at the wider context to notice things that </span><em><span>should</span></em><span> have been</span>
<span>changed, and in general notice anything that might be not quite right with the codebase,</span>
<span>irrespective of the historical path to the current state of the code.</span></p>
<p><span>So, for me, the ideal diff view would look rather like this:</span></p>

<figure>

<img alt="" src="https://user-images.githubusercontent.com/1711539/277485436-5e9ff9d5-325b-4e2c-8285-4acb6a8c088b.png"/>
</figure>
<p><span>On the left, the current state of the code (which is also the on-disk state), with changes subtly</span>
<span>highlighted in the margins. On the right, the unified diff for the portion of the codebase currently</span>
<span>visible on the left.</span></p>
<p><span>Sadly, this format of review isn</span>’<span>t well supported by the tools </span>—<span> everyone seems to be happy</span>
<span>reviewing diffs, rather than the actual code?</span></p>
<p><span>I have a low-tech and pretty inefficient workflow for this style of review. A </span><a href="https://github.com/matklad/config/blob/master/xtool/src/gpr.rs"><code>gpr</code>
<span>script</span></a><span> for checking out a pull</span>
<span>request locally:</span></p>

<figure>


<pre><code><span><span>$</span> gpr 1234 --review</span></code></pre>

</figure>
<p><span>Internally, it does roughly</span></p>

<figure>


<pre><code><span><span>$</span> git fetch unstream refs/pull/1234/head</span>
<span><span>$</span> git switch --detach FETCH_HEAD</span>
<span><span>$</span> git reset $(git merge-base HEAD main)</span></code></pre>

</figure>
<p><span>The last line is the key </span>—<span> it erases all the commits from the pull request, but keeps all of the</span>
<span>changes. This lets me abuse my workflow for staging&amp;committing to do a code review </span>—
<a href="https://github.com/kahole/edamagit"><span>edamagit</span></a><span> shows the list of changed files, I get </span>“<span>go to</span>
<span>next/previous change</span>”<span> shortcuts in the editor, I can even use the staging area to mark hunks I have</span>
<span>reviewed.</span></p>
<p><span>The only thing I </span><em><span>don</span>’<span>t</span></em><span> get is automatic synchronization between magit status buffer, and the file</span>
<span>that</span>’<span>s currently open in the editor. That is, to view the current file and the diff on the side, I</span>
<span>have to manually open the diff and scroll it to the point I am currently looking at.</span></p>
<p><span>I wish it was easier to get this close to the code without building custom ad-hoc tools!</span></p>
<p><span>P.S. This post talks about how to review code, but reviewing the code is not necessary the primary</span>
<span>goal of code review. See this related post:</span>
<a href="https://matklad.github.io/2021/01/03/two-kinds-of-code-review.html"><em><span>Two Kinds of Code Review</span></em></a><span>.</span></p>
</article>
  </div></div>
  </body>
</html>
