<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://code.mendhak.com/keepassxc-sign-git-commit-with-ssh/">Original</a>
    <h1>Use KeePassXC to sign your Git commits</h1>
    
    <div id="readability-page-1" class="page"><article>
<p>Git 2.34 introduced a new feature: the ability to sign commits <a href="https://github.blog/2021-11-15-highlights-from-git-2-34/#tidbits">using an SSH key</a> instead of just a PGP key. This means you can now manage your SSH key with KeePassXC for both git operations and commit signing.</p>
<p>It’s a convenient option, with everything being in one place; it’s certainly easier to manage than separate PGP keys. And it still offers the security benefits of a password manager — you can have a strong password on the key and won’t have to type it in each time you push or sign the commit.</p>
<div><p>
This post assumes you’re already using KeePassXC to manage your SSH keys.</p></div>
<h4 id="get-the-latest-git" tabindex="-1"><a href="#get-the-latest-git">Get the latest git</a></h4>
<p>It’s best to have the latest version installed. On Ubuntu, you can get the latest git by adding their repository.</p>
<pre><code><span>sudo</span> add-apt-repository ppa:git-core/ppa <span>-y</span>
<span>sudo</span> <span>apt</span> update 
<span>sudo</span> <span>apt</span> <span>install</span> <span>-y</span> <span>git</span>
<span>git</span> <span>--version</span></code></pre>
<h2 id="tell-git-to-use-ssh-for-signing" tabindex="-1"><a href="#tell-git-to-use-ssh-for-signing">Tell git to use SSH for signing</a></h2>
<p>First, tell git that we want to sign every commit.</p>
<pre><code><span>git</span> config <span>--global</span> commit.gpgsign <span>true</span></code></pre>
<p>Then tell git to use ssh for signing, instead of gpg which it would normally use.</p>
<pre><code><span>git</span> config <span>--global</span> gpg.format <span>ssh</span></code></pre>
<p>Finally tell git to grab the first key from the ssh agent.</p>
<pre><code><span>git</span> config <span>--global</span> <span>--unset</span> user.signingkey
<span>git</span> config <span>--global</span> gpg.ssh.defaultKeyCommand <span>&#34;ssh-add -L&#34;</span></code></pre>
<h3 id="if-you-have-multiple-keys" tabindex="-1"><a href="#if-you-have-multiple-keys">If you have multiple keys</a></h3>
<p>The above will work well if the <em>first</em> key being served by KeePassXC is the one you want to use.</p>
<p>You can see for yourself by running:</p>
<pre><code>ssh-add <span>-L</span></code></pre>
<p>If the key you want to use isn’t the first in that list, you’ll have to copy the public key, and pass it to git as shown here:</p>
<pre><code><span>git</span> config <span>--global</span> <span>--unset</span> gpg.ssh.defaultKeyCommand
<span>git</span> config <span>--global</span> user.signingkey <span>&#34;key::ssh-ed25519 AAAAC3NzaC1xxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span></code></pre>
<p>The format is the <code>key::</code> prefix, followed by the key format (ssh-ed25519), and then the key itself. I’ve noticed that it works whether or not you include the label at the end of the key.</p>
<h2 id="sign-a-commit" tabindex="-1"><a href="#sign-a-commit">Sign a commit</a></h2>
<p>Now try signing a commit; since we’ve told git to always sign commits, just do:</p>
<pre><code><span>git</span> commit --allow-empty <span>--message</span><span>=</span><span>&#34;Testing SSH signing&#34;</span></code></pre>
<p>If you see no errors, then it worked.</p>
<h2 id="tell-github-about-your-ssh-key-again" tabindex="-1"><a href="#tell-github-about-your-ssh-key-again">Tell Github about your SSH key, again</a></h2>
<p>If you use SSH for your git pushes and fetches, you’ve already <a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account">told Github</a> about your SSH key.  You’ll have to do this <strong>once more</strong>, but this time for signing.</p>
<p>Go to the <a href="https://github.com/settings/ssh/new">Add new SSH key page</a>, and select “Signing Key” from the “Key Type” dropdown.  Then paste in your public key.</p>
<figure><a href="https://code.mendhak.com/assets/images/keepassxc-sign-git-commit-with-ssh/004.png">
    <img src="https://code.mendhak.com/assets/images/keepassxc-sign-git-commit-with-ssh/004.png" alt="" loading="lazy"/></a>
    <figcaption>SSH key specifically for signing</figcaption>
  </figure>
<h3 id="push-a-signed-commit" tabindex="-1"><a href="#push-a-signed-commit">Push a signed commit</a></h3>
<p>Push your signed commit up to Github, and it should appear with the verified badge.</p>
<figure><a href="https://code.mendhak.com/assets/images/keepassxc-sign-git-commit-with-ssh/003.png">
    <img src="https://code.mendhak.com/assets/images/keepassxc-sign-git-commit-with-ssh/003.png" alt="" loading="lazy"/></a>
    <figcaption>Verified badge</figcaption>
  </figure>
<h2 id="how-to-verify-a-signed-commit-locally" tabindex="-1"><a href="#how-to-verify-a-signed-commit-locally">How to verify a signed commit locally</a></h2>
<p>This is optional, though it’s nice to be able to verify your own commits locally.</p>
<p>If you do a <code>git log --show-signature</code>, you should see “No signature” listed against your SSH signed commits. This is normal for now.</p>
<p>Add your email address followed by the public key to an allowed_signers file.</p>
<pre><code><span>echo</span> <span>&#34;<a href="https://code.mendhak.com/cdn-cgi/l/email-protection" data-cfemail="aad3c5dfd8cfc7cbc3c6eacfd2cbc7dac6cf84c9c5c7">[email protected]</a> <span><span>$(</span>ssh-add <span>-L</span><span>)</span></span>&#34;</span> <span>&gt;&gt;</span> ~/.ssh/allowed_signers</code></pre>
<p>As before, if you have multiple keys, specify the one you want to use directly.</p>
<p>Tell git where to find that allowed_signers file.</p>
<pre><code><span>git</span> config <span>--global</span> gpg.ssh.allowedSignersFile ~/.ssh/allowed_signers</code></pre>
<p>And that’s it. If you now view the log, you should see “Good signature” listed against your SSH signed commits.</p>
<pre><code><span>git</span> log --show-signature</code></pre>
<figure><a href="https://code.mendhak.com/assets/images/keepassxc-sign-git-commit-with-ssh/005.png">
    <img src="https://code.mendhak.com/assets/images/keepassxc-sign-git-commit-with-ssh/005.png" alt="" loading="lazy"/></a>
    <figcaption>Good signature</figcaption>
  </figure>
<h2 id="notes-and-references" tabindex="-1"><a href="#notes-and-references">Notes and references</a></h2>
<p>Although this post is about KeePassXC, it should also work the same with other SSH agents like <a href="https://code.mendhak.com/keepass-and-keeagent-setup/">KeeAgent</a>, or the built in ssh-agent by just adding the key using <code>ssh-add ~/.ssh/id_ed25519</code>.</p>
<h4 id="my-gitconfig" tabindex="-1"><a href="#my-gitconfig">My <code>~/.gitconfig</code></a></h4>
<p>For your reference, this is what my <code>~/.gitconfig</code> looks like after setting this up.</p>
<p>This is a version where the first key from KeePassXC is used, nice and simple.</p>
<pre><code>[user]
        name = mendhak
        email = <a href="https://code.mendhak.com/cdn-cgi/l/email-protection" data-cfemail="a9c4ccc7cdc1c8c2e9dcdaccdbda87c7c6dbccd9c5d087cec0ddc1dccb87cac6c4">[email protected]</a>
[commit]
        gpgsign = true
[gpg]
        format = ssh
[gpg &#34;ssh&#34;]
        allowedSignersFile = /home/mendhak/.ssh/allowed_signers
        defaultKeyCommand = ssh-add -L
</code></pre>
<p>This is a version where I’ve specified the key directly.</p>
<pre><code>[user]
        name = mendhak
        email = <a href="https://code.mendhak.com/cdn-cgi/l/email-protection" data-cfemail="6d00080309050c062d181e081f1e4303021f081d0114430a041905180f430e0200">[email protected]</a>
        signingkey = key::ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAkrfhulAPWQMzPXF08BYdUgDi6NMD9FzdpiR5IhUmMr
[commit]
        gpgsign = true
[gpg]
        format = ssh
[gpg &#34;ssh&#34;]
        allowedSignersFile = /home/mendhak/.ssh/allowed_signers
</code></pre>

</article></div>
  </body>
</html>
