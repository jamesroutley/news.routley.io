<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/GrafanaLokiSimpleNotRecommended">Original</a>
    <h1>I can&#39;t recommend serious use of an all-in-one local Grafana Loki setup</h1>
    
    <div id="readability-page-1" class="page"><div><h2>I can&#39;t recommend serious use of an all-in-one local Grafana Loki setup</h2>

	<p><small>April 27, 2023</small></p>
</div><div><p><a href="https://grafana.com/oss/loki/">Grafana Loki</a> is often (self-)described
as &#39;Prometheus for logs&#39;. Like Prometheus, it theoretically has a
<a href="https://grafana.com/docs/loki/latest/installation/local/">simple all in one local installation mode of operation</a> (which
is a type of <a href="https://grafana.com/docs/loki/latest/fundamentals/architecture/deployment-modes/#monolithic-mode">monolithic deployment mode</a>),
where you install the Loki server binary, point it at some local
disk space, and run <a href="https://grafana.com/docs/loki/latest/clients/promtail/">Promtail</a> to feed
your system logs (ie, the systemd journal) into Loki. <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/GrafanaLokiAndCentralSyslogs">This is
what we do</a>, to supplement <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/CentralizeSyslog">our
central syslog server</a>. Although you might wonder
why you&#39;d have two different centralized log collection systems,
<a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/GrafanaLokiWhatILikeItFor">I&#39;ve found that there are things I like using Grafana Loki for</a>.</p>

<p>However, <strong>I can no longer recommend running such an all-in-one
Grafana Loki setup for anything serious</strong>, including what you might
call &#39;production&#39;, and I think you should be wary about attempting
to run Grafana Loki yourself in any configuration.</p>

<p>The large scale reason I say this is that most available evidence
is that Grafana Inc, the developers of Loki, are simply not very
interested in supporting this usage case or possibly any usage case
involving other people running Loki. Unlike <a href="https://prometheus.io/">Prometheus</a>, where the local usage case is considered
real and how many people operate Prometheus (<a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/PrometheusGrafanaSetup-2019">us included</a>), the Loki &#39;local usage&#39; comes across
as a teaser to convince you of Loki&#39;s general virtues, and ingesting
systemd logs through Promtail merely the most convenient way to get
a bunch of logs (<a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/GrafanaLokiAvoidingJSON">you can even get them in JSON format, although
you probably shouldn&#39;t in real usage</a>).</p>

<p>If you do try to operate Grafana Loki in this all-in-one configuration
(and perhaps in other ones), you&#39;ll likely run into an ongoing
series of issues. In general I&#39;ve found <a href="https://grafana.com/docs/loki/latest/">the Loki documentation</a> to be frustratingly brief
in important areas such as <a href="https://grafana.com/docs/loki/latest/configuration/">what all of the configuration file
settings mean</a>
and what the implications of setting them to various values are.
The documentation&#39;s example configuration for promtail reading
systemd logs is <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/GrafanaLokiCardinalityProblem">actively dangerous due to cardinality issues in
systemd labels</a>, and while Loki is
called &#39;Prometheus for logs&#39; <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/GrafanaLokiNoChunkCompaction">it differs from Prometheus in critical
ways that can force you to destroy your accumulated log data</a>. The documentation will not tell you
about this.</p>

<p>Even if you do everything as right as you can, things may well still
go wrong. Grafana Inc shipped a Linux x86 promtail 2.8.0 binary
that <a href="https://github.com/grafana/loki/issues/9060">didn&#39;t read the systemd journal</a>, which is only one
of the (nominal) headline features of promtail on its dominant
platform. <a href="https://mastodon.social/@cks/110272339926898886">An attempt to upgrade our Loki 2.7.4 to 2.8.1 failed
badly and could not be reverted</a>, forcing us to
delete our entire accumulated log data for the second time in a few
months (after <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/GrafanaLokiNoChunkCompaction">the first time</a>).
Worse, I feel that diagnosing and thus fixing this issue would have
been all but impossible within a reasonable time because Loki simply
didn&#39;t log enough useful information for a system administrator.
When the only reported &#39;error&#39;, to the extent that there is one,
is &#39;<a href="https://grafana.com/docs/loki/latest/fundamentals/architecture/rings/">empty ring</a>&#39;,
there is both a specific problem (what &#39;<a href="https://grafana.com/docs/loki/latest/fundamentals/architecture/rings/">ring</a>&#39;
out of several and how do you make it non-empty given that you&#39;re
running in a monolith and don&#39;t have rings as such) and a deep-seated
problem.</p>

<p>The deep seated problem is that <strong>Loki doesn&#39;t feel like it&#39;s been
built to be operable by people who don&#39;t know its code and its
internal details</strong>. If you are a Loki specialist who understands
everything there is about Loki, perhaps you can diagnose &#39;&#34;empty
ring&#34; as the response to everything&#39;. But if you&#39;re running Loki
in the all-in-one filesystem setup as a busy system administrator,
you probably aren&#39;t such a specialist and never will be. Loki doesn&#39;t
feel like it&#39;s built to be run in production by you and me, not
safely and reliably, and I don&#39;t expect Grafana Inc to ever change
that.</p>

<p>We will probably keep running Grafana Loki, because it&#39;s already
there, I derive some value from it, it&#39;s been integrated a bit into
<a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/PrometheusGrafanaSetup-2019">our Grafana dashboards</a>, and since
we already have <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/CentralizeSyslog">our central syslog server</a> I can live with
periodically throwing away the accumulated log data and starting
over from scratch, although I don&#39;t like it. But if I ever leave
I&#39;ll advise my co-workers to rip out all of the Loki and Promtail
infrastructure, which is also my plan if dealing with it becomes
too time-consuming and irritating. If I know now what I knew back
when I started to set up Loki, I&#39;m not sure I&#39;d have bothered.</p>

<p>(This elaborates on <a href="https://mastodon.social/@cks/110272782533851141">some Fediverse posts</a>.)</p>

<p>PS: Loki also has some container-ized multi-component run-it-yourself
example setups. I don&#39;t have any experience with them so I have no
idea if they&#39;re better supported and more reliable in practice than
the all-in-one version (which isn&#39;t particularly, as we&#39;ve seen).
A container based setup ingesting custom application logs with low
label cardinality and storing the actual logs in the cloud instead
of the filesystem may be a much better place to be for using Loki
in practice than &#39;all in one systemd journal ingestion to the
filesystem&#39;. Certainly it&#39;s closer to how Grafana Inc probably runs
Loki in their &#39;Grafana Cloud&#39; service, and the VC-funded Grafana
Inc certainly wants you to use Grafana Cloud instead of wrestling
with <a href="https://grafana.com/docs/loki/latest/configuration/">Loki configuration</a> and operation.</p>
</div></div>
  </body>
</html>
