<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.undeadly.org/cgi?action=article;sid=20260115203619">Original</a>
    <h1>OpenBSD-current now runs as guest under Apple Hypervisor</h1>
    
    <div id="readability-page-1" class="page"><div>
<div>
<p>Contributed by
<a href="https://nxdomain.no/~peter/blogposts/">Peter N. M. Hansteen</a>
on <time datetime="2026-01-15T19:01:15Z">2026-01-15</time>
from the hyper-armed dept.</p>
</div><p>
Following a recent series of commits <a href="https://marc.info/?l=openbsd-cvs&amp;m=176824452210423&amp;w=2">by</a> Helg Bredow (<code>helg@</code>) <a href="https://marc.info/?l=openbsd-cvs&amp;m=176847076401851&amp;w=2">and</a> Stefan Fritsch (<code>sf@</code>), <a href="https://www.openbsd.org/arm64.html">OpenBSD/arm64</a> now works as a guest operating system under the <em><a href="https://developer.apple.com/documentation/hypervisor">Apple Hypervisor</a></em>.
</p><p>
The commits read
</p><blockquote>
<pre>List:       openbsd-cvs
Subject:    CVS: cvs.openbsd.org: src
From:       Helg Bredow &lt;helg () cvs ! openbsd ! org&gt;
Date:       2026-01-12 18:15:33


CVSROOT:	/cvs
Module name:	src
Changes by:	helg@cvs.openbsd.org	2026/01/12 11:15:33

Modified files:
	sys/dev/pv     : viogpu.c 

Log message:
viogpu_wsmmap() returns a kva but instead should return a physical
address via <a href="https://man.openbsd.org/bus_dmamem_mmap">bus_dmamem_mmap(9)</a>. Without this, QEMU would only show a
black screen when starting X11. On the Apple Hypervisor, the kernel
would panic.
</pre>
</blockquote>

<blockquote>
<pre>Also add calls to bus_dmamap_sync(9) before transferring the framebuffer
to host memory. It was working for me without this, but this ensures
that the host running on another CPU will see updates to the
framebuffer.

Thanks to kettenis@ for reviewing and providing feedback.

ok sf@
</pre>
</blockquote>
<p>
and
</p><blockquote>
<pre>List:       openbsd-cvs
Subject:    CVS: cvs.openbsd.org: src
From:       Stefan Fritsch &lt;sf () cvs ! openbsd ! org&gt;
Date:       2026-01-15 9:06:19

CVSROOT:	/cvs
Module name:	src
Changes by:	sf@cvs.openbsd.org	2026/01/15 02:06:19

Modified files:
	sys/dev/pv     : if_vio.c 

Log message:
vio: Support MTU feature

Add support for the VIRTIO_NET_F_MTU which allows to get the hardmtu
from the hypervisor. Also set the current mtu to the same value. The
virtio standard is not clear if that is recommended, but Linux does
this, too.

Use ETHER_MAX_HARDMTU_LEN as upper hardmtu limit instead of MAXMCLBYTES,
as this seems to be more correct.

If the hypervisor requests a MTU larger than ETHER_MAX_HARDMTU_LEN,
redo feature negotiation without VIRTIO_NET_F_MTU.

With this commit, OpenBSD finally works on Apple Virtualization.

Input and testing from @helg

ok jan@
</pre>
</blockquote>
<p>
This development will be most welcome for those of us who run with newer <em><a href="https://en.wikipedia.org/wiki/Apple_silicon">Apple Silicon</a></em> Mac models.
</p><p>
As always, if you have the hardware and the capacity, please take this for a spin (in snapshots now), and report!

</p></div></div>
  </body>
</html>
