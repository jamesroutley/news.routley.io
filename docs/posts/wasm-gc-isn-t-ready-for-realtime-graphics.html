<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://dthompson.us/posts/wasm-gc-isnt-ready-for-realtime-graphics.html">Original</a>
    <h1>WASM GC isn&#39;t ready for realtime graphics</h1>
    
    <div id="readability-page-1" class="page"><div><p>Wasm GC is a wonderful thing that is now available in all major web
browsers since slowpoke Safari/WebKit finally shipped it in December.
It provides a hierarchy of heap allocated reference types and a set of
instructions to operate on them.  Wasm GC enables managed memory
languages to take advantage of the advanced garbage collectors inside
web browser engines.  It’s now possible to implement a managed memory
language without having to ship a GC inside the binary.  The benefits
are smaller binaries, better performance, and better integration with
the host runtime.</p><p>However, Wasm GC has some serious drawbacks when compared to linear
memory. I enjoy playing around with realtime graphics programming in
my free time, but I was disappointed to discover that Wasm GC just
isn’t a good fit for that right now.  I decided to write this post
because I’d like to see Wasm GC on more or less equal footing with
linear memory when it comes to binary data manipulation.</p><h2>Hello triangle</h2><p>For starters, let&#39;s take a look at what a <a href="https://learnopengl.com/Getting-started/Hello-Triangle">“hello
triangle”</a>
WebGL demo looks like with Wasm GC.  I’ll use
<a href="https://spritely.institute/hoot">Hoot</a>, the Scheme to Wasm compiler
that I work on, to build it.</p><p>Below is a Scheme program that declares imports for the subset of the
WebGL, HTML5 Canvas, etc. APIs that are necessary and then renders a
single triangle:</p><pre><code><span>(</span><span>use-modules</span> <span>(</span><span>hoot</span> <span>ffi</span><span>)</span><span>)</span>

<span>(</span><span>define-foreign</span> <span>get-element-by-id</span>
  <span>&#34;document&#34;</span> <span>&#34;getElementById&#34;</span>
  <span>(</span><span>ref</span> <span>string</span><span>)</span> <span>-&gt;</span> <span>(</span><span>ref</span> <span>null</span> <span>extern</span><span>)</span><span>)</span>

<span>(</span><span>define-foreign</span> <span>element-width</span>
  <span>&#34;element&#34;</span> <span>&#34;width&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>-&gt;</span> <span>i32</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>element-height</span>
  <span>&#34;element&#34;</span> <span>&#34;height&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>-&gt;</span> <span>i32</span><span>)</span>

<span>(</span><span>define-foreign</span> <span>get-canvas-context</span>
  <span>&#34;canvas&#34;</span> <span>&#34;getContext&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>(</span><span>ref</span> <span>string</span><span>)</span> <span>-&gt;</span> <span>(</span><span>ref</span> <span>null</span> <span>extern</span><span>)</span><span>)</span>

<span>(</span><span>define</span> <span>GL_VERTEX_SHADER</span> <span>35633</span><span>)</span>
<span>(</span><span>define</span> <span>GL_FRAGMENT_SHADER</span> <span>35632</span><span>)</span>
<span>(</span><span>define</span> <span>GL_COMPILE_STATUS</span> <span>35713</span><span>)</span>
<span>(</span><span>define</span> <span>GL_LINK_STATUS</span> <span>35714</span><span>)</span>
<span>(</span><span>define</span> <span>GL_ARRAY_BUFFER</span> <span>34962</span><span>)</span>
<span>(</span><span>define</span> <span>GL_STATIC_DRAW</span> <span>35044</span><span>)</span>
<span>(</span><span>define</span> <span>GL_COLOR_BUFFER_BIT</span> <span>16384</span><span>)</span>
<span>(</span><span>define</span> <span>GL_TRIANGLES</span> <span>4</span><span>)</span>
<span>(</span><span>define</span> <span>GL_FLOAT</span> <span>5126</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-create-shader</span>
  <span>&#34;gl&#34;</span> <span>&#34;createShader&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>i32</span> <span>-&gt;</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-delete-shader</span>
  <span>&#34;gl&#34;</span> <span>&#34;deleteShader&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>-&gt;</span> <span>none</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-shader-source</span>
  <span>&#34;gl&#34;</span> <span>&#34;shaderSource&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>(</span><span>ref</span> <span>string</span><span>)</span> <span>-&gt;</span> <span>none</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-compile-shader</span>
  <span>&#34;gl&#34;</span> <span>&#34;compileShader&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>-&gt;</span> <span>none</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-get-shader-parameter</span>
  <span>&#34;gl&#34;</span> <span>&#34;getShaderParameter&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>i32</span> <span>-&gt;</span> <span>i32</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-get-shader-info-log</span>
  <span>&#34;gl&#34;</span> <span>&#34;getShaderInfoLog&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>-&gt;</span> <span>(</span><span>ref</span> <span>string</span><span>)</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-create-program</span>
  <span>&#34;gl&#34;</span> <span>&#34;createProgram&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>-&gt;</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-delete-program</span>
  <span>&#34;gl&#34;</span> <span>&#34;deleteProgram&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>-&gt;</span> <span>none</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-attach-shader</span>
  <span>&#34;gl&#34;</span> <span>&#34;attachShader&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>-&gt;</span> <span>none</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-link-program</span>
  <span>&#34;gl&#34;</span> <span>&#34;linkProgram&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>-&gt;</span> <span>none</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-use-program</span>
  <span>&#34;gl&#34;</span> <span>&#34;useProgram&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>-&gt;</span> <span>none</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-get-program-parameter</span>
  <span>&#34;gl&#34;</span> <span>&#34;getProgramParameter&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>i32</span> <span>-&gt;</span> <span>i32</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-get-program-info-log</span>
  <span>&#34;gl&#34;</span> <span>&#34;getProgramInfoLog&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>-&gt;</span> <span>(</span><span>ref</span> <span>string</span><span>)</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-create-buffer</span>
  <span>&#34;gl&#34;</span> <span>&#34;createBuffer&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>-&gt;</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-delete-buffer</span>
  <span>&#34;gl&#34;</span> <span>&#34;deleteBuffer&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>-&gt;</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-bind-buffer</span>
  <span>&#34;gl&#34;</span> <span>&#34;bindBuffer&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>i32</span> <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>-&gt;</span> <span>none</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-buffer-data</span>
  <span>&#34;gl&#34;</span> <span>&#34;bufferData&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>i32</span> <span>(</span><span>ref</span> <span>eq</span><span>)</span> <span>i32</span> <span>-&gt;</span> <span>none</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-enable-vertex-attrib-array</span>
  <span>&#34;gl&#34;</span> <span>&#34;enableVertexAttribArray&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>i32</span> <span>-&gt;</span> <span>none</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-vertex-attrib-pointer</span>
  <span>&#34;gl&#34;</span> <span>&#34;vertexAttribPointer&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>i32</span> <span>i32</span> <span>i32</span> <span>i32</span> <span>i32</span> <span>i32</span> <span>-&gt;</span> <span>none</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-draw-arrays</span>
  <span>&#34;gl&#34;</span> <span>&#34;drawArrays&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>i32</span> <span>i32</span> <span>i32</span> <span>-&gt;</span> <span>none</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-viewport</span>
  <span>&#34;gl&#34;</span> <span>&#34;viewport&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>i32</span> <span>i32</span> <span>i32</span> <span>i32</span> <span>-&gt;</span> <span>none</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-clear-color</span>
  <span>&#34;gl&#34;</span> <span>&#34;clearColor&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>f64</span> <span>f64</span> <span>f64</span> <span>f64</span> <span>-&gt;</span> <span>none</span><span>)</span>
<span>(</span><span>define-foreign</span> <span>gl-clear</span>
  <span>&#34;gl&#34;</span> <span>&#34;clear&#34;</span>
  <span>(</span><span>ref</span> <span>extern</span><span>)</span> <span>i32</span> <span>-&gt;</span> <span>none</span><span>)</span>

<span>(</span><span>define</span> <span>(</span><span>compile-shader</span> <span>gl</span> <span>type</span> <span>source</span><span>)</span>
  <span>(</span><span>let</span> <span>(</span><span>(</span><span>shader</span> <span>(</span><span>gl-create-shader</span> <span>gl</span> <span>type</span><span>)</span><span>)</span><span>)</span>
    <span>(</span><span>gl-shader-source</span> <span>gl</span> <span>shader</span> <span>source</span><span>)</span>
    <span>(</span><span>gl-compile-shader</span> <span>gl</span> <span>shader</span><span>)</span>
    <span>(</span><span>unless</span> <span>(</span><span>=</span> <span>(</span><span>gl-get-shader-parameter</span> <span>gl</span> <span>shader</span> <span>GL_COMPILE_STATUS</span><span>)</span> <span>1</span><span>)</span>
      <span>(</span><span>let</span> <span>(</span><span>(</span><span>info</span> <span>(</span><span>gl-get-shader-info-log</span> <span>gl</span> <span>shader</span><span>)</span><span>)</span><span>)</span>
        <span>(</span><span>gl-delete-shader</span> <span>gl</span> <span>shader</span><span>)</span>
        <span>(</span><span>error</span> <span>&#34;shader compilation failed&#34;</span> <span>info</span><span>)</span><span>)</span><span>)</span>
    <span>shader</span><span>)</span><span>)</span>

<span>(</span><span>define</span> <span>(</span><span>link-shader</span> <span>gl</span> <span>vertex-shader</span> <span>fragment-shader</span><span>)</span>
  <span>(</span><span>let</span> <span>(</span><span>(</span><span>program</span> <span>(</span><span>gl-create-program</span> <span>gl</span><span>)</span><span>)</span><span>)</span>
    <span>(</span><span>gl-attach-shader</span> <span>gl</span> <span>program</span> <span>vertex-shader</span><span>)</span>
    <span>(</span><span>gl-attach-shader</span> <span>gl</span> <span>program</span> <span>fragment-shader</span><span>)</span>
    <span>(</span><span>gl-link-program</span> <span>gl</span> <span>program</span><span>)</span>
    <span>(</span><span>unless</span> <span>(</span><span>=</span> <span>(</span><span>gl-get-program-parameter</span> <span>gl</span> <span>program</span> <span>GL_LINK_STATUS</span><span>)</span> <span>1</span><span>)</span>
      <span>(</span><span>let</span> <span>(</span><span>(</span><span>info</span> <span>(</span><span>gl-get-program-info-log</span> <span>gl</span> <span>program</span><span>)</span><span>)</span><span>)</span>
        <span>(</span><span>gl-delete-program</span> <span>gl</span> <span>program</span><span>)</span>
        <span>(</span><span>error</span> <span>&#34;program linking failed&#34;</span> <span>info</span><span>)</span><span>)</span><span>)</span>
    <span>program</span><span>)</span><span>)</span>

<span>(</span><span>define</span> <span>canvas</span> <span>(</span><span>get-element-by-id</span> <span>&#34;canvas&#34;</span><span>)</span><span>)</span>
<span>(</span><span>define</span> <span>gl</span> <span>(</span><span>get-canvas-context</span> <span>canvas</span> <span>&#34;webgl&#34;</span><span>)</span><span>)</span>
<span>(</span><span>when</span> <span>(</span><span>external-null?</span> <span>gl</span><span>)</span>
  <span>(</span><span>error</span> <span>&#34;unable to create WebGL context&#34;</span><span>)</span><span>)</span>

<span>(</span><span>define</span> <span>vertex-shader-source</span>
  <span>&#34;attribute vec2 position;
attribute vec3 color;
varying vec3 fragColor;

void main() {
  gl_Position = vec4(position, 0.0, 1.0);
  fragColor = color;
}&#34;</span><span>)</span>
<span>(</span><span>define</span> <span>fragment-shader-source</span>
  <span>&#34;precision mediump float;

varying vec3 fragColor;

void main() {
  gl_FragColor = vec4(fragColor, 1);
}&#34;</span><span>)</span>
<span>(</span><span>define</span> <span>vertex-shader</span>
  <span>(</span><span>compile-shader</span> <span>gl</span> <span>GL_VERTEX_SHADER</span> <span>vertex-shader-source</span><span>)</span><span>)</span>
<span>(</span><span>define</span> <span>fragment-shader</span>
  <span>(</span><span>compile-shader</span> <span>gl</span> <span>GL_FRAGMENT_SHADER</span> <span>fragment-shader-source</span><span>)</span><span>)</span>
<span>(</span><span>define</span> <span>shader</span> <span>(</span><span>link-shader</span> <span>gl</span> <span>vertex-shader</span> <span>fragment-shader</span><span>)</span><span>)</span>

<span>(</span><span>define</span> <span>stride</span> <span>(</span><span>*</span> <span>4</span> <span>5</span><span>)</span><span>)</span>
<span>(</span><span>define</span> <span>buffer</span> <span>(</span><span>gl-create-buffer</span> <span>gl</span><span>)</span><span>)</span>
<span>(</span><span>gl-bind-buffer</span> <span>gl</span> <span>GL_ARRAY_BUFFER</span> <span>buffer</span><span>)</span>
<span>(</span><span>gl-buffer-data</span> <span>gl</span> <span>GL_ARRAY_BUFFER</span>
                <span>#f32</span><span>(</span><span>-1.0</span> <span>-1.0</span>
                      <span>1.0</span>  <span>0.0</span>  <span>0.0</span>
                      <span>1.0</span> <span>-1.0</span>
                      <span>0.0</span>  <span>1.0</span>  <span>0.0</span>
                      <span>0.0</span>  <span>1.0</span>
                      <span>0.0</span>  <span>0.0</span>  <span>1.0</span><span>)</span>
                <span>GL_STATIC_DRAW</span><span>)</span>

<span>(</span><span>gl-viewport</span> <span>gl</span> <span>0</span> <span>0</span> <span>(</span><span>element-width</span> <span>canvas</span><span>)</span> <span>(</span><span>element-height</span> <span>canvas</span><span>)</span><span>)</span>
<span>(</span><span>gl-clear</span> <span>gl</span> <span>GL_COLOR_BUFFER_BIT</span><span>)</span>
<span>(</span><span>gl-use-program</span> <span>gl</span> <span>shader</span><span>)</span>
<span>(</span><span>gl-enable-vertex-attrib-array</span> <span>gl</span> <span>0</span><span>)</span>
<span>(</span><span>gl-vertex-attrib-pointer</span> <span>gl</span> <span>0</span> <span>2</span> <span>GL_FLOAT</span> <span>0</span> <span>stride</span> <span>0</span><span>)</span>
<span>(</span><span>gl-enable-vertex-attrib-array</span> <span>gl</span> <span>1</span><span>)</span>
<span>(</span><span>gl-vertex-attrib-pointer</span> <span>gl</span> <span>1</span> <span>3</span> <span>GL_FLOAT</span> <span>0</span> <span>stride</span> <span>8</span><span>)</span>
<span>(</span><span>gl-draw-arrays</span> <span>gl</span> <span>GL_TRIANGLES</span> <span>0</span> <span>3</span><span>)</span></code></pre><p>Note that in Scheme, the equivalent of a <code>Uint8Array</code> is a
<em>bytevector</em>.  Hoot uses a packed array, an <code>(array i8)</code> specifically,
for the contents of a bytevector.</p><p>And here is the JavaScript code necessary to boot the resulting Wasm
binary:</p><pre><code><span>window</span><span>.</span><span>addEventListener</span><span>(</span><span>&#34;load&#34;</span><span>,</span> <span>async</span> <span>(</span><span>)</span> <span>=</span><span>&gt;</span> <span>{</span>
  <span>function</span> <span>bytevectorToUint8Array</span><span>(</span><span>bv</span><span>)</span> <span>{</span>
    <span>let</span> <span>len</span> <span>=</span> <span>reflect</span><span>.</span><span>bytevector_length</span><span>(</span><span>bv</span><span>)</span><span>;</span>
    <span>let</span> <span>array</span> <span>=</span> <span>new</span> <span>Uint8Array</span><span>(</span><span>len</span><span>)</span><span>;</span>
    <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>len</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
      <span>array</span><span>[</span><span>i</span><span>]</span> <span>=</span> <span>reflect</span><span>.</span><span>bytevector_ref</span><span>(</span><span>bv</span><span>,</span> <span>i</span><span>)</span><span>;</span>
    <span>}</span>
    <span>return</span> <span>array</span><span>;</span>
  <span>}</span>

  <span>let</span> <span>mod</span> <span>=</span> <span>await</span> <span>SchemeModule</span><span>.</span><span>fetch_and_instantiate</span><span>(</span><span>&#34;triangle.wasm&#34;</span><span>,</span> <span>{</span>
    <span>reflect_wasm_dir</span><span>:</span> <span>&#39;reflect-wasm&#39;</span><span>,</span>
    <span>user_imports</span><span>:</span> <span>{</span>
      <span>document</span><span>:</span> <span>{</span>
        <span>getElementById</span><span>:</span> <span>(</span><span>id</span><span>)</span> <span>=</span><span>&gt;</span> <span>document</span><span>.</span><span>getElementById</span><span>(</span><span>id</span><span>)</span>
      <span>}</span><span>,</span>
      <span>element</span><span>:</span> <span>{</span>
        <span>width</span><span>:</span> <span>(</span><span>elem</span><span>)</span> <span>=</span><span>&gt;</span> <span>elem</span><span>.</span><span>width</span><span>,</span>
        <span>height</span><span>:</span> <span>(</span><span>elem</span><span>)</span> <span>=</span><span>&gt;</span> <span>elem</span><span>.</span><span>height</span>
      <span>}</span><span>,</span>
      <span>canvas</span><span>:</span> <span>{</span>
        <span>getContext</span><span>:</span> <span>(</span><span>elem</span><span>,</span> <span>type</span><span>)</span> <span>=</span><span>&gt;</span> <span>elem</span><span>.</span><span>getContext</span><span>(</span><span>type</span><span>)</span>
      <span>}</span><span>,</span>
      <span>gl</span><span>:</span> <span>{</span>
        <span>createShader</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>type</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>createShader</span><span>(</span><span>type</span><span>)</span><span>,</span>
        <span>deleteShader</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>shader</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>deleteShader</span><span>(</span><span>shader</span><span>)</span><span>,</span>
        <span>shaderSource</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>shader</span><span>,</span> <span>source</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>shaderSource</span><span>(</span><span>shader</span><span>,</span> <span>source</span><span>)</span><span>,</span>
        <span>compileShader</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>shader</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>compileShader</span><span>(</span><span>shader</span><span>)</span><span>,</span>
        <span>getShaderParameter</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>shader</span><span>,</span> <span>param</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>getShaderParameter</span><span>(</span><span>shader</span><span>,</span> <span>param</span><span>)</span><span>,</span>
        <span>getShaderInfoLog</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>shader</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>getShaderInfoLog</span><span>(</span><span>shader</span><span>)</span><span>,</span>
        <span>createProgram</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>type</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>createProgram</span><span>(</span><span>type</span><span>)</span><span>,</span>
        <span>deleteProgram</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>program</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>deleteProgram</span><span>(</span><span>program</span><span>)</span><span>,</span>
        <span>attachShader</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>program</span><span>,</span> <span>shader</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>attachShader</span><span>(</span><span>program</span><span>,</span> <span>shader</span><span>)</span><span>,</span>
        <span>linkProgram</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>program</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>linkProgram</span><span>(</span><span>program</span><span>)</span><span>,</span>
        <span>useProgram</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>program</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>useProgram</span><span>(</span><span>program</span><span>)</span><span>,</span>
        <span>getProgramParameter</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>program</span><span>,</span> <span>param</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>getProgramParameter</span><span>(</span><span>program</span><span>,</span> <span>param</span><span>)</span><span>,</span>
        <span>getProgramInfoLog</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>program</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>getProgramInfoLog</span><span>(</span><span>program</span><span>)</span><span>,</span>
        <span>createBuffer</span><span>:</span> <span>(</span><span>gl</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>createBuffer</span><span>(</span><span>)</span><span>,</span>
        <span>deleteBuffer</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>buffer</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>deleteBuffer</span><span>(</span><span>buffer</span><span>)</span><span>,</span>
        <span>bindBuffer</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>target</span><span>,</span> <span>buffer</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>bindBuffer</span><span>(</span><span>target</span><span>,</span> <span>buffer</span><span>)</span><span>,</span>
        <span>bufferData</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>buffer</span><span>,</span> <span>data</span><span>,</span> <span>usage</span><span>)</span> <span>=</span><span>&gt;</span> <span>{</span>
          <span>let</span> <span>bv</span> <span>=</span> <span>new</span> <span>Bytevector</span><span>(</span><span>reflect</span><span>,</span> <span>data</span><span>)</span><span>;</span>
          <span>gl</span><span>.</span><span>bufferData</span><span>(</span><span>buffer</span><span>,</span> <span>bytevectorToUint8Array</span><span>(</span><span>bv</span><span>)</span><span>,</span> <span>usage</span><span>)</span><span>;</span>
        <span>}</span><span>,</span>
        <span>enableVertexAttribArray</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>index</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>enableVertexAttribArray</span><span>(</span><span>index</span><span>)</span><span>,</span>
        <span>vertexAttribPointer</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>index</span><span>,</span> <span>size</span><span>,</span> <span>type</span><span>,</span> <span>normalized</span><span>,</span> <span>stride</span><span>,</span> <span>offset</span><span>)</span> <span>=</span><span>&gt;</span> <span>{</span>
          <span>gl</span><span>.</span><span>vertexAttribPointer</span><span>(</span><span>index</span><span>,</span> <span>size</span><span>,</span> <span>type</span><span>,</span> <span>normalized</span><span>,</span> <span>stride</span><span>,</span> <span>offset</span><span>)</span><span>;</span>
        <span>}</span><span>,</span>
        <span>drawArrays</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>mode</span><span>,</span> <span>first</span><span>,</span> <span>count</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>drawArrays</span><span>(</span><span>mode</span><span>,</span> <span>first</span><span>,</span> <span>count</span><span>)</span><span>,</span>
        <span>viewport</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>x</span><span>,</span> <span>y</span><span>,</span> <span>w</span><span>,</span> <span>h</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>viewport</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>,</span> <span>w</span><span>,</span> <span>h</span><span>)</span><span>,</span>
        <span>clearColor</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>r</span><span>,</span> <span>g</span><span>,</span> <span>b</span><span>,</span> <span>a</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>clearColor</span><span>(</span><span>r</span><span>,</span> <span>g</span><span>,</span> <span>b</span><span>,</span> <span>a</span><span>)</span><span>,</span>
        <span>clear</span><span>:</span> <span>(</span><span>gl</span><span>,</span> <span>mask</span><span>)</span> <span>=</span><span>&gt;</span> <span>gl</span><span>.</span><span>clear</span><span>(</span><span>mask</span><span>)</span>
      <span>}</span>
    <span>}</span>
  <span>}</span><span>)</span><span>;</span>
  <span>let</span> <span>reflect</span> <span>=</span> <span>await</span> <span>mod</span><span>.</span><span>reflect</span><span>(</span><span>{</span> <span>reflect_wasm_dir</span><span>:</span> <span>&#39;reflect-wasm&#39;</span> <span>}</span><span>)</span><span>;</span>
  <span>let</span> <span>proc</span> <span>=</span> <span>new</span> <span>Procedure</span><span>(</span><span>reflect</span><span>,</span> <span>mod</span><span>.</span><span>get_export</span><span>(</span><span>&#34;$load&#34;</span><span>)</span><span>.</span><span>value</span><span>)</span><span>;</span>
  <span>proc</span><span>.</span><span>call</span><span>(</span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span></code></pre><h2>Hello problems</h2><p>There are two major performance issues with this program.  One is
visible in the source above, the other is hidden in the language
implementation.</p><h3>Heap objects are opaque on the other side</h3><p>Wasm GC heap objects are <em>opaque</em> to the host.  Likewise, heap objects
from the host are opaque to the Wasm guest.  Thus the contents of an
<code>(array i8)</code> object are not visible from JavaScript and the contents
of a <code>Uint8Array</code> are not visible from Wasm.  This is a good security
property in the general case, but it’s a hinderance in this specific
case.</p><p>Let’s say we have an <code>(array i8)</code> full of vertex data we want to put
into a WebGL buffer.  To do this, we must make one JS-&gt;Wasm call <em>for
each byte</em> in the array and store it into a <code>Uint8Array</code>.  This is
what the <code>bytevectorToUint8Array</code> function above is doing.  Copying
any significant amount of data per frame is going to tank performance.
Hope you aren’t trying to stream vertex data!</p><p>Contrast the previous paragraph with Wasm linear memory.  A
<code>WebAssembly.Memory</code> object can be <a href="https://developer.mozilla.org/en-US/docs/WebAssembly/JavaScript_interface/Memory/buffer">easily accessed from
JavaScript</a>
as an <code>ArrayBuffer</code>.  To get a blob of vertex data out of a memory
object, you just need to know the byte offset and length and you’re
good to go.  There are many Wasm linear memory applications using
WebGL successfully.</p><h3>Manipulating multi-byte binary data is inefficient</h3><p>To read a multi-byte number such as an unsigned 32-bit integer from an
<code>(array i8)</code>, you have to fetch each individual byte and combine them
together.  Here’s a self-contained example that uses Guile-flavored
WAT format:</p><pre><code><span>(</span><span>module</span>
 <span>(</span><span>type</span> <span>$bytevector</span> <span>(</span><span>array</span> <span>i8</span><span>)</span><span>)</span>
 <span>(</span><span>data</span> <span>$init</span> <span>#u32</span><span>(</span><span>123456789</span><span>)</span><span>)</span>
 <span>(</span><span>func</span> <span>(</span><span>export</span> <span>&#34;main&#34;</span><span>)</span> <span>(</span><span>result</span> <span>i32</span><span>)</span>
       <span>(</span><span>local</span> <span>$a</span> <span>(</span><span>ref</span> <span>$bytevector</span><span>)</span><span>)</span>
       <span>(</span><span>local.set</span> <span>$a</span> <span>(</span><span>array.new_data</span> <span>$bytevector</span> <span>$init</span>
                                     <span>(</span><span>i32.const</span> <span>0</span><span>)</span>
                                     <span>(</span><span>i32.const</span> <span>4</span><span>)</span><span>)</span><span>)</span>
       <span>(</span><span>array.get_u</span> <span>$bytevector</span> <span>(</span><span>local.get</span> <span>$a</span><span>)</span> <span>(</span><span>i32.const</span> <span>0</span><span>)</span><span>)</span>
       <span>(</span><span>i32.shl</span> <span>(</span><span>array.get_u</span> <span>$bytevector</span> <span>(</span><span>local.get</span> <span>$a</span><span>)</span> <span>(</span><span>i32.const</span> <span>1</span><span>)</span><span>)</span>
                <span>(</span><span>i32.const</span> <span>8</span><span>)</span><span>)</span>
       <span>(</span><span>i32.or</span><span>)</span>
       <span>(</span><span>i32.shl</span> <span>(</span><span>array.get_u</span> <span>$bytevector</span> <span>(</span><span>local.get</span> <span>$a</span><span>)</span> <span>(</span><span>i32.const</span> <span>2</span><span>)</span><span>)</span>
                <span>(</span><span>i32.const</span> <span>16</span><span>)</span><span>)</span>
       <span>(</span><span>i32.or</span><span>)</span>
       <span>(</span><span>i32.shl</span> <span>(</span><span>array.get_u</span> <span>$bytevector</span> <span>(</span><span>local.get</span> <span>$a</span><span>)</span> <span>(</span><span>i32.const</span> <span>3</span><span>)</span><span>)</span>
                <span>(</span><span>i32.const</span> <span>24</span><span>)</span><span>)</span>
       <span>(</span><span>i32.or</span><span>)</span><span>)</span><span>)</span></code></pre><p>By contrast, Wasm linear memory needs but a single <code>i32.load</code>
instruction:</p><pre><code><span>(</span><span>module</span>
 <span>(</span><span>memory</span> <span>1</span><span>)</span>
 <span>(</span><span>func</span> <span>(</span><span>export</span> <span>&#34;main&#34;</span><span>)</span> <span>(</span><span>result</span> <span>i32</span><span>)</span>
       <span>(</span><span>i32.store</span> <span>(</span><span>i32.const</span> <span>0</span><span>)</span> <span>(</span><span>i32.const</span> <span>123456789</span><span>)</span><span>)</span>
       <span>(</span><span>i32.load</span> <span>(</span><span>i32.const</span> <span>0</span><span>)</span><span>)</span><span>)</span><span>)</span></code></pre><p>Easy peasy.  Not only is it less code, it&#39;s a lot more efficient.</p><p>The triangle example above uses static vertex data stuffed into
bytevector literals, so it doesn’t hit this problem, but real programs
that have dynamic buffer data will be slower than their linear memory
equivalents.</p><h2>Unsatisfying workarounds</h2><p>There’s no way around the multi-byte problem at the moment, but for
byte access from JavaScript there are some things we could try to work
with what we have been given.  Spoiler alert: None of them are
pleasant.</p><h3>Use Uint8Array from the host</h3><p>This approach makes all binary operations from within the Wasm binary
slow since we’d have to cross the Wasm-&gt;JS bridge for each read/write.
Since most of the binary data manipulation is happening in the Wasm
module, this approach will just make things slower overall.</p><h3>Use linear memory for bytevectors</h3><p>This would require a little <code>malloc</code>/<code>free</code> implementation and a way
to reclaim memory for GC&#39;d bytevectors.  You could register every
bytevector in a <code>FinalizationRegistry</code> in order to be notified upon GC
and <code>free</code> the memory.  Now you have to deal with memory
fragmentation.  This is Wasm GC, we shouldn’t have to do any of this!</p><h3>Use linear memory as a scratch space</h3><p>This avoids crossing the Wasm/JS boundary for each byte, but still
involves a byte-by-byte copy from <code>(array i8)</code> to linear memory within
the Wasm module.  So far this feels like the least worst option, but
the extra copy is still going to greatly reduce throughput.</p><h2>Wasm GC needs some fixin&#39;</h2><p>I’ve used realtime graphics as an example because it’s a use case that
is very sensitive to performance issues, but this unfortunate need to
copy binary data byte-by-byte is also the reason why <a href="https://wingolog.org/archives/2023/10/19/requiem-for-a-stringref">strings are
trash</a>
on Wasm GC right now.
<a href="https://github.com/WebAssembly/stringref">Stringref</a> is a good
proposal and the Wasm community group made a mistake by rejecting it.</p><p>Anyway, there has been some discussion about both
<a href="https://github.com/WebAssembly/gc/issues/395">multi-byte</a> and
<a href="https://github.com/WebAssembly/gc/issues/568"><code>ArrayBuffer</code></a> access
on GitHub, but as far as I can tell neither issue is anywhere close to
a resolution.</p><p>Can these things be implemented efficiently?  How can the need for
direct access to packed arrays from JS be reconciled with Wasm heap
object opaqueness?  I hope the Wasm community group can arrive at
solutions sooner than later because it will take a long time to get
the proposal(s) to phase 4 and shipped in all browsers, perhaps years.
I am getting by making simple things with HTML5 Canvas but it would be
a shame to be effectively shut out from using WebGPU when it finally
reaches stable browser releases.</p></div></div>
  </body>
</html>
