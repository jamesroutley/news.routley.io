<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://dinesh.wiki/posts/build-your-own-persistent-kv-store/">Original</a>
    <h1>Build your own fast, persistent KV store</h1>
    
    <div id="readability-page-1" class="page"><div id="main">
    <div>

        

        <article data-align="justify" data-type="posts">

            

            

            
                
                
            

            
                

<p><time datetime="2023-02-13T18:15:37+04:00"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"></path></svg> 2023.2.13</time>
    
    
    
    
        
        
        
            
                <span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"></path></svg> <a href="https://bytes.zone/categories/databases/">databases</a></span>
            
        
    
    
        
        <span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3 0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9 0l60.1 60.1c18.8 18.7 18.8 49.1 0 67.9zM284.2 99.8L21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3 0-17l-111-111c-4.8-4.7-12.4-4.7-17.1 0zM124.1 339.9c-5.5-5.5-5.5-14.3 0-19.8l154-154c5.5-5.5 14.3-5.5 19.8 0s5.5 14.3 0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8 0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"></path></svg> 1652</span>
    
    
        
        <span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"></path></svg> 8 mins</span>
    
    
    
</p>

            

            <nav>
  <ol>
    <li>
      <ol>
        <li><a id="contents:bitcask" href="#bitcask">Bitcask</a>
          <ol>
            <li><a id="contents:goals" href="#goals">Goals</a></li>
          </ol>
        </li>
        <li><a id="contents:data-format" href="#data-format">Data Format</a>
          <ol>
            <li><a id="contents:whats-the-essential-thing-that-we-need-to-store" href="#whats-the-essential-thing-that-we-need-to-store">What’s the essential thing that we need to store?</a></li>
            <li><a id="contents:given-a-cursor-at-the-location-of-the-data-in-file-will-you-be-able-to-read-the-data" href="#given-a-cursor-at-the-location-of-the-data-in-file-will-you-be-able-to-read-the-data">Given a cursor at the location of the data in file, will you be able to read the data?</a></li>
            <li><a id="contents:storing-primitive-data-types" href="#storing-primitive-data-types">Storing primitive data types</a></li>
            <li><a id="contents:auditing--security" href="#auditing--security">Auditing &amp; Security</a></li>
          </ol>
        </li>
        <li><a id="contents:number-system" href="#number-system">Number System</a></li>
        <li><a id="contents:largest-key--value-size" href="#largest-key--value-size">Largest Key &amp; Value Size</a></li>
        <li><a id="contents:stiching-everything" href="#stiching-everything">Stiching Everything</a>
          <ol>
            <li><a id="contents:serialize--deserialize" href="#serialize--deserialize">Serialize &amp; Deserialize</a></li>
            <li><a id="contents:diskstore" href="#diskstore">DiskStore</a></li>
          </ol>
        </li>
        <li><a id="contents:closing-thoughts" href="#closing-thoughts">Closing thoughts</a></li>
      </ol>
    </li>
  </ol>
</nav><div>
                <p><span>D</span>atabases have always fascinated me, and I have always dreamt of building a simple, hobby database for fun.
I have read several blog posts about building redis, git, compiler, and interpreter, but none about building a database. This post is an outcome of a long and treacherous search of posts on making a database and eventually encountering the <a href="https://riak.com/assets/bitcask-intro.pdf" target="_blank" rel="noopener">Bitcask paper</a>.</p>
<h3 id="bitcask"><a href="#bitcask"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a><a href="#contents:bitcask">Bitcask</a></h3>
<p><a href="https://riak.com/assets/bitcask-intro.pdf" target="_blank" rel="noopener">Bitcask</a> is a local key/value store where the data is persisted in a file. One operating system process will open the file for writing at any time. When the file size reaches a considerable theoretical threshold, we close the file and open a new one.</p>
<h4 id="goals"><a href="#goals"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a><a href="#contents:goals">Goals</a></h4>
<ol>
<li>Low latency per item, read or written.</li>
<li>High throughput, especially when writing an incoming stream of random items.</li>
<li>Ability to handle datasets much more significant than RAM w/o degradation.</li>
<li>Crash friendliness, both in terms of a fast recovery and not losing data.</li>
<li>Ease of backup and restore.</li>
<li>A relatively simple, understandable code structure and data format.</li>
</ol>
<h3 id="data-format"><a href="#data-format"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a><a href="#contents:data-format">Data Format</a></h3>
<p>Let’s start breaking it down.</p>
<h4 id="whats-the-essential-thing-that-we-need-to-store"><a href="#whats-the-essential-thing-that-we-need-to-store"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a><a href="#contents:whats-the-essential-thing-that-we-need-to-store">What’s the essential thing that we need to store?</a></h4>
<ol>
<li>Key</li>
<li>Value</li>
</ol>
<p><img src="https://bytes.zone/posts/fields-as-sets/images/bitcask-db-kv.svg" width="40%" alt="b-kv"/></p><h4 id="given-a-cursor-at-the-location-of-the-data-in-file-will-you-be-able-to-read-the-data"><a href="#given-a-cursor-at-the-location-of-the-data-in-file-will-you-be-able-to-read-the-data"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a><a href="#contents:given-a-cursor-at-the-location-of-the-data-in-file-will-you-be-able-to-read-the-data">Given a cursor at the location of the data in file, will you be able to read the data?</a></h4>
<p>The answer is No!</p>
<p><strong>Let me explain</strong></p>
<p>As key and value is variable length. We will need to figure out how much to read. So we need to store the size of the key and its value.</p>
<p><img src="https://bytes.zone/posts/fields-as-sets/images/bitcask-db-kv-size.svg" width="50%" alt="b-kv-size"/></p><p>Now that we have the key and value size written in the file. Given a file cursor pointing to the location of the data. We know the first 8 bytes represent key and value size. Once we read that, we see the size of the actual key and the value to be read.</p>
<h4 id="storing-primitive-data-types"><a href="#storing-primitive-data-types"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a><a href="#contents:storing-primitive-data-types">Storing primitive data types</a></h4>
<p>Although our kv database is MVP-ready. Suppose we want to store data types like integer, float and string. Once the data is written in the file, the data type is lost, and everything will be treated as a string, as we are not storing any information.</p>
<p>To preserve type information, let’s store two more fields, <code>keytype</code> and <code>valuetype</code>, representing the type of data stored.</p>
<p><img src="https://bytes.zone/posts/fields-as-sets/images/bitcask-db-kv-size-type.svg" width="60%" alt="b-kv-size-type"/></p><h4 id="auditing--security"><a href="#auditing--security"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a><a href="#contents:auditing--security">Auditing &amp; Security</a></h4>
<p>For auditing and security, bitcask suggests storing 32-bit EPOC timestamp and <a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check" target="_blank" rel="noopener">CRC(Cyclic Redundancy Check)</a>, respectively. These values are generated when data is written to the file.</p>
<p>The final data format would look like something below. We would store 20 bytes of additional data for every key and value.</p>
<ul>
<li>1st 4 bytes are a 32-bit integer representing CRC.</li>
<li>The following 4 bytes are a 32-bit integer representing EPOC timestamp.</li>
<li>The following 8 bytes are two 32-bit integers representing <code>keysize</code> and <code>valuesize</code>.</li>
<li>The next 4 bytes are two 16-bit integers representing <code>keytype</code> and <code>valuetype</code>.</li>
<li>The remaining bytes are our key and value.</li>
</ul>
<p><img src="https://bytes.zone/posts/fields-as-sets/images/bitcask-db.svg" width="80%" alt="Data Format"/></p><h3 id="number-system"><a href="#number-system"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a><a href="#contents:number-system">Number System</a></h3>
<p>Computers represent data in sets of binary digits. The representation comprises bits grouped into more extensive collections, such as bytes. The first 24 bytes are unsigned integers if you notice our data format. By default, when integers are written to a file, they are not stored in binary.</p>
<p><strong>Let me explain</strong></p>
<p>Suppose we run the below code. What would be the size of the data written in the file?</p>
<div><div>
<div><table><tbody><tr><td>
<pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span><span>5
</span></code></pre></td>
<td>
<pre tabindex="0"><code data-lang="ruby"><span>File</span><span>.</span><span>open</span><span>(</span><span>&#39;sample.txt&#39;</span><span>,</span> <span>&#39;w&#39;</span><span>)</span> <span>do</span> <span>|</span><span>file</span><span>|</span>
    <span>[</span><span>1</span><span>,</span> <span>12</span><span>,</span> <span>123</span><span>,</span> <span>1234</span><span>,</span> <span>12345</span><span>,</span> <span>123456</span><span>,</span> <span>1234567</span><span>,</span> <span>12345678</span><span>].</span><span>each</span> <span>do</span> <span>|</span><span>num</span><span>|</span>
        <span>file</span><span>.</span><span>write</span><span>(</span><span>num</span><span>)</span>
    <span>end</span>
<span>end</span>
</code></pre></td></tr></tbody></table></div>
</div>
</div><p>It’s <strong>36</strong> bytes because, by default, they are written as strings where each character is 1 byte.</p>
<p>$${\textsf{ 1 + 2 + 3 + 4 + 5 + 6 + 7 + 8 = 36 bytes}}$$</p>
<p>But this could be more efficient. In our data format, we discussed that for any key and value, we would be storing 20 bytes of metadata. So we cannot keep them as strings, as it would result in a variable length field. The solution is to encode it and store it in binary format.</p>
<p>If we encoded them as 4-byte integers and stored them in binary format. The size of the file would <strong>32</strong> bytes.</p>
<p>$${\textsf{ 4 * 8 = 32 bytes}}$$</p>
<h3 id="largest-key--value-size"><a href="#largest-key--value-size"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a><a href="#contents:largest-key--value-size">Largest Key &amp; Value Size</a></h3>
<p>The largest <code>key</code> or <code>value</code> stored in file is a function of the type of integer of <code>keysize</code> or <code>valuesize</code> respectively.</p>
<p>$${\large{\mathsf{\max_{\substack{\mathsf{1&lt;x&lt;2^{x}-1}}} f(x)}}}  \textsf{where x is the size of an integer in bits}$$</p>
<p>As our <code>keysize</code> or <code>valuesize</code> are 4 bytes(32 bits) unsigned integers. The largest value of key or value that we can store is</p>
<p>$${{\mathsf{ 2^{32-1}} = \textsf{4294967295 bytes =  4.29 GB}}}$$</p>
<h3 id="stiching-everything"><a href="#stiching-everything"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a><a href="#contents:stiching-everything">Stiching Everything</a></h3>
<p>Let’s create a <code>Serializer</code> module which encapsulates serialization and deserialization logic. We need to encode our data into a binary sequence. Ruby has <a href="https://apidock.com/ruby/Array/pack" target="_blank" rel="noopener">Array.pack</a>, which packs the data into a binary sequence according to a directive. Directives inform how data should be encoded in a binary sequence. Below is the list of directives we will be using.</p>
<ol>
<li><strong>L&lt;</strong> : 32-bit unsigned integer, little endian (uint32_t)</li>
<li><strong>S&lt;</strong> : 16-bit unsigned integer, little endian (uint16_t)</li>
<li><strong>q&lt;</strong> : 64-bit signed integer, little endian (int64_t)</li>
<li><strong>E</strong>  : double-precision, little-endian</li>
</ol>
<p>All of our directives have little-endian byte order. This does not have any performance benefit. You can encode them in big-endian order as well. We specify the endianness to ensure our database file is cross-platform compatible.</p>
<div title="serializer.rb"><div>
<div><table><tbody><tr><td>
<pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span><span>25
</span><span>26
</span><span>27
</span><span>28
</span></code></pre></td>
<td>
<pre tabindex="0"><code data-lang="ruby"><span>module</span> <span>Bitcask</span>
  <span>module</span> <span>Serializer</span>

    <span>HEADER_FORMAT</span> <span>=</span> <span>&#39;L&lt;L&lt;L&lt;S&lt;S&lt;&#39;</span>
    <span>HEADER_SIZE</span> <span>=</span> <span>16</span>

    <span>CRC32_FORMAT</span> <span>=</span> <span>&#39;L&lt;&#39;</span>
    <span>CRC32_SIZE</span> <span>=</span> <span>4</span>

    <span>DATA_TYPE</span> <span>=</span> <span>{</span>
      <span>Integer</span><span>:</span> <span>1</span><span>,</span>
      <span>Float</span><span>:</span> <span>2</span><span>,</span>
      <span>String</span><span>:</span> <span>3</span>
    <span>}</span><span>.</span><span>freeze</span>

    <span>DATA_TYPE_LOOK_UP</span> <span>=</span> <span>{</span>
      <span>DATA_TYPE</span><span>[</span><span>:Integer</span><span>]</span> <span>=&gt;</span> <span>:Integer</span><span>,</span>
      <span>DATA_TYPE</span><span>[</span><span>:Float</span><span>]</span> <span>=&gt;</span> <span>:Float</span><span>,</span>
      <span>DATA_TYPE</span><span>[</span><span>:String</span><span>]</span> <span>=&gt;</span> <span>:String</span>
    <span>}</span><span>.</span><span>freeze</span>

    <span>DATA_TYPE_DIRECTIVE</span> <span>=</span> <span>{</span>
      <span>DATA_TYPE</span><span>[</span><span>:Integer</span><span>]</span> <span>=&gt;</span> <span>&#39;q&lt;&#39;</span><span>,</span>
      <span>DATA_TYPE</span><span>[</span><span>:Float</span><span>]</span> <span>=&gt;</span> <span>&#39;E&#39;</span>
    <span>}</span><span>.</span><span>freeze</span>

  <span>end</span>
<span>end</span>
</code></pre></td></tr></tbody></table></div>
</div>
</div><h4 id="serialize--deserialize"><a href="#serialize--deserialize"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a><a href="#contents:serialize--deserialize">Serialize &amp; Deserialize</a></h4>
<ol>
<li><code>serialize</code> serializes the data to our data format. It identifies the type of data, generates a header and computes crc. It returns the length of the data and the binary encoded data.</li>
<li><code>deserialize</code> does the opposite of <code>serialize</code>. It validates crc, decodes the binary encoded data and returns epoc, key and value.</li>
</ol>
<div title="serializer.rb"><div>
<div><table><tbody><tr><td>
<pre tabindex="0"><code><span>27
</span><span>28
</span><span>29
</span><span>30
</span><span>31
</span><span>32
</span><span>33
</span><span>34
</span><span>35
</span><span>36
</span><span>37
</span><span>38
</span><span>39
</span><span>40
</span><span>41
</span><span>42
</span><span>43
</span><span>44
</span><span>45
</span><span>46
</span><span>47
</span><span>48
</span><span>49
</span><span>50
</span><span>51
</span><span>52
</span><span>53
</span><span>54
</span><span>55
</span><span>56
</span><span>57
</span><span>58
</span><span>59
</span><span>60
</span><span>61
</span><span>62
</span><span>63
</span><span>64
</span><span>65
</span></code></pre></td>
<td>
<pre tabindex="0"><code data-lang="ruby"><span>module</span> <span>Bitcask</span>
  <span>module</span> <span>Serializer</span>

    <span>def</span> <span>serialize</span><span>(</span><span>epoc</span><span>:,</span> <span>key</span><span>:,</span> <span>value</span><span>:)</span>
      <span>key_type</span> <span>=</span> <span>type</span><span>(</span><span>key</span><span>)</span>
      <span>value_type</span> <span>=</span> <span>type</span><span>(</span><span>value</span><span>)</span>

      <span>key_bytes</span> <span>=</span> <span>pack</span><span>(</span><span>key</span><span>,</span> <span>key_type</span><span>)</span>
      <span>value_bytes</span> <span>=</span> <span>pack</span><span>(</span><span>value</span><span>,</span> <span>value_type</span><span>)</span>

      <span>header</span> <span>=</span> <span>serialize_header</span><span>(</span><span>epoc</span><span>:</span> <span>epoc</span><span>,</span> <span>keysz</span><span>:</span> <span>key_bytes</span><span>.</span><span>length</span><span>,</span> <span>key_type</span><span>:</span> <span>key_type</span><span>,</span> <span>value_type</span><span>:</span> <span>value_type</span><span>,</span>
                                <span>valuesz</span><span>:</span> <span>value_bytes</span><span>.</span><span>length</span><span>)</span>
      <span>data</span> <span>=</span> <span>key_bytes</span> <span>+</span> <span>value_bytes</span>

      <span>[</span><span>crc32_header_offset</span> <span>+</span> <span>data</span><span>.</span><span>length</span><span>,</span> <span>crc32</span><span>(</span><span>header</span> <span>+</span> <span>data</span><span>)</span> <span>+</span> <span>header</span> <span>+</span> <span>data</span><span>]</span>
    <span>end</span>

    <span>def</span> <span>deserialize</span><span>(</span><span>data</span><span>)</span>
      <span>return</span> <span>0</span><span>,</span> <span>&#39;&#39;</span><span>,</span> <span>&#39;&#39;</span> <span>unless</span> <span>crc32_valid?</span><span>(</span><span>desearlize_crc32</span><span>(</span><span>data</span><span>[..</span><span>crc32_offset</span> <span>-</span> <span>1</span><span>]</span><span>),</span> <span>data</span><span>[</span><span>crc32_offset</span><span>..]</span><span>)</span>

      <span>epoc</span><span>,</span> <span>keysz</span><span>,</span> <span>valuesz</span><span>,</span> <span>key_type</span><span>,</span> <span>value_type</span> <span>=</span> <span>deserialize_header</span><span>(</span><span>data</span><span>[</span><span>crc32_offset</span><span>..</span><span>crc32_header_offset</span> <span>-</span> <span>1</span><span>]</span><span>)</span>
      <span>key_bytes</span> <span>=</span> <span>data</span><span>[</span><span>crc32_header_offset</span><span>..</span><span>crc32_header_offset</span> <span>+</span> <span>keysz</span> <span>-</span> <span>1</span><span>]</span>
      <span>value_bytes</span> <span>=</span> <span>data</span><span>[</span><span>crc32_header_offset</span> <span>+</span> <span>keysz</span><span>..]</span>

      <span>[</span><span>epoc</span><span>,</span> <span>unpack</span><span>(</span><span>key_bytes</span><span>,</span> <span>key_type</span><span>),</span> <span>unpack</span><span>(</span><span>value_bytes</span><span>,</span> <span>value_type</span><span>)</span><span>]</span>
    <span>end</span>

    <span>def</span> <span>serialize_header</span><span>(</span><span>epoc</span><span>:,</span> <span>key_type</span><span>:,</span> <span>keysz</span><span>:,</span> <span>value_type</span><span>:,</span> <span>valuesz</span><span>:)</span>
      <span>[</span><span>epoc</span><span>,</span> <span>keysz</span><span>,</span> <span>valuesz</span><span>,</span> <span>DATA_TYPE</span><span>[</span><span>key_type</span><span>]</span><span>,</span> <span>DATA_TYPE</span><span>[</span><span>value_type</span><span>]].</span><span>pack</span><span>(</span><span>HEADER_FORMAT</span><span>)</span>
    <span>end</span>

    <span>def</span> <span>deserialize_header</span><span>(</span><span>header_data</span><span>)</span>
      <span>header</span> <span>=</span> <span>header_data</span><span>.</span><span>unpack</span><span>(</span><span>HEADER_FORMAT</span><span>)</span>

      <span>[</span><span>header</span><span>[</span><span>0</span><span>]</span><span>,</span> <span>header</span><span>[</span><span>1</span><span>]</span><span>,</span> <span>header</span><span>[</span><span>2</span><span>]</span><span>,</span> <span>DATA_TYPE_LOOK_UP</span><span>[</span><span>header</span><span>[</span><span>3</span><span>]]</span><span>,</span> <span>DATA_TYPE_LOOK_UP</span><span>[</span><span>header</span><span>[</span><span>4</span><span>]]]</span>
    <span>end</span>

  <span>end</span>
<span>end</span> 
</code></pre></td></tr></tbody></table></div>
</div>
</div><p>Below are a few helper functions used for packing, unpacking and generating crc.</p>
<div title="serializer.rb"><div>
<div><table><tbody><tr><td>
<pre tabindex="0"><code><span> 66
</span><span> 67
</span><span> 68
</span><span> 69
</span><span> 70
</span><span> 71
</span><span> 72
</span><span> 73
</span><span> 74
</span><span> 75
</span><span> 76
</span><span> 77
</span><span> 78
</span><span> 79
</span><span> 80
</span><span> 81
</span><span> 82
</span><span> 83
</span><span> 84
</span><span> 85
</span><span> 86
</span><span> 87
</span><span> 88
</span><span> 89
</span><span> 90
</span><span> 91
</span><span> 92
</span><span> 93
</span><span> 94
</span><span> 95
</span><span> 96
</span><span> 97
</span><span> 98
</span><span> 99
</span><span>100
</span><span>101
</span><span>102
</span><span>103
</span><span>104
</span><span>105
</span><span>106
</span><span>107
</span><span>108
</span><span>109
</span><span>110
</span><span>111
</span><span>112
</span><span>113
</span><span>114
</span><span>115
</span><span>116
</span><span>117
</span><span>118
</span><span>119
</span><span>120
</span><span>121
</span><span>122
</span><span>123
</span><span>124
</span><span>125
</span><span>126
</span></code></pre></td>
<td>
<pre tabindex="0"><code data-lang="ruby"><span>module</span> <span>Bitcask</span>
  <span>module</span> <span>Serializer</span>

    <span>def</span> <span>crc32_offset</span>
      <span>CRC32_SIZE</span>
    <span>end</span>

    <span>def</span> <span>header_offset</span>
      <span>HEADER_SIZE</span>
    <span>end</span>

    <span>def</span> <span>crc32_header_offset</span>
      <span>crc32_offset</span> <span>+</span> <span>header_offset</span>
    <span>end</span>

    <span>def</span> <span>crc32</span><span>(</span><span>data_bytes</span><span>)</span>
      <span>[</span><span>Zlib</span><span>.</span><span>crc32</span><span>(</span><span>data_bytes</span><span>)</span><span>].</span><span>pack</span><span>(</span><span>CRC32_FORMAT</span><span>)</span>
    <span>end</span>

    <span>def</span> <span>desearlize_crc32</span><span>(</span><span>crc</span><span>)</span>
      <span>crc</span><span>.</span><span>unpack1</span><span>(</span><span>CRC32_FORMAT</span><span>)</span>
    <span>end</span>

    <span>def</span> <span>crc32_valid?</span><span>(</span><span>digest</span><span>,</span> <span>data_bytes</span><span>)</span>
      <span>digest</span> <span>==</span> <span>Zlib</span><span>.</span><span>crc32</span><span>(</span><span>data_bytes</span><span>)</span>
    <span>end</span>

    <span>def</span> <span>pack</span><span>(</span><span>attribute</span><span>,</span> <span>attribute_type</span><span>)</span>
      <span>case</span> <span>attribute_type</span>
      <span>when</span> <span>:Integer</span><span>,</span> <span>:Float</span>
        <span>[</span><span>attribute</span><span>].</span><span>pack</span><span>(</span><span>directive</span><span>(</span><span>attribute_type</span><span>))</span>
      <span>when</span> <span>:String</span>
        <span>attribute</span><span>.</span><span>encode</span><span>(</span><span>&#39;utf-8&#39;</span><span>)</span>
      <span>else</span>
        <span>raise</span> <span>StandardError</span><span>,</span> <span>&#39;Invalid attribute_type for pack&#39;</span>
      <span>end</span>
    <span>end</span>

    <span>def</span> <span>unpack</span><span>(</span><span>attribute</span><span>,</span> <span>attribute_type</span><span>)</span>
      <span>case</span> <span>attribute_type</span>
      <span>when</span> <span>:Integer</span><span>,</span> <span>:Float</span>
        <span>attribute</span><span>.</span><span>unpack1</span><span>(</span><span>directive</span><span>(</span><span>attribute_type</span><span>))</span>
      <span>when</span> <span>:String</span>
        <span>attribute</span>
      <span>else</span>
        <span>raise</span> <span>StandardError</span><span>,</span> <span>&#39;Invalid attribute_type for unpack&#39;</span>
      <span>end</span>
    <span>end</span>

    <span>private</span>

    <span>def</span> <span>directive</span><span>(</span><span>attribute_type</span><span>)</span>
      <span>DATA_TYPE_DIRECTIVE</span><span>[</span><span>DATA_TYPE</span><span>[</span><span>attribute_type</span><span>]]</span>
    <span>end</span>

    <span>def</span> <span>type</span><span>(</span><span>attribute</span><span>)</span>
      <span>attribute</span><span>.</span><span>class</span><span>.</span><span>to_s</span><span>.</span><span>to_sym</span>
    <span>end</span>

  <span>end</span>
<span>end</span>
</code></pre></td></tr></tbody></table></div>
</div>
</div><h4 id="diskstore"><a href="#diskstore"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a><a href="#contents:diskstore">DiskStore</a></h4>
<p>Finally, let us create a class called <code>DiskStore</code>, our persistent key-value store. It has the following methods.</p>
<ol>
<li><strong>Get</strong> : Returns value for a given key from the store.</li>
</ol>
<div><p>
flowchart LR;
    A([get]) --&gt; C{key in </p></div>

<ol start="2">
<li><strong>Put</strong> : Write key-value into the store.</li>
</ol>
<div><p>
flowchart LR;
    A([put]) --&gt; B(generate epoc)
    B --&gt; C(serialize data)
    C --&gt; G(add to key_dir)
    G --&gt; D(write to file)
    D --&gt; E(incr write_pos </p></div>

<div title="disk_store.rb"><div>
<div><table><tbody><tr><td>
<pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span><span>25
</span><span>26
</span><span>27
</span><span>28
</span><span>29
</span><span>30
</span><span>31
</span><span>32
</span><span>33
</span><span>34
</span><span>35
</span><span>36
</span><span>37
</span><span>38
</span><span>39
</span><span>40
</span><span>41
</span><span>42
</span><span>43
</span><span>44
</span><span>45
</span><span>46
</span><span>47
</span><span>48
</span><span>49
</span><span>50
</span><span>51
</span><span>52
</span></code></pre></td>
<td>
<pre tabindex="0"><code data-lang="ruby"><span>module</span> <span>Bitcask</span>
  <span>class</span> <span>DiskStore</span>

    <span>include</span> <span>Serializer</span>

    <span>def</span> <span>initialize</span><span>(</span><span>db_file</span> <span>=</span> <span>&#39;bitcask.db&#39;</span><span>)</span>
      <span>@db_fh</span> <span>=</span> <span>File</span><span>.</span><span>open</span><span>(</span><span>db_file</span><span>,</span> <span>&#39;a+b&#39;</span><span>)</span>
      <span>@write_pos</span> <span>=</span> <span>0</span>
      <span>@key_dir</span> <span>=</span> <span>{}</span>
    <span>end</span>

    <span>def</span> <span>get</span><span>(</span><span>key</span><span>)</span>
      <span>key_struct</span> <span>=</span> <span>@key_dir</span><span>[</span><span>key</span><span>]</span>
      <span>return</span> <span>&#39;&#39;</span> <span>if</span> <span>key_struct</span><span>.</span><span>nil?</span>

      <span>@db_fh</span><span>.</span><span>seek</span><span>(</span><span>key_struct</span><span>[</span><span>:write_pos</span><span>]</span><span>)</span>
      <span>epoc</span><span>,</span> <span>key</span><span>,</span> <span>value</span> <span>=</span> <span>deserialize</span><span>(</span><span>@db_fh</span><span>.</span><span>read</span><span>(</span><span>key_struct</span><span>[</span><span>:log_size</span><span>]</span><span>))</span>

      <span>value</span>
    <span>end</span>

    <span>def</span> <span>put</span><span>(</span><span>key</span><span>,</span> <span>value</span><span>)</span>
      <span>log_size</span><span>,</span> <span>data</span> <span>=</span> <span>serialize</span><span>(</span><span>epoc</span><span>:</span> <span>Time</span><span>.</span><span>now</span><span>.</span><span>to_i</span><span>,</span> <span>key</span><span>:</span> <span>key</span><span>,</span> <span>value</span><span>:</span> <span>value</span><span>)</span>

      <span>@key_dir</span><span>[</span><span>key</span><span>]</span> <span>=</span> <span>key_struct</span><span>(</span><span>@write_pos</span><span>,</span> <span>log_size</span><span>,</span> <span>key</span><span>)</span>
      <span>persist</span><span>(</span><span>data</span><span>)</span>
      <span>incr_write_pos</span><span>(</span><span>log_size</span><span>)</span>

      <span>nil</span>
    <span>end</span>

    <span>def</span> <span>flush</span>
      <span>@db_fh</span><span>.</span><span>flush</span>
    <span>end</span>

    <span>private</span>

    <span>def</span> <span>persist</span><span>(</span><span>data</span><span>)</span>
      <span>@db_fh</span><span>.</span><span>write</span><span>(</span><span>data</span><span>)</span>
      <span>@db_fh</span><span>.</span><span>flush</span>
    <span>end</span>

    <span>def</span> <span>incr_write_pos</span><span>(</span><span>pos</span><span>)</span>
      <span>@write_pos</span> <span>+=</span> <span>pos</span>
    <span>end</span>

    <span>def</span> <span>key_struct</span><span>(</span><span>write_pos</span><span>,</span> <span>log_size</span><span>,</span> <span>key</span><span>)</span>
      <span>{</span> <span>write_pos</span><span>:</span> <span>write_pos</span><span>,</span> <span>log_size</span><span>:</span> <span>log_size</span><span>,</span> <span>key</span><span>:</span> <span>key</span> <span>}</span>
    <span>end</span>

  <span>end</span>
<span>end</span>
</code></pre></td></tr></tbody></table></div>
</div>
</div><h3 id="closing-thoughts"><a href="#closing-thoughts"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a><a href="#contents:closing-thoughts">Closing thoughts</a></h3>
<p>To avoid overloading you folks with too much data, I have left out a few things from the article. The next improvement that you should be thinking about is <strong>How to initialize the DiskStore with a pre-existing data file?</strong></p>
<p>You can implement it in the language of your choice. If you are blocked anywhere, check out the complete working code at <strong><a href="https://github.com/dineshgowda24/bitcask-rb" target="_blank" rel="noopener">https://github.com/dineshgowda24/bitcask-rb</a></strong>. It has implementations for initializing the <code>DiskStore</code> with a pre-existing data file and benchmarks if you are interested in any of those.</p>
<p><em>Happy implementing your own KV store!</em></p>

            </div>

            


        </article>

        

        
    <p>

<svg xmlns="http://www.w3.org/2000/svg" width="130" height="20"><linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"></stop><stop offset="1" stop-opacity=".1"></stop></linearGradient><clipPath id="a"><rect width="130" height="20" rx="3" fill="#fff"></rect></clipPath><g clip-path="url(#a)"><path d="M0 0h55v20H0z"></path><path d="M55 0h75v20H55z"></path><path fill="url(#b)" d="M0 0h130v20H0z"></path></g><g fill="#fff" text-anchor="middle" font-size="110"><text x="285" y="150" fill="#010101" fill-opacity=".3" textLength="450" transform="scale(.1)">updated</text><text x="285" y="140" textLength="450" transform="scale(.1)">updated</text><text x="915" y="150" fill="#010101" fill-opacity=".3" textLength="650" transform="scale(.1)">2023-02-15</text><text x="915" y="140" textLength="650" transform="scale(.1)">2023-02-15</text></g></svg></p>



        


        




        
    
    
        
    



        
    
        
    



        


        


        
    
        
        
    
    
    
    
        
    



        
    

        

        
            
            
            
        

        

        

        
    



    </div>
</div></div>
  </body>
</html>
