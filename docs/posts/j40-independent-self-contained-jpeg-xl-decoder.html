<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/lifthrasiir/j40">Original</a>
    <h1>J40: Independent, self-contained JPEG XL decoder</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto"><strong>J40</strong> (Jay-forty) is a decoder for ISO/IEC 18181 <a href="https://en.wikipedia.org/wiki/JPEG_XL" rel="nofollow">JPEG XL</a> image format.
It intends to be a fully compatible reimplementation to the reference implementation, <a href="https://github.com/libjxl/libjxl/">libjxl</a>,
and also serves as a verification that the specification allows for
an independent implementation besides from libjxl.</p>
<p dir="auto">J40 is a <a href="https://github.com/nothings/single_file_libs">single-file C99 library with zero dependencies</a>,
making it trivial to insert to your project and dependencies.
It is also a public domain software and can be used for absolutely every purpose.</p>
<p dir="auto"><em><strong>As of version 2270 (2022-09), J40 is a highly experimental software.</strong>
Expect breakage, bug and <a href="#format-support">incomplete format support</a>.
In order to discourage accidental uses, you need to define an additional macro for now.</em></p>
<h2 dir="auto"><a id="user-content-quick-start" aria-hidden="true" href="#quick-start"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Quick Start</h2>
<p dir="auto">The following is a simple but complete converter from JPEG XL to <a href="http://netpbm.sourceforge.net/doc/pam.html" rel="nofollow">Portable Arbitrary Map</a> format,
and covers all the currently available API functions.</p>
<div dir="auto" data-snippet-clipboard-copy-content="#define J40_IMPLEMENTATION // only a SINGLE file should have this
#include &#34;j40.h&#34; // you also need to define a macro for experimental versions; follow the error.
#include &lt;stdio.h&gt;
#include &lt;stdarg.h&gt; // for va_*

static int oops(const char *fmt, ...) {
    va_list args;
    va_start(args, fmt);
    vfprintf(stderr, fmt, args);
    va_end(args);
    return 1;
}

int main(int argc, char **argv) {
    if (argc &lt; 3) return oops(&#34;Usage: %s input.jxl output.pam\n&#34;, argv[0]);

    FILE *out = fopen(argv[2], &#34;wb&#34;);
    if (!out) return oops(&#34;Error: Cannot open an output file.\n&#34;);

    j40_image image;
    j40_from_file(&amp;image, argv[1]); // or: j40_from_memory(&amp;image, buf, bufsize, freefunc);
    j40_output_format(&amp;image, J40_RGBA, J40_U8X4);

    // JPEG XL supports animation, so `j40_next_frame` calls can be called multiple times
    if (j40_next_frame(&amp;image)) {
        j40_frame frame = j40_current_frame(&amp;image);
        j40_pixels_u8x4 pixels = j40_frame_pixels_u8x4(&amp;frame, J40_RGBA);
        fprintf(out,
            &#34;P7\n&#34;
            &#34;WIDTH %d\n&#34;
            &#34;HEIGHT %d\n&#34;
            &#34;DEPTH 4\n&#34;
            &#34;MAXVAL 255\n&#34;
            &#34;TUPLTYPE RGB_ALPHA\n&#34;
            &#34;ENDHDR\n&#34;,
            pixels.width, pixels.height);
        for (int y = 0; y &lt; height; ++y) {
            fwrite(j40_row_u8x4(pixels, y), 4, pixels.width, out);
        }
    }

    // J40 stops once the first error is encountered; its error can be checked at the very end
    if (j40_error(&amp;image)) return oops(&#34;Error: %s\n&#34;, j40_error_string(&amp;image));
    if (ferror(out)) return oops(&#34;Error: Cannot fully write to the output file.\n&#34;);

    j40_free(&amp;image); // also frees all memory associated to j40_frame etc.
    fclose(out);
    return 0;
}"><pre>#<span>define</span> <span>J40_IMPLEMENTATION</span> <span><span>//</span> only a SINGLE file should have this</span>
#<span>include</span> <span><span>&#34;</span>j40.h<span>&#34;</span></span> <span><span>//</span> you also need to define a macro for experimental versions; follow the error.</span>
#<span>include</span> <span><span>&lt;</span>stdio.h<span>&gt;</span></span>
#<span>include</span> <span><span>&lt;</span>stdarg.h<span>&gt;</span></span> <span><span>//</span> for va_*</span>

<span>static</span> <span>int</span> <span>oops</span>(<span>const</span> <span>char</span> *fmt, ...) {
    <span>va_list</span> args;
    <span>va_start</span>(args, fmt);
    <span>vfprintf</span>(stderr, fmt, args);
    <span>va_end</span>(args);
    <span>return</span> <span>1</span>;
}

<span>int</span> <span>main</span>(<span>int</span> argc, <span>char</span> **argv) {
    <span>if</span> (argc &lt; <span>3</span>) <span>return</span> <span>oops</span>(<span><span>&#34;</span>Usage: <span>%s</span> input.jxl output.pam<span>\n</span><span>&#34;</span></span>, argv[<span>0</span>]);

    FILE *out = <span>fopen</span>(argv[<span>2</span>], <span><span>&#34;</span>wb<span>&#34;</span></span>);
    <span>if</span> (!out) <span>return</span> <span>oops</span>(<span><span>&#34;</span>Error: Cannot open an output file.<span>\n</span><span>&#34;</span></span>);

    j40_image image;
    <span>j40_from_file</span>(&amp;image, argv[<span>1</span>]); <span><span>//</span> or: j40_from_memory(&amp;image, buf, bufsize, freefunc);</span>
    <span>j40_output_format</span>(&amp;image, J40_RGBA, J40_U8X4);

    <span><span>//</span> JPEG XL supports animation, so `j40_next_frame` calls can be called multiple times</span>
    <span>if</span> (<span>j40_next_frame</span>(&amp;image)) {
        j40_frame frame = <span>j40_current_frame</span>(&amp;image);
        j40_pixels_u8x4 pixels = <span>j40_frame_pixels_u8x4</span>(&amp;frame, J40_RGBA);
        <span>fprintf</span>(out,
            <span><span>&#34;</span>P7<span>\n</span><span>&#34;</span></span>
            <span><span>&#34;</span>WIDTH <span>%d</span><span>\n</span><span>&#34;</span></span>
            <span><span>&#34;</span>HEIGHT <span>%d</span><span>\n</span><span>&#34;</span></span>
            <span><span>&#34;</span>DEPTH 4<span>\n</span><span>&#34;</span></span>
            <span><span>&#34;</span>MAXVAL 255<span>\n</span><span>&#34;</span></span>
            <span><span>&#34;</span>TUPLTYPE RGB_ALPHA<span>\n</span><span>&#34;</span></span>
            <span><span>&#34;</span>ENDHDR<span>\n</span><span>&#34;</span></span>,
            pixels.<span>width</span>, pixels.<span>height</span>);
        <span>for</span> (<span>int</span> y = <span>0</span>; y &lt; height; ++y) {
            <span>fwrite</span>(<span>j40_row_u8x4</span>(pixels, y), <span>4</span>, pixels.<span>width</span>, out);
        }
    }

    <span><span>//</span> J40 stops once the first error is encountered; its error can be checked at the very end</span>
    <span>if</span> (<span>j40_error</span>(&amp;image)) <span>return</span> <span>oops</span>(<span><span>&#34;</span>Error: <span>%s</span><span>\n</span><span>&#34;</span></span>, <span>j40_error_string</span>(&amp;image));
    <span>if</span> (<span>ferror</span>(out)) <span>return</span> <span>oops</span>(<span><span>&#34;</span>Error: Cannot fully write to the output file.<span>\n</span><span>&#34;</span></span>);

    <span>j40_free</span>(&amp;image); <span><span>//</span> also frees all memory associated to j40_frame etc.</span>
    <span>fclose</span>(out);
    <span>return</span> <span>0</span>;
}</pre></div>
<p dir="auto">Alternatively, you can use a <code>dj40</code> executable to convert a JPEG XL file into a PNG file,
which can be built as follows:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# if your system has make:
$ make

# otherwise, do the equivalent of:
$ cc -O3 dj40.c -o dj40"><pre># <span><span>if</span> your system has make:</span>
$ <span>make</span>

# <span>otherwise, <span>do</span> the equivalent of:</span>
$ <span>cc -O3 dj40.c -o dj40</span></pre></div>
<h2 dir="auto"><a id="user-content-format-support" aria-hidden="true" href="#format-support"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Format Support</h2>
<p dir="auto">As of version 2270, J40 can decode:</p>
<ul dir="auto">
<li>Any image encoded with <a href="https://github.com/libjxl/libjxl/tree/main/experimental/fast_lossless">fjxl</a>, or</li>
<li>Most images encoded with <a href="https://github.com/libjxl/libjxl/">cjxl</a> containing...
<ul dir="auto">
<li>No animations or previews</li>
<li>No image features (<code>--dots</code> and <code>--patches</code>), which implies:
<ul dir="auto">
<li>Efforts (<code>-e</code>) up to 6</li>
<li>For lossy compression, target distance (<code>-d</code>) less than 3.0</li>
</ul>
</li>
<li>No progressive encoding (<code>-p</code>)</li>
<li>No lossless JPEG transcoding in use (can be disabled with <code>-j</code>)</li>
<li>No floating point samples</li>
</ul>
</li>
</ul>
<p dir="auto">There are some known cases where J40 and libjxl can significantly diverge:</p>
<ul dir="auto">
<li>Restoration filters (<code>--epf</code>, <code>--gaborish</code>) are currently ignored.</li>
<li>Crop retangles are currently ignored and can reveal a frame larger than the actual image.</li>
<li>ICC profiles are only decoded to the point that the actual image can be decoded.</li>
</ul>
</article>
          </div></div>
  </body>
</html>
