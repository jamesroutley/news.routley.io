<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://yaky.dev/2025-11-30-self-hosting-matrix/">Original</a>
    <h1>Self-hosting a Matrix server for 5 years</h1>
    
    <div id="readability-page-1" class="page"><div>
<div>

<p>Experiences with the Matrix protocol, Matrix Synapse server, bridges, and Element mobile apps.</p>
<p>I have been hosting a Matrix server for about five years now, mostly for text chats between a few relatives and close friends, and a bridge to WhatsApp for a few more people. These are my experiences. </p>

<h2 id="Matrix_protocol">Matrix protocol</h2>
<p>I don&#39;t have many thoughts on the protocol itself.</p>
<p>The only thing that I don&#39;t really understand is the decision on data replication. If a user on server A joins a room on server B, recent room data is copied from server B to server A and then kept in sync on both servers. I suppose this reduces the load on the original server at the expense of federation overhead and space on other servers. However, this also creates a situation where anything said across federation cannot be unsaid, which is an ironic situation for a protocol/system that often comes up when talking about privacy.</p>
<p>IIRC, fediverse/ActivityPub uses a similar approach.</p>

<h2 id="Synapse_server">Synapse server</h2>
<p>Synapse is the only choice that supports bridges, which was why I wanted to try Matrix in the first place. And back in 2019-2020 this was the only choice anyway.</p>
<p>As of right now, I run Synapse, PostgreSQL, and coturn directly, without containerization, on a small VPS.</p>
<h3 id="Works_well">Works well</h3>
<p>Works fairly reliably, supports bridges, and is more efficient that it was in 2020. </p>
<p>API is well documented, and allows authenticating and sending (unencrypted) messages via simple HTTP calls. At some point in time, I wanted to write a simple shell client to use with SXMO and such.</p>
<h3 id="Does_not_have_an_admin_panel">Does not have an admin panel</h3>
<p>There is no admin page or panel. There was a third-party admin site, but it&#39;s an entire site just for making HTTP calls. So I ended up writing my own. </p>
<p><a href="https://yaky.dev/apps/simple-synapse-admin">My Simple Synapse Admin page</a></p>
<p>(Nowadays, the ESS deployment includes developer-made admin, see Future section)</p>
<h3 id="Requires_PostgreSQL">Requires PostgreSQL</h3>
<p>While technically, Synapse can work with a sqlite database (and which at first seems like an OK choice for having &lt;10 users on the server), it WILL become corrupted. So PostgreSQL is de-facto mandatory.</p>
<p>(Already a part of new ESS)</p>
<h3 id="Requires_federation">Requires federation</h3>
<p>Initial setup presumes that the server is going to be federated, and there is no good way to turn it off. The best workaround involves a blank whitelist of federated servers.</p>
<p><a href="https://github.com/matrix-org/synapse/issues/6401">GitHub issue: Single config option to disable federation</a></p>
<p>I don&#39;t know the implications of disabling it.</p>
<h3 id="Needs_constant_cleanup">Needs constant cleanup</h3>
<p>Message retention policy can be set up server-wide, but also per-room. There are specific lines in the configuration that need to be set to actually enable a service that runs the cleanup.</p>
<p>Synapse keeps the room even after all of the members leave it, including federated rooms. This results in many (sometimes large) rooms without local members orphaned on the server, taking up database space.</p>
<p>Deleting messages (events) with attachments does not delete the attachment (because another message might refer to it?), which means that the sent files continue existing on the server indefinitely. Another privacy implication. A simple &#34;delete all files older than X&#34; script works great until it deletes avatars. So yeah, seems like this is something that should be handled by the Synapse server instead of cobbled-together scripts.</p>
<p>Even after extensive cleanup, PostgreSQL database might need to be vacuumed to reduce the disk space it takes up.</p>
<h3 id="Database_grows_out_of_control">Database grows out of control</h3>
<p>Even for my small server with &lt;10 active users, database size reached several gigabytes.</p>
<p>Synapse keeps track of room states in an append-only (!) table named state_groups_state. Deleting a room does not delete the state_groups_state records. So it is never automatically cleaned up, and grows in size infinitely. It is possible to delete many of those records from the database directly, and Element (the company) provides some tool to &#34;compress&#34; those records, but again, something that should be handled by the server.</p>
<p><a href="https://www.sequentialread.com/matrix-synapse-out-of-disk-space-state_groups_state/">Good article about state_groups_state</a></p>
<h3 id="Users_cannot_be_deleted">Users cannot be deleted</h3>
<p>This is simply not an option in the API. Server admin can perform a &#34;deactivate&#34; (disable login) and &#34;erase&#34; (remove related data, which claims to be GDPR-compliant) on user accounts, but the accounts themselves stay on the server forever.</p>
<p>Wait, what? Why?</p>
<p>How this not considered a GDPR violation is a mystery to me. Even on my tiny server, I have users who use their first name as their ID and bridged WhatsApp users that use phone numbers as IDs.</p>
<p><a href="https://github.com/matrix-org/synapse/issues/1707">GitHub issue</a></p>
<h3 id="Future">Future</h3>
<p>While Matrix-Element ecosystem has been catering towards government and corporate entities for some time, there have been multiple recent announcements about its future.</p>
<p>Specifically, Element (the company) is now providing an all-in-one Element Server Suite (ESS) to replace the current setup, including</p>
<p><a href="https://element.io/en/server-suite/community">ESS Community</a></p>
<blockquote>It is intended for non-professional use, evaluations, and small to mid-sized deployments (1–100 users). </blockquote>
<p>ESS Community includes 7 components/services, now requires a minimum of 2 CPUs, 2GB of RAM, and runs using... Kubernetes? IMO, this is an overkill for dozen users.</p>
<p>For comparison, Snikket, an all-in-one solution with similar functionality using XMPP, requires a single CPU and 128MB (!) RAM for 10 or so users.</p>
<p>Yes, I have seen the ansible setup script setup recommended, but at this point, making setup easier does not address the issue of extra services being required in the first place.</p>
<p><a href="https://github.com/spantaleev/matrix-docker-ansible-deploy">Matrix server setup using Ansible and Docker</a></p>
<p>Also, the ESS handles account creation and calls in an entirely different way, more on that later.</p>

<h2 id="Matrix_WhatsApp_bridge">Matrix-WhatsApp bridge</h2>
<p>Pretty great. Easy to install and set up, works really well, and needs only occasional (semi-yearly or so) updates when WhatsApp changes their web API. Does not support calls.</p>

<h2 id="Element_Classic">Element Classic</h2>
<h3 id="Same_on_all_platforms">Same on all platforms</h3>
<p>Element exists and looks consistent on Android, iOS, and web, making it easier for regular users and for troubleshooting.</p>
<h3 id="No_image_captions">No image captions</h3>
<p>This is silly, but while (official?) bridges support image captions, official Element app does not. The answer in the FAQ? Get a better app. Well, OK.</p>
<p><img src="https://yaky.dev/2025-11-30-self-hosting-matrix/el_no_caption.png" alt="el_no_caption.png"/></p>
<p>No image caption in Element Classic.</p>
<p><img src="https://yaky.dev/2025-11-30-self-hosting-matrix/el_caption.png" alt="el_caption.png"/></p>
<p>Image with a caption in SchildiChat Classic (the better app).</p>
<h3 id="Slow_notifications">Slow notifications</h3>
<p>Sometimes it can take up to a few minutes to get a message, even between two Android clients using Google Cloud Messaging. Sometimes it is nearly instant. Still unsure of the cause.</p>
<h3 id="No_offline_indication">No offline indication</h3>
<p>One unreliable way to tell that the server is unreachable is the endless loading bar. But even then, it eventually goes away without indicating any errors.</p>
<p>Then, when sending a message, the user receives &#34;Unable to send message&#34;. Frustration ensues.</p>
<p>But I know the app is trying to call the /sync endpoint. Why doesn&#39;t it show any errors when that fails?</p>
<h3 id="Security_key_and_device_verification">Security key and device verification</h3>
<p>IIRC the first thing the app does is ask user to back up their signing keys and enter the key password, without a simple explanation. Not a great experience for regular users.</p>
<p>Some people reported issues with Element losing its keys or frequently requesting to be re-verified. Thankfully I have not encountered these.</p>
<h3 id="Third_party_services">Third-party services</h3>
<p>Even if you connect to a self-hosted server, Element Classic could attempt to connect to vector.im integration server and matrix.org key backup server.</p>

<h2 id="Element_X">Element X</h2>
<p>Element X is now recommended as the new and better client. It is not.</p>
<h3 id="Slower">Slower</h3>
<p>Somehow, it is slower. Clicking on a conversation takes 0.5-1.0 seconds to load it, compared to almost instant load on Classic.</p>
<p>Perhaps it does work better for accounts with many large rooms, but that is not my case.</p>
<h3 id="Sorting">Sorting</h3>
<p>Conversations are sorted by... who knows. It is not recent nor alphabetical.</p>
<h3 id="No_background_sync">No background sync</h3>
<p>Element X does not support periodic background sync, so you need to set up ntfy or something similar to use Element X on a de-googled device. Seems like a simple enough fail-safe (even WhatsApp does this), but it was dropped for some reason.</p>
<p><img src="https://yaky.dev/2025-11-30-self-hosting-matrix/elx_no_distributors_available.png" alt="elx_no_distributors_available.png"/></p>
<h3 id="Requires__sliding_sync__option_on_the_server">Requires &#34;sliding sync&#34; option on the server</h3>
<p>This &#34;sliding sync&#34; option is available only for newer Synapse versions, and only if running with PostgreSQL database (which should already be the case - see above). Probably not an issue unless the user tries to connect Element X to an outdated Synapse.</p>
<h3 id="Calls_are_not_backward_compatible">Calls are not backward compatible</h3>
<p>Calling with Element X requires Element Call (part of ESS). This supports group calls, but... only video calls at the moment.</p>
<p><img src="https://yaky.dev/2025-11-30-self-hosting-matrix/elx_call_is_not_supported.png" alt="elx_call_is_not_supported.png"/></p>
<p>You also might be asked to tell your contact to install the new app:</p>
<p><img src="https://yaky.dev/2025-11-30-self-hosting-matrix/elx_unsupported_call.png" alt="elx_unsupported_call.png"/></p>
<p>I don&#39;t regularly use calls, but some people I would like to invite to my server would want to use them.</p>

<h2 id="Onboarding_is_bad">Onboarding is bad</h2>
<p>A few years ago, I ended up either temporarily enabling unrestricted registration (a terrible idea), or creating my users&#39; accounts manually, because the &#34;invite&#34; matrix.to link was broken, and registration tokens did not work correctly in mobile apps.</p>
<p>So let&#39;s see how it works now. Keep in mind, I am still on standalone Synapse, not ESS.</p>
<h3 id="Element_X_onboarding">Element X onboarding</h3>
<p>I am a user, and I was to register an account on my friend&#39;s server. I see that Element X is now a recommended app, so let&#39;s try that.</p>
<p><img src="https://yaky.dev/2025-11-30-self-hosting-matrix/elx_00.png" alt="elx_00.png"/></p>
<p>Click &#34;Create account&#34; (which is a different style that does not look like a button for some reason).</p>
<p><img src="https://yaky.dev/2025-11-30-self-hosting-matrix/elx_01.png" alt="elx_01.png"/></p>
<p>But I want an account on a different server. Click &#34;Change account provider&#34;.</p>
<p><img src="https://yaky.dev/2025-11-30-self-hosting-matrix/elx_02.png" alt="elx_02.png"/></p>
<p>Click &#34;Other&#34;.</p>
<p><img src="https://yaky.dev/2025-11-30-self-hosting-matrix/elx_03.png" alt="elx_03.png"/></p>
<p>Now I can search for the server my friend is hosting, and it should appear in the list below the search. </p>
<p>As server admin: I do not remember if Synapse server has to enable/keep federation for this to work.</p>
<p><img src="https://yaky.dev/2025-11-30-self-hosting-matrix/elx_04.png" alt="elx_04.png"/></p>
<p>Yes! That is what I want, why is this so verbose?</p>
<p><img src="https://yaky.dev/2025-11-30-self-hosting-matrix/elx_05.png" alt="elx_05.png"/></p>
<p>WTF. So Element X cannot create even the simplest username+password account. That is all I want, I don&#39;t want to sign in with Google, Apple, or any other form of third-party authentication.</p>
<h3 id="Element_Classic_onboarding">Element Classic onboarding</h3>
<p>I was unable to register an account using Element X, so Element Classic should work better.</p>
<p><img src="https://yaky.dev/2025-11-30-self-hosting-matrix/elc_00.png" alt="elc_00.png"/></p>
<p>Ok, &#34;CREATE ACCOUNT&#34;.</p>
<p><img src="https://yaky.dev/2025-11-30-self-hosting-matrix/elc_01.png" alt="elc_01.png"/></p>
<p>What difference does this make? Skip.</p>
<p><img src="https://yaky.dev/2025-11-30-self-hosting-matrix/elc_02.png" alt="elc_02.png"/></p>
<p>The current official app is telling me to use Element X. Just tried that. Click &#34;EDIT&#34; where it says &#34;matrix.org&#34; (which does not say &#34;server&#34;, actually) and enter the server name.</p>
<p><img src="https://yaky.dev/2025-11-30-self-hosting-matrix/elc_03.png" alt="elc_03.png"/></p>
<p>Why not? No explanation. Sure, I&#39;ll use a web client.</p>
<p><img src="https://yaky.dev/2025-11-30-self-hosting-matrix/elc_04.png" alt="elc_04.png"/></p>
<p>Well, fuck me, I guess. Why can&#39;t I just create an account?</p>
<p>As a server admin: Synapse is set to allow registrations via registration tokens, because unrestricted registration is a bad idea. I did not find where the /static/client/register path is set.</p>
<p>IIRC it is possible to register an account by going to a web-hosted Element app, such as app.element.io, which will allow to register an account using a registration token. But then the user has to deal with the headache of cross-verifying their mobile device to the web app (which they might never use).</p>

<h2 id="So_now_what_">So now what?</h2>
<p>Matrix-Element is growing, building new features, and acquiring large customers (mostly government entities AFAIK). However, the new corporatesque ESS Community is not worth it in my opinion. I don&#39;t need fancy auth, third-party IDs, group video conferencing, or even federation for that matter. But it is clear that Synapse and Element X are severely crippled and are not designed to work without these services.</p>
<p>I will probably switch to Snikket, which is more efficient, has timely notifications, and very smooth onboarding.</p>
<p><a href="https://snikket.org/">Snikket</a></p>

<h2 id="Who_cares_">Who cares?</h2>
<p>¯\_(ツ)_/¯</p>
<br/>
</div>
</div></div>
  </body>
</html>
