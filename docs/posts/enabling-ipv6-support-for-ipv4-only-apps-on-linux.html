<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://pavel.network/enabling-ipv6-support-for-ipv4-only-apps-on-linux/">Original</a>
    <h1>Enabling IPv6 support for IPv4 only apps on Linux</h1>
    
    <div id="readability-page-1" class="page"><div id="gh-main">
    <article>
        <header>
                <span>
                    By <a href="https://pavel.network/author/pavel/">Pavel Odintsov</a>
                    —
                    <time datetime="2023-05-01">May 1, 2023</time>
                </span>

            


        </header>

        <div>
            <p>To prove point that IPv6 is ready for production use I&#39;ve been using IPv6 only setup on my Ubuntu PC for more then 4 months. To access legacy IPv4 Internet I use NAT64 gateway based on <a href="http://www.litech.org/tayga/?ref=pavel.network">Tayga</a> deployed on <a href="https://pine64.com/product-category/rockpro64/?ref=pavel.network">RockPro64</a> SBC in my cupboard:</p><figure><img src="https://pavel.network/content/images/2023/05/image.png" alt="" loading="lazy" width="337" height="212"/><figcaption>RockPro64 is ARM64 based SBC with dedicated 1G Ethernet and PCI-E slot</figcaption></figure><p>Most of the apps I use support IPv6 but there are some cases when lack of IPv4 connectivity on my machine negatively affects experience. </p><p>One of the cases which affects my daily experience is a constant need to manually prepend IPv4 addresses for ssh as direct attempt to use ssh with IPv4 literal address fails:</p><blockquote>ssh 1.3.3.7</blockquote><p>Instead I have to append my IPv6 NAT64 prefix all the time:</p><blockquote>ssh 64:ff9b::1.3.3.7</blockquote><p>Luckily for us Linux provides exceptionally easy way to intercept some specific library functions using simple dynamically linked library: LD_PRELOAD</p><figure><img src="https://pavel.network/content/images/2023/05/Screenshot-from-2023-05-01-14-39-50.png" alt="" loading="lazy" width="1333" height="194" srcset="https://pavel.network/content/images/size/w600/2023/05/Screenshot-from-2023-05-01-14-39-50.png 600w, https://pavel.network/content/images/size/w1000/2023/05/Screenshot-from-2023-05-01-14-39-50.png 1000w, https://pavel.network/content/images/2023/05/Screenshot-from-2023-05-01-14-39-50.png 1333w" sizes="(min-width: 720px) 720px"/><figcaption>LD_PRELOAD allows us to override some functions with our own logic</figcaption></figure><p>When app needs to connect to the network it uses Linux system functions such as <a href="https://man7.org/linux/man-pages/man2/socket.2.html?ref=pavel.network">socket</a>(), <a href="https://man7.org/linux/man-pages/man2/connect.2.html?ref=pavel.network">connect</a>(), <a href="https://man7.org/linux/man-pages/man2/getpeername.2.html?ref=pavel.network">getpeername</a>(), <a href="https://man7.org/linux/man-pages/man2/getsockname.2.html?ref=pavel.network">getsockname</a>() and by overriding them with functions which explicitly transform all IPv4 connection attempts to connections to special IPv6 address crafted using NAT64 prefix. Which this approach in hands we can automatically add IPv6 support for such apps without. </p><p>That&#39;s exactly how tool called <a href="https://github.com/andrewshadura/tnat64?ref=pavel.network">tnat64</a> works. You can find this tool in Debian or Ubuntu official repositories and installation is as easy as follow:</p><blockquote>sudo apt install -y tnat64</blockquote><p>This tools provides single dynamic library available on following path: /usr/lib/tnat64/libtnat64.so.</p><p>To enable it for specific session in Terminal we need to run following commands:</p><blockquote>export LD_PRELOAD=/usr/lib/tnat64/libtnat64.so TNAT64_DEBUG=10 TNAT64_DEBUG_FILE=/tmp/tnat64.log</blockquote><p>The only mandatory part here is: LD_PRELOAD, TNAT64_DEBUG and TNAT64_DEBUG_FILE just enable debugging to provide more information how this library  works.</p><p>After that when you run any app in same Terminal session it will load libtnat64.so first and then all calls to network functions will be intercepted and as consequence any attempt to connect to IPv4 literal will work just fine even on machine without external IPv4 connectivity:</p><blockquote>ssh 1.3.3.7</blockquote><p>I would recommend using this apporach only for apps with clear IPv6 support issues. Attempts to enable this logic may lead to some issues as some apps may not like such tricks with syscalls. </p><p>To get more information about runtime activity of <strong>tnat64</strong> you can check content of it&#39;s log file /tmp/tnat64.log:</p><figure><img src="https://pavel.network/content/images/2023/05/image-1.png" alt="" loading="lazy" width="1895" height="479" srcset="https://pavel.network/content/images/size/w600/2023/05/image-1.png 600w, https://pavel.network/content/images/size/w1000/2023/05/image-1.png 1000w, https://pavel.network/content/images/size/w1600/2023/05/image-1.png 1600w, https://pavel.network/content/images/2023/05/image-1.png 1895w" sizes="(min-width: 720px) 720px"/><figcaption>tnat64 log file</figcaption></figure><p>I would like to say thank you for this awesome tool to author of it <a href="https://shadura.me/?ref=pavel.network">Andrej Shadura</a>. </p><p>Just for historical perspective this tool was written around 2011.</p><p>Our current success with IPv6 deployment is a result of two decades of colossal amount of work from incredible number of very talented engineers. </p>
        </div>

            

            
    </article>
</div></div>
  </body>
</html>
