<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/UbuntuGrubUpdateConfusion">Original</a>
    <h1>It&#39;s far from clear how grub package updates work on Ubuntu</h1>
    
    <div id="readability-page-1" class="page"><div><h2>It&#39;s far from clear how grub package updates work on Ubuntu</h2>

	<p><small>April 10, 2024</small></p>
</div><div><p>Recently <a href="https://mastodon.social/@cks/112237487766533967">I ran across (and eventually reported) an issue on
pre-beta Ubuntu 24.04 where a grub package update would fail for
systems with software RAID root disks and BIOS MBR booting</a>. The specific
error was that grub-install could not install the new version of
GRUB&#39;s boot-time code on &#39;/dev/md0&#39;, the (nominal) device of the
root filesystem, reporting an error to the effect of:</p>


<blockquote><pre>grub-install: warning: File system `ext2&#39; doesn&#39;t support embedding.
grub-install: warning: Embedding is not possible. GRUB can only be installed in this setup by using blocklists. However, blocklists are UNRELIABLE and their use is discouraged..
grub-install: error: diskfilter writes are not supported.
  grub-install failure for /dev/md0
</pre>
</blockquote>

<p>(You can work around this by reconfiguring the grub package to use
the underlying disk devices, either by doing &#39;<code>dpkg-reconfigure
grub-pc</code>&#39; or by installing package updates in a manner where dpkg
is allowed to ask you questions. Also, this is another case of
<a href="https://utcc.utoronto.ca/~cks/space/blog/linux/GrubUnknownFilesystemWhy">grub-install having unclear error messages</a>.)</p>

<p>One of the puzzling things about this entire situation is that the
exact same configuration works on Ubuntu 22.04 and there are no
obvious differences between 22.04 and 24.04 here. For instance,
there are <a href="https://en.wikipedia.org/wiki/Debian_configuration_system">debconf</a> keys
for what the root filesystem device is and they are exactly the
same between 22.04 and 24.04:</p>

<blockquote><pre>; debconf-show grub-pc
[...]
* grub-pc/install_devices: /dev/disk/by-id/md-name-ubuntu-server:0
</pre>
</blockquote>

<p>At this point you might guess (as I did) that &#39;grub-install /dev/md0&#39;
works on Ubuntu 22.04. However, it does not; it fails with the same
error as in 24.04. So presumably how grub-install is invoked during
package updates is different between 22.04 and 24.04.</p>

<p>As far as I can tell, the &#39;grub-pc&#39; package runs grub-install from
its &#39;postinst&#39; script, which you can find in
/var/lib/dpkg/info/grub-pc.postinst. If you take a look at this
script, you can see that it&#39;s a rather complex script that is quite
embedded into the general Debian package update and debconf framework.
If there are ways to run it as a standalone script so that you can
understand what it&#39;s doing, those ways aren&#39;t at all obvious.  It&#39;s
also not obvious how the script is making or not making decisions,
and the 22.04 and 24.04 versions seem pretty similar. Nor does
scanning and searching either version of the script provide any
smoking guns in the form of, for example, mentions of &#39;md-&#39;.</p>

<p>(You have to know a reasonable amount about dpkg to even find
/var/lib/dpkg/info and know that the &#39;grub-pc.postinst&#39; file
is what you&#39;re looking for. The dpkg manual page does mention
that packages can have various scripts associated with them.)</p>

<p>All of this adds up to something that&#39;s almost impossible for
ordinary people to troubleshoot or debug. All we can readily determine
is that this worked in Ubuntu 20.04 LTS and 22.04 LTS, and doesn&#39;t
work in the pre-beta 24.04 (and probably not in the beta 24.04, and
most likely not in the released 24.04). The mechanisms of it working
and not working are opaque, buried inside several layers of black
boxes.</p>

<p>Part of this opacity is that it&#39;s not even clear what Ubuntu&#39;s grub
package does or is supposed to do on package update. If you run a
UEFI system with mirrored system disks, for example, you may be a
little bit surprised to find out that <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/Ubuntu2204MultiDiskUEFI">Ubuntu&#39;s grub is probably
quietly updating all your EFI system partitions</a>
when it does package updates.</p>

<p>PS: after much delving into things using various tools and the fact
that I have various scratch virtual machines available, I now believe
that the answer is that <a href="https://mastodon.social/@cks/112250021179300881">Ubuntu 20.04 and 22.04 don&#39;t run grub-install
at all when the grub package (for MBR booting) is updated</a>. This fact is
casually semi-disguised in the 20.04 and 22.04 grub-pc postinst
script. Presumably the 20.04 and 22.04 server installer should have
set &#39;grub-pc/install_devices&#39; to a different value, but that problem
was being covered up by grub-install normally not running and using
that value.</p>
</div></div>
  </body>
</html>
