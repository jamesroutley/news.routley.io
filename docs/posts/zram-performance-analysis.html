<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://notes.xeome.dev/notes/Zram">Original</a>
    <h1>Zram Performance Analysis</h1>
    
    <div id="readability-page-1" class="page"><article>
<h2 id="introduction">Introduction<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#introduction"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Zram is a kernel module that utilizes a compressed virtual memory block device allowing for efficient memory management. In this document we will analyze the performance of various compression algorithms used in Zram and their impact on the system. We will also discuss the effects of different page-cluster values on the systemâ€™s latencies and throughput.</p>
<h2 id="compression-algorithm-comparison">Compression Algorithm Comparison<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#compression-algorithm-comparison"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>The following table compares the performance of different compression algorithms used in Zram, in terms of compression time, data size, compressed size, total size, and compression ratio.</p>
<p>Data from <a href="https://linuxreviews.org/Zram">Linux Reviews<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>:</p>





























































<div><table><thead><tr><th>Algorithm</th><th>Cp time</th><th>Data</th><th>Compressed</th><th>Total</th><th>Ratio</th></tr></thead><tbody><tr><td>lzo</td><td>4.571s</td><td>1.1G</td><td>387.8M</td><td>409.8M</td><td>2.689</td></tr><tr><td>lzo-rle</td><td>4.471s</td><td>1.1G</td><td>388M</td><td>410M</td><td>2.682</td></tr><tr><td>lz4</td><td>4.467s</td><td>1.1G</td><td>403.4M</td><td>426.4M</td><td>2.582</td></tr><tr><td>lz4hc</td><td>14.584s</td><td>1.1G</td><td>362.8M</td><td>383.2M</td><td>2.872</td></tr><tr><td>842</td><td>22.574s</td><td>1.1G</td><td>538.6M</td><td>570.5M</td><td>1.929</td></tr><tr><td>zstd</td><td>7.897s</td><td>1.1G</td><td>285.3M</td><td>298.8M</td><td>3.961</td></tr></tbody></table></div>
<p>Data from u/VenditatioDelendaEst:</p>






























































































































































<div><table><thead><tr><th>algo</th><th>page-cluster</th><th>MiB/s</th><th>IOPS</th><th>Mean Latency (ns)</th><th>99% Latency (ns)</th><th>comp_ratio</th></tr></thead><tbody><tr><td>lzo</td><td>0</td><td>5821</td><td>1490274</td><td>2428</td><td>7456</td><td>2.77</td></tr><tr><td>lzo</td><td>1</td><td>6668</td><td>853514</td><td>4436</td><td>11968</td><td>2.77</td></tr><tr><td>lzo</td><td>2</td><td>7193</td><td>460352</td><td>8438</td><td>21120</td><td>2.77</td></tr><tr><td>lzo</td><td>3</td><td>7496</td><td>239875</td><td>16426</td><td>39168</td><td>2.77</td></tr><tr><td>lzo-rle</td><td>0</td><td>6264</td><td>1603776</td><td>2235</td><td>6304</td><td>2.74</td></tr><tr><td>lzo-rle</td><td>1</td><td>7270</td><td>930642</td><td>4045</td><td>10560</td><td>2.74</td></tr><tr><td>lzo-rle</td><td>2</td><td>7832</td><td>501248</td><td>7710</td><td>19584</td><td>2.74</td></tr><tr><td>lzo-rle</td><td>3</td><td>8248</td><td>263963</td><td>14897</td><td>37120</td><td>2.74</td></tr><tr><td>lz4</td><td>0</td><td>7943</td><td>2033515</td><td>1708</td><td>3600</td><td>2.63</td></tr><tr><td>lz4</td><td>1</td><td>9628</td><td>1232494</td><td>2990</td><td>6304</td><td>2.63</td></tr><tr><td>lz4</td><td>2</td><td>10756</td><td>688430</td><td>5560</td><td>11456</td><td>2.63</td></tr><tr><td>lz4</td><td>3</td><td>11434</td><td>365893</td><td>10674</td><td>21376</td><td>2.63</td></tr><tr><td>zstd</td><td>0</td><td>2612</td><td>668715</td><td>5714</td><td>13120</td><td>3.37</td></tr><tr><td>zstd</td><td>1</td><td>2816</td><td>360533</td><td>10847</td><td>24960</td><td>3.37</td></tr><tr><td>zstd</td><td>2</td><td>2931</td><td>187608</td><td>21073</td><td>48896</td><td>3.37</td></tr><tr><td>zstd</td><td>3</td><td>3005</td><td>96181</td><td>41343</td><td>95744</td><td>3.37</td></tr></tbody></table></div>
<p>Data from my raspberry pi 4, 2gb model:</p>






























































































































































<div><table><thead><tr><th>algo</th><th>page-cluster</th><th>MiB/s</th><th>IOPS</th><th>Mean Latency (ns)</th><th>99% Latency (ns)</th><th>comp_ratio</th></tr></thead><tbody><tr><td>lzo</td><td>0</td><td>1275.19</td><td>326448.93</td><td>9965.14</td><td>18816.00</td><td>1.62</td></tr><tr><td>lzo</td><td>1</td><td>1892.08</td><td>242186.68</td><td>14178.77</td><td>31104.00</td><td>1.62</td></tr><tr><td>lzo</td><td>2</td><td>2451.65</td><td>156905.52</td><td>23083.55</td><td>56064.00</td><td>1.62</td></tr><tr><td>lzo</td><td>3</td><td>2786.33</td><td>89162.46</td><td>42224.49</td><td>107008.00</td><td>1.62</td></tr><tr><td>lzo-rle</td><td>0</td><td>1271.53</td><td>325511.42</td><td>9997.72</td><td>20096.00</td><td>1.62</td></tr><tr><td>lzo-rle</td><td>1</td><td>1842.69</td><td>235863.95</td><td>14627.23</td><td>34048.00</td><td>1.62</td></tr><tr><td>lzo-rle</td><td>2</td><td>2404.35</td><td>153878.65</td><td>23592.19</td><td>60160.00</td><td>1.62</td></tr><tr><td>lzo-rle</td><td>3</td><td>2766.61</td><td>88531.46</td><td>42579.14</td><td>114176.00</td><td>1.62</td></tr><tr><td>lz4</td><td>0</td><td>1329.87</td><td>340447.83</td><td>9421.35</td><td>15936.00</td><td>1.59</td></tr><tr><td>lz4</td><td>1</td><td>2004.43</td><td>256567.19</td><td>13238.78</td><td>25216.00</td><td>1.59</td></tr><tr><td>lz4</td><td>2</td><td>2687.75</td><td>172015.93</td><td>20807.00</td><td>43264.00</td><td>1.59</td></tr><tr><td>lz4</td><td>3</td><td>3157.29</td><td>101033.42</td><td>36901.36</td><td>80384.00</td><td>1.59</td></tr><tr><td>zstd</td><td>0</td><td>818.88</td><td>209633.97</td><td>16672.13</td><td>38656.00</td><td>1.97</td></tr><tr><td>zstd</td><td>1</td><td>1069.07</td><td>136840.50</td><td>26777.05</td><td>69120.00</td><td>1.97</td></tr><tr><td>zstd</td><td>2</td><td>1286.17</td><td>82314.84</td><td>46059.39</td><td>127488.00</td><td>1.97</td></tr><tr><td>zstd</td><td>3</td><td>1427.75</td><td>45688.14</td><td>84876.56</td><td>246784.00</td><td>1.97</td></tr></tbody></table></div>
<p>The table presents the performance metrics of different compression algorithms, including LZO, LZO-RLE, LZ4, and ZSTD. The metrics include throughput, compression ratio, and latency, which are important factors to consider for selecting the optimal compression algorithm.
<img src="https://notes.xeome.dev/notes/assets/img/zram_weighed.png" width="auto" height="auto" alt=""/>
We used a weighted sum to evaluate the performance of each algorithm and page cluster combination, with weights of 0.4 for latency, 0.4 for compression ratio, and 0.2 for throughput. The results show that LZ4 with page cluster 0 achieved the highest weighted sum, indicating that it is the optimal choice for this dataset. Overall, this evaluation provides valuable insights for selecting the most suitable compression algorithm for data storage and processing, balancing between compression ratio, throughput, and latency.</p>
<p>Code used to calculate weighed sums:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="py" data-theme="github-light github-dark"><code data-language="py" data-theme="github-light github-dark"><span data-line=""><span>data </span><span>=</span><span> {</span></span>
<span data-line=""><span>    (</span><span>&#39;lzo&#39;</span><span>, </span><span>0</span><span>): (</span><span>5821</span><span>, </span><span>2.77</span><span>, </span><span>2428</span><span>),</span></span>
<span data-line=""><span>    (</span><span>&#39;lzo&#39;</span><span>, </span><span>1</span><span>): (</span><span>6668</span><span>, </span><span>2.77</span><span>, </span><span>4436</span><span>),</span></span>
<span data-line=""><span>    (</span><span>&#39;lzo&#39;</span><span>, </span><span>2</span><span>): (</span><span>7193</span><span>, </span><span>2.77</span><span>, </span><span>8438</span><span>),</span></span>
<span data-line=""><span>    (</span><span>&#39;lzo&#39;</span><span>, </span><span>3</span><span>): (</span><span>7496</span><span>, </span><span>2.77</span><span>, </span><span>16426</span><span>),</span></span>
<span data-line=""><span>    (</span><span>&#39;lzo-rle&#39;</span><span>, </span><span>0</span><span>): (</span><span>6264</span><span>, </span><span>2.74</span><span>, </span><span>2235</span><span>),</span></span>
<span data-line=""><span>    (</span><span>&#39;lzo-rle&#39;</span><span>, </span><span>1</span><span>): (</span><span>7270</span><span>, </span><span>2.74</span><span>, </span><span>4045</span><span>),</span></span>
<span data-line=""><span>    (</span><span>&#39;lzo-rle&#39;</span><span>, </span><span>2</span><span>): (</span><span>7832</span><span>, </span><span>2.74</span><span>, </span><span>7710</span><span>),</span></span>
<span data-line=""><span>    (</span><span>&#39;lzo-rle&#39;</span><span>, </span><span>3</span><span>): (</span><span>8248</span><span>, </span><span>2.74</span><span>, </span><span>14897</span><span>),</span></span>
<span data-line=""><span>    (</span><span>&#39;lz4&#39;</span><span>, </span><span>0</span><span>): (</span><span>7943</span><span>, </span><span>2.63</span><span>, </span><span>1708</span><span>),</span></span>
<span data-line=""><span>    (</span><span>&#39;lz4&#39;</span><span>, </span><span>1</span><span>): (</span><span>9628</span><span>, </span><span>2.63</span><span>, </span><span>2990</span><span>),</span></span>
<span data-line=""><span>    (</span><span>&#39;lz4&#39;</span><span>, </span><span>2</span><span>): (</span><span>10756</span><span>, </span><span>2.63</span><span>, </span><span>5560</span><span>),</span></span>
<span data-line=""><span>    (</span><span>&#39;lz4&#39;</span><span>, </span><span>3</span><span>): (</span><span>11434</span><span>, </span><span>2.63</span><span>, </span><span>10674</span><span>),</span></span>
<span data-line=""><span>    (</span><span>&#39;zstd&#39;</span><span>, </span><span>0</span><span>): (</span><span>2612</span><span>, </span><span>3.37</span><span>, </span><span>5714</span><span>),</span></span>
<span data-line=""><span>    (</span><span>&#39;zstd&#39;</span><span>, </span><span>1</span><span>): (</span><span>2816</span><span>, </span><span>3.37</span><span>, </span><span>10847</span><span>),</span></span>
<span data-line=""><span>    (</span><span>&#39;zstd&#39;</span><span>, </span><span>2</span><span>): (</span><span>2931</span><span>, </span><span>3.37</span><span>, </span><span>21073</span><span>),</span></span>
<span data-line=""><span>    (</span><span>&#39;zstd&#39;</span><span>, </span><span>3</span><span>): (</span><span>3005</span><span>, </span><span>3.37</span><span>, </span><span>41343</span><span>),</span></span>
<span data-line=""><span>}</span></span>
<span data-line=""> </span>
<span data-line=""><span>weights </span><span>=</span><span> {</span><span>&#39;latency&#39;</span><span>: </span><span>0.4</span><span>, </span><span>&#39;ratio&#39;</span><span>: </span><span>0.4</span><span>, </span><span>&#39;throughput&#39;</span><span>: </span><span>0.2</span><span>}</span></span>
<span data-line=""> </span>
<span data-line=""><span># Find the maximum value for each metric</span></span>
<span data-line=""><span>max_throughput </span><span>=</span><span> max</span><span>(x[</span><span>0</span><span>] </span><span>for</span><span> x </span><span>in</span><span> data.values())</span></span>
<span data-line=""><span>max_ratio </span><span>=</span><span> max</span><span>(x[</span><span>1</span><span>] </span><span>for</span><span> x </span><span>in</span><span> data.values())</span></span>
<span data-line=""><span>max_latency </span><span>=</span><span> max</span><span>(x[</span><span>2</span><span>] </span><span>for</span><span> x </span><span>in</span><span> data.values())</span></span>
<span data-line=""> </span>
<span data-line=""><span>best_score </span><span>=</span><span> 0</span></span>
<span data-line=""><span>best_algo </span><span>=</span><span> None</span></span>
<span data-line=""><span>best_page_cluster </span><span>=</span><span> None</span></span>
<span data-line=""> </span>
<span data-line=""><span>for</span><span> (algo, page_cluster), (throughput, ratio, latency) </span><span>in</span><span> data.items():</span></span>
<span data-line=""><span>    throughput_norm </span><span>=</span><span> throughput </span><span>/</span><span> max_throughput</span></span>
<span data-line=""><span>    ratio_norm </span><span>=</span><span> ratio </span><span>/</span><span> max_ratio</span></span>
<span data-line=""><span>    latency_norm </span><span>=</span><span> latency </span><span>/</span><span> max_latency</span></span>
<span data-line=""><span>    score </span><span>=</span><span> weights[</span><span>&#39;latency&#39;</span><span>] </span><span>*</span><span> (</span><span>1</span><span> /</span><span> latency_norm) </span><span>+</span><span> weights[</span><span>&#39;ratio&#39;</span><span>] </span><span>*</span><span> ratio_norm </span><span>+</span><span> weights[</span><span>&#39;throughput&#39;</span><span>] </span><span>*</span><span> throughput_norm</span></span>
<span data-line=""><span>    print</span><span>(</span><span>f</span><span>&#34;</span><span>{</span><span>algo</span><span>}</span><span>, pagecluster </span><span>{</span><span>page_cluster</span><span>}</span><span>: </span><span>{</span><span>score</span><span>:.4f</span><span>}</span><span>&#34;</span><span>)</span></span>
<span data-line=""><span>    if</span><span> score </span><span>&gt;</span><span> best_score:</span></span>
<span data-line=""><span>        best_score </span><span>=</span><span> score</span></span>
<span data-line=""><span>        best_algo </span><span>=</span><span> algo</span></span>
<span data-line=""><span>        best_page_cluster </span><span>=</span><span> page_cluster</span></span>
<span data-line=""> </span>
<span data-line=""><span>print</span><span>(</span><span>f</span><span>&#34;Best algorithm: </span><span>{</span><span>best_algo</span><span>}</span><span>&#34;</span><span>)</span></span>
<span data-line=""><span>print</span><span>(</span><span>f</span><span>&#34;Best page cluster: </span><span>{</span><span>best_page_cluster</span><span>}</span><span>&#34;</span><span>)</span></span></code></pre></figure>
<p>Data from me:</p>
<p>Compiling memory intensive code (<a href="https://github.com/netxs-group/vtm">vtm<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> ). Test was done on raspberry pi 4b, 2gb ram.</p>

















<div><table><thead><tr><th>algo</th><th>time</th></tr></thead><tbody><tr><td>lz4</td><td>433.63s</td></tr><tr><td>zstd</td><td>459.34s</td></tr></tbody></table></div>
<h3 id="page-cluster-values-and-latency">Page-cluster Values and Latency<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#page-cluster-values-and-latency"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>The page-cluster value controls the number of pages that are read in from swap in a single attempt, similar to the page cache readahead. The consecutive pages are not based on virtual or physical addresses, but consecutive on swap space, meaning they were swapped out together.</p>
<p>The page-cluster value is a logarithmic value. Setting it to zero means one page, setting it to one means two pages, setting it to two means four pages, etc. A value of zero disables swap readahead completely.</p>
<p>The default value is 3 (8 pages at a time). However, tuning this value to a different value may provide small benefits if the workload is swap-intensive. Lower values mean lower latencies for initial faults, but at the same time, extra faults and I/O delays for following faults if they would have been part of that consecutive pages readahead would have brought in.</p>
<p><img src="https://notes.xeome.dev/notes/assets/img/O_benchmarks_zram_throughput.png" width="auto" height="auto" alt=""/></p>
<p><img src="https://notes.xeome.dev/notes/assets/img/O_benchmarks_zram_latency.png" width="auto" height="auto" alt=""/></p>
<h2 id="conclusion">Conclusion<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#conclusion"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>In the analysis of Zram performance, it was determined that the zstd algorithm provides the highest compression ratio while still maintaining acceptable speeds. The high compression ratio allows more of the working set to fit in uncompressed memory, reducing the need for swap and ultimately improving performance.</p>
<p>For daily use (non latency sensitive), it is recommended to use zstd with <code>page-cluster=0</code> as the majority of swapped data is likely stale (old browser tabs). However, systems that require constant swapping may benefit from using the lz4 algorithm due to its higher throughput and lower latency.</p>
<p>It is important to note that the decompression of zstd is slow and results in a lack of throughput gain from readahead. Therefore, <code>page-cluster=0</code> should be used for zstd. This is the default setting on <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=263561#c16=">ChromeOS<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> and seems to be standard practice on <a href="https://cs.android.com/search?q=page-cluster&amp;start=21">Android<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>.</p>
<p>The default <code>page-cluster</code> value is set to 3, which is better suited for physical swap. This value dates back to 2005, when the kernel switched to git, and may have been used in a time before the widespread use of SSDs. It is recommended to consider the specific requirements of the system and workload when configuring Zram.</p>

<p><a href="https://linuxreviews.org/Zram">https://linuxreviews.org/Zram<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></p>
<p><a href="https://docs.kernel.org/admin-guide/sysctl/vm.html">https://docs.kernel.org/admin-guide/sysctl/vm.html<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></p>
<p><a href="https://www.reddit.com/r/Fedora/comments/mzun99/new_zram_tuning_benchmarks/">https://www.reddit.com/r/Fedora/comments/mzun99/new_zram_tuning_benchmarks/<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></p></article></div>
  </body>
</html>
