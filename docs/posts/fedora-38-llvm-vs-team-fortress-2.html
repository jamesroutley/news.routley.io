<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://airlied.blogspot.com/2023/04/fedora-38-llvm-vs-team-fortress-2-tf2.html">Original</a>
    <h1>Fedora 38 LLVM vs. Team Fortress 2</h1>
    
    <div id="readability-page-1" class="page"><div id="post-body-7968821791383818554">
<p>F38 just released and seeing a bunch of people complain that TF2 dies on AMD or other platforms when lavapipe is installed. Who&#39;s at fault? I&#39;ve no real idea. How to fix it? I&#39;ve no real idea.</p><h4>What&#39;s happening?</h4><p>AMD OpenGL drivers use LLVM as the backend compiler. Fedora 38 updated to LLVM 16. LLVM 16 is built with c++17 by default. C++17 introduces new &#34;operator new/delete&#34; interfaces[1].</p><p>TF2 ships with it&#39;s own libtcmalloc_minimal.so implementation, tcmalloc expects to replace all the new/delete interfaces, but the version in TF2 must not support or had incorrect support for the new align interfaces.</p><p>What happens is when TF2 probes OpenGL and LLVM is loaded, when DenseMap initializes, one &#34;new&#34; path fails to go into tcmalloc, but the &#34;delete&#34; path does, and this causes tcmalloc to explode with</p><p>&#34;src/tcmalloc.cc:278] Attempt to free invalid pointer&#34;</p><h4>Fixing it?</h4><p>I&#39;ll talk to Valve and see if we can work out something, LLVM 16 doesn&#39;t seem to support building with C++14 anymore. I&#39;m not sure if static linking libstdc++ into LLVM might avoid the tcmalloc overrides, it might not also be acceptable to the wider Fedora community.<br/></p><p>[1] <a href="https://www.cppstories.com/2019/08/newnew-align/">https://www.cppstories.com/2019/08/newnew-align/</a><br/></p>
</div></div>
  </body>
</html>
