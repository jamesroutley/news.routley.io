<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ogris.de/howtos/freebsd-jails.html">Original</a>
    <h1>Jails on FreeBSD</h1>
    
    <div id="readability-page-1" class="page">

<p>We have had <a href="https://www.freebsd.org/doc/en/books/handbook/jails.html">Jails</a> on FreeBSD since 4.0 came out 19 years ago in March 2000. This describes how to setup jails on FreeBSD 12 without any helpers.</p>
<h2>Steps</h2>
<ol>
<li>I usually place all jails under <i>/var/jail</i> and give each jail its own directory, which reflects its short hostname. For this, I use <a href="https://www.freebsd.org/cgi/man.cgi?bsdinstall(8)">bsdinstall</a>:
<pre># bsdinstall jail /var/jail/mysql</pre>
Deselect all optional system components during the installation as well as any services.
</li>
<li>On the host system, you can either create one big <i>/etc/jail.conf</i> or one <i>/etc/jail.HOSTNAME.conf</i> per jail, e.g. <i>/etc/jail.mysql.conf</i>:
<pre>exec.start = &#34;/bin/sh /etc/rc&#34;;
exec.stop = &#34;/bin/sh /etc/rc.shutdown&#34;;
exec.clean;
mount.devfs;

path = &#34;/var/jail/mysql&#34;;

mysql {
  host.hostname = &#34;mysql.intra.ogris.net&#34;;
  ip4.addr = &#34;lo1|10.0.0.2&#34;;
}
</pre></li>
<li>In order to have the jails started and stopped during system boot and shutdown, respectively, add this to <i>/etc/rc.conf</i>:
<pre>jail_enable=&#34;YES&#34;
jail_list=&#34;mysql&#34;
</pre></li>
<li>Unless you want to assign each jail an IP address from your network, you have to setup a host-only network. In <i>/etc/rc.conf</i>:
<pre>cloned_interfaces=&#34;lo1&#34;
ifconfig_lo1=&#34;inet 10.0.0.1 netmask 255.255.255.0&#34;
</pre></li>
<li>Usually, you want to give your jails Internet access. Thus, we need NAT on the host. First, create <i>/etc/ipfw.rules</i>:
<pre>nat 1 config if vtnet0 same_ports
add nat 1 ip from any to any via vtnet0
add allow ip from any to any
</pre>
Replace <i>vtnet0</i> by your actual network interface.</li>
<li>Now add this to <i>/etc/rc.conf</i> in order to activate IP forwarding and to have the firewall rules loaded during system boot:
<pre>kld_list=&#34;ipfw_nat&#34;
gateway_enable=&#34;YES&#34;
firewall_enable=&#34;YES&#34;
firewall_type=&#34;/etc/ipfw.rules&#34;
</pre></li>
<li>Reboot the host. Afterwards, you can log into your jails, e.g. by typing
<pre># jexec mysql /bin/csh
</pre></li>
<li>Optionally, set up a local <a href="https://www.freebsd.org/cgi/man.cgi?query=unbound">unbound</a> as caching DNS resolver:
<pre># cat &gt;/etc/unbound/conf.d/local.conf &lt;&lt;EOF
server:
	interface: 0.0.0.0
	access-control: 127.0.0.0/8 allow
	access-control: 10.0.0.0/24 allow
EOF
# service local_unbound enable
# service local_unbound start
</pre></li>
<li>Inside the jail, setup <i>/etc/resolv.conf</i> (you can do this from the host as well!). Either add your local nameserver, or the jail&#39;s IP address if you started a local unbound resolver on the host as described above</li>
<li>Now, you can install the ports collections as usual:
<pre># portsnap fetch extract
</pre></li>
<li>Not strictly needed, but I like my jails to send emails via the host system. First, fix <i>/etc/make.conf</i> for both the host and the jails:
<pre>SENDMAIL_MC=/etc/mail/freebsd.mc
SENDMAIL_SUBMIT_MC=/etc/mail/freebsd.submit.mc
</pre></li>
<li>On the host, add this to <i>/etc/rc.conf</i>:
<pre>sendmail_enable=&#34;YES&#34;
sendmail_rebuild_aliases=&#34;YES&#34;
</pre></li>
<li>Make sure that <i>/etc/mail/freebsd.mc</i> contains these lines:
<pre>FEATURE(`accept_unresolvable_domains&#39;)dnl
FEATURE(`accept_unqualified_senders&#39;)dnl
DAEMON_OPTIONS(`Name=IPv4, Family=inet, Addr=10.0.0.1&#39;)dnl
</pre></li>
<li>Additionally, if your host has to use a relay server as well:
<pre>define(`SMART_HOST&#39;, `[192.168.23.42]&#39;)dnl
</pre></li>
<li>Rebuild sendmail.cf and restart sendmail:
<pre># make -C /etc/mail clean all install
# service sendmail restart
</pre></li>
<li>Inside each jail, add this to <i>/etc/rc.conf</i>:
<pre>sendmail_rebuild_aliases=&#34;YES&#34;
</pre></li>
<li>In <i>/etc/mail/freebsd.mc</i>, set the host&#39;s ip address as relay server:
<pre>define(`SMART_HOST&#39;, `[10.0.0.1]&#39;)dnl
FEATURE(nocanonify)dnl
</pre></li>
<li>Rebuild sendmail.cf and restart sendmail inside the jails as well:
<pre># make -C /etc/mail clean all install
# service sendmail restart
</pre></li>
</ol>
<h2 id="jupdate">Updating jails</h2>
<p>I wrote and have used <a href="https://ogris.de/howtos/jupdate.sh">jupdate.sh</a> to run <a href="https://www.freebsd.org/cgi/man.cgi?freebsd-update">freebsd-update</a>, <a href="https://www.freebsd.org/cgi/man.cgi?portsnap">postsnap</a>, and <a href="https://www.freebsd.org/cgi/man.cgi?portmaster">portmaster</a> on the host system and inside each running jail.</p>


</div>
  </body>
</html>
