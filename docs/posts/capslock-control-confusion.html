<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://cceckman.com/writing/qmk-capslock/">Original</a>
    <h1>CapsLock-Control Confusion</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>We had a keyboard running <a href="https://qmk.fm" target="_blank">QMK</a> firmware, where the <a href="https://docs.qmk.fm/mod_tap" target="_blank">Mod-Tap</a>
behavior seemed to be misbehaving: the configuration
“tap for CapsLock, hold for Ctrl” only ever registered as Ctrl.</p>
<p>After some experimentation, I found that the
<code>MAGIC_CAPS_LOCK_AS_Ctrl</code> <a href="https://docs.qmk.fm/keycodes_magic" target="_blank">Magic Keycodes</a> bit had been set;
toggling that off resolved the issue. I suspect clearing the EEPROM
would have done the same.</p>
<p><strong>Lesson learned:</strong>: When starting a “fresh” keyboard layout,
clear out the EEPROM explicitly!</p>
<h2 id="issue-report">Issue report</h2>
<p>Here’s my narrative of what happened; see <a href="#analysis">below</a> for
a deeper understanding.</p>
<p>Note that this isn’t a <em>bug</em> report for QMK. As far as I can tell,
everything was working as intended – just not as I naively expected!</p>
<h3 id="symptoms">Symptoms</h3>
<p>We had a <a href="https://github.com/blewis308/Ristretto" target="_blank">Ristretto</a> keyboard sitting on the shelf for a while.
Recently, the user pulled it, configured a layout with the
<a href="https://config.qmk.fm/" target="_blank">QMK Configurator</a> tool, and programmed it onto the keyboard.</p>
<p>For the most part, the layout worked fine, except for one key.
The user had configured that key with <code>MT(MOD_LCTL, KC_CAPSLOCK)</code>:
using the <a href="https://docs.qmk.fm/mod_tap" target="_blank">Mod-Tap</a> feature, a tap (short press) should
toggle CapsLock, while a hold (long press) would register as “left Ctrl”.</p>
<p>The actual behavior was that the key always behaved as “left Ctrl” (<code>MOD_LCTL</code>).
This wasn’t an operating-system level rebinding; we saw it on distinct Windows and
Linux computers.</p>
<h3 id="debugging-and-suspicions">Debugging and suspicions</h3>
<p>For debugging, we <a href="https://docs.qmk.fm/newbs_getting_started" target="_blank">set up the QMK command-line environment</a>
to get more Ctrl. We exported the <code>keymap.json</code> file from the <a href="https://config.qmk.fm/" target="_blank">QMK Configurator</a>,
and used the <a href="https://docs.qmk.fm/cli_commands#qmk-json2c" target="_blank"><code>qmk json2c</code> command</a> command to get a buildable keymap.</p>
<p>The issue reproduced when using a local build; it wasn’t a configurator problem.
We changed a couple of <code>#defines</code> related to the Mod-Tap feature, but they
also didn’t introduce any fix.</p>
<p>I wound up trying <code>MT(MOD_LCTL, KC_TAB)</code>, which gave our first big clue:
that key combo worked fine! This suggested there was something about CapsLock
that was behaving specially.</p>
<p>I probably should have guessed that sooner, really. “Replace CapsLock with Ctrl”
is a pretty typical keyboard customization, even without running custom firmware –
I have configured my laptop to swap them.</p>
<p>I recognized the behavior as being <em>equivalent to</em> “CapsLock acts as Ctrl”:
regardless of “hold” or “tap”, the key came up “Ctrl”.</p>
<h3 id="discovery-and-mitigation">Discovery and mitigation</h3>
<p>A little searching turned up
<a href="https://www.reddit.com/r/olkb/comments/7wtxxa/qmk_kc_lctl_kc_caps_functionality_swapped/" target="_blank">this Reddit thread</a>;
which doesn’t say much, but points at the <a href="https://docs.qmk.fm/features/bootmagic" target="_blank">Bootmagic</a> feature.</p>
<p>That page notes that Bootmagic is deprecated in favor of <a href="https://docs.qmk.fm/keycodes_magic" target="_blank">Magic Keycodes</a>
– of which the first several deal with “CapsLock as Ctrl”.
Found it!</p>
<p>I configured a key for <code>QK_MAGIC_CAPS_LOCK_AS_CONTROL_OFF</code>, flashed the keyboard,
and pressed the key – and the Mod-Tap key worked as it should. This also persisted after
flashing a new layout, moving to a different computer, etc.</p>
<h2 id="analysis">Analysis: Persistent state in QMK</h2>
<p>So what happened here? The keyboard had some sort of persistent state that said
“treat CapsLock as Control”, that wasn’t surfaced aside from the behavior itself;
that persisted even after re-flashing.</p>
<p>QMK can use <a href="https://docs.qmk.fm/feature_eeprom" target="_blank">EEPROM</a> to store persistent settings.
Looking at the source, we can see this feature is used for the <a href="https://docs.qmk.fm/keycodes_magic" target="_blank">Magic Keycodes</a>:
The <code>keymap_config</code> is <a href="https://github.com/qmk/qmk_firmware/blob/8b5cdfabf5d05958a607efa174e64377d36e4b64/quantum/process_keycode/process_magic.c#L50" target="_blank">read from <code>eeconfig</code></a>,
updated, and <a href="https://github.com/qmk/qmk_firmware/blob/8b5cdfabf5d05958a607efa174e64377d36e4b64/quantum/process_keycode/process_magic.c#L190" target="_blank">written back</a>.</p>
<p>As far as I can tell from the <a href="https://cceckman.com/writing/qmk-capslock/atmega32u4.pdf">datasheet</a>, the <a href="https://www.microchip.com/en-us/product/atmega32u4" target="_blank">atmega32u4</a> controller <a href="https://github.com/blewis308/Ristretto/blob/ace47eeedc10528ed6059dd57979c17c04300c63/firmware/QMK/rules.mk#L2C7-L2C17" target="_blank">used by Ristretto</a> does not have any <a href="https://en.wikipedia.org/wiki/Error_correction_code" target="_blank">ECC</a> protections. (If you know otherwise, let me know!)</p>
<p>So at some point, either I had set this configuration bit, or
that specific bit of EEPROM had been corrupted by noise,<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup> or…something.
And the configuration stuck in the EEPROM until cleared.</p>
<h2 id="what-ive-learned">What I’ve learned</h2>
<p>QMK is pretty easy to use, and quite powerful!
I’ve mostly been using graphical configurators for my keyboards, but I might
switch over to get that lower-level control.</p>
<p>When notionally starting a new layout, explicitly clear the EEPROM
to clean out any persistent state.</p>


</div></div>
  </body>
</html>
