<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://wasmer.io/posts/announcing-wcgi">Original</a>
    <h1>Announcing WCGI: WebAsseAmbly and CGI</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>Welcome to the future of server-side development with WebAssembly!</p>
<p>Here are some of WCGI&#39;s highlights:</p>
<ul>
<li>You can <strong>reuse</strong> your existing CGI applications by compiling them to WASI
(AssemblyScript, C, C++, Go, PHP, Python, ...)</li>
<li>Ship <strong>ultra-small packages</strong> that will only contain your business logic
and static assets, no HTTP stack or bulky Docker containers</li>
<li>Completely <strong>sandboxed execution</strong>: WebAssembly code runs in a sandbox, with one
isolated instance per request</li>
</ul>
<p>Picture running <strong>Wordpress</strong> and not having to worry about attackers breaking into
your system. With WCGI, now this a reality!</p>
<iframe width="100%" height="370" src="https://www.youtube.com/embed/euYWW4vZqxg" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe>
<h4>Try Wordpress locally with Wasmer</h4>
<pre tabindex="0"><code><span><span># Install wasmer beta 2</span></span>
<span><span>curl</span><span> </span><span>https://get.wasmer.io</span><span> </span><span>-sSfL</span><span> </span><span>|</span><span> </span><span>sh</span><span> </span><span>-s</span><span> </span><span>&#34;v3.2.0-beta.2&#34;</span></span>
<span></span>
<span><span># Execute Wordpress</span></span>
<span><span>mkdir</span><span> </span><span>db</span></span>
<span><span>wasmer</span><span> </span><span>run-unstable</span><span> </span><span>wasmer/wcgi-wordpress-demo</span><span> </span><span>--mapdir=/db:db</span></span></code></pre>
<blockquote>
<p>We are trialing the new runner architecture via <code>wasmer run-unstable</code>.
In the future you would simply use <code>wasmer run</code></p>
</blockquote>
<hr/>
<h2>The Why Behind WCGI</h2>
<p>When venturing into serverless solutions at Wasmer, we faced a crucial question:
should we create our own framework and risk locking developers into a <strong>walled
garden</strong>, or should we adopt an <strong>open standard</strong> that allows them to utilize existing
code?</p>
<p>CGI&#39;s alignment with the goal of executing a program per HTTP request makes it a
compelling choice. Interestingly, CGI can outperform many other solutions (such as WSGI in Python/Ruby or NodeJS) in terms of scalability and latency in serverless environments.</p>
<p>Furthermore, it also closely mirrors the workers proposal from the <strong><a href="https://wintercg.org/">Winter
Community
Group</a></strong>.</p>
<p>Consider the challenge of running PHP programs on servers. We have two primary
options:</p>
<ol>
<li>Wrap the PHP interpreter with a layer that instruments each HTTP call</li>
<li>Use the existing <code>php-cgi</code> program and simply compile it to Wasm</li>
</ol>
<p>Option 2 is not only faster, but it also enables any web application on Wasmer
more efficiently.</p>
<p>By embracing WCGI, those seeking to achieve greater efficiency, security, and flexibility in server-side development can truly benefit from this approach.</p>
<h2>Creating a WCGI Application with Rust</h2>
<p>To create a WCGI application using Rust, first add the <strong><code>cgi</code></strong> crate as a
dependency in your <strong><code>Cargo.toml</code></strong> file:</p>
<pre tabindex="0"><code><span><span>$</span><span> </span><span>cargo</span><span> </span><span>add</span><span> </span><span>cgi</span></span></code></pre>
<p>Next, write your Rust server, like the example below:</p>
<pre tabindex="0"><code><span><span>// src/lib.rs</span></span>
<span></span>
<span><span>use</span><span> </span><span>cgi</span><span>::</span><span>{</span><span>http</span><span>::</span><span>StatusCode</span><span>, </span><span>Request</span><span>, </span><span>Response</span><span>};</span></span>
<span></span>
<span><span>fn</span><span> </span><span>main</span><span>() {</span></span>
<span><span>    </span><span>cgi</span><span>::</span><span>handle</span><span>(handler);</span></span>
<span><span>}</span></span>
<span></span>
<span><span>fn</span><span> </span><span>handler</span><span>(request</span><span>:</span><span> </span><span>Request</span><span>) </span><span>-&gt;</span><span> </span><span>Response</span><span> {</span></span>
<span><span>    </span><span>let</span><span> who </span><span>=</span><span> </span><span>String</span><span>::</span><span>from_utf8_lossy</span><span>(request</span><span>.</span><span>body</span><span>());</span></span>
<span><span>    </span><span>let</span><span> who </span><span>=</span><span> </span><span>if</span><span> who</span><span>.</span><span>trim</span><span>()</span><span>.</span><span>is_empty</span><span>() {</span></span>
<span><span>        </span><span>&#34;World&#34;</span></span>
<span><span>    } </span><span>else</span><span> {</span></span>
<span><span>        who</span><span>.</span><span>trim</span><span>()</span></span>
<span><span>    };</span></span>
<span></span>
<span><span>    </span><span>cgi</span><span>::</span><span>text_response</span><span>(</span><span>StatusCode</span><span>::</span><span>OK</span><span>, </span><span>format!</span><span>(</span><span>&#34;Hello, {who}!&#34;</span><span>))</span></span>
<span><span>}</span></span></code></pre>
<p>After writing your implementation, compile it to the <strong><code>wasm32-wasi</code></strong> target.
You may need to install the WASI target if you haven’t already (<code>rustup target add wasm32-wasi</code>).</p>
<pre tabindex="0"><code><span><span>$</span><span> cargo build </span><span>--</span><span>target wasm32</span><span>-</span><span>wasi </span><span>--</span><span>release</span></span></code></pre>
<p>Create a <strong><code>wasmer.toml</code></strong> file that describes your package and contains a WCGI
command that the <code>wasmer</code> CLI will execute.</p>
<pre tabindex="0"><code><span><span>[</span><span>package</span><span>]</span></span>
<span><span>name = </span><span>&#34;wasmer/wcgi-rust-template&#34;</span></span>
<span><span>version = </span><span>&#34;0.1.0&#34;</span></span>
<span><span>description = </span><span>&#34;A template for WCGI applications&#34;</span></span>
<span><span>license = </span><span>&#34;MIT OR Apache-2.0&#34;</span></span>
<span><span>readme = </span><span>&#34;README.md&#34;</span></span>
<span><span>repository = </span><span>&#34;https://github.com/wasmerio/wcgi-rust-template&#34;</span></span>
<span></span>
<span><span>[[</span><span>module</span><span>]]</span></span>
<span><span>name = </span><span>&#34;server&#34;</span></span>
<span><span>source = </span><span>&#34;target/wasm32-wasi/release/wcgi-rust-template.wasm&#34;</span></span>
<span><span>abi = </span><span>&#34;wasi&#34;</span></span>
<span></span>
<span><span>[[</span><span>command</span><span>]]</span></span>
<span><span>name = </span><span>&#34;server&#34;</span></span>
<span><span>runner = </span><span>&#34;wcgi&#34;</span></span>
<span><span>module = </span><span>&#34;wcgi&#34;</span></span>
<span><span>annotations = { wcgi = { dialect = </span><span>&#34;rfc-3875&#34;</span><span> } }</span></span></code></pre>
<p>Now you can start the server and browse to
<a href="http://localhost:8000/">http://localhost:8000/</a> to see it in action:</p>
<pre tabindex="0"><code><span><span>$</span><span> </span><span>wasmer</span><span> </span><span>run-unstable</span><span> </span><span>.</span></span></code></pre>
<h2>Creating a WCGI Application in PHP</h2>
<p>PHP-CGI was first introduced by Rafael Fernández López.
Thanks to his original version of <code>php-cgi</code> compiled to WebAssembly &amp; WASI,
Wasmer can now run PHP websites using WCGI.</p>
<p>First, create a new repository and copy
<a href="https://github.com/wasmerio/wcgi-php-template/raw/main/php-cgi.wasm">php-cgi.wasm</a>
into it. Then, create an <code>app/</code> directory and add some PHP code to it.</p>
<pre tabindex="0"><code><span><span>$</span><span> </span><span>mkdir</span><span> </span><span>app</span></span>
<span><span>$</span><span> </span><span>echo</span><span> </span><span>&#39;&lt;? print(&#34;Hello, World!&#34;); ?&gt;&#39;</span><span> </span><span>&gt;</span><span> </span><span>app/index.php</span></span></code></pre>
<p>Now we need to create a <code>wasmer.toml</code> file.</p>
<p>This is a bit longer than the Rust one because we need to set some environment
variables that tell <code>php-cgi</code> which script to invoke. We also want the <code>app/</code>
folder to be bundled with the package when we publish it.</p>
<pre tabindex="0"><code><span><span>[</span><span>package</span><span>]</span></span>
<span><span>name = </span><span>&#34;wasmer/wcgi-php-template&#34;</span></span>
<span><span>version = </span><span>&#34;0.1.0&#34;</span></span>
<span><span>description = </span><span>&#34;A PHP template for WCGI applications&#34;</span></span>
<span><span>license = </span><span>&#34;MIT OR Apache-2.0&#34;</span></span>
<span><span>readme = </span><span>&#34;README.md&#34;</span></span>
<span><span>repository = </span><span>&#34;https://github.com/wasmerio/wcgi-php-template&#34;</span></span>
<span></span>
<span><span>[[</span><span>module</span><span>]]</span></span>
<span><span>name = </span><span>&#34;php&#34;</span></span>
<span><span>source = </span><span>&#34;php-cgi.wasm&#34;</span></span>
<span><span>abi = </span><span>&#34;wasi&#34;</span></span>
<span></span>
<span><span>[[</span><span>command</span><span>]]</span></span>
<span><span>name = </span><span>&#34;php&#34;</span></span>
<span><span>runner = </span><span>&#34;wcgi&#34;</span></span>
<span><span>module = </span><span>&#34;php&#34;</span></span>
<span></span>
<span><span>[</span><span>command</span><span>.</span><span>annotations</span><span>.</span><span>wcgi</span><span>]</span></span>
<span><span>dialect = </span><span>&#34;rfc-3875&#34;</span></span>
<span></span>
<span><span>[</span><span>command</span><span>.</span><span>annotations</span><span>.</span><span>wasi</span><span>]</span></span>
<span><span>atom = </span><span>&#34;php&#34;</span></span>
<span><span>env = [</span><span>&#34;DOCUMENT_ROOT=/app&#34;</span><span>, </span><span>&#34;SCRIPT_FILENAME=/app/index.php&#34;</span><span>]</span></span>
<span></span>
<span><span>[</span><span>fs</span><span>]</span></span>
<span><span>&#34;app&#34; = </span><span>&#34;app&#34;</span></span></code></pre>
<p>You can now run this with <code>wasmer run-unstable</code>:</p>
<pre tabindex="0"><code><span><span>$</span><span> </span><span>wasmer</span><span> </span><span>run-unstable</span><span> </span><span>.</span></span></code></pre>
<p>Opening up our web browser shows the “Hello, World” message as expected.</p>
<p><img src="https://wasmer.io/images/blog/wcgi-php-hello-world.png" alt="PHP hello world"/></p>
<p>You can also use the <code>wasmer</code> CLI’s <code>--mapdir</code> flag to make specific directories
on your host machine available to the WebAssembly application.</p>
<p>This is really useful during development because it means you can mount your
<code>app/</code> directory and make changes on the fly without needing to restart the WCGI
server.</p>
<p>First, start the WCGI server and tell it that the <code>/app</code> directory inside the
WebAssembly application corresponds to the <code>./app</code> directory on your host.</p>
<pre tabindex="0"><code><span><span>$</span><span> </span><span>wasmer</span><span> </span><span>run-unstable</span><span> </span><span>--mapdir</span><span> </span><span>/app:./app</span><span> </span><span>.</span></span></code></pre>
<p>If you open <a href="http://localhost:8000/">http://localhost:8000/</a> up in your browser,
you should see the “Hello, World!” from before.</p>
<p>Next, modify <code>app/index.php</code> to print <code>phpinfo()</code> , hit save, and refresh your
browser.</p>
<p><img src="https://wasmer.io/images/blog/wcgi-phpinfo.png" alt="PHP phpinfo()"/></p>
<p>This package is also available <a href="https://wapm.dev/wasmer/wcgi-php-template">on WAPM</a>.</p>
<pre tabindex="0"><code><span><span>$</span><span> </span><span>wasmer</span><span> </span><span>run-unstable</span><span> </span><span>wasmer/wcgi-php-template</span></span></code></pre>
<p><em>You can find in Github the source code for the <a href="https://github.com/wasmerio/wcgi-wordpress-demo">Wordpress Wasmer pacakage</a>, and the <a href="https://github.com/wasmerio/wcgi-php-template">PHP WCGI template</a></em>.</p>
<p>We can&#39;t wait to see what you create next with WCGI!</p>
<h2>In Summary…</h2>
<p>WCGI represents a refined approach to server-side development, integrating the
flexibility, security, and performance of WebAssembly. This innovative
technology has the potential to reshape the landscape of serverless
applications, providing developers with a powerful and versatile solution for
their projects.</p>
<p>Watch this space 😉</p></div></div></div>
  </body>
</html>
