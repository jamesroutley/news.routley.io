<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/facebook/prophet">Original</a>
    <h1>Prophet: Automatic Forecasting Procedure</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
    <p>I’m (hopefully) getting closer to the finish line on <a href="https://bugs.webkit.org/show_bug.cgi?id=222315">enabling Wasm on Windows</a> in WebKit. 
Recently I had a setback, when Yusuke Suzuki pointed out the critical flaw in the approach to free up r11 for use as the ws1 scratch register.
I had missed that r11 was used as a scratch register not only within the offlineasm compiler, but also with MacroAssemblerX86. Using r11 was
working and passed tests - but it’d also be very brittle going forward, as r11 could get clobbered by a new instruction, or through inserted 
JIT compiled code (once enabled on Windows).</p>

<p>I did have the tests passing using r11 though - which meant I could easily try switching from r11 to one of the available callee save 
registers on Windows and run the tests. I tried csr2 (rdi) as a replacement and ran into a problem - the tests passed on debug builds,
but were crashing on release builds.</p>

<p>After running the release build with a debugger attached, the problem became apparent. Here’s the segfault:</p>

<p><img src="https://iangrunert.com/docs/assets/images/works-on-debug-1.png" alt="Segfault thrown on the vmEntryToWasm line"/></p>

<p>Looking at the disassembly for that:</p>

<p><img src="https://iangrunert.com/docs/assets/images/works-on-debug-2.png" alt="Segfault thrown when referencing rdi after calling into the wasm interpreter"/></p>

<p>The code was calling into the Wasm interpreter, and afterwards continuing to use the rdi register that was clobbered by the 
interpreter. I hadn’t updated the code to save / restore the register appropriately yet.</p>

<p>I’d just gotten lucky with the register allocation in the debug build, that it hadn’t used the rdi register.</p>

  </div></div>
  </body>
</html>
