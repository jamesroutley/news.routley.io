<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://richg42.blogspot.com/2023/04/a-dead-simple-lossless-or-lossy-lz4.html">Original</a>
    <h1>Near-lossless image formats using ultra-fast LZ codecs</h1>
    
    <div id="readability-page-1" class="page"><div id="post-body-2395803353788754720" itemprop="description articleBody">
<p><span>I think simple ultra-high speed lossy (or near-lossless) image codecs, built from the new generation of fast LZ codecs, are going to become more relevant in the future.</span></p><p><span>Computing bottlenecks change over time. As disk space, disk bandwidth, and internet bandwidth increases, older image codecs that squeeze every last bit out of the resulting file become less valuable for many use cases. Eventually websites or products using noticeably lossy compressed images will be less attractive. The <b>bandwidth savings from overly lossy image codecs will become meaningless</b>, and the <b>CPU/user time and battery or grid energy spent on complex decompression steps will be wasted</b>.</span></p><p><span>Eventually, much simpler codecs with lower (weaker) compression ratios that introduce less distortion, but have blazingly fast decompression rates are going to become more common. This core concept motivates this work.</span></p><p><span>One way to construct a simple lossless or lossy image codec with fast decompression is to combine a custom encoding tool with the popular lossless <a href="https://en.wikipedia.org/wiki/LZ4_(compression_algorithm)">LZ4</a> codec. LZ4&#39;s compression and decompression is extremely fast, and the library is reliable, updated often, extensively fuzz tested, and very simple to use. </span></p><p><span>To make it lossy, the encoder needs to precondition the image data so when it&#39;s subsequently compressed by LZ4, the proportion of 4+ byte matches vs. literals is increased compared to the original image data. I&#39;ve been constructing <b>LZ Preconditioners, </b>and building new LZ codecs that amend themselves to this preconditioning step, over the past year.</span></p><p><span>Such a codec will not be able to compete against JPEG, WebP, JPEG 2000, etc. for perceived quality per bit. However, it&#39;ll be extremely fast to decode, very simple, and will likely not bloat executables because the LZ4 library is already present in many codebases. Using LZ4 introduces no new security risks.</span></p><p><span>This LZ preconditioning step must be done in a way that minimizes obvious visible artifacts, as perceived by the <a href="https://en.wikipedia.org/wiki/Visual_system">Human Visual System</a> (HVS). This tradeoff, of increasing distortion but reducing the bitrate is a classic application of <a href="https://en.wikipedia.org/wiki/Rate%E2%80%93distortion_theory">Rate-distortion theory</a>. This is well-known in video coding, and now in GPU texture encoding (which I introduced in 2009 with my &#34;crunch&#34; compression library).</span></p><p><span>The <a href="https://github.com/richgel999/rdopng">rdopng tool on github</a> supports creating lossy LZ4 compressed RGB/RGBA images using a simple rate-distortion model. (Lossless is next, but I wanted to solve the harder problem first.) During the preconditioning step, the LZ4 rate in bits is approximated using a sliding dictionary and a match finder. For each potential match replacement which would introduce distortion into the lookahead buffer, the preconditioner approximates the introduced visual error by computing color error distances in a scaled <a href="https://bottosson.github.io/posts/oklab/">Oklab perceptual colorspace</a>. (Oklab is one of the most powerful colorspaces I&#39;ve used for this sort of work. There are better colorspaces for compression, but Oklab is simple to use and well-documented.)</span></p><p><span>Perceptually, distortions introduced into regions of images surrounded by high frequency details are less noticeable vs. regions containing smooth or gradient features. Before preconditioning, the encoder computes two error scaling masks which indicate which areas of the image contains large or small gradients/smooth regions. These scaling masks suppress introducing distortions (by using longer or more matches) if doing so would be too noticeable to the HVS. This step has a large impact on bitrate and can be improved.</span></p><p><span>To speed up encoding, the preconditioner only examines a window region above and to the left of the lookahead buffer. LZ4&#39;s unfortunate minimum match size of 4 bytes complicates encoding of 24bpp RGB images. Encoding is not very fast due to this search process, but it&#39;s possible to thread it by working on different regions of the image in parallel. The encoder is a proof of principle and testing grounds, and not as fast as it could be, but it works.</span></p><p><span>The encoder also supports angular error metrics for encoding tangent space normal maps.</span></p><p><span>LZ4I images are trivial to decode in any language. A LZ4I image consists of a simple header followed by the LZ4 compressed 24bpp RGB (R first) or RGBA pixel data:</span></p><p><a href="https://blogger.googleusercontent.com/img/a/AVvXsEhxcrm9H5hel9mUeOvd2Ns9JfiRgJJCsJVPUZrlLtB58_HYI7ryXrH4x4Tn_X97SBGlM63acZlRg7k9aNxn2iCoT-xWX8uzhsTLj2Aw3Fa9JwAfovoLemdW4HeYFbqCzXWdfFmcKHKCbICF5jbcUJgmyxIfEwSCkM_wgh77I0KbVvNJSXRsSb4-NRfxVA"><span><img data-original-height="170" data-original-width="592" src="https://blogger.googleusercontent.com/img/a/AVvXsEhxcrm9H5hel9mUeOvd2Ns9JfiRgJJCsJVPUZrlLtB58_HYI7ryXrH4x4Tn_X97SBGlM63acZlRg7k9aNxn2iCoT-xWX8uzhsTLj2Aw3Fa9JwAfovoLemdW4HeYFbqCzXWdfFmcKHKCbICF5jbcUJgmyxIfEwSCkM_wgh77I0KbVvNJSXRsSb4-NRfxVA=s16000"/></span></a></p><div><p><span>Lossless original PNG image, 19.577 bits/pixel PNG, or 20.519 bits/pixel LZ4I:</span></p><p><span>Lossy LZ4I: 42.630 709 Y dB,  12.985 bits/pixel, 1.1 gigapixels/sec. decompression rate using <span>LZ4_decompress_safe() </span>(on a mobile Core i7 1065G7 at 1.3GHz base clock)<span>:</span></span></p><p><a href="https://blogger.googleusercontent.com/img/a/AVvXsEggH4yJHbhpN_YSsE9StsDOXvmax0d3dezuQF4nzVZKVmDYJoRfFbz5TvWWQlA-rgufqDyW7FZCTypM5dmCCFX8GSvO9Tths6_deGIEA51DHduWCvvnz97yDr6k48AKHndeZCm4KlLh3zJBZJHYBSA-Lkwrs5Pn9Hkcw5wOKb5tTyXk0a9znOq_bR38_g"><span><img data-original-height="768" data-original-width="1024" src="https://blogger.googleusercontent.com/img/a/AVvXsEggH4yJHbhpN_YSsE9StsDOXvmax0d3dezuQF4nzVZKVmDYJoRfFbz5TvWWQlA-rgufqDyW7FZCTypM5dmCCFX8GSvO9Tths6_deGIEA51DHduWCvvnz97yDr6k48AKHndeZCm4KlLh3zJBZJHYBSA-Lkwrs5Pn9Hkcw5wOKb5tTyXk0a9znOq_bR38_g=s16000"/></span></a></p><p><span>Biased delta image:</span></p><p><a href="https://blogger.googleusercontent.com/img/a/AVvXsEjLWmmg6XHkpa6rObzxx0d3FQj3cmD92UuQzINnUavhc7Q0K4w1nSGUTomDeE3MbW5cjsk4dKducG9M7qPwll9PImCBx5o2R6TBZg-pf9GzFhnPiSbFVrJcPHncxJ2h1lTOsQTzGLjxiWt0YpHyuHByD3im5jMjYDVNqWmjFyCODhzdEecWBDIHtefPMw"><span><img data-original-height="768" data-original-width="1024" src="https://blogger.googleusercontent.com/img/a/AVvXsEjLWmmg6XHkpa6rObzxx0d3FQj3cmD92UuQzINnUavhc7Q0K4w1nSGUTomDeE3MbW5cjsk4dKducG9M7qPwll9PImCBx5o2R6TBZg-pf9GzFhnPiSbFVrJcPHncxJ2h1lTOsQTzGLjxiWt0YpHyuHByD3im5jMjYDVNqWmjFyCODhzdEecWBDIHtefPMw=s16000"/></span></a></p><p><span>Greyscale histogram of biased delta image:</span></p><p><a href="https://blogger.googleusercontent.com/img/a/AVvXsEiXj0VBT_QmTVyCQIIyYGttp2hsUFhpeb2sSgKU6j1aaGVx9j-v3U4rXQyr8m9MR3n_RBQCr4Qi6FxwQi_fp_b4tGifvHwAXEbPRooJgPQnGYHCynE3qsMrp1Uk96F_lblEyGylhOtpcN2IoL0sZ9p-lwNQM5MmtahKR4sgUHUI5agi4jznOVL4mSQOKw"><span><img data-original-height="301" data-original-width="551" src="https://blogger.googleusercontent.com/img/a/AVvXsEiXj0VBT_QmTVyCQIIyYGttp2hsUFhpeb2sSgKU6j1aaGVx9j-v3U4rXQyr8m9MR3n_RBQCr4Qi6FxwQi_fp_b4tGifvHwAXEbPRooJgPQnGYHCynE3qsMrp1Uk96F_lblEyGylhOtpcN2IoL0sZ9p-lwNQM5MmtahKR4sgUHUI5agi4jznOVL4mSQOKw=s16000"/></span></a></p></div><p><span>A more lossy LZ4I encoding, 38.019 709 Y dB, 8.319 bits/pixel:</span></p><div><p><a href="https://blogger.googleusercontent.com/img/a/AVvXsEixIyzJw36tkSloMEjJS_f-NZSTHNgDIVJ75GDVc8BxQbqPoc3HZFu-Rpx7dmrB7Tjgzc9pBY83GNuKcVcPMo6DVqQ8lAKOyrxcJY-TOqspAynCKnC9B4-LrVwESsLlp6AM2CmppeItZQ_KMBXX0L4vTUHycICPamfVRe7bXrx6xp2p1CZLr3QcRSbq6g"><span><img data-original-height="768" data-original-width="1024" src="https://blogger.googleusercontent.com/img/a/AVvXsEixIyzJw36tkSloMEjJS_f-NZSTHNgDIVJ75GDVc8BxQbqPoc3HZFu-Rpx7dmrB7Tjgzc9pBY83GNuKcVcPMo6DVqQ8lAKOyrxcJY-TOqspAynCKnC9B4-LrVwESsLlp6AM2CmppeItZQ_KMBXX0L4vTUHycICPamfVRe7bXrx6xp2p1CZLr3QcRSbq6g=s16000"/></span></a></p></div><div><p><a href="https://blogger.googleusercontent.com/img/a/AVvXsEh1y2gv8Qc8_StBX6jqGxxFuaym5V-WEV9mHufLMvFnvZs7rZPEltKNQQKmdhDuIQ7MZFP0KYog35HCfPXNBFjZWu6RZDqzlYuUZfZ8LjFL8rAlRWwVCgq2gcUSnp3OojsHniETPmwP7jgkBz1ADvQMvoj__1914N_3uI6t4MK1vsh8q_-FrglVNxac1A"><span><img data-original-height="768" data-original-width="1024" src="https://blogger.googleusercontent.com/img/a/AVvXsEh1y2gv8Qc8_StBX6jqGxxFuaym5V-WEV9mHufLMvFnvZs7rZPEltKNQQKmdhDuIQ7MZFP0KYog35HCfPXNBFjZWu6RZDqzlYuUZfZ8LjFL8rAlRWwVCgq2gcUSnp3OojsHniETPmwP7jgkBz1ADvQMvoj__1914N_3uI6t4MK1vsh8q_-FrglVNxac1A=s16000"/></span></a></p></div><div><p><a href="https://blogger.googleusercontent.com/img/a/AVvXsEjkiUGmi7HxV0QPCKRmQofpJ7BjgbZqVklJAGzEX4DMyrkzBlt0E41fO7PXxNDaYjGpr4a-2nKG0Kv1FhM4p65JykCFlvXV5hnVE7F2d9HLb9zIqehBi_ipMaUedefVEaoeeRIqPFNk5CkI8CJD1eyhAAEa-4NsW6VFQKosg2oCYdQnSuMnF7tnp0_-WA"><span><img data-original-height="291" data-original-width="546" src="https://blogger.googleusercontent.com/img/a/AVvXsEjkiUGmi7HxV0QPCKRmQofpJ7BjgbZqVklJAGzEX4DMyrkzBlt0E41fO7PXxNDaYjGpr4a-2nKG0Kv1FhM4p65JykCFlvXV5hnVE7F2d9HLb9zIqehBi_ipMaUedefVEaoeeRIqPFNk5CkI8CJD1eyhAAEa-4NsW6VFQKosg2oCYdQnSuMnF7tnp0_-WA=s16000"/></span></a></p></div><div><p><a href="https://blogger.googleusercontent.com/img/a/AVvXsEire2F3Ly6SzRq81OHQLbB4-5fIvfb3NdambllfVBUoKKU13lAvhN63GVwYkikfqhZ86htur1HPEOFtdZJ8xiGyjiFOz9HzAhLbZztj2EcNUPmJfH70MJISR5xgWXoCDgt4t5fSkGr89yTZOKQDm99ebGwGs-F4hpEBJcEp7YZb2pL_jepiSgOJXu-T9w"><img data-original-height="512" data-original-width="512" src="https://blogger.googleusercontent.com/img/a/AVvXsEire2F3Ly6SzRq81OHQLbB4-5fIvfb3NdambllfVBUoKKU13lAvhN63GVwYkikfqhZ86htur1HPEOFtdZJ8xiGyjiFOz9HzAhLbZztj2EcNUPmJfH70MJISR5xgWXoCDgt4t5fSkGr89yTZOKQDm99ebGwGs-F4hpEBJcEp7YZb2pL_jepiSgOJXu-T9w=s16000"/></a></p><p><span>Lossy LZ4I: 45.758 709 Y dB, 7.433 bits/pixel (less than half the size vs. lossless LZ4I!):</span></p></div><div><p><a href="https://blogger.googleusercontent.com/img/a/AVvXsEhbj6tLCaCYS4t07O1NXGgQu_gS74uqq_zyAkF8zWD12E7wJLqpfDDd0qVbJUUyZR2lZ77BBW-9R0jhJU-OzyXNjH7I8wby6nQWk8sF-vuZTJfVFnFYIyt_YatEn-lkS9SIvKX0LjMF21nn6mr5RfooDhgv6CwVP6x1ACE-PTSdLoJUyUDcclod4Lzoig"><img data-original-height="512" data-original-width="512" src="https://blogger.googleusercontent.com/img/a/AVvXsEhbj6tLCaCYS4t07O1NXGgQu_gS74uqq_zyAkF8zWD12E7wJLqpfDDd0qVbJUUyZR2lZ77BBW-9R0jhJU-OzyXNjH7I8wby6nQWk8sF-vuZTJfVFnFYIyt_YatEn-lkS9SIvKX0LjMF21nn6mr5RfooDhgv6CwVP6x1ACE-PTSdLoJUyUDcclod4Lzoig=s16000"/></a></p></div><p><span>rdopng also supports lossy <a href="https://qoiformat.org/">QOI </a>and PNG encoding. QOI is a particularly attractive for lossy compression because the encoding search space is tiny, however decompression is slower. Lossy QOI encoding is extremely fast vs. PNG/LZ4.</span></p><p><span>It&#39;s also possible to construct specialized preconditioners for other LZ codecs, such as LZMA, Brotli, Zstandard, or <a href="https://github.com/ConorStokes/LZSSE">LZSSE</a>. Note the LZ4 preconditioner demonstrated here is universal (i.e. it&#39;s compatible with any LZ codec) because it just introduces more or longer matches, but it doesn&#39;t exploit the individual LZ commands supported by each codec.</span></p><p><span><b>LZSSE is particularly attractive as a preconditioning target</b> because it&#39;s 30-40% faster than LZ4 and has a higher ratio. This is next. A format that uses tiled decompression and multiple threads is also a no-brainer. Ultimately I think LZ or QOI-like variants will be very strong contenders in the future.</span></p>

</div></div>
  </body>
</html>
