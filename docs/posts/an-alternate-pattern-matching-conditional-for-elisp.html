<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/Articles/961682/">Original</a>
    <h1>An alternate pattern-matching conditional for Elisp</h1>
    
    <div id="readability-page-1" class="page"><div>
<center>
           <div><b>This article brought to you by LWN subscribers</b><p>Subscribers to LWN.net made this article — and everything that
       surrounds it — possible.  If you appreciate our content, please
       <a href="https://lwn.net/subscribe/">buy a subscription</a> and make the next
       set of articles possible.</p></div>
           </center>
           
<p>
One of the outcomes of the (extremely) lengthy discussion about using
Common Lisp features in Emacs Lisp (Elisp), which we <a href="https://lwn.net/Articles/951090/">looked at</a> back in November, was an effort to
start removing some of those uses from Emacs.  The rewrite of some of the
Elisp in Emacs that uses the Common Lisp library (cl-lib) was <a href="https://lwn.net/ml/emacs-devel/E1qvq5s-0003LC-O6@fencepost.gnu.org/">started by
Richard Stallman</a> as a way to reduce the cognitive load needed for
maintaining Emacs itself.  Since then, he has broadened his efforts to
simplify Elisp by adding a new <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Pattern_002dMatching-Conditional.html">pattern-matching
conditional</a> that would be a competitor to <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/pcase-Macro.html"><tt>pcase</tt></a>,
which is a longstanding macro that he finds overly complex.
</p>

<h4>Complexity</h4>

<p>
Back in mid-November, Stallman <a href="https://lwn.net/ml/emacs-devel/E1r3SgH-0007Rb-BU@fencepost.gnu.org/">noted</a> that
he found the &#34;<q>little language</q>&#34; that <tt>pcase</tt> defines to be
&#34;<q>so concise it is 
downright cryptic</q>&#34;.  He recognizes that trying to solve the same set of
problems combining simpler Elisp constructs, such as <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Conditionals.html#index-cond"><tt>cond</tt></a>
and <a href="https://www.gnu.org/software/emacs/manual/html_node/eintr/let.html"><tt>let</tt></a>,
is &#34;<q>long-winded and cumbersome</q>&#34;, but <tt>pcase</tt> has taken the
desire for conciseness to an undesirable extreme.  That imposes a cost on
all Emacs developers who have to maintain code using <tt>pcase</tt>, he
said, so he decided to adapt some <tt>pcase</tt> features in other constructs.
</p>

<p>
Predictably, that led to a long thread—standard fare for the emacs-devel
mailing list—discussing whether there is a need for a <tt>pcase</tt>
alternative, what one 
might look like, and more.  Stallman <a href="https://lwn.net/ml/emacs-devel/E1r4Bci-00043P-VJ@fencepost.gnu.org/">started a new
sub-thread</a> to investigate his ideas for a new macro, <tt>cond*</tt>,
which would 
provide a simpler pattern-matching construct that is still more concise
than using &#34;<q>old-fashioned Lisp</q>&#34;.
His new macro is meant to combine the conditional <tt>cond</tt> form, which
handles 
checking for multiple different values—something like <a href="https://en.wikipedia.org/wiki/Switch_statement">switch constructs</a>
in other languages—with <tt>let</tt>, which temporarily binds values to
variables within a limited scope.  <tt>pcase</tt> and <tt>cond*</tt> are
both designed to provide an <a href="https://en.wikibooks.org/wiki/Standard_ML_Programming/Expressions#Case_expressions_and_pattern-matching">ML-style
pattern-matching conditional</a> mechanism for Elisp.
</p>

<p>
A simple <tt>pcase</tt> example may give the general flavor of these
constructs, but there is a great deal more that both can do,
including pattern matching and pulling lists and other data structures
apart, which is known as &#34;destructuring&#34;.  This
example, taken from the <tt>pcase</tt> documentation, 
handles several different types (e.g. string, symbol) for a return code,
producing an appropriate message for each:
</p><pre>    (pcase (get-return-code x)
      ;; string
      ((and (pred stringp) msg)
       (message &#34;%s&#34; msg))

      ;; symbol
      (&#39;success       (message &#34;Done!&#34;))
      (&#39;would-block   (message &#34;Sorry, can&#39;t do it now&#34;))
      (&#39;read-only     (message &#34;The schmilblick is read-only&#34;))
      (&#39;access-denied (message &#34;You do not have the needed rights&#34;))

      ;; default
      (code           (message &#34;Unknown return code %S&#34; code)))
</pre>


<p>
Stallman characterized his approach as trying to &#34;<q>avoid
the kludginess of pcase&#39;s bells-and-whistles-for-everything approach</q>&#34;.
Naturally, that led to further arguments in favor of <tt>pcase</tt>. For
example,  Michael Heerdegen <a href="https://lwn.net/ml/emacs-devel/878r6u3s7f.fsf@web.de/">said</a>: &#34;<q>In my opinion 
`pcase&#39; comes very close to the optimal solution for its task.</q>&#34;
</p>

<p>
By
mid-December, Stallman was <a href="https://lwn.net/ml/emacs-devel/E1rF4wk-0006QG-G6@fencepost.gnu.org/">asking</a>
about features needed for <tt>cond*</tt> &#34;<q>so that it is rare to
encounter a pcase 
that can&#39;t be replaced cleanly</q>&#34;. That
conversation took place in <a href="https://lwn.net/ml/emacs-devel/E1rF4wi-0006Q3-Ne@fencepost.gnu.org/">another
branch</a> of the original 
<tt>pcase</tt>-replacement discussion, which makes it a little hard(er) to
follow. In that part of the thread, others were working with Stallman on
<tt>cond*</tt>; once again, there were numerous
helpful suggestions and clarification queries, amidst a few grumbles.
Stallman was clearly making progress on the feature, however.
</p>

<p>
In mid-November, Alan Mackenzie had <a href="https://lwn.net/ml/emacs-devel/ZVp_3zG-W5EnYfRT@ACM/">raised an 
issue</a> that has seemingly lingered with <tt>pcase</tt> since it was
<a href="https://git.savannah.gnu.org/cgit/emacs.git/commit/?id=d02c9bcd096c44b4e3d5e2834c75967b56cdecdd">added</a>
in 2010: documentation.  He pointed to a <a href="https://lists.gnu.org/archive/html/emacs-devel/2015-12/msg00741.html">post</a>
he had made in 2015 that described the problems that existed in the
<tt>pcase</tt> documentation; many of those were addressed at
the time, but there is an <a href="https://lwn.net/ml/emacs-devel/19a64b7a-cec0-ed8a-d413-096451cc7413@gmail.com/">ongoing
effort</a>, led by Jim Porter, to improve the documentation for the macro.
</p>

<p>
Porter listed multiple areas that need attention, including moving the
presentation of the backquote (&#34;<tt>`</tt>&#34;) operator, which is used for
pattern-matching and destructuring, earlier in the <tt>pcase</tt> <a href="https://www.emacswiki.org/emacs/DocString">doc string</a>.  As 
Mackenzie had 
noted, one of the confusing things about <tt>pcase</tt> is its use of two
punctuation marks, backquote and comma (&#34;<tt>,</tt>&#34;), that already have
established 
uses in Elisp macro 
definitions:
&#34;<q>pcase complicated the meaning of ` and ,.  Before pcase these had
definite meanings.  Afterwards, they became highly context dependent.</q>&#34;
</p>

<p>
There were a few responses to Porter&#39;s message, largely in favor of his
ideas; eventually, Emacs co-maintainer Stefan Kangas <a href="https://lwn.net/ml/emacs-devel/CADwFkm=aZB29-Jc_WGBWj+SdwrQJ1KRCqvJUPgaqR=JpWDLVGA@mail.gmail.com/">copied
the post</a> to Stefan Monnier, who is a former Emacs maintainer and the
developer of <tt>pcase</tt>.  Monnier was <a href="https://lwn.net/ml/emacs-devel/jwvbkaejfzz.fsf-monnier+emacs@gnu.org/">generally in
favor</a> as well; 
he thought that the doc string was not really the place for detailed
backquote information, though some reorganization made sense.  Stallman <a href="https://lwn.net/ml/emacs-devel/E1rILvo-0006PN-Ka@fencepost.gnu.org/">took
exception</a> to Porter&#39;s other suggestion to possibly mention
<tt>pcase</tt> in &#34;<a href="https://www.gnu.org/software/emacs/manual/html_node/eintr/index.html">An
Introduction to Programming in Emacs Lisp</a>&#34;. &#34;<q>We should not encourage
people learning 
Emacs Lisp to use pcase.</q>&#34;
</p>

<h4>First draft</h4>

<p>
In mid-January, Stallman 
<a href="https://lwn.net/ml/emacs-devel/E1rQJDv-0001UG-2E@fencepost.gnu.org/">posted a
first draft of <tt>cond*</tt></a>, asking for more testing,
&#34;<q>constructive comments, bug reports, patches, 
and suggestions</q>&#34;.  Andrea Corallo <a href="https://lwn.net/ml/emacs-devel/yp1ttnave7z.fsf@fencepost.gnu.org/">asked</a> about
one particular feature of <tt>cond*</tt>:
</p><blockquote>
what is the reason
for some of these cond* clauses to keep the binding in effect outside
the clause itself and for the whole cond* construct?  At first glance it
doesn&#39;t look very idiomatic in Lisp terms to me.
</blockquote>


<p>
Corallo is referring to the <tt>bind*</tt> sub-clause that can appear
anywhere in the body of the <tt>cond*</tt> to bind variables with a scope
that does not end with the <tt>bind*</tt> that contains them.
Instead, the scope of those variables is the body of the <tt>cond*</tt>
from that point onward, which is a bit of an oddity from the usual
expectation in Lisp.
</p><pre>    (cond*
         (CONDITION FORM)
         ((bind* (x 42)))  ; create a binding of 42 to x
         (CONDITION-using-x FORM-using-x)
         ...)
</pre>


<p>
As  João Távora <a href="https://lwn.net/ml/emacs-devel/CALDnm51H-3vPJLEm40YbX5K559O7mRTxeXg5hG0no73y2Wu4gw@mail.gmail.com/">noted</a>,
others had already asked about that behavior, but he is &#34;<q>not sure we
eventually clarified it</q>&#34;.  He also wondered if <tt>cond*</tt> could be
built using <tt>pcase</tt>; if it is a strict subset of the features of
<tt>pcase</tt>, it might help to do so. It &#34;<q>could actually facilitate
the adoption path for &#39;cond*&#39; (as 
questionable as that path may still be, at least for some parties)</q>&#34;.
But Stallman <a href="https://lwn.net/ml/emacs-devel/E1rRO8o-0001R8-Mx@fencepost.gnu.org/">does not see things
that way</a>; he listed the advantages he sees with <tt>cond*</tt> and
said that he plans to add the new macro to Emacs:
</p><blockquote>
cond* has four basic advances over pcase: making bindings that cover
the rest of the body, matching patterns against various data objects
(not forcibly the same one), use of ordinary Lisp expressions as
conditions in clauses, and the [ability] to make bindings and continue
with further clauses.
<p>
I&#39;m going to do some more testing and then install cond*.
</p></blockquote>


<p>
Adam Porter <a href="https://lwn.net/ml/emacs-devel/86a97153-94eb-4df4-b135-4127d2a00057@alphapapa.net/">asked</a>
Stallman to reconsider installing <tt>cond*</tt> into Emacs proper,
suggesting that he should consider enhancing <tt>pcase</tt> rather than add
a whole new facility that developers will need to learn.  One of the
complaints about <tt>pcase</tt> is that it is a burden to learn; &#34;<q>How
will that burden be helped by having to learn both Pcase and 
cond*?</q>&#34;  (Adam) Porter pointed out that <tt>pcase</tt> could handle many
of the advances Stallman had listed, so there may be a path to enhance
<tt>pcase</tt>:
</p><blockquote>
Your stated reasons for writing cond* were
various shortcomings of Pcase.  Some of those, e.g. the documentation, have
already had volunteers step up to address.  The others could also be
addressed in various ways.  I&#39;ve suggested a few, but you haven&#39;t explained
the reasons for rejecting them.
</blockquote>


<p>
As might be guessed, Stallman <a href="https://lwn.net/ml/emacs-devel/E1rSH01-00025m-B1@fencepost.gnu.org/">did not
agree</a>:
</p><blockquote>
If pcase lacked features for certain specific jobs, it would be [easy]
to fix that by adding a few features.  However, the problem with pcase
is that it has too many features for the job it does.  cond* does the
same jobs with fewer features because they work together better.
</blockquote>


<h4>ELPA?</h4>

<p>
Kangas <a href="https://lwn.net/ml/emacs-devel/CADwFkmmCYZqGrF5KtSED2RHJuqR-nbo0CDL9gSrHFVBD7zUGfQ@mail.gmail.com/">said</a>
that he was not closely following the discussion, but was surprised to hear
that &#34;<q>there was a plan to install `cond*&#39;, or I would have spoken up
sooner</q>&#34;.  Adding <tt>cond*</tt> will necessarily make the job of
maintaining Emacs harder, since <tt>pcase</tt> is not going away, thus
there will be &#34;<q>not one, but two relatively complex macros</q>&#34; that he
will have to know and understand.  That might be worth doing if
<tt>cond*</tt> offered substantial benefits, but he does not see that;
&#34;<q>What I see instead is a mere _version_ of `pcase&#39;.</q>&#34;  So, he
recommended making a new package for the <a href="https://elpa.gnu.org/">GNU Emacs Lisp Package Archive</a> (ELPA),
which will provide &#34;<q>a good way of exploring an alternative version of an
existing 
macro</q>&#34;.
</p>

<p>
The lack of a plan to wholesale replace <tt>pcase</tt> with <tt>cond*</tt>
was seen as a good thing by Kangas.  That avoids a bunch of code churn and
bugs that would naturally result.  But Mackenzie <a href="https://lwn.net/ml/emacs-devel/ZbD_WHup2fSmtYwi@ACM/">disagreed</a>; he thinks that
fully replacing <tt>pcase</tt> would be a good goal for &#34;<q>improving the
readability and 
maintainability of our code at a stroke</q>&#34;.  He thinks that putting it
into an ELPA library is &#34;<q>a way of ensuring it never comes to anything
and just gets 
forgotten about</q>&#34;; a feature branch with an eventual merge into the
Emacs mainline would be a better course.
</p>

<p>
Like several others, Monnier <a href="https://lwn.net/ml/emacs-devel/jwvv87kvtey.fsf-monnier+emacs@gnu.org/">believes</a>
that <tt>cond*</tt> is simply further complicating Elisp.  On the other
hand, he said, it would be a bit hypocritical for him to oppose it:
</p><blockquote>
So, I&#39;m not super enthusiastic about adding such a new form, but being
responsible for the introduction of several such new constructs in ELisp
over the years, I do feel a bit like the pot calling the kettle black.
<p>
So, rather than oppose it, I&#39;ll just point out some things which I think
could be improved (or which offend my taste, as the case may be).
</p></blockquote>


<p>
What followed was an extended back-and-forth between Stallman and Monnier about
<tt>cond*</tt>, its overlaps with <tt>pcase</tt> (and how the two could
perhaps 
&#34;meet in the middle&#34;), some deficiencies in the regular <tt>cond</tt> form
with respect to 
binding inside of the conditional, and more.  Much of the discussion
revolved around Monnier&#39;s concern that the two constructs had overlapping,
but still different, pattern languages:
</p><blockquote>
[...] I see a fairly extensive but hardcoded pattern language, which
seems like a regression compared to Pcase where the pattern language is
built from a few primitives only (with the rest defined on top via
`pcase-defmacro`).  The worst part, tho, is that the two pattern
languages are very similar, and I can&#39;t see any good reason for
the differences.
</blockquote>


<p>
Monnier <a href="https://lwn.net/ml/emacs-devel/jwvttmt8x38.fsf-monnier+emacs@gnu.org/">asserted</a>
that Stallman could just reuse the low-level pattern language of
<tt>pcase</tt> for <tt>cond*</tt>, which would have a number of benefits:
&#34;<q>Less work, less code duplication, less
documentation duplication, less to learn for coders.  And presumably
you&#39;d then improve Pcase, so everyone wins.</q>&#34;
</p>

<p>
The discussion continues as of this writing, though it is unclear which
direction Stallman will take with the pattern language.  That language,
which is implemented by the <tt>match*</tt> form that would be added for
<tt>cond*</tt>, could 
easily be changed to use the <tt>pcase</tt> machinery, Monnier <a href="https://lwn.net/ml/emacs-devel/jwvcysksgl3.fsf-monnier+emacs@gnu.org/">said</a>;
a patch to do so has <a href="https://lwn.net/ml/emacs-devel/jwvmsroqxhc.fsf-monnier+emacs@gnu.org/">already been
sent</a>.  Mackenzie <a href="https://lwn.net/ml/emacs-devel/Zdt3TM4AzmcDSrVq@ACM/">objected</a> to <tt>cond*</tt>
using the <tt>pcase</tt> pattern handling, in part because of a lack of
documentation of the 
low-level <tt>pcase</tt> machinery.  Alfred M. Szmidt <a href="https://lwn.net/ml/emacs-devel/E1reIZh-0000Z1-56@fencepost.gnu.org/">hoped</a> that
eventually <tt>pcase</tt> could be written to use <tt>cond*</tt>, instead
of the reverse, but Monnier <a href="https://lwn.net/ml/emacs-devel/jwvbk84qvii.fsf-monnier+emacs@gnu.org/">said</a> that
would not be technically feasible.
</p>

<h4>Adding <tt>cond*</tt></h4>
<p>
At the end of January, Emacs co-maintainers Eli Zaretskii and Kangas <a href="https://lwn.net/ml/emacs-devel/CADwFkm=p5QWY4Quy1ihrd8u3FX+NALis+OAOnGG0RzWPMihbsQ@mail.gmail.com/">announced</a>
that <tt>cond*</tt> would be installed in the Emacs core as an alternative
to <tt>pcase</tt>; there would be no effort to switch away from
<tt>pcase</tt>, however, as it is &#34;<q>to be considered a matter of
stylistic preference</q>&#34;.  In the post, Kangas makes it clear that
political, rather than strictly technical, considerations were part of the
decision-making process:
</p><blockquote>
Our responsibility as maintainers is first and foremost to ensure that
we can all work together, and unite under a common banner.  Our success
as a project depends on it.  Thus, the last thing we want to do is to
alienate any group of contributors, big or small.
<p>
We believe that this is a more important concern than the arguments for
or against cond* or pcase.  The simple fact is that we have different
backgrounds and experiences, which have tended to land us on either side
of this discussion.  This diversity is a strength, and not a weakness.
</p></blockquote>


<p>
Even that has not satisfied everyone as there are apparently still some
scars from <tt>pcase</tt> being installed in Emacs 14 years ago, at
least <a href="https://lwn.net/ml/emacs-devel/ZbZ5m1AO5Ltqglvc@ACM/">for Mackenzie</a>.
He believes that the middle path chosen by the maintainers will not help
resolve the problems that he and others have in understanding some
<tt>pcase</tt> uses; he would still advocate a wholesale replacement using
<tt>cond*</tt>.  Stallman, on the other hand, <a href="https://lwn.net/ml/emacs-devel/E1rUfF3-00068E-Jd@fencepost.gnu.org/">does not
think that <tt>pcase</tt> should be replaced</a>, but does &#34;<q>hope to
discourage its use inside Emacs in 
favor of cond*</q>&#34;.  And, of course, the decision did not stop yet another
<a href="https://lwn.net/ml/emacs-devel/DU2PR02MB10109F1CBA5F7A8D78A597A5D96472@DU2PR02MB10109.eurprd02.prod.outlook.com/">discussion
of &#34;<tt>cond*</tt> versus <tt>pcase</tt>&#34;</a> from breaking out and,
naturally, continuing at length.
</p>

<p>
At the end of January, Stallman <a href="https://lwn.net/ml/emacs-devel/E1rVO51-00077C-A0@fencepost.gnu.org/">said</a> that
he was close to ready to commit the code to the <a href="https://lwn.net/ml/emacs-devel/E1rVO51-00077C-A0@fencepost.gnu.org/">Emacs Git
repository</a>, though that has not happened as of this writing.  Zaretskii
<a href="https://lwn.net/ml/emacs-devel/86cytg1vcu.fsf@gnu.org/">asked</a> that
documentation be added to the <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/index.html">Elisp
reference manual</a> 
at the same time, so that may have slowed the process some.  Before long,
though, <tt>cond*</tt> should make an appearance in Emacs, so there will be
two options for conditionals with pattern-matching and destructuring
capabilities—for good or ill.
</p></div></div>
  </body>
</html>
