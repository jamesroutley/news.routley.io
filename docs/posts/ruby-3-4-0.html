<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.ruby-lang.org/en/news/2024/12/25/ruby-3-4-0-released/">Original</a>
    <h1>Ruby 3.4.0</h1>
    
    <div id="readability-page-1" class="page"><div id="content">
    <p>Posted by naruse on 25 Dec 2024</p>

    
<p>We are pleased to announce the release of Ruby 3.4.0. Ruby 3.4 adds <code>it</code> block parameter reference,
change Prism as default parser, adds Happy Eyeballs Version 2 support to socket library, improves YJIT,
adds Modular GC, and so on.</p>

<h2><code>it</code> is introduced</h2>

<p><code>it</code> is added to reference a block parameter with no variable name. [<a href="https://bugs.ruby-lang.org/issues/18980">Feature #18980</a>]</p>

<div><div><pre><code><span>ary</span> <span>=</span> <span>[</span><span>&#34;foo&#34;</span><span>,</span> <span>&#34;bar&#34;</span><span>,</span> <span>&#34;baz&#34;</span><span>]</span>

<span>p</span> <span>ary</span><span>.</span><span>map</span> <span>{</span> <span>it</span><span>.</span><span>upcase</span> <span>}</span> <span>#=&gt; [&#34;FOO&#34;, &#34;BAR&#34;, &#34;BAZ&#34;]</span>
</code></pre></div></div>

<p><code>it</code> very much behaves the same as <code>_1</code>. When the intention is to only use <code>_1</code> in a block, the potential for other numbered parameters such as <code>_2</code> to also appear imposes an extra cognitive load onto readers. So <code>it</code> was introduced as a handy alias. Use <code>it</code> in simple cases where <code>it</code> speaks for itself, such as in one-line blocks.</p>

<h2>Prism is now the default parser</h2>

<p>Switch the default parser from parse.y to Prism. [<a href="https://bugs.ruby-lang.org/issues/20564">Feature #20564</a>]</p>

<p>This is an internal improvement and there should be little change visible to the user. If you notice any compatibility issues, please report them to us.</p>

<p>To use the conventional parser, use the command-line argument <code>--parser=parse.y</code>.</p>

<h2>The socket library now features Happy Eyeballs Version 2 (RFC 8305)</h2>

<p>The socket library now features <a href="https://datatracker.ietf.org/doc/html/rfc8305">Happy Eyeballs Version 2 (RFC 8305)</a>, the latest standardized version of a widely adopted approach for better connectivity in many programming languages, in <code>TCPSocket.new</code> (<code>TCPSocket.open</code>) and <code>Socket.tcp</code>.
This improvement enables Ruby to provide efficient and reliable network connections, adapted to modern internet environments.</p>

<p>Until Ruby 3.3, these methods performed name resolution and connection attempts serially. With this algorithm, they now operate as follows:</p>

<ol>
  <li>Performs IPv6 and IPv4 name resolution concurrently</li>
  <li>Attempt connections to the resolved IP addresses, prioritizing IPv6, with parallel attempts staggered at 250ms intervals</li>
  <li>Return the first successful connection while canceling any others</li>
</ol>

<p>This ensures minimized connection delays, even if a specific protocol or IP address is delayed or unavailable.
This feature is enabled by default, so additional configuration is not required to use it. To disable it globally, set the environment variable <code>RUBY_TCP_NO_FAST_FALLBACK=1</code> or call <code>Socket.tcp_fast_fallback=false</code>. Or to disable it on a per-method basis, use the keyword argument <code>fast_fallback: false</code>.</p>

<h2>YJIT</h2>

<h3>TL;DR</h3>

<ul>
  <li>Better performance across most benchmarks on both x86-64 and arm64 platforms.</li>
  <li>Reduced memory usage through compressed metadata and a unified memory limit.</li>
  <li>Various bug fixes: YJIT is now more robust and thoroughly tested.</li>
</ul>

<h3>New features</h3>

<ul>
  <li>Command-line options
    <ul>
      <li><code>--yjit-mem-size</code> introduces a unified memory limit (default 128MiB) to track total YJIT memory usage,
providing a more intuitive alternative to the old <code>--yjit-exec-mem-size</code> option.</li>
      <li><code>--yjit-log</code> enables a compilation log to track what gets compiled.</li>
    </ul>
  </li>
  <li>Ruby API
    <ul>
      <li><code>RubyVM::YJIT.log</code> provides access to the tail of the compilation log at run-time.</li>
    </ul>
  </li>
  <li>YJIT stats
    <ul>
      <li><code>RubyVM::YJIT.runtime_stats</code> now always provides additional statistics on
 invalidation, inlining, and metadata encoding.</li>
    </ul>
  </li>
</ul>

<h3>New optimizations</h3>

<ul>
  <li>Compressed context reduces memory needed to store YJIT metadata</li>
  <li>Allocate registers for local variables and Ruby method arguments</li>
  <li>When YJIT is enabled, use more Core primitives written in Ruby:
    <ul>
      <li><code>Array#each</code>, <code>Array#select</code>, <code>Array#map</code> rewritten in Ruby for better performance [<a href="https://bugs.ruby-lang.org/issues/20182">Feature #20182</a>].</li>
    </ul>
  </li>
  <li>Ability to inline small/trivial methods such as:
    <ul>
      <li>Empty methods</li>
      <li>Methods returning a constant</li>
      <li>Methods returning <code>self</code></li>
      <li>Methods directly returning an argument</li>
    </ul>
  </li>
  <li>Specialized codegen for many more runtime methods</li>
  <li>Optimize <code>String#getbyte</code>, <code>String#setbyte</code> and other string methods</li>
  <li>Optimize bitwise operations to speed up low-level bit/byte manipulation</li>
  <li>Support shareable constants in multi-ractor mode</li>
  <li>Various other incremental optimizations</li>
</ul>

<h2>Modular GC</h2>

<ul>
  <li>
    <p>Alternative garbage collector (GC) implementations can be loaded dynamically
through the modular garbage collector feature. To enable this feature,
configure Ruby with <code>--with-modular-gc</code> at build time. GC libraries can be
loaded at runtime using the environment variable <code>RUBY_GC_LIBRARY</code>.
[<a href="https://bugs.ruby-lang.org/issues/20351">Feature #20351</a>]</p>
  </li>
  <li>
    <p>Ruby’s built-in garbage collector has been split into a separate file at
<code>gc/default/default.c</code> and interacts with Ruby using an API defined in
<code>gc/gc_impl.h</code>. The built-in garbage collector can now also be built as a
library using <code>make modular-gc MODULAR_GC=default</code> and enabled using the
environment variable <code>RUBY_GC_LIBRARY=default</code>. [<a href="https://bugs.ruby-lang.org/issues/20470">Feature #20470</a>]</p>
  </li>
  <li>
    <p>An experimental GC library is provided based on <a href="https://www.mmtk.io/">MMTk</a>.
This GC library can be built using <code>make modular-gc MODULAR_GC=mmtk</code> and
enabled using the environment variable <code>RUBY_GC_LIBRARY=mmtk</code>. This requires
the Rust toolchain on the build machine. [<a href="https://bugs.ruby-lang.org/issues/20860">Feature #20860</a>]</p>
  </li>
</ul>

<h2>Language changes</h2>

<ul>
  <li>
    <p>String literals in files without a <code>frozen_string_literal</code> comment now emit a deprecation warning
when they are mutated.
These warnings can be enabled with <code>-W:deprecated</code> or by setting <code>Warning[:deprecated] = true</code>.
To disable this change, you can run Ruby with the <code>--disable-frozen-string-literal</code>
command line argument. [<a href="https://bugs.ruby-lang.org/issues/20205">Feature #20205</a>]</p>
  </li>
  <li>
    <p>Keyword splatting <code>nil</code> when calling methods is now supported.
<code>**nil</code> is treated similarly to <code>**{}</code>, passing no keywords,
and not calling any conversion methods.  [<a href="https://bugs.ruby-lang.org/issues/20064">Bug #20064</a>]</p>
  </li>
  <li>
    <p>Block passing is no longer allowed in index.  [<a href="https://bugs.ruby-lang.org/issues/19918">Bug #19918</a>]</p>
  </li>
  <li>
    <p>Keyword arguments are no longer allowed in index.  [<a href="https://bugs.ruby-lang.org/issues/20218">Bug #20218</a>]</p>
  </li>
  <li>
    <p>The toplevel name <code>::Ruby</code> is reserved now, and the definition will be warned when <code>Warning[:deprecated]</code>.  [<a href="https://bugs.ruby-lang.org/issues/20884">Feature #20884</a>]</p>
  </li>
</ul>

<h2>Core classes updates</h2>

<p>Note: We’re only listing notable updates of Core class.</p>

<ul>
  <li>
    <p>Exception</p>

    <ul>
      <li><code>Exception#set_backtrace</code> now accepts an array of <code>Thread::Backtrace::Location</code>.
<code>Kernel#raise</code>, <code>Thread#raise</code> and <code>Fiber#raise</code> also accept this new format. [<a href="https://bugs.ruby-lang.org/issues/13557">Feature #13557</a>]</li>
    </ul>
  </li>
  <li>
    <p>GC</p>

    <ul>
      <li>
        <p><code>GC.config</code> added to allow setting configuration variables on the Garbage
Collector. [<a href="https://bugs.ruby-lang.org/issues/20443">Feature #20443</a>]</p>
      </li>
      <li>
        <p>GC configuration parameter <code>rgengc_allow_full_mark</code> introduced.  When <code>false</code>
GC will only mark young objects. Default is <code>true</code>.  [<a href="https://bugs.ruby-lang.org/issues/20443">Feature #20443</a>]</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Ractor</p>

    <ul>
      <li>
        <p><code>require</code> in Ractor is allowed. The requiring process will be run on
the main Ractor.
<code>Ractor._require(feature)</code> is added to run requiring process on the
main Ractor.
[<a href="https://bugs.ruby-lang.org/issues/20627">Feature #20627</a>]</p>
      </li>
      <li>
        <p><code>Ractor.main?</code> is added. [<a href="https://bugs.ruby-lang.org/issues/20627">Feature #20627</a>]</p>
      </li>
      <li>
        <p><code>Ractor.[]</code> and <code>Ractor.[]=</code> are added to access the ractor local storage
of the current Ractor. [<a href="https://bugs.ruby-lang.org/issues/20715">Feature #20715</a>]</p>
      </li>
      <li>
        <p><code>Ractor.store_if_absent(key){ init }</code> is added to initialize ractor local
variables in thread-safty. [<a href="https://bugs.ruby-lang.org/issues/20875">Feature #20875</a>]</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Range</p>

    <ul>
      <li><code>Range#size</code> now raises <code>TypeError</code> if the range is not iterable. [<a href="https://bugs.ruby-lang.org/issues/18984">Misc #18984</a>]</li>
    </ul>
  </li>
</ul>

<h2>Standard Library updates</h2>

<p>Note: We’re only listing notable updates of Standard librarires.</p>

<ul>
  <li>RubyGems
    <ul>
      <li>Add <code>--attestation</code> option to gem push. It enabled to store signature to <a href="https://www.ruby-lang.org/en/news/2024/12/25/ruby-3-4-0-released/sigstore.dev">sigstore.dev</a></li>
    </ul>
  </li>
  <li>Bundler
    <ul>
      <li>Add a <code>lockfile_checksums</code> configuration to include checksums in fresh lockfiles</li>
      <li>Add bundle lock <code>--add-checksums</code> to add checksums to an existing lockfile</li>
    </ul>
  </li>
  <li>
    <p>JSON</p>

    <ul>
      <li>Performance improvements of <code>JSON.parse</code> about 1.5 times faster than json-2.7.x.</li>
    </ul>
  </li>
  <li>
    <p>Tempfile</p>

    <ul>
      <li>The keyword argument <code>anonymous: true</code> is implemented for Tempfile.create.
<code>Tempfile.create(anonymous: true)</code> removes the created temporary file immediately.
So applications don’t need to remove the file.
[<a href="https://bugs.ruby-lang.org/issues/20497">Feature #20497</a>]</li>
    </ul>
  </li>
  <li>
    <p>win32/sspi.rb</p>

    <ul>
      <li>This library is now extracted from the Ruby repository to <a href="https://github.com/ruby/net-http-sspi">ruby/net-http-sspi</a>.
[<a href="https://bugs.ruby-lang.org/issues/20775">Feature #20775</a>]</li>
    </ul>
  </li>
</ul>

<h2>Compatibility issues</h2>

<p>Note: Excluding feature bug fixes.</p>

<ul>
  <li>Error messages and backtrace displays have been changed.
    <ul>
      <li>Use a single quote instead of a backtick as a opening quote. [<a href="https://bugs.ruby-lang.org/issues/16495">Feature #16495</a>]</li>
      <li>Display a class name before a method name (only when the class has a permanent name). [<a href="https://bugs.ruby-lang.org/issues/19117">Feature #19117</a>]</li>
      <li><code>Kernel#caller</code>, <code>Thread::Backtrace::Location</code>’s methods, etc. are also changed accordingly.</li>
    </ul>

    <div><div><pre><code>Old:
test.rb:1:in `foo&#39;: undefined method `time&#39; for an instance of Integer
        from test.rb:2:in `&lt;main&gt;&#39;

New:
test.rb:1:in &#39;Object#foo&#39;: undefined method &#39;time&#39; for an instance of Integer
        from test.rb:2:in &#39;&lt;main&gt;&#39;
</code></pre></div>    </div>
  </li>
  <li>
    <p>Hash#inspect rendering have been changed. [[Bug #20433]]</p>

    <ul>
      <li>Symbol keys are displayed using the modern symbol key syntax: <code>&#34;{user: 1}&#34;</code></li>
      <li>Other keys now have spaces around <code>=&gt;</code>: <code>&#39;{&#34;user&#34; =&gt; 1}&#39;</code>, while previously they didn’t: <code>&#39;{&#34;user&#34;=&gt;1}&#39;</code></li>
    </ul>
  </li>
  <li>
    <p>Kernel#Float() now accepts a decimal string with decimal part omitted. [<a href="https://bugs.ruby-lang.org/issues/20705">Feature #20705</a>]</p>

    <div><div><pre><code><span>Float</span><span>(</span><span>&#34;1.&#34;</span><span>)</span>    <span>#=&gt; 1.0 (previously, an ArgumentError was raised)</span>
<span>Float</span><span>(</span><span>&#34;1.E-1&#34;</span><span>)</span> <span>#=&gt; 0.1 (previously, an ArgumentError was raised)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>String#to_f now accepts a decimal string with decimal part omitted. Note that the result changes when an exponent is specified. [<a href="https://bugs.ruby-lang.org/issues/20705">Feature #20705</a>]</p>

    <div><div><pre><code><span>&#34;1.&#34;</span><span>.</span><span>to_f</span>    <span>#=&gt; 1.0</span>
<span>&#34;1.E-1&#34;</span><span>.</span><span>to_f</span> <span>#=&gt; 0.1 (previously, 1.0 was returned)</span>
</code></pre></div>    </div>
  </li>
  <li>Refinement#refined_class has been removed. [<a href="https://bugs.ruby-lang.org/issues/19714">Feature #19714</a>]</li>
</ul>

<h2>Standard library compatibility issues</h2>

<ul>
  <li>
    <p>DidYouMean</p>

    <ul>
      <li><code>DidYouMean::SPELL_CHECKERS[]=</code> and <code>DidYouMean::SPELL_CHECKERS.merge!</code> are removed.</li>
    </ul>
  </li>
  <li>
    <p>Net::HTTP</p>

    <ul>
      <li>Removed the following deprecated constants:
        <ul>
          <li><code>Net::HTTP::ProxyMod</code></li>
          <li><code>Net::NetPrivate::HTTPRequest</code></li>
          <li><code>Net::HTTPInformationCode</code></li>
          <li><code>Net::HTTPSuccessCode</code></li>
          <li><code>Net::HTTPRedirectionCode</code></li>
          <li><code>Net::HTTPRetriableCode</code></li>
          <li><code>Net::HTTPClientErrorCode</code></li>
          <li><code>Net::HTTPFatalErrorCode</code></li>
          <li><code>Net::HTTPServerErrorCode</code></li>
          <li><code>Net::HTTPResponseReceiver</code></li>
          <li><code>Net::HTTPResponceReceiver</code></li>
        </ul>

        <p>These constants were deprecated from 2012.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Timeout</p>

    <ul>
      <li>Reject negative values for Timeout.timeout. [<a href="https://bugs.ruby-lang.org/issues/20795">Bug #20795</a>]</li>
    </ul>
  </li>
  <li>
    <p>URI</p>

    <ul>
      <li>Switched default parser to RFC 3986 compliant from RFC 2396 compliant.
[<a href="https://bugs.ruby-lang.org/issues/19266">Bug #19266</a>]</li>
    </ul>
  </li>
</ul>

<h2>C API updates</h2>

<ul>
  <li><code>rb_newobj</code> and <code>rb_newobj_of</code> (and corresponding macros <code>RB_NEWOBJ</code>, <code>RB_NEWOBJ_OF</code>, <code>NEWOBJ</code>, <code>NEWOBJ_OF</code>) have been removed. [<a href="https://bugs.ruby-lang.org/issues/20265">Feature #20265</a>]</li>
  <li>Removed deprecated function <code>rb_gc_force_recycle</code>. [<a href="https://bugs.ruby-lang.org/issues/18290">Feature #18290</a>]</li>
</ul>

<h2>Miscellaneous changes</h2>

<ul>
  <li>
    <p>Passing a block to a method which doesn’t use the passed block will show
a warning on verbose mode (<code>-w</code>).
[<a href="https://bugs.ruby-lang.org/issues/15554">Feature #15554</a>]</p>
  </li>
  <li>
    <p>Redefining some core methods that are specially optimized by the interpeter
and JIT like <code>String.freeze</code> or <code>Integer#+</code> now emits a performance class
warning (<code>-W:performance</code> or <code>Warning[:performance] = true</code>).
[<a href="https://bugs.ruby-lang.org/issues/20429">Feature #20429</a>]</p>
  </li>
</ul>

<p>See <a href="https://github.com/ruby/ruby/blob/v3_4_0/NEWS.md">NEWS</a>
or <a href="https://github.com/ruby/ruby/compare/v3_3_0...v3_4_0">commit logs</a>
for more details.</p>

<p>With those changes, <a href="https://github.com/ruby/ruby/compare/v3_3_0...v3_4_0#file_bucket">4942 files changed, 202244 insertions(+), 255528 deletions(-)</a>
since Ruby 3.3.0!</p>

<p>Merry Christmas, Happy Holidays, and enjoy programming with Ruby 3.4!</p>

<h2>Download</h2>

<ul>
  <li>
    <p><a href="https://cache.ruby-lang.org/pub/ruby/3.4/ruby-3.4.0.tar.gz">https://cache.ruby-lang.org/pub/ruby/3.4/ruby-3.4.0.tar.gz</a></p>

    <div><div><pre><code>SIZE: 23153022
SHA1: 8ccb561848a7c460ae08e1a120a47c4a88a79335
SHA256: 068c8523442174bd3400e786f4a6952352c82b1b9f6210fd17fb4823086d3379
SHA512: bc70ecba27d1cdea00879f03487cad137a7d9ab2ad376cfb7a65780ad14da637fa3944eeeede2c04ab31eeafb970c64ccfeeb854c99c1093937ecc1165731562
</code></pre></div>    </div>
  </li>
  <li>
    <p><a href="https://cache.ruby-lang.org/pub/ruby/3.4/ruby-3.4.0.tar.xz">https://cache.ruby-lang.org/pub/ruby/3.4/ruby-3.4.0.tar.xz</a></p>

    <div><div><pre><code>SIZE: 17215572
SHA1: eb25447cc404e8d2e177c62550d0224ebd410e68
SHA256: 0081930db22121eb997207f56c0e22720d4f5d21264b5907693f516c32f233ca
SHA512: 776a2cf3e9ccc77c27500240f168aa3e996b0c7c1ee1ef5a7afc291a06c118444016fde38b5b139c0b800496b8eb1b5456562d833f0edc0658917164763b1af7
</code></pre></div>    </div>
  </li>
  <li>
    <p><a href="https://cache.ruby-lang.org/pub/ruby/3.4/ruby-3.4.0.zip">https://cache.ruby-lang.org/pub/ruby/3.4/ruby-3.4.0.zip</a></p>

    <div><div><pre><code>SIZE: 28310193
SHA1: 26254ca5d3decc28a4e5faec255995265e5270b5
SHA256: c120228038af04554f6363e716b0a32cbf53cf63c6adf9f2c22a24f43dc8b555
SHA512: 4d535ed10db76a6aa74f8a025df319deb28483a7a781c24045906ee7663f1cff9d9f9e71dbc993c9e050113a34b37c7fa2143c355a0a6e1e1029bf2c92213ecc
</code></pre></div>    </div>
  </li>
</ul>

<h2>What is Ruby</h2>

<p>Ruby was first developed by Matz (Yukihiro Matsumoto) in 1993,
and is now developed as Open Source. It runs on multiple platforms
and is used all over the world especially for web development.</p>


  </div></div>
  </body>
</html>
