<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.crisluengo.net/archives/1138/">Original</a>
    <h1>Median filtering (2022)</h1>
    
    <div id="readability-page-1" class="page"><p>By Cris Luengo on <span>Mon 27 June 2022</span>.</p><div>
<p>The median filter is a non-liner smoothing (blurring) filter where an output pixel is
the median value of its neighborhood in the input image. It can be generalized to a percentile filter,
where the median is the 50<sup>th</sup> percentile.</p>
<p><img alt="Result of applying percentile filter with varying parameter" src="https://www.crisluengo.net/images/median_filter_examples.jpg"/></p>
<p>Noisy “trui” image filtered with a percentile filter, from left to right: 100<sup>th</sup> percentile (dilation),
95<sup>th</sup> percentile, 75<sup>th</sup> percentile, 50<sup>th</sup> percentile (median), 25<sup>th</sup> percentile, 5<sup>th</sup> percentile,
0<sup>th</sup> percentile (erosion).</p>
<p>In Mathematical Morphology one talks about a rank filter. Mathematical Morphology is based on the maximum
and minimum values of sets (actually the supremum and infimum values, but the difference is just a technicality).
For noisy images, it sometimes is advantageous to compute the maximum or minimum ignoring a few values, in fact
computing a rank order statistic. So a rank 3 filter is like a maximum filter (a dilation), but ignoring the two
largest values in the neighborhood. The equivalence between the rank filter and the percentile filter is obvious.</p>
<p>In this blog post I want to discuss implementations of the median filter (and, by extension, the percentile
and rank filters). Because computing the median is a non-linear operation, we cannot use the Fourier transform
to aid us. There is also no way to split up the median computation.
We can compute the mean of a set by dividing up the set into smaller sets, compute the mean of each subset,
then compute the mean of the means. We can do the same for the maximum or minimum computation. But for the
median this is not possible. This means that reducing the algorithmic complexity of the median filter is not
a trivial exercise.</p>
<h2>Naive algorithm</h2>
<p>The basic algorithm to compute a median filter would be to compute the median over the neighborhood independently
for each output pixel. This is the algorithm implemented in scikit-image (which actually uses the implementation
in SciPy’s ndimage), as well as the one in DIPlib up to version 3.3.0 (which is the current release, the next
release of DIPlib will include a more efficient algorithm, discussed later).</p>
<p>Computing the median cannot be done in-place. One needs to sort the values, so the simplest approach is to copy
them over into a temporary buffer, sort the buffer, and then find the median value. Sorting <span><svg style="width: 0.565em; height: 0.536em; vertical-align: -0.011em; " viewBox=".06 -5.25 5.65 5.36">
<title>
\(n\)
</title>
<defs>
<path id="eq1-g1-61" d="M5.65-1.24L5.48-1.39C5.4-1.29 5.31-1.18 5.23-1.08C4.88-.64 4.67-.45 4.5-.45C4.39-.45 4.31-.54 4.31-.64C4.31-.74 4.36-.96 4.48-1.39L5.16-3.85C5.23-4.1 5.26-4.36 5.26-4.53C5.26-4.95 4.94-5.25 4.48-5.25C3.72-5.25 2.97-4.53 1.74-2.63L2.54-5.23L2.5-5.25L.57-4.88V-4.69C1.18-4.68 1.33-4.61 1.33-4.37C1.33-4.3 1.32-4.23 1.31-4.17L.17 0H1.06C1.62-1.88 1.73-2.14 2.25-2.95C2.97-4.06 3.57-4.65 4.01-4.65C4.19-4.65 4.3-4.51 4.3-4.3C4.3-4.16 4.23-3.76 4.13-3.39L3.61-1.43C3.45-.81 3.42-.66 3.42-.54C3.42-.08 3.59 .11 3.98 .11C4.51 .11 4.81-.13 5.65-1.24Z"></path>
</defs>
<g id="eq1-page1">
<use x=".06" y="0" xlink:href="#eq1-g1-61"></use>
</g>
</svg></span> values takes
<span><svg style="width: 4.911em; height: 1.114em; vertical-align: -0.260em; " viewBox=".3 -8.54 49.11 11.14">
<title>
\(\mathcal{O}(n \log n)\)
</title>
<defs>
<path id="eq2-g8-103" d="M5.6-4.62V-5.09H4.68C4.44-5.09 4.26-5.12 4.03-5.2L3.76-5.3C3.44-5.42 3.12-5.48 2.81-5.48C1.7-5.48 .82-4.62 .82-3.54C.82-2.79 1.14-2.33 1.93-1.94L1.42-1.46C1.02-1.12 .87-.88 .87-.64C.87-.39 1.01-.25 1.5-.01C.66 .61 .33 1 .33 1.44C.33 2.07 1.26 2.6 2.39 2.6C3.29 2.6 4.22 2.29 4.84 1.79C5.29 1.42 5.49 1.04 5.49 .58C5.49-.15 4.93-.66 4.05-.69L2.51-.76C1.88-.79 1.58-.89 1.58-1.08C1.58-1.32 1.98-1.74 2.3-1.83C2.41-1.82 2.49-1.81 2.53-1.81C2.75-1.79 2.91-1.77 2.98-1.77C3.42-1.77 3.89-1.95 4.26-2.27C4.66-2.61 4.84-3.03 4.84-3.62C4.84-3.97 4.78-4.24 4.61-4.62H5.6ZM5.16 .76C5.16 1.45 4.25 1.92 2.91 1.92C1.86 1.92 1.17 1.57 1.17 1.05C1.17 .77 1.25 .62 1.75 .02C2.14 .11 3.1 .18 3.68 .18C4.76 .18 5.16 .33 5.16 .76ZM3.92-3.16C3.92-2.49 3.57-2.07 3.03-2.07C2.31-2.07 1.81-2.85 1.81-3.99V-4.03C1.81-4.73 2.14-5.15 2.69-5.15C3.06-5.15 3.37-4.94 3.56-4.59C3.78-4.17 3.92-3.62 3.92-3.16Z"></path>
<path id="eq2-g8-108" d="M3.06 0V-.18C2.3-.23 2.17-.35 2.17-1V-8.11L2.12-8.13C1.5-7.93 1.05-7.81 .23-7.61V-7.42H.3C.43-7.43 .57-7.44 .67-7.44C1.05-7.44 1.17-7.28 1.17-6.72V-1.04C1.17-.39 1-.24 .25-.18V0H3.06Z"></path>
<path id="eq2-g8-111" d="M5.6-2.79C5.6-4.35 4.5-5.48 2.98-5.48C1.43-5.48 .35-4.34 .35-2.69C.35-1.08 1.45 .12 2.95 .12S5.6-1.14 5.6-2.79ZM4.53-2.37C4.53-1.02 3.99-.21 3.1-.21C2.63-.21 2.19-.5 1.94-.98C1.61-1.6 1.42-2.43 1.42-3.28C1.42-4.41 1.98-5.15 2.82-5.15C3.82-5.15 4.53-4 4.53-2.37Z"></path>
<path id="eq2-g4-61" d="M5.65-1.24L5.48-1.39C5.4-1.29 5.31-1.18 5.23-1.08C4.88-.64 4.67-.45 4.5-.45C4.39-.45 4.31-.54 4.31-.64C4.31-.74 4.36-.96 4.48-1.39L5.16-3.85C5.23-4.1 5.26-4.36 5.26-4.53C5.26-4.95 4.94-5.25 4.48-5.25C3.72-5.25 2.97-4.53 1.74-2.63L2.54-5.23L2.5-5.25L.57-4.88V-4.69C1.18-4.68 1.33-4.61 1.33-4.37C1.33-4.3 1.32-4.23 1.31-4.17L.17 0H1.06C1.62-1.88 1.73-2.14 2.25-2.95C2.97-4.06 3.57-4.65 4.01-4.65C4.19-4.65 4.3-4.51 4.3-4.3C4.3-4.16 4.23-3.76 4.13-3.39L3.61-1.43C3.45-.81 3.42-.66 3.42-.54C3.42-.08 3.59 .11 3.98 .11C4.51 .11 4.81-.13 5.65-1.24Z"></path>
<path id="eq2-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq2-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq2-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq2-page1">
<use x=".3" y="0" xlink:href="#eq2-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq2-g1-185"></use>
<use x="14.43" y="0" xlink:href="#eq2-g4-61"></use>
<use x="22.56" y="0" xlink:href="#eq2-g8-108"></use>
<use x="25.88" y="0" xlink:href="#eq2-g8-111"></use>
<use x="31.86" y="0" xlink:href="#eq2-g8-103"></use>
<use x="39.89" y="0" xlink:href="#eq2-g4-61"></use>
<use x="46.02" y="0" xlink:href="#eq2-g1-186"></use>
</g>
</svg></span>. We can speed up the process by not sorting the array fully, just enough to get the median value
in its place. For example, using <a href="https://en.wikipedia.org/wiki/Quicksort">the Quicksort algorithm</a> for sorting,
we can always skip one of the two sub-arrays. This is called partial sorting, and in C++ is implemented as
<a href="https://en.cppreference.com/w/cpp/algorithm/nth_element"><code>std::nth_element</code></a>. Partial sorting has a complexity
of <span><svg style="width: 2.366em; height: 1.095em; vertical-align: -0.241em; " viewBox=".3 -8.54 23.66 10.95">
<title>
\(\mathcal{O}(n)\)
</title>
<defs>
<path id="eq3-g4-61" d="M5.65-1.24L5.48-1.39C5.4-1.29 5.31-1.18 5.23-1.08C4.88-.64 4.67-.45 4.5-.45C4.39-.45 4.31-.54 4.31-.64C4.31-.74 4.36-.96 4.48-1.39L5.16-3.85C5.23-4.1 5.26-4.36 5.26-4.53C5.26-4.95 4.94-5.25 4.48-5.25C3.72-5.25 2.97-4.53 1.74-2.63L2.54-5.23L2.5-5.25L.57-4.88V-4.69C1.18-4.68 1.33-4.61 1.33-4.37C1.33-4.3 1.32-4.23 1.31-4.17L.17 0H1.06C1.62-1.88 1.73-2.14 2.25-2.95C2.97-4.06 3.57-4.65 4.01-4.65C4.19-4.65 4.3-4.51 4.3-4.3C4.3-4.16 4.23-3.76 4.13-3.39L3.61-1.43C3.45-.81 3.42-.66 3.42-.54C3.42-.08 3.59 .11 3.98 .11C4.51 .11 4.81-.13 5.65-1.24Z"></path>
<path id="eq3-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq3-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq3-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq3-page1">
<use x=".3" y="0" xlink:href="#eq3-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq3-g1-185"></use>
<use x="14.43" y="0" xlink:href="#eq3-g4-61"></use>
<use x="20.56" y="0" xlink:href="#eq3-g1-186"></use>
</g>
</svg></span> on average.</p>
<p>For integer values, sorting complexity is <span><svg style="width: 2.366em; height: 1.095em; vertical-align: -0.241em; " viewBox=".3 -8.54 23.66 10.95">
<title>
\(\mathcal{O}(n)\)
</title>
<defs>
<path id="eq4-g4-61" d="M5.65-1.24L5.48-1.39C5.4-1.29 5.31-1.18 5.23-1.08C4.88-.64 4.67-.45 4.5-.45C4.39-.45 4.31-.54 4.31-.64C4.31-.74 4.36-.96 4.48-1.39L5.16-3.85C5.23-4.1 5.26-4.36 5.26-4.53C5.26-4.95 4.94-5.25 4.48-5.25C3.72-5.25 2.97-4.53 1.74-2.63L2.54-5.23L2.5-5.25L.57-4.88V-4.69C1.18-4.68 1.33-4.61 1.33-4.37C1.33-4.3 1.32-4.23 1.31-4.17L.17 0H1.06C1.62-1.88 1.73-2.14 2.25-2.95C2.97-4.06 3.57-4.65 4.01-4.65C4.19-4.65 4.3-4.51 4.3-4.3C4.3-4.16 4.23-3.76 4.13-3.39L3.61-1.43C3.45-.81 3.42-.66 3.42-.54C3.42-.08 3.59 .11 3.98 .11C4.51 .11 4.81-.13 5.65-1.24Z"></path>
<path id="eq4-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq4-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq4-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq4-page1">
<use x=".3" y="0" xlink:href="#eq4-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq4-g1-185"></use>
<use x="14.43" y="0" xlink:href="#eq4-g4-61"></use>
<use x="20.56" y="0" xlink:href="#eq4-g1-186"></use>
</g>
</svg></span>, but there is no reduction in complexity for partial
sort in this case.</p>
<p>For a square 2D kernel of <span><svg style="width: 2.516em; height: 0.827em; vertical-align: -0.014em; " viewBox=".49 -8.13 25.16 8.27">
<title>
\(k \times k\)
</title>
<defs>
<path id="eq5-g1-2" d="M6.91-.42L4.25-3.06L6.91-5.72L6.43-6.19L3.79-3.54L1.14-6.19L.67-5.72L3.31-3.06L.67-.42L1.14 .06L3.79-2.6L6.43 .06L6.91-.42Z"></path>
<path id="eq5-g4-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
</defs>
<g id="eq5-page1">
<use x=".49" y="0" xlink:href="#eq5-g4-58"></use>
<use x="9.41" y="0" xlink:href="#eq5-g1-2"></use>
<use x="20.16" y="0" xlink:href="#eq5-g4-58"></use>
</g>
</svg></span> pixels, this implementation thus costs <span><svg style="width: 2.910em; height: 1.265em; vertical-align: -0.241em; " viewBox=".3 -10.24 29.1 12.65">
<title>
\(\mathcal{O}(k^2)\)
</title>
<defs>
<path id="eq6-g8-50" d="M4.15-1.2L4.04-1.24C3.71-.74 3.6-.66 3.21-.66H1.12L2.59-2.2C3.36-3.01 3.7-3.68 3.7-4.36C3.7-5.23 3-5.9 2.09-5.9C1.61-5.9 1.15-5.71 .83-5.36C.55-5.07 .42-4.79 .27-4.17L.45-4.12C.8-4.98 1.12-5.26 1.72-5.26C2.45-5.26 2.95-4.76 2.95-4.03C2.95-3.35 2.55-2.53 1.82-1.76L.26-.1V0H3.67L4.15-1.2Z"></path>
<path id="eq6-g4-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
<path id="eq6-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq6-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq6-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq6-page1">
<use x=".3" y="0" xlink:href="#eq6-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq6-g1-185"></use>
<use x="14.86" y="0" xlink:href="#eq6-g4-58"></use>
<use x="21.12" y="-4.34" xlink:href="#eq6-g8-50"></use>
<use x="26.01" y="0" xlink:href="#eq6-g1-186"></use>
</g>
</svg></span> per pixel.
This is actually a quite efficient algorithm for small kernels, but because of the poor scaling, gets quite expensive
for larger ones.</p>
<h2>Histogram-based algorithm</h2>
<p>Because the median computation cannot be split up, as I mentioned earlier, the only way to reduce the algorithmic
complexity of the filter is to somehow update the data in the temporary buffer (remove the pixels exiting the kernel as
it is shifted over one pixel, and add the pixels entering), and do so in a manner that makes finding the median
cheaper, in a manner that allows re-using the earlier work.</p>
<p>In the case of 8-bit images, sorting can be done efficiently by computing a histogram of the values to be sorted.
Finding the median in the histogram involves summing up the bins of the histogram, the bin where this sum reaches
<span><svg style="width: 2.230em; height: 1.254em; vertical-align: -0.230em; " viewBox=".49 -10.24 22.3 12.54">
<title>
\(k^2/2\)
</title>
<defs>
<use id="eq7-g11-50" xlink:href="#eq7-g8-50" transform="scale(1.36)"></use>
<path id="eq7-g1-157" d="M.74 2.3H1.36L4.74-8.42H4.12L.74 2.3Z"></path>
<path id="eq7-g8-50" d="M4.15-1.2L4.04-1.24C3.71-.74 3.6-.66 3.21-.66H1.12L2.59-2.2C3.36-3.01 3.7-3.68 3.7-4.36C3.7-5.23 3-5.9 2.09-5.9C1.61-5.9 1.15-5.71 .83-5.36C.55-5.07 .42-4.79 .27-4.17L.45-4.12C.8-4.98 1.12-5.26 1.72-5.26C2.45-5.26 2.95-4.76 2.95-4.03C2.95-3.35 2.55-2.53 1.82-1.76L.26-.1V0H3.67L4.15-1.2Z"></path>
<path id="eq7-g4-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
</defs>
<g id="eq7-page1">
<use x=".49" y="0" xlink:href="#eq7-g4-58"></use>
<use x="6.75" y="-4.34" xlink:href="#eq7-g8-50"></use>
<use x="11.64" y="0" xlink:href="#eq7-g1-157"></use>
<use x="17.14" y="0" xlink:href="#eq7-g11-50"></use>
</g>
</svg></span> is the median.
Updating the histogram as we shift the kernel by one pixel costs <span><svg style="width: 2.422em; height: 1.095em; vertical-align: -0.241em; " viewBox=".3 -8.54 24.22 10.95">
<title>
\(\mathcal{O}(k)\)
</title>
<defs>
<path id="eq8-g4-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
<path id="eq8-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq8-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq8-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq8-page1">
<use x=".3" y="0" xlink:href="#eq8-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq8-g1-185"></use>
<use x="14.86" y="0" xlink:href="#eq8-g4-58"></use>
<use x="21.12" y="0" xlink:href="#eq8-g1-186"></use>
</g>
</svg></span> operations, and finding the median
is a fixed number of operations. Thus, for these images, the median filter has a complexity of <span><svg style="width: 2.422em; height: 1.095em; vertical-align: -0.241em; " viewBox=".3 -8.54 24.22 10.95">
<title>
\(\mathcal{O}(k)\)
</title>
<defs>
<path id="eq9-g4-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
<path id="eq9-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq9-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq9-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq9-page1">
<use x=".3" y="0" xlink:href="#eq9-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq9-g1-185"></use>
<use x="14.86" y="0" xlink:href="#eq9-g4-58"></use>
<use x="21.12" y="0" xlink:href="#eq9-g1-186"></use>
</g>
</svg></span>,
much better than the naive implementation.</p>
<p>Note that this algorithm works for kernels of any shape; <span><svg style="width: 0.549em; height: 0.827em; vertical-align: -0.014em; " viewBox=".49 -8.13 5.49 8.27">
<title>
\(k\)
</title>
<defs>
<path id="eq10-g1-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
</defs>
<g id="eq10-page1">
<use x=".49" y="0" xlink:href="#eq10-g1-58"></use>
</g>
</svg></span> is then  the number of pixels that exit and enter
the kernel when shifting it by one pixel. For a compact 2D kernel this is the height of the kernel,
for a non-compact kernel this can be much larger. In 3D it is the height times the depth of the kernel (for example,
for a <span><svg style="width: 4.483em; height: 0.827em; vertical-align: -0.014em; " viewBox=".49 -8.13 44.83 8.27">
<title>
\(k \times k \times k\)
</title>
<defs>
<path id="eq11-g1-2" d="M6.91-.42L4.25-3.06L6.91-5.72L6.43-6.19L3.79-3.54L1.14-6.19L.67-5.72L3.31-3.06L.67-.42L1.14 .06L3.79-2.6L6.43 .06L6.91-.42Z"></path>
<path id="eq11-g4-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
</defs>
<g id="eq11-page1">
<use x=".49" y="0" xlink:href="#eq11-g4-58"></use>
<use x="9.41" y="0" xlink:href="#eq11-g1-2"></use>
<use x="20.16" y="0" xlink:href="#eq11-g4-58"></use>
<use x="29.08" y="0" xlink:href="#eq11-g1-2"></use>
<use x="39.83" y="0" xlink:href="#eq11-g4-58"></use>
</g>
</svg></span> cubic kernel, the complexity is <span><svg style="width: 2.910em; height: 1.265em; vertical-align: -0.241em; " viewBox=".3 -10.24 29.1 12.65">
<title>
\(\mathcal{O}(k^3)\)
</title>
<defs>
<path id="eq12-g8-51" d="M3.77-1.91C3.77-2.36 3.63-2.77 3.38-3.04C3.21-3.23 3.04-3.34 2.66-3.5C3.26-3.91 3.48-4.24 3.48-4.71C3.48-5.42 2.92-5.9 2.11-5.9C1.68-5.9 1.29-5.76 .98-5.48C.72-5.24 .59-5.01 .39-4.49L.52-4.45C.88-5.09 1.28-5.38 1.83-5.38C2.39-5.38 2.79-5 2.79-4.45C2.79-4.13 2.66-3.82 2.44-3.6C2.17-3.34 1.93-3.21 1.34-3V-2.88C1.85-2.88 2.05-2.86 2.26-2.79C2.8-2.59 3.14-2.1 3.14-1.49C3.14-.76 2.65-.19 2-.19C1.76-.19 1.59-.25 1.27-.46C1-.62 .86-.68 .71-.68C.51-.68 .38-.56 .38-.38C.38-.07 .75 .12 1.36 .12C2.04 .12 2.73-.1 3.14-.46S3.77-1.33 3.77-1.91Z"></path>
<path id="eq12-g4-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
<path id="eq12-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq12-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq12-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq12-page1">
<use x=".3" y="0" xlink:href="#eq12-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq12-g1-185"></use>
<use x="14.86" y="0" xlink:href="#eq12-g4-58"></use>
<use x="21.12" y="-4.34" xlink:href="#eq12-g8-51"></use>
<use x="26.01" y="0" xlink:href="#eq12-g1-186"></use>
</g>
</svg></span> for the naive algorithm, and
<span><svg style="width: 2.910em; height: 1.265em; vertical-align: -0.241em; " viewBox=".3 -10.24 29.1 12.65">
<title>
\(\mathcal{O}(k^2)\)
</title>
<defs>
<path id="eq13-g8-50" d="M4.15-1.2L4.04-1.24C3.71-.74 3.6-.66 3.21-.66H1.12L2.59-2.2C3.36-3.01 3.7-3.68 3.7-4.36C3.7-5.23 3-5.9 2.09-5.9C1.61-5.9 1.15-5.71 .83-5.36C.55-5.07 .42-4.79 .27-4.17L.45-4.12C.8-4.98 1.12-5.26 1.72-5.26C2.45-5.26 2.95-4.76 2.95-4.03C2.95-3.35 2.55-2.53 1.82-1.76L.26-.1V0H3.67L4.15-1.2Z"></path>
<path id="eq13-g4-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
<path id="eq13-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq13-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq13-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq13-page1">
<use x=".3" y="0" xlink:href="#eq13-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq13-g1-185"></use>
<use x="14.86" y="0" xlink:href="#eq13-g4-58"></use>
<use x="21.12" y="-4.34" xlink:href="#eq13-g8-50"></use>
<use x="26.01" y="0" xlink:href="#eq13-g1-186"></use>
</g>
</svg></span> for the histogram-based algorithm).</p>
<p>This algorithm is due to T.S. Huang and colleagues <a href="#ref-huang">[1]</a>.</p>
<p>But even for 16-bit images, a histogram becomes unwieldy, because finding the median now is not <span><svg style="width: 5.331em; height: 1.254em; vertical-align: -0.230em; " viewBox="0 -10.24 53.31 12.54">
<title>
\(2^8 / 2 = 128\)
</title>
<defs>
<path id="eq14-g1-61" d="M6.57-3.93V-4.6H.48V-3.93H6.57ZM6.57-1.51V-2.18H.48V-1.51H6.57Z"></path>
<path id="eq14-g4-157" d="M.74 2.3H1.36L4.74-8.42H4.12L.74 2.3Z"></path>
<path id="eq14-g8-49" d="M3.44 0V-.13C2.75-.14 2.61-.23 2.61-.65V-5.89L2.54-5.9L.97-5.11V-4.99C1.07-5.03 1.17-5.07 1.21-5.08C1.36-5.14 1.51-5.18 1.6-5.18C1.78-5.18 1.86-5.05 1.86-4.77V-.81C1.86-.52 1.79-.32 1.65-.24C1.52-.17 1.4-.14 1.03-.13V0H3.44Z"></path>
<path id="eq14-g8-50" d="M4.15-1.2L4.04-1.24C3.71-.74 3.6-.66 3.21-.66H1.12L2.59-2.2C3.36-3.01 3.7-3.68 3.7-4.36C3.7-5.23 3-5.9 2.09-5.9C1.61-5.9 1.15-5.71 .83-5.36C.55-5.07 .42-4.79 .27-4.17L.45-4.12C.8-4.98 1.12-5.26 1.72-5.26C2.45-5.26 2.95-4.76 2.95-4.03C2.95-3.35 2.55-2.53 1.82-1.76L.26-.1V0H3.67L4.15-1.2Z"></path>
<path id="eq14-g8-56" d="M3.89-1.35C3.89-2.03 3.59-2.45 2.53-3.24C3.4-3.7 3.7-4.07 3.7-4.66C3.7-5.38 3.07-5.9 2.2-5.9C1.25-5.9 .54-5.32 .54-4.52C.54-3.96 .71-3.7 1.62-2.9C.68-2.18 .49-1.91 .49-1.32C.49-.47 1.18 .12 2.17 .12C3.21 .12 3.89-.45 3.89-1.35ZM3.22-1.08C3.22-.52 2.83-.12 2.26-.12C1.6-.12 1.15-.63 1.15-1.39C1.15-1.95 1.35-2.31 1.85-2.73L2.38-2.34C3.01-1.89 3.22-1.57 3.22-1.08ZM3.1-4.67C3.1-4.18 2.86-3.78 2.36-3.45C2.31-3.42 2.31-3.42 2.28-3.4C1.5-3.9 1.19-4.31 1.19-4.8C1.19-5.3 1.58-5.66 2.13-5.66C2.73-5.66 3.1-5.28 3.1-4.67Z"></path>
<use id="eq14-g11-49" xlink:href="#eq14-g8-49" transform="scale(1.36)"></use>
<use id="eq14-g11-50" xlink:href="#eq14-g8-50" transform="scale(1.36)"></use>
<use id="eq14-g11-56" xlink:href="#eq14-g8-56" transform="scale(1.36)"></use>
</defs>
<g id="eq14-page1">
<use x="0" y="0" xlink:href="#eq14-g11-50"></use>
<use x="5.98" y="-4.34" xlink:href="#eq14-g8-56"></use>
<use x="10.86" y="0" xlink:href="#eq14-g4-157"></use>
<use x="16.36" y="0" xlink:href="#eq14-g11-50"></use>
<use x="25.66" y="0" xlink:href="#eq14-g1-61"></use>
<use x="36.06" y="0" xlink:href="#eq14-g11-49"></use>
<use x="42.03" y="0" xlink:href="#eq14-g11-50"></use>
<use x="48.01" y="0" xlink:href="#eq14-g11-56"></use>
</g>
</svg></span>
additions on average, but <span><svg style="width: 7.297em; height: 1.261em; vertical-align: -0.230em; " viewBox="0 -10.31 72.97 12.61">
<title>
\(2^{16} / 2 = 32\;768\)
</title>
<defs>
<path id="eq15-g1-61" d="M6.57-3.93V-4.6H.48V-3.93H6.57ZM6.57-1.51V-2.18H.48V-1.51H6.57Z"></path>
<path id="eq15-g8-49" d="M3.44 0V-.13C2.75-.14 2.61-.23 2.61-.65V-5.89L2.54-5.9L.97-5.11V-4.99C1.07-5.03 1.17-5.07 1.21-5.08C1.36-5.14 1.51-5.18 1.6-5.18C1.78-5.18 1.86-5.05 1.86-4.77V-.81C1.86-.52 1.79-.32 1.65-.24C1.52-.17 1.4-.14 1.03-.13V0H3.44Z"></path>
<path id="eq15-g8-50" d="M4.15-1.2L4.04-1.24C3.71-.74 3.6-.66 3.21-.66H1.12L2.59-2.2C3.36-3.01 3.7-3.68 3.7-4.36C3.7-5.23 3-5.9 2.09-5.9C1.61-5.9 1.15-5.71 .83-5.36C.55-5.07 .42-4.79 .27-4.17L.45-4.12C.8-4.98 1.12-5.26 1.72-5.26C2.45-5.26 2.95-4.76 2.95-4.03C2.95-3.35 2.55-2.53 1.82-1.76L.26-.1V0H3.67L4.15-1.2Z"></path>
<path id="eq15-g8-51" d="M3.77-1.91C3.77-2.36 3.63-2.77 3.38-3.04C3.21-3.23 3.04-3.34 2.66-3.5C3.26-3.91 3.48-4.24 3.48-4.71C3.48-5.42 2.92-5.9 2.11-5.9C1.68-5.9 1.29-5.76 .98-5.48C.72-5.24 .59-5.01 .39-4.49L.52-4.45C.88-5.09 1.28-5.38 1.83-5.38C2.39-5.38 2.79-5 2.79-4.45C2.79-4.13 2.66-3.82 2.44-3.6C2.17-3.34 1.93-3.21 1.34-3V-2.88C1.85-2.88 2.05-2.86 2.26-2.79C2.8-2.59 3.14-2.1 3.14-1.49C3.14-.76 2.65-.19 2-.19C1.76-.19 1.59-.25 1.27-.46C1-.62 .86-.68 .71-.68C.51-.68 .38-.56 .38-.38C.38-.07 .75 .12 1.36 .12C2.04 .12 2.73-.1 3.14-.46S3.77-1.33 3.77-1.91Z"></path>
<path id="eq15-g8-54" d="M4.09-1.91C4.09-3.03 3.45-3.74 2.45-3.74C2.06-3.74 1.88-3.68 1.33-3.35C1.56-4.66 2.54-5.61 3.91-5.83L3.9-5.97C2.9-5.89 2.39-5.72 1.76-5.28C.81-4.6 .3-3.61 .3-2.44C.3-1.68 .53-.91 .91-.47C1.24-.09 1.71 .12 2.25 .12C3.34 .12 4.09-.71 4.09-1.91ZM3.3-1.62C3.3-.66 2.96-.12 2.35-.12C1.58-.12 1.11-.94 1.11-2.3C1.11-2.74 1.18-2.99 1.35-3.12C1.54-3.26 1.81-3.34 2.11-3.34C2.86-3.34 3.3-2.71 3.3-1.62Z"></path>
<path id="eq15-g8-55" d="M3.92-5.64V-5.78H.69L.17-4.5L.32-4.43C.7-5.02 .86-5.14 1.34-5.14H3.23L1.5 .07H2.07L3.92-5.64Z"></path>
<path id="eq15-g8-56" d="M3.89-1.35C3.89-2.03 3.59-2.45 2.53-3.24C3.4-3.7 3.7-4.07 3.7-4.66C3.7-5.38 3.07-5.9 2.2-5.9C1.25-5.9 .54-5.32 .54-4.52C.54-3.96 .71-3.7 1.62-2.9C.68-2.18 .49-1.91 .49-1.32C.49-.47 1.18 .12 2.17 .12C3.21 .12 3.89-.45 3.89-1.35ZM3.22-1.08C3.22-.52 2.83-.12 2.26-.12C1.6-.12 1.15-.63 1.15-1.39C1.15-1.95 1.35-2.31 1.85-2.73L2.38-2.34C3.01-1.89 3.22-1.57 3.22-1.08ZM3.1-4.67C3.1-4.18 2.86-3.78 2.36-3.45C2.31-3.42 2.31-3.42 2.28-3.4C1.5-3.9 1.19-4.31 1.19-4.8C1.19-5.3 1.58-5.66 2.13-5.66C2.73-5.66 3.1-5.28 3.1-4.67Z"></path>
<path id="eq15-g4-157" d="M.74 2.3H1.36L4.74-8.42H4.12L.74 2.3Z"></path>
<use id="eq15-g11-50" xlink:href="#eq15-g8-50" transform="scale(1.36)"></use>
<use id="eq15-g11-51" xlink:href="#eq15-g8-51" transform="scale(1.36)"></use>
<use id="eq15-g11-54" xlink:href="#eq15-g8-54" transform="scale(1.36)"></use>
<use id="eq15-g11-55" xlink:href="#eq15-g8-55" transform="scale(1.36)"></use>
<use id="eq15-g11-56" xlink:href="#eq15-g8-56" transform="scale(1.36)"></use>
</defs>
<g id="eq15-page1">
<use x="0" y="0" xlink:href="#eq15-g11-50"></use>
<use x="5.98" y="-4.34" xlink:href="#eq15-g8-49"></use>
<use x="10.36" y="-4.34" xlink:href="#eq15-g8-54"></use>
<use x="15.24" y="0" xlink:href="#eq15-g4-157"></use>
<use x="20.74" y="0" xlink:href="#eq15-g11-50"></use>
<use x="30.04" y="0" xlink:href="#eq15-g1-61"></use>
<use x="40.44" y="0" xlink:href="#eq15-g11-51"></use>
<use x="46.42" y="0" xlink:href="#eq15-g11-50"></use>
<use x="55.71" y="0" xlink:href="#eq15-g11-55"></use>
<use x="61.69" y="0" xlink:href="#eq15-g11-54"></use>
<use x="67.67" y="0" xlink:href="#eq15-g11-56"></use>
</g>
</svg></span>. The constant cost becomes significant compared to the linear
cost for reasonable values of <span><svg style="width: 0.549em; height: 0.827em; vertical-align: -0.014em; " viewBox=".49 -8.13 5.49 8.27">
<title>
\(k\)
</title>
<defs>
<path id="eq16-g1-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
</defs>
<g id="eq16-page1">
<use x=".49" y="0" xlink:href="#eq16-g1-58"></use>
</g>
</svg></span>.</p>
<p>It has been proposed to augment the 16-bit histogram with smaller histograms with wider bins. For example, each
subsequent scale combining 16 bins into one. Updating such a multi-scale histogram is a bit more expensive, but
finding the median becomes much cheaper. Still, this does not allow for an algorithm that can handle floating-point
images efficiently.</p>
<h2>Binary tree algorithm</h2>
<p>The histogram here was used as a data structure that makes it easy to compute the median of a set of values, and
allows this set to be updated (removing and adding values).
A <a href="https://en.wikipedia.org/wiki/Binary_search_tree">binary search tree</a> can perform the same function but does
not rely on values being small integers. A binary search tree is a binary tree where each node contains a value,
and the nodes are sorted such that a node’s left child (and all of its descendants) has a smaller value than the node,
and the node’s right child has a larger value. Inserting a new value into the tree takes <span><svg style="width: 4.093em; height: 1.114em; vertical-align: -0.260em; " viewBox=".3 -8.54 40.93 11.14">
<title>
\(\mathcal{O}(\log n)\)
</title>
<defs>
<path id="eq17-g4-61" d="M5.65-1.24L5.48-1.39C5.4-1.29 5.31-1.18 5.23-1.08C4.88-.64 4.67-.45 4.5-.45C4.39-.45 4.31-.54 4.31-.64C4.31-.74 4.36-.96 4.48-1.39L5.16-3.85C5.23-4.1 5.26-4.36 5.26-4.53C5.26-4.95 4.94-5.25 4.48-5.25C3.72-5.25 2.97-4.53 1.74-2.63L2.54-5.23L2.5-5.25L.57-4.88V-4.69C1.18-4.68 1.33-4.61 1.33-4.37C1.33-4.3 1.32-4.23 1.31-4.17L.17 0H1.06C1.62-1.88 1.73-2.14 2.25-2.95C2.97-4.06 3.57-4.65 4.01-4.65C4.19-4.65 4.3-4.51 4.3-4.3C4.3-4.16 4.23-3.76 4.13-3.39L3.61-1.43C3.45-.81 3.42-.66 3.42-.54C3.42-.08 3.59 .11 3.98 .11C4.51 .11 4.81-.13 5.65-1.24Z"></path>
<path id="eq17-g8-103" d="M5.6-4.62V-5.09H4.68C4.44-5.09 4.26-5.12 4.03-5.2L3.76-5.3C3.44-5.42 3.12-5.48 2.81-5.48C1.7-5.48 .82-4.62 .82-3.54C.82-2.79 1.14-2.33 1.93-1.94L1.42-1.46C1.02-1.12 .87-.88 .87-.64C.87-.39 1.01-.25 1.5-.01C.66 .61 .33 1 .33 1.44C.33 2.07 1.26 2.6 2.39 2.6C3.29 2.6 4.22 2.29 4.84 1.79C5.29 1.42 5.49 1.04 5.49 .58C5.49-.15 4.93-.66 4.05-.69L2.51-.76C1.88-.79 1.58-.89 1.58-1.08C1.58-1.32 1.98-1.74 2.3-1.83C2.41-1.82 2.49-1.81 2.53-1.81C2.75-1.79 2.91-1.77 2.98-1.77C3.42-1.77 3.89-1.95 4.26-2.27C4.66-2.61 4.84-3.03 4.84-3.62C4.84-3.97 4.78-4.24 4.61-4.62H5.6ZM5.16 .76C5.16 1.45 4.25 1.92 2.91 1.92C1.86 1.92 1.17 1.57 1.17 1.05C1.17 .77 1.25 .62 1.75 .02C2.14 .11 3.1 .18 3.68 .18C4.76 .18 5.16 .33 5.16 .76ZM3.92-3.16C3.92-2.49 3.57-2.07 3.03-2.07C2.31-2.07 1.81-2.85 1.81-3.99V-4.03C1.81-4.73 2.14-5.15 2.69-5.15C3.06-5.15 3.37-4.94 3.56-4.59C3.78-4.17 3.92-3.62 3.92-3.16Z"></path>
<path id="eq17-g8-108" d="M3.06 0V-.18C2.3-.23 2.17-.35 2.17-1V-8.11L2.12-8.13C1.5-7.93 1.05-7.81 .23-7.61V-7.42H.3C.43-7.43 .57-7.44 .67-7.44C1.05-7.44 1.17-7.28 1.17-6.72V-1.04C1.17-.39 1-.24 .25-.18V0H3.06Z"></path>
<path id="eq17-g8-111" d="M5.6-2.79C5.6-4.35 4.5-5.48 2.98-5.48C1.43-5.48 .35-4.34 .35-2.69C.35-1.08 1.45 .12 2.95 .12S5.6-1.14 5.6-2.79ZM4.53-2.37C4.53-1.02 3.99-.21 3.1-.21C2.63-.21 2.19-.5 1.94-.98C1.61-1.6 1.42-2.43 1.42-3.28C1.42-4.41 1.98-5.15 2.82-5.15C3.82-5.15 4.53-4 4.53-2.37Z"></path>
<path id="eq17-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq17-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq17-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq17-page1">
<use x=".3" y="0" xlink:href="#eq17-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq17-g1-185"></use>
<use x="14.37" y="0" xlink:href="#eq17-g8-108"></use>
<use x="17.69" y="0" xlink:href="#eq17-g8-111"></use>
<use x="23.67" y="0" xlink:href="#eq17-g8-103"></use>
<use x="31.7" y="0" xlink:href="#eq17-g4-61"></use>
<use x="37.83" y="0" xlink:href="#eq17-g1-186"></use>
</g>
</svg></span>,
and so does removing a value. But computing the median still requires to access half the nodes in order,
which takes <span><svg style="width: 2.366em; height: 1.095em; vertical-align: -0.241em; " viewBox=".3 -8.54 23.66 10.95">
<title>
\(\mathcal{O}(n)\)
</title>
<defs>
<path id="eq18-g4-61" d="M5.65-1.24L5.48-1.39C5.4-1.29 5.31-1.18 5.23-1.08C4.88-.64 4.67-.45 4.5-.45C4.39-.45 4.31-.54 4.31-.64C4.31-.74 4.36-.96 4.48-1.39L5.16-3.85C5.23-4.1 5.26-4.36 5.26-4.53C5.26-4.95 4.94-5.25 4.48-5.25C3.72-5.25 2.97-4.53 1.74-2.63L2.54-5.23L2.5-5.25L.57-4.88V-4.69C1.18-4.68 1.33-4.61 1.33-4.37C1.33-4.3 1.32-4.23 1.31-4.17L.17 0H1.06C1.62-1.88 1.73-2.14 2.25-2.95C2.97-4.06 3.57-4.65 4.01-4.65C4.19-4.65 4.3-4.51 4.3-4.3C4.3-4.16 4.23-3.76 4.13-3.39L3.61-1.43C3.45-.81 3.42-.66 3.42-.54C3.42-.08 3.59 .11 3.98 .11C4.51 .11 4.81-.13 5.65-1.24Z"></path>
<path id="eq18-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq18-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq18-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq18-page1">
<use x=".3" y="0" xlink:href="#eq18-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq18-g1-185"></use>
<use x="14.43" y="0" xlink:href="#eq18-g4-61"></use>
<use x="20.56" y="0" xlink:href="#eq18-g1-186"></use>
</g>
</svg></span>.</p>
<p>An <a href="https://en.wikipedia.org/wiki/Order_statistic_tree">order statistic tree</a> is a binary search tree where each
node additionally records its size, which is given by the number of nodes in the subtree rooted at that node.
That is, a node’s size is the sum of the sizes of the two children plus one. Armed with this additional information,
finding the median (or the node at any given index) takes only <span><svg style="width: 4.093em; height: 1.114em; vertical-align: -0.260em; " viewBox=".3 -8.54 40.93 11.14">
<title>
\(\mathcal{O}(\log n)\)
</title>
<defs>
<path id="eq19-g4-61" d="M5.65-1.24L5.48-1.39C5.4-1.29 5.31-1.18 5.23-1.08C4.88-.64 4.67-.45 4.5-.45C4.39-.45 4.31-.54 4.31-.64C4.31-.74 4.36-.96 4.48-1.39L5.16-3.85C5.23-4.1 5.26-4.36 5.26-4.53C5.26-4.95 4.94-5.25 4.48-5.25C3.72-5.25 2.97-4.53 1.74-2.63L2.54-5.23L2.5-5.25L.57-4.88V-4.69C1.18-4.68 1.33-4.61 1.33-4.37C1.33-4.3 1.32-4.23 1.31-4.17L.17 0H1.06C1.62-1.88 1.73-2.14 2.25-2.95C2.97-4.06 3.57-4.65 4.01-4.65C4.19-4.65 4.3-4.51 4.3-4.3C4.3-4.16 4.23-3.76 4.13-3.39L3.61-1.43C3.45-.81 3.42-.66 3.42-.54C3.42-.08 3.59 .11 3.98 .11C4.51 .11 4.81-.13 5.65-1.24Z"></path>
<path id="eq19-g8-103" d="M5.6-4.62V-5.09H4.68C4.44-5.09 4.26-5.12 4.03-5.2L3.76-5.3C3.44-5.42 3.12-5.48 2.81-5.48C1.7-5.48 .82-4.62 .82-3.54C.82-2.79 1.14-2.33 1.93-1.94L1.42-1.46C1.02-1.12 .87-.88 .87-.64C.87-.39 1.01-.25 1.5-.01C.66 .61 .33 1 .33 1.44C.33 2.07 1.26 2.6 2.39 2.6C3.29 2.6 4.22 2.29 4.84 1.79C5.29 1.42 5.49 1.04 5.49 .58C5.49-.15 4.93-.66 4.05-.69L2.51-.76C1.88-.79 1.58-.89 1.58-1.08C1.58-1.32 1.98-1.74 2.3-1.83C2.41-1.82 2.49-1.81 2.53-1.81C2.75-1.79 2.91-1.77 2.98-1.77C3.42-1.77 3.89-1.95 4.26-2.27C4.66-2.61 4.84-3.03 4.84-3.62C4.84-3.97 4.78-4.24 4.61-4.62H5.6ZM5.16 .76C5.16 1.45 4.25 1.92 2.91 1.92C1.86 1.92 1.17 1.57 1.17 1.05C1.17 .77 1.25 .62 1.75 .02C2.14 .11 3.1 .18 3.68 .18C4.76 .18 5.16 .33 5.16 .76ZM3.92-3.16C3.92-2.49 3.57-2.07 3.03-2.07C2.31-2.07 1.81-2.85 1.81-3.99V-4.03C1.81-4.73 2.14-5.15 2.69-5.15C3.06-5.15 3.37-4.94 3.56-4.59C3.78-4.17 3.92-3.62 3.92-3.16Z"></path>
<path id="eq19-g8-108" d="M3.06 0V-.18C2.3-.23 2.17-.35 2.17-1V-8.11L2.12-8.13C1.5-7.93 1.05-7.81 .23-7.61V-7.42H.3C.43-7.43 .57-7.44 .67-7.44C1.05-7.44 1.17-7.28 1.17-6.72V-1.04C1.17-.39 1-.24 .25-.18V0H3.06Z"></path>
<path id="eq19-g8-111" d="M5.6-2.79C5.6-4.35 4.5-5.48 2.98-5.48C1.43-5.48 .35-4.34 .35-2.69C.35-1.08 1.45 .12 2.95 .12S5.6-1.14 5.6-2.79ZM4.53-2.37C4.53-1.02 3.99-.21 3.1-.21C2.63-.21 2.19-.5 1.94-.98C1.61-1.6 1.42-2.43 1.42-3.28C1.42-4.41 1.98-5.15 2.82-5.15C3.82-5.15 4.53-4 4.53-2.37Z"></path>
<path id="eq19-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq19-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq19-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq19-page1">
<use x=".3" y="0" xlink:href="#eq19-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq19-g1-185"></use>
<use x="14.37" y="0" xlink:href="#eq19-g8-108"></use>
<use x="17.69" y="0" xlink:href="#eq19-g8-111"></use>
<use x="23.67" y="0" xlink:href="#eq19-g8-103"></use>
<use x="31.7" y="0" xlink:href="#eq19-g4-61"></use>
<use x="37.83" y="0" xlink:href="#eq19-g1-186"></use>
</g>
</svg></span>. It is no longer necessary
to traverse all nodes in order from the lowest value to the given index. The node’s size allows the algorithm
to skip most nodes along that path.</p>
<p>So, again assuming a <span><svg style="width: 2.516em; height: 0.827em; vertical-align: -0.014em; " viewBox=".49 -8.13 25.16 8.27">
<title>
\(k \times k\)
</title>
<defs>
<path id="eq20-g1-2" d="M6.91-.42L4.25-3.06L6.91-5.72L6.43-6.19L3.79-3.54L1.14-6.19L.67-5.72L3.31-3.06L.67-.42L1.14 .06L3.79-2.6L6.43 .06L6.91-.42Z"></path>
<path id="eq20-g4-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
</defs>
<g id="eq20-page1">
<use x=".49" y="0" xlink:href="#eq20-g4-58"></use>
<use x="9.41" y="0" xlink:href="#eq20-g1-2"></use>
<use x="20.16" y="0" xlink:href="#eq20-g4-58"></use>
</g>
</svg></span> square kernel, we have <span><svg style="width: 3.076em; height: 1.038em; vertical-align: -0.014em; " viewBox=".06 -10.24 30.76 10.38">
<title>
\(n=k^2\)
</title>
<defs>
<path id="eq21-g1-61" d="M6.57-3.93V-4.6H.48V-3.93H6.57ZM6.57-1.51V-2.18H.48V-1.51H6.57Z"></path>
<path id="eq21-g8-50" d="M4.15-1.2L4.04-1.24C3.71-.74 3.6-.66 3.21-.66H1.12L2.59-2.2C3.36-3.01 3.7-3.68 3.7-4.36C3.7-5.23 3-5.9 2.09-5.9C1.61-5.9 1.15-5.71 .83-5.36C.55-5.07 .42-4.79 .27-4.17L.45-4.12C.8-4.98 1.12-5.26 1.72-5.26C2.45-5.26 2.95-4.76 2.95-4.03C2.95-3.35 2.55-2.53 1.82-1.76L.26-.1V0H3.67L4.15-1.2Z"></path>
<path id="eq21-g4-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
<path id="eq21-g4-61" d="M5.65-1.24L5.48-1.39C5.4-1.29 5.31-1.18 5.23-1.08C4.88-.64 4.67-.45 4.5-.45C4.39-.45 4.31-.54 4.31-.64C4.31-.74 4.36-.96 4.48-1.39L5.16-3.85C5.23-4.1 5.26-4.36 5.26-4.53C5.26-4.95 4.94-5.25 4.48-5.25C3.72-5.25 2.97-4.53 1.74-2.63L2.54-5.23L2.5-5.25L.57-4.88V-4.69C1.18-4.68 1.33-4.61 1.33-4.37C1.33-4.3 1.32-4.23 1.31-4.17L.17 0H1.06C1.62-1.88 1.73-2.14 2.25-2.95C2.97-4.06 3.57-4.65 4.01-4.65C4.19-4.65 4.3-4.51 4.3-4.3C4.3-4.16 4.23-3.76 4.13-3.39L3.61-1.43C3.45-.81 3.42-.66 3.42-.54C3.42-.08 3.59 .11 3.98 .11C4.51 .11 4.81-.13 5.65-1.24Z"></path>
</defs>
<g id="eq21-page1">
<use x=".06" y="0" xlink:href="#eq21-g4-61"></use>
<use x="9.51" y="0" xlink:href="#eq21-g1-61"></use>
<use x="20.4" y="0" xlink:href="#eq21-g4-58"></use>
<use x="26.67" y="-4.34" xlink:href="#eq21-g8-50"></use>
</g>
</svg></span> values in the tree, and for each pixel we need
to remove <span><svg style="width: 0.549em; height: 0.827em; vertical-align: -0.014em; " viewBox=".49 -8.13 5.49 8.27">
<title>
\(k\)
</title>
<defs>
<path id="eq22-g1-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
</defs>
<g id="eq22-page1">
<use x=".49" y="0" xlink:href="#eq22-g1-58"></use>
</g>
</svg></span> values, insert <span><svg style="width: 0.549em; height: 0.827em; vertical-align: -0.014em; " viewBox=".49 -8.13 5.49 8.27">
<title>
\(k\)
</title>
<defs>
<path id="eq23-g1-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
</defs>
<g id="eq23-page1">
<use x=".49" y="0" xlink:href="#eq23-g1-58"></use>
</g>
</svg></span> values, then find the median. This has a complexity of <span><svg style="width: 5.024em; height: 1.114em; vertical-align: -0.260em; " viewBox=".3 -8.54 50.24 11.14">
<title>
\(\mathcal{O}(k \log k)\)
</title>
<defs>
<path id="eq24-g8-103" d="M5.6-4.62V-5.09H4.68C4.44-5.09 4.26-5.12 4.03-5.2L3.76-5.3C3.44-5.42 3.12-5.48 2.81-5.48C1.7-5.48 .82-4.62 .82-3.54C.82-2.79 1.14-2.33 1.93-1.94L1.42-1.46C1.02-1.12 .87-.88 .87-.64C.87-.39 1.01-.25 1.5-.01C.66 .61 .33 1 .33 1.44C.33 2.07 1.26 2.6 2.39 2.6C3.29 2.6 4.22 2.29 4.84 1.79C5.29 1.42 5.49 1.04 5.49 .58C5.49-.15 4.93-.66 4.05-.69L2.51-.76C1.88-.79 1.58-.89 1.58-1.08C1.58-1.32 1.98-1.74 2.3-1.83C2.41-1.82 2.49-1.81 2.53-1.81C2.75-1.79 2.91-1.77 2.98-1.77C3.42-1.77 3.89-1.95 4.26-2.27C4.66-2.61 4.84-3.03 4.84-3.62C4.84-3.97 4.78-4.24 4.61-4.62H5.6ZM5.16 .76C5.16 1.45 4.25 1.92 2.91 1.92C1.86 1.92 1.17 1.57 1.17 1.05C1.17 .77 1.25 .62 1.75 .02C2.14 .11 3.1 .18 3.68 .18C4.76 .18 5.16 .33 5.16 .76ZM3.92-3.16C3.92-2.49 3.57-2.07 3.03-2.07C2.31-2.07 1.81-2.85 1.81-3.99V-4.03C1.81-4.73 2.14-5.15 2.69-5.15C3.06-5.15 3.37-4.94 3.56-4.59C3.78-4.17 3.92-3.62 3.92-3.16Z"></path>
<path id="eq24-g8-108" d="M3.06 0V-.18C2.3-.23 2.17-.35 2.17-1V-8.11L2.12-8.13C1.5-7.93 1.05-7.81 .23-7.61V-7.42H.3C.43-7.43 .57-7.44 .67-7.44C1.05-7.44 1.17-7.28 1.17-6.72V-1.04C1.17-.39 1-.24 .25-.18V0H3.06Z"></path>
<path id="eq24-g8-111" d="M5.6-2.79C5.6-4.35 4.5-5.48 2.98-5.48C1.43-5.48 .35-4.34 .35-2.69C.35-1.08 1.45 .12 2.95 .12S5.6-1.14 5.6-2.79ZM4.53-2.37C4.53-1.02 3.99-.21 3.1-.21C2.63-.21 2.19-.5 1.94-.98C1.61-1.6 1.42-2.43 1.42-3.28C1.42-4.41 1.98-5.15 2.82-5.15C3.82-5.15 4.53-4 4.53-2.37Z"></path>
<path id="eq24-g4-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
<path id="eq24-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq24-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq24-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq24-page1">
<use x=".3" y="0" xlink:href="#eq24-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq24-g1-185"></use>
<use x="14.86" y="0" xlink:href="#eq24-g4-58"></use>
<use x="23.12" y="0" xlink:href="#eq24-g8-108"></use>
<use x="26.44" y="0" xlink:href="#eq24-g8-111"></use>
<use x="32.42" y="0" xlink:href="#eq24-g8-103"></use>
<use x="40.88" y="0" xlink:href="#eq24-g4-58"></use>
<use x="47.14" y="0" xlink:href="#eq24-g1-186"></use>
</g>
</svg></span></p>
<p>The complexity analysis here assumes that the binary tree is balanced. Values in an image are locally correlated,
meaning that the tree is likely to become unbalanced quickly unless we specifically rebalance the tree when needed.
Binary trees typically store some additional value to enable this balancing act (e.g. red-black trees).
One form of self-balancing tree is the <a href="https://en.wikipedia.org/wiki/Weight-balanced_tree">weight-balanced tree</a>,
which keeps the weight of the two subtrees within some factor of each other. Each node stores the weight of the
subtree rooted at that node. The weight is defined as one plus the size of the subtree, and we’re already storing
the size to compute the order statistic. This means that we can keep the order statistic tree balanced without
any additional information or bookkeeping. I followed Hirai and Yamamoto <a href="#ref-hirai">[2]</a> to implement the
balancing scheme, using their proposed (3,2) factors: the weight of the two subtrees are kept within a factor of 3
from each other, and the 2 is used when the balance is broken, to decide on whether to do a single or a double
rotation at the node to restore balance.</p>
<p>Because pixel values are locally correlated, it is likely that there are repeated values in a neighborhood. A simple
modification to the order statistic tree gives it a speed boost when this happens: repeated values are stored in the
same node, which now additionally stores this count. This change means there are fewer nodes to traverse when
inserting or removing values, or when indexing, and so the computational cost is reduced.</p>
<p>This implementation is in DIPlib, <a href="https://github.com/DIPlib/diplib/blob/master/src/nonlinear/percentile.cpp">here</a>.
It will be available in the next release (whichever comes after the current 3.3.0 release), or you can build it yourself.</p>
<p>The binary search tree is a bit more expensive than the naive algorithm for small kernels.
I ran a small experiment to find out how to decide which of the two algorithms to use for any particular call
to the <code>dip::MedianFilter()</code> function. Using a rectangular kernel, I varied the width and height independently,
from 3 to 39, and determined the running time on some sufficiently large image. This is the result (blue is the
naive algorithm, yellow the new order statistic tree algorithm):</p>
<p><img alt="Timing the naive vs order statistic tree implementation of the median filter" src="https://www.crisluengo.net/images/median_filter_naive_vs_tree.png"/></p>
<p>It can clearly be seen that the naive implementation has a running time that is linear in both the width (<span><svg style="width: 0.838em; height: 0.536em; vertical-align: -0.011em; " viewBox=".08 -5.25 8.38 5.36">
<title>
\(m\)
</title>
<defs>
<path id="eq25-g1-60" d="M8.38-1.25L8.21-1.39L7.96-1.08C7.61-.64 7.38-.45 7.18-.45C7.09-.45 7.04-.51 7.04-.64C7.04-.69 7.09-.91 7.16-1.18L7.97-4.17C7.98-4.23 8-4.42 8-4.5C8-4.93 7.71-5.25 7.31-5.25C7.07-5.25 6.86-5.18 6.57-5C5.99-4.63 5.49-4.05 4.66-2.73C4.95-3.64 5.13-4.31 5.13-4.54C5.13-4.97 4.86-5.25 4.45-5.25C3.73-5.25 2.89-4.47 1.8-2.74L2.49-5.23L2.45-5.25L.55-4.88V-4.69H.85C1.17-4.69 1.31-4.61 1.31-4.43C1.31-4.29 1.04-3.2 .61-1.7L.14 0H1.04C1.61-1.88 1.79-2.33 2.19-2.95C2.86-3.97 3.57-4.63 3.98-4.63C4.13-4.63 4.22-4.53 4.22-4.34C4.22-4.18 3.89-2.92 3.38-1.1L3.08 0H3.98C4.44-1.83 4.68-2.43 5.26-3.25C5.86-4.09 6.47-4.63 6.82-4.63C6.96-4.63 7.06-4.53 7.06-4.38C7.06-4.32 7.04-4.2 6.98-3.97L6.29-1.23C6.17-.76 6.13-.56 6.13-.44C6.13-.08 6.3 .11 6.61 .11C7.17 .11 7.69-.29 8.33-1.17L8.38-1.25Z"></path>
</defs>
<g id="eq25-page1">
<use x=".08" y="0" xlink:href="#eq25-g1-60"></use>
</g>
</svg></span>)
and the height (<span><svg style="width: 0.549em; height: 0.827em; vertical-align: -0.014em; " viewBox=".49 -8.13 5.49 8.27">
<title>
\(k\)
</title>
<defs>
<path id="eq26-g1-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
</defs>
<g id="eq26-page1">
<use x=".49" y="0" xlink:href="#eq26-g1-58"></use>
</g>
</svg></span>) of the kernel (<span><svg style="width: 3.344em; height: 1.095em; vertical-align: -0.241em; " viewBox=".3 -8.54 33.44 10.95">
<title>
\(\mathcal{O}(mk)\)
</title>
<defs>
<path id="eq27-g4-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
<path id="eq27-g4-60" d="M8.38-1.25L8.21-1.39L7.96-1.08C7.61-.64 7.38-.45 7.18-.45C7.09-.45 7.04-.51 7.04-.64C7.04-.69 7.09-.91 7.16-1.18L7.97-4.17C7.98-4.23 8-4.42 8-4.5C8-4.93 7.71-5.25 7.31-5.25C7.07-5.25 6.86-5.18 6.57-5C5.99-4.63 5.49-4.05 4.66-2.73C4.95-3.64 5.13-4.31 5.13-4.54C5.13-4.97 4.86-5.25 4.45-5.25C3.73-5.25 2.89-4.47 1.8-2.74L2.49-5.23L2.45-5.25L.55-4.88V-4.69H.85C1.17-4.69 1.31-4.61 1.31-4.43C1.31-4.29 1.04-3.2 .61-1.7L.14 0H1.04C1.61-1.88 1.79-2.33 2.19-2.95C2.86-3.97 3.57-4.63 3.98-4.63C4.13-4.63 4.22-4.53 4.22-4.34C4.22-4.18 3.89-2.92 3.38-1.1L3.08 0H3.98C4.44-1.83 4.68-2.43 5.26-3.25C5.86-4.09 6.47-4.63 6.82-4.63C6.96-4.63 7.06-4.53 7.06-4.38C7.06-4.32 7.04-4.2 6.98-3.97L6.29-1.23C6.17-.76 6.13-.56 6.13-.44C6.13-.08 6.3 .11 6.61 .11C7.17 .11 7.69-.29 8.33-1.17L8.38-1.25Z"></path>
<path id="eq27-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq27-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq27-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq27-page1">
<use x=".3" y="0" xlink:href="#eq27-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq27-g1-185"></use>
<use x="14.45" y="0" xlink:href="#eq27-g4-60"></use>
<use x="24.08" y="0" xlink:href="#eq27-g4-58"></use>
<use x="30.34" y="0" xlink:href="#eq27-g1-186"></use>
</g>
</svg></span>). In contrast, the binary tree implementation has a running
time that is independent of the width, and linear in the height (<span><svg style="width: 2.422em; height: 1.095em; vertical-align: -0.241em; " viewBox=".3 -8.54 24.22 10.95">
<title>
\(\mathcal{O}(k)\)
</title>
<defs>
<path id="eq28-g4-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
<path id="eq28-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq28-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq28-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq28-page1">
<use x=".3" y="0" xlink:href="#eq28-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq28-g1-185"></use>
<use x="14.86" y="0" xlink:href="#eq28-g4-58"></use>
<use x="21.12" y="0" xlink:href="#eq28-g1-186"></use>
</g>
</svg></span>). It is actually
<span><svg style="width: 5.024em; height: 1.114em; vertical-align: -0.260em; " viewBox=".3 -8.54 50.24 11.14">
<title>
\(\mathcal{O}(k \log k)\)
</title>
<defs>
<path id="eq29-g8-103" d="M5.6-4.62V-5.09H4.68C4.44-5.09 4.26-5.12 4.03-5.2L3.76-5.3C3.44-5.42 3.12-5.48 2.81-5.48C1.7-5.48 .82-4.62 .82-3.54C.82-2.79 1.14-2.33 1.93-1.94L1.42-1.46C1.02-1.12 .87-.88 .87-.64C.87-.39 1.01-.25 1.5-.01C.66 .61 .33 1 .33 1.44C.33 2.07 1.26 2.6 2.39 2.6C3.29 2.6 4.22 2.29 4.84 1.79C5.29 1.42 5.49 1.04 5.49 .58C5.49-.15 4.93-.66 4.05-.69L2.51-.76C1.88-.79 1.58-.89 1.58-1.08C1.58-1.32 1.98-1.74 2.3-1.83C2.41-1.82 2.49-1.81 2.53-1.81C2.75-1.79 2.91-1.77 2.98-1.77C3.42-1.77 3.89-1.95 4.26-2.27C4.66-2.61 4.84-3.03 4.84-3.62C4.84-3.97 4.78-4.24 4.61-4.62H5.6ZM5.16 .76C5.16 1.45 4.25 1.92 2.91 1.92C1.86 1.92 1.17 1.57 1.17 1.05C1.17 .77 1.25 .62 1.75 .02C2.14 .11 3.1 .18 3.68 .18C4.76 .18 5.16 .33 5.16 .76ZM3.92-3.16C3.92-2.49 3.57-2.07 3.03-2.07C2.31-2.07 1.81-2.85 1.81-3.99V-4.03C1.81-4.73 2.14-5.15 2.69-5.15C3.06-5.15 3.37-4.94 3.56-4.59C3.78-4.17 3.92-3.62 3.92-3.16Z"></path>
<path id="eq29-g8-108" d="M3.06 0V-.18C2.3-.23 2.17-.35 2.17-1V-8.11L2.12-8.13C1.5-7.93 1.05-7.81 .23-7.61V-7.42H.3C.43-7.43 .57-7.44 .67-7.44C1.05-7.44 1.17-7.28 1.17-6.72V-1.04C1.17-.39 1-.24 .25-.18V0H3.06Z"></path>
<path id="eq29-g8-111" d="M5.6-2.79C5.6-4.35 4.5-5.48 2.98-5.48C1.43-5.48 .35-4.34 .35-2.69C.35-1.08 1.45 .12 2.95 .12S5.6-1.14 5.6-2.79ZM4.53-2.37C4.53-1.02 3.99-.21 3.1-.21C2.63-.21 2.19-.5 1.94-.98C1.61-1.6 1.42-2.43 1.42-3.28C1.42-4.41 1.98-5.15 2.82-5.15C3.82-5.15 4.53-4 4.53-2.37Z"></path>
<path id="eq29-g4-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
<path id="eq29-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq29-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq29-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq29-page1">
<use x=".3" y="0" xlink:href="#eq29-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq29-g1-185"></use>
<use x="14.86" y="0" xlink:href="#eq29-g4-58"></use>
<use x="23.12" y="0" xlink:href="#eq29-g8-108"></use>
<use x="26.44" y="0" xlink:href="#eq29-g8-111"></use>
<use x="32.42" y="0" xlink:href="#eq29-g8-103"></use>
<use x="40.88" y="0" xlink:href="#eq29-g4-58"></use>
<use x="47.14" y="0" xlink:href="#eq29-g1-186"></use>
</g>
</svg></span>, but the range is too small to discern the difference.</p>
<p>It can also clearly be seen that the two implementations take the same time for <span><svg style="width: 0.549em; height: 0.827em; vertical-align: -0.014em; " viewBox=".49 -8.13 5.49 8.27">
<title>
\(k\)
</title>
<defs>
<path id="eq30-g1-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
</defs>
<g id="eq30-page1">
<use x=".49" y="0" xlink:href="#eq30-g1-58"></use>
</g>
</svg></span> equal to 11. This threshold
is likely different on different computers, but I hard-coded this threshold into the <code>dip::MedianFilter()</code> function
anyway as it should give some meaningful algorithm selection on any machine.</p>
<h2>O(1) algorithm</h2>
<p>Perreault and Hérbert <a href="#ref-perreault">[3]</a> figured out how to compute a median filter in constant time. This
algorithm is based on Huang’s histogram algorithm, but they store a histogram for each image column, updating these
when moving the kernel by one pixel only requires removing one value and adding one value to one of these histograms,
then subtracting one histogram and adding another histogram to the main histogram that covers all values under the
kernel. OpenCV implements this algorithm, which only works for 8-bit images and square kernels.</p>
<p>Perreault and Hérbert’s paper discusses extension to octagonal kernels (as an approximation to round kernels),
which require more intermediate memory (more histograms stored). They claim that for these kernels the algorithm
is still <span><svg style="width: 2.344em; height: 1.095em; vertical-align: -0.241em; " viewBox=".3 -8.54 23.44 10.95">
<title>
\(\mathcal{O}(1)\)
</title>
<defs>
<path id="eq31-g5-49" d="M4.69 0V-.18C3.75-.19 3.56-.31 3.56-.88V-8.03L3.47-8.05L1.32-6.97V-6.8C1.46-6.86 1.6-6.91 1.64-6.93C1.86-7.02 2.06-7.06 2.18-7.06C2.43-7.06 2.54-6.88 2.54-6.5V-1.11C2.54-.71 2.44-.44 2.25-.33C2.07-.23 1.91-.19 1.41-.18V0H4.69Z"></path>
<path id="eq31-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq31-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq31-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq31-page1">
<use x=".3" y="0" xlink:href="#eq31-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq31-g1-185"></use>
<use x="14.37" y="0" xlink:href="#eq31-g5-49"></use>
<use x="20.35" y="0" xlink:href="#eq31-g1-186"></use>
</g>
</svg></span>, but the increased cost would make this algorithm impractical for all but the largest of
kernels.</p>
<p>This algorithm is incredibly fast for any kernel size, as long as the kernel is square and the image is 8-bit. This
lack of generality makes it uninteresting to include in DIPlib, which quickly switches to single-precision floating
point pixels to avoid rounding errors, and which uses isotropic (round) kernels by default everywhere.</p>
<h2>Timing comparisons</h2>
<p>The graph below shows the computational time for a square median filter.
The new DIPlib implementation is in blue, the constant-time OpenCV implementation is in red, and scikit-image’s
implementation (which actually calls SciPy ndimage’s implementation) in green.</p>
<p>For each implementation, I used a single-precision floating-point image (continuous line), an 8-bit unsigned integer
version of the same image (dashed line), and that same image divided by 25, meaning that it only has integer values in
the range 0-10 (dotted line). This latter case should have many more repeated values within the kernel than the other
cases.</p>
<p><img alt="Timing the median filter in various Python libraries" src="https://www.crisluengo.net/images/median_filter_diplib_vs_opencv_vs_skimage.png"/></p>
<p>One can see the kink in the blue lines for DIPlib between 11 and 13 pixels, where a different algorithm is chosen.
To the left, the curve is quadratic (<span><svg style="width: 2.910em; height: 1.265em; vertical-align: -0.241em; " viewBox=".3 -10.24 29.1 12.65">
<title>
\(\mathcal{O}(k^2)\)
</title>
<defs>
<path id="eq32-g8-50" d="M4.15-1.2L4.04-1.24C3.71-.74 3.6-.66 3.21-.66H1.12L2.59-2.2C3.36-3.01 3.7-3.68 3.7-4.36C3.7-5.23 3-5.9 2.09-5.9C1.61-5.9 1.15-5.71 .83-5.36C.55-5.07 .42-4.79 .27-4.17L.45-4.12C.8-4.98 1.12-5.26 1.72-5.26C2.45-5.26 2.95-4.76 2.95-4.03C2.95-3.35 2.55-2.53 1.82-1.76L.26-.1V0H3.67L4.15-1.2Z"></path>
<path id="eq32-g4-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
<path id="eq32-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq32-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq32-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq32-page1">
<use x=".3" y="0" xlink:href="#eq32-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq32-g1-185"></use>
<use x="14.86" y="0" xlink:href="#eq32-g4-58"></use>
<use x="21.12" y="-4.34" xlink:href="#eq32-g8-50"></use>
<use x="26.01" y="0" xlink:href="#eq32-g1-186"></use>
</g>
</svg></span>), to the right it is <span><svg style="width: 5.024em; height: 1.114em; vertical-align: -0.260em; " viewBox=".3 -8.54 50.24 11.14">
<title>
\(\mathcal{O}(k \log k)\)
</title>
<defs>
<path id="eq33-g8-103" d="M5.6-4.62V-5.09H4.68C4.44-5.09 4.26-5.12 4.03-5.2L3.76-5.3C3.44-5.42 3.12-5.48 2.81-5.48C1.7-5.48 .82-4.62 .82-3.54C.82-2.79 1.14-2.33 1.93-1.94L1.42-1.46C1.02-1.12 .87-.88 .87-.64C.87-.39 1.01-.25 1.5-.01C.66 .61 .33 1 .33 1.44C.33 2.07 1.26 2.6 2.39 2.6C3.29 2.6 4.22 2.29 4.84 1.79C5.29 1.42 5.49 1.04 5.49 .58C5.49-.15 4.93-.66 4.05-.69L2.51-.76C1.88-.79 1.58-.89 1.58-1.08C1.58-1.32 1.98-1.74 2.3-1.83C2.41-1.82 2.49-1.81 2.53-1.81C2.75-1.79 2.91-1.77 2.98-1.77C3.42-1.77 3.89-1.95 4.26-2.27C4.66-2.61 4.84-3.03 4.84-3.62C4.84-3.97 4.78-4.24 4.61-4.62H5.6ZM5.16 .76C5.16 1.45 4.25 1.92 2.91 1.92C1.86 1.92 1.17 1.57 1.17 1.05C1.17 .77 1.25 .62 1.75 .02C2.14 .11 3.1 .18 3.68 .18C4.76 .18 5.16 .33 5.16 .76ZM3.92-3.16C3.92-2.49 3.57-2.07 3.03-2.07C2.31-2.07 1.81-2.85 1.81-3.99V-4.03C1.81-4.73 2.14-5.15 2.69-5.15C3.06-5.15 3.37-4.94 3.56-4.59C3.78-4.17 3.92-3.62 3.92-3.16Z"></path>
<path id="eq33-g8-108" d="M3.06 0V-.18C2.3-.23 2.17-.35 2.17-1V-8.11L2.12-8.13C1.5-7.93 1.05-7.81 .23-7.61V-7.42H.3C.43-7.43 .57-7.44 .67-7.44C1.05-7.44 1.17-7.28 1.17-6.72V-1.04C1.17-.39 1-.24 .25-.18V0H3.06Z"></path>
<path id="eq33-g8-111" d="M5.6-2.79C5.6-4.35 4.5-5.48 2.98-5.48C1.43-5.48 .35-4.34 .35-2.69C.35-1.08 1.45 .12 2.95 .12S5.6-1.14 5.6-2.79ZM4.53-2.37C4.53-1.02 3.99-.21 3.1-.21C2.63-.21 2.19-.5 1.94-.98C1.61-1.6 1.42-2.43 1.42-3.28C1.42-4.41 1.98-5.15 2.82-5.15C3.82-5.15 4.53-4 4.53-2.37Z"></path>
<path id="eq33-g4-58" d="M5.11-1.17L4.93-1.3C4.87-1.19 4.81-1.08 4.75-.99C4.54-.62 4.39-.49 4.22-.49C3.97-.49 3.73-.87 3.25-2.02L2.81-3.07C4.56-4.63 4.93-4.87 5.49-4.91V-5.1H3.31V-4.91H3.5C3.8-4.91 3.97-4.82 3.97-4.69C3.97-4.45 3.38-3.88 2.26-3.03L1.75-2.63L3.18-8.08L3.12-8.13C2.42-7.98 1.97-7.9 1.26-7.81V-7.62H1.46C1.87-7.62 2.05-7.54 2.07-7.32C2.05-7.12 1.98-6.81 1.81-6.25L1.7-5.86L1.68-5.75L.17 0H1.06L1.63-2.14L2.13-2.53C2.32-2 2.63-1.26 2.85-.85C3.23-.1 3.44 .13 3.79 .13C4.26 .13 4.56-.17 5.11-1.17Z"></path>
<path id="eq33-g1-79" d="M8.29-5.48C8.29-7.02 7.34-8.52 5.67-8.52C4.94-8.52 4.2-8.33 3.66-7.84C3.94-7.9 4.23-7.91 4.53-7.91C5.94-7.91 7.12-7.13 7.12-5.61C7.12-3.78 5.42-.2 3.29-.2C2.02-.2 1.39-1.37 1.39-2.5C1.39-4.54 3.1-7.06 5.22-7.35C4.9-7.5 4.59-7.53 4.23-7.53C2.18-7.53 .08-4.6 .08-2.69C.08-.73 1.41 .3 3.29 .3C6.21 .3 8.29-2.78 8.29-5.48Z"></path>
<path id="eq33-g1-185" d="M3.51-8.54C1.79-7.42 .57-5.49 .57-3.06C.57-.85 1.83 1.39 3.48 2.41L3.62 2.22C2.05 .98 1.6-.46 1.6-3.1C1.6-5.74 2.08-7.11 3.62-8.35L3.51-8.54Z"></path>
<path id="eq33-g1-186" d="M.45-8.54L.35-8.35C1.88-7.11 2.37-5.74 2.37-3.1C2.37-.46 1.92 .98 .35 2.22L.49 2.41C2.13 1.39 3.39-.85 3.39-3.06C3.39-5.49 2.18-7.42 .45-8.54Z"></path>
</defs>
<g id="eq33-page1">
<use x=".3" y="0" xlink:href="#eq33-g1-79"></use>
<use x="9.91" y="0" xlink:href="#eq33-g1-185"></use>
<use x="14.86" y="0" xlink:href="#eq33-g4-58"></use>
<use x="23.12" y="0" xlink:href="#eq33-g8-108"></use>
<use x="26.44" y="0" xlink:href="#eq33-g8-111"></use>
<use x="32.42" y="0" xlink:href="#eq33-g8-103"></use>
<use x="40.88" y="0" xlink:href="#eq33-g4-58"></use>
<use x="47.14" y="0" xlink:href="#eq33-g1-186"></use>
</g>
</svg></span>. Scikit-image’s
lines are quadratic, the difference with DIPlib’s line is partially due to quality of implementation, but mostly
because DIPlib uses all cores whereas scikit-image is single-threaded. For both implementations, reducing the number
of values in the input image strongly reduces the computational cost (dotted lines). Quickselect is faster when many
values are identical, and our binary tree implementation has strongly reduced number of nodes when each node represents
many pixels with the same value.</p>
<p>The constant-time implementation in OpenCV is not actually constant time. It seems that a different algorithm
is used for kernels up to 15 pixels, the constant-time algorithm kicks in at 19 pixels.
It also looks like the selection of which algorithm to use was tuned on a machine with different characteristics
to mine, meaning that a different algorithm was chosen for some sizes where the constant-time implementation would
be more efficient. Because of this, the filter is significantly slower for a kernel of size 15 than for a kernel
of size 19.</p>
<p>We can see the same issue in the DIPlib implementation for the dotted line, where the binary tree implementation is
faster than what I measured earlier because of the reduced number of different values in the image.
Picking the most efficient algorithm under all circumstances is an unattainable dream, I am willing to live with
small imperfections like this.</p>
<div>
<p>Literature</p>
<ol>
<li id="ref-huang">T.S. Huang, G.J. Yang, G.Y. Tang, “A fast two-dimensional median filtering algorithm”,
    IEEE Transactions on Acoustics, Speech, and Signal Processing 27(1):13–18, 1979.</li>
<li id="ref-hirai">Y. Hirai, K. Yamamoto, “Balancing weight-balanced trees”,
    Journal of Functional Programming 21(3):287–307, 2011.</li>
<li id="ref-perreault">S. Perreault and P. Hérbert, “Median Filtering in Constant Time”,
    IEEE Transactions on Image Processing 16(9):2389–2394, 2007.</li>
</ol>
</div>
        </div></div>
  </body>
</html>
