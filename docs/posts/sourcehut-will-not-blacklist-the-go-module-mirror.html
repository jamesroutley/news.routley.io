<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://sourcehut.org/blog/2023-01-09-gomodulemirror/">Original</a>
    <h1>Sourcehut will not blacklist the Go module mirror</h1>
    
    <div id="readability-page-1" class="page"><article>
        <p><strong>Update 2023-01-31</strong>: Russ Cox of the Go team reached out to us to address this
problem. After some discussion, an acceptable plan was worked out. The Go team
is working on deploying an update to the “go” tool to add a -reuse flag, which
should substantially reduce the traffic generated by this system for all users
of Go.</p>
<p>In the meantime, the automated refresh traffic from proxy.golang.org was
disabled for SourceHut, which the Go team assures us should have little-to-no
impact on users and which reduces the burden on our system to a managable level.
Following this change by the Go team, we have observed traffic from the Go
module mirror reduced to an acceptable level. The Go team has decided that the
automatic refresh behavior is their responsibility, not the responsibility of
other operators, so any other small hosts will hopefully not be affected as the
Go team will enable or disable the refresh behavior at their discretion with the
burden on third-party operators in mind.</p>
<p>Consequently, we have cancelled our plans to disable Go traffic to git.sr.ht. No
action is required by users to continue receiving service. Thanks Russ!</p>
<p>The original post can be read below.</p>
<hr/>
<p>SourceHut will disable git access for the <a href="https://proxy.golang.org/">Go Module Mirror</a> on February
24th, 2023. This will cause a service impact for Go users. This article explains
why this step is necessary and how Go users can work around the issue.</p>
<h2 id="tldr">tl;dr</h2>
<p>From February 24th, users running <code>go get</code> or a similar command on Go packages
which import modules from SourceHut repositories will be met with an error
message similar to the following:</p>
<pre tabindex="0"><code>$ go get
go: downloading git.sr.ht/~sircmpwn/foobaz v0.0.0-20230108094957-81402546c10e
go: git.sr.ht/~sircmpwn/foobaz@v0.0.0-20230108094957-81402546c10e: verifying module: git.sr.ht/~sircmpwn/foobaz@v0.0.0-20230108094957-81402546c10e: reading https://sum.golang.org/lookup/git.sr.ht/~sircmpwn/foobaz@v0.0.0-20230108094957-81402546c10e: 404 Not Found
	server response:
	not found: git.sr.ht/~sircmpwn/foobaz@v0.0.0-20230108094957-81402546c10e: invalid version: git ls-remote -q origin in /tmp/gopath/pkg/mod/cache/vcs/568e5edafe93f7887c0b6f718b0f17ea91c63c35822fb28628535f172b5429b7: exit status 128:
		fatal: unable to access &#39;https://git.sr.ht/~sircmpwn/foobaz/&#39;: The requested URL returned error: 429
</code></pre><p>The following workaround will correct the issue:</p>
<pre tabindex="0"><code>$ export GOPRIVATE=git.sr.ht
$ go get # works
</code></pre><p>For more detail, read on.</p>
<h2 id="background">Background</h2>
<p>The Go programming language fetches modules via git, such that a user who
imports “<a href="https://git.sr.ht/~sircmpwn/dowork">git.sr.ht/~sircmpwn/dowork</a>” will cause the toolchain to fetch the
corresponding repository via git in order to make it available in the user’s Go
environment. Each of these requests is routed through a proxy service at
<a href="https://proxy.golang.org/">proxy.golang.org</a>, which provides a number of features:</p>
<ul>
<li>Offers reliable and fast access to module downloads via Google’s cache</li>
<li>Stores redundant copies of Go modules to ensure availability</li>
<li>Records an independent source of their checksum for the checksum database</li>
<li>Provides an index of new Go modules</li>
</ul>
<p>This comes with a number of downsides. For example, most Go users are unaware
that every package they fetch is accompanied by a request to Google’s servers,
and implies a trust relationship with Google to return authentic packages.
Additionally, should the underlying source repository disappear or become out of
sync with the cache, the problem is hidden from Go users, which can cause their
software to become dependent on modules or module versions which no longer
exist.</p>
<p>More importantly for SourceHut, the proxy will regularly fetch Go packages from
their source repository to check for updates – independent of any user
requests, such as running <code>go get</code>. These requests take the form of a complete
git clone of the source repository, which is the most expensive kind of request
for git.sr.ht to service. Additionally, these requests originate from many
servers which do not coordinate with each other to reduce their workload. The
frequency of these requests can be as high as ~2,500 per hour, often batched
with up to a dozen clones at once, and are generally highly redundant: a single
git repository can be fetched over 100 times per hour.</p>
<p>This traffic produces an excessive background workload which is constantly being
serviced by git.sr.ht. Due to the relatively large traffic requirements of git
clones, this represents about 70% of all outgoing network traffic from
git.sr.ht. A single module can produce as much as 4 GiB of daily traffic from
Google.</p>
<h2 id="seeking-other-solutions">Seeking other solutions</h2>
<p>Blacklisting GoModuleMirror is our last resort, and we wanted to avoid it if
possible. We attempted to work with the Go team on a solution, but were
unsuccessful.</p>
<p>On February 24th, 2021, we <a href="https://github.com/golang/go/issues/44577">reported an issue</a> to the Go team regarding
this problem. The Go team initially helped us narrow down the cause, first by
setting an appropriate User-Agent to help identify this traffic, then through
discussions regarding the behavior of this system. We made recommendations to
Google for how to service their requirements without generating an excessive
amount of redundant traffic. However, the discussion stalled and no further
changes were made by Google to address the issue, and we continued to receive an
excessive amount of traffic from the module mirror.</p>
<p>The situation remained so for over a year. In that time, I was banned from the
Go issue tracker without explanation, and was unable to continue discussing the
problem with Google. With few options left, I wrote <a href="https://drewdevault.com/2022/05/25/Google-has-been-DDoSing-sourcehut.html">a blog post</a> on May
25th, 2022 outlining the issue and petitioning the public for support in
addressing this problem. However, the problem remains unsolved.</p>
<p>February 24th, 2023, the date that we plan to disable Go traffic, marks two
years since the initial complaint was submitted to the Go team. The cost of
bearing this traffic is no longer acceptable to us, and the Go team has made no
attempts to correct the issue during this time. We want to avoid causing
inconvenience for Go users, but the load and cost is too high for us to continue
justifying support for this feature.</p>
<h2 id="recommendations-for-the-go-team">Recommendations for the Go team</h2>
<p>From February 24th, git clone requests with a GoModuleMirror User-Agent will
receive a 429 (Too Many Requests) response. To restore service, we have the
following recommendations for the Go team:</p>
<ol>
<li>Obey robots.txt, including the Crawl-Delay directive, to control the rate at
which modules are fetched.</li>
<li>Perform a shallow git clone rather than a full git clone; or, ideally, store
the last seen commit hash for each reference and only fetch if it has been
updated.</li>
<li>Reduce redundant traffic: fetch each git repository less often. It should not
be necessary to fetch the same git module up to 2,000 times per day.</li>
</ol>
<p>If these issues are addressed, we would be pleased to re-enable GoModuleMirror’s
access to our services. The Go team can reach me <a href="mailto:sir@cmpwn.com">via
email</a> to discuss the matter further, if you have ideas
for other solutions or require any additional details to address the problem.</p>
<h2 id="recommendations-for-go-users">Recommendations for Go users</h2>
<p>Unfortunately, this will affect Go users and will require workarounds to be
implemented in order to compile Go software which depend on modules hosted on
git.sr.ht. If you encounter an error similar to the following:</p>
<pre tabindex="0"><code>$ go get
go: downloading git.sr.ht/~sircmpwn/foobaz v0.0.0-20230108094957-81402546c10e
go: git.sr.ht/~sircmpwn/foobaz@v0.0.0-20230108094957-81402546c10e: verifying module: git.sr.ht/~sircmpwn/foobaz@v0.0.0-20230108094957-81402546c10e: reading https://sum.golang.org/lookup/git.sr.ht/~sircmpwn/foobaz@v0.0.0-20230108094957-81402546c10e: 404 Not Found
	server response:
	not found: git.sr.ht/~sircmpwn/foobaz@v0.0.0-20230108094957-81402546c10e: invalid version: git ls-remote -q origin in /tmp/gopath/pkg/mod/cache/vcs/568e5edafe93f7887c0b6f718b0f17ea91c63c35822fb28628535f172b5429b7: exit status 128:
		fatal: unable to access &#39;https://git.sr.ht/~sircmpwn/foobaz/&#39;: The requested URL returned error: 429
</code></pre><p>You can correct it by bypassing proxy.golang.org:</p>
<pre tabindex="0"><code>$ export GOPRIVATE=git.sr.ht
$ go get # works
</code></pre><p>We will enable these variables by default for builds.sr.ht jobs prior to
disabling service for the Go module mirror.</p>
<p>We understand if Go users need to migrate away from SourceHut to deal with these
problems. We apologise for this inconvenience, and we hope to see you return
should the problem be resolved. The SourceHut team is available to assist with
any necessary migration efforts via
<a href="https://lists.sr.ht/~sircmpwn/sr.ht-discuss">sr.ht-discuss</a>.</p>

      </article></div>
  </body>
</html>
