<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.troyhunt.com/fighting-api-bots-with-cloudflares-invisible-turnstile/">Original</a>
    <h1>Fighting API bots with Cloudflare&#39;s invisible turnstile</h1>
    
    <div id="readability-page-1" class="page"><section>
<p>There&#39;s a &#34;hidden&#34; API on HIBP. Well, it&#39;s not &#34;hidden&#34; insofar as it&#39;s easily discoverable if you watch the network traffic from the client, but it&#39;s not meant to be called directly, rather only via the web app. It&#39;s called &#34;unified search&#34; and it looks just like this:</p><figure><img src="https://www.troyhunt.com/content/images/2023/03/image-20.png" alt="" loading="lazy" width="1441" height="1031" srcset="https://www.troyhunt.com/content/images/size/w600/2023/03/image-20.png 600w, https://www.troyhunt.com/content/images/size/w1000/2023/03/image-20.png 1000w, https://www.troyhunt.com/content/images/2023/03/image-20.png 1441w" sizes="(min-width: 720px) 720px"/></figure><p>It&#39;s been there in one form or another since day 1 (so almost a decade now), and it serves a sole purpose: to perform searches from the home page. That is all - <em>only from the home page</em>. It&#39;s called asynchronously from the client without needing to post back the entire page and by design, it&#39;s super fast and super easy to use. Which is bad. Sometimes.</p><p>To understand why it&#39;s bad we need to go back in time all the way to when <a href="https://www.troyhunt.com/have-i-been-pwned-you-can-now-ask-api/">I first launched the API that was intended to be consumed programmatically by other people&#39;s services</a>. That was easy, because it was basically just documenting the API that sat behind the home page of the website already, the predecessor to the one you see above. And then, unsurprisingly in retrospect, <a href="https://www.troyhunt.com/the-have-i-been-pwned-api-rate-limiting-and-commercial-use/">it started to be abused so I had to put a rate limit on it</a>. Problem is, that was a very rudimentary IP-based rate limit and it could be circumvented by someone with enough IPs, so fast forward a bit further and <a href="https://www.troyhunt.com/authentication-and-the-have-i-been-pwned-api/">I put auth on the API which required a nominal payment to access it</a>. At the same time, that unified search endpoint was created and home page searches updated to use that rather than the publicly documented API. So, 2 APIs with 2 different purposes.</p><p>The primary objective for putting a price on the public API was to tackle abuse. And it did - it stopped it <em>dead</em>. By attaching a rate limit to a key that required a credit card to purchase it, abusive practices (namely enumerating large numbers of email addresses) disappeared. This wasn&#39;t just about putting a <em>financial </em>cost to queries, it was about putting an <em>identity</em> cost to them; people are reluctant to start doing nasty things with a key traceable back to their own payment card! Which is why they turned their attention to the non-authenticated, non-documented unified search API.</p><p>Let&#39;s look at a 3 day period of requests to that API earlier this year, keeping in mind this should only ever be requested organically by humans performing searches from the home page:</p><figure><img src="https://www.troyhunt.com/content/images/2023/03/image-12.png" alt="" loading="lazy" width="1200" height="645" srcset="https://www.troyhunt.com/content/images/size/w600/2023/03/image-12.png 600w, https://www.troyhunt.com/content/images/size/w1000/2023/03/image-12.png 1000w, https://www.troyhunt.com/content/images/2023/03/image-12.png 1200w" sizes="(min-width: 720px) 720px"/></figure><p>This is far from organic usage with requests peaking at 121.3k in just 5 minutes. Which poses an interesting question: <strong>how do you create an API that should only be consumed asynchronously from a web page and never programmatically via a script?</strong> You could chuck a CAPTCHA on the front page and require that be solved first but let&#39;s face it, that&#39;s not a pleasant user experience. Rate limit requests by IP? See the earlier problem with that. Block UA strings? Pointless, because they&#39;re easily randomised. Rate limit an <a href="https://www.cloudflare.com/learning/network-layer/what-is-an-autonomous-system/?ref=troyhunt.com">ASN</a>? It gets you part way there, but what happens when you get a genuine flood of traffic because the site has hit the mainstream news? <a href="https://www.troyhunt.com/brief-lessons-on-handling-huge-traffic-spikes/">It happens</a>.</p><p>Over the years, I&#39;ve played with all sorts of combinations of firewall rules based on parameters such as geolocations with incommensurate numbers of requests to their populations, <a href="https://developers.cloudflare.com/bots/concepts/ja3-fingerprint/?ref=troyhunt.com">JA3 fingerprints</a> and, of course, the parameters mentioned above. Based on the chart above these obviously didn&#39;t catch all the abusive traffic, but they did catch a significant portion of it:</p><figure><img src="https://www.troyhunt.com/content/images/2023/03/image-13.png" alt="" loading="lazy" width="1075" height="756" srcset="https://www.troyhunt.com/content/images/size/w600/2023/03/image-13.png 600w, https://www.troyhunt.com/content/images/size/w1000/2023/03/image-13.png 1000w, https://www.troyhunt.com/content/images/2023/03/image-13.png 1075w" sizes="(min-width: 720px) 720px"/></figure><p>If you combine it with the previous graph, that&#39;s about a third of all the bad traffic in that period or in other words, two thirds of the bad traffic was still getting through. There had to be a better way, which brings us to <a href="https://developers.cloudflare.com/turnstile/?ref=troyhunt.com">Cloudflare&#39;s Turnstile</a>:</p><blockquote>With Turnstile, we adapt the actual challenge outcome to the individual visitor or browser. First, we run a series of small non-interactive JavaScript challenges gathering more signals about the visitor/browser environment. Those challenges include, proof-of-work, proof-of-space, probing for web APIs, and various other challenges for detecting browser-quirks and human behavior. As a result, we can fine-tune the difficulty of the challenge to the specific request and avoid ever showing a visual puzzle to a user.</blockquote><p>&#34;Avoid ever showing a visual puzzle to a user&#34; is a polite way of saying they avoid the sucky UX of CAPTCHA. Instead, Turnstile offers the ability to issue a &#34;non-interactive challenge&#34; which implements the sorts of clever techniques mentioned above and as it relates to this blog post, that can be <strong>an invisible non-interactive challenge</strong>. This is one of <a href="https://developers.cloudflare.com/turnstile/reference/widget-types/?ref=troyhunt.com">3 different widget types</a> with the others being <strong>a visible non-interactive challenge</strong> and a <strong>non-<em>intrusive</em> interactive challenge</strong>. For my purposes on HIBP, I wanted a zero-friction implementation nobody saw, hence the invisible approach. Here&#39;s how it works:</p><figure><img src="https://www.troyhunt.com/content/images/2023/08/turnstile-overview_hu857217e6cfe3055a024af7c1505ed0dc_210985_3757x2700_resize_q75_box_3-3bb896c3.png" alt="" loading="lazy" width="2000" height="1437" srcset="https://www.troyhunt.com/content/images/size/w600/2023/08/turnstile-overview_hu857217e6cfe3055a024af7c1505ed0dc_210985_3757x2700_resize_q75_box_3-3bb896c3.png 600w, https://www.troyhunt.com/content/images/size/w1000/2023/08/turnstile-overview_hu857217e6cfe3055a024af7c1505ed0dc_210985_3757x2700_resize_q75_box_3-3bb896c3.png 1000w, https://www.troyhunt.com/content/images/size/w1600/2023/08/turnstile-overview_hu857217e6cfe3055a024af7c1505ed0dc_210985_3757x2700_resize_q75_box_3-3bb896c3.png 1600w, https://www.troyhunt.com/content/images/size/w2400/2023/08/turnstile-overview_hu857217e6cfe3055a024af7c1505ed0dc_210985_3757x2700_resize_q75_box_3-3bb896c3.png 2400w"/></figure><p>Get it? Ok, let&#39;s break it down further as it relates to HIBP, starting with when the front page first loads and it embeds the Turnstile widget from Cloudflare:</p><pre><code>&lt;script src=&#34;https://challenges.cloudflare.com/turnstile/v0/api.js&#34; async defer&gt;&lt;/script&gt;</code></pre><p>The widget takes responsibility for running the non-interactive challenge and returning a token. This needs to be persisted somewhere on the client side which brings us to <a href="https://developers.cloudflare.com/turnstile/get-started/client-side-rendering/?ref=troyhunt.com">embedding the widget</a>:</p><pre><code>&lt;divÂ ID=&#34;turnstileWidget&#34;Â class=&#34;cf-turnstile&#34;Â data-sitekey=&#34;0x4AAAAAAADY3UwkmqCvH8VR&#34;Â data-callback=&#34;turnstileCompleted&#34;&gt;&lt;/div&gt;</code></pre><p>Per the docs in that link, the main thing here is to have an element with the &#34;cf-turnstile&#34; class set on it. If you happen to go take a look at the HIBP HTML source right now, you&#39;ll see that element precisely as it appears in the code block above. However, check it out in your browser&#39;s dev tools so you can see how it renders in the DOM and it will look more like this:</p><figure><img src="https://www.troyhunt.com/content/images/2023/08/image-4.png" alt="" loading="lazy" width="968" height="204" srcset="https://www.troyhunt.com/content/images/size/w600/2023/08/image-4.png 600w, https://www.troyhunt.com/content/images/2023/08/image-4.png 968w"/></figure><p>Expand that DIV tag and you&#39;ll find a whole bunch more content set as a result of loading the widget, but that&#39;s not relevant right now. What&#39;s important is the data-token attribute because that&#39;s what&#39;s going to prove you&#39;re not a bot when you run the search. How you implement this from here is up to you, but what HIBP does is picks up the token and sets it in the &#34;cf-turnstile-response&#34; header then sends it along with the request when that unified search endpoint is called:</p><figure><img src="https://www.troyhunt.com/content/images/2023/08/image-6.png" alt="" loading="lazy" width="948" height="582" srcset="https://www.troyhunt.com/content/images/size/w600/2023/08/image-6.png 600w, https://www.troyhunt.com/content/images/2023/08/image-6.png 948w"/></figure><p>So, at this point we&#39;ve issued a challenge, the browser has solved the challenge and received a token back, now that token has been sent along with the request for the actual resource the user wanted, in this case the unified search endpoint. The final step is to validate the token and for this I&#39;m using a Cloudflare worker. <a href="https://www.troyhunt.com/tag/cloudflare/">I&#39;ve written a lot about workers in the past</a> so here&#39;s the short pitch: it&#39;s code that runs in each one of Cloudflare&#39;s 300+ edge nodes around the world and can inspect and modify requests and responses on the fly. I already had a worker to do some other processing on unified search requests, so I just added the following:</p><pre><code>const token = request.headers.get(&#39;cf-turnstile-response&#39;);

if (token === null) {
    return new Response(&#39;Missing Turnstile token&#39;, { status: 401 });
}

const ip = request.headers.get(&#39;CF-Connecting-IP&#39;);

let formData = new FormData();
formData.append(&#39;secret&#39;, &#39;[secret key goes here]&#39;);
formData.append(&#39;response&#39;, token);
formData.append(&#39;remoteip&#39;, ip);

const turnstileUrl = &#39;https://challenges.cloudflare.com/turnstile/v0/siteverify&#39;;
const result = await fetch(turnstileUrl, {
    body: formData,
    method: &#39;POST&#39;,
});
const outcome = await result.json();

if (!outcome.success) {
    return new Response(&#39;Invalid Turnstile token&#39;, { status: 401 });
}</code></pre><p>That should be pretty self-explanatory and you can find the docs for this on <a href="https://developers.cloudflare.com/turnstile/get-started/server-side-validation/?ref=troyhunt.com">Cloudflare&#39;s server-side validation page</a> which goes into more detail, but in essence, it does the following:</p><ol><li>Gets the token from the request header and rejects the request if it doesn&#39;t exist</li><li>Sends the token, your secret key and the user&#39;s IP along to Turnstile&#39;s &#34;siteverify&#34; endpoint</li><li>If the token is not successfully verified then return 401 &#34;Unauthorised&#34;, otherwise continue with the request</li></ol><p>And because this is all done in a Cloudflare worker, any of those 401 responses never even touch the origin. Not only do I not need to process the request in Azure, the person attempting to abuse my API gets a nice speedy response directly from an edge node near them ðŸ™‚</p><p>So, what does this mean for bots? If there&#39;s no token then they get booted out right away. If there&#39;s a token but it&#39;s not valid then they get booted out at the end. But can&#39;t they just take a previously generated token and use that? Well, yes, but only once:</p><blockquote>If the same response is presented twice, the second and each subsequent request will generate an error stating that the response has already been consumed.</blockquote><p>And remember, a real browser had to generate that token in the first place so it&#39;s not like you can just automate the process of token generation then throw it at the API above. (Sidenote: that server-side validation link includes how to handle idempotency, for example when retrying failed requests.) But what if a <em>real human</em> fails the verification? That&#39;s entirely up to you but in HIBP&#39;s case, that 401 response causes a fallback to a full page post back which then implements other controls, for example an interactive challenge.</p><p>Time for graphs and stats, starting with the one in the hero image of this page where we can see the number of times Turnstile was issued and how many times it was solved over the week prior to publishing this post:</p><figure><img src="https://www.troyhunt.com/content/images/2023/08/2023-08-21_16-38-03.png"/></figure><p>That&#39;s a 91% hit rate of solved challenges which is great. That remaining 9% is either humans with a false positive or... bots getting rejected ðŸ˜Ž </p><p>More graphs, this time how many requests to the unified search page were rejected by Turnstile:</p><figure><img src="https://www.troyhunt.com/content/images/2023/08/image-9.png" alt="" loading="lazy" width="1110" height="834" srcset="https://www.troyhunt.com/content/images/size/w600/2023/08/image-9.png 600w, https://www.troyhunt.com/content/images/size/w1000/2023/08/image-9.png 1000w, https://www.troyhunt.com/content/images/2023/08/image-9.png 1110w"/></figure><p>That 990k number doesn&#39;t marry up with the 476k unsolved ones from before because they&#39;re 2 different things: the unsolved challenges are when the Turnstile widget is loaded but not solved (hopefully due to it being a bot rather than a false positive), whereas the 401 responses to the API is when a successful (and previously unused) Turnstile token isn&#39;t in the header. This could be because the token wasn&#39;t present, wasn&#39;t solved or had already been used. You get more of a sense of how many of these rejected requests were legit humans when you drill down into attributes like <a href="https://developers.cloudflare.com/bots/concepts/ja3-fingerprint/?ref=troyhunt.com">the JA3 fingerprints</a>:</p><figure><img src="https://www.troyhunt.com/content/images/2023/08/image-10.png" alt="" loading="lazy" width="540" height="238"/></figure><p>In other words, of those 990k failed requests, almost 40% of them were from the same 5 clients. Seems legit ðŸ¤”</p><p>And about a third were from clients with an identical UA string:</p><figure><img src="https://www.troyhunt.com/content/images/2023/08/image-11.png" alt="" loading="lazy" width="538" height="238"/></figure><p>And so on and so forth. The point being that the number of actual legitimate requests from end users that were inconvenienced by Turnstile would be exceptionally small, almost certainly a very low single-digit percentage. I&#39;ll never know exactly because bots obviously attempt to emulate legit clients and sometimes legit clients look like bots and if we could easily solve this problem then we wouldn&#39;t need Turnstile in the first place! Anecdotally, that very small false positive number stacks up as people tend to complain pretty quickly when something isn&#39;t optimal, and I implemented this all the way back in March. Yep, 5 months ago, and I&#39;ve waited this long to write about it just to be confident it&#39;s actually working. Over 100M Turnstile challenges later, I&#39;m confident it is - I&#39;ve not seen a single instance of abnormal traffic spikes to the unified search endpoint since rolling this out. What I did see initially though is a lot of this sort of thing:</p><figure><img src="https://www.troyhunt.com/content/images/2023/03/image-16.png" alt="" loading="lazy" width="865" height="838" srcset="https://www.troyhunt.com/content/images/size/w600/2023/03/image-16.png 600w, https://www.troyhunt.com/content/images/2023/03/image-16.png 865w" sizes="(min-width: 720px) 720px"/></figure><p>By now it should be pretty obvious what&#39;s going on here, and it should be equally obvious that it didn&#39;t work out real well for them ðŸ˜Š</p><p>The bot problem is a hard one for those of us building services because we&#39;re continually torn in different directions. We want to build a slick UX for humans but an obtrusive one for bots. We want services to be easily consumable, but only in the way we intend them to... which might be by the good bots playing by the rules!</p><p>I don&#39;t know exactly what Cloudflare is doing in that challenge and I&#39;ll be honest, I don&#39;t even know what a &#34;proof-of-space&#34; is. But the point of using a service like this is that <em>I don&#39;t need to know!</em> What I do know is that Cloudflare sees about 20% of the internet&#39;s traffic and because of that, they&#39;re in an unrivalled position to look at a request and make a determination on its legitimacy.</p><p>If you&#39;re in my shoes, <a href="https://developers.cloudflare.com/turnstile/?ref=troyhunt.com">go and give Turnstile a go</a>. And if you want to consume data from HIBP, go and check out <a href="https://haveibeenpwned.com/API/v3?ref=troyhunt.com">the official API docs</a>, the uh, unified search doesn&#39;t work real well for you any more ðŸ˜Ž</p>
<section>
<a href="https://www.troyhunt.com/tag/cloudflare/">Cloudflare</a>
<a href="https://www.troyhunt.com/tag/have-i-been-pwned-3f/">Have I Been Pwned</a>
</section>
</section></div>
  </body>
</html>
