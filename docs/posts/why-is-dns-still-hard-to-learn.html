<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jvns.ca/blog/2023/07/28/why-is-dns-still-hard-to-learn/">Original</a>
    <h1>Why is DNS still hard to learn?</h1>
    
    

<p>I write a lot about technologies that I found hard to learn about. A
while back my friend Sumana asked me an interesting question &ndash; why are these
things so hard to learn about? Why do they seem so mysterious?</p>

<p>For example, take DNS. We&rsquo;ve been using DNS since the <a href="https://www.ietf.org/rfc/rfc1034.txt">80s</a> (for more than 35 years!). It&rsquo;s
used in every website on the internet. And it&rsquo;s pretty stable &ndash; in a lot of
ways, it works the exact same way it did 30 years ago.</p>

<p>But it took me YEARS to figure out how to confidently debug DNS issues, and
I&rsquo;ve seen a lot of other programmers struggle with debugging DNS problems as
well. So what&rsquo;s going on?</p>

<p>Here are a couple of thoughts about why learning to troubleshoot DNS problems
is hard.</p>

<p>(I&rsquo;m not going to explain DNS very much in this post, see <a href="https://implement-dns.wizardzines.com/">Implement DNS in a Weekend</a> or <a href="https://jvns.ca/categories/dns/">my DNS blog posts</a> for more about how DNS works)</p>

<h3 id="a-lot-of-the-system-is-hidden">a lot of the system is hidden</h3>

<p>When you make a DNS request on your computer, the basic story is:</p>

<ol>
<li>your computer makes a request to a server called <strong>resolver</strong></li>
<li>the resolver checks its cache, and makes requests to some other servers called <strong>authoritative nameservers</strong></li>
</ol>

<p>Here are some things you don&rsquo;t see:</p>

<ul>
<li>the resolver&rsquo;s <strong>cache</strong>. What&rsquo;s in there?</li>
<li>which <strong>library code</strong> on your computer is making the DNS request (is it libc
<code>getaddrinfo</code>? if so, is it the getaddrinfo from glibc, or musl, or apple? is
it your browser&rsquo;s DNS code? is it a different custom DNS implementation?).
All of these options behave slightly differently and have different
configuration, approaches to caching, available features, etc. For example musl DNS didn&rsquo;t support TCP until <a href="https://www.theregister.com/2023/05/16/alpine_linux_318/">early 2023</a>.</li>
<li>the <strong>conversation</strong> between the resolver and the authoritative nameservers. I
think a lot of DNS issues would be SO simple to understand if you could
magically get a trace of exactly which authoritative nameservers were
queried downstream during your request, and what they said. (like, what if
you could run <code>dig +debug google.com</code> and it gave you a bunch of extra
debugging information?)</li>
</ul>

<h3 id="dealing-with-hidden-systems">dealing with hidden systems</h3>

<p>A couple of ideas for how to deal with hidden systems</p>

<ul>
<li>just teaching people what the hidden systems are makes a huge difference. For
a long time I had no idea that my computer had many different DNS libraries
that were used in different situations and I was confused about this for
literally years. This is a big part of my approach.</li>
<li>with <a href="https://messwithdns.net/">Mess With DNS</a> we tried out this &ldquo;fishbowl&rdquo;
approach where it shows you some parts of the system (the conversation with
the resolver and the authoritative nameserver) that are normally hidden</li>
<li>I feel like it would be extremely cool to extend DNS to include a &ldquo;debugging
information&rdquo; section. (edit: it looks like this already exists! It&rsquo;s called
<a href="https://blog.nlnetlabs.nl/extended-dns-error-support-for-unbound/">Extended DNS Errors</a>,
or EDE, and tools are slowly adding support for it.</li>
</ul>

<h3 id="extended-dns-errors-seem-cool">Extended DNS Errors seem cool</h3>

<p>Extended DNS Errors are a new way for DNS servers to provide extra debuggging information in DNS responss. Here&rsquo;s an example of what that looks like:</p>

<pre><code>$ dig @8.8.8.8 xjwudh.com
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NXDOMAIN, id: 39830
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
; EDE: 12 (NSEC Missing): (Invalid denial of existence of xjwudh.com/a)
;; QUESTION SECTION:
;xjwudh.com.			IN	A

;; AUTHORITY SECTION:
com.			900	IN	SOA	a.gtld-servers.net. nstld.verisign-grs.com. 1690634120 1800 900 604800 86400

;; Query time: 92 msec
;; SERVER: 8.8.8.8#53(8.8.8.8) (UDP)
;; WHEN: Sat Jul 29 08:35:45 EDT 2023
;; MSG SIZE  rcvd: 161
</code></pre>

<p>Here I&rsquo;ve requested a nonexistsent domain, and I got the extended error <code>EDE:
12 (NSEC Missing): (Invalid denial of existence of xjwudh.com/a)</code>. I&rsquo;m not
sure what that means (it&rsquo;s some DNSSEC Thing), but it&rsquo;s cool to see an extra
debug message like that.</p>

<p>I did have to install a newer version of <code>dig</code> to get the above to work.</p>

<h3 id="confusing-tools">confusing tools</h3>

<p>Even though a lot of DNS stuff is hidden, there are a lot of ways to figure out
what&rsquo;s going on by using <code>dig</code>.</p>

<p>For example, you can use <code>dig +norecurse</code> to figure out if a given DNS resolver
has a particular record in its cache. <code>8.8.8.8</code> seems to return a <code>SERVFAIL</code>
response if the response isn&rsquo;t cached.</p>

<p>here&rsquo;s what that looks like for <code>google.com</code></p>

<pre><code>$ dig +norecurse  @8.8.8.8 google.com
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 11653
;; flags: qr ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
;; QUESTION SECTION:
;google.com.			IN	A

;; ANSWER SECTION:
google.com.		21	IN	A	172.217.4.206

;; Query time: 57 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Fri Jul 28 10:50:45 EDT 2023
;; MSG SIZE  rcvd: 55
</code></pre>

<p>and for <code>homestarrunner.com</code>:</p>

<pre><code>$ dig +norecurse  @8.8.8.8 homestarrunner.com
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: SERVFAIL, id: 55777
;; flags: qr ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
;; QUESTION SECTION:
;homestarrunner.com.		IN	A

;; Query time: 52 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Fri Jul 28 10:51:01 EDT 2023
;; MSG SIZE  rcvd: 47
</code></pre>

<p>Here you can see we got a normal <code>NOERROR</code> response for <code>google.com</code> (which is
in <code>8.8.8.8</code>&rsquo;s cache) but a <code>SERVFAIL</code> for <code>homestarrunner.com</code> (which isn&rsquo;t).
This doesn&rsquo;t mean there&rsquo;s no DNS record <code>homestarrunner.com</code> (there is!), it&rsquo;s
just not cached).</p>

<p>But this output is really confusing to read if you&rsquo;re not used to it! Here are a few things that I think are weird about it:</p>

<ol>
<li>the headings are weird (there&rsquo;s <code>-&gt;&gt;HEADER&lt;&lt;-</code>, <code>flags:</code>, <code>OPT PSEUDOSECTION:</code>, <code>QUESTION SECTION:</code>, <code>ANSWER SECTION:</code>)</li>
<li>the spacing is weird (why is the no newline between <code>OPT PSEUDOSECTION</code> and <code>QUESTION SECTION</code>?)</li>
<li><code>MSG SIZE  rcvd: 47</code> is weird (are there other fields in <code>MSG SIZE</code> other than <code>rcvd</code>? what are they?)</li>
<li>it says that there&rsquo;s 1 record in the ADDITIONAL section but doesn&rsquo;t show it, you have to somehow magically know that the &ldquo;OPT PSEUDOSECTION&rdquo; record is actually in the additional section</li>
</ol>

<p>In general <code>dig</code>&rsquo;s output has the feeling of a script someone wrote in an adhoc
way that grew organically over time and not something that was intentionally
designed.</p>

<h3 id="dealing-with-confusing-tools">dealing with confusing tools</h3>

<p>some ideas for improving on confusing tools:</p>

<ul>
<li><strong>explain the output</strong>. For example I wrote <a href="https://jvns.ca/blog/2021/12/04/how-to-use-dig/">how to use dig</a> explaining how <code>dig</code>&rsquo;s
output works and how to configure it to give you a shorter output by default</li>
<li><strong>make new, more friendly tools</strong>. For example for DNS there&rsquo;s
<a href="https://github.com/ogham/dog">dog</a> and <a href="https://github.com/mr-karan/doggo">doggo</a> and <a href="https://dns-lookup.jvns.ca/">my dns lookup tool</a>. I think these are really cool but
personally I don&rsquo;t use them because sometimes I want to do something a little
more advanced (like using <code>+norecurse</code>) and as far as I can tell neither
<code>dog</code> nor <code>doggo</code> support <code>+norecurse</code>. I&rsquo;d rather use 1 tool for everything,
so I stick to <code>dig</code>. Replacing the breadth of functionality of <code>dig</code> is a
huge undertaking.</li>
<li><strong>make dig&rsquo;s output a little more friendly</strong>. If I were better at C programming,
I might try to write a <code>dig</code> pull request that adds a <code>+human</code> flag to dig
that formats the long form output in a more structured and readable way,
maybe something like this:</li>
</ul>

<pre><code>$ dig +human +norecurse  @8.8.8.8 google.com 
HEADER:
  opcode: QUERY
  status: NOERROR
  id: 11653
  flags: qr ra
  records: QUESTION: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

QUESTION SECTION:
  google.com.			IN	A

ANSWER SECTION:
  google.com.		21	IN	A	172.217.4.206
  
ADDITIONAL SECTION:
  EDNS: version: 0, flags:; udp: 512

EXTRA INFO:
  Time: Fri Jul 28 10:51:01 EDT 2023
  Elapsed: 52 msec
  Server: 8.8.8.8:53
  Protocol: UDP
  Response size: 47 bytes
</code></pre>

<p>This makes the structure of the DNS response more clear &ndash; there&rsquo;s the header, the
question, the answer, and the additional section.</p>

<p>And it&rsquo;s not &ldquo;dumbed down&rdquo; or anything! It&rsquo;s the exact same information, just
formatted in a more structured way. My biggest frustration with alternative DNS
tools that they often remove information in the name of clarity. And though
there&rsquo;s definitely a place for those tools, I want to see all the information!
I just want it to be presented clearly.</p>

<p>We&rsquo;ve learned a lot about how to design more user friendly command line tools
in the last 40 years and I think it would be cool to apply some of that
knowledge to some of our older crustier tools.</p>

<h3 id="dig-yaml">dig +yaml</h3>

<p>One quick note on dig: newer versions of dig do have a <code>+yaml</code> output format
which feels a little clearer to me, though it&rsquo;s too verbose for my taste (a
pretty simple DNS response doesn&rsquo;t fit on my screen)</p>

<h3 id="weird-gotchas">weird gotchas</h3>

<p>DNS has some weird stuff that&rsquo;s relatively common to run into, but pretty hard
to learn about if nobody tells you what&rsquo;s going on. A few examples (there are more in <a href="https://jvns.ca/blog/2022/01/15/some-ways-dns-can-break/">some ways DNS can break</a>:</p>

<ul>
<li>negative caching! (which I talk about in <a href="https://jvns.ca/blog/2023/05/08/new-talk-learning-dns-in-10-years/">this talk</a>) It
took me probably 5 years to realize that I shouldn&rsquo;t visit a domain that
doesn&rsquo;t have a DNS record yet, because then the <strong>nonexistance</strong> of that
record will be cached, and it gets cached for HOURS, and it&rsquo;s really
annoying.</li>
<li>differences in <code>getaddrinfo</code> implementations: until <a href="https://www.theregister.com/2023/05/16/alpine_linux_318/">early 2023</a>, <code>musl</code> didn&rsquo;t support TCP DNS</li>
<li>resolvers that ignore TTLs: if you set a TTL on your DNS records (like &ldquo;5
minutes&rdquo;), some resolvers will ignore those TTLs completely and cache the
records for longer, like maybe 24 hours instead</li>
<li>if you configure nginx wrong (<a href="https://jvns.ca/blog/2022/01/15/some-ways-dns-can-break/#problem-nginx-caching-dns-records-forever">like this</a>), it&rsquo;ll cache DNS records forever.</li>
<li>how <a href="https://pracucci.com/kubernetes-dns-resolution-ndots-options-and-why-it-may-affect-application-performances.html">ndots</a> can make your Kubernetes DNS slow</li>
</ul>

<h3 id="dealing-with-weird-gotchas">dealing with weird gotchas</h3>

<p>I don&rsquo;t have as good answers here as I would like to, but knowledge about weird
gotchas is extremely hard won (again, it took me years to figure out negative
caching!) and it feels very silly to me that people have to rediscover them for
themselves over and over and over again.</p>

<p>A few ideas:</p>

<ul>
<li>It&rsquo;s incredibly helpful when people call out gotchas when explaining a topic. For example (leaving
DNS for a moment), Josh Comeau&rsquo;s Flexbox intro explains this <a href="https://www.joshwcomeau.com/css/interactive-guide-to-flexbox/#the-minimum-size-gotcha-11">minimum size gotcha</a>
which I ran into SO MANY times for several years before finally finding an
explanation of what was going on.</li>
<li>I&rsquo;d love to see more community collections of common gotchas. For bash,
<a href="https://www.shellcheck.net/">shellcheck</a> is an incredible collection of bash
gotchas.</li>
</ul>

<p>One tricky thing about documenting DNS gotchas is that different people are
going to run into different gotchas &ndash; if you&rsquo;re just configuring DNS for your
personal domain once every 3 years, you&rsquo;re probably going to run into different
gotchas than someone who administrates DNS for a domain with heavy traffic.</p>

<p>A couple of more quick reasons:</p>

<h3 id="infrequent-exposure">infrequent exposure</h3>

<p>A lot of people only deal with DNS extremely infrequently. And of course if you
only touch DNS every 3 years it&rsquo;s going to be harder to learn!</p>

<p>I think cheat sheets (like &ldquo;here are the steps to changing your nameservers&rdquo;)
can really help with this.</p>

<h3 id="it-s-hard-to-experiment-with">it&rsquo;s hard to experiment with</h3>

<p>DNS can be scary to experiment with &ndash; you don&rsquo;t want to mess up your domain.
We built <a href="https://messwithdns.net/">Mess With DNS</a> to make this one a little easier.</p>

<h3 id="that-s-all-for-now">that&rsquo;s all for now</h3>

<p>I&rsquo;d love to hear other thoughts about what makes DNS (or your favourite
mysterious technology) hard to learn.</p>

  </body>
</html>
