<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://healeycodes.com/sandboxing-javascript-code">Original</a>
    <h1>Sandboxing JavaScript Code</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>I&#39;ve been enjoying playing around on <a href="https://www.val.town/">Val Town</a> lately. Val Town can be described a few ways; a cloud scripting site, a runnable github gists, or <a href="https://val-town.notion.site/End-programmer-Programming-a749beb4a9b143f2990f575fb7e59b33">end-programmer programming</a>. I first came across it in a <a href="https://news.ycombinator.com/item?id=34343122">Show HN thread</a>.</p><blockquote><p>A &#34;val&#34; is a JavaScript/TypeScript function or value that runs on our servers. We aim to get you from idea to running code in seconds: type code, run it, get its API endpoint, schedule it - all from the browser, in a couple keystrokes.</p></blockquote><p>You can do cute stuff like email yourself with <code>console.email</code> and call other people&#39;s scripts with <code>@yourFriend.bar()</code>. Here&#39;s a screenshot of me composing a val with autocomplete showing someone else&#39;s utility function — it can be auto-completed with Enter or followed with Command+Click like navigating a code base.</p><p><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27725%27%20height=%27170.9729381443299%27/%3e"/></span><img alt="A screenshot of Val Town. Autocomplete offers a utility function for formatting a basic authentication header." srcset="/_next/image?url=%2Fposts%2Fsandboxing-javascript-code%2Fval-town.png&amp;w=750&amp;q=100 1x, /_next/image?url=%2Fposts%2Fsandboxing-javascript-code%2Fval-town.png&amp;w=1920&amp;q=100 2x" src="https://charles.inclouds.space/_next/image?url=%2Fposts%2Fsandboxing-javascript-code%2Fval-town.png&amp;w=1920&amp;q=100" decoding="async" data-nimg="intrinsic"/></span></p><p>Playing around on Val Town, and writing a few small vals, got me thinking about how this stuff works — how they run my code on their server <em>securely</em>. The answer is sandboxing (also see: <a href="https://fly.io/blog/sandboxing-and-workload-isolation/">workload isolation</a>).</p><p><em>Sandboxing</em> is a technique of isolating the execution environment of the code, so that malicious code can&#39;t access sensitive information or harm the system. We&#39;re surrounded by sandboxes, really. You&#39;re reading this in a web browser which itself is a sandbox. If you&#39;re on an iPhone, that browser is wrapped with Apple&#39;s App Sandbox, and then layers of iOS sandboxes after that. It&#39;s sandboxes all the way down.</p><p>The sandbox that Val Town currently uses is <a href="https://github.com/patriksimek/vm2">vm2</a> which runs untrusted code in the same process as the parent program. User-supplied code is transformed and evaluated in a locked down section of the same JavaScript environment. You can&#39;t submit <code>process.exit(0)</code> and kill the server <em>but</em> you could find a new vm2 security bug (<a href="https://github.com/patriksimek/vm2/issues/467#issuecomment-1247515828">here&#39;s an example</a>) and remotely execute code within the parent program.</p><p>Per a <a href="https://blog.val.town/blog/val-town-newsletter-3#2bcad60775d141e9a3e5c72f31a0d168">recent newsletter</a>, Val Town are moving to a more secure runtime soon.</p><h2 id="my-own-mini-cloud-platform">My Own Mini Cloud Platform</h2><p>During my final week at The Recurse Center, I wanted to build a mini cloud platform for my friends. Inspired by Val Town, I wanted to support little JavaScript programs.</p><p>I don&#39;t trust my friends not to hack my server so I needed to sandbox the JavaScript code they were sending me. After reading more about vm2&#39;s <a href="https://github.com/patriksimek/vm2/issues/338">history of breakouts</a>, I wanted a more secure solution.</p><p>AWS Fargate, AWS Lambda, and <a href="http://Fly.io">Fly.io</a>, all use <a href="https://github.com/firecracker-microvm/firecracker/">Firecracker</a>&#39;s lightweight virtualization technology to securely run user code. I went and read Julia Evan&#39;s <a href="https://jvns.ca/blog/2021/01/23/firecracker--start-a-vm-in-less-than-a-second/">blog post</a>, where she sets up Firecracker&#39;s MicroVMs for a personal project. While reading it, I thought: wow! secure AND fast. But, although it&#39;s well-suited for this problem space, setting up Firecracker seemed non-trivial so I decided I wouldn&#39;t be able to get it up and running in a few days.</p><p>My goal remained: run a service somewhere that my friends can send JavaScript code to be executed — and I was running out of time.</p><p>Next, I read about how CloudFlare&#39;s Worker platform does <a href="https://blog.cloudflare.com/cloud-computing-without-containers/">Cloud Computing without Containers</a> by using <a href="https://v8docs.nodesource.com/node-0.8/d5/dda/classv8_1_1_isolate.html">V8 Isolates</a> — a feature of the V8 JavaScript engine that powers Chrome, Deno, Node.js, and others. Isolates allow you to run multiple, isolated instances of JavaScript code in a single process. Each Isolate is a separate instance of the V8 engine, with its own memory heap, garbage collector, and JavaScript context. Letting you run code in a sandboxed environment.</p><p>CloudFlare actually go a few steps further than just relying on Isolates, they disallow timers and multithreading, use dynamic process isolation, and do periodic whole-memory shuffling. You can read more about this in <a href="https://blog.cloudflare.com/mitigating-spectre-and-other-security-threats-the-cloudflare-workers-security-model/">Mitigating Spectre and Other Security Threats</a>, or in the paper they co-authored called <a href="https://arxiv.org/abs/2110.04751">Dynamic Process Isolation</a>.</p><p>Let&#39;s get crisp about my threat model. While my friends are certainly crafty, and could feasibly find some kind of security hole in a less secure sandbox like vm2, I don&#39;t think they will find an internet-threatening zero day vulnerability.</p><h2 id="sandboxing-with-deno">Sandboxing With Deno</h2><p>I wanted to write application code, rather than my own isolation library. So instead of working with V8 bindings (<a href="https://github.com/denoland/rusty_v8">in Rust</a>, or <a href="https://github.com/rogchap/v8go">in Go</a>) I tried to abuse Deno&#39;s permissions model to get something up and running quickly. Unlike Node.js, Deno is secure by default, and you opt in granular <a href="https://deno.land/manual@v1.26.0/getting_started/permissions">permissions</a> like file, network, and environment access. These permissions helped me carve the boundaries of a sandbox.</p><p>The project I shipped, <a href="https://github.com/healeycodes/deno-script-sandbox">deno-script-sandbox</a>, has an API where users can send JavaScript/TypeScript programs and receive the evaluation result (stdout/stderr). When the API receives source code, it&#39;s written to disk, and then a sandbox program with limited permissions dynamically imports the code, executes it, and the result (stdout/stderr) is returned to the user.</p><p>The architecture roughly looks like this:</p><p><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27725%27%20height=%27318.58316221765915%27/%3e"/></span><img alt="deno-script-arch.png" srcset="/_next/image?url=%2Fposts%2Fsandboxing-javascript-code%2Fdeno-script-arch.png&amp;w=750&amp;q=100 1x, /_next/image?url=%2Fposts%2Fsandboxing-javascript-code%2Fdeno-script-arch.png&amp;w=1920&amp;q=100 2x" src="https://charles.inclouds.space/_next/image?url=%2Fposts%2Fsandboxing-javascript-code%2Fdeno-script-arch.png&amp;w=1920&amp;q=100" decoding="async" data-nimg="intrinsic"/></span></p><p>Here are the key lines (from <a href="https://github.com/healeycodes/deno-script-sandbox/blob/main/api.ts">api.ts</a>) with some added comments:</p><pre><div><div><p><span>const</span><span> cmd </span><span>=</span><span> </span><span>[</span><span></span></p><p><span>      </span><span>&#34;deno&#34;</span><span>,</span><span></span></p><p><span>      </span><span>&#34;run&#34;</span><span>,</span><span></span></p><p><span>      </span><span>// Limit memory usage</span><span></span></p><p><span>      </span><span>`</span><span>--v8-flags=--max-old-space-size=</span><span>${</span><span>SCRIPT_MEMORY_LIMIT</span><span>}</span><span>`</span><span>,</span><span></span></p><p><span>      </span><span>// The sandbox can only access the user&#39;s script file</span><span></span></p><p><span>      </span><span>`</span><span>--allow-read=</span><span>${</span><span>scriptPath</span><span>}</span><span>`</span><span>,</span><span></span></p><p><span>      </span><span>// The sandbox can only `fetch` to the proxy</span><span></span></p><p><span>      </span><span>`</span><span>--allow-net=</span><span>${</span><span>PROXY_LOCATION</span><span>}</span><span>`</span><span>,</span><span></span></p><p><span>      </span><span>&#34;./sandbox.ts&#34;</span><span>,</span><span></span></p><p><span>      </span><span>`</span><span>scriptId=</span><span>${</span><span>scriptId</span><span>}</span><span>`</span><span>,</span><span></span></p><p><span>      </span><span>`</span><span>scriptPath=</span><span>${</span><span>scriptPath</span><span>}</span><span>`</span><span>,</span><span></span></p><p><span>    </span><span>]</span><span>;</span><span></span></p><p><span>    </span><span>// Limit how many scripts we&#39;re running at once</span><span></span></p><p><span>    </span><span>const</span><span> release </span><span>=</span><span> </span><span>await</span><span> conurrencyMutex</span><span>.</span><span>acquire</span><span>(</span><span>)</span><span>;</span><span></span></p><p><span>    </span><span>const</span><span> scriptProcess </span><span>=</span><span> </span><span>Deno</span><span>.</span><span>run</span><span>(</span><span>{</span><span> cmd</span><span>,</span><span> stderr</span><span>:</span><span> </span><span>&#34;piped&#34;</span><span>,</span><span> stdout</span><span>:</span><span> </span><span>&#34;piped&#34;</span><span> </span><span>}</span><span>)</span><span>;</span><span></span></p><p><span>    </span><span>release</span><span>(</span><span>)</span><span>;</span><span></span></p><p><span>    </span><span>setTimeout</span><span>(</span><span>async</span><span> </span><span>(</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span></span></p><p><span>        </span><span>// (Error handling code has been removed for brevity)</span><span></span></p><p><span>        scriptProcess</span><span>.</span><span>kill</span><span>(</span><span>)</span><span>;</span><span></span></p><p><span>        scriptProcess</span><span>.</span><span>close</span><span>(</span><span>)</span><span>;</span><span></span></p><p><span>        </span><span>await</span><span> </span><span>Deno</span><span>.</span><span>remove</span><span>(</span><span>scriptPath</span><span>)</span><span>;</span><span></span></p><p><span>    </span><span>}</span><span>,</span><span> </span><span>SCRIPT_TIME_LIMIT</span><span>)</span><span>;</span></p></div></div></pre><p>The sandbox program is given the minimal permissions it needs to achieve its task. It&#39;s also passed a scriptId that doubles as an authentication ticket for the proxy. <code>fetch</code> is wrapped so that web requests pass through the proxy endpoint of the API (even if users call the hidden <code>__realFetch</code> function, it doesn&#39;t give them extra capabilities). The user&#39;s original resource is passed via headers.</p><p>Based off the sandbox&#39;s authentication ticket, the proxy can add any number of limitations like allowlisting URLs, a max number of requests per script, limitations around the bandwidth usage, etc.</p><p>The sandbox program is pretty small, so here&#39;s the code in its entirety:</p><pre><div><div><p><span>const</span><span> scriptId </span><span>=</span><span> </span><span>Deno</span><span>.</span><span>args</span><span>[</span><span>0</span><span>]</span><span> </span><span>/* `scriptId=b` */</span><span>.</span><span>split</span><span>(</span><span>&#34;=&#34;</span><span>)</span><span>[</span><span>1</span><span>]</span><span>;</span><span></span></p><p><span></span><span>const</span><span> scriptPath </span><span>=</span><span> </span><span>Deno</span><span>.</span><span>args</span><span>[</span><span>1</span><span>]</span><span> </span><span>/* `scriptPath=/a/b.ts` */</span><span>.</span><span>split</span><span>(</span><span>&#34;=&#34;</span><span>)</span><span>[</span><span>1</span><span>]</span><span>;</span><span></span></p><p><span></span><span>const</span><span> scriptProxy </span><span>=</span><span> </span><span>&#34;http://localhost:3001/proxy&#34;</span><span>;</span><span></span></p><p><span></span><span>const</span><span> scriptAuthHeaders </span><span>=</span><span> </span><span>{</span><span></span></p><p><span>  </span><span>&#34;x-script-id&#34;</span><span>:</span><span> scriptId</span><span>,</span><span></span></p><p><span></span><span>}</span><span>;</span><span></span></p><p><span></span><span>const</span><span> realFetch </span><span>=</span><span> fetch</span><span>;</span><span></span></p><p><span>globalThis</span><span>.</span><span>fetch</span><span> </span><span>=</span><span> </span><span>(</span><span></span></p><p><span>  input</span><span>:</span><span> </span><span>string</span><span> </span><span>|</span><span> </span><span>Request</span><span> </span><span>|</span><span> </span><span>URL</span><span>,</span><span></span></p><p><span>  init</span><span>:</span><span> </span><span>RequestInit</span><span> </span><span>=</span><span> </span><span>{</span><span>}</span><span>,</span><span></span></p><p><span></span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span></span></p><p><span>  init</span><span>.</span><span>headers</span><span> </span><span>=</span><span> </span><span>{</span><span></span></p><p><span>    </span><span>...</span><span>init</span><span>.</span><span>headers</span><span>,</span><span></span></p><p><span>    </span><span>...</span><span>scriptAuthHeaders</span><span>,</span><span></span></p><p><span>    </span><span>&#34;x-script-fetch&#34;</span><span>:</span><span> input</span><span>.</span><span>toString</span><span>(</span><span>)</span><span>,</span><span></span></p><p><span>  </span><span>}</span><span>;</span><span></span></p><p><span>  </span><span>return</span><span> </span><span>realFetch</span><span>(</span><span>scriptProxy</span><span>,</span><span> init</span><span>)</span><span>;</span><span></span></p><p><span></span><span>}</span><span>;</span><span></span></p><p><span></span><span>try</span><span> </span><span>{</span><span></span></p><p><span>  </span><span>// Here&#39;s where we run user code</span><span></span></p><p><span>  </span><span>await</span><span> </span><span>import</span><span>(</span><span>scriptPath</span><span>)</span><span>;</span><span></span></p><p><span></span><span>}</span><span> </span><span>catch</span><span> </span><span>(</span><span>e</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>  </span><span>console</span><span>.</span><span>error</span><span>(</span><span>e</span><span>)</span><span>;</span><span></span></p><p><span></span><span>}</span></p></div></div></pre><p>The main downside of this approach is performance. The code needs to be written to disk and an entire Deno process needs to be spawned. That&#39;s a major cold boot penalty. Also, there aren&#39;t any control levers to limit the CPU usage of each of these processes.</p><p>A few of my friends tried to escape the sandbox and crash the server but … they weren&#39;t able to! A valiant attempt tried to over-consume heap memory:</p><pre><div><div><p><span>const</span><span> a </span><span>=</span><span> </span><span>[</span><span>]</span><span>;</span><span></span></p><p><span></span><span>for</span><span> </span><span>(</span><span>let</span><span> i </span><span>=</span><span> </span><span>0</span><span>;</span><span> i </span><span>&lt;</span><span> </span><span>9000000000</span><span>;</span><span> i</span><span>++</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>    a</span><span>.</span><span>push</span><span>(</span><span>i</span><span>)</span><span></span></p><p><span></span><span>}</span></p></div></div></pre><p>But since we&#39;re passing <code>--max-old-space-size</code> to Deno, the heap space is locked down.</p><p>Mission complete. It&#39;s not exactly Deno&#39;s <a href="https://deno.com/blog/anatomy-isolate-cloud">Isolate Cloud</a> but it works.</p><h2 id="going-lower-level">Going Lower Level</h2><p>Happy that my duct-taped-together solution achieved my mini cloud platform goal, I wanted to look a little deeper at the steps required to build an Isolate sandbox the right way.</p><p>The <a href="https://github.com/denoland/rusty_v8/blob/main/examples/hello_world.rs">hello world example</a> for using Deno&#39;s V8 bindings requires quite a bit of knowledge about V8 to be productive. Instead, I looked into using Deno&#39;s internal libraries (performance-focus Rust code). <a href="https://deno.com/blog/roll-your-own-javascript-runtime">Roll your own JavaScript runtime</a> by Bartek Iwańczuk goes through the steps to build a CLI that executes JavaScript files (using Deno&#39;s internal libraries) and shows how to add on functionality to the runtime (reading to, writing, and deleting files).</p><p>I&#39;ve put up a <a href="https://github.com/healeycodes/deno-isolate-web-request">repository</a> with my experiments to get basic web requests working in the toy runtime. It doesn&#39;t use Deno-isms like zero-copy, and I only implement about 1% of the functionally of something like <code>fetch</code>, but you can do stuff like:</p><pre><div><div><p><span>const</span><span> getExample </span><span>=</span><span> </span><span>await</span><span> request</span><span>.</span><span>get</span><span>(</span><span>&#34;http://healeycodes.com&#34;</span><span>,</span><span> </span><span>{</span><span></span></p><p><span>  </span><span>&#34;someHeaderKey&#34;</span><span>:</span><span> </span><span>&#34;someHeaderValue&#34;</span><span>,</span><span></span></p><p><span></span><span>}</span><span>)</span><span>;</span><span></span></p><p><span></span><span>console</span><span>.</span><span>log</span><span>(</span><span>{</span><span></span></p><p><span>  </span><span>status</span><span>:</span><span> getExample</span><span>.</span><span>status</span><span>,</span><span></span></p><p><span>  </span><span>headers</span><span>:</span><span> getExample</span><span>.</span><span>headers</span><span>,</span><span></span></p><p><span>  </span><span>url</span><span>:</span><span> getExample</span><span>.</span><span>url</span><span>,</span><span></span></p><p><span>  </span><span>body</span><span>:</span><span> getExample</span><span>.</span><span>body</span><span>,</span><span></span></p><p><span></span><span>}</span><span>)</span><span>;</span></p></div></div></pre><p>I was quite impressed by Deno&#39;s interfaces for V8. The Deno-to-V8 connection is straightforwards and accessible (compared to using V8 directly in C or C++) without giving up fine-grained control over things like performance and security. <a href="https://denolib.gitbook.io/guide/advanced/interaction-with-v8">A Guide to Deno Core</a> is fantastic documentation too.</p><p>Reading through Deno&#39;s <code>fetch</code> implementation — both the <a href="https://github.com/denoland/deno/blob/main/ext/fetch/lib.rs">Rust parts</a> and the <a href="https://github.com/denoland/deno/tree/main/ext/fetch">JavaScript parts</a> — reveals the complexity of building a production ready web-standards-based runtime.</p><h2 id="unexplored-ideas">Unexplored Ideas</h2><p>I didn&#39;t read too deeply into the issues around executing multiple pieces of untrusted code in the same process. But if you want to dig a little deeper on that, <a href="https://news.ycombinator.com/item?id=31740885">this HN thread</a> is the place to be. It includes Fly.io&#39;s CEO going back and forth with the tech lead for CloudFlare Workers, including asides by tptacek who wrote this <a href="https://fly.io/blog/sandboxing-and-workload-isolation/">banger-of-an-post</a> about workload isolation on Fly&#39;s blog.</p><p>Going through resources on V8 (like the codebase, the projects blog posts, or famous papers) probably wouldn&#39;t have been a waste of time but I wanted to ship some code rather than read for a week. I did enjoy reading <a href="https://github.blog/2022-06-29-the-chromium-super-inline-cache-type-confusion/">an in-depth post</a> about a recent remote code execution bug in Chromium though.</p><p>There are other JavaScript engines (like <a href="https://bellard.org/quickjs/">QuickJS</a>) that are a little easier to work with compared to V8 — but most of the smaller engines don&#39;t have any promises around security capabilities (nor are they deployed and attacked at Chrome/V8&#39;s scale). There are <a href="https://github.com/justjake/quickjs-emscripten">JavaScript/TypeScript bindings</a> for QuickJS by <a href="https://github.com/justjake/quickjs-emscripten">justjake</a> if you want to play around with that.</p><p>A recently-released <a href="https://github.com/Shopify/javy">JS to WebAssembly toolchain</a> by Shopify looks promising for evaluating code within a secure sandbox (see: <a href="https://webassembly.org/docs/security/">WebAssembly&#39;s security model</a>). Many people point to WebAssembly as the future of securely running untrusted code — with almost every mainstream programming language having some kind of capability to be compiled down to WebAssembly.</p><p>Like any excursion that takes you deeper down the stack, I return a little scared about the <a href="https://xkcd.com/2347/">software mountain</a> we build on, and curious to go back for more.</p><p><small>Thanks to <a href="https://samgeo.codes/">Samuel Eisenhandler</a> for providing feedback on an early draft.</small></p></div></div></div>
  </body>
</html>
