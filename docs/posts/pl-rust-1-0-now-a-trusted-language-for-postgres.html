<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tcdi.github.io/plrust/plrust.html">Original</a>
    <h1>PL/Rust 1.0: now a trusted language for Postgres</h1>
    
    <div id="readability-page-1" class="page">
        <!-- Provide site root to javascript -->
        

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        

        <!-- Set the theme before any content is loaded, prevents flash -->
        

        <!-- Hide / unhide sidebar before it is displayed -->
        

        <nav id="sidebar" aria-label="Table of contents">
            
            
        </nav>

        <div id="page-wrapper">

            <div class="page">
                
                

                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                

                <div id="content">
                    <main>
                        
<blockquote>
<p>This documentation is under development.</p>
</blockquote>
<p>PL/Rust is a loadable procedural language that enables writing PostgreSQL
functions in the Rust programming language. These functions are compiled to
native machine code. Unlike other procedural languages, PL/Rust functions are
not interpreted.</p>
<p>The top advantages of PL/Rust include writing natively-compiled functions to achieve the absolute best performance,
access to Rust&#39;s large development ecosystem, and Rust&#39;s compile-time safety guarantees.</p>
<p>PL/Rust is Open Source and <a href="https://github.com/tcdi/plrust">actively developed on GitHub</a>.</p>
<h2 id="features"><a href="#features">Features</a></h2>
<p>PL/Rust provides access to Postgres&#39; Server Programming Interface (SPI) including dynamic queries, prepared
statements, and cursors. It also provides safe Rust types over most of Postgres built-in data types, including (but
not limited to), <code>TEXT</code>, <code>INT</code>, <code>BIGINT</code>, <code>NUMERIC</code>, <code>FLOAT</code>, <code>DOUBLE PRECISION</code>,
<code>DATE</code>, <code>TIME</code>, etc.</p>
<p>On <code>x86_64</code> and <code>aarch64</code> systems PL/Rust can be a &#34;trusted&#34; procedural language, assuming the proper compilation
requirements are met. On other systems, it is perfectly usable as an &#34;untrusted&#34; language but cannot provide the
same level of safety guarantees.</p>
<h2 id="example-plrust-function"><a href="#example-plrust-function">Example PL/Rust function</a></h2>
<p>The following example shows an example PL/Rust function to count the length of
an input string. See <a href="https://tcdi.github.io/plrust/use-plrust.html">PL/Rust Functions and Arguments</a>
for more examples.</p>
<pre><code>CREATE FUNCTION strlen(name TEXT)
    RETURNS int LANGUAGE plrust AS
$$
    Ok(Some(name.unwrap().len() as i32))
$$;
</code></pre>
<p>Using the function is just like any other PostgreSQL function.</p>
<pre><code>SELECT strlen(&#39;Hello, PL/Rust&#39;);
</code></pre>
<pre><code>┌────────┐
│ strlen │
╞════════╡
│     14 │
└────────┘
</code></pre>
<h2 id="built-on-pgx"><a href="#built-on-pgx">Built on pgx</a></h2>
<p>PL/Rust itself is a <a href="https://github.com/tcdi/pgx"><code>pgx</code></a>-based Postgres extension.  Furthermore, each <code>LANGUAGE plrust</code> function are themselves mini-pgx extensions. <code>pgx</code>is a generalized framework for developing Postgres extensions with Rust.  Like this project, <code>pgx</code>
is developed by <a href="https://www.tcdi.com">TCDI</a>.</p>
<p>The following sections discuss PL/Rusts safety guarantees, configuration settings, and installation instructions.</p>

<p>Quoted from the &#34;Rustonomicon&#34;:</p>
<blockquote>
<p>Safe Rust is the true Rust programming language. If all you do is write Safe Rust, you will never have to worry
about type-safety or memory-safety. You will never endure a dangling pointer, a use-after-free, or any other kind
of Undefined Behavior (a.k.a. UB).</p>
</blockquote>
<p>This is the universe in which PL/Rust functions live. If a PL/Rust function compiles it has these guarantees, by
the Rust compiler, that it won&#39;t &#34;crash.&#34; This quality is important for natively-compiled code running in a
production database.</p>
<h2 id="what-about-unsafe"><a href="#what-about-unsafe">What about <code>unsafe</code>?</a></h2>
<p>PL/Rust uses the Rust compiler itself to wholesale <strong>disallow</strong> the use of <code>unsafe</code> in user functions. If
a <code>LANGUAGE plrust</code> function uses <code>unsafe</code> it won&#39;t compile.</p>
<p>Generally, what this means is that PL/Rust functions cannot call <code>unsafe fn</code>s, cannot call <code>extern &#34;C&#34;</code>s into
Postgres itself, and cannot dereference pointers.</p>
<p>This is accomplished using Rust&#39;s built-in <code>#![forbid(unsafe_code)]</code> lint.</p>
<p>3rd-party crate dependencies are allowed to use <code>unsafe</code>. We&#39;ll discuss this below.</p>
<h2 id="what-about-pgx"><a href="#what-about-pgx">What about <code>pgx</code>?</a></h2>
<p>If <code>pgx</code> is a &#34;generalized framework for developing Postgres extensions with Rust&#34;, and if PL/Rust user functions
are themselves &#34;mini-pgx extensions&#34;, what prevents a <code>LANGUAGE plrust</code> function from using any part of <code>pgx</code>?</p>
<p>The <a href="https://github.com/tcdi/plrust/tree/main/plrust-trusted-pgx"><code>plrust-trusted-pgx</code></a> crate does!
The <code>plrust-trusted-pgx</code> crate is a tightly-controlled &#34;re-export crate&#34; on top of <code>pgx</code> that exposes the bare minimum necessary for
PL/Rust user functions to compile along with the bare minimum, <strong>safe</strong> features of <code>pgx</code>.</p>
<p>The crate is versioned independently to both <code>pgx</code> and <code>plrust</code> and is published on <a href="https://crates.io/crates/plrust-trusted-pgx">crates.io</a>.
By default, the version a plrust user function will use is that of the one set in the project repository when plrust itself
is compiled.  However, the <code>plrust.trusted_pgx_version</code> GUC can be set to specify a specific version.</p>
<p>The intent is that <code>plrust-trusted-pgx</code> can evolve independently of both <code>pgx</code> and <code>plrust</code>.</p>
<p>There are a few &#34;unsafe&#34; parts of <code>pgx</code> exposed through <code>plrust-trusted-pgx</code>, but PL/Rust&#39;s ability to block <code>unsafe</code>
renders them useless by PL/Rust user functions.  <code>plrust-trusted-pgx</code>&#39;s docs are available on <a href="https://docs.rs/plrust-trusted-pgx">docs.rs</a>.</p>
<h2 id="what-about-rust-compiler-bugs"><a href="#what-about-rust-compiler-bugs">What about Rust compiler bugs?</a></h2>
<p>PL/Rust uses its own <code>rustc</code> driver which enables it to apply custom lints to the user&#39;s <code>LANGUAGE plrust</code> function.
In general, these lints will fail compilation if the user&#39;s code uses certain code idioms or patterns which we know to
have &#34;I-Unsound&#34; issues.</p>
<p>PL/Rust contains a small set of <a href="https://tcdi.github.io/plrust/config-lints.html">lints</a> to block what the developers have deemed the most egregious &#34;I-Unsound&#34; Rust bugs.</p>
<p>Should new Rust bugs be found, and detection lints are developed for PL/Rust, the lints can be applied to new user 
function compilations along with ensuring that future function executions had those lints applied at compile time.</p>
<p>Note that this is done on a best-effort basis, and does <em>not</em> provide a strong level of security — it&#39;s not a sandbox,
and as such, it&#39;s likely that a skilled hostile attacker who is sufficiently motivated could find ways around it
(PostgreSQL itself is not a particularly hardened codebase, after all). You should ensure such actors cannot execute SQL
on your database, but to be clear: this is true regardless of whether or not PL/Rust is installed. Having said that, any
issues found with our implementation will be taken seriously, and should be
<a href="https://github.com/tcdi/plrust/blob/main/SECURITY.md">reported appropriately</a>.</p>
<h2 id="trusted-with-postgrestd-on-linux-x86_64aarch64"><a href="#trusted-with-postgrestd-on-linux-x86_64aarch64">Trusted with <code>postgrestd</code> on Linux x86_64/aarch64</a></h2>
<p>The &#34;trusted&#34; version of PL/Rust uses a unique fork of Rust&#39;s <code>std</code> entitled
<a href="https://github.com/tcdi/postgrestd"><code>postgrestd</code></a> when compiling <code>LANGUAGE plrust</code> user functions. <code>postgrestd</code> is
a specialized Rust compilation target which disallows access to the filesystem and the host operating system. The Install PL/Rust section outlines the steps required for
<a href="https://tcdi.github.io/install-plrust.html#trusted-install">trusted install</a> of PL/Rust.
Currently, <code>postgrestd</code> is only supported on Linux <code>x86_64</code> and <code>aarch64</code> platforms.</p>
<p>When <code>plrust</code> user functions are compiled and linked against <code>postgrestd</code>, they are prohibited from using the
filesystem, executing processes, and otherwise interacting with the host operating system.</p>
<p>In order for PL/Rust to use <code>postgrestd</code>, its Rust compilation targets must be installed on the Postgres server.
This happens via plrust&#39;s
<a href="https://github.com/tcdi/plrust/blob/main/plrust/build"><code>plrust/build</code></a> script, which clones <code>postgrestd</code>, compiles it, by
default, for both <code>x86_64</code> and <code>aarch64</code> architectures, and ultimately places a copy of the necessary libraries used by
Rust for <code>std</code> into the appropriate &#34;sysroot&#34;, which is the location that <code>rustc</code> will look for building those
libraries.</p>
<h2 id="the-trusted-feature-flag"><a href="#the-trusted-feature-flag">The <code>trusted</code> Feature Flag</a></h2>
<p>PL/Rust has a feature flag simply named <code>trusted</code>. When compiled with the <code>trusted</code> feature flag PL/Rust will
<strong>always</strong> use the <code>postgrestd</code> targets when compiling user functions.
Again, this is only supported on <code>x86_64</code> and <code>aarch64</code> Linux systems.
<code>postgrestd</code> and the <code>trusted</code> feature flag are <strong>not</strong> supported on other platforms.
As such, PL/Rust cannot be considered fully trusted on those platforms.</p>
<p>If the <code>trusted</code> feature flag is not used when compiling PL/Rust, which is the default, then <code>postgrestd</code> is <strong>not</strong>
used when compiling user functions, and while they&#39;ll still benefit from Rust&#39;s general compile-time safety
checked, forced usage of the <code>plrust-trusted-pgx</code> crate, and PL/Rust&#39;s <code>unsafe</code> blocking, they will be able to access the
filesystem and communicate with the host operating system, as the user running the connected Postgres backend
(typically, this is a user named <code>postgres</code>).</p>

<p>In this day and age of sophisticated and flexible Postgres replication, along with cloud providers offering
Postgres on, and replication to, disparate CPU architectures, it&#39;s important that plrust, since it stores the user
function binary bytes in a database table, support running that function on a replicated Postgres server of a
different CPU architecture.</p>
<p><em>cross compilation has entered the chat</em></p>
<p>By default, PL/Rust will not perform cross compilation. It must be installed
and enabled through configuration.</p>
<p>Configuring a <em>host</em> to properly cross compile is a thing that can take minimal effort to individual feats of
heroic effort. Reading the (still in-progress) <a href="https://github.com/tcdi/pgx/blob/master/CROSS_COMPILE.md">pgx cross compile guide</a> 
can help. Generally speaking, it&#39;s not too awful to setup on Debian-based Linux systems, such as Ubuntu. Basically,
you install the &#34;cross compilation toolchain&#34; <code>apt</code> package for the <em>other</em> platform.</p>

                    </main>

                    <nav aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="next" href="https://tcdi.github.io/plrust/install-prerequisites.html" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i></i>
                            </a>
                        
                    </nav>
                </div>
            </div>

            <nav aria-label="Page navigation">
                    <a rel="next" href="https://tcdi.github.io/plrust/install-prerequisites.html" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i></i>
                    </a>
            </nav>

        </div>

        
        
        
        
        
        
        

        <!-- Custom JS scripts -->
    

</div>
  </body>
</html>
