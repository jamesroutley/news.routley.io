<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://docs.racket-lang.org/more/index.html">Original</a>
    <h1>Systems Programming with Racket</h1>
    
    <div id="readability-page-1" class="page"><div><div><p><span>8.9</span></p><p><span><p>Matthew Flatt</p></span></p><p>In contrast to the impression that <a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?tag=%28part._%28.%27%28lib._scribblings%2Fquick%2Fquick..scrbl%29.%27._.%27top.%27%29%29&amp;version=8.9" data-pltdoc="x">Quick: An Introduction to Racket with Pictures</a> may give, Racket is
not just another pretty face. Underneath the graphical facade of
DrRacket lies a sophisticated toolbox for managing threads and
processes, which is the subject of this tutorial.</p><p>Specifically, we show how to build a secure, multi-threaded,
servlet-extensible, continuation-based web server. We use much more of
the language than in <a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?tag=%28part._%28.%27%28lib._scribblings%2Fquick%2Fquick..scrbl%29.%27._.%27top.%27%29%29&amp;version=8.9" data-pltdoc="x">Quick: An Introduction to Racket with Pictures</a>, and we expect you to click on syntax or
function names that you don’t recognize (which will take you to the
relevant documentation). Beware that the last couple of sections
present material that is normally considered difficult. If you’re
still new to Racket and have relatively little programming experience,
you may want to skip to <a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=guide&amp;rel=index.html&amp;version=8.9" data-pltdoc="x">The Racket Guide</a>.</p><p>To get into the spirit of this tutorial, we suggest that you set
DrRacket aside for a moment, and switch to raw <span>racket</span> in a
terminal.
<span><span><span>If you’re already spoiled, you can keep using
DrRacket. In that case, skip <a href="#%28part._ready%29" data-pltdoc="x">Ready...</a>, build the program in
DrRacket’s definitions window instead of a <span>&#34;serve.rkt&#34;</span> file
as described in <a href="#%28part._set%29" data-pltdoc="x">Set...</a>, and click the <span>Run</span> button
instead of using <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=interactive.html%23%2528form._%2528%2528lib._racket%252Fenter..rkt%2529._enter%2521%2529%2529&amp;version=8.9" data-pltdoc="x">enter!</a></span> as shown in <a href="#%28part._go%29" data-pltdoc="x">Go!</a>.</span></span></span>
You’ll also need a text editor, such as Emacs, vi, or even
Notepad—<wbr/>any editor will do, but one that supports parenthesis
matching would be helpful. Finally, you’ll need a web client, perhaps
Lynx or Firefox.</p><h3 x-source-module="(lib &#34;scribblings/more/more.scrbl&#34;)" x-source-pkg="racket-doc" x-part-tag="&#34;ready&#34;">1<tt> </tt><a name="(part._ready)"></a>Ready...</h3><p><a href="http://download.racket-lang.org/">Download Racket</a>, install, and then
start <span>racket</span> with no command-line arguments:</p><table><tbody><tr><td><p><span>  </span><span>$ racket</span></p></td></tr><tr><td><p><span>  </span><span>Welcome to Racket v8.9 [cs].</span></p></td></tr><tr><td><p><span>  </span><span>&gt;</span></p></td></tr></tbody></table><blockquote><blockquote><blockquote><p>Set your <span>PATH</span> environment variable so you can use
<span>raco</span> and other Racket command-line functions. On Mac OS:
<span>sudo sh -c </span>&#39;<span>echo &#34;/Applications/Racket v</span><span>8.9</span><span>/bin&#34;</span><span>
</span><span>&gt;&gt; /etc/paths.d/racket</span>&#39; (assuming that you have installed
Racket in the <span>&#34;Applications&#34;</span> folder). On Windows: add the Racket
installation path to <span>Path</span> in <span>Environment Variables</span>
(under <span>System Properties</span>, <span>Advanced</span> tab).</p></blockquote></blockquote></blockquote><p>Assuming that you have Editline installed,<span><span><span>To use GNU
Readline instead of Editline, set the <span>PLT_READLINE_LIB</span>
environment variable or install the <span>&#34;readline-gpl&#34;</span> package.</span></span></span>
<span>racket</span> by default supports line editing and comma-prefixed
meta-commands that support exploration and development. See
<a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?tag=%28mod-path._.%27xrepl.%27%29&amp;version=8.9" data-pltdoc="x"><span>xrepl</span></a> for more information.</p><h3 x-source-module="(lib &#34;scribblings/more/more.scrbl&#34;)" x-source-pkg="racket-doc" x-part-tag="&#34;set&#34;">2<tt> </tt><a name="(part._set)"></a>Set...</h3><p>In the same directory where you started <span>racket</span>, create a text
file <span>&#34;serve.rkt&#34;</span>, and start it like this:</p><blockquote></blockquote><blockquote><blockquote><blockquote><p>Here’s the whole program so far in plain text: <a href="https://docs.racket-lang.org/more/step0.txt">step 0</a>.</p></blockquote></blockquote></blockquote><h3 x-source-module="(lib &#34;scribblings/more/more.scrbl&#34;)" x-source-pkg="racket-doc" x-part-tag="&#34;go&#34;">3<tt> </tt><a name="(part._go)"></a>Go!</h3><p>Back in <span>racket</span>, try loading the file and running <span>go</span>:</p><blockquote><blockquote><blockquote><p>If you use <a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=xrepl&amp;rel=index.html&amp;version=8.9" data-pltdoc="x"><span>xrepl</span></a>, you can use
<a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=xrepl&amp;rel=index.html%23%2528xrepl._enter%2529&amp;version=8.9" data-pltdoc="x"><span><span></span><span>,enter serve.rkt</span><span></span></span></a>.</p></blockquote></blockquote></blockquote><blockquote><table><tbody><tr><td><span>&gt; </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=interactive.html%23%2528form._%2528%2528lib._racket%252Fenter..rkt%2529._enter%2521%2529%2529&amp;version=8.9" data-pltdoc="x">enter!</a></span><span> </span><span>&#34;serve.rkt&#34;</span><span>)</span></td></tr><tr><td><p><span></span><span> </span><span>[loading serve.rkt]</span></p></td></tr><tr><td><span>&gt; </span><span>(</span><span>go</span><span>)</span></td></tr><tr><td><p><span>&#39;yep-it-works</span></p></td></tr></tbody></table></blockquote><p>Try modifying <span>&#34;serve.rkt&#34;</span>, and then run <span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=interactive.html%23%2528form._%2528%2528lib._racket%252Fenter..rkt%2529._enter%2521%2529%2529&amp;version=8.9" data-pltdoc="x">enter!</a></span><span> </span><span>&#34;serve.rkt&#34;</span><span>)</span> again to re-load the module, and then check your changes.</p><h3 x-source-module="(lib &#34;scribblings/more/more.scrbl&#34;)" x-source-pkg="racket-doc" x-part-tag="&#34;_Hello_World__Server&#34;">4<tt> </tt><a name="(part.__.Hello_.World__.Server)"></a>“Hello World” Server</h3><p>We’ll implement the web server through a <span>serve</span> function that
takes an IP port number for client connections:</p><blockquote></blockquote><p>The server accepts TCP connections through a <span>listener</span>, which
we create with <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=tcp.html%23%2528def._%2528%2528lib._racket%252Ftcp..rkt%2529._tcp-listen%2529%2529&amp;version=8.9" data-pltdoc="x">tcp-listen</a></span>. To make interactive development
easier, we supply <span>#t</span> as the third argument to
<span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=tcp.html%23%2528def._%2528%2528lib._racket%252Ftcp..rkt%2529._tcp-listen%2529%2529&amp;version=8.9" data-pltdoc="x">tcp-listen</a></span>, which lets us re-use the port number immediately,
without waiting for a TCP timeout.</p><blockquote></blockquote><p>The server must loop to accept connections from the listener:</p><blockquote><table><tbody><tr><td><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>(</span><span>serve</span><span> </span><span>port-no</span><span>)</span></td></tr><tr><td><span>  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>listener</span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=tcp.html%23%2528def._%2528%2528lib._racket%252Ftcp..rkt%2529._tcp-listen%2529%2529&amp;version=8.9" data-pltdoc="x">tcp-listen</a></span><span> </span><span>port-no</span><span> </span><span>5</span><span> </span><span>#t</span><span>)</span><span>)</span></td></tr><tr><td><span>  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>(</span><span>loop</span><span>)</span></td></tr><tr><td><span>    </span><span>(</span><span>accept-and-handle</span><span> </span><span>listener</span><span>)</span></td></tr><tr><td><span>    </span><span>(</span><span>loop</span><span>)</span><span>)</span></td></tr><tr><td><span>  </span><span>(</span><span>loop</span><span>)</span><span>)</span></td></tr></tbody></table></blockquote><p>Our <span>accept-and-handle</span> function accepts a connection using
<span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=tcp.html%23%2528def._%2528%2528lib._racket%252Ftcp..rkt%2529._tcp-accept%2529%2529&amp;version=8.9" data-pltdoc="x">tcp-accept</a></span>, which returns two values: a stream for input from
the client, and a stream for output to the client.</p><blockquote></blockquote><p>To handle a connection, for now, we’ll read and discard the request
header, and then write a “Hello, world!” web page as the result:</p><blockquote><table><tbody><tr><td><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>(</span><span>handle</span><span> </span><span>in</span><span> </span><span>out</span><span>)</span></td></tr><tr><td><span>  </span><span>;</span><span> </span><span>Discard the request header (up to blank line):</span></td></tr><tr><td><span>  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=regexp.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._regexp-match%2529%2529&amp;version=8.9" data-pltdoc="x">regexp-match</a></span><span> </span><span>#rx&#34;(\r\n|^)\r\n&#34;</span><span> </span><span>in</span><span>)</span></td></tr><tr><td><span>  </span><span>;</span><span> </span><span>Send reply:</span></td></tr><tr><td><span>  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=Writing.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._display%2529%2529&amp;version=8.9" data-pltdoc="x">display</a></span><span> </span><span>&#34;HTTP/1.0 200 Okay\r\n&#34;</span><span> </span><span>out</span><span>)</span></td></tr><tr><td><span>  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=Writing.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._display%2529%2529&amp;version=8.9" data-pltdoc="x">display</a></span><span> </span><span>&#34;Server: k\r\nContent-Type: text/html\r\n\r\n&#34;</span><span> </span><span>out</span><span>)</span></td></tr><tr><td><span>  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=Writing.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._display%2529%2529&amp;version=8.9" data-pltdoc="x">display</a></span><span> </span><span>&#34;&lt;html&gt;&lt;body&gt;Hello, world!&lt;/body&gt;&lt;/html&gt;&#34;</span><span> </span><span>out</span><span>)</span><span>)</span></td></tr></tbody></table></blockquote><p>Note that <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=regexp.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._regexp-match%2529%2529&amp;version=8.9" data-pltdoc="x">regexp-match</a></span> operates directly on the input stream,
which is easier than bothering with individual lines.</p><blockquote><blockquote><blockquote><p>Here’s the whole program so far in plain text: <a href="https://docs.racket-lang.org/more/step1.txt">step 1</a>.</p></blockquote></blockquote></blockquote><p>Copy the above three definitions—<wbr/><span>serve</span>,
<span>accept-and-handle</span>, and <span>handle</span>—<wbr/>into
<span>&#34;serve.rkt&#34;</span> and re-load:</p><blockquote><table><tbody><tr><td><span>&gt; </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=interactive.html%23%2528form._%2528%2528lib._racket%252Fenter..rkt%2529._enter%2521%2529%2529&amp;version=8.9" data-pltdoc="x">enter!</a></span><span> </span><span>&#34;serve.rkt&#34;</span><span>)</span></td></tr><tr><td><p><span></span><span> </span><span>[re-loading serve.rkt]</span></p></td></tr><tr><td><span>&gt; </span><span>(</span><span>serve</span><span> </span><span>8080</span><span>)</span></td></tr></tbody></table></blockquote><p>Now point your browser to <span>http://localhost:8080</span> (assuming that
you used <span>8080</span> as the port number, and that the browser is
running on the same machine) to receive a friendly greeting from your
web server.</p><h3 x-source-module="(lib &#34;scribblings/more/more.scrbl&#34;)" x-source-pkg="racket-doc" x-part-tag="&#34;Server_Thread&#34;">5<tt> </tt><a name="(part._.Server_.Thread)"></a>Server Thread</h3><p>Before we can make the web server respond in more interesting ways, we
need to get a Racket prompt back. Typing Ctl-C in your terminal window
interrupts the server loop:</p><blockquote><blockquote><blockquote><p>In DrRacket, instead of typing Ctl-C, click the
<span>Stop</span> button once.</p></blockquote></blockquote></blockquote><blockquote><table><tbody><tr><td><span>&gt; </span><span>(</span><span>serve</span><span> </span><span>8080</span><span>)</span></td></tr><tr><td><p><span>^Cuser break</span></p></td></tr><tr><td><span>&gt; </span></td></tr></tbody></table></blockquote><p>Unfortunately, we cannot now re-start the server with the same port
number:</p><blockquote><table><tbody><tr><td><span>&gt; </span><span>(</span><span>serve</span><span> </span><span>8080</span><span>)</span></td></tr><tr><td><p><span>tcp-listen: listen on 8080 failed (address already in use)</span></p></td></tr></tbody></table></blockquote><p>The problem is that the listener that we created with <span>serve</span>
is still listening on the original port number.</p><p>To avoid this problem, let’s put the listener loop in its own thread,
and have <span>serve</span> return immediately. Furthermore, we’ll have
<span>serve</span> return a function that can be used to shut down the
server thread and TCP listener:</p><blockquote></blockquote><blockquote><blockquote><blockquote><p>Here’s the whole program so far in plain text: <a href="https://docs.racket-lang.org/more/step2.txt">step 2</a>.</p></blockquote></blockquote></blockquote><p>Try the new one:</p><blockquote><table><tbody><tr><td><span>&gt; </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=interactive.html%23%2528form._%2528%2528lib._racket%252Fenter..rkt%2529._enter%2521%2529%2529&amp;version=8.9" data-pltdoc="x">enter!</a></span><span> </span><span>&#34;serve.rkt&#34;</span><span>)</span></td></tr><tr><td><p><span></span><span> </span><span>[re-loading serve.rkt]</span></p></td></tr><tr><td><span>&gt; </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>stop</span><span> </span><span>(</span><span>serve</span><span> </span><span>8081</span><span>)</span><span>)</span></td></tr></tbody></table></blockquote><p>Your server should now respond to <span>http://localhost:8081</span>, but you
can shut down and restart the server on the same port number as often
as you like:</p><blockquote><table><tbody><tr><td><span>&gt; </span><span>(</span><span>stop</span><span>)</span></td></tr><tr><td><span>&gt; </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>stop</span><span> </span><span>(</span><span>serve</span><span> </span><span>8081</span><span>)</span><span>)</span></td></tr><tr><td><span>&gt; </span><span>(</span><span>stop</span><span>)</span></td></tr><tr><td><span>&gt; </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>stop</span><span> </span><span>(</span><span>serve</span><span> </span><span>8081</span><span>)</span><span>)</span></td></tr><tr><td><span>&gt; </span><span>(</span><span>stop</span><span>)</span></td></tr></tbody></table></blockquote><h3 x-source-module="(lib &#34;scribblings/more/more.scrbl&#34;)" x-source-pkg="racket-doc" x-part-tag="&#34;Connection_Threads&#34;">6<tt> </tt><a name="(part._.Connection_.Threads)"></a>Connection Threads</h3><p>In the same way that we put the main server loop into a background
thread, we can put each individual connection into its own thread:</p><blockquote></blockquote><blockquote><blockquote><blockquote><p>Here’s the whole program so far in plain text: <a href="https://docs.racket-lang.org/more/step3.txt">step 3</a>.</p></blockquote></blockquote></blockquote><p>With this change, our server can now handle multiple threads at
once. The handler is so fast that this fact will be difficult to
detect, however, so try inserting <span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=threads.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._sleep%2529%2529&amp;version=8.9" data-pltdoc="x">sleep</a></span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=generic-numbers.html%23%2528def._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._random%2529%2529&amp;version=8.9" data-pltdoc="x">random</a></span><span> </span><span>10</span><span>)</span><span>)</span> before
the <span>handle</span> call above. If you make multiple connections from
the web browser at roughly the same time, some will return soon, and
some will take up to 10 seconds. The random delays will be independent
of the order in which you started the connections.</p><h3 x-source-module="(lib &#34;scribblings/more/more.scrbl&#34;)" x-source-pkg="racket-doc" x-part-tag="&#34;Terminating_Connections&#34;">7<tt> </tt><a name="(part._.Terminating_.Connections)"></a>Terminating Connections</h3><p>A malicious client could connect to our web server and not send the
HTTP header, in which case a connection thread will idle forever,
waiting for the end of the header. To avoid this possibility, we’d
like to implement a timeout for each connection thread.</p><p>One way to implement the timeout is to create a second thread that
waits for 10 seconds, and then kills the thread that calls
<span>handle</span>. Threads are lightweight enough in Racket that this
watcher-thread strategy works well:</p><blockquote></blockquote><p>This first attempt isn’t quite right, because when the thread is
killed, its <span>in</span> and <span>out</span> streams remain open.  We
could add code to the watcher thread to close the streams as well as
kill the thread, but Racket offers a more general shutdown mechanism:
<span>custodians</span>. A custodian is a kind of container for all
resources other than memory, and it supports a
<span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=custodians.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._custodian-shutdown-all%2529%2529&amp;version=8.9" data-pltdoc="x">custodian-shutdown-all</a></span> operation that terminates and closes
all resources within the container, whether they’re threads, streams,
or other kinds of limited resources.</p><p>Whenever a thread or stream is created, it is placed into the current
custodian as determined by the <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=custodians.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._current-custodian%2529%2529&amp;version=8.9" data-pltdoc="x">current-custodian</a></span>
parameter. To place everything about a connection into a custodian, we
<span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=parameters.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fmore-scheme..rkt%2529._parameterize%2529%2529&amp;version=8.9" data-pltdoc="x">parameterize</a></span> all the resource creations to go into a new
custodian:</p><blockquote><blockquote><blockquote><p>See <a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=guide&amp;rel=parameterize.html&amp;version=8.9" data-pltdoc="x">Dynamic Binding: <span><span>parameterize</span></span></a>
for an introduction to parameters.</p></blockquote></blockquote></blockquote><blockquote></blockquote><p>With this implementation, <span>in</span>, <span>out</span>, and the thread
that calls <span>handle</span> all belong to <span>cust</span>. In addition,
if we later change <span>handle</span> so that it, say, opens a file, then
the file handles will also belong to <span>cust</span>, so they will be
reliably closed when <span>cust</span> is shut down.</p><p>In fact, it’s a good idea to change <span>serve</span> so that it uses a
custodian, too:</p><blockquote></blockquote><p>That way, the <span>main-cust</span> created in <span>serve</span> not only
owns the TCP listener and the main server thread, it also owns every
custodian created for a connection. Consequently, the revised shutdown
procedure for the server immediately terminates all active connections,
in addition to the main server loop.</p><blockquote><blockquote><blockquote><p>Here’s the whole program so far in plain text: <a href="https://docs.racket-lang.org/more/step4.txt">step 4</a>.</p></blockquote></blockquote></blockquote><p>After updating the <span>serve</span> and <span>accept-and-handle</span>
functions as above, here’s how you can simulate a malicious client:</p><blockquote></blockquote><p>Now wait 10 seconds. If you try reading from <span>cin</span>, which is
the stream that sends data from the server back to the client, you’ll
find that the server has shut down the connection:</p><blockquote></blockquote><p>Alternatively, you don’t have to wait 10 seconds if you explicitly
shut down the server:</p><blockquote></blockquote><h3 x-source-module="(lib &#34;scribblings/more/more.scrbl&#34;)" x-source-pkg="racket-doc" x-part-tag="&#34;Dispatching&#34;">8<tt> </tt><a name="(part._.Dispatching)"></a>Dispatching</h3><p>It’s finally time to generalize our server’s “Hello, World!”
response to something more useful. Let’s adjust the server so that we
can plug in dispatching functions to handle requests to different
URLs.</p><p>To parse the incoming URL and to more easily format HTML output, we’ll
require two extra libraries:</p><blockquote><p><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=require.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._require%2529%2529&amp;version=8.9" data-pltdoc="x">require</a></span><span> </span><span>xml</span><span> </span><span>net/url</span><span>)</span></p></blockquote><p>The <a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=xml&amp;rel=index.html&amp;version=8.9" data-pltdoc="x"><span>xml</span></a> library gives us <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=xml&amp;rel=index.html%23%2528def._%2528%2528lib._xml%252Fmain..rkt%2529._xexpr-%7E3estring%2529%2529&amp;version=8.9" data-pltdoc="x">xexpr-&gt;string</a></span>, which
takes a Racket value that looks like HTML and turns it into actual
HTML:</p><blockquote><table><tbody><tr><td><span>&gt; </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=xml&amp;rel=index.html%23%2528def._%2528%2528lib._xml%252Fmain..rkt%2529._xexpr-%7E3estring%2529%2529&amp;version=8.9" data-pltdoc="x">xexpr-&gt;string</a></span><span> </span><span>&#39;</span><span>(</span><span>html</span><span> </span><span>(</span><span>head</span><span> </span><span>(</span><span>title</span><span> </span><span>&#34;Hello&#34;</span><span>)</span><span>)</span><span> </span><span>(</span><span>body</span><span> </span><span>&#34;Hi!&#34;</span><span>)</span><span>)</span><span>)</span></td></tr><tr><td><p><span>&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Hi!&lt;/body&gt;&lt;/html&gt;&#34;</span></p></td></tr></tbody></table></blockquote><p>We’ll assume that our new <span>dispatch</span> function (to be written)
takes a requested URL and produces a result value suitable to use with
<span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=xml&amp;rel=index.html%23%2528def._%2528%2528lib._xml%252Fmain..rkt%2529._xexpr-%7E3estring%2529%2529&amp;version=8.9" data-pltdoc="x">xexpr-&gt;string</a></span> to send back to the client:</p><blockquote><table><tbody><tr><td><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>(</span><span>handle</span><span> </span><span>in</span><span> </span><span>out</span><span>)</span></td></tr><tr><td><span>  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>req</span></td></tr><tr><td><span>    </span><span>;</span><span> </span><span>Match the first line to extract the request:</span></td></tr><tr><td><span>    </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=regexp.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._regexp-match%2529%2529&amp;version=8.9" data-pltdoc="x">regexp-match</a></span><span> </span><span>#rx&#34;^GET (.+) HTTP/[0-9]+\\.[0-9]+&#34;</span></td></tr><tr><td><span>                  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=Byte_and_String_Input.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._read-line%2529%2529&amp;version=8.9" data-pltdoc="x">read-line</a></span><span> </span><span>in</span><span>)</span><span>)</span><span>)</span></td></tr><tr><td><span>  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=when_unless.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fletstx-scheme..rkt%2529._when%2529%2529&amp;version=8.9" data-pltdoc="x">when</a></span><span> </span><span>req</span></td></tr><tr><td><span>    </span><span>;</span><span> </span><span>Discard the rest of the header (up to blank line):</span></td></tr><tr><td><span>    </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=regexp.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._regexp-match%2529%2529&amp;version=8.9" data-pltdoc="x">regexp-match</a></span><span> </span><span>#rx&#34;(\r\n|^)\r\n&#34;</span><span> </span><span>in</span><span>)</span></td></tr><tr><td><span>    </span><span>;</span><span> </span><span>Dispatch:</span></td></tr><tr><td><span>    </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=let.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fletstx-scheme..rkt%2529._let%2529%2529&amp;version=8.9" data-pltdoc="x">let</a></span><span> </span><span>(</span><span>[</span><span>xexpr</span><span> </span><span>(</span><span>dispatch</span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._list-ref%2529%2529&amp;version=8.9" data-pltdoc="x">list-ref</a></span><span> </span><span>req</span><span> </span><span>1</span><span>)</span><span>)</span><span>]</span><span>)</span></td></tr><tr><td><span>      </span><span>;</span><span> </span><span>Send reply:</span></td></tr><tr><td><span>      </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=Writing.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._display%2529%2529&amp;version=8.9" data-pltdoc="x">display</a></span><span> </span><span>&#34;HTTP/1.0 200 Okay\r\n&#34;</span><span> </span><span>out</span><span>)</span></td></tr><tr><td><span>      </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=Writing.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._display%2529%2529&amp;version=8.9" data-pltdoc="x">display</a></span><span> </span><span>&#34;Server: k\r\nContent-Type: text/html\r\n\r\n&#34;</span><span> </span><span>out</span><span>)</span></td></tr><tr><td><span>      </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=Writing.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._display%2529%2529&amp;version=8.9" data-pltdoc="x">display</a></span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=xml&amp;rel=index.html%23%2528def._%2528%2528lib._xml%252Fmain..rkt%2529._xexpr-%7E3estring%2529%2529&amp;version=8.9" data-pltdoc="x">xexpr-&gt;string</a></span><span> </span><span>xexpr</span><span>)</span><span> </span><span>out</span><span>)</span><span>)</span><span>)</span><span>)</span></td></tr></tbody></table></blockquote><p>The <a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=net&amp;rel=url.html&amp;version=8.9" data-pltdoc="x"><span>net/url</span></a> library gives us <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=net&amp;rel=url.html%23%2528def._%2528%2528lib._net%252Furl..rkt%2529._string-%7E3eurl%2529%2529&amp;version=8.9" data-pltdoc="x">string-&gt;url</a></span>,
<span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=net&amp;rel=url.html%23%2528def._%2528%2528lib._net%252Furl-structs..rkt%2529._url-path%2529%2529&amp;version=8.9" data-pltdoc="x">url-path</a></span>, <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=net&amp;rel=url.html%23%2528def._%2528%2528lib._net%252Furl-structs..rkt%2529._path%252Fparam-path%2529%2529&amp;version=8.9" data-pltdoc="x">path/param-path</a></span>, and <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=net&amp;rel=url.html%23%2528def._%2528%2528lib._net%252Furl-structs..rkt%2529._url-query%2529%2529&amp;version=8.9" data-pltdoc="x">url-query</a></span>
for getting from a string to parts of the URL that it represents:</p><blockquote></blockquote><p>We use these pieces to implement <span>dispatch</span>. The
<span>dispatch</span> function consults a hash table that maps an initial
path element, like <span>&#34;foo&#34;</span>, to a handler function:</p><blockquote><table><tbody><tr><td><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>(</span><span>dispatch</span><span> </span><span>str-path</span><span>)</span></td></tr><tr><td><span>  </span><span>;</span><span> </span><span>Parse the request as a URL:</span></td></tr><tr><td><span>  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=net&amp;rel=url.html%23%2528def._%2528%2528lib._net%252Furl-structs..rkt%2529._url%2529%2529&amp;version=8.9" data-pltdoc="x">url</a></span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=net&amp;rel=url.html%23%2528def._%2528%2528lib._net%252Furl..rkt%2529._string-%7E3eurl%2529%2529&amp;version=8.9" data-pltdoc="x">string-&gt;url</a></span><span> </span><span>str-path</span><span>)</span><span>)</span></td></tr><tr><td><span>  </span><span>;</span><span> </span><span>Extract the path part:</span></td></tr><tr><td><span>  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>path</span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528lib._racket%252Fprivate%252Fmap..rkt%2529._map%2529%2529&amp;version=8.9" data-pltdoc="x">map</a></span><span> </span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=net&amp;rel=url.html%23%2528def._%2528%2528lib._net%252Furl-structs..rkt%2529._path%252Fparam-path%2529%2529&amp;version=8.9" data-pltdoc="x">path/param-path</a></span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=net&amp;rel=url.html%23%2528def._%2528%2528lib._net%252Furl-structs..rkt%2529._url-path%2529%2529&amp;version=8.9" data-pltdoc="x">url-path</a></span><span> </span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=net&amp;rel=url.html%23%2528def._%2528%2528lib._net%252Furl-structs..rkt%2529._url%2529%2529&amp;version=8.9" data-pltdoc="x">url</a></span><span>)</span><span>)</span><span>)</span></td></tr><tr><td><span>  </span><span>;</span><span> </span><span>Find a handler based on the path</span><span>&#39;</span><span>s first element:</span></td></tr><tr><td><span>  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>h</span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=hashtables.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._hash-ref%2529%2529&amp;version=8.9" data-pltdoc="x">hash-ref</a></span><span> </span><span>dispatch-table</span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._car%2529%2529&amp;version=8.9" data-pltdoc="x">car</a></span><span> </span><span>path</span><span>)</span><span> </span><span>#f</span><span>)</span><span>)</span></td></tr><tr><td><span>  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=if.html%23%2528form._%2528%2528quote._%7E23%7E25kernel%2529._if%2529%2529&amp;version=8.9" data-pltdoc="x">if</a></span><span> </span><span>h</span></td></tr><tr><td><span>      </span><span>;</span><span> </span><span>Call a handler:</span></td></tr><tr><td><span>      </span><span>(</span><span>h</span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=net&amp;rel=url.html%23%2528def._%2528%2528lib._net%252Furl-structs..rkt%2529._url-query%2529%2529&amp;version=8.9" data-pltdoc="x">url-query</a></span><span> </span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=net&amp;rel=url.html%23%2528def._%2528%2528lib._net%252Furl-structs..rkt%2529._url%2529%2529&amp;version=8.9" data-pltdoc="x">url</a></span><span>)</span><span>)</span></td></tr><tr><td><span>      </span><span>;</span><span> </span><span>No handler found:</span></td></tr><tr><td><span>      </span><span>`</span><span>(</span><span>html</span><span> </span><span>(</span><span>head</span><span> </span><span>(</span><span>title</span><span> </span><span>&#34;Error&#34;</span><span>)</span><span>)</span></td></tr><tr><td><span>            </span><span>(</span><span>body</span></td></tr><tr><td><span>             </span><span>(</span><span>font</span><span> </span><span>(</span><span>(</span><span>color</span><span> </span><span>&#34;red&#34;</span><span>)</span><span>)</span></td></tr><tr><td><span>                   </span><span>&#34;Unknown page: &#34;</span></td></tr><tr><td><span>                   </span><span>,</span><span>str-path</span><span>)</span><span>)</span><span>)</span><span>)</span><span>)</span></td></tr><tr><td><span> </span></td></tr><tr><td><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>dispatch-table</span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=hashtables.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._make-hash%2529%2529&amp;version=8.9" data-pltdoc="x">make-hash</a></span><span>)</span><span>)</span></td></tr></tbody></table></blockquote><p>With the new <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=require.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._require%2529%2529&amp;version=8.9" data-pltdoc="x">require</a></span> import and new <span>handle</span>,
<span>dispatch</span>, and <span>dispatch-table</span> definitions, our
“Hello World!” server has turned into an error server. You don’t have
to stop the server to try it out. After modifying <span>&#34;serve.rkt&#34;</span>
with the new pieces, evaluate <span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=interactive.html%23%2528form._%2528%2528lib._racket%252Fenter..rkt%2529._enter%2521%2529%2529&amp;version=8.9" data-pltdoc="x">enter!</a></span><span> </span><span>&#34;serve.rkt&#34;</span><span>)</span> and then
try again to connect to the server. The web browser should show an
“Unknown page” error in red.</p><p>We can register a handler for the <span>&#34;hello&#34;</span> path like this:</p><blockquote><table><tbody><tr><td><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=hashtables.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._hash-set%2521%2529%2529&amp;version=8.9" data-pltdoc="x">hash-set!</a></span><span> </span><span>dispatch-table</span><span> </span><span>&#34;hello&#34;</span></td></tr><tr><td><span>           </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=lambda.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._lambda%2529%2529&amp;version=8.9" data-pltdoc="x">lambda</a></span><span> </span><span>(</span><span>query</span><span>)</span></td></tr><tr><td><span>             </span><span>`</span><span>(</span><span>html</span><span> </span><span>(</span><span>body</span><span> </span><span>&#34;Hello, World!&#34;</span><span>)</span><span>)</span><span>)</span><span>)</span></td></tr></tbody></table></blockquote><blockquote><blockquote><blockquote><p>Here’s the whole program so far in plain text: <a href="https://docs.racket-lang.org/more/step5.txt">step 5</a>.</p></blockquote></blockquote></blockquote><p>After adding these lines and evaluating <span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=interactive.html%23%2528form._%2528%2528lib._racket%252Fenter..rkt%2529._enter%2521%2529%2529&amp;version=8.9" data-pltdoc="x">enter!</a></span><span> </span><span>&#34;serve.rkt&#34;</span><span>)</span>,
opening <span>http://localhost:8081/hello</span> should produce the old
greeting.</p><h3 x-source-module="(lib &#34;scribblings/more/more.scrbl&#34;)" x-source-pkg="racket-doc" x-part-tag="&#34;Servlets_and_Sessions&#34;">9<tt> </tt><a name="(part._.Servlets_and_.Sessions)"></a>Servlets and Sessions</h3><p>Using the <span>query</span> argument that is passed to a handler by
<span>dispatch</span>, a handler can respond to values that a user
supplies through a form.</p><p>The following helper function constructs an HTML form. The
<span>label</span> argument is a string to show the user. The
<span>next-url</span> argument is a destination for the form results. The
<span>hidden</span> argument is a value to propagate through the form as a
hidden field. When the user responds, the <span>&#34;number&#34;</span> field in
the form holds the user’s value:</p><blockquote><table><tbody><tr><td><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>(</span><span>build-request-page</span><span> </span><span>label</span><span> </span><span>next-url</span><span> </span><span>hidden</span><span>)</span></td></tr><tr><td><span>  </span><span>`</span><span>(</span><span>html</span></td></tr><tr><td><span>    </span><span>(</span><span>head</span><span> </span><span>(</span><span>title</span><span> </span><span>&#34;Enter a Number to Add&#34;</span><span>)</span><span>)</span></td></tr><tr><td><span>    </span><span>(</span><span>body</span><span> </span><span>(</span><span>[</span><span>bgcolor</span><span> </span><span>&#34;white&#34;</span><span>]</span><span>)</span></td></tr><tr><td><span>          </span><span>(</span><span>form</span><span> </span><span>(</span><span>[</span><span>action</span><span> </span><span>,</span><span>next-url</span><span>]</span><span> </span><span>[</span><span>method</span><span> </span><span>&#34;get&#34;</span><span>]</span><span>)</span></td></tr><tr><td><span>                </span><span>,</span><span>label</span></td></tr><tr><td><span>                </span><span>(</span><span>input</span><span> </span><span>(</span><span>[</span><span>type</span><span> </span><span>&#34;text&#34;</span><span>]</span><span> </span><span>[</span><span>name</span><span> </span><span>&#34;number&#34;</span><span>]</span></td></tr><tr><td><span>                                      </span><span>[</span><span>value</span><span> </span><span>&#34;&#34;</span><span>]</span><span>)</span><span>)</span></td></tr><tr><td><span>                </span><span>(</span><span>input</span><span> </span><span>(</span><span>[</span><span>type</span><span> </span><span>&#34;hidden&#34;</span><span>]</span><span> </span><span>[</span><span>name</span><span> </span><span>&#34;hidden&#34;</span><span>]</span></td></tr><tr><td><span>                                        </span><span>[</span><span>value</span><span> </span><span>,</span><span>hidden</span><span>]</span><span>)</span><span>)</span></td></tr><tr><td><span>                </span><span>(</span><span>input</span><span> </span><span>(</span><span>[</span><span>type</span><span> </span><span>&#34;submit&#34;</span><span>]</span><span> </span><span>[</span><span>name</span><span> </span><span>&#34;enter&#34;</span><span>]</span></td></tr><tr><td><span>                                        </span><span>[</span><span>value</span><span> </span><span>&#34;Enter&#34;</span><span>]</span><span>)</span><span>)</span><span>)</span><span>)</span><span>)</span><span>)</span></td></tr></tbody></table></blockquote><p>Using this helper function, we can create a servlet that generates as
many “hello”s as a user wants:</p><blockquote><blockquote><blockquote><p>See <a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=guide&amp;rel=for.html&amp;version=8.9" data-pltdoc="x">Iterations and Comprehensions</a>
for an introduction to forms like <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=for.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._for%252Flist%2529%2529&amp;version=8.9" data-pltdoc="x">for/list</a></span>.</p></blockquote></blockquote></blockquote><blockquote></blockquote><blockquote><blockquote><blockquote><p>Here’s the whole program so far in plain text: <a href="https://docs.racket-lang.org/more/step6.txt">step 6</a>.</p></blockquote></blockquote></blockquote><p>As usual, once you have added these to your program, update with
<span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=interactive.html%23%2528form._%2528%2528lib._racket%252Fenter..rkt%2529._enter%2521%2529%2529&amp;version=8.9" data-pltdoc="x">enter!</a></span><span> </span><span>&#34;serve.rkt&#34;</span><span>)</span>, and then visit
<span>http://localhost:8081/many</span>. Provide a number, and you’ll receive
a new page with that many “hello”s.</p><h3 x-source-module="(lib &#34;scribblings/more/more.scrbl&#34;)" x-source-pkg="racket-doc" x-part-tag="&#34;Limiting_Memory_Use&#34;">10<tt> </tt><a name="(part._.Limiting_.Memory_.Use)"></a>Limiting Memory Use</h3><p>With our latest <span>&#34;many&#34;</span> servlet, we seem to have a new
problem: a malicious client could request so many “hello”s that the
server runs out of memory. Actually, a malicious client could also
supply an HTTP request whose first line is arbitrarily long.</p><p>The solution to this class of problems is to limit the memory use of a
connection. Inside <span>accept-and-handle</span>, after the definition of
<span>cust</span>, add the line</p><blockquote><p><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=custodians.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._custodian-limit-memory%2529%2529&amp;version=8.9" data-pltdoc="x">custodian-limit-memory</a></span><span> </span><span>cust</span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=generic-numbers.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._%252A%2529%2529&amp;version=8.9" data-pltdoc="x">*</a></span><span> </span><span>50</span><span> </span><span>1024</span><span> </span><span>1024</span><span>)</span><span>)</span></p></blockquote><blockquote><blockquote><blockquote><p>Here’s the whole program so far in plain text: <a href="https://docs.racket-lang.org/more/step7.txt">step 7</a>.</p></blockquote></blockquote></blockquote><p>We’re assuming that 50MB should be plenty for any
servlet. Garbage-collector overhead means that the actual memory use
of the system can be some small multiple of 50 MB. An important
guarantee, however, is that different connections will not be charged
for each other’s memory use, so one misbehaving connection will not
interfere with a different one.</p><p>So, with the new line above, and assuming that you have a couple of
hundred megabytes available for the <span>racket</span> process to use,
you shouldn’t be able to crash the web server by requesting a
ridiculously large number of “hello”s.</p><p>Given the <span>&#34;many&#34;</span> example, it’s a small step to a web server
that accepts arbitrary Racket code to execute on the server. In that
case, there are many additional security issues besides limiting
processor time and memory consumption. The
<a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=Sandboxed_Evaluation.html&amp;version=8.9" data-pltdoc="x"><span>racket/sandbox</span></a> library provides support to managing
all those other issues.</p><h3 x-source-module="(lib &#34;scribblings/more/more.scrbl&#34;)" x-source-pkg="racket-doc" x-part-tag="&#34;Continuations&#34;">11<tt> </tt><a name="(part._.Continuations)"></a>Continuations</h3><p>As a systems example, the problem of implementing a web server exposes
many system and security issues where a programming language can
help. The web-server example also leads to a classic, advanced Racket
topic: <span>continuations</span>. In fact, this facet of a web server
needs <span>delimited continuations</span>, which Racket provides.</p><p>The problem solved by continuations is related to servlet sessions and
user input, where a computation spans multiple client connections
[<a href="#%28cite._.Queinnec00%29" data-pltdoc="x">Queinnec00</a>]. Often, client-side computation (as in AJAX) is the
right solution to the problem, but many problems are best solved with
a mixture of techniques (e.g., to take advantage of the browser’s
“back” button).</p><p>As the multi-connection computation becomes more complex, propagating
arguments through <span>query</span> becomes increasingly tedious. For
example, we can implement a servlet that takes two numbers to add by
using the hidden field in the form to remember the first number:</p><blockquote><table><tbody><tr><td><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>(</span><span>sum</span><span> </span><span>query</span><span>)</span></td></tr><tr><td><span>  </span><span>(</span><span>build-request-page</span><span> </span><span>&#34;First number:&#34;</span><span> </span><span>&#34;/one&#34;</span><span> </span><span>&#34;&#34;</span><span>)</span><span>)</span></td></tr><tr><td><span> </span></td></tr><tr><td><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>(</span><span>one</span><span> </span><span>query</span><span>)</span></td></tr><tr><td><span>  </span><span>(</span><span>build-request-page</span><span> </span><span>&#34;Second number:&#34;</span></td></tr><tr><td><span>                      </span><span>&#34;/two&#34;</span></td></tr><tr><td><span>                      </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._cdr%2529%2529&amp;version=8.9" data-pltdoc="x">cdr</a></span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528lib._racket%252Fprivate%252Flist..rkt%2529._assq%2529%2529&amp;version=8.9" data-pltdoc="x">assq</a></span><span> </span><span>&#39;</span><span>number</span><span> </span><span>query</span><span>)</span><span>)</span><span>)</span><span>)</span></td></tr><tr><td><span> </span></td></tr><tr><td><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>(</span><span>two</span><span> </span><span>query</span><span>)</span></td></tr><tr><td><span>  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=let.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fletstx-scheme..rkt%2529._let%2529%2529&amp;version=8.9" data-pltdoc="x">let</a></span><span> </span><span>(</span><span>[</span><span>n</span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=generic-numbers.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._string-%7E3enumber%2529%2529&amp;version=8.9" data-pltdoc="x">string-&gt;number</a></span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._cdr%2529%2529&amp;version=8.9" data-pltdoc="x">cdr</a></span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528lib._racket%252Fprivate%252Flist..rkt%2529._assq%2529%2529&amp;version=8.9" data-pltdoc="x">assq</a></span><span> </span><span>&#39;</span><span>hidden</span><span> </span><span>query</span><span>)</span><span>)</span><span>)</span><span>]</span></td></tr><tr><td><span>        </span><span>[</span><span>m</span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=generic-numbers.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._string-%7E3enumber%2529%2529&amp;version=8.9" data-pltdoc="x">string-&gt;number</a></span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._cdr%2529%2529&amp;version=8.9" data-pltdoc="x">cdr</a></span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528lib._racket%252Fprivate%252Flist..rkt%2529._assq%2529%2529&amp;version=8.9" data-pltdoc="x">assq</a></span><span> </span><span>&#39;</span><span>number</span><span> </span><span>query</span><span>)</span><span>)</span><span>)</span><span>]</span><span>)</span></td></tr><tr><td><span>    </span><span>`</span><span>(</span><span>html</span><span> </span><span>(</span><span>body</span><span> </span><span>&#34;The sum is &#34;</span><span> </span><span>,</span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=generic-numbers.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._number-%7E3estring%2529%2529&amp;version=8.9" data-pltdoc="x">number-&gt;string</a></span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=generic-numbers.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._%252B%2529%2529&amp;version=8.9" data-pltdoc="x">+</a></span><span> </span><span>m</span><span> </span><span>n</span><span>)</span><span>)</span><span>)</span><span>)</span><span>)</span><span>)</span></td></tr><tr><td><span> </span></td></tr><tr><td><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=hashtables.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._hash-set%2521%2529%2529&amp;version=8.9" data-pltdoc="x">hash-set!</a></span><span> </span><span>dispatch-table</span><span> </span><span>&#34;sum&#34;</span><span> </span><span>sum</span><span>)</span></td></tr><tr><td><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=hashtables.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._hash-set%2521%2529%2529&amp;version=8.9" data-pltdoc="x">hash-set!</a></span><span> </span><span>dispatch-table</span><span> </span><span>&#34;one&#34;</span><span> </span><span>one</span><span>)</span></td></tr><tr><td><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=hashtables.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._hash-set%2521%2529%2529&amp;version=8.9" data-pltdoc="x">hash-set!</a></span><span> </span><span>dispatch-table</span><span> </span><span>&#34;two&#34;</span><span> </span><span>two</span><span>)</span></td></tr></tbody></table></blockquote><blockquote><blockquote><blockquote><p>Here’s the whole program so far in plain text: <a href="https://docs.racket-lang.org/more/step8.txt">step 8</a>.</p></blockquote></blockquote></blockquote><p>While the above works, we would much rather write such computations in
a direct style:</p><blockquote><table><tbody><tr><td><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>(</span><span>sum2</span><span> </span><span>query</span><span>)</span></td></tr><tr><td><span>  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>m</span><span> </span><span>(</span><span>get-number</span><span> </span><span>&#34;First number:&#34;</span><span>)</span><span>)</span></td></tr><tr><td><span>  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>n</span><span> </span><span>(</span><span>get-number</span><span> </span><span>&#34;Second number:&#34;</span><span>)</span><span>)</span></td></tr><tr><td><span>  </span><span>`</span><span>(</span><span>html</span><span> </span><span>(</span><span>body</span><span> </span><span>&#34;The sum is &#34;</span><span> </span><span>,</span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=generic-numbers.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._number-%7E3estring%2529%2529&amp;version=8.9" data-pltdoc="x">number-&gt;string</a></span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=generic-numbers.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._%252B%2529%2529&amp;version=8.9" data-pltdoc="x">+</a></span><span> </span><span>m</span><span> </span><span>n</span><span>)</span><span>)</span><span>)</span><span>)</span><span>)</span></td></tr><tr><td><span> </span></td></tr><tr><td><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=hashtables.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._hash-set%2521%2529%2529&amp;version=8.9" data-pltdoc="x">hash-set!</a></span><span> </span><span>dispatch-table</span><span> </span><span>&#34;sum2&#34;</span><span> </span><span>sum2</span><span>)</span></td></tr></tbody></table></blockquote><p>The problem is that <span>get-number</span> needs to send an HTML response
back for the current connection, and then it must obtain a response
through a new connection. That is, somehow it needs to convert the
page generated by <span>build-request-page</span> into a <span>query</span>
result:</p><blockquote></blockquote><p>Continuations let us implement a <span>send/suspend</span> operation that
performs exactly that operation. The <span>send/suspend</span> procedure
generates a URL that represents the current connection’s computation,
capturing it as a continuation. It passes the generated URL to a
procedure that creates the query page; this query page is used as the
result of the current connection, and the surrounding computation
(i.e., the continuation) is aborted. Finally, <span>send/suspend</span>
arranges for a request to the generated URL (in a new connection) to
restore the aborted computation.</p><p>Thus, <span>get-number</span> is implemented as follows:</p><blockquote><table><tbody><tr><td><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>(</span><span>get-number</span><span> </span><span>label</span><span>)</span></td></tr><tr><td><span>  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>query</span></td></tr><tr><td><span>    </span><span>;</span><span> </span><span>Generate a URL for the current computation:</span></td></tr><tr><td><span>    </span><span>(</span><span>send/suspend</span></td></tr><tr><td><span>      </span><span>;</span><span> </span><span>Receive the computation-as-URL here:</span></td></tr><tr><td><span>      </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=lambda.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._lambda%2529%2529&amp;version=8.9" data-pltdoc="x">lambda</a></span><span> </span><span>(</span><span>k-url</span><span>)</span></td></tr><tr><td><span>        </span><span>;</span><span> </span><span>Generate the query-page result for this connection.</span></td></tr><tr><td><span>        </span><span>;</span><span> </span><span>Send the query result to the saved-computation URL:</span></td></tr><tr><td><span>        </span><span>(</span><span>build-request-page</span><span> </span><span>label</span><span> </span><span>k-url</span><span> </span><span>&#34;&#34;</span><span>)</span><span>)</span><span>)</span><span>)</span></td></tr><tr><td><span>  </span><span>;</span><span> </span><span>We arrive here later, in a new connection</span></td></tr><tr><td><span>  </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=generic-numbers.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._string-%7E3enumber%2529%2529&amp;version=8.9" data-pltdoc="x">string-&gt;number</a></span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._cdr%2529%2529&amp;version=8.9" data-pltdoc="x">cdr</a></span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528lib._racket%252Fprivate%252Flist..rkt%2529._assq%2529%2529&amp;version=8.9" data-pltdoc="x">assq</a></span><span> </span><span>&#39;</span><span>number</span><span> </span><span>query</span><span>)</span><span>)</span><span>)</span><span>)</span></td></tr></tbody></table></blockquote><p>We still have to implement <span>send/suspend</span>. For that task, we
import a library of control operators:</p><blockquote><p><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=require.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._require%2529%2529&amp;version=8.9" data-pltdoc="x">require</a></span><span> </span><span>racket/control</span><span>)</span></p></blockquote><p>Specifically, we need <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=cont.html%23%2528form._%2528%2528lib._racket%252Fcontrol..rkt%2529._prompt%2529%2529&amp;version=8.9" data-pltdoc="x">prompt</a></span> and <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=cont.html%23%2528def._%2528%2528lib._racket%252Fcontrol..rkt%2529._abort%2529%2529&amp;version=8.9" data-pltdoc="x">abort</a></span> from
<a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=cont.html%23%2528mod-path._racket%252Fcontrol%2529&amp;version=8.9" data-pltdoc="x"><span>racket/control</span></a>. We use <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=cont.html%23%2528form._%2528%2528lib._racket%252Fcontrol..rkt%2529._prompt%2529%2529&amp;version=8.9" data-pltdoc="x">prompt</a></span> to mark the
place where a servlet is started, so that we can abort a computation
to that point. Change <span>handle</span> by wrapping a <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=cont.html%23%2528form._%2528%2528lib._racket%252Fcontrol..rkt%2529._prompt%2529%2529&amp;version=8.9" data-pltdoc="x">prompt</a></span>
around the call to <span>dispatch</span>:</p><blockquote><table><tbody><tr><td><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.9" data-pltdoc="x">define</a></span><span> </span><span>(</span><span>handle</span><span> </span><span>in</span><span> </span><span>out</span><span>)</span></td></tr><tr><td><span>  </span><span>....</span></td></tr><tr><td><span>    </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=let.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fletstx-scheme..rkt%2529._let%2529%2529&amp;version=8.9" data-pltdoc="x">let</a></span><span> </span><span>(</span><span>[</span><span>xexpr</span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=cont.html%23%2528form._%2528%2528lib._racket%252Fcontrol..rkt%2529._prompt%2529%2529&amp;version=8.9" data-pltdoc="x">prompt</a></span><span> </span><span>(</span><span>dispatch</span><span> </span><span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=pairs.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._list-ref%2529%2529&amp;version=8.9" data-pltdoc="x">list-ref</a></span><span> </span><span>req</span><span> </span><span>1</span><span>)</span><span>)</span><span>)</span><span>]</span><span>)</span></td></tr><tr><td><span>      </span><span>....</span><span>)</span><span>)</span></td></tr></tbody></table></blockquote><p>Now, we can implement <span>send/suspend</span>. We use <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=cont.html%23%2528def._%2528%2528lib._racket%252Fprivate%252Fmore-scheme..rkt%2529._call%252Fcc%2529%2529&amp;version=8.9" data-pltdoc="x">call/cc</a></span>
in the guise of <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=cont.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fmore-scheme..rkt%2529._let%252Fcc%2529%2529&amp;version=8.9" data-pltdoc="x">let/cc</a></span>, which captures the current
computation up to an enclosing <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=cont.html%23%2528form._%2528%2528lib._racket%252Fcontrol..rkt%2529._prompt%2529%2529&amp;version=8.9" data-pltdoc="x">prompt</a></span> and binds that
computation to an identifier—<wbr/><span>k</span>, in this case:</p><blockquote></blockquote><p>Next, we generate a new dispatch tag, and we record the mapping from
the tag to <span>k</span>:</p><blockquote></blockquote><p>Finally, we abort the current computation, supplying instead the page
that is built by applying the given <span>mk-page</span> to a URL for the
generated tag:</p><blockquote></blockquote><p>When the user submits the form, the handler associated with the form’s
URL is the old computation, stored as a continuation in the dispatch
table. Calling the continuation (like a function) restores the old
computation, passing the <span>query</span> argument back to that
computation.</p><blockquote><blockquote><blockquote><p>Here’s the final program in plain text: <a href="https://docs.racket-lang.org/more/step9.txt">step 9</a>.</p></blockquote></blockquote></blockquote><p>In summary, the new pieces are: <span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=require.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._require%2529%2529&amp;version=8.9" data-pltdoc="x">require</a></span><span> </span><span>racket/control</span><span>)</span>,
adding <span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=cont.html%23%2528form._%2528%2528lib._racket%252Fcontrol..rkt%2529._prompt%2529%2529&amp;version=8.9" data-pltdoc="x">prompt</a></span> inside <span>handle</span>, the definitions of
<span>send/suspend</span>, <span>get-number</span>, and <span>sum2</span>, and
<span>(</span><span><a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=hashtables.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._hash-set%2521%2529%2529&amp;version=8.9" data-pltdoc="x">hash-set!</a></span><span> </span><span>dispatch-table</span><span> </span><span>&#34;sum2&#34;</span><span> </span><span>sum2</span><span>)</span>. Once you have
the server updated, visit <span>http://localhost:8081/sum2</span>.</p><h3 x-source-module="(lib &#34;scribblings/more/more.scrbl&#34;)" x-source-pkg="racket-doc" x-part-tag="&#34;Where_to_Go_From_Here&#34;">12<tt> </tt><a name="(part._.Where_to_.Go_.From_.Here)"></a>Where to Go From Here</h3><p>The Racket distribution includes a production-quality web server that
addresses all of the design points mentioned here and more.  To learn
more, see the tutorial <a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?tag=%28part._%28.%27%28lib._web-server%2Fscribblings%2Ftutorial%2Fcontinue..scrbl%29.%27._.%27top.%27%29%29&amp;version=8.9" data-pltdoc="x">Continue: Web Applications in Racket</a>, <a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?tag=%28part._%28.%27%28lib._web-server%2Fscribblings%2Fweb-server..scrbl%29.%27._.%27top.%27%29%29&amp;version=8.9" data-pltdoc="x">theWeb Applications in Racketdocumentation</a>, or the
research paper [<a href="#%28cite._.Krishnamurthi07%29" data-pltdoc="x">Krishnamurthi07</a>].</p><p>Otherwise, if you arrived here as part of an introduction to
Racket, then your next stop is probably <a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=guide&amp;rel=index.html&amp;version=8.9" data-pltdoc="x">The Racket Guide</a>.</p><p>If the topics covered here are the kind that interest you, see also
<a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=concurrency.html&amp;version=8.9" data-pltdoc="x">Concurrency and Parallelism</a> and <a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=security.html&amp;version=8.9" data-pltdoc="x">Reflection and Security</a> in <a href="https://download.racket-lang.org/releases/8.9/doc/local-redirect/index.html?doc=reference&amp;rel=index.html&amp;version=8.9" data-pltdoc="x">The Racket Reference</a>.</p><p>Some of this material is based on relatively recent research, and more
information can be found in papers written by the authors of Racket,
including papers on GRacket (formerly “MrEd”) [<a href="#%28cite._.Flatt99%29" data-pltdoc="x">Flatt99</a>],
memory accounting [<a href="#%28cite._.Wick04%29" data-pltdoc="x">Wick04</a>], kill-safe abstractions
[<a href="#%28cite._.Flatt04%29" data-pltdoc="x">Flatt04</a>], and delimited continuations [<a href="#%28cite._.Flatt07%29" data-pltdoc="x">Flatt07</a>].</p><h3 x-source-module="(lib &#34;scribblings/more/more.scrbl&#34;)" x-source-pkg="racket-doc" x-part-tag="&#34;doc-bibliography&#34;"><a name="(part._doc-bibliography)"></a>Bibliography</h3><table><tbody><tr><td><a name="(cite._.Flatt99)"></a>[Flatt99]</td><td><span> </span></td><td><span>Matthew Flatt, Robert Bruce Findler, Shriram Krishnamurthi, and Matthias Felleisen, “Programming Languages as Operating Systems
(<span>or</span> Revenge of the Son of the Lisp Machine),” International Conference on Functional Programming, 1999. <a href="http://www.ccs.neu.edu/scheme/pubs/icfp99-ffkf.pdf"><span>http://www.ccs.neu.edu/scheme/pubs/icfp99-ffkf.pdf</span></a></span></td></tr><tr><td><a name="(cite._.Flatt04)"></a>[Flatt04]</td><td><span> </span></td><td><span>Matthew Flatt and Robert Bruce Findler, “Kill-Safe Synchronization Abstractions,” Programming Language Design and Implementation, 2004. <a href="http://www.cs.utah.edu/plt/publications/pldi04-ff.pdf"><span>http://www.cs.utah.edu/plt/publications/pldi04-ff.pdf</span></a></span></td></tr><tr><td><a name="(cite._.Flatt07)"></a>[Flatt07]</td><td><span> </span></td><td><span>Matthew Flatt, Gang Yu, Robert Bruce Findler, and Matthias Felleisen, “Adding Delimited and Composable Control to a Production Programming Environment,” International Conference on Functional Programming, 2007. <a href="http://www.cs.utah.edu/plt/publications/icfp07-fyff.pdf"><span>http://www.cs.utah.edu/plt/publications/icfp07-fyff.pdf</span></a></span></td></tr><tr><td><a name="(cite._.Krishnamurthi07)"></a>[Krishnamurthi07]</td><td><span> </span></td><td><span>Shriram Krishnamurthi, Peter Hopkins, Jay McCarthy, Paul T. Graunke, Greg Pettyjohn, and Matthias Felleisen, “Implementation and Use of the PLT Scheme Web Server,” <span>Higher-Order and Symbolic Computation</span>, 2007. <a href="http://www.cs.brown.edu/~sk/Publications/Papers/Published/khmgpf-impl-use-plt-web-server-journal/paper.pdf"><span>http://www.cs.brown.edu/~sk/Publications/Papers/Published/khmgpf-impl-use-plt-web-server-journal/paper.pdf</span></a></span></td></tr><tr><td><a name="(cite._.Queinnec00)"></a>[Queinnec00]</td><td><span> </span></td><td><span>Christian Queinnec, “The Influence of Browsers on Evaluators or, Continuations to Program Web Servers,” International Conference on Functional Programming, 2000. <a href="http://pagesperso-systeme.lip6.fr/Christian.Queinnec/PDF/webcont.pdf"><span>http://pagesperso-systeme.lip6.fr/Christian.Queinnec/PDF/webcont.pdf</span></a></span></td></tr><tr><td><a name="(cite._.Wick04)"></a>[Wick04]</td><td><span> </span></td><td><span>Adam Wick and Matthew Flatt, “Memory Accounting without Partitions,” International Symposium on Memory Management, 2004. <a href="http://www.cs.utah.edu/plt/publications/ismm04-wf.pdf"><span>http://www.cs.utah.edu/plt/publications/ismm04-wf.pdf</span></a></span></td></tr></tbody></table></div></div></div>
  </body>
</html>
