<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://netflixtechblog.com/migrating-netflix-to-graphql-safely-8e1e4d4f1e72?gi=4217a3fd9c5c">Original</a>
    <h1>Migrating Netflix to GraphQL safely</h1>
    
    <div id="readability-page-1" class="page"><section><div><div><div><div><div><div><div><div><div><div><div><a href="https://netflixtechblog.medium.com" rel="noopener follow"><div><div aria-hidden="false"><div><div><p><img alt="Netflix Technology Blog" src="https://miro.medium.com/v2/resize:fill:88:88/1*BJWRqfSMf9Da9vsXG9EBRQ.jpeg" width="44" height="44" loading="lazy"/></p></div></div></div></div></a><a href="https://netflixtechblog.com" rel="noopener  ugc nofollow"><div><div><div aria-hidden="false"><div><div><p><img alt="Netflix TechBlog" src="https://miro.medium.com/v2/resize:fill:48:48/1*ty4NvNrGg4ReETxqU2N3Og.png" width="24" height="24" loading="lazy"/></p></div></div></div></div></div></a></div></div></div></div></div></div></div><p id="5868">By <a href="https://www.linkedin.com/in/jennifer-shin-0019a516/" rel="noopener ugc nofollow" target="_blank">Jennifer Shin</a>, <a href="https://www.linkedin.com/in/tejas-shikhare-81027b19/" rel="noopener ugc nofollow" target="_blank">Tejas Shikhare</a>, <a href="https://www.linkedin.com/in/willemmanuel/" rel="noopener ugc nofollow" target="_blank">Will Emmanuel</a></p><p id="00f0">In 2022, a major change was made to Netflix’s iOS and Android applications. We migrated Netflix’s mobile apps to GraphQL with zero downtime, which involved a total overhaul from the client to the API layer.</p><p id="f179">Until recently, an internal API framework, <a href="https://netflix.github.io/falcor/" rel="noopener ugc nofollow" target="_blank">Falcor</a>, powered our mobile apps. They are now backed by <a rel="noopener ugc nofollow" target="_blank" href="https://www.cyberdemon.org/how-netflix-scales-its-api-with-graphql-federation-part-1-ae3557c187e2">Federated GraphQL</a>, a distributed approach to APIs where domain teams can independently manage and own specific sections of the API.</p><p id="663a">Doing this <strong>safely</strong> for 100s of millions of customers without disruption is exceptionally challenging, especially considering the many dimensions of change involved. This blog post will share broadly-applicable techniques (beyond GraphQL) we used to perform this migration. The three strategies we will discuss today are <strong>AB Testing</strong>, <strong>Replay Testing,</strong> and <strong>Sticky Canaries</strong>.</p><p id="249a">Before diving into these techniques, let’s briefly examine the migration plan.</p><p id="0221"><strong>Before GraphQL: Monolithic Falcor API implemented and maintained by the API Team</strong></p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*9b08XEVCUiNEG10039-UyQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*9b08XEVCUiNEG10039-UyQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*9b08XEVCUiNEG10039-UyQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*9b08XEVCUiNEG10039-UyQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*9b08XEVCUiNEG10039-UyQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*9b08XEVCUiNEG10039-UyQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9b08XEVCUiNEG10039-UyQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*9b08XEVCUiNEG10039-UyQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*9b08XEVCUiNEG10039-UyQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*9b08XEVCUiNEG10039-UyQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*9b08XEVCUiNEG10039-UyQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*9b08XEVCUiNEG10039-UyQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*9b08XEVCUiNEG10039-UyQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*9b08XEVCUiNEG10039-UyQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="336" loading="lazy" role="presentation"/></picture></div></div></figure><p id="dc3e">Before moving to GraphQL, our API layer consisted of a monolithic server built with <a href="https://netflix.github.io/falcor/" rel="noopener ugc nofollow" target="_blank">Falcor</a>. A single API team maintained both the Java implementation of the Falcor framework <em>and</em> the API Server.</p><p id="7ad5"><strong>Created a GraphQL Shim Service on top of our existing Monolith Falcor API.</strong></p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*DwoVONp2LLEuJ86UuyiWqQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*DwoVONp2LLEuJ86UuyiWqQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*DwoVONp2LLEuJ86UuyiWqQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*DwoVONp2LLEuJ86UuyiWqQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*DwoVONp2LLEuJ86UuyiWqQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*DwoVONp2LLEuJ86UuyiWqQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DwoVONp2LLEuJ86UuyiWqQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*DwoVONp2LLEuJ86UuyiWqQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*DwoVONp2LLEuJ86UuyiWqQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*DwoVONp2LLEuJ86UuyiWqQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*DwoVONp2LLEuJ86UuyiWqQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*DwoVONp2LLEuJ86UuyiWqQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*DwoVONp2LLEuJ86UuyiWqQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*DwoVONp2LLEuJ86UuyiWqQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="262" loading="lazy" role="presentation"/></picture></div></div></figure><p id="8fe5">By the summer of 2020, many UI engineers were ready to move to GraphQL. Instead of embarking on a full-fledged migration top to bottom, we created a GraphQL shim on top of our existing Falcor API. The GraphQL shim enabled client engineers to move quickly onto GraphQL, figure out client-side concerns like cache normalization, experiment with different GraphQL clients, and investigate client performance without being blocked by server-side migrations. To launch Phase 1 safely, we used <strong>AB Testing</strong>.</p><p id="fd21"><strong>Deprecate the GraphQL Shim Service and Legacy API Monolith in favor of GraphQL services owned by the domain teams.</strong></p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*pIaQcrZRPruNX_TzKcdR5Q.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*pIaQcrZRPruNX_TzKcdR5Q.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*pIaQcrZRPruNX_TzKcdR5Q.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*pIaQcrZRPruNX_TzKcdR5Q.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*pIaQcrZRPruNX_TzKcdR5Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*pIaQcrZRPruNX_TzKcdR5Q.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pIaQcrZRPruNX_TzKcdR5Q.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*pIaQcrZRPruNX_TzKcdR5Q.png 640w, https://miro.medium.com/v2/resize:fit:720/1*pIaQcrZRPruNX_TzKcdR5Q.png 720w, https://miro.medium.com/v2/resize:fit:750/1*pIaQcrZRPruNX_TzKcdR5Q.png 750w, https://miro.medium.com/v2/resize:fit:786/1*pIaQcrZRPruNX_TzKcdR5Q.png 786w, https://miro.medium.com/v2/resize:fit:828/1*pIaQcrZRPruNX_TzKcdR5Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*pIaQcrZRPruNX_TzKcdR5Q.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*pIaQcrZRPruNX_TzKcdR5Q.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="362" loading="lazy" role="presentation"/></picture></div></div></figure><p id="7f89">We didn’t want the legacy Falcor API to linger forever, so we leaned into Federated GraphQL to power a single GraphQL API with multiple GraphQL servers.</p><p id="190d">We could also swap out the implementation of a field from GraphQL Shim to Video API with federation directives. To launch Phase 2 safely, we used <strong>Replay Testing</strong> and <strong>Sticky Canaries</strong>.</p><p id="1b3c">Two key factors determined our testing strategies:</p><ul><li id="f773">Functional vs. non-functional requirements</li><li id="b25a">Idempotency</li></ul><p id="c053">If we were testing <strong>functional requirements</strong> like data accuracy, and if the request was <strong>idempotent</strong>, we relied on <strong>Replay Testing</strong>. We knew we could test the same query with the same inputs and consistently expect the same results.</p><p id="1f23">We couldn’t replay test GraphQL queries or mutations that requested non-idempotent fields.</p><figure><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*6AUD_2oUUTauxY5mo_BM9Q.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*6AUD_2oUUTauxY5mo_BM9Q.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*6AUD_2oUUTauxY5mo_BM9Q.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*6AUD_2oUUTauxY5mo_BM9Q.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*6AUD_2oUUTauxY5mo_BM9Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*6AUD_2oUUTauxY5mo_BM9Q.png 1100w, https://miro.medium.com/v2/resize:fit:1292/format:webp/1*6AUD_2oUUTauxY5mo_BM9Q.png 1292w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 646px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*6AUD_2oUUTauxY5mo_BM9Q.png 640w, https://miro.medium.com/v2/resize:fit:720/1*6AUD_2oUUTauxY5mo_BM9Q.png 720w, https://miro.medium.com/v2/resize:fit:750/1*6AUD_2oUUTauxY5mo_BM9Q.png 750w, https://miro.medium.com/v2/resize:fit:786/1*6AUD_2oUUTauxY5mo_BM9Q.png 786w, https://miro.medium.com/v2/resize:fit:828/1*6AUD_2oUUTauxY5mo_BM9Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*6AUD_2oUUTauxY5mo_BM9Q.png 1100w, https://miro.medium.com/v2/resize:fit:1292/1*6AUD_2oUUTauxY5mo_BM9Q.png 1292w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 646px"/><img alt="" width="646" height="765" loading="lazy" role="presentation"/></picture></div></figure><p id="637b">And we definitely couldn’t replay test <strong>non-functional requirements</strong> like caching and logging user interaction. In such cases, we were not testing for response data but overall behavior. So, we relied on higher-level metrics-based testing: <strong>AB Testing </strong>and<strong> Sticky Canaries</strong>.</p><p id="7831">Let’s discuss the three testing strategies in further detail.</p><p id="4404">Netflix traditionally uses AB Testing to evaluate whether new product features resonate with customers. <strong>In Phase 1,</strong> we leveraged the AB testing framework to isolate a user segment into two groups totaling 1 million users. The control group’s traffic utilized the legacy Falcor stack, while the experiment population leveraged the new GraphQL client and was directed to the GraphQL Shim. To determine customer impact, we could compare various metrics such as error rates, latencies, and time to render.</p><p id="bb3c">We set up a client-side AB experiment that tested Falcor versus GraphQL and reported coarse-grained quality of experience metrics (<strong>QoE</strong>). The AB experiment results hinted that GraphQL’s correctness was not up to par with the legacy system. We spent the next few months diving into these high-level metrics and fixing issues such as cache TTLs, flawed client assumptions, etc.</p><h2 id="8905">Wins</h2><p id="c256"><strong>High-Level Health Metrics: </strong>AB Testing provided the assurance we needed in our overall client-side GraphQL implementation. This helped us successfully migrate 100% of the traffic on the mobile homepage canvas to GraphQL in 6 months.</p><h2 id="1a7a">Gotchas</h2><p id="5d47"><strong>Error Diagnosis: </strong>With an AB test, we could see coarse-grained metrics which pointed to potential issues, but it was challenging<strong> to diagnose</strong> the exact issues.</p><p id="3374">The next phase in the migration was to reimplement our existing Falcor API in a GraphQL-first server (Video API Service). The Falcor API had become a logic-heavy monolith with over a decade of tech debt. So we had to ensure that the reimplemented Video API server was bug-free and identical to the already productized Shim service.</p><p id="38d6">We developed a Replay Testing tool to verify that <strong>idempotent</strong> APIs were migrated correctly from the GraphQL Shim to the Video API service.</p><p id="7ad1">The Replay Testing framework leverages the <em>@override</em> directive available in GraphQL Federation. This directive tells the GraphQL Gateway to route to one GraphQL server over another. Take, for instance, the following two GraphQL schemas defined by the Shim Service and the Video Service:</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*C68WgNffpOMi88xWtBjpXQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*C68WgNffpOMi88xWtBjpXQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*C68WgNffpOMi88xWtBjpXQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*C68WgNffpOMi88xWtBjpXQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*C68WgNffpOMi88xWtBjpXQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*C68WgNffpOMi88xWtBjpXQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C68WgNffpOMi88xWtBjpXQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*C68WgNffpOMi88xWtBjpXQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*C68WgNffpOMi88xWtBjpXQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*C68WgNffpOMi88xWtBjpXQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*C68WgNffpOMi88xWtBjpXQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*C68WgNffpOMi88xWtBjpXQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*C68WgNffpOMi88xWtBjpXQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*C68WgNffpOMi88xWtBjpXQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="151" loading="lazy" role="presentation"/></picture></div></div></figure><p id="3ecb">The GraphQL Shim first defined the <em>certificationRating</em> field (things like Rated R or PG-13) in Phase 1. In Phase 2, we stood up the VideoService and defined the same <em>certificationRating</em> field marked with the <em>@override</em> directive. The presence of the identical field with the <em>@override</em> directive informed the GraphQL Gateway to route the resolution of this field to the new Video Service rather than the old Shim Service.</p><p id="3453">The Replay Tester tool samples raw traffic streams from <a href="https://netflix.github.io/mantis/" rel="noopener ugc nofollow" target="_blank">Mantis</a>. With these sampled events, the tool can capture a live request from production and run an <strong>identical</strong> GraphQL query against both the GraphQL Shim and the new Video API service. The tool then compares the results and outputs any differences in response payloads.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*u38PDW5BKHqtOEui3_WQjA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*u38PDW5BKHqtOEui3_WQjA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*u38PDW5BKHqtOEui3_WQjA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*u38PDW5BKHqtOEui3_WQjA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*u38PDW5BKHqtOEui3_WQjA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*u38PDW5BKHqtOEui3_WQjA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u38PDW5BKHqtOEui3_WQjA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*u38PDW5BKHqtOEui3_WQjA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*u38PDW5BKHqtOEui3_WQjA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*u38PDW5BKHqtOEui3_WQjA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*u38PDW5BKHqtOEui3_WQjA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*u38PDW5BKHqtOEui3_WQjA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*u38PDW5BKHqtOEui3_WQjA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*u38PDW5BKHqtOEui3_WQjA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="464" loading="lazy" role="presentation"/></picture></div></div></figure><p id="6e0c"><strong>Note: We do not replay test Personally Identifiable Information. It’s used only for non-sensitive product features on the Netflix UI.</strong></p><p id="80ce">Once the test is completed, the engineer can view the diffs displayed as a <em>flattened JSON node</em>. You can see the control value on the left side of the comma in parentheses and the experiment value on the right.</p><pre><span id="fabb">/data/videos/0/tags/3/id: (81496962, null)</span></pre><pre><span id="c602">/data/videos/0/tags/5/displayName: (Série, value: “S\303\251rie”)</span></pre><p id="aeef">We captured two diffs above, the first had missing data for an ID field in the experiment, and the second had an encoding difference. We also saw differences in localization, date precisions, and floating point accuracy. It gave us confidence in replicated business logic, where subscriber plans and user geographic location determined the customer’s catalog availability.</p><h2 id="8afe">Wins</h2><ul><li id="69cd"><strong>Confidence</strong> in parity between the two GraphQL Implementations</li><li id="d3be"><strong>Enabled tuning</strong> <strong>configs</strong> in cases where data was missing due to over-eager timeouts</li><li id="f271"><strong>Tested</strong> <strong>business logic</strong> that required many (unknown) inputs and where correctness can be hard to eyeball</li></ul><h2 id="8f09">Gotchas</h2><ul><li id="b889"><strong>PII</strong> and non-idempotent APIs should <strong>not</strong> be tested using Replay Tests, and it would be valuable to have a mechanism to <strong><em>prevent</em></strong> that.</li><li id="a289"><strong>Manually constructed queries</strong> are only as good as the features the developer remembers to test. We ended up with untested fields simply because we forgot about them.</li><li id="6d9b"><strong>Correctness:</strong> The idea of correctness can be confusing too. For example, is it more correct for an array to be empty or null, or is it just noise? Ultimately, we matched the existing behavior as much as possible because verifying the robustness of the client’s error handling was difficult.</li></ul><p id="7ab6">Despite these shortcomings, Replay Testing was a key indicator that we had achieved functional correctness of <em>most</em> idempotent queries.</p><p id="4c39">While Replay Testing validates the functional correctness of the new GraphQL APIs, it does not provide any performance or business metric insight, such as the <strong>overall perceived health of user interaction</strong>. Are users clicking play at the same rates? Are things loading in time before the user loses interest? Replay Testing also cannot be used for non-idempotent API validation. We reached for a Netflix tool called the Sticky Canary to build confidence.</p><p id="2597">A Sticky Canary is an infrastructure experiment where customers are assigned either to a canary or baseline host for the entire duration of an experiment. All incoming traffic is allocated to an experimental or baseline host based on their device and profile, similar to a bucket hash. The experimental host deployment serves all the customers assigned to the experiment. Watch our <a href="https://www.youtube.com/watch?v=Xbn65E-BQhA" rel="noopener ugc nofollow" target="_blank">Chaos Engineering</a> talk from AWS Reinvent to learn more about Sticky Canaries.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*4jAIZZ4_a7h7NwL8kKiA1A.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*4jAIZZ4_a7h7NwL8kKiA1A.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*4jAIZZ4_a7h7NwL8kKiA1A.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*4jAIZZ4_a7h7NwL8kKiA1A.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*4jAIZZ4_a7h7NwL8kKiA1A.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*4jAIZZ4_a7h7NwL8kKiA1A.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4jAIZZ4_a7h7NwL8kKiA1A.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*4jAIZZ4_a7h7NwL8kKiA1A.png 640w, https://miro.medium.com/v2/resize:fit:720/1*4jAIZZ4_a7h7NwL8kKiA1A.png 720w, https://miro.medium.com/v2/resize:fit:750/1*4jAIZZ4_a7h7NwL8kKiA1A.png 750w, https://miro.medium.com/v2/resize:fit:786/1*4jAIZZ4_a7h7NwL8kKiA1A.png 786w, https://miro.medium.com/v2/resize:fit:828/1*4jAIZZ4_a7h7NwL8kKiA1A.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*4jAIZZ4_a7h7NwL8kKiA1A.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*4jAIZZ4_a7h7NwL8kKiA1A.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="308" loading="lazy" role="presentation"/></picture></div></div></figure><p id="78f4">In the case of our GraphQL APIs, we used a Sticky Canary experiment to<strong> run two instances of our GraphQL gateway</strong>. The <strong>baseline</strong> gateway used the existing schema, which routes all traffic to the GraphQL Shim. The <strong>experimental</strong> gateway used the new proposed schema, which routes traffic to the latest Video API service. <a href="https://github.com/Netflix/zuul" rel="noopener ugc nofollow" target="_blank">Zuul</a>, our primary edge gateway, assigns traffic to either cluster based on the experiment parameters.</p><p id="4b0b">We then collect and analyze the performance of the two clusters. Some KPIs we monitor closely include:</p><ul><li id="8a68">Median and tail latencies</li><li id="77c9">Error rates</li><li id="7d23">Logs</li><li id="43cb">Resource utilization–CPU, network traffic, memory, disk</li><li id="f2e9">Device QoE (Quality of Experience) metrics</li><li id="8c37">Streaming health metrics</li></ul><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*SzHeBP1qU722lruPiOvmJQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*SzHeBP1qU722lruPiOvmJQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*SzHeBP1qU722lruPiOvmJQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*SzHeBP1qU722lruPiOvmJQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*SzHeBP1qU722lruPiOvmJQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*SzHeBP1qU722lruPiOvmJQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SzHeBP1qU722lruPiOvmJQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*SzHeBP1qU722lruPiOvmJQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*SzHeBP1qU722lruPiOvmJQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*SzHeBP1qU722lruPiOvmJQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*SzHeBP1qU722lruPiOvmJQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*SzHeBP1qU722lruPiOvmJQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*SzHeBP1qU722lruPiOvmJQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*SzHeBP1qU722lruPiOvmJQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="467" loading="lazy" role="presentation"/></picture></div></div></figure><p id="2d10">We started small, with tiny customer allocations for hour-long experiments. After validating performance, we slowly built up scope. We increased the percentage of customer allocations, introduced multi-region tests, and eventually 12-hour or day-long experiments. Validating along the way is essential since Sticky Canaries impact live production traffic and are assigned persistently to a customer.</p><p id="f089">After several sticky canary experiments, we had assurance that phase 2 of the migration improved all core metrics, and we could dial up GraphQL globally with confidence.</p><h2 id="8d41">Wins</h2><p id="8d9a">Sticky Canaries was essential to build confidence in our new GraphQL services.</p><ul><li id="9151"><strong>Non-Idempotent APIs:</strong> these tests are compatible with mutating or non-idempotent APIs</li><li id="6fc2"><strong>Business metrics:</strong> Sticky Canaries validated our core Netflix business metrics had improved after the migration</li><li id="baad"><strong>System performance:</strong> Insights into latency and resource usage help us understand how scaling profiles change after migration</li></ul><h2 id="a4d0">Gotchas</h2><ul><li id="1eb3"><strong>Negative Customer Impact: </strong>Sticky Canaries can impact real users. We needed confidence in our new services before persistently routing some customers to them. This is partially mitigated by <em>real-time impact detection</em>, which will automatically cancel experiments.</li><li id="2c89"><strong>Short-lived:</strong> Sticky Canaries are meant for short-lived experiments. For longer-lived tests, a full-blown AB test should be used.</li></ul><p id="feb3">Technology is constantly changing, and we, as engineers, spend a large part of our careers performing migrations. The question is not whether we are migrating but whether we are migrating <strong><em>safely</em></strong>, with zero downtime, in a timely manner.</p><p id="c543">At Netflix, we have developed tools that ensure confidence in these migrations, targeted toward each specific use case being tested. We covered three tools, <strong>AB testing</strong>, <strong>Replay Testing</strong>, and <strong>Sticky Canaries</strong> that we used for the GraphQL Migration.</p><p id="03f5">This blog post is part of our Migrating Critical Traffic series. Also, check out: Migrating Critical Traffic at Scale (<a rel="noopener ugc nofollow" target="_blank" href="https://www.cyberdemon.org/migrating-critical-traffic-at-scale-with-no-downtime-part-1-ba1c7a1c7835">part 1</a>, <a href="https://netflixtechblog.medium.com/migrating-critical-traffic-at-scale-with-no-downtime-part-2-4b1c8c7155c1" rel="noopener">part 2</a>) and <a rel="noopener ugc nofollow" target="_blank" href="https://www.cyberdemon.org/ensuring-the-successful-launch-of-ads-on-netflix-f99490fdf1ba">Ensuring the Successful Launch of Ads</a>.</p></div></div></div></div></section></div>
  </body>
</html>
