<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://taras.glek.net/post/cloudflare-pages-kind-of-amazing/">Original</a>
    <h1>Cloudflare Pages: Best server tech since CGI-bin?</h1>
    
    <div id="readability-page-1" class="page"><div role="main">
  <div>
    <div>
      <article role="main">
        <h3 id="cloudflare-pages-">Cloudflare Pages üòç</h3>
<p>I got into <a href="https://developers.cloudflare.com/pages/">Cloudflare pages</a> because it lets you host static websites with all the latest optimizations conveniently and for free. Setting up a static website with a custom domain is easy, and you get the benefits of automatic SSL, CDN, and latest version of HTTP3.</p>
<p>This is how this blog is hosted and I have a few other projects like this. I love the fact that I can get a super-fast static website up and running in a few minutes and I don‚Äôt have to worry about infrastructure details.</p>
<p>Recently, I needed to add a serverside component to one of my projects in order to generate <a href="https://developer.twitter.com/en/docs/twitter-for-websites/cards/overview/abouts-cards">twitter cards</a>. This required a database to dump pictures + metadata into (I love <a href="https://supabase.com/">supabase</a> for that). I also needed server-side functionality to serve the twitter card metadata + user screenshots.</p>
<h3 id="cloudflare-functions-holy-documentation-batman-">Cloudflare Functions: Holy Documentation Batman! üò±</h3>
<p>I started reading about <a href="https://developers.cloudflare.com/pages/platform/functions/">Cloudflare functions</a>. It‚Äôs cool that you can extend your static website with server-side JavaScript code. You just make a <code>functions</code> subdir and drop code into it. I managed to get hello-world function to work using the <a href="https://developers.cloudflare.com/workers/wrangler/get-started/">wrangler</a> tool. The setup was somewhat finicky, but not too bad.</p>
<p>Then I immediately hit a deadend in that the docs are terrible at explaining the provided API. The docs read more like incomplete corporate documentation wiki that your coworker is gonna guide you through than a public product (but I wasn‚Äôt given a coworker or paid for this!). In provided samples there were no import statements to follow to delve into the library source code. Apparently Functions are some bastard relative of Workers. There was also some concept of corporate-sounding middleware. I was a really confused about how to get started beyond the simple hello world.</p>
<p>As a shortcut, I used GPT-3 to generate a basic typescript function for me. This let me look at TS type definitions and get a better idea of what‚Äôs available so I could get developing.</p>
<h3 id="cloudflare-functions-omg-these-are-actually-good-">Cloudflare Functions: OMG, these are actually good! üòç</h3>
<p>Turns out middleware is a function that lets you proxy/rewrite static assets being served (including overwriting request/response headers). This made it easy to write a function that inserts custom markup in my static react site(pointing at preview images that users store in db). This combined nicely with fact that Pages serves same SPA for every http path instead of a 404. I‚Äôll probably rewrite this as a function that serve a simple twitter-bot-oriented-HTML, but was cool to finally try a proxy API that‚Äôs pleasure to use.</p>
<p>I also wrote a simple function to serve preview images from <a href="https://supabase.com/docs/guides/api">supabase PostgREST API</a>. I‚Äôll eventually redo this to use Cloudflare R2.</p>
<p>I defined the url + rewriting mapping for both functions using their clever filesystem-naming scheme.</p>
<p>After testing everything with wangler, serverside deployed and worked on first try! I‚Äôm so impressed!</p>
<h3 id="sample-code-">Sample Code ü•ä</h3>
<p>I would like to be able to use it for my next set of projects, here are some sample code snippets to help me and others:</p>
<p><code>functions/screenshot/[[path]].ts</code> resolves to <code>mydomain/screenshot/.*</code></p>
<div><pre><code data-lang="typescript"><span>export</span> <span>const</span> <span>onRequest</span>: <span>PagesFunction</span> <span>=</span> <span>function</span> <span>onRequest</span>(<span>ctx</span>) {
  <span>let</span> <span>response</span> <span>=</span> <span>`Hello, world! </span><span>${</span><span>ctx</span>.<span>request</span>.<span>url</span><span>}</span><span> </span><span>${</span><span>ctx</span>.<span>request</span>.<span>method</span><span>}</span><span> </span><span>${</span><span>JSON</span>.<span>stringify</span>(<span>ctx</span>.<span>request</span>.<span>headers</span>)<span>}</span><span>`</span>
  <span>return</span> <span>new</span> <span>Response</span>(<span>response</span>);
}
</code></pre></div><p><code>functions/shared/_middleware.ts</code> rewrites content shared at <code>mydomain/shared/.*</code></p>
<div><pre><code data-lang="typescript"><span>let</span> <span>handler</span>:<span>PagesPluginFunction</span> <span>=</span> <span>async</span> (<span>ctx</span>) <span>=&gt;</span> {
  <span>try</span> {
    <span>const</span> <span>response</span> <span>=</span> <span>await</span> <span>ctx</span>.<span>next</span>(<span>ctx</span>.<span>request</span>, {<span>headers</span>: <span>ctx.request.headers</span>});
    <span>let</span> <span>responseText</span> <span>=</span> <span>await</span> <span>response</span>.<span>text</span>();
    <span>responseText</span> <span>=</span> <span>&#34;Hello, world! &#34;</span><span>+</span><span>responseText</span>.<span>length</span>;
    <span>// Cloudflare gets upset when specify 304 and include a body, even if it&#39;s &#34;&#34;
</span><span></span>    <span>return</span> <span>new</span> <span>Response</span>(<span>response</span>.<span>status</span> <span>==</span> <span>200</span> <span>?</span> <span>responseText</span> : <span>undefined</span>, <span>response</span>);
  } <span>catch</span> (<span>thrown</span>) {
    <span>return</span> <span>new</span> <span>Response</span>(<span>`Error serving </span><span>${</span><span>ctx</span>.<span>request</span>.<span>url</span><span>}</span><span>: </span><span>${</span><span>thrown</span><span>}</span><span>`</span>, {
      <span>status</span>: <span>500</span>,
      <span>statusText</span><span>:</span> <span>&#34;Internal Server Error&#34;</span>,
    });
  }
}

<span>export</span> <span>const</span> <span>onRequest</span> <span>=</span> [
  <span>handler</span>,
  <span>// can chain more handlers here
</span><span></span>];
</code></pre></div><h3 id="conclusion-">Conclusion ü§ó</h3>
<p>In addition to awesome static hosting on Cloudflare Pages, one can add dynamic functionality dropping a few TypeScript files into a <code>functions</code>, then git <code>commit</code>+<code>push</code>. This is magnitudes simpler than any prior server stack I‚Äôve tried. The free tier is generous, after the free tier the price seems lower than AWS.</p>
<p>I absolutely love the experience of zero-effort git-ops style static websites with serverless functions. Cloudflare Pages + Functions are now my favourite solution for deploying hobby projects, by far. I‚Äôm looking forward to writing more backend functionality in this style.</p>
<p>Last time serverside was this fun to write was when Apache served static pages and you could write cgi-bin scripts in any language of your choice, but we didn‚Äôt have git or npm back then. I‚Äôm glad we have this now.</p>
<p><em>But, dear Cloudflare get your documentation together. Maybe you can just copy <a href="https://developer.mozilla.org/en-US/">MDN</a>? I got some stuff to work, but I still have questions as to how you intend me to package libraries into my functions, etc. Would love examples of every single API call you offer. Maybe you could let us in the kinds of hardcore cleverness your middleware enables?</em>.</p>
<p><a href="https://news.ycombinator.com/item?id=33307950">HN Comments</a></p>


        
          
        

        

        
      </article>

      
        
      


      

    </div>
  </div>
</div></div>
  </body>
</html>
