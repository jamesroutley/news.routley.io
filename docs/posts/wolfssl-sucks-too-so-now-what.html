<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.feld.me/posts/2026/02/wolfssl-sucks-too/">Original</a>
    <h1>WolfSSL sucks too, so now what?</h1>
    
    <div id="readability-page-1" class="page"><div>
		<p>OpenSSL sucks. The BoringSSL and AWS-LC forks are Googled and Amazoned to death; they don&#39;t care about anyone but their own use cases. I can&#39;t remember ever having a good experience with software using GnuTLS. LibreSSL is incomplete...</p>
<div id="what-happened-now">
<a href="#what-happened-now" title="Permalink to this section"><h2>What happened now?</h2>
</a><p>Last year an <a href="https://www.haproxy.com/blog/state-of-ssl-stacks">article</a> from Haproxy about how terribly slow OpenSSL has become was published. This made the rounds a few times, and I had an itch to scratch so I helped enable FreeBSD to package a variant of Haproxy built against WolfSSL. This seemed like an easy way to get people wider exposure to WolfSSL as it&#39;s unlikely we&#39;ll see this happen on most Linux distros, so in reality the only people who are experiencing a WolfSSL-backed Haproxy are people who know what they&#39;re getting into and custom built it themselves. I haven&#39;t actually checked if Arch, Gentoo, Nix, etc have done similar, but they&#39;d be the easiest to produce a similar <strong>haproxy-wolfssl</strong> package.</p>
<p>So I did it, and I ran WolfSSL in a few places, and then I hit a bug. I reported the bug, forgot about it, and moved on. And then I hit it again and was motivated to actually figure it out. So I reopened the <a href="https://github.com/wolfSSL/wolfssl/issues/9156">bug</a> and fumbled my way through debugging the issue until the root cause was identified.</p>
<p>TLS 1.3 is defined in <a href="https://www.rfc-editor.org/rfc/rfc8446">RFC 8446</a>. It works quite a bit different from TLS 1.2 which caused them no end of issues, such that they documented &#34;The design of TLS 1.3 was constrained by widely deployed non-compliant TLS middleboxes&#34;.</p>
<p>Ahh yes, the infamous middleboxes. Great. Those invisible pieces of garbage that can tamper with your traffic and you&#39;ll generally never know they exist until they cause you grief. And they will.</p>
</div>
<div id="middlebox-hell">
<a href="#middlebox-hell" title="Permalink to this section"><h2>Middlebox Hell</h2>
</a><p>Hell is definitely a place where middleboxes were invented and no amount of wishcasting will remove them from existence. Although maybe some Etsy witches could provide some guidance as they have incredible luck solving problems...</p>
<p>Anyway, so we have all these middleboxes and they suck and we want the network to have better security guarantees than TLS 1.2 but the boxes only understand TLS 1.2 and TLS 1.3 can&#39;t exist if the boxes break them so TLS 1.3 has to be able to pretend to be TLS 1.2. That&#39;s where we&#39;re at with this.</p>
<p>So the authors hemmed and hawwed about this and came up with a solution: <a href="https://www.rfc-editor.org/rfc/rfc8446#appendix-D.4">Middlebox Compatibility Mode</a>.</p>
<p>Essentially, clients can optionally set a non-empty session ID in the ClientHello to fool the middleboxes, and the client and server exchange dummy change_cipher_spec records. This is useless and just adds latency to establishing the TLS session, but it will work. Fair.</p>
</div>
<div id="the-upside-down">
<a href="#the-upside-down" title="Permalink to this section"><h2>The Upside Down</h2>
</a><p>The RFC is pretty clear about how this is all meant to play out.</p>
<blockquote>
This &#34;compatibility mode&#34; is partially negotiated: the client
can opt to provide a session ID or not, and the server has to echo it.</blockquote>
<p>and</p>
<blockquote>
if the client sends a non-empty session ID,
the server MUST send the change_cipher_spec as described in this
appendix.</blockquote>
<p>But WolfSSL says &#34;thanks but no thanks&#34;. The entire middlebox compatibility functionality is gated behind compiling the library with <strong>-DWOLFSSL_TLS13_MIDDLEBOX_COMPAT</strong>, which forces it to always be in this mode or not.</p>
<p>So the current state is that WolfSSL cannot be trusted to work correctly with TLS 1.3 clients. It all depends on how forgiving they are, but you shouldn&#39;t be forgiving when implementing the RFC correctly... The GitHub issue comment left at the end leads me to believe that they aren&#39;t really interested in RFC compliance. There isn&#39;t a middleground here or a &#34;different way&#34; of implementing middlebox compatibility. It&#39;s either RFC compliant or not. And they&#39;re not. Asking me to open a new issue to discuss this behavior instead of it being a high priority for them to open up a new issue internally to fix this is odd. I&#39;m not here to do their homework for them.</p>
<p>This sucks extra hard because WolfSSL is also used in a lot of embedded devices. The right thing to do from a security PoV should be to always enable Middlebox Compatibility Mode on your TLS 1.3 clients to increase the chances that your TLS 1.3 handshake will be successfully established. But now we can&#39;t do that. Should we wait a few years for WolfSSL to have releases out there with this fixed? Well, since it&#39;s often used in embedded devices too you might want to wait a decade before you can use this feature blindly if you don&#39;t control both the client and server deployments. Big yikes.</p>
</div>
<div id="the-plaintiff">
<a href="#the-plaintiff" title="Permalink to this section"><h2>The Plaintiff</h2>
</a><p>Currently I&#39;ve only identified one victim of this decision, but there&#39;s bound to be more out there. Erlang/OTP has its own ssl library implementation and you can rightfully assume that they&#39;ve taken Joe&#39;s advice to heart when adding TLS 1.3 support:</p>
<blockquote>
Make it work, then make it beautiful, then if you really, really have to, make it fast. - Joe Armstrong</blockquote>
<p>So to cover their butts, they opted to enable <a href="https://github.com/erlang/otp/blob/7f599b97ce2dbdc672866bd709b12b9789c86cc8/lib/ssl/src/ssl_session.erl#L248">middlebox_comp_mode</a> by default. (If you want it fast and you know it&#39;s safe to do so -- turn it off)</p>
<p>And now every Elixir/Erlang/etc HTTP client fails to be able to connect to a WolfSSL HTTPS server if TLS 1.3 is available.</p>
</div>
<div id="where-do-we-go-from-here">
<a href="#where-do-we-go-from-here" title="Permalink to this section"><h2>Where Do We Go From Here?</h2>
</a><p>OpenBSD was probably right. We just need to get people to focus on LibreSSL and forget about these other libraries. As Haproxy noted, it&#39;s not a victim of the OpenSSL 3.0 screwups because they forked earlier, but it&#39;s missing some optimizations. I think that&#39;s probably a fair trade-off and the gaps will be filled in due time.</p>
<p>So don&#39;t be like me. This was hubris I guess. Sure, I thought I could be clever and have faster TLS termination for my websites, but all it did was lead me to wasting a lot of time learning about something I really didn&#39;t care to know, and then writing this stupid blog post. You&#39;ve been warned.</p>
<div id="elixir-poc">
<a href="#elixir-poc" title="Permalink to this section"><h3>Elixir PoC</h3>
</a><p>A PoC for Elixir 1.17.3 (compiled with Erlang/OTP 26) is as simple as below:</p>
<div><pre><span></span><span>#!/usr/bin/env elixir</span>

<span>url</span><span> </span><span>=</span><span> </span><span>&#34;https://some-wolfssl-endpoint&#34;</span>

<span>url</span><span> </span><span>=</span><span> </span><span>String</span><span>.</span><span>to_charlist</span><span>(</span><span>url</span><span>)</span>

<span>{</span><span>:ok</span><span>,</span><span> </span><span>_</span><span>}</span><span> </span><span>=</span><span> </span><span>Application</span><span>.</span><span>ensure_all_started</span><span>(</span><span>:inets</span><span>)</span>
<span>{</span><span>:ok</span><span>,</span><span> </span><span>_</span><span>}</span><span> </span><span>=</span><span> </span><span>Application</span><span>.</span><span>ensure_all_started</span><span>(</span><span>:ssl</span><span>)</span>

<span>:logger</span><span>.</span><span>set_application_level</span><span>(</span><span>:ssl</span><span>,</span><span> </span><span>:debug</span><span>)</span>

<span>http_options</span><span> </span><span>=</span>
<span>  </span><span>[</span>
<span>    </span><span>ssl</span><span>:</span><span> </span><span>[</span>
<span>      </span><span>verify</span><span>:</span><span> </span><span>:verify_peer</span><span>,</span>
<span>      </span><span>cacerts</span><span>:</span><span> </span><span>:public_key</span><span>.</span><span>cacerts_get</span><span>(),</span>
<span>      </span><span>depth</span><span>:</span><span> </span><span>2</span><span>,</span>
<span>      </span><span>customize_hostname_check</span><span>:</span><span> </span><span>[</span>
<span>        </span><span>match_fun</span><span>:</span><span> </span><span>:public_key</span><span>.</span><span>pkix_verify_hostname_match_fun</span><span>(</span><span>:https</span><span>)</span>
<span>      </span><span>],</span>
<span>      </span><span>versions</span><span>:</span><span> </span><span>[</span><span>:&#34;tlsv1.2&#34;</span><span>,</span><span> </span><span>:&#34;tlsv1.3&#34;</span><span>],</span>
<span>      </span><span>middlebox_comp_mode</span><span>:</span><span> </span><span>true</span>
<span>    </span><span>]</span>
<span>  </span><span>]</span>

<span>options</span><span> </span><span>=</span><span> </span><span>[</span><span>body_format</span><span>:</span><span> </span><span>:binary</span><span>]</span>

<span>:httpc</span><span>.</span><span>request</span><span>(</span><span>:get</span><span>,</span><span> </span><span>{</span><span>url</span><span>,</span><span> </span><span>[]},</span><span> </span><span>http_options</span><span>,</span><span> </span><span>options</span><span>)</span>
</pre></div>
<p>The error is going to look like this:</p>
<div><pre><span></span><span>11</span><span>:</span><span>00</span><span>:</span><span>44.996</span><span> </span><span>[</span><span>warning</span><span>]</span><span> </span><span>Description</span><span>:</span><span> </span><span>~c&#34;Failed to assert middlebox server message&#34;</span>
<span>     </span><span>Reason</span><span>:</span><span> </span><span>[</span><span>missing</span><span>:</span><span> </span><span>{</span><span>:change_cipher_spec</span><span>,</span><span> </span><span>1</span><span>}]</span>

<span>11</span><span>:</span><span>00</span><span>:</span><span>45.014</span><span> </span><span>[</span><span>notice</span><span>]</span><span> </span><span>TLS</span><span> </span><span>:client</span><span>:</span><span> </span><span>In</span><span> </span><span>state</span><span> </span><span>:hello_middlebox_assert</span><span> </span><span>at</span><span> </span><span>ssl_gen_statem</span><span>.</span><span>erl</span><span>:</span><span>821</span><span> </span><span>generated</span><span> </span><span>CLIENT</span><span> </span><span>ALERT</span><span>:</span><span> </span><span>Fatal</span><span> </span><span>-</span><span> </span><span>Unexpected</span><span> </span><span>Message</span>
<span> </span><span>-</span><span> </span><span>{</span><span>:unexpected_msg</span><span>,</span>
<span> </span><span>{</span><span>:internal</span><span>,</span>
<span>  </span><span>{</span><span>:encrypted_extensions</span><span>,</span>
<span>   </span><span>%{</span>
<span>     </span><span>elliptic_curves</span><span>:</span><span> </span><span>{</span><span>:supported_groups</span><span>,</span>
<span>      </span><span>[</span><span>:secp521r1</span><span>,</span><span> </span><span>:secp384r1</span><span>,</span><span> </span><span>:secp256r1</span><span>,</span><span> </span><span>:x25519</span><span>,</span><span> </span><span>:ffdhe2048</span><span>]}</span>
<span>   </span><span>}}}}</span>
</pre></div>
<p>That&#39;s when you&#39;ll know you&#39;ve been thrown to the wolves. ðŸ¤¬ If you change those <strong>http_options</strong> to set <strong>middlebox_comp_mode</strong> to <strong>false</strong> it will work as expected.</p>
</div>
</div>

	</div></div>
  </body>
</html>
