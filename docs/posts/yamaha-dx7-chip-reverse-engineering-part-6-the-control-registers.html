<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.righto.com/2022/02/yamaha-dx7-chip-reverse-engineering_7.html">Original</a>
    <h1>Yamaha DX7 chip reverse-engineering, part 6: the control registers</h1>
    
    <div id="readability-page-1" class="page"><div id="post-body-7599448188873380170" itemprop="description articleBody">


<p>The Yamaha DX7 digital synthesizer (1983) was the classic synthesizer in 1980s pop music.
It uses a technique called FM synthesis to
produce complex, harmonically-rich sounds.
In this blog post, I look inside its custom &#34;OPS&#34; sound chip and explain the control registers for this chip.
By reverse-engineering the circuitry, I found a few undocumented test functions.
(This post covers some fairly obscure details of the DX7; you might prefer my previous DX7 posts<span id="fnref:previous"><a href="#fn:previous">1</a></span>
starting with &#34;<a href="https://www.righto.com/2021/11/reverse-engineering-yamaha-dx7.html">DX7 reverse-engineering</a>&#34;.)</p>
<p><a href="https://static.righto.com/images/dx7-data/die-labeled.jpg"><img alt="Die photo of the YM21280 chip with the main functional blocks labeled. Click this photo (or any other) for a larger version." height="523" src="https://static.righto.com/images/dx7-data/die-labeled-w600.jpg" title="Die photo of the YM21280 chip with the main functional blocks labeled. Click this photo (or any other) for a larger version." width="600"/></a></p><p>Die photo of the YM21280 chip with the main functional blocks labeled. Click this photo (or any other) for a larger version.</p>
<p>The die photo above shows the DX7&#39;s OPS sound synthesis chip under the microscope, showing its complex silicon circuitry.
Unlike modern chips, this chip has just one layer of metal, visible as the whitish lines on top.
Around the edges, you can see the 64 bond wires attached to pads; these connect the silicon die to the chip&#39;s 64 pins.
In this blog post, I&#39;m focusing on the control registers, highlighted in red.
I&#39;ll outline the other functional blocks briefly.
Each of the 96 oscillators has a phase accumulator used to generate the frequency.
The sine and exponential functions are implemented with lookup tables in ROMs.
Other functional blocks apply the envelope, hold configuration data, and buffer the output values.</p>
<p><a href="https://static.righto.com/images/dx7-data/dx7.jpg"><img alt="The DX7 synthesizer. Photo by rockheim (CC BY-NC-SA 2.0)." height="108" src="https://static.righto.com/images/dx7-data/dx7-w600.jpg" title="The DX7 synthesizer. Photo by rockheim (CC BY-NC-SA 2.0)." width="600"/></a></p>
<p>The DX7 generates sounds digitally using a technique called FM synthesis.
Each note has six oscillators (called &#34;operators&#34;) that can be combined in different ways (called &#34;algorithms&#34;).
An algorithm is represented by a diagram (below), where an oscillator modulates the oscillator below, as shown by the lines.
For instance, in algorithm 1 below, oscillator 6 modulates oscillator 5 which modulates 4 which modulates 3.
Oscillator 2 modulates oscillator 1. The output is taken from the bottom oscillators (1 and 3).
Meanwhile, oscillator 6 modulates itself, controlled by a user-selectable feedback level.
With 32 different algorithms, the DX7 can generate a wide variety of sounds.
In the DX7 synthesizer, all 16 notes must use the same algorithm.
But from my reverse-engineering, it appears that the chip supports different algorithms for each note, even though
the synthesizer doesn&#39;t make use of this.</p>
<p><a href="https://static.righto.com/images/dx7-data/algorithms.png"><img alt="Four of the 32 &#34;algorithms&#34; that can be selected on the DX7." height="157" src="https://static.righto.com/images/dx7-data/algorithms-w400.png" title="Four of the 32 &#34;algorithms&#34; that can be selected on the DX7." width="400"/></a></p><p>Four of the 32 &#34;algorithms&#34; that can be selected on the DX7.</p>
<p>To the programmer of the DX7 firmware, the sound chip appears to have two write-only registers that control the chip.
The diagram below shows the layout of the chip&#39;s s two registers, as described by Anthony Richardson.
The desired algorithm and feedback are written to address 1.<span id="fnref:rom"><a href="#fn:rom">2</a></span>
Address 0 has bits to turn the &#34;key sync&#34; feature<span id="fnref:sync"><a href="#fn:sync">3</a></span> on and off.
As for the Mute and Test Register Select bits, my investigation provides some explanation.</p>
<pre>Address | Bit 7 | Bit 6          | Bit 5        | Bit 4 | Bit 3 | Bit 2 | Bit 1 | Bit 0 |
0       | Mute  | Clear Key Sync | Set Key Sync | Test Register Select                  |
1       | Algorithm Select (0..31)                              | Feedback Level (0..7) |
</pre>

<p>(The functionality above is pretty limited, so you might wonder how the synthesizer controls which notes are played.
Most of the synthesizer functions are controlled through 
a second custom chip, the envelope generator chip (EGS).
Note and envelope data is written to registers in the EGS chip, which 
then sends frequency and amplitude data to the sound chip over a special bus.)</p>
<p>The diagram below shows the main components of the register circuitry.
The large block at the bottom is the A-register, which holds the algorithm/feedback entries, as 16 8-bit values.<span id="fnref:aregister"><a href="#fn:aregister">4</a></span>
The most puzzling feature of the A-register is its size; it holds 16 entries, one for each note, 
but the DX7 uses the same algorithm/feedback setting for all 16 notes.
The second puzzling feature is that although the chip appears to have two 8-bit registers, the implementation is
one 9-bit register, and one 5-bit register. Moreover, the 5-bit register can only be modified by writing through the 9-bit register.</p>
<p><a href="https://static.righto.com/images/dx7-data/blocks-labeled.jpg"><img alt="Main functional blocks of the register circuitry." height="543" src="https://static.righto.com/images/dx7-data/blocks-labeled-w400.jpg" title="Main functional blocks of the register circuitry." width="400"/></a></p><p>Main functional blocks of the register circuitry.</p>
<p>The chip has one address pin (called &#34;DS&#34;) which selects between the two registers.
When a byte is written to the chip, to either address, the 8 bits along with DS (the address bit) are stored in the 9-bit latches.
If DS is 0 (i.e. write to the control address 0), the bits are decoded to perform any special functions, and the lower 5 bits are loaded into the
5-bit register on the right.
If DS is 1 (i.e. write to the algorithm/feedback address 1), the 8-bit algorithm/feedback value is stored into the A register, in a location controlled by the 5-bit register.</p>
<h2>Updating the algorithm/feedback</h2>
<p>The algorithm/feedback A-register register holds data for 16 notes.
It can be updated in two ways. The first way, used by the DX7, updates all entries with the same value.
The second way updates a single entry, allowing different notes to have different algorithms.
Both cases involve a write to address 0, followed by writing the algorithm/feedback byte to address 1.</p>
<p>To update all entries, address 0 must be written with a value with the bit pattern <code>0??1?0??</code> (where ? indicates a &#34;don&#39;t care&#34; bit that can be 0 or 1).<span id="fnref:pattern"><a href="#fn:pattern">5</a></span>
This pattern triggers a circuit that constantly loads the value in the data latch into the storage register.</p>
<p>The DX7&#39;s CPU controls the OPS chip in this way. Specifically,
an update of the algorithm and feedback is performed by writing either 0x30 (if sync is on) or 0x50 (if sync is off) to address 0, and then writing the algorithm/feedback byte to address 1.<span id="fnref2:rom"><a href="#fn:rom">2</a></span></p>
<p>The second update path will change the algorithm and feedback for a single note.
(The DX7 does not use this feature.)
is triggered by writing the bit pattern <code>0??0nnnn</code>, where <em>nnnn</em> specifies one of the 16 notes.</p>
<p>The implementation of this is a bit tricky because the chip uses shift registers for storage, not RAM.
The A-register consists of 8 shift registers (one for each bit), each with 16 stages (one for each note).
An entry can only be updated when it is shifted out the end of the shift register, and a new value can be inserted.
(This is unlike RAM, where an arbitrary entry can be written.)
To update an entry in the shift register, a 4-bit comparator circuit (below) compares the number of the current note with the number of the desired note in the control register.
When there is a match, the new value is written to the shift register.</p>
<p><a href="https://static.righto.com/images/dx7-data/comparator.jpg"><img alt="The 4-bit comparator determines when the shift register is at the desired note position. It is built from four exclusive-NOR gates." height="302" src="https://static.righto.com/images/dx7-data/comparator-w200.jpg" title="The 4-bit comparator determines when the shift register is at the desired note position. It is built from four exclusive-NOR gates." width="200"/></a></p><p>The 4-bit comparator determines when the shift register is at the desired note position. It is built from four exclusive-NOR gates.</p>
<h2>Special command sequences</h2>
<p>The logic circuitry recognizes several bit patterns when they are written to address 0,
and causes special actions when they are detected.
These are not used by the DX7; I think they were used for testing the chip during manufacturing to make tests more predictable
and faster.</p>
<p><code>1???????</code>: Setting the top bit triggers several special actions. Earlier analysis has labeled this bit as &#34;Mute&#34;, but I suspect
it is more of a &#34;Test Reset&#34; function, 
resetting the chip to a known state so tests will be predictable.
This bit clears the phase accumulators.
This bit disables the scale factors, so the output data is unshifted.
It also bypasses the output latch, which may output digital note data at a higher rate.</p>
<p><code>1??????1</code>: In addition to the previous action, this pattern resets the counters that count through the operators and notes,
controlling the actions of the chip.
This is probably used start testing the chip from a known state, so the outputs can be compared with expected values.</p>
<p><code>1?????1?</code>: This causes the low-order bits of the phase register to generate the waveform, rather than the high-order bits.
I think this is used for testing so the low-order bits can be examined more directly to find flaws.
It also will increase the frequencies by a factor of 1024, which may help run through waveforms faster for testing.</p>
<h2>Conclusion</h2>
<p>By looking inside the chip and reverse-engineering the silicon circuits, I learned some details about the internal registers.
One interesting discovery is that the chip appears to support separate algorithms for each voice, even though the synthesizer
doesn&#39;t use this feature. I also uncovered some test functionality.</p>
<p><a href="https://static.righto.com/images/dx7-data/package-opened.jpg"><img alt="The Yamaha YM21280 OPS integrated circuit package with the metal lid removed, revealing the silicon die." height="227" src="https://static.righto.com/images/dx7-data/package-opened-w350.jpg" title="The Yamaha YM21280 OPS integrated circuit package with the metal lid removed, revealing the silicon die." width="350"/></a></p><p>The Yamaha YM21280 OPS integrated circuit package with the metal lid removed, revealing the silicon die.</p>
<p>I plan to continue investigating the DX7&#39;s circuitry,
so follow me on Twitter <a href="https://twitter.com/kenshirriff">@kenshirriff</a> for updates. I also have an <a href="https://www.righto.com/feeds/posts/default">RSS feed</a>.
Thanks to Jacques Mattheij and Anthony Richardson for providing the chip and discussion.<span id="fnref:refs"><a href="#fn:refs">6</a></span></p>
<p>Disclaimer: I figured out the behavior described in this post studying the die. It hasn&#39;t been tested on
an actual DX7 so I don&#39;t guarantee that it is correct.</p>
<h2>Notes and references</h2>


</div></div>
  </body>
</html>
