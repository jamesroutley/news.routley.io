<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://leahneukirchen.org/blog/archive/2020/05/the-case-of-the-mysterious-help-directory.html">Original</a>
    <h1>The case of the mysterious --help directory (2020)</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>For quite some time—as my research will show, March 2016—, I have
been annoyed by a directory named <code>--help</code> showing up in my home
directory (and sometimes in others).</p>

<p>It’s just an empty, innocent directory with a weird name.
Removed by a simple run of <code>rmdir ./--help</code>.
Yet, it would turn up again.
Sometimes soon, sometimes it took a few weeks.</p>

<p>I had no idea where it came from.</p>

<p>Obviously, a simple <code>mkdir --help</code> just print’s the <code>mkdir</code> help:</p>

<pre><code>Usage: mkdir [OPTION]... DIRECTORY...
Create the DIRECTORY(ies), if they do not already exist.
...
</code></pre>

<p>I thought, maybe some program was called once with <code>--help</code> but
didn’t understand it, yet stored it somewhere and would create it when
run again.  I suspected many things, especially applications I don’t use that
often, like Gimp or Transmission.  I grepped all dotfiles in <code>$HOME</code>
for <code>--help</code>.  To no avail.</p>

<p>I decided I had to track this down.</p>

<p>My first thought was to use
<a href="https://piware.de/2012/02/fatrace-report-system-wide-file-access-events/"><code>fatrace</code></a>,
which logs all file accesses.  But <code>fatrace</code> doesn’t register
directory creation (the <code>fanotify</code> API does, I think).</p>

<p>I didn’t know what to do, and left the problem alone for some time.
The <code>--help</code> directory kept reappearing.</p>

<p>Some time later,
I read a book on eBPF, and decided I can log all mkdir(2) calls with
it, globally.
(I also think I tried this with SystemTap before, but I’m not sure anymore.)</p>

<p>I wrote a <code>bpftrace</code> script called <code>mkdirsnoop</code>, a variant of <code>opensnoop</code>.
It would print all mkdir(2) calls and what program ran it, system wide.</p>

<p>I ran it a lot, but not consistently.</p>

<p>Yesterday, it finally triggered!
I <a href="https://twitter.com/LeahNeukirchen/status/1256304578267619329">tweeted</a>:</p>

<blockquote><q>
I’m really flipping the table.</q></blockquote>

<p>If it was mkdir(1), it must have been created by a script.
Gimp and Transmission were acquitted of charge.</p>

<p>Julien Kirch proposed to put a different <code>mkdir</code> into my <code>$PATH</code>,
which I think was a smart idea.  I wrote this:</p>

<pre><code>#!/bin/sh
printf &#39;%s\n&#39; &#34;mkdir called from $$ at $(date)&#34; &gt;&gt; /tmp/mkdirlog
pstree -sap $$ &gt;&gt; /tmp/mkdirlog
exec /usr/bin/mkdir &#34;$@&#34;
</code></pre>

<p>Very quickly, the script triggered, and I saw:</p>

<pre><code>runit,1
  `-sh,30996 -c urxvt
      `-urxvt,30997
          `-zsh,30998
              `-zsh,31055
                  `-mkdir,31058 /home/leah/bin/mkdir --help
                      `-pstree,31060 -sap 31058
</code></pre>

<p>So it was actually <code>zsh</code> calling <code>mkdir --help</code>.
(Or a <code>zsh</code> script.)
But there was no directory <code>--help</code>.
Because calling <code>mkdir --help</code> does not create a directory,
instead printing the help.</p>

<p>Jannis Harder told me that the zsh completion for <code>mkdir</code> would run
<code>mkdir --help</code> (to see if it’s the GNU variant), which I could verify.</p>

<p>But it didn’t explain the <code>--help</code> directory.</p>

<p>However, I had something to track down now.</p>

<p>Using my <a href="https://github.com/leahneukirchen/extrace">extrace</a>, I would
log all runs of <code>mkdir</code> with a <code>--help</code> argument, and at some point
I found:</p>

<pre><code>mkdir -p -- --help
</code></pre>

<p>Mysterious.  I grepped my dotfiles again and found the unsuspicious
function <code>mkcd</code>:</p>

<pre><code># mkcd -- mkdir and cd at once
mkcd() { mkdir -p -- &#34;$1&#34; &amp;&amp; cd -- &#34;$1&#34; }
</code></pre>

<p>This is a helper function I use a lot.  But I don’t call it with
<code>--help</code> of course, and then wonder for 4 years why I do that.</p>

<p>Well <em>I</em> don’t.  But <code>zsh</code> does, because I also had:</p>

<pre><code>compdef mkcd=mkdir
</code></pre>

<p>This was a quick shortcut to complete <code>mkdir</code>’s arguments (only
directories) also for <code>mkcd</code>.  I added it in 2013.  Even before I added
the <code>-p</code> flag in 2016.</p>

<p>Quickly, I verified that <code>mkcd &lt;TAB&gt;</code> would create a <code>--help</code>
directory.  But only if the completion wasn’t loaded already,
e.g. when I didn’t run <code>mkdir &lt;TAB&gt;</code> before.  This explains why
the directory only appeared sporadically.</p>

<p>I quickly rewrote the completion:</p>

<pre><code>_mkcd() { _path_files -/ }
compdef _mkcd mkcd
</code></pre>

<p>And another mystery of my setup has been solved.  Case closed.</p>

<p><small>NP: Pearl Jam—Take The Long Way</small></p>
</div></div>
  </body>
</html>
