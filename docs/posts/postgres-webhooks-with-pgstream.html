<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://xata.io/blog/postgres-webhooks-with-pgstream">Original</a>
    <h1>Postgres Webhooks with Pgstream</h1>
    
    <div id="readability-page-1" class="page"><div><p><a href="https://xata.io/pgstream">pgstream</a> is a CDC (Change-Data-Capture) tool focused on PostgreSQL. Among other <a href="https://github.com/xataio/pgstream?tab=readme-ov-file#features">things</a>, it can be used to call webhooks whenever there is a data (or schema) change in a Postgres database. This means that whenever a row is inserted, updated, or deleted, or a table is created, altered, truncated or deleted, a webhook is notified of the relevant event details.</p>
<p>In this article we&#39;re going to dive into the pgstream webhooks functionality, including more advanced topics, like sending the old and new values, TOAST support, and schema changes support.</p>
<div><p><a href="https://xata.io/mdx/docs/mdx-blog/pgstream-webhooks.png"><img alt="Postgres webhooks with pgstream" loading="lazy" decoding="async" data-nimg="fill" sizes="100vw" srcset="/_next/image?url=%2Fmdx%2Fdocs%2Fmdx-blog%2Fpgstream-webhooks.png&amp;w=640&amp;q=75 640w, /_next/image?url=%2Fmdx%2Fdocs%2Fmdx-blog%2Fpgstream-webhooks.png&amp;w=750&amp;q=75 750w, /_next/image?url=%2Fmdx%2Fdocs%2Fmdx-blog%2Fpgstream-webhooks.png&amp;w=828&amp;q=75 828w, /_next/image?url=%2Fmdx%2Fdocs%2Fmdx-blog%2Fpgstream-webhooks.png&amp;w=1080&amp;q=75 1080w, /_next/image?url=%2Fmdx%2Fdocs%2Fmdx-blog%2Fpgstream-webhooks.png&amp;w=1200&amp;q=75 1200w, /_next/image?url=%2Fmdx%2Fdocs%2Fmdx-blog%2Fpgstream-webhooks.png&amp;w=1920&amp;q=75 1920w, /_next/image?url=%2Fmdx%2Fdocs%2Fmdx-blog%2Fpgstream-webhooks.png&amp;w=2048&amp;q=75 2048w, /_next/image?url=%2Fmdx%2Fdocs%2Fmdx-blog%2Fpgstream-webhooks.png&amp;w=3840&amp;q=75 3840w" src="https://xata.io/_next/image?url=%2Fmdx%2Fdocs%2Fmdx-blog%2Fpgstream-webhooks.png&amp;w=3840&amp;q=75"/></a></p><p><figcaption>Postgres webhooks with pgstream</figcaption></p></div>

<p>For this tutorial we need a Postgres instance that has logical replication enabled and the <a href="https://github.com/eulerto/wal2json">wal2json</a> output plugin loaded. There are a number of ways to do this, but we&#39;re going to use the <a href="https://github.com/xataio/pgstream/blob/main/build/docker/docker-compose.yml">docker-compose file</a> from the pgstream repo:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>git</span><span> clone</span><span> https://github.com/xataio/pgstream.git</span></span>
<span></span></code></pre></div></div>
<p>And then start the Postgres instance:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>docker</span><span> compose</span><span> -f</span><span> build/docker/docker-compose.yml</span><span> up</span><span> db</span></span>
<span></span></code></pre></div></div>
<p>Then, in a new terminal window, you can connect to it and create a simple table to play with:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>psql</span><span> &#34;postgres://postgres:postgres@localhost:5432/postgres&#34;</span></span>
<span></span></code></pre></div></div>
<p>At the psql prompt:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>CREATE</span><span> TABLE</span><span> employees</span><span>(id </span><span>SERIAL</span><span> PRIMARY KEY</span><span>, </span><span>name</span><span> TEXT</span><span>, </span><span>role</span><span> TEXT</span><span>);</span></span>
<span></span></code></pre></div></div>
<p>Let&#39;s now install <code>pgstream</code>. One option is to build it from source, since we already have the repo cloned:</p>

<p>The above assumes you have Go installed. If you don&#39;t, check out the other <a href="https://github.com/xataio/pgstream/tree/main?tab=readme-ov-file#installation">installation options</a>.</p>
<p>Next step is to initialize <code>pgstream</code>, like this:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>./pgstream</span><span> init</span><span> --pgurl</span><span> &#34;postgres://postgres:postgres@localhost/postgres?sslmode=disable&#34;</span></span>
<span></span></code></pre></div></div>
<p>This creates several tables managed by pgstream, which are grouped in a schema called <code>pgstream</code>.</p>

<p>The <code>pgstream</code> repo comes with a <code>pg2webhook.env</code> configuration file for this purpose. Its contents are:</p>
<div><div role="group"><pre tabindex="0"><code><span><span># Listener config</span></span>
<span><span>PGSTREAM_POSTGRES_LISTENER_URL</span><span>=</span><span>&#34;postgres://postgres:postgres@localhost?sslmode=disable&#34;</span></span>
<span></span>
<span><span># Processor config</span></span>
<span><span>PGSTREAM_TRANSLATOR_STORE_POSTGRES_URL</span><span>=</span><span>&#34;postgres://postgres:postgres@localhost?sslmode=disable&#34;</span></span>
<span><span>PGSTREAM_WEBHOOK_SUBSCRIPTION_STORE_URL</span><span>=</span><span>&#34;postgres://postgres:postgres@localhost?sslmode=disable&#34;</span></span>
<span><span>PGSTREAM_WEBHOOK_SUBSCRIPTION_STORE_CACHE_ENABLED</span><span>=</span><span>false</span></span>
<span><span>PGSTREAM_WEBHOOK_SUBSCRIPTION_STORE_CACHE_REFRESH_INTERVAL</span><span>=</span><span>&#34;60s&#34;</span></span>
<span></span></code></pre></div></div>
<p><code>PGSTREAM_POSTGRES_LISTENER_URL</code> indicates which database the pgstream listener should connect to. <code>PGSTREAM_WEBHOOK_SUBSCRIPTION_STORE_URL</code> is used as a metadata db to store the registered subscriptions and their configuration. In this example, they are both set to the same database, but you can use different databases or instances if you prefer. More details can be found in the <a href="https://github.com/xataio/pgstream/tree/main?tab=readme-ov-file#configuration">readme configuration section</a>.</p>
<p>You are now ready to start <code>pgstream</code> like this:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>./pgstream</span><span> run</span><span> -c</span><span> pg2webhook.env</span></span>
<span></span></code></pre></div></div>

<p>We now have pgstream ready to go, but we need something to receive the webhooks. This is normally your application, or a lambda function, or similar. pgstream comes with a sample webhooks listener written in Go. You can start it like this:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>go</span><span> run</span><span> tools/webhook/webhook_server.go</span></span>
<span></span></code></pre></div></div>
<p>This starts a server on port 9910 that simply logs any JSON payload that is received under the <code>/webhook</code> path.</p>
<p>Now we have to create a subscription so that <code>pgstream</code> knows to send the webhook to <code>localhost:9910/webhook</code> where the <code>webhook_server.go</code> program is waiting. We do this by calling an API which the webhook module from <code>pgstream</code> serves:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>curl</span><span> localhost:9900/webhooks/subscribe</span><span> \</span></span>
<span><span>    -H</span><span> &#34;content-type: application/json&#34;</span><span> \</span></span>
<span><span>    -d</span><span> &#39;{&#34;url&#34;:&#34;http://localhost:9910/webhook&#34;, &#34;schema&#34;: &#34;public&#34;, &#34;table&#34;: &#34;employees&#34;}&#39;</span></span>
<span></span></code></pre></div></div>
<p>The above adds a line in the <code>pgstream.webhook_subscriptions</code> table, which is maintained by <code>pgstream</code>. You can verify by running via <code>psql</code>:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>postgres</span><span>=</span><span># </span><span>select</span><span> *</span><span> from</span><span> pgstream.webhook_subscriptions;</span></span>
<span><span>              url</span><span>              | schema_name | table_name | event_types</span></span>
<span><span>-------------------------------+-------------+------------+-------------</span></span>
<span><span> http</span><span>:</span><span>//</span><span>localhost:</span><span>9910</span><span>/</span><span>webhook | public      | employees  |</span></span>
<span><span>(</span><span>1</span><span> row</span><span>)</span></span>
<span></span></code></pre></div></div>
<p>Notes:</p>
<ul role="list"><li>in the API call above, we subscribe to a particular table. If you&#39;d like to subscribe to all tables in a schema, leave the <code>table</code> key unset.</li><li>you can also subscribe to only some particular event types. To do this, set the <code>event_types</code> key to an array containing the operations you want (<code>I</code> for inserts, <code>U</code> for updates, <code>D</code> for deletes, <code>T</code> for truncates).</li></ul>

<p>With <code>pgstream</code> and the <code>webhooks_server.py</code> started in different consoles, let&#39;s run the following SQL via <code>psql</code>:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>INSERT INTO</span><span> employees(</span><span>name</span><span>,</span><span>role</span><span>) </span><span>VALUES</span><span>(</span><span>&#39;Dwight Schrute&#39;</span><span>, </span><span>&#39;Assistant Regional Manager&#39;</span><span>);</span></span>
<span></span></code></pre></div></div>
<p>You should see the following printed by the python program:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>{</span></span>
<span><span>  &#34;Data&#34;</span><span>:</span><span> {</span></span>
<span><span>    &#34;action&#34;</span><span>:</span><span> &#34;I&#34;</span><span>,</span></span>
<span><span>    &#34;timestamp&#34;</span><span>:</span><span> &#34;2024-08-20 13:57:16.806107+00&#34;</span><span>,</span></span>
<span><span>    &#34;lsn&#34;</span><span>:</span><span> &#34;0/15F1D60&#34;</span><span>,</span></span>
<span><span>    &#34;schema&#34;</span><span>:</span><span> &#34;public&#34;</span><span>,</span></span>
<span><span>    &#34;table&#34;</span><span>:</span><span> &#34;employees&#34;</span><span>,</span></span>
<span><span>    &#34;columns&#34;</span><span>:</span><span> [</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-1&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;id&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;integer&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> 1</span></span>
<span><span>      }</span><span>,</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-2&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;name&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;text&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> &#34;Dwight Schrute&#34;</span></span>
<span><span>      }</span><span>,</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-3&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;role&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;text&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> &#34;Assistant Regional Manager&#34;</span></span>
<span><span>      }</span></span>
<span><span>    ]</span><span>,</span></span>
<span><span>    &#34;identity&#34;</span><span>:</span><span> null</span><span>,</span></span>
<span><span>    &#34;metadata&#34;</span><span>:</span><span> {</span></span>
<span><span>      &#34;schema_id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdig&#34;</span><span>,</span></span>
<span><span>      &#34;table_pgstream_id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0&#34;</span><span>,</span></span>
<span><span>      &#34;id_col_pgstream_id&#34;</span><span>:</span><span> [</span><span>&#34;cr2a0enjc0j00h93rdj0-1&#34;</span><span>]</span><span>,</span></span>
<span><span>      &#34;version_col_pgstream_id&#34;</span><span>:</span><span> &#34;&#34;</span></span>
<span><span>    }</span></span>
<span><span>  }</span></span>
<span><span>}</span></span>
<span></span></code></pre></div></div>
<p>Things to note in the above:</p>
<ul role="list"><li>The &#34;action&#34; is <code>I</code> for &#34;insert&#34;.</li><li>The LSN (Log Sequence Number) is included. This is a unique and sorted value generated by Postgres, which you can use to order the events in case they are processed out of order.</li><li>Each column is included with their name, type, new value, and an ID generated by pgstream (e.g. <code>cr2a0enjc0j00h93rdj0-2</code> for the <code>name</code> column). This ID is unique for each column and can be used to follow columns across renames.</li></ul>

<p>Now let&#39;s run an update statement:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>UPDATE</span><span> employees </span><span>SET</span><span> role=</span><span>&#39;Assistant to the Regional Manager&#39;</span><span> WHERE</span><span> name=</span><span>&#39;Dwight Schrute&#39;</span><span>;</span></span>
<span></span></code></pre></div></div>
<p>The following webhook event is received:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>{</span></span>
<span><span>  &#34;Data&#34;</span><span>:</span><span> {</span></span>
<span><span>    &#34;action&#34;</span><span>:</span><span> &#34;U&#34;</span><span>,</span></span>
<span><span>    &#34;timestamp&#34;</span><span>:</span><span> &#34;2024-08-20 14:01:28.86832+00&#34;</span><span>,</span></span>
<span><span>    &#34;lsn&#34;</span><span>:</span><span> &#34;0/15F1FB8&#34;</span><span>,</span></span>
<span><span>    &#34;schema&#34;</span><span>:</span><span> &#34;public&#34;</span><span>,</span></span>
<span><span>    &#34;table&#34;</span><span>:</span><span> &#34;employees&#34;</span><span>,</span></span>
<span><span>    &#34;columns&#34;</span><span>:</span><span> [</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-1&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;id&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;integer&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> 1</span></span>
<span><span>      }</span><span>,</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-2&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;name&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;text&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> &#34;Dwight Schrute&#34;</span></span>
<span><span>      }</span><span>,</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-3&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;role&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;text&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> &#34;Assistant to the Regional Manager&#34;</span></span>
<span><span>      }</span></span>
<span><span>    ]</span><span>,</span></span>
<span><span>    &#34;identity&#34;</span><span>:</span><span> [</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-1&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;id&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;integer&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> 1</span></span>
<span><span>      }</span></span>
<span><span>    ]</span><span>,</span></span>
<span><span>    &#34;metadata&#34;</span><span>:</span><span> {</span></span>
<span><span>      &#34;schema_id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdig&#34;</span><span>,</span></span>
<span><span>      &#34;table_pgstream_id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0&#34;</span><span>,</span></span>
<span><span>      &#34;id_col_pgstream_id&#34;</span><span>:</span><span> [</span><span>&#34;cr2a0enjc0j00h93rdj0-1&#34;</span><span>]</span><span>,</span></span>
<span><span>      &#34;version_col_pgstream_id&#34;</span><span>:</span><span> &#34;&#34;</span></span>
<span><span>    }</span></span>
<span><span>  }</span></span>
<span><span>}</span></span>
<span></span></code></pre></div></div>
<p>The above is very similar to the INSERT event, with a couple of differences:</p>
<ul role="list"><li>The &#34;action&#34; is set to <code>U</code>, for update</li><li>The <code>identity</code> sub-object is now filled. It contains the primary key of the affected row. Notably, this is the value of the primary key <strong>before the update</strong>, in case the update has changed the value of the PK.</li></ul>

<p>How about including the old values in addition to the new values for UPDATEs? Yes, that&#39;s possible, using a little trick.</p>
<p>See how in the above UPDATE event, the &#34;identity&#34; contains the PK value, and we noted that this is the PK value <strong>before the update</strong>? That is because the &#34;replica identity&#34; for the table is set to &#34;primary key&#34;, which is the default. However, the replica identity can be set to any unique group of columns, or to &#34;all columns&#34; by setting it to FULL:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>ALTER</span><span> TABLE</span><span> employees </span><span>REPLICA</span><span> IDENTITY</span><span> FULL;</span></span>
<span></span></code></pre></div></div>
<p>If we run the update again:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>UPDATE</span><span> employees </span><span>SET</span><span> role=</span><span>&#39;Assistant Regional Manager&#39;</span><span> WHERE</span><span> name=</span><span>&#39;Dwight Schrute&#39;</span><span>;</span></span>
<span></span></code></pre></div></div>
<p>We now get all values after the update, but also before the update, under the <code>identity</code> field:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>{</span></span>
<span><span>  &#34;Data&#34;</span><span>:</span><span> {</span></span>
<span><span>    &#34;action&#34;</span><span>:</span><span> &#34;U&#34;</span><span>,</span></span>
<span><span>    &#34;timestamp&#34;</span><span>:</span><span> &#34;2024-08-20 17:50:50.503662+00&#34;</span><span>,</span></span>
<span><span>    &#34;lsn&#34;</span><span>:</span><span> &#34;0/15F65F0&#34;</span><span>,</span></span>
<span><span>    &#34;schema&#34;</span><span>:</span><span> &#34;public&#34;</span><span>,</span></span>
<span><span>    &#34;table&#34;</span><span>:</span><span> &#34;employees&#34;</span><span>,</span></span>
<span><span>    &#34;columns&#34;</span><span>:</span><span> [</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-1&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;id&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;integer&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> 1</span></span>
<span><span>      }</span><span>,</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-2&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;name&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;text&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> &#34;Dwight Schrute&#34;</span></span>
<span><span>      }</span><span>,</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-3&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;role&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;text&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> &#34;Assistant Regional Manager&#34;</span></span>
<span><span>      }</span></span>
<span><span>    ]</span><span>,</span></span>
<span><span>    &#34;identity&#34;</span><span>:</span><span> [</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-1&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;id&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;integer&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> 1</span></span>
<span><span>      }</span><span>,</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-2&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;name&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;text&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> &#34;Dwight Schrute&#34;</span></span>
<span><span>      }</span><span>,</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-3&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;role&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;text&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> &#34;Assistant to the Regional Manager&#34;</span></span>
<span><span>      }</span></span>
<span><span>    ]</span><span>,</span></span>
<span><span>    &#34;metadata&#34;</span><span>:</span><span> {</span></span>
<span><span>      &#34;schema_id&#34;</span><span>:</span><span> &#34;cr2ae77jc0j00h93rdjg&#34;</span><span>,</span></span>
<span><span>      &#34;table_pgstream_id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0&#34;</span><span>,</span></span>
<span><span>      &#34;id_col_pgstream_id&#34;</span><span>:</span><span> [</span><span>&#34;cr2a0enjc0j00h93rdj0-1&#34;</span><span>]</span><span>,</span></span>
<span><span>      &#34;version_col_pgstream_id&#34;</span><span>:</span><span> &#34;&#34;</span></span>
<span><span>    }</span></span>
<span><span>  }</span></span>
<span><span>}</span></span>
<span></span></code></pre></div></div>

<p>Let&#39;s try a simple delete as well:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>DELETE</span><span> FROM</span><span> employees </span><span>WHERE</span><span> name=</span><span>&#39;Dwight Schrute&#39;</span><span>;</span></span>
<span></span></code></pre></div></div>
<p>The generated event:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>{</span></span>
<span><span>  &#34;Data&#34;</span><span>:</span><span> {</span></span>
<span><span>    &#34;action&#34;</span><span>:</span><span> &#34;D&#34;</span><span>,</span></span>
<span><span>    &#34;timestamp&#34;</span><span>:</span><span> &#34;2024-08-21 15:31:55.992618+00&#34;</span><span>,</span></span>
<span><span>    &#34;lsn&#34;</span><span>:</span><span> &#34;0/163CEC8&#34;</span><span>,</span></span>
<span><span>    &#34;schema&#34;</span><span>:</span><span> &#34;public&#34;</span><span>,</span></span>
<span><span>    &#34;table&#34;</span><span>:</span><span> &#34;employees&#34;</span><span>,</span></span>
<span><span>    &#34;columns&#34;</span><span>:</span><span> null</span><span>,</span></span>
<span><span>    &#34;identity&#34;</span><span>:</span><span> [</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-1&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;id&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;integer&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> 1</span></span>
<span><span>      }</span><span>,</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-2&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;name&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;text&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> &#34;Dwight Schrute&#34;</span></span>
<span><span>      }</span><span>,</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-3&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;role&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;text&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> &#34;Assistant Regional Manager&#34;</span></span>
<span><span>      }</span><span>,</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-4&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;last_name&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;text&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> null</span></span>
<span><span>      }</span></span>
<span><span>    ]</span><span>,</span></span>
<span><span>    &#34;metadata&#34;</span><span>:</span><span> {</span></span>
<span><span>      &#34;schema_id&#34;</span><span>:</span><span> &#34;cr2r0lvjc0j00h93rdn0&#34;</span><span>,</span></span>
<span><span>      &#34;table_pgstream_id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0&#34;</span><span>,</span></span>
<span><span>      &#34;id_col_pgstream_id&#34;</span><span>:</span><span> [</span><span>&#34;cr2a0enjc0j00h93rdj0-1&#34;</span><span>]</span><span>,</span></span>
<span><span>      &#34;version_col_pgstream_id&#34;</span><span>:</span><span> &#34;&#34;</span></span>
<span><span>    }</span></span>
<span><span>  }</span></span>
<span><span>}</span></span>
<span></span></code></pre></div></div>
<p>To note:</p>
<ul role="list"><li>The &#34;action&#34; key is set to <code>D</code>, for &#34;delete&#34;</li><li>The full row is included in the <code>identity</code> object. That is because we have the replicate identity set to FULL, otherwise only the PK would have been included.</li></ul>

<p>Setting the replica identity to full accomplishes one more thing: it includes the large values in the webhook events.</p>
<p>Postgres values over the page size (commonly 8k, after compression) are stored separately from the main table data in <a href="https://www.postgresql.org/docs/current/storage-toast.html">TOAST storage</a>. This means they are also not included in the logical replication events by default, unless they are changed by the current UPDATE statement. This is a gotcha: you are expecting all columns to always be present, but once they reach a certain size they will be missing.</p>
<p>However, setting the replica identity to <code>full</code> solves this. To test this, try the following:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>-- set the identity back to be just PK</span></span>
<span><span>ALTER</span><span> TABLE</span><span> employees </span><span>REPLICA</span><span> IDENTITY</span><span> DEFAULT</span><span>;</span></span>
<span></span>
<span><span>-- set the role column to a large value.</span></span>
<span><span>-- This will be in the event because the role column is modified</span></span>
<span><span>UPDATE</span><span> employees </span><span>SET</span><span> role=</span><span>(</span></span>
<span><span>    SELECT</span><span> string_agg</span><span>(generate_series::</span><span>text</span><span>, </span><span>&#39; &#39;</span><span>) </span><span>FROM</span><span> generate_series</span><span>(</span><span>0</span><span>, </span><span>8000</span><span>)</span></span>
<span><span>    ) </span><span>WHERE</span><span> name=</span><span>&#39;Dwight Schrute&#39;</span><span>;</span></span>
<span></span>
<span><span>-- change another column.</span></span>
<span><span>-- This time the role column is not present because it&#39;s TOASTed</span></span>
<span><span>UPDATE</span><span> employees </span><span>SET</span><span> name=</span><span>&#39;Jim Halpert&#39;</span><span> WHERE</span><span> name=</span><span>&#39;Dwight Schrute&#39;</span><span>;</span></span>
<span></span>
<span><span>-- set the identity to FULL</span></span>
<span><span>ALTER</span><span> TABLE</span><span> employees </span><span>REPLICA</span><span> IDENTITY</span><span> FULL;</span></span>
<span></span>
<span><span>-- try the update again, this time the value is included in the event.</span></span>
<span><span>UPDATE</span><span> employees </span><span>SET</span><span> name=</span><span>&#39;Dwight Schrute&#39;</span><span> WHERE</span><span> name=</span><span>&#39;Jim Halpert&#39;</span><span>;</span></span>
<span></span></code></pre></div></div>
<p>Note, however, that the TOASTed value is included only in the <code>identity</code> part of the event, so your application needs to pick it up from there.</p>
<p>At this point, you might be wondering what are the downsides of setting the replica identity to full. Luckily, we wrote a <a href="https://xata.io/blog/replica-identity-full-performance">full blog post about that</a>. In short: there are some performance impacts, more relevant for the Postgres to Postgres replication use case and less relevant for the webhooks calling use case.</p>

<p>Let&#39;s look at one more pgstream trick: receiving webhooks for schema changes, in addition to data changes.</p>
<p>Postgres replication events have the well-known limitation that they don&#39;t include any schema changes. This can be an issue if your application requires having an up-to-date view of the schema.</p>
<p>pgstream works around this limitation by installing <a href="https://wiki.postgresql.org/wiki/Event_Triggers">DDL event triggers</a> and maintaining the list of changes in a separate table, called <code>pgstream.schema_log</code>. Then, pgstream can subscribe to this table just like any other table.</p>
<p>To get schema events, we create another subscription pointing to the same webhooks listener server as before:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>curl</span><span> localhost:9900/webhooks/subscribe</span><span> \</span></span>
<span><span>  -H</span><span> &#34;content-type: application/json&#34;</span><span> \</span></span>
<span><span>  -d</span><span> &#39;{&#34;url&#34;:&#34;http://localhost:9910/webhook&#34;, &#34;schema&#34;: &#34;pgstream&#34;, &#34;table&#34;: &#34;schema_log&#34;}&#39;</span></span>
<span></span></code></pre></div></div>
<p>Now if we do a schema change:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>ALTER</span><span> TABLE</span><span> employees </span><span>ADD</span><span> COLUMN first_name </span><span>TEXT</span><span>;</span></span>
<span></span></code></pre></div></div>
<p>We get an event like this:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>{</span></span>
<span><span>  &#34;Data&#34;</span><span>:</span><span> {</span></span>
<span><span>    &#34;action&#34;</span><span>:</span><span> &#34;I&#34;</span><span>,</span></span>
<span><span>    &#34;timestamp&#34;</span><span>:</span><span> &#34;2024-08-21 09:10:07.940957+00&#34;</span><span>,</span></span>
<span><span>    &#34;lsn&#34;</span><span>:</span><span> &#34;0/16240F8&#34;</span><span>,</span></span>
<span><span>    &#34;schema&#34;</span><span>:</span><span> &#34;pgstream&#34;</span><span>,</span></span>
<span><span>    &#34;table&#34;</span><span>:</span><span> &#34;schema_log&#34;</span><span>,</span></span>
<span><span>    &#34;columns&#34;</span><span>:</span><span> [</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;id&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;pgstream.xid&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> &#34;cr2qtrvjc0j00h93rdmg&#34;</span></span>
<span><span>      }</span><span>,</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;version&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;bigint&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> 11</span></span>
<span><span>      }</span><span>,</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;schema_name&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;text&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> &#34;public&#34;</span></span>
<span><span>      }</span><span>,</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;schema&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;jsonb&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> &#34;{\&#34;tables\&#34;: [{\&#34;oid\&#34;: \&#34;16480\&#34;, \&#34;name\&#34;: \&#34;employees\&#34;, \&#34;columns\&#34;: [{\&#34;name\&#34;: \&#34;first_name\&#34;, \&#34;type\&#34;: \&#34;text\&#34;, \&#34;unique\&#34;: false, \&#34;default\&#34;: null, \&#34;metadata\&#34;: null, \&#34;nullable\&#34;: true, \&#34;pgstream_id\&#34;: \&#34;cr2a0enjc0j00h93rdj0-4\&#34;}, {\&#34;name\&#34;: \&#34;name\&#34;, \&#34;type\&#34;: \&#34;text\&#34;, \&#34;unique\&#34;: false, \&#34;default\&#34;: null, \&#34;metadata\&#34;: null, \&#34;nullable\&#34;: true, \&#34;pgstream_id\&#34;: \&#34;cr2a0enjc0j00h93rdj0-2\&#34;}, {\&#34;name\&#34;: \&#34;role\&#34;, \&#34;type\&#34;: \&#34;text\&#34;, \&#34;unique\&#34;: false, \&#34;default\&#34;: null, \&#34;metadata\&#34;: null, \&#34;nullable\&#34;: true, \&#34;pgstream_id\&#34;: \&#34;cr2a0enjc0j00h93rdj0-3\&#34;}, {\&#34;name\&#34;: \&#34;id\&#34;, \&#34;type\&#34;: \&#34;integer\&#34;, \&#34;unique\&#34;: true, \&#34;default\&#34;: \&#34;nextval(&#39;public.employees_id_seq&#39;::regclass)\&#34;, \&#34;metadata\&#34;: null, \&#34;nullable\&#34;: false, \&#34;pgstream_id\&#34;: \&#34;cr2a0enjc0j00h93rdj0-1\&#34;}], \&#34;pgstream_id\&#34;: \&#34;cr2a0enjc0j00h93rdj0\&#34;, \&#34;primary_key_columns\&#34;: [\&#34;id\&#34;]}, {\&#34;oid\&#34;: \&#34;16472\&#34;, \&#34;name\&#34;: \&#34;webhook_subscriptions\&#34;, \&#34;columns\&#34;: [{\&#34;name\&#34;: \&#34;url\&#34;, \&#34;type\&#34;: \&#34;text\&#34;, \&#34;unique\&#34;: false, \&#34;default\&#34;: null, \&#34;metadata\&#34;: null, \&#34;nullable\&#34;: false, \&#34;pgstream_id\&#34;: \&#34;cr29p2vjc0j00i13rdhg-1\&#34;}, {\&#34;name\&#34;: \&#34;schema_name\&#34;, \&#34;type\&#34;: \&#34;text\&#34;, \&#34;unique\&#34;: false, \&#34;default\&#34;: null, \&#34;metadata\&#34;: null, \&#34;nullable\&#34;: false, \&#34;pgstream_id\&#34;: \&#34;cr29p2vjc0j00i13rdhg-2\&#34;}, {\&#34;name\&#34;: \&#34;table_name\&#34;, \&#34;type\&#34;: \&#34;text\&#34;, \&#34;unique\&#34;: false, \&#34;default\&#34;: null, \&#34;metadata\&#34;: null, \&#34;nullable\&#34;: false, \&#34;pgstream_id\&#34;: \&#34;cr29p2vjc0j00i13rdhg-3\&#34;}, {\&#34;name\&#34;: \&#34;event_types\&#34;, \&#34;type\&#34;: \&#34;text[]\&#34;, \&#34;unique\&#34;: false, \&#34;default\&#34;: null, \&#34;metadata\&#34;: null, \&#34;nullable\&#34;: true, \&#34;pgstream_id\&#34;: \&#34;cr29p2vjc0j00i13rdhg-4\&#34;}], \&#34;pgstream_id\&#34;: \&#34;cr29p2vjc0j00i13rdhg\&#34;, \&#34;primary_key_columns\&#34;: [\&#34;url\&#34;, \&#34;schema_name\&#34;, \&#34;table_name\&#34;]}]}&#34;</span></span>
<span><span>      }</span><span>,</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;created_at&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;timestamp without time zone&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> &#34;2024-08-21 09:10:07.909214&#34;</span></span>
<span><span>      }</span><span>,</span></span>
<span><span>      {</span></span>
<span><span>        &#34;id&#34;</span><span>:</span><span> &#34;&#34;</span><span>,</span></span>
<span><span>        &#34;name&#34;</span><span>:</span><span> &#34;acked&#34;</span><span>,</span></span>
<span><span>        &#34;type&#34;</span><span>:</span><span> &#34;boolean&#34;</span><span>,</span></span>
<span><span>        &#34;value&#34;</span><span>:</span><span> false</span></span>
<span><span>      }</span></span>
<span><span>    ]</span><span>,</span></span>
<span><span>    &#34;identity&#34;</span><span>:</span><span> null</span><span>,</span></span>
<span><span>    &#34;metadata&#34;</span><span>:</span><span> {</span></span>
<span><span>      &#34;schema_id&#34;</span><span>:</span><span> null</span><span>,</span></span>
<span><span>      &#34;table_pgstream_id&#34;</span><span>:</span><span> &#34;&#34;</span><span>,</span></span>
<span><span>      &#34;id_col_pgstream_id&#34;</span><span>:</span><span> null</span><span>,</span></span>
<span><span>      &#34;version_col_pgstream_id&#34;</span><span>:</span><span> &#34;&#34;</span></span>
<span><span>    }</span></span>
<span><span>  }</span></span>
<span><span>}</span></span>
<span></span></code></pre></div></div>
<p>The event is more complex, but if you look under the <code>schema</code> column value, you see the newly added column:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>{</span></span>
<span><span>  &#34;name&#34;</span><span>:</span><span> &#34;first_name&#34;</span><span>,</span></span>
<span><span>  &#34;type&#34;</span><span>:</span><span> &#34;text&#34;</span><span>,</span></span>
<span><span>  &#34;unique&#34;</span><span>:</span><span> false</span><span>,</span></span>
<span><span>  &#34;default&#34;</span><span>:</span><span> null</span><span>,</span></span>
<span><span>  &#34;metadata&#34;</span><span>:</span><span> null</span><span>,</span></span>
<span><span>  &#34;nullable&#34;</span><span>:</span><span> true</span><span>,</span></span>
<span><span>  &#34;pgstream_id&#34;</span><span>:</span><span> &#34;cr2a0enjc0j00h93rdj0-4&#34;</span></span>
<span><span>}</span></span>
<span></span></code></pre></div></div>
<p>Note how you get not only the name and the type of the column, but also metadata information (is nullable, is unique, default value).</p>
<p>Also, the <code>pgstream_id</code> value is unique and fixed for this column, regardless of the name. You can verify this by performing a rename:</p>
<div><div role="group"><pre tabindex="0"><code><span><span>ALTER</span><span> TABLE</span><span> employees RENAME COLUMN first_name </span><span>TO</span><span> last_name;</span></span>
<span></span></code></pre></div></div>

<p>In this guide, we demonstrated how to set up and trigger webhooks based on data changes in a PostgreSQL database using <code>pgstream</code>. We covered the initial setup, webhook configuration, and handling basic operations like inserts, updates, and deletes.</p>
<p><code>pgstream</code> also offers advanced capabilities, such as sending both old and new values during updates and managing schema changes. By integrating <code>pgstream</code> into your PostgreSQL environment, you can automate workflows, trigger real-time notifications, and build more responsive applications, whether for data synchronization, auditing, or microservices communication.</p>
<p>If you have any questions or hit issues with this tutorial, please open an issue in the <a href="https://github.com/xataio/pgstream">pgstream repo</a> or join us in <a href="https://xata.io/discord">Discord</a>.</p></div></div>
  </body>
</html>
