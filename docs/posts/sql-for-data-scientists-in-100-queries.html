<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gvwilson.github.io/sql-tutorial/">Original</a>
    <h1>SQL for data scientists in 100 queries</h1>
    
    <div id="readability-page-1" class="page"><div>
      
      
<!-- 0 -->

<section>

  <h2 id="what-this-is">☆ what this is</h2>

  <ul>
    <li>notes and working examples that instructors can use to perform a lesson
      <ul>
        <li>do <em>not</em> expect novices with no prior SQL experience to be able to learn from them</li>
      </ul>
    </li>
    <li>musical analogy
      <ul>
        <li>this is the chord changes and melody</li>
        <li>we expect instructors to create an arrangement and/or improvise while delivering</li>
        <li>see <a href="https://teachtogether.tech/"><em>Teaching Tech Together</em></a> for background</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="scope">☆ scope</h2>

  <ul>
    <li><a href="http://teachtogether.tech/en/index.html#s:process-personas">intended audience</a>
      <ul>
        <li>Rachel has a master’s degree in cell biology
and now works in a research hospital doing cell assays.</li>
        <li>She learned a bit of R in an undergrad biostatistics course
and has been through <a href="https://swcarpentry.github.io/shell-novice/">the Carpentries lesson on the Unix shell</a>.</li>
        <li>Rachel is thinking about becoming a data scientist
and would like to understand how data is stored and managed.</li>
        <li>Her work schedule is unpredictable and highly variable,
so she needs to be able to learn a bit at a time.</li>
      </ul>
    </li>
    <li>prerequisites
      <ul>
        <li>basic Unix command line: <code>cd</code>, <code>ls</code>, <code>*</code> wildcard</li>
        <li>basic tabular data analysis: filtering rows, aggregating within groups</li>
      </ul>
    </li>
    <li>learning outcomes
      <ol>
        <li>Explain the difference between a database and a database manager.</li>
        <li>Write SQL to select, filter, sort, group, and aggregate data.</li>
        <li>Define tables and insert, update, and delete records.</li>
        <li>Describe different types of join and write queries that use them to combine data.</li>
        <li>Use windowing functions to operate on adjacent rows.</li>
        <li>Explain what transactions are and write queries that roll back when constraints are violated.</li>
        <li>Explain what triggers are and write SQL to create them.</li>
        <li>Manipulate JSON data using SQL.</li>
        <li>Interact with a database using Python directly, from a Jupyter notebook, and via an ORM.</li>
      </ol>
    </li>
  </ul>

</section>
<section>

  <h2 id="setup">☆ setup</h2>

  <ul>
    <li>Download <a href="https://github.com/gvwilson/sql-tutorial/raw/main/sql-tutorial.zip">the latest release</a></li>
    <li>Unzip the file in a temporary directory to create:
      <ul>
        <li><code>./db/*.db</code>: the SQLite databases used in the examples</li>
        <li><code>./src/*.*</code>: SQL queries, Python scripts, and other source code</li>
        <li><code>./out/*.*</code>: expected output for examples</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="background-concepts">☆ background concepts</h2>

  <ul>
    <li>A <a href="#g:database">database</a> is a collection of data that can be searched and retrieved</li>
    <li>A <a href="#g:dbms">database management system</a> (DBMS) is a program that manages a particular kind of database</li>
    <li>Each DBMS stores data in its own way
      <ul>
        <li><a href="https://sqlite.org/">SQLite</a> stores each database in a single file</li>
        <li><a href="https://www.postgresql.org/">PostgreSQL</a> spreads information across many files for higher performance</li>
      </ul>
    </li>
    <li>DBMS can be a library embedded in other programs (<a href="https://sqlite.org/">SQLite</a>) or a server (<a href="https://www.postgresql.org/">PostgreSQL</a>)</li>
    <li>A <a href="#g:rdbms">relational database management system</a> (RDBMS) stores data in tables and uses <a href="https://en.wikipedia.org/wiki/SQL">SQL</a> for queries
      <ul>
        <li>Unfortunately, every RDBMS has its own dialect of SQL</li>
      </ul>
    </li>
    <li>There are also <a href="#g:nosql">NoSQL databases</a> like <a href="https://www.mongodb.com/">MongoDB</a> that don’t use tables</li>
  </ul>

  <p><img src="https://www.wildlondon.org.uk/sql-tutorial/img/concept_map_overview.svg" alt="concept map: overview"/></p>

</section>
<section>

  <h2 id="connect-to-database">☆ connect to database</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/connect_penguins.sh">src/connect_penguins.sh</a></p>
  

  <ul>
    <li>Not actually a query</li>
    <li>But we have to do it before we can do anything else</li>
  </ul>

</section>
<section>

  <h2 id="select-constant">1: select constant</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/select_1.sql">src/select_1.sql</a></p>
  

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/select_1.out">out/select_1.out</a></p>
  

  <ul>
    <li><code>select</code> is a keyword</li>
    <li>Normally used to select data from table…</li>
    <li>…but if all we want is a constant value, we don’t need to specify one</li>
    <li>Semi-colon terminator is required</li>
  </ul>

</section>
<section>

  <h2 id="select-all-values-from-table">2: select all values from table</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/select_star.sql">src/select_star.sql</a></p>
  <div><div><pre><code><span>select</span> <span>*</span> <span>from</span> <span>little_penguins</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/select_star.out">out/select_star.out</a></p>
  <div><div><pre><code>Adelie|Dream|37.2|18.1|178|3900|MALE
Adelie|Dream|37.6|19.3|181|3300|FEMALE
Gentoo|Biscoe|50|15.3|220|5550|MALE
Adelie|Torgersen|37.3|20.5|199|3775|MALE
Adelie|Biscoe|39.6|17.7|186|3500|FEMALE
Gentoo|Biscoe|47.7|15|216|4750|FEMALE
Adelie|Dream|36.5|18|182|3150|FEMALE
Gentoo|Biscoe|42|13.5|210|4150|FEMALE
Adelie|Torgersen|42.1|19.1|195|4000|MALE
Gentoo|Biscoe|54.3|15.7|231|5650|MALE
</code></pre></div>  </div>

  <ul>
    <li>An actual <a href="#g:query">query</a></li>
    <li>Use <code>*</code> to mean “all columns”</li>
    <li>Use <code>from <em>tablename</em></code> to specify table</li>
    <li>Output format is not particularly readable</li>
  </ul>

</section>
<section>

  <h2 id="administrative-commands">☆ administrative commands</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/admin_commands.sql">src/admin_commands.sql</a></p>
  <div><div><pre><code><span>.</span><span>headers</span> <span>on</span>
<span>.</span><span>mode</span> <span>markdown</span>
<span>select</span> <span>*</span> <span>from</span> <span>little_penguins</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/admin_commands.out">out/admin_commands.out</a></p>
  <div><div><pre><code>| species |  island   | bill_length_mm | bill_depth_mm | flipper_length_mm | body_mass_g |  sex   |
|---------|-----------|----------------|---------------|-------------------|-------------|--------|
| Adelie  | Dream     | 37.2           | 18.1          | 178               | 3900        | MALE   |
| Adelie  | Dream     | 37.6           | 19.3          | 181               | 3300        | FEMALE |
| Gentoo  | Biscoe    | 50             | 15.3          | 220               | 5550        | MALE   |
| Adelie  | Torgersen | 37.3           | 20.5          | 199               | 3775        | MALE   |
| Adelie  | Biscoe    | 39.6           | 17.7          | 186               | 3500        | FEMALE |
| Gentoo  | Biscoe    | 47.7           | 15            | 216               | 4750        | FEMALE |
| Adelie  | Dream     | 36.5           | 18            | 182               | 3150        | FEMALE |
| Gentoo  | Biscoe    | 42             | 13.5          | 210               | 4150        | FEMALE |
| Adelie  | Torgersen | 42.1           | 19.1          | 195               | 4000        | MALE   |
| Gentoo  | Biscoe    | 54.3           | 15.7          | 231               | 5650        | MALE   |
</code></pre></div>  </div>

  <ul>
    <li>SQLite administrative commands start with <code>.</code> and <em>aren’t</em> part of the SQL standard
      <ul>
        <li>PostgreSQL’s special commands start with <code>\</code></li>
      </ul>
    </li>
    <li>Use <code>.help</code> for a complete list</li>
  </ul>

</section>
<section>

  <h2 id="specify-columns">3: specify columns</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/specify_columns.sql">src/specify_columns.sql</a></p>
  <div><div><pre><code><span>select</span> <span>species</span><span>,</span> <span>island</span><span>,</span> <span>sex</span>
<span>from</span> <span>little_penguins</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/specify_columns.out">out/specify_columns.out</a></p>
  <div><div><pre><code>| species |  island   |  sex   |
|---------|-----------|--------|
| Adelie  | Dream     | MALE   |
| Adelie  | Dream     | FEMALE |
| Gentoo  | Biscoe    | MALE   |
| Adelie  | Torgersen | MALE   |
| Adelie  | Biscoe    | FEMALE |
| Gentoo  | Biscoe    | FEMALE |
| Adelie  | Dream     | FEMALE |
| Gentoo  | Biscoe    | FEMALE |
| Adelie  | Torgersen | MALE   |
| Gentoo  | Biscoe    | MALE   |
</code></pre></div>  </div>

  <ul>
    <li>Specify column names separated by commas
      <ul>
        <li>In any order</li>
        <li>Duplicates allowed</li>
      </ul>
    </li>
    <li>Line breaks <strike>allowed</strike> encouraged for readability</li>
  </ul>

</section>
<section>

  <h2 id="sort">4: sort</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/sort.sql">src/sort.sql</a></p>
  <div><div><pre><code><span>select</span> <span>species</span><span>,</span> <span>sex</span><span>,</span> <span>island</span>
<span>from</span> <span>little_penguins</span>
<span>order</span> <span>by</span> <span>island</span> <span>asc</span><span>,</span> <span>sex</span> <span>desc</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/sort.out">out/sort.out</a></p>
  <div><div><pre><code>| species |  sex   |  island   |
|---------|--------|-----------|
| Gentoo  | MALE   | Biscoe    |
| Gentoo  | MALE   | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Gentoo  | FEMALE | Biscoe    |
| Gentoo  | FEMALE | Biscoe    |
| Adelie  | MALE   | Dream     |
| Adelie  | FEMALE | Dream     |
| Adelie  | FEMALE | Dream     |
| Adelie  | MALE   | Torgersen |
| Adelie  | MALE   | Torgersen |
</code></pre></div>  </div>

  <ul>
    <li><code>order by</code> must follow <code>from</code> (which must follow <code>select</code>)</li>
    <li><code>asc</code> is ascending, <code>desc</code> is descending
      <ul>
        <li>Default is ascending, but please specify</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="limit-output">5: limit output</h2>

  <ul>
    <li>Full dataset has 344 rows</li>
  </ul>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/limit.sql">src/limit.sql</a></p>
  <div><div><pre><code><span>select</span> <span>species</span><span>,</span> <span>sex</span><span>,</span> <span>island</span>
<span>from</span> <span>penguins</span>
<span>order</span> <span>by</span> <span>species</span><span>,</span> <span>sex</span><span>,</span> <span>island</span>
<span>limit</span> <span>10</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/limit.out">out/limit.out</a></p>
  <div><div><pre><code>| species |  sex   |  island   |
|---------|--------|-----------|
| Adelie  |        | Dream     |
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
</code></pre></div>  </div>

  <ul>
    <li>Comments start with <code>--</code> and run to the end of the line</li>
    <li><code>limit <em>N</em></code> specifies maximum number of rows returned by query</li>
  </ul>

</section>
<section>

  <h2 id="page-output">6: page output</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/page.sql">src/page.sql</a></p>
  <div><div><pre><code><span>select</span> <span>species</span><span>,</span> <span>sex</span><span>,</span> <span>island</span>
<span>from</span> <span>penguins</span>
<span>order</span> <span>by</span> <span>species</span><span>,</span> <span>sex</span><span>,</span> <span>island</span>
<span>limit</span> <span>10</span> <span>offset</span> <span>3</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/page.out">out/page.out</a></p>
  <div><div><pre><code>| species |  sex   |  island   |
|---------|--------|-----------|
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
</code></pre></div>  </div>

  <ul>
    <li><code>offset <em>N</em></code> must follow <code>limit</code></li>
    <li>Specifies number of rows to skip from the start of the selection</li>
    <li>So this query skips the first 3 and shows the next 10</li>
  </ul>

</section>
<section>

  <h2 id="remove-duplicates">7: remove duplicates</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/distinct.sql">src/distinct.sql</a></p>
  <div><div><pre><code><span>select</span> <span>distinct</span> <span>species</span><span>,</span> <span>sex</span><span>,</span> <span>island</span>
<span>from</span> <span>penguins</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/distinct.out">out/distinct.out</a></p>
  <div><div><pre><code>|  species  |  sex   |  island   |
|-----------|--------|-----------|
| Adelie    | MALE   | Torgersen |
| Adelie    | FEMALE | Torgersen |
| Adelie    |        | Torgersen |
| Adelie    | FEMALE | Biscoe    |
| Adelie    | MALE   | Biscoe    |
| Adelie    | FEMALE | Dream     |
| Adelie    | MALE   | Dream     |
| Adelie    |        | Dream     |
| Chinstrap | FEMALE | Dream     |
| Chinstrap | MALE   | Dream     |
| Gentoo    | FEMALE | Biscoe    |
| Gentoo    | MALE   | Biscoe    |
| Gentoo    |        | Biscoe    |
</code></pre></div>  </div>

  <ul>
    <li><code>distinct</code> keyword must appear right after <code>select</code>
      <ul>
        <li>SQL was supposed to read like English</li>
      </ul>
    </li>
    <li>Shows distinct combinations</li>
    <li>Blanks in <code>sex</code> column show missing data
      <ul>
        <li>We’ll talk about this in a bit</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="filter-results">8: filter results</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/filter.sql">src/filter.sql</a></p>
  <div><div><pre><code><span>select</span> <span>distinct</span> <span>species</span><span>,</span> <span>sex</span><span>,</span> <span>island</span>
<span>from</span> <span>penguins</span>
<span>where</span> <span>island</span> <span>=</span> <span>&#39;Biscoe&#39;</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/filter.out">out/filter.out</a></p>
  <div><div><pre><code>| species |  sex   | island |
|---------|--------|--------|
| Adelie  | FEMALE | Biscoe |
| Adelie  | MALE   | Biscoe |
| Gentoo  | FEMALE | Biscoe |
| Gentoo  | MALE   | Biscoe |
| Gentoo  |        | Biscoe |
</code></pre></div>  </div>

  <ul>
    <li><code>where <em>condition</em></code> <a href="#g:filter">filters</a> the rows produced by selection</li>
    <li>Condition is evaluated independently for each row</li>
    <li>Only rows that pass the test appear in results</li>
    <li>Use single quotes for <code>&#39;text data&#39;</code> and double quotes for <code>&#34;weird column names&#34;</code>
      <ul>
        <li>SQLite will accept double-quoted text data</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="filter-with-more-complex-conditions">9: filter with more complex conditions</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/filter_and.sql">src/filter_and.sql</a></p>
  <div><div><pre><code><span>select</span> <span>distinct</span> <span>species</span><span>,</span> <span>sex</span><span>,</span> <span>island</span>
<span>from</span> <span>penguins</span>
<span>where</span> <span>island</span> <span>=</span> <span>&#39;Biscoe&#39;</span> <span>and</span> <span>sex</span> <span>!=</span> <span>&#39;MALE&#39;</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/filter_and.out">out/filter_and.out</a></p>
  <div><div><pre><code>| species |  sex   | island |
|---------|--------|--------|
| Adelie  | FEMALE | Biscoe |
| Gentoo  | FEMALE | Biscoe |
</code></pre></div>  </div>

  <ul>
    <li><code>and</code>: both sub-conditions must be true</li>
    <li><code>or</code>: either or both part must be true</li>
    <li>Notice that the row for Gentoo penguins on Biscoe island with unknown (empty) sex didn’t pass the test
      <ul>
        <li>We’ll talk about this in a bit</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="do-calculations">10: do calculations</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/calculations.sql">src/calculations.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>flipper_length_mm</span> <span>/</span> <span>10</span><span>.</span><span>0</span><span>,</span>
    <span>body_mass_g</span> <span>/</span> <span>1000</span><span>.</span><span>0</span>
<span>from</span> <span>penguins</span>
<span>limit</span> <span>3</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/calculations.out">out/calculations.out</a></p>
  <div><div><pre><code>| flipper_length_mm / 10.0 | body_mass_g / 1000.0 |
|--------------------------|----------------------|
| 18.1                     | 3.75                 |
| 18.6                     | 3.8                  |
| 19.5                     | 3.25                 |
</code></pre></div>  </div>

  <ul>
    <li>Can do the usual kinds of arithmetic on individual values
      <ul>
        <li>Calculation done for each row independently</li>
      </ul>
    </li>
    <li>Column name shows the calculation done</li>
  </ul>

</section>
<section>

  <h2 id="rename-columns">11: rename columns</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/rename_columns.sql">src/rename_columns.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>flipper_length_mm</span> <span>/</span> <span>10</span><span>.</span><span>0</span> <span>as</span> <span>flipper_cm</span><span>,</span>
    <span>body_mass_g</span> <span>/</span> <span>1000</span><span>.</span><span>0</span> <span>as</span> <span>weight_kg</span><span>,</span>
    <span>island</span> <span>as</span> <span>where_found</span>
<span>from</span> <span>penguins</span>
<span>limit</span> <span>3</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/rename_columns.out">out/rename_columns.out</a></p>
  <div><div><pre><code>| flipper_cm | weight_kg | where_found |
|------------|-----------|-------------|
| 18.1       | 3.75      | Torgersen   |
| 18.6       | 3.8       | Torgersen   |
| 19.5       | 3.25      | Torgersen   |
</code></pre></div>  </div>

  <ul>
    <li>Use <code><em>expression</em> as <em>name</em></code> to rename</li>
    <li>Give result of calculation a meaningful name</li>
    <li>Can also rename columns without modifying</li>
  </ul>

</section>
<section>

  <h2 id="check-your-understanding">☆ check your understanding</h2>

  <p><img src="https://www.wildlondon.org.uk/sql-tutorial/img/concept_map_select.svg" alt="concept map: selection"/></p>

</section>
<section>

  <h2 id="calculate-with-missing-values">12: calculate with missing values</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/show_missing_values.sql">src/show_missing_values.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>flipper_length_mm</span> <span>/</span> <span>10</span><span>.</span><span>0</span> <span>as</span> <span>flipper_cm</span><span>,</span>
    <span>body_mass_g</span> <span>/</span> <span>1000</span><span>.</span><span>0</span> <span>as</span> <span>weight_kg</span><span>,</span>
    <span>island</span> <span>as</span> <span>where_found</span>
<span>from</span> <span>penguins</span>
<span>limit</span> <span>5</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/show_missing_values.out">out/show_missing_values.out</a></p>
  <div><div><pre><code>| flipper_cm | weight_kg | where_found |
|------------|-----------|-------------|
| 18.1       | 3.75      | Torgersen   |
| 18.6       | 3.8       | Torgersen   |
| 19.5       | 3.25      | Torgersen   |
|            |           | Torgersen   |
| 19.3       | 3.45      | Torgersen   |
</code></pre></div>  </div>

  <ul>
    <li>SQL uses a special value <a href="#g:null"><code>null</code></a> to representing missing data
      <ul>
        <li>Not 0 or empty string, but “I don’t know”</li>
      </ul>
    </li>
    <li>Flipper length and body weight not known for one of the first five penguins</li>
    <li>“I don’t know” divided by 10 or 1000 is “I don’t know”</li>
  </ul>

</section>
<section>

  <h2 id="null-equality">13: null equality</h2>

  <ul>
    <li>Repeated from above so it doesn’t count against our query limit</li>
  </ul>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/filter.sql">src/filter.sql</a></p>
  <div><div><pre><code><span>select</span> <span>distinct</span> <span>species</span><span>,</span> <span>sex</span><span>,</span> <span>island</span>
<span>from</span> <span>penguins</span>
<span>where</span> <span>island</span> <span>=</span> <span>&#39;Biscoe&#39;</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/filter.out">out/filter.out</a></p>
  <div><div><pre><code>| species |  sex   | island |
|---------|--------|--------|
| Adelie  | FEMALE | Biscoe |
| Adelie  | MALE   | Biscoe |
| Gentoo  | FEMALE | Biscoe |
| Gentoo  | MALE   | Biscoe |
| Gentoo  |        | Biscoe |
</code></pre></div>  </div>

  <ul>
    <li>If we ask for female penguins the row with the missing sex drops out</li>
  </ul>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/null_equality.sql">src/null_equality.sql</a></p>
  <div><div><pre><code><span>select</span> <span>distinct</span> <span>species</span><span>,</span> <span>sex</span><span>,</span> <span>island</span>
<span>from</span> <span>penguins</span>
<span>where</span> <span>island</span> <span>=</span> <span>&#39;Biscoe&#39;</span> <span>and</span> <span>sex</span> <span>=</span> <span>&#39;FEMALE&#39;</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/null_equality.out">out/null_equality.out</a></p>
  <div><div><pre><code>| species |  sex   | island |
|---------|--------|--------|
| Adelie  | FEMALE | Biscoe |
| Gentoo  | FEMALE | Biscoe |
</code></pre></div>  </div>

</section>
<section>

  <h2 id="null-inequality">14: null inequality</h2>

  <ul>
    <li>But if we ask for penguins that <em>aren’t</em> female it drops out as well</li>
  </ul>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/null_inequality.sql">src/null_inequality.sql</a></p>
  <div><div><pre><code><span>select</span> <span>distinct</span> <span>species</span><span>,</span> <span>sex</span><span>,</span> <span>island</span>
<span>from</span> <span>penguins</span>
<span>where</span> <span>island</span> <span>=</span> <span>&#39;Biscoe&#39;</span> <span>and</span> <span>sex</span> <span>!=</span> <span>&#39;FEMALE&#39;</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/null_inequality.out">out/null_inequality.out</a></p>
  <div><div><pre><code>| species | sex  | island |
|---------|------|--------|
| Adelie  | MALE | Biscoe |
| Gentoo  | MALE | Biscoe |
</code></pre></div>  </div>

</section>
<section>

  <h2 id="ternary-logic">15: ternary logic</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/ternary_logic.sql">src/ternary_logic.sql</a></p>
  

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/ternary_logic.out">out/ternary_logic.out</a></p>
  <div><div><pre><code>| null = null |
|-------------|
|             |
</code></pre></div>  </div>

  <ul>
    <li>If we don’t know the left and right values, we don’t know if they’re equal or not</li>
    <li>So the result is <code>null</code></li>
    <li>Get the same answer for <code>null != null</code></li>
    <li><a href="#g:ternary_logic">Ternary logic</a></li>
  </ul>

  <table>
  <tbody><tr>
    <th colspan="4">equality</th>
  </tr>
  <tr>
    <th></th>
    <th>X</th>
    <th>Y</th>
    <th>null</th>
  </tr>
  <tr>
    <th>X</th>
    <td>true</td>
    <td>false</td>
    <td>null</td>
  </tr>
  <tr>
    <th>Y</th>
    <td>false</td>
    <td>true</td>
    <td>null</td>
  </tr>
  <tr>
    <th>null</th>
    <td>null</td>
    <td>null</td>
    <td>null</td>
  </tr>
</tbody></table>

</section>
<section>

  <h2 id="handle-null-safely">16: handle null safely</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/safe_null_equality.sql">src/safe_null_equality.sql</a></p>
  <div><div><pre><code><span>select</span> <span>species</span><span>,</span> <span>sex</span><span>,</span> <span>island</span>
<span>from</span> <span>penguins</span>
<span>where</span> <span>sex</span> <span>is</span> <span>null</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/safe_null_equality.out">out/safe_null_equality.out</a></p>
  <div><div><pre><code>| species | sex |  island   |
|---------|-----|-----------|
| Adelie  |     | Torgersen |
| Adelie  |     | Torgersen |
| Adelie  |     | Torgersen |
| Adelie  |     | Torgersen |
| Adelie  |     | Torgersen |
| Adelie  |     | Dream     |
| Gentoo  |     | Biscoe    |
| Gentoo  |     | Biscoe    |
| Gentoo  |     | Biscoe    |
| Gentoo  |     | Biscoe    |
| Gentoo  |     | Biscoe    |
</code></pre></div>  </div>

  <ul>
    <li>Use <code>is null</code> and <code>is not null</code> to handle null safely</li>
    <li>Other parts of SQL handle nulls specially</li>
  </ul>

</section>
<section>

  <h2 id="check-your-understanding-1">☆ check your understanding</h2>

  <p><img src="https://www.wildlondon.org.uk/sql-tutorial/img/concept_map_null.svg" alt="concept map: null"/></p>

</section>
<section>

  <h2 id="aggregate">17: aggregate</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/simple_sum.sql">src/simple_sum.sql</a></p>
  <div><div><pre><code><span>select</span> <span>sum</span><span>(</span><span>body_mass_g</span><span>)</span> <span>as</span> <span>total_mass</span>
<span>from</span> <span>penguins</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/simple_sum.out">out/simple_sum.out</a></p>
  <div><div><pre><code>| total_mass |
|------------|
| 1437000    |
</code></pre></div>  </div>

  <ul>
    <li><a href="#g:aggregation">Aggregation</a> combines many values to produce one</li>
    <li><code>sum</code> is an <a href="#g:aggregation_func">aggregation function</a></li>
    <li>Combines corresponding values from multiple rows</li>
  </ul>

</section>
<section>

  <h2 id="common-aggregation-functions">18: common aggregation functions</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/common_aggregations.sql">src/common_aggregations.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>max</span><span>(</span><span>bill_length_mm</span><span>)</span> <span>as</span> <span>longest_bill</span><span>,</span>
    <span>min</span><span>(</span><span>flipper_length_mm</span><span>)</span> <span>as</span> <span>shortest_flipper</span><span>,</span>
    <span>avg</span><span>(</span><span>bill_length_mm</span><span>)</span> <span>/</span> <span>avg</span><span>(</span><span>bill_depth_mm</span><span>)</span> <span>as</span> <span>weird_ratio</span>
<span>from</span> <span>penguins</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/common_aggregations.out">out/common_aggregations.out</a></p>
  <div><div><pre><code>| longest_bill | shortest_flipper |   weird_ratio    |
|--------------|------------------|------------------|
| 59.6         | 172              | 2.56087082530644 |
</code></pre></div>  </div>

  <ul>
    <li>This actually shouldn’t work:
can’t calculate maximum or average if any values are null</li>
    <li>SQL does the useful thing instead of the right one</li>
  </ul>

</section>
<section>

  <h2 id="counting">19: counting</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/count_behavior.sql">src/count_behavior.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>count</span><span>(</span><span>*</span><span>)</span> <span>as</span> <span>count_star</span><span>,</span>
    <span>count</span><span>(</span><span>sex</span><span>)</span> <span>as</span> <span>count_specific</span><span>,</span>
    <span>count</span><span>(</span><span>distinct</span> <span>sex</span><span>)</span> <span>as</span> <span>count_distinct</span>
<span>from</span> <span>penguins</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/count_behavior.out">out/count_behavior.out</a></p>
  <div><div><pre><code>| count_star | count_specific | count_distinct |
|------------|----------------|----------------|
| 344        | 333            | 2              |
</code></pre></div>  </div>

  <ul>
    <li><code>count(*)</code> counts rows</li>
    <li><code>count(<em>column</em>)</code> counts non-null entries in column</li>
    <li><code>count(distinct <em>column</em>)</code> counts distinct non-null entries</li>
  </ul>

</section>
<section>

  <h2 id="group">20: group</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/simple_group.sql">src/simple_group.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>avg</span><span>(</span><span>body_mass_g</span><span>)</span> <span>as</span> <span>average_mass_g</span>
<span>from</span> <span>penguins</span>
<span>group</span> <span>by</span> <span>sex</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/simple_group.out">out/simple_group.out</a></p>
  <div><div><pre><code>|  average_mass_g  |
|------------------|
| 4005.55555555556 |
| 3862.27272727273 |
| 4545.68452380952 |
</code></pre></div>  </div>

  <ul>
    <li>Put rows in <a href="#g:group">groups</a> based on distinct combinations of values in columns specified with <code>group by</code></li>
    <li>Then perform aggregation separately for each group</li>
    <li>But which is which?</li>
  </ul>

</section>
<section>

  <h2 id="behavior-of-unaggregated-columns">21: behavior of unaggregated columns</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/unaggregated_columns.sql">src/unaggregated_columns.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>sex</span><span>,</span>
    <span>avg</span><span>(</span><span>body_mass_g</span><span>)</span> <span>as</span> <span>average_mass_g</span>
<span>from</span> <span>penguins</span>
<span>group</span> <span>by</span> <span>sex</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/unaggregated_columns.out">out/unaggregated_columns.out</a></p>
  <div><div><pre><code>|  sex   |  average_mass_g  |
|--------|------------------|
|        | 4005.55555555556 |
| FEMALE | 3862.27272727273 |
| MALE   | 4545.68452380952 |
</code></pre></div>  </div>

  <ul>
    <li>All rows in each group have the same value for <code>sex</code>, so no need to aggregate</li>
  </ul>

</section>
<section>

  <h2 id="arbitrary-choice-in-aggregation">22: arbitrary choice in aggregation</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/arbitrary_in_aggregation.sql">src/arbitrary_in_aggregation.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>sex</span><span>,</span>
    <span>body_mass_g</span>                   
<span>from</span> <span>penguins</span>
<span>group</span> <span>by</span> <span>sex</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/arbitrary_in_aggregation.out">out/arbitrary_in_aggregation.out</a></p>
  <div><div><pre><code>|  sex   | body_mass_g |
|--------|-------------|
|        |             |
| FEMALE | 3800        |
| MALE   | 3750        |
</code></pre></div>  </div>

  <ul>
    <li>If we don’t specify how to aggregate a column, SQL can choose <em>any arbitrary value</em> from the group</li>
    <li>All penguins in each group have the same sex because we grouped by that, so we get the right answer</li>
    <li>The body mass values are in the data but unpredictable</li>
    <li>A common mistake</li>
  </ul>

</section>
<section>

  <h2 id="filter-aggregated-values">23: filter aggregated values</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/filter_aggregation.sql">src/filter_aggregation.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>sex</span><span>,</span>
    <span>avg</span><span>(</span><span>body_mass_g</span><span>)</span> <span>as</span> <span>average_mass_g</span>
<span>from</span> <span>penguins</span>
<span>group</span> <span>by</span> <span>sex</span>
<span>having</span> <span>average_mass_g</span> <span>&gt;</span> <span>4000</span><span>.</span><span>0</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/filter_aggregation.out">out/filter_aggregation.out</a></p>
  <div><div><pre><code>| sex  |  average_mass_g  |
|------|------------------|
|      | 4005.55555555556 |
| MALE | 4545.68452380952 |
</code></pre></div>  </div>

  <ul>
    <li>Using <code>having <em>condition</em></code> instead of <code>where <em>condition</em></code> for aggregates</li>
  </ul>

</section>
<section>

  <h2 id="readable-output">24: readable output</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/readable_aggregation.sql">src/readable_aggregation.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>sex</span><span>,</span>
    <span>round</span><span>(</span><span>avg</span><span>(</span><span>body_mass_g</span><span>),</span> <span>1</span><span>)</span> <span>as</span> <span>average_mass_g</span>
<span>from</span> <span>penguins</span>
<span>group</span> <span>by</span> <span>sex</span>
<span>having</span> <span>average_mass_g</span> <span>&gt;</span> <span>4000</span><span>.</span><span>0</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/readable_aggregation.out">out/readable_aggregation.out</a></p>
  <div><div><pre><code>| sex  | average_mass_g |
|------|----------------|
|      | 4005.6         |
| MALE | 4545.7         |
</code></pre></div>  </div>

  <ul>
    <li>Use <code>round(<em>value</em>, <em>decimals</em>)</code> to round off a number</li>
  </ul>

</section>
<section>

  <h2 id="filter-aggregate-inputs">25: filter aggregate inputs</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/filter_aggregate_inputs.sql">src/filter_aggregate_inputs.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>sex</span><span>,</span>
    <span>round</span><span>(</span>
        <span>avg</span><span>(</span><span>body_mass_g</span><span>)</span> <span>filter</span> <span>(</span><span>where</span> <span>body_mass_g</span> <span>&lt;</span> <span>4000</span><span>.</span><span>0</span><span>),</span>
        <span>1</span>
    <span>)</span> <span>as</span> <span>average_mass_g</span>
<span>from</span> <span>penguins</span>
<span>group</span> <span>by</span> <span>sex</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/filter_aggregate_inputs.out">out/filter_aggregate_inputs.out</a></p>
  <div><div><pre><code>|  sex   | average_mass_g |
|--------|----------------|
|        | 3362.5         |
| FEMALE | 3417.3         |
| MALE   | 3752.5         |
</code></pre></div>  </div>

  <ul>
    <li><code>filter (where <em>condition</em>)</code> applies to <em>inputs</em></li>
  </ul>

</section>
<section>

  <h2 id="check-your-understanding-2">☆ check your understanding</h2>

  <p><img src="https://www.wildlondon.org.uk/sql-tutorial/img/concept_map_aggregate.svg" alt="concept map: aggregation"/></p>

</section>
<section>

  <h2 id="create-in-memory-database">☆ create in-memory database</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/in_memory_db.sh">src/in_memory_db.sh</a></p>
  

  <ul>
    <li>“Connect” to an <a href="#g:in_memory_db">in-memory database</a></li>
  </ul>

</section>
<section>

  <h2 id="create-tables">26: create tables</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/create_work_job.sql">src/create_work_job.sql</a></p>
  <div><div><pre><code><span>create</span> <span>table</span> <span>job</span> <span>(</span>
    <span>name</span> <span>text</span> <span>not</span> <span>null</span><span>,</span>
    <span>billable</span> <span>real</span> <span>not</span> <span>null</span>
<span>);</span>
<span>create</span> <span>table</span> <span>work</span> <span>(</span>
    <span>person</span> <span>text</span> <span>not</span> <span>null</span><span>,</span>
    <span>job</span> <span>text</span> <span>not</span> <span>null</span>
<span>);</span>
</code></pre></div>  </div>

  <ul>
    <li><code>create table <em>name</em></code> followed by parenthesized list of columns</li>
    <li>Each column is a name, a data type, and optional extra information
      <ul>
        <li>E.g., <code>not null</code> prevents nulls from being added</li>
      </ul>
    </li>
    <li><code>.schema</code> is <em>not</em> standard SQL</li>
    <li>SQLite has added a few things
      <ul>
        <li><code>create if not exists</code></li>
        <li>upper-case keywords (SQL is case insensitive)</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="insert-data">27: insert data</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/populate_work_job.sql">src/populate_work_job.sql</a></p>
  <div><div><pre><code><span>insert</span> <span>into</span> <span>job</span> <span>values</span>
    <span>(</span><span>&#39;calibrate&#39;</span><span>,</span> <span>1</span><span>.</span><span>5</span><span>),</span>
    <span>(</span><span>&#39;clean&#39;</span><span>,</span> <span>0</span><span>.</span><span>5</span><span>);</span>
<span>insert</span> <span>into</span> <span>work</span> <span>values</span>
    <span>(</span><span>&#39;mik&#39;</span><span>,</span> <span>&#39;calibrate&#39;</span><span>),</span>
    <span>(</span><span>&#39;mik&#39;</span><span>,</span> <span>&#39;clean&#39;</span><span>),</span>
    <span>(</span><span>&#39;mik&#39;</span><span>,</span> <span>&#39;complain&#39;</span><span>),</span>
    <span>(</span><span>&#39;po&#39;</span><span>,</span> <span>&#39;clean&#39;</span><span>),</span>
    <span>(</span><span>&#39;po&#39;</span><span>,</span> <span>&#39;complain&#39;</span><span>),</span>
    <span>(</span><span>&#39;tay&#39;</span><span>,</span> <span>&#39;complain&#39;</span><span>);</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/insert_values.out">out/insert_values.out</a></p>
  <pre><code>|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
| clean     | 0.5      |

| person |    job    |
|--------|-----------|
| mik    | calibrate |
| mik    | clean     |
| mik    | complain  |
| po     | clean     |
| po     | complain  |
| tay    | complain  |
</code></pre>

</section>
<section>

  <h2 id="update-rows">28: update rows</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/update_work_job.sql">src/update_work_job.sql</a></p>
  <div><div><pre><code><span>update</span> <span>work</span>
<span>set</span> <span>person</span> <span>=</span> <span>&#34;tae&#34;</span>
<span>where</span> <span>person</span> <span>=</span> <span>&#34;tay&#34;</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/update_rows.out">out/update_rows.out</a></p>
  <pre><code>| person |    job    |
|--------|-----------|
| mik    | calibrate |
| mik    | clean     |
| mik    | complain  |
| po     | clean     |
| po     | complain  |
| tae    | complain  |
</code></pre>

  <ul>
    <li>(Almost) always specify row(w) to update using <code>where</code>
      <ul>
        <li>Would otherwise update all rows</li>
      </ul>
    </li>
    <li>Useful to give each row a <a href="#g:primary_key">primary key</a> that uniquely identifies it for this purpose
      <ul>
        <li>Will see other uses below</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="delete-rows">29: delete rows</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/delete_rows.sql">src/delete_rows.sql</a></p>
  <div><div><pre><code><span>delete</span> <span>from</span> <span>work</span>
<span>where</span> <span>person</span> <span>=</span> <span>&#34;tae&#34;</span><span>;</span>

<span>select</span> <span>*</span> <span>from</span> <span>work</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/delete_rows.out">out/delete_rows.out</a></p>
  <div><div><pre><code>| person |    job    |
|--------|-----------|
| mik    | calibrate |
| mik    | clean     |
| mik    | complain  |
| po     | clean     |
| po     | complain  |
</code></pre></div>  </div>

  <ul>
    <li>Again, (almost) always specify row(s) to delete using <code>where</code></li>
  </ul>

</section>
<section>

  <h2 id="backing-up">30: backing up</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/backing_up.sql">src/backing_up.sql</a></p>
  <div><div><pre><code><span>create</span> <span>table</span> <span>backup</span> <span>(</span>
    <span>person</span> <span>text</span> <span>not</span> <span>null</span><span>,</span>
    <span>job</span> <span>text</span> <span>not</span> <span>null</span>
<span>);</span>

<span>insert</span> <span>into</span> <span>backup</span>
<span>select</span> <span>person</span><span>,</span> <span>job</span>
<span>from</span> <span>work</span>
<span>where</span> <span>person</span> <span>=</span> <span>&#39;tae&#39;</span><span>;</span>

<span>delete</span> <span>from</span> <span>work</span>
<span>where</span> <span>person</span> <span>=</span> <span>&#39;tae&#39;</span><span>;</span>

<span>select</span> <span>*</span> <span>from</span> <span>backup</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/backing_up.out">out/backing_up.out</a></p>
  <div><div><pre><code>| person |   job    |
|--------|----------|
| tae    | complain |
</code></pre></div>  </div>

</section>
<section>

  <h2 id="check-your-understanding-3">☆ check your understanding</h2>

  <p><img src="https://www.wildlondon.org.uk/sql-tutorial/img/concept_map_datamod.svg" alt="concept map: data definition and modification"/></p>

</section>
<section>

  <h2 id="join-tables">31: join tables</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/cross_join.sql">src/cross_join.sql</a></p>
  <div><div><pre><code><span>select</span> <span>*</span>
<span>from</span> <span>work</span> <span>cross</span> <span>join</span> <span>job</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/cross_join.out">out/cross_join.out</a></p>
  <div><div><pre><code>| person |    job    |   name    | billable |
|--------|-----------|-----------|----------|
| mik    | calibrate | calibrate | 1.5      |
| mik    | calibrate | clean     | 0.5      |
| mik    | clean     | calibrate | 1.5      |
| mik    | clean     | clean     | 0.5      |
| mik    | complain  | calibrate | 1.5      |
| mik    | complain  | clean     | 0.5      |
| po     | clean     | calibrate | 1.5      |
| po     | clean     | clean     | 0.5      |
| po     | complain  | calibrate | 1.5      |
| po     | complain  | clean     | 0.5      |
| tay    | complain  | calibrate | 1.5      |
| tay    | complain  | clean     | 0.5      |
</code></pre></div>  </div>

  <ul>
    <li>A <a href="#g:join">join</a> combines information from two tables</li>
    <li><a href="#g:full_outer_join">full outer join</a> (also called <a href="#g:cross_join">cross join</a>) constructs their cross product
      <ul>
        <li>All combinations of rows from each</li>
      </ul>
    </li>
    <li>Result isn’t particularly useful: <code>job</code> and <code>name</code> don’t match</li>
  </ul>

</section>
<section>

  <h2 id="inner-join">32: inner join</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/inner_join.sql">src/inner_join.sql</a></p>
  <div><div><pre><code><span>select</span> <span>*</span>
<span>from</span> <span>work</span> <span>inner</span> <span>join</span> <span>job</span>
<span>on</span> <span>work</span><span>.</span><span>job</span> <span>=</span> <span>job</span><span>.</span><span>name</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/inner_join.out">out/inner_join.out</a></p>
  <div><div><pre><code>| person |    job    |   name    | billable |
|--------|-----------|-----------|----------|
| mik    | calibrate | calibrate | 1.5      |
| mik    | clean     | clean     | 0.5      |
| po     | clean     | clean     | 0.5      |
</code></pre></div>  </div>

  <ul>
    <li>Use <code><em>table</em>.<em>column</em></code> notation to specify columns
      <ul>
        <li>A column can have the same name as a table</li>
      </ul>
    </li>
    <li>Use <code>on <em>condition</em></code> to specify <a href="#g:join_condition">join condition</a></li>
    <li>Since <code>complain</code> doesn’t appear in <code>job.name</code>, none of those rows are kept</li>
  </ul>

</section>
<section>

  <h2 id="aggregate-joined-data">33: aggregate joined data</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/aggregate_join.sql">src/aggregate_join.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>work</span><span>.</span><span>person</span><span>,</span>
    <span>sum</span><span>(</span><span>job</span><span>.</span><span>billable</span><span>)</span> <span>as</span> <span>pay</span>
<span>from</span> <span>work</span> <span>inner</span> <span>join</span> <span>job</span>
<span>on</span> <span>work</span><span>.</span><span>job</span> <span>=</span> <span>job</span><span>.</span><span>name</span>
<span>group</span> <span>by</span> <span>work</span><span>.</span><span>person</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/aggregate_join.out">out/aggregate_join.out</a></p>
  <div><div><pre><code>| person | pay |
|--------|-----|
| mik    | 2.0 |
| po     | 0.5 |
</code></pre></div>  </div>

  <ul>
    <li>Combines ideas we’ve seen before</li>
    <li>But Tay is missing from the table</li>
  </ul>

</section>
<section>

  <h2 id="left-join">34: left join</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/left_join.sql">src/left_join.sql</a></p>
  <div><div><pre><code><span>select</span> <span>*</span>
<span>from</span> <span>work</span> <span>left</span> <span>join</span> <span>job</span>
<span>on</span> <span>work</span><span>.</span><span>job</span> <span>=</span> <span>job</span><span>.</span><span>name</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/left_join.out">out/left_join.out</a></p>
  <div><div><pre><code>| person |    job    |   name    | billable |
|--------|-----------|-----------|----------|
| mik    | calibrate | calibrate | 1.5      |
| mik    | clean     | clean     | 0.5      |
| mik    | complain  |           |          |
| po     | clean     | clean     | 0.5      |
| po     | complain  |           |          |
| tay    | complain  |           |          |
</code></pre></div>  </div>

  <ul>
    <li>A <a href="#g:left_outer_join">left outer join</a> keeps all rows from the left table</li>
    <li>Fills missing values from right table with null</li>
  </ul>

</section>
<section>

  <h2 id="aggregate-left-joins">35: aggregate left joins</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/aggregate_left_join.sql">src/aggregate_left_join.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>work</span><span>.</span><span>person</span><span>,</span>
    <span>sum</span><span>(</span><span>job</span><span>.</span><span>billable</span><span>)</span> <span>as</span> <span>pay</span>
<span>from</span> <span>work</span> <span>left</span> <span>join</span> <span>job</span>
<span>on</span> <span>work</span><span>.</span><span>job</span> <span>=</span> <span>job</span><span>.</span><span>name</span>
<span>group</span> <span>by</span> <span>work</span><span>.</span><span>person</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/aggregate_left_join.out">out/aggregate_left_join.out</a></p>
  <div><div><pre><code>| person | pay |
|--------|-----|
| mik    | 2.0 |
| po     | 0.5 |
| tay    |     |
</code></pre></div>  </div>

  <ul>
    <li>That’s better, but we’d like to see 0 rather than a blank</li>
  </ul>

</section>
<section>

  <h2 id="check-your-understanding-4">☆ check your understanding</h2>

  <p><img src="https://www.wildlondon.org.uk/sql-tutorial/img/concept_map_join.svg" alt="concept map: join"/></p>

</section>
<section>

  <h2 id="coalesce-values">36: coalesce values</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/coalesce.sql">src/coalesce.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>work</span><span>.</span><span>person</span><span>,</span>
    <span>coalesce</span><span>(</span><span>sum</span><span>(</span><span>job</span><span>.</span><span>billable</span><span>),</span> <span>0</span><span>.</span><span>0</span><span>)</span> <span>as</span> <span>pay</span>
<span>from</span> <span>work</span> <span>left</span> <span>join</span> <span>job</span>
<span>on</span> <span>work</span><span>.</span><span>job</span> <span>=</span> <span>job</span><span>.</span><span>name</span>
<span>group</span> <span>by</span> <span>work</span><span>.</span><span>person</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/coalesce.out">out/coalesce.out</a></p>
  <div><div><pre><code>| person | pay |
|--------|-----|
| mik    | 2.0 |
| po     | 0.5 |
| tay    | 0.0 |
</code></pre></div>  </div>

  <ul>
    <li><code>coalesce(<em>val1</em>, <em>val2</em>, …)</code> returns first non-null value</li>
  </ul>

</section>
<section>

  <h2 id="negate-incorrectly">37: negate incorrectly</h2>

  <ul>
    <li>Who doesn’t calibrate?</li>
  </ul>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/negate_incorrectly.sql">src/negate_incorrectly.sql</a></p>
  <div><div><pre><code><span>select</span> <span>distinct</span> <span>person</span>
<span>from</span> <span>work</span>
<span>where</span> <span>job</span> <span>!=</span> <span>&#39;calibrate&#39;</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/negate_incorrectly.out">out/negate_incorrectly.out</a></p>
  <div><div><pre><code>| person |
|--------|
| mik    |
| po     |
| tay    |
</code></pre></div>  </div>

  <ul>
    <li>But Mik <em>does</em> calibrate</li>
    <li>Problem is that there’s an entry for Mik cleaning</li>
    <li>And since <code>&#39;clean&#39; != &#39;calibrate&#39;</code>, that row is included in the results</li>
    <li>We need a different approach</li>
  </ul>

</section>
<section>

  <h2 id="set-membership">38: set membership</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/set_membership.sql">src/set_membership.sql</a></p>
  <div><div><pre><code><span>select</span> <span>*</span>
<span>from</span> <span>work</span>
<span>where</span> <span>person</span> <span>not</span> <span>in</span> <span>(</span><span>&#39;mik&#39;</span><span>,</span> <span>&#39;tay&#39;</span><span>);</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/set_membership.out">out/set_membership.out</a></p>
  <div><div><pre><code>| person |   job    |
|--------|----------|
| po     | clean    |
| po     | complain |
</code></pre></div>  </div>

  <ul>
    <li><code>in <em>values</em></code> and <code>not in <em>values</em></code> do exactly what you expect</li>
  </ul>

</section>
<section>

  <h2 id="subqueries">39: subqueries</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/subquery_set.sql">src/subquery_set.sql</a></p>
  <div><div><pre><code><span>select</span> <span>distinct</span> <span>person</span>
<span>from</span> <span>work</span>
<span>where</span> <span>person</span> <span>not</span> <span>in</span> <span>(</span>
    <span>select</span> <span>distinct</span> <span>person</span>
    <span>from</span> <span>work</span>
    <span>where</span> <span>job</span> <span>=</span> <span>&#39;calibrate&#39;</span>
<span>);</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/subquery_set.out">out/subquery_set.out</a></p>
  <div><div><pre><code>| person |
|--------|
| po     |
| tay    |
</code></pre></div>  </div>

  <ul>
    <li>Use a <a href="#g:subquery">subquery</a> to select the people who <em>do</em> calibrate</li>
    <li>Then select all the people who aren’t in that set</li>
    <li>Initially feels odd, but subqueries are useful in other ways</li>
  </ul>

</section>
<section>

  <h2 id="m-to-n-relationships">☆ M to N relationships</h2>

  <ul>
    <li>Relationships between entities are usually characterized as:
      <ul>
        <li><a href="#g:1_to_1">1-to-1</a>:
fields in the same record</li>
        <li><a href="#g:1_to_many">1-to-many</a>:
the many have a <a href="#g:foreign_key">foreign key</a> referring to the one’s primary key</li>
        <li><a href="#g:many_to_many">many-to-many</a>:
don’t know how many keys to add to records (“maximum” never is)</li>
      </ul>
    </li>
    <li>Nearly-universal solution is a <a href="#g:join_table">join table</a>
      <ul>
        <li>Each record is a pair of foreign keys</li>
        <li>I.e., each record is the fact that records A and B are related</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="autoincrement-and-primary-key">40: autoincrement and primary key</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/autoincrement.sql">src/autoincrement.sql</a></p>
  <div><div><pre><code><span>create</span> <span>table</span> <span>person</span> <span>(</span>
    <span>ident</span> <span>integer</span> <span>primary</span> <span>key</span> <span>autoincrement</span><span>,</span>
    <span>name</span> <span>text</span> <span>not</span> <span>null</span>
<span>);</span>
<span>insert</span> <span>into</span> <span>person</span> <span>values</span>
    <span>(</span><span>null</span><span>,</span> <span>&#39;mik&#39;</span><span>),</span>
    <span>(</span><span>null</span><span>,</span> <span>&#39;po&#39;</span><span>),</span>
    <span>(</span><span>null</span><span>,</span> <span>&#39;tay&#39;</span><span>);</span>
<span>select</span> <span>*</span> <span>from</span> <span>person</span><span>;</span>
<span>insert</span> <span>into</span> <span>person</span> <span>values</span> <span>(</span><span>1</span><span>,</span> <span>&#34;prevented&#34;</span><span>);</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/autoincrement.out">out/autoincrement.out</a></p>
  <div><div><pre><code>| ident | name |
|-------|------|
| 1     | mik  |
| 2     | po   |
| 3     | tay  |
Runtime error near line 12: UNIQUE constraint failed: person.ident (19)
</code></pre></div>  </div>

  <ul>
    <li>Database <a href="#g:autoincrement">autoincrements</a> <code>ident</code> each time a new record is added</li>
    <li>Use that field as the primary key
      <ul>
        <li>So that if Mik changes their name again,
we only have to change one fact in the database</li>
        <li>Downside: manual queries are harder to read (who is person 17?)</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="internal-tables">☆ internal tables</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/sequence_table.sql">src/sequence_table.sql</a></p>
  <div><div><pre><code><span>select</span> <span>*</span> <span>from</span> <span>sqlite_sequence</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/sequence_table.out">out/sequence_table.out</a></p>
  <div><div><pre><code>|  name  | seq |
|--------|-----|
| person | 3   |
</code></pre></div>  </div>

  <ul>
    <li>Sequence numbers are <em>not</em> reset when rows are deleted</li>
  </ul>

</section>
<section>

  <h2 id="alter-tables">41: alter tables</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/alter_tables.sql">src/alter_tables.sql</a></p>
  <div><div><pre><code><span>alter</span> <span>table</span> <span>job</span>
<span>add</span> <span>ident</span> <span>integer</span> <span>not</span> <span>null</span> <span>default</span> <span>-</span><span>1</span><span>;</span>

<span>update</span> <span>job</span>
<span>set</span> <span>ident</span> <span>=</span> <span>1</span>
<span>where</span> <span>name</span> <span>=</span> <span>&#39;calibrate&#39;</span><span>;</span>

<span>update</span> <span>job</span>
<span>set</span> <span>ident</span> <span>=</span> <span>2</span>
<span>where</span> <span>name</span> <span>=</span> <span>&#39;clean&#39;</span><span>;</span>

<span>select</span> <span>*</span> <span>from</span> <span>job</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/alter_tables.out">out/alter_tables.out</a></p>
  <div><div><pre><code>|   name    | billable | ident |
|-----------|----------|-------|
| calibrate | 1.5      | 1     |
| clean     | 0.5      | 2     |
</code></pre></div>  </div>

  <ul>
    <li>Add a column after the fact</li>
    <li>Since it can’t be null, we have to provide a default value
      <ul>
        <li>Really want to make it the primary key, but SQLite doesn’t allow that (easily) after the fact</li>
      </ul>
    </li>
    <li>Then use <code>update</code> to modify existing records
      <ul>
        <li>Can modify any number of records at once</li>
        <li>So be careful about <code>where</code> clause</li>
      </ul>
    </li>
    <li><a href="#g:data_migration">Data migration</a></li>
  </ul>

</section>
<section>

  <h2 id="create-new-tables-from-old">42: create new tables from old</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/insert_select.sql">src/insert_select.sql</a></p>
  <div><div><pre><code><span>create</span> <span>table</span> <span>new_work</span> <span>(</span>
    <span>person_id</span> <span>integer</span> <span>not</span> <span>null</span><span>,</span>
    <span>job_id</span> <span>integer</span> <span>not</span> <span>null</span><span>,</span>
    <span>foreign</span> <span>key</span><span>(</span><span>person_id</span><span>)</span> <span>references</span> <span>person</span><span>(</span><span>ident</span><span>),</span>
    <span>foreign</span> <span>key</span><span>(</span><span>job_id</span><span>)</span> <span>references</span> <span>job</span><span>(</span><span>ident</span><span>)</span>
<span>);</span>

<span>insert</span> <span>into</span> <span>new_work</span>
<span>select</span>
    <span>person</span><span>.</span><span>ident</span> <span>as</span> <span>person_id</span><span>,</span>
    <span>job</span><span>.</span><span>ident</span> <span>as</span> <span>job_id</span>
<span>from</span>
    <span>(</span><span>person</span> <span>join</span> <span>work</span> <span>on</span> <span>person</span><span>.</span><span>name</span> <span>=</span> <span>work</span><span>.</span><span>person</span><span>)</span>
    <span>join</span> <span>job</span> <span>on</span> <span>job</span><span>.</span><span>name</span> <span>=</span> <span>work</span><span>.</span><span>job</span><span>;</span>
<span>select</span> <span>*</span> <span>from</span> <span>new_work</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/insert_select.out">out/insert_select.out</a></p>
  <div><div><pre><code>| person_id | job_id |
|-----------|--------|
| 1         | 1      |
| 1         | 2      |
| 2         | 2      |
</code></pre></div>  </div>

  <ul>
    <li><code>new_work</code> is our join table</li>
    <li>Each column refers to a record in some other table</li>
  </ul>

</section>
<section>

  <h2 id="remove-tables">43: remove tables</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/drop_table.sql">src/drop_table.sql</a></p>
  <div><div><pre><code><span>drop</span> <span>table</span> <span>work</span><span>;</span>
<span>alter</span> <span>table</span> <span>new_work</span> <span>rename</span> <span>to</span> <span>work</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/drop_table.out">out/drop_table.out</a></p>
  <div><div><pre><code>CREATE TABLE job (
    ident integer primary key autoincrement,
    name text not null,
    billable real not null
);
CREATE TABLE sqlite_sequence(name,seq);
CREATE TABLE person (
    ident integer primary key autoincrement,
    name text not null
);
CREATE TABLE IF NOT EXISTS &#34;work&#34; (
    person_id integer not null,
    job_id integer not null,
    foreign key(person_id) references person(ident),
    foreign key(job_id) references job(ident)
);
</code></pre></div>  </div>

  <ul>
    <li>Remove the old table and rename the new one to take its place
      <ul>
        <li>Note <code>if exists</code></li>
      </ul>
    </li>
    <li>Be careful…</li>
  </ul>

</section>
<section>

  <h2 id="compare-individual-values-to-aggregates">44: compare individual values to aggregates</h2>

  <ul>
    <li>Go back to penguins</li>
  </ul>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/compare_individual_aggregate.sql">src/compare_individual_aggregate.sql</a></p>
  <div><div><pre><code><span>select</span> <span>body_mass_g</span>
<span>from</span> <span>penguins</span>
<span>where</span> <span>body_mass_g</span> <span>&gt;</span> <span>(</span>
    <span>select</span> <span>avg</span><span>(</span><span>body_mass_g</span><span>)</span>
    <span>from</span> <span>penguins</span>
<span>)</span>
<span>limit</span> <span>5</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/compare_individual_aggregate.out">out/compare_individual_aggregate.out</a></p>
  <div><div><pre><code>| body_mass_g |
|-------------|
| 4675        |
| 4250        |
| 4400        |
| 4500        |
| 4650        |
</code></pre></div>  </div>

  <ul>
    <li>Get average body mass in subquery</li>
    <li>Compare each row against that</li>
    <li>Requires two scans of the data, but there’s no way to avoid that</li>
    <li>Null values aren’t included in the average or in the final results</li>
  </ul>

</section>
<section>

  <h2 id="compare-individual-values-to-aggregates-within-groups">45: compare individual values to aggregates within groups</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/compare_within_groups.sql">src/compare_within_groups.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>penguins</span><span>.</span><span>species</span><span>,</span>
    <span>penguins</span><span>.</span><span>body_mass_g</span><span>,</span>
    <span>round</span><span>(</span><span>averaged</span><span>.</span><span>avg_mass_g</span><span>,</span> <span>1</span><span>)</span> <span>as</span> <span>avg_mass_g</span>
<span>from</span> <span>penguins</span> <span>join</span> <span>(</span>
    <span>select</span> <span>species</span><span>,</span> <span>avg</span><span>(</span><span>body_mass_g</span><span>)</span> <span>as</span> <span>avg_mass_g</span>
    <span>from</span> <span>penguins</span>
    <span>group</span> <span>by</span> <span>species</span>
<span>)</span> <span>as</span> <span>averaged</span>
<span>on</span> <span>penguins</span><span>.</span><span>species</span> <span>=</span> <span>averaged</span><span>.</span><span>species</span>
<span>where</span> <span>penguins</span><span>.</span><span>body_mass_g</span> <span>&gt;</span> <span>averaged</span><span>.</span><span>avg_mass_g</span>
<span>limit</span> <span>5</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/compare_within_groups.out">out/compare_within_groups.out</a></p>
  <div><div><pre><code>| species | body_mass_g | avg_mass_g |
|---------|-------------|------------|
| Adelie  | 3750        | 3700.7     |
| Adelie  | 3800        | 3700.7     |
| Adelie  | 4675        | 3700.7     |
| Adelie  | 4250        | 3700.7     |
| Adelie  | 3800        | 3700.7     |
</code></pre></div>  </div>

  <ul>
    <li>Subquery runs first to create temporary table <code>averaged</code> with average mass per species</li>
    <li>Join that with <code>penguins</code></li>
    <li>Filter to find penguins heavier than average within their species</li>
  </ul>

</section>
<section>

  <h2 id="common-table-expressions">46: common table expressions</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/common_table_expressions.sql">src/common_table_expressions.sql</a></p>
  <div><div><pre><code><span>with</span> <span>grouped</span> <span>as</span> <span>(</span>
    <span>select</span> <span>species</span><span>,</span> <span>avg</span><span>(</span><span>body_mass_g</span><span>)</span> <span>as</span> <span>avg_mass_g</span>
    <span>from</span> <span>penguins</span>
    <span>group</span> <span>by</span> <span>species</span>
<span>)</span>
<span>select</span>
    <span>penguins</span><span>.</span><span>species</span><span>,</span>
    <span>penguins</span><span>.</span><span>body_mass_g</span><span>,</span>
    <span>round</span><span>(</span><span>grouped</span><span>.</span><span>avg_mass_g</span><span>,</span> <span>1</span><span>)</span> <span>as</span> <span>avg_mass_g</span>
<span>from</span> <span>penguins</span> <span>join</span> <span>grouped</span>
<span>where</span> <span>penguins</span><span>.</span><span>body_mass_g</span> <span>&gt;</span> <span>grouped</span><span>.</span><span>avg_mass_g</span>
<span>limit</span> <span>5</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/common_table_expressions.out">out/common_table_expressions.out</a></p>
  <div><div><pre><code>| species | body_mass_g | avg_mass_g |
|---------|-------------|------------|
| Adelie  | 3750        | 3700.7     |
| Adelie  | 3800        | 3700.7     |
| Adelie  | 4675        | 3700.7     |
| Adelie  | 4250        | 3700.7     |
| Adelie  | 3800        | 3700.7     |
</code></pre></div>  </div>

  <ul>
    <li>Use <a href="#g:cte">common table expression</a> (CTE) to make queries clearer
      <ul>
        <li>Nested subqueries quickly become difficult to understand</li>
      </ul>
    </li>
    <li>Database decides how to optimize</li>
  </ul>

</section>
<section>

  <h2 id="explain-query-plan">☆ explain query plan</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/explain_query_plan.sql">src/explain_query_plan.sql</a></p>
  <div><div><pre><code><span>explain</span> <span>query</span> <span>plan</span>
<span>select</span>
    <span>species</span><span>,</span>
    <span>avg</span><span>(</span><span>body_mass_g</span><span>)</span>
<span>from</span> <span>penguins</span>
<span>group</span> <span>by</span> <span>species</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/explain_query_plan.out">out/explain_query_plan.out</a></p>
  <div><div><pre><code>QUERY PLAN
|--SCAN penguins
`--USE TEMP B-TREE FOR GROUP BY
</code></pre></div>  </div>

  <ul>
    <li>SQLite plans to scan every row of the table</li>
    <li>It will build a temporary B-tree data structure to group rows</li>
  </ul>

</section>
<section>

  <h2 id="enumerate-rows">47: enumerate rows</h2>

  <ul>
    <li>Every table has a special column called <code>rowid</code></li>
  </ul>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/rowid.sql">src/rowid.sql</a></p>
  <div><div><pre><code><span>select</span> <span>rowid</span><span>,</span> <span>species</span><span>,</span> <span>island</span>
<span>from</span> <span>penguins</span>
<span>limit</span> <span>5</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/rowid.out">out/rowid.out</a></p>
  <div><div><pre><code>| rowid | species |  island   |
|-------|---------|-----------|
| 1     | Adelie  | Torgersen |
| 2     | Adelie  | Torgersen |
| 3     | Adelie  | Torgersen |
| 4     | Adelie  | Torgersen |
| 5     | Adelie  | Torgersen |
</code></pre></div>  </div>

  <ul>
    <li><code>rowid</code> is persistent within a session
      <ul>
        <li>I.e., if we delete the first 5 rows we now have row IDs 6…N</li>
      </ul>
    </li>
    <li><em>Do not rely on row ID</em>
      <ul>
        <li>In particular, do not use it as a key</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="if-else-function">48: if-else function</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/if_else.sql">src/if_else.sql</a></p>
  <div><div><pre><code><span>with</span> <span>sized_penguins</span> <span>as</span> <span>(</span>
    <span>select</span>
        <span>species</span><span>,</span>
        <span>iif</span><span>(</span>
            <span>body_mass_g</span> <span>&lt;</span> <span>3500</span><span>,</span>
            <span>&#39;small&#39;</span><span>,</span>
            <span>&#39;large&#39;</span>
        <span>)</span> <span>as</span> <span>size</span>
    <span>from</span> <span>penguins</span>
<span>)</span>
<span>select</span> <span>species</span><span>,</span> <span>size</span><span>,</span> <span>count</span><span>(</span><span>*</span><span>)</span> <span>as</span> <span>num</span>
<span>from</span> <span>sized_penguins</span>
<span>group</span> <span>by</span> <span>species</span><span>,</span> <span>size</span>
<span>order</span> <span>by</span> <span>species</span><span>,</span> <span>num</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/if_else.out">out/if_else.out</a></p>
  <div><div><pre><code>|  species  | size  | num |
|-----------|-------|-----|
| Adelie    | small | 54  |
| Adelie    | large | 98  |
| Chinstrap | small | 17  |
| Chinstrap | large | 51  |
| Gentoo    | large | 124 |
</code></pre></div>  </div>

  <ul>
    <li><code>iif(<em>condition</em>, <em>true_result</em>, <em>false_result</em>)</code>
      <ul>
        <li>Note: <code>iif</code> with two i’s</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="select-a-case">49: select a case</h2>

  <ul>
    <li>What if we want small, medium, and large?</li>
    <li>Can nest <code>iif</code>, but quickly becomes unreadable</li>
  </ul>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/case_when.sql">src/case_when.sql</a></p>
  <div><div><pre><code><span>with</span> <span>sized_penguins</span> <span>as</span> <span>(</span>
    <span>select</span>
        <span>species</span><span>,</span>
        <span>case</span>
            <span>when</span> <span>body_mass_g</span> <span>&lt;</span> <span>3500</span> <span>then</span> <span>&#39;small&#39;</span>
            <span>when</span> <span>body_mass_g</span> <span>&lt;</span> <span>5000</span> <span>then</span> <span>&#39;medium&#39;</span>
            <span>else</span> <span>&#39;large&#39;</span>
        <span>end</span> <span>as</span> <span>size</span>
    <span>from</span> <span>penguins</span>
<span>)</span>
<span>select</span> <span>species</span><span>,</span> <span>size</span><span>,</span> <span>count</span><span>(</span><span>*</span><span>)</span> <span>as</span> <span>num</span>
<span>from</span> <span>sized_penguins</span>
<span>group</span> <span>by</span> <span>species</span><span>,</span> <span>size</span>
<span>order</span> <span>by</span> <span>species</span><span>,</span> <span>num</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/case_when.out">out/case_when.out</a></p>
  <div><div><pre><code>|  species  |  size  | num |
|-----------|--------|-----|
| Adelie    | large  | 1   |
| Adelie    | small  | 54  |
| Adelie    | medium | 97  |
| Chinstrap | small  | 17  |
| Chinstrap | medium | 51  |
| Gentoo    | medium | 56  |
| Gentoo    | large  | 68  |
</code></pre></div>  </div>

  <ul>
    <li>Evaluate <code>when</code> options in order and take first</li>
    <li>Result of <code>case</code> is null if no condition is true</li>
    <li>Use <code>else</code> as fallback</li>
  </ul>

</section>
<section>

  <h2 id="check-range">50: check range</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/check_range.sql">src/check_range.sql</a></p>
  <div><div><pre><code><span>with</span> <span>sized_penguins</span> <span>as</span> <span>(</span>
    <span>select</span>
        <span>species</span><span>,</span>
        <span>case</span>
            <span>when</span> <span>body_mass_g</span> <span>between</span> <span>3500</span> <span>and</span> <span>5000</span> <span>then</span> <span>&#39;normal&#39;</span>
            <span>else</span> <span>&#39;abnormal&#39;</span>
        <span>end</span> <span>as</span> <span>size</span>
    <span>from</span> <span>penguins</span>
<span>)</span>
<span>select</span> <span>species</span><span>,</span> <span>size</span><span>,</span> <span>count</span><span>(</span><span>*</span><span>)</span> <span>as</span> <span>num</span>
<span>from</span> <span>sized_penguins</span>
<span>group</span> <span>by</span> <span>species</span><span>,</span> <span>size</span>
<span>order</span> <span>by</span> <span>species</span><span>,</span> <span>num</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/check_range.out">out/check_range.out</a></p>
  <div><div><pre><code>|  species  |   size   | num |
|-----------|----------|-----|
| Adelie    | abnormal | 55  |
| Adelie    | normal   | 97  |
| Chinstrap | abnormal | 17  |
| Chinstrap | normal   | 51  |
| Gentoo    | abnormal | 62  |
| Gentoo    | normal   | 62  |
</code></pre></div>  </div>

  <ul>
    <li><code>between</code> can make queries easier to read</li>
    <li>But be careful of the <code>and</code> in the middle</li>
  </ul>

</section>
<section>

  <h2 id="yet-another-database">☆ yet another database</h2>

  <ul>
    <li><a href="#g:er_diagram">Entity-relationship diagram</a> (ER diagram) shows relationships between tables</li>
    <li>Like everything to do with databases, there are lots of variations</li>
  </ul>

  <p><img src="https://www.wildlondon.org.uk/sql-tutorial/img/assays_tables.svg" alt="assay database table diagram"/></p>

  <p><img src="https://www.wildlondon.org.uk/sql-tutorial/img/assays_er.svg" alt="assay ER diagram"/></p>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/assay_staff.sql">src/assay_staff.sql</a></p>
  

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/assay_staff.out">out/assay_staff.out</a></p>
  <div><div><pre><code>| ident | personal |  family   | dept | age |
|-------|----------|-----------|------|-----|
| 1     | Kartik   | Gupta     |      | 46  |
| 2     | Divit    | Dhaliwal  | hist | 34  |
| 3     | Indrans  | Sridhar   | mb   | 47  |
| 4     | Pranay   | Khanna    | mb   | 51  |
| 5     | Riaan    | Dua       |      | 23  |
| 6     | Vedika   | Rout      | hist | 45  |
| 7     | Abram    | Chokshi   | gen  | 23  |
| 8     | Romil    | Kapoor    | hist | 38  |
| 9     | Ishaan   | Ramaswamy | mb   | 35  |
| 10    | Nitya    | Lal       | gen  | 52  |
</code></pre></div>  </div>

</section>
<section>

  <h2 id="pattern-matching">51: pattern matching</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/like_glob.sql">src/like_glob.sql</a></p>
  <div><div><pre><code><span>select</span> <span>personal</span><span>,</span> <span>family</span> <span>from</span> <span>staff</span>
<span>where</span> <span>personal</span> <span>like</span> <span>&#39;%ya%&#39;</span> <span>or</span> <span>family</span> <span>glob</span> <span>&#39;*De*&#39;</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/like_glob.out">out/like_glob.out</a></p>
  <div><div><pre><code>| personal | family |
|----------|--------|
| Nitya    | Lal    |
</code></pre></div>  </div>

  <ul>
    <li><code>like</code> is the original SQL pattern matcher
      <ul>
        <li><code>%</code> matches zero or more characters at the start or end of a string</li>
        <li>Case insensitive by default</li>
      </ul>
    </li>
    <li><code>glob</code> supports Unix-style wildcards</li>
  </ul>

  <table>
    <thead>
      <tr>
        <th>name</th>
        <th>purpose</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>substr</code></td>
        <td>Get substring given starting point and length</td>
      </tr>
      <tr>
        <td><code>trim</code></td>
        <td>Remove characters from beginning and end of string</td>
      </tr>
      <tr>
        <td><code>ltrim</code></td>
        <td>Remove characters from beginning of string</td>
      </tr>
      <tr>
        <td><code>rtrim</code></td>
        <td>Remove characters from end of string</td>
      </tr>
      <tr>
        <td><code>length</code></td>
        <td>Length of string</td>
      </tr>
      <tr>
        <td><code>replace</code></td>
        <td>Replace occurrences of substring with another string</td>
      </tr>
      <tr>
        <td><code>upper</code></td>
        <td>Return upper-case version of string</td>
      </tr>
      <tr>
        <td><code>lower</code></td>
        <td>Return lower-case version of string</td>
      </tr>
      <tr>
        <td><code>instr</code></td>
        <td>Find location of first occurrence of substring (returns 0 if not found)</td>
      </tr>
    </tbody>
  </table>

</section>
<section>

  <h2 id="select-first-and-last-rows">52: select first and last rows</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/union_all.sql">src/union_all.sql</a></p>
  <div><div><pre><code><span>select</span> <span>*</span> <span>from</span> <span>(</span>
    <span>select</span> <span>*</span> <span>from</span> <span>(</span><span>select</span> <span>*</span> <span>from</span> <span>experiment</span> <span>order</span> <span>by</span> <span>started</span> <span>asc</span> <span>limit</span> <span>5</span><span>)</span>
    <span>union</span> <span>all</span>
    <span>select</span> <span>*</span> <span>from</span> <span>(</span><span>select</span> <span>*</span> <span>from</span> <span>experiment</span> <span>order</span> <span>by</span> <span>started</span> <span>desc</span> <span>limit</span> <span>5</span><span>)</span>
<span>)</span>
<span>order</span> <span>by</span> <span>started</span> <span>asc</span>
<span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/union_all.out">out/union_all.out</a></p>
  <div><div><pre><code>| ident |    kind     |  started   |   ended    |
|-------|-------------|------------|------------|
| 17    | trial       | 2023-01-29 | 2023-01-30 |
| 35    | calibration | 2023-01-30 | 2023-01-30 |
| 36    | trial       | 2023-02-02 | 2023-02-03 |
| 25    | trial       | 2023-02-12 | 2023-02-14 |
| 2     | calibration | 2023-02-14 | 2023-02-14 |
| 40    | calibration | 2024-01-21 | 2024-01-21 |
| 12    | trial       | 2024-01-26 | 2024-01-28 |
| 44    | trial       | 2024-01-27 | 2024-01-29 |
| 34    | trial       | 2024-02-01 | 2024-02-02 |
| 14    | calibration | 2024-02-03 | 2024-02-03 |
</code></pre></div>  </div>

  <ul>
    <li><code>union all</code> combines records
      <ul>
        <li>Keeps duplicates: <code>union</code> on its own keeps unique records</li>
      </ul>
    </li>
    <li>Yes, it feels like the extra <code>select * from</code> should be unnecessary</li>
  </ul>

</section>
<section>

  <h2 id="intersection">53: intersection</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/intersect.sql">src/intersect.sql</a></p>
  <div><div><pre><code><span>select</span> <span>personal</span><span>,</span> <span>family</span><span>,</span> <span>dept</span><span>,</span> <span>age</span>
<span>from</span> <span>staff</span>
<span>where</span> <span>dept</span> <span>=</span> <span>&#39;mb&#39;</span>
<span>intersect</span>
    <span>select</span> <span>personal</span><span>,</span> <span>family</span><span>,</span> <span>dept</span><span>,</span> <span>age</span> <span>from</span> <span>staff</span>
    <span>where</span> <span>age</span> <span>&lt;</span> <span>50</span>
<span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/intersect.out">out/intersect.out</a></p>
  <div><div><pre><code>| personal |  family   | dept | age |
|----------|-----------|------|-----|
| Indrans  | Sridhar   | mb   | 47  |
| Ishaan   | Ramaswamy | mb   | 35  |
</code></pre></div>  </div>

  <ul>
    <li>Tables being intersected must have same structure</li>
    <li>Intersection usually used when pulling values from different tables
      <ul>
        <li>In this case, would be clearer to use <code>where</code></li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="exclusion">54: exclusion</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/except.sql">src/except.sql</a></p>
  <div><div><pre><code><span>select</span> <span>personal</span><span>,</span> <span>family</span><span>,</span> <span>dept</span><span>,</span> <span>age</span>
<span>from</span> <span>staff</span>
<span>where</span> <span>dept</span> <span>=</span> <span>&#39;mb&#39;</span>
<span>except</span>
    <span>select</span> <span>personal</span><span>,</span> <span>family</span><span>,</span> <span>dept</span><span>,</span> <span>age</span> <span>from</span> <span>staff</span>
    <span>where</span> <span>age</span> <span>&lt;</span> <span>50</span>
<span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/except.out">out/except.out</a></p>
  <div><div><pre><code>| personal | family | dept | age |
|----------|--------|------|-----|
| Pranay   | Khanna | mb   | 51  |
</code></pre></div>  </div>

  <ul>
    <li>Again, tables must have same structure
      <ul>
        <li>And this would be clearer with <code>where</code></li>
      </ul>
    </li>
    <li>SQL operates on sets, not tables, except where it doesn’t</li>
  </ul>

</section>
<section>

  <h2 id="random-numbers-and-why-not">55: random numbers and why not</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/random_numbers.sql">src/random_numbers.sql</a></p>
  <div><div><pre><code><span>with</span> <span>decorated</span> <span>as</span> <span>(</span>
    <span>select</span> <span>random</span><span>()</span> <span>as</span> <span>rand</span><span>,</span>
    <span>personal</span> <span>||</span> <span>&#39; &#39;</span> <span>||</span> <span>family</span> <span>as</span> <span>name</span>
    <span>from</span> <span>staff</span>
<span>)</span>
<span>select</span> <span>rand</span><span>,</span> <span>abs</span><span>(</span><span>rand</span><span>)</span> <span>%</span> <span>10</span> <span>as</span> <span>selector</span><span>,</span> <span>name</span>
<span>from</span> <span>decorated</span>
<span>where</span> <span>selector</span> <span>&lt;</span> <span>5</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/random_numbers.out">out/random_numbers.out</a></p>
  <div><div><pre><code>|         rand         | selector |      name       |
|----------------------|----------|-----------------|
| 7176652035743196310  | 0        | Divit Dhaliwal  |
| -2243654635505630380 | 2        | Indrans Sridhar |
| -6940074802089166303 | 5        | Pranay Khanna   |
| 8882650891091088193  | 9        | Riaan Dua       |
| -45079732302991538   | 5        | Vedika Rout     |
| -8973877087806386134 | 2        | Abram Chokshi   |
| 3360598450426870356  | 9        | Romil Kapoor    |
</code></pre></div>  </div>

  <ul>
    <li>There is no way to seed SQLite’s random number generator</li>
    <li>Which means there is no way to reproduce one of its “random” sequences</li>
  </ul>

</section>
<section>

  <h2 id="creating-index">56: creating index</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/create_use_index.sql">src/create_use_index.sql</a></p>
  <div><div><pre><code><span>explain</span> <span>query</span> <span>plan</span>
<span>select</span> <span>filename</span>
<span>from</span> <span>plate</span>
<span>where</span> <span>filename</span> <span>like</span> <span>&#39;%07%&#39;</span><span>;</span>

<span>create</span> <span>index</span> <span>plate_file</span> <span>on</span> <span>plate</span><span>(</span><span>filename</span><span>);</span>

<span>explain</span> <span>query</span> <span>plan</span>
<span>select</span> <span>filename</span>
<span>from</span> <span>plate</span>
<span>where</span> <span>filename</span> <span>like</span> <span>&#39;%07%&#39;</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/create_use_index.out">out/create_use_index.out</a></p>
  <div><div><pre><code>QUERY PLAN
`--SCAN plate USING COVERING INDEX sqlite_autoindex_plate_1
QUERY PLAN
`--SCAN plate USING COVERING INDEX plate_file
</code></pre></div>  </div>

  <ul>
    <li>An <a href="#g:index">index</a> is an auxiliary data structure that enables faster access to records
      <ul>
        <li>Spend storage space to buy speed</li>
      </ul>
    </li>
    <li>Don’t have to mention it explicitly in queries
      <ul>
        <li>Database manager will use it automatically</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="generate-sequence">57: generate sequence</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/generate_sequence.sql">src/generate_sequence.sql</a></p>
  <div><div><pre><code><span>select</span> <span>value</span> <span>from</span> <span>generate_series</span><span>(</span><span>1</span><span>,</span> <span>5</span><span>);</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/generate_sequence.out">out/generate_sequence.out</a></p>
  <div><div><pre><code>| value |
|-------|
| 1     |
| 2     |
| 3     |
| 4     |
| 5     |
</code></pre></div>  </div>

  <ul>
    <li>A (non-standard) <a href="#g:table_valued_func">table-valued function</a></li>
  </ul>

</section>
<section>

  <h2 id="generate-sequence-based-on-data">58: generate sequence based on data</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/data_range_sequence.sql">src/data_range_sequence.sql</a></p>
  <div><div><pre><code><span>create</span> <span>table</span> <span>temp</span> <span>(</span>
    <span>num</span> <span>integer</span> <span>not</span> <span>null</span>
<span>);</span>
<span>insert</span> <span>into</span> <span>temp</span> <span>values</span> <span>(</span><span>1</span><span>),</span> <span>(</span><span>5</span><span>);</span>
<span>select</span> <span>value</span> <span>from</span> <span>generate_series</span> <span>(</span>
    <span>(</span><span>select</span> <span>min</span><span>(</span><span>num</span><span>)</span> <span>from</span> <span>temp</span><span>),</span>
    <span>(</span><span>select</span> <span>max</span><span>(</span><span>num</span><span>)</span> <span>from</span> <span>temp</span><span>)</span>
<span>);</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/data_range_sequence.out">out/data_range_sequence.out</a></p>
  <div><div><pre><code>| value |
|-------|
| 1     |
| 2     |
| 3     |
| 4     |
| 5     |
</code></pre></div>  </div>

  <ul>
    <li>Must have the parentheses around the <code>min</code> and <code>max</code> selections to keep SQLite happy</li>
  </ul>

</section>
<section>

  <h2 id="generate-sequence-of-dates">59: generate sequence of dates</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/date_sequence.sql">src/date_sequence.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>date</span><span>((</span><span>select</span> <span>julianday</span><span>(</span><span>min</span><span>(</span><span>started</span><span>))</span> <span>from</span> <span>experiment</span><span>)</span> <span>+</span> <span>value</span><span>)</span> <span>as</span> <span>some_day</span>
<span>from</span> <span>(</span>
    <span>select</span> <span>value</span> <span>from</span> <span>generate_series</span><span>(</span>
        <span>(</span><span>select</span> <span>0</span><span>),</span>
        <span>(</span><span>select</span> <span>count</span><span>(</span><span>*</span><span>)</span> <span>-</span> <span>1</span> <span>from</span> <span>experiment</span><span>)</span>
    <span>)</span>
<span>)</span>
<span>limit</span> <span>5</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/date_sequence.out">out/date_sequence.out</a></p>
  <div><div><pre><code>|  some_day  |
|------------|
| 2023-01-29 |
| 2023-01-30 |
| 2023-01-31 |
| 2023-02-01 |
| 2023-02-02 |
</code></pre></div>  </div>

  <ul>
    <li>SQLite represents dates as YYYY-MM-DD strings
or as Julian days or as Unix milliseconds or…
      <ul>
        <li>Julian days is fractional number of days since November 24, 4714 BCE</li>
      </ul>
    </li>
    <li><code>julianday</code> and <code>date</code> convert back and forth</li>
  </ul>

</section>
<section>

  <h2 id="count-experiments-started-per-day-without-gaps">60: count experiments started per day without gaps</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/experiments_per_day.sql">src/experiments_per_day.sql</a></p>
  <div><div><pre><code><span>with</span>
<span>-- complete sequence of days with 0 as placeholder for number of experiments</span>
<span>all_days</span> <span>as</span> <span>(</span>
    <span>select</span>
        <span>date</span><span>((</span><span>select</span> <span>julianday</span><span>(</span><span>min</span><span>(</span><span>started</span><span>))</span> <span>from</span> <span>experiment</span><span>)</span> <span>+</span> <span>value</span><span>)</span> <span>as</span> <span>some_day</span><span>,</span>
        <span>0</span> <span>as</span> <span>zeroes</span>
    <span>from</span> <span>(</span>
        <span>select</span> <span>value</span> <span>from</span> <span>generate_series</span><span>(</span>
            <span>(</span><span>select</span> <span>0</span><span>),</span>
            <span>(</span><span>select</span> <span>count</span><span>(</span><span>*</span><span>)</span> <span>-</span> <span>1</span> <span>from</span> <span>experiment</span><span>)</span>
        <span>)</span>
    <span>)</span>
<span>),</span>
<span>-- sequence of actual days with actual number of experiments started</span>
<span>actual_days</span> <span>as</span> <span>(</span>
    <span>select</span> <span>started</span><span>,</span> <span>count</span><span>(</span><span>started</span><span>)</span> <span>as</span> <span>num_exp</span>
    <span>from</span> <span>experiment</span>
    <span>group</span> <span>by</span> <span>started</span>
<span>)</span>
<span>-- combined by joining on day and taking actual number (if available) or zero</span>
<span>select</span>
    <span>all_days</span><span>.</span><span>some_day</span> <span>as</span> <span>day</span><span>,</span>
    <span>coalesce</span><span>(</span><span>actual_days</span><span>.</span><span>num_exp</span><span>,</span> <span>all_days</span><span>.</span><span>zeroes</span><span>)</span> <span>as</span> <span>num_exp</span>
<span>from</span>
    <span>all_days</span> <span>left</span> <span>join</span> <span>actual_days</span> <span>on</span> <span>all_days</span><span>.</span><span>some_day</span> <span>=</span> <span>actual_days</span><span>.</span><span>started</span>
<span>limit</span> <span>5</span>
<span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/experiments_per_day.out">out/experiments_per_day.out</a></p>
  <div><div><pre><code>|    day     | num_exp |
|------------|---------|
| 2023-01-29 | 1       |
| 2023-01-30 | 1       |
| 2023-01-31 | 0       |
| 2023-02-01 | 0       |
| 2023-02-02 | 1       |
</code></pre></div>  </div>

</section>
<section>

  <h2 id="self-join">61: self join</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/self_join.sql">src/self_join.sql</a></p>
  <div><div><pre><code><span>with</span> <span>person</span> <span>as</span> <span>(</span>
    <span>select</span>
        <span>ident</span><span>,</span>
        <span>personal</span> <span>||</span> <span>&#39; &#39;</span> <span>||</span> <span>family</span> <span>as</span> <span>name</span>
    <span>from</span> <span>staff</span>
<span>)</span>
<span>select</span> <span>left</span><span>.</span><span>name</span><span>,</span> <span>right</span><span>.</span><span>name</span>
<span>from</span> <span>person</span> <span>as</span> <span>left</span> <span>join</span> <span>person</span> <span>as</span> <span>right</span>
<span>limit</span> <span>10</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/self_join.out">out/self_join.out</a></p>
  <div><div><pre><code>|     name     |       name       |
|--------------|------------------|
| Kartik Gupta | Kartik Gupta     |
| Kartik Gupta | Divit Dhaliwal   |
| Kartik Gupta | Indrans Sridhar  |
| Kartik Gupta | Pranay Khanna    |
| Kartik Gupta | Riaan Dua        |
| Kartik Gupta | Vedika Rout      |
| Kartik Gupta | Abram Chokshi    |
| Kartik Gupta | Romil Kapoor     |
| Kartik Gupta | Ishaan Ramaswamy |
| Kartik Gupta | Nitya Lal        |
</code></pre></div>  </div>

  <ul>
    <li>Join a table to itself
      <ul>
        <li>Use <code>as</code> to create <a href="#g:alias">aliases</a> for copies of tables to distinguish them</li>
        <li>Nothing special about the names <code>left</code> and <code>right</code></li>
      </ul>
    </li>
    <li>Get all <math>n</math><sup>2</sup> pairs, including person with themself</li>
  </ul>

</section>
<section>

  <h2 id="generate-unique-pairs">62: generate unique pairs</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/unique_pairs.sql">src/unique_pairs.sql</a></p>
  <div><div><pre><code><span>with</span> <span>person</span> <span>as</span> <span>(</span>
    <span>select</span>
        <span>ident</span><span>,</span>
        <span>personal</span> <span>||</span> <span>&#39; &#39;</span> <span>||</span> <span>family</span> <span>as</span> <span>name</span>
    <span>from</span> <span>staff</span>
<span>)</span>
<span>select</span> <span>left</span><span>.</span><span>name</span><span>,</span> <span>right</span><span>.</span><span>name</span>
<span>from</span> <span>person</span> <span>as</span> <span>left</span> <span>join</span> <span>person</span> <span>as</span> <span>right</span>
<span>on</span> <span>left</span><span>.</span><span>ident</span> <span>&lt;</span> <span>right</span><span>.</span><span>ident</span>
<span>where</span> <span>left</span><span>.</span><span>ident</span> <span>&lt;=</span> <span>4</span> <span>and</span> <span>right</span><span>.</span><span>ident</span> <span>&lt;=</span> <span>4</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/unique_pairs.out">out/unique_pairs.out</a></p>
  <div><div><pre><code>|      name       |      name       |
|-----------------|-----------------|
| Kartik Gupta    | Divit Dhaliwal  |
| Kartik Gupta    | Indrans Sridhar |
| Kartik Gupta    | Pranay Khanna   |
| Divit Dhaliwal  | Indrans Sridhar |
| Divit Dhaliwal  | Pranay Khanna   |
| Indrans Sridhar | Pranay Khanna   |
</code></pre></div>  </div>

  <ul>
    <li><code>left.ident &lt; right.ident</code> ensures distinct pairs without duplicates</li>
    <li>Use <code>left.ident &lt;= 4 and right.ident &lt;= 4</code> to limit output</li>
    <li>Quick check: <math>n(n-1)/2</math> pairs</li>
  </ul>

</section>
<section>

  <h2 id="filter-pairs">63: filter pairs</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/filter_pairs.sql">src/filter_pairs.sql</a></p>
  <div><div><pre><code><span>with</span>
<span>person</span> <span>as</span> <span>(</span>
    <span>select</span>
        <span>ident</span><span>,</span>
        <span>personal</span> <span>||</span> <span>&#39; &#39;</span> <span>||</span> <span>family</span> <span>as</span> <span>name</span>
    <span>from</span> <span>staff</span>
<span>),</span>
<span>together</span> <span>as</span> <span>(</span>
    <span>select</span>
        <span>left</span><span>.</span><span>staff</span> <span>as</span> <span>left_staff</span><span>,</span>
        <span>right</span><span>.</span><span>staff</span> <span>as</span> <span>right_staff</span>
    <span>from</span> <span>performed</span> <span>as</span> <span>left</span> <span>join</span> <span>performed</span> <span>as</span> <span>right</span>
    <span>on</span> <span>left</span><span>.</span><span>experiment</span> <span>=</span> <span>right</span><span>.</span><span>experiment</span>
    <span>where</span> <span>left_staff</span> <span>&lt;</span> <span>right_staff</span>
<span>)</span>
<span>select</span>
    <span>left</span><span>.</span><span>name</span> <span>as</span> <span>person_1</span><span>,</span>
    <span>right</span><span>.</span><span>name</span> <span>as</span> <span>person_2</span>
<span>from</span> <span>person</span> <span>as</span> <span>left</span> <span>join</span> <span>person</span> <span>as</span> <span>right</span> <span>join</span> <span>together</span>
<span>on</span> <span>left</span><span>.</span><span>ident</span> <span>=</span> <span>left_staff</span> <span>and</span> <span>right</span><span>.</span><span>ident</span> <span>=</span> <span>right_staff</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/filter_pairs.out">out/filter_pairs.out</a></p>
  <div><div><pre><code>|    person_1     |     person_2     |
|-----------------|------------------|
| Kartik Gupta    | Vedika Rout      |
| Pranay Khanna   | Vedika Rout      |
| Indrans Sridhar | Romil Kapoor     |
| Abram Chokshi   | Ishaan Ramaswamy |
| Pranay Khanna   | Vedika Rout      |
| Kartik Gupta    | Abram Chokshi    |
| Abram Chokshi   | Romil Kapoor     |
| Kartik Gupta    | Divit Dhaliwal   |
| Divit Dhaliwal  | Abram Chokshi    |
| Pranay Khanna   | Ishaan Ramaswamy |
| Indrans Sridhar | Romil Kapoor     |
| Kartik Gupta    | Ishaan Ramaswamy |
| Kartik Gupta    | Nitya Lal        |
| Kartik Gupta    | Abram Chokshi    |
| Pranay Khanna   | Romil Kapoor     |
</code></pre></div>  </div>

</section>
<section>

  

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/correlated_subquery.sql">src/correlated_subquery.sql</a></p>
  <div><div><pre><code><span>select</span> <span>name</span><span>,</span> <span>building</span>
<span>from</span> <span>department</span>
<span>where</span> <span>exists</span> <span>(</span>
    <span>select</span> <span>1</span>
    <span>from</span> <span>staff</span>
    <span>where</span> <span>dept</span> <span>=</span> <span>department</span><span>.</span><span>ident</span>
<span>)</span>
<span>order</span> <span>by</span> <span>name</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/correlated_subquery.out">out/correlated_subquery.out</a></p>
  <div><div><pre><code>|       name        |     building     |
|-------------------|------------------|
| Genetics          | Chesson          |
| Histology         | Fashet Extension |
| Molecular Biology | Chesson          |
</code></pre></div>  </div>

  <ul>
    <li>Nobody works in Endocrinology</li>
    <li><code>select 1</code> could equally be <code>select true</code> or any other value</li>
    <li>A <a href="#g:correlated_subquery">correlated subquery</a> depends on a value from the outer query
      <ul>
        <li>Equivalent to nested loop</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="nonexistence">65: nonexistence</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/nonexistence.sql">src/nonexistence.sql</a></p>
  <div><div><pre><code><span>select</span> <span>name</span><span>,</span> <span>building</span>
<span>from</span> <span>department</span>
<span>where</span> <span>not</span> <span>exists</span> <span>(</span>
    <span>select</span> <span>1</span>
    <span>from</span> <span>staff</span>
    <span>where</span> <span>dept</span> <span>=</span> <span>department</span><span>.</span><span>ident</span>
<span>)</span>
<span>order</span> <span>by</span> <span>name</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/nonexistence.out">out/nonexistence.out</a></p>
  <div><div><pre><code>|     name      | building |
|---------------|----------|
| Endocrinology | TGVH     |
</code></pre></div>  </div>

</section>
<section>

  

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/avoid_correlated_subqueries.sql">src/avoid_correlated_subqueries.sql</a></p>
  <div><div><pre><code><span>select</span> <span>distinct</span>
    <span>department</span><span>.</span><span>name</span> <span>as</span> <span>name</span><span>,</span>
    <span>department</span><span>.</span><span>building</span> <span>as</span> <span>building</span>
<span>from</span> <span>department</span> <span>join</span> <span>staff</span>
<span>on</span> <span>department</span><span>.</span><span>ident</span> <span>=</span> <span>staff</span><span>.</span><span>dept</span>
<span>order</span> <span>by</span> <span>name</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/avoid_correlated_subqueries.out">out/avoid_correlated_subqueries.out</a></p>
  <div><div><pre><code>|       name        |     building     |
|-------------------|------------------|
| Genetics          | Chesson          |
| Histology         | Fashet Extension |
| Molecular Biology | Chesson          |
</code></pre></div>  </div>

  <ul>
    <li>The join might or might not be faster than the correlated subquery</li>
    <li>Hard to find unstaffed departments without either <code>not exists</code> or <code>count</code> and a check for 0</li>
  </ul>

</section>
<section>

  <h2 id="lead-and-lag">66: lead and lag</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/lead_lag.sql">src/lead_lag.sql</a></p>
  <div><div><pre><code><span>with</span> <span>ym_num</span> <span>as</span> <span>(</span>
    <span>select</span>
        <span>strftime</span><span>(</span><span>&#39;%Y-%m&#39;</span><span>,</span> <span>started</span><span>)</span> <span>as</span> <span>ym</span><span>,</span>
        <span>count</span><span>(</span><span>*</span><span>)</span> <span>as</span> <span>num</span>
    <span>from</span> <span>experiment</span>
    <span>group</span> <span>by</span> <span>ym</span>
<span>)</span>
<span>select</span>
    <span>ym</span><span>,</span>
    <span>lag</span><span>(</span><span>num</span><span>)</span> <span>over</span> <span>(</span><span>order</span> <span>by</span> <span>ym</span><span>)</span> <span>as</span> <span>prev_num</span><span>,</span>
    <span>num</span><span>,</span>
    <span>lead</span><span>(</span><span>num</span><span>)</span> <span>over</span> <span>(</span><span>order</span> <span>by</span> <span>ym</span><span>)</span> <span>as</span> <span>next_num</span>
<span>from</span> <span>ym_num</span>
<span>order</span> <span>by</span> <span>ym</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/lead_lag.out">out/lead_lag.out</a></p>
  <div><div><pre><code>|   ym    | prev_num | num | next_num |
|---------|----------|-----|----------|
| 2023-01 |          | 2   | 5        |
| 2023-02 | 2        | 5   | 5        |
| 2023-03 | 5        | 5   | 1        |
| 2023-04 | 5        | 1   | 6        |
| 2023-05 | 1        | 6   | 5        |
| 2023-06 | 6        | 5   | 3        |
| 2023-07 | 5        | 3   | 2        |
| 2023-08 | 3        | 2   | 4        |
| 2023-09 | 2        | 4   | 6        |
| 2023-10 | 4        | 6   | 4        |
| 2023-12 | 6        | 4   | 5        |
| 2024-01 | 4        | 5   | 2        |
| 2024-02 | 5        | 2   |          |
</code></pre></div>  </div>

  <ul>
    <li>Use <code>strftime</code> to extract year and month
      <ul>
        <li>Clumsy, but date/time handling is not SQLite’s strong point</li>
      </ul>
    </li>
    <li>Use <a href="#g:window_func">window functions</a> <code>lead</code> and <code>lag</code> to shift values
      <ul>
        <li>Unavailable values are null</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="window-functions">67: window functions</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/window_functions.sql">src/window_functions.sql</a></p>
  <div><div><pre><code><span>with</span> <span>ym_num</span> <span>as</span> <span>(</span>
    <span>select</span>
        <span>strftime</span><span>(</span><span>&#39;%Y-%m&#39;</span><span>,</span> <span>started</span><span>)</span> <span>as</span> <span>ym</span><span>,</span>
        <span>count</span><span>(</span><span>*</span><span>)</span> <span>as</span> <span>num</span>
    <span>from</span> <span>experiment</span>
    <span>group</span> <span>by</span> <span>ym</span>
<span>)</span>
<span>select</span>
    <span>ym</span><span>,</span>
    <span>num</span><span>,</span>
    <span>sum</span><span>(</span><span>num</span><span>)</span> <span>over</span> <span>(</span><span>order</span> <span>by</span> <span>ym</span><span>)</span> <span>as</span> <span>num_done</span><span>,</span>
    <span>cume_dist</span><span>()</span> <span>over</span> <span>(</span><span>order</span> <span>by</span> <span>ym</span><span>)</span> <span>as</span> <span>progress</span>
<span>from</span> <span>ym_num</span>
<span>order</span> <span>by</span> <span>ym</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/window_functions.out">out/window_functions.out</a></p>
  <div><div><pre><code>|   ym    | num | num_done |      progress      |
|---------|-----|----------|--------------------|
| 2023-01 | 2   | 2        | 0.0769230769230769 |
| 2023-02 | 5   | 7        | 0.153846153846154  |
| 2023-03 | 5   | 12       | 0.230769230769231  |
| 2023-04 | 1   | 13       | 0.307692307692308  |
| 2023-05 | 6   | 19       | 0.384615384615385  |
| 2023-06 | 5   | 24       | 0.461538461538462  |
| 2023-07 | 3   | 27       | 0.538461538461538  |
| 2023-08 | 2   | 29       | 0.615384615384615  |
| 2023-09 | 4   | 33       | 0.692307692307692  |
| 2023-10 | 6   | 39       | 0.769230769230769  |
| 2023-12 | 4   | 43       | 0.846153846153846  |
| 2024-01 | 5   | 48       | 0.923076923076923  |
| 2024-02 | 2   | 50       | 1.0                |
</code></pre></div>  </div>

  <ul>
    <li><code>sum() over</code> does a running total</li>
    <li><code>cume_dist</code> is fraction <em>of rows seen so far</em></li>
  </ul>

</section>
<section>

  <h2 id="explain-another-query-plain">☆ explain another query plain</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/explain_window_function.sql">src/explain_window_function.sql</a></p>
  <div><div><pre><code><span>explain</span> <span>query</span> <span>plan</span>
<span>with</span> <span>ym_num</span> <span>as</span> <span>(</span>
    <span>select</span>
        <span>strftime</span><span>(</span><span>&#39;%Y-%m&#39;</span><span>,</span> <span>started</span><span>)</span> <span>as</span> <span>ym</span><span>,</span>
        <span>count</span><span>(</span><span>*</span><span>)</span> <span>as</span> <span>num</span>
    <span>from</span> <span>experiment</span>
    <span>group</span> <span>by</span> <span>ym</span>
<span>)</span>
<span>select</span>
    <span>ym</span><span>,</span>
    <span>num</span><span>,</span>
    <span>sum</span><span>(</span><span>num</span><span>)</span> <span>over</span> <span>(</span><span>order</span> <span>by</span> <span>ym</span><span>)</span> <span>as</span> <span>num_done</span><span>,</span>
    <span>cume_dist</span><span>()</span> <span>over</span> <span>(</span><span>order</span> <span>by</span> <span>ym</span><span>)</span> <span>as</span> <span>progress</span>
<span>from</span> <span>ym_num</span>
<span>order</span> <span>by</span> <span>ym</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/explain_window_function.out">out/explain_window_function.out</a></p>
  <div><div><pre><code>QUERY PLAN
|--CO-ROUTINE (subquery-3)
|  |--CO-ROUTINE (subquery-4)
|  |  |--CO-ROUTINE ym_num
|  |  |  |--SCAN experiment
|  |  |  `--USE TEMP B-TREE FOR GROUP BY
|  |  |--SCAN ym_num
|  |  `--USE TEMP B-TREE FOR ORDER BY
|  `--SCAN (subquery-4)
`--SCAN (subquery-3)
</code></pre></div>  </div>

  <ul>
    <li>Becomes useful…eventually</li>
  </ul>

</section>
<section>

  <h2 id="partitioned-windows">68: partitioned windows</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/partition_window.sql">src/partition_window.sql</a></p>
  <div><div><pre><code><span>with</span> <span>y_m_num</span> <span>as</span> <span>(</span>
    <span>select</span>
        <span>strftime</span><span>(</span><span>&#39;%Y&#39;</span><span>,</span> <span>started</span><span>)</span> <span>as</span> <span>year</span><span>,</span>
        <span>strftime</span><span>(</span><span>&#39;%m&#39;</span><span>,</span> <span>started</span><span>)</span> <span>as</span> <span>month</span><span>,</span>
        <span>count</span><span>(</span><span>*</span><span>)</span> <span>as</span> <span>num</span>
    <span>from</span> <span>experiment</span>
    <span>group</span> <span>by</span> <span>year</span><span>,</span> <span>month</span>
<span>)</span>
<span>select</span>
    <span>year</span><span>,</span>
    <span>month</span><span>,</span>
    <span>num</span><span>,</span>
    <span>sum</span><span>(</span><span>num</span><span>)</span> <span>over</span> <span>(</span><span>partition</span> <span>by</span> <span>year</span> <span>order</span> <span>by</span> <span>month</span><span>)</span> <span>as</span> <span>num_done</span>
<span>from</span> <span>y_m_num</span>
<span>order</span> <span>by</span> <span>year</span><span>,</span> <span>month</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/partition_window.out">out/partition_window.out</a></p>
  <div><div><pre><code>| year | month | num | num_done |
|------|-------|-----|----------|
| 2023 | 01    | 2   | 2        |
| 2023 | 02    | 5   | 7        |
| 2023 | 03    | 5   | 12       |
| 2023 | 04    | 1   | 13       |
| 2023 | 05    | 6   | 19       |
| 2023 | 06    | 5   | 24       |
| 2023 | 07    | 3   | 27       |
| 2023 | 08    | 2   | 29       |
| 2023 | 09    | 4   | 33       |
| 2023 | 10    | 6   | 39       |
| 2023 | 12    | 4   | 43       |
| 2024 | 01    | 5   | 5        |
| 2024 | 02    | 2   | 7        |
</code></pre></div>  </div>

  <ul>
    <li><code>partition by</code> creates groups</li>
    <li>So this counts experiments started since the beginning of each year</li>
  </ul>

</section>
<section>

  <h2 id="blobs">69: blobs</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/blob.sql">src/blob.sql</a></p>
  <div><div><pre><code><span>create</span> <span>table</span> <span>images</span> <span>(</span>
    <span>name</span> <span>text</span> <span>not</span> <span>null</span><span>,</span>
    <span>content</span> <span>blob</span>
<span>);</span>

<span>insert</span> <span>into</span> <span>images</span><span>(</span><span>name</span><span>,</span> <span>content</span><span>)</span> <span>values</span>
    <span>(</span><span>&#34;biohazard&#34;</span><span>,</span> <span>readfile</span><span>(</span><span>&#34;img/biohazard.png&#34;</span><span>)),</span>
    <span>(</span><span>&#34;crush&#34;</span><span>,</span> <span>readfile</span><span>(</span><span>&#34;img/crush.png&#34;</span><span>)),</span>
    <span>(</span><span>&#34;fire&#34;</span><span>,</span> <span>readfile</span><span>(</span><span>&#34;img/fire.png&#34;</span><span>)),</span>
    <span>(</span><span>&#34;radioactive&#34;</span><span>,</span> <span>readfile</span><span>(</span><span>&#34;img/radioactive.png&#34;</span><span>)),</span>
    <span>(</span><span>&#34;tripping&#34;</span><span>,</span> <span>readfile</span><span>(</span><span>&#34;img/tripping.png&#34;</span><span>));</span>

<span>select</span> <span>name</span><span>,</span> <span>length</span><span>(</span><span>content</span><span>)</span> <span>from</span> <span>images</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/blob.out">out/blob.out</a></p>
  <div><div><pre><code>|    name     | length(content) |
|-------------|-----------------|
| biohazard   | 19629           |
| crush       | 15967           |
| fire        | 18699           |
| radioactive | 16661           |
| tripping    | 17208           |
</code></pre></div>  </div>

  <ul>
    <li>A <a href="#g:blob">blob</a> is a binary large object
      <ul>
        <li>Bytes in, bytes out…</li>
      </ul>
    </li>
    <li>If you think that’s odd, check out <a href="https://fossil-scm.org/">Fossil</a></li>
  </ul>

</section>
<section>

  <h2 id="yet-another-database-1">☆ yet another database</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/lab_log_db.sh">src/lab_log_db.sh</a></p>
  

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/lab_log_schema.sql">src/lab_log_schema.sql</a></p>
  

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/lab_log_schema.out">out/lab_log_schema.out</a></p>
  <div><div><pre><code>CREATE TABLE sqlite_sequence(name,seq);
CREATE TABLE person(
       ident            integer primary key autoincrement,
       details          text not null
);
CREATE TABLE machine(
       ident            integer primary key autoincrement,
       name             text not null,
       details          text not null
);
CREATE TABLE usage(
       ident            integer primary key autoincrement,
       log              text not null
);
</code></pre></div>  </div>

</section>
<section>

  <h2 id="store-json">70: store JSON</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/json_in_table.sql">src/json_in_table.sql</a></p>
  

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/json_in_table.out">out/json_in_table.out</a></p>
  <div><div><pre><code>| ident |      name      |                         details                         |
|-------|----------------|---------------------------------------------------------|
| 1     | WY401          | {&#34;acquired&#34;: &#34;2023-05-01&#34;}                              |
| 2     | Inphormex      | {&#34;acquired&#34;: &#34;2021-07-15&#34;, &#34;refurbished&#34;: &#34;2023-10-22&#34;} |
| 3     | AutoPlate 9000 | {&#34;note&#34;: &#34;needs software update&#34;}                       |
</code></pre></div>  </div>

  <ul>
    <li>Store heterogeneous data as JSON-formatted text (with double-quoted strings)
      <ul>
        <li>Database parses it each time it is queried</li>
      </ul>
    </li>
    <li>Alternatively store as blob
      <ul>
        <li>Can’t just view it</li>
        <li>But more efficient</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="select-field-from-json">71: select field from JSON</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/json_field.sql">src/json_field.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>details</span><span>-&gt;</span><span>&#39;$.acquired&#39;</span> <span>as</span> <span>single_arrow</span><span>,</span>
    <span>details</span><span>-&gt;&gt;</span><span>&#39;$.acquired&#39;</span> <span>as</span> <span>double_arrow</span>
<span>from</span> <span>machine</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/json_field.out">out/json_field.out</a></p>
  <div><div><pre><code>| single_arrow | double_arrow |
|--------------|--------------|
| &#34;2023-05-01&#34; | 2023-05-01   |
| &#34;2021-07-15&#34; | 2021-07-15   |
|              |              |
</code></pre></div>  </div>

  <ul>
    <li>Single arrow <code>-&gt;</code> returns JSON representation result</li>
    <li>Double arrow <code>-&gt;&gt;</code> returns SQL text, integer, real, or null</li>
    <li>Left side is column</li>
    <li>Right side is <a href="#g:path_expression">path expression</a>
      <ul>
        <li>Start with <code>$</code> (meaning “root”)</li>
        <li>Fields separated by <code>.</code></li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="json-array-access">72: JSON array access</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/json_array.sql">src/json_array.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>ident</span><span>,</span>
    <span>json_array_length</span><span>(</span><span>log</span><span>-&gt;</span><span>&#39;$&#39;</span><span>)</span> <span>as</span> <span>length</span><span>,</span>
    <span>log</span><span>-&gt;</span><span>&#39;$[0]&#39;</span> <span>as</span> <span>first</span>
<span>from</span> <span>usage</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/json_array.out">out/json_array.out</a></p>
  <div><div><pre><code>| ident | length |                            first                             |
|-------|--------|--------------------------------------------------------------|
| 1     | 4      | {&#34;machine&#34;:&#34;Inphormex&#34;,&#34;person&#34;:[&#34;Gabrielle&#34;,&#34;Dub\u00e9&#34;]}   |
| 2     | 5      | {&#34;machine&#34;:&#34;Inphormex&#34;,&#34;person&#34;:[&#34;Marianne&#34;,&#34;Richer&#34;]}       |
| 3     | 2      | {&#34;machine&#34;:&#34;sterilizer&#34;,&#34;person&#34;:[&#34;Josette&#34;,&#34;Villeneuve&#34;]}   |
| 4     | 1      | {&#34;machine&#34;:&#34;sterilizer&#34;,&#34;person&#34;:[&#34;Maude&#34;,&#34;Goulet&#34;]}         |
| 5     | 2      | {&#34;machine&#34;:&#34;AutoPlate 9000&#34;,&#34;person&#34;:[&#34;Brigitte&#34;,&#34;Michaud&#34;]} |
| 6     | 1      | {&#34;machine&#34;:&#34;sterilizer&#34;,&#34;person&#34;:[&#34;Marianne&#34;,&#34;Richer&#34;]}      |
| 7     | 3      | {&#34;machine&#34;:&#34;WY401&#34;,&#34;person&#34;:[&#34;Maude&#34;,&#34;Goulet&#34;]}              |
| 8     | 1      | {&#34;machine&#34;:&#34;AutoPlate 9000&#34;}                                 |
</code></pre></div>  </div>

  <ul>
    <li>SQLite (and other database managers) has lots of JSON manipulation functions</li>
    <li><code>json_array_length</code> gives number of elements in selected array</li>
    <li>subscripts start with 0</li>
    <li>Characters outside 7-bit ASCII represented as Unicode escapes</li>
  </ul>

</section>
<section>

  <h2 id="unpack-json-array">73: unpack JSON array</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/json_unpack.sql">src/json_unpack.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>ident</span><span>,</span>
    <span>json_each</span><span>.</span><span>key</span> <span>as</span> <span>key</span><span>,</span>
    <span>json_each</span><span>.</span><span>value</span> <span>as</span> <span>value</span>
<span>from</span> <span>usage</span><span>,</span> <span>json_each</span><span>(</span><span>usage</span><span>.</span><span>log</span><span>)</span>
<span>limit</span> <span>10</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/json_unpack.out">out/json_unpack.out</a></p>
  <div><div><pre><code>| ident | key |                            value                             |
|-------|-----|--------------------------------------------------------------|
| 1     | 0   | {&#34;machine&#34;:&#34;Inphormex&#34;,&#34;person&#34;:[&#34;Gabrielle&#34;,&#34;Dub\u00e9&#34;]}   |
| 1     | 1   | {&#34;machine&#34;:&#34;Inphormex&#34;,&#34;person&#34;:[&#34;Gabrielle&#34;,&#34;Dub\u00e9&#34;]}   |
| 1     | 2   | {&#34;machine&#34;:&#34;WY401&#34;,&#34;person&#34;:[&#34;Gabrielle&#34;,&#34;Dub\u00e9&#34;]}       |
| 1     | 3   | {&#34;machine&#34;:&#34;Inphormex&#34;,&#34;person&#34;:[&#34;Gabrielle&#34;,&#34;Dub\u00e9&#34;]}   |
| 2     | 0   | {&#34;machine&#34;:&#34;Inphormex&#34;,&#34;person&#34;:[&#34;Marianne&#34;,&#34;Richer&#34;]}       |
| 2     | 1   | {&#34;machine&#34;:&#34;AutoPlate 9000&#34;,&#34;person&#34;:[&#34;Marianne&#34;,&#34;Richer&#34;]}  |
| 2     | 2   | {&#34;machine&#34;:&#34;sterilizer&#34;,&#34;person&#34;:[&#34;Marianne&#34;,&#34;Richer&#34;]}      |
| 2     | 3   | {&#34;machine&#34;:&#34;AutoPlate 9000&#34;,&#34;person&#34;:[&#34;Monique&#34;,&#34;Marcotte&#34;]} |
| 2     | 4   | {&#34;machine&#34;:&#34;sterilizer&#34;,&#34;person&#34;:[&#34;Marianne&#34;,&#34;Richer&#34;]}      |
| 3     | 0   | {&#34;machine&#34;:&#34;sterilizer&#34;,&#34;person&#34;:[&#34;Josette&#34;,&#34;Villeneuve&#34;]}   |
</code></pre></div>  </div>

  <ul>
    <li><code>json_each</code> is another table-valued function</li>
    <li>Use <code>json_each.<em>name</em></code> to get properties of unpacked array</li>
  </ul>

</section>
<section>

  <h2 id="last-element-of-array">74: last element of array</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/json_array_last.sql">src/json_array_last.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>ident</span><span>,</span>
    <span>log</span><span>-&gt;</span><span>&#39;$[#-1].machine&#39;</span> <span>as</span> <span>final</span>
<span>from</span> <span>usage</span>
<span>limit</span> <span>5</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/json_array_last.out">out/json_array_last.out</a></p>
  <div><div><pre><code>| ident |    final     |
|-------|--------------|
| 1     | &#34;Inphormex&#34;  |
| 2     | &#34;sterilizer&#34; |
| 3     | &#34;Inphormex&#34;  |
| 4     | &#34;sterilizer&#34; |
| 5     | &#34;sterilizer&#34; |
</code></pre></div>  </div>

</section>
<section>

  <h2 id="modify-json">75: modify JSON</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/json_modify.sql">src/json_modify.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>ident</span><span>,</span>
    <span>name</span><span>,</span>
    <span>json_set</span><span>(</span><span>details</span><span>,</span> <span>&#39;$.sold&#39;</span><span>,</span> <span>json_quote</span><span>(</span><span>&#39;2024-01-25&#39;</span><span>))</span> <span>as</span> <span>updated</span>
<span>from</span> <span>machine</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/json_modify.out">out/json_modify.out</a></p>
  <div><div><pre><code>| ident |      name      |                           updated                            |
|-------|----------------|--------------------------------------------------------------|
| 1     | WY401          | {&#34;acquired&#34;:&#34;2023-05-01&#34;,&#34;sold&#34;:&#34;2024-01-25&#34;}                |
| 2     | Inphormex      | {&#34;acquired&#34;:&#34;2021-07-15&#34;,&#34;refurbished&#34;:&#34;2023-10-22&#34;,&#34;sold&#34;:&#34; |
|       |                | 2024-01-25&#34;}                                                 |
| 3     | AutoPlate 9000 | {&#34;note&#34;:&#34;needs software update&#34;,&#34;sold&#34;:&#34;2024-01-25&#34;}         |
</code></pre></div>  </div>

  <ul>
    <li>Updates the in-memory copy of the JSON, <em>not</em> the database record</li>
    <li>Please use <code>json_quote</code> rather than trying to format JSON with string operations</li>
  </ul>

</section>
<section>

  <h2 id="refresh-penguins">☆ refresh penguins</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/count_penguins.sql">src/count_penguins.sql</a></p>
  <div><div><pre><code><span>select</span> <span>species</span><span>,</span> <span>count</span><span>(</span><span>*</span><span>)</span> <span>as</span> <span>num</span>
<span>from</span> <span>penguins</span>
<span>group</span> <span>by</span> <span>species</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/count_penguins.out">out/count_penguins.out</a></p>
  <div><div><pre><code>|  species  | num |
|-----------|-----|
| Adelie    | 152 |
| Chinstrap | 68  |
| Gentoo    | 124 |
</code></pre></div>  </div>

  <ul>
    <li>We will restore full database after each example</li>
  </ul>

</section>
<section>

  <h2 id="tombstones">76: tombstones</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/make_active.sql">src/make_active.sql</a></p>
  <div><div><pre><code><span>alter</span> <span>table</span> <span>penguins</span>
<span>add</span> <span>active</span> <span>integer</span> <span>not</span> <span>null</span> <span>default</span> <span>1</span><span>;</span>

<span>update</span> <span>penguins</span>
<span>set</span> <span>active</span> <span>=</span> <span>iif</span><span>(</span><span>species</span> <span>=</span> <span>&#39;Adelie&#39;</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>);</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/active_penguins.sql">src/active_penguins.sql</a></p>
  <div><div><pre><code><span>select</span> <span>species</span><span>,</span> <span>count</span><span>(</span><span>*</span><span>)</span> <span>as</span> <span>num</span>
<span>from</span> <span>penguins</span>
<span>where</span> <span>active</span>
<span>group</span> <span>by</span> <span>species</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/active_penguins.out">out/active_penguins.out</a></p>
  <div><div><pre><code>|  species  | num |
|-----------|-----|
| Chinstrap | 68  |
| Gentoo    | 124 |
</code></pre></div>  </div>

  <ul>
    <li>Use a <a href="#g:tombstone">tombstone</a> to mark (in)active records</li>
    <li>Every query must now include it</li>
  </ul>

</section>
<section>

  <h2 id="views">77: views</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/views.sql">src/views.sql</a></p>
  <div><div><pre><code><span>create</span> <span>view</span> <span>if</span> <span>not</span> <span>exists</span>
<span>active_penguins</span> <span>(</span>
    <span>species</span><span>,</span>
    <span>island</span><span>,</span>
    <span>bill_length_mm</span><span>,</span>
    <span>bill_depth_mm</span><span>,</span>
    <span>flipper_length_mm</span><span>,</span>
    <span>body_mass_g</span><span>,</span>
    <span>sex</span>
<span>)</span> <span>as</span>
<span>select</span>
    <span>species</span><span>,</span>
    <span>island</span><span>,</span>
    <span>bill_length_mm</span><span>,</span>
    <span>bill_depth_mm</span><span>,</span>
    <span>flipper_length_mm</span><span>,</span>
    <span>body_mass_g</span><span>,</span>
    <span>sex</span>
<span>from</span> <span>penguins</span>
<span>where</span> <span>active</span><span>;</span>

<span>select</span> <span>species</span><span>,</span> <span>count</span><span>(</span><span>*</span><span>)</span> <span>as</span> <span>num</span>
<span>from</span> <span>active_penguins</span>
<span>group</span> <span>by</span> <span>species</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/views.out">out/views.out</a></p>
  <div><div><pre><code>|  species  | num |
|-----------|-----|
| Chinstrap | 68  |
| Gentoo    | 124 |
</code></pre></div>  </div>

  <ul>
    <li>A <a href="#g:view">view</a> is a saved query that other queries can invoke</li>
    <li>View is re-run each time it’s used</li>
    <li>Like a CTE, but:
      <ul>
        <li>Can be shared between queries</li>
        <li>Views came first</li>
      </ul>
    </li>
    <li>Some databases offer <a href="#g:materialized_view">materialized views</a>
      <ul>
        <li>Update-on-demand temporary tables</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="hours-reminder">☆ hours reminder</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/all_jobs.sql">src/all_jobs.sql</a></p>
  <div><div><pre><code><span>create</span> <span>table</span> <span>job</span> <span>(</span>
    <span>name</span> <span>text</span> <span>not</span> <span>null</span><span>,</span>
    <span>billable</span> <span>real</span> <span>not</span> <span>null</span>
<span>);</span>
<span>insert</span> <span>into</span> <span>job</span> <span>values</span>
    <span>(</span><span>&#39;calibrate&#39;</span><span>,</span> <span>1</span><span>.</span><span>5</span><span>),</span>
    <span>(</span><span>&#39;clean&#39;</span><span>,</span> <span>0</span><span>.</span><span>5</span><span>);</span>
<span>select</span> <span>*</span> <span>from</span> <span>job</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/all_jobs.out">out/all_jobs.out</a></p>
  <div><div><pre><code>|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
| clean     | 0.5      |
</code></pre></div>  </div>

</section>
<section>

  <h2 id="add-check">78: add check</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/all_jobs_check.sql">src/all_jobs_check.sql</a></p>
  <div><div><pre><code><span>create</span> <span>table</span> <span>job</span> <span>(</span>
    <span>name</span> <span>text</span> <span>not</span> <span>null</span><span>,</span>
    <span>billable</span> <span>real</span> <span>not</span> <span>null</span><span>,</span>
    <span>check</span> <span>(</span><span>billable</span> <span>&gt;</span> <span>0</span><span>.</span><span>0</span><span>)</span>
<span>);</span>
<span>insert</span> <span>into</span> <span>job</span> <span>values</span> <span>(</span><span>&#39;calibrate&#39;</span><span>,</span> <span>1</span><span>.</span><span>5</span><span>);</span>
<span>insert</span> <span>into</span> <span>job</span> <span>values</span> <span>(</span><span>&#39;reset&#39;</span><span>,</span> <span>-</span><span>0</span><span>.</span><span>5</span><span>);</span>
<span>select</span> <span>*</span> <span>from</span> <span>job</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/all_jobs_check.out">out/all_jobs_check.out</a></p>
  <div><div><pre><code>Runtime error near line 9: CHECK constraint failed: billable &gt; 0.0 (19)
|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
</code></pre></div>  </div>

  <ul>
    <li><code>check</code> adds constraint to table
      <ul>
        <li>Must produce a Boolean result</li>
        <li>Run each time values added or modified</li>
      </ul>
    </li>
    <li>But changes made before the error have taken effect</li>
  </ul>

</section>
<section>

  <h2 id="acid">☆ ACID</h2>

  <ul>
    <li><a href="#g:atomic">Atomic</a>: change cannot be broken down into smaller ones (i.e., all or nothing)</li>
    <li><a href="#g:consistent">Consistent</a>: database goes from one consistent state to another</li>
    <li><a href="#g:isolated">Isolated</a>: looks like changes happened one after another</li>
    <li><a href="#g:durable">Durable</a>: if change takes place, it’s still there after a restart</li>
  </ul>

</section>
<section>

  <h2 id="transactions">79: transactions</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/transaction.sql">src/transaction.sql</a></p>
  <div><div><pre><code><span>create</span> <span>table</span> <span>job</span> <span>(</span>
    <span>name</span> <span>text</span> <span>not</span> <span>null</span><span>,</span>
    <span>billable</span> <span>real</span> <span>not</span> <span>null</span><span>,</span>
    <span>check</span> <span>(</span><span>billable</span> <span>&gt;</span> <span>0</span><span>.</span><span>0</span><span>)</span>
<span>);</span>

<span>insert</span> <span>into</span> <span>job</span> <span>values</span> <span>(</span><span>&#39;calibrate&#39;</span><span>,</span> <span>1</span><span>.</span><span>5</span><span>);</span>

<span>begin</span> <span>transaction</span><span>;</span>
<span>insert</span> <span>into</span> <span>job</span> <span>values</span> <span>(</span><span>&#39;clean&#39;</span><span>,</span> <span>0</span><span>.</span><span>5</span><span>);</span>
<span>rollback</span><span>;</span>

<span>select</span> <span>*</span> <span>from</span> <span>job</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/transaction.out">out/transaction.out</a></p>
  <div><div><pre><code>|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
</code></pre></div>  </div>

  <ul>
    <li>Statements outside transaction execute and are committed immediately</li>
    <li>Statement(s) inside transaction don’t take effect until:
      <ul>
        <li><code>end transaction</code> (success)</li>
        <li><code>rollback</code> (undo)</li>
      </ul>
    </li>
    <li>Can have any number of statements inside a transaction</li>
    <li>But <em>cannot</em> nest transactions in SQLite
      <ul>
        <li>Other databases support this</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="rollback-in-constraint">80: rollback in constraint</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/rollback_constraint.sql">src/rollback_constraint.sql</a></p>
  <div><div><pre><code><span>create</span> <span>table</span> <span>job</span> <span>(</span>
    <span>name</span> <span>text</span> <span>not</span> <span>null</span><span>,</span>
    <span>billable</span> <span>real</span> <span>not</span> <span>null</span><span>,</span>
    <span>check</span> <span>(</span><span>billable</span> <span>&gt;</span> <span>0</span><span>.</span><span>0</span><span>)</span> <span>on</span> <span>conflict</span> <span>rollback</span>
<span>);</span>

<span>insert</span> <span>into</span> <span>job</span> <span>values</span>
    <span>(</span><span>&#39;calibrate&#39;</span><span>,</span> <span>1</span><span>.</span><span>5</span><span>);</span>
<span>insert</span> <span>into</span> <span>job</span> <span>values</span>
    <span>(</span><span>&#39;clean&#39;</span><span>,</span> <span>0</span><span>.</span><span>5</span><span>),</span>
    <span>(</span><span>&#39;reset&#39;</span><span>,</span> <span>-</span><span>0</span><span>.</span><span>5</span><span>);</span>

<span>select</span> <span>*</span> <span>from</span> <span>job</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/rollback_constraint.out">out/rollback_constraint.out</a></p>
  <div><div><pre><code>Runtime error near line 11: CHECK constraint failed: billable &gt; 0.0 (19)
|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
</code></pre></div>  </div>

  <ul>
    <li>All of second <code>insert</code> rolled back as soon as error occurred</li>
    <li>But first <code>insert</code> took effect</li>
  </ul>

</section>
<section>

  <h2 id="rollback-in-statement">81: rollback in statement</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/rollback_statement.sql">src/rollback_statement.sql</a></p>
  <div><div><pre><code><span>create</span> <span>table</span> <span>job</span> <span>(</span>
    <span>name</span> <span>text</span> <span>not</span> <span>null</span><span>,</span>
    <span>billable</span> <span>real</span> <span>not</span> <span>null</span><span>,</span>
    <span>check</span> <span>(</span><span>billable</span> <span>&gt;</span> <span>0</span><span>.</span><span>0</span><span>)</span>
<span>);</span>

<span>insert</span> <span>or</span> <span>rollback</span> <span>into</span> <span>job</span> <span>values</span>
    <span>(</span><span>&#39;calibrate&#39;</span><span>,</span> <span>1</span><span>.</span><span>5</span><span>);</span>
<span>insert</span> <span>or</span> <span>rollback</span> <span>into</span> <span>job</span> <span>values</span>
    <span>(</span><span>&#39;clean&#39;</span><span>,</span> <span>0</span><span>.</span><span>5</span><span>),</span>
    <span>(</span><span>&#39;reset&#39;</span><span>,</span> <span>-</span><span>0</span><span>.</span><span>5</span><span>);</span>

<span>select</span> <span>*</span> <span>from</span> <span>job</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/rollback_statement.out">out/rollback_statement.out</a></p>
  <div><div><pre><code>Runtime error near line 11: CHECK constraint failed: billable &gt; 0.0 (19)
|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
</code></pre></div>  </div>

  <ul>
    <li>Constraint is in table definition</li>
    <li>Action is in statement</li>
  </ul>

</section>
<section>

  <h2 id="upsert">82: upsert</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/upsert.sql">src/upsert.sql</a></p>
  <div><div><pre><code><span>create</span> <span>table</span> <span>jobs_done</span> <span>(</span>
    <span>person</span> <span>text</span> <span>unique</span><span>,</span>
    <span>num</span> <span>integer</span> <span>default</span> <span>0</span>
<span>);</span>

<span>insert</span> <span>into</span> <span>jobs_done</span> <span>values</span><span>(</span><span>&#34;zia&#34;</span><span>,</span> <span>1</span><span>);</span>
<span>.</span><span>print</span> <span>&#34;after first&#34;</span>
<span>select</span> <span>*</span> <span>from</span> <span>jobs_done</span><span>;</span>
<span>.</span><span>print</span>


<span>insert</span> <span>into</span> <span>jobs_done</span> <span>values</span><span>(</span><span>&#34;zia&#34;</span><span>,</span> <span>1</span><span>);</span>
<span>.</span><span>print</span> <span>&#34;after failed&#34;</span>
<span>select</span> <span>*</span> <span>from</span> <span>jobs_done</span><span>;</span>

<span>insert</span> <span>into</span> <span>jobs_done</span> <span>values</span><span>(</span><span>&#34;zia&#34;</span><span>,</span> <span>1</span><span>)</span>
    <span>on</span> <span>conflict</span><span>(</span><span>person</span><span>)</span> <span>do</span> <span>update</span> <span>set</span> <span>num</span> <span>=</span> <span>num</span> <span>+</span> <span>1</span><span>;</span>
<span>.</span><span>print</span> <span>&#34;</span><span>\n</span><span>after upsert&#34;</span>
<span>select</span> <span>*</span> <span>from</span> <span>jobs_done</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/upsert.out">out/upsert.out</a></p>
  <div><div><pre><code>after first
| person | num |
|--------|-----|
| zia    | 1   |

Runtime error near line 14: UNIQUE constraint failed: jobs_done.person (19)
after failed
| person | num |
|--------|-----|
| zia    | 1   |

after upsert
| person | num |
|--------|-----|
| zia    | 2   |
</code></pre></div>  </div>

  <ul>
    <li><a href="#g:upsert">upsert</a> stands for “update or insert”
      <ul>
        <li>Create if record doesn’t exist</li>
        <li>Update if it does</li>
      </ul>
    </li>
    <li>Not standard SQL but widely implemented</li>
    <li>Example also shows use of SQLite <code>.print</code> command</li>
  </ul>

</section>
<section>

  <h2 id="normalization">☆ normalization</h2>

  <ul>
    <li>
      <p>First <a href="#g:normal_form">normal form</a> (1NF):
every field of every record contains one indivisible value.</p>
    </li>
    <li>
      <p>Second normal form (2NF) and third normal form (3NF):
every value in a record that isn’t a key depends solely on the key,
not on other values.</p>
    </li>
    <li>
      <p><a href="#g:denormalization">Denormalization</a>: explicitly store values that could be calculated on the fly</p>
      <ul>
        <li>To simplify queries and/or make processing faster</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="create-trigger">83: create trigger</h2>

  <ul>
    <li>A <a href="#g:trigger">trigger</a> automatically runs before or after a specified operation</li>
    <li>Can have side effects (e.g., update some other table)</li>
    <li>And/or implement checks (e.g., make sure other records exist)</li>
    <li>Add processing overhead…</li>
    <li>…but data is either cheap or correct, never both</li>
    <li>Inside trigger, refer to old and new versions of record
as <code>old.<em>column</em></code> and <code>new.<em>column</em></code></li>
  </ul>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/trigger_setup.sql">src/trigger_setup.sql</a></p>
  <div><div><pre><code><span>-- Track hours of lab work.</span>
<span>create</span> <span>table</span> <span>job</span> <span>(</span>
    <span>person</span> <span>text</span> <span>not</span> <span>null</span><span>,</span>
    <span>reported</span> <span>real</span> <span>not</span> <span>null</span> <span>check</span> <span>(</span><span>reported</span> <span>&gt;=</span> <span>0</span><span>.</span><span>0</span><span>)</span>
<span>);</span>

<span>-- Explicitly store per-person total rather than using sum().</span>
<span>create</span> <span>table</span> <span>total</span> <span>(</span>
    <span>person</span> <span>text</span> <span>unique</span> <span>not</span> <span>null</span><span>,</span>
    <span>hours</span> <span>real</span>
<span>);</span>

<span>-- Initialize totals.</span>
<span>insert</span> <span>into</span> <span>total</span> <span>values</span>
    <span>(</span><span>&#34;gene&#34;</span><span>,</span> <span>0</span><span>.</span><span>0</span><span>),</span>
    <span>(</span><span>&#34;august&#34;</span><span>,</span> <span>0</span><span>.</span><span>0</span><span>);</span>

<span>-- Define a trigger.</span>
<span>create</span> <span>trigger</span> <span>total_trigger</span>
<span>before</span> <span>insert</span> <span>on</span> <span>job</span>
<span>begin</span>
    <span>-- Check that the person exists.</span>
    <span>select</span> <span>case</span>
        <span>when</span> <span>not</span> <span>exists</span> <span>(</span><span>select</span> <span>1</span> <span>from</span> <span>total</span> <span>where</span> <span>person</span> <span>=</span> <span>new</span><span>.</span><span>person</span><span>)</span>
        <span>then</span> <span>raise</span><span>(</span><span>rollback</span><span>,</span> <span>&#39;Unknown person &#39;</span><span>)</span>
    <span>end</span><span>;</span>
    <span>-- Update their total hours (or fail if non-negative constraint violated).</span>
    <span>update</span> <span>total</span>
    <span>set</span> <span>hours</span> <span>=</span> <span>hours</span> <span>+</span> <span>new</span><span>.</span><span>reported</span>
    <span>where</span> <span>total</span><span>.</span><span>person</span> <span>=</span> <span>new</span><span>.</span><span>person</span><span>;</span>
<span>end</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/trigger_successful.sql">src/trigger_successful.sql</a></p>
  <div><div><pre><code><span>insert</span> <span>into</span> <span>job</span> <span>values</span>
    <span>(</span><span>&#39;gene&#39;</span><span>,</span> <span>1</span><span>.</span><span>5</span><span>),</span>
    <span>(</span><span>&#39;august&#39;</span><span>,</span> <span>0</span><span>.</span><span>5</span><span>),</span>
    <span>(</span><span>&#39;gene&#39;</span><span>,</span> <span>1</span><span>.</span><span>0</span><span>)</span>
<span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/trigger_successful.out">out/trigger_successful.out</a></p>
  <div><div><pre><code>| person | reported |
|--------|----------|
| gene   | 1.5      |
| august | 0.5      |
| gene   | 1.0      |

| person | hours |
|--------|-------|
| gene   | 2.5   |
| august | 0.5   |
</code></pre></div>  </div>

</section>
<section>

  

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/trigger_firing.sql">src/trigger_firing.sql</a></p>
  <div><div><pre><code><span>insert</span> <span>into</span> <span>job</span> <span>values</span>
    <span>(</span><span>&#39;gene&#39;</span><span>,</span> <span>1</span><span>.</span><span>0</span><span>),</span>
    <span>(</span><span>&#39;august&#39;</span><span>,</span> <span>-</span><span>1</span><span>.</span><span>0</span><span>)</span>
<span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/trigger_firing.out">out/trigger_firing.out</a></p>
  <div><div><pre><code>Runtime error near line 6: CHECK constraint failed: reported &gt;= 0.0 (19)

| person | hours |
|--------|-------|
| gene   | 0.0   |
| august | 0.0   |
</code></pre></div>  </div>

</section>
<section>

  <h2 id="represent-graphs">☆ represent graphs</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/lineage_setup.sql">src/lineage_setup.sql</a></p>
  <div><div><pre><code><span>create</span> <span>table</span> <span>lineage</span> <span>(</span>
    <span>parent</span> <span>text</span> <span>not</span> <span>null</span><span>,</span>
    <span>child</span> <span>text</span> <span>not</span> <span>null</span>
<span>);</span>
<span>insert</span> <span>into</span> <span>lineage</span> <span>values</span>
    <span>(</span><span>&#39;Arturo&#39;</span><span>,</span> <span>&#39;Clemente&#39;</span><span>),</span>
    <span>(</span><span>&#39;Darío&#39;</span><span>,</span> <span>&#39;Clemente&#39;</span><span>),</span>
    <span>(</span><span>&#39;Clemente&#39;</span><span>,</span> <span>&#39;Homero&#39;</span><span>),</span>
    <span>(</span><span>&#39;Clemente&#39;</span><span>,</span> <span>&#39;Ivonne&#39;</span><span>),</span>
    <span>(</span><span>&#39;Ivonne&#39;</span><span>,</span> <span>&#39;Lourdes&#39;</span><span>),</span>
    <span>(</span><span>&#39;Soledad&#39;</span><span>,</span> <span>&#39;Lourdes&#39;</span><span>),</span>
    <span>(</span><span>&#39;Lourdes&#39;</span><span>,</span> <span>&#39;Santiago&#39;</span><span>);</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/represent_graph.sql">src/represent_graph.sql</a></p>
  

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/represent_graph.out">out/represent_graph.out</a></p>
  <div><div><pre><code>|  parent  |  child   |
|----------|----------|
| Arturo   | Clemente |
| Darío    | Clemente |
| Clemente | Homero   |
| Clemente | Ivonne   |
| Ivonne   | Lourdes  |
| Soledad  | Lourdes  |
| Lourdes  | Santiago |
</code></pre></div>  </div>

  <p><img src="https://www.wildlondon.org.uk/sql-tutorial/img/lineage.svg" alt="lineage diagram"/></p>

</section>
<section>

  <h2 id="recursive-query">84: recursive query</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/recursive_lineage.sql">src/recursive_lineage.sql</a></p>
  <div><div><pre><code><span>with</span> <span>recursive</span> <span>descendent</span> <span>as</span> <span>(</span>
    <span>select</span>
        <span>&#39;Clemente&#39;</span> <span>as</span> <span>person</span><span>,</span>
        <span>0</span> <span>as</span> <span>generations</span>
    <span>union</span> <span>all</span>
    <span>select</span>
        <span>lineage</span><span>.</span><span>child</span> <span>as</span> <span>person</span><span>,</span>
        <span>descendent</span><span>.</span><span>generations</span> <span>+</span> <span>1</span> <span>as</span> <span>generations</span>
    <span>from</span> <span>descendent</span> <span>join</span> <span>lineage</span>
    <span>on</span> <span>descendent</span><span>.</span><span>person</span> <span>=</span> <span>lineage</span><span>.</span><span>parent</span>
<span>)</span>
<span>select</span> <span>person</span><span>,</span> <span>generations</span> <span>from</span> <span>descendent</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/recursive_lineage.out">out/recursive_lineage.out</a></p>
  <div><div><pre><code>|  person  | generations |
|----------|-------------|
| Clemente | 0           |
| Homero   | 1           |
| Ivonne   | 1           |
| Lourdes  | 2           |
| Santiago | 3           |
</code></pre></div>  </div>

  <ul>
    <li>Use a <a href="#g:recursive_cte">recursive CTE</a> to create a temporary table (<code>descendent</code>)</li>
    <li><a href="#g:base_case">Base case</a> seeds this table</li>
    <li><a href="#g:recursive_case">Recursive case</a> relies on value(s) already in that table and external table(s)</li>
    <li><code>union all</code> to combine rows
      <ul>
        <li>Can use <code>union</code> but that has lower performance (must check uniqueness each time)</li>
      </ul>
    </li>
    <li>Stops when the recursive case yields an empty row set (nothing new to add)</li>
    <li>Then select the desired values from the CTE</li>
  </ul>

</section>
<section>

  

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/contact_person.sql">src/contact_person.sql</a></p>
  

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/contact_person.out">out/contact_person.out</a></p>
  <div><div><pre><code>| ident |         name          |
|-------|-----------------------|
| 1     | Juana Baeza           |
| 2     | Agustín Rodríquez     |
| 3     | Ariadna Caraballo     |
| 4     | Micaela Laboy         |
| 5     | Verónica Altamirano   |
| 6     | Reina Rivero          |
| 7     | Elias Merino          |
| 8     | Minerva Guerrero      |
| 9     | Mauro Balderas        |
| 10    | Pilar Alarcón         |
| 11    | Daniela Menéndez      |
| 12    | Marco Antonio Barrera |
| 13    | Cristal Soliz         |
| 14    | Bernardo Narváez      |
| 15    | Óscar Barrios         |
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/contact_contacts.sql">src/contact_contacts.sql</a></p>
  

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/contact_contacts.out">out/contact_contacts.out</a></p>
  <div><div><pre><code>|       left        |         right         |
|-------------------|-----------------------|
| Agustín Rodríquez | Ariadna Caraballo     |
| Agustín Rodríquez | Verónica Altamirano   |
| Juana Baeza       | Verónica Altamirano   |
| Juana Baeza       | Micaela Laboy         |
| Pilar Alarcón     | Reina Rivero          |
| Cristal Soliz     | Marco Antonio Barrera |
| Cristal Soliz     | Daniela Menéndez      |
| Daniela Menéndez  | Marco Antonio Barrera |
</code></pre></div>  </div>

  <p><img src="https://www.wildlondon.org.uk/sql-tutorial/img/contact_tracing.svg" alt="contact diagram"/></p>

</section>
<section>

  

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/bidirectional.sql">src/bidirectional.sql</a></p>
  <div><div><pre><code><span>create</span> <span>temporary</span> <span>table</span> <span>bi_contact</span> <span>(</span>
    <span>left</span> <span>text</span><span>,</span>
    <span>right</span> <span>text</span>
<span>);</span>

<span>insert</span> <span>into</span> <span>bi_contact</span>
<span>select</span>
    <span>left</span><span>,</span> <span>right</span> <span>from</span> <span>contact</span>
    <span>union</span> <span>all</span>
    <span>select</span> <span>right</span><span>,</span> <span>left</span> <span>from</span> <span>contact</span>
<span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/bidirectional.out">out/bidirectional.out</a></p>
  <div><div><pre><code>| original_count |
|----------------|
| 8              |

| num_contact |
|-------------|
| 16          |
</code></pre></div>  </div>

  <ul>
    <li>Create a <a href="#g:temporary_table">temporary table</a> rather than using a long chain of CTEs
      <ul>
        <li>Only lasts as long as the session (not saved to disk)</li>
      </ul>
    </li>
    <li>Duplicate information rather than writing more complicated query</li>
  </ul>

</section>
<section>

  <h2 id="update-group-identifiers">86: update group identifiers</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/update_group_ids.sql">src/update_group_ids.sql</a></p>
  <div><div><pre><code><span>select</span>
    <span>left</span><span>.</span><span>name</span> <span>as</span> <span>left_name</span><span>,</span>
    <span>left</span><span>.</span><span>ident</span> <span>as</span> <span>left_ident</span><span>,</span>
    <span>right</span><span>.</span><span>name</span> <span>as</span> <span>right_name</span><span>,</span>
    <span>right</span><span>.</span><span>ident</span> <span>as</span> <span>right_ident</span><span>,</span>
    <span>min</span><span>(</span><span>left</span><span>.</span><span>ident</span><span>,</span> <span>right</span><span>.</span><span>ident</span><span>)</span> <span>as</span> <span>new_ident</span>
<span>from</span>
    <span>(</span><span>person</span> <span>as</span> <span>left</span> <span>join</span> <span>bi_contact</span> <span>on</span> <span>left</span><span>.</span><span>name</span> <span>=</span> <span>bi_contact</span><span>.</span><span>left</span><span>)</span>
    <span>join</span> <span>person</span> <span>as</span> <span>right</span> <span>on</span> <span>bi_contact</span><span>.</span><span>right</span> <span>=</span> <span>right</span><span>.</span><span>name</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/update_group_ids.out">out/update_group_ids.out</a></p>
  <div><div><pre><code>|       left_name       | left_ident |      right_name       | right_ident | new_ident |
|-----------------------|------------|-----------------------|-------------|-----------|
| Juana Baeza           | 1          | Micaela Laboy         | 4           | 1         |
| Juana Baeza           | 1          | Verónica Altamirano   | 5           | 1         |
| Agustín Rodríquez     | 2          | Ariadna Caraballo     | 3           | 2         |
| Agustín Rodríquez     | 2          | Verónica Altamirano   | 5           | 2         |
| Ariadna Caraballo     | 3          | Agustín Rodríquez     | 2           | 2         |
| Micaela Laboy         | 4          | Juana Baeza           | 1           | 1         |
| Verónica Altamirano   | 5          | Agustín Rodríquez     | 2           | 2         |
| Verónica Altamirano   | 5          | Juana Baeza           | 1           | 1         |
| Reina Rivero          | 6          | Pilar Alarcón         | 10          | 6         |
| Pilar Alarcón         | 10         | Reina Rivero          | 6           | 6         |
| Daniela Menéndez      | 11         | Cristal Soliz         | 13          | 11        |
| Daniela Menéndez      | 11         | Marco Antonio Barrera | 12          | 11        |
| Marco Antonio Barrera | 12         | Cristal Soliz         | 13          | 12        |
| Marco Antonio Barrera | 12         | Daniela Menéndez      | 11          | 11        |
| Cristal Soliz         | 13         | Daniela Menéndez      | 11          | 11        |
| Cristal Soliz         | 13         | Marco Antonio Barrera | 12          | 12        |
</code></pre></div>  </div>

  <ul>
    <li><code>new_ident</code> is minimum of own identifier and identifiers one step away</li>
    <li>Doesn’t keep people with no contacts</li>
  </ul>

</section>
<section>

  <h2 id="recursive-labeling">87: recursive labeling</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/recursive_labeling.sql">src/recursive_labeling.sql</a></p>
  <div><div><pre><code><span>with</span> <span>recursive</span> <span>labeled</span> <span>as</span> <span>(</span>
    <span>select</span>
        <span>person</span><span>.</span><span>name</span> <span>as</span> <span>name</span><span>,</span>
	<span>person</span><span>.</span><span>ident</span> <span>as</span> <span>label</span>
    <span>from</span>
        <span>person</span>
    <span>union</span> <span>-- not &#39;union all&#39;</span>
    <span>select</span>
        <span>person</span><span>.</span><span>name</span> <span>as</span> <span>name</span><span>,</span>
	<span>labeled</span><span>.</span><span>label</span> <span>as</span> <span>label</span>
    <span>from</span>
        <span>(</span><span>person</span> <span>join</span> <span>bi_contact</span> <span>on</span> <span>person</span><span>.</span><span>name</span> <span>=</span> <span>bi_contact</span><span>.</span><span>left</span><span>)</span>
	<span>join</span> <span>labeled</span> <span>on</span> <span>bi_contact</span><span>.</span><span>right</span> <span>=</span> <span>labeled</span><span>.</span><span>name</span>
    <span>where</span> <span>labeled</span><span>.</span><span>label</span> <span>&lt;</span> <span>person</span><span>.</span><span>ident</span>
<span>)</span>
<span>select</span> <span>name</span><span>,</span> <span>min</span><span>(</span><span>label</span><span>)</span> <span>as</span> <span>group_id</span>
<span>from</span> <span>labeled</span>
<span>group</span> <span>by</span> <span>name</span>
<span>order</span> <span>by</span> <span>label</span><span>,</span> <span>name</span><span>;</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/recursive_labeling.out">out/recursive_labeling.out</a></p>
  <div><div><pre><code>|         name          | group_id |
|-----------------------|----------|
| Agustín Rodríquez     | 1        |
| Ariadna Caraballo     | 1        |
| Juana Baeza           | 1        |
| Micaela Laboy         | 1        |
| Verónica Altamirano   | 1        |
| Pilar Alarcón         | 6        |
| Reina Rivero          | 6        |
| Elias Merino          | 7        |
| Minerva Guerrero      | 8        |
| Mauro Balderas        | 9        |
| Cristal Soliz         | 11       |
| Daniela Menéndez      | 11       |
| Marco Antonio Barrera | 11       |
| Bernardo Narváez      | 14       |
| Óscar Barrios         | 15       |
</code></pre></div>  </div>

  <ul>
    <li>Use <code>union</code> instead of <code>union all</code> to prevent <a href="#g:infinite_recursion">infinite recursion</a></li>
  </ul>

</section>
<section>

  <h2 id="query-from-python">88: query from Python</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/basic_python_query.py">src/basic_python_query.py</a></p>
  <div><div><pre><code><span>import</span> <span>sqlite3</span>

<span>connection</span> <span>=</span> <span>sqlite3</span><span>.</span><span>connect</span><span>(</span><span>&#34;db/penguins.db&#34;</span><span>)</span>
<span>cursor</span> <span>=</span> <span>connection</span><span>.</span><span>execute</span><span>(</span><span>&#34;select count(*) from penguins;&#34;</span><span>)</span>
<span>rows</span> <span>=</span> <span>cursor</span><span>.</span><span>fetchall</span><span>()</span>
<span>print</span><span>(</span><span>rows</span><span>)</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/basic_python_query.out">out/basic_python_query.out</a></p>
  

  <ul>
    <li><code>sqlite3</code> is part of Python’s standard library</li>
    <li>Create a connection to a database file</li>
    <li>Get a <a href="#g:cursor">cursor</a> by executing a query
      <ul>
        <li>More common to create cursor and use that to run queries</li>
      </ul>
    </li>
    <li>Fetch all rows at once as list of tuples</li>
  </ul>

</section>
<section>

  <h2 id="incremental-fetch">89: incremental fetch</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/incremental_fetch.py">src/incremental_fetch.py</a></p>
  <div><div><pre><code><span>import</span> <span>sqlite3</span>

<span>connection</span> <span>=</span> <span>sqlite3</span><span>.</span><span>connect</span><span>(</span><span>&#34;db/penguins.db&#34;</span><span>)</span>
<span>cursor</span> <span>=</span> <span>connection</span><span>.</span><span>cursor</span><span>()</span>
<span>cursor</span> <span>=</span> <span>cursor</span><span>.</span><span>execute</span><span>(</span><span>&#34;select species, island from penguins limit 5;&#34;</span><span>)</span>
<span>while</span> <span>row</span> <span>:</span><span>=</span> <span>cursor</span><span>.</span><span>fetchone</span><span>():</span>
    <span>print</span><span>(</span><span>row</span><span>)</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/incremental_fetch.out">out/incremental_fetch.out</a></p>
  <div><div><pre><code>(&#39;Adelie&#39;, &#39;Torgersen&#39;)
(&#39;Adelie&#39;, &#39;Torgersen&#39;)
(&#39;Adelie&#39;, &#39;Torgersen&#39;)
(&#39;Adelie&#39;, &#39;Torgersen&#39;)
(&#39;Adelie&#39;, &#39;Torgersen&#39;)
</code></pre></div>  </div>

  <ul>
    <li><code>cursor.fetchone</code> returns <code>None</code> when no more data</li>
    <li>There is also <code>fetchmany(N)</code> to fetch (up to) a certain number of rows</li>
  </ul>

</section>
<section>

  <h2 id="insert-delete-and-all-that">90: insert, delete, and all that</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/insert_delete.py">src/insert_delete.py</a></p>
  <div><div><pre><code><span>import</span> <span>sqlite3</span>

<span>connection</span> <span>=</span> <span>sqlite3</span><span>.</span><span>connect</span><span>(</span><span>&#34;:memory:&#34;</span><span>)</span>
<span>cursor</span> <span>=</span> <span>connection</span><span>.</span><span>cursor</span><span>()</span>
<span>cursor</span><span>.</span><span>execute</span><span>(</span><span>&#34;create table example(num integer);&#34;</span><span>)</span>

<span>cursor</span><span>.</span><span>execute</span><span>(</span><span>&#34;insert into example values (10), (20);&#34;</span><span>)</span>
<span>print</span><span>(</span><span>&#34;after insertion&#34;</span><span>,</span> <span>cursor</span><span>.</span><span>execute</span><span>(</span><span>&#34;select * from example;&#34;</span><span>).</span><span>fetchall</span><span>())</span>

<span>cursor</span><span>.</span><span>execute</span><span>(</span><span>&#34;delete from example where num &lt; 15;&#34;</span><span>)</span>
<span>print</span><span>(</span><span>&#34;after deletion&#34;</span><span>,</span> <span>cursor</span><span>.</span><span>execute</span><span>(</span><span>&#34;select * from example;&#34;</span><span>).</span><span>fetchall</span><span>())</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/insert_delete.out">out/insert_delete.out</a></p>
  <div><div><pre><code>after insertion [(10,), (20,)]
after deletion [(20,)]
</code></pre></div>  </div>

  <ul>
    <li>Each <code>execute</code> is its own transaction</li>
  </ul>

</section>
<section>

  <h2 id="interpolate-values">91: interpolate values</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/interpolate.py">src/interpolate.py</a></p>
  <div><div><pre><code><span>import</span> <span>sqlite3</span>

<span>connection</span> <span>=</span> <span>sqlite3</span><span>.</span><span>connect</span><span>(</span><span>&#34;:memory:&#34;</span><span>)</span>
<span>cursor</span> <span>=</span> <span>connection</span><span>.</span><span>cursor</span><span>()</span>
<span>cursor</span><span>.</span><span>execute</span><span>(</span><span>&#34;create table example(num integer);&#34;</span><span>)</span>

<span>cursor</span><span>.</span><span>executemany</span><span>(</span><span>&#34;insert into example values (?);&#34;</span><span>,</span> <span>[(</span><span>10</span><span>,),</span> <span>(</span><span>20</span><span>,)])</span>
<span>print</span><span>(</span><span>&#34;after insertion&#34;</span><span>,</span> <span>cursor</span><span>.</span><span>execute</span><span>(</span><span>&#34;select * from example;&#34;</span><span>).</span><span>fetchall</span><span>())</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/interpolate.out">out/interpolate.out</a></p>
  <div><div><pre><code>after insertion [(10,), (20,)]
</code></pre></div>  </div>

  <ul>
    <li>From <a href="https://xkcd.com/327/">XKCD</a></li>
  </ul>

  <p><img src="https://www.wildlondon.org.uk/sql-tutorial/img/xkcd_327_exploits_of_a_mom.png" alt="XKCD Exploits of a Mom"/></p>

</section>
<section>

  <h2 id="script-execution">92: script execution</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/script_execution.py">src/script_execution.py</a></p>
  <div><div><pre><code><span>import</span> <span>sqlite3</span>

<span>SETUP</span> <span>=</span> <span>&#34;&#34;&#34;</span><span>\
</span><span>drop table if exists example;
create table example(num integer);
insert into example values (10), (20);
&#34;&#34;&#34;</span>

<span>connection</span> <span>=</span> <span>sqlite3</span><span>.</span><span>connect</span><span>(</span><span>&#34;:memory:&#34;</span><span>)</span>
<span>cursor</span> <span>=</span> <span>connection</span><span>.</span><span>cursor</span><span>()</span>
<span>cursor</span><span>.</span><span>executescript</span><span>(</span><span>SETUP</span><span>)</span>
<span>print</span><span>(</span><span>&#34;after insertion&#34;</span><span>,</span> <span>cursor</span><span>.</span><span>execute</span><span>(</span><span>&#34;select * from example;&#34;</span><span>).</span><span>fetchall</span><span>())</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/script_execution.out">out/script_execution.out</a></p>
  <div><div><pre><code>after insertion [(10,), (20,)]
</code></pre></div>  </div>

  <ul>
    <li>But what if something goes wrong?</li>
  </ul>

</section>
<section>

  <h2 id="sqlite-exceptions-in-python">93: SQLite exceptions in Python</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/exceptions.py">src/exceptions.py</a></p>
  <div><div><pre><code><span>import</span> <span>sqlite3</span>

<span>SETUP</span> <span>=</span> <span>&#34;&#34;&#34;</span><span>\
</span><span>create table example(num integer check(num &gt; 0));
insert into example values (10);
insert into example values (-1);
insert into example values (20);
&#34;&#34;&#34;</span>

<span>connection</span> <span>=</span> <span>sqlite3</span><span>.</span><span>connect</span><span>(</span><span>&#34;:memory:&#34;</span><span>)</span>
<span>cursor</span> <span>=</span> <span>connection</span><span>.</span><span>cursor</span><span>()</span>
<span>try</span><span>:</span>
    <span>cursor</span><span>.</span><span>executescript</span><span>(</span><span>SETUP</span><span>)</span>
<span>except</span> <span>sqlite3</span><span>.</span><span>Error</span> <span>as</span> <span>exc</span><span>:</span>
    <span>print</span><span>(</span><span>f</span><span>&#34;SQLite exception: </span><span>{</span><span>exc</span><span>}</span><span>&#34;</span><span>)</span>
<span>print</span><span>(</span><span>&#34;after execution&#34;</span><span>,</span> <span>cursor</span><span>.</span><span>execute</span><span>(</span><span>&#34;select * from example;&#34;</span><span>).</span><span>fetchall</span><span>())</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/exceptions.out">out/exceptions.out</a></p>
  <div><div><pre><code>SQLite exception: CHECK constraint failed: num &gt; 0
after execution [(10,)]
</code></pre></div>  </div>

</section>
<section>

  <h2 id="python-in-sqlite">94: Python in SQLite</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/embedded_python.py">src/embedded_python.py</a></p>
  <div><div><pre><code><span>import</span> <span>sqlite3</span>

<span>SETUP</span> <span>=</span> <span>&#34;&#34;&#34;</span><span>\
</span><span>create table example(num integer);
insert into example values (-10), (10), (20), (30);
&#34;&#34;&#34;</span>


<span>def</span> <span>clip</span><span>(</span><span>value</span><span>):</span>
    <span>if</span> <span>value</span> <span>&lt;</span> <span>0</span><span>:</span>
        <span>return</span> <span>0</span>
    <span>if</span> <span>value</span> <span>&gt;</span> <span>20</span><span>:</span>
        <span>return</span> <span>20</span>
    <span>return</span> <span>value</span>


<span>connection</span> <span>=</span> <span>sqlite3</span><span>.</span><span>connect</span><span>(</span><span>&#34;:memory:&#34;</span><span>)</span>
<span>connection</span><span>.</span><span>create_function</span><span>(</span><span>&#34;clip&#34;</span><span>,</span> <span>1</span><span>,</span> <span>clip</span><span>)</span>
<span>cursor</span> <span>=</span> <span>connection</span><span>.</span><span>cursor</span><span>()</span>
<span>cursor</span><span>.</span><span>executescript</span><span>(</span><span>SETUP</span><span>)</span>
<span>for</span> <span>row</span> <span>in</span> <span>cursor</span><span>.</span><span>execute</span><span>(</span><span>&#34;select num, clip(num) from example;&#34;</span><span>).</span><span>fetchall</span><span>():</span>
    <span>print</span><span>(</span><span>row</span><span>)</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/embedded_python.out">out/embedded_python.out</a></p>
  <div><div><pre><code>(-10, 0)
(10, 10)
(20, 20)
(30, 20)
</code></pre></div>  </div>

  <ul>
    <li>SQLite calls back into Python to execute the function</li>
    <li>Other databases can run Python (and other languages) in the database server process</li>
    <li>Be careful</li>
  </ul>

</section>
<section>

  <h2 id="handle-dates-and-times">95: handle dates and times</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/dates_times.py">src/dates_times.py</a></p>
  <div><div><pre><code><span>from</span> <span>datetime</span> <span>import</span> <span>date</span>
<span>import</span> <span>sqlite3</span>


<span># Convert date to ISO-formatted string when writing to database
</span><span>def</span> <span>_adapt_date_iso</span><span>(</span><span>val</span><span>):</span>
    <span>return</span> <span>val</span><span>.</span><span>isoformat</span><span>()</span>


<span>sqlite3</span><span>.</span><span>register_adapter</span><span>(</span><span>date</span><span>,</span> <span>_adapt_date_iso</span><span>)</span>


<span># Convert ISO-formatted string to date when reading from database
</span><span>def</span> <span>_convert_date</span><span>(</span><span>val</span><span>):</span>
    <span>return</span> <span>date</span><span>.</span><span>fromisoformat</span><span>(</span><span>val</span><span>.</span><span>decode</span><span>())</span>


<span>sqlite3</span><span>.</span><span>register_converter</span><span>(</span><span>&#34;date&#34;</span><span>,</span> <span>_convert_date</span><span>)</span>

<span>SETUP</span> <span>=</span> <span>&#34;&#34;&#34;</span><span>\
</span><span>create table events(
    happened date not null,
    description text not null
);
&#34;&#34;&#34;</span>

<span>connection</span> <span>=</span> <span>sqlite3</span><span>.</span><span>connect</span><span>(</span><span>&#34;:memory:&#34;</span><span>,</span> <span>detect_types</span><span>=</span><span>sqlite3</span><span>.</span><span>PARSE_DECLTYPES</span><span>)</span>
<span>cursor</span> <span>=</span> <span>connection</span><span>.</span><span>cursor</span><span>()</span>
<span>cursor</span><span>.</span><span>execute</span><span>(</span><span>SETUP</span><span>)</span>

<span>cursor</span><span>.</span><span>executemany</span><span>(</span>
    <span>&#34;insert into events values (?, ?);&#34;</span><span>,</span>
    <span>[(</span><span>date</span><span>(</span><span>2024</span><span>,</span> <span>1</span><span>,</span> <span>10</span><span>),</span> <span>&#34;started tutorial&#34;</span><span>),</span> <span>(</span><span>date</span><span>(</span><span>2024</span><span>,</span> <span>1</span><span>,</span> <span>29</span><span>),</span> <span>&#34;finished tutorial&#34;</span><span>)],</span>
<span>)</span>

<span>for</span> <span>row</span> <span>in</span> <span>cursor</span><span>.</span><span>execute</span><span>(</span><span>&#34;select * from events;&#34;</span><span>).</span><span>fetchall</span><span>():</span>
    <span>print</span><span>(</span><span>row</span><span>)</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/dates_times.out">out/dates_times.out</a></p>
  <div><div><pre><code>(datetime.date(2024, 1, 10), &#39;started tutorial&#39;)
(datetime.date(2024, 1, 29), &#39;finished tutorial&#39;)
</code></pre></div>  </div>

  <ul>
    <li><code>sqlite3.PARSE_DECLTYPES</code> tells <code>sqlite3</code> library to use converts based on declared column types</li>
    <li>Adapt on the way in, convert on the way out</li>
  </ul>

</section>
<section>

  <h2 id="sql-in-jupyter-notebooks">96: SQL in Jupyter notebooks</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/install_jupysql.sh">src/install_jupysql.sh</a></p>
  

  <ul>
    <li>And then inside the notebook:</li>
  </ul>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/load_ext.text">src/load_ext.text</a></p>
  

  <ul>
    <li>Loads extension</li>
  </ul>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/jupyter_connect.text">src/jupyter_connect.text</a></p>
  <div><div><pre><code>%sql sqlite:///data/penguins.db
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/jupyter_connect.out">out/jupyter_connect.out</a></p>
  <div><div><pre><code>Connecting to &#39;sqlite:///data/penguins.db&#39;
</code></pre></div>  </div>

  <ul>
    <li>Connects to database
      <ul>
        <li><code>sqlite://</code> with two slashes is the protocol</li>
        <li><code>/data/penguins.db</code> (one leading slash) is a local path</li>
      </ul>
    </li>
    <li>Single percent sign <code>%sql</code> introduces one-line command</li>
    <li>Use double percent sign <code>%%sql</code> to indicate that the rest of the cell is SQL</li>
  </ul>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/jupyter_select.text">src/jupyter_select.text</a></p>
  <div><div><pre><code>%%sql
select species, count(*) as num
from penguins
group by species;
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/jupyter_select.out">out/jupyter_select.out</a></p>
  <div><div><pre><code>Running query in &#39;sqlite:///data/penguins.db&#39;
</code></pre></div>  </div>

  <table>
  <thead>
    <tr>
      <th>species</th>
      <th>num</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Adelie</td>
      <td>152</td>
    </tr>
    <tr>
      <td>Chinstrap</td>
      <td>68</td>
    </tr>
    <tr>
      <td>Gentoo</td>
      <td>124</td>
    </tr>
  </tbody>
</table>

</section>
<section>

  <h2 id="pandas-and-sql">97: Pandas and SQL</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/install_pandas.sh">src/install_pandas.sh</a></p>
  

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/select_pandas.py">src/select_pandas.py</a></p>
  <div><div><pre><code><span>import</span> <span>pandas</span> <span>as</span> <span>pd</span>
<span>import</span> <span>sqlite3</span>

<span>connection</span> <span>=</span> <span>sqlite3</span><span>.</span><span>connect</span><span>(</span><span>&#34;db/penguins.db&#34;</span><span>)</span>
<span>query</span> <span>=</span> <span>&#34;select species, count(*) as num from penguins group by species;&#34;</span>
<span>df</span> <span>=</span> <span>pd</span><span>.</span><span>read_sql</span><span>(</span><span>query</span><span>,</span> <span>connection</span><span>)</span>
<span>print</span><span>(</span><span>df</span><span>)</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/select_pandas.out">out/select_pandas.out</a></p>
  <div><div><pre><code>species  num
0     Adelie  152
1  Chinstrap   68
2     Gentoo  124
</code></pre></div>  </div>

  <ul>
    <li>Be careful about datatype conversion</li>
  </ul>

</section>
<section>

  <h2 id="polars-and-sql">98: Polars and SQL</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/install_polars.sh">src/install_polars.sh</a></p>
  <div><div><pre><code>pip <span>install </span>polars pyarrow adbc-driver-sqlite
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/select_polars.py">src/select_polars.py</a></p>
  <div><div><pre><code><span>import</span> <span>polars</span> <span>as</span> <span>pl</span>

<span>query</span> <span>=</span> <span>&#34;select species, count(*) as num from penguins group by species;&#34;</span>
<span>uri</span> <span>=</span> <span>&#34;sqlite:///db/penguins.db&#34;</span>
<span>df</span> <span>=</span> <span>pl</span><span>.</span><span>read_database_uri</span><span>(</span><span>query</span><span>,</span> <span>uri</span><span>,</span> <span>engine</span><span>=</span><span>&#34;adbc&#34;</span><span>)</span>
<span>print</span><span>(</span><span>df</span><span>)</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/select_polars.out">out/select_polars.out</a></p>
  <div><div><pre><code>shape: (3, 2)
┌───────────┬─────┐
│ species   ┆ num │
│ ---       ┆ --- │
│ str       ┆ i64 │
╞═══════════╪═════╡
│ Adelie    ┆ 152 │
│ Chinstrap ┆ 68  │
│ Gentoo    ┆ 124 │
└───────────┴─────┘
</code></pre></div>  </div>

  <ul>
    <li>The <a href="#g:uri">Uniform Resource Identifier</a> (URI) specifies the database</li>
    <li>The query is the query</li>
    <li>Use the ADBC engine instead of the default ConnectorX</li>
  </ul>

</section>
<section>

  <h2 id="object-relational-mapper">99: object-relational mapper</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/orm.py">src/orm.py</a></p>
  <div><div><pre><code><span>from</span> <span>sqlmodel</span> <span>import</span> <span>Field</span><span>,</span> <span>Session</span><span>,</span> <span>SQLModel</span><span>,</span> <span>create_engine</span><span>,</span> <span>select</span>


<span>class</span> <span>Department</span><span>(</span><span>SQLModel</span><span>,</span> <span>table</span><span>=</span><span>True</span><span>):</span>
    <span>ident</span><span>:</span> <span>str</span> <span>=</span> <span>Field</span><span>(</span><span>default</span><span>=</span><span>None</span><span>,</span> <span>primary_key</span><span>=</span><span>True</span><span>)</span>
    <span>name</span><span>:</span> <span>str</span>
    <span>building</span><span>:</span> <span>str</span>


<span>engine</span> <span>=</span> <span>create_engine</span><span>(</span><span>&#34;sqlite:///db/assays.db&#34;</span><span>)</span>
<span>with</span> <span>Session</span><span>(</span><span>engine</span><span>)</span> <span>as</span> <span>session</span><span>:</span>
    <span>statement</span> <span>=</span> <span>select</span><span>(</span><span>Department</span><span>)</span>
    <span>for</span> <span>result</span> <span>in</span> <span>session</span><span>.</span><span>exec</span><span>(</span><span>statement</span><span>).</span><span>all</span><span>():</span>
        <span>print</span><span>(</span><span>result</span><span>)</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/orm.out">out/orm.out</a></p>
  <div><div><pre><code>building=&#39;Chesson&#39; name=&#39;Genetics&#39; ident=&#39;gen&#39;
building=&#39;Fashet Extension&#39; name=&#39;Histology&#39; ident=&#39;hist&#39;
building=&#39;Chesson&#39; name=&#39;Molecular Biology&#39; ident=&#39;mb&#39;
building=&#39;TGVH&#39; name=&#39;Endocrinology&#39; ident=&#39;end&#39;
</code></pre></div>  </div>

  <ul>
    <li>An <a href="#g:orm">object-relational mapper</a> (ORM) translates table columns to object properties and vice versa</li>
    <li>SQLModel relies on Python type hints</li>
  </ul>

</section>
<section>

  <h2 id="relations-with-orm">100: relations with ORM</h2>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/src/orm_relation.py">src/orm_relation.py</a></p>
  <div><div><pre><code><span>class</span> <span>Staff</span><span>(</span><span>SQLModel</span><span>,</span> <span>table</span><span>=</span><span>True</span><span>):</span>
    <span>ident</span><span>:</span> <span>str</span> <span>=</span> <span>Field</span><span>(</span><span>default</span><span>=</span><span>None</span><span>,</span> <span>primary_key</span><span>=</span><span>True</span><span>)</span>
    <span>personal</span><span>:</span> <span>str</span>
    <span>family</span><span>:</span> <span>str</span>
    <span>dept</span><span>:</span> <span>Optional</span><span>[</span><span>str</span><span>]</span> <span>=</span> <span>Field</span><span>(</span><span>default</span><span>=</span><span>None</span><span>,</span> <span>foreign_key</span><span>=</span><span>&#34;department.ident&#34;</span><span>)</span>
    <span>age</span><span>:</span> <span>int</span>


<span>engine</span> <span>=</span> <span>create_engine</span><span>(</span><span>&#34;sqlite:///db/assays.db&#34;</span><span>)</span>
<span>SQLModel</span><span>.</span><span>metadata</span><span>.</span><span>create_all</span><span>(</span><span>engine</span><span>)</span>
<span>with</span> <span>Session</span><span>(</span><span>engine</span><span>)</span> <span>as</span> <span>session</span><span>:</span>
    <span>statement</span> <span>=</span> <span>select</span><span>(</span><span>Department</span><span>,</span> <span>Staff</span><span>).</span><span>where</span><span>(</span><span>Staff</span><span>.</span><span>dept</span> <span>==</span> <span>Department</span><span>.</span><span>ident</span><span>)</span>
    <span>for</span> <span>dept</span><span>,</span> <span>staff</span> <span>in</span> <span>session</span><span>.</span><span>exec</span><span>(</span><span>statement</span><span>):</span>
        <span>print</span><span>(</span><span>f</span><span>&#34;</span><span>{</span><span>dept</span><span>.</span><span>name</span><span>}</span><span>: </span><span>{</span><span>staff</span><span>.</span><span>personal</span><span>}</span><span> </span><span>{</span><span>staff</span><span>.</span><span>family</span><span>}</span><span>&#34;</span><span>)</span>
</code></pre></div>  </div>

  <p><a href="https://www.wildlondon.org.uk/blog/david-bradshaw/out/orm_relation.out">out/orm_relation.out</a></p>
  <div><div><pre><code>Histology: Divit Dhaliwal
Molecular Biology: Indrans Sridhar
Molecular Biology: Pranay Khanna
Histology: Vedika Rout
Genetics: Abram Chokshi
Histology: Romil Kapoor
Molecular Biology: Ishaan Ramaswamy
Genetics: Nitya Lal
</code></pre></div>  </div>

  <ul>
    <li>Make foreign keys explicit in class definitions</li>
    <li>SQLModel automatically does the join
      <ul>
        <li>The two staff with no department aren’t included in the result</li>
      </ul>
    </li>
  </ul>

</section>
<section>

  <h2 id="appendices">☆ Appendices</h2>

  <h2 id="terms">☆  Terms</h2>

  <dl>
  
  <dt id="g:1_to_1">1-to-1 relation</dt>
  <dd>A relationship between two tables in which each record from the first table matches exactly one record from the second and vice versa.
</dd>
  
  <dt id="g:1_to_many">1-to-many relation</dt>
  <dd>A relationship between two tables in which each record from the first table matches zero or more records from the second, but each record from the second table matches exactly one record from the first.
</dd>
  
  <dt id="g:aggregation">aggregation</dt>
  <dd>Combining several values to produce one.
</dd>
  
  <dt id="g:aggregation_func">aggregation function</dt>
  <dd>A function used to produce one value from many, such as maximum or addition.
</dd>
  
  <dt id="g:alias">alias</dt>
  <dd>An alternate name used temporarily for a table or column.
</dd>
  
  <dt id="g:atomic">atomic</dt>
  <dd>An operation that cannot be broken into smaller operations.
</dd>
  
  <dt id="g:autoincrement">autoincrement</dt>
  <dd>Automatically add one to a value.
</dd>
  
  <dt id="g:base_case">base case</dt>
  <dd>A starting point for recursion that does not depend on previous recursive calculations.
</dd>
  
  <dt id="g:blob">Binary Large Object (blob)</dt>
  <dd>Bytes that are handled as-is rather than being interpreted as numbers, text, or other data types.
</dd>
  
  <dt id="g:cross_join">cross join</dt>
  <dd>A join that creates the cross-product of rows from two tables.
</dd>
  
  <dt id="g:cte">common table expression (CTE)</dt>
  <dd>A temporary table created at the start of a query, usually to simplify writing the query.
</dd>
  
  <dt id="g:consistent">consistent</dt>
  <dd>A state in which all constraints are satisfied, e.g., all columns contain allowed values and all foreign keys refer to primary keys.
</dd>
  
  
  <dd>A subquery that depends on a value or values from the enclosing query, and which must therefore be executed once for each of those values.
</dd>
  
  <dt id="g:cursor">cursor</dt>
  <dd>A reference to the current location in the results of an ongoing query.
</dd>
  
  <dt id="g:data_migration">data migration</dt>
  <dd>To move data from one form to another, e.g., from one set of tables to a new set or from one DBMS to another.
</dd>
  
  <dt id="g:database">database</dt>
  <dd>A collection of data that can be searched and retrieved.
</dd>
  
  <dt id="g:dbms">database management system (DBMS)</dt>
  <dd>A program that manages a particular kind of database.
</dd>
  
  <dt id="g:denormalization">denormalization</dt>
  <dd>To deliberately introduce duplication or other violate normal forms, typically to improve query performance.
</dd>
  
  <dt id="g:durable">durable</dt>
  <dd>Guaranteed to survive shutdown and restart.
</dd>
  
  <dt id="g:er_diagram">entity-relationship diagram</dt>
  <dd>A graphical depiction of the relationships between tables in a database.
</dd>
  
  <dt id="g:filter">filter</dt>
  <dd>To select records based on whether they pass some Boolean test.
</dd>
  
  <dt id="g:foreign_key">foreign key</dt>
  <dd>A value in one table that identifies a primary key in another table.
</dd>
  
  <dt id="g:full_outer_join">full outer join</dt>
  <dd>See <a href="#g:cross_join">cross join</a>.
</dd>
  
  <dt id="g:group">group</dt>
  <dd>A set of records that share a common property, such as having the same value in a particular column.
</dd>
  
  <dt id="g:in_memory_db">in-memory database</dt>
  <dd>A database that is stored in memory rather than on disk.
</dd>
  
  <dt id="g:index">index</dt>
  <dd>An auxiliary data structure that enables faster access to records.
</dd>
  
  <dt id="g:infinite_recursion">infinite recursion</dt>
  <dd>See “infinite recursion”.
</dd>
  
  <dt id="g:isolated">isolated</dt>
  <dd>The appearance of having executed in an otherwise-idle system.
</dd>
  
  <dt id="g:join">join</dt>
  <dd>To combine records from two tables.
</dd>
  
  <dt id="g:join_condition">join condition</dt>
  <dd>The criteria used to decide which rows from each table in a join are combined.
</dd>
  
  <dt id="g:join_table">join table</dt>
  <dd>A table that exists solely to enable information from two tables to be connected.
</dd>
  
  <dt id="g:left_outer_join">left outer join</dt>
  <dd>A join that is guaranteed to keep all rows from the first (left) table. Columns from the right table are filled with actual values if available or with null otherwise.
</dd>
  
  <dt id="g:many_to_many">many-to-many relation</dt>
  <dd>A relationship between two tables in which each record from the first table may match zero or more records from the second and vice versa.
</dd>
  
  <dt id="g:materialized_view">materialized view</dt>
  <dd>A view that is stored on disk and updated on demand.
</dd>
  
  <dt id="g:normal_form">normal form</dt>
  <dd>One of several (loosely defined) rules for organizing data in tables.
</dd>
  
  <dt id="g:nosql">NoSQL database</dt>
  <dd>Any database that doesn’t use the relational model.
</dd>
  
  <dt id="g:null">null</dt>
  <dd>A special value representing “not known”.
</dd>
  
  <dt id="g:orm">object-relational mapper (ORM)</dt>
  <dd>A library that translates objects in a program into database queries and the results of those queries back into objects.
</dd>
  
  <dt id="g:path_expression">path expression</dt>
  <dd>An expression identifying an element or a set of elements in a JSON structure.
</dd>
  
  <dt id="g:primary_key">primary key</dt>
  <dd>A value or values in a database table that uniquely identifies each record in that table.
</dd>
  
  <dt id="g:query">query</dt>
  <dd>A command to perform some operation in a database (typically data retrieval).
</dd>
  
  <dt id="g:recursive_cte">recursive CTE</dt>
  <dd>A common table expression that refers to itself. Every recursive CTE must have a base case and a recursive case.
</dd>
  
  <dt id="g:recursive_case">recursive case</dt>
  <dd>The second or subsequent step in self-referential accumulation of data.
</dd>
  
  <dt id="g:rdbms">relational database management system (RDBMS)</dt>
  <dd>A database management system that stores data in tables with columns and rows.
</dd>
  
  <dt id="g:subquery">subquery</dt>
  <dd>A query used within another query.
</dd>
  
  <dt id="g:table_valued_func">table-valued function</dt>
  <dd>A function that returns multiple values rather than a single value.
</dd>
  
  <dt id="g:temporary_table">temporary table</dt>
  <dd>A table that is explicitly constructed in memory outside any particular query.
</dd>
  
  <dt id="g:ternary_logic">ternary logic</dt>
  <dd>A logic based on three values: true, false, and “don’t know” (represented as null).
</dd>
  
  <dt id="g:tombstone">tombstone</dt>
  <dd>A marker value added to a record to show that it is no longer active. Tombstones are used as an alternative to deleting data.
</dd>
  
  <dt id="g:trigger">trigger</dt>
  <dd>An action that runs automatically when something happens in a database, typically insertion or deletion.
</dd>
  
  <dt id="g:upsert">upsert</dt>
  <dd>To update a record if it exists or insert (create) a new record if it doesn’t.
</dd>
  
  <dt id="g:uri">Uniform Resource Identifier (URI)</dt>
  <dd>A string that identifies a resource (such as a web page or database) and the protocol used to access it.
</dd>
  
  <dt id="g:view">view</dt>
  <dd>A rearrangement of data in a database that is regenerated on demand.
</dd>
  
  <dt id="g:window_func">window function</dt>
  <dd>A function that combines data from adjacent rows in a database query’s result.
</dd>
  
</dl>

  <h2 id="acknowledgments">☆  Acknowledgments</h2>

  <p>This tutorial would not have been possible without:</p>

  <ul>
    <li><a href="http://andialbrecht.de/">Andi Albrecht</a>’s <a href="https://pypi.org/project/sqlparse/"><code>sqlparse</code></a> module</li>
    <li><a href="https://tapoueh.org/">Dimitri Fontaine</a>’s <a href="https://theartofpostgresql.com/"><em>The Art of PostgreSQL</em></a></li>
    <li>David Rozenshtein’s <em>The Essence of SQL</em> (now sadly out of print)</li>
  </ul>

  <p>I would also like to thank the following for spotting issues, making suggestions, or submitting changes:</p>

  <ul>
    <li>Sam Hames</li>
    <li>Robert Kern</li>
    <li>Roy Pardee</li>
    <li>Manos Pitsidianakis</li>
    <li>Daniel Possenriede</li>
    <li>Adam Rosien</li>
    <li>Thomas Sandmann</li>
    <li>Simon Willison</li>
  </ul>

</section>


    </div></div>
  </body>
</html>
