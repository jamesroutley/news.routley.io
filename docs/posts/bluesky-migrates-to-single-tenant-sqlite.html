<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/bluesky-social/atproto/pull/1705">Original</a>
    <h1>Bluesky migrates to single-tenant SQLite</h1>
    
    <div id="readability-page-1" class="page"><div>
        <div>
  
  <task-lists disabled="" sortable="">
    <div>
      <p dir="auto">This refactors the PDS to use a single-tenant SQLite datastore.</p>
<p dir="auto">Each user has their own SQLite file that stores their repo and private account state.</p>
<p dir="auto">Repo signing keys for each repo are stored alongside the SQLite file.</p>
<p dir="auto">We also switch out the abstraction for interacting with user data to an <code>ActorStore</code>. The primary difference between the <code>ActorStore</code> and our previous &#34;services&#34; is that the <code>ActorStore</code> has different classes for reading &amp; writing. Since SQLite does not support concurrent transactions, the <code>ActorStore</code> requires that you clearly &#34;transact&#34; with the store in order to make a write.</p>
<p dir="auto">We also maintain an LRUCache for signing keys and databases. We allow 30k open file handles and 30k keys held in memory. When a database falls out of the cache, we ensure that we close the file handle.</p>
<p dir="auto">We also introduce 3 separate SQLite databases for managing service state:</p>
<ul dir="auto">
<li>service DB for account info, invite codes, refresh tokens etc</li>
<li>did cache DB with only one table for caching DID resolutions</li>
<li>sequencer DB with only one table for sequencing repo updates across all repos on a service.</li>
</ul>
<p dir="auto">Each of these SQLite files in run in WAL mode to allow for concurrent reads and streaming replication.</p>
<p dir="auto">We intend to ship the PDS distribution with <a href="https://litestream.io/" rel="nofollow">Litestream</a> or something similar</p>
    </div>
  </task-lists>
  
</div>

      </div></div>
  </body>
</html>
