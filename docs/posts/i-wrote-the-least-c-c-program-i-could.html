<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://briancallahan.net/blog/20220220.html">Original</a>
    <h1>I wrote the least-C C program I could</h1>
    
    <div id="readability-page-1" class="page">
	<a name="top"></a>
	<div id="main">
	    
	    <p>academic, developer, with an eye towards a brighter techno-social life</p>
	    <hr/>
		
	    <hr/>
	</div>
<h5 id="prev"><a href="https://briancallahan.net/blog/20220205.html">[prev]</a></h5>
<h5 id="next">[next]</h5>
    <h2 id="title">2022-02-20</h2>
<p>All source code for this blog post can be found <a href="https://github.com/ibara/cpaint">here</a>.</p>
<p>As a fun afternoon challenge, I decided to write a C program that looked nothing like C. Not necessarily obfuscated, though there is <a href="https://www.ioccc.org/">a competition for that</a> if you are so inclined.</p>
<p>No, instead I thought to myself, what if I turned C into an entirely different language, then wrote a program in that language, then used the C compiler to compile the program. That to me sounds like the least-C C program I could write.</p>
<p>Here it is, in all its glory:</p>
<pre>#include&#34;cpaint.h&#34;

var a, b, c, h, i, l, v, x, y, q, w, p size 65535 ，
packed n size 13 ꞉integer ；

procedure display(r,s,c) ;
begin
  LOOP
    call A(Z) ;
    call H(y,x) ;
    call B(Z)
  POOL ;

  y ꞉＝ r;
  x ꞉＝ s;

  call A(c) ;
  call H(y,x) ;
  call B(c) ;

  call refresh()
end ;

procedure fill(y,x,c,a) ;
begin
  if(y&lt;0 or y&gt;w-1 or x&lt;0 or x&gt;q-1 or c ＝ a or Z ＜＞ a)fill꞉＝ -1 ;

  call draw(c) ;
  call fill(y+1,x,c,a) ;
  call fill(y-1,x,c,a) ;
  call fill(y,x-1,c,a) ;
  call fill(y,x+1,c,a)
end ;

procedure save(r,s) ;
begin
  i ꞉＝ 0 ;
  while(i&lt;13)do
  begin
    n[i] ꞉＝ 0 ;
    i ꞉＝ i+1
  end ;

  call move(w&gt;&gt;1,(q&gt;&gt;1)-6) ;
  call printw(&#34;Save: &#34;) ;
  call echo() ;
  call getnstr(n,12) ;
  call noecho() ;

  call open(n,&#34;w+&#34;) ;
  call writeChar(83) ;
  call writeChar(w) ;
  call writeChar(q) ;

  LOOP
    call writeChar(Z)
  POOL ;

  y ꞉＝ r;
  x ꞉＝ s;

  call close ;
  call move(y,x)
end ;

procedure load(packed ʌ n) ;
begin
  call open(n,&#34;r&#34;) ;
  call check ;

  LOOP
    readln(c);
    call draw(c)
  POOL ;

  c ꞉＝ 0;

  call close
end ;

procedure m() ;
begin
  l ꞉＝ 0 ;
  v ꞉＝ 1 ;

  call A(c) ;
  call H(0,0) ;
  call B(c) ;
  call refresh() ;

  while(v)do
  begin
    read(inp) ;
    &#39;/&#39;:l ꞉＝ not l ; if(l)call draw(c) ; OK
    &#39;k&#39;:y ꞉＝ y-1 ; if(y&lt;0)y ꞉＝ 0 ; if(l)call draw(c) ; OK
    &#39;j&#39;:y ꞉＝ y+1 ; if(y&gt;w-1)y ꞉＝ w-1 ; if(l)call draw(c) ; OK
    &#39;h&#39;:x ꞉＝ x-1 ; if(x&lt;0)x ꞉＝ 0 ; if(l)call draw(c) ; OK
    &#39;l&#39;:x ꞉＝ x+1 ; if(x&gt;q-1)x ꞉＝ q-1 ; if(l)call draw(c) ; OK
    &#39; &#39;:call draw(c) ; OK
    &#39;c&#39;:c ꞉＝ c+1 ; if(c ＝ M)c ꞉＝ 0 ; OK
    &#39;d&#39;:call draw(15) ; OK
    &#39;f&#39;:call fill(y,x,c,Z) ; OK
    &#39;s&#39;:call save(y,x) ; OK
    &#39;q&#39;:v ꞉＝ 0 ; OK
    &#39;v&#39;:c ꞉＝ c-1 ; if(c ＝ N)c ꞉＝ M-1 ; CALL display(y,x,c)
  end
end ;

procedure main(I c,packed ʌ ʌ v) ;
begin
  call start ;
  call getmaxyx(stdscr,w,q) ;
  if(w&gt;M)w ꞉＝ M ;if(q&gt;M)q ꞉＝ M ;
  call start_color() ;

  while(x&lt;M)do
  begin
    call init_pair(x,x,x) ;
    x ꞉＝ x+1
  end ;

  LOOP
    call draw(15)
  POOL ;

  if(c ＝ 2)call load(v[c-1]) ; call display(0,0,0) ; call m() ; call endwin()
end ;

call main．
</pre>
<p>I hear what you&#39;re saying: &#34;This is literally not C. It has all the markings of a Pascal language, with the semicolon as statement separator rather than statement terminator, the <code>:=</code> for assignment, and maybe some Algol with the <code>LOOP .. POOL</code> syntax.&#34; It even has the Pascal-style return assignment where you assign the function a value and that&#39;s its return value (see the <code>fill</code> procedure).</p>
<p>Caught me. I had recently heard that <a href="https://en.wikipedia.org/wiki/Arthur_Whitney_(computer_scientist)">Arthur Whitney</a>, author of the <a href="https://en.wikipedia.org/wiki/A%2B_(programming_language)">A+</a>, <a href="https://en.wikipedia.org/wiki/K_(programming_language)">k</a>, and <a href="https://en.wikipedia.org/wiki/Q_(programming_language_from_Kx_Systems)">q</a> languages (which are array programming languages like <a href="https://en.wikipedia.org/wiki/APL_(programming_language)">APL</a> and <a href="https://en.wikipedia.org/wiki/J_(programming_language)">J</a>), would use the C preprocessor to create his own language and then write the implementation of his language in that self-defined language. I decided to try to do the same.</p>
<p>I loosely based my self-defined language off of <a href="https://en.wikipedia.org/wiki/PL/0">PL/0</a>, which we <a href="https://briancallahan.net/blog/20210814.html">wrote a compiler</a> for previously (yes, I know I have to finish the self-hosting blog series; I will finish it).</p>
<p>The hero of this exercise was the fact that the C compilers understand UTF-8 characters as valid characters for identifiers. I use lots of characters that look like ASCII but are in fact not ASCII but nonetheless accepted as valid identifier characters. The C preprocessor happily accepts macros that transform these identifiers into whatever you need them to. You can see the hidden away header file <a href="https://github.com/ibara/cpaint/blob/main/cpaint.h">here</a>. Creative use of whitespace helped finish it off.</p>
<p>If you want to see what the C code truly looks like, trying running:</p>
<pre>$ cc -E cpaint.c | clang-format | less
</pre>
<p>For a short afternoon, it was amusing. I probably won&#39;t try something like this again. But it was fun to discover some interesting ways to abuse the C preprocessor.</p>
<p>Oh, and if you actually want to use the program, it&#39;s a simple terminal paint program.</p>
<p><a href="#top"><img alt="Top" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAICAYAAADJEc7MAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4wkWDyUKJxzXegAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAUklEQVQY02Ocd/j/fwY0kGjDwMhACPz//5/h////DPMO//8PYxODWXAZOP8Iw39k22F8uBg2G7Gx0cWYGMgEWJ2aaMPAiO5UDOcTGxjogUe2UwHwdJDZUucW5QAAAABJRU5ErkJggg=="/></a></p>
<a href="https://briancallahan.net/blog/feed.xml"><img alt="RSS" src="https://briancallahan.net/blog/media/pic_rss.gif"/></a>
	</div>
  </body>
</html>
