<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://git.cuvoodoo.info/kingkevin/board/src/branch/hdmi_firewall/README.md">Original</a>
    <h1>HDMI Firewall</h1>
    
    <div id="readability-page-1" class="page"><p><span id="count_prompt">You can not select more than 25 topics</span>
			<span id="format_prompt">Topics must start with a letter or number, can include dashes (&#39;-&#39;) and can be up to 35 characters long.</span>
		</p><div>
	
	<div>
		
	


		<div>
			
				<p>The HDMI firewall prevents devices from hacking HDMI equipment, and vice-versa.</p>
<p><img src="https://git.cuvoodoo.info/kingkevin/board/media/branch/hdmi_firewall/picture/dongle_v1_front.webp" title="front" height="250"/>
<img src="https://git.cuvoodoo.info/kingkevin/board/media/branch/hdmi_firewall/picture/dongle_v1_back.webp" title="back" height="250"/></p>
<p>HDMI is mainly used to transfer audio and video, but also offers a number of additional features (e.g. HPD, CEC, HEAC, MHL).
This increases the attack surface, and since the security of their implement in embedded devices is far from ideal, an attacker could exploit them and inject malicious code.
Now your unsuspicious video equipment is compromised and threatens your IT/network security.
And your monitor could then in turn hack back any other device connected to it.</p>
<p>For example, let&#39;s imagine you invite an external guest for a presentation inside your company.
You offer to connect to a video-projector so he can show his slides.
This is the perfect opportunity for the guest to hack the video-projector.
Next time an employee connects to this projector, his laptop is hacked back.
And voila, the innocent guest managed to infiltrate your company network, and can exfiltrate confidential information.</p>
<p>The HDMI firewall blocks all additional interfaces, and only allows audio and video data transfer.
It is based on the research of Pierre-Michel Ricordel and José Lopes Esteves from ANSSI/SDE/ST/LSF presented at the IT security conference <a href="https://sstic.org/2021/presentation/un_pare_feu_pour_le_hdmi/" rel="nofollow">SSTIC 2021</a>.
Some security research and vulnerabilities around CEC and EDID are listed in <a href="https://www.sstic.org/media/SSTIC2021/SSTIC-actes/un_pare_feu_pour_le_hdmi/SSTIC2021-Slides-un_pare_feu_pour_le_hdmi-lopes-esteves_ricordel.pdf" rel="nofollow">slide 4</a>.</p>

<p>The HDMI firewall comes with a generic HD profile, but this might not correspond to the capabilities of your monitor.
The resulting image could be distorted, or completely missing.
Thus, you first have to copy the Extended Display Identification Data (EDID) information of the equipment to protect.
This data includes information such as the supported resolutions.
You can read it out using the I²C-based Display Data Channel (DDC) interface.
Copy this EDID data on the EEPROM of the HDMI firewall, and break the tab using pliers to enable write protection.
It will prevent attackers from injecting any malicious payload.
This only has to be done once (per monitor to protect).
Copying the EDID can be done using the <a href="https://git.cuvoodoo.info/kingkevin/board/src/branch/hdmi_firewall_programmer" rel="nofollow">HDMI firewall programmer</a>, or following the instructions under <strong>installation</strong>.</p>
<p>Plug in the HDMI firewall in the monitor to be protected.
Connect the cable going to the untrusted device on the HDMI firewall.
Your equipment is now protected.</p>
<p>To re-write the EEPROM of the HDMI firewall in case you want to protect another monitor, you can re-disable write protection by putting a solder blob across the two pads marked WP.</p>
<p>By default, the 5V supplied by the device is forwarded to the monitor.
To further reduce the attack surface, you can disable this by cutting the trace between the two pads marked 5V.
The risk is that some monitors rely on this signal to detect when a device is plugged in.</p>

<p>High-bandwidth Digital Content Protection (HDCP) is not supported since the DDC interface is limited to the EDID information.</p>

<p>A few HDMI firewalls are available on <a href="https://www.tindie.com/products/cuvoodoo/hdmi-firewall/" rel="nofollow">tindie</a>.</p>
<p>The schematic pdf and board gerbers are available as <a href="https://git.cuvoodoo.info/kingkevin/board/releases/tag/hdmi_firewall_v1" rel="nofollow">release</a>.</p>
<p>The next version should have the <a href="https://git.cuvoodoo.info/kingkevin/board/src/branch/hdmi_firewall_programmer" rel="nofollow">HDMI firewall programmer</a> integrated, and maybe some fixes reported by other users (I only tested for my simple case, and with 6 monitors).</p>

<p>To protect the monitor, the HDMI firewall only forwards the signal lines used for audio/video (A/V) data transfer (D0, D1, D2, CK).
All other signal lines are unconnected (CEC, SDA, SCL, utility/HEAC+, HPD).
This will block all non A/V interfaces (e.g. DDC, HPD, CEC, HEAC, MHL)
The SDA/SCL lines used for the DDC interface to provide the EDID information to the device are connected to an EEPROM on the firewall.
This is where you need to copy the monitor information to.
This limits the DDC interface to the EDID information.</p>

<p>For the HDMI firewall to be used correctly, it needs a copy of the EDID data from the monitor to protect.</p>
<p>These instructions are for Linux.
For Windows see the instructions provided in the <a href="https://www.sstic.org/media/SSTIC2021/SSTIC-actes/un_pare_feu_pour_le_hdmi/SSTIC2021-Slides-un_pare_feu_pour_le_hdmi-lopes-esteves_ricordel.pdf" rel="nofollow">original research slides</a> (untested).</p>
<p>Install tools to read/write I²C devices:</p>
<ul>
<li>for Debian-based distributions</li>
</ul>
<pre><code>sudo apt install i2c-tools
</code></pre><p>Make the I²C buses user accessible (under /dev/i2c-*):</p>
<pre><code>sudo modprobe i2c-dev
</code></pre><p>Now we have to figure out which I²C bus corresponds to the HDMI port.
First list the available buses:</p>
<pre><code>sudo i2cdetect -l
</code></pre><p>You should see something like this:</p>
<pre><code>i2c-0	smbus     	SMBus PIIX4 adapter port 0 at 0b00	SMBus adapter
i2c-1	smbus     	SMBus PIIX4 adapter port 2 at 0b00	SMBus adapter
i2c-2	smbus     	SMBus PIIX4 adapter port 1 at 0b20	SMBus adapter
i2c-3	i2c       	AMDGPU DM i2c hw bus 0          	I2C adapter
i2c-4	i2c       	AMDGPU DM i2c hw bus 1          	I2C adapter
i2c-5	i2c       	AMDGPU DM i2c hw bus 2          	I2C adapter
i2c-6	i2c       	AMDGPU DM i2c hw bus 3          	I2C adapter
i2c-7	i2c       	AMDGPU DM aux hw bus 0          	I2C adapter
i2c-8	i2c       	AMDGPU DM aux hw bus 2          	I2C adapter
i2c-9	i2c       	AMDGPU DM aux hw bus 3          	I2C adapter
i2c-10	i2c       	DPMST                           	I2C adapter
i2c-11	i2c       	DPMST                           	I2C adapter
</code></pre><p>Candidate buses are 3 to 9, used by the GPU (number after i2c- in the first column).</p>
<p>Disconnect everything from the HDMI port, and scan for devices on each I²C bus (replace BUS with the bus number):</p>
<pre><code>sudo i2cdetect -y BUS
</code></pre><p>Since nothing is connected, no device should be detected, and the output should look like this:</p>
<pre><code>     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:                         -- -- -- -- -- -- -- --
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
70: -- -- -- -- -- -- -- --
</code></pre><p>Now connect the HDMI firewall on the device side to your HDMI port and re-scan for devices.
If you see the following result, you found the I²C bus of the HDMI port.
Else continue with the next bus.</p>
<pre><code>     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:                         -- -- -- -- -- -- -- --
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
50: 50 51 52 53 54 55 56 57 -- -- -- -- -- -- -- --
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
70: -- -- -- -- -- -- -- --
</code></pre><p>Now connect the monitor you want to copy the EDID from directly to the HDMI port.</p>
<p>We will use the EEPROM module to dump the EDID:</p>
<pre><code>sudo modprobe eeprom
</code></pre><p>Display the EDID overview and ensure the Model Name corresponds to your monitor (here a DELL 2408WFP on bus number 4):</p>
<pre><code>ddcmon 4

Checksum:               OK
EDID Version:           1.3
Manufacturer ID:        DEL
Model Number:           0xA02C
Model Name:             DELL 2408WFP
Serial Number:          G286H9642GLS
Manufacture Time:       2009-W23
Display Input:          Digital
Monitor Size (cm):      52x32
Gamma Factor:           2.20
DPMS Modes:             Active Off, Suspend, Standby
Color Mode:             RGB Multicolor
Vertical Sync (Hz):     56-76
Horizontal Sync (kHz):  30-83
Max Pixel Clock (MHz):  170
Timing:                 640x480 @ 60 Hz
Timing:                 640x480 @ 75 Hz
Timing:                 720x400 @ 70 Hz
Timing:                 800x600 @ 60 Hz
Timing:                 800x600 @ 72 Hz
Timing:                 800x600 @ 75 Hz
Timing:                 1024x768 @ 87 Hz (interlaced)
Timing:                 1024x768 @ 75 Hz
Timing:                 1152x864 @ 75 Hz
Timing:                 1280x1024 @ 60 Hz
Timing:                 1600x1200 @ 60 Hz
Timing:                 1920x1200 @ 60 Hz
</code></pre><p>Dump the complete EDID (replace BUS with corresponding bus number):</p>
<pre><code>cat /sys/bus/i2c/devices/BUS-0050/eeprom &gt; edid.bin
</code></pre><p>Connect the HDMI firewall device port to your HDMI output.
Ensure Write Protect is disabled (by default until the tab is broken, and no solder across the WP pads is added).
<strong>WARNING</strong>: writing data to the wrong I²C bus could permanently damage your computer or other devices.</p>
<p>Free the I²C access to the EEPROM:</p>
<pre><code>sudo modprobe -r eeprom
</code></pre><p>Write the extracted EDID data to the HDMI firewall (replace BUS with corresponding bus number):</p>
<pre><code>for addr in `seq 0 255`; do echo $addr; sudo i2cset -y BUS 0x50 $addr 0x`xxd -p -l 1 -s $addr edid.bin`; done
</code></pre><p>To verify the data has been written correctly, compare original data with the one on the EEPROM:</p>
<pre><code># display original dumped data
xxd -g 1 edid.bin
# display data written on EEPROM
sudo i2cdump -y BUS 0x50
</code></pre><p>Once writing the EDID to the HDMI firewall memory succeeded, break the tab using pliers to write protect the memory.
This will prevent attackers from storing a malicious payload.
You can now use the HDMI firewall (only for this monitor).</p>
<p>Feel free to put shrink tube or tape around the HDMI firewall.
This will prevent the electronics from getting shorted when entering in contact with neighbouring metal objects.</p>

<p>If the monitor does not detect the device or does not display anything (but should), try to re-enable the 5V forward (as per default) by putting solder across the 5V pads.
In the HDMI cable there is a 5V line, with power provided by the device.
In our case we use it is to power the HDMI firewall memory.
Forwarding it to the monitor can be disabled by cutting the trace across the 5V pads.</p>
<p>If the device does not detect the monitor or HDMI firewall, or writing the EDID data to the HDMI firewall fails (better indication), try connecting the HDMI firewall with another (better quality) HDMI cable.</p>

<h2 id="user-content-xrandr">xrandr</h2>
<p>xrandr can also dump the EDID information:</p>
<pre><code>xrandr --properties
</code></pre><h2 id="user-content-sysfs">sysfs</h2>
<p>sysfs also exposes the raw EDID information (change path accordingly):</p>
<pre><code>edid-decode /sys/devices/pci0000:00/0000:00:08.1/0000:05:00.0/drm/card0/card0-HDMI-A-1/edid
</code></pre><h2 id="user-content-i²c-non-root">I²C non-root</h2>
<p>to access I²C buses as non-root:</p>
<pre><code># add UDEV rule
cat &lt;&lt; EOF | sudo tee /etc/udev/rules.d/20-i2c.rules
KERNEL==&#34;i2c-[0-9]*&#34;, GROUP=&#34;i2c&#34;
EOF
# give user access to devices (you have to re-login in for the change to take effect)
sudo groupadd i2c
sudo gpasswd -a $USER i2c
# reload rules
sudo udevadm control --reload-rules
sudo udevadm trigger
</code></pre><h2 id="user-content-erase">erase</h2>
<p>If you want to clear the HDMI firewall memory (for usage with another monitor):</p>
<pre><code>for page in `seq 50 57`; do echo 0x$page; for addr in `seq 0 255`; do echo $addr; sudo i2cset -y BUS 0x$page $addr 0xff; done; done
</code></pre><h2 id="user-content-edid-decode">edid-decode</h2>
<p>To parse and display the complete EDID information, you can use edid-decode.</p>
<ul>
<li>for Debian-based distributions</li>
</ul>
<pre><code>sudo apt-get install edid-decode
</code></pre><ul>
<li>for Arch-based distributions</li>
</ul>
<pre><code>pikaur -S edid-decode-git
</code></pre><p>To view the dumped EDID information:</p>
<pre><code>edid-decode edid.bin
</code></pre><h2 id="user-content-edid-rw">edid-rw</h2>
<p><a href="https://github.com/bulletmark/edid-rw" rel="nofollow">EDID-RW</a> makes reading and writing EDID a bit easier.</p>
<p>Install these prerequisites:</p>
<ul>
<li>for Debian-based distributions</li>
</ul>
<pre><code>sudo apt-get install python3-smbus
</code></pre><ul>
<li>for Arch-based distributions</li>
</ul>
<pre><code>pikaur -S python-smbus-git
</code></pre><p>Get EDID-RW:</p>
<pre><code>git clone https://github.com/bulletmark/edid-rw
cd edid-rw/
</code></pre><p>To retrieve the EDID data from the monitor you connected:</p>
<pre><code>sudo ./edid-rw 4 &gt; edid.bin
</code></pre><p>To write the dumped EDID on the HDMI firewall memory:</p>
<pre><code>sudo ./edid-rw -w 4 &lt; edid.bin
</code></pre><p>To verify of the data has been written correctly, read it back:</p>
<pre><code>sudo ./edid-rw 4 | edid-decode
</code></pre>
			
		</div>
	</div>
</div></div>
  </body>
</html>
