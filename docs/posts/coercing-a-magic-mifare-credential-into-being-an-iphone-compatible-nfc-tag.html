<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ewpratten.com/blog/iphone-mifare-magic">Original</a>
    <h1>Coercing a Magic MIFARE credential into being an iPhone-compatible NFC tag</h1>
    
    <div id="readability-page-1" class="page"><div>
        
        <div>
            
            
            <p><span>My life is full of very obscure problems</span>
            
        </p></div>
        

        <p>Over the years, I have lent out many NFC cards to friends for use as virtual business cards.</p>

<p>I program these cards to open portfolio websites or directly share contact information when scanned with a mobile phone. I even embedded one of these into my conference badge at an animation industry event last year.</p>

<p>Being <em>that person</em> with the custom NFC badge at an event is generally a great way to be remembered and has a habit of starting interesting conversations too.</p>

<p>Unfortunately, my pile of spares has a few cards that I could never get to work on iPhones for some reason. I‚Äôd never bothered to really investigate why, but I recently made the metal connection that I had mixed in some ‚ÄúMagic‚Äù MIFARE cards with my regular generic ISO14443-A stock.</p>

<p>While absolutely magical in ability, the Magic MIFARE cards ‚Äúcan‚Äôt be read‚Äù by iPhones for reasons that nobody online seems to quite agree with eachother about.</p>

<p>So.. here I am to teach you how to get a Magic MIFARE card to be read by an iPhone.</p>

<h2 id="card-preparation">Card preparation</h2>

<p>I am using a Magic MIFARE Gen 1a credential for this demonstration. Since I‚Äôm not tinkering with the UID, I assume this will work on other cards, but I have none to try with.</p>

<p>Performing a quick HF scan with a Proxmark3 reveals the following info about this blank card:</p>

<div><div><pre><code>[usb] pm3 --&gt; hf search
 üïë  Searching for ISO14443-A tag...
[=] ---------- ISO14443-A Information ----------
[+]  UID: 00 56 78 BB   ( ONUID, re-used )
[+] ATQA: 00 04
[+]  SAK: 08 [2]
[+] Possible types:
[+]    MIFARE Classic 1K
[=] proprietary non iso14443-4 card found, RATS not supported
[=]

[+] Magic capabilities... Gen 1a
[+] Magic capabilities... Gen 4 GDM / USCUID ( Gen1 Magic Wakeup )
[+] Prng detection....... weak

[?] Hint: use `hf mf c*` magic commands
[?] Hint: use `hf mf gdm* --gen1a` magic commands
[?] Hint: try `hf mf` commands


[+] Valid ISO 14443-A tag found
</code></pre></div></div>

<p>Since this is a magic card, I‚Äôm going to take a moment to re-wipe it to make sure I‚Äôm starting from a blank slate.
This way, there won‚Äôt be any encryption keys in my way for the next steps.</p>

<div><div><pre><code>[usb] pm3 --&gt; hf mf cwipe
 üïí wipe block 63
[+] Card wiped successfully
</code></pre></div></div>

<p>Now, using <code>ndefformat</code>, I‚Äôll turn this into a blank NDEF tag.</p>

<div><div><pre><code>[usb] pm3 --&gt; hf mf ndefformat
[-] ‚õî Error - can&#39;t find `hf-mf-005678BB-key.bin`
 üïö Formatting block 63
</code></pre></div></div>

<p>At this point, many Android devices will be able to interact with this tag normally, but iPhones still refuse to acknowledge its existence.</p>

<h2 id="iphone-magic">iPhone magic</h2>

<p>Luckily, its very easy to turn this now-formatted card into something iPhones will play nicely with.</p>

<p>To do this, you need access to a modern iPhone with the <a href="https://apps.apple.com/us/app/nfc-tools/id1252962749">NFC Tools</a> application installed.</p>

<p>Once installed, you‚Äôll need to open the app‚Äôs settings and switch to ‚Äúcompatibility mode‚Äù for a moment.</p>

<p><img src="https://ewpratten.com/assets/blog/iphone-mifare-magic/IMG_0496.PNG"/>
    <img src="https://ewpratten.com/assets/blog/iphone-mifare-magic/IMG_0497.PNG"/>
</p>

<p>Next, tap the card to the phone in ‚Äúread‚Äù mode to make sure the app can see it. Then, switch to ‚Äúwrite‚Äù mode and write some arbitrary data to the card. I chose ‚ÄúHello, World!‚Äù.</p>

<p><img src="https://ewpratten.com/assets/blog/iphone-mifare-magic/IMG_0498.PNG"/>
    <img src="https://ewpratten.com/assets/blog/iphone-mifare-magic/IMG_0499.PNG"/>
</p>

<p>This write operation performs some kind of additional format operation I don‚Äôt quite understand. For whatever reason, this particular series of events puts the card into a state that all iPhones can now recognize.</p>

<p>Back on the Proxmark, I‚Äôll take a moment to read back the data I wrote from the iPhone.</p>

<div><div><pre><code>[usb] pm3 --&gt; hf mf ndefread
[#] Auth error
[=] reading data from tag
 üïë 14

[=] --- NDEF parsing ----------------
[+] --- NDEF NULL block ---

[+] --- NDEF Message ---
[+] Found NDEF message ( 20 bytes )

[+] Record 1
[=] -----------------------------------------------------
[=]
[=] Text
[=]     UTF 8... en, Hello, World!
[=]
[?] Try `hf mf ndefread -v` for more details
</code></pre></div></div>

<h2 id="writing-records">Writing records</h2>

<p>Now, with the properly formatted card, we can write NDEF records to it like normal.</p>

<p>For this example, I‚Äôm using the <code>ndeflib</code> Python library to create records for me.</p>

<div><div><pre><code><span>$ </span>python3 <span>-m</span> pip <span>install </span>ndeflib
</code></pre></div></div>

<p>The following snippet generates an NDEF-formatted URI record for my website.</p>

<div><div><pre><code><span>&gt;&gt;&gt;</span> <span>import</span> <span>ndef</span>
<span>&gt;&gt;&gt;</span> <span>&#34;</span><span>00000312</span><span>&#34;</span> <span>+</span> <span>b</span><span>&#34;&#34;</span><span>.</span><span>join</span><span>(</span><span>ndef</span><span>.</span><span>message_encoder</span><span>([</span><span>ndef</span><span>.</span><span>UriRecord</span><span>(</span><span>&#34;</span><span>https://ewpratten.com</span><span>&#34;</span><span>)])).</span><span>hex</span><span>()</span> <span>+</span> <span>&#34;</span><span>fe</span><span>&#34;</span>
<span>&#39;</span><span>00000312d1010e550465777072617474656e2e636f6dfe</span><span>&#39;</span>
</code></pre></div></div>

<p>Pasting the resulting string into the Proxmark shell, I can write the record to the card.</p>

<div><div><pre><code>[usb] pm3 --&gt; hf mf ndefwrite --1k -d 00000312d1010e550465777072617474656e2e636f6dfe
 üïõ 5
</code></pre></div></div>

<h2 id="success">Success</h2>

<p>And just like that, the card works on an iPhone!</p>

<p><img src="https://ewpratten.com/assets/blog/iphone-mifare-magic/IMG_0500.PNG" alt=""/></p>

    </div></div>
  </body>
</html>
