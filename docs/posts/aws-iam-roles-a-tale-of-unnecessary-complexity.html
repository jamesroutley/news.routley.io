<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://infosec.rodeo/posts/thoughts-on-aws-iam/">Original</a>
    <h1>AWS IAM Roles, a tale of unnecessary complexity</h1>
    
    <div id="readability-page-1" class="page"><div><p>This is going to be a highly opinionated blog post. I think AWS is great and use it daily, but their implementation of IAM is unnecessarily complicated.</p><blockquote><p>If you can‚Äôt tolerate critics, don‚Äôt do anything new or interesting.</p><p><em>Jeff Bezos</em></p></blockquote><p>Let‚Äôs get started.</p><p>The <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_evaluation-logic.html#policy-eval-denyallow">policy evaluation logic</a> reads like a James Joyce novel:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/blog/aws_policy_evaluation_logic.png" alt="Policy Evaluation Logic"/></p><p>Does it need to be this complex?</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/blog/the-office-steve-carell.gif" alt="Why are you like this"/></p><p>Because AWS is doubling down on a flawed Organizational model.</p><h2 id="a-bit-of-history">A bit of history</h2><p>We need to go back to the <del>history books</del> <a href="https://web.archive.org/web/20070101134207/http://www.amazon.com/aws/">Wayback Machine</a> to understand why things are so. <a href="https://en.wikipedia.org/wiki/Timeline_of_Amazon_Web_Services">First</a> came the services (this <a href="https://gist.github.com/chitchcock/1281611">rant</a> comes to mind) - S3, SQS and EC2. At that time, ‚ÄúAmazon Web Services‚Äù was hardly a ‚Äúcloud provider‚Äù, but rather a few disjointed building blocks. It took <a href="https://aws.amazon.com/blogs/aws/iam-identity-access-management/">many years</a> for the current IAM service to be released. Back then it fit the purpose, namely managing authentication and authorization <strong>in a single AWS account</strong>.</p><p>The introduction of IAM came with 2 types of principals:</p><ul><li>Users, representing human actors</li><li>Groups, a container for users allowing for ‚Äú<strong>role</strong> based access control‚Äù</li></ul><p>This new service also included the concept of policies, which allowed defining what a principal could do (identity-based policies) as well as what a resource allowed for (resource-based policies).</p><p>A few years later, the ‚Äú<strong>roles</strong> for EC2 instances‚Äù feature was <a href="https://aws.amazon.com/blogs/aws/iam-roles-for-ec2-instances-simplified-secure-access-to-aws-service-apis-from-ec2/">released</a>:</p><blockquote><p>Today we are introducing AWS Identity and Access management (IAM) roles for EC2 instances, a new feature that makes it even easier for you to securely access AWS service APIs from your EC2 instances. You can create an IAM role, assign it a set of permissions, launch EC2 instances with the IAM role, and then AWS access keys with the specified permissions are automatically made available on those EC2 instances.</p></blockquote><p>This made sense - no more need to hardcode an IAM users‚Äô API keys in your applications and workloads!</p><p>This now meant we had a third type of principal:</p><ul><li><strong>Roles</strong>, an ‚Äúidentity‚Äù that an instance, workload or application impersonates to gain API permissions</li></ul><p>The implementation of this new principal required the ability to provide EC2 instances with temporary credentials. This was initially only available via the <a href="http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/AESDG-chapter-instancedata.html">EC2 Instance Metadata Service</a>, but was <a href="https://aws.amazon.com/blogs/security/aws-security-token-service-is-now-available-in-every-aws-region/">later</a> generalized by the AWS Security Token Service (STS) service. With this new service, you could now easily get temporary credentials for any role. Neat!</p><p>As adoption of the cloud grew, organizations started to identify the need for using multiple AWS accounts. This posed a serious problem, because AWS‚Äô architecture didn‚Äôt easily support managing access and permissions for multi-account scenarios. <strong>This</strong> is where things started going sideways. Instead of refactoring the architecture, AWS did what AWS does best - it built a new service.</p><p>I can envision a meeting in an unmarked office building, downtown Seattle. A team is hashing out the details of the new ‚ÄúOrganizations‚Äù service they‚Äôve been tasked to build, allowing management of multiple accounts by a single entity. They come to the topic of AWS account access:</p><ul><li>Product Manager: <em>How are people going to authenticate to all these accounts?</em></li><li>Engineer: <em>Why don‚Äôt we just use roles?</em></li><li>Product Manager: <em>Roles? I thought those were just for EC2?</em></li><li>Engineer: <em>Well you know, IAM roles can already be <del>impersonated</del> assumed by a principal in another account so‚Ä¶ there‚Äôs really nothing we need to add? Let‚Äôs just use this mechanism to allow access to an Organization‚Äôs sub-accounts and call it a day.</em></li><li>Product Manager: <em>But won‚Äôt that be confusing? Since you know, roles are for ‚Äúinstances, workloads or applications?‚Äù</em></li><li>Engineer: <em>Hey man, we can either do it this way or take 100x more time and re-architect the whole thing.</em></li><li>Product Manager: <em>Sold!</em></li></ul><p>And just like that, AWS Organizations as we know it was <a href="https://aws.amazon.com/blogs/aws/aws-organizations-policy-based-management-for-multiple-aws-accounts/">born</a>.</p><p>How does organizations implement sub-account access via roles? Well, you create <a href="https://docs.aws.amazon.com/singlesignon/latest/userguide/permissionsetsconcept.html">permission sets</a> in SSO, which are essentially IAM policies. When you ‚Äúattach‚Äù a permission set to an SSO user or group <strong>in a given sub-account</strong>, Organizations will automagically create a role in that account with the permissions defined in the set. Once the user (or member of the group) authenticates to SSO, they‚Äôre presented with the accounts they can access by assuming (via SSO, not directly) the role created by Organizations.</p><p>A consequence of this change was to further remove any coherent meaning for the term ‚Äúrole‚Äù, as it didn‚Äôt strictly refer to:</p><ul><li><em>programmatic identities</em>, since any principal (users, groups &amp; roles) can potentially assume any role and Organizations relies on role assumption for sub-account access</li><li><em>federated identities</em> (as in IdP/SSO), since workloads as well as AWS services can assume a role</li><li><strong>Role</strong> Based Access Control (RBAC), which is a standard term in the industry (and is <em>the traditional authorization model used in IAM</em><sup id="fnref:1" role="doc-noteref"><a href="#fn:1" rel="footnote">1</a></sup>)<ul><li>To be fair, this was an issue from the start</li></ul></li></ul><p>So <strong>what</strong> is an IAM role then? Simply put, it‚Äôs a principal (i.e. an identity) with no long-lived credentials, that can be impersonated for arbitrary purposes.</p><h2 id="looking-around">Looking around</h2><p>All right, so we‚Äôve established the <a href="https://aws.amazon.com/blogs/aws/happy-10th-birthday-aws-identity-and-access-management/">timeline</a> for AWS IAM‚Äôs progress, and asserted that AWS Organizations is when things went wrong. Could it have been any other way?</p><p>I think it would have, if AWS hadn‚Äôt treated ‚Äúmulti-account management‚Äù as ‚Äújust another service‚Äù. So why did they?</p><blockquote><p>No problem can be solved from the same level of consciousness that created it.</p><p><em>Albert Einstein</em></p></blockquote><p>This is where Google Cloud Platform, Google‚Äôs (not-yet-canned üòÖ) cloud provider comes into play. GCP‚Äôs infancy was similar to AWS‚Äô in that the <a href="https://en.wikipedia.org/wiki/Google_Cloud_Platform">initial offering</a> was a single service, App Engine. But Google had two advantages over Amazon:</p><ul><li>By being released later (GA in 2011, the same year AWS launched IAM), they surely benefited from the ability to learn from AWS‚Äô achievements and mistakes.<ul><li>They even copied things like the super unsafe and not really useful <code>allAuthenticatedUsers</code> bucket <a href="https://cloud.google.com/storage/docs/access-control/lists#scopes">ACL</a>, which AWS <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/managing-acls.html">highly recommends against</a> (and have hidden away from the web console).</li></ul></li><li>Google already had the G Suite identity provider (now Google Workspace), removing the need for a new authentication mechanism.</li></ul><p>The result? GCP‚Äôs <a href="https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy">Resource Hierarchy</a>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/blog/gcp_resource_hierarchy.png" alt="GCP Resource Hierarchy"/></p><blockquote><p>The purpose of the Google Cloud resource hierarchy is two-fold:</p><ul><li>Provide a hierarchy of ownership, which binds the lifecycle of a resource to its immediate parent in the hierarchy.</li><li>Provide attach points and inheritance for access control and organization policies.</li></ul><p>Metaphorically speaking, the Google Cloud resource hierarchy resembles the file system found in traditional operating systems as a way of organizing and managing entities hierarchically. Generally, each resource has exactly one parent. <strong>This hierarchical organization of resources enables you to set access control policies and configuration settings on a parent resource, and the policies and Identity and Access Management (IAM) settings are inherited by the child resources.</strong></p></blockquote><p>The brilliant thing with this implementation is that it ties permissions (e.g. read access to storage buckets) to their location (e.g. the buckets in the <code>production</code> project), which provides <strong>context</strong>. In AWS, policies/permissions exists within the whole AWS account they belong to. You need to add specific <code>Conditions</code> , or to define the <code>Resources</code> to which the permissions apply to scope down access. In practice, this is rarely implemented comprehensively and leads to significant complexity. And that‚Äôs if you‚Äôre creating the permissions yourself - AWS-managed permissions will apply to everything in that account.</p><p>Thanks to its ease of use, GCP‚Äôs resource hierarchy also fosters better isolation of environments. I can‚Äôt tell you how many times I‚Äôve seen large, mature organizations have their production, staging and development environments in the same AWS account (often the Organization‚Äôs management account, which is excluded from Security Control Policies). Compounded with the above, the end result is an environment rich in privilege escalation and lateral movement vectors.</p><p>What about the process required for a GCP user to access the different levels of the hierarchy? Easy - if a user has permissions granted in that project (it‚Äôs really <em>if a user is assigned a <strong>role</strong> in that project</em>, but we‚Äôre already confused enough with the terminology), then they can use those permissions. No need for additional principals, role assumption chains or overly complex edge cases that <a href="https://ermetic.com/blog/aws/diving-deeply-into-iam-policy-evaluation-highlights-from-aws-reinforce-session-iam433/">almost no one understands</a>.</p><p>And when it comes to security, simpler often leads to safer.</p><h3 id="gcp-is-not-a-panacea">GCP is not a panacea</h3><p>GCP IAM is definitely not perfect. When auditing GCP organizations we often find issues such as:</p><ol><li>Too many permissions granted at the Organizational node, which are then inherited by the rest of the resource tree</li><li>Lack of a defined resource hierarchy, which limits assigning roles in a manner that adheres to the principle of least privilege</li><li>An overuse of basic roles, granting too many permissions</li></ol><p>The difference is that these are sub-par configurations, which are easier to fix as they are primarily caused by not making the most of GCP‚Äôs resource hierarchy, rather than the architecture forcing complexity and misconfigurations.</p><p>To remediate the above:</p><ol><li>Grant permissions closer to where they are needed</li><li>Restructure the resource hierarchy, which is easy enough as folders and projects can be <a href="https://cloud.google.com/resource-manager/docs/moving-projects-folders">moved</a></li><li>Use predefined or custom roles</li></ol><h2 id="what-id-like-to-see">What I‚Äôd like to see</h2><p>Here are some changes that would help improve what I‚Äôve outline above.</p><h3 id="stop-saying-role">Stop saying ‚Äúrole‚Äù</h3><p>It may be too late, but the term is a misnomer. IAM roles aren‚Äôt roles, they are service identities. Or service principals. Or service accounts. Calling programmatic identities ‚Äúroles‚Äù is incorrect and confusing. Roles relate to tasks and the permissions required to complete them - they are not <strong>an</strong> identity, they <strong>relate to</strong> an identity.</p><p>While we‚Äôre at it, saying ‚Äúassuming‚Äù a role makes no sense. It‚Äôs <em>impersonating</em>, or simply <em>getting temporary credentials for the identity</em>.</p><h3 id="make-users-first-class-citizens">Make users first class citizens</h3><p>If we can‚Äôt rename roles, can we at least stop using them for everything? Couldn‚Äôt identities created in AWS SSO simply exist in the Organization‚Äôs sub-accounts?</p><p>Something like this:</p><ul><li>Current: Attaching a permission set creates a role in the sub-account that the SSO user can assume to get access to said sub-account.</li><li>Proposed: Attaching a permission set creates a representation of the SSO user in the sub-account. The SSO user can then get temporary tokens (i.e. create a session) in that account (just create a new <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_identifiers.html#identifiers-arns">identifier</a>), which has the permissions granted by the permission set.</li></ul><h3 id="no-more-single-accounts-organizations-are-the-default">No more single accounts, Organizations are the default</h3><p>Take a break from being ‚Äúfirst‚Äù and replicate the competition‚Äôs wins for a change. Follow the same model GCP, Azure and even OCI implement and make the creation of an Organization the default when you sign up for AWS.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/blog/table_head.png" alt="Table Head"/></p><p>Is this a significant task? Sure! Akin to retiring <a href="https://aws.amazon.com/blogs/aws/ec2-classic-is-retiring-heres-how-to-prepare/">EC2-Classic</a>.</p><p>This would also solve an issue we see <strong>constantly</strong>, where a company started off with a single account where they deployed all their infrastructure. At some point they figure they need more accounts so they set up Organizations with this account as their management account. Then they realize they need to decouple the management account from the infrastructure, e.g. because SCPs don‚Äôt apply to that account. Chaos ensues.</p><h2 id="closing-thoughts">Closing thoughts</h2><p>I hope this rant is useful to someone, if only to highlight that it‚Äôs okay to be critical of something most of the industry is using, and that things can always be improved upon.</p><p><em>Many thanks to Patrick Farwick for his insightful comments and feedback.</em></p></div></div>
  </body>
</html>
