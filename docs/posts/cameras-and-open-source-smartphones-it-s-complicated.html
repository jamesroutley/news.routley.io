<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://puri.sm/posts/cameras-its-complicated/">Original</a>
    <h1>Cameras and Open Source Smartphones: It’s Complicated</h1>
    
    <div id="readability-page-1" class="page"><div><div><div><p dir="auto" data-sourcepos="1:1-1:350">Two years before I started working on cameras for the <a href="https://puri.sm/products/librem-5-usa/">Librem 5</a>, I thought the work would go something like this: first, write a driver, then maybe calibrate the colors, connect to the camera support infrastructure, and bam! PureOS users on the phone would then do teleconferences with Jitsi or snap selfies with Cheese, just like they can on laptops.</p><p dir="auto" data-sourcepos="3:1-3:466">The title of this blog post already gives away what happened. I wrote a driver and connected it up, yet teleconferences remain in the future. In fact, <a href="https://source.puri.sm/Librem5/millipixels/">our version</a> of <a href="https://gitlab.com/postmarketOS/megapixels" target="_blank" rel="nofollow noreferrer noopener">Megapixels</a> is the only app that can shoot photos on the Librem 5 today, and that’s because it received special attention. How come? Aren’t cameras pretty simple in the end? Light in, pixels out. That’s pretty plug-and-play!</p><p dir="auto" data-sourcepos="3:1-3:466">Well actually, no. Cameras can be made of a multitude of components, and light sensors are just one piece of the puzzle. There are cameras that output raw light values, but the whole module also includes mechanical parts like a flash light, focus motor, or one for zoom, or maybe active image stabilization actuators. There are also Image Signals Processors (ISPs) which can do a multitude of tasks, like debayering, denoising, lens correction, color balance, color conversions, and more.</p><figure id="attachment_74953"><img src="https://puri.sm/wp-content/uploads/2022/05/1090251.jpg" alt="" width="1024" height="584" srcset="https://puri.sm/wp-content/uploads/2022/05/1090251.jpg 1024w, https://puri.sm/wp-content/uploads/2022/05/1090251-300x171.jpg 300w, https://puri.sm/wp-content/uploads/2022/05/1090251-768x438.jpg 768w" sizes="(max-width: 1024px) 100vw, 1024px"/><figcaption>Librem 5 reworked camera module</figcaption></figure><p dir="auto" data-sourcepos="7:1-7:466">But that’s not surprising. What’s unusual is that despite the diversity of camera modules, laptop cameras generally Just Work. They are so well supported under Linux because they are connected using a protocol called… USB. Yes, laptop cameras are connected over USB! And USB cameras universally support the UVC (USB video class) protocol, which requires the webcam to provide a video stream ready to consume by applications. It’s an amazing achievement to have such standardization.</p><p dir="auto" data-sourcepos="9:1-9:700">However, USB is not the camera protocol typically used on phones. It’s not even universal on <a href="https://github.com/linux-surface/linux-surface/issues/91" target="_blank" rel="nofollow noreferrer noopener">laptops</a>! UVC is really good for basic video recording, because it provides just what typical applications need: automatic adjustment of brightness, focus, and color, and it also provides images that are already <a href="https://en.wikipedia.org/wiki/Demosaicing" target="_blank" rel="nofollow noreferrer noopener">demosaiced</a>. Those are difficult tasks, and completely out of scope for applications like the web browser or a chat client. They should be doing what they do best, rather than switch focus to <a href="https://puri.sm/posts/librem-5-photo-processing-tutorial/">image processing</a>, and UVC helps them a lot by pushing those responsibilities to the camera hardware.</p><p dir="auto" data-sourcepos="11:1-11:283">If you’re a phone maker, you might not be satisfied with UVC taking over those tasks. You might want to have detailed access to the ISP part of your camera module. Or you might want to expose the raw sensor instead, just like the Librem 5 does. Then you can’t rely on UVC any longer.</p><p dir="auto" data-sourcepos="13:1-13:220">Let’s take a look again at the processing steps that are really needed between when the camera receives light and an application presents a video frame. On the left, there’s the UVC baseline, on the right a raw Bayer sensor.<img src="https://puri.sm/wp-content/uploads/2022/05/uvc_vs_Bayer.png" alt="" width="850" height="483" srcset="https://puri.sm/wp-content/uploads/2022/05/uvc_vs_Bayer.png 850w, https://puri.sm/wp-content/uploads/2022/05/uvc_vs_Bayer-300x170.png 300w, https://puri.sm/wp-content/uploads/2022/05/uvc_vs_Bayer-768x436.png 768w" sizes="(max-width: 850px) 100vw, 850px"/>Oh no! There’s a huge gap in functionality when using a Bayer sensor! Our application can’t capture frames until the gap is filled. But what should fill it? We already established that the application <em>should not</em> be responsible for processing. Maybe we can squeeze it back in the module? Sadly, it’s not possible to add new functionality to existing hardware. What’s left is the kernel… perish the thought! Adding image processing code to the kernel is a terrible idea: any bug could cause the crash of the entire system. Let the kernel remain a path to access hardware, and that only.</p><p dir="auto" data-sourcepos="19:1-19:44">There are no more options. Are we in a bind?</p><p dir="auto" data-sourcepos="21:1-21:373">Wait a moment. If you zoom in on any typical application, you will see that… it’s actually not a single thing. It’s made of multiple libraries combined together, each responsible for a different task. For example, your email client doesn’t decode images, libpng does. And your movie player does not compile shaders needed to display the window, it uses an OpenGL library.</p><p dir="auto" data-sourcepos="23:1-23:149">Where’s the library that provides highly processed video streams like those coming from UVC modules? It’s called <a href="https://libcamera.org/" target="_blank" rel="nofollow noreferrer noopener">libcamera</a>.</p><p dir="auto" data-sourcepos="25:1-25:443">Libcamera is not yet old and established like OpenGL. It’s relatively young, just like running GNU/Linux on devices with custom cameras is, so it’s currently not widely used. But once it becomes widespread enough, it could solve our problem of having plug-and-play camera support, regardless of the camera type. In fact, we already wrote about this in our <a href="https://puri.sm/posts/librem-5-photo-processing-tutorial/" target="_blank" rel="nofollow noreferrer noopener">photo processing tutorial</a>.</p><p dir="auto" data-sourcepos="27:1-27:504">That’s where the Librem 5 team has been directing their camera efforts now. We still have a way to go: selecting capture resolutions, forwarding controls, debayering, and auto-adjustment algorithms. We’re progressing slowly, but steadily, helping the library overcome growing pains and get right its internal structure as well as external API. And once we get the functionality we need working, it will be available to others using libcamera: applications and other cameras will have them out of the box.</p><p dir="auto" data-sourcepos="29:1-29:419">Hopefully, by that time, libcamera will reach critical mass, and all applications would be able to use it without fuss, including teleconferencing apps. Then we’ll reach our goal. Meanwhile, you can help everyone get there by <a href="https://libcamera.org/contributing.html" target="_blank" rel="nofollow noreferrer noopener">contributing</a>. If you’re a student, libcamera is also regularly <a href="https://libcamera.org/gsoc-application-guide.html" target="_blank" rel="nofollow noreferrer noopener">a mentor</a> at Google Summer of Code.</p><p dir="auto" data-sourcepos="31:1-31:48">See you on the other side (of a teleconference)!</p><h2>Purism Products and Availability Chart</h2><table id="tablepress-46"><thead><tr><th> </th><th>Model</th><th>Status</th><th>Lead Time</th><th> </th></tr></thead><tbody><tr><td><img src="https://shop.puri.sm/wp-content/uploads/2020/03/librem-mini-1-no-bg-300x300.png" alt="Most Secure PC Purism Librem Mini"/><br/></td><td><a href="https://puri.sm/products/librem-mini/">Librem Mini</a></td><td>In Stock</td><td>10 days</td><td><div> <p><a href="https://puri.sm/products/librem-mini/">Learn More</a> <a href="https://shop.puri.sm/shop/librem-mini/">Buy Now</a></p></div></td></tr><tr><td><img src="https://shop.puri.sm/wp-content/uploads/2019/12/librem-server-persp-800x800-300x300.png" alt="Most Secure Server Purism Librem Servers"/></td><td><a href="https://puri.sm/products/librem-server/">Librem Servers</a></td><td>In Stock</td><td>10 days</td><td><div><p><a href="https://shop.puri.sm/librem-server-notify-me/">Notify Me</a><a href="https://puri.sm/products/librem-server/">Learn More</a> <a href="https://shop.puri.sm/?s=server">Buy Now</a></p></div></td></tr><tr><td><img src="https://shop.puri.sm/wp-content/uploads/2018/09/librem-key-v2-persp-300x300.png" alt="USB Security Token Purism Librem Key"/></td><td><a href="https://puri.sm/products/librem-key/">Librem Key</a></td><td>In Stock</td><td>10 days</td><td><div> <p><a href="https://puri.sm/products/librem-key/">Learn More</a> <a href="https://shop.puri.sm/shop/librem-key/">Buy Now</a></p></div></td></tr><tr><td><img src="https://shop.puri.sm/wp-content/uploads/2020/06/librem14-v1-front-300x300.png" alt="Most Secure Laptop Purism Librem 14"/></td><td><a href="https://puri.sm/products/librem-14/">Librem 14</a></td><td>In Stock</td><td>10 days</td><td><div> <p><a href="https://puri.sm/products/librem-14/">Learn More</a> <a href="https://shop.puri.sm/shop/librem-14/">Buy Now</a></p></div></td></tr><tr><td><img src="https://shop.puri.sm/wp-content/uploads/2018/11/l5-v1-front-300x300.png" alt="Made in USA Phone Purism Librem 5 USA"/></td><td><a href="https://puri.sm/products/librem-5-usa/">Librem 5 USA</a></td><td>In Stock</td><td>90 days</td><td><div> <p><a href="https://puri.sm/products/librem-5-usa/">Learn More</a> <a href="https://shop.puri.sm/shop/librem-5-usa/">Buy Now</a></p></div></td></tr><tr><td><img src="https://shop.puri.sm/wp-content/uploads/2018/11/l5-v1-front-300x300.png"/></td><td><a href="https://puri.sm/products/librem-5/">Librem 5</a></td><td>Currently shipping backlogs</td><td>52 weeks</td><td><div><p><a href="https://shop.puri.sm/librem-5-notify-me/">Notify Me</a><a href="https://puri.sm/products/librem-5/">Learn More</a> <a href="https://shop.puri.sm/shop/librem-5/">Buy Now</a></p></div></td></tr></tbody></table> <p><span>The current product and shipping chart of Purism Librem products, updated on May 6, 2022</span></p></div></div></div></div>
  </body>
</html>
