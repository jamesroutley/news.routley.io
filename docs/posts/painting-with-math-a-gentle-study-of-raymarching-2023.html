<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.maximeheckel.com/posts/painting-with-math-a-gentle-study-of-raymarching/">Original</a>
    <h1>Painting with Math: A Gentle Study of Raymarching (2023)</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>Most of my experience writing GLSL so far focused on enhancing pre-existing Three.js/React Three Fiber scenes that contain diverse geometries and materials with effects that wouldn&#39;t be achievable without shaders, such as my work with <a href="https://blog.maximeheckel.com/posts/refraction-dispersion-and-other-shader-light-effects/">dispersion</a> and <a href="https://blog.maximeheckel.com/posts/the-magical-world-of-particles-with-react-three-fiber-and-shaders/">particle effects</a>. However, during my studies of shaders, I always found my way to <a href="https://https://www.shadertoy.com/">Shadertoy</a>, which contains a multitude of impressive 3D scenes featuring landscapes, clouds, fractals, and so much more, <strong>entirely implemented in GLSL</strong>. No geometries. No materials. Just <em>a single fragment shader</em>.</p>
<p>One video titled <a href="https://www.youtube.com/watch?v=BFld4EBO2RE&amp;ab_channel=InigoQuilez">Painting a Landscape with Math</a> from <a href="https://twitter.com/iquilezles">Inigo Quilez</a> pushed me to learn about the thing behind those 3D shader scenes: <strong>Raymarching</strong>. I was very intrigued by the perfect blend of creativity, code, and math involved in this rendering technique that allows anyone to sculpt and paint entire worlds in just a few lines of code, so I decided to spend my summer time studying every aspect of Raymarching I could through building as many scenes as possible such as the ones below which are the result of these past few months of work. (and more importantly, I took my time to do that to not burnout as the subject can be overwhelming, hence the title ðŸ™‚)</p>
<figure></figure>
<p>In this article, you will find a <em>condensed version</em> of my study of Raymarching to get a gentle head start on building your own shader-powered scenes. It aims to introduce this technique alongside the concept of signed distance functions and give you the tools and building blocks to build increasingly more sophisticated scenes, from simple objects with lighting and shadows to fractals and infinite landscapes.</p>


<section id="snapshots-of-math-demystifying-the-concept-of-raymarching-section"><div><h2 id="snapshots-of-math-demystifying-the-concept-of-raymarching"><a href="#snapshots-of-math-demystifying-the-concept-of-raymarching" aria-hidden="true" tabindex="-1"><span></span></a>Snapshots of Math: demystifying the concept of Raymarching</h2></div>
<p>If you&#39;re already familiar with Three.js or React Three Fiber 3D scenes, you most likely encountered the concepts of geometry, material, and mesh and maybe even built quite a few scenes with those constructs. Under the hood, rendering with them involves a technique called <strong>Rasterization</strong>, the process of converting 3D geometries to pixels on a screen.</p>
<p>Raymarching on the other hand, is an <em>alternative rendering technique</em> to render a 3D scene, without requiring geometries or meshes...</p>
<h3 id="marching-rays"><a href="#marching-rays" aria-hidden="true" tabindex="-1"><span></span></a>Marching rays</h3>
<p>Raymarching consists of <strong>marching step-by-step alongside rays cast from an origin point</strong> (a camera, the observer&#39;s eye, ...) <strong>through each pixel of an output image until they intersect with objects in the scene within a set maximum number of steps</strong>. When an intersection occurs, we draw the resulting pixel.</p>
<p>That&#39;s the simplest explanation I could come up with. However, it never hurts to have a little visualization to go with the definition of a new concept! That&#39;s why I built the widget below illustrating:</p>
<ul>
<li><p>The step-by-step aspect of Raymarching: The visualizer below lets you iterate up to 13 steps.</p></li>
<li><p>The rays cast from a single point of origin (bottom panel)</p></li>
<li><p>and the intersections of those rays with an object resulting in pixels on the fragment shader (top panel)</p></li>
</ul>
<div><div><div><p><span role="presentation">-0.5<!-- -->,<!-- -->0.5</span></p><p><span role="presentation">0.5<!-- -->,<!-- -->0.5</span></p><p><span role="presentation">0<!-- -->,<!-- -->0</span></p><p><span role="presentation">-0.5<!-- -->,<!-- -->-0.5</span></p><p><span role="presentation">0.5<!-- -->,<!-- -->-0.5</span></p></div></div></div>

<h3 id="defining-the-world-with-signed-distance-fields"><a href="#defining-the-world-with-signed-distance-fields" aria-hidden="true" tabindex="-1"><span></span></a>Defining the World with Signed Distance Fields</h3>
<p>The definition I just gave you above is only approximately correct. Usually, when working with Raymarching:</p>
<ul>
<li><p>We won&#39;t go step-by-step with a constant step distance along our rays. That would make the process very long.</p></li>
<li><p>We also won&#39;t be relying on the intersection points between the rays and the object.</p></li>
</ul>
<p>Instead, we will use <strong>Signed Distance Fields</strong>, functions that calculate the shortest distances between the points reached while marching alongside our rays and the surfaces of the objects in our scene. Relying on the distance to a surface lets us define the entire scene with simple math formulas âœ¨.</p>
<p>For each step, calculating and marching that resulting distance along the rays lets us approach those objects until we&#39;re <em>close enough</em> to consider we&#39;ve &#34;hit&#34; the surface and can draw a pixel. The diagrams below showcase this process:</p>
<div data-fullbleed="true"><div><figure><p><img alt="Diagram showcasing the Raymarching process of 3 rays beamed from a single point and marching step-by-step by a distance d obtained through a Signed Distance Field" loading="lazy" width="700" height="398" decoding="async" data-nimg="1" sizes="(max-width: 768px) 120vw, 75vw" srcset="https://images.maximeheckel.com/cdn-cgi/image/width=640,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-sdf_inmjmq.png 640w, https://images.maximeheckel.com/cdn-cgi/image/width=750,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-sdf_inmjmq.png 750w, https://images.maximeheckel.com/cdn-cgi/image/width=828,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-sdf_inmjmq.png 828w, https://images.maximeheckel.com/cdn-cgi/image/width=1080,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-sdf_inmjmq.png 1080w, https://images.maximeheckel.com/cdn-cgi/image/width=1200,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-sdf_inmjmq.png 1200w, https://images.maximeheckel.com/cdn-cgi/image/width=1920,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-sdf_inmjmq.png 1920w, https://images.maximeheckel.com/cdn-cgi/image/width=2048,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-sdf_inmjmq.png 2048w, https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-sdf_inmjmq.png 3840w" src="https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-sdf_inmjmq.png"/></p><figcaption>Diagram showcasing the Raymarching process of 3 rays beamed from a single point and marching step-by-step by a distance d obtained through a Signed Distance Field</figcaption></figure></div></div>
<p>Notice how:</p>
<ul>
<li><p>each step of the raymarching (in green) goes as far as the distance to the object.</p></li>
<li><p>if the distance between a point on our rays and the surface of an object is small enough (under a small value Îµ) we consider we have a hit (in orange).</p></li>
<li><p>if the distance is not under that threshold, we continue the process over and over using our SDF until we reach the maximum amount of steps.</p></li>
</ul>
<p>By using SDFs, we can define a variety of basic shapes, like spheres, boxes, or toruses that can then be combined to make more sophisticated objects (which we&#39;ll see later in this article). Each of these have a specific formula that had to be reverse-engineered from the distance of a point to its surface. For example, the SDF of a sphere is equivalent to:</p>
<div><div><p data-testid="codesnippet-title">SDF for a sphere centered at the origin of the scene</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">sdSphere</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line"> p</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> radius</span><span data-testid="content-line">)</span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>2</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">length</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> radius</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div>
<p>To help you understand why the SDF of a sphere is defined as such, I made the diagram below:</p>
<div data-fullbleed="true"><div><figure><p><img alt="Diagram showcasing 3 points, P1, P2, and P3, being respectively, at a positive distance, small distance, and inside a sphere." loading="lazy" width="700" height="417" decoding="async" data-nimg="1" sizes="(max-width: 768px) 120vw, 75vw" srcset="https://images.maximeheckel.com/cdn-cgi/image/width=640,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-points_s6aqzv.png 640w, https://images.maximeheckel.com/cdn-cgi/image/width=750,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-points_s6aqzv.png 750w, https://images.maximeheckel.com/cdn-cgi/image/width=828,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-points_s6aqzv.png 828w, https://images.maximeheckel.com/cdn-cgi/image/width=1080,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-points_s6aqzv.png 1080w, https://images.maximeheckel.com/cdn-cgi/image/width=1200,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-points_s6aqzv.png 1200w, https://images.maximeheckel.com/cdn-cgi/image/width=1920,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-points_s6aqzv.png 1920w, https://images.maximeheckel.com/cdn-cgi/image/width=2048,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-points_s6aqzv.png 2048w, https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-points_s6aqzv.png 3840w" src="https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-points_s6aqzv.png"/></p><figcaption>Diagram showcasing 3 points, P1, P2, and P3, being respectively, at a positive distance, small distance, and inside a sphere.</figcaption></figure></div></div>
<p>In it:</p>
<ul>
<li><p><code>P1</code> is at a distance <code>d</code> from the surface that is positive since the distance between <code>P1</code> and the center of the sphere <code>c</code> is greater than the radius of the sphere <code>r</code>.</p></li>
<li><p><code>P2</code> is very close to the surface and would be considered a <em>hit</em> since the distance between <code>P2</code> and <code>c</code> is greater than <code>r</code> but lower than <code>Îµ</code>.</p></li>
<li><p><code>P3</code> lies &#34;within&#34; the sphre, and technically we want our Raymarcher to <em>never</em> end up in such use case (at least for what is presented in this article).</p></li>
</ul>

<p>This is where the <em>Math</em> in Raymarching resides: through the definition and the combination of SDFs, we can literally <strong>define entire worlds with math</strong>. To showcase that power however, we first need to create our first &#34;Raymarcher&#34; and put in code the different constructs we just introduced.</p>
</section><section id="our-first-raymarched-scene-section"><div><h2 id="our-first-raymarched-scene"><a href="#our-first-raymarched-scene" aria-hidden="true" tabindex="-1"><span></span></a>Our first Raymarched scene</h2></div>
<p>This introduction to the concept of Raymarching might have left you perplexed as to how one is supposed to get started building anything with it.
Lucky for us, there are many ways to render a Raymarched scene, and for this article we&#39;re going to take the perhaps most obvious approach: use a simple Three.js/React Three Fiber <code>planeGeometry</code> as a canvas, and <em>paint</em> our shader on it.</p>

<h3 id="the-canvas"><a href="#the-canvas" aria-hidden="true" tabindex="-1"><span></span></a>The canvas</h3>
<p>Rendering a shader on top of a fullscreen <code>planeGeometry</code> is the technique I used during this Raymarching study:</p>
<ul>
<li><p>I didn&#39;t want too much time investigating more <em>lightweight</em> solutions.</p></li>
<li><p>I still wanted to have easy access to tools like Leva.</p></li>
<li><p>I was familiar with React Three Fiber&#39;s render loop and still wanted to reuse code I&#39;ve written over the past two years, like uniforms, <code>OrbitControls</code>, mouse movements, etc.</p></li>
</ul>
<p>Below is a code snippet of my <em>canvas</em> that served as the basis for my Raymarching work:</p>
<div><div><p data-testid="codesnippet-title">React Three Fiber scene used as canvas for Raymarching</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">import</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"> </span><span data-testid="content-line">Canvas</span><span data-testid="content-line">,</span><span data-testid="content-line"> useFrame</span><span data-testid="content-line">,</span><span data-testid="content-line"> useThree </span><span data-testid="content-line">}</span><span data-testid="content-line"> </span><span data-testid="content-line">from</span><span data-testid="content-line"> </span><span data-testid="content-line">&#39;@react-three/fiber&#39;</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>2</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">import</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"> useRef</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">Suspense</span><span data-testid="content-line"> </span><span data-testid="content-line">}</span><span data-testid="content-line"> </span><span data-testid="content-line">from</span><span data-testid="content-line"> </span><span data-testid="content-line">&#39;react&#39;</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">import</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">as</span><span data-testid="content-line"> </span><span data-testid="content-line">THREE</span><span data-testid="content-line"> </span><span data-testid="content-line">from</span><span data-testid="content-line"> </span><span data-testid="content-line">&#39;three&#39;</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">import</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"> v4 </span><span data-testid="content-line">as</span><span data-testid="content-line"> uuidv4 </span><span data-testid="content-line">}</span><span data-testid="content-line"> </span><span data-testid="content-line">from</span><span data-testid="content-line"> </span><span data-testid="content-line">&#39;uuid&#39;</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">import</span><span data-testid="content-line"> </span><span data-testid="content-line">fragmentShader</span><span data-testid="content-line"> </span><span data-testid="content-line">from</span><span data-testid="content-line"> </span><span data-testid="content-line">&#39;./fragmentShader.glsl&#39;</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">import</span><span data-testid="content-line"> </span><span data-testid="content-line">vertexShader</span><span data-testid="content-line"> </span><span data-testid="content-line">from</span><span data-testid="content-line"> </span><span data-testid="content-line">&#39;./vertexShader.glsl&#39;</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">const</span><span data-testid="content-line"> </span><span data-testid="content-line">SDF</span><span data-testid="content-line"> </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">props</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">=&gt;</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">const</span><span data-testid="content-line"> mesh </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">useRef</span><span data-testid="content-line">(</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>13</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">const</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"> viewport </span><span data-testid="content-line">}</span><span data-testid="content-line"> </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">useThree</span><span data-testid="content-line">(</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">uTime</span><span data-testid="content-line">:</span><span data-testid="content-line"> </span><span data-testid="content-line">new</span><span data-testid="content-line"> </span><span data-testid="content-line">THREE</span><span data-testid="content-line">.</span><span data-testid="content-line">Uniform</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>17</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">uResolution</span><span data-testid="content-line">:</span><span data-testid="content-line"> </span><span data-testid="content-line">new</span><span data-testid="content-line"> </span><span data-testid="content-line">THREE</span><span data-testid="content-line">.</span><span data-testid="content-line">Uniform</span><span data-testid="content-line">(</span><span data-testid="content-line">new</span><span data-testid="content-line"> </span><span data-testid="content-line">THREE</span><span data-testid="content-line">.</span><span data-testid="content-line">Vector2</span><span data-testid="content-line">(</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>21</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">const</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"> clock </span><span data-testid="content-line">}</span><span data-testid="content-line"> </span><span data-testid="content-line">=</span><span data-testid="content-line"> state</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>22</p><p><span><span data-testid="content-line">    mesh</span><span data-testid="content-line">.</span><span data-testid="content-line">current</span><span data-testid="content-line">.</span><span data-testid="content-line">material</span><span data-testid="content-line">.</span><span data-testid="content-line">uniforms</span><span data-testid="content-line">.</span><span data-testid="content-line">uTime</span><span data-testid="content-line">.</span><span data-testid="content-line">value</span><span data-testid="content-line"> </span><span data-testid="content-line">=</span><span data-testid="content-line"> clock</span><span data-testid="content-line">.</span><span data-testid="content-line">getElapsedTime</span><span data-testid="content-line">(</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>23</p><p><span><span data-testid="content-line">    mesh</span><span data-testid="content-line">.</span><span data-testid="content-line">current</span><span data-testid="content-line">.</span><span data-testid="content-line">material</span><span data-testid="content-line">.</span><span data-testid="content-line">uniforms</span><span data-testid="content-line">.</span><span data-testid="content-line">uResolution</span><span data-testid="content-line">.</span><span data-testid="content-line">value</span><span data-testid="content-line"> </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">new</span><span data-testid="content-line"> </span><span data-testid="content-line">THREE</span><span data-testid="content-line">.</span><span data-testid="content-line">Vector2</span><span data-testid="content-line">(</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>24</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">window</span><span data-testid="content-line">.</span><span data-testid="content-line">innerWidth</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">DPR</span><span data-testid="content-line">,</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>25</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">window</span><span data-testid="content-line">.</span><span data-testid="content-line">innerHeight</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">DPR</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>30</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">&lt;</span><span data-testid="content-line">mesh</span><span data-testid="content-line"> </span><span data-testid="content-line">ref</span><span data-testid="content-line">=</span><span data-testid="content-line">{</span><span data-testid="content-line">mesh</span><span data-testid="content-line">}</span><span data-testid="content-line"> </span><span data-testid="content-line">scale</span><span data-testid="content-line">=</span><span data-testid="content-line">{</span><span data-testid="content-line">[</span><span data-testid="content-line">viewport</span><span data-testid="content-line">.</span><span data-testid="content-line">width</span><span data-testid="content-line">,</span><span data-testid="content-line"> viewport</span><span data-testid="content-line">.</span><span data-testid="content-line">height</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">}</span><span data-testid="content-line">&gt;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>31</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">&lt;</span><span data-testid="content-line">planeBufferGeometry</span><span data-testid="content-line"> </span><span data-testid="content-line">args</span><span data-testid="content-line">=</span><span data-testid="content-line">{</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">}</span><span data-testid="content-line"> </span><span data-testid="content-line">/&gt;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>34</p><p><span><span data-testid="content-line">        </span><span data-testid="content-line">fragmentShader</span><span data-testid="content-line">=</span><span data-testid="content-line">{</span><span data-testid="content-line">fragmentShader</span><span data-testid="content-line">}</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>35</p><p><span><span data-testid="content-line">        </span><span data-testid="content-line">vertexShader</span><span data-testid="content-line">=</span><span data-testid="content-line">{</span><span data-testid="content-line">vertexShader</span><span data-testid="content-line">}</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>45</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">&lt;</span><span data-testid="content-line">Canvas</span><span data-testid="content-line"> </span><span data-testid="content-line">camera</span><span data-testid="content-line">=</span><span data-testid="content-line">{</span><span data-testid="content-line">{</span><span data-testid="content-line"> </span><span data-testid="content-line">position</span><span data-testid="content-line">:</span><span data-testid="content-line"> </span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">6</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">}</span><span data-testid="content-line">}</span><span data-testid="content-line"> </span><span data-testid="content-line">dpr</span><span data-testid="content-line">=</span><span data-testid="content-line">{</span><span data-testid="content-line">DPR</span><span data-testid="content-line">}</span><span data-testid="content-line">&gt;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>46</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">&lt;</span><span data-testid="content-line">Suspense</span><span data-testid="content-line"> </span><span data-testid="content-line">fallback</span><span data-testid="content-line">=</span><span data-testid="content-line">{</span><span data-testid="content-line">null</span><span data-testid="content-line">}</span><span data-testid="content-line">&gt;</span><span data-testid="content-line"></span></span></p></div></pre></div>
<p>I&#39;m also passing a couple of essential uniforms to my <code>shaderMaterial</code>, which I advise you include as well in your own work, as they may become pretty handy to have around:</p>
<ul>
<li><p><code>uResolution</code> contains the current resolution of the window.</p></li>
<li><p><code>uTime</code> represents the time since the scene was rendered on the screen.</p></li>
</ul>

<p>We need to do a few tweaks to our fragment shader before we can start implementing our Raymarcher:</p>
<ol>
<li><p>Normalize our UV coordinates.</p></li>
<li><p>Shift our UV coordinates to be centered.</p></li>
<li><p>Adjust them to the current aspect ratio of the screen.</p></li>
</ol>
<p>These steps allow us to have our coordinate system where the center of the screen is at the coordinates <code>(0, 0)</code> while preserving the appearance of our shader regardless of screen resolutions and aspect ratios (it won&#39;t appear stretched).
That process may be hard to understand at first, but here&#39;s a diagram to illustrate the math involved:</p>
<figure><p><img alt="Diagram illustrating the normalization, shift, and aspect ratio adjustements of our UV coordinates that make sure that our raymarched scenes will be resizable and at the correct aspect ratio." loading="lazy" width="700" height="1079" decoding="async" data-nimg="1" sizes="(max-width: 768px) 120vw, 75vw" srcset="https://images.maximeheckel.com/cdn-cgi/image/width=640,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-uv.png 640w, https://images.maximeheckel.com/cdn-cgi/image/width=750,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-uv.png 750w, https://images.maximeheckel.com/cdn-cgi/image/width=828,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-uv.png 828w, https://images.maximeheckel.com/cdn-cgi/image/width=1080,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-uv.png 1080w, https://images.maximeheckel.com/cdn-cgi/image/width=1200,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-uv.png 1200w, https://images.maximeheckel.com/cdn-cgi/image/width=1920,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-uv.png 1920w, https://images.maximeheckel.com/cdn-cgi/image/width=2048,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-uv.png 2048w, https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-uv.png 3840w" src="https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-uv.png"/></p><figcaption>Diagram illustrating the normalization, shift, and aspect ratio adjustements of our UV coordinates that make sure that our raymarched scenes will be resizable and at the correct aspect ratio.</figcaption></figure>
<h3 id="beaming-rays"><a href="#beaming-rays" aria-hidden="true" tabindex="-1"><span></span></a>Beaming rays</h3>
<p>Let&#39;s implement our Raymarching algorithm step-by-step from the definition established earlier. We need:</p>
<ol>
<li><p>A <code>rayOrigin</code> from where all our rays will emerge from. E.g. <code>vec3(0, 0, 5)</code>.</p></li>
<li><p>A <code>rayDirection</code> equivalent to <code>normalize(vec3(uv, -1.0))</code> to allow us to beam rays in every direction on the screen along the negative z-axis.</p></li>
<li><p>A <code>raymarch</code> function to march from the <code>rayOrigin</code> following the <code>rayDirection</code> and <em>detect</em> when we&#39;re close enough to a surface to draw it.</p></li>
<li><p>An SDF of any kind (we&#39;ll use a sphere) that our <code>raymarch</code> function will use to calculate how close it is from the surface at any given point of the raymarching loop.</p></li>
<li><p>A maximum number <code>MAX_STEPS</code> of steps and a surface distance <code>SURFACE_DISTANCE</code> from which we can safely assume we&#39;re <em>close enough</em> to draw a pixel.</p></li>
</ol>
<figure><p><img alt="Diagram representing the position of a theoretical sphere and our ray origin in relation to the center of the scene." loading="lazy" width="700" height="528" decoding="async" data-nimg="1" sizes="(max-width: 768px) 120vw, 75vw" srcset="https://images.maximeheckel.com/cdn-cgi/image/width=640,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-axis_rxqjxy.png 640w, https://images.maximeheckel.com/cdn-cgi/image/width=750,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-axis_rxqjxy.png 750w, https://images.maximeheckel.com/cdn-cgi/image/width=828,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-axis_rxqjxy.png 828w, https://images.maximeheckel.com/cdn-cgi/image/width=1080,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-axis_rxqjxy.png 1080w, https://images.maximeheckel.com/cdn-cgi/image/width=1200,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-axis_rxqjxy.png 1200w, https://images.maximeheckel.com/cdn-cgi/image/width=1920,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-axis_rxqjxy.png 1920w, https://images.maximeheckel.com/cdn-cgi/image/width=2048,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-axis_rxqjxy.png 2048w, https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-axis_rxqjxy.png 3840w" src="https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-axis_rxqjxy.png"/></p><figcaption>Diagram representing the position of a theoretical sphere and our ray origin in relation to the center of the scene.</figcaption></figure>
<p>Our <code>raymarch</code> function will loop for up to <code>MAX_STEPS</code> until we reach the step limit, in which case we&#39;ll draw <em>nothing</em> or hit the surface of the shape defined by our SDF.</p>
<div><pre><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">#</span><span data-testid="content-line">define</span><span data-testid="content-line"> </span><span data-testid="content-line">SURFACE_DIST</span><span data-testid="content-line"> </span><span data-testid="content-line">0.01</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> distance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sdSphere</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">raymarch</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line"> ro</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> rd</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>14</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">for</span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> i </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> i </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> MAX_STEPS</span><span data-testid="content-line">;</span><span data-testid="content-line"> i</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>15</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> p </span><span data-testid="content-line">=</span><span data-testid="content-line"> ro </span><span data-testid="content-line">+</span><span data-testid="content-line"> rd </span><span data-testid="content-line">*</span><span data-testid="content-line"> dO</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>20</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">if</span><span data-testid="content-line">(</span><span data-testid="content-line">dO </span><span data-testid="content-line">&gt;</span><span data-testid="content-line"> MAX_DIST </span><span data-testid="content-line">||</span><span data-testid="content-line"> dS </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> SURFACE_DIST</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div></pre></div>
<p>If we try running this code within our canvas, we should obtain the following result ðŸ‘€</p>

<h3 id="adding-some-depth-with-light"><a href="#adding-some-depth-with-light" aria-hidden="true" tabindex="-1"><span></span></a>Adding some depth with light</h3>
<p>We just drew a sphere with solely GLSL code ðŸŽ‰. However, it looks more like a <em>circle</em> because our scene has no light or lighting model implemented, which means our scene doesn&#39;t have much depth. That is quite similar to the first mesh you render in Three.js using <code>MeshBasicMaterial</code>: the lack of shadows and reflections or diffuse makes the result look flat.</p>
<p>If you read my article <a href="https://blog.maximeheckel.com/posts/refraction-dispersion-and-other-shader-light-effects/#adding-volume-and-shininess-to-our-dispersion">Refraction, dispersion, and other shader light effects</a>, we had a similar issue, and that&#39;s where we introduced the concept of <strong>diffuse light</strong>. Lucky us, we can reuse the same formula and principles from that blog post: by using the dot product of the normal of the surface and a light direction vector, we can get some simple lighting in our raymarched scene ðŸ’¡.</p>
<div><div><p data-testid="codesnippet-title">GLSL implementation of diffuse lighting</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">float</span><span data-testid="content-line"> diffuse </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">max</span><span data-testid="content-line">(</span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">normal</span><span data-testid="content-line">,</span><span data-testid="content-line"> lightDirection</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span></span></p></div></pre></div>

<p>The only issue is that we do not have an easy access to the Normal vector as we do in rasterized scenes. We need to calculate it for each &#34;hit&#34; we get between our rays and a surface. Luckily, <a href="https://iquilezles.org/articles/normalsSDF/">Inigo Quilez already went deep into this subject</a>, and I invite you to read his article on the subject as it will give you a better understanding of the underlying formula which we&#39;ll use throughout all the examples of this article:</p>
<div><div><p data-testid="codesnippet-title">getNormal function that returns the normal vector of a point p of the surface of an object</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">vec3</span><span data-testid="content-line"> </span><span data-testid="content-line">getNormal</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line"> p</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> n </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">scene</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line"></span></span></p></div></pre></div>
<p>Applying both those formulas gives us a nicely lit raymarched scene ðŸ’¡. Sprinkle on top some <code>uTime</code> for our light position, and we can appreciate a more dynamic composition that reacts to light in real-time:</p>


</section><section id="sdf-operations-complex-scenes-and-fractals-section"><div><h2 id="sdf-operations-complex-scenes-and-fractals"><a href="#sdf-operations-complex-scenes-and-fractals" aria-hidden="true" tabindex="-1"><span></span></a>SDF operations, complex scenes, and fractals</h2></div>
<p>Using SDFs lets us render a plethora of objects in our raymarched scenes, but there&#39;s more we can do with them. In this part, we&#39;ll go through different applications of SDFs to create more complex compositions by:</p>
<ul>
<li><p>rendering multiple objects</p></li>
<li><p>combining shapes to create new ones</p></li>
<li><p>moving, scaling, and rotating objects</p></li>
</ul>
<h3 id="combining-sdfs"><a href="#combining-sdfs" aria-hidden="true" tabindex="-1"><span></span></a>Combining SDFs</h3>
<p>To render two objects within a raymarched scene where each object is defined through their respective SDF, we need to return a distance equivalent to <strong>the minimum of both SDFs</strong>. This is perhaps one of the technique you&#39;ll use the most throughout your own Raymarching explorations.</p>
<div><div><p data-testid="codesnippet-title">Application of min to render 2 objects in a raymarched scene</p></div><pre><div data-testid="line"><p>3</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> sphere </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sdSphere</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>5</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> distance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">min</span><span data-testid="content-line">(</span><span data-testid="content-line">sphere</span><span data-testid="content-line">,</span><span data-testid="content-line"> plane</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div>
<p><strong>Why is it the min?</strong></p>
<p>Doing the min of two SDFs consists of <em>uniting</em> the two shapes in a single scene: either object could get hit by the ray, and you&#39;re essentially asking which of the two shapes is closer to a given point.</p>
<p>This is represented in the graph below ðŸ‘‡, notice how we march our rays a distance <code>d</code>, that is for any given point on that ray, equivalent to the distance to the closest object in the scene.</p>
<div data-fullbleed="true"><div><figure><p><img alt="Diagram showcasing how Raymarching and SDF are applied when multiple objects are in the scene through the usage of the min operator." loading="lazy" width="700" height="396" decoding="async" data-nimg="1" sizes="(max-width: 768px) 120vw, 75vw" srcset="https://images.maximeheckel.com/cdn-cgi/image/width=640,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-min_scweye.png 640w, https://images.maximeheckel.com/cdn-cgi/image/width=750,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-min_scweye.png 750w, https://images.maximeheckel.com/cdn-cgi/image/width=828,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-min_scweye.png 828w, https://images.maximeheckel.com/cdn-cgi/image/width=1080,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-min_scweye.png 1080w, https://images.maximeheckel.com/cdn-cgi/image/width=1200,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-min_scweye.png 1200w, https://images.maximeheckel.com/cdn-cgi/image/width=1920,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-min_scweye.png 1920w, https://images.maximeheckel.com/cdn-cgi/image/width=2048,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-min_scweye.png 2048w, https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-min_scweye.png 3840w" src="https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-min_scweye.png"/></p><figcaption>Diagram showcasing how Raymarching and SDF are applied when multiple objects are in the scene through the usage of the min operator.</figcaption></figure></div></div>
<p>Thus, if the objects are far apart, doing the <code>min</code> of both SDFs will render both on the scene. If they are close enough, it will look as if they are blending into one another ðŸ«§.</p>

<p>Likewise, if we were to do the <code>max</code> of two SDFs, we&#39;d render <strong>the intersection of both objects</strong>: you&#39;d be looking for when your ray is inside both SDFs. That one is my favorite operator, as it allows us to build very sophisticated shapes using techniques akin to CSG (Constructive Solid Geometries).</p>

<p>However, an issue that is particularly visible in the examples above is that these operators do not yield very <em>smooth</em> unions and intersections. That is due to discontinued derivatives of the surfaces, a.k.a. the slopes. At a single point we have:</p>
<ul>
<li><p>one surface that has a downward slope (negative derivative)</p></li>
<li><p>another surface that has a upward slope (positive derivative)</p></li>
</ul>
<figure><p><img alt="Chart representing a non-smooth intersection of 2 objects through the function f:x -&gt; abs(x/2) and its derivative which is discontinued." loading="lazy" width="700" height="358" decoding="async" data-nimg="1" sizes="(max-width: 768px) 120vw, 75vw" srcset="https://images.maximeheckel.com/cdn-cgi/image/width=640,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-derivative_uwzz62.png 640w, https://images.maximeheckel.com/cdn-cgi/image/width=750,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-derivative_uwzz62.png 750w, https://images.maximeheckel.com/cdn-cgi/image/width=828,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-derivative_uwzz62.png 828w, https://images.maximeheckel.com/cdn-cgi/image/width=1080,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-derivative_uwzz62.png 1080w, https://images.maximeheckel.com/cdn-cgi/image/width=1200,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-derivative_uwzz62.png 1200w, https://images.maximeheckel.com/cdn-cgi/image/width=1920,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-derivative_uwzz62.png 1920w, https://images.maximeheckel.com/cdn-cgi/image/width=2048,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-derivative_uwzz62.png 2048w, https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-derivative_uwzz62.png 3840w" src="https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-derivative_uwzz62.png"/></p><figcaption>Chart representing a non-smooth intersection of 2 objects through the function f:x -&gt; abs(x/2) and its derivative which is discontinued.</figcaption></figure>
<p>We can use a pinch of math to obtain a <strong>smooth minimum/maximum</strong>. Once again, Inigo Quilez <a href="https://iquilezles.org/articles/smin/">wrote on the subject pretty extensively</a>, and his polynomial <code>smoothmin</code> variant became the standard in many Shadertoy scenes. <a href="https://www.youtube.com/watch?v=YJ4iyff7zbk&amp;ab_channel=TheArtofCode">This video from The Art of Code</a> also goes into more details but with a more visual approach on how to get to the formula step-by-step.</p>
<div data-fullbleed="true"><div><figure><p><img alt="Charts representing respectively a curve obtained by using the standard min operator and a curve obtained by using smoothmin." loading="lazy" width="700" height="558" decoding="async" data-nimg="1" sizes="(max-width: 768px) 120vw, 75vw" srcset="https://images.maximeheckel.com/cdn-cgi/image/width=640,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-smoothmin_xjlz5c.png 640w, https://images.maximeheckel.com/cdn-cgi/image/width=750,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-smoothmin_xjlz5c.png 750w, https://images.maximeheckel.com/cdn-cgi/image/width=828,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-smoothmin_xjlz5c.png 828w, https://images.maximeheckel.com/cdn-cgi/image/width=1080,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-smoothmin_xjlz5c.png 1080w, https://images.maximeheckel.com/cdn-cgi/image/width=1200,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-smoothmin_xjlz5c.png 1200w, https://images.maximeheckel.com/cdn-cgi/image/width=1920,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-smoothmin_xjlz5c.png 1920w, https://images.maximeheckel.com/cdn-cgi/image/width=2048,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-smoothmin_xjlz5c.png 2048w, https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-smoothmin_xjlz5c.png 3840w" src="https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-smoothmin_xjlz5c.png"/></p><figcaption>Charts representing respectively a curve obtained by using the standard min operator and a curve obtained by using smoothmin.</figcaption></figure></div></div>
<div><div><p data-testid="codesnippet-title">GLSL implementation of the smoothmin function</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">smoothmin</span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> a</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> b</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> k</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>2</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> h </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">clamp</span><span data-testid="content-line">(</span><span data-testid="content-line">0.5</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">b</span><span data-testid="content-line">-</span><span data-testid="content-line">a</span><span data-testid="content-line">)</span><span data-testid="content-line">/</span><span data-testid="content-line">k</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">mix</span><span data-testid="content-line">(</span><span data-testid="content-line">b</span><span data-testid="content-line">,</span><span data-testid="content-line"> a</span><span data-testid="content-line">,</span><span data-testid="content-line"> h</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> k </span><span data-testid="content-line">*</span><span data-testid="content-line"> h </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> h</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div>
<p>Thanks to this <code>smoothmin</code> function, we can not only get prettier unions, but we can also have objects act more like <em>liquids</em> or more organic when moving and blending together. That&#39;s something that is quite difficult to do in a rasterized scene and would require a lot of vertices, but it only requires a few lines of GLSL to obtain a great result with Raymarching!</p>
<p>The scene below is an example of smooth minimum applied to three spheres alongside some Perlin noise, akin to the one I made for <a href="https://r3f.maximeheckel.com/sdf4">this showcase</a>.</p>

<h3 id="moving-rotating-and-scaling"><a href="#moving-rotating-and-scaling" aria-hidden="true" tabindex="-1"><span></span></a>Moving, rotating, and scaling</h3>
<p>While the union and intersection of SDFs may be straightforward to picture in one&#39;s mind, operations such as translations, rotations, and scale can feel a bit less intuitive, especially when having only dealt with rasterized scenes in the past.</p>
<p>To me, to position a sphere in a raymarched scene at a given set of coordinates, it first made more sense to render the SDF, pick it up, and move it to the desired position, which, unfortunately for this intuition, is wrong. In the world of Raymarching, you&#39;d need to <strong>move the sampling point</strong> to the <em>opposite</em> direction you wish to place your SDF object. A simple way to visualize this is to:</p>
<ul>
<li><p>Imagine yourself as a point in a raymarched scene containing a sphere.</p></li>
<li><p>If you step two steps to the right, your sphere will appear to you two steps further to the left.</p></li>
</ul>
<div><div><p data-testid="codesnippet-title">Example of moving SDFs by moving the sampling point p</p></div><pre><div data-testid="highlight-line"><p>2</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> plane </span><span data-testid="content-line">=</span><span data-testid="content-line"> p</span><span data-testid="content-line">.</span><span data-testid="content-line">y </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>3</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> sphere </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sdSphere</span><span data-testid="content-line">(</span><span data-testid="content-line">p </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>5</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> distance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">min</span><span data-testid="content-line">(</span><span data-testid="content-line">sphere</span><span data-testid="content-line">,</span><span data-testid="content-line"> plane</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div>
<p>Rotating consists of the same way of thinking:</p>
<ul>
<li><p>We don&#39;t rotate the SDF itself</p></li>
<li><p>We apply the rotation on the sampling point instead</p></li>
</ul>
<div><div><p data-testid="codesnippet-title">Example of rotation in a raymarched applied to the sampling point</p></div><pre><div data-testid="highlight-line"><p>2</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> p1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">rotate</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">3.14</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">2.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>3</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> distance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sdSphere</span><span data-testid="content-line">(</span><span data-testid="content-line">p1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div>

<p>Scaling is even <em>weirder</em>. To scale, you need to multiply your sampling point by a factor:</p>
<ul>
<li><p>Multiplying by two will make the resulting shape half the size</p></li>
<li><p>Multiplying by 0.5 will make the shape twice as big</p></li>
</ul>
<p>However, by multiplying our sampling point, we mess a bit with our raymarcher and may accidentally have it <em>step inside our object</em>. To work around this issue, we have to decrease our step size (i.e. the distance returned by the SDF) by the same factor we&#39;re scaling our shape of</p>
<div><div><p data-testid="codesnippet-title">Example of scaling a SDF in a raymarched scene</p></div><pre><div data-testid="line"><p>5</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> sphere </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sdSphere</span><span data-testid="content-line">(</span><span data-testid="content-line">p1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.5</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>6</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> distance </span><span data-testid="content-line">=</span><span data-testid="content-line"> sphere </span><span data-testid="content-line">/</span><span data-testid="content-line"> scale</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div>
<p>Combining all those operations and transformations and adding our <code>utime</code> uniform to the mix can yield gorgeous results. You can see one such beautifully executed raymarched scene that uses those operations on <a href="https://richardmattka.com/">Richard Mattka&#39;s portfolio</a>, which <a href="https://twitter.com/akella">@Akella</a> reproduced in one of <a href="https://www.youtube.com/watch?v=afc8qabsGYg">his streams</a>.</p>
<p>I give you my own simplified implementation of it below, also featured on my <a href="https://r3f.maximeheckel.com/sdf3">React Three Fiber showcase website</a>, which leverages all the building blocks of Raymarching featured in this article so far:</p>

<h3 id="scaling-to-infinity"><a href="#scaling-to-infinity" aria-hidden="true" tabindex="-1"><span></span></a>Scaling to infinity</h3>
<p>One trippy aspect of Raymarching that really blew my mind early on is the ability to render <em>infinite-looking</em> scenes with very little code. You can achieve that by putting together lots of SDFs, positioning them programmatically, moving your camera, or increasing the maximum number of steps to render further in space. However, the more SDFs we use, the slower our scene gets.</p>
<p>If you&#39;ve tried to do the same in a classic rasterized scene, you have faced the same issues and worked around them using <strong>mesh instances</strong> instead of rendering discreet meshes. Luckily, Raymarching lets us use a similar principle: <strong>reusing a single SDF</strong> to add as many objects as desired onto our scene.</p>
<div><div><p data-testid="codesnippet-title">Repeat function used to periodically duplicate our sampling point</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">vec3</span><span data-testid="content-line"> </span><span data-testid="content-line">repeat</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line"> p</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> c</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>2</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">mod</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">,</span><span data-testid="content-line">c</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> c</span><span data-testid="content-line">;</span><span data-testid="content-line"> </span><span data-testid="content-line"></span></span></p></div></pre></div>
<p>The function above is what makes this possible:</p>
<ul>
<li><p>Using the <code>mod</code> function (modulo) on the sampling point <code>p</code> lets us take a chunk of space defined by the second argument and tile it infinitely in <em>all</em> directions (see diagram below showcasing the <code>mod</code> function but applied only to a single dimension).</p></li>
<li><p>Then, &#34;instantiate&#34; many objects from a single SDF for each <em>tile</em>, giving the illusion of infinite shapes stretching to infinity.</p></li>
</ul>
<figure><p><img alt="Chart representing the mod function with a period of 2. Notice the repeating pattern along the x-axis. Now use this model to picture in your mind the same repetition happening along all axis x, y, and z in our raymarched scene." loading="lazy" width="700" height="358" decoding="async" data-nimg="1" sizes="(max-width: 768px) 120vw, 75vw" srcset="https://images.maximeheckel.com/cdn-cgi/image/width=640,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-mod_cr2h8i.png 640w, https://images.maximeheckel.com/cdn-cgi/image/width=750,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-mod_cr2h8i.png 750w, https://images.maximeheckel.com/cdn-cgi/image/width=828,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-mod_cr2h8i.png 828w, https://images.maximeheckel.com/cdn-cgi/image/width=1080,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-mod_cr2h8i.png 1080w, https://images.maximeheckel.com/cdn-cgi/image/width=1200,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-mod_cr2h8i.png 1200w, https://images.maximeheckel.com/cdn-cgi/image/width=1920,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-mod_cr2h8i.png 1920w, https://images.maximeheckel.com/cdn-cgi/image/width=2048,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-mod_cr2h8i.png 2048w, https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-mod_cr2h8i.png 3840w" src="https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-mod_cr2h8i.png"/></p><figcaption>Chart representing the mod function with a period of 2. Notice the repeating pattern along the x-axis. Now use this model to picture in your mind the same repetition happening along all axis x, y, and z in our raymarched scene.</figcaption></figure>
<p>The demo scene below showcases how you can include the <code>repeat</code> function with any SDF to create infinite instances of an object in every direction in space:</p>

<p>Notice that if the second argument of the modulo function is low, the objects will appear closer to one another (more frequent repetitions). If higher, they will appear further apart.</p>
<p>While being able to render scenes that stretch to infinity is impressive, the <code>mod</code> function can also have an incredible effect in a more &#34;limited&#34; way: to create <strong>fractals</strong>.</p>
<p>That&#39;s what Inigo Quilez explores in <a href="https://iquilezles.org/articles/menger/">his article</a> about <em>Menger Fractals</em> which are nothing more than &#34;iterated intersection of a cross and a box SDF&#34; that solely relies on the operations we&#39;ve seen in this part:</p>
<ul>
<li><p>Render a simple box using its SDF.</p></li>
</ul>
<div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">sdBox</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line"> p</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> b</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">length</span><span data-testid="content-line">(</span><span data-testid="content-line">max</span><span data-testid="content-line">(</span><span data-testid="content-line">q</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">min</span><span data-testid="content-line">(</span><span data-testid="content-line">max</span><span data-testid="content-line">(</span><span data-testid="content-line">q</span><span data-testid="content-line">.</span><span data-testid="content-line">x</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">max</span><span data-testid="content-line">(</span><span data-testid="content-line">q</span><span data-testid="content-line">.</span><span data-testid="content-line">y</span><span data-testid="content-line">,</span><span data-testid="content-line"> q</span><span data-testid="content-line">.</span><span data-testid="content-line">z</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> d </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sdBox</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">,</span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">6.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div>
<ul>
<li><p>Render an infinite cross SDF, which is the union of 3 boxes.</p></li>
<li><p>Intersect them to obtain a box with square holes at the center of each phase using the <code>max</code> operator.</p></li>
</ul>
<div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">sdBox</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line"> p</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> b</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">length</span><span data-testid="content-line">(</span><span data-testid="content-line">max</span><span data-testid="content-line">(</span><span data-testid="content-line">q</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">min</span><span data-testid="content-line">(</span><span data-testid="content-line">max</span><span data-testid="content-line">(</span><span data-testid="content-line">q</span><span data-testid="content-line">.</span><span data-testid="content-line">x</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">max</span><span data-testid="content-line">(</span><span data-testid="content-line">q</span><span data-testid="content-line">.</span><span data-testid="content-line">y</span><span data-testid="content-line">,</span><span data-testid="content-line"> q</span><span data-testid="content-line">.</span><span data-testid="content-line">z</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">sdCross</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">in</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> p </span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>8</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> da </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sdBox</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">.</span><span data-testid="content-line">xyz</span><span data-testid="content-line">,</span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">inf</span><span data-testid="content-line">,</span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> db </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sdBox</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">.</span><span data-testid="content-line">yzx</span><span data-testid="content-line">,</span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line">inf</span><span data-testid="content-line">,</span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> dc </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sdBox</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">.</span><span data-testid="content-line">zxy</span><span data-testid="content-line">,</span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line">inf</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">min</span><span data-testid="content-line">(</span><span data-testid="content-line">da</span><span data-testid="content-line">,</span><span data-testid="content-line">min</span><span data-testid="content-line">(</span><span data-testid="content-line">db</span><span data-testid="content-line">,</span><span data-testid="content-line">dc</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>15</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> d </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sdBox</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">,</span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">6.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>18</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> distance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">max</span><span data-testid="content-line">(</span><span data-testid="content-line">d</span><span data-testid="content-line">,</span><span data-testid="content-line">c</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div>
<p>By doing these operations in a loop, and for each iteration, making our combined SDF smaller by scaling down and increasing the number of repetitions, the resulting SDF can output some intricate objects that can display repeating patterns that could theoretically go on forever if we wanted to. Hence, this falls into the category of fractals.</p>
<p>The demo below showcases the Menger fractal implementation from Inigo, using the building blocks we laid out in this article with the inclusion of soft shadows, which really shine (no pun intended) for this specific use case.</p>


</section><section id="building-worlds-with-raymarching-and-noise-derivatives-section"><div><h2 id="building-worlds-with-raymarching-and-noise-derivatives"><a href="#building-worlds-with-raymarching-and-noise-derivatives" aria-hidden="true" tabindex="-1"><span></span></a>Building Worlds with Raymarching and noise derivatives</h2></div>
<p>We&#39;ve finally reached the part focusing on the reason I wanted to write this blog post in the first place âœ¨. Now that we&#39;ve warmed up and got familiar with the building blocks of Raymarching, we can explore the beautiful art of <em>painting landscapes</em> with those same techniques.</p>
<p>If you spend some time searching on Shadertoy, those raymarched landscapes can feel both breathtaking when looking at the results they yield and quite intimidating at the same time when looking at the code displayed on the right-hand side of the website. That is why I spent a <em>big deal of time</em> analyzing a couple of those landscapes by trying to find the repetitive patterns used by the authors and breaking them down for you into more digestible bits.</p>
<h3 id="composing-noise-with-fractal-brownian-motion"><a href="#composing-noise-with-fractal-brownian-motion" aria-hidden="true" tabindex="-1"><span></span></a>Composing noise with Fractal Brownian Motion</h3>
<p>You&#39;ve probably played quite a bit with noise in your own shader work and are familiar with the ability of the different types to generate more <em>organic</em> patterns.</p>

<p>In that blog post, I also briefly mention the concept of <strong>Fractal Brownian Motion</strong>: a method to <em>compose noises</em> and obtain a more granular resulting noise featuring more fine details:</p>
<ul>
<li><p>The final detailed noise builds itself in a loop.</p></li>
<li><p>We start with a simple noise with a given amplitude and frequency for the first iteration.</p></li>
<li><p>Then, for each iteration, we apply the same noise but decrease the amplitude and increase the frequency (and add some transformation if we want to), thus creating sharper details but with less influence on the overall scene.</p></li>
</ul>
<p>We can visualize this in 2D by looking at a simple curve. Each iteration is called an <strong>Octave</strong>, and the higher we go in terms of octaves, the sharper and better looking our noise will be:</p>
<figure><p><img alt="Charts representing the application of a noise on top of itself through 3 octaves, where at each octave we decrease its amplitude and increase its frequency, thus yielding a more organic-looking and sharper noise the bigger the maximum octave number is." loading="lazy" width="700" height="719" decoding="async" data-nimg="1" sizes="(max-width: 768px) 120vw, 75vw" srcset="https://images.maximeheckel.com/cdn-cgi/image/width=640,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm_ywg0zh.png 640w, https://images.maximeheckel.com/cdn-cgi/image/width=750,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm_ywg0zh.png 750w, https://images.maximeheckel.com/cdn-cgi/image/width=828,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm_ywg0zh.png 828w, https://images.maximeheckel.com/cdn-cgi/image/width=1080,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm_ywg0zh.png 1080w, https://images.maximeheckel.com/cdn-cgi/image/width=1200,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm_ywg0zh.png 1200w, https://images.maximeheckel.com/cdn-cgi/image/width=1920,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm_ywg0zh.png 1920w, https://images.maximeheckel.com/cdn-cgi/image/width=2048,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm_ywg0zh.png 2048w, https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm_ywg0zh.png 3840w" src="https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm_ywg0zh.png"/></p><figcaption>Charts representing the application of a noise on top of itself through 3 octaves, where at each octave we decrease its amplitude and increase its frequency, thus yielding a more organic-looking and sharper noise the bigger the maximum octave number is.</figcaption></figure>
<p>Applying that type of noise to the SDF of a plane, like in the code snippet below, can yield some very sharp-looking mountainous landscapes stretching to infinity.</p>
<div><div><p data-testid="codesnippet-title">Example of Fractal Brownian Motion applied to a raymarched plane</p></div><pre><div data-testid="line"><p>2</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">#</span><span data-testid="content-line">pragma</span><span data-testid="content-line"> </span><span data-testid="content-line">glslify</span><span data-testid="content-line">:</span><span data-testid="content-line"> cnoise </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">require</span><span data-testid="content-line">(</span><span data-testid="content-line">glsl</span><span data-testid="content-line">-</span><span data-testid="content-line">noise</span><span data-testid="content-line">/</span><span data-testid="content-line">classic</span><span data-testid="content-line">/</span><span data-testid="content-line">2</span><span data-testid="content-line">d</span><span data-testid="content-line">)</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">#</span><span data-testid="content-line">define</span><span data-testid="content-line"> </span><span data-testid="content-line">PI</span><span data-testid="content-line"> </span><span data-testid="content-line">3.14159265359</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">mat2</span><span data-testid="content-line"> </span><span data-testid="content-line">rotate2D</span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">mat2</span><span data-testid="content-line">(</span><span data-testid="content-line">ca</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">sa</span><span data-testid="content-line">,</span><span data-testid="content-line"> sa</span><span data-testid="content-line">,</span><span data-testid="content-line"> ca</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>17</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">for</span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> i </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> i </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> </span><span data-testid="content-line">12</span><span data-testid="content-line">;</span><span data-testid="content-line"> i</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>18</p><p><span><span data-testid="content-line">    res </span><span data-testid="content-line">+=</span><span data-testid="content-line"> amp </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">cnoise</span><span data-testid="content-line">(</span><span data-testid="content-line">p </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.8</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>21</p><p><span><span data-testid="content-line">    p </span><span data-testid="content-line">=</span><span data-testid="content-line"> p </span><span data-testid="content-line">*</span><span data-testid="content-line"> freq </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">rotate2D</span><span data-testid="content-line">(</span><span data-testid="content-line">PI </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">4.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>28</p><p><span><span data-testid="content-line">  distance </span><span data-testid="content-line">+=</span><span data-testid="content-line"> </span><span data-testid="content-line">fbm</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">.</span><span data-testid="content-line">xz </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.3</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>29</p><p><span><span data-testid="content-line">  distance </span><span data-testid="content-line">+=</span><span data-testid="content-line"> p</span><span data-testid="content-line">.</span><span data-testid="content-line">y </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">2.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div>
<p>Add to that the diffuse lighting model we looked at in the earlier parts of this article and some soft shadows, and you can get a beautiful raymarched landscape with just a few lines of GLSL. Those are the techniques I used to build <a href="https://r3f.maximeheckel.com/sdf6">my very first raymarched terrain</a>, and I was quite satisfied with the result. Also, look at how the shadows update in real time as we move the position of the light ðŸ¤¤.</p>
<div><div><div><p><a href="https://twitter.com/MaximeHeckel" target="_blank" rel="noopener noreferrer"><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2746%27%20height=%2746%27/%3e"/></span><img alt="MaximeHeckel" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span></a></p></div><a href="https://twitter.com/MaximeHeckel/status/1679319759018418178" target="_blank" rel="noopener noreferrer" aria-label="@MaximeHeckel&#39;s Twitter profile"><svg viewBox="328 355 335 276" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M 630, 425    A 195, 195 0 0 1 331, 600    A 142, 142 0 0 0 428, 570    A  70,  70 0 0 1 370, 523    A  70,  70 0 0 0 401, 521    A  70,  70 0 0 1 344, 455    A  70,  70 0 0 0 372, 460    A  70,  70 0 0 1 354, 370    A 195, 195 0 0 0 495, 442    A  67,  67 0 0 1 611, 380    A 117, 117 0 0 0 654, 363    A  65,  65 0 0 1 623, 401    A 117, 117 0 0 0 662, 390    A  65,  65 0 0 1 630, 425    Z" style="fill:#3BA9EE"></path></svg></a></div><p>You can create entire procedurally generated worlds with shaders with a couple of well-placed math formulas!

From the sharpness of the terrain, the light, the fog, and the shadows of those mountains: it&#39;s all GLSL

(don&#39;t run this on your phone pls)

https://t.co/hBVew9w90O https://t.co/jl1vk9yPWQ</p></div>
<p>However, I quickly realized that:</p>
<ol>
<li><p><strong>I needed my FBM loop to reach high octaves for a sharp looking result</strong>. That caused the frame rate to drop significantly, as the higher the octaves for my FBM, the higher the complexity of my raymarcher was (nested loops). This scene was pulling a lot of juice from my laptop and even worse at higher resolutions!</p></li>
<li><p>Despite using Perlin noise as the base for my FBM, the resulting landscape was just an endless series of mountains. Each looked distinct and unique from its neighbor, but <strong>the overall result looked repetitive</strong>.</p></li>
</ol>
<h3 id="noise-derivatives"><a href="#noise-derivatives" aria-hidden="true" tabindex="-1"><span></span></a>Noise derivatives</h3>
<p>By studying <a href="https://www.shadertoy.com/view/MdX3Rr">Inigo&#39;s own 3D landscape creations</a>, I noticed that in many of them, he was using a tweaked Fractal Brownian Motion to generate his terrains through the use of <strong>noise derivatives</strong>.</p>
<p>In <a href="https://iquilezles.org/articles/morenoise/">his blog posts on the topic</a>, he presents this technique as an updated version of FBM to generate realistic-looking noise patterns. This technique is, at first glance, a little bit more complicated to explain concisely and also involves a little bit more math than most people might be comfortable with, but here&#39;s my own attempt at highlighting its key features:</p>
<ul>
<li><p>It relies on sampling a grayscaled noise texture (we&#39;ll get to that in a bit) at various points, i.e. looking at the color value stored at a given location, and interpolating between them.</p></li>
<li><p>Instead of relying on those &#34;noise values&#34;, we&#39;re using the derivative between the sampled points representing the steepness or rate of change.</p></li>
</ul>
<p>We thus end up with more &#34;data&#34; about the physical properties of our terrain: the higher derivatives correspond to steeper regions of our landscapes, while lower values will result in flat plateaux or downward slopes, resulting in better-looking, more detailed terrains. The GLSL code for that function looks like this ðŸ‘‡</p>
<div><div><p data-testid="codesnippet-title">Function returning noise value and noise derivative</p></div><pre><div data-testid="line"><p>2</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">uniform</span><span data-testid="content-line"> </span><span data-testid="content-line">sampler2D</span><span data-testid="content-line"> uTexture</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> u </span><span data-testid="content-line">=</span><span data-testid="content-line"> f </span><span data-testid="content-line">*</span><span data-testid="content-line"> f</span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">3.0</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">2.0</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> f</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> a </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">textureLod</span><span data-testid="content-line">(</span><span data-testid="content-line">uTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">+</span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">.0</span><span data-testid="content-line">,</span><span data-testid="content-line">.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line">256.</span><span data-testid="content-line">,</span><span data-testid="content-line">0.</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">x</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> b </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">textureLod</span><span data-testid="content-line">(</span><span data-testid="content-line">uTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">+</span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line">.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line">256.</span><span data-testid="content-line">,</span><span data-testid="content-line">0.</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">x</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> c </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">textureLod</span><span data-testid="content-line">(</span><span data-testid="content-line">uTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">+</span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">.0</span><span data-testid="content-line">,</span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line">256.</span><span data-testid="content-line">,</span><span data-testid="content-line">0.</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">x</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> d </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">textureLod</span><span data-testid="content-line">(</span><span data-testid="content-line">uTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">+</span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line">256.</span><span data-testid="content-line">,</span><span data-testid="content-line">0.</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">x</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>14</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> noiseValue </span><span data-testid="content-line">=</span><span data-testid="content-line"> a </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">b </span><span data-testid="content-line">-</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> u</span><span data-testid="content-line">.</span><span data-testid="content-line">x </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">c </span><span data-testid="content-line">-</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>15</p><p><span><span data-testid="content-line">    u</span><span data-testid="content-line">.</span><span data-testid="content-line">y </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">a </span><span data-testid="content-line">-</span><span data-testid="content-line"> b </span><span data-testid="content-line">-</span><span data-testid="content-line"> c </span><span data-testid="content-line">+</span><span data-testid="content-line"> d</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> u</span><span data-testid="content-line">.</span><span data-testid="content-line">x </span><span data-testid="content-line">*</span><span data-testid="content-line"> u</span><span data-testid="content-line">.</span><span data-testid="content-line">y</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>16</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> noiseDerivative </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">6.0</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> f </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> f</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">b </span><span data-testid="content-line">-</span><span data-testid="content-line"> a</span><span data-testid="content-line">,</span><span data-testid="content-line"> c </span><span data-testid="content-line">-</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>17</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">(</span><span data-testid="content-line">a </span><span data-testid="content-line">-</span><span data-testid="content-line"> b </span><span data-testid="content-line">-</span><span data-testid="content-line"> c </span><span data-testid="content-line">+</span><span data-testid="content-line"> d</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> u</span><span data-testid="content-line">.</span><span data-testid="content-line">yx</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>19</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">noiseValue</span><span data-testid="content-line">,</span><span data-testid="content-line"> noiseDerivative</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div>

<div data-card-details="true" data-state="closed"><details><summary type="button" aria-controls="radix-:Rlu2e6:" aria-expanded="false" data-state="closed"><p>[Optional] Quick Math refresher on how to obtain the derivative</p></summary></details></div>
<p>From these noise derivatives, we can generate the terrain in a similar fashion to the FBM method. For each iteration:</p>
<ul>
<li><p>We call our <code>noised</code> function for our sample point.</p></li>
<li><p>Accumulate the derivatives, which will accentuate the features of the terrain as we go through the iterations of our loop.</p></li>
<li><p>Adjust the height <code>a</code> of our terrain based on the value of the noise.</p></li>
<li><p>Reduce and flip the sign of the scaling factor <code>b</code>. That will result in each subsequent iteration having less effect on the global aspect of the terrain while also alternating between increases and decreases in the overall height of our terrain.</p></li>
<li><p>Transform the sampling point for the next loop by multiplying it by a rotation matrix (which results in a slight rotation for the following iteration) and scaling it down.</p></li>
</ul>
<div><div><p data-testid="codesnippet-title">Alternate FBM process using noise value along side noise derivative</p></div><pre><div data-testid="line"><p>8</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">for</span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> i </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> i </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> </span><span data-testid="content-line">8</span><span data-testid="content-line">;</span><span data-testid="content-line"> i</span><span data-testid="content-line">++</span><span data-testid="content-line"> </span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">    a </span><span data-testid="content-line">+=</span><span data-testid="content-line"> b </span><span data-testid="content-line">*</span><span data-testid="content-line"> n</span><span data-testid="content-line">.</span><span data-testid="content-line">x </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">d</span><span data-testid="content-line">,</span><span data-testid="content-line">d</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div>
<p>The screenshot below showcases the terrain yielded at each octave (i.e. each iteration of our FBM loop) from <code>2</code> to <code>7</code>:</p>
<figure><p><img alt="Screenshots representing a raymarched terrain view from the top from octaves 2 to 7, obtained through FBM and noise derivatives. Notice the cracks, and slopes forming after the 5th octave is reached." loading="lazy" width="700" height="771" decoding="async" data-nimg="1" sizes="(max-width: 768px) 120vw, 75vw" srcset="https://images.maximeheckel.com/cdn-cgi/image/width=640,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm-noise-derivative_fx9ecf.png 640w, https://images.maximeheckel.com/cdn-cgi/image/width=750,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm-noise-derivative_fx9ecf.png 750w, https://images.maximeheckel.com/cdn-cgi/image/width=828,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm-noise-derivative_fx9ecf.png 828w, https://images.maximeheckel.com/cdn-cgi/image/width=1080,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm-noise-derivative_fx9ecf.png 1080w, https://images.maximeheckel.com/cdn-cgi/image/width=1200,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm-noise-derivative_fx9ecf.png 1200w, https://images.maximeheckel.com/cdn-cgi/image/width=1920,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm-noise-derivative_fx9ecf.png 1920w, https://images.maximeheckel.com/cdn-cgi/image/width=2048,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm-noise-derivative_fx9ecf.png 2048w, https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm-noise-derivative_fx9ecf.png 3840w" src="https://images.maximeheckel.com/cdn-cgi/image/width=3840,quality=100,format=webp/https://cdn.maximeheckel.com/images/blog/raymarching-fbm-noise-derivative_fx9ecf.png"/></p><figcaption>Screenshots representing a raymarched terrain view from the top from octaves 2 to 7, obtained through FBM and noise derivatives. Notice the cracks, and slopes forming after the 5th octave is reached.</figcaption></figure>
<p>Applying this technique on top of everything we&#39;ve learned through this article gives us a magnificent landscape that is entirely tweakable, more detailed, and less repetitive than its standard FBM counterpart. I&#39;ll let you play with the scale factors, noise weight, and height in the demo below so you can experiment with more diverse terrains ðŸ‘€.</p>

<h3 id="sky-fog-and-martian-landscape"><a href="#sky-fog-and-martian-landscape" aria-hidden="true" tabindex="-1"><span></span></a>Sky, fog, and Martian landscape</h3>
<p>Generating the terrain is not all there is when building landscapes with Raymarching. One of the foremost things I like to add is <strong>fog</strong>: the further in the distance an element of my landscape is, the more faded and enveloped in mist it should appear. This adds a layer of realism to the scene and can also help you color it!</p>
<p>Once again, we can use some math and physics principles to create such an effect. Using <a href="https://en.wikipedia.org/wiki/Beer%E2%80%93Lambert_law">Beer&#39;s law</a> which states that the intensity of light passing through a medium is exponentially related to the distance it travels we can get a realistic fog effect:</p>
<p><code>I = I0â€‹ * exp(âˆ’Î± * d)</code> where <code>Î±</code> is the absorption or attenuation coefficient describing how &#34;thick&#34; or &#34;dense&#34; the medium is.</p>
<p>That&#39;s the math that Inigo uses as the base for <a href="https://iquilezles.org/articles/fog/">his own fog implementation</a> that is a little bit more elaborated and is also featured in most of his own creations.</p>
<div><div><p data-testid="codesnippet-title">Inigo Quilez&#39;s implementation of fog using exponential decay</p></div><pre><div data-testid="line"><p>4</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">vec3</span><span data-testid="content-line"> </span><span data-testid="content-line">fog</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line"> ro</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> rd</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> col</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> d</span><span data-testid="content-line">)</span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>5</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> pos </span><span data-testid="content-line">=</span><span data-testid="content-line"> ro </span><span data-testid="content-line">+</span><span data-testid="content-line"> rd </span><span data-testid="content-line">*</span><span data-testid="content-line"> d</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> sunAmount </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">max</span><span data-testid="content-line">(</span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">rd</span><span data-testid="content-line">,</span><span data-testid="content-line"> lightPosition</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> fogAmount </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.2</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">exp</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">ro</span><span data-testid="content-line">.</span><span data-testid="content-line">y </span><span data-testid="content-line">*</span><span data-testid="content-line"> b</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">exp</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">d </span><span data-testid="content-line">*</span><span data-testid="content-line"> rd</span><span data-testid="content-line">.</span><span data-testid="content-line">y </span><span data-testid="content-line">*</span><span data-testid="content-line"> b</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> rd</span><span data-testid="content-line">.</span><span data-testid="content-line">y</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> fogColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mix</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.5</span><span data-testid="content-line">,</span><span data-testid="content-line">0.2</span><span data-testid="content-line">,</span><span data-testid="content-line">0.15</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">1.1</span><span data-testid="content-line">,</span><span data-testid="content-line">0.6</span><span data-testid="content-line">,</span><span data-testid="content-line">0.45</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">pow</span><span data-testid="content-line">(</span><span data-testid="content-line">sunAmount</span><span data-testid="content-line">,</span><span data-testid="content-line">2.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>13</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">mix</span><span data-testid="content-line">(</span><span data-testid="content-line">col</span><span data-testid="content-line">,</span><span data-testid="content-line"> fogColor</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">clamp</span><span data-testid="content-line">(</span><span data-testid="content-line">fogAmount</span><span data-testid="content-line">,</span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div>
<p>When it comes to adding a background color for our sky, it&#39;s really straightforward: whatever was not hit by the raymarching loop is our sky and thus can be colored in any way we want!</p>
<div><div><p data-testid="codesnippet-title">Applying a sky color to the background and fog to a raymarched scene</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">vec3</span><span data-testid="content-line"> lightPosition </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">1.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> uv </span><span data-testid="content-line">=</span><span data-testid="content-line"> gl_FragCoord</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">/</span><span data-testid="content-line">uResolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">  uv</span><span data-testid="content-line">.</span><span data-testid="content-line">x </span><span data-testid="content-line">*=</span><span data-testid="content-line"> uResolution</span><span data-testid="content-line">.</span><span data-testid="content-line">x </span><span data-testid="content-line">/</span><span data-testid="content-line"> uResolution</span><span data-testid="content-line">.</span><span data-testid="content-line">y</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>8</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> ro </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">18.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">5.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> rd </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">normalize</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">uv</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">float</span><span data-testid="content-line"> d </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">raymarch</span><span data-testid="content-line">(</span><span data-testid="content-line">ro</span><span data-testid="content-line">,</span><span data-testid="content-line">rd</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>15</p><p><span><span data-testid="content-line">  </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> lightDirection </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">normalize</span><span data-testid="content-line">(</span><span data-testid="content-line">lightPosition</span><span data-testid="content-line">-</span><span data-testid="content-line">p</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>18</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> normal </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">getNormal</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>20</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> amb </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">clamp</span><span data-testid="content-line">(</span><span data-testid="content-line">0.5</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> normal</span><span data-testid="content-line">.</span><span data-testid="content-line">y</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>21</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> diffuse </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">clamp</span><span data-testid="content-line">(</span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">normal</span><span data-testid="content-line">,</span><span data-testid="content-line"> lightDirection</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>22</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> shadow </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">softShadows</span><span data-testid="content-line">(</span><span data-testid="content-line">p</span><span data-testid="content-line">,</span><span data-testid="content-line"> lightDirection</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">3.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">64.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>24</p><p><span><span data-testid="content-line">    color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> diffuse </span><span data-testid="content-line">*</span><span data-testid="content-line"> shadow</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>26</p><p><span><span data-testid="content-line">    color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">fog</span><span data-testid="content-line">(</span><span data-testid="content-line">ro</span><span data-testid="content-line">,</span><span data-testid="content-line"> rd</span><span data-testid="content-line">,</span><span data-testid="content-line"> color</span><span data-testid="content-line">,</span><span data-testid="content-line"> d</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>29</p><p><span><span data-testid="content-line">    color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.5</span><span data-testid="content-line">,</span><span data-testid="content-line">0.6</span><span data-testid="content-line">,</span><span data-testid="content-line">0.7</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>32</p><p><span><span data-testid="content-line">  gl_FragColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line">(</span><span data-testid="content-line">color</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div>
<p>From there, it&#39;s up to you to get creative and play with more effects or add more details to your landscapes. I haven&#39;t had the time yet to generate a lot of those or explore how to add more details such as clouds or trees. That&#39;s next on my list though!</p>
<p>In case you need an example to get you started, here&#39;s a demo featuring the Martian landscape I showcased on Twitter in early August inspired by the work of <a href="https://twitter.com/stormoid">@stormoid</a>.</p>
<div><p>A look at some of my recent shader Raymarching work ðŸ§ª

I learned how to use noise derivatives to create better procedural terrains

Combined with fog and light scattering you can achieve some gorgeous results like this beautiful Martian landscape

https://t.co/5vGVFF6QgI https://t.co/UCdpr68VbK</p><div><p>You can create entire procedurally generated worlds with shaders with a couple of well-placed math formulas!

From the sharpness of the terrain, the light, the fog, and the shadows of those mountains: it&#39;s all GLSL

(don&#39;t run this on your phone pls)

https://t.co/hBVew9w90O https://t.co/jl1vk9yPWQ</p></div></div>
<p>It features:</p>
<ul>
<li><p>Our good ol&#39; Raymarcher we built in the first part of this article.</p></li>
<li><p>An application of noise derivatives</p></li>
<li><p>Soft shadows</p></li>
<li><p>Fog</p></li>
<li><p>@Stormoid&#39;s atmospherical scattering function that creates this &#34;planetary glow&#34; that&#39;s also based on a flavor of exponential decay (like our fog).</p></li>
</ul>

</section><section id="final-thoughts-section">
<p>I find those raymarched landscapes really <em>fascinating</em>. Through the brevity of the code, and the very realistic terrains that stretches to infinity it outputs, it makes creating large unique worlds almost trivial, which reminded me a lot of the empty, unfathomably big worlds featured in one of <a href="https://www.youtube.com/watch?v=Q85l1Fenc5w">Jacob Geller&#39;s videos on Video Games that don&#39;t fake space</a>.</p>
<p>On top of all that, the file containing the code bringing those worlds to life <em>only weighs a couple of kilobytes</em>, <code>~5kB</code> the last time I checked for the Martian landscape excluding the texture which is itself 10x bigger already but it can technically be replaced by a hash function so I&#39;m not counting it in. Even just taking a screenshot of <em>a single frame</em> of the landscape can be close to 100x heavier. I don&#39;t know about you but this makes me <em>think</em> a lot ðŸ˜„, perhaps a bit too much, hence why I really liked working on those scenes.</p>
<p>All of that is made possible by simply stitching a couple of clever math together alongside some simple physics principles, which reminds me of this quote from Zach Lieberman:</p>
<div><p>every image I make is a snapshot of math</p></div>
<p>I think this fits well for Raymarching as a whole and also to conclude this (long) article, which I hope you enjoyed.</p>
<p>I&#39;m not 100% done with Raymarching yet though (and will probably never be). If anything, this is just the tip of the iceberg. <a href="https://twitter.com/MaximeHeckel/status/1689294787046678529?s=20">I recently got into Volumetric rendering</a>, the method behind rendering smoke and clouds, which is kind of a spin-off of Raymarching, that I find really fun to build with. That, however, will be a topic for another time ðŸ˜„.</p></section></div></div></div>
  </body>
</html>
