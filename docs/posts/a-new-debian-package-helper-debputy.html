<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://people.debian.org/~nthykier/blog/2023/a-new-debian-package-helper-debputy.html">Original</a>
    <h1>A new Debian package helper: debputy</h1>
    
    <div id="readability-page-1" class="page"><div><p>I have made a new helper for producing Debian packages called <strong>debputy</strong>. Today, I uploaded it to Debian unstable for the first time. This enables others to migrate their package build using <strong>dh</strong> +<strong>debputy</strong> rather than the &#34;classic&#34; <strong>dh</strong>. Eventually, I hope to remove <strong>dh</strong> entirely from this equation, so you only need <strong>debputy</strong>. But for now, <strong>debputy</strong> still leverages <strong>dh</strong> support for managing upstream build systems.</p>
<p>The <strong>debputy</strong> tool takes a radically different approach to packaging compared to our existing packaging methods by using a single highlevel manifest instead of all the debian/install (etc.) and no &#34;hook targets&#34; in <strong>debian/rules</strong>.</p>
<p>Here are some of the things that <strong>debputy</strong> can do or does:</p>
<ul>
<li><strong>debputy</strong> can perform installation similar to <strong>dh_install</strong>, <strong>dh_installdocs</strong> (etc.) plus a bit of the <strong>dh-exec</strong> support. Notably, <strong>debputy</strong> supports &#34;<em>install /usr/bin/foo into foo&#34;</em> and &#34;<em>install everything else in /usr/bin into foo-utils</em>&#34; without you having to resort to weird tricks. With debhelper, this would require <strong>dh-exec</strong>&#39;s <tt>=&gt; /usr/bin/foo</tt> operator.</li>
<li><strong>debputy</strong> can assign mode to files without needing hooks and static file ownership can be assigned without resorting to <strong>fakeroot</strong>. If you request <strong>Rules-Requires-Root: no</strong>, <strong>debputy</strong> will assemble the deb without using <strong>fakeroot</strong>. The fragileness of <strong>fakeroot</strong> may some day just be a horror story we tell our unruly children that they do not really believe is true.</li>
<li><strong>debputy</strong> defaults to all scripts with a &#34;<strong>#! /bin/tool</strong>&#34; or &#34;<strong>#! /usr/bin/tool</strong>&#34; to have mode 0755 (a+x) unless they are placed in directories known not to have executable files (such as the perl module dirs). As an example, scripts in the examples directory may now get an automatic executable bit if they have a proper #!-line for <strong>/usr/bin</strong> or <strong>/bin</strong>.</li>
<li><strong>debputy</strong> supports the default flow of 48 debhelper tools. If you are using pure <strong>dh $@</strong> with no sequence add-ons and no hook targets in <strong>debian/rules</strong> (or only hook targets for the upstream side), odds are that <strong>debputy</strong> got your needs covered.</li>
</ul>
<p>There are also some features that <strong>debputy</strong> does not support at the moment:</p>
<ul>
<li>Almost any <strong>debhelper</strong> sequence add-on. The <strong>debputy</strong> tool comes with a migration tool that will auto-detect any unsupported <strong>dh</strong> add-on from <strong>Build-Depends</strong> and will flag them as potential problematic. The migration tool works from an list of approved add-ons. Note that manually activated add-ons via <strong>dh $@ --with ...</strong> are not detected.</li>
<li>Anything that installs or recently installed into <strong>/lib</strong> or another /usr-merged location. My life is too short to be directly involved in the /usr-merge transition. This means no <strong>udev</strong> and no <strong>systemd</strong> unit support at the moment (note <strong>tmpfiles</strong> and <strong>sysusers</strong> <em>is</em> supported). For the <strong>systemd</strong> side, I am also contemplating a different model for how to deal with services. Even without the /usr-merge transition, these would not have been supported. The migration tool will detect problematic file in the <strong>debian</strong> directory immediately and <strong>debputy</strong> will detect upstream provided <strong>systemd</strong> unit files at build time.</li>
<li>There is also no support for packager provided maintscript files at this time. If you have your own maintscripts, then you will not be able to migrate. The migration tool detects the <strong>debhelper</strong> based path and warns you (such as <strong>debian/postinst</strong>).</li>
<li>Additionally, if you need special cases in tools (such as <strong>perl-base</strong> dependency with <strong>dh_perl</strong>) or rely on <strong>dh_strip-nondeterminsm</strong> for reproducibility, then you cannot or is advised not to migrate at this time.</li>
</ul>
<p>There are all limitations of the current work in progress. I hope to resolve them all in due time.</p>
<div id="trying-debputy">
<h2>Trying debputy</h2>
<p>With the limitations aside, lets talk about how you would go about migrating a package:</p>
<div><pre><span></span><span># Assuming here you have already run: apt install dh-debputy</span>
$<span> </span>git<span> </span>clone<span> </span>https://salsa.debian.org/rra/kstart
<span>[</span>...<span>]</span>
$<span> </span><span>cd</span><span> </span>kstart
<span># Add a Build-Dependency on dh-sequence-debputy</span>
$<span> </span>perl<span> </span>-n<span> </span>-i<span> </span>-e<span> </span><span>\</span>
<span>   </span><span>&#39;print; print &#34; dh-sequence-debputy,\n&#34; if m/debhelper-compat/;&#39;</span><span> </span><span>\</span>
<span>    </span>debian/control
$<span> </span>debputy<span> </span>migrate-from-dh<span> </span>--apply-changes
debputy:<span> </span>info:<span> </span>Loading<span> </span>plugin<span> </span>debputy<span> </span><span>(</span>version:<span> </span>archive/debian/4.3-1<span>)</span><span> </span>...
debputy:<span> </span>info:<span> </span>Verifying<span> </span>the<span> </span>generating<span> </span>manifest
debputy:<span> </span>info:<span> </span>Updated<span> </span>manifest<span> </span>debian/debputy.manifest
debputy:<span> </span>info:<span> </span>Removals:
debputy:<span> </span>info:<span>   </span>rm<span> </span>-f<span> </span><span>&#34;./debian/docs&#34;</span>
debputy:<span> </span>info:<span>   </span>rm<span> </span>-f<span> </span><span>&#34;./debian/examples&#34;</span>

debputy:<span> </span>info:<span> </span>Migrations<span> </span>performed<span> </span>successfully

debputy:<span> </span>info:<span> </span>Remember<span> </span>to<span> </span>validate<span> </span>the<span> </span>resulting<span> </span>binary<span> </span>packages<span> </span>after<span> </span>rebuilding<span> </span>with<span> </span>debputy
$<span> </span>cat<span> </span>debian/debputy.manifest
manifest-version:<span> </span><span>&#39;0.1&#39;</span>
installations:
-<span> </span>install-docs:
<span>    </span>sources:
<span>    </span>-<span> </span>NEWS
<span>    </span>-<span> </span>README
<span>    </span>-<span> </span>TODO
-<span> </span>install-examples:
<span>    </span>source:<span> </span>examples/krenew-agent
$<span> </span>git<span> </span>add<span> </span>debian/debputy.manifest
$<span> </span>git<span> </span>commit<span> </span>--signoff<span> </span>-am<span>&#34;Migrate to debputy&#34;</span>
<span># Run build tool of choice to verify the output.</span>
</pre></div>
<p>This is of course a specific example that works out of the box. If you were to try this on <strong>debianutils</strong> (from git), the output would look something like this:</p>
<div><pre><span></span>$<span> </span>debputy<span> </span>migrate-from-dh
debputy:<span> </span>info:<span> </span>Loading<span> </span>plugin<span> </span>debputy<span> </span><span>(</span>version:<span> </span><span>5</span>.13-13-g9836721<span>)</span><span> </span>...
debputy:<span> </span>error:<span> </span>Unable<span> </span>to<span> </span>migrate<span> </span>automatically<span> </span>due<span> </span>to<span> </span>missing<span> </span>features<span> </span><span>in</span><span> </span>debputy.

<span>  </span>*<span> </span>The<span> </span><span>&#34;debian/triggers&#34;</span><span> </span>debhelper<span> </span>config<span> </span>file<span> </span><span>(</span>used<span> </span>by<span> </span>dh_installdeb<span> </span>is<span> </span>currently<span> </span>not<span> </span>supported<span> </span>by<span> </span>debputy.

Use<span> </span>--acceptable-migration-issues<span>=[</span>...<span>]</span><span> </span>to<span> </span>convert<span> </span>this<span> </span>into<span> </span>a<span> </span>warning<span> </span><span>[</span>...<span>]</span>
</pre></div>
<p>And indeed, <strong>debianutils</strong> requires at least 4 <strong>debhelper</strong> features beyond what <strong>debputy</strong> can support at the moment (all related to maintscripts and triggers).</p>
</div>
<div id="rapid-feedback">
<h2>Rapid feedback</h2>
<p>Rapid feedback cycles are important for keeping developers engaged in their work. The <strong>debputy</strong> tool provides the following features to enable rapid feedback.</p>

<div id="idempotence-clean-re-runs-of-dh-debputy-without-clean-rebuild">
<h3>Idempotence: Clean re-runs of <strong>dh_debputy</strong> without clean/rebuild</h3>
<p>If you read the &#34;fine print&#34; of many <strong>debhelper</strong> commands, you may see the following note their manpage:</p>
<pre>This command is not idempotent. dh_prep(1) should be called between

invocations of this command ...

Manpage of an anonymous debhelper tool
</pre>
<p>What this usually means, is that if you run the command twice, you will get its maintscript change (etc.) twice in the final deb. This fits into our &#34;single-use clean throw-away chroot builds&#34; on the buildds and CI as well as <strong>dpkg-buildpackage</strong>&#39;s &#34;no-clean&#34; (<strong>-nc</strong>) option. Single-use throw-away chroots are not very helpful for debugging though, so I rarely use them when doing the majority of my packaging work as I do not want to wait for the chroot initialization (including installing of build-depends).</p>
<p>But even then, I have found that <strong>dpkg-buildpackage -nc</strong> has been useless for me in many cases as I am stuck between two options:</p>
<ul>
<li>With <strong>-nc</strong>, you often still interact with the upstream build system. As an example, <strong>debhelper</strong> will do a <strong>dh_prep</strong> followed by <strong>dh_auto_install</strong>, so now we are waiting for upstream&#39;s install target to run again. What should have taken seconds now easily take 0.5-1 minute extra per attempt.</li>
<li>If you want to by-pass this, you have to manually call the helpers needed (in correct order) and every run accumulates cruft from previous runs to the point that cruft drowns out the actual change you want to see. Also, I am rarely in the mood to play <em>human dh</em>, when I am debugging an issue that I failed to fix in my first, second and third try.</li>
</ul>
<p>As you can probably tell, neither option has worked that well for me. But with <strong>dh_debputy</strong>, I have made it a goal that it will not &#34;self-taint&#34; the final output. If <strong>dh_debputy</strong> fails, you should be able to tweak the manifest and re-run <strong>dh_debputy</strong> with the same arguments.</p>
<ul>
<li>No waiting for <strong>dpkg-buildpackage -nc</strong> nor anything implied by that.</li>
<li>No &#34;self-tainting&#34; of the final deb. The result you get, is the result you would have gotten if the previous <strong>dh_debputy</strong> run never happened.</li>
<li>Because <strong>dh_debputy</strong> produces the final result, I do not have to run multiple tools in &#34;the right&#34; order.</li>
</ul>
<p>Obviously, this is currently a lot easier, because <strong>debputy</strong> is not involved in the upstream build system at all. If this feature is useful to you, please do let me know and I will try to preserve it as <strong>debputy</strong> progresses in features.</p>
</div>
</div>
<div id="packager-provided-files">
<h2>Packager provided files</h2>
<p>On a different topic, have you ever wondered what kind of files you can place into the <strong>debian</strong> directory that <strong>debhelper</strong> automatically picks up or reacts too? I do not have an answer to that beyond it is over 80 files and that as the maintainer of <strong>debhelper</strong>, I am not willing to manually maintain such a list manually.</p>
<p>However, I do know what the answer is in <strong>debputy</strong>, because I can just ask <strong>debputy</strong>:</p>
<div><pre><span></span>$<span> </span>debputy<span> </span>plugin<span> </span>list<span> </span>packager-provided-files
+-----------------------------+---------------------------------------------<span>[</span>...<span>]</span>
<span>|</span><span> </span>Stem<span>                        </span><span>|</span><span> </span>Installed<span> </span>As<span>                                </span><span>[</span>...<span>]</span>
+-----------------------------+---------------------------------------------<span>[</span>...<span>]</span>
<span>|</span><span> </span>NEWS<span>                        </span><span>|</span><span> </span>/usr/share/doc/<span>{</span>name<span>}</span>/NEWS.Debian<span>           </span><span>[</span>...<span>]</span>
<span>|</span><span> </span>README.Debian<span>               </span><span>|</span><span> </span>/usr/share/doc/<span>{</span>name<span>}</span>/README.Debian<span>         </span><span>[</span>...<span>]</span>
<span>|</span><span> </span>TODO<span>                        </span><span>|</span><span> </span>/usr/share/doc/<span>{</span>name<span>}</span>/TODO.Debian<span>           </span><span>[</span>...<span>]</span>
<span>|</span><span> </span>bug-control<span>                 </span><span>|</span><span> </span>/usr/share/bug/<span>{</span>name<span>}</span>/control<span>               </span><span>[</span>...<span>]</span>
<span>|</span><span> </span>bug-presubj<span>                 </span><span>|</span><span> </span>/usr/share/bug/<span>{</span>name<span>}</span>/presubj<span>               </span><span>[</span>...<span>]</span>
<span>|</span><span> </span>bug-script<span>                  </span><span>|</span><span> </span>/usr/share/bug/<span>{</span>name<span>}</span>/script<span>                </span><span>[</span>...<span>]</span>
<span>|</span><span> </span>changelog<span>                   </span><span>|</span><span> </span>/usr/share/doc/<span>{</span>name<span>}</span>/changelog.Debian<span>      </span><span>[</span>...<span>]</span>
<span>|</span><span> </span>copyright<span>                   </span><span>|</span><span> </span>/usr/share/doc/<span>{</span>name<span>}</span>/copyright<span>             </span><span>[</span>...<span>]</span>
<span>[</span>...<span>]</span>
</pre></div>
<p>This will list all file types (<strong>Stem</strong> column) that <strong>debputy</strong> knows about and it accounts for any plugin that <strong>debputy</strong> can find. Note to be deterministic, <strong>debputy</strong> will not auto-load plugins that have not been explicitly requested during package builds. So this list could list files that are available but not active for your current package.</p>
<p>Note the output is not intended to be machine readable. That may come in later version. Feel free to chime in if you have a concrete use-case.</p>
</div>
<div id="take-it-for-a-spin">
<h2>Take it for a spin</h2>
<p>As I started this blog post with, <strong>debputy</strong> is now available in unstable. I hope you will take it for a spin on some of your simpler packages and provide feedback on it. :)</p>
<p>For documentation, please have a look at:</p>
<ul>
<li><a href="https://salsa.debian.org/debian/debputy/-/blob/main/GETTING-STARTED-WITH-dh-debputy.md">GETTING-STARTED-WITH-dh-debputy.md</a> (how-to guide)</li>
<li><a href="https://salsa.debian.org/debian/debputy/-/blob/main/MANIFEST-FORMAT.md">MANIFEST-FORMAT.md</a> (reference documentation)</li>
</ul>
<p>Thanks for considering</p>
<p>PS: My deepest respect to the <strong>fakeroot</strong> maintainers. That game of whack-a-mole is not something I would have been willing to maintain. I think <strong>fakeroot</strong> is like the Python GIL in the sense that it has been important in getting Debian to where it is today. But at the same time, I feel it is time to let go of the &#34;crutch&#34; and find a proper solution.</p>
</div>
</div></div>
  </body>
</html>
