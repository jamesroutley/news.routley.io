<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://hisham.hm/2022/06/27/turns-out-gcc-has-imperative-argument-handling/">Original</a>
    <h1>Turns out GCC has imperative argument handling</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>The Linux program with most contrived argument handling logic ever has got to be <tt>gcc</tt>.</p>
<p>Everything in it has a reason, of course, but the end result is that you get a weird mix where the order matters for some args and not for others PLUS there are <i>imperative</i> arguments:</p>
<p>Say you want to link a static library into your program (I‚Äôm going to use [‚Ä¶] to skip other flags)</p>
<pre>gcc -o myprogram [...] myprogram.c libmylibrary.a [...]</pre>
<p>This works, but now you want to add plugins to your program. So you add some runtime dynamic linking logic and add -ldl.</p>
<p>Oops, you realize your plugins can‚Äôt find some symbols from the static library, only those already used by the main program. The compiler threw away everything from libmylibrary.a that was ‚Äúunused‚Äù.</p>
<p><tt>-Wl,‚Äìwhole-archive</tt> to the rescue!</p>
<blockquote><p>
Wait, what‚Äôs that? Two flags joined by a comma?</p>
<p>Turns out <tt>gcc</tt> is a main driver command which launches other programs, and passes arguments along to them. <tt>-Wl,‚Äì<i>something</i></tt> means that it will pass the flag <tt><i>‚Äìsomething</i></tt> to the linker. You can add after <tt>-Wl,</tt> anything that is understood by ld, the GNU Linker.)
</p></blockquote>
<p><i>But</i> you have other libraries you‚Äôre linking as well, and now you start getting duplicated symbol errors when compiling, because it is linking too much stuff! The solution? Wait for it‚Ä¶ </p>
<pre>gcc [...stuff...] -Wl,--whole-archive libfoo.a -Wl,--no-whole-archive [...other libs...]</pre>
<p>The arguments in <tt>gcc</tt> when dealing with linker options are not only positional, they are <b>imperative</b>! </p>
<p>And I mean that in a quite literal sense. They <i>interpreted</i> like a sequence with side-effects: you set a flag, the next libraries is affected by it, you unset the flag, the following libraries aren‚Äôt affected anymore.</p>
<p>I thought <tt>find</tt> was a strong contender for Unix command with the weirdest argument handling, but I guess <tt>gcc</tt> takes the cake. üç∞</p>

</div></div>
  </body>
</html>
