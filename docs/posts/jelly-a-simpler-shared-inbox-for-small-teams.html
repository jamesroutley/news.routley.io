<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://letsjelly.com/">Original</a>
    <h1>Show HN: Jelly – A simpler shared inbox for small teams</h1>
    
    <div id="readability-page-1" class="page"><div><p>I use <a href="https://github.com/kaushalmodi/ox-hugo/">ox-hugo</a> to <a href="https://punchagan.muse-amuse.in/blog/deploying-hugo-drafts-simplified/">write blog posts</a> in org-mode and publish them using <a href="https://gohugo.io/">Hugo</a>. I
<a href="https://punchagan.muse-amuse.in/blog/why-i-like-org-as-a-markup/">enjoy using org-mode</a> for any writing that I do, including blog posts (when I am
able to get myself to write them). After a long hiatus, I’ve been trying to get
back to blogging, as this post might have given away. But, ox-hugo’s <a href="https://ox-hugo.scripter.co/doc/auto-export-on-saving/">auto
export</a> seemed much slower than I remember it being.</p>
<p>Each time I hit save on my <code>blog-posts.org</code> file, Emacs gets busy for about
10ish seconds exporting the post to Hugo markdown. And this is annoying because
I tend to hit <code>save-buffer</code> multiple times while writing in <code>Emacs</code> – thanks,
muscle memory!</p>
<h2 id="enter-emacs-profiler">Enter Emacs profiler</h2>
<p>I was on a flight and had some time to dig into this. If I was online, I
probably would have looked through the README and/or the issue tracker, but I
<a href="https://punchagan.muse-amuse.in/blog/how-i-learnt-to-use-emacs-profiler/">jumped in</a> with the handy <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Profiling.html">Emacs profiler</a>.</p>
<p>The profiler-report showed that a big chunk of time was being spent in
<code>org-id-update-id-locations</code> even before the actual export started. And then,
during the export, a bulk of the time was spent in
<code>org-hugo--get-pre-processed-buffer</code>. Once I knew the problem areas, I started
poking around in the <code>ox-hugo</code> code to “fix” these issues.</p>
<h2 id="turn-off-org-id-location-update">Turn off Org ID location update</h2>
<p><code>org-id-update-id-locations</code> scans a bunch of org-mode files and stores a
mapping of all the IDs of subtrees to their filenames. If you have a lot of org
subtrees this can take a while, even if none of them actually have IDs. It
turns out that I didn’t have any ID properties set, and this caused the <a href="https://github.com/kaushalmodi/ox-hugo/blob/98421a1298adc6d80ce21b3cb5c951af818b27bf/ox-hugo.el#L4881-L4882">update
function to run before every export</a>!</p>
<p>I simply added a new ID property on one of the subtrees in my blog-posts file
to prevent the ID updation from running on every export! I’m not sure how a
stale <code>org-id-locations</code> value affects cross links, but at this stage of
writing I don’t care about the cross links. (spoiler: The next hack actually
nullifies any impact a stale value might have had!)</p>
<p>Cutting down auto export time by 4-5 seconds is great! But, I’m still not happy
to wait for 5-6 seconds in the middle of writing my posts. Let’s look at the
other hotspot – the buffer preprocessing!</p>
<h2 id="turn-off-buffer-preprocessing-maybe">Turn off buffer preprocessing, maybe?</h2>
<p>Currently, I don’t have any cross links between posts in my org-mode source.
So, I can turn off this feature completely by setting
<code>org-hugo--preprocess-buffer</code> to <code>nil</code>. Viola! Hitting <code>save-buffer</code> doesn’t
freeze my Emacs any more. I can compose “100s of blog posts”™ in a flurry! ;)</p>
<p>But, if I’m going to have these “100s of blog posts”, wouldn’t it be better to
have cross links? But, with preprocessing turned off when there are
cross-links, the “auto-export and build” workflow breaks. The variable
<code>org-hugo--preprocess-buffer</code> MUST be non-nil to produce posts with <strong>valid</strong>
cross-links. If not, the exported markdown file processed by <code>hugo</code> ends up
having broken cross-links, which crashes <code>hugo serve</code> and/or <code>hugo build</code>.</p>
<p>Unsetting and setting the <code>org-hugo--preprocess-buffer</code> variable for the
writing vs publishing phase, respectively, isn’t an ergonomic workflow. It’s
not an improvement over disabling and enabling the auto-export mode as needed.
I want to enjoy auto export with Hugo’s <a href="https://gohugo.io/getting-started/usage/#livereload">live reload</a> feature.</p>
<h2 id="moar-workaround">Moar workaround!</h2>
<p>Looking through the code some more, I learnt <a href="https://github.com/kaushalmodi/ox-hugo/blob/98421a1298adc6d80ce21b3cb5c951af818b27bf/ox-hugo.el#L2723"><code>org-hugo-link</code></a> first uses a
custom export handler, if one exists for a link’s protocol. I decided to piggy
back on this functionality and made up <code>hugo:</code> protocol for cross-links.</p>
<p>The <code>hugo</code> link simply contains the <code>EXPORT_FILE_NAME</code> of the linked blog post
i.e., name of the exported markdown file (without the .md extension) as the
‘path’ of the link. The custom protocol export handler can then generates a
<code>relref</code> shortcode for Hugo to process in the exported markdown file.</p>
<p>This nicely works around the need to preprocess my entire <code>blog-posts.org</code>
buffer to generate <strong>valid</strong> cross-links!</p>
<div><pre tabindex="0"><code data-lang="emacs-lisp"><span><span>(<span>org-link-set-parameters</span> <span>&#34;hugo&#34;</span> <span>:export</span> <span>#&#39;</span><span>pc/org-hugo-link-export-to-md</span> <span>&#34;Export Hugo blog link to markdown file&#34;</span> )
</span></span><span><span>
</span></span><span><span>(<span>defun</span> <span>pc/org-hugo-link-export-to-md</span> (<span>path</span> <span>desc</span> <span>backend</span> <span>&amp;optional</span> <span>info</span>)
</span></span><span><span>  <span>&#34;Export a link to a Hugo blog link in markdown format.&#34;</span>
</span></span><span><span>  (<span>message</span> (<span>format</span> <span>&#34;path: %s, desc: %s, backend: %s&#34;</span> <span>path</span> <span>desc</span> <span>backend</span>))
</span></span><span><span>  (<span>cond</span>
</span></span><span><span>   ((<span>eq</span> <span>backend</span> <span>&#39;md</span>)
</span></span><span><span>    (<span>if</span> (<span>equal</span> <span>org-export-current-backend</span> <span>&#39;hugo</span>)
</span></span><span><span>        (<span>format</span> <span>&#34;[%s]({{&lt; relref \&#34;%s\&#34; &gt;}})&#34;</span> <span>desc</span> <span>path</span>)
</span></span><span><span>      (<span>error</span> <span>&#34;Cannot export Hugo link to non-Hugo backend&#34;</span>)))
</span></span><span><span>   (<span>t</span> (<span>error</span> <span>&#34;Cannot export Hugo link to non-Hugo backend&#34;</span>))))
</span></span></code></pre></div><h2 id="outro">Outro</h2>
<p>I made a <a href="https://github.com/punchagan/dot-doom/blob/c45f01e6b20275ce1df943855626af5c40cb626c/config.el#L541-L564">simple helper</a> to make it easier to insert these cross-links with the
<code>hugo:</code> protocol. It simply looks through all the headlines with an
<code>EXPORT_FILE_NAME</code> property, and allows it to be inserted as a link with the
<code>hugo:</code> protocol.</p>
<p>Now, cross-linking posts and publishing posts with cross-links are both a
breeze. Stay tuned for the “100s of blog posts” ™ I’m going to write!</p>
</div><div><p>
  Feel free to <a href="https://twitter.com/punchagan">tweet to me</a> or send me an
  <a href="mailto:punchagan+blog@muse-amuse.in">email</a> with your comments.
</p></div></div>
  </body>
</html>
