<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://re.factorcode.org/2023/08/drunken-bishop.html">Original</a>
    <h1>Drunken Bishop (2023)</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>The <a href="https://www.openssh.com">OpenSSH project</a> is a widely available tool for
working with the <a href="https://en.wikipedia.org/wiki/Secure_Shell">SSH protocol</a> in
a variety of ways on a variety of operating systems. Their project description
states:</p>
<blockquote>
<p>OpenSSH is the premier connectivity tool for remote login with the SSH
protocol. It encrypts all traffic to eliminate eavesdropping, connection
hijacking, and other attacks. In addition, OpenSSH provides a large suite of
secure tunneling capabilities, several authentication methods, and
sophisticated configuration options.</p></blockquote>
<p>One of the interesting features that it contains is a method of visualizing
<a href="https://en.wikipedia.org/wiki/Public_key_fingerprint">public key fingerprints</a>
to allow a user to more easily see that a key has changed by examining a visual
output that looks something like this:</p>
<pre tabindex="0"><code>+----[RSA 2048]---+
|        . o.+o  .|
|     . + *  +o...|
|      + * .. ... |
|       o + .   . |
|        S o   .  |
|         o     . |
|          .     o|
|               .o|
|               Eo|
+------[MD5]------+
</code></pre><p>This is the <a href="https://github.com/openssh/openssh-portable/blob/master/sshkey.c#L976">Drunken Bishop
algorithm</a>,
a variant of a technique called <em>random art</em> that was originally described in
the paper <a href="http://users.ece.cmu.edu/~dawnsong/papers/randomart.pdf">Hash Visualization: a New Technique to improve Real-World
Security</a>. You can see
more information about it in <a href="http://www.dirk-loss.de/sshvis/drunken_bishop.pdf">The drunken bishop: An analysis of the OpenSSH fingerprint
visualization algorithm</a>.</p>
<p>This <a href="https://man.openbsd.org/ssh_config#VisualHostKey">OpenSSH feature</a> is
controlled by the <code>VisualHostKey</code> flag:</p>
<blockquote>
<p><strong>VisualHostKey</strong></p>
<p>If this flag is set to <strong>yes</strong>, an ASCII art representation of the remote
host key fingerprint is printed in addition to the fingerprint string at
login and for unknown host keys. If this flag is set to <strong>no</strong> (the default),
no fingerprint strings are printed at login and only the fingerprint string
will be printed for unknown host keys.</p></blockquote>
<p>This can be enabled by adding to your <code>~/.ssh/config</code>:</p>
<pre tabindex="0"><code>VisualHostKey yes
</code></pre><p>Or by adding this option in your <code>ssh</code> command:</p>
<pre tabindex="0"><code>$ ssh -o VisualHostKey=yes your.host.name
</code></pre><h2 id="implementation">Implementation</h2>
<p>We are going to be implementing this in the <a href="https://factorcode.org">Factor</a>
programming language.</p>
<p>The algorithm begins by defining a visual board – by default 9 rows by 17
columns – and a starting position in the middle of the board. Each 8-bit byte
of input is split into 2-bit groups which indicate where the bishop moves:</p>
<table>
  <thead>
      <tr>
          <th>Value</th>
          <th>Direction</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>00</td>
          <td>↖</td>
      </tr>
      <tr>
          <td>01</td>
          <td>↗</td>
      </tr>
      <tr>
          <td>10</td>
          <td>↙</td>
      </tr>
      <tr>
          <td>11</td>
          <td>↘</td>
      </tr>
  </tbody>
</table>
<p>As the bishop moves around the board diagonally, it increments a counter in
each cell.  However, the bishop cannot move through the walls on the edge of
the board, remaining stuck in whichever direction is blocked.</p>
<div><pre tabindex="0"><code data-lang="factor"><span><span><span>CONSTANT:</span> <span>WIDTH</span> <span>17
</span></span></span><span><span><span></span><span>CONSTANT:</span> <span>HEIGHT</span> <span>9
</span></span></span><span><span><span></span>
</span></span><span><span><span>::</span> <span>drunken-bishop</span> <span>( </span><span>bytes</span> <span>-- </span><span>board</span> <span>)
</span></span></span><span><span><span></span>    HEIGHT [ WIDTH <span>0 </span><span>&lt;array&gt; </span>] <span>replicate </span>:&gt; board
</span></span><span><span>    HEIGHT <span>2/ </span>:&gt; y!
</span></span><span><span>    WIDTH <span>2/ </span>:&gt; x!
</span></span><span><span>
</span></span><span><span>    <span>15 </span>x y board <span>nth set-nth </span><span>! starting position</span>
</span></span><span><span>
</span></span><span><span>    bytes [
</span></span><span><span>        { <span>0 -2 -4 -6 </span>} [
</span></span><span><span>            <span>shift </span><span>2 </span>bits {
</span></span><span><span>                { <span>0b00 </span>[ <span>-1 -1 </span>] }
</span></span><span><span>                { <span>0b01 </span>[ <span>-1 </span> <span>1 </span>] }
</span></span><span><span>                { <span>0b10 </span>[  <span>1 -1 </span>] }
</span></span><span><span>                { <span>0b11 </span>[  <span>1 </span> <span>1 </span>] }
</span></span><span><span>            } <span>case </span>:&gt; <span>( </span><span>dy</span> <span>dx</span> <span>)
</span></span></span><span><span><span></span>            dy y <span>+ </span><span>0 </span>HEIGHT <span>1 </span><span>- </span>clamp y!
</span></span><span><span>            dx x <span>+ </span><span>0 </span>WIDTH <span>1 </span><span>- </span>clamp x!
</span></span><span><span>            x y board <span>nth </span>[ <span>dup </span><span>14 </span><span>&lt; </span>[ <span>1 </span><span>+ </span>] <span>when </span>] <span>change-nth
</span></span></span><span><span><span></span>        ] <span>with each
</span></span></span><span><span><span></span>    ] <span>each
</span></span></span><span><span><span></span>
</span></span><span><span>    <span>16 </span>x y board <span>nth set-nth </span><span>! ending position</span>
</span></span><span><span>
</span></span><span><span>    board <span>;
</span></span></span></code></pre></div><p>The output is rendered using an <code>.o+=*BOX@%&amp;#/^</code> alphabet with <code>S</code> for the
starting position and <code>E</code> for the ending position specially rendered:</p>
<div><pre tabindex="0"><code data-lang="factor"><span><span><span>CONSTANT:</span> <span>SYMBOLS</span> <span>&#34; .o+=*BOX@%&amp;#/^SE&#34;</span>
</span></span><span><span>
</span></span><span><span><span>:</span> <span>drunken-bishop.</span> <span>( </span><span>bytes</span> <span>-- )
</span></span></span><span><span><span></span>    drunken-bishop [ SYMBOLS <span>nths print </span>] <span>each </span><span>;
</span></span></span></code></pre></div><p>We can try this out and see that it works:</p>
<div><pre tabindex="0"><code data-lang="factor"><span><span><span>IN:</span> <span>scratchpad</span> <span>&#34;fc94b0c1e5b0987c5843997697ee9fb7&#34;</span>
</span></span><span><span>               hex-string&gt;bytes drunken-bishop.
</span></span><span><span>       .=o.  <span>. </span>  
</span></span><span><span>     <span>. </span>*+*. o    
</span></span><span><span>      =.*..o     
</span></span><span><span>       o <span>+ </span>..    
</span></span><span><span>        S o.     
</span></span><span><span>         o  <span>. </span>   
</span></span><span><span>          <span>. </span> <span>. . </span>
</span></span><span><span>              o <span>.
</span></span></span><span><span><span></span>               E.
</span></span></code></pre></div><p>This is available in the <a href="https://github.com/factor/factor/blob/master/extra/drunken-bishop/drunken-bishop.factor">drunken-bishop
vocabulary</a>
in a recent development version.</p>

</div></div>
  </body>
</html>
