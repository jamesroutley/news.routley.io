<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://labs.withsecure.com/advisories/microsoft-office-365-message-encryption-insecure-mode-of-operation">Original</a>
    <h1>Microsoft Office 365 Message Encryption Insecure Mode of Operation</h1>
    
    <div id="readability-page-1" class="page"><div>



<div id="container-706807303">
	
	<div>
		


<div>
    
    <p>

<h3>Overview</h3>
</p>
<p>Microsoft Office 365 Message Encryption (OME) utilitises Electronic Codebook (ECB) mode of operation. This mode is generally insecure and can leak information about the structure of the messages sent, which can lead to partial or full message disclosure. As stated in the NIST’s &#34;<a href="https://csrc.nist.gov/News/2022/proposal-to-revise-sp-800-38a">Announcement of Proposal to Revise Special Publication 800-38A</a>&#34;: &#34;In the <a href="https://nvd.nist.gov/" title="https://nvd.nist.gov/">NIST National Vulnerability Database (NVD)</a>, the use of ECB to encrypt confidential information constitutes a severe security vulnerability; for example, see <a href="https://nvd.nist.gov/vuln/detail/CVE-2020-11500" title="https://nvd.nist.gov/vuln/detail/CVE-2020-11500">CVE-2020-11500</a>.&#34;</p>
<p>

<h3>Description</h3>
</p>
<p>Microsoft Office 365 offers a method of sending encrypted messages. This feature is advertised to allow organization to send and receive encrypted email messages between people inside and outside your organization in a secure manner. Unfortunately the OME messages are encrypted in insecure Electronic Codebook (ECB) mode of operation.</p>
<p>

<h3>Impact</h3>
</p>
<p>Malicious 3rd party gaining access to the encrypted email messages may be able to identify content of the messages since ECB leaks certain structural information of the messages. This leads to potential loss of confidentiality.</p>
<div><p><img src="https://labs.withsecure.com/content/labs/advisories/microsoft-office-365-message-encryption-insecure-mode-of-operation/jcr%3acontent/root/responsivegrid/responsivegrid/customcontainer_copy/custom-container/customcontainer_copy_932194407/custom-container/image.img.png/1664449067107.png" alt="Image encrypted by Office 365 Message Encryption" title="Image encrypted by Office 365 Message Encryption"/></p><p><small>Image extracted from the Office 365 Message Encryption protected email</small>
    
    


</p></div>
<div>


<p>Since the encrypted messages are sent as a regular email attachments, the messages sent may be stored in various email systems, and may have been intercepted by any party between the sender and the recipient.</p>
<p>An attacker with a large database of messages may infer their content (or parts of it) by analyzing relative locations of repeated sections of the intercepted messages.</p>
<p>Most OME encrypted messages are impacted, and the attack can be performed offline on any previously sent, received or intercepted encrypted messages. There is no way for the organization to prevent analysis of already sent messages, nor does use of rights management features remediate the problem.</p>
<p>Depending on the content sent via encrypted messages, some organizations may need to consider legal impact of the vulnerability. It is possible that vulnerability has lead to privacy impact as described in EU General Data Protection Regulation (GDPR), State of California Consumer Privacy Act (CCPA), or some other similar legislation.</p>


</div>
<p>

<h3>Details</h3>
</p>
<p>Electronic Codebook (ECB) mode of operation means that each cipher block is encrypted individually. Repeating blocks of the clear text message always map to the same cipher text blocks. In practice this means that while the actual cleartext is not revealed directly, information about the structure of the message is. Here is a RAW image that has been AES encrypted in ECB mode of operation:</p>
<div><p><img src="https://labs.withsecure.com/content/labs/advisories/microsoft-office-365-message-encryption-insecure-mode-of-operation/jcr%3acontent/root/responsivegrid/responsivegrid/customcontainer_copy/custom-container/customcontainer_copy_932194407/custom-container/image_7626591.img.png/1664449210922.png" alt="file" title=""/></p>
    
    


</div>
<div>


<p>While the actual individual pixel values are not known, the actual image content can be easily identified.</p>
<p>Even if specific message would not directly leak information in this way, an attacker with a large body of messages is able to perform analysis of the relation of the repeated patterns in the files to identify specific files. This may lead to ability to infer (parts of) clear text of encrypted messages.</p>
<p>No knowledge of the encryption key is required to exploit this vulnerability and hence Bring Your Own Key (BYOK) or similar encryption key protection measures have no remedial impact.</p>
<p>The cipher used for Microsoft Office 365 Message Encryption appears to be Advanced Encryption Standard (AES). However, in the context of this vulnerability the actual cipher is irrelevant since the ECB mode of operation has the same properties regardless of the cipher used.</p>


</div>
<p>

<h4>CWE-327: Use of a Broken or Risky Cryptographic Algorithm</h4>
</p>
<div>


<p>Outlook 365 Message Encryption uses Electronic Codebook (ECB) mode of operation when encrypting the message into RPMSG blob.</p>
<p>The root cause for the vulnerability appears to be a prior decision to use Electronic Codebook (ECB) mode of operation with message encryption and then maintaining compatibility with this poor decision.</p>
<p>The Microsoft Information Protection (MIP) <i>ProtectionHandler::PublishingSettings</i> class has a <i>SetIsDeprecatedAlgorithmPreferred</i> method (<a href="https://docs.microsoft.com/en-us/information-protection/develop/reference/class_mip_protectionhandler_publishingsettings">1</a>) that is documented as:</p>
<p>&#34;Sets whether or not deprecated crypto algorithm (ECB) is preferred for backwards compatibility.&#34; </p>
<p>It is likely that OME uses this method to enable the ECB encryption of RPMSG. If this flag is not set Cipher Block Chaining (CBC) mode of operation is used.</p>
<p>Microsoft Information Protection FIPS 140-2 Compliance (<a href="https://docs.microsoft.com/en-us/information-protection/develop/concept-fips-compliance">2</a>) documentation mentions that</p>
<p>&#34;Legacy versions of Office (2010) require AES 128 ECB, and Office docs are still protected in this manner by Office apps.&#34;</p>


</div>
<p>

<h3>Remediation</h3>
</p>
<div>


<p>After repeated queries about the status of the vulnerability Microsoft eventually replied with the following:</p>
<p>&#34;The report was not considered  meeting the bar for security servicing, nor is it considered a breach. No code change was made and so no CVE was issued for this report.&#34;</p>
<p>End user or administrator of the email system has no option to enforce more secure mode of operation. Since Microsoft has no plans to fix this vulnerability the only mitigation is to avoid using Microsoft Office 365 Message Encryption.</p>


</div>

    
</div>

	</div>
</div></div></div>
  </body>
</html>
