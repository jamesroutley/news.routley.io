<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/xorvoid/sectorc">Original</a>
    <h1>A C Compiler that fits in the 512 byte boot sector of an x86 machine</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">SectorC is a C compiler written in x86-16 assembly that fits within the 512 byte boot sector of an x86 machine. It supports a
subset of C that is large enough to write real and interesting programs. It is quite likely the smallest C compiler ever written.</p>
<p dir="auto">In a base64 encoding, it looks like this:</p>
<div data-snippet-clipboard-copy-content="6gUAwAdoADAfaAAgBzH/6DABPfQYdQXoJQHr8+gjAVOJP+gSALDDqluB+9lQdeAG/zdoAEAfy+gI
AegFAYnYg/hNdFuE9nQNsOiqiwcp+IPoAqvr4j3/FXUG6OUAquvXPVgYdQXoJgDrGj0C2nUGV+gb
AOsF6CgA68Ow6apYKfiD6AKrifgp8CaJRP7rrOg4ALiFwKu4D4Srq1fonP9ewz2N/HUV6JoA6BkA
ieu4iQRQuIs26IAAWKvD6AcAieu4iQbrc4nd6HkA6HYA6DgAHg4fvq8Bra052HQGhcB19h/DrVCw
UKroWQDoGwC4WZGrW4D/wHUMuDnIq7i4AKu4AA+ridirH8M9jfx1COgzALiLBOucg/j4dQXorf/r
JIP49nUI6BwAuI0G6wyE0nQFsLiq6wa4iwarAduJ2KvrA+gAAOhLADwgfvkx2zHJPDkPnsI8IH4S
weEIiMFr2wqD6DABw+gqAOvqicg9Ly90Dj0qL3QSPSkoD5TGidjD6BAAPAp1+eu86Ln/g/jDdfjr
slIx9osEMQQ8O3QUuAACMdLNFIDkgHX0PDt1BIkEMcBaw/v/A8H9/yvB+v/34fb/I8FMAAvBLgAz
wYQA0+CaANP4jwCUwHf/lcAMAJzADgCfwIUAnsCZAJ3AAAAAAAAAAAAAAAAAAAAAAAAAAAAAVao="><pre><code>6gUAwAdoADAfaAAgBzH/6DABPfQYdQXoJQHr8+gjAVOJP+gSALDDqluB+9lQdeAG/zdoAEAfy+gI
AegFAYnYg/hNdFuE9nQNsOiqiwcp+IPoAqvr4j3/FXUG6OUAquvXPVgYdQXoJgDrGj0C2nUGV+gb
AOsF6CgA68Ow6apYKfiD6AKrifgp8CaJRP7rrOg4ALiFwKu4D4Srq1fonP9ewz2N/HUV6JoA6BkA
ieu4iQRQuIs26IAAWKvD6AcAieu4iQbrc4nd6HkA6HYA6DgAHg4fvq8Bra052HQGhcB19h/DrVCw
UKroWQDoGwC4WZGrW4D/wHUMuDnIq7i4AKu4AA+ridirH8M9jfx1COgzALiLBOucg/j4dQXorf/r
JIP49nUI6BwAuI0G6wyE0nQFsLiq6wa4iwarAduJ2KvrA+gAAOhLADwgfvkx2zHJPDkPnsI8IH4S
weEIiMFr2wqD6DABw+gqAOvqicg9Ly90Dj0qL3QSPSkoD5TGidjD6BAAPAp1+eu86Ln/g/jDdfjr
slIx9osEMQQ8O3QUuAACMdLNFIDkgHX0PDt1BIkEMcBaw/v/A8H9/yvB+v/34fb/I8FMAAvBLgAz
wYQA0+CaANP4jwCUwHf/lcAMAJzADgCfwIUAnsCZAJ3AAAAAAAAAAAAAAAAAAAAAAAAAAAAAVao=
</code></pre></div>
<h2 tabindex="-1" id="user-content-supported-language" dir="auto"><a href="#supported-language">Supported language<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">A fairly large subset is supported: global variables, functions, if statements, while statements, lots of operators, pointer dereference, inline machine-code, comments, etc.
All of these features make it quite capable.</p>
<p dir="auto">For example, the following program animates a moving sine-wave:</p>
<div data-snippet-clipboard-copy-content="int y;
int x;
int x_0;
void sin_positive_approx()
{
  y = ( x_0 * ( 157 - x_0 ) ) &gt;&gt; 7;
}
void sin()
{
  x_0 = x;
  while( x_0 &gt; 314 ){
    x_0 = x_0 - 314;
  }
  if( x_0 &lt;= 157 ){
    sin_positive_approx();
  }
  if( x_0 &gt; 157 ){
    x_0 = x_0 - 157;
    sin_positive_approx();
    y = 0 - y;
  }
  y = 100 + y;
}


int offset;
int x_end;
void draw_sine_wave()
{
  x = offset;
  x_end = x + 314;
  while( x &lt;= x_end ){
    sin();
    pixel_x = x - offset;
    pixel_y = y;
    vga_set_pixel();
    x = x + 1;
  }
}

int v_1;
int v_2;
void delay()
{
  v_1 = 0;
  while( v_1 &lt; 50 ){
    v_2 = 0;
    while( v_2 &lt; 10000 ){
      v_2 = v_2 + 1;
    }
    v_1 = v_1 + 1;
  }
}

void main()
{
  vga_init();

  offset = 0;
  while( 1 ){
    vga_clear();
    draw_sine_wave();

    delay();
    offset = offset + 1;
    if( offset &gt;= 314 ){ // mod the value to avoid 2^16 integer overflow
      offset = offset - 314;
    }
  }
}"><pre><code>int y;
int x;
int x_0;
void sin_positive_approx()
{
  y = ( x_0 * ( 157 - x_0 ) ) &gt;&gt; 7;
}
void sin()
{
  x_0 = x;
  while( x_0 &gt; 314 ){
    x_0 = x_0 - 314;
  }
  if( x_0 &lt;= 157 ){
    sin_positive_approx();
  }
  if( x_0 &gt; 157 ){
    x_0 = x_0 - 157;
    sin_positive_approx();
    y = 0 - y;
  }
  y = 100 + y;
}


int offset;
int x_end;
void draw_sine_wave()
{
  x = offset;
  x_end = x + 314;
  while( x &lt;= x_end ){
    sin();
    pixel_x = x - offset;
    pixel_y = y;
    vga_set_pixel();
    x = x + 1;
  }
}

int v_1;
int v_2;
void delay()
{
  v_1 = 0;
  while( v_1 &lt; 50 ){
    v_2 = 0;
    while( v_2 &lt; 10000 ){
      v_2 = v_2 + 1;
    }
    v_1 = v_1 + 1;
  }
}

void main()
{
  vga_init();

  offset = 0;
  while( 1 ){
    vga_clear();
    draw_sine_wave();

    delay();
    offset = offset + 1;
    if( offset &gt;= 314 ){ // mod the value to avoid 2^16 integer overflow
      offset = offset - 314;
    }
  }
}
</code></pre></div>
<h3 tabindex="-1" id="user-content-screenshot" dir="auto"><a href="#screenshot">Screenshot<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/xorvoid/sectorc/blob/main/img/sinwave.png"><img src="https://github.com/xorvoid/sectorc/raw/main/img/sinwave.png" alt="Moving Sinwave"/></a></p>
<h2 tabindex="-1" id="user-content-provided-example-code" dir="auto"><a href="#provided-example-code">Provided Example Code<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">A few examples are provided that leverage the unique hardware aspects of the x86-16 IBM PC:</p>
<ul dir="auto">
<li><code>examples/hello.c:</code> Print a text greeting on the screen writing to memory at 0xB8000</li>
<li><code>examples/sinwave.c:</code> Draw a moving sine wave animation with VGA Mode 0x13 using an appropriately bad approximation of sin(x)</li>
<li><code>examples/twinkle.c:</code> Play “Twinkle Twinkle Little Star” through the PC Speaker (Warning: LOUD)</li>
</ul>
<h2 tabindex="-1" id="user-content-grammar" dir="auto"><a href="#grammar">Grammar<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">The following grammar is accepted and compiled by sectorc:</p>
<div data-snippet-clipboard-copy-content="program     = (var_decl | func_decl)+
var_decl    = &#34;int&#34; identifier &#34;;&#34;
func_decl   = &#34;void&#34; func_name &#34;{&#34; statement* &#34;}&#34;
func_name   = &lt;identifier that ends in &#34;()&#34; with no space&gt;
statement   = &#34;if(&#34; expr &#34;){&#34; statement* &#34;}&#34;
            | &#34;while(&#34; expr &#34;){&#34; statement* &#34;}&#34;
            | &#34;asm&#34; integer &#34;;&#34;
            | func_name &#34;;&#34;
            | assign_expr &#34;;&#34;
assign_expr = deref? identifier &#34;=&#34; expr
deref       = &#34;*(int*)&#34;
expr        = unary (op unary)?
unary       = deref identifier
            | &#34;&amp;&#34; identifier
            | &#34;(&#34; expr &#34;)&#34;
            | indentifier
            | integer
op          = &#34;+&#34; | &#34;-&#34; | &#34;&amp;&#34; | &#34;|&#34; | &#34;^&#34; | &#34;&lt;&lt;&#34; | &#34;&gt;&gt;&#34;
            | &#34;==&#34; | &#34;!=&#34; | &#34;&lt;&#34; | &#34;&gt;&#34; | &#34;&lt;=&#34; | &#34;&gt;=&#34;"><pre><code>program     = (var_decl | func_decl)+
var_decl    = &#34;int&#34; identifier &#34;;&#34;
func_decl   = &#34;void&#34; func_name &#34;{&#34; statement* &#34;}&#34;
func_name   = &lt;identifier that ends in &#34;()&#34; with no space&gt;
statement   = &#34;if(&#34; expr &#34;){&#34; statement* &#34;}&#34;
            | &#34;while(&#34; expr &#34;){&#34; statement* &#34;}&#34;
            | &#34;asm&#34; integer &#34;;&#34;
            | func_name &#34;;&#34;
            | assign_expr &#34;;&#34;
assign_expr = deref? identifier &#34;=&#34; expr
deref       = &#34;*(int*)&#34;
expr        = unary (op unary)?
unary       = deref identifier
            | &#34;&amp;&#34; identifier
            | &#34;(&#34; expr &#34;)&#34;
            | indentifier
            | integer
op          = &#34;+&#34; | &#34;-&#34; | &#34;&amp;&#34; | &#34;|&#34; | &#34;^&#34; | &#34;&lt;&lt;&#34; | &#34;&gt;&gt;&#34;
            | &#34;==&#34; | &#34;!=&#34; | &#34;&lt;&#34; | &#34;&gt;&#34; | &#34;&lt;=&#34; | &#34;&gt;=&#34;
</code></pre></div>
<p dir="auto">In addition, both <code>// comment</code> and <code>/* multi-line comment */</code> styles are supported.</p>
<p dir="auto">(NOTE: This grammar is 704 bytes in ascii, 38% larger than it&#39;s implementation!)</p>
<h2 tabindex="-1" id="user-content-how" dir="auto"><a href="#how">How?<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">See blog post: <a href="https://xorvoid.com/sectorc.html" rel="nofollow">SectorC: A C Compiler in 512 bytes</a></p>
<h2 tabindex="-1" id="user-content-why" dir="auto"><a href="#why">Why?<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">In 2020, cesarblum wrote a Forth that fits in a bootsector: (<a href="https://github.com/cesarblum/sectorforth">sectorforth</a>)</p>
<p dir="auto">In 2021, jart et. al. wrote a Lisp that fits in the bootsector: (<a href="https://github.com/jart/sectorlisp">sectorlisp</a>)</p>
<p dir="auto">Naturally, C always needs to come and crash (literally) every low-level systems party regaurdless of whether it was even invited.</p>
<h2 tabindex="-1" id="user-content-running" dir="auto"><a href="#running">Running<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">Dependencies:</p>
<ul dir="auto">
<li><code>nasm</code> for assembling (I used v2.16.01)</li>
<li><code>qemu-system-i386</code> for emulating x86-16 (I used v8.0.0)</li>
</ul>
<p dir="auto">Build: <code>./build.sh</code></p>
<p dir="auto">Run: <code>./run.sh your_source.c</code></p>
<p dir="auto">NOTE: Tested only on a MacBook M1</p>
<h2 tabindex="-1" id="user-content-what-is-this-useful-for" dir="auto"><a href="#what-is-this-useful-for">What is this useful for?<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">Probably Nothing.</p>
<p dir="auto">Or at least that&#39;s what I thought when starting out. But, I didn&#39;t think I&#39;d get such a feature set. Now, I&#39;d say that it <strong>might</strong> be
useful for someone that wants to explore x86-16 bios functions and machine model w/o having to learn lots of x86 assembly first. But, then again, you
should just use a proper C compiler and write a tiny bootloader to execute it.</p>
</article>
          </div></div>
  </body>
</html>
