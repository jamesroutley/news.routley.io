<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.trailofbits.com/2024/07/30/our-audit-of-homebrew/">Original</a>
    <h1>Our Audit of Homebrew</h1>
    
    <div id="readability-page-1" class="page"><article id="post-107865">
	<!-- .entry-header -->

	<div>
		<p><em>By William Woodruff</em></p>
<p>This is a joint post with the Homebrew maintainers; <a href="https://brew.sh/2024/07/30/homebrew-security-audit/">read their announcement here</a>!</p>
<p>Last summer, we performed an audit of <a href="https://brew.sh/">Homebrew</a>. Our audit’s scope included <a href="https://github.com/Homebrew/brew">Homebrew/brew</a> itself (home of the brew CLI), and three adjacent repositories responsible for various security-relevant aspects of Homebrew’s operation:</p>
<ul>
<li><a href="https://github.com/Homebrew/actions">Homebrew/actions</a>: a repository of custom GitHub Actions used throughout Homebrew’s CI/CD;</li>
<li><a href="https://github.com/Homebrew/formulae.brew.sh">Homebrew/formulae.brew.sh</a>: the codebase responsible for Homebrew’s JSON index of installable packages;</li>
<li><a href="https://github.com/Homebrew/homebrew-test-bot">Homebrew/homebrew-test-bot</a>: Homebrew’s core CI/CD orchestration and lifecycle management routines.</li>
</ul>
<p>We found issues within Homebrew that, while not critical, could allow an attacker to load executable code at unexpected points and undermine the integrity guarantees intended by Homebrew’s use of sandboxing. Similarly, we found issues in Homebrew’s CI/CD that could allow an attacker to surreptitiously modify binary (“<a href="https://docs.brew.sh/Bottles">bottle</a>”) builds of formulae and potentially pivot from triggering CI/CD workflows to controlling the execution of CI/CD workflows and exfiltrating their secrets.</p>
<p>This audit was sponsored by the <a href="https://www.opentech.fund/">Open Tech Fund</a> as part of their larger mission to secure critical pieces of internet infrastructure. You can read the full report in <a href="https://github.com/trailofbits/publications#technology-product-reviews">our publications repository</a>.</p>
<h3>Homebrew</h3>
<p>Homebrew is the self-described “missing package manager for macOS (or Linux).” It serves as the <em>de facto</em> standard package manager for software developers on macOS, and <a href="https://formulae.brew.sh/analytics/install/365d/">serves hundreds of millions of package installs</a> annually. These installations include “keystone” packages such as <a href="https://formulae.brew.sh/formula/go#default">Golang</a>, <a href="https://formulae.brew.sh/formula/node#default">Node.js</a>, and <a href="https://formulae.brew.sh/formula/openssl@3#default">OpenSSL</a>, making Homebrew’s security (and the integrity of its builds) critical to the security of downstream software ecosystems as a whole. Homebrew’s core (not to be confused with <a href="https://github.com/Homebrew/homebrew-core">homebrew-core</a>) is a Ruby monolith responsible for providing the <a href="https://docs.brew.sh/Manpage"><code>brew</code> CLI</a> to users along with an <a href="https://rubydoc.brew.sh/">importable Ruby API</a>.</p>
<p>Since its inception in 2009, Homebrew has undergone several architectural shifts aimed at improving the reliability and usability of packages delivered to users: binary builds (bottles) were implemented, made into the default installation mechanism (replacing local source builds), and subsequently built solely on CI/CD to limit the risk of a compromised developer machine. Despite this increasingly static approach, Homebrew’s core codebase is fundamentally dynamic and, in many places, reflects Homebrew’s historical need for dynamic loading of <a href="https://docs.brew.sh/Formula-Cookbook">DSL-specified formulae</a> via user-controlled Ruby code.</p>
<h3>Scope</h3>
<p>Homebrew is both a user-installable package manager (the <code>brew</code> CLI) and a packaging ecosystem, with an extensive and bespoke CI/CD configuration for reviewing, building, and distributing bottles to end users. Our audit focused on aspects of both of these, and aimed to answer questions like (but not limited to) the following:</p>
<ul>
<li>Can a local actor induce unexpected execution of a formula’s DSL, e.g. without an explicit invocation of <code>brew install</code>?</li>
<li>Can a local actor induce unexpected evaluation of a tap’s formulae, e.g. from just <code>brew tap</code> with no subsequent user actions?</li>
<li>Can a local actor induce namespace confusions or conflicts within brew, resulting in <code>brew install foo</code> installing an unexpected formula?</li>
<li>Can a locally installed formula surreptitiously subvert or bypass Homebrew’s build isolation mechanisms?</li>
<li>Can an unprivileged or low-privilege CI/CD actor (such as a third-party contributor) pivot to a higher privilege in Homebrew’s CI/CD?</li>
<li>Can an unprivileged or low-privilege CI/CD actor surreptitiously taint or compromise a bottle build?</li>
<li>Can an unprivileged or low-privilege CI/CD actor establish persistence in Homebrew’s CI/CD?</li>
</ul>
<h3>Highlighted findings</h3>
<h4>brew</h4>
<p>During our review of the <code>brew</code> CLI’s codebase, we uncovered a number of findings that, while not critical, could potentially undermine Homebrew’s per-formula integrity and isolation properties. We also uncovered findings that could allow loading of formulae (i.e., executable code) from surprising sources, such as remote URLs.</p>
<p>Some findings of interest include:</p>
<ul>
<li>TOB-BREW-2, wherein a formula can influence the construction of its sandbox through string injection, resulting in a sandbox escape.</li>
<li>TOB-BREW-5, wherein Homebrew used a collision-prone hash function (MD5) for a synthetic namespace (<code>FormulaNamespace</code>) could allow an attacker to induce runtime confusion between formulae.</li>
<li>TOB-BREW-8, wherein a formula can surreptitiously include networked resources in its build without explicitly listing them via <code>resource</code> stanzas.</li>
<li>TOB-BREW-11, wherein a formula can potentially use a socket pivot to escape its build sandbox on macOS.</li>
<li>TOB-BREW-12, wherein a formula could opportunistically perform a privilege escalation through a user’s previously activated <code>sudo</code> token.</li>
<li>TOB-BREW-13, wherein <code>brew install</code> can be induced to install formulae from non-local URLs for any protocol supported by the version of <code>curl</code> being used, such as SFTP or SCP.</li>
</ul>
<p>Our overall evaluation of <a href="https://github.com/Homebrew/brew">Homebrew/brew</a> is reflected in our report: while extensively tested, Homebrew’s large API and CLI surface and informal local behavioral contract offer a large variety of avenues for unsandboxed, local code execution to an opportunistic attacker. These avenues do not necessarily violate Homebrew’s core security assumptions (which assume trustworthy formulae), but may be subverted either by malicious formulae or through unexpected sources of formula loading (such as insufficiently sanitized inputs).</p>
<h4>Homebrew’s CI/CD</h4>
<p>Our review of Homebrew’s CI/CD workflows and actions uncovered findings that, while not critical, could undermine the integrity of Homebrew’s CI/CD runs and allow a less-privileged user to pivot to a position of higher privilege or even obtain persistence on Homebrew’s self-hosted GitHub Actions runners.</p>
<p>Some findings of interest include:</p>
<ul>
<li>TOB-BREW-18, wherein multiple CI/CD workflows use the <code>pull_request_target</code> trigger to allow third-party pull requests to run code in the context of Homebrew’s upstream repository, potentially enabling either credential disclosure or tampering with Homebrew’s bottle builds.</li>
<li>TOB-BREW-23, wherein multiple CI/CD workflows inadvertently allow shell injection via unsanitized <code>workflow_dispatch</code> inputs, potentially enabling vertical movement by a less-privileged user (i.e., one who can dispatch workflows but not modify them).</li>
</ul>
<p>Beyond CI/CD-specific findings, many brew findings are also salient in the CI/CD setting:</p>
<ul>
<li>TOB-BREW-6, which describes a lack of sandboxing/isolation during archive extraction, could be used by a less-privileged CI actor to pivot into a higher-privileged context by inducing extraction of a formula or other executable code that gets auto-loaded and executed during the CI’s lifecycle.</li>
<li>TOB-BREW-13, described above, could be used by a less-privileged CI actor to pivot into a higher-privileged context, by inducing arbitrary code execution through <code>brew install</code> of a formula not present in the CI’s pre-configured (presumed trusted) context.</li>
</ul>
<p>Our report concludes that Homebrew’s CI/CD, while mature and effective at reducing the number of human touch-points in Homebrew’s package lifecycle, is complex and relies on misuse-prone patterns common in GitHub Actions workflows (such as dangerous workflow triggers and mixing of configuration, code, and data via template expansion). These patterns do not necessarily enable persistence or pivoting by a fully external actor, but may be leveraged by a lower-privileged insider (such as a rogue maintainer) to undermine the integrity and isolation assumptions made by Homebrew’s CI/CD.</p>
<h3>Takeaways</h3>
<p>Auditing a package management ecosystem such as Homebrew poses unique challenges. Local package management tools install and execute arbitrary third-party code by design and, as such, typically have informal and loosely defined boundaries between expected and unexpected code execution. This is especially true in packaging ecosystems like Homebrew, where the “carrier” format for packages (formulae) is itself executable code (Ruby scripts, in Homebrew’s case).</p>
<p>Throughout the audit, we worked closely with the <a href="https://github.com/Homebrew/brew?tab=readme-ov-file#who-we-are">Homebrew maintainers</a> and the <a href="https://docs.brew.sh/Homebrew-Governance">Homebrew PLC</a> and would like to thank them for sharing their extensive knowledge and expertise. We would also like to thank <a href="https://github.com/p-linnane">Patrick Linnane</a>, Homebrew’s security manager, in particular for his triage and coordination efforts on behalf of Homebrew.</p>

			</div><!-- .entry-content -->

	
</article></div>
  </body>
</html>
