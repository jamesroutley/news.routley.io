<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://verdagon.dev/blog/yak-shave-language-engine-game">Original</a>
    <h1>A Tale of Yak Shaving: Accidentally Making a Language, for an Engine, for a Game</h1>
    
    <div id="readability-page-1" class="page"><div>
          <div>
  

        
  
<section>
<p>
There&#39;s an old mantra in game development:
</p>
<p>
&#34;Don&#39;t make a game engine, make a game.&#34; - Confucius, 1337 A.D.
</p>
<p>
It&#39;s a wise saying, because we game developers have so much fun making the underlying foundations, that we never get around to adding the actual gameplay.
</p>

</section>
<section>
<p>
This is an article about <b>how badly I disregarded that advice, and what happened because of it.</b>
</p>

</section>
<section>
<p>
As you can guess, I made my own game engine.
</p>

</section>
<section>


</section>
<section>
<p>
It was an gloriously unwise decision, and delayed my game for a <i>long time</i>. This is what&#39;s known as <a href="https://www.hanselman.com/blog/yak-shaving-defined-ill-get-that-done-as-soon-as-i-shave-this-yak">yak-shaving</a>: getting so distracted by the details that you lose track of the original goal.
</p>

</section>
<section>
<p>
I learned a valuable lesson from that mistake: <b>don&#39;t get distracted trying to make the perfect tools.</b>
</p>

</section>
<section>
<p>
So, having learned that lesson thoroughly, I then made the same mistake again! Not being satisfied with C#, C++, Rust, and other languages in the landscape, <a href="#note0" data-noteid="0">0</a> I made <b>an entire programming language, <a href="https://vale.dev/">Vale</a>,</b> and rewrote the game engine with that.
</p>

</section>
<section>
<p>
It wasn&#39;t on purpose, it just <i>happened</i>. You start out making a simple DSL, <a href="#note1" data-noteid="1">1</a> and you find yourself working on it more than the game itself. Then, momentum just carries you forward, because you&#39;re having so much fun.
</p>

</section>
<section>
<p>
After <i>eight years</i>, I finally had an entire general-purpose programming language and engine that I could use in the <a href="http://7drl.com/">7 Day Roguelike Challenge</a>.
</p>

</section>

      </div>
  
<div>

      <nav>
      <p>A Tale of Yak Shaving: Accidentally Making a Language, for an Engine, for a Game</p>
    


      </nav>
      
    

      <div>
        <div>
    
<div id="note0" data-noteid="0">
<p><span>0</span></p><section>
<p>
These languages are mostly fine... but C# is slow, Rust can&#39;t handle a lot of basic safe patterns, and C++ doesn&#39;t have the syntactic goodies that I&#39;m so used to.
</p>

</section>
</div>
<div id="note1" data-noteid="1">
<p><span>1</span></p><section>
<p>
Domain-Specific Language, usually a tiny language that helps with one specific task.
</p>

</section>
</div>

        </div>
      </div>
    
</div>

    </div><div>
      <div>
  
<section>
<h2 id="the-unexpected">
 The Unexpected</h2>
<p>
Making a programming language is like raising a child. They start out helpless and generally oblivious, and they constantly fall and spout nonsense. Adorable, indecipherable nonsense. <a href="#note2" data-noteid="2">2</a>
</p>

</section>
<section>
<p>
Eventually, you teach them how to walk, how to do basic math, how to follow instructions, and how to signal basic syntax errors... and then the impossible happens: they win an argument with you. They point out a mistake you made, and <i>they were right.</i>
</p>

</section>
<section>
<p>
It&#39;s a complex mix of emotions: embarassment because you were wrong, sorrow because they no longer need you, and pride because you taught them well.
</p>

</section>
<section>
<p>
In the 7DRL challenge, Vale <a href="https://verdagon.dev/blog/higher-raii-7drl">found a bug in one of my caches at compile time</a> because it uses something called &#34;Higher RAII&#34; which doublechecks we actually fulfill our responsibilities. <a href="#note3" data-noteid="3">3</a>
</p>

</section>

      </div>
  
<div>

      <div>
        <div>
    
<div id="note2" data-noteid="2">
<p><span>2</span></p><section>
<p>
This nonsense usually comes in the form of toddler-speak or s-expressions, depending on the time of day.
</p>

</section>
</div>


        </div>
      </div>
    
</div>

    </div><div>
      <div>
  
<section>
<h2 id="the-good-parts">
 The Good Parts</h2>

</section>
<section>
<p>
There&#39;s a certain joy from using a new language that nobody else has ever used before. I felt like an Indiana Jones, exploring a tomb that no modern eyes have beheld.
</p>

</section>
<section>
<p>
There&#39;s a freedom one feels when not slowed down by garbage collection or reference counting, and not constrained by a borrow checker. <a href="#note4" data-noteid="4">4</a> I&#39;m free to implement what I want, and know that the language will help me do it safely. It&#39;s like I&#39;ve been driving a Honda Civic in city traffic, and now I&#39;m in a BMW cruising down the highway.
</p>

</section>
<section>
<div>
<div>
<section>
<p>
It was also nice to see that Vale is heading in the right direction. I found a lot of places that were just begging to harness <a href="https://verdagon.dev/blog/verdagon.dev/blog/hybrid-generational-memory">Hybrid-Generational Memory</a> and <a href="https://verdagon.dev/blog/seamless-fearless-structured-concurrency">seamless structured concurrency</a>.

</p>

</section>
</div>

</div>

</section>
<section>
<p>
For example, those two features would make it so there&#39;s <b>zero memory safety overhead</b> for the entire below function. For a language with shared mutability to have that is <i>unheard of</i> and makes me quite excited for Vale&#39;s future.
</p>

</section>
<section>

    <div>
      
      <p><span><span><span>pure</span> func <span>CellularAutomata</span><span>(</span></span></span></p>
    </div>
  

</section>

      </div>
  
<div>

      <div>
        <div>
    
<div id="note4" data-noteid="4">
<p><span>4</span></p><section>
<p>
I have a particular wariness for the borrow checker, after learning it that it&#39;s incompatible with observers, most dependency injection, <a href="https://verdagon.dev/blog/higher-raii-7drl">most RAII</a>, and it can sometimes influence one into more complicated architecture <a href="https://www.reddit.com/r/roguelikedev/comments/i3xekn/ec_vs_ecs_for_roguelikes/">with no performance benefit</a>). This is why I made the <a href="https://verdagon.dev/blog/zero-cost-refs-regions">Region Borrow Checker</a>, which should handle shared mutability a bit better.
</p>

</section>
</div>
<div id="note5" data-noteid="5">
<p><span>5</span></p><section>
<p>
 If we add <span>parallel</span> in front of this loop, it can perform these iterations in parallel on multiple threads, using <a href="https://verdagon.dev/blog/seamless-fearless-structured-concurrency">seamless structured concurrency</a>.
</p>

</section>
</div>
<div id="note6" data-noteid="6">
<p><span>6</span></p><section>
<p>
 <a href="https://verdagon.dev/blog/verdagon.dev/blog/hybrid-generational-memory">Hybrid-Generational Memory</a> would notice that we&#39;re iterating over a piece of data we own, so it wouldn&#39;t have to keep checking it still exists.
</p>

</section>
</div>
<div id="note7" data-noteid="7">
<p><span>7</span></p><section>
<p>
 Because we&#39;re accessing data that was a parameter to a pure function, it doesn&#39;t have to check that the data is still alive or increment any reference counters, see <a href="https://verdagon.dev/blog/zero-cost-refs-regions">Zero-Cost References with Regions</a>.
</p>

</section>
</div>
<div id="note8" data-noteid="8">
<p><span>8</span></p><section>
<p>
 PatternMap would contain an &#34;<b>iso</b>&#34; HashMap, which means nobody outside has any references to it. Because of this, PatternMap can freely mutate it without memory safety overhead.

</p>

</section>
</div>

        </div>
      </div>
    
</div>

    </div><div>
      <div>
  
<section>
<h2 id="the-bad-parts">
 The Bad Parts</h2>
<p>
The Vale compiler is written in Scala, for its great development speed. <a href="#note9" data-noteid="9">9</a> <a href="#note10" data-noteid="10">10</a>
</p>
<p>
However, Scala is <i>slow as heck</i> so the Vale compiler runs slow, which means Vale code takes a long time to compile. <a href="#note11" data-noteid="11">11</a>
</p>

</section>
<section>
<p>
<b>This was the biggest risk in this year&#39;s challenge,</b> and almost pushed me past the deadline. Now I know that this year&#39;s priority should be to rewrite the compiler in Vale itself, which would be much faster.
</p>

</section>

      </div>
  
<div>

      <div>
        <div>
    
<div id="note9" data-noteid="9">
<p><span>9</span></p><section>
<p>
I use Scala it in a mostly imperative fashion, more like Kotlin than any pure functional approach.
</p>

</section>
</div>
<div id="note10" data-noteid="10">
<p><span>10</span></p><section>
<p>
In case you&#39;re curious, the backend is in C++, because I&#39;m a madman.
</p>

</section>
</div>
<div id="note11" data-noteid="11">
<p><span>11</span></p><section>
<p>
Moral of the story for language designers: Pay attention to your compile speed. Don&#39;t over-optimize, but at least track performance regressions and leave some TODOs around your codebase so you know where potential slowdowns might be when you do decide to optimize.
</p>

</section>
</div>

        </div>
      </div>
    
</div>

    </div><div>
      <div>
  
<section>
<h2 id="the-result">
 The Result</h2>
<p>
After the longest yak-shave in history, I still don&#39;t have much of a game. It&#39;s only about 6,000 lines of Vale code.
</p>

</section>
<section>
<p>
It&#39;s clear that if I spent all this time working on an actual game instead, instead of making the perfect programming language for game design, then I&#39;d have three or four games by now! In this timeline, I don&#39;t have those games.
</p>

</section>
<section>
<p>
Still, I&#39;m very glad I spent this time working on a programming language, because I ended up creating something <i>so weird, so unrecognizable</i> <a href="#note12" data-noteid="12">12</a> that it blows people&#39;s minds, and that&#39;s a really great feeling.
</p>

</section>
<section>
<p>
I also now have something that can help a lot of people for decades to come. Speed and safety has always incurred a lot of complexity burden on the programmer, and maybe with this language, I can help with that.
</p>

</section>
<section>
<h2 id="thats-all">
 That&#39;s all!</h2>
<p>
Thanks for visiting, and I hope you enjoyed reading about this experience as much as I enjoyed writing it!
</p>

</section>
<section>
<p>
In the coming weeks, I&#39;ll be writing more about our &#34;region borrow checker&#34; which helps eliminate Vale&#39;s memory safety overhead, so subscribe to our <a href="https://verdagon.dev/rss.xml">RSS feed</a> or the <a href="https://reddit.com/r/vale">r/Vale</a> subreddit, and come hang out in the <a href="https://discord.gg/SNB8yGH">Vale discord</a>.
</p>

</section>
<section>
<p>
If you found this interesting or entertaining, please consider sponsoring me:
</p>
<center>
  <a href="https://github.com/sponsors/ValeLang">
     
     Sponsor me on GitHub!
  </a>
</center>

<p>
With your help, I can write this kind of nonsense more often!
</p>

</section>

      </div>
  
<div>

      <div>
        <div>
    
<div id="note12" data-noteid="12">
<p><span>12</span></p><section>
<p>
Nobody would have thought that there was an alternative to GC, RC, and borrow checking!
</p>

</section>
</div>

        </div>
      </div>
    
</div>

    </div><div>
      <div>
  
<section>
<h2 id="about-the-vale-language-project">
 About the Vale Language Project</h2>
<p>
The Vale Language Project is not just about making Vale, it&#39;s about <b>exploring, discovering, and publishing</b> new programming language mechanisms that enable <b>speed</b>, <b>safety</b>, and <b>ease of use.</b>
</p>

</section>
<section>
<p>
<b>The world needs more exploration here!</b> Currently, most programming language research is is in:
</p>
<ul>
<li>
High-overhead languages involving reference counting and tracing garbage collection.
</li>
<li>
Complex languages (Ada/Spark, Coq, Rust, Haskell, etc.) which impose a higher complexity burden on the average programmer.
</li>
</ul>
<p>
These are useful, but there is a <b>vast field of possibilities</b> in between, waiting to be explored!
</p>

</section>
<section>
<p>
Our aim is to explore that space, discover what it has to offer, and make <b>speed and safety easier than ever before.</b>
</p>

</section>
<section>
<p>
In this quest, we&#39;ve discovered a lot of new techniques:
</p>
<ul>
<li>
<a href="https://verdagon.dev/blog/zero-cost-refs-regions">Region Borrow Checking</a>, which adds mutable aliasing support to a Rust-like borrow checker.
</li>
<li>
<a href="https://verdagon.dev/blog/generational-references">Generational Memory</a>, for a language to ensure an object still exists at the time of dereferencing.
</li>
<li>
<a href="https://verdagon.dev/blog/hybrid-generational-memory">Hybrid-Generational Memory</a>, which ensures that nobody destroys an object too early, for better optimizations.
</li>
</ul>

</section>
<section>
<p>
These techniques have also opened up some new emergent possibilities:
</p>
<ul>
<li>
<a href="https://verdagon.dev/blog/seamless-fearless-structured-concurrency">Seamless concurrency</a>, the ability to launch multiple threads that can access any pre-existing data without data races, without the need for refactoring the code or the data.
</li>
<li>
Object pools and bump-allocators that are memory-safe and decoupled, so no refactoring needed.
</li>
<li>
<a href="https://verdagon.dev/blog/fearless#safe-externs">Fearless FFI</a>, which allows us to call into C without risk of accidentally corrupting Vale objects.
</li>
<li>
Deterministic replayability, to record all inputs and replay execution. Goodbye races and heisenbugs!
</li>
<li>
<a href="https://verdagon.dev/blog/raii-next-steps">Higher RAII</a>, a form of linear typing that enables destructors with parameters and returns.
</li>
</ul>

</section>
<section>
<p>
We also gain a lot of inspiration from other languages, and are finding new ways to combine their techniques:
</p>
<ul>
<li>
We can mix an <span>unsafe</span> block with Fearless FFI to make a much safer systems programming language!
</li>
<li>
We can mix Erlang&#39;s isolation benefits with functional reactive programming to make much more resilient programs!
</li>
<li>
We can mix region borrow checking with Pony&#39;s <span>iso</span> to support shared mutability.
</li>
</ul>
<p>
...plus a lot more interesting ideas to explore!
</p>

</section>
<section>
<p>
The Vale programming language is only one combination of the features we&#39;ve found. Our goal is to publish all the techniques we&#39;ve found, even the ones that couldn&#39;t fit in Vale, so that other languages can make strides in this area.
</p>

</section>
<section>
<p>
Our medium-term goals:
</p>
<ul>
<li>
Publish the Language Simplicity Manifesto, a collection of principles to keep programming languages&#39; learning curves down.
</li>
<li>
Publish the Memory Safety Grimoire, a collection of &#34;memory safety building blocks&#34; that languages can potentially use to make new memory models, just like Vale combined generational references and scope tethering.
</li>
<li>
Prototype the Region Borrow Checker in Vale, to show the world that shared mutability can work with borrow checking!
</li>
<li>
Prototype Hybrid-Generational Memory in Vale, to see how fast and easy we can make single ownership.
</li>
</ul>

</section>
<section>
<p>
We aim to publish articles biweekly on all of these topics, and inspire the next generation of fast, safe, and easy programming languages.
</p>

</section>
<section>
<p>
If you want to support our work, please consider <a href="https://github.com/sponsors/ValeLang">sponsoring us on GitHub</a>!
</p>
<p>
With enough sponsorship, we can:
</p>
<ul>
<li>
Work on this full-time.
</li>
<li>
Turn the Vale Language Project into a 501(c)(3) non-profit organization.
</li>
<li>
Make Vale into a production-ready language, and push it into the mainstream!
</li>
</ul>
<center>
  <a href="https://github.com/sponsors/ValeLang">
     
     Sponsor us on GitHub!
  </a>
</center>



</section>

      </div>
  


    </div></div>
  </body>
</html>
