<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://dorotac.eu/posts/libobscura/">Original</a>
    <h1>Libobscura</h1>
    
    <div id="readability-page-1" class="page"><div>

  <article>
    
      
<p>Let me formally introduce you to my most recent overly-ambitious experiment: *<em><a href="https://libobscura.codeberg.page">libobscura</a></em>*.</p>
<p><img src="https://dorotac.eu/posts/libobscura/libobscura.svg" alt="libobscura"/></p>
<p>**<strong>Libobscura is a friendly library to use cameras on Linux.</strong>**</p>
<p>At least that&#39;s the goal.</p>
<h2>## What does &#34;friendly&#34; mean?</h2>
<ul>
<li>*<em>It&#39;s hard to use it wrong.</em>* No segfaults. Errors guide you to the right track.</li>
<li>*<em>Point-and-shoot.</em>* If that&#39;s all you need, you get a RGB buffer in ten lines of code.</li>
<li>*<em>It&#39;s easy to add support for new devices.</em>* Great documentation and a good internal API are the goals.</li>
<li>*<em>It&#39;s easy to contribute to.</em>* Send patches using the <a href="https://codeberg.org/libobscura/libobscura/pulls">web interface</a>, not a mailing list.</li>
</ul>
<p>TL;DR: with the simple buffer API you can get a frame in 6 calls, and map it to CPU in another 2:</p>
<pre>```
<code>let cameras_list = vidi::actors::camera_list::spawn()?;
let cameras = cameras_list.cameras();
let camera = cameras_list.create(&amp;cameras[0].info.id)
    .expect(&#34;No such camera&#34;)
    .expect(&#34;Failed to create camera&#34;);

let mut camera = camera.acquire();
if let Ok(ref mut camera) = camera {
    let mut stream = camera.start(
        Config{fourcc: FourCC::new(b&#34;YUYV&#34;)},
        4
    ).unwrap();
    loop {
        let (buf, meta, _next) = stream.next().unwrap();
        let mmap = buf.memory_map_ro().unwrap();
        let data = mmap.as_slice();
    }
}
</code>```</pre>
<p>Go to project <a href="https://codeberg.org/libobscura/libobscura/src/branch/master/crates/vidi-examples">examples</a> for more.</p>
<p><img src="https://dorotac.eu/posts/libobscura/baby.png" alt="A baby placing a missing block. They are stacked in the Bayer pattern."/></p>
<p>Figure 1: Libobscura will never be friendly enough for every audience.</p>
<h2>## What cameras?</h2>
<p>Any webcams, industrial cameras, image sensors working exposed by the V4L2 interface are currently in scope.</p>
<h2>## What does &#34;experiment&#34; mean?</h2>
<p>There are already other libraries for camera support on Linux. You can use the <a href="https://www.kernel.org/doc/html/latest/userspace-api/media/v4l/v4l2.html">V4L2 APIs</a> directly, or use <a href="https://libcamera.org/">libcamera</a>, or <a href="https://gitlab.com/megapixels-org/libmegapixels">libmegapixels</a>.</p>
<p>They all strike various middle points on the power vs user-friendliness scale. Having worked with all of them while developing camera support for the <a href="https://puri.sm/products/librem-5/">Librem 5</a>, I never got the impression that any of them are particularly easy to use.</p>
<p>Libobscura is an experiment because it tries to find an API that fulfills the needs of most people and remains hard to use wrong.</p>
<p><img src="https://dorotac.eu/posts/libobscura/diagram.png" alt="A diagram showing two axes: vertically ease of use and horizontally covered use cases. A couple of projects are positioned below an area called &#34;unexplored&#34;, whichis itself under am area called &#34;unachievable&#34;. The borders are roughly moving to less easy to use as covered use cases grow."/></p>
<p>Figure 2: My &#34;Perfect tool&#34; conjecture. Imagine you have a perfectly well useable tool covering some of your needs. If your needs grow, the perfect tool covering those tools cannot be easier to use than your old tool. And humans are imperfect. This applies to APIs, as well. I put my rough idea of where I think a couple of examples fall. Libcamera tries to be as general as possible, so it&#39;s on the far right. OpenCV has Python bindings, so it&#39;s up top. Libobscura starts out a bit to the left and top, and I hope to push it to the right, to explore how many use cases can be added while staying easy.</p>
<p>Perhaps it&#39;s impossible to improve on what current libraries do. But now libobscura is a space where it&#39;s possible to try out radical changes without bothering the maintainers of existing libraries – for example, to try out an entirely new approach.</p>
<h2>## Radical approaches</h2>
<p>There are a couple of radical approaches in libobscura that earn it the &#34;experiment&#34; status.</p>
<h3>### Rust</h3>
<p>Rust is a memory-safe systems language. Libobscura uses it to ensure that the APIs are hard to use wrong. A Rust API built with a little care does not let you crash with a segfault – the compiler will alert you before you can create problems.</p>
<p>The Linux kernel started its <a href="https://rust-for-linux.com/">own Rust experiment</a> in 2020. Linux is a low-level project. Camera support is a low-level topic (many people working on libcamera also work on the kernel). If Rust is interesting for Linux, then it&#39;s interesting for libobscura.</p>
<h3>### Get RGB data</h3>
<p>A camera library can&#39;t be described as easy to use if the pictures it gives you need to be processed before displaying.</p>
<p>The typical format to display data is RGB while cameras return either Bayer or YUV data. With libobscura, the goal is to provide those conversions transparently, without any extra effort on behalf of the user or camera backend.</p>
<h3>### GPU acceleration</h3>
<p>The conversions might not be implemented in hardware, but don&#39;t worry, libobscura has your back! It comes with a GPU-accelerated image processing library called <a href="https://codeberg.org/libobscura/libobscura/src/branch/master/crates/crispy">crispy-img</a>.</p>
<p>Why GPU? The idea started with the Librem 5, which will often record video while running on battery. Offloading this work to the GPU is a clear win, and I expect most Linux video-capable devices to have some form of GPU. And we&#39;re open to a CPU decoder if you want to contribute!</p>
<p><img src="https://dorotac.eu/posts/libobscura/painter.png" alt="A painter looking at a canvas with 4 colored strokes: 2 colored, 2 gray, representing YUYV. The painter holds a brush at a canvas on the other side with 3 colored strokes: red, green, and blue."/></p>
<p>Figure 3: An artist&#39;s impression of a pixel format conversion shader.</p>
<h2>## Status</h2>
<p>Because libobscura is only two months old as a funded project, the current status is &#34;proof of concept&#34;. There&#39;s a safe and limited user API, another more tricky but zero-copy API, the GPU accelerated library can handle some conversions, and camera support is relatively simple. USB camera demo works.</p>
<p>But there are still <a href="https://codeberg.org/libobscura/libobscura/issues">goals to achieve</a>:</p>
<ul>
<li><a href="https://codeberg.org/libobscura/libobscura/issues/1">change controls</a> like brightness or focus,</li>
<li><a href="https://codeberg.org/libobscura/libobscura/issues/2">transparently integrate</a> GPU processing,</li>
<li>have a way to choose your <a href="https://codeberg.org/libobscura/libobscura/issues/3">preferred output format</a>,</li>
<li>implement <a href="https://codeberg.org/libobscura/libobscura/issues/5">auto-* algorithms</a> when the camera doesn&#39;t have auto mode,</li>
<li>replace <a href="https://codeberg.org/libobscura/libobscura/issues/6">LGPL-licensed pieces</a> from libvidi and crispycam (not great for link-time-optimized code)</li>
<li>add <a href="https://pipewire.org/">Pipewire</a> <a href="https://codeberg.org/libobscura/libobscura/issues/7">integration</a>, so your browser can just pick up your camera feed for teleconferencing,</li>
<li>add <a href="https://codeberg.org/libobscura/libobscura/issues/9">Librem 5 support</a> as a realistic, useful verification of concept.</li>
</ul>
<p>Those will be the next steps for the project. First implement all the functionality and then extend support for more devices. This way we can catch corner cases in the API that are bound to appear with unusual setups.</p>
<h2>## The future is YOU</h2>
<p>I&#39;m making libobscura in the hope that it will be useful to people. As a base to build software, or to ship devices, or to learn what software architectures fit this problem.</p>
<p>When I sent my funding request to Prototype Fund, I didn&#39;t expect to be taken seriously. After all, what motivated me most was that it was a cool challenge. Apparently they believed in me more than I did, because I got funding until March 2025.</p>
<p>What happens until then and what happens next depends on how useful this work actually is to YOU. The ultimate goal of any software is to be useful, otherwise what&#39;s the point?</p>
<p>So I invite YOU to analyze it, try it out, give feedback, experiment with it, copy the concepts, <a href="https://libobscura.codeberg.page/community.html#contributing">contribute</a> to docs, illustrations, and code, fork it entirely! Regardless if you come from the <a href="https://postmarketos.org/">Mobile</a> <a href="https://mobian.org/">Linux</a> <a href="https://manjaro.org/">community</a>, or <a href="https://www.raspberrypi.com/documentation/accessories/camera.html">Raspberry Pi</a>, or you have a laptop with this <a href="https://github.com/linux-surface/linux-surface/wiki/Camera-Support">IPU thing</a>, or if you&#39;re from libcamera. When you improve, libobscura fulfills its goals.</p>
<p>So see you on the <a href="https://codeberg.org/libobscura/libobscura">project page</a>!</p>
<h2>## Thanks</h2>
<p>Thank you to <a href="https://puri.sm">Purism</a>, for inviting me to the Linux camera work and funding the base which I&#39;m using now.</p>
<p>Thank you to all the libcamera people! I stol... was inspired by libcamera&#39;s architecture, and you also answered my countless questions both during Librem 5 development and recently.</p>
<p>Thank you <a href="https://blog.brixit.nl/">Martijn Braam</a> for showing how to create simple config files for many mobile phones.</p>
<p>Thank you <a href="https://www.bmbf.de">BMBF</a> for providing the funding money, and thanks <a href="https://prototypefund.de/">Prototype Fund</a> for connecting me to it :)</p>
<p><img src="https://dorotac.eu/posts/libobscura/bmbf.jpg" alt="Logo: sponsored by the Federal Ministry of Education and Research"/></p>

    
    
    <section>
        <a href="https://comments.dorotac.eu/posts/libobscura">Comments</a>
        
    </section>
  </article>

    </div></div>
  </body>
</html>
