<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/sebosp/s2protocol-rs">Original</a>
    <h1>Show HN: A nom parser for the Starcraft 2 Protocol Replay format</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><p dir="auto"><a href="https://crates.io/crates/s2protocol" rel="nofollow"><img src="https://camo.githubusercontent.com/a1812bb4b15e9310c05a13d289e8ea9d335f8acce82020e7172c3a2e4e8e6a5f/68747470733a2f2f696d672e736869656c64732e696f2f6372617465732f762f733270726f746f636f6c2e737667" alt="Crates.io" data-canonical-src="https://img.shields.io/crates/v/s2protocol.svg"/></a>
<a href="https://github.com/sebosp/s2protocol-rs/actions?query=workflow%3A%22Rust%22"><img src="https://github.com/sebosp/s2protocol-rs/workflows/Rust/badge.svg" alt="Workflow Status"/></a></p>

<p dir="auto">A nom parser for the Starcraft 2 Protocol Replay format.
Provides Iterators to transist a minimal state machine through the game loops
Keeping track of unit groups, upgrades, targets, etc.</p>
<h2 tabindex="-1" id="user-content-motivation" dir="auto"><a href="#motivation">Motivation<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">The goal is to learn how to parse binary files format with <code>nom</code> and to learn
how the Starcraft 2 Replay file is so incredibly small for the amount of
information it packs.</p>
<p dir="auto">From the available data, analytics, visualizations and generative art can be created, for example
by using</p>
<ul dir="auto">
<li><a href="https://github.com/rerun-io/rerun">rerun</a> : See the repo <a href="https://github.com/sebosp/swarmy">swarmy</a></li>
<li><a href="https://github.com/nical/lyon">lyon</a> (PoC in progress in cooper)</li>
<li><a href="https://github.com/yewstack/yew">yew</a> <a href="https://github.com/sebosp/cooper">cooper</a></li>
<li><a href="https://github.com/emilk/egui">eframe/egui</a>: See repo <a href="https://github.com/sebosp/eframe-sc2">eframes-c2</a></li>
<li><a href="https://github.com/bevyengine/bevy">bevyengine/bevy</a> can be used to see:
<ul dir="auto">
<li>An Enhanced Replay Minimap</li>
<li>Additional statistics.</li>
</ul>
</li>
</ul>
<h2 tabindex="-1" id="user-content-consuming-events" dir="auto"><a href="#consuming-events">Consuming events<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<h3 tabindex="-1" id="user-content-transition-iterators" dir="auto"><a href="#transition-iterators">Transition Iterators<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">These are different ways to consume the events:</p>
<ul dir="auto">
<li><code>SC2EventIterator</code> collects both TrackerEvents and GameEvents. Events are provided as they appear, be them Tracker or Game</li>
<li><code>TrackerEventIterator</code> allows consuming only Tracker Events</li>
<li><code>GameEventIterator</code> allows consuming only the Game Events</li>
</ul>
<p dir="auto">Event changes transist a minimal state machine that updates:</p>
<ul dir="auto">
<li>names</li>
<li>positions</li>
<li>Attack events</li>
<li>etc.</li>
</ul>
<p dir="auto">The iterators returns a tuple <code>(SC2EventType, UnitChangeHint)</code>
The first item contains the event itself as it was deserialized from the SC2Replay.
The second item hints the consumers of the iterator about the changes performed to the state machine due to this event.
For example, units may have been deleted, added, changed position, etc.</p>
<div dir="auto" data-snippet-clipboard-copy-content="let source: PathBuf = PathBuf::new();
let res = s2protocol::state::SC2EventIterator::new(&amp;source)?;
for (event, change_hint) in res.into_iter() {
    println!(&#34;{},&#34;, serde_json::to_string(&amp;event)?);
}"><pre><span>let</span> source<span>:</span> <span>PathBuf</span> = <span>PathBuf</span><span>::</span><span>new</span><span>(</span><span>)</span><span>;</span>
<span>let</span> res = s2protocol<span>::</span>state<span>::</span><span>SC2EventIterator</span><span>::</span><span>new</span><span>(</span><span>&amp;</span>source<span>)</span>?<span>;</span>
<span>for</span> <span>(</span>event<span>,</span> change_hint<span>)</span> <span>in</span> res<span>.</span><span>into_iter</span><span>(</span><span>)</span> <span>{</span>
    <span>println</span><span>!</span><span>(</span><span>&#34;{},&#34;</span>, serde_json::to_string<span>(</span>&amp;event<span>)</span>?<span>)</span><span>;</span>
<span>}</span></pre></div>
<h2 tabindex="-1" id="user-content-interacting-with-polars" dir="auto"><a href="#interacting-with-polars">Interacting with polars<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<h3 tabindex="-1" id="user-content-generating-the-ipc-arrow-datasets" dir="auto"><a href="#generating-the-ipc-arrow-datasets">Generating the IPC Arrow datasets<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">In the directory ipcs/ one .ipc file will be created per implemented data type.
The <code>--source</code> is the directory that contains the replay directory (Or a single file).
Files are processed using parallel operations.
For 3600 files (500 MBs) it takes 30 seconds to transform/split them. YMMV</p>
<p dir="auto">This is behind a feature flag <code>arrow</code>.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ mkdir ipcs/
$ cargo run --features arrow -r -- --source &#34;/mnt/windows/Users/sebos/Documents/StarCraft II/Accounts/51504154/2-S2-1-8459957/Replays/Multiplayer/&#34; --output ipcs/ write-arrow-ipc all
2023-10-04T18:53:36.030202Z  INFO s2protocol::arrow: Processing Arrow write request
2023-10-04T18:53:36.441089Z  INFO s2protocol::arrow: Found 3600 files
2023-10-04T18:53:36.441646Z  INFO s2protocol::arrow: Processing InitData IPC write request
2023-10-04T18:53:38.515349Z  INFO s2protocol::arrow: Loaded 3600 records
2023-10-04T18:53:38.575090Z  INFO s2protocol::arrow: Processing Details IPC write request
2023-10-04T18:53:38.700572Z  INFO s2protocol::arrow: Loaded 3600 records
2023-10-04T18:53:38.706659Z  INFO s2protocol::arrow: Processing TrackerEvents IPC write request: Stats
2023-10-04T18:53:44.295524Z  INFO s2protocol::arrow: Loaded 1722783 records
2023-10-04T18:53:44.515362Z  INFO s2protocol::arrow: Processing TrackerEvents IPC write request: Upgrades
2023-10-04T18:53:49.963043Z  INFO s2protocol::arrow: Loaded 292898 records
2023-10-04T18:53:50.036165Z  INFO s2protocol::arrow: Processing TrackerEvents IPC write request: UnitBorn
2023-10-04T18:53:57.561082Z  INFO s2protocol::arrow: Loaded 22754591 records
2023-10-04T18:54:00.502298Z  INFO s2protocol::arrow: Processing TrackerEvents IPC write request: UnitDied
2023-10-04T18:54:07.387545Z  INFO s2protocol::arrow: Loaded 16118808 records
Total time: 33.654286961s"><pre>$ mkdir ipcs/
$ cargo run --features arrow -r -- --source <span><span>&#34;</span>/mnt/windows/Users/sebos/Documents/StarCraft II/Accounts/51504154/2-S2-1-8459957/Replays/Multiplayer/<span>&#34;</span></span> --output ipcs/ write-arrow-ipc all
2023-10-04T18:53:36.030202Z  INFO s2protocol::arrow: Processing Arrow write request
2023-10-04T18:53:36.441089Z  INFO s2protocol::arrow: Found 3600 files
2023-10-04T18:53:36.441646Z  INFO s2protocol::arrow: Processing InitData IPC write request
2023-10-04T18:53:38.515349Z  INFO s2protocol::arrow: Loaded 3600 records
2023-10-04T18:53:38.575090Z  INFO s2protocol::arrow: Processing Details IPC write request
2023-10-04T18:53:38.700572Z  INFO s2protocol::arrow: Loaded 3600 records
2023-10-04T18:53:38.706659Z  INFO s2protocol::arrow: Processing TrackerEvents IPC write request: Stats
2023-10-04T18:53:44.295524Z  INFO s2protocol::arrow: Loaded 1722783 records
2023-10-04T18:53:44.515362Z  INFO s2protocol::arrow: Processing TrackerEvents IPC write request: Upgrades
2023-10-04T18:53:49.963043Z  INFO s2protocol::arrow: Loaded 292898 records
2023-10-04T18:53:50.036165Z  INFO s2protocol::arrow: Processing TrackerEvents IPC write request: UnitBorn
2023-10-04T18:53:57.561082Z  INFO s2protocol::arrow: Loaded 22754591 records
2023-10-04T18:54:00.502298Z  INFO s2protocol::arrow: Processing TrackerEvents IPC write request: UnitDied
2023-10-04T18:54:07.387545Z  INFO s2protocol::arrow: Loaded 16118808 records
Total time: 33.654286961s</pre></div>
<h3 tabindex="-1" id="user-content-jupyter-notebooks" dir="auto"><a href="#jupyter-notebooks">Jupyter Notebooks<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<div data-snippet-clipboard-copy-content="$ virtualenv new venv
$ source ./venv/bin/activate
$ pip install -r requirements.txt
$ jupyter lab"><pre><code>$ virtualenv new venv
$ source ./venv/bin/activate
$ pip install -r requirements.txt
$ jupyter lab
</code></pre></div>
<p dir="auto">Then open your browser and locate the Notebbooks, for example:</p>
<p dir="auto"><a href="https://github.com/sebosp/s2protocol-rs/blob/main/jupyter_notebooks/Basic-UnitBorn-Queries.ipynb">Basic UnitBorn Queries</a>
<a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/873436/272668152-2307780a-bc62-4cd4-9daf-a3e622bdb5b7.png"><img src="https://user-images.githubusercontent.com/873436/272668152-2307780a-bc62-4cd4-9daf-a3e622bdb5b7.png" alt="All units born"/></a>
<a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/873436/272679127-cba9da20-a034-47f3-9016-bfd6db21247b.png"><img src="https://user-images.githubusercontent.com/873436/272679127-cba9da20-a034-47f3-9016-bfd6db21247b.png" alt="Most effective units across all games"/></a></p>
<h3 tabindex="-1" id="user-content-polars-cli" dir="auto"><a href="#polars-cli">polars-cli<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<div dir="auto" data-snippet-clipboard-copy-content="$ cargo install polars-cli
$ # List the max number of minerals that were lost in per map when the army was killed.
❯ echo &#34;SELECT ext_fs_replay_file_name, MAX(minerals_lost_army) FROM read_ipc(&#39;/home/seb/git/s2protocol-rs/ipcs/stats.ipc&#39;) GROUP BY ext_fs_replay_file_name ORDER BY minerals_lost_army DESC;&#34;|polars
┌───────────────────────────────────┬────────────────────┐
│ ext_fs_replay_file_name           ┆ minerals_lost_army │
│ ---                               ┆ ---                │
│ str                               ┆ i32                │
╞═══════════════════════════════════╪════════════════════╡
│ Heavy Artillery LE (349).SC2Repl… ┆ 71362              │
│ Arctic Dream LE (398).SC2Replay   ┆ 59375              │
│ Nightscape LE (52).SC2Replay      ┆ 54846              │
│ …                                 ┆ …                  │
│ Emerald City LE (223).SC2Replay   ┆ 43450              │
│ Rhoskallian LE (101).SC2Replay    ┆ 41614              │
│ Fields of Death (345).SC2Replay   ┆ 41529              │
│ Rhoskallian LE (346).SC2Replay    ┆ 41425              │
└───────────────────────────────────┴────────────────────┘"><pre>$ cargo install polars-cli
$ <span><span>#</span> List the max number of minerals that were lost in per map when the army was killed.</span>
❯ <span>echo</span> <span><span>&#34;</span>SELECT ext_fs_replay_file_name, MAX(minerals_lost_army) FROM read_ipc(&#39;/home/seb/git/s2protocol-rs/ipcs/stats.ipc&#39;) GROUP BY ext_fs_replay_file_name ORDER BY minerals_lost_army DESC;<span>&#34;</span></span><span>|</span>polars
┌───────────────────────────────────┬────────────────────┐
│ ext_fs_replay_file_name           ┆ minerals_lost_army │
│ ---                               ┆ ---                │
│ str                               ┆ i32                │
╞═══════════════════════════════════╪════════════════════╡
│ Heavy Artillery LE (349).SC2Repl… ┆ 71362              │
│ Arctic Dream LE (398).SC2Replay   ┆ 59375              │
│ Nightscape LE (52).SC2Replay      ┆ 54846              │
│ …                                 ┆ …                  │
│ Emerald City LE (223).SC2Replay   ┆ 43450              │
│ Rhoskallian LE (101).SC2Replay    ┆ 41614              │
│ Fields of Death (345).SC2Replay   ┆ 41529              │
│ Rhoskallian LE (346).SC2Replay    ┆ 41425              │
└───────────────────────────────────┴────────────────────┘</pre></div>
<h2 tabindex="-1" id="user-content-status" dir="auto"><a href="#status">Status<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<ul>
<li> Replay Tracker, Game Events and Chat Message Events for protocol75689</li>
<li> Replay Tracker, Game Events and Chat Message Events for protocol84643</li>
<li> Replay Tracker, Game Events and Chat Message Events for protocol87702</li>
<li> Replay Tracker, Game Events and Chat Message Events for protocol88500</li>
<li> Replay Tracker, Game Events and Chat Message Events for protocol89634</li>
<li> Replay Tracker, Game Events and Chat Message Events for protocol89720</li>
<li> Replay Tracker, Game Events and Chat Message Events for protocol90136</li>
<li> Replay Tracker, Game Events and Chat Message Events for protocol90779</li>
<li> Replay Tracker, Game Events and Chat Message Events for protocol90870</li>
<li> Parsing unit movement is done.</li>
<li> Decoding the tag/recycle done to match Game Events.</li>
<li> Game Events are parsed (tho some that seem irrelevant are skipped).</li>
<li> Read the version and from the version call the correct module so that we can support multiple modules.</li>
<li> Support for MPQ embedded file: <code>replay.initData</code></li>
<li> Add the remaining Tracker/Game event types.</li>
<li> Support for MPQ embedded file: <code>replay.gamemetadata.json</code></li>
<li> Support for MPQ embedded file: <code>replay.attributes.events</code></li>
</ul>
<h2 tabindex="-1" id="user-content-current-issues" dir="auto"><a href="#current-issues">Current issues<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">In the arrow file generation, sha256 digest is used to detect duplication/etc.
This inflates the size of the rows. Even tho it&#39;s slightly less than long directory names.
Perhaps using short rev-parse for sha256 may be better, find something like 7-characters unique combinations
And use that instead of the long sha256 form.</p>
<h2 tabindex="-1" id="user-content-version-compatibility" dir="auto"><a href="#version-compatibility">version compatibility.<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">After a bit of testing, it seems most of the types are compatible between versions, so only when they differ would they make part of the protocol version.
Since I started this exercise on protocol87702, all types would be relative to it. That is, most modules would re-use protocol87702 as much as possible.
This explains why old-er versions such as 75689 would still reference 87702 as much as possible.</p>
<p dir="auto">The generator above thus would show example code <code>S2ProtoResult</code> created in favour of unwrapping/panic&#39;ing.</p>
<h2 tabindex="-1" id="user-content-generating-protocol-specific-code" dir="auto"><a href="#generating-protocol-specific-code">Generating protocol-specific code:<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">The rust code for the protocols versions available were generated using:
This would now be compared with ./src/versions/protocol99999.template file and from there we can analyze what has changed.
Notably, the number of bits used for the Chat Message is still miscalculated to 3 so it needs to be dismissed.</p>
<div dir="auto" data-snippet-clipboard-copy-content="mkdir src/versions/protocol89720/
RUST_LOG_SPAN_EVENTS=full RUST_LOG=debug cargo watch -i src/versions/protocol89720/mod.rs -x &#39;run -- --source ../s2protocol/json/protocol89720.json generate --output src/versions/protocol89720/mod.rs&#39;
# Add the new module to src/versions/mod.rs
# Run rust format on the new src/versions/protocol87702/mod.rs file
# cargo check, cargo build, etc
# Additionally some code to transform from Protocol-Specific to Protocol-Agnostic was added, TODO: Add to generator.rs"><pre>mkdir src/versions/protocol89720/
RUST_LOG_SPAN_EVENTS=full RUST_LOG=debug cargo watch -i src/versions/protocol89720/mod.rs -x <span><span>&#39;</span>run -- --source ../s2protocol/json/protocol89720.json generate --output src/versions/protocol89720/mod.rs<span>&#39;</span></span>
<span><span>#</span> Add the new module to src/versions/mod.rs</span>
<span><span>#</span> Run rust format on the new src/versions/protocol87702/mod.rs file</span>
<span><span>#</span> cargo check, cargo build, etc</span>
<span><span>#</span> Additionally some code to transform from Protocol-Specific to Protocol-Agnostic was added, TODO: Add to generator.rs</span></pre></div>
<h2 tabindex="-1" id="user-content-json-sources" dir="auto"><a href="#json-sources">JSON Sources<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto"><a href="https://github.com/Blizzard/s2protocol">Blizzard/s2protocol repo</a></p>
</article>
          </div></div>
  </body>
</html>
