<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://machinelearning.apple.com/research/introducing-apple-foundation-models">Original</a>
    <h1>Apple&#39;s On-Device and Server Foundation Models</h1>
    
    <div id="readability-page-1" class="page"><div role="main"><section><div><p>At the 2024 <a href="https://developer.apple.com/wwdc24/">Worldwide Developers Conference</a>, we introduced Apple Intelligence, a personal intelligence system integrated deeply into iOS 18, iPadOS 18, and macOS Sequoia.</p>
<p>Apple Intelligence is comprised of multiple highly-capable generative models that are specialized for our users’ everyday tasks, and can adapt on the fly for their current activity. The foundation models built into Apple Intelligence have been fine-tuned for user experiences such as writing and refining text, prioritizing and summarizing notifications, creating playful images for conversations with family and friends, and taking in-app actions to simplify interactions across apps.</p>
<p>In the following overview, we will detail how two of these models — a ~3 billion parameter on-device language model, and a larger server-based language model available with <a href="https://security.apple.com/blog/private-cloud-compute/">Private Cloud Compute</a> and running on Apple silicon servers — have been built and adapted to perform specialized tasks efficiently, accurately, and responsibly. These two foundation models are part of a larger family of generative models created by Apple to support users and developers; this includes a coding model to build intelligence into Xcode, as well as a diffusion model to help users express themselves visually, for example, in the Messages app. We look forward to sharing more information soon on this broader set of models.</p>
<h2>Our Focus on Responsible AI Development</h2>
<p>Apple Intelligence is designed with our core values at every step and built on a foundation of groundbreaking privacy innovations.</p>
<p>Additionally, we have created a set of Responsible AI principles to guide how we develop AI tools, as well as the models that underpin them:</p>
<ol>
<li><span>Empower users with intelligent tools</span>: We identify areas where AI can be used responsibly to create tools for addressing specific user needs. We respect how our users choose to use these tools to accomplish their goals.</li>
<li><span>Represent our users</span>: We build deeply personal products with the goal of representing users around the globe authentically. We work continuously to avoid perpetuating stereotypes and systemic biases across our AI tools and models.</li>
<li><span>Design with care</span>: We take precautions at every stage of our process, including design, model training, feature development, and quality evaluation to identify how our AI tools may be misused or lead to potential harm. We will continuously and proactively improve our AI tools with the help of user feedback.</li>
<li><span>Protect privacy</span>: We protect our users&#39; privacy with powerful on-device processing and groundbreaking infrastructure like Private Cloud Compute. We do not use our users&#39; private personal data or user interactions when training our foundation models.</li>
</ol>
<p>These principles are reflected throughout the architecture that enables Apple Intelligence, connects features and tools with specialized models, and scans inputs and outputs to provide each feature with the information needed to function responsibly.</p>
<p>In the remainder of this overview, we provide details on decisions such as: how we develop models that are highly capable, fast, and power-efficient; how we approach training these models; how our adapters are fine-tuned for specific user needs; and how we evaluate model performance for both helpfulness and unintended harm.</p>
<figure id="figure1" aria-labelledby="figure-figure1-caption" data-aos="fade-up"><p><a href="https://mlr.cdn-apple.com/media/Fig1_Responsible_AI_8bf7727ab5.png" aria-label="Modeling overview" tabindex="-1" target="_blank"><img src="https://mlr.cdn-apple.com/media/Fig1_Responsible_AI_8bf7727ab5.png" alt="Modeling overview" loading="lazy"/></a></p><figcaption id="figure-figure1-caption" aria-hidden="false">Figure 1: Modeling overview for the Apple foundation models.</figcaption></figure>
<h2>Pre-Training</h2>
<p>Our foundation models are trained on <a href="https://github.com/apple/axlearn" target="_blank" aria-label="Apple&#39;s AXLearn framework - Opens in a new window" rel="noopener nofollow">Apple&#39;s AXLearn framework</a>, an open-source project we released in 2023. It builds on top of JAX and XLA, and allows us to train the models with high efficiency and scalability on various training hardware and cloud platforms, including TPUs and both cloud and on-premise GPUs. We used a combination of data parallelism, tensor parallelism, sequence parallelism, and Fully Sharded Data Parallel (FSDP) to scale training along multiple dimensions such as data, model, and sequence length.</p>
<p>We train our foundation models on licensed data, including data selected to enhance specific features, as well as publicly available data collected by our web-crawler, AppleBot. Web publishers have <a href="https://support.apple.com/en-us/119829">the option to opt out</a> of the use of their web content for Apple Intelligence training with a data usage control.</p>
<p>We never use our users’ private personal data or user interactions when training our foundation models, and we apply filters to remove personally identifiable information like social security and credit card numbers that are publicly available on the Internet. We also filter profanity and other low-quality content to prevent its inclusion in the training corpus. In addition to filtering, we perform data extraction, deduplication, and the application of a model-based classifier to identify high quality documents.</p>
<h2>Post-Training</h2>
<p>We find that data quality is essential to model success, so we utilize a hybrid data strategy in our training pipeline, incorporating both human-annotated and synthetic data, and conduct thorough data curation and filtering procedures. We have developed two novel algorithms in post-training: (1) a rejection sampling fine-tuning algorithm with teacher committee, and (2) a reinforcement learning from human feedback (RLHF) algorithm with mirror descent policy optimization and a leave-one-out advantage estimator. We find that these two algorithms lead to significant improvement in the model’s instruction-following quality.</p>
<h2>Optimization</h2>
<p>In addition to ensuring our generative models are highly capable, we have used a range of innovative techniques to optimize them on-device and on our private cloud for speed and efficiency. We have applied an extensive set of optimizations for both first token and extended token inference performance.</p>
<p>Both the on-device and server models use grouped-query-attention. We use shared input and output vocab embedding tables to reduce memory requirements and inference cost. These shared embedding tensors are mapped without duplications. The on-device model uses a vocab size of 49K, while the server model uses a vocab size of 100K, which includes additional language and technical tokens.</p>
<p>For on-device inference, we use low-bit palletization, a critical optimization technique that achieves the necessary memory, power, and performance requirements. To maintain model quality, we developed a new framework using LoRA adapters that incorporates a mixed 2-bit and 4-bit configuration strategy — averaging 3.5 bits-per-weight — to achieve the same accuracy as the uncompressed models.</p>
<p>Additionally, we use an interactive model latency and power analysis tool, <a href="https://machinelearning.apple.com/research/talaria">Talaria</a>, to better guide the bit rate selection for each operation. We also utilize activation quantization and embedding quantization, and have developed an approach to enable efficient Key-Value (KV) cache update on our neural engines.</p>
<p>With this set of optimizations, on iPhone 15 Pro we are able to reach time-to-first-token latency of about 0.6 millisecond per prompt token, and a generation rate of 30 tokens per second. Notably, this performance is attained before employing token speculation techniques, from which we see further enhancement on the token generation rate.</p>
<h2>Model Adaptation</h2>
<p>Our foundation models are fine-tuned for users’ everyday activities, and can dynamically specialize themselves on-the-fly for the task at hand. We utilize adapters, small neural network modules that can be plugged into various layers of the pre-trained model, to fine-tune our models for specific tasks. For our models we adapt the attention matrices, the attention projection matrix, and the fully connected layers in the point-wise feedforward networks for a suitable set of the decoding layers of the transformer architecture.</p>
<p>By fine-tuning only the adapter layers, the original parameters of the base pre-trained model remain unchanged, preserving the general knowledge of the model while tailoring the adapter layers to support specific tasks.</p>
<figure id="figure2" aria-labelledby="figure-figure2-caption" data-aos="fade-up"><figcaption id="figure-figure2-caption" aria-hidden="false">Figure 2: Adapters are small collections of model weights that are overlaid onto the common base foundation model. They can be dynamically loaded and swapped — giving the foundation model the ability to specialize itself on-the-fly for the task at hand. Apple Intelligence includes a broad set of adapters, each fine-tuned for a specific feature. It’s an efficient way to scale the capabilities of our foundation model.</figcaption></figure>
<p>We represent the values of the adapter parameters using 16 bits, and for the ~3 billion parameter on-device model, the parameters for a rank 16 adapter typically require 10s of megabytes. The adapter models can be dynamically loaded, temporarily cached in memory, and swapped — giving our foundation model the ability to specialize itself on the fly for the task at hand while efficiently managing memory and guaranteeing the operating system&#39;s responsiveness.</p>
<p>To facilitate the training of the adapters, we created an efficient infrastructure that allows us to rapidly retrain, test, and deploy adapters when either the base model or the training data gets updated. The adapter parameters are initialized using the accuracy-recovery adapter introduced in the Optimization section.</p>
<h2>Performance and Evaluation</h2>
<p>Our focus is on delivering generative models that can enable users to communicate, work, express themselves, and get things done across their Apple products. When benchmarking our models, we focus on human evaluation as we find that these results are highly correlated to user experience in our products. We conducted performance evaluations on both feature-specific adapters and the foundation models.</p>
<p>To illustrate our approach, we look at how we evaluated our adapter for summarization. As product requirements for summaries of emails and notifications differ in subtle but important ways, we fine-tune accuracy-recovery low-rank (LoRA) adapters on top of the palletized model to meet these specific requirements. Our training data is based on synthetic summaries generated from bigger server models, filtered by a rejection sampling strategy that keeps only the high quality summaries.</p>
<p>To evaluate the product-specific summarization, we use a set of 750 responses carefully sampled for each use case. These evaluation datasets emphasize a diverse set of inputs that our product features are likely to face in production, and include a stratified mixture of single and stacked documents of varying content types and lengths. As product features, it was important to evaluate performance against datasets that are representative of real use cases. We find that our models with adapters generate better summaries than a comparable model.</p>
<p>As part of responsible development, we identified and evaluated specific risks inherent to summarization. For example, summaries occasionally remove important nuance or other details in ways that are undesirable. However, we found that the summarization adapter did not amplify sensitive content in over 99% of targeted adversarial examples. We continue to adversarially probe to identify unknown harms and expand our evaluations to help guide further improvements.</p>
<figure id="figure3" aria-labelledby="figure-figure3-caption" data-aos="fade-up"><figcaption id="figure-figure3-caption" aria-hidden="false">Figure 3: Ratio of &#34;good&#34; and &#34;poor&#34; responses for two summarization use cases relative to all responses. Summaries are classified as &#34;good&#34;, &#34;neutral&#34;, &#34;poor&#34; given the grader&#39;s scores across five dimensions. A result is classified as &#34;good&#34; if all of the dimensions are good (higher is better). A result is classified as &#34;poor&#34; if any of the dimensions are poor (lower is better). Our models with adapters generate better summaries than a comparable model.</figcaption></figure>
<p>In addition to evaluating feature specific performance powered by foundation models and adapters, we evaluate both the on-device and server-based models’ general capabilities. We utilize a comprehensive evaluation set of real-world prompts to test the general model capabilities. These prompts are diverse across different difficulty levels and cover major categories such as brainstorming, classification, closed question answering, coding, extraction, mathematical reasoning, open question answering, rewriting, safety, summarization, and writing.</p>
<p>We compare our models with both open-source models (Phi-3, Gemma, Mistral, DBRX) and commercial models of comparable size (GPT-3.5-Turbo, GPT-4-Turbo)<sup><a href="#footnotes">1</a></sup>. We find that our models are preferred by human graders over most comparable competitor models. On this benchmark, our on-device model, with ~3B parameters, outperforms larger models including Phi-3-mini, Mistral-7B, and Gemma-7B. Our server model compares favorably to DBRX-Instruct, Mixtral-8x22B, and GPT-3.5-Turbo while being highly efficient.</p>
<figure id="figure4" aria-labelledby="figure-figure4-caption" data-aos="fade-up"><figcaption id="figure-figure4-caption" aria-hidden="false">Figure 4: Fraction of preferred responses in side-by-side evaluation of Apple&#39;s foundation model against comparable models. We find that our models are preferred by human graders.</figcaption></figure>
<p>We use a set of diverse adversarial prompts to test the model performance on harmful content, sensitive topics, and factuality. We measure the violation rates of each model as evaluated by human graders on this evaluation set, with a lower number being desirable. Both the on-device and server models are robust when faced with adversarial prompts, achieving violation rates lower than open-source and commercial models.</p>
<figure id="figure5" aria-labelledby="figure-figure5-caption" data-aos="fade-up"><figcaption id="figure-figure5-caption" aria-hidden="false">Figure 5: Fraction of violating responses for harmful content, sensitive topics, and factuality (lower is better). Our models are robust when faced with adversarial prompts.</figcaption></figure>
<p>Our models are preferred by human graders as safe and helpful over competitor models for these prompts. However, considering the broad capabilities of large language models, we understand the limitation of our safety benchmark. We are actively conducting both manual and automatic red-teaming with internal and external teams to continue evaluating our models&#39; safety.</p>
<figure id="figure6" aria-labelledby="figure-figure6-caption" data-aos="fade-up"><figcaption id="figure-figure6-caption" aria-hidden="false">Figure 6: Fraction of preferred responses in side-by-side evaluation of Apple&#39;s foundation model against comparable models on safety prompts. Human graders found our responses safer and more helpful.</figcaption></figure>
<p>To further evaluate our models, we use the Instruction-Following Eval (IFEval) benchmark to compare their instruction-following capabilities with models of comparable size. The results suggest that both our on-device and server model follow detailed instructions better than the open-source and commercial models of comparable size.</p>
<figure id="figure7" aria-labelledby="figure-figure7-caption" data-aos="fade-up"><figcaption id="figure-figure7-caption" aria-hidden="false">Figure 7: Instruction-following capability (measured with IFEval) for Apple&#39;s foundation models and models of comparable size (higher is better).</figcaption></figure>
<p>We evaluate our models’ writing ability on our internal summarization and composition benchmarks, consisting of a variety of writing instructions. These results do not refer to our feature-specific adapter for summarization (seen in <a href="#figure3">Figure 3</a>), nor do we have an adapter focused on composition.</p>
<figure id="figure8" aria-labelledby="figure-figure8-caption" data-aos="fade-up"><figcaption id="figure-figure8-caption" aria-hidden="false">Figure 8: Writing ability on internal summarization and composition benchmarks (higher is better).</figcaption></figure>
<h2>Conclusion</h2>
<p>The Apple foundation models and adapters introduced at WWDC24 underlie Apple Intelligence, the new personal intelligence system that is integrated deeply into iPhone, iPad, and Mac, and enables powerful capabilities across language, images, actions, and personal context. Our models have been created with the purpose of helping users do everyday activities across their Apple products, and developed responsibly at every stage and guided by Apple’s core values. We look forward to sharing more information soon on our broader family of generative models, including language, diffusion, and coding models.</p>

<p>[1]   We compared against the following model versions: gpt-3.5-turbo-0125, gpt-4-0125-preview, Phi-3-mini-4k-instruct, Mistral-7B-Instruct-v0.2, Mixtral-8x22B-Instruct-v0.1, Gemma-1.1-2B, and Gemma-1.1-7B. The open-source and Apple models are evaluated in bfloat16 precision.</p></div></section><section><div><div><div><div><p>A voice replicator is a powerful tool for people at risk of losing their ability to speak, including those with a recent diagnosis of amyotrophic lateral sclerosis (ALS) or other conditions that can progressively impact speaking ability. First introduced in May 2023 and made available on iOS 17 in September 2023, <a href="https://support.apple.com/en-us/104993">Personal Voice</a> is a tool that creates a synthesized voice for such users to speak in FaceTime, phone calls, assistive communication apps, and in-person conversations.</p><p><a href="https://machinelearning.apple.com/research/personal-voice" aria-label="See full highlight details regarding Advancing Speech Accessibility with Personal Voice">See highlight details</a></p></div></div><div><div><div><p>Earlier this year, Apple hosted the Natural Language Understanding workshop. This two-day hybrid event brought together Apple and members of the academic research community for talks and discussions on the state of the art in natural language understanding.</p>
<p>In this post, we share highlights from workshop discussions and recordings of select workshop talks.</p></div><p><a href="https://machinelearning.apple.com/updates/nlu-workshop-2023" aria-label="See full event details regarding Apple Natural Language Understanding Workshop 2023">See event details</a></p></div></div></div></div></section><section></section></div></div>
  </body>
</html>
