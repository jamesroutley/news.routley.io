<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.maxcountryman.com/articles/we-need-to-talk-about-vercel">Original</a>
    <h1>We Need To Talk About Vercel</h1>
    
    <div id="readability-page-1" class="page"><div><p>Recently there&#39;s been some discussion around Vercel and its hefty markup over AWS Lambda or its <a target="_blank" rel="noopener" href="https://twitter.com/shoeboxdnb/status/1643639119824801793">surprise runaway costs</a>.<sup><a id="user-content-fnref-billing-limits" href="https://www.maxcountryman.com/articles/we-need-to-talk-about-vercel#user-content-fn-billing-limits">1</a></sup> That said, there&#39;s an argument to be made that the development experience value add is worth the pretty penny. And indeed for some, that may be the case.</p>
<p>However, as I&#39;ve spent more time working with the Vercel Content Delivery Network (CDN) product, I&#39;ve encountered technical deficiencies which have been met with a customer support response that not only leaves me skeptical of the proffered value add, but has left me to question the product altogether.</p>
<h2 id="some-background">Some Background</h2>
<p>I&#39;ve been working on <a target="_blank" rel="noopener" href="https://remotejobs.org">remotejobs.org</a>, which is largely static but updates periodically throughout the day. I&#39;ll spare readers the technical details here but what&#39;s important is to understand that this is implemented via <a target="_blank" rel="noopener" href="https://astro.build">Astro&#39;s</a> Server-Side Rendering and is intended to be cached by the CDN.</p>
<p>To do so, we make use of the <code>s-maxage</code> and <code>stale-while-revalidate</code> directives of the <code>Cache-Control</code> header. The goal here is to have the surrogate, i.e. the CDN network appliance, cache the content for a set amount of time and then to lean on the <code>stale-while-revalidate</code> directive to serve cached content while fresh data is fetched in the background.</p>
<p>As of writing the <a target="_blank" rel="noopener" href="https://web.archive.org/web/20230308131936/https://vercel.com/docs/concepts/edge-network/caching#stale-while-revalidate">Vercel docs</a> give this description of <code>stale-while-revalidate</code>:</p>
<blockquote>
<p>This allows you to serve content from the Edge cache while simultaneously updating the cache in the background with the response from your Serverless Function.</p>
</blockquote>
<p>Offering some relevant use-cases and overlap with what we want:</p>
<blockquote>
<p>Some situations where <code>stale-while-revalidate</code> is of great value:</p>
<ul>
<li>Your content changes frequently but it takes a significant amount of time to regenerate. For example, an expensive database query or upstream API request.</li>
<li>Your content changes infrequently but you want to have the flexibility to update it (to fix a typo, for example) and don&#39;t wait for the cache to expire.</li>
</ul>
</blockquote>
<p>Fortunately Vercel makes configuring such a header easy via the <code>vercel.json</code> configuration:</p>
<pre><code><span><span>{</span>
</span><span>    <span>&#34;headers&#34;</span><span>:</span> <span>[</span>
</span><span>        <span>{</span>
</span><span>            <span>&#34;source&#34;</span><span>:</span> <span>&#34;/(.*)&#34;</span><span>,</span>
</span><span>            <span>&#34;headers&#34;</span><span>:</span> <span>[</span>
</span><span>                <span>{</span>
</span><span>                    <span>&#34;key&#34;</span><span>:</span> <span>&#34;Cache-Control&#34;</span><span>,</span>
</span><span>                    <span>&#34;value&#34;</span><span>:</span> <span>&#34;public, max-age=0, s-maxage=3600, stale-while-revalidate=3900&#34;</span>
</span><span>                <span>}</span>
</span><span>            <span>]</span>
</span><span>        <span>}</span>
</span><span>    <span>]</span>
</span><span><span>}</span>
</span></code></pre>
<p>Mission accomplished.</p>
<h2 id="not-so-easy-after-all">Not So Easy After All</h2>
<p>Only it doesn&#39;t work the way it&#39;s advertised.</p>
<p>Bizarrely, Vercel&#39;s network appliance mangles the <code>Cache-Control</code> header and indeed does not respect the configured values as it should.<sup><a id="user-content-fnref-trying-various-things" href="https://www.maxcountryman.com/articles/we-need-to-talk-about-vercel#user-content-fn-trying-various-things">2</a></sup> For some resources, things work as expected, but for e.g. our index page the <code>s-maxage</code> and <code>stale-while-revalidate</code> directives are both missing.</p>
<p>In fact, only resources like JavaScript and CSS see the correct header value with everything else being configured such that <code>Cache-Control</code> has a value of <code>public, max-age=0</code>. Not what we wanted or configured.</p>
<h2 id="looking-for-support">Looking for Support</h2>
<p>After messing around with this for some time, ensuring we were manually setting the headers on our origin, I had no luck and reached out to Vercel&#39;s support.</p>
<p>Over the course of a couple of weeks I was told by their support team:</p>
<ol>
<li>This is not a real issue, try these various configuration tweaks (none worked and they would later admit they could easily reproduce the issue independently).</li>
<li>This is a real issue, but it&#39;s Astro&#39;s fault (it wasn&#39;t, as the Astro team would trivially demonstrate) and I should do free work for Vercel to poll their community regarding how widespread the issue is.</li>
<li>Vercel&#39;s support staff is only trained to handle frontend issues, therefore I can&#39;t expect helpful responses (Vercel sells a CDN product, so this is surprising).<sup><a id="user-content-fnref-frontend-issues" href="https://www.maxcountryman.com/articles/we-need-to-talk-about-vercel#user-content-fn-frontend-issues">3</a></sup></li>
<li>The internal team is working on an RFC to make documentation changes (odd, but okay; the issue still remains).</li>
<li>I would receive an update within one week (now a month later, I have had no update whatsoever and the issue persists).</li>
</ol>
<p>I was also told that because I haven&#39;t graduated to a high-enough service tier, my issue wasn&#39;t important. I find this a strange response, because other customers, who might be paying lots of money to use Vercel&#39;s product, would benefit from the CDN operating as it&#39;s advertised.</p>
<p>On March 9th, 2023, Vercel&#39;s support team promised to follow up &#34;next week&#34;. They have not done so and the issue remains an issue.</p>
<blockquote>
<p>&#34;Please keep an eye out for a message from our team next week.&#34;</p>
</blockquote>
<h2 id="where-we-go-from-here">Where We Go from Here</h2>
<p>CDNs are hard. There&#39;s no doubt a lot going on in the background here that we can&#39;t see. For instance, later on in the support thread, Vercel&#39;s support said this:</p>
<blockquote>
<p>&#34;After catching up with our CDN team, it&#39;s worth sharing that we&#39;ll be reviewing docs on s-maxage/stale-while-revalidate/stale-while-error and how they are consumed by our proxy. Slight overshare but there&#39;s an active RFC internally to review this behaviour in its entirety.&#34;</p>
</blockquote>
<p>While this is a somewhat odd response, it demonstrates that Vercel is aware of these problems and that they can be difficult to tackle.<sup><a id="user-content-fnref-update-the-docs" href="https://www.maxcountryman.com/articles/we-need-to-talk-about-vercel#user-content-fn-update-the-docs">4</a></sup></p>
<p>However, for me the bigger issue is how Vercel&#39;s frontline support team responds and behaves. I was repeatedly told my issue wasn&#39;t real, a fairly blatant attempt to gaslight me, and then when it had been confirmed multiple times that I should just go away already.</p>
<p>Now I&#39;m clearly not worth enough for Vercel to care about. Fair enough. They&#39;re right that I won&#39;t independently bring them large bags of money in the form of recurring revenue. But being so blunt about that seems shortsighted at best: Should I ever be in the position to bring more business to Vercel, I now won&#39;t.</p>
<p>Contrast this approach with Cloudflare or AWS: Even as a free or essentially free customer, both platforms invest in their customers because it&#39;s part of a larger customer acquisition strategy.</p>
<p>Good support is not just a resource to fallback to.</p>
<p>Take AWS as an example, which has for years invested heavily in customer success. AWS offers a wide array of resources, including dedicated support teams, structured programs, and ongoing training. Without such things in place, AWS wouldn&#39;t just be more difficult to use, but would also likely have a far less commanding hold of the cloud market. While Vercel may not be at AWS scale, even in the beginning Amazon has had a reputation for being &#34;customer obsessed&#34;.</p>
<p>Given where Vercel is today, I&#39;ll be moving on. Most of <a target="_blank" rel="noopener" href="https://remotejobs.org">remotejobs.org</a> is already hosted on a VPS and so in my case I&#39;ll move the web pieces there with a CDN like Cloudflare in front of it.</p>
</div></div>
  </body>
</html>
