<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.synack.com/blog/this-microsoft-windows-rce-vulnerability-gives-an-attacker-complete-control/">Original</a>
    <h1>Microsoft Windows RCE Vulnerability Gives an Attacker Complete Control</h1>
    
    <div id="readability-page-1" class="page"><div role="main" id="main">


<div>
    <article id="post-9700">

        <!-- .entry-header -->

        <div>
			<p><span>By Malcolm Stagg</span></p>
<p><i><span>CVE-2021-34535 is a Remote Code Execution (RCE) vulnerability in Remote Desktop Client, found by SRT member Malcolm Stagg earlier this year, and patched by Microsoft in August 2021.</span></i></p>
<h2><strong>Finding the Vulnerability</strong></h2>
<p><span>I found this vulnerability by looking at the disassembly of several Windows dll’s in IDA debugger for potential memory access flaws. Protocol parsing code, especially code involving multimedia decoding, tends to be a common place for flaws since the protocol decoding is often complex. When raw pointers to memory buffers are used directly, it is easy to make a mistake that can lead to a serious memory access vulnerability.</span></p>
<p><span>Looking at occurrences of </span><b>memcpy</b><span>, the C function that copies data between two memory buffers, I found one occurrence in the TSMF media decoder that showed signs of having a complex access pattern. TSMF is a legacy plug-in for Remote Desktop, in which the Remote Desktop Server transfers a multimedia file to be played by the Remote Desktop Client. </span></p>
<p><span>First, the decoder allocates a heap buffer with the size </span><b>cbData+63 </b><span>bytes, where </span><b>cbData</b><span> is a field from a packet that attackers can control. Next, </span><b>cbData+36</b><span> bytes of data are copied from the packet into the buffer. The remaining 27 bytes are intended to be filled with data from a separate buffer.</span></p>
<p><span>This access pattern looks innocent enough until you look at cases involving an integer overflow. </span><b>cbData</b><span> is a 32-bit unsigned integer, so it can represent any number between 0 and approximately 4 billion. By specifying a buffer size just slightly below that upper limit, an integer overflow will occur, causing a very small buffer to be allocated, and a huge amount of attacker-controlled data copied into that buffer. The result is a heap buffer overflow, where structures throughout the program’s memory space are overwritten with attacker-controlled data.</span></p>
<p><img alt="" width="1302" height="273" data-srcset="https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image1.png 1302w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image1-300x63.png 300w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image1-1024x215.png 1024w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image1-768x161.png 768w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image1-480x101.png 480w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image1-420x88.png 420w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image1-200x42.png 200w" data-src="https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image1.png" data-sizes="(max-width: 1302px) 100vw, 1302px" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/><img alt="" width="1115" height="554" data-srcset="https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image2.png 1115w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image2-300x149.png 300w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image2-1024x509.png 1024w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image2-768x382.png 768w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image2-480x238.png 480w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image2-420x209.png 420w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image2-200x99.png 200w" data-src="https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image2.png" data-sizes="(max-width: 1115px) 100vw, 1115px" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></p>
<h2><strong>Exploiting the Vulnerability</strong></h2>
<p><span>There are two main scenarios for how an attacker could exploit this vulnerability. One of these is by gaining control of a Remote Desktop Server. An attacker could take control of a victim’s machine when it connects to the malicious Remote Desktop Server, exploiting this vulnerability to run code that escapes from the Remote Desktop Client onto the victim’s machine.</span></p>
<p><span>The other scenario, which is perhaps even more interesting, is a Hyper-V Client escape. Unless “Enhanced Session Mode” is explicitly disabled by the user, Hyper-V uses Remote Desktop Client dll’s while accessing a virtual machine. By doing so, features like clipboard sharing and printing are enabled, improving the user experience. If a virtual machine is running malicious software, an attacker could exploit this vulnerability to escape from the Hyper-V Client and gain control over the host machine. Since users often run untrusted software inside a virtual machine to provide better security and isolation, this is an interesting case that could have a serious impact.</span></p>
<h2><strong>Proof of Concept</strong></h2>
<p><span>The vulnerability was fairly difficult to exploit for two reasons: one is that it will always result in a client crash. Approximately 4 GiB of data is copied into an extremely small buffer, so a memory access violation is inevitable. The attacker’s payload must be successfully executed before the client crash occurs.</span></p>
<p><span>The other difficulty in exploitation is due to Address Space Layout Randomization (ASLR), a security feature designed to make memory access vulnerabilities more difficult to exploit by providing randomization of memory addresses. Since this vulnerability in itself provides no way of bypassing ASLR, for the purposes of demonstration, it is assumed that the attacker has some other way of bypassing it. A common method would be finding an information disclosure vulnerability where a program’s internal memory pointers are exposed to the attacker.</span></p>
<p><span>Ultimately, a proof of concept was developed by finding a target function where Hyper-V Client jumps to a memory address stored within the attack payload. To obtain remote code execution, a couple of “gadget” functions were also found. Gadgets are existing functions within the program which have been repurposed by the attacker to perform a task.</span></p>
<p><span>The first gadget causes a memory pointer to jump from its initial, random, location within the attack payload to a specific location known to the attacker. This known location specifies a second gadget function and a program name. The second gadget function causes the program name to be read from the attack payload and executed.</span></p>
<p><img alt="" width="1350" height="517" data-srcset="https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image3.png 1350w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image3-300x115.png 300w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image3-1024x392.png 1024w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image3-768x294.png 768w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image3-480x184.png 480w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image3-420x161.png 420w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image3-200x77.png 200w" data-src="https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image3.png" data-sizes="(max-width: 1350px) 100vw, 1350px" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></p>
<p><span>The proof of concept is demonstrated in the following video, showing how executing a program within a virtual machine can result in a Calculator executing on the host machine.</span></p>


<h2><strong>Preventing These Vulnerabilities</strong></h2>
<p><span>This specific vulnerability could have been prevented by the developers performing several additional validation checks:</span></p>
<ol>
<li aria-level="1"><span>Validate all user-controlled data and buffer sizes</span></li>
<li aria-level="1"><span>Check for integer overflow edge cases</span></li>
<li aria-level="1"><span>Verify a buffer’s length before copying any data</span></li>
</ol>
<p><span>Memory access vulnerabilities are most common when using raw pointers directly, so those should be avoided whenever it’s feasible to do so.</span></p>
<h2><strong>Protecting Yourself</strong></h2>
<p><span>If you’re accessing an untrusted virtual machine in Hyper-V or running an untrusted program on your virtual machine, disable “Enhanced Session Mode” whenever you can to reduce your attack surface. </span></p>
<p><img alt="" width="620" height="107" data-srcset="https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image4.png 620w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image4-300x52.png 300w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image4-480x83.png 480w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image4-420x72.png 420w, https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image4-200x35.png 200w" data-src="https://cdnm.synack.com/wp-content/uploads/2021/11/malcolm-stagg-blog-image4.png" data-sizes="(max-width: 620px) 100vw, 620px" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></p>
<p><span>Always be cautious when accessing a Remote Desktop Server you don’t explicitly trust. It is best to only access machines with which you are familiar.</span></p>
<p><span>Finally, by keeping your computer up-to-date and installing the latest Windows Update patches, your computer will be protected from many new vulnerabilities, including this one!</span></p>


        </div><!-- .entry-content -->

    </article><!-- #post-9700 -->
</div>


</div></div>
  </body>
</html>
