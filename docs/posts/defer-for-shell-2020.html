<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://cedwards.xyz/defer-for-shell/">Original</a>
    <h1>Defer for Shell (2020)</h1>
    
    <div id="readability-page-1" class="page"><div>
            

            <div>
                <div>
                    <p>Defer for Shell</p>
                    <p>March 8, 2020</p>
                </div>
                <p>One of my favourite features of Go is the <code>defer</code> keyword. It allows for a clean way to cleanup resources upon returning from a function, whilst the statement itself is immediately after or in close proximity to the resource acquisition. This makes the cleanup more visible and can reduce the likelihood of bugs if your function contains many branches.</p>
<p>I think the <code>defer</code> keyword is so useful that it should be a component of every language. I think C in particular could benefit greatly - freeing locally allocated memory would become trivial.</p>
<p>I decided to implement a pseudo-<code>defer</code> keyword for shell (<code>/bin/sh</code>) which simplified some of my scripts. With this, I can be sure that mounts and files are always cleaned up properly, even if the script exits early. This is known as <em>idempotency</em>.</p>
<div><pre tabindex="0"><code data-lang="sh"><span><span><span>#!/bin/sh
</span></span></span><span><span><span></span>DEFER<span>=</span>
</span></span><span><span>defer<span>()</span> <span>{</span>
</span></span><span><span>    DEFER<span>=</span><span>&#34;</span>$*<span>; </span><span>${</span>DEFER<span>}</span><span>&#34;</span>
</span></span><span><span>    trap <span>&#34;{ </span>$DEFER<span> }&#34;</span> EXIT
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Hereâ€™s an example of how you can use this function:</p>
<div><pre tabindex="0"><code data-lang="sh"><span><span><span># Mount /tmp as tmpfs and umount it on script exit.</span>
</span></span><span><span>mount -t tmpfs tmpfs /tmp
</span></span><span><span>defer umount -f /tmp
</span></span><span><span>
</span></span><span><span><span># Create a temporary file and delete it on script exit.</span>
</span></span><span><span>TEMP<span>=</span><span>$(</span>mktemp<span>)</span>
</span></span><span><span>echo <span>&#34;Hello!&#34;</span> &gt; <span>&#34;</span>$TEMP<span>&#34;</span>
</span></span><span><span>defer rm -f <span>&#34;</span>$TEMP<span>&#34;</span>
</span></span></code></pre></div><p>This might require some tweaking for your particular use-case. <a href="https://gist.github.com/cedws/ab8da14beb3aad4521ba6b612956a83e">If you have any suggestions or comments, please leave them here!</a></p>

            </div>
            

        </div></div>
  </body>
</html>
