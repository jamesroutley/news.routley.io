<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://bytes.zone/posts/sourcing-secrets-from-opw/">Original</a>
    <h1>sourcing secrets from 1Password</h1>
    
    <div id="readability-page-1" class="page"><article><p><em>Brian Hicks, February 27, 2024</em></p><p>I&#39;ve been <a href="https://bytes.zone/projects/thing-a-month-meta/">setting up a personal Kubernetes cluster</a> recently. The whole thing is set up with <a href="https://argoproj.github.io/">Argo CD</a>, which basically means that I make changes to the cluster by committing to a git repo and pushing. Really handy, especially when I make a mistake and need to clean something up or revert.</p><p>One problem with this, though, is that it&#39;s probably not a great idea to commit secrets to the repository. I don&#39;t want things like passwords and API keys sitting there in clear text on my laptop or on the remote.</p><p>If I were setting up a cluster that other people were going to operate, I&#39;d probably set up something like <a href="https://www.vaultproject.io/">Vault</a>, but since it&#39;s just me I can get away with creating the secrets by hand. That said, I still don&#39;t want to leave them on disk unencrypted!</p><p>Enter the <code>opw</code> CLI for <a href="https://1password.com/">1Password</a>. <span id="continue-reading"></span> It can output secret data as JSON, and I can use <a href="https://jqlang.github.io/jq/"><code>jq</code></a> to transform that into Kubernetes secret objects, which I can pipe into <code>kubectl</code> to apply in the cluster.</p><p>Let&#39;s take a simple example: an image pull secret. I have the secret stored in 1Password under a specific vault. If I run <code>op item get --vault k8s &#34;image pull secret&#34;</code>, I&#39;ll get something like the following:</p><pre data-lang="yaml"><code data-lang="yaml"><span>ID</span><span>:          </span><span>y63hsk7qy5osug5n2qupwhtz3e
</span><span>Title</span><span>:       </span><span>image pull secret
</span><span>Vault</span><span>:       </span><span>k8s (2qaqjigknr3htch273i2mho5vi)
</span><span>Created</span><span>:     </span><span>2 weeks ago
</span><span>Updated</span><span>:     </span><span>2 weeks ago by Brian Hicks
</span><span>Favorite</span><span>:    </span><span>false
</span><span>Version</span><span>:     </span><span>1
</span><span>Category</span><span>:    </span><span>LOGIN
</span><span>Fields</span><span>:
</span><span>  </span><span>password</span><span>:    </span><span>password-goes-here
</span><span>  </span><span>username</span><span>:    </span><span>username-goes-here
</span></code></pre><p>I can also ask for it in JSON format by adding <code>--format json</code> to the end:</p><pre data-lang="json"><code data-lang="json"><span>{
</span><span>  </span><span>&#34;id&#34;</span><span>: </span><span>&#34;y63hsk7qy5osug5n2qupwhtz3e&#34;</span><span>,
</span><span>  </span><span>&#34;title&#34;</span><span>: </span><span>&#34;image pull secreet&#34;</span><span>,
</span><span>  </span><span>&#34;version&#34;</span><span>: </span><span>1</span><span>,
</span><span>  </span><span>&#34;vault&#34;</span><span>: {
</span><span>    </span><span>&#34;id&#34;</span><span>: </span><span>&#34;2qaqjigknr3htch273i2mho5vi&#34;</span><span>,
</span><span>    </span><span>&#34;name&#34;</span><span>: </span><span>&#34;k8s&#34;
</span><span>  },
</span><span>  </span><span>&#34;category&#34;</span><span>: </span><span>&#34;LOGIN&#34;</span><span>,
</span><span>  </span><span>&#34;last_edited_by&#34;</span><span>: </span><span>&#34;B76OR7I6DNENPAQOQFFO6FKQOM&#34;</span><span>,
</span><span>  </span><span>&#34;created_at&#34;</span><span>: </span><span>&#34;2024-02-12T18:37:38Z&#34;</span><span>,
</span><span>  </span><span>&#34;updated_at&#34;</span><span>: </span><span>&#34;2024-02-12T18:37:38Z&#34;</span><span>,
</span><span>  </span><span>&#34;additional_information&#34;</span><span>: </span><span>&#34;<a href="https://bytes.zone/cdn-cgi/l/email-protection" data-cfemail="1b7969727a755b7969727a756f737278706835787476">[emailÂ protected]</a>&#34;</span><span>,
</span><span>  </span><span>&#34;fields&#34;</span><span>: [
</span><span>    {
</span><span>      </span><span>&#34;id&#34;</span><span>: </span><span>&#34;password&#34;</span><span>,
</span><span>      </span><span>&#34;type&#34;</span><span>: </span><span>&#34;CONCEALED&#34;</span><span>,
</span><span>      </span><span>&#34;purpose&#34;</span><span>: </span><span>&#34;PASSWORD&#34;</span><span>,
</span><span>      </span><span>&#34;label&#34;</span><span>: </span><span>&#34;password&#34;</span><span>,
</span><span>      </span><span>&#34;value&#34;</span><span>: </span><span>&#34;password-goes-here&#34;</span><span>,
</span><span>      </span><span>&#34;reference&#34;</span><span>: </span><span>&#34;op://k8s/image pull secret/password&#34;</span><span>,
</span><span>      </span><span>&#34;password_details&#34;</span><span>: {
</span><span>        </span><span>&#34;strength&#34;</span><span>: </span><span>&#34;FANTASTIC&#34;
</span><span>      }
</span><span>    },
</span><span>    {
</span><span>      </span><span>&#34;id&#34;</span><span>: </span><span>&#34;username&#34;</span><span>,
</span><span>      </span><span>&#34;type&#34;</span><span>: </span><span>&#34;STRING&#34;</span><span>,
</span><span>      </span><span>&#34;purpose&#34;</span><span>: </span><span>&#34;USERNAME&#34;</span><span>,
</span><span>      </span><span>&#34;label&#34;</span><span>: </span><span>&#34;username&#34;</span><span>,
</span><span>      </span><span>&#34;value&#34;</span><span>: </span><span>&#34;username-goes-here&#34;</span><span>,
</span><span>      </span><span>&#34;reference&#34;</span><span>: </span><span>&#34;op://k8s/image pull secret/username&#34;
</span><span>    },
</span><span>    {
</span><span>      </span><span>&#34;id&#34;</span><span>: </span><span>&#34;notesPlain&#34;</span><span>,
</span><span>      </span><span>&#34;type&#34;</span><span>: </span><span>&#34;STRING&#34;</span><span>,
</span><span>      </span><span>&#34;purpose&#34;</span><span>: </span><span>&#34;NOTES&#34;</span><span>,
</span><span>      </span><span>&#34;label&#34;</span><span>: </span><span>&#34;notesPlain&#34;</span><span>,
</span><span>      </span><span>&#34;reference&#34;</span><span>: </span><span>&#34;op://k8s/image pull secret/notesPlain&#34;
</span><span>    }
</span><span>  ]
</span><span>}
</span></code></pre><p>We can then pipe that into the following jq program to get an object indexed by the field names:</p><pre data-lang="jq"><code data-lang="jq"><span>.fields | </span><span>map</span><span>({ key: .label, value: .value }) | </span><span>from_entries
</span></code></pre><p>That produces this:</p><pre data-lang="json"><code data-lang="json"><span>{
</span><span>  </span><span>&#34;password&#34;</span><span>: </span><span>&#34;password-goes-here&#34;</span><span>,
</span><span>  </span><span>&#34;username&#34;</span><span>: </span><span>&#34;username-goes-here&#34;</span><span>,
</span><span>  </span><span>&#34;notesPlain&#34;</span><span>: </span><span>null
</span><span>}
</span></code></pre><p>And we can add onto that jq program to produce some JSON in the shape of a Kubernetes secret:</p><pre data-lang="jq"><code data-lang="jq"><span>.fields | </span><span>map</span><span>({ key: .label, value: .value }) | </span><span>from_entries</span><span> | {
</span><span>    apiVersion: </span><span>&#34;v1&#34;</span><span>,
</span><span>    kind: </span><span>&#34;Secret&#34;</span><span>,
</span><span>    type: </span><span>&#34;kubernetes.io/dockerconfigjson&#34;</span><span>,
</span><span>    metadata: {
</span><span>        name: </span><span>&#34;ghcr-image-pull-secret&#34;</span><span>,
</span><span>    },
</span><span>    data: {
</span><span>        </span><span>&#34;.dockerconfigjson&#34;</span><span>: {
</span><span>            auths: {
</span><span>                </span><span>&#34;image-host.io&#34;</span><span>: {
</span><span>                    auth: </span><span>&#34;</span><span>\(</span><span>.username</span><span>)</span><span>:</span><span>\(</span><span>.password</span><span>)</span><span>&#34;</span><span> | </span><span>@base64
</span><span>                }
</span><span>            }
</span><span>        } | </span><span>@base64
</span><span>    }
</span><span>}
</span></code></pre><p>Assuming that&#39;s in <code>image-pull-secret.jq</code>, we can now load the secret into Kubernetes like so:</p><pre data-lang="sh"><code data-lang="sh"><span>op</span><span> item get</span><span> --vault</span><span> k8s </span><span>&#34;image pull secret&#34;</span><span> --format</span><span> json </span><span>| </span><span>\
</span><span>    </span><span>jq -f</span><span> image-pull-secret.jq </span><span>| </span><span>\
</span><span>    </span><span>kubectl</span><span> apply</span><span> -n</span><span> whatever-namespace</span><span> -f</span><span> -
</span></code></pre><p>Like everything, this has some tradeoffs: the secrets are stored securely and never hit the disk, which is <em>great</em>! But in exchange, I have to run a command manually if I want to update the secrets. This means that if I&#39;m creating a new app, it&#39;ll probably fail at least once. Same if I have to move my cluster (<a href="https://bytes.zone/micro/thing-a-month-02-05/">which I already did once</a>) and have to apply all the manifests from scratch.</p><p>So in the end, would I recommend this? Yes, if you&#39;re in my situation! But if you&#39;re running a cluster where other people have to operate it too, this is probably not the best approach. It&#39;s good to know it&#39;s possible, though!</p></article></div>
  </body>
</html>
