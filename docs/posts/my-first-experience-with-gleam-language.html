<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://pliutau.com/my-first-experience-with-gleam-lang/">Original</a>
    <h1>My first experience with Gleam Language</h1>
    
    <div id="readability-page-1" class="page"><div>
        
        <div>
            
            
            <p><em></em>
                <span>
                    Tue, Aug 27, 2024 </span>
                <em></em>
                <span>5-minute read</span>
            </p>
            
        </div>

        <p><img src="https://pliutau.com/gleam.png" alt="gleam-lang"/></p>
<p>Over the past few months, I saw a growing amount of posts on X about the Gleam language (probably the X algorithm doing its thing), and decided to give it a try. I was not disappointed, with few exceptions.</p>
<p><strong>Disclaimer 1:</strong> This post shares my personal experience with the language, and it is not a comprehensive review of the language. It’s not sponsored by anyone, and I’m not affiliated with the Gleam team.</p>
<p><strong>Disclaimer 2:</strong> I had little prior experience with Erlang VM or functional programming in general.</p>
<h2 id="getting-started">Getting Started</h2>
<p>The first thing I did was to go through the official <a href="https://tour.gleam.run/">Gleam Language Tour</a> which was a pleasure. After an hour I familiarized myself with the syntax and the basic concepts of the language. I remember that’s how I started with Go as well, and I believe that every language must have an interactive tour like this.</p>
<div><pre><code data-lang="rust"><span>import</span><span> </span><span>gleam</span><span>/</span><span>io</span><span>
</span><span>
</span><span></span><span>pub</span><span> </span><span>fn</span> <span>main</span><span>()</span><span> </span><span>{</span><span>
</span><span>  </span><span>io</span><span>.</span><span>println</span><span>(</span><span>&#34;Hello, Joe!&#34;</span><span>)</span><span>
</span><span></span><span>}</span><span>
</span></code></pre></div><p>The next thing I did was to install the language on my machine. I was surprised by how easy it was to install the language and the tooling on macos.</p>
<div><pre><code data-lang="bash">brew install gleam
brew install erlang
</code></pre></div><p>You may also need rebar3, though I didn’t need it for my project.</p>
<p>So far so good!</p>
<h2 id="guinea-pig-project">Guinea Pig Project</h2>
<p>I prefer learning by doing, therefore I decided to build a small project with Gleam. I wanted to build a simple daemon application that monitors multiple websites concurrently from Yaml configuration and stores the results in a SQLite database.</p>
<p>The configuration looks similar to this:</p>
<div><pre><code data-lang="yaml"><span>websites</span><span>:</span><span>
</span><span>  </span>- <span>url</span><span>:</span><span> </span><span>https://packagemain.tech</span><span>
</span><span>    </span><span>interval</span><span>:</span><span> </span><span>10</span><span>
</span><span>  </span>- <span>url</span><span>:</span><span> </span><span>https://pliutau.com</span><span>
</span><span>    </span><span>interval</span><span>:</span><span> </span><span>15</span><span>
</span><span>  </span>- <span>url</span><span>:</span><span> </span><span>https://news.ycombinator.com</span><span>
</span><span>    </span><span>interval</span><span>:</span><span> </span><span>30</span><span>
</span><span>    </span><span>pattern</span><span>:</span><span> </span><span>gleam</span><span>
</span></code></pre></div><p>I chose this project as I could learn about the following aspects:</p>
<ul>
<li>Concurrency</li>
<li>HTTP calls</li>
<li>Gleam packages</li>
<li>Data types</li>
<li>Error handling</li>
<li>Yaml parsing</li>
<li>Testing</li>
</ul>
<p>Creating a new project:</p>
<div><pre><code data-lang="bash">gleam new websites_checker
</code></pre></div><p>This command creates a folder with a predefined structure. The boilerplate code is minimal, and I was able to start coding right away. Basically I focused on <code>src/websites_checker.gleam</code> and <code>test/websites_checker_test.gleam</code> files.</p>
<h2 id="dependencies-and-imports">Dependencies and Imports</h2>
<p>This part is nice as well, easy to install dependencies and import them in the code. My project needed the following dependencies:</p>
<div><pre><code data-lang="bash">gleam add gleam_http
gleam add gleam_erlang
gleam add sqlight
gleam add glaml
gleam add simplifile
gleam add gleam_hackney
gleam add birl
</code></pre></div><p>Now, I wished I could use fewer external dependencies, but I couldn’t find how to do some things using stdlib only. For example reading file, parsing Yaml, working with time.</p>
<p>Dependencies are locked in <code>gleam.toml</code> and can be downloaded later in your CI/CD by running:</p>
<p>You can find a lot of dependencies in <a href="https://github.com/gleam-lang/awesome-gleam">awesome-gleam</a> repository, but many of them are very new and I would not consider them production-ready.</p>
<h2 id="parsing-yaml">Parsing Yaml</h2>
<p>Here is where I struggled the most. Maybe because I’m so used to Go’s way of parsing Yaml or JSON into a pre-defined struct. The code for parsing my configuration into a custom type is not that pretty and very verbose for multiple reasons:</p>
<ul>
<li><a href="https://tour.gleam.run/flow-control/case-expressions/">case expressions</a> are making the code verbose and highly indented, however they provide a nice way to handle errors. And I like when errors are treated as values.</li>
<li>Probably there needs to be a better package to parse Yaml in Gleam, but I couldn’t find one and used <a href="https://github.com/katekyy/glaml">glaml</a> which I wouldn’t call production-friendly (has 2 start on Github only?).</li>
<li>There is no mutation in Gleam, so we have to use higher-level functions like <code>list.map</code> a lot.</li>
</ul>
<div><pre><code data-lang="rust"><span>import</span><span> </span><span>glaml</span><span>
</span><span></span><span>import</span><span> </span><span>gleam</span><span>/</span><span>result</span><span>
</span><span></span><span>import</span><span> </span><span>simplifile</span><span>
</span><span>
</span><span></span><span>pub</span><span> </span><span>type</span> <span>Config</span><span> </span><span>{</span><span>
</span><span>  </span><span>Config</span><span>(</span><span>websites</span>: <span>List</span><span>(</span><span>Website</span><span>))</span><span>
</span><span></span><span>}</span><span>
</span><span>
</span><span></span><span>pub</span><span> </span><span>type</span> <span>Website</span><span> </span><span>{</span><span>
</span><span>  </span><span>Website</span><span>(</span><span>url</span>: <span>String</span><span>,</span><span> </span><span>interval</span>: <span>Int</span><span>,</span><span> </span><span>pattern</span>: <span>String</span><span>)</span><span>
</span><span></span><span>}</span><span>
</span><span>
</span><span></span><span>pub</span><span> </span><span>type</span> <span>ConfigError</span><span> </span><span>{</span><span>
</span><span>  </span><span>ConfigError</span><span>(</span><span>message</span>: <span>String</span><span>)</span><span>
</span><span></span><span>}</span><span>
</span><span>
</span><span></span><span>pub</span><span> </span><span>fn</span> <span>load</span><span>(</span><span>filename</span>: <span>String</span><span>)</span><span> </span>-&gt; <span>Result</span><span>(</span><span>Config</span><span>,</span><span> </span><span>ConfigError</span><span>)</span><span> </span><span>{</span><span>
</span><span>  </span><span>use</span><span> </span><span>file_data</span><span> </span><span>&lt;-</span><span> </span><span>result</span><span>.</span><span>try</span><span>(</span><span>open_config_file</span><span>(</span><span>filename</span><span>))</span><span>
</span><span>  </span><span>use</span><span> </span><span>websites</span><span> </span><span>&lt;-</span><span> </span><span>result</span><span>.</span><span>try</span><span>(</span><span>parse_config_file</span><span>(</span><span>file_data</span><span>))</span><span>
</span><span>
</span><span>  </span><span>Ok</span><span>(</span><span>Config</span><span>(</span><span>websites</span><span>))</span><span>
</span><span></span><span>}</span><span>
</span><span>
</span><span></span><span>fn</span> <span>open_config_file</span><span>(</span><span>filename</span>: <span>String</span><span>)</span><span> </span>-&gt; <span>Result</span><span>(</span><span>String</span><span>,</span><span> </span><span>ConfigError</span><span>)</span><span> </span><span>{</span><span>
</span><span>  </span><span>case</span><span> </span><span>simplifile</span><span>.</span><span>read</span><span>(</span><span>filename</span><span>)</span><span> </span><span>{</span><span>
</span><span>    </span><span>Ok</span><span>(</span><span>data</span><span>)</span><span> </span>-&gt; <span>Ok</span><span>(</span><span>data</span><span>)</span><span>
</span><span>    </span><span>Error</span><span>(</span><span>_</span><span>)</span><span> </span>-&gt; <span>Error</span><span>(</span><span>ConfigError</span><span>(</span><span>message</span>: <span>&#34;Failed to read config file&#34;</span><span>))</span><span>
</span><span>  </span><span>}</span><span>
</span><span></span><span>}</span><span>
</span><span>
</span><span></span><span>// ...
</span></code></pre></div><p>You can see the full <a href="https://github.com/plutov/websites_checker/blob/main/src/config.gleam">config.gleam file here</a>, please reach out to me if you know how to make it shorter.</p>
<h2 id="sqlite">SQLite</h2>
<p>Working with SQLite was a breeze. I used <a href="https://github.com/lpil/sqlight">sqlight</a> package and it does the job well. Maybe <code>exec()</code> function needs to accept parameters, because I had to use <code>query()</code> for that and had to initialize a decoder which I don’t actually need as I don’t return any data from the database, just insert it.</p>
<div><pre><code data-lang="rust"><span>import</span><span> </span><span>crawler</span><span>
</span><span></span><span>import</span><span> </span><span>gleam</span><span>/</span><span>bool</span><span>
</span><span></span><span>import</span><span> </span><span>gleam</span><span>/</span><span>dynamic</span><span>
</span><span></span><span>import</span><span> </span><span>sqlight</span><span>
</span><span>
</span><span></span><span>pub</span><span> </span><span>fn</span> <span>save_result</span><span>(</span><span>
</span><span>  </span><span>db</span>: <span>sqlight</span><span>.</span><span>Connection</span><span>,</span><span>
</span><span>  </span><span>result</span>: <span>crawler</span><span>.</span><span>CrawlResult</span><span>,</span><span>
</span><span></span><span>)</span><span> </span>-&gt; <span>Result</span><span>(</span><span>Nil</span><span>,</span><span> </span><span>sqlight</span><span>.</span><span>Error</span><span>)</span><span> </span><span>{</span><span>
</span><span>  </span><span>// actually not needed, as we don&#39;t read the result back
</span><span></span><span>  </span><span>let</span><span> </span><span>mock_decoder</span><span> </span><span>=</span><span> </span><span>dynamic</span><span>.</span><span>tuple2</span><span>(</span><span>dynamic</span><span>.</span><span>int</span><span>,</span><span> </span><span>dynamic</span><span>.</span><span>int</span><span>)</span><span>
</span><span>
</span><span>  </span><span>case</span><span>
</span><span>    </span><span>sqlight</span><span>.</span><span>query</span><span>(</span><span>
</span><span>      </span><span>&#34;insert into websites (started_at, completed_at, status, pattern_matched, url) values (?, ?, ?, ?, ?)&#34;</span><span>,</span><span>
</span><span>      </span><span>on</span>: <span>db</span><span>,</span><span>
</span><span>      </span><span>with</span>: <span>[</span><span>
</span><span>        </span><span>sqlight</span><span>.</span><span>int</span><span>(</span><span>result</span><span>.</span><span>started_at</span><span>),</span><span>
</span><span>        </span><span>sqlight</span><span>.</span><span>int</span><span>(</span><span>result</span><span>.</span><span>completed_at</span><span>),</span><span>
</span><span>        </span><span>sqlight</span><span>.</span><span>int</span><span>(</span><span>result</span><span>.</span><span>status_code</span><span>),</span><span>
</span><span>        </span><span>sqlight</span><span>.</span><span>int</span><span>(</span><span>result</span><span>.</span><span>pattern_matched</span><span> </span><span>|&gt;</span><span> </span><span>bool</span><span>.</span><span>to_int</span><span>),</span><span>
</span><span>        </span><span>sqlight</span><span>.</span><span>text</span><span>(</span><span>result</span><span>.</span><span>url</span><span>),</span><span>
</span><span>      </span><span>],</span><span>
</span><span>      </span><span>expecting</span>: <span>mock_decoder</span><span>,</span><span>
</span><span>    </span><span>)</span><span>
</span><span>  </span><span>{</span><span>
</span><span>    </span><span>Ok</span><span>(</span><span>_</span><span>)</span><span> </span>-&gt; <span>Ok</span><span>(</span><span>Nil</span><span>)</span><span>
</span><span>    </span><span>Error</span><span>(</span><span>e</span><span>)</span><span> </span>-&gt; <span>Error</span><span>(</span><span>e</span><span>)</span><span>
</span><span>  </span><span>}</span><span>
</span><span></span><span>}</span><span>
</span></code></pre></div><h2 id="concurrency-and-glueing-everything-together">Concurrency and Glueing Everything Together</h2>
<p>At this point I wrote a config parser, database layer and HTTP crawler. It was time to glue everything together and run the main loop. I wanted to create a concurrent process for each website and crawl them with a specified interval.</p>
<p>The concurrency is great in Gleam, I guess it inherited it from Erlang. I used <code>gleam/erlang</code> package to create a linked process.</p>
<div><pre><code data-lang="rust"><span>// Start process for each website
</span><span></span><span>list</span><span>.</span><span>each</span><span>(</span><span>c</span><span>.</span><span>websites</span><span>,</span><span> </span><span>fn</span><span>(</span><span>w</span><span>)</span><span> </span><span>{</span><span>
</span><span>  </span><span>process</span><span>.</span><span>start</span><span>(</span><span>fn</span><span>()</span><span> </span><span>{</span><span> </span><span>process_website_recursively</span><span>(</span><span>db_conn</span><span>,</span><span> </span><span>w</span><span>)</span><span> </span><span>},</span><span> </span><span>True</span><span>)</span><span>
</span><span></span><span>})</span><span>
</span><span>
</span><span></span><span>fn</span> <span>process_website_recursively</span><span>(</span><span>
</span><span>  </span><span>db_conn</span>: <span>sqlight</span><span>.</span><span>Connection</span><span>,</span><span>
</span><span>  </span><span>website</span>: <span>config</span><span>.</span><span>Website</span><span>,</span><span>
</span><span></span><span>)</span><span> </span><span>{</span><span>
</span><span>  </span><span>let</span><span> </span><span>result</span><span> </span><span>=</span><span> </span><span>crawler</span><span>.</span><span>crawl_url</span><span>(</span><span>website</span><span>.</span><span>url</span><span>,</span><span> </span><span>website</span><span>.</span><span>pattern</span><span>)</span><span>
</span><span>  </span><span>case</span><span> </span><span>database</span><span>.</span><span>save_result</span><span>(</span><span>db_conn</span><span>,</span><span> </span><span>result</span><span>)</span><span> </span><span>{</span><span>
</span><span>    </span><span>Ok</span><span>(</span><span>_</span><span>)</span><span> </span>-&gt;
      <span>io</span><span>.</span><span>println</span><span>(</span><span>string</span><span>.</span><span>append</span><span>(</span><span>&#34;Result saved successfully: &#34;</span><span>,</span><span> </span><span>website</span><span>.</span><span>url</span><span>))</span><span>
</span><span>    </span><span>Error</span><span>(</span><span>e</span><span>)</span><span> </span>-&gt; <span>io</span><span>.</span><span>println</span><span>(</span><span>string</span><span>.</span><span>append</span><span>(</span><span>&#34;Failed to save result: &#34;</span><span>,</span><span> </span><span>e</span><span>.</span><span>message</span><span>))</span><span>
</span><span>  </span><span>}</span><span>
</span><span>  </span><span>process</span><span>.</span><span>sleep</span><span>(</span><span>website</span><span>.</span><span>interval</span><span> </span><span>*</span><span> </span><span>1000</span><span>)</span><span>
</span><span>  </span><span>process_website_recursively</span><span>(</span><span>db_conn</span><span>,</span><span> </span><span>website</span><span>)</span><span>
</span><span></span><span>}</span><span>
</span></code></pre></div><p>You may ask why to use recursion here? <strong>There are no loops in Gleam!</strong> I think I could live with that as long as it promises immutability and no side effects.</p>
<h2 id="running-in-different-runtimes">Running in different runtimes</h2>
<p>I used <code>gleam run</code> to run the project locally in Erlang VM, that worked pretty well. But I also want to explore later how to compile it to JavaScript and run it in the browser.</p>
<p><img src="https://pliutau.com/gleam-run.png" alt="gleam-run"/></p>
<h2 id="testing">Testing</h2>
<p>I added a simple Unit Test for my parser and it was easy to write. Then I used <code>gleam test</code> to run the tests.</p>
<div><pre><code data-lang="rust"><span>import</span><span> </span><span>config</span><span>
</span><span></span><span>import</span><span> </span><span>gleam</span><span>/</span><span>list</span><span>
</span><span></span><span>import</span><span> </span><span>gleeunit</span><span>
</span><span></span><span>import</span><span> </span><span>gleeunit</span><span>/</span><span>should</span><span>
</span><span>
</span><span></span><span>pub</span><span> </span><span>fn</span> <span>main</span><span>()</span><span> </span><span>{</span><span>
</span><span>  </span><span>gleeunit</span><span>.</span><span>main</span><span>()</span><span>
</span><span></span><span>}</span><span>
</span><span>
</span><span></span><span>pub</span><span> </span><span>fn</span> <span>parse_config_file_test</span><span>()</span><span> </span><span>{</span><span>
</span><span>  </span><span>config</span><span>.</span><span>parse_config_file</span><span>(</span><span>&#34;invalid yaml data&#34;</span><span>)</span><span> </span><span>|&gt;</span><span> </span><span>should</span><span>.</span><span>be_error</span><span>
</span><span>
</span><span>  </span><span>let</span><span> </span><span>assert</span><span> </span><span>Ok</span><span>(</span><span>res</span><span>)</span><span> </span><span>=</span><span>
</span><span>    </span><span>config</span><span>.</span><span>parse_config_file</span><span>(</span><span>
</span><span>      </span><span>&#34;websites:
</span><span>    - url: https://packagemain.tech
</span><span>      interval: 11&#34;</span><span>,</span><span>
</span><span>    </span><span>)</span><span>
</span><span>  </span><span>let</span><span> </span><span>assert</span><span> </span><span>Ok</span><span>(</span><span>first</span><span>)</span><span> </span><span>=</span><span> </span><span>res</span><span> </span><span>|&gt;</span><span> </span><span>list</span><span>.</span><span>first</span><span>
</span><span>  </span><span>first</span><span>.</span><span>url</span><span> </span><span>|&gt;</span><span> </span><span>should</span><span>.</span><span>equal</span><span>(</span><span>&#34;https://packagemain.tech&#34;</span><span>)</span><span>
</span><span>  </span><span>first</span><span>.</span><span>interval</span><span> </span><span>|&gt;</span><span> </span><span>should</span><span>.</span><span>equal</span><span>(</span><span>11</span><span>)</span><span>
</span><span></span><span>}</span><span>
</span></code></pre></div><p>I wanted to name the file differently but I couldn’t. Does that mean I can’t have multiple test files in Gleam?</p>
<h2 id="ide-support">IDE Support</h2>
<p>I am using Zed and it just asked me to integrate the Gleam Language Server and it worked well.</p>
<p><img src="https://pliutau.com/gleam-zed.png" alt="gleam-zed"/></p>
<h2 id="conclusion">Conclusion</h2>
<p>I enjoyed writing this project in Gleam. My favorite parts were:</p>
<ul>
<li>Immutability and no side effects</li>
<li>Pipelines, for example <code>first.url |&gt; should.equal(&#34;https://packagemain.tech&#34;)</code></li>
<li><code>Result(value, error)</code> type for error handling</li>
<li>Concurrency</li>
</ul>
<p>Learning Gleam has given me a lot of ideas and I’m looking forward to writing more projects in it.</p>
<p>You can see the full code in the <a href="https://github.com/plutov/websites_checker">websites_checker repository</a> and please reach out to me if you have any suggestions for it.</p>
</div></div>
  </body>
</html>
