<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blogs.igalia.com/berto/2022/07/05/running-the-steam-decks-os-in-a-virtual-machine-using-qemu/">Original</a>
    <h1>Running the Steam Deck’s OS in a virtual machine using QEMU</h1>
    
    <div id="readability-page-1" class="page"><div>
			<p><img src="http://blogs.igalia.com/berto/files/2022/07/steamos-desktop.jpg" alt="SteamOS desktop"/></p>

<p>The <a href="http://www.steamdeck.com/">Steam Deck</a> is a handheld gaming computer that runs a Linux-based operating system called SteamOS. The machine comes with SteamOS 3 (code name <em>“holo”</em>), which is in turn based on Arch Linux.</p>
<p>Although there is no SteamOS 3 installer for a generic PC (yet), it is very easy to install on a virtual machine using QEMU. This post explains how to do it.</p>
<p>The goal of this VM is not to play games (you can already install Steam on your computer after all) but to use SteamOS in <em>desktop</em> mode. The <em>Gamescope</em> mode (the console-like interface you normally see when you use the machine) requires additional development to make it work with QEMU and will not work with these instructions.</p>
<p>A SteamOS VM can be useful for debugging, development, and generally playing and tinkering with the OS without risking breaking the Steam Deck.</p>
<p>Running the SteamOS desktop in a virtual machine only requires QEMU and the OVMF UEFI firmware and should work in any relatively recent distribution.</p>

<p>SteamOS is a single-user operating system and it uses an A/B partition scheme, which means that there are two sets of partitions and two copies of the operating system. The root filesystem is <em>read-only</em> and system updates happen on the partition set that is not active. This allows for safer updates, among other things.</p>
<p>There is one single <code>/home</code> partition, shared by both partition sets. It contains the games, user files, and anything that the user wants to install there.</p>
<p>Although the user can trivially become root, make the root filesystem read-write and install or change anything (the <code>pacman</code> package manager is available), this is not recommended because</p>
<ul>
<li>it increases the chances of breaking the OS, and</li>
<li>any changes will disappear with the next OS update.</li>
</ul>
<p>A simple way for the user to install additional software that survives OS updates and doesn’t touch the root filesystem is <a href="https://flathub.org/">Flatpak</a>. It comes preinstalled with the OS and is integrated with the KDE Discover app.</p>

<p>The first thing that we need is the installer. For that we have to download the Steam Deck recovery image from here: <a href="https://store.steampowered.com/steamos/download/?ver=steamdeck&amp;snr=">https://store.steampowered.com/steamos/download/?ver=steamdeck&amp;snr=</a></p>
<p>Once the file has been downloaded, we can uncompress it and we’ll get a raw disk image called <code>steamdeck-recovery-4.img</code> (the number may vary).</p>
<p>Note that the recovery image is already SteamOS (just not the most up-to-date version). If you simply want to have a quick look you can play a bit with it and skip the installation step. In this case I recommend that you extend the image before using it, for example with ‘<code>truncate -s 64G steamdeck-recovery-4.img</code>‘ or, better, create a qcow2 overlay file and leave the original raw image unmodified: ‘<code>qemu-img create -f qcow2 -F raw -b steamdeck-recovery-4.img steamdeck-recovery-extended.qcow2 64G</code>‘</p>
<p>But here we want to perform the actual installation, so we need a destination image. Let’s create one:</p>
<p><code>$ qemu-img create -f qcow2 steamos.qcow2 64G</code></p>

<p>Now that we have all files we can start the virtual machine:</p>
<pre>$ qemu-system-x86_64 -enable-kvm -smp cores=4 -m 8G \
    -device usb-ehci -device usb-tablet \
    -device intel-hda -device hda-duplex \
    -device VGA,xres=1280,yres=800 \
    -drive if=pflash,format=raw,readonly=on,file=/usr/share/ovmf/OVMF.fd \
    -drive if=virtio,file=steamdeck-recovery-4.img,driver=raw \
    -device nvme,drive=drive0,serial=badbeef \
    -drive if=none,id=drive0,file=steamos.qcow2
</pre>
<p>Note that we’re emulating an NVMe drive for <code>steamos.qcow2</code> because that’s what the installer script expects. This is not strictly necessary but it makes things a bit easier.</p>
<p><img src="http://blogs.igalia.com/berto/files/2022/07/steamos-installer.jpg" alt="SteamOS installer shortcuts"/></p>
<p>Once the system has booted we’ll see a KDE Plasma session with a few tools on the desktop. If we select <em>“Reimage Steam Deck”</em> and click <em>“Proceed”</em> on the confirmation dialog then SteamOS will be installed on the destination drive. This process should not take a long time.</p>
<p>Now, once the operation finishes a new confirmation dialog will ask if we want to reboot the Steam Deck, but here <strong>we have to choose “Cancel”</strong>. We cannot use the new image yet because it would try to boot into the Gamescope session, which won’t work, so we need to change the default desktop session.</p>
<p>SteamOS comes with a helper script that allows us to enter a chroot after automatically mounting all SteamOS partitions, so let’s open a Konsole and make the Plasma session the default one in both partition sets:</p>
<pre><code>$ sudo steamos-chroot --disk /dev/nvme0n1 --partset A
# steamos-readonly disable
# echo &#39;[Autologin] &gt; /etc/sddm.conf.d/zz-steamos-autologin.conf
# echo &#39;Session=plasma.desktop&#39; &gt;&gt; /etc/sddm.conf.d/zz-steamos-autologin.conf
# steamos-readonly enable
# exit

$ sudo steamos-chroot --disk /dev/nvme0n1 --partset B
# steamos-readonly disable
# echo &#39;[Autologin] &gt; /etc/sddm.conf.d/zz-steamos-autologin.conf
# echo &#39;Session=plasma.desktop&#39; &gt;&gt; /etc/sddm.conf.d/zz-steamos-autologin.conf
# steamos-readonly enable
# exit
</code></pre>
<p>After this we can shut down the virtual machine. Our new SteamOS drive is ready to be used. We can discard the recovery image now if we want.</p>

<p>To boot SteamOS we can use a QEMU line similar to the one used during the installation. This time we’re not emulating an NVMe drive because it’s no longer necessary.</p>
<pre>$ cp /usr/share/OVMF/OVMF_VARS.fd .
$ qemu-system-x86_64 -enable-kvm -smp cores=4 -m 8G \
   -device usb-ehci -device usb-tablet \
   -device intel-hda -device hda-duplex \
   -device VGA,xres=1280,yres=800 \
   -drive if=pflash,format=raw,readonly=on,file=/usr/share/ovmf/OVMF.fd \
   -drive if=pflash,format=raw,file=OVMF_VARS.fd \
   -drive if=virtio,file=steamos.qcow2 \
   -device virtio-net-pci,netdev=net0 \
   -netdev user,id=net0,hostfwd=tcp::2222-:22
</pre>
<p>(the last two lines redirect tcp port 2222 to port 22 of the guest to be able to SSH into the VM. If you don’t want to do that you can omit them)</p>
<p>If everything went fine, you should see KDE Plasma again, this time with a desktop icon to launch Steam and another one to “Return to Gaming Mode” (which we should <strong>not</strong> use because it won’t work). See the screenshot that opens this post.</p>
<p>Congratulations, you’re running SteamOS now. Here are some things that you probably want to do:</p>
<ul>
<li>(optional) Change the keyboard layout in the system settings (the default one is US English)</li>
<li>Set the password for the <code>deck</code> user: run ‘<code>passwd</code>‘ on a terminal</li>
<li>Enable / start the SSH server: ‘<code>sudo systemctl enable sshd</code>‘ and/or ‘<code>sudo systemctl start sshd</code>‘.</li>
<li>SSH into the machine: ‘<code>ssh -p 2222 deck@localhost</code>‘</li>
</ul>

<p>The Steam Deck recovery image doesn’t install the most recent version of SteamOS, so now we should probably do a software update.</p>
<ul>
<li>First of all ensure that you’re giving enought RAM to the VM (in my examples I run QEMU with <code>-m 8G</code>). The OS update might fail if you use less.</li>
<li>(optional) Change the OS branch if you want to try the beta release: ‘<code>sudo steamos-select-branch beta</code>‘ (or <code>main</code>, if you want the bleeding edge)</li>
<li>Check the currently installed version in <code>/etc/os-release</code> (see the <code>BUILD_ID</code> variable)</li>
<li>Check the available version: ‘<code>steamos-update check</code>‘</li>
<li>Download and install the software update: ‘<code>steamos-update</code>‘</li>
</ul>
<p>Note: if the last step fails after reaching 100% with a <em>post-install handler error</em> then go to <em>Connections</em> in the system settings, rename <em>Wired Connection 1</em> to something else (anything, the name doesn’t matter), click <em>Apply</em> and run <code>steamos-update</code> again. This works around a bug in the update process. Recent images fix this and this workaround is not necessary with them.</p>
<p>As we did with the recovery image, before rebooting we should ensure that the new update boots into the Plasma session, otherwise it won’t work:</p>
<pre><code>$ sudo steamos-chroot --partset other
# steamos-readonly disable
# echo &#39;[Autologin] &gt; /etc/sddm.conf.d/zz-steamos-autologin.conf
# echo &#39;Session=plasma.desktop&#39; &gt;&gt; /etc/sddm.conf.d/zz-steamos-autologin.conf
# steamos-readonly enable
# exit
</code></pre>
<p>After this we can restart the system.</p>
<p>If everything went fine we should be running the latest SteamOS release. Enjoy!</p>

<p>SteamOS is under active development. If you find problems or want to request improvements please go to the <a href="https://github.com/ValveSoftware/SteamOS/issues">SteamOS community tracker</a>.</p>
					</div></div>
  </body>
</html>
