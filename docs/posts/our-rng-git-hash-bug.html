<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tmendez.dev/posts/rng-git-hash-bug/">Original</a>
    <h1>Our RNG Git Hash Bug</h1>
    
    <div id="readability-page-1" class="page"><div>
    <main aria-label="Content">
        <article>
            
            
            <div>
                <h2 id="background">Background</h2>
<p>I work on the live services game <a href="https://www.playxadia.com/">Dragon Prince: Xadia</a>. We have iOS/Android clients, hosted gameservers, and a platform. Our gameservers and clients need to be in sync, so we have a field in our platform’s YAML configuration:</p>
<div><pre tabindex="0"><code data-lang="yaml"><span><span><span>gameServerVersion</span><span>:</span><span> </span><span>&lt;gitHashOfDeployedCommitGoesHere&gt;</span><span>
</span></span></span></code></pre></div><p>This way, we can tell clients when they are out of date and need to update. This value is set dynamically by a TeamCity deployment job.</p>
<h2 id="the-bug">The Bug</h2>
<p>One day, a good long while after we put this system in place, our QA lead pings me in the #game-ops channel on Slack:</p>
<blockquote>
<p>@tim_m @bug there’s something wonky with Sandbox2. Deployment is finished for platform/server/Android and I downloaded the new Android client/patched and it’s still reporting that there’s an update</p>
</blockquote>
<p>Clients for our Sandbox2 shard are blocking access with a “you gotta update” message.</p>
<h2 id="a-brief-investigation">A Brief Investigation</h2>
<p>I’m assuming the deployment didn’t actually succeed, or either the platform or client was overwritten with the wrong git hash by accident. So, I pull down the Sandbox2 shard’s yml config and look at the <code>gameServerVersion</code> value.</p>
<div><pre tabindex="0"><code data-lang="yaml"><span><span><span>gameServerVersion</span><span>:</span><span> </span><span>556474e378</span><span>
</span></span></span></code></pre></div><p>I jot that down and take a look at our TeamCity deployment history. The git hash used in both client deployments matches this value.</p>
<p>I’m a bit perplexed here, so I download the iOS client myself to make sure it’s not an Android caching bug (of which we’ve had a few). Our QA lead, of course, has already gone through all the cache clearing steps for Android, with no success. I boot up iOS and see the same “you gotta update your client” message.</p>
<p>Our QA lead posts the client log for me to comb through. I’m expecting to see the client pointing to a different platform, or something to that effect. Instead, I see:</p>
<pre tabindex="0"><code data-lang="log">&#34;gameServerVersion&#34;: &#34;Infinity&#34;,
</code></pre><p>as part of the <code>GameData</code> payload, which we compare to the version bundled with the client.</p>
<p>Well that’s probably it. HMMMMM.</p>
<h2 id="the-cause">The Cause</h2>
<p>I look back at the git hash and immediately see what’s wrong this time: quotes are missing.</p>
<p><code>556474e378</code> also happens to be scientific notation for, well, a very large value. It’s also expressed as 556474 × 10<sup>378</sup>.</p>
<p>YAML parsers will interpret values as strings even if quotes aren’t present, as long as the value is definitely not something else, like a number, boolean, etc.</p>
<p>Every short git hash that we had rolled before now happened to <strong>not</strong> be able to be interpreted as a number, so <code>gameServerVersion</code> was always being interpreted as a string.</p>
<h2 id="the-solution">The Solution</h2>
<p>I wrap the git hash in quotes and, sure enough, the error message goes away.</p>
<div><pre tabindex="0"><code data-lang="yaml"><span><span><span>gameServerVersion</span><span>:</span><span> </span><span>&#34;556474e378&#34;</span><span>
</span></span></span></code></pre></div><p>I also update our TeamCity code to wrap the git hash in quotes to fix this bug for future git commit hashes.</p>
<p>A git hash that can also be interpreted as mathematical expression was not on my initial list of causes for the bug.</p>

            </div>
        </article></main>
</div></div>
  </body>
</html>
