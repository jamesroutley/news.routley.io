<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.loro.dev/blog/loro-richtext">Original</a>
    <h1>Introduction to Loro&#39;s Rich Text CRDT</h1>
    
    <div id="readability-page-1" class="page"><article><main><div><div title="Blog"><p><a href="https://riskmusings.substack.com/blog">Blog</a></p></div><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg><p>Introduction to Loro&#39;s Rich Text CRDT</p></div>
<!-- -->
<div><p>2024-01-22</p><!-- --><p> by <span><a href="https://twitter.com/zxch3n" target="_blank">Zixuan Chen</a></span></p></div>
<p><img loading="lazy" width="1942" height="1036" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fcover_long.87c49754.png&amp;w=2048&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fcover_long.87c49754.png&amp;w=3840&amp;q=75 2x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fcover_long.87c49754.png&amp;w=3840&amp;q=75"/></p>
<!-- -->
<p>This article presents the rich text CRDT algorithm implemented in Loro, complying with <a href="https://www.inkandswitch.com/peritext/" target="_blank" rel="noreferrer">Peritext<span> (opens in a new tab)</span></a>&#39;s criteria for seamless rich text collaboration. Furthermore, it can be built on top of any List CRDT algorithms and turn them into rich text CRDTs.</p>

<!-- -->
<p>Above is an online demo of Loro&#39;s rich text CRDT, built with Quill. After the replay, you can simulate real-time collaboration and concurrent editing while offline. You can also drag on the history view to replay the editing history.</p>
<p>If CRDTs are new to you, our article <a href="https://riskmusings.substack.com/docs/concepts/crdt">What are CRDTs</a> provides a brief introduction.</p>
<h2>Background<a href="#background" id="background" aria-label="Permalink for this section"></a></h2>
<p>Loro is based on the <a href="https://riskmusings.substack.com/docs/advanced/replayable_event_graph">Replayable Event Graph (REG)</a> algorithm proposed by Seph Gentle, but this algorithm cannot integrate the original version of Peritext. This motivates us to create a new rich text algorithm. It is independent of the specific List CRDTs, thus working nicely with REG, and is developed on top of them to establish a rich text CRDT.</p>
<p>Before diving into the algorithm of Loro&#39;s rich text CRDT, I&#39;d like to briefly introduce REG and Peritext, and why Peritext cannot be used on REG.</p>
<details><summary>Recap on List CRDTs</summary><div><div><h3>Recap on List CRDTs<a href="#recap-on-list-crdts" id="recap-on-list-crdts" aria-label="Permalink for this section"></a></h3><p>Unlike OT, most List-oriented CRDTs assign a unique ID to each item or character, often corresponding to the operation ID of its insertion. With unique IDs for each character, we can reliably reference a character or position through its ID.</p><p><img loading="lazy" width="1906" height="451" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flist_crdt_ids.61db6257.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flist_crdt_ids.61db6257.png&amp;w=3840&amp;q=75 2x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flist_crdt_ids.61db6257.png&amp;w=3840&amp;q=75"/></p><p>The unique ID eliminates concerns about consistent position descriptions during synchronization. For instance, deletions are straightforward by specifying the deleted character&#39;s ID, and insertions are described using the IDs of adjacent characters. In cases of concurrent insertions at the same location, List CRDT algorithms resolve the consistency issues.</p><p><img loading="lazy" width="1887" height="794" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flist_crdt_insert.572f0896.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flist_crdt_insert.572f0896.png&amp;w=3840&amp;q=75 2x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flist_crdt_insert.572f0896.png&amp;w=3840&amp;q=75"/></p><p><img loading="lazy" width="1887" height="463" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flist_crdt_delete.e2fdf7bc.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flist_crdt_delete.e2fdf7bc.png&amp;w=3840&amp;q=75 2x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flist_crdt_delete.e2fdf7bc.png&amp;w=3840&amp;q=75"/></p><p>However, a notable limitation of List CRDTs is the use of &#39;tombstones&#39;. Upon deletion of a character, it is not fully removed but replaced with a tombstone, maintaining the ID&#39;s position. Depending on the algorithm, this tombstone may be removed once all participating nodes acknowledge the deletion. However, it can be challenging to determine if all peers have received the corresponding deletion operation. This information often means additional overhead for many CRDTs. Thus, the simplest solution is not to perform any tombstone collection.</p><p><img loading="lazy" width="1897" height="1787" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flist_crdt_tombstone.5a4f3d51.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flist_crdt_tombstone.5a4f3d51.png&amp;w=3840&amp;q=75 2x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flist_crdt_tombstone.5a4f3d51.png&amp;w=3840&amp;q=75"/></p></div></div></details>
<h3>Brief Introduction to Replayable Event Graph<a href="#brief-introduction-to-replayable-event-graph" id="brief-introduction-to-replayable-event-graph" aria-label="Permalink for this section"></a></h3>
<blockquote>
<p><a href="https://github.com/josephg" target="_blank" rel="noreferrer">Seph Gentle<span> (opens in a new tab)</span></a>, the author of Replayable Event Graph, is currently working on the paper, and it&#39;s highly anticipated.</p>
</blockquote>
<p>REG is a novel CRDT algorithm that combines the strengths of both OT and CRDTs. It has the distributed nature of CRDT that enables P2P collaboration and data ownership. Moreover, it achieves minimal overhead in scenarios devoid of concurrent edits, similar to OT.</p>
<!-- -->
<!-- -->
<p>Whether in real-time collaboration or multi-end synchronization, a directed acyclic graph (DAG) forms over the history of these parallel edits, similar to Git&#39;s history. The REG algorithm records the history of user edits on the DAG.</p>
<p>Unlike conventional CRDTs, REG can record just the original description of operations, not the metadata of CRDTs. For instance, in text editing scenarios, the <a href="https://www.sciencedirect.com/science/article/abs/pii/S0743731510002716" target="_blank" rel="noreferrer">RGA algorithm<span> (opens in a new tab)</span></a> needs the op ID and <a href="https://en.wikipedia.org/wiki/Lamport_timestamp" target="_blank" rel="noreferrer">Lamport timestamp<span> (opens in a new tab)</span></a> of the character to the left to determine the insertion point. <a href="https://github.com/yjs/yjs" target="_blank" rel="noreferrer">Yjs<span> (opens in a new tab)</span></a>/Fugue, however, requires the op ID of both the left and right characters at insertion. In contrast, REG simplifies this by only recording the index at the time of insertion. Loro, which uses <a href="https://arxiv.org/abs/2305.00583" target="_blank" rel="noreferrer">Fugue<span> (opens in a new tab)</span></a> upon REG, inherits these advantages.</p>
<p>An index is not a stable position descriptor, as the index of an operation can be affected by other operations. For example, if you highlight content from <code dir="ltr">index=x</code> to <code dir="ltr">index=y</code>, and concurrently someone inserts n characters at <code dir="ltr">index=n</code> where <code dir="ltr">n&lt;x</code>, then your highlighted range should shift to cover from <code dir="ltr">x+n</code> to <code dir="ltr">y+n</code>. But REG can determine the exact position of this index by replaying history. Thus, it can reconstruct the corresponding CRDT structure by replaying history.</p>
<p>Reconstructing history might seem time-consuming, but REG can backtrack only some. When merging updates from remote sources, it only needs to replay operations parallel to the remote update, reconstructing the local CRDTs to calculate the diff after applying remote operations to the current document.</p>
<p>The REG algorithm excels with its fast local update speeds and eliminate concerns about tombstone collection in CRDTs.For instance, if an operation has been synchronized across all endpoints, no new operations will occur concurrently with it, allowing it to be safely removed from the history.</p>
<details><summary>What is Fugue</summary><div><div><p>Fugue is a new CRDT text algorithm, presented in <em><a href="https://arxiv.org/abs/2305.00583" target="_blank" rel="noreferrer">The Art of the Fugue: Minimizing Interleaving in Collaborative Text Editing<span> (opens in a new tab)</span></a></em> by <a href="https://arxiv.org/search/cs?searchtype=author&amp;query=Weidner%2C+M" target="_blank" rel="noreferrer">Matthew Weidner<span> (opens in a new tab)</span></a> et al., nicely solves <strong>the interleaving problem</strong>.</p><p>The interleaving problem was proposed in the paper <em><a href="https://martin.kleppmann.com/2019/03/25/papoc-interleaving-anomalies.html" target="_blank" rel="noreferrer">Interleaving anomalies in collaborative text editors<span> (opens in a new tab)</span></a></em> by Martin Kleppmann et al.</p><p>An example of interleaving:</p><ul>
<li>A type &#34;Hello &#34; from left to right/right to left</li>
<li>B type &#34;Hi &#34; from left to right/right to left</li>
<li>The expected result: &#34;Hello Hi &#34; or &#34;Hi Hello &#34;</li>
<li>The interleaving result may look like: &#34;HHeil lo&#34;<!-- -->
<ul>
<li>This happens when typing from right to left in RGA.</li>
</ul>
</li>
</ul><p><img alt="An example of an interleaving anomaly when using fractional indexing CRDT on text content. Source: **Martin Kleppmann, Victor B. F. Gomes, Dominic P. Mulligan, and Alastair R. Beresford. 2019. Interleaving anomalies in collaborative text editors. https://doi.org/10.1145/3301419.3323972" loading="lazy" width="1926" height="774" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Frichtext0.f84468af.png&amp;w=2048&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Frichtext0.f84468af.png&amp;w=3840&amp;q=75 2x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Frichtext0.f84468af.png&amp;w=3840&amp;q=75"/></p><p>An example of an interleaving anomaly when using <a href="https://madebyevan.com/algos/crdt-fractional-indexing/" target="_blank" rel="noreferrer">fractional indexing<span> (opens in a new tab)</span></a> CRDT on text content.
Source: **Martin Kleppmann, Victor B. F. Gomes, Dominic P. Mulligan, and Alastair R. Beresford. 2019. Interleaving anomalies in collaborative text editors. <a href="https://doi.org/10.1145/3301419.3323972" target="_blank" rel="noreferrer">https://doi.org/10.1145/3301419.3323972<span> (opens in a new tab)</span></a></p><p>The <a href="https://arxiv.org/abs/2305.00583" target="_blank" rel="noreferrer">Fugue paper<span> (opens in a new tab)</span></a> summarizes the current state of the interleaving problems in the table.</p><p><img alt="Souece: Weidner, M., Gentle, J., &amp; Kleppmann, M. (2023). The Art of the Fugue: Minimizing Interleaving in Collaborative Text Editing. ArXiv. /abs/2305.00583" loading="lazy" width="1658" height="1054" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Frichtext1.8a6c34f1.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Frichtext1.8a6c34f1.png&amp;w=3840&amp;q=75 2x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Frichtext1.8a6c34f1.png&amp;w=3840&amp;q=75"/></p><p>Souece: Weidner, M., Gentle, J., &amp; Kleppmann, M. (2023). The Art of the Fugue: Minimizing Interleaving in Collaborative Text Editing. <em>ArXiv</em>. /abs/2305.00583</p><p>The interleaving problem sometimes are unsolvable when there are more than 2 sites. See <a href="https://arxiv.org/abs/2305.00583" target="_blank" rel="noreferrer">Fugue<span> (opens in a new tab)</span></a> paper Appendix B, Proof of Theorem 5 for detailed explanation.</p><p><img alt="The case where the interleaving problem is unsolvable Source: Weidner, M., Gentle, J., &amp; Kleppmann, M. (2023). The Art of the Fugue: Minimizing Interleaving in Collaborative Text Editing. ArXiv. /abs/2305.00583" loading="lazy" width="754" height="572" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Frichtext2.509b13ad.png&amp;w=828&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Frichtext2.509b13ad.png&amp;w=1920&amp;q=75 2x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Frichtext2.509b13ad.png&amp;w=1920&amp;q=75"/></p><p>The case where the interleaving problem is unsolvable
Source: Weidner, M., Gentle, J., &amp; Kleppmann, M. (2023). The Art of the Fugue: Minimizing Interleaving in Collaborative Text Editing. <em>ArXiv</em>. /abs/2305.00583</p><p>However, we can still minimize the chance of interleaving. Fugue introduces the concept of <strong>maximal non-interleaving</strong> and solves it with an elegant algorithm that is easy to optimize. The definition of <em>maximal non-interleaving</em> makes a lot of sense to me and leaves little room for ambiguity. I won&#39;t reiterate the definition here. But the basic idea is first to solve forward interleaving by leftOrigin. If there is still ambiguity, then solve the backward interleaving by rightOrigin. (The leftOrigin and rightOrigin refer to the ids of the original neighbors when the character is inserted, just like Yjs)</p></div></div></details>
<h3>Brief Introduction to Peritext<a href="#brief-introduction-to-peritext" id="brief-introduction-to-peritext" aria-label="Permalink for this section"></a></h3>
<p><a href="https://www.inkandswitch.com/peritext/" target="_blank" rel="noreferrer">Peritext<span> (opens in a new tab)</span></a> was proposed by <em>Geoffrey Litt et al.</em> It&#39;s the first paper to discuss rich text CRDTs. It can merge concurrent edits in rich text format while <a href="https://www.inkandswitch.com/peritext/#preserving-the-authors-intent" target="_blank" rel="noreferrer">preserving users&#39; intent as much as possible<span> (opens in a new tab)</span></a>. Its primary focus is merging the formats and annotations of rich text content, such as bold, italic, and comments. It was implemented in <a href="https://github.com/automerge/automerge" target="_blank" rel="noreferrer">Automerge<span> (opens in a new tab)</span></a> and <a href="https://github.com/loro-dev/crdt-richtext" target="_blank" rel="noreferrer">crdt-richtext<span> (opens in a new tab)</span></a>.</p>
<blockquote>
<p>💡 The specific definition of user intent in the context of concurrent rich text editing can&#39;t be clearly explained in a few words. It&#39;s best understood through particular examples.</p>
</blockquote>
<p>Peritext is designed to solve a couple of significant challenges:</p>
<p>Firstly, it addresses the anticipated problems arising from conflicting style edits. For instance, consider a text example, &#34;The quick fox jumped.&#34; If User A highlights &#34;The quick&#34; in bold and User B highlights &#34;quick fox jumped,&#34; the ideal merge should result in the entire sentence, &#34;The quick fox jumped,&#34; being bold. However, existing algorithms might not meet this expectation, resulting in either &#34;The quick fox&#34; or &#34;The&#34; and &#34;jumped&#34; being bold instead.</p>
<div><table><thead><tr><th>Original Text</th><th>The quick fox jumped</th></tr></thead><tbody><tr><td>Concurrent Edit from A</td><td><strong>The quick</strong> fox jumped</td></tr><tr><td>Concurrent Edit from B</td><td>The <strong>quick fox jumped</strong></td></tr><tr><td>Expected Merged Result</td><td><strong>The quick fox jumped</strong></td></tr><tr><td>Bad case from merging Markdown text directly</td><td><strong>The</strong> quick <strong>fox jumped</strong></td></tr><tr><td>Bad case from Yjs</td><td><strong>The quick</strong> fox jumped</td></tr></tbody></table></div>
<p>Additionally, Peritext manages conflicts between style and text edits. In the same example, if User A highlights &#34;The quick&#34; in bold, but User B changes the text to &#34;The fast fox jumped,&#34; the ideal merge should result in &#34;The fast&#34; being bold.</p>
<div><table><thead><tr><th>Original Text</th><th>The quick fox jumped</th></tr></thead><tbody><tr><td>Concurrent Edit from A</td><td><strong>The quick</strong> fox jumped</td></tr><tr><td>Concurrent Edit from B</td><td>The fast fox jumped</td></tr><tr><td>Expected Merged Result</td><td><strong>The fast</strong> fox jumped</td></tr></tbody></table></div>
<p>What’s more, Peritext takes into account different expectations for expanding styles. For example, if you type after a bold text, you would typically want the new text to continue being bold. However, if you&#39;re typing after a hyperlink or a comment, you likely wouldn&#39;t want the new input to become part of the hyperlink or comment.</p>
<p><img alt="Link style should not expand" loading="lazy" width="1700" height="670" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2FPeritext.aa65d0ee.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2FPeritext.aa65d0ee.png&amp;w=3840&amp;q=75 2x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2FPeritext.aa65d0ee.png&amp;w=3840&amp;q=75"/></p>
<p>Illustration of Peritext&#39;s internal state. It uses the IDs of the character&#39;s ops to record the style ranges. In the example, the bold mark has the range of <code dir="ltr">{ start: { type: &#34;before&#34;, opId: &#34;9@B&#34; }, end: { type: &#34;before&#34;, opId: &#34;10@B&#34; }}</code></p>
<h3>Why Original Peritext Can&#39;t Be Directly Used with REG<a href="#why-original-peritext-cant-be-directly-used-with-reg" id="why-original-peritext-cant-be-directly-used-with-reg" aria-label="Permalink for this section"></a></h3>
<p>On the one hand, Peritext&#39;s algorithm expresses style ranges <a href="https://www.inkandswitch.com/peritext/#generating-inline-formatting-operations" target="_blank" rel="noreferrer">through character OpIDs<span> (opens in a new tab)</span></a>. Without replaying history, CRDTs based on REG cannot determine the specific positions corresponding to these OpIDs.</p>
<p>On the other hand, it&#39;s not feasible to model Peritext on REG through replaying. This is because REG&#39;s &#34;local backtracking suffices&#34; relies on the algorithm satisfying &#34;the same operation will produce the same effect, regardless of the current state,&#34; which Peritext does not adhere to. For example, when inserting the character &#34;x&#34; at position <code dir="ltr">p</code>, whether &#34;x&#34; is bold depends on &#34;whether <code dir="ltr">p</code> is surrounded by bold&#34; and &#34;<a href="https://arc.net/l/quote/ifxpaand" target="_blank" rel="noreferrer">whether the tombstones at <code dir="ltr">p</code> contain boundaries of bold and other styles<span> (opens in a new tab)</span></a>.&#34;</p>
<h2>Loro&#39;s Rich Text CRDT<a href="#loros-rich-text-crdt" id="loros-rich-text-crdt" aria-label="Permalink for this section"></a></h2>
<h3>Algorithm<a href="#algorithm" id="algorithm" aria-label="Permalink for this section"></a></h3>
<p>Loro implements rich text using special control characters called &#39;style anchors&#39;. Each matching pair of start anchor and end anchor contains the following information:</p>
<ul>
<li>The op ID of the style operation</li>
<li>The style&#39;s key-value pair</li>
<li>The style&#39;s <a href="https://en.wikipedia.org/wiki/Lamport_timestamp" target="_blank" rel="noreferrer">Lamport timestamp<span> (opens in a new tab)</span></a></li>
<li>Style expansion behavior: Determines whether newly inserted text before or after the style boundaries should inherit the style.</li>
</ul>
<p>The method to determine a character&#39;s style is as follows:</p>
<ul>
<li>Find all style anchor pairs that include the character, where each pair is created by the same style operation</li>
<li>Aggregate pairs according to the key. There may be multiple style pairs with the same key but different values. In such cases, the value with the greatest Lamport timestamp is chosen (if Lamport timestamps are equal, then use the peer ID to break the tie)</li>
</ul>
<p>Contrary to <a href="https://www.inkandswitch.com/peritext/#adding-control-characters-to-plain-text" target="_blank" rel="noreferrer">Yjs&#39;s method of using control characters<span> (opens in a new tab)</span></a> for rich text, our algorithm pairs start and end anchors when they originate from the same style operation. This approach accurately handles the following scenarios:</p>
<p><img alt="overlap_bold" loading="lazy" width="1889" height="1428" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Foverlap_bold.5c44773d.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Foverlap_bold.5c44773d.png&amp;w=3840&amp;q=75 2x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Foverlap_bold.5c44773d.png&amp;w=3840&amp;q=75"/></p>
<p>These special control characters are not exposed to the user; each control character is effectively of zero length from the user&#39;s perspective. Our data structure supports various methods of measuring text length for indexing text content. Besides Unicode, UTF-16, and UTF-8, we also measure our rich text length in <code dir="ltr">Entity length</code>. It treats each style anchor as an entity with a length of 1 and measures plain text in Unicode length.</p>
<p><img alt="len" loading="lazy" width="1226" height="440" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flen.45cb3960.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flen.45cb3960.png&amp;w=3840&amp;q=75 2x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flen.45cb3960.png&amp;w=3840&amp;q=75"/></p>
<table><thead><tr><th>Concept</th><th>Definition</th></tr></thead><tbody><tr><td>Style Anchors</td><td>Control characters used in Loro denote style boundaries&#39; start and end. They are differentiated into start and end anchors, representing a style&#39;s beginning and end.</td></tr><tr><td>Rich Text Element</td><td>A rich text element is either a span of text or a style anchor. A list of rich text elements represents the internal state of Loro&#39;s rich text.</td></tr><tr><td>Unicode Index</td><td>A method of indexing text positions in rich text. In this method, the length of the text is measured in Unicode char length, and the length of style anchors is considered 0.</td></tr><tr><td>Entity Index</td><td>A method of indexing text positions in rich text. In this method, the length of the text is measured in Unicode char length, and the length of a style anchor is considered 1.</td></tr></tbody></table>
<h4>Local Behavior<a href="#local-behavior" id="local-behavior" aria-label="Permalink for this section"></a></h4>
<p>Multiple valid insertion points can exist when users insert text at a specific Unicode index. It occurs due to style anchors, which are zero-length elements from the user&#39;s perspective.</p>
<p><img alt="Two Different Kinds of Indexes" loading="lazy" width="1505" height="244" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Ftwo_index.f9451eb9.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Ftwo_index.f9451eb9.png&amp;w=3840&amp;q=75 2x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Ftwo_index.f9451eb9.png&amp;w=3840&amp;q=75"/></p>
<p>For example, in the case of <code dir="ltr">&lt;b&gt;Hello&lt;/b&gt; world</code>, when a user inserts content at Unicode <code dir="ltr">index=5</code>, they face the choice of inserting to the left or right of <code dir="ltr">&lt;/b&gt;</code>. If the user sets the expand behavior of bold to expand forward, the new character will be inserted to the left of <code dir="ltr">&lt;/b&gt;</code>, making the inserted text bold as well.</p>
<p>When users delete text, Loro uses an additional mapping layer to avoid deleting style anchors within the text range.</p>
<p>To model the deletion of a style, a new style anchor pair with a null value is added.</p>
<p>We can implement the following optimizations to remove redundant style anchors:</p>
<ul>
<li>The style anchors that include no text can be removed.</li>
<li>When styles completely negate each other, like a span of bold is canceled by a span of unbold, we can remove their style anchors.</li>
</ul>
<p>All these behaviors happen locally, and the algorithm is independent of the specific List CRDT.</p>
<h5>Behavior When Inserting Text at Style Boundaries<a href="#behavior-when-inserting-text-at-style-boundaries" id="behavior-when-inserting-text-at-style-boundaries" aria-label="Permalink for this section"></a></h5>
<p>Most modern rich text editors (Google Doc, Microsoft Word, Notion) behave as follows: when new text is entered right after bold text, the new text should inherit the bold style; when entered after a hyperlink, the new content should not inherit the hyperlink style. Different styles have varying preferences for text insertion positions, leading to potential conflicts. This is reflected in the degree of freedom we have when inserting new text.</p>
<p>Users interact with rich text based on text-based indexes, like the Unicode index. Since style anchors have a Unicode Length of 0, a Unicode index with n style anchors presents n + 1 potential insertion positions.</p>
<p>We select the insertion position based on the following rules:</p>
<ol>
<li>Insertions occur before a start anchor of a style that should not expand backward.</li>
<li>Insertions occur before style anchors that signify the end of bold-like marks (expand = &#34;after&#34; or expand = &#34;both&#34;).</li>
<li>Insertions occur after style anchors that signify the end of link-like marks (expand = &#34;none&#34; or expand = &#34;before&#34;).</li>
</ol>
<p>Rule 1 should be prioritized over rules 2 and 3 to prevent <a href="https://github.com/inkandswitch/peritext/issues/32" target="_blank" rel="noreferrer">the accidental creation of a new style<span> (opens in a new tab)</span></a>.</p>
<p>The current method first scans forward to find the last position satisfying rules 1 and 2.</p>
<p>Then, it scans backward to find the first position satisfying rule 3.</p>
<h4>Merging Remote Updates<a href="#merging-remote-updates" id="merging-remote-updates" aria-label="Permalink for this section"></a></h4>
<p>Loro treats style anchors as a special element and handles them using the same List CRDT for resolving concurrent conflicts. The logic related to rich text is independent of the particular List CRDT. Therefore, this algorithm can rely on any List CRDT algorithm for merging remote operations. Loro utilizes the <a href="https://arxiv.org/abs/2305.00583" target="_blank" rel="noreferrer">Fugue<span> (opens in a new tab)</span></a> List CRDT algorithm.</p>
<p>When new style anchors are inserted by remote updates, new styles are added; if old style anchors are deleted, the corresponding old styles are removed.</p>
<h4>Strong Eventual Consistency<a href="#strong-eventual-consistency" id="strong-eventual-consistency" aria-label="Permalink for this section"></a></h4>
<p>The internal state of this algorithm consists of a list of elements, each either a text segment or a style anchor. The rich text document is derived from this internal state.</p>
<p>The internal state achieves strong eventual consistency through the upstream List CRDT.</p>
<p>Identical internal states result in identical rich text documents. Hence, the same set of updates will produce the same rich text documents, evidencing the strong eventual consistency of this algorithm.</p>
<h3>Criteria in Peritext<a href="#criteria-in-peritext" id="criteria-in-peritext" aria-label="Permalink for this section"></a></h3>
<p><a href="https://www.inkandswitch.com/peritext/static/cscw-publication.pdf" target="_blank" rel="noreferrer">The Peritext paper<span> (opens in a new tab)</span></a> specifies the intent-preserving merge behavior for rich text inline format. Loro&#39;s rich text algorithm successfully passes all test cases outlined therein.</p>
<h4>1. Concurrent Formatting and Insertion<a href="#1-concurrent-formatting-and-insertion" id="1-concurrent-formatting-and-insertion" aria-label="Permalink for this section"></a></h4>
<div><table><thead><tr><th>Name</th><th>Text</th></tr></thead><tbody><tr><td>Origin</td><td>Hello World</td></tr><tr><td>Concurrent A</td><td><strong>Hello World</strong></td></tr><tr><td>Concurrent B</td><td>Hello New World</td></tr><tr><td>Expected Result</td><td><strong>Hello New World</strong></td></tr></tbody></table></div>
<p>Loro easily supports this case by treating style anchors as special elements alongside text.</p>
<h4>2. Overlapping Formatting<a href="#2-overlapping-formatting" id="2-overlapping-formatting" aria-label="Permalink for this section"></a></h4>
<div><table><thead><tr><th>Name</th><th>Text</th></tr></thead><tbody><tr><td>Origin</td><td>Hello World</td></tr><tr><td>Concurrent A</td><td><strong>Hello</strong> World</td></tr><tr><td>Concurrent B</td><td>Hel<strong>lo World</strong></td></tr><tr><td>Expected Result</td><td><strong>Hello World</strong></td></tr></tbody></table></div>
<p>This case has been analyzed earlier. Since our style anchors contain style op ID information, we know there are two bold segments: one from 0 to 5 and another from 3 to 11, allowing us to merge them.</p>
<div><table><thead><tr><th>Name</th><th>Text</th></tr></thead><tbody><tr><td>Origin</td><td>Hello World</td></tr><tr><td>Concurrent A</td><td><strong>Hello</strong> World</td></tr><tr><td>Concurrent B</td><td>Hel<em>lo World</em></td></tr><tr><td>Expected Result</td><td><strong>Hel<em>lo</em></strong> <em>World</em></td></tr></tbody></table></div>
<p>Multiple style types are easily supported.</p>
<div><table><thead><tr><th>Name</th><th>Text</th><th>Note</th></tr></thead><tbody><tr><td>Origin</td><td>Hello World</td><td></td></tr><tr><td>Concurrent A</td><td><strong>Hello World</strong> </td><td>Bold, then unbold</td></tr><tr><td>Concurrent B</td><td>Hello Wor<strong>ld</strong></td><td></td></tr><tr><td>Expected Result</td><td><strong>Hello</strong> Wor<strong>ld</strong></td><td>Both are acceptable</td></tr></tbody></table></div>
<p>Like Peritext, we model unbolding by adding a new style with the key <code dir="ltr">bold</code> and the value <code dir="ltr">null</code>.
The final value of each style key on each character is determined by the style with the greatest <a href="https://en.wikipedia.org/wiki/Lamport_timestamp" target="_blank" rel="noreferrer">Lamport<span> (opens in a new tab)</span></a> timestamp that includes the character. Thus, it easily supports this case.</p>
<h4>3. Text Insertion at Span Boundaries<a href="#3-text-insertion-at-span-boundaries" id="3-text-insertion-at-span-boundaries" aria-label="Permalink for this section"></a></h4>
<p>Insertion right after a bold style should result in the newly inserted text also being bold.</p>
<p><img alt="bold_expand" loading="lazy" width="1354" height="470" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fbold_expand.8ca1c7b5.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fbold_expand.8ca1c7b5.png&amp;w=3840&amp;q=75 2x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fbold_expand.8ca1c7b5.png&amp;w=3840&amp;q=75"/></p>
<p>However, insertion right after a link style should result in the newly inserted text not having the hyperlink style.</p>
<p><img alt="Link style should not expand" loading="lazy" width="1300" height="466" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flink_expand.dc64a252.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flink_expand.dc64a252.png&amp;w=3840&amp;q=75 2x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flink_expand.dc64a252.png&amp;w=3840&amp;q=75"/></p>
<h4>4. Styles that Support Overlapping<a href="#4-styles-that-support-overlapping" id="4-styles-that-support-overlapping" aria-label="Permalink for this section"></a></h4>
<p><img loading="lazy" width="1280" height="734" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Foverlap_mark.8a170e5c.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Foverlap_mark.8a170e5c.png&amp;w=3840&amp;q=75 2x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Foverlap_mark.8a170e5c.png&amp;w=3840&amp;q=75"/></p>
<p>The problem of overlapping styles is related to how we represent them.</p>
<p>We represent the rich text using <a href="https://quilljs.com/docs/delta/" target="_blank" rel="noreferrer">Quill&#39;s Delta<span> (opens in a new tab)</span></a> format.</p>
<div><pre data-language="ts" data-theme="default"><code dir="ltr" data-language="ts" data-theme="default"><span><span>[</span></span>
<span><span>	{ insert</span><span>:</span><span> </span><span>&#39;Gandalf&#39;</span><span>,</span><span> attributes</span><span>:</span><span> { bold</span><span>:</span><span> </span><span>true</span><span> } }</span><span>,</span></span>
<span><span>	{ insert</span><span>:</span><span> </span><span>&#39; the &#39;</span><span> }</span><span>,</span></span>
<span><span>	{ insert</span><span>:</span><span> </span><span>&#39;Grey&#39;</span><span>,</span><span> attributes</span><span>:</span><span> { color</span><span>:</span><span> </span><span>&#39;#cccccc&#39;</span><span> } }</span></span>
<span><span>]</span></span></code></pre></div>
<p>An example of Quill&#39;s Delta format</p>
<p>However, it cannot handle cases with multiple values assigned to the same key. So, it&#39;s a headache to handle the styles that support overlapping.</p>
<p><img loading="lazy" width="1139" height="287" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Foverlap_comments.6dc9c59f.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Foverlap_comments.6dc9c59f.png&amp;w=3840&amp;q=75 2x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Foverlap_comments.6dc9c59f.png&amp;w=3840&amp;q=75"/></p>
<p>For example, in the above case, the text &#34;fox&#34; is commented on by both Alice and Bob. We can&#39;t represent it with Quill&#39;s Delta format directly.
So the possible workaround includes:</p>
<p><strong>Turn the attribute value into a list</strong></p>
<div><pre data-language="ts" data-theme="default"><code dir="ltr" data-language="ts" data-theme="default"><span><span>[</span></span>
<span><span>  { insert</span><span>:</span><span> </span><span>&#34;The &#34;</span><span>,</span><span> attributes</span><span>:</span><span> { comment</span><span>:</span><span> [{ </span><span>...</span><span>commentA }] } }</span><span>,</span></span>
<span><span>  {</span></span>
<span><span>    insert</span><span>:</span><span> </span><span>&#34;fox&#34;</span><span>,</span></span>
<span><span>    attributes</span><span>:</span><span> { comment</span><span>:</span><span> [{ </span><span>...</span><span>commentA }</span><span>,</span><span> { </span><span>...</span><span>commentB }] }</span><span>,</span></span>
<span><span>  }</span><span>,</span></span>
<span><span>  { insert</span><span>:</span><span> </span><span>&#34; jumped&#34;</span><span>,</span><span> attributes</span><span>:</span><span> { comment</span><span>:</span><span> [{ </span><span>...</span><span>commentB }] } }</span><span>,</span></span>
<span><span>]</span></span></code></pre></div>
<p><strong>Use op ID that creates the op as the key of the attribute</strong></p>
<div><pre data-language="ts" data-theme="default"><code dir="ltr" data-language="ts" data-theme="default"><span><span>[</span></span>
<span><span>  { insert</span><span>:</span><span> </span><span>&#34;The &#34;</span><span>,</span><span> attributes</span><span>:</span><span> { </span><span>&#34;id:0@A&#34;</span><span>:</span><span> { key</span><span>:</span><span> </span><span>&#34;comment&#34;</span><span>,</span><span> </span><span>...</span><span>commentA } } }</span><span>,</span></span>
<span><span>  {</span></span>
<span><span>    insert</span><span>:</span><span> </span><span>&#34;fox&#34;</span><span>,</span></span>
<span><span>    attributes</span><span>:</span><span> {</span></span>
<span><span>      </span><span>&#34;id:0@A&#34;</span><span>:</span><span> { key</span><span>:</span><span> </span><span>&#34;comment&#34;</span><span>,</span><span> </span><span>...</span><span>commentA }</span><span>,</span></span>
<span><span>      </span><span>&#34;id:0@B&#34;</span><span>:</span><span> { key</span><span>:</span><span> </span><span>&#34;comment&#34;</span><span>,</span><span> </span><span>...</span><span>commentB }</span><span>,</span></span>
<span><span>    }</span><span>,</span></span>
<span><span>  }</span><span>,</span></span>
<span><span>  {</span></span>
<span><span>    insert</span><span>:</span><span> </span><span>&#34; jumped&#34;</span><span>,</span></span>
<span><span>    attributes</span><span>:</span><span> { </span><span>&#34;id:0@B&#34;</span><span>:</span><span> { key</span><span>:</span><span> </span><span>&#34;comment&#34;</span><span>,</span><span> </span><span>...</span><span>commentA } }</span><span>,</span></span>
<span><span>  }</span><span>,</span></span>
<span><span>]</span></span></code></pre></div>
<p>But both require special behaviors for both CRDT lib and for application code, which are painful to work with.</p>
<p>Finally, we found that the optimal approach to represent an overlappable style was to use <code dir="ltr">&lt;key&gt;:</code> as a prefix and allow users to assign a unique suffix to create a distinct style key.
This method simplifies the CRDTs library code, as it doesn&#39;t require handling special cases.
It effectively addresses scenarios where multiple comments overlap and is also user-friendly for application coding.</p>
<div><pre data-language="ts" data-theme="default"><code dir="ltr" data-language="ts" data-theme="default"><span><span>[</span></span>
<span><span>	{ insert</span><span>:</span><span> </span><span>&#34;The &#34;</span><span>,</span><span> attributes</span><span>:</span><span> { </span><span>&#34;comment:alice&#34;</span><span>:</span><span> </span><span>&#34;Hi&#34;</span><span> } }</span><span>,</span></span>
<span><span>	{</span></span>
<span><span>		insert</span><span>:</span><span> </span><span>&#34;fox&#34;</span><span>,</span></span>
<span><span>		attributes</span><span>:</span><span> { </span><span>&#34;comment:alice&#34;</span><span>:</span><span> </span><span>&#34;Hi&#34;</span><span>,</span><span> </span><span>&#34;comment:bob&#34;</span><span>:</span><span> </span><span>&#34;Jump&#34;</span><span> }</span><span>,</span></span>
<span><span>	}</span><span>,</span></span>
<span><span>	{ insert</span><span>:</span><span> </span><span>&#34; jumped&#34;</span><span>,</span><span> attributes</span><span>:</span><span> { </span><span>&#34;comment:bob&#34;</span><span>:</span><span> </span><span>&#34;Jump&#34;</span><span> } }</span><span>,</span></span>
<span><span>]</span></span></code></pre></div>
<p>Following is the example code in Loro:</p>
<div><pre data-language="ts" data-theme="default"><code dir="ltr" data-language="ts" data-theme="default"><span><span>const</span><span> </span><span>doc</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Loro</span><span>();</span></span>
<span><span>doc</span><span>.configTextStyle</span><span>({</span></span>
<span><span>	comment</span><span>:</span><span> { expand</span><span>:</span><span> </span><span>&#34;none&#34;</span><span>,</span><span> }</span></span>
<span><span>})</span></span>
<span><span>const</span><span> </span><span>text</span><span> </span><span>=</span><span> </span><span>doc</span><span>.getText</span><span>(</span><span>&#34;text&#34;</span><span>);</span></span>
<span><span>text</span><span>.insert</span><span>(</span><span>0</span><span>,</span><span> </span><span>&#34;The fox jumped.&#34;</span><span>);</span></span>
<span><span>text</span><span>.mark</span><span>({ start</span><span>:</span><span> </span><span>0</span><span>,</span><span> end</span><span>:</span><span> </span><span>7</span><span> }</span><span>,</span><span> </span><span>&#34;comment:alice&#34;</span><span>,</span><span> </span><span>&#34;Hi&#34;</span><span>);</span></span>
<span><span>text</span><span>.mark</span><span>({ start</span><span>:</span><span> </span><span>4</span><span>,</span><span> end</span><span>:</span><span> </span><span>14</span><span> }</span><span>,</span><span> </span><span>&#34;comment:bob&#34;</span><span>,</span><span> </span><span>&#34;Jump&#34;</span><span>);</span></span>
<span><span>expect</span><span>(</span><span>text</span><span>.toDelta</span><span>())</span><span>.toStrictEqual</span><span>([</span></span>
<span><span>	{</span></span>
<span><span>		insert</span><span>:</span><span> </span><span>&#34;The &#34;</span><span>,</span><span> attributes</span><span>:</span><span> { </span><span>&#34;comment:alice&#34;</span><span>:</span><span> </span><span>&#34;Hi&#34;</span><span> }</span><span>,</span></span>
<span><span>	}</span><span>,</span></span>
<span><span>	{</span></span>
<span><span>		insert</span><span>:</span><span> </span><span>&#34;fox&#34;</span><span>,</span><span> </span></span>
<span><span>		attributes</span><span>:</span><span> { </span></span>
<span><span>			</span><span>&#34;comment:alice&#34;</span><span>:</span><span> </span><span>&#34;Hi&#34;</span><span>,</span><span> </span></span>
<span><span>			</span><span>&#34;comment:bob&#34;</span><span>:</span><span> </span><span>&#34;Jump&#34;</span><span> </span></span>
<span><span>		}</span><span>,</span></span>
<span><span>	}</span><span>,</span></span>
<span><span>	{</span></span>
<span><span>		insert</span><span>:</span><span> </span><span>&#34; jumped&#34;</span><span>,</span><span> attributes</span><span>:</span><span> { </span><span>&#34;comment:bob&#34;</span><span>:</span><span> </span><span>&#34;Jump&#34;</span><span> }</span><span>,</span></span>
<span><span>	}</span><span>,</span></span>
<span><span>	{</span></span>
<span><span>		insert</span><span>:</span><span> </span><span>&#34;.&#34;</span><span>,</span></span>
<span><span>	}</span></span>
<span><span>])</span></span></code></pre></div>
<h2>Implementation of Loro&#39;s Rich Text Algorithm<a href="#implementation-of-loros-rich-text-algorithm" id="implementation-of-loros-rich-text-algorithm" aria-label="Permalink for this section"></a></h2>
<p>The following is an overview of Loro&#39;s implementation as of January, 2024.</p>
<h3>Architecture of Loro<a href="#architecture-of-loro" id="architecture-of-loro" aria-label="Permalink for this section"></a></h3>
<p>In line with the properties of Replayable Event Graph, Loro uses <code dir="ltr">OpLog</code> and <code dir="ltr">DocState</code> as the internal state.</p>
<p><code dir="ltr">OpLog</code> is dedicated to recording history, while <code dir="ltr">DocState</code> only records the current document state and does not include historical operation information. When applying updates from remote sources, Loro uses the relevant operations from <code dir="ltr">OpLog</code> and computes the diff through a <code dir="ltr">DiffCalculator</code>. This diff is then applied to <code dir="ltr">DocState</code>. This architecture also makes time travel easier to implement.</p>
<p>For more details, see the documentation on <a href="https://loro.dev/docs/advanced/doc_state_and_oplog" target="_blank" rel="noreferrer">DocState and OpLog<span> (opens in a new tab)</span></a>.</p>
<p><img loading="lazy" width="1217" height="1427" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fapply_updates.63c697d6.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fapply_updates.63c697d6.png&amp;w=3840&amp;q=75 2x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fapply_updates.63c697d6.png&amp;w=3840&amp;q=75"/></p>
<h3>Implementation of Loro&#39;s Rich Text CRDT<a href="#implementation-of-loros-rich-text-crdt" id="implementation-of-loros-rich-text-crdt" aria-label="Permalink for this section"></a></h3>
<p>For rich text, Loro reuses the same <code dir="ltr">DiffCalculator</code> as Loro List, based on the <a href="https://arxiv.org/abs/2305.00583" target="_blank" rel="noreferrer">Fugue<span> (opens in a new tab)</span></a> algorithm. As a result, the primary logic related to rich text is concentrated in <code dir="ltr">DocState</code>. This includes expressing styles, inserting new characters, and representing multiple index formats.</p>
<p>In the representation of rich text state, we distinguish between the data structure <code dir="ltr">ContentTree</code>, which expresses the text (including style anchors), and <code dir="ltr">StyleRangeMap</code>, which expresses styles.</p>
<p><img loading="lazy" width="2112" height="1975" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Ftext_state_arch.0364d666.png&amp;w=3840&amp;q=75 1x" src="https://riskmusings.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Ftext_state_arch.0364d666.png&amp;w=3840&amp;q=75"/></p>
<p>Both structures are built on B+Trees.</p>
<p><code dir="ltr">ContentTree</code> is responsible for efficient text finding, insertion, and deletion. It can index specific insertion/deletion positions using Unicode/UTF-8/UTF-16/Entity index. It does not store what specific style each text segment should have.</p>
<p>We built the following B+Tree structure based on our <a href="https://github.com/loro-dev/generic-btree" target="_blank" rel="noreferrer">generic-btree library<span> (opens in a new tab)</span></a> to express text in memory:</p>
<ul>
<li>Each internal node in the B+Tree stores the Unicode char length, UTF-16 length, UTF-8 length, and Entity length of its subtree. The Entity length considers the length of style anchors as 1, otherwise 0.</li>
<li>The leaf nodes of the B+Tree are text or style anchors.</li>
</ul>
<p><code dir="ltr">StyleRangeMap</code> is responsible for efficient updating/querying of style ranges.</p>
<p>In the <code dir="ltr">StyleRangeMap</code> B+Tree expressing styles:</p>
<ul>
<li>Each internal node stores the <code dir="ltr">entity length</code> of its subtree.</li>
<li>Each leaf node stores the collection of style information for the corresponding range and its `entity length.</li>
</ul>
<p>Separating the text <code dir="ltr">ContentTree</code> and style <code dir="ltr">StyleRangeMap</code> into two structures aims for better performance optimization. On rich text, style information is often not abundant and tends to have good continuity, such as several paragraphs having the same format, which can be expressed with a single leaf node. However, our structure for storing text is unsuitable for leaf nodes with large content, as conversion time between different encoding formats would become excessively long.</p>
<p>When a user inserts a new character at <code dir="ltr">Unicode index</code> = i, the following occurs:</p>
<ul>
<li>Find the position at <code dir="ltr">Unicode index</code> = i in <code dir="ltr">ContentTree</code>.</li>
<li>Check if there are any adjacent style anchors at this position. If not, directly insert.</li>
<li>If there are, decide whether to insert to the left or right of the corresponding style anchor based on its type and properties. If there are multiple such style anchors, insert them according to the previous section on <a href="https://riskmusings.substack.com/blog/loro-richtext#behavior-when-inserting-text-at-style-boundaries">&#34;Behavior When Inserting Text at Style Boundaries&#34;</a>.</li>
</ul>
<h3>Testing<a href="#testing" id="testing" aria-label="Permalink for this section"></a></h3>
<p>We have written tests for the criteria proposed by Peritext and passed all of them.</p>
<p>To ensure the correctness of our CRDTs, we have added numerous fuzzing tests to simulate different collaborative behaviors, synchronization behaviors, and time-travel behaviors. These tests check for the strong eventual consistency and the correctness of internal invariants. We run these fuzzing tests continuously for several days after every critical modification to avoid oversights.</p>
<h2>How to Use<a href="#how-to-use" id="how-to-use" aria-label="Permalink for this section"></a></h2>
<p>Before using the Loro&#39;s rich text module, it is necessary to define the configuration for rich text styles, specifying the expand behavior for different keys and whether overlap is allowed.</p>
<p>Here is an example of using Loro&#39;s rich text in JavaScript:</p>
<div><pre data-language="typescript" data-theme="default"><code dir="ltr" data-language="typescript" data-theme="default"><span><span>const</span><span> </span><span>doc</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Loro</span><span>();</span></span>
<span><span>doc</span><span>.configTextStyle</span><span>({</span></span>
<span><span>	bold</span><span>:</span><span> {</span></span>
<span><span>		expand</span><span>:</span><span> </span><span>&#34;after&#34;</span><span>,</span></span>
<span><span>	}</span><span>,</span></span>
<span><span>	comment</span><span>:</span><span> {</span></span>
<span><span>		expand</span><span>:</span><span> </span><span>&#34;none&#34;</span><span>,</span></span>
<span><span>		overlap</span><span>:</span><span> </span><span>true</span></span>
<span><span>	}</span><span>,</span></span>
<span><span>	link</span><span>:</span><span> {</span></span>
<span><span>		expand</span><span>:</span><span> </span><span>&#34;none&#34;</span></span>
<span><span>	}</span></span>
<span><span>});</span></span>
<span> </span>
<span><span>const</span><span> </span><span>text</span><span> </span><span>=</span><span> </span><span>doc</span><span>.getText</span><span>(</span><span>&#34;text&#34;</span><span>);</span></span>
<span><span>text</span><span>.insert</span><span>(</span><span>0</span><span>,</span><span> </span><span>&#34;Hello world!&#34;</span><span>);</span></span>
<span><span>text</span><span>.mark</span><span>({ start</span><span>:</span><span> </span><span>0</span><span>,</span><span> end</span><span>:</span><span> </span><span>5</span><span> }</span><span>,</span><span> </span><span>&#34;bold&#34;</span><span>,</span><span> </span><span>true</span><span>);</span></span>
<span><span>expect</span><span>(</span><span>text</span><span>.toDelta</span><span>())</span><span>.toStrictEqual</span><span>([</span></span>
<span><span>	{</span></span>
<span><span>		insert</span><span>:</span><span> </span><span>&#34;Hello&#34;</span><span>,</span></span>
<span><span>		attributes</span><span>:</span><span> { bold</span><span>:</span><span> </span><span>true</span><span> }</span><span>,</span></span>
<span><span>	}</span><span>,</span><span> </span></span>
<span><span>	{</span></span>
<span><span>		insert</span><span>:</span><span> </span><span>&#34; world!&#34;</span><span>,</span></span>
<span><span>	}</span></span>
<span><span>] </span><span>as</span><span> </span><span>Delta</span><span>&lt;</span><span>string</span><span>&gt;[]);</span></span>
<span> </span>
<span><span>text</span><span>.insert</span><span>(</span><span>5</span><span>,</span><span> </span><span>&#34;!&#34;</span><span>);</span></span>
<span><span>expect</span><span>(</span><span>text</span><span>.toDelta</span><span>())</span><span>.toStrictEqual</span><span>([</span></span>
<span><span>	{</span></span>
<span><span>	    insert</span><span>:</span><span> </span><span>&#34;Hello!&#34;</span><span>,</span></span>
<span><span>	    attributes</span><span>:</span><span> { bold</span><span>:</span><span> </span><span>true</span><span> }</span><span>,</span></span>
<span><span>	}</span><span>,</span><span> {</span></span>
<span><span>	    insert</span><span>:</span><span> </span><span>&#34; world!&#34;</span><span>,</span></span>
<span><span>	}</span></span>
<span><span>] </span><span>as</span><span> </span><span>Delta</span><span>&lt;</span><span>string</span><span>&gt;[]);</span></span></code></pre></div>
<h2>Summary<a href="#summary" id="summary" aria-label="Permalink for this section"></a></h2>
<p>This article presents Loro&#39;s rich text algorithm design and implementation. Its correctness is readily demonstrable. It can be built upon any existing List CRDT algorithm. It allows Loro to support rich text collaboration using <a href="https://riskmusings.substack.com/blog/loro-richtext#brief-introduction-to-replayable-event-graph">REG</a> and <a href="https://arxiv.org/abs/2305.00583" target="_blank" rel="noreferrer">Fugue<span> (opens in a new tab)</span></a>, combining the strengths of multiple CRDT algorithms.</p>
<p>We are continuously refining its design and actively seeking design partners. We are open to all forms of feedback and constructive criticism. Should you have any proposals for collaboration, please reach out to <a href="mailto:zx@loro.dev">zx@loro.dev</a></p></main></article></div>
  </body>
</html>
