<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/caddyserver/caddy/pull/4707">Original</a>
    <h1>Caddyhttp: Enable HTTP/3 by Default</h1>
    
    <div id="readability-page-1" class="page"><div disabled="" sortable="">
<div>
          <p dir="auto">I&#39;ve pushed a commit that polishes this feature a bit more:</p>
<ul dir="auto">
<li>Deprecate the <code>server { protocol</code> sub-option in global options, including <code>allow_h2c</code> and <code>strict_sni_host</code>.</li>
<li>Move <code>strict_sni_host</code> to sub-option of <code>server</code></li>
<li>Add <code>server { protocols</code> sub-option, which allows setting which HTTP versions to enable: <code>h1 h2 h2c h3</code> are allowed values.</li>
</ul>
<p dir="auto">This lets the user toggle precisely which HTTP versions they want to support, including HTTP/3-only, which is currently our oldest open issue: <a data-error-text="Failed to load title" data-id="223939558" data-permission-text="Title is private" data-url="https://github.com/caddyserver/caddy/issues/1614" data-hovercard-type="issue" data-hovercard-url="/caddyserver/caddy/issues/1614/hovercard" href="https://github.com/caddyserver/caddy/issues/1614">#1614</a>. (Yay!)</p>
<p dir="auto">Because the Go standard library does not let us disable HTTP/1.1, we would <a href="https://stackoverflow.com/questions/51521141/how-to-completely-disable-http-1-x-support" rel="nofollow">probably have to implement our own server</a> to support <em>only</em> HTTP/2 (or h2c) without HTTP/1.1 fallback. I actually tried it:</p>
<div data-snippet-clipboard-copy-content="// http2Server is a server that speaks only HTTP/2.
type http2Server struct {
	h1server *http.Server
	server   *http2.Server
	handler  http.Handler
	logger   *zap.Logger
}

func (h2 http2Server) Serve(ln net.Listener) error {
	h2.server = new(http2.Server)
	opts := &amp;http2.ServeConnOpts{
		BaseConfig: h2.h1server,
		Handler:    h2.handler,
	}
	for {
		conn, err := ln.Accept()
		if err != nil {
			return err
		}
		go h2.serve(conn, opts)
	}
}

func (h2 http2Server) serve(conn net.Conn, opts *http2.ServeConnOpts) {
	defer func() {
		if r := recover(); r != nil {
			buf := make([]byte, 64&lt;&lt;10)
			buf = buf[:runtime.Stack(buf, false)]
			h2.logger.Error(&#34;panic&#34;,
				zap.String(&#34;remote&#34;, conn.RemoteAddr().String()),
				zap.Any(&#34;error&#34;, r),
				zap.String(&#34;stack&#34;, string(buf)))
		}
	}()
	defer conn.Close()
	h2.server.ServeConn(conn, opts)
}"><pre><span>// http2Server is a server that speaks only HTTP/2.</span>
<span>type</span> <span>http2Server</span> <span>struct</span> {
	<span>h1server</span> <span>*</span>http.<span>Server</span>
	<span>server</span>   <span>*</span>http2.<span>Server</span>
	<span>handler</span>  http.<span>Handler</span>
	<span>logger</span>   <span>*</span>zap.<span>Logger</span>
}

<span>func</span> (<span>h2</span> <span>http2Server</span>) <span>Serve</span>(<span>ln</span> net.<span>Listener</span>) <span>error</span> {
	<span>h2</span>.<span>server</span> <span>=</span> <span>new</span>(http2.<span>Server</span>)
	<span>opts</span> <span>:=</span> <span>&amp;</span>http2.<span>ServeConnOpts</span>{
		<span>BaseConfig</span>: <span>h2</span>.<span>h1server</span>,
		<span>Handler</span>:    <span>h2</span>.<span>handler</span>,
	}
	<span>for</span> {
		<span>conn</span>, <span>err</span> <span>:=</span> <span>ln</span>.<span>Accept</span>()
		<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
			<span>return</span> <span>err</span>
		}
		<span>go</span> <span>h2</span>.<span>serve</span>(<span>conn</span>, <span>opts</span>)
	}
}

<span>func</span> (<span>h2</span> <span>http2Server</span>) <span>serve</span>(<span>conn</span> net.<span>Conn</span>, <span>opts</span> <span>*</span>http2.<span>ServeConnOpts</span>) {
	<span>defer</span> <span>func</span>() {
		<span>if</span> <span>r</span> <span>:=</span> <span>recover</span>(); <span>r</span> <span>!=</span> <span>nil</span> {
			<span>buf</span> <span>:=</span> <span>make</span>([]<span>byte</span>, <span>64</span><span>&lt;&lt;</span><span>10</span>)
			<span>buf</span> <span>=</span> <span>buf</span>[:<span>runtime</span>.<span>Stack</span>(<span>buf</span>, <span>false</span>)]
			<span>h2</span>.<span>logger</span>.<span>Error</span>(<span>&#34;panic&#34;</span>,
				<span>zap</span>.<span>String</span>(<span>&#34;remote&#34;</span>, <span>conn</span>.<span>RemoteAddr</span>().<span>String</span>()),
				<span>zap</span>.<span>Any</span>(<span>&#34;error&#34;</span>, <span>r</span>),
				<span>zap</span>.<span>String</span>(<span>&#34;stack&#34;</span>, <span>string</span>(<span>buf</span>)))
		}
	}()
	<span>defer</span> <span>conn</span>.<span>Close</span>()
	<span>h2</span>.<span>server</span>.<span>ServeConn</span>(<span>conn</span>, <span>opts</span>)
}</pre></div>
<p dir="auto">but I could not get it to work. Curl complained, <code>curl: (1) Received HTTP/0.9 when not allowed</code> - which I don&#39;t understand, but I didn&#39;t spend much time looking into why. Anyway, this seems like a huge maintenance burden &amp; undertaking, so I decided to not support HTTP/2-only servers for now. However, HTTP/1-only and HTTP/3-only configurations work fine!</p>
<p dir="auto">This means HTTP/3 can be disabled, and we&#39;ve made protocol configuration easy and consistent.</p>
<hr/>
<p dir="auto"><strong>In summary:</strong> I believe have finished this feature, all except for the AcceptToken tweak mentioned above. (I would still like <code>quic.defaultAcceptToken()</code> either exported or always called even if we set our own. /cc <a data-hovercard-type="user" data-hovercard-url="/users/marten-seemann/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/marten-seemann">@marten-seemann</a> <g-emoji alias="smiley" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f603.png">ðŸ˜ƒ</g-emoji>)</p>
<p dir="auto">Once that is taken care of, I think we can merge this and ship Caddy with HTTP/3 enabled by default.</p>
      </div>
</div></div>
  </body>
</html>
