<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://securitylabs.datadoghq.com/articles/malicious-pypi-package-fastapi-toolkit/">Original</a>
    <h1>Investigating a backdoored PyPI package targeting FastAPI applications</h1>
    
    <div id="readability-page-1" class="page"><div>
        <h2 id="introduction" tabindex="-1">Introduction</h2>
<p>FastAPI is a highly popular Python web framework. On November 23rd, 2022, the Datadog Security Labs team identified a third-party utility Python package on PyPI related to FastAPI, <code>fastapi-toolkit</code>, that has likely been compromised by a malicious actor. The attacker inserted a backdoor in the package, adding a FastAPI route allowing a remote attacker to execute arbitrary python code and SQL queries in the context of the web application.</p>
<p>While FastAPI itself is <em>not impacted</em>, this is an interesting occurrence of an attacker attempting to deploy a FastAPI-specific backdoor.</p>
<h2 id="key-points-and-observations" tabindex="-1">Key points and observations</h2>
<ul>
<li><code>fastapi-toolkit</code> was first published on PyPi on March 21, 2022. There likely was no malicious intent with the initial and subsequent versions of the package.</li>
<li>On November 23, 2022, at 07:33 UTC, a malicious commit with a backdoor (<a href="https://archive.ph/9UAsw">2cd2223</a>) was pushed to the GitHub repository. Shortly after, at 07:35 UTC, the malicious version of the package was uploaded to PyPI.</li>
<li>We identified this malicious package on November 23 using our latest open source tool, <a href="https://securitylabs.datadoghq.com/articles/guarddog-identify-malicious-pypi-packages/">GuardDog</a>, which uses heuristics to identify malicious or compromised PyPI packages.</li>
<li>We reported the malicious PyPI package to the PyPI team, as well as the malicious GitHub commit to GitHub.</li>
</ul>
<h2 id="discovery-and-analysis" tabindex="-1">Discovery and analysis</h2>
<p>We recently released <a href="https://securitylabs.datadoghq.com/articles/guarddog-identify-malicious-pypi-packages/">GuardDog</a>, a free and open-source tool to identify malicious PyPI packages. We use it to identify, analyze, and help take down malicious packages.</p>
<p>On November 23, we identified that the package <code>fastapi-toolkit</code> was likely malicious.</p>
<center>
<figure>
        <img src="https://securitylabs.datadoghq.com/assets/img/malicious-pypi-package-fastapi-toolkit/guarddog.png" alt="Scanning fastapi-toolkit with GuardDog" loading="lazy"/>
        <figcaption>Scanning fastapi-toolkit with GuardDog</figcaption>
      </figure>
</center>
<p>Upon investigation, we determined that <code>fastapi-toolkit</code> used to be a legitimate package. At 7:33 UTC on November 23, a backdoor was introduced through commit <a href="https://archive.ph/9UAsw">2cd2223</a>.</p>
<center>
<figure>
        <img src="https://securitylabs.datadoghq.com/assets/img/malicious-pypi-package-fastapi-toolkit/github.png" alt="The malicious commit" loading="lazy"/>
        <figcaption>The malicious commit</figcaption>
      </figure>
</center>
<p>In addition to bumping the package version from 0.0.26 to 0.0.27, the new code dynamically executes Base64-encoded code whenever the package is used.</p>
<pre><code>commit 2cd2223dcd90fa9d9c72851427602aa0e179e061</code></pre>
<p>Decoding the Base64-encoded code shows that the backdoor adds a FastAPI HTTP route that allows the attacker to execute arbitrary Python code or SQL queries whenever the application receives an HTTP request with a specific header.</p>
<pre><code></code></pre>
<p>The functions <code>__run_python</code> and <code>__run_sql</code> execute arbitrary Python code and an arbitrary SQL query, respectively, provided in the HTTP POST request body.</p>
<pre><code><span>async</span> <span>def</span> <span>__run_python</span><span>(</span>body<span>:</span> <span>str</span><span>)</span><span>:</span></code></pre>
<pre><code><span>async</span> <span>def</span> <span>__run_sql</span><span>(</span>body<span>:</span> <span>str</span><span>)</span><span>:</span></code></pre>
<p>Once an attacker has compromised an application, they can trigger the backdoor by sending an HTTP request similar to:</p>
<pre><code></code></pre>
<h2 id="root-cause-and-response" tabindex="-1">Root cause and response</h2>
<p>It is possible the original developer of the package had their account compromised and used by a malicious actor. We promptly warned them of the issue so they could take necessary actions on their side, such as resetting their GitHub and PyPI credentials. It is also possible that the user knowingly uploaded a backdoor.</p>
<p>We also promptly reported the malicious package to the PyPI team to ensure it gets taken down.</p>
<p>At the time of writing, this package was the only one published by the developer&#39;s account on PyPI, and their GitHub account did not have any other recent commit. We can make sure of that by using the GitHub API to identify recent events of the account:</p>
<pre><code><span>curl</span> <span>-s</span> <span>-H</span> <span>&#34;Accept: application/vnd.github+json&#34;</span> <span>\</span></code></pre>
<pre><code><span>[</span></code></pre>
<h3 id="how-to-know-if-you&#39;re-affected" tabindex="-1">How to know if you&#39;re affected</h3>
<p>To determine if you’re impacted, you first need to identify if the package <code>fastapi-toolkit</code> in version 0.0.27 is present on your system. To do so, you can run the command:</p>
<pre><code>pip list <span>|</span> <span>grep</span> fastapi-toolkit</code></pre>
<p>If the package is available on the system or in the current virtual environment, the output will look like:</p>
<pre><code>fastapi-toolkit    <span>0.0</span>.27</code></pre>
<p>This will tell you the current version of <code>fastapi-toolkit</code>—in this case, it is 0.0.27, the backdoored version.</p>
<h3 id="what-to-do-if-you&#39;re-affected" tabindex="-1">What to do if you&#39;re affected</h3>
<p>If your application is running the <code>fastapi-toolkit</code> package, we recommend you consider it compromised and take the following steps:</p>
<ul>
<li>Remove the <code>fastapi-toolkit</code> dependency.</li>
<li>Review your web server logs to identify if an attacker has triggered the backdoor through a <code>POST</code> request to <code>/</code>.</li>
<li>If you are monitoring process activity, review any instance of <code>python</code> spawning child processes, as this could indicate usage of the backdoor.</li>
</ul>
<h2 id="how-datadog-can-help" tabindex="-1">How Datadog can help</h2>
<p><a href="https://www.datadoghq.com/product/cloud-security-management/application-security-management/">Datadog ASM</a> Vulnerability Monitoring, <a href="https://www.datadoghq.com/blog/dash-2022-new-feature-roundup/#cloud-and-application-security">announced</a> earlier this year at Dash, allows you to identify vulnerable and malicious packages used by your applications at runtime. It is currently in private beta. You can request access to the private beta <a href="https://docs.google.com/forms/d/e/1FAIpQLScB3uSccf9lSAh7GcA8NZ8SsmUGQ5mi09DnDgZmqXcbiYfMzA/viewform">here</a>.</p>
<p>In addition, Datadog <a href="https://docs.datadoghq.com/security_platform/cloud_workload_security/">Cloud Workload Security</a> has a number of out-of-the-box rules to detect post exploitation scenarios, including <a href="https://docs.datadoghq.com/security_platform/default_rules/interactive_shell_in_container/">Interactive shell spawned in container</a>.</p>
<h2 id="conclusion" tabindex="-1">Conclusion</h2>
<p>In this post, we analyzed a package whose maintainer&#39;s account was likely compromised by a malicious actor and leveraged to insert a backdoor specific to FastAPI.</p>
<p>You can download the full source code of the malicious package on <a href="https://github.com/DataDog/security-labs-pocs/blob/main/malware-samples/pypi/2022-11-23-fastapi-toolkit.zip">our GitHub repository</a>.</p>

        </div></div>
  </body>
</html>
