<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://novamostra.com/2022/10/23/byopm/">Original</a>
    <h1>Bring Your Own Password Manager: Portable BitWarden on a Pi Zero</h1>
    
    <div id="readability-page-1" class="page"><article id="post-2064">
	
	<!-- .entry-header -->

	<div>
		<p><img src="https://i0.wp.com/novamostra.com/wp-content/uploads/2022/10/byopm.jpg?w=660&amp;ssl=1" alt="BYOPM" data-recalc-dims="1" data-lazy-src="https://i0.wp.com/novamostra.com/wp-content/uploads/2022/10/byopm.jpg?w=660&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></p>
<p>BYOPM is a portable Password Manager implementation based on <a href="https://bitwarden.com/">BitWarden</a> and a Raspberry PI Zero. It’s a self hosted solution, with full functionality, which is activated by just plugging the device on your computer. Bitwarden’s Official browser addons and extensions are also supported, and the device has been tested both on Windows (10 and 11) and Linux (Debian Based).</p>

<h2>How it works</h2>
<p>Plug BYOPM to your computer using a micro usb cable, after about a minute a new network device will be automatically created and appear as connected. BYOPM hosts a Bitwarden instance which is required for managing your passwords and also emulates an ethernet network interface card in order to be accessible from your computer without any configuration. Bitwarden is accessbible using your browser at <a href="https://byopm.local">https://byopm.local</a>.</p>
<h2>Bill of Materials</h2>
<p>1) Raspberry Pi Zero (Any version will be OK, but if you want to print the official BYOPM case avoid the H versions which include the 2.54mm pin header)</p>
<h2>Schematic</h2>
<p><img src="https://i0.wp.com/novamostra.com/wp-content/uploads/2022/10/byopm_schematic.jpg?w=660&amp;ssl=1" alt="byopm schematic" data-recalc-dims="1" data-lazy-src="https://i0.wp.com/novamostra.com/wp-content/uploads/2022/10/byopm_schematic.jpg?w=660&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></p>
<p>Pay special attention when soldering the tactile switch to the board. It must be  aligned with top cover’s hole and you must remove all the excess of soldering material from the bottom side of the Raspberry board.</p>
<p><img src="https://i0.wp.com/novamostra.com/wp-content/uploads/2022/10/power_button.jpg?w=660&amp;ssl=1" alt="Raspi Power Switch" data-recalc-dims="1" data-lazy-src="https://i0.wp.com/novamostra.com/wp-content/uploads/2022/10/power_button.jpg?w=660&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></p>
<h2>Preparation</h2>
<p>The following steps executed on a Raspberry PI Zero W Rev. 1.1 (Model: 9000c1), running the official Raspberry OS Lite released on <a href="https://downloads.raspberrypi.org/raspios_lite_armhf/images/raspios_lite_armhf-2022-09-26/2022-09-22-raspios-bullseye-armhf-lite.img.xz">September 22nd 2022</a> ( 32-bit system, Debian 11, Kernel version: 5.15).</p>
<h3>SD-Card preparation</h3>
<p>Using the official <a href="https://www.raspberrypi.com/software/">Raspberry PI Imager</a> tool configure your SD Card as follows:</p>
<ol>
<li>
<p>Click on <strong>CHOOSE OS</strong></p>
</li>
<li>
<p>Select the 32 bit Image of Raspberry PI OS</p>
</li>
<li>
<p>Connect your SD Card to your Computer, using a card reader or a USB adapter and click on <strong>CHOOSE STORAGE</strong></p>
</li>
<li>
<p>Select your SD CARD (<strong>WARNING</strong>: Make sure that the storage you selected is indeed your Raspberry PI’s SD Card to avoid any unwanted data loss)</p>
</li>
<li>
<p>Click on the <strong>GEAR Button</strong> located bottom right.</p>
</li>
<li>
<p>Type <strong>byopm</strong> as hostname, enable SSH, set your own username and password and configure your wireless LAN (you can skip Wi-Fi configuration if you will configure the device using the Serial Console).</p>
</li>
<li>
<p>Save your configuration and click the <strong>WRITE</strong> button.</p>
</li>
<li>
<p>When your SD Card is ready the following message will appear.</p>
</li>
<li>
<p>Finally, click <strong>CONTINUE</strong>, remove the SD card from your computer and re-plug it to appear as a USB Removable Storage.</p>
</li>
<li>
<p>Navigate to the Removable Storage and edit the config.txt file:</p>
</li>
<li>
<p>Append the following commands to enable the ShutDown Button functionality and the Serial Console [optional] (It is recommended to enable the Serial Console as a redundant communication link):</p>
<pre><code>enable_uart=1
dtoverlay=gpio-shutdown</code></pre>
</li>
<li>
<p>Save the file and safely remove your SD Card.</p>
</li>
</ol>
<h3>Initial Raspberry PI Configuration</h3>
<p>Place your SD card back to the Raspberry PI and plug the power cable. Establish a terminal connection to your Raspberry either <a href="https://www.raspberrypi.com/documentation/computers/remote-access.html#introduction-to-remote-access">using SSH</a> (use byopm.local as hostname) or Serial Console.After establishing the connection and logging in:</p>
<h4>Update your distribution using the commands :</h4>
<pre><code>sudo apt update
sudo apt upgrade</code></pre>
<h4>Install dnsmasq and nginx:</h4>
<pre><code>sudo apt install -y dnsmasq nginx</code></pre>
<h4>Install Docker:</h4>
<pre><code>curl -sSL https://get.docker.com | sh</code></pre>
<h4>Add your user to the docker group, <strong>replace your username</strong>:</h4>
<pre><code>sudo usermod -aG docker USERNAME_HERE</code></pre>
<h4>Apply the new group to the user.</h4>
<pre><code>exec su -l USERNAME_HERE</code></pre>
<p>You will be prompted for your password in order to apply the new group.</p>
<h4>Pull the Docker Image of Bitwarden:</h4>
<pre><code>docker pull vaultwarden/server:latest</code></pre>
<h4>Create a self-signed certificate</h4>
<p>This self-signed certificate will last for 730 days and will be stored in the <strong>/etc/ssl/certs/</strong>. The Private key will be store in the <strong>/etc/ssl/private/</strong> directory. While generating the certificate you will be asked to provide some details, pick your country code from <a href="https://www.digicert.com/kb/ssl-certificate-country-codes.htm">this list</a>, skip everything else and type <strong>byopm.local</strong> as Common Name.</p>
<pre><code>sudo openssl req -x509 -nodes -days 730 -newkey rsa:4096 -keyout /etc/ssl/private/nginx-bitwarden.key -out /etc/ssl/certs/nginx-bitwarden.crt</code></pre>
<p><img src="https://i0.wp.com/novamostra.com/wp-content/uploads/2022/10/07.png?w=660&amp;ssl=1" alt="Self Singed Certificate Generation" data-recalc-dims="1" data-lazy-src="https://i0.wp.com/novamostra.com/wp-content/uploads/2022/10/07.png?w=660&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></p>
<h4>Create a Diffie-Helman group</h4>
<p>This is used to help improve the security of your device’s SSL connections and is the most time consuming procedure. Unfortunately due to the low resources of Raspberry PI Zero, this is taking about 20 minutes to complete.</p>
<pre><code>sudo openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048</code></pre>
<h3>Configuring NGINX hosting</h3>
<p>Nginx is the webserver which will host the Bitwarden web interface. It was installed but currently working with the default configuration, a new configuration must created to enable Bitwarden functionality.</p>
<h4>Remove the default nginx configuration</h4>
<pre><code>sudo rm /etc/nginx/sites-enabled/default</code></pre>
<h4>Make a new nginx configuration</h4>
<pre><code>sudo nano /etc/nginx/sites-enabled/bitwarden.conf</code></pre>
<p>with the following content:</p>
<pre><code>server {
    listen 80;
    listen [::]:80;
    server_name byopm.local;
    return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  server_name byopm.local;

  ssl_certificate      /etc/ssl/certs/nginx-bitwarden.crt;   
  ssl_certificate_key  /etc/ssl/private/nginx-bitwarden.key; 

  ssl_dhparam /etc/ssl/certs/dhparam.pem;

  # Send functionality of BW allows up to 100MB
  client_max_body_size 128M;

  location / {
    proxy_pass http://0.0.0.0:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

location /notifications/hub {
    proxy_pass http://0.0.0.0:3012;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection &#34;upgrade&#34;;
  }

  location /notifications/hub/negotiate {
    proxy_pass http://0.0.0.0:8080;
  }
}</code></pre>
<h4>Restart NGINX</h4>
<pre><code>sudo systemctl restart nginx.service</code></pre>
<h3>Configuring BitWarden</h3>
<h4>Generate a random Admin token:</h4>
<p>This token must kept secret as this will let anyone have full access to the Bitwarden server.</p>
<pre><code>openssl rand -base64 48</code></pre>
<h4>Run the Bitwarden Docker container</h4>
<p>Replace your <strong>Admin token</strong> and use the following command to run the Bitwarden Docker container</p>
<pre><code>sudo docker run -d --name bitwarden \
    -e ADMIN_TOKEN=[ADMIN_TOKEN_HERE] \
    --restart=always \
    -v /bw-data/:/data/ \
    -p 127.0.0.1:8080:80 \
    -p 127.0.0.1:3012:3012 \
    vaultwarden/server:latest</code></pre>
<h4>Confirm that the container is running:</h4>
<pre><code>docker ps</code></pre>
<p><img src="https://i0.wp.com/novamostra.com/wp-content/uploads/2022/10/docker-ps.png?resize=660%2C200&amp;ssl=1" alt="Docker PS" data-recalc-dims="1" data-lazy-src="https://i0.wp.com/novamostra.com/wp-content/uploads/2022/10/docker-ps.png?resize=660%2C200&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></p>
<h4>Configure Bitwarden’s web interface</h4>
<ol>
<li>Navigate to <a href="https://byopm.local/admin">https://byopm.local/admin</a>, you will get a warning about the self-signed certificate. This is because browsers only trust certificates from specific authorities which can validate. Self-signed certificates is a workaround to avoid paying, while maintaining a secure connection between server and client.</li>
<li>Click <strong>Advanced</strong></li>
<li>Click <strong>Accept the Risk and continue</strong></li>
<li>Enter the Admin Token you generated before and Click <strong>Enter</strong></li>
<li>At the <strong>General settings</strong> tab make sure that Domain URL is <a href="https://byopm.local">https://byopm.local</a> and click <strong>Save</strong> at the end of the page.</li>
<li>Verify that web interface will indeed use the specific domain by visiting <a href="https://byopm.local/app-id.json">https://byopm.local/app-id.json</a>, and under ids the <a href="https://byopm.local">https://byopm.local</a> exist.</li>
<li>Now navigate to <a href="https://byopm.local">https://byopm.local</a> click on <strong>Create Account</strong> and create a new account.</li>
</ol>
<h3>Configure Raspberry PI to act as a Network Interface Card (Ethernet Gadget)</h3>
<p>Raspberry PI, will act as a Network Interface Card and will also host a DNS Server using dnsmasq. Every time the device connects on a computer, it will automatically create a new Network connection and provide the computer with a specific IP.</p>
<h4>Configure the Network Interface</h4>
<pre><code>sudo nano /etc/network/interfaces</code></pre>
<p>and append</p>
<pre><code>auto lo
iface lo inet loopback

auto usb0
allow-hotplug usb0
iface usb0 inet static
address 10.18.1.19
netmask 255.255.255.0</code></pre>
<h4>Configure the DHCP and DNS Server</h4>
<pre><code>sudo nano /etc/dnsmasq.conf</code></pre>
<p>and append</p>
<pre><code>dhcp-range=10.18.1.20,10.18.1.21,12h

dhcp-option=option:dns-server,10.18.1.19
port=53
domain-needed
bogus-priv
listen-address=127.0.0.1,10.18.1.19
expand-hosts
domain = local
local=/local/</code></pre>
<h4>Replace Server’s IP for proper resolving</h4>
<pre><code>sudo nano /etc/hosts</code></pre>
<p>and replace </p>
<pre><code>127.0.0.1   byopm</code></pre>
<p>with</p>
<pre><code>10.18.1.19  byopm.local byopm</code></pre>
<h4>Configure Raspberry to act as an Ethernet Gadget</h4>
<ol>
<li>
<p>Create the gadget script.</p>
<pre><code>sudo mkdir -p /etc/novamostra
sudo nano /etc/novamostra/gadget.sh</code></pre>
<p>and insert the following content:</p>
<pre><code>#!/bin/bash
#October 2022
#This file is part of BYOPM.
#Copyright (c) novamostra.com
GADGET_DIR=&#34;nm_ether&#34;
VENDOR_ID=&#34;0x1d6b&#34;
PRODUCT_ID=&#34;0x0104&#34;
HOST=&#34;00:dc:c8:f7:75:14&#34;
SELF=&#34;00:dd:dc:eb:6d:a1&#34;
modprobe libcomposite
mkdir -p /sys/kernel/config/usb_gadget/$GADGET_DIR
cd /sys/kernel/config/usb_gadget/$GADGET_DIR
echo $VENDOR_ID &gt; idVendor
echo $PRODUCT_ID &gt; idProduct
echo 0x0100 &gt; bcdDevice
echo 0x0200 &gt; bcdUSB
echo 0xEF &gt; bDeviceClass
echo 0x02 &gt; bDeviceSubClass
echo 0x01 &gt; bDeviceProtocol
mkdir -p strings/0x409 # English language strings
echo &#34;nm_nic_01&#34; &gt; strings/0x409/serialnumber
echo &#34;novamostra&#34; &gt; strings/0x409/manufacturer
echo &#34;byopm&#34; &gt; strings/0x409/product
mkdir -p configs/c.1/strings/0x409
echo &#34;Config 1: RNDIS network&#34; &gt; configs/c.1/strings/0x409/configuration
echo 250 &gt; configs/c.1/MaxPower
echo 0x80 &gt; configs/c.1/bmAttributes
mkdir -p functions/rndis.usb0
# set up mac address of remote device
echo $HOST &gt; functions/rndis.usb0/host_addr
# set up local mac address
echo $SELF &gt; functions/rndis.usb0/dev_addr
# Force windows configuration
echo &#34;1&#34; &gt; os_desc/use
echo &#34;0xcd&#34; &gt; os_desc/b_vendor_code
echo &#34;MSFT100&#34; &gt; os_desc/qw_sign
mkdir -p functions/rndis.usb0/os_desc/interface.rndis
echo RNDIS &gt; functions/rndis.usb0/os_desc/interface.rndis/compatible_id
echo 5162001 &gt; functions/rndis.usb0/os_desc/interface.rndis/sub_compatible_id
ln -s functions/rndis.usb0 configs/c.1/
ln -s configs/c.1/ os_desc
udevadm settle -t 5 || :
ls /sys/class/udc &gt; UDC</code></pre>
</li>
<li>
<p>Give executing permission</p>
<pre><code>sudo chmod +x /etc/novamostra/gadget.sh</code></pre>
</li>
<li>
<p>Create the service</p>
<pre><code>sudo nano /lib/systemd/system/nm_gadget.service</code></pre>
<p>and insert the following content</p>
<pre><code>[Unit]
Description=Novamostra Ethernet Gadget
Before=network-pre.target
Wants=network-pre.target
[Service]
ExecStart=/usr/bin/bash /etc/novamostra/gadget.sh
[Install]
WantedBy=multi-user.target</code></pre>
</li>
<li>
<p>Enable the service to automatically start on boot.</p>
<pre><code>sudo systemctl enable nm_gadget.service</code></pre>
</li>
<li>
<p>Disable the DHCPCD service to avoid any network conflicts.</p>
<pre><code>sudo systemctl disable dhcpcd.service</code></pre>
</li>
<li>
<p>Enable the Ethernet Gadget and disable the Wi-Fi module</p>
<pre><code>sudo nano /boot/config.txt </code></pre>
<p>and append:</p>
<pre><code>dtoverlay=dwc2
dtoverlay=disable-wifi
dtoverlay=disable-bt</code></pre>
<p><img src="https://i0.wp.com/novamostra.com/wp-content/uploads/2022/10/dwc2.png?w=660&amp;ssl=1" alt="DWC2" data-recalc-dims="1" data-lazy-src="https://i0.wp.com/novamostra.com/wp-content/uploads/2022/10/dwc2.png?w=660&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></p>
</li>
<li>
<p>Power off Raspberry PI</p>
<pre><code>sudo poweroff</code></pre>
</li>
<li>
<p>Verify connections</p>
</li>
</ol>
<h2>Usage</h2>
<p>Every time you connect the BYOPM to a computer, a new network adapter will appear as connected.</p>
<p>Without any further configuration you will be able to access through your browser the <a href="https://byopm.local">https://byopm.local</a> and use your own Bitwarden instance. For better functionality I recommend installing Bitwarden’s addons to the devices you plan to use your device and configure it as follows.</p>
<h3>Bitwarden Firefox Addon</h3>
<p>To install the official Bitwarden Firefox Addon, go to <a href="https://addons.mozilla.org/en-US/firefox/addon/bitwarden-password-manager/">addon’s page</a> and click <strong>Add to Firefox</strong></p>
<p>In the Settings window, set the Server url to <a href="https://byopm.local">https://byopm.local</a>, and click <strong>Save</strong></p>
<p><img src="https://i0.wp.com/novamostra.com/wp-content/uploads/2022/10/13.png?w=660&amp;ssl=1" alt="Bitwarden Set Custom Host" data-recalc-dims="1" data-lazy-src="https://i0.wp.com/novamostra.com/wp-content/uploads/2022/10/13.png?w=660&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></p>
<p>Next login using the credentials of the account you created to the prior setup.</p>
<p><img src="https://i0.wp.com/novamostra.com/wp-content/uploads/2022/10/login.png?w=660&amp;ssl=1" alt="Bitwarden Addon Login" data-recalc-dims="1" data-lazy-src="https://i0.wp.com/novamostra.com/wp-content/uploads/2022/10/login.png?w=660&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></p>
<p>The configuration is similar for the <a href="https://chrome.google.com/webstore/detail/bitwarden-free-password-m/">Chrome’s Bitwarden Extension</a></p>
<p><strong>Warning:</strong> If for any reason the addon/extension fails to login while the credentials are correct, try first login though the normal web interface  (<a href="https://byopm.local">https://byopm.local</a>) using the respective browser and then try again.</p>
<h2>Code</h2>
<p>The code is available on <a href="https://github.com/novamostra/byopm">github</a></p>
<h2>3d Files</h2>
<p>BYOPM consists of 2 3d printed parts (top and bottom):</p>
<h2>Final Thoughts</h2>
<ul>
<li>After completing the configuration, your device will also be available using SSH. Just plug it on your computer and use the <strong>byopm.local</strong> hostname to access it.</li>
<li>It is recommended to <strong>always POWER OFF</strong> the device before removing it from the host computer. Use the Power Button and wait until the <strong>Status Indicator</strong> turn off.</li>
</ul>
<h3>Database Backup</h3>
<p><strong>WARNING</strong>: SD cards have a maximum number of read and writes. Storing your passwords on an SD card <strong>without any backup</strong> will soon result in lost passwords and possible lock outs. Always backup your database. In the current configuration is located in <code>/bw-data/db.sqlite3</code></p>
	</div><!-- .entry-content -->

	
	<!-- .entry-footer -->

</article></div>
  </body>
</html>
