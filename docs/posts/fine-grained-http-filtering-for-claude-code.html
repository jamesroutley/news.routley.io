<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ammar.io/blog/httpjail">Original</a>
    <h1>Fine-grained HTTP filtering for Claude Code</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>Posted on September 12, 2025</p>

<p>Defaultâ€‘deny HTTP(S) for dev tools and AI agents. Script rules in JS or shell, log every request, and keep egress within your policy.</p>
<p>Coding agents are becoming more powerful every day without commensurate security
and governance tooling. The result is a world where solo developers happily run <code>claude --dangerously-skip-permissions</code> for hours unmoderated while many of <span>the world&#39;s most important organizations have barely tried agentic development<span>Learned from our experience at <a href="https://coder.com" target="_blank" rel="noopener noreferrer">Coder</a></span></span> . I&#39;ve been working on a tool called <a href="https://github.com/coder/httpjail" target="_blank" rel="noopener noreferrer"><code>httpjail</code></a> in an effort to make agents available everywhere.</p>

<p>The tool is focused on mitigating these classes of risks:</p>

<table>
<thead>
<tr>
<th>Risk</th>
<th>Example</th>
</tr>
</thead>

<tbody>
<tr>
<td>Agents performing destructive actions</td>
<td>Deleting your database</td>
</tr>

<tr>
<td>Agents leaking sensitive information</td>
<td>Exposing API keys or credentials</td>
</tr>

<tr>
<td>Agents operating with more authority than desired</td>
<td>Pushing straight to main instead of opening a PR</td>
</tr>
</tbody>
</table>
<p>Agents may transgress accidentally (user misinterpretation) or intentionally (prompt injection).</p>

<p>There is a class of risks at the file-system interface too, but, I believe existing tooling
(containers) is sufficient here. Existing network isolation tools rely on IP-based rules. In our case, they&#39;re <span>imprecise<span>centralized, anycast load balancers power much of the internet</span></span> and require <span>constant maintenance<span>IPs change randomly and they&#39;re not a part of a service&#39;s implicit &#34;contract&#34;</span></span>.</p>
<h2><a href="#httpjail" name="httpjail">httpjail</a>
</h2>

<p><code>httpjail</code> implements an HTTP(S) interceptor alongside process-level network isolation. Under default configuration, all DNS (udp:53) is permitted and
all other non-HTTP(S) traffic is blocked.</p>

<p><code>httpjail</code> rules are either JavaScript expressions or custom programs. This approach makes
them far more flexible than traditional rule-oriented firewalls and avoids the learning curve of a DSL.</p>

<p>Block all HTTP requests other than the LLM API traffic
itself:</p>

<pre><code>$ httpjail --js &#34;r.host === &#39;api.anthropic.com&#39;&#34; -- claude &#34;build something great&#34;
</code></pre>



<p>Allow only <code>GET</code> requests i.e. make the internet read-only:</p>

<pre><code>$ httpjail --js &#34;r.method === &#39;GET&#39;&#34; -- claude &#34;build something great&#34;
</code></pre>

<p>Only allow hosts in a <code>whitelist.txt</code> file:</p>

<pre><code>$ httpjail --sh &#34;grep -qx \&#34;$HTTPJAIL_HOST\&#34; whitelist.txt&#34; -- claude &#34;research these APIs&#34;
</code></pre>
<h2><a href="#how-it-works" name="how-it-works">How it works</a>
</h2>

<p>In a nutshell:</p>

<div><p>
%%{init: {&#39;theme&#39;:&#39;dark&#39;, &#39;themeVariables&#39;: {&#39;fontSize&#39;: &#39;24px&#39;}}}%%
graph LR
    subgraph &#34;1. Setup&#34;
        direction TB
        Start{Mode?}
        Start --&gt;|Linux</p></div>
<h3><a href="#macos-(weak-mode)" name="macos-(weak-mode)">macOS (Weak Mode)</a>
</h3>

<p>macOS uses <code>--weak/-w</code> mode by default (see <a href="https://github.com/coder/httpjail/issues/7" target="_blank" rel="noopener noreferrer">#7</a>).</p>

<p>In weak mode, we rely on process cooperation via the standard <code>HTTP_PROXY</code>/<code>HTTPS_PROXY</code> environment variables. This mode is less of a jail and more of a suggestion that the majority of
well-meaning applications happen to comply with.</p>
<h3><a href="#tls-interception" name="tls-interception">TLS Interception</a>
</h3>

<p><code>httpjail</code> implements full TLS interception to inspect and filter HTTPS traffic. Without interception, rules would only have access to the hostname via <a href="https://en.wikipedia.org/wiki/Server_Name_Indication" target="_blank" rel="noopener noreferrer">SNI</a>, and most of the power of this tool would be lost.</p>
<h4><a href="#how-tls-interception-works" name="how-tls-interception-works">How TLS Interception Works</a>
</h4>

<ol>
<li><p><strong>Certificate Authority Generation</strong>: On first run, <code>httpjail</code> generates a self-signed Certificate Authority (CA) that&#39;s stored in <code>~/.config/httpjail/</code>. This CA is used to sign certificates for intercepted connections.</p></li>

<li><p><strong>Dynamic Certificate Generation</strong>: When a client connects, <code>httpjail</code>:</p>

<ul>
<li>Extracts the Server Name Indication (SNI) from the TLS ClientHello</li>
<li>Generates a certificate on-the-fly for that specific hostname

<ul>
<li>Uses a shared ECDSA P-256 key pair for all server certificates for O(1) keygen overhead</li>
</ul></li>
<li>Signs it with the CA certificate</li>
<li>Caches certificate in memory for performance</li>
</ul></li>

<li><p><strong>Dual Mode Operation</strong>:</p>

<ul>
<li><strong>Transparent Proxy Mode</strong>: Directly accepts TLS connections by detecting the TLS ClientHello packet (starts with <code>0x16</code>)</li>
<li><strong>Explicit Proxy Mode</strong>: Handles HTTP CONNECT tunnels, responds with &#34;200 Connection Established&#34;, then transitions to Transparent Proxy Mode</li>
</ul></li>

<li><p><strong>Trust Injection</strong>: The CA certificate must be trusted by client applications. <code>httpjail</code> automatically sets environment variables for common tools:</p>

<ul>
<li><code>SSL_CERT_FILE</code> / <code>SSL_CERT_DIR</code> for OpenSSL-based tools</li>
<li><code>CURL_CA_BUNDLE</code> for curl</li>
<li><code>NODE_EXTRA_CA_CERTS</code> for Node.js</li>
<li><code>REQUESTS_CA_BUNDLE</code> for Python requests</li>
<li><code>GIT_SSL_CAINFO</code> for Git</li>
</ul></li>
</ol>
<h2><a href="#jail-escapes" name="jail-escapes">Jail Escapes</a>
</h2>

<p>In the weak jail, it&#39;s trivial for the agent to escape the jail by funnelling requests through a
shim program that disregards the <code>HTTP_PROXY</code> environment variable.</p>

<p>Even the strong jail is not perfect. There are potential escape hatches in the filesystem. For
example, the agent could create a container via a Docker socket which would spawn outside the
network namespace.</p>

<p>To combine filesystem and network isolation into one, <code>httpjail</code> has a <code>--docker-run</code> flag that works like this:</p>

<pre><code>httpjail --js &#34;r.host === &#39;api.github.com&#39;&#34; --docker-run -- \
    --rm alpine:latest wget -qO- https://api.github.com
</code></pre>

<p>I believe there&#39;s still much value in this approach even with imperfect isolation. In my experience, models seldom try
to escape restrictions intentionally placed by the user. And, if the jail is rendered ineffective by prompt
injection, it wasn&#39;t doing its job in the first place.</p>
<h2><a href="#server-mode" name="server-mode">Server Mode</a>
</h2>

<p>For the strongest level of isolation, you can:</p>

<ul>
<li>Run <code>httpjail --server</code> on a standalone server.</li>
<li>Configure the network firewall to only permit 80/443 traffic to the proxy server.

<ul>
<li>Optionally, you may redirect all traffic to the proxy server, otherwise you will need to take
care in ensuring HTTP_PROXY is set in your environments and all of your web-faring applications respect it.</li>
</ul></li>
<li>Run processes as usual in the development environment.</li>
</ul>

<div><p>
%%{init: {&#39;theme&#39;:&#39;dark&#39;, &#39;themeVariables&#39;: {&#39;fontSize&#39;: &#39;24px&#39;}}}%%
graph LR
    subgraph &#34;Dev Environment&#34;
        Request[HTTP/HTTPS</p></div>
<h2><a href="#try-it-out" name="try-it-out">Try it out</a>
</h2>

<pre><code>cargo install httpjail
</code></pre>

<p>And, check out the <a href="https://github.com/coder/httpjail" target="_blank" rel="noopener noreferrer">GitHub repository</a> for more details.</p>

</div></div>
  </body>
</html>
