<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://httptoolkit.com/blog/apple-private-access-tokens-attestation/">Original</a>
    <h1>Apple already shipped attestation on the web, and we barely noticed</h1>
    
    <div id="readability-page-1" class="page"><div><p>There&#39;s been a lot of concern recently about the <a href="https://github.com/RupertBenWiser/Web-Environment-Integrity">Web Environment Integrity</a> proposal, developed by a selection of authors from Google, and apparently being prototyped in Chromium.</p>
<p>There&#39;s good reason for anger here (though I&#39;m not sure yelling at people on GitHub is necessarily the best outlet). This proposal amounts to attestation on the web, limiting access to features or entire sites based on whether the client is approved by a trusted issuer. In practice, that will mean Apple, Microsoft &amp; Google.</p>
<p>Of course, Google isn&#39;t the first to think of this, but in fact they&#39;re not even the first to ship it. Apple already developed &amp; deployed an extremely similar system last year, now integrated into MacOS 13, iOS 16 &amp; Safari, called &#34;<a href="https://developer.apple.com/news/?id=huqjyh7k">Private Access Tokens</a>&#34;:</p>
<blockquote>
<p>Private Access Tokens are powerful tools that prove when HTTP requests are coming from legitimate devices without disclosing someone&#39;s identity.</p>
</blockquote>
<p>The focus here is primarily on removing captchas, and as such it&#39;s been integrated into Cloudflare (discussed <a href="https://blog.cloudflare.com/eliminating-captchas-on-iphones-and-macs-using-new-standard/">here</a>) and Fastly (<a href="https://www.fastly.com/blog/private-access-tokens-stepping-into-the-privacy-respecting-captcha-less">here</a>) as a mechanism for recognizing &#39;real&#39; clients without needing other captcha mechanisms.</p>
<p>Fundamentally though, it&#39;s exactly the same concept: a way that web servers can demand your device prove it is a sufficiently &#39;legitimate&#39; device before browsing the web.</p>
<h2 id="how-do-private-access-tokens-work"><a href="#how-do-private-access-tokens-work" aria-label="how do private access tokens work permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How do Private Access Tokens work?</h2>
<p>The mechanism is a fairly simple exchange over HTTP, handled by built-in browser APIs, which in turn integrate with operating system components to confirm that the browser &amp; OS are &#39;legitimate&#39; (the exact definition of that is left to the attester - i.e. Apple).</p>
<p>The flow looks like this:</p>
<ol>
<li>A browser makes an HTTP request from a web server.</li>
<li>
<p>The web server refuses the request, and returns an HTTP 401 response with a <code>PrivateToken</code> challenge:</p>
<div data-language="text">
      <pre><code>HTTP/1.1 401 Unauthorized
WWW-Authenticate:
    PrivateToken challenge=&lt;base64 challenge data&gt;,
        token-key=&lt;base64 public-key&gt;</code></pre>
      </div>
<p><em>(Newlines added for readability)</em></p>
</li>
<li>The browser recognizes this, and sends parts of the challenge, in addition to verified details of your device provided by the OS, to an attester (e.g. Apple).</li>
<li>The attester verifies your device is real &amp; unmodified (depends on the device, but both Android &amp; iOS have existing ways to check this) and works with a token issuer (somebody trusted by the origin &amp; that trusts the attester, e.g. Cloudflare/Fastly) to return a signed token, proving that your device has been verified as legitimate.</li>
<li>
<p>The browser resends the request, with the signed token in their <code>Authorization</code> header:</p>
<div data-language="text">
      <pre><code>GET /protected-content HTTP/1.1
Host: example.com
Authorization: PrivateToken token=&lt;signed token&gt;</code></pre>
      </div>
</li>
<li>The server now knows that the client has been verified by a trusted provider (but nothing more) and can treat the client differently on that basis.</li>
</ol>
<p>This all happens on Apple devices today when using Safari, any time a service using this (such as Fastly &amp; Cloudflare) is concerned about the legitimacy of your requests.</p>
<p>The privacy protections in here appear fairly strong (I&#39;m not an expert on this, but that&#39;s a very clear goal of the proposal and the separation of the origin/issuer/attester flow) but the core issue from Web Environment Integrity remains: your treatment on the web depends on whether Apple says your device, OS &amp; browser configuration are legitimate &amp; acceptable.</p>
<h2 id="how-bad-is-this"><a href="#how-bad-is-this" aria-label="how bad is this permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How bad is this?</h2>
<p>This feature is largely bad for the web and the industry generally, like all attestation (see below).</p>
<p>That said, it&#39;s not as dangerous as the Google proposal, simply because Safari isn&#39;t the dominant browser. Right now, Safari has around 20% market share in browsers (25% on mobile, and 15% on desktop), while Chrome is comfortably above 60% everywhere, with Chromium more generally (Brave, Edge, Opera, Samsung Internet, etc) about 10% above that.</p>
<p>With Safari providing this, it can be used by some providers, but nobody can block or behave differently with unattested clients. Similarly, Safari can&#39;t usefully use this to tighten the screws on users - while they could refuse to attest old OS versions or browsers, it wouldn&#39;t make a significant impact on users (they might see statistically more CAPTCHAs, but little else).</p>
<p>Chrome&#39;s usage is a larger concern. With 70+% of web clients using Chromium, this would become a major part of the web very quickly. With both Web Environment Integrity &amp; Private Access Tokens, 90% of web clients would potentially be attested, and the &#34;oh, you&#39;re not attested, let&#39;s treat you suspiciously&#34; pressure could ramp up quickly.</p>
<h2 id="why-is-attestation-bad-generally"><a href="#why-is-attestation-bad-generally" aria-label="why is attestation bad generally permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why is attestation bad generally?</h2>
<p>This has been <a href="https://arstechnica.com/gadgets/2023/07/googles-web-integrity-api-sounds-like-drm-for-the-web/">covered</a> <a href="https://gabrielsieben.tech/2022/07/29/remote-assertion-is-coming-back-how-much-freedom-will-it-take/">extensively</a> elsewhere, so I won&#39;t dig into it too deeply, but as a quick summary:</p>
<ul>
<li>Attestation means you can only use approved clients, which is terrible for competition and innovation (sorry, it&#39;s now impossible to make a new browser or OS!) particularly for open-source, community &amp; smaller indie efforts that are consistently excluded from these mechanisms. If attestation was around in the days of IE6, it would&#39;ve been a major roadblock in the rise of Firefox &amp; Chrome.</li>
<li>Attestation blocks users&#39; control of their own devices, by design. A key goal is that users using modified software should not be attested as legitimate. I would like to be able to browse the web on my rooted Android phone please. There&#39;s no way any fully user-modifiable OS or hardware can ever be attested in the way these proposals intend.</li>
<li>Attestation opens dangerous doors that allow the approved providers to freely tighten the rules later. &#34;Sorry, we only attest devices during their 2 year official support window&#34;, and &#34;Sorry, we don&#39;t attest browsers with ad-block extensions installed&#34; are both perfectly plausible and thoroughly problematic next steps.</li>
</ul>
<p>Proponents would argue that none of this applies to the Web Environment Integrity proposal, as it suggests &#39;holdbacks&#39;, i.e. refusing attestation a small percentage of times to make blocking based on attestation impossible. I suspect business pressures will make that unworkable in practice (there&#39;s already <a href="https://github.com/RupertBenWiser/Web-Environment-Integrity/issues/5">strong industry pushback</a> from a closely involved F5 / Shape Security representative) and it&#39;s notable that Google&#39;s existing Android Play Integrity attestation does <em>not</em> do this.</p>
<p>Free usage of different clients &amp; servers on the web is what has built the open web, and is a large part of why it&#39;s so successful. Attestation breaks this by design.</p>
<p>All of this has already played out on Android, where you technically <em>can</em> create and run your OS, and Android distributions like <a href="https://lineageos.org/">LineageOS</a> are perfectly functional, but attestation features mean that this implies the constant risk of key apps (like your bank!) blocking you as suspicious.</p>
<p>Fundamentally, attestation is anti-competitive. Blocking competition between different Android versions is already problematic. Blocking competition for both browsers &amp; OSs on the web would be catastrophic.</p>
<h2 id="shit"><a href="#shit" aria-label="shit permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Shit</h2>
<p>Quite.</p>
<p>If you&#39;re concerned about all this, you might also be interested in the <a href="https://github.com/antifraudcg/proposals/issues">other proposals</a> from the Anti-Fraud Community Group, discussing various other potential web &#39;features&#39; along the same lines.</p>
<p>Fraud &amp; bots on the web are a real problem, and discussion on ways to defend against that is totally reasonable, and often very valuable! It&#39;s a hard problem. That said, this has to be carefully balanced against the health of the web itself. Blocking competition, hamstringing open-source and the open web, and removing all user control over their own devices is not a reasonable tradeoff.</p>
<p>Have thoughts or comments? Get in touch <a href="https://twitter.com/pimterry">on Twitter</a>, <a href="https://toot.cafe/@pimterry">on Mastodon</a> or <a href="https://httptoolkit.com/contact/">directly</a>.</p>
<p><strong>Want to understand how this all works up close? Try intercepting, exploring &amp; modifying your web traffic with <a href="https://httptoolkit.com">HTTP Toolkit</a> now</strong>.</p></div></div>
  </body>
</html>
