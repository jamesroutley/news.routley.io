<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://antonz.org/in-browser-code-playgrounds/">Original</a>
    <h1>In-browser code playgrounds</h1>
    
    <div id="readability-page-1" class="page"><div><div><article><div><div><header></header><p>I&#39;m a big fan of interactive code snippets in all kinds of technical writing, from product docs to online courses to blog posts. Like this one:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>def</span> <span>greet</span>(<span>name</span>):
</span></span><span><span>    <span>print</span>(<span>f</span><span>&#34;Hello, </span><span>{</span><span>name</span><span>}</span><span>!&#34;</span>)
</span></span><span><span>
</span></span><span><span><span>greet</span>(<span>&#34;World&#34;</span>)
</span></span></code></pre></div><codapi-snippet sandbox="python" editor="basic"></codapi-snippet><p>In fact, I even built an open source tool called Codapi<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup> for embedding such snippets.</p><p>Typically, a code playground consists of a client-side widget and a server-side part that executes the code and returns the result:</p><pre tabindex="0"><code>  browser
┌───────────────────────────────┐
│ def greet(name):              │
│   print(f&#34;Hello, {name}!&#34;)    │
│                               │
│ greet(&#34;World&#34;)                │
└───────────────────────────────┘
  Run ►
    ↓
  server
┌───────────────────────────────┐
│ docker run codapi/python      │
│ python main.py                │
└───────────────────────────────┘
    ↓
  browser
┌───────────────────────────────┐
│ Hello, World!                 │
└───────────────────────────────┘
</code></pre><p>Personally, I&#39;m quite happy with this setup. But often people prefer not to depend on a server and run the code entirely in the browser. So I decided to look into it and implemented embeddable in-browser code playgrounds for JavaScript, Python, PHP, Ruby, Lua, and SQLite.</p><h2 id="running-language-runtimes-in-the-browser">Running language runtimes in the browser</h2><p>The modern way to run arbitrary programs in the browser seems to be WebAssembly System Interface (WASI<sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup>) — an executable binary format based on WebAssembly. With WASI, you compile a program (originally written in C, Rust, Go, or some other language) into a WASI binary and then run it with a WASI runtime (there are a number of these runtimes from different vendors).</p><p>Just as we can compile an arbitrary program into WASI binary, we can take a language interpreter like Lua or CPython, compile it into WASI, and run it with the WASI runtime to execute Lua or Python code. In practice, however, it&#39;s not that easy, because WASI compilers do not (yet) implement all the features of traditional compilers like GCC.</p><p>Fortunately, VMWare Labs has already done the hard part and compiled PHP<sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup>, Python<sup id="fnref:4"><a href="#fn:4" role="doc-noteref">4</a></sup> and Ruby<sup id="fnref:5"><a href="#fn:5" role="doc-noteref">5</a></sup> into WASI. So all I had to do was publish the WASI binaries as NPM packages to make them available on the CDN. I&#39;ve also compiled Lua<sup id="fnref:6"><a href="#fn:6" role="doc-noteref">6</a></sup> and SQLite<sup id="fnref:7"><a href="#fn:7" role="doc-noteref">7</a></sup> to WASI.</p><blockquote><p>There is also Kohei Tokunaga&#39;s container2wasm initiative<sup id="fnref:8"><a href="#fn:8" role="doc-noteref">8</a></sup>, which converts arbitrary Docker images into WASI binaries. It looks promising, but it generates 100+ MB binaries for even the smallest Alpine-based images. And since downloading hundreds of megabytes just to read an interactive article is probably not the best idea, this approach is not very practical (yet).</p></blockquote><p>Language runtimes compiled into WASI are one part of the equation. The other one is the WASI runtime (the thing that runs the binaries) capable of working in the browser. I chose the Runno<sup id="fnref:9"><a href="#fn:9" role="doc-noteref">9</a></sup> runtime by Ben Taylor because it&#39;s simple and lightweight (27 KB).</p><p>The last step was to modify the JavaScript widget<sup id="fnref:10"><a href="#fn:10" role="doc-noteref">10</a></sup> to support pluggable engines (WASI is one of them).</p><p>And that was it!</p><h2 id="showcase">Showcase</h2><p>Here are some interactive code snippets implemented as described above. Note that the language runtime is downloaded when you click the Run button, so the first run may take some time. Subsequent runs are almost instantaneous.</p><h3 id="python">Python</h3><p>Executes the code using the Python 3.12 WASI runtime (26.3 MB).</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>def</span> <span>greet</span>(<span>name</span>):
</span></span><span><span>    <span>print</span>(<span>f</span><span>&#34;Hello, </span><span>{</span><span>name</span><span>}</span><span>!&#34;</span>)
</span></span><span><span>
</span></span><span><span><span>greet</span>(<span>&#34;World&#34;</span>)
</span></span></code></pre></div><codapi-snippet engine="wasi" sandbox="python" editor="basic"></codapi-snippet><h3 id="php">PHP</h3><p>Executes the code using the PHP 8.2 WASI runtime (13.2 MB).</p><div><pre tabindex="0"><code data-lang="php"><span><span><span>function</span> <span>greet</span>(<span>$name</span>) {
</span></span><span><span>    <span>echo</span> <span>&#34;Hello, </span><span>$name</span><span>!&#34;</span>;
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span><span>greet</span>(<span>&#34;World&#34;</span>);
</span></span></code></pre></div><codapi-snippet engine="wasi" sandbox="php" editor="basic" template="main.php"></codapi-snippet><h3 id="ruby">Ruby</h3><p>Executes the code using the Ruby 3.2 WASI runtime (24.5 MB).</p><div><pre tabindex="0"><code data-lang="ruby"><span><span><span>def</span> <span>greet</span>(<span>name</span>)
</span></span><span><span>  <span>puts</span> <span>&#34;Hello, </span><span>#{</span><span>name</span><span>}</span><span>!&#34;</span>
</span></span><span><span><span>end</span>
</span></span><span><span>
</span></span><span><span><span>greet</span>(<span>&#34;World&#34;</span>)
</span></span></code></pre></div><codapi-snippet engine="wasi" sandbox="ruby" editor="basic"></codapi-snippet><h3 id="lua">Lua</h3><p>Executes the code using the Lua 5.4 WASI runtime (330 KB).</p><div><pre tabindex="0"><code data-lang="lua"><span><span><span>function</span> <span>greet</span>(<span>name</span>)
</span></span><span><span>  <span>print</span>(<span>&#34;Hello, &#34;</span> <span>..</span> <span>name</span> <span>..</span> <span>&#34;!&#34;</span>)
</span></span><span><span><span>end</span>
</span></span><span><span>
</span></span><span><span><span>greet</span>(<span>&#34;World&#34;</span>)
</span></span></code></pre></div><codapi-snippet engine="wasi" sandbox="lua" editor="basic"></codapi-snippet><h3 id="javascript">JavaScript</h3><p>Executes the code using the AsyncFunction<sup id="fnref:11"><a href="#fn:11" role="doc-noteref">11</a></sup>.</p><div><pre tabindex="0"><code data-lang="js"><span><span><span>const</span> <span>greet</span> <span>=</span> (<span>name</span>) =&gt; {
</span></span><span><span>    <span>console</span>.<span>log</span>(<span>`Hello, </span><span>${</span><span>name</span><span>}</span><span>!`</span>);
</span></span><span><span>};
</span></span><span><span>
</span></span><span><span><span>greet</span>(<span>&#34;World&#34;</span>);
</span></span></code></pre></div><codapi-snippet engine="browser" sandbox="javascript" editor="basic"></codapi-snippet><h3 id="fetch">Fetch</h3><p>Executes the code using the Fetch API<sup id="fnref:12"><a href="#fn:12" role="doc-noteref">12</a></sup>.</p><div><pre tabindex="0"><code data-lang="js"><span><span><span>POST</span> <span>https</span><span>:</span><span>//httpbingo.org/dump/request
</span></span></span><span><span><span></span><span>content</span><span>-</span><span>type</span><span>:</span> <span>application</span><span>/</span><span>json</span>
</span></span><span><span>
</span></span><span><span>{ <span>&#34;message&#34;</span><span>:</span> <span>&#34;hello&#34;</span> }
</span></span></code></pre></div><codapi-snippet engine="browser" sandbox="fetch" editor="basic"></codapi-snippet><h3 id="sqlite">SQLite</h3><p>Executes the code using the SQLite 3.44 WASI runtime (2.1 MB).</p><div><pre tabindex="0"><code data-lang="sql"><span><span><span>select</span> <span>id</span>, <span>name</span>, <span>department</span>
</span></span><span><span><span>from</span> <span>employees</span>
</span></span><span><span><span>order</span> <span>by</span> <span>id</span> <span>limit</span> <span>3</span>;
</span></span></code></pre></div><codapi-snippet engine="wasi" sandbox="sqlite" editor="basic" template="employees.sql"></codapi-snippet><h2 id="advanced-features">Advanced features</h2><p>Because the WASI runtime plugs into the existing architecture, WASI-powered code snippets support advanced Codapi features such as templates or code cells.</p><p>Templates<sup id="fnref:13"><a href="#fn:13" role="doc-noteref">13</a></sup> allow you to hide some code behind the scenes and show only the relevant part. For example, in the SQLite example above, the <code>employees</code> table is created as part of the template, so the snippet can take it for granted:</p><div><pre tabindex="0"><code data-lang="sql"><span><span><span>select</span> <span>id</span>, <span>name</span>, <span>department</span>
</span></span><span><span><span>from</span> <span>employees</span>
</span></span><span><span><span>order</span> <span>by</span> <span>id</span> <span>limit</span> <span>3</span>;
</span></span></code></pre></div><codapi-snippet engine="wasi" sandbox="sqlite" editor="basic" template="employees.sql"></codapi-snippet><p>Code cells<sup id="fnref:14"><a href="#fn:14" role="doc-noteref">14</a></sup> allow you to make code snippets depend on each other. For example, the first snippet defines the <code>wrap</code> function, while the second snippet uses it:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>import</span> <span>textwrap</span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>wrap</span>(<span>text</span>, <span>width</span><span>=</span><span>20</span>):
</span></span><span><span>    <span>&#34;&#34;&#34;Wraps the text so every line is at most width characters long.&#34;&#34;&#34;</span>
</span></span><span><span>    <span>return</span> <span>textwrap</span><span>.</span><span>fill</span>(<span>text</span>, <span>width</span>)
</span></span></code></pre></div><codapi-snippet id="cell-1" engine="wasi" sandbox="python" editor="basic"></codapi-snippet><div><pre tabindex="0"><code data-lang="python"><span><span><span>text</span> <span>=</span> (
</span></span><span><span>    <span>&#34;Python is a programming language that lets you work quickly &#34;</span>
</span></span><span><span>    <span>&#34;and integrate systems more effectively.&#34;</span>
</span></span><span><span>)
</span></span><span><span><span>print</span>(<span>wrap</span>(<span>text</span>))
</span></span></code></pre></div><codapi-snippet id="cell-2" engine="wasi" sandbox="python" editor="basic" depends-on="cell-1"></codapi-snippet><h2 id="usage">Usage</h2><p>To use native browser playgrounds (e.g. JavaScript or Fetch), include the <code>snippet.js</code> script and add the <code>codapi-snippet</code> element next to the static code example. Use the <code>browser</code> engine:</p><div><pre tabindex="0"><code data-lang="html"><span><span>&lt;<span>pre</span>&gt;console.log(&#34;hello&#34;)&lt;/<span>pre</span>&gt;
</span></span><span><span>
</span></span><span><span>&lt;<span>codapi-snippet</span> <span>engine</span><span>=</span><span>&#34;browser&#34;</span> <span>sandbox</span><span>=</span><span>&#34;javascript&#34;</span> <span>editor</span><span>=</span><span>&#34;basic&#34;</span>&gt;
</span></span><span><span>&lt;/<span>codapi-snippet</span>&gt;
</span></span><span><span>
</span></span><span><span>&lt;<span>script</span> <span>src</span><span>=</span><span>&#34;https://unpkg.com/@antonz/codapi@0.12.0/dist/snippet.js&#34;</span>&gt;&lt;/<span>script</span>&gt;
</span></span></code></pre></div><p>To use WASI-powered playgrounds (e.g. Python or SQLite), include two additional scripts and use the <code>wasi</code> engine:</p><div><pre tabindex="0"><code data-lang="html"><span><span>&lt;<span>pre</span>&gt;print(&#34;hello&#34;)&lt;/<span>pre</span>&gt;
</span></span><span><span>
</span></span><span><span>&lt;<span>codapi-snippet</span> <span>engine</span><span>=</span><span>&#34;wasi&#34;</span> <span>sandbox</span><span>=</span><span>&#34;python&#34;</span> <span>editor</span><span>=</span><span>&#34;basic&#34;</span>&gt;&lt;/<span>codapi-snippet</span>&gt;
</span></span><span><span>
</span></span><span><span>&lt;<span>script</span> <span>src</span><span>=</span><span>&#34;https://unpkg.com/@antonz/runno@0.6.1/dist/runno.js&#34;</span>&gt;&lt;/<span>script</span>&gt;
</span></span><span><span>&lt;<span>script</span> <span>src</span><span>=</span><span>&#34;https://unpkg.com/@antonz/codapi@0.12.0/dist/engine/wasi.js&#34;</span>&gt;&lt;/<span>script</span>&gt;
</span></span><span><span>&lt;<span>script</span> <span>src</span><span>=</span><span>&#34;https://unpkg.com/@antonz/codapi@0.12.0/dist/snippet.js&#34;</span>&gt;&lt;/<span>script</span>&gt;
</span></span></code></pre></div><p>To switch from in-browser to server-side playgrounds (which can run virtually any software), remove the <code>engine</code> attribute:</p><div><pre tabindex="0"><code data-lang="html"><span><span>&lt;<span>pre</span>&gt;
</span></span><span><span>fn main() {
</span></span><span><span>    println!(&#34;Hello, World!&#34;);
</span></span><span><span>}
</span></span><span><span>&lt;/<span>pre</span>&gt;
</span></span><span><span>
</span></span><span><span>&lt;<span>codapi-snippet</span> <span>sandbox</span><span>=</span><span>&#34;rust&#34;</span> <span>editor</span><span>=</span><span>&#34;basic&#34;</span>&gt;&lt;/<span>codapi-snippet</span>&gt;
</span></span></code></pre></div><p>See the documentation<sup id="fnref:15"><a href="#fn:15" role="doc-noteref">15</a></sup> for details.</p><h2 id="summary">Summary</h2><p>WASI-powered sandboxes allow code snippets to run completely in-browser, with no server involved. They may take some time and traffic to initialize the runtime, but after that they run almost instantly.</p><p>As implemented in Codapi, they fit nicely into the overall architecture, providing access to features like templates and code cells. You can also easily switch from a browser-side to a server-side execution model.</p><p>Give them a try!</p><p><a href="https://github.com/nalgeon/codapi-js/blob/main/docs/browser-only.md">Playgrounds</a> •
<a href="https://github.com/nalgeon/codapi-js">Snippet widget</a> •
<a href="https://codapi.org/">About Codapi</a></p>

<p><em><a href="https://antonz.org/subscribe/"><i></i> <strong>Subscribe</strong></a>
to keep up with new posts.</em></p></div></div></article></div></div></div>
  </body>
</html>
