<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://eclecticlight.co/2024/11/18/inside-m4-chips-e-and-p-cores/">Original</a>
    <h1>M4 chips: E and P cores</h1>
    
    <div id="readability-page-1" class="page"><div data-first_letter="I">
		<p>In the two previous articles (links at the end), I explored some of the features and properties of Performance (P) cores in Apple’s latest M4 chips. This article looks at their Efficiency (E) cores by comparison.</p>
<h4>M4 family</h4>
<p>In the three current M4 designs, there are only two variations in terms of E cores:</p>
<ul>
<li><strong>Base M4</strong>, with 6 E cores, except for a cheaper variant with only 4 active E cores.</li>
<li><strong>M4 Pro</strong> and <strong>Max</strong>, with 4 E cores, including ‘binned’ variants.</li>
</ul>
<p>Apple is expected to release an Ultra variant in 2025, with two M4 Max chips in tandem, providing a total of 8 E cores. Apart from the number of cores, all E cores are the same, and different from P cores.</p>
<h4>E core architecture</h4>
<p>All E cores are arranged in a single cluster of 4 or 6, sharing common L2 cache, and running at the same frequency (clock speed). Analysis of M1 cores implies that each E core has roughly half the number of processing units, where there is more than one such unit in the P core, giving an M1 E core roughly half the compute capacity of the P core. I haven’t seen any comparable analysis of cores in later M families, although differences in power consumption imply there remain substantial differences in processing units and compute capacity.</p>
<h4>Frequency</h4>
<p>Like P cores, E cores can be set to run at any of 5 values between the minimum of 1,020 MHz and maximum of 2,592 MHz (1.0-2.6 GHz). When running macOS, cluster frequency is set by macOS at a kernel level; other operating systems may offer more direct control. This range of frequencies is significantly narrower than that of E cores in the M3, which range between 744-2,748 MHz.</p>
<p>E cores idle at 1,020 MHz, and although they can be shut down altogether, that’s exceptional given the steady demand for macOS background threads to be run on them. Nevertheless, <code>powermetrics</code> still reports their ‘down’ residencies separately from idle residencies.</p>
<h4>Instruction set</h4>
<p>This is believed to be identical to ARMv9.2-A without Scalable Vector Extension (SVE) supported by M4 P cores, enabling the same threads to be run on either core type.</p>
<h4>Single thread comparisons</h4>
<p>One way to appreciate the contrasts between core types is to compare a single intensive in-core thread run in each. For this purpose, I used a tight loop of floating point calculations, running at two different Quality of Service (QoS) settings, in macOS 15.1.</p>
<h5>Single thread at high QoS on P cores</h5>
<p><span><img data-attachment-id="83631" data-permalink="https://eclecticlight.co/m4singlepflopt1/" data-orig-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt1.png" data-orig-size="1100,900" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="m4singlePflopt1" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt1.png?w=300" data-large-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt1.png?w=940" src="https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt1.png" alt="m4singlePflopt1" width="1100" height="900" srcset="https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt1.png 1100w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt1.png?w=150&amp;h=123 150w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt1.png?w=300&amp;h=245 300w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt1.png?w=768&amp;h=628 768w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt1.png?w=1024&amp;h=838 1024w" sizes="(max-width: 1100px) 100vw, 1100px"/></span></p>
<p>This thread was initially loaded onto P13 (red) in the second (P1) cluster, and after 3.7 seconds was moved to P5 (blue) in the first (P0) cluster. After a further 4.6 seconds running on that, it was moved back to the second (P1) cluster, to run on P11 (purple). During this run, there was almost no other activity on the two P clusters, and the inactive cluster was therefore shut down while this thread was running on the other.</p>
<p><span><img data-attachment-id="83632" data-permalink="https://eclecticlight.co/m4singlepflopt2/" data-orig-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt2.png" data-orig-size="1100,900" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="m4singlePflopt2" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt2.png?w=300" data-large-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt2.png?w=940" src="https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt2.png" alt="m4singlePflopt2" width="1100" height="900" srcset="https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt2.png 1100w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt2.png?w=150&amp;h=123 150w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt2.png?w=300&amp;h=245 300w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt2.png?w=768&amp;h=628 768w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt2.png?w=1024&amp;h=838 1024w" sizes="(max-width: 1100px) 100vw, 1100px"/></span></p>
<p>The active cluster was run at the maximum frequency of 4,511 MHz throughout. Just before the thread was moved to a different cluster, that was brought up and run up to maximum frequency ready to run the thread.</p>
<p><span><img data-attachment-id="83633" data-permalink="https://eclecticlight.co/m4singlepflopt3/" data-orig-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt3.png" data-orig-size="1100,900" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="m4singlePflopt3" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt3.png?w=300" data-large-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt3.png?w=940" loading="lazy" src="https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt3.png" alt="m4singlePflopt3" width="1100" height="900" srcset="https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt3.png 1100w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt3.png?w=150&amp;h=123 150w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt3.png?w=300&amp;h=245 300w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt3.png?w=768&amp;h=628 768w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singlepflopt3.png?w=1024&amp;h=838 1024w" sizes="(max-width: 1100px) 100vw, 1100px"/></span></p>
<p>Total CPU power remained similar throughout the period the thread was being executed, but there is a small and consistent difference according to which cluster was active: the first (P0) brought power use of about 2,520 mW, 50 mW higher than the second (P1) at about 2,470 mW. This matches the difference reported previously, and merits assessment in other M4 Pro chips to determine whether this is a general feature.</p>
<h5>Single thread at high QoS on E cores</h5>
<p>There are methods of running code, such as the in-core floating point loop test used here, on E cores: they can be run with a low QoS (Background), so that macOS allocates them to run on only E cores, or they can be spilt over from high QoS threads when there are more threads than available P cores. On an M4 Pro chip, that requires 11 threads, which results in one of those being allocated to the E cluster, as described next.</p>
<p><span><img data-attachment-id="83634" data-permalink="https://eclecticlight.co/m4singleponeflop1/" data-orig-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleponeflop1.png" data-orig-size="1100,900" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="m4singlePonEflop1" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleponeflop1.png?w=300" data-large-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleponeflop1.png?w=940" loading="lazy" src="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleponeflop1.png" alt="m4singlePonEflop1" width="1100" height="900" srcset="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleponeflop1.png 1100w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singleponeflop1.png?w=150&amp;h=123 150w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singleponeflop1.png?w=300&amp;h=245 300w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singleponeflop1.png?w=768&amp;h=628 768w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singleponeflop1.png?w=1024&amp;h=838 1024w" sizes="(max-width: 1100px) 100vw, 1100px"/></span></p>
<p>This chart shows active residency on the four E cores with a single high QoS thread spilt onto them. While cores E1, E2 and E3 appear to handle other threads over this period of more than six seconds, core E0 appears to run at 90-100% active residency executing the spilt thread. Note that this thread wasn’t moved between cores over that period of over six seconds.</p>
<p>E cluster frequency remained constant throughout at its maximum of 2,592 MHz. CPU power use was inevitably dominated by the ten P cores running at 100% active residency and maximum frequency, remaining at just under 14,000 mW. Unfortunately, using <code>powermetrics</code> it’s not possible to estimate the power use of the E cluster directly.</p>
<h5>Single thread at low QoS on E cores</h5>
<p>This is very different from the spilt thread at high QoS.</p>
<p><span><img data-attachment-id="83628" data-permalink="https://eclecticlight.co/m4singleeflop1/" data-orig-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop1.png" data-orig-size="1100,900" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="m4singleEflop1" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop1.png?w=300" data-large-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop1.png?w=940" loading="lazy" src="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop1.png" alt="m4singleEflop1" width="1100" height="900" srcset="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop1.png 1100w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop1.png?w=150&amp;h=123 150w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop1.png?w=300&amp;h=245 300w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop1.png?w=768&amp;h=628 768w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop1.png?w=1024&amp;h=838 1024w" sizes="(max-width: 1100px) 100vw, 1100px"/></span></p>
<p>There’s no evidence here that any single core in the E cluster ran a thread at 100% active residency. Instead it appears to have been moved rapidly and freely around the cores, with many 0.1 second sampling intervals spanning its execution in more than one core over that period.</p>
<p><span><img data-attachment-id="83629" data-permalink="https://eclecticlight.co/m4singleeflop2/" data-orig-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop2.png" data-orig-size="1100,900" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="m4singleEflop2" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop2.png?w=300" data-large-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop2.png?w=940" loading="lazy" src="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop2.png" alt="m4singleEflop2" width="1100" height="900" srcset="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop2.png 1100w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop2.png?w=150&amp;h=123 150w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop2.png?w=300&amp;h=245 300w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop2.png?w=768&amp;h=628 768w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop2.png?w=1024&amp;h=838 1024w" sizes="(max-width: 1100px) 100vw, 1100px"/></span></p>
<p>Cluster frequency was a steady minimum of 1,050-1,060 MHz, with superimposed spikes when it rose briefly to the maximum of 2,592 MHz. This suggests that the single thread would most probably have been run at close to core minimum frequency, had there not been additional threads to run.</p>
<p><span><img data-attachment-id="83630" data-permalink="https://eclecticlight.co/m4singleeflop3/" data-orig-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop3.png" data-orig-size="1100,900" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="m4singleEflop3" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop3.png?w=300" data-large-file="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop3.png?w=940" loading="lazy" src="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop3.png" alt="m4singleEflop3" width="1100" height="900" srcset="https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop3.png 1100w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop3.png?w=150&amp;h=123 150w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop3.png?w=300&amp;h=245 300w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop3.png?w=768&amp;h=628 768w, https://eclecticlight.co/wp-content/uploads/2024/11/m4singleeflop3.png?w=1024&amp;h=838 1024w" sizes="(max-width: 1100px) 100vw, 1100px"/></span></p>
<p>A similar picture is seen in power use, with spikes from a low background of about 40-45 mW required by the single thread alone.</p>
<h4>Single thread behaviours</h4>
<p>These can be summarised as:</p>
<ul>
<li>P core (high QoS) runs at 100% active residency on a single P core at maximum frequency, and is switched between clusters irregularly (about every 3.7-4.6 seconds). Total power use is about 2,500 mW.</li>
<li>High QoS spilt over to E cores runs at 90-100% active residency on a single E core at maximum frequency, and is either not switched between cores at all, or only infrequently.</li>
<li>E core (low QoS) runs at about 100% and is moved frequently between all E cores in the cluster, at close to minimum frequency. Total power use is about 40-45 mW.</li>
</ul>
<h4>Performance, power and efficiency</h4>
<p>Although I’ll be returning to more detailed comparisons of performance and power use between P and E cores, I provide a single illustration here, for the in-core floating point task used above.</p>
<p>Running 2 x 10^9 loops in each thread, P cores at maximum frequency take 9.2-9.7 seconds per thread, and use about 2,500 mW per thread. E cores running low QoS threads at close to minimum frequency take about four times as long, 38.5 seconds, but use less than 45 mW power per thread. Total energy used to complete one thread is therefore over 23 J when run on P cores, and less than 1.7 J when run on E cores. E cores therefore use only 7% of the energy that P cores do performing the same task.</p>
<h4>Key information</h4>
<ul>
<li>Current M4 chips feature 4-6 CPU E cores.</li>
<li>M4 E cores are arranged in a single cluster of 4 or 6, sharing L2 cache and running at a common frequency.</li>
<li>The E core cluster can be shut down (exceptionally), idling at their minimum frequency of 1,020 MHz, or at one of 6 set frequencies up to a maximum of 2,592 MHz, as controlled by macOS.</li>
<li>Their instruction set is the same as M4 P cores, ARMv9.2-A without its Scalable Vector Extension (SVE).</li>
<li>They use 40-45 mW when at low frequencies, but it’s not currently feasible to measure directly their maximum power use at high frequencies.</li>
<li>macOS allocates threads to E cores when their QoS is 9 (Background), and when a thread with higher QoS can’t be allocated to a P core because they are all busy. Management of frequencies and core allocation differ between those two cases.</li>
<li>High QoS threads on E cores are run at maximum frequency and appear not to move between cores.</li>
<li>Low QoS threads on E cores are run at close to minimum frequency and are highly mobile between cores.</li>
<li>Low QoS threads running on E cores run more slowly than higher QoS threads running on P cores, but E core power use is much lower, resulting in considerable saving in total energy use for the same computational task.</li>
</ul>
<h4>Previous article</h4>
<p><a href="https://eclecticlight.co/2024/11/11/inside-m4-chips-p-cores/">Inside M4 chips: P cores</a></p>
<h4>Explainer</h4>
<p><strong>Residency</strong> is the percentage of time a core is in a specific state. <em>Idle residency</em> is thus the percentage of time that core is idle and not processing instructions. <em>Active residency</em> is the percentage of time it isn’t idle, but is actively processing instructions. <em>Down residency</em> is the percentage of time the core is shut down. All these are independent of the core’s frequency or clock speed.</p>
	</div></div>
  </body>
</html>
