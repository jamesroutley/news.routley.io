<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://cloud.google.com/blog/topics/systems/tpu-v4-enables-performance-energy-and-co2e-efficiency-gains">Original</a>
    <h1>TPU v4 provides exaFLOPS-scale ML with efficiency gains</h1>
    
    <div id="readability-page-1" class="page"><div jsname="tx2NYc"><section><span jsaction="rcuQ6b:npT2md" jscontroller="YSybTb" data-track-type="" soy-skip="" ssk="5:kbe95"><p><i><b>Editor’s note</b>: Today, two legendary Google engineers describe the “secret sauce” that has made TPU v4 a platform of choice for the world’s leading AI researchers and developers for training machine learning models at scale. <a href="https://en.wikipedia.org/wiki/Norman_Jouppi" target="_blank">Norm Jouppi</a> is the chief architect for all Google’s TPUs, from TPU v1 to TPU v4. He is a Google Fellow and a member of the National Academy of Engineering (NAE). <a href="https://en.wikipedia.org/wiki/David_Patterson_(computer_scientist)" target="_blank">David Patterson</a>, a Google Distinguished Engineer, shared the <a href="https://www.nytimes.com/2018/03/21/technology/computer-chips-turing-award.html" target="_blank">ACM A.M. Turing Award</a> and the <a href="https://www.nae.edu/266390/RISC-Chip-Innovators-Receive-the-2022-Charles-Stark-Draper-Prize-for-Engineering" target="_blank">NAE Charles Draper Prize</a>. David is one of the creators of RISC and RAID, and his recent research has been on the <a href="https://ieeexplore.ieee.org/document/9810097" target="_blank">CO2e emissions from machine learning</a>. </i></p><hr/><p>Scaling computing performance is foundational to advancing the state of the art in machine learning (ML). Thanks to key innovations in interconnect technologies and domain specific accelerators (DSA), the Google Cloud TPU v4 enabled: </p><ul><li><p>a nearly 10x leap forward in scaling ML system performance over TPU v3 </p></li><li><p>boosting energy efficiency ~2-3x compared to contemporary ML DSAs, and </p></li><li><p>reducing CO2e as much as ~20x over these DSAs in typical on-premise data centers<sup>1</sup>.</p></li></ul><p>As such, the performance, scalability, efficiency, and availability of TPU v4 make it an ideal vehicle for large language models.</p><p>TPU v4 provides exascale ML performance, with 4096 chips interconnected by an internally-developed industry-leading optical circuit switch (OCS). You can see one eighth of a TPU v4 pod below. Google’s Cloud TPU v4 outperforms TPU v3 by 2.1x on average on a per-chip basis and improves performance/Watt by 2.7x. The mean TPU v4 chip power is typically only 200W.</p></span></section><section><section><figure><section jscontroller="SCGBie" jsaction="rcuQ6b:npT2md"><img src="https://storage.googleapis.com/gweb-cloudblog-publish/images/1_Cloud_TPU_v4.max-1100x1100.jpg" alt="https://storage.googleapis.com/gweb-cloudblog-publish/images/1_Cloud_TPU_v4.max-1100x1100.jpg" jsname="P3Vluc" jsaction="click:HTIlC" loading="lazy"/><section role="dialog" aria-modal="true"><img src="https://storage.googleapis.com/gweb-cloudblog-publish/images/1_Cloud_TPU_v4.max-1100x1100.jpg" alt="https://storage.googleapis.com/gweb-cloudblog-publish/images/1_Cloud_TPU_v4.max-1100x1100.jpg" jsname="P3Vluc" jsaction="click:HTIlC" loading="lazy"/></section></section></figure><p><span jsaction="rcuQ6b:npT2md" jscontroller="YSybTb" data-track-type="" soy-skip="" ssk="5:kbe95"><i>One eighth of a TPU v4 pod from Google&#39;s <a href="https://cloud.google.com/blog/products/compute/google-unveils-worlds-largest-publicly-available-ml-cluster">world’s largest publicly available ML cluster</a> </i></span></p></section></section><section><span jsaction="rcuQ6b:npT2md" jscontroller="YSybTb" data-track-type="" soy-skip="" ssk="5:kbe95"><p>TPU v4 is the first supercomputer to deploy a reconfigurable OCS. OCSes dynamically reconfigure their interconnect topology to improve scale, availability, utilization, modularity, deployment, security, power, and performance. Much cheaper, lower power, and faster than Infiniband, OCSes and underlying optical components are &lt;5% of TPU v4’s system cost and &lt;5% of system power. <a href="https://dl.acm.org/doi/pdf/10.1145/2829988.2787508" target="_blank">The figure below shows how an OCS works</a>, using two MEMs arrays. No optical to electrical to optical conversion or power-hungry network packet switches are required, saving power.</p></span></section><section><section><figure><section jscontroller="SCGBie" jsaction="rcuQ6b:npT2md"><img src="https://storage.googleapis.com/gweb-cloudblog-publish/images/2_Cloud_TPU_v4.max-1400x1400.jpg" alt="https://storage.googleapis.com/gweb-cloudblog-publish/images/2_Cloud_TPU_v4.max-1400x1400.jpg" jsname="P3Vluc" jsaction="click:HTIlC" loading="lazy"/><section role="dialog" aria-modal="true"><img src="https://storage.googleapis.com/gweb-cloudblog-publish/images/2_Cloud_TPU_v4.max-1400x1400.jpg" alt="https://storage.googleapis.com/gweb-cloudblog-publish/images/2_Cloud_TPU_v4.max-1400x1400.jpg" jsname="P3Vluc" jsaction="click:HTIlC" loading="lazy"/></section></section></figure></section></section><section><span jsaction="rcuQ6b:npT2md" jscontroller="YSybTb" data-track-type="" soy-skip="" ssk="5:kbe95"><p>The combination of powerful yet efficient processors and a distributed shared memory system provides remarkable scalability for deep neural network models. The scalability of TPU v4 production workloads on a variety of model types is shown below on a log-log scale.</p></span></section><section><section><figure><section jscontroller="SCGBie" jsaction="rcuQ6b:npT2md"><img src="https://storage.googleapis.com/gweb-cloudblog-publish/images/3_Cloud_TPU_v4.max-1200x1200.jpg" alt="https://storage.googleapis.com/gweb-cloudblog-publish/images/3_Cloud_TPU_v4.max-1200x1200.jpg" jsname="P3Vluc" jsaction="click:HTIlC" loading="lazy"/><section role="dialog" aria-modal="true"><img src="https://storage.googleapis.com/gweb-cloudblog-publish/images/3_Cloud_TPU_v4.max-1200x1200.jpg" alt="https://storage.googleapis.com/gweb-cloudblog-publish/images/3_Cloud_TPU_v4.max-1200x1200.jpg" jsname="P3Vluc" jsaction="click:HTIlC" loading="lazy"/></section></section></figure></section></section><section><span jsaction="rcuQ6b:npT2md" jscontroller="YSybTb" data-track-type="" soy-skip="" ssk="5:kbe95"><p>Dynamic OCS reconfigurability also helps with availability. Circuit switching makes it easy to route around failed components so that long-running tasks like ML training can utilize thousands of processors for weeks at a time. This flexibility even allows us to change the topology of the supercomputer interconnect to accelerate the performance of an ML model.</p><p>The performance, scalability, and availability make TPU supercomputers the workhorses of large language models like LaMDA, MUM, and <a href="https://ai.googleblog.com/2022/04/pathways-language-model-palm-scaling-to.html" target="_blank">PaLM</a>. The 540B-parameter PaLM model sustained a remarkable <i>57.8% of the peak hardware floating point performance over 50 days</i> while training on TPU v4 supercomputers. TPU v4’s scalable interconnect also unlocks multidimensional model-partitioning techniques that enable <a href="https://arxiv.org/abs/2211.05102" target="_blank">low-latency, high-throughput inference</a> for these LMs.</p><p>TPU supercomputers are also the first with hardware support for embeddings, a key component of Deep Learning Recommendation Models (DLRMs) used in advertising, search ranking, YouTube, and Google Play. Each TPU v4 includes third-generation SparseCores, dataflow processors that accelerate models that rely on embeddings by 5x–7x yet use only 5% of die area and power. </p><p>The performance of an internal recommendation model on CPUs, TPU v3, TPU v4, and TPU v4 with embeddings in CPU memory (not using SparseCore) is shown below. The TPU v4 SparseCore is 3X faster than TPU v3 on recommendation models, and 5–30X faster than systems using CPUs.</p></span></section><section><section><figure><section jscontroller="SCGBie" jsaction="rcuQ6b:npT2md"><img src="https://storage.googleapis.com/gweb-cloudblog-publish/images/4_Cloud_TPU_v4.max-1200x1200.jpg" alt="https://storage.googleapis.com/gweb-cloudblog-publish/images/4_Cloud_TPU_v4.max-1200x1200.jpg" jsname="P3Vluc" jsaction="click:HTIlC" loading="lazy"/><section role="dialog" aria-modal="true"><img src="https://storage.googleapis.com/gweb-cloudblog-publish/images/4_Cloud_TPU_v4.max-1200x1200.jpg" alt="https://storage.googleapis.com/gweb-cloudblog-publish/images/4_Cloud_TPU_v4.max-1200x1200.jpg" jsname="P3Vluc" jsaction="click:HTIlC" loading="lazy"/></section></section></figure></section></section><section><span jsaction="rcuQ6b:npT2md" jscontroller="YSybTb" data-track-type="" soy-skip="" ssk="5:kbe95"><p>Embeddings processing requires significant all-to-all communication, since the embeddings are distributed around TPU chips working together on a model. This pattern stresses the bandwidth of the shared memory interconnect. That’s why TPU v4 uses a 3D torus interconnect (vs. TPU v2 and v3 which used a 2D torus). TPU v4’s 3D torus provides a higher bisection bandwidth — i.e., the bandwidth from one half of the chips to the other half across the middle of the interconnect — to help support the larger number of chips and the higher SparseCore v3 performance. The figure below shows the significant bandwidth and performance increase from the 3D torus.</p></span></section><section><section><figure><section jscontroller="SCGBie" jsaction="rcuQ6b:npT2md"><img src="https://storage.googleapis.com/gweb-cloudblog-publish/images/5_Cloud_TPU_v4.max-900x900.jpg" alt="https://storage.googleapis.com/gweb-cloudblog-publish/images/5_Cloud_TPU_v4.max-900x900.jpg" jsname="P3Vluc" jsaction="click:HTIlC" loading="lazy"/><section role="dialog" aria-modal="true"><img src="https://storage.googleapis.com/gweb-cloudblog-publish/images/5_Cloud_TPU_v4.max-900x900.jpg" alt="https://storage.googleapis.com/gweb-cloudblog-publish/images/5_Cloud_TPU_v4.max-900x900.jpg" jsname="P3Vluc" jsaction="click:HTIlC" loading="lazy"/></section></section></figure></section></section><section><span jsaction="rcuQ6b:npT2md" jscontroller="YSybTb" data-track-type="" soy-skip="" ssk="5:kbe95"><p>TPU v4 has been operational at Google since 2020 and became available for customers on Google Cloud <a href="https://cloud.google.com/blog/products/compute/google-unveils-worlds-largest-publicly-available-ml-cluster">last year</a>. Since its launch, TPU v4 supercomputers have been actively used by leading AI teams around the globe for cutting-edge ML research and production workloads across language models, recommender systems and generative AI. For example, the <a href="https://blog.allenai.org/cloud-tpus-unlock-many-large-scale-high-impact-projects-at-ai2-7aca9229e2c6" target="_blank">Allen Institute for AI</a>, a non-profit institute founded by Paul Allen with the mission of conducting high-impact AI research for the common good, greatly benefitted from TPU v4 architecture and was able to unlock many of their large-scale, high-impact research initiatives. </p><p>“More recently, a number of researchers have turned to Cloud TPUs for their easy ability to distribute across many processing units. With GPUs, once you scale beyond a single machine you need to adjust your code for distribution and you might be disappointed by the connection speeds between your servers,” said Michael Schmitz, Senior Director of Engineering, Allen Institute for AI. “But with Cloud TPUs you can seamlessly scale individual workloads to thousands of chips, where all chips are directly connected to each other via a high-speed mesh network.”</p><p><a href="https://www.googlecloudpresscorner.com/2023-03-14-Midjourney-Selects-Google-Cloud-to-Power-AI-Generated-Creative-Platform" target="_blank">Midjourney</a>, one of the leading text-to-image AI startups, have been using Cloud TPU v4 to train their state-of-the-art model, coincidentally also called “version four”. </p><p>&#34;We’re proud to work with Google Cloud to deliver a seamless experience for our creative community powered by Google’s globally scalable infrastructure,” said David Holz, founder and CEO of Midjourney. “From training the fourth version of our algorithm on the latest v4 TPUs with JAX, to running inference on GPUs, we have been impressed by the speed at which TPU v4 allows our users to bring their vibrant ideas to life.”</p><p>We are proud to share additional details of our TPU v4 research in a <a href="https://arxiv.org/abs/2304.01433" target="_blank">paper</a> that will be presented at the <a href="https://iscaconf.org/isca2023/" target="_blank">International Symposium on Computer Architecture</a>, and we look forward to discussing our findings with the community. </p><hr/><p><i><sup>The authors thank many of Google&#39;s engineering and product teams for making TPU v4 a success story. We also want to thank Amin Vahdat, Mark Lohmeyer, Maud Texier, James Bradbury and Max Sapozhnikov for their contributions to this blog post.</sup></i><br/></p><p><i><sup>1. This ~20x improvement comes from a combination of: ~2-3x more energy efficient TPUs, ~1.4x lower <a href="https://en.wikipedia.org/wiki/Power_usage_effectiveness" target="_blank">PUE</a> of Google data centers relative to on-premise data centers, and ~6x for the cleaner energy in Oklahoma that houses all Cloud TPU v4 supercomputers versus the average energy cleanliness of the typical on-premise data center.</sup></i></p></span></section><section><section><span>Posted in</span><ul><li><a href="https://cloud.google.com/blog/topics/systems" track-metadata-position="body" track-metadata-eventdetail="cloud.google.com/blog/topics/systems" track-metadata-module="tag list" track-metadata-module_headline="posted in">Systems</a></li><li><a href="https://cloud.google.com/blog/products/ai-machine-learning" track-metadata-position="body" track-metadata-eventdetail="cloud.google.com/blog/products/ai-machine-learning" track-metadata-module="tag list" track-metadata-module_headline="posted in">AI &amp; Machine Learning</a></li><li><a href="https://cloud.google.com/blog/products/compute" track-metadata-position="body" track-metadata-eventdetail="cloud.google.com/blog/products/compute" track-metadata-module="tag list" track-metadata-module_headline="posted in">Compute</a></li></ul></section></section></div></div>
  </body>
</html>
