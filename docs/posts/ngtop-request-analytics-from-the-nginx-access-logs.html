<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/facundoolano/ngtop">Original</a>
    <h1>Ngtop â€“ Request analytics from the Nginx access logs</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">ngtop is a command-line program to query request counts from nginx&#39;s access.log files.</p>
<div data-snippet-clipboard-copy-content="$ ngtop url user_agent --since 1d --where url=/blog/% --where status=200 --limit 5
PATH                                             USER_AGENT     #REQS
/blog/deconstructing-the-role-playing-videogame/ Safari         120
/blog/on-ai-assistance/                          Go-http-client 101
/blog/a-note-on-essential-complexity/            Safari         91
/blog/deconstructing-the-role-playing-videogame/ Chrome         84
/blog/from-rss-to-my-kindle/                     Safari         79"><pre><code>$ ngtop url user_agent --since 1d --where url=/blog/% --where status=200 --limit 5
PATH                                             USER_AGENT     #REQS
/blog/deconstructing-the-role-playing-videogame/ Safari         120
/blog/on-ai-assistance/                          Go-http-client 101
/blog/a-note-on-essential-complexity/            Safari         91
/blog/deconstructing-the-role-playing-videogame/ Chrome         84
/blog/from-rss-to-my-kindle/                     Safari         79
</code></pre></div>

<p dir="auto">Download the <a href="https://github.com/facundoolano/ngtop/releases/latest">latest release binary</a> for your platform, for example:</p>
<div data-snippet-clipboard-copy-content="$ wget https://github.com/facundoolano/ngtop/releases/latest/download/ngtop-linux-arm64  \
    -O ngtop &amp;&amp; chmod +x ngtop &amp;&amp; mv ngtop /usr/local/bin"><pre><code>$ wget https://github.com/facundoolano/ngtop/releases/latest/download/ngtop-linux-arm64  \
    -O ngtop &amp;&amp; chmod +x ngtop &amp;&amp; mv ngtop /usr/local/bin
</code></pre></div>
<p dir="auto">Alternatively, install with go:</p>
<div data-snippet-clipboard-copy-content="$ go install github.com/facundoolano/ngtop@latest"><pre><code>$ go install github.com/facundoolano/ngtop@latest
</code></pre></div>

<p dir="auto">Count requests from the last hour:</p>
<div data-snippet-clipboard-copy-content="$ ngtop --since 1h
$ ngtop -s 1h
$ ngtop"><pre><code>$ ngtop --since 1h
$ ngtop -s 1h
$ ngtop
</code></pre></div>
<p dir="auto">Count requests from the last second, minute, day, week, or month:</p>
<div data-snippet-clipboard-copy-content="$ ngtop -s 1s
$ ngtop -s 1m
$ ngtop -s 1d
$ ngtop -s 1w
$ ngtop -s 1M"><pre><code>$ ngtop -s 1s
$ ngtop -s 1m
$ ngtop -s 1d
$ ngtop -s 1w
$ ngtop -s 1M
</code></pre></div>
<p dir="auto">Count requests from the day before:</p>
<div data-snippet-clipboard-copy-content="$ ngtop --since 2d --until 1d
$ ngtop -s 2d -u 1d"><pre><code>$ ngtop --since 2d --until 1d
$ ngtop -s 2d -u 1d
</code></pre></div>
<p dir="auto">Show the top 5 urls in the last hour:</p>

<p dir="auto">Show the top 5 urls in the last minute:</p>

<p dir="auto">Show the top 10 urls in the last hour:</p>
<div data-snippet-clipboard-copy-content="$ ngtop url --limit 10
$ ngtop url -l 10"><pre><code>$ ngtop url --limit 10
$ ngtop url -l 10
</code></pre></div>
<p dir="auto">Count total requests to a specific url in the last hour:</p>
<div data-snippet-clipboard-copy-content="$ ngtop --where url=/blog/code-is-run-more-than-read
$ ngtop --where path=/blog/code-is-run-more-than-read
$ ngtop -w url=/blog/code-is-run-more-than-read"><pre><code>$ ngtop --where url=/blog/code-is-run-more-than-read
$ ngtop --where path=/blog/code-is-run-more-than-read
$ ngtop -w url=/blog/code-is-run-more-than-read
</code></pre></div>
<p dir="auto">Count total requests to urls matching a pattern:</p>

<p dir="auto">Count total requests to urls excluding a value or pattern:</p>
<div data-snippet-clipboard-copy-content="$ ngtop -w url!=/feed.xml
$ ngtop -w url!=/feed%"><pre><code>$ ngtop -w url!=/feed.xml
$ ngtop -w url!=/feed%
</code></pre></div>
<p dir="auto">Count total requests to one of mutliple urls (one OR another):</p>
<div data-snippet-clipboard-copy-content="$ ngtop -w url=/blog/code-is-run-more-than-read -w url=/blog/a-note-on-essential-complexity"><pre><code>$ ngtop -w url=/blog/code-is-run-more-than-read -w url=/blog/a-note-on-essential-complexity
</code></pre></div>
<p dir="auto">Count total requests to a specific urls AND referer:</p>
<div data-snippet-clipboard-copy-content="$ ngtop -w url=/blog/code-is-run-more-than-read -w referer=news.ycombinator.com"><pre><code>$ ngtop -w url=/blog/code-is-run-more-than-read -w referer=news.ycombinator.com
</code></pre></div>
<p dir="auto">Show the top visited urls matching a pattern:</p>
<div data-snippet-clipboard-copy-content="$ ngtop url -w url=/blog/%"><pre><code>$ ngtop url -w url=/blog/%
</code></pre></div>
<p dir="auto">Show the top requesting ips:</p>

<p dir="auto">Show the top url visits by ip:</p>
<div data-snippet-clipboard-copy-content="$ ngtop url -w ip=77.16.76.86"><pre><code>$ ngtop url -w ip=77.16.76.86
</code></pre></div>
<p dir="auto">Show the top user agents by url:</p>
<div data-snippet-clipboard-copy-content="$ ngtop user_agent -w url=/blog/code-is-run-more-than-read
$ ngtop ua -w url=/blog/code-is-run-more-than-read"><pre><code>$ ngtop user_agent -w url=/blog/code-is-run-more-than-read
$ ngtop ua -w url=/blog/code-is-run-more-than-read
</code></pre></div>
<p dir="auto">Show the top urls by user agent details (parsed with <a href="https://pkg.go.dev/github.com/mileusna/useragent" rel="nofollow">mileusna/useagent</a>):</p>
<div data-snippet-clipboard-copy-content="$ ngtop url -w ua=Firefox
$ ngtop url -w ua_type=bot
$ ngtop url -w device=iPhone
$ ngtop url -w os=Linux"><pre><code>$ ngtop url -w ua=Firefox
$ ngtop url -w ua_type=bot
$ ngtop url -w device=iPhone
$ ngtop url -w os=Linux
</code></pre></div>
<p dir="auto">Show the top referers for a url pattern:</p>
<div data-snippet-clipboard-copy-content="$ ngtop referer -w url=/blog/%"><pre><code>$ ngtop referer -w url=/blog/%
</code></pre></div>
<p dir="auto">Show the top user agent and referer combination</p>

<p dir="auto">Show the top user agent and referer combination for a specific url</p>
<div data-snippet-clipboard-copy-content="$ ngtop ua referer -w url=/blog/code-is-run-more-than-read"><pre><code>$ ngtop ua referer -w url=/blog/code-is-run-more-than-read
</code></pre></div>
<p dir="auto">Count total 404 status responses:</p>

<p dir="auto">Count non successful responses:</p>
<div data-snippet-clipboard-copy-content="$ ngtop status -w status=4% -status=5%"><pre><code>$ ngtop status -w status=4% -status=5%
</code></pre></div>

<ul dir="auto">
<li>Whenever the program is run, it looks for the nginx access.logs, parses them and stores the data into an SQLite DB.
<ul dir="auto">
<li>By default, the logs are looked up at <code>/var/log/nginx/access.log*</code>, which can be overridden with the <code>NGTOP_LOGS_PATH</code> environment variable.</li>
<li>By default, the logs are assumed to have the <a href="https://nginx.org/en/docs/http/ngx_http_log_module.html#log_format" rel="nofollow">nginx combined log format</a>. The format can be customized with <code>NGTOP_LOG_FORMAT</code>.
<ul dir="auto">
<li>This could likely be made to work with non nginx logs, although that hasn&#39;t been tested.</li>
</ul>
</li>
<li>Subsequent runs of the program only parse and store the logs up until the time of the previous run.</li>
<li>The SQLite DB is stored at <code>./ngtop.db</code>, which can be overridden with the <code>NGTOP_DB</code> environment variable.</li>
</ul>
</li>
<li>The command line arguments express a filtering criteria, used to build the SQL query that counts the requests.
<ul dir="auto">
<li>For instance, the command <code>ngtop url -w url=/blog/%</code> produces:
<div dir="auto" data-snippet-clipboard-copy-content="SELECT path,count(1) &#39;#reqs&#39; FROM access_logs
WHERE time &gt; ? AND time &lt; ? AND (path LIKE ?)
GROUP BY 1
ORDER BY count(1)
DESC LIMIT 5"><pre><span>SELECT</span> <span>path</span>,<span>count</span>(<span>1</span>) <span><span>&#39;</span>#reqs<span>&#39;</span></span> <span>FROM</span> access_logs
<span>WHERE</span> <span>time</span> <span>&gt;</span> ? <span>AND</span> <span>time</span> <span>&lt;</span> ? <span>AND</span> (<span>path</span> <span>LIKE</span> ?)
<span>GROUP BY</span> <span>1</span>
<span>ORDER BY</span> <span>count</span>(<span>1</span>)
<span>DESC</span> <span>LIMIT</span> <span>5</span></pre></div>
</li>
</ul>
</li>
</ul>

<p dir="auto">The command-line arguments and flags are intended exclusively to express a requests count query. The configuration, which isn&#39;t expected to change across command invocations, is left to environment variables:</p>
<ul dir="auto">
<li><code>NGTOP_LOGS_PATH</code>: path pattern to find the nginx access logs. Defaults to <code>/var/log/nginx/access.log*</code>. The pattern is expanded using Go&#39;s <a href="https://pkg.go.dev/path/filepath#Glob" rel="nofollow"><code>path/filepath.Glob</code></a>.</li>
<li><code>NGTOP_LOG_FORMAT</code>: The <a href="https://nginx.org/en/docs/http/ngx_http_log_module.html#log_format" title="
" rel="nofollow">nginx log_format</a> specification to parse the log entries. By default combined logs are assumed, which is equivalent to:
<div data-snippet-clipboard-copy-content="NGTOP_LOG_FORMAT=&#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; $status $body_bytes_sent &#34;$http_referer&#34; &#34;$http_user_agent&#34;&#39;"><pre><code>NGTOP_LOG_FORMAT=&#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; $status $body_bytes_sent &#34;$http_referer&#34; &#34;$http_user_agent&#34;&#39;
</code></pre></div>
</li>
<li><code>NGTOP_DEBUG</code>: when set, internal logs will be printed to standard output.</li>
<li><code>NGTOP_DB</code>: location of the SQLite db where the parsed logs are stored. Defaults to <code>./ngtop.db</code>.</li>
</ul>
</article></div></div>
  </body>
</html>
