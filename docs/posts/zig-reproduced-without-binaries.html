<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jakstys.lt/2024/zig-reproduced-without-binaries/">Original</a>
    <h1>Zig Reproduced Without Binaries</h1>
    
    <div id="readability-page-1" class="page"><div>
  
    <div>
      <p>I decided to bootstrap Zig without using binaries that are <a href="https://github.com/ziglang/zig/blob/0.13.0/stage1/zig1.wasm">checked in the
repository</a> and
answer if the resulting <code>zig1.wasm</code> in the latest Zig release (0.13.0) is the
same the one bootstrapped without using those binaries.</p>
<p>TLDR: yes, they are the same:</p>
<pre tabindex="0"><code>$ sha256sum code/zig{,2}/stage1/zig1.wasm
127909fb8c9610ce3f296d8a48014546c0f85055115002fb3aba4d865dcdbb27  code/zig/stage1/zig1.wasm
127909fb8c9610ce3f296d8a48014546c0f85055115002fb3aba4d865dcdbb27  code/zig2/stage1/zig1.wasm
</code></pre><p>I can now confidently say (and you can also check, you don‚Äôt need to <a href="https://www.cs.cmu.edu/~rdriley/487/papers/Thompson_1984_ReflectionsonTrustingTrust.pdf">trust
me</a>) that there is nothing hiding in <code>zig1.wasm</code> that hasn‚Äôt been
checked-in as a source file.</p>
<p>Many, many thanks to <a href="https://ultrarare.space/">Hilton Chain</a> for reasons I that will become clear
later. The rest of this post walks through how I arrived to this claim.</p>

<p>Steps to acquire the official incarnation of <code>zig1.wasm</code> are straightforward:
download Zig, build <code>zig3</code> using the official instructions, use it to
<code>update-zig1</code>:</p>
<pre tabindex="0"><code>git clone https://github.com/ziglang/zig; cd zig
git checkout 0.13.0
mkdir build; pushd build
  cmake ..
  make -j$(nproc) install
popd
build/stage3/bin/zig build update-zig1
</code></pre><p>Which results in an updated <code>code/zig/stage1/zig1.wasm</code>:</p>
<pre tabindex="0"><code>$ git diff --stat
 stage1/zig1.wasm | Bin 2675178 -&gt; 2800926 bytes
 1 file changed, 0 insertions(+), 0 deletions(-)
</code></pre><p>We will be comparing this file to the one bootstrapped in the next section.</p>

<p>Builting zig 0.13.0 without binaries is tricky, because to build zig 0.13.0, we
need a <code>zig1.wasm</code>, which has been checked in and continuously updated since
<a href="https://github.com/ziglang/zig/pull/13560">late 2022</a>:</p>
<pre tabindex="0"><code>commit 20d86d9c63476b6312b87dc5b0e4aa4822eb7717
Author: Andrew Kelley &lt;andrew@ziglang.org&gt;
Date:   2022-11-13T01:35:20+02:00

    add zig1.wasm.zst
    
    This commit adds a 637 KB binary file to the source repository. This
    commit does nothing else, so it should be replaced with a different
    commit before this branch is merged to avoid bloating the git
    repository.

 stage1/zig1.wasm.zst | Bin 0 -&gt; 652012 bytes
 1 file changed, 0 insertions(+), 0 deletions(-)
</code></pre><p><a href="https://ziglang.org/news/goodbye-cpp/">Andrew‚Äôs motivation</a> is reasonable from a Zig developer‚Äôs perspective.
However, checked-in binary blobs have trust issues, regardless of what we think
about the author.</p>
<p>The last commit that can<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup> be built without using binary blobs is the parent
of this one:</p>
<pre tabindex="0"><code>commit 28514476ef8c824c3d189d98f23d0f8d23e496ea
Author: Andrew Kelley &lt;andrew@ziglang.org&gt;
Date:   2022-11-01T05:29:55+02:00

    remove `-fstage1` option

    After this commit, the self-hosted compiler does not offer the option to
    use stage1 as a backend anymore.
</code></pre><p>After this, Zig is required to build Zig. This is a cyclic dependency, which
Zig Core team breaks by continuously checking in <em>a</em> Zig compiler in
wasm, the <code>zig1.wasm</code> file, which is used to build the compiler.</p>
<p>Andrew suggests a motivated third-party to implement a <a href="https://ziggit.dev/t/building-self-hosted-from-the-original-c-implementation/6607/2?u=motiejus">Zig
interpreter</a> in non-Zig that could break this chain. While
that would be certainly be ideal, nobody has built it yet ü§∑.</p>
<p>The steps to build ‚Äútrusted‚Äù<sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup> Zig are roughly:</p>
<ol>
<li>Build Zig from the C++ implementation of the commit above (with hacks and
tricks to make it <a href="https://ziggit.dev/t/building-self-hosted-from-the-original-c-implementation/6607?u=motiejus">actually compile</a>).</li>
<li>Use previous step to build the first Zig self-hosted.</li>
<li>Proceed to the next step. When the updated Zig does not build, find creative
ways to build it anyway (or, when really stuck, ask @mlugg).</li>
<li>Goto 2 for <a href="https://git.jakstys.lt/motiejus/zig-repro/src/commit/7f37da6e75cab9d4637b8173d713f91853c9ef54/run#L1032-L1076">45+ times</a>.</li>
</ol>
<p>After reaching <code>0.11.0-1894-gb92e30ff0b</code>, which is two <code>zig1.wasm</code> updates away
from 0.12.0, I received an email from Hilton Chain, titled <code>Thank you for the work on bootstrapping Zig!</code>, where they took my PoC, <a href="https://issues.guix.gnu.org/74217">re-created all of it in
Guix DSL</a> and ran all the way to 0.13.0<sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup>. This made me flabbergasted.</p>
<p>I audited their script to see if it really deletes <code>zig1.wasm</code> at every
checkout, ran it to produce <code>zig1.wasm</code> of <code>0.13.0</code> myself:</p>
<pre tabindex="0"><code>$ ./pre-inst-env guix build zig@0.13
&lt; ... a few hours ... &gt;
/gnu/store/mz95707dd7qmycpr1f0ndxhkmx3vdy1c-zig-0.13.0
/gnu/store/kqwq8sjgwi561sp78vfi6xkgm9i3wysk-zig-0.13.0-zig1
$ ls -l /gnu/store/kqwq8sjgwi561sp78vfi6xkgm9i3wysk-zig-0.13.0-zig1/bin/zig1.wasm 
-r--r--r-- 5 root root 2661492 Jan  1  1970 /gnu/store/kqwq8sjgwi561sp78vfi6xkgm9i3wysk-zig-0.13.0-zig1/bin/zig1.wasm
</code></pre><p>Once I had <code>zig1.wasm</code> of 0.13.0, I did the same as I did in the official
<code>zig1.wasm</code>: built <code>zig3</code>, used it to build <code>zig1.wasm</code>, and voil√†, the hashes of
the official <code>zig1.wasm</code> and the one built here match.</p>

<p>I am looking forward to Hilton landing this to Guix, so anyone can audit the
build script and reproduce this exercise by themselves with an otherwise
<a href="https://guix.gnu.org/en/blog/2023/the-full-source-bootstrap-building-from-source-all-the-way-down/">bootstrappable</a> system. If you don‚Äôt trust Guix, what and whom do you
trust?</p>
<p>If anyone can trace origins of <code>zig1.wasm</code> by producing an identical version
themselves, perhaps it‚Äôs not too bad to trust it and have it checked in?</p>

</div>
  
  </div></div>
  </body>
</html>
