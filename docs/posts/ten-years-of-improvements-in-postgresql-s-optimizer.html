<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://rmarcus.info/blog/2024/04/12/pg-over-time.html">Original</a>
    <h1>Ten years of improvements in PostgreSQL&#39;s optimizer</h1>
    
    <div id="readability-page-1" class="page"><p><img srcset="/blog/assets/me-2022-150px.avif 150w,
                     /blog/assets/me-2022-300px.avif 300w,
                     /blog/assets/me-2022-600px.avif 600w,
                     /blog/assets/me-2022-1200px.avif 1200w," src="https://www.youtube.com/blog/assets/me.jpg" sizes="150px" alt="headshot of Ryan"/>
      
        
      Ryan Marcus, assistant professor at the University of Pennsylvania (Fall &#39;23). Using machine learning to build the next generation of data systems.
    </p><div id="mainHeader">
      <div id="ascii-art">
        <pre id="ascii-large">      
    ____                       __  ___                          
   / __ \__  ______ _____     /  |/  /___ _____________  _______
  / /_/ / / / / __ `/ __ \   / /|_/ / __ `/ ___/ ___/ / / / ___/
 / _, _/ /_/ / /_/ / / / /  / /  / / /_/ / /  / /__/ /_/ (__  ) 
/_/ |_|\__, /\__,_/_/ /_/  /_/  /_/\__,_/_/   \___/\__,_/____/  
      /____/                                                    
        </pre>
        <pre id="ascii-small">   ___                   __  ___                    
  / _ \__ _____ ____    /  |/  /__ ___________ _____
 / , _/ // / _ `/ _ \  / /|_/ / _ `/ __/ __/ // (_-&lt;
/_/|_|\_, /\_,_/_//_/ /_/  /_/\_,_/_/  \__/\_,_/___/
     /___/                                          
        </pre>
        <pre id="ascii-very-small">   ___  __  ___                    
  / _ \/  |/  /__ ___________ _____
 / , _/ /|_/ / _ `/ __/ __/ // (_-&lt;
/_/|_/_/  /_/\_,_/_/  \__/\_,_/___/                                   
        </pre>
      </div>
      

      

    </div><div id="rcmContent">
      <div>
  
  <p>12 Apr 2024</p>
  <p>As a query optimization researcher, I’ve spent the last 10 years of my life playing with, learning from, and building on top of the most sophisticated open source query optimizer out there, <a href="https://postgresql.org">PostgreSQL</a>. I recently wondered how much PostgreSQL had improved over the decade since I started working on databases. While changelogs and opinion pieces were plentiful, I couldn’t find any strong empirical comparisons, so I decided to run the <a href="https://www.vldb.org/pvldb/vol9/p204-leis.pdf">join order benchmark</a> (JOB)<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" rel="footnote">1</a></sup> on PostgreSQL 8 through 16. I recorded the 90th percentile query latency for each database version.</p>

<p><img src="https://www.youtube.com/blog/assets/pg_over_time/job.svg" alt="Graph of P90 tail latency for different PostgreSQL versions. Speed improves drastically over time."/></p>

<p>I built each version<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" rel="footnote">2</a></sup> of PostgreSQL using GCC 13.2 inside a Docker container with Arch Linux. Since I wanted to measure the quality of the query optimizer, and not index/IO performance, I set <code>shared_buffers</code> to 8GB (large enough to hold the entire database). I also set <code>work_mem</code> to 8MB for all versions. Each query is executed once to warm the cache, then the median latency of 5 additional runs in recorded.</p>

<p>Overall, <strong>PostgreSQL’s tail performance has improved drastically</strong>, although versions 13 through 16 have been mostly stable. Comparing version 8 to version 16, <strong>PostgreSQL’s optimizer has dropped tail latency by nearly half in the last 10 years!</strong></p>

<p>We can also investigate the entire query distribution (note the log scale):</p>

<p><img src="https://www.youtube.com/blog/assets/pg_over_time/box.svg" alt="Box plots of query latency for each major version. There is a slight slope downwards."/></p>

<p>We can use regression analysis to (1) confirm that the downward slope in latency is significant, and (2) quantify how much improvement is brought by each version of PostgreSQL. If we regress the PostgreSQL major version number against query latency, we see that each new major version of PostgreSQL brings, on average, a <strong>15% performance improvement</strong> on the Join Order Benchmark (<span id="il180"></span>). However, a linear model is arguably a poor measure of the change (<span id="il181"></span>).</p>

<p>Of course, not all of these improvements are attributable to the query optimizer. Improvements to the execution engine – from parallel workers to just-in-time (JIT) compilation – also play a role. It would be interesting to investigate how each query plan in JOB has changed over the year… maybe next time!</p>

<p>Quantifying the improvement aside:</p>

<ul>
  <li>Upgrade your database! Going from PostgreSQL 8 to 16 has the potential to massively improve your workload’s tail latency.</li>
  <li>Researchers should note that PostgreSQL is a bit of a moving target. Learned query optimization research has compared with different versions of PostgreSQL over time (e.g., Neo and Bao compare with version 11, whereas newer work compare with version 14, 15, or 16.) So just because an older technique improves on PostgreSQL by 30%, and a newer technique only improves on PostgreSQL by 25%, the newer technique may be comparing against a stronger PostgreSQL.</li>
</ul>

<p>You can also check out <a href="https://www.youtube.com/blog/assets/pg_over_time/job_pg.csv">the raw data</a> for yourself.</p>

<h2 id="notes">Notes</h2>



</div>







    </div></div>
  </body>
</html>
