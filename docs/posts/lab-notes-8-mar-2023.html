<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://archvile.net/2023/03/08/lab.html">Original</a>
    <h1>Lab Notes: 8 Mar 2023</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p>Hello! It is once again 2 PM. This morning, I took Eamon to the Natural History Museum. It’s an OK museum. This is the museum we visit least because there isn’t much there that captures Eamon’s fancy. Being two, he’s mostly into tactile stuff and being able to run around. That, and machines. Oh, does he love machines. I don’t mean trucks and stuff, though he loves those too. He loves the mechanical: clocks, robots, computers, and, especially, steam engines.</p>

<p>Anyway, back to computers. <a href="https://cyberdemon.org/2023/03/07/lab.html">Yesterday</a>, I ran a sysbench MySQL benchmark against a MySQL instance with capped resources (1 CPU and 1 GB memory). I also started to set up Ubuntu on an old MacBook I had laying around. Today, I want to get Docker running on that machine and run another benchmark. Today’s goal for the benchmark is to play with throughput: how many queries per second can I process? How will that affect the p95 request duration?</p>

<h3 id="meta-note">Meta-note</h3>
<p>A meta-note: I understand that these notes are nearly unreadable (and also probably not interesting to anyone). I <em>can</em> do something about readability: today I’m going to try breaking the notes up into clear sections. With regards to them being uninteresting, I do wonder why I’m publishing them at all! The reason is that, when I write them, I am imagining an audience (even though that audience probably doesn’t exist), and that helps motivate me and also forces me to make my thinking a bit more clear.</p>

<h2 id="installing-docker-engine-on-ubuntu-using-ansible">Installing Docker Engine on Ubuntu using Ansible</h2>
<p>Docker provides <a href="https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository">instructions for Ubuntu installation</a>, which boil down to trusting their GPG key, adding their repo, and installing. This is a good excuse to learn a bit about apt’s <code>sources.list</code> and why/how you use GPG keys to indicate trust.</p>

<h3 id="indicating-trust-of-a-repo">Indicating trust of a repo</h3>
<p>When you add a repo to <code>sources.list</code>, you can add a <code>signed-by</code> field. This field is described in the <a href="https://manpages.ubuntu.com/manpages/jammy/en/man5/sources.list.5.html">man page for sources.list</a>: “require a repository to pass <code>apt-secure</code> verification with a certain set of keys”. So, then, what is <code>apt-secure</code>? According to the <a href="https://manpages.ubuntu.com/manpages/kinetic/en/man8/apt-secure.8.html">man page for apt-secure</a>, it’s a way to check that a repo is controlled by who you <em>think</em> it’s controlled by. In other words, it’s a way to verify that the repo is trustworthy.</p>

<p>Let’s look at Docker’s instructions for adding its repo to explain the above.</p>
<div><div><pre><code><span>sudo mkdir</span> <span>-m</span> 0755 <span>-p</span> /etc/apt/keyrings
curl <span>-fsSL</span> https://download.docker.com/linux/ubuntu/gpg | <span>sudo </span>gpg <span>--dearmor</span> <span>-o</span> /etc/apt/keyrings/docker.gpg
</code></pre></div></div>

<p>Docker advertises a public key at <code>https://download.docker.com/linux/ubuntu/gpg</code>. We download it, and store it in <code>/etc/apt/keyrings</code> (indeed, that’s where the sources.list manpage recommends sysadmins put keyrings). What <code>gpg --dearmor -o</code> does I’m not sure, but clearly it’s storing the keyring.</p>

<p>Next, in the instructions we create a file <code>/etc/apt/sources.list.d/docker.list</code> that will configure the repo. The contents are:</p>
<div><div><pre><code><span>echo</span> <span>\</span>
  <span>&#34;deb [arch=</span><span>$(</span>dpkg <span>--print-architecture</span><span>)</span><span> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu </span><span>\</span><span>
  </span><span>$(</span>lsb_release <span>-cs</span><span>)</span><span> stable&#34;</span> | <span>sudo tee</span> /etc/apt/sources.list.d/docker.list <span>&gt;</span> /dev/null
</code></pre></div></div>

<p>See the <code>signed-by</code>? So, we’re saying that stuff we download from this repo needs to match that key.</p>

<p>(Side note: note how, like yesterday, we pipe the output into <code>sudo tee</code>? I now understand why. This is so that we can do the <code>echo</code> command without sudo, and then take the output and then use sudo <em>only</em> for writing the file. This is neat, and smart. It restricts escalation to the only part that actually <em>needs it</em>, that is, modifying <code>/etc/apt/sources.list.d</code>).</p>

<h3 id="what-happens-if-we-dont-specify-signed-by">What happens if we don’t specify signed-by?</h3>
<p>Actually, I’m interested in a little experiment. What will happen if I add the <code>deb</code> entry <em>without</em> signed-by? Is this repo trusted blindly? I’m going to guess no. If signed-by isn’t provided, the repo will be checked against some other set of keys, fail to match, and there will be an error or something.</p>

<p>Let’s try it.</p>
<div><div><pre><code><span>echo</span> <span>\</span>
  <span>&#34;deb [arch=</span><span>$(</span>dpkg <span>--print-architecture</span><span>)</span><span>] https://download.docker.com/linux/ubuntu </span><span>\</span><span>
  </span><span>$(</span>lsb_release <span>-cs</span><span>)</span><span> stable&#34;</span> | <span>sudo tee</span> /etc/apt/sources.list.d/docker.list <span>&gt;</span> /dev/null
</code></pre></div></div>

<p>And then <code>sudo apt update</code>.</p>

<p>Aha! Yes, it refused to do so.</p>
<div><div><pre><code>W: GPG error: https://download.docker.com/linux/ubuntu jammy InRelease: The following signatures couldn&#39;t be verified because the public key is not available: NO_PUBKEY 7EA0A9C3F273FCD8
E: The repository &#39;https://download.docker.com/linux/ubuntu jammy InRelease&#39; is not signed.
N: Updating from such a repository can&#39;t be done securely, and is therefore disabled by default.
N: See apt-secure(8) manpage for repository creation and user configuration details.
</code></pre></div></div>

<p>Note that this failure happened during <code>apt update</code>, <em>not</em> during the install step. This is because <code>apt-secure</code> verifies the repo, <em>not</em> packages.</p>

<p>If I install the keyring and reference it in <code>docker.list</code>, then <code>apt update</code> works fine:</p>
<div><div><pre><code>Get:4 https://download.docker.com/linux/ubuntu jammy InRelease [48.9 kB]
Hit:5 http://security.ubuntu.com/ubuntu jammy-security InRelease
Get:6 https://download.docker.com/linux/ubuntu jammy/stable amd64 Packages [13.6 kB]
</code></pre></div></div>

<h3 id="converting-dockers-instructions-to-an-ansible-playbook">Converting Docker’s instructions to an Ansible playbook</h3>
<p>DigitalOcean has a <a href="https://www.digitalocean.com/community/tutorials/how-to-use-ansible-to-install-and-set-up-docker-on-ubuntu-20-04">tutorial for installing Docker Engine using Ansible</a>, and it’s straightforward: to store the gpg key, we use the <code>apt_key</code> module, and to add the repo, we use the <code>apt_repository</code> module.</p>

<h3 id="is-ansibles-apt_key-module-safe-to-use">Is Ansible’s apt_key module safe to use?</h3>
<p>I’m curious, though, what <code>apt_key</code> actually does. This is important because there are some completely insecure ways to install a key. For example, if you install a key into <code>/etc/apt/trusted.gpg</code> or <code>/etc/apt/trusted.gpg.d</code>, then it will be trusted for <em>all</em> repos (which would mean that the key holder could trick you into installing malware).</p>

<p>Aha! In the <a href="https://github.com/ansible/ansible/blob/bfcb55777773572c9f96d266494049ccbb7cac50/lib/ansible/modules/apt_key.py">source</a>, it’s clear that <code>apt_key</code> uses the deprecated <code>apt-key</code> utility. It’s been <a href="https://manpages.ubuntu.com/manpages/xenial/man8/apt-key.8.html">deprecated</a> for the reason I gave above.</p>

<h3 id="avoiding-apt_key">Avoiding apt_key</h3>
<p>I’ll have to replace those steps with other commands. To download the key, I can use <code>get_url</code>, but what about the <code>gpg --dearmor</code> part? Looks like I’ll have to figure out what it does after all.</p>

<p>This is what <code>https://download.docker.com/linux/ubuntu/gpg</code> looks like:</p>
<div><div><pre><code>-----BEGIN PGP PUBLIC KEY BLOCK-----
mQINBFit2ioBEADhWpZ8/
[bunch of crap]
-----END PGP PUBLIC KEY BLOCK-----
</code></pre></div></div>

<p>Apparently, I need to “dearmor” this? Let’s try that and see what the output looks like.</p>
<div><div><pre><code>$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor
X��*�Z�|�
         ���s�@u�V����-��u�o�a��2�a����M�����_T�R`��
                                                    �弲)5���䷎ڐ�X��o^��U���.-��Ӿ��,P��An��L�
</code></pre></div></div>

<p>Binary!</p>

<p>OK, so, after a bit of <a href="https://unix.stackexchange.com/questions/623375/what-is-the-armored-option-for-in-gnupg">reading</a>, it seems that “armored” ASCII PGP keys are the old format, and the new format is binary. Anyway, I’ll need an extra step to dearmor the key. (There is much <a href="https://github.com/ansible/ansible/issues/78063">discussion</a> about this for the apt_key module, with unhappiness that we need two commands to properly install a key).</p>

<p>Actually, sounds like I can just reference the ASCII version in the <code>docker.list</code>, so I’ll just do that.</p>

<div><div><pre><code><span>-</span> <span>name</span><span>:</span> <span>Ensure that the /etc/apt/keyrings dir exists</span>
  <span>file</span><span>:</span>
    <span>path</span><span>:</span> <span>/etc/apt/keyrings</span>
    <span>state</span><span>:</span> <span>directory</span>
    <span>group</span><span>:</span> <span>root</span>
    <span>owner</span><span>:</span> <span>root</span>
    <span>mode</span><span>:</span> <span>0755</span>

<span>-</span> <span>name</span><span>:</span> <span>Add Docker GPG key</span>
  <span>get_url</span><span>:</span>
    <span>url</span><span>:</span> <span>https://download.docker.com/linux/ubuntu/gpg</span>
    <span>dest</span><span>:</span> <span>/etc/apt/keyrings/docker.asc</span>

<span>-</span> <span>name</span><span>:</span> <span>Add Docker repo</span>
  <span>vars</span><span>:</span>
    <span>architecture_map</span><span>:</span>
      <span>aarch64</span><span>:</span> <span>&#34;</span><span>arm64&#34;</span>
      <span>x86_64</span><span>:</span> <span>&#34;</span><span>amd64&#34;</span>
  <span>apt_repository</span><span>:</span>
    <span>filename</span><span>:</span> <span>docker</span>
    <span>repo</span><span>:</span> <span>&#39;</span><span>deb</span><span> </span><span>[arch=</span><span> </span><span>signed-by=/etc/apt/keyrings/docker.asc]</span><span> </span><span>https://download.docker.com/linux/ubuntu</span><span>  </span><span>stable&#39;</span>

<span>-</span> <span>name</span><span>:</span> <span>Install Docker stuff</span>
  <span>apt</span><span>:</span>
    <span>pkg</span><span>:</span>
      <span>-</span> <span>docker-ce</span>
      <span>-</span> <span>docker-ce-cli</span>
      <span>-</span> <span>containerd.io</span>
      <span>-</span> <span>docker-buildx-plugin</span>
      <span>-</span> <span>docker-compose-plugin</span>
</code></pre></div></div>

<p>(Kudos to <a href="https://file-explorers.club/@ezarowny">Eric Zarowny</a> for the nifty <code>architecture_map</code> conversion. Otherwise, I’d have been lazy and just hardcoded amd64).</p>

<p>Hooray! Another day where doing the simplest thing was difficult, but at least I learned something.</p>

<h3 id="oh-yeah-also-i-want-to-install-gh-cli-so-i-can-clone-the-repo-easily">Oh yeah, also I want to install GH CLI so I can clone the repo easily.</h3>
<p>The <a href="https://github.com/dmazin/host-setup/blob/68b474ba86cddd7ab7a746e1274cd822a83dbc6e/ansible/github.yaml">task</a> looks a lot like the Docker one, except following GH CLI’s <a href="https://github.com/cli/cli/blob/trunk/docs/install_linux.md#debian-ubuntu-linux-raspberry-pi-os-apt">official instructions</a>.</p>

<h3 id="can-i-actually-run-the-benchmark-now-please">Can I actually run the benchmark now, please?</h3>
<p>No! I ran out of time. Well, really what happened is that my kid cut his hand while peeling a carrot.</p>

<p>Tomorrow, I will actually run the benchmark.</p>

<p>If you read this far, maybe you’ll want to hear from me again.</p>
<ul>
  <li>Sign up to an <a href="https://cyberdemon.org/feed.xml">RSS feed of my posts on this site</a>.</li>
  <li><a href="https://file-explorers.club/@dmitry">Follow me on Mastodon</a>.</li>
  <li>Sign up to <a href="https://docs.google.com/forms/d/e/1FAIpQLSePJIQBenOoP1GGe26exOhgPCKdqgY4j36D_WAvhTzudcioWA/viewform?usp=sf_link">get my posts via email</a>.</li>
</ul>

<p>If you’d like to discuss this post, please do reach out! My email is <a href="">dm@archvile.net</a>.</p>

    
  </div>
</article>

      </div>
    </div></div>
  </body>
</html>
