<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://madebyme.today/blog/python-dict-vs-curly-brackets/">Original</a>
    <h1>Performance Analysis of Python&#39;s Dict() and {}</h1>
    
    <div id="readability-page-1" class="page"><div><p>Some time ago, during a code review, I had a discussion with a colleague of mine about preferring <code>dict()</code> over <code>{}</code> in
new Python code. They argued that <code>dict()</code> is more readable — and expresses intent more clearly — therefore should
be preferred. I wasn’t convinced by that, but at that time I didn’t have any counterarguments, so I passed.</p><p>Yet that made me wonder: what’s the difference between the <code>dict</code> type and <code>{}</code> literal expression?</p><p>Let’s go down the rabbit hole.</p><h2 id="pythons-dictionaries">Python’s dictionaries
<a href="#pythons-dictionaries" aria-label="Anchor"><i aria-hidden="true"></i></a></h2><p>First, let’s check what’s the performance difference between the two methods. I’ll use the <a href="https://docs.python.org/3.12/library/timeit.html"><code>timeit</code></a>
module for that.</p><div><pre tabindex="0"><code data-lang="sh"><span><span id="hl-0-1"><a href="#hl-0-1">1</a></span><span>$ python -m timeit <span>&#34;dict()&#34;</span>
</span></span><span><span id="hl-0-2"><a href="#hl-0-2">2</a></span><span><span>10000000</span> loops, best of 5: <span>40</span> nsec per loop
</span></span><span><span id="hl-0-3"><a href="#hl-0-3">3</a></span><span>$ python -m timeit <span>&#34;{}&#34;</span>
</span></span><span><span id="hl-0-4"><a href="#hl-0-4">4</a></span><span><span>20000000</span> loops, best of 5: 19.6 nsec per loop
</span></span></code></pre></div><p>On my MacBook M1 the difference is <strong>almost 2x</strong>. A non-trivial difference, especially knowing that both of these
expressions produce the exact same object.</p><p>Where does the difference come from?</p><p>Before we get into that, we need to sidetrack a little bit and talk about what happens when you execute Python code.
Python is an <a href="https://en.wikipedia.org/wiki/Scripting_language">interpreted language</a> — it needs to have an interpreter. <a href="https://github.com/python/cpython/tree/v3.12.0">CPython</a> is
the most wildly used interpreter of Python; it’s a reference implementation, meaning that other interpreters use it to
determine the “correct” behavior. If you’ve installed Python from a default distribution, you have CPython installed on
your machine.</p><p>Interestingly, CPython is both a compiler and an interpreter. When executing Python code it first compiles it into
<a href="https://docs.python.org/3.12/library/dis.html#python-bytecode-instructions">bytecode</a> instructions and interprets them.</p><p>To better understand the performance difference between <code>dist()</code> and <code>{}</code> let’s compare the bytecode instructions they
compile into. Python has a built-in module called <a href="https://docs.python.org/3.12/library/dis.html">dis</a> which does exactly that.</p><div><pre tabindex="0"><code data-lang="python"><span><span id="hl-1-1"><a href="#hl-1-1"> 1</a></span><span><span>&gt;&gt;&gt;</span> <span>import</span> <span>dis</span>
</span></span><span><span id="hl-1-2"><a href="#hl-1-2"> 2</a></span><span><span>&gt;&gt;&gt;</span> <span>def</span> <span>a</span><span>():</span>
</span></span><span><span id="hl-1-3"><a href="#hl-1-3"> 3</a></span><span><span>...</span>   <span>return</span> <span>dict</span><span>()</span>
</span></span><span><span id="hl-1-4"><a href="#hl-1-4"> 4</a></span><span><span>...</span>
</span></span><span><span id="hl-1-5"><a href="#hl-1-5"> 5</a></span><span><span>&gt;&gt;&gt;</span> <span>def</span> <span>b</span><span>():</span>
</span></span><span><span id="hl-1-6"><a href="#hl-1-6"> 6</a></span><span><span>...</span>   <span>return</span> <span>{}</span>
</span></span><span><span id="hl-1-7"><a href="#hl-1-7"> 7</a></span><span><span>...</span>
</span></span><span><span id="hl-1-8"><a href="#hl-1-8"> 8</a></span><span><span>&gt;&gt;&gt;</span> <span>dis</span><span>.</span><span>dis</span><span>(</span><span>a</span><span>)</span>
</span></span><span><span id="hl-1-9"><a href="#hl-1-9"> 9</a></span><span>  <span>1</span>           <span>0</span> <span>RESUME</span>                   <span>0</span>
</span></span><span><span id="hl-1-10"><a href="#hl-1-10">10</a></span><span>
</span></span><span><span id="hl-1-11"><a href="#hl-1-11">11</a></span><span>  <span>2</span>           <span>2</span> <span>LOAD_GLOBAL</span>              <span>1</span> <span>(</span><span>NULL</span> <span>+</span> <span>dict</span><span>)</span>
</span></span><span><span id="hl-1-12"><a href="#hl-1-12">12</a></span><span>             <span>12</span> <span>CALL</span>                     <span>0</span>
</span></span><span><span id="hl-1-13"><a href="#hl-1-13">13</a></span><span>             <span>20</span> <span>RETURN_VALUE</span>
</span></span><span><span id="hl-1-14"><a href="#hl-1-14">14</a></span><span><span>&gt;&gt;&gt;</span> <span>dis</span><span>.</span><span>dis</span><span>(</span><span>b</span><span>)</span>
</span></span><span><span id="hl-1-15"><a href="#hl-1-15">15</a></span><span>  <span>1</span>           <span>0</span> <span>RESUME</span>                   <span>0</span>
</span></span><span><span id="hl-1-16"><a href="#hl-1-16">16</a></span><span>
</span></span><span><span id="hl-1-17"><a href="#hl-1-17">17</a></span><span>  <span>2</span>           <span>2</span> <span>BUILD_MAP</span>                <span>0</span>
</span></span><span><span id="hl-1-18"><a href="#hl-1-18">18</a></span><span>              <span>4</span> <span>RETURN_VALUE</span>
</span></span></code></pre></div><p>Although they produce the same end result these two expression, quite clearly, execute different code.</p><h3 id="bytecode-instructions">Bytecode instructions
<a href="#bytecode-instructions" aria-label="Anchor"><i aria-hidden="true"></i></a></h3><p>The output of <code>dis.dis</code> isn’t very hard to understand.</p><div><pre tabindex="0"><code data-lang="text"><span><span id="hl-2-1"><a href="#hl-2-1">1</a></span><span> (1) |    (2)    |          (3)          | (4) |      (5)      
</span></span><span><span id="hl-2-2"><a href="#hl-2-2">2</a></span><span>-----|-----------|-----------------------|-----|---------------
</span></span><span><span id="hl-2-3"><a href="#hl-2-3">3</a></span><span>   1 |         0 | RESUME                | 0   |
</span></span><span><span id="hl-2-4"><a href="#hl-2-4">4</a></span><span>     |           |                       |     |
</span></span><span><span id="hl-2-5"><a href="#hl-2-5">5</a></span><span>   2 |         2 | LOAD_GLOBAL           | 1   | (NULL + dict)
</span></span><span><span id="hl-2-6"><a href="#hl-2-6">6</a></span><span>     |        12 | CALL                  | 0   |
</span></span><span><span id="hl-2-7"><a href="#hl-2-7">7</a></span><span>     |        20 | RETURN_VALUE          |     |
</span></span></code></pre></div><p>Each column has a purpose:</p><ol><li>Line number in the source code.</li><li>The address of the instruction — byte index in the compiled bytecode.</li><li>The bytecode name (opcode).</li><li>Operation parameters.</li><li>Human-readable interpretation of the operation parameters.</li></ol><p>Alright, equipped with this knowledge and by cross-referencing the <a href="https://docs.python.org/3.12/library/dis.html#python-bytecode-instructions">opcode set</a> we know that:</p><ol><li><a href="https://docs.python.org/3.12/library/dis.html#opcode-RESUME"><code>RESUME</code></a> — does nothing. It performs internal tracking, debugging and optimization checks.</li><li><a href="https://docs.python.org/3.12/library/dis.html#opcode-LOAD_GLOBAL"><code>LOAD_GLOBAL</code></a> — loads a global variable onto the stack. From the human-readable interpretation of the opcode
parameters we know that it loads <code>dict</code> (ignore <code>NULL</code> for now).</li><li><a href="https://docs.python.org/3.12/library/dis.html#opcode-CALL"><code>CALL</code></a> — calls a callable object with the number of arguments specified by <code>argc</code> — in our case it’s zero.</li><li><a href="https://docs.python.org/3.12/library/dis.html#opcode-RETURN_VALUE"><code>RETURN_VALUE</code></a> — returns with the last element from the stack to the caller.</li></ol><p>Compiling <code>return {}</code> yields one more opcode:</p><ol start="5"><li><a href="https://docs.python.org/3.12/library/dis.html#opcode-BUILD_MAP"><code>BUILD_MAP</code></a> — pushes a new dictionary object onto the stack. Pops <code>2 * count</code> items so that the dictionary holds
count entries.</li></ol><p>Already we have a few obvious differences between the two cases. The <code>{}</code> expression builds a dictionary directly, while
<code>dict()</code> delegates that to a callable object. Before that can even happen it first needs to load the global value
(<code>dict</code>) onto the stack — it actually does that every single time we call that function.</p><p>Why?</p><p>Because <code>dict</code> is not constant: it can be overwritten — and therefore — produce a different value.</p><div><pre tabindex="0"><code data-lang="python"><span><span id="hl-3-1"><a href="#hl-3-1">1</a></span><span><span>&gt;&gt;&gt;</span> <span>def</span> <span>a</span><span>():</span>
</span></span><span><span id="hl-3-2"><a href="#hl-3-2">2</a></span><span><span>...</span>   <span>return</span> <span>dict</span><span>()</span>
</span></span><span><span id="hl-3-3"><a href="#hl-3-3">3</a></span><span><span>...</span>
</span></span><span><span id="hl-3-4"><a href="#hl-3-4">4</a></span><span><span>&gt;&gt;&gt;</span> <span>dict</span> <span>=</span> <span>lambda</span><span>:</span> <span>42</span>
</span></span><span><span id="hl-3-5"><a href="#hl-3-5">5</a></span><span><span>&gt;&gt;&gt;</span>
</span></span><span><span id="hl-3-6"><a href="#hl-3-6">6</a></span><span><span>&gt;&gt;&gt;</span> <span>assert</span> <span>a</span><span>()</span> <span>==</span> <span>42</span>
</span></span></code></pre></div><p>It can happen. This is why Python needs to generate this overhead of loading and calling a callable for every call of
the function.</p><p>OK, it all sound very neat. Calling a callable does create an overhead and it’s reasonable to assume that the difference
we saw at the beginning of this post is a result of this overhead. However, are we sure that <code>dict()</code> internally calls
the same code, as <code>{}</code> does? <code>dict</code> is a class and, luckily, the <a href="https://docs.python.org/3/library/dis.html#dis.dis"><code>dis.dis</code></a> function can compile classes to bytecode.</p><div><h6><i aria-hidden="true"></i>
Example</h6><div><pre tabindex="0"><code data-lang="python"><span><span id="hl-0-1"><a href="#hl-0-1"> 1</a></span><span><span>import</span> <span>dis</span>
</span></span><span><span id="hl-0-2"><a href="#hl-0-2"> 2</a></span><span>
</span></span><span><span id="hl-0-3"><a href="#hl-0-3"> 3</a></span><span><span>class</span> <span>Foo</span><span>:</span>
</span></span><span><span id="hl-0-4"><a href="#hl-0-4"> 4</a></span><span>    <span>def</span> <span>bar</span><span>(</span><span>self</span><span>):</span>
</span></span><span><span id="hl-0-5"><a href="#hl-0-5"> 5</a></span><span>        <span>return</span> <span>42</span>
</span></span><span><span id="hl-0-6"><a href="#hl-0-6"> 6</a></span><span>
</span></span><span><span id="hl-0-7"><a href="#hl-0-7"> 7</a></span><span>    <span>def</span> <span>__str__</span><span>(</span><span>self</span><span>):</span>
</span></span><span><span id="hl-0-8"><a href="#hl-0-8"> 8</a></span><span>        <span>return</span> <span>self</span><span>.</span><span>__class__</span><span>.</span><span>__name__</span>
</span></span><span><span id="hl-0-9"><a href="#hl-0-9"> 9</a></span><span>
</span></span><span><span id="hl-0-10"><a href="#hl-0-10">10</a></span><span><span>dis</span><span>.</span><span>dis</span><span>(</span><span>Foo</span><span>)</span>
</span></span></code></pre></div><p>It prints out disassembly for all of the classes’s methods:</p><div><pre tabindex="0"><code data-lang="txt"><span><span id="hl-1-1"><a href="#hl-1-1"> 1</a></span><span>Disassembly of __str__:
</span></span><span><span id="hl-1-2"><a href="#hl-1-2"> 2</a></span><span>  8           0 RESUME                   0
</span></span><span><span id="hl-1-3"><a href="#hl-1-3"> 3</a></span><span>
</span></span><span><span id="hl-1-4"><a href="#hl-1-4"> 4</a></span><span>  9           2 LOAD_FAST                0 (self)
</span></span><span><span id="hl-1-5"><a href="#hl-1-5"> 5</a></span><span>              4 LOAD_ATTR                0 (__class__)
</span></span><span><span id="hl-1-6"><a href="#hl-1-6"> 6</a></span><span>             24 LOAD_ATTR                2 (__name__)
</span></span><span><span id="hl-1-7"><a href="#hl-1-7"> 7</a></span><span>             44 RETURN_VALUE
</span></span><span><span id="hl-1-8"><a href="#hl-1-8"> 8</a></span><span>
</span></span><span><span id="hl-1-9"><a href="#hl-1-9"> 9</a></span><span>Disassembly of bar:
</span></span><span><span id="hl-1-10"><a href="#hl-1-10">10</a></span><span>  5           0 RESUME                   0
</span></span><span><span id="hl-1-11"><a href="#hl-1-11">11</a></span><span>
</span></span><span><span id="hl-1-12"><a href="#hl-1-12">12</a></span><span>  6           2 RETURN_CONST             1 (42)
</span></span></code></pre></div></div><p>Let’s try this for <code>dict</code>:</p><p>… it doesn’t print anything? Why?</p><p>Well, the <a href="https://docs.python.org/3.12/library/dis.html">dis</a> module isn’t very useful for internal types and <code>dict</code> is one of those types — defined
within the interpreter’s source code.</p><h3 id="getting-lost-in-the-cpython-source-code">Getting lost in the CPython source code
<a href="#getting-lost-in-the-cpython-source-code" aria-label="Anchor"><i aria-hidden="true"></i></a></h3><p>To tap into the forbidden magic, we need to clone the <a href="https://github.com/python/cpython/tree/main">CPython repository</a> first. We don’t need all the
history, so let’s <a href="https://git-scm.com/docs/git-clone#Documentation/git-clone.txt---depthltdepthgt"><code>--depth 1</code></a> this.</p><div><pre tabindex="0"><code data-lang="sh"><span><span id="hl-5-1"><a href="#hl-5-1">1</a></span><span>git clone --depth <span>1</span> --branch v3.12.0 https://github.com/python/cpython.git
</span></span><span><span id="hl-5-2"><a href="#hl-5-2">2</a></span><span><span># or</span>
</span></span><span><span id="hl-5-3"><a href="#hl-5-3">3</a></span><span>git clone --depth <span>1</span> --branch v3.12.0 git@github.com:python/cpython.git
</span></span></code></pre></div><p>Then we need to find what we’re actually looking for — a place where opcode instructions are interpreted. After a cup
of coffee and a lot of greps later we find the <a href="https://github.com/python/cpython/blob/v3.12.0/Python/bytecodes.c"><code>Python/bytecodes.c</code></a> file. It consists of a single <code>switch</code>
statement and it seems like all bytecode instruction are interpreted there.</p><h4 id="the-dict-type">The <code>dict</code> type
<a href="#the-dict-type" aria-label="Anchor"><i aria-hidden="true"></i></a></h4><p>Let’s tackle <code>dict</code> first. All internal types are defined as <code>PyTypeObject</code> objects and the <code>dict</code> type is defined in
the <a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L3839"><code>dictobject.c</code></a> file. It has a lot of attributes defined, but only two are of interest
for us:</p><div><pre tabindex="0"><code data-lang="c"><span><span id="hl-6-1"><a href="#hl-6-1"> 1</a></span><span><span>PyTypeObject</span> <span>PyDict_Type</span> <span>=</span> <span>{</span>
</span></span><span><span id="hl-6-2"><a href="#hl-6-2"> 2</a></span><span>    <span>PyVarObject_HEAD_INIT</span><span>(</span><span>&amp;</span><span>PyType_Type</span><span>,</span> <span>0</span><span>)</span>
</span></span><span><span id="hl-6-3"><a href="#hl-6-3"> 3</a></span><span>    <span>&#34;dict&#34;</span><span>,</span>
</span></span><span><span id="hl-6-4"><a href="#hl-6-4"> 4</a></span><span>    <span>sizeof</span><span>(</span><span>PyDictObject</span><span>),</span>
</span></span><span><span id="hl-6-5"><a href="#hl-6-5"> 5</a></span><span>    <span>// ...
</span></span></span><span><span id="hl-6-6"><a href="#hl-6-6"> 6</a></span><span><span></span>    <span>dict_init</span><span>,</span>                                  <span>/* tp_init */</span>
</span></span><span><span id="hl-6-7"><a href="#hl-6-7"> 7</a></span><span>    <span>// ...
</span></span></span><span><span id="hl-6-8"><a href="#hl-6-8"> 8</a></span><span><span></span>    <span>dict_new</span><span>,</span>                                   <span>/* tp_new */</span>
</span></span><span><span id="hl-6-9"><a href="#hl-6-9"> 9</a></span><span>    <span>// ...
</span></span></span><span><span id="hl-6-10"><a href="#hl-6-10">10</a></span><span><span></span><span>};</span>
</span></span></code></pre></div><p>The pair (<code>dict_new</code> and <code>dict_init</code>) will tell us what happens when someone creates a new dictionary.</p><div><h6><i aria-hidden="true"></i>
Note</h6><p>The constructor in Python is called <code>__new__</code>. It’s a static method that returns a new object of its type.</p><p>The initializer method is called <code>__init__</code>. It takes a newly created object and initializes its attributes. The
<code>__init__</code>method is called after the <code>__new__</code> method.</p></div><p>The <code>dict_new</code> function is defined here: <a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L3751">dictobject.c#L3751</a>.</p><div><pre tabindex="0"><code data-lang="c"><span><span id="hl-7-1"><a href="#hl-7-1"> 1</a></span><span><span>static</span> <span>PyObject</span> <span>*</span>
</span></span><span><span id="hl-7-2"><a href="#hl-7-2"> 2</a></span><span><span>dict_new</span><span>(</span><span>PyTypeObject</span><span>*</span><span>type</span><span>,</span> <span>PyObject</span> <span>*</span><span>args</span><span>,</span> <span>PyObject</span><span>*</span><span>kwds</span><span>)</span>
</span></span><span><span id="hl-7-3"><a href="#hl-7-3"> 3</a></span><span><span>{</span>
</span></span><span><span id="hl-7-4"><a href="#hl-7-4"> 4</a></span><span>    <span>assert</span><span>(</span><span>type</span> <span>!=</span> <span>NULL</span><span>);</span>
</span></span><span><span id="hl-7-5"><a href="#hl-7-5"> 5</a></span><span>    <span>assert</span><span>(</span><span>type</span><span>-&gt;</span><span>tp_alloc</span> <span>!=</span> <span>NULL</span><span>);</span>
</span></span><span><span id="hl-7-6"><a href="#hl-7-6"> 6</a></span><span>    <span>// dict subclasses must implement the GC protocol
</span></span></span><span><span id="hl-7-7"><a href="#hl-7-7"> 7</a></span><span><span></span>    <span>assert</span><span>(</span><span>_PyType_IS_GC</span><span>(</span><span>type</span><span>));</span>
</span></span><span><span id="hl-7-8"><a href="#hl-7-8"> 8</a></span><span>
</span></span><span><span id="hl-7-9"><a href="#hl-7-9"> 9</a></span><span>    <span>PyObject</span> <span>*</span><span>self</span> <span>=</span> <span>type</span><span>-&gt;</span><span>tp_alloc</span><span>(</span><span>type</span><span>,</span> <span>0</span><span>);</span>
</span></span><span><span id="hl-7-10"><a href="#hl-7-10">10</a></span><span>    <span>if</span> <span>(</span><span>self</span> <span>==</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span id="hl-7-11"><a href="#hl-7-11">11</a></span><span>        <span>return</span> <span>NULL</span><span>;</span>
</span></span><span><span id="hl-7-12"><a href="#hl-7-12">12</a></span><span>    <span>}</span>
</span></span><span><span id="hl-7-13"><a href="#hl-7-13">13</a></span><span>    <span>PyDictObject</span> <span>*</span><span>d</span> <span>=</span> <span>(</span><span>PyDictObject</span> <span>*</span><span>)</span><span>self</span><span>;</span>
</span></span><span><span id="hl-7-14"><a href="#hl-7-14">14</a></span><span>
</span></span><span><span id="hl-7-15"><a href="#hl-7-15">15</a></span><span>    <span>d</span><span>-&gt;</span><span>ma_used</span> <span>=</span> <span>0</span><span>;</span>
</span></span><span><span id="hl-7-16"><a href="#hl-7-16">16</a></span><span>    <span>d</span><span>-&gt;</span><span>ma_version_tag</span> <span>=</span> <span>DICT_NEXT_VERSION</span><span>(</span>
</span></span><span><span id="hl-7-17"><a href="#hl-7-17">17</a></span><span>            <span>_PyInterpreterState_GET</span><span>());</span>
</span></span><span><span id="hl-7-18"><a href="#hl-7-18">18</a></span><span>    <span>dictkeys_incref</span><span>(</span><span>Py_EMPTY_KEYS</span><span>);</span>
</span></span><span><span id="hl-7-19"><a href="#hl-7-19">19</a></span><span>    <span>d</span><span>-&gt;</span><span>ma_keys</span> <span>=</span> <span>Py_EMPTY_KEYS</span><span>;</span>
</span></span><span><span id="hl-7-20"><a href="#hl-7-20">20</a></span><span>    <span>d</span><span>-&gt;</span><span>ma_values</span> <span>=</span> <span>NULL</span><span>;</span>
</span></span><span><span id="hl-7-21"><a href="#hl-7-21">21</a></span><span>    <span>ASSERT_CONSISTENT</span><span>(</span><span>d</span><span>);</span>
</span></span><span><span id="hl-7-22"><a href="#hl-7-22">22</a></span><span>
</span></span><span><span id="hl-7-23"><a href="#hl-7-23">23</a></span><span>    <span>// ...
</span></span></span><span><span id="hl-7-24"><a href="#hl-7-24">24</a></span><span><span></span>
</span></span><span><span id="hl-7-25"><a href="#hl-7-25">25</a></span><span>    <span>return</span> <span>self</span><span>;</span>
</span></span><span><span id="hl-7-26"><a href="#hl-7-26">26</a></span><span><span>}</span>
</span></span></code></pre></div><p>We see that first, it allocates a new object via the provided allocator (9<sup>th</sup> line) and then sets
some of its internal fields (15<sup>th</sup>, 19<sup>th</sup>, and 20<sup>th</sup>).
Interestingly for us, it <strong>does not</strong> pre-allocate the dictionary’s internal memory (see marked lines). It might seems
strange at first, but please remember: an object’s initialization — like memory pre-allocation — is not a
responsibility of the <code>__new__</code> method, that what the <code>__init__</code> method is for.</p><p>With the new object in memory, the <code>dict_init</code> function can insert entries to it. The insertion logic is delegated to
the <code>dict_update_common</code> function, which can be found here: <a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L2678">dictobject.c#L2678</a>.</p><div><pre tabindex="0"><code data-lang="c"><span><span id="hl-8-1"><a href="#hl-8-1"> 1</a></span><span><span>static</span> <span>int</span>
</span></span><span><span id="hl-8-2"><a href="#hl-8-2"> 2</a></span><span><span>dict_update_common</span><span>(</span><span>PyObject</span> <span>*</span><span>self</span><span>,</span> <span>PyObject</span> <span>*</span><span>args</span><span>,</span> <span>PyObject</span> <span>*</span><span>kwds</span><span>,</span>
</span></span><span><span id="hl-8-3"><a href="#hl-8-3"> 3</a></span><span>                   <span>const</span> <span>char</span> <span>*</span><span>methname</span><span>)</span>
</span></span><span><span id="hl-8-4"><a href="#hl-8-4"> 4</a></span><span><span>{</span>
</span></span><span><span id="hl-8-5"><a href="#hl-8-5"> 5</a></span><span>    <span>PyObject</span> <span>*</span><span>arg</span> <span>=</span> <span>NULL</span><span>;</span>
</span></span><span><span id="hl-8-6"><a href="#hl-8-6"> 6</a></span><span>    <span>int</span> <span>result</span> <span>=</span> <span>0</span><span>;</span>
</span></span><span><span id="hl-8-7"><a href="#hl-8-7"> 7</a></span><span>
</span></span><span><span id="hl-8-8"><a href="#hl-8-8"> 8</a></span><span>    <span>if</span> <span>(</span><span>!</span><span>PyArg_UnpackTuple</span><span>(</span><span>args</span><span>,</span> <span>methname</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>,</span> <span>&amp;</span><span>arg</span><span>))</span> <span>{</span>
</span></span><span><span id="hl-8-9"><a href="#hl-8-9"> 9</a></span><span>        <span>result</span> <span>=</span> <span>-</span><span>1</span><span>;</span>
</span></span><span><span id="hl-8-10"><a href="#hl-8-10">10</a></span><span>    <span>}</span>
</span></span><span><span id="hl-8-11"><a href="#hl-8-11">11</a></span><span>    <span>else</span> <span>if</span> <span>(</span><span>arg</span> <span>!=</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span id="hl-8-12"><a href="#hl-8-12">12</a></span><span>        <span>result</span> <span>=</span> <span>dict_update_arg</span><span>(</span><span>self</span><span>,</span> <span>arg</span><span>);</span>
</span></span><span><span id="hl-8-13"><a href="#hl-8-13">13</a></span><span>    <span>}</span>
</span></span><span><span id="hl-8-14"><a href="#hl-8-14">14</a></span><span>
</span></span><span><span id="hl-8-15"><a href="#hl-8-15">15</a></span><span>    <span>if</span> <span>(</span><span>result</span> <span>==</span> <span>0</span> <span>&amp;&amp;</span> <span>kwds</span> <span>!=</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span id="hl-8-16"><a href="#hl-8-16">16</a></span><span>        <span>if</span> <span>(</span><span>PyArg_ValidateKeywordArguments</span><span>(</span><span>kwds</span><span>))</span>
</span></span><span><span id="hl-8-17"><a href="#hl-8-17">17</a></span><span>            <span>result</span> <span>=</span> <span>PyDict_Merge</span><span>(</span><span>self</span><span>,</span> <span>kwds</span><span>,</span> <span>1</span><span>);</span>
</span></span><span><span id="hl-8-18"><a href="#hl-8-18">18</a></span><span>        <span>else</span>
</span></span><span><span id="hl-8-19"><a href="#hl-8-19">19</a></span><span>            <span>result</span> <span>=</span> <span>-</span><span>1</span><span>;</span>
</span></span><span><span id="hl-8-20"><a href="#hl-8-20">20</a></span><span>    <span>}</span>
</span></span><span><span id="hl-8-21"><a href="#hl-8-21">21</a></span><span>    <span>return</span> <span>result</span><span>;</span>
</span></span><span><span id="hl-8-22"><a href="#hl-8-22">22</a></span><span><span>}</span>
</span></span></code></pre></div><p>It updates the dictionary from both args and kwargs.</p><h5 id="args--dict_update_arg">args &amp; <code>dict_update_arg</code>
<a href="#args--dict_update_arg" aria-label="Anchor"><i aria-hidden="true"></i></a></h5><p>For <code>args</code> it calls the <code>dict_update_arg</code> function.</p><div><pre tabindex="0"><code data-lang="c"><span><span id="hl-9-1"><a href="#hl-9-1"> 1</a></span><span><span>static</span> <span>int</span>
</span></span><span><span id="hl-9-2"><a href="#hl-9-2"> 2</a></span><span><span>dict_update_arg</span><span>(</span><span>PyObject</span> <span>*</span><span>self</span><span>,</span> <span>PyObject</span> <span>*</span><span>arg</span><span>)</span>
</span></span><span><span id="hl-9-3"><a href="#hl-9-3"> 3</a></span><span><span>{</span>
</span></span><span><span id="hl-9-4"><a href="#hl-9-4"> 4</a></span><span>    <span>if</span> <span>(</span><span>PyDict_CheckExact</span><span>(</span><span>arg</span><span>))</span> <span>{</span>
</span></span><span><span id="hl-9-5"><a href="#hl-9-5"> 5</a></span><span>        <span>return</span> <span>PyDict_Merge</span><span>(</span><span>self</span><span>,</span> <span>arg</span><span>,</span> <span>1</span><span>);</span>
</span></span><span><span id="hl-9-6"><a href="#hl-9-6"> 6</a></span><span>    <span>}</span>
</span></span><span><span id="hl-9-7"><a href="#hl-9-7"> 7</a></span><span>    <span>PyObject</span> <span>*</span><span>func</span><span>;</span>
</span></span><span><span id="hl-9-8"><a href="#hl-9-8"> 8</a></span><span>    <span>if</span> <span>(</span><span>_PyObject_LookupAttr</span><span>(</span><span>arg</span><span>,</span> <span>&amp;</span><span>_Py_ID</span><span>(</span><span>keys</span><span>),</span> <span>&amp;</span><span>func</span><span>)</span> <span>&lt;</span> <span>0</span><span>)</span> <span>{</span>
</span></span><span><span id="hl-9-9"><a href="#hl-9-9"> 9</a></span><span>        <span>return</span> <span>-</span><span>1</span><span>;</span>
</span></span><span><span id="hl-9-10"><a href="#hl-9-10">10</a></span><span>    <span>}</span>
</span></span><span><span id="hl-9-11"><a href="#hl-9-11">11</a></span><span>    <span>if</span> <span>(</span><span>func</span> <span>!=</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span id="hl-9-12"><a href="#hl-9-12">12</a></span><span>        <span>Py_DECREF</span><span>(</span><span>func</span><span>);</span>
</span></span><span><span id="hl-9-13"><a href="#hl-9-13">13</a></span><span>        <span>return</span> <span>PyDict_Merge</span><span>(</span><span>self</span><span>,</span> <span>arg</span><span>,</span> <span>1</span><span>);</span>
</span></span><span><span id="hl-9-14"><a href="#hl-9-14">14</a></span><span>    <span>}</span>
</span></span><span><span id="hl-9-15"><a href="#hl-9-15">15</a></span><span>    <span>return</span> <span>PyDict_MergeFromSeq2</span><span>(</span><span>self</span><span>,</span> <span>arg</span><span>,</span> <span>1</span><span>);</span>
</span></span><span><span id="hl-9-16"><a href="#hl-9-16">16</a></span><span><span>}</span>
</span></span></code></pre></div><p>The function checks if <code>arg</code> is a dictionary, if so it merges the two (<a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L2988"><code>PyDict_Merge</code></a>), otherwise it adds new entries
from a sequence of pairs (<a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L2722"><code>PyDict_MergeFromSeq2</code></a>).</p><h5 id="kwargs--pydict_merge">kwargs &amp; <code>PyDict_Merge</code>
<a href="#kwargs--pydict_merge" aria-label="Anchor"><i aria-hidden="true"></i></a></h5><p>The <code>kwargs</code> path ends in the same place — <a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L2988"><code>PyDict_Merge</code></a>. Let’s take a look.</p><p>Internally, it delegates all logic to the <a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L2807"><code>dict_merge</code></a> function.</p><div><pre tabindex="0"><code data-lang="c"><span><span id="hl-10-1"><a href="#hl-10-1"> 1</a></span><span><span>static</span> <span>int</span>
</span></span><span><span id="hl-10-2"><a href="#hl-10-2"> 2</a></span><span><span>dict_merge</span><span>(</span><span>PyInterpreterState</span> <span>*</span><span>interp</span><span>,</span> <span>PyObject</span> <span>*</span><span>a</span><span>,</span> <span>PyObject</span> <span>*</span><span>b</span><span>,</span> <span>int</span> <span>override</span><span>)</span>
</span></span><span><span id="hl-10-3"><a href="#hl-10-3"> 3</a></span><span><span>{</span>
</span></span><span><span id="hl-10-4"><a href="#hl-10-4"> 4</a></span><span>    <span>PyDictObject</span> <span>*</span><span>mp</span><span>,</span> <span>*</span><span>other</span><span>;</span>
</span></span><span><span id="hl-10-5"><a href="#hl-10-5"> 5</a></span><span>
</span></span><span><span id="hl-10-6"><a href="#hl-10-6"> 6</a></span><span>    <span>assert</span><span>(</span><span>0</span> <span>&lt;=</span> <span>override</span> <span>&amp;&amp;</span> <span>override</span> <span>&lt;=</span> <span>2</span><span>);</span>
</span></span><span><span id="hl-10-7"><a href="#hl-10-7"> 7</a></span><span>
</span></span><span><span id="hl-10-8"><a href="#hl-10-8"> 8</a></span><span>    <span>/* We accept for the argument either a concrete dictionary object,
</span></span></span><span><span id="hl-10-9"><a href="#hl-10-9"> 9</a></span><span><span>     * or an abstract &#34;mapping&#34; object.  For the former, we can do
</span></span></span><span><span id="hl-10-10"><a href="#hl-10-10">10</a></span><span><span>     * things quite efficiently.  For the latter, we only require that
</span></span></span><span><span id="hl-10-11"><a href="#hl-10-11">11</a></span><span><span>     * PyMapping_Keys() and PyObject_GetItem() be supported.
</span></span></span><span><span id="hl-10-12"><a href="#hl-10-12">12</a></span><span><span>     */</span>
</span></span><span><span id="hl-10-13"><a href="#hl-10-13">13</a></span><span>    <span>if</span> <span>(</span><span>a</span> <span>==</span> <span>NULL</span> <span>||</span> <span>!</span><span>PyDict_Check</span><span>(</span><span>a</span><span>)</span> <span>||</span> <span>b</span> <span>==</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span id="hl-10-14"><a href="#hl-10-14">14</a></span><span>        <span>PyErr_BadInternalCall</span><span>();</span>
</span></span><span><span id="hl-10-15"><a href="#hl-10-15">15</a></span><span>        <span>return</span> <span>-</span><span>1</span><span>;</span>
</span></span><span><span id="hl-10-16"><a href="#hl-10-16">16</a></span><span>    <span>}</span>
</span></span><span><span id="hl-10-17"><a href="#hl-10-17">17</a></span><span>    <span>mp</span> <span>=</span> <span>(</span><span>PyDictObject</span><span>*</span><span>)</span><span>a</span><span>;</span>
</span></span><span><span id="hl-10-18"><a href="#hl-10-18">18</a></span><span>    <span>if</span> <span>(</span><span>PyDict_Check</span><span>(</span><span>b</span><span>)</span> <span>&amp;&amp;</span> <span>(</span><span>Py_TYPE</span><span>(</span><span>b</span><span>)</span><span>-&gt;</span><span>tp_iter</span> <span>==</span> <span>(</span><span>getiterfunc</span><span>)</span><span>dict_iter</span><span>))</span> <span>{</span>
</span></span><span><span id="hl-10-19"><a href="#hl-10-19">19</a></span><span>
</span></span><span><span id="hl-10-20"><a href="#hl-10-20">20</a></span><span>        <span>// ...
</span></span></span><span><span id="hl-10-21"><a href="#hl-10-21">21</a></span><span><span></span>    <span>else</span> <span>{</span>
</span></span><span><span id="hl-10-22"><a href="#hl-10-22">22</a></span><span>        <span>/* Do it the generic, slower way */</span>
</span></span><span><span id="hl-10-23"><a href="#hl-10-23">23</a></span><span>
</span></span><span><span id="hl-10-24"><a href="#hl-10-24">24</a></span><span>        <span>// ...
</span></span></span><span><span id="hl-10-25"><a href="#hl-10-25">25</a></span><span><span></span>    <span>}</span>
</span></span><span><span id="hl-10-26"><a href="#hl-10-26">26</a></span><span>    <span>ASSERT_CONSISTENT</span><span>(</span><span>a</span><span>);</span>
</span></span><span><span id="hl-10-27"><a href="#hl-10-27">27</a></span><span>    <span>return</span> <span>0</span><span>;</span>
</span></span><span><span id="hl-10-28"><a href="#hl-10-28">28</a></span><span><span>}</span>
</span></span></code></pre></div><p>From the comment, we know that the function has been optimized for being called with another dictionary as a parameter.
If the parameter is not a dictionary, then it’s a generic <a href="https://docs.python.org/3.12/library/collections.abc.html#collections.abc.Mapping"><code>Mapping</code></a> — a container object that supports arbitrary key
lookups.</p><h4 id="the--expression">The <code>{}</code> expression
<a href="#the--expression" aria-label="Anchor"><i aria-hidden="true"></i></a></h4><p>The literal expression should be easier to reason about. Let’s go back to the <a href="https://github.com/python/cpython/blob/v3.12.0/Python/bytecodes.c">bytecode.c</a> file and find mapping for the
<code>BUILD_MAP</code> opcode.</p><div><pre tabindex="0"><code data-lang="c"><span><span id="hl-11-1"><a href="#hl-11-1"> 1</a></span><span><span>inst</span><span>(</span><span>BUILD_MAP</span><span>,</span> <span>(</span><span>values</span><span>[</span><span>oparg</span><span>*</span><span>2</span><span>]</span> <span>--</span> <span>map</span><span>))</span> <span>{</span>
</span></span><span><span id="hl-11-2"><a href="#hl-11-2"> 2</a></span><span>    <span>map</span> <span>=</span> <span>_PyDict_FromItems</span><span>(</span>
</span></span><span><span id="hl-11-3"><a href="#hl-11-3"> 3</a></span><span>            <span>values</span><span>,</span> <span>2</span><span>,</span>
</span></span><span><span id="hl-11-4"><a href="#hl-11-4"> 4</a></span><span>            <span>values</span><span>+</span><span>1</span><span>,</span> <span>2</span><span>,</span>
</span></span><span><span id="hl-11-5"><a href="#hl-11-5"> 5</a></span><span>            <span>oparg</span><span>);</span>
</span></span><span><span id="hl-11-6"><a href="#hl-11-6"> 6</a></span><span>    <span>if</span> <span>(</span><span>map</span> <span>==</span> <span>NULL</span><span>)</span>
</span></span><span><span id="hl-11-7"><a href="#hl-11-7"> 7</a></span><span>        <span>goto</span> <span>error</span><span>;</span>
</span></span><span><span id="hl-11-8"><a href="#hl-11-8"> 8</a></span><span>
</span></span><span><span id="hl-11-9"><a href="#hl-11-9"> 9</a></span><span>    <span>DECREF_INPUTS</span><span>();</span>
</span></span><span><span id="hl-11-10"><a href="#hl-11-10">10</a></span><span>    <span>ERROR_IF</span><span>(</span><span>map</span> <span>==</span> <span>NULL</span><span>,</span> <span>error</span><span>);</span>
</span></span><span><span id="hl-11-11"><a href="#hl-11-11">11</a></span><span><span>}</span>
</span></span></code></pre></div><p><em>See sources here: <a href="https://github.com/python/cpython/blob/v3.12.0/Python/bytecodes.c#L1541">bytecode.c#L1541</a>.</em></p><p>We see that the dictionary is fully constructed and returned by <a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L1616"><code>_PyDict_FromItems</code></a>. Let’s go there.</p><div><pre tabindex="0"><code data-lang="c"><span><span id="hl-12-1"><a href="#hl-12-1"> 1</a></span><span><span>PyObject</span> <span>*</span>
</span></span><span><span id="hl-12-2"><a href="#hl-12-2"> 2</a></span><span><span>_PyDict_FromItems</span><span>(</span><span>PyObject</span> <span>*</span><span>const</span> <span>*</span><span>keys</span><span>,</span> <span>Py_ssize_t</span> <span>keys_offset</span><span>,</span>
</span></span><span><span id="hl-12-3"><a href="#hl-12-3"> 3</a></span><span>                  <span>PyObject</span> <span>*</span><span>const</span> <span>*</span><span>values</span><span>,</span> <span>Py_ssize_t</span> <span>values_offset</span><span>,</span>
</span></span><span><span id="hl-12-4"><a href="#hl-12-4"> 4</a></span><span>                  <span>Py_ssize_t</span> <span>length</span><span>)</span>
</span></span><span><span id="hl-12-5"><a href="#hl-12-5"> 5</a></span><span><span>{</span>
</span></span><span><span id="hl-12-6"><a href="#hl-12-6"> 6</a></span><span>    <span>bool</span> <span>unicode</span> <span>=</span> <span>true</span><span>;</span>
</span></span><span><span id="hl-12-7"><a href="#hl-12-7"> 7</a></span><span>    <span>PyObject</span> <span>*</span><span>const</span> <span>*</span><span>ks</span> <span>=</span> <span>keys</span><span>;</span>
</span></span><span><span id="hl-12-8"><a href="#hl-12-8"> 8</a></span><span>    <span>PyInterpreterState</span> <span>*</span><span>interp</span> <span>=</span> <span>_PyInterpreterState_GET</span><span>();</span>
</span></span><span><span id="hl-12-9"><a href="#hl-12-9"> 9</a></span><span>
</span></span><span><span id="hl-12-10"><a href="#hl-12-10">10</a></span><span>    <span>for</span> <span>(</span><span>Py_ssize_t</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>length</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
</span></span><span><span id="hl-12-11"><a href="#hl-12-11">11</a></span><span>        <span>if</span> <span>(</span><span>!</span><span>PyUnicode_CheckExact</span><span>(</span><span>*</span><span>ks</span><span>))</span> <span>{</span>
</span></span><span><span id="hl-12-12"><a href="#hl-12-12">12</a></span><span>            <span>unicode</span> <span>=</span> <span>false</span><span>;</span>
</span></span><span><span id="hl-12-13"><a href="#hl-12-13">13</a></span><span>            <span>break</span><span>;</span>
</span></span><span><span id="hl-12-14"><a href="#hl-12-14">14</a></span><span>        <span>}</span>
</span></span><span><span id="hl-12-15"><a href="#hl-12-15">15</a></span><span>        <span>ks</span> <span>+=</span> <span>keys_offset</span><span>;</span>
</span></span><span><span id="hl-12-16"><a href="#hl-12-16">16</a></span><span>    <span>}</span>
</span></span><span><span id="hl-12-17"><a href="#hl-12-17">17</a></span><span>
</span></span><span><span id="hl-12-18"><a href="#hl-12-18">18</a></span><span>    <span>PyObject</span> <span>*</span><span>dict</span> <span>=</span> <span>dict_new_presized</span><span>(</span><span>interp</span><span>,</span> <span>length</span><span>,</span> <span>unicode</span><span>);</span>
</span></span><span><span id="hl-12-19"><a href="#hl-12-19">19</a></span><span>    <span>if</span> <span>(</span><span>dict</span> <span>==</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span id="hl-12-20"><a href="#hl-12-20">20</a></span><span>        <span>return</span> <span>NULL</span><span>;</span>
</span></span><span><span id="hl-12-21"><a href="#hl-12-21">21</a></span><span>    <span>}</span>
</span></span><span><span id="hl-12-22"><a href="#hl-12-22">22</a></span><span>
</span></span><span><span id="hl-12-23"><a href="#hl-12-23">23</a></span><span>    <span>ks</span> <span>=</span> <span>keys</span><span>;</span>
</span></span><span><span id="hl-12-24"><a href="#hl-12-24">24</a></span><span>    <span>PyObject</span> <span>*</span><span>const</span> <span>*</span><span>vs</span> <span>=</span> <span>values</span><span>;</span>
</span></span><span><span id="hl-12-25"><a href="#hl-12-25">25</a></span><span>
</span></span><span><span id="hl-12-26"><a href="#hl-12-26">26</a></span><span>    <span>for</span> <span>(</span><span>Py_ssize_t</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>length</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
</span></span><span><span id="hl-12-27"><a href="#hl-12-27">27</a></span><span>        <span>PyObject</span> <span>*</span><span>key</span> <span>=</span> <span>*</span><span>ks</span><span>;</span>
</span></span><span><span id="hl-12-28"><a href="#hl-12-28">28</a></span><span>        <span>PyObject</span> <span>*</span><span>value</span> <span>=</span> <span>*</span><span>vs</span><span>;</span>
</span></span><span><span id="hl-12-29"><a href="#hl-12-29">29</a></span><span>        <span>if</span> <span>(</span><span>PyDict_SetItem</span><span>(</span><span>dict</span><span>,</span> <span>key</span><span>,</span> <span>value</span><span>)</span> <span>&lt;</span> <span>0</span><span>)</span> <span>{</span>
</span></span><span><span id="hl-12-30"><a href="#hl-12-30">30</a></span><span>            <span>Py_DECREF</span><span>(</span><span>dict</span><span>);</span>
</span></span><span><span id="hl-12-31"><a href="#hl-12-31">31</a></span><span>            <span>return</span> <span>NULL</span><span>;</span>
</span></span><span><span id="hl-12-32"><a href="#hl-12-32">32</a></span><span>        <span>}</span>
</span></span><span><span id="hl-12-33"><a href="#hl-12-33">33</a></span><span>        <span>ks</span> <span>+=</span> <span>keys_offset</span><span>;</span>
</span></span><span><span id="hl-12-34"><a href="#hl-12-34">34</a></span><span>        <span>vs</span> <span>+=</span> <span>values_offset</span><span>;</span>
</span></span><span><span id="hl-12-35"><a href="#hl-12-35">35</a></span><span>    <span>}</span>
</span></span><span><span id="hl-12-36"><a href="#hl-12-36">36</a></span><span>
</span></span><span><span id="hl-12-37"><a href="#hl-12-37">37</a></span><span>    <span>return</span> <span>dict</span><span>;</span>
</span></span><span><span id="hl-12-38"><a href="#hl-12-38">38</a></span><span><span>}</span>
</span></span></code></pre></div><p>I’ve marked the most interesting line: in opposition to <code>dict_new</code>, it <strong>pre-allocates</strong> the dictionary, so it already
has a capacity for all of its entries. After that it inserts key-value pairs one-by-one.</p><h2 id="conclusions">Conclusions
<a href="#conclusions" aria-label="Anchor"><i aria-hidden="true"></i></a></h2><p>To sum things up.</p><p>When you do <code>dict(a=1, b=2)</code>, Python needs to:</p><ul><li>allocate a new <code>PyObject</code>,</li><li>construct a <code>dict</code> via the <code>__new__</code> method,</li><li>call its <code>__init__</code> method, which internally calls <a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L2988"><code>PyDict_Merge</code></a>,</li><li>because <code>kwargs</code> is not <code>dict</code>, <a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L2988"><code>PyDict_Merge</code></a> needs to use the slower method, which inserts entries one-by-one.</li></ul><p>Whereas doing <code>{}</code> causes Python to:</p><ul><li>construct a new <strong>pre-allocated</strong> dictionary,</li><li>inserts entries one-by-one.</li></ul><p>To be fair, unless you construct dictionaries in a loop, I don’t believe there’s a lot to gain performance-wise by
switching from <code>dict</code> to <code>{}</code>. There’s one thing I’d like you to remember after reading this post:</p><div><h6><i aria-hidden="true"></i>
tl;dr</h6><p>The <code>{}</code> is always faster than <code>dict</code>.</p></div><h2 id="appendix">Appendix
<a href="#appendix" aria-label="Anchor"><i aria-hidden="true"></i></a></h2><p>Similar analysis can be done for lists, sets, and (<em>possibly</em>) tuples. However, this post is already too long, so I’ll
drop all the other resources I’ve gathered here.</p><h3 id="lists">Lists
<a href="#lists" aria-label="Anchor"><i aria-hidden="true"></i></a></h3><div><pre tabindex="0"><code data-lang="sh"><span><span id="hl-13-1"><a href="#hl-13-1">1</a></span><span>$ python -m timeit <span>&#34;list((1, 2, &#39;a&#39;))&#34;</span>
</span></span><span><span id="hl-13-2"><a href="#hl-13-2">2</a></span><span><span>5000000</span> loops, best of 5: <span>53</span> nsec per loop
</span></span><span><span id="hl-13-3"><a href="#hl-13-3">3</a></span><span>$ python -m timeit <span>&#34;[(1, 2, &#39;a&#39;)]&#34;</span>
</span></span><span><span id="hl-13-4"><a href="#hl-13-4">4</a></span><span><span>10000000</span> loops, best of 5: 30.4 nsec per loop
</span></span></code></pre></div><h4 id="list-type"><code>list</code> type
<a href="#list-type" aria-label="Anchor"><i aria-hidden="true"></i></a></h4><p>The Python’s <code>list</code> type is defined in the <code>listobject.c</code> file:</p><div><pre tabindex="0"><code data-lang="c"><span><span id="hl-14-1"><a href="#hl-14-1">1</a></span><span><span>PyTypeObject</span> <span>PyList_Type</span> <span>=</span> <span>{</span>
</span></span><span><span id="hl-14-2"><a href="#hl-14-2">2</a></span><span>    <span>// ...
</span></span></span><span><span id="hl-14-3"><a href="#hl-14-3">3</a></span><span><span></span>    <span>(</span><span>initproc</span><span>)</span><span>list___init__</span><span>,</span> <span>/* tp_init */</span>
</span></span><span><span id="hl-14-4"><a href="#hl-14-4">4</a></span><span>    <span>PyType_GenericAlloc</span><span>,</span> <span>/* tp_alloc */</span>
</span></span><span><span id="hl-14-5"><a href="#hl-14-5">5</a></span><span>    <span>PyType_GenericNew</span><span>,</span> <span>/* tp_new */</span>
</span></span><span><span id="hl-14-6"><a href="#hl-14-6">6</a></span><span>    <span>// ...
</span></span></span><span><span id="hl-14-7"><a href="#hl-14-7">7</a></span><span><span></span><span>}</span>
</span></span></code></pre></div><p><code>PyType_GenericNew</code> does nothing — it ignores <code>args</code> and <code>kwargs</code>, and return an object allocated by
<code>type-&gt;typ_alloc</code>. Source: <a href="https://github.com/python/cpython/blob/main/Objects/typeobject.c#L1768">https://github.com/python/cpython/blob/main/Objects/typeobject.c#L1768</a></p><p><code>PyType_GenericAlloc</code> allocated a new object and (if it’s garbage-collectable) marks it as “to-be-collected”.</p><p><code>list___init__</code> is a convenience wrapper around the <code>list___init___impl</code> function, which does the actual initialization.
It does some basic pre-steps:</p><ul><li>fails if any <code>kwarg</code> has been passed,</li><li>fails if <code>args</code> has more then 1 element,</li><li>converts the first argument of <code>args</code> to an iterable.</li></ul><p><code>list___init___impl</code> clears the list (if not empty) and extends it by the provided iterable (by calling the
<code>list_extend</code> function).</p><div><h6><i aria-hidden="true"></i>
Question</h6><p>I think the two:</p><div><pre tabindex="0"><code data-lang="python"><span><span id="hl-0-1"><a href="#hl-0-1">1</a></span><span><span>list</span><span>((</span><span>1</span><span>,</span> <span>2</span><span>,</span> <span>3</span><span>))</span>
</span></span><span><span id="hl-0-2"><a href="#hl-0-2">2</a></span><span>
</span></span><span><span id="hl-0-3"><a href="#hl-0-3">3</a></span><span><span>_tmp</span> <span>=</span> <span>list</span><span>()</span>
</span></span><span><span id="hl-0-4"><a href="#hl-0-4">4</a></span><span><span>_tmp</span><span>.</span><span>extend</span><span>((</span><span>1</span><span>,</span> <span>2</span><span>,</span> <span>3</span><span>))</span>
</span></span></code></pre></div><p>are equivalent in every way (but the generated opcodes sequence) and are calling the same underlying C code.</p></div><h4 id="-literal-expression"><code>[]</code> literal expression
<a href="#-literal-expression" aria-label="Anchor"><i aria-hidden="true"></i></a></h4><p>Opcode <code>BUILD_LIST</code> uses the <code>_PyList_FromArraySteal</code> function to construct a list object and return it.</p><div><h6><i aria-hidden="true"></i>
Note</h6><p>_PyList_FromArraySteal is used since 3.12. See <a href="https://docs.python.org/3.12/whatsnew/changelog.html">3.12 changelog</a>
and <a href="https://github.com/python/cpython/pull/100147">gh-100146</a>. Before 3.12, the opcode was repeatedly calling <code>POP()</code>
to get items from the stack, and then inserting them into the list.</p><div><pre tabindex="0"><code data-lang="c"><span><span id="hl-0-1"><a href="#hl-0-1">1</a></span><span><span>while</span> <span>(</span><span>--</span><span>oparg</span> <span>&gt;=</span> <span>0</span><span>)</span> <span>{</span>
</span></span><span><span id="hl-0-2"><a href="#hl-0-2">2</a></span><span>    <span>PyObject</span> <span>*</span><span>item</span> <span>=</span> <span>POP</span><span>();</span>
</span></span><span><span id="hl-0-3"><a href="#hl-0-3">3</a></span><span>    <span>PyList_SET_ITEM</span><span>(</span><span>list</span><span>,</span> <span>oparg</span><span>,</span> <span>item</span><span>);</span>
</span></span><span><span id="hl-0-4"><a href="#hl-0-4">4</a></span><span><span>}</span>
</span></span></code></pre></div><p>See <a href="https://github.com/python/cpython/pull/100147/files#diff-729a985b0cb8b431cb291f1edb561bbbfea22e3f8c262451cd83328a0936a342L1447-L1450">change in gh-100146 PR</a>.</p></div><p>The <code>_PyList_FromArraySteal</code> helper creates an empty list (if there are no items), or preallocates the list before
inserting items to it.</p><div><pre tabindex="0"><code data-lang="c"><span><span id="hl-15-1"><a href="#hl-15-1">1</a></span><span><span>PyObject</span> <span>**</span><span>dst</span> <span>=</span> <span>list</span><span>-&gt;</span><span>ob_item</span><span>;</span>
</span></span><span><span id="hl-15-2"><a href="#hl-15-2">2</a></span><span><span>memcpy</span><span>(</span><span>dst</span><span>,</span> <span>src</span><span>,</span> <span>n</span> <span>*</span> <span>sizeof</span><span>(</span><span>PyObject</span> <span>*</span><span>));</span>
</span></span></code></pre></div><h3 id="sets">Sets
<a href="#sets" aria-label="Anchor"><i aria-hidden="true"></i></a></h3><div><h6><i aria-hidden="true"></i>
Warning</h6><p>AFAIK there’s no way to construct a new set with a literal expression, hence the following analysis is performed for
sets with two elements: <code>1</code> and <code>2</code>.</p></div><div><pre tabindex="0"><code data-lang="sh"><span><span id="hl-16-1"><a href="#hl-16-1">1</a></span><span>$ python -m timeit <span>&#34;set((1, 2))&#34;</span>
</span></span><span><span id="hl-16-2"><a href="#hl-16-2">2</a></span><span><span>5000000</span> loops, best of 5: 82.6 nsec per loop
</span></span><span><span id="hl-16-3"><a href="#hl-16-3">3</a></span><span>$ python -m timeit <span>&#34;{1, 2}&#34;</span>
</span></span><span><span id="hl-16-4"><a href="#hl-16-4">4</a></span><span><span>5000000</span> loops, best of 5: 45.5 nsec per loop
</span></span></code></pre></div><h4 id="set-type"><code>set</code> type
<a href="#set-type" aria-label="Anchor"><i aria-hidden="true"></i></a></h4><p>The Python’s <code>set</code> type is defined in the <code>setobject.c</code> file:</p><div><pre tabindex="0"><code data-lang="c"><span><span id="hl-17-1"><a href="#hl-17-1">1</a></span><span><span>PyTypeObject</span> <span>PySet_Type</span> <span>=</span> <span>{</span>
</span></span><span><span id="hl-17-2"><a href="#hl-17-2">2</a></span><span>    <span>// ...
</span></span></span><span><span id="hl-17-3"><a href="#hl-17-3">3</a></span><span><span></span>    <span>(</span><span>initproc</span><span>)</span><span>set_init</span><span>,</span> <span>/* tp_init */</span>
</span></span><span><span id="hl-17-4"><a href="#hl-17-4">4</a></span><span>    <span>PyType_GenericAlloc</span><span>,</span> <span>/* tp_alloc */</span>
</span></span><span><span id="hl-17-5"><a href="#hl-17-5">5</a></span><span>    <span>set_new</span><span>,</span> <span>/* tp_new */</span>
</span></span><span><span id="hl-17-6"><a href="#hl-17-6">6</a></span><span>    <span>// ...
</span></span></span><span><span id="hl-17-7"><a href="#hl-17-7">7</a></span><span><span></span><span>}</span>
</span></span></code></pre></div><p><code>set_new</code> uses the allocated to create a new empty set object. Internally it calls the <code>make_new_set</code> function.</p><p><code>set_init</code> performs some pre-steps:</p><ul><li>fails if any <code>kwarg</code> has been passed,</li><li>fails if <code>args</code> has more then 1 element,</li><li>converts the first argument of <code>args</code> to an iterable,</li><li>if the set object has already been filled, then it clears it</li></ul><p>… and calls the <code>set_update_internal</code> function, to insert values into the set object.</p><h4 id="1-2-literal-expression"><code>{1, 2}</code> literal expression
<a href="#1-2-literal-expression" aria-label="Anchor"><i aria-hidden="true"></i></a></h4><p>The opcode handler has no dedicated helpers. It constructs a new set (empty), and then iterates over all items from the
stack and insets them one-by-one.</p><div><pre tabindex="0"><code data-lang="c"><span><span id="hl-18-1"><a href="#hl-18-1"> 1</a></span><span><span>inst</span><span>(</span><span>BUILD_SET</span><span>,</span> <span>(</span><span>values</span><span>[</span><span>oparg</span><span>]</span> <span>--</span> <span>set</span><span>))</span> <span>{</span>
</span></span><span><span id="hl-18-2"><a href="#hl-18-2"> 2</a></span><span>    <span>set</span> <span>=</span> <span>PySet_New</span><span>(</span><span>NULL</span><span>);</span>
</span></span><span><span id="hl-18-3"><a href="#hl-18-3"> 3</a></span><span>    <span>if</span> <span>(</span><span>set</span> <span>==</span> <span>NULL</span><span>)</span>
</span></span><span><span id="hl-18-4"><a href="#hl-18-4"> 4</a></span><span>    <span>GOTO_ERROR</span><span>(</span><span>error</span><span>);</span>
</span></span><span><span id="hl-18-5"><a href="#hl-18-5"> 5</a></span><span>    <span>int</span> <span>err</span> <span>=</span> <span>0</span><span>;</span>
</span></span><span><span id="hl-18-6"><a href="#hl-18-6"> 6</a></span><span>    <span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>oparg</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
</span></span><span><span id="hl-18-7"><a href="#hl-18-7"> 7</a></span><span>        <span>PyObject</span> <span>*</span><span>item</span> <span>=</span> <span>values</span><span>[</span><span>i</span><span>];</span>
</span></span><span><span id="hl-18-8"><a href="#hl-18-8"> 8</a></span><span>        <span>if</span> <span>(</span><span>err</span> <span>==</span> <span>0</span><span>)</span>
</span></span><span><span id="hl-18-9"><a href="#hl-18-9"> 9</a></span><span>            <span>err</span> <span>=</span> <span>PySet_Add</span><span>(</span><span>set</span><span>,</span> <span>item</span><span>);</span>
</span></span><span><span id="hl-18-10"><a href="#hl-18-10">10</a></span><span>        <span>Py_DECREF</span><span>(</span><span>item</span><span>);</span>
</span></span><span><span id="hl-18-11"><a href="#hl-18-11">11</a></span><span>    <span>}</span>
</span></span><span><span id="hl-18-12"><a href="#hl-18-12">12</a></span><span>    <span>if</span> <span>(</span><span>err</span> <span>!=</span> <span>0</span><span>)</span> <span>{</span>
</span></span><span><span id="hl-18-13"><a href="#hl-18-13">13</a></span><span>        <span>Py_DECREF</span><span>(</span><span>set</span><span>);</span>
</span></span><span><span id="hl-18-14"><a href="#hl-18-14">14</a></span><span>        <span>ERROR_IF</span><span>(</span><span>true</span><span>,</span> <span>error</span><span>);</span>
</span></span><span><span id="hl-18-15"><a href="#hl-18-15">15</a></span><span>    <span>}</span>
</span></span><span><span id="hl-18-16"><a href="#hl-18-16">16</a></span><span><span>}</span>
</span></span></code></pre></div><p>Source: <a href="https://github.com/python/cpython/blob/main/Python/bytecodes.c#L1627">https://github.com/python/cpython/blob/main/Python/bytecodes.c#L1627</a>.</p><div><h6><i aria-hidden="true"></i>
Warning</h6><p>Warning
The generated bytecode is different if we add another argument to the literal expression: <code>{1, 2, 3}</code>. Then it becomes:</p><div><pre tabindex="0"><code data-lang="python"><span><span id="hl-0-1"><a href="#hl-0-1">1</a></span><span>   <span>2</span> <span>BUILD_SET</span>                <span>0</span>
</span></span><span><span id="hl-0-2"><a href="#hl-0-2">2</a></span><span>   <span>4</span> <span>LOAD_CONST</span>               <span>1</span> <span>(</span><span>frozenset</span><span>({</span><span>1</span><span>,</span> <span>2</span><span>,</span> <span>3</span><span>}))</span>
</span></span><span><span id="hl-0-3"><a href="#hl-0-3">3</a></span><span>   <span>6</span> <span>SET_UPDATE</span>               <span>1</span>
</span></span><span><span id="hl-0-4"><a href="#hl-0-4">4</a></span><span>   <span>8</span> <span>RETURN_VALUE</span>
</span></span></code></pre></div></div><h3 id="tuples">Tuples
<a href="#tuples" aria-label="Anchor"><i aria-hidden="true"></i></a></h3><p>This one’s tricky. Constructing a tuple with the <code>tuple</code> type requires an iterable. The easiest way of getting one it to
create a tuple literal, which is obviously less efficient, than using a tuple literal syntax in the first place.</p><div><pre tabindex="0"><code data-lang="python"><span><span id="hl-19-1"><a href="#hl-19-1"> 1</a></span><span><span>&gt;&gt;&gt;</span> <span>import</span> <span>sys</span>
</span></span><span><span id="hl-19-2"><a href="#hl-19-2"> 2</a></span><span><span>&gt;&gt;&gt;</span> <span>sys</span><span>.</span><span>version_info</span>
</span></span><span><span id="hl-19-3"><a href="#hl-19-3"> 3</a></span><span><span>sys</span><span>.</span><span>version_info</span><span>(</span><span>major</span><span>=</span><span>3</span><span>,</span> <span>minor</span><span>=</span><span>12</span><span>,</span> <span>micro</span><span>=</span><span>1</span><span>,</span> <span>releaselevel</span><span>=</span><span>&#39;final&#39;</span><span>,</span> <span>serial</span><span>=</span><span>0</span><span>)</span>
</span></span><span><span id="hl-19-4"><a href="#hl-19-4"> 4</a></span><span><span>&gt;&gt;&gt;</span>
</span></span><span><span id="hl-19-5"><a href="#hl-19-5"> 5</a></span><span><span>&gt;&gt;&gt;</span> <span>def</span> <span>a</span><span>():</span>
</span></span><span><span id="hl-19-6"><a href="#hl-19-6"> 6</a></span><span><span>...</span>   <span>return</span> <span>tuple</span><span>((</span><span>1</span><span>,</span> <span>2</span><span>,</span> <span>[]))</span>
</span></span><span><span id="hl-19-7"><a href="#hl-19-7"> 7</a></span><span><span>&gt;&gt;&gt;</span>
</span></span><span><span id="hl-19-8"><a href="#hl-19-8"> 8</a></span><span><span>&gt;&gt;&gt;</span> <span>def</span> <span>b</span><span>():</span>
</span></span><span><span id="hl-19-9"><a href="#hl-19-9"> 9</a></span><span><span>...</span>   <span>return</span> <span>(</span><span>1</span><span>,</span> <span>2</span><span>,</span> <span>[])</span>
</span></span><span><span id="hl-19-10"><a href="#hl-19-10">10</a></span><span><span>&gt;&gt;&gt;</span>
</span></span><span><span id="hl-19-11"><a href="#hl-19-11">11</a></span><span><span>&gt;&gt;&gt;</span> <span>import</span> <span>dis</span>
</span></span><span><span id="hl-19-12"><a href="#hl-19-12">12</a></span><span><span>&gt;&gt;&gt;</span>
</span></span><span><span id="hl-19-13"><a href="#hl-19-13">13</a></span><span><span>&gt;&gt;&gt;</span> <span>dis</span><span>.</span><span>dis</span><span>(</span><span>a</span><span>)</span>
</span></span><span><span id="hl-19-14"><a href="#hl-19-14">14</a></span><span>  <span>1</span>           <span>0</span> <span>RESUME</span>                   <span>0</span>
</span></span><span><span id="hl-19-15"><a href="#hl-19-15">15</a></span><span>
</span></span><span><span id="hl-19-16"><a href="#hl-19-16">16</a></span><span>  <span>2</span>           <span>2</span> <span>LOAD_GLOBAL</span>              <span>1</span> <span>(</span><span>NULL</span> <span>+</span> <span>tuple</span><span>)</span>
</span></span><span><span id="hl-19-17"><a href="#hl-19-17">17</a></span><span>             <span>12</span> <span>LOAD_CONST</span>               <span>1</span> <span>(</span><span>1</span><span>)</span>
</span></span><span><span id="hl-19-18"><a href="#hl-19-18">18</a></span><span>             <span>14</span> <span>LOAD_CONST</span>               <span>2</span> <span>(</span><span>2</span><span>)</span>
</span></span><span><span id="hl-19-19"><a href="#hl-19-19">19</a></span><span>             <span>16</span> <span>BUILD_LIST</span>               <span>0</span>
</span></span><span><span id="hl-19-20"><a href="#hl-19-20">20</a></span><span>             <span>18</span> <span>BUILD_TUPLE</span>              <span>3</span>
</span></span><span><span id="hl-19-21"><a href="#hl-19-21">21</a></span><span>             <span>20</span> <span>CALL</span>                     <span>1</span>
</span></span><span><span id="hl-19-22"><a href="#hl-19-22">22</a></span><span>             <span>28</span> <span>RETURN_VALUE</span>
</span></span><span><span id="hl-19-23"><a href="#hl-19-23">23</a></span><span><span>&gt;&gt;&gt;</span> <span>dis</span><span>.</span><span>dis</span><span>(</span><span>b</span><span>)</span>
</span></span><span><span id="hl-19-24"><a href="#hl-19-24">24</a></span><span>  <span>1</span>           <span>0</span> <span>RESUME</span>                   <span>0</span>
</span></span><span><span id="hl-19-25"><a href="#hl-19-25">25</a></span><span>
</span></span><span><span id="hl-19-26"><a href="#hl-19-26">26</a></span><span>  <span>2</span>           <span>2</span> <span>LOAD_CONST</span>               <span>1</span> <span>(</span><span>1</span><span>)</span>
</span></span><span><span id="hl-19-27"><a href="#hl-19-27">27</a></span><span>              <span>4</span> <span>LOAD_CONST</span>               <span>2</span> <span>(</span><span>2</span><span>)</span>
</span></span><span><span id="hl-19-28"><a href="#hl-19-28">28</a></span><span>              <span>6</span> <span>BUILD_LIST</span>               <span>0</span>
</span></span><span><span id="hl-19-29"><a href="#hl-19-29">29</a></span><span>              <span>8</span> <span>BUILD_TUPLE</span>              <span>3</span>
</span></span><span><span id="hl-19-30"><a href="#hl-19-30">30</a></span><span>             <span>10</span> <span>RETURN_VALUE</span>
</span></span></code></pre></div><p>It might not make much sense to include this example in the article.</p><h4 id="tuple-type"><code>tuple</code> type
<a href="#tuple-type" aria-label="Anchor"><i aria-hidden="true"></i></a></h4><p>The Python’s <code>tuple</code> type is defined in <code>tupleobject.c</code>. Interestingly, it has no <code>tp_alloc</code>, nor <code>tp_init</code>.</p><div><pre tabindex="0"><code data-lang="c"><span><span id="hl-20-1"><a href="#hl-20-1">1</a></span><span><span>PyTypeObject</span> <span>PyTuple_Type</span> <span>=</span> <span>{</span>
</span></span><span><span id="hl-20-2"><a href="#hl-20-2">2</a></span><span>    <span>// ...
</span></span></span><span><span id="hl-20-3"><a href="#hl-20-3">3</a></span><span><span></span>    <span>0</span><span>,</span> <span>/* tp_init */</span>
</span></span><span><span id="hl-20-4"><a href="#hl-20-4">4</a></span><span>    <span>0</span><span>,</span> <span>/* tp_alloc */</span>
</span></span><span><span id="hl-20-5"><a href="#hl-20-5">5</a></span><span>    <span>tuple_new</span><span>,</span> <span>/* tp_new */</span>
</span></span><span><span id="hl-20-6"><a href="#hl-20-6">6</a></span><span>    <span>// ...
</span></span></span><span><span id="hl-20-7"><a href="#hl-20-7">7</a></span><span><span></span><span>}</span>
</span></span></code></pre></div><p>The <code>tuple_new</code> function is responsible for allocating a new tuple object, with the items passed as a parameter.</p></div></div>
  </body>
</html>
