<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://0110.be/posts/USB_MIDI_interface_for_the_NeXTCube_-_ISPW_board">Original</a>
    <h1>USB MIDI interface for the NeXTCube – ISPW board</h1>
    
    <div id="readability-page-1" class="page"><div>
    <article>
		

<span><a href="https://0110.be/posts/USB_MIDI_interface_for_the_NeXTCube_-_ISPW_board">»</a> By <a href="https://0110.be/users/Joren">Joren</a> on Friday 05 <a href="https://0110.be/date/2023/5">May 2023</a></span>
<p>I have recently <a href="https://0110.be/posts/Electronic_Music_and_the_NeXTcube_-_Running_MAX_on_the_IRCAM_Musical_Workstation">restored a NeXTCube with an <span>ISPW</span> Ariel soundcard</a> with the aim to put it in the hands of artists and researchers in the context of a <a href="https://asil.ugent.be/projects/#heritageinstruments">living electronic music instrument heritage project</a>. To make the cube talk to keyboards, synths or other audio workstations I have built a <i><span>MIDI</span> interface for the NeXTcube</i>.</p>
<center>
<p><img src="https://0110.be/files/attachments/514/nextcube_midi_proport.webp"/></p>
</center>
<p>Recently, I was able to restore a NeXTCube and install an early version of <span>MAX</span> – a graphical music programming environment. However, a crucial part of the system was missing: there was no way to do <a href="https://en.wikipedia.org/wiki/MIDI"><span>MIDI</span> input/output</a>. <span>MIDI</span> is used to connect controllers, keyboards, synthesizers or other musical instruments to the audio workstation. The NeXTCube itself has <a href="https://www.nextcomputers.org/NeXTfiles/Docs/connectivity.pdf">a serial port which allows users to connect <span>MIDI</span> devices</a>. Next to the serial port on the mainboard, the NeXTCube I am working with also has a RS-422 serial port on the <span>ISPW</span> ‘soundcard’. The serial port uses RS-422 and mini <span>DIN</span> 8 connectors which provide <span>MIDI</span> input and output. While the <span>MIDI</span> data bytes are transmitted according to spec, the <i>connector and the electrical signals are not compatible with standard <span>MIDI</span></i>.</p>
<center>
<p><img src="https://0110.be/files/attachments/514/ariel_soundcard_IRCAM_ISPW.jpg"/></p>
</center>
<p>For <span>MIDI</span> I/O we need a device which allows to connect the RS-422 <span>MIDI</span> to both legacy <span>MIDI</span> devices and to computers via <span>USB</span> <span>MIDI</span>. If a <span>MIDI</span> event arrives from the NeXTCube’s RS-422 it needs to be passed through to the <span>USB</span> and legacy <span>MIDI</span> ports and the other way around. The <a href="https://www.pjrc.com/teensy/">Teensy platform</a> is ideal: it supports hardware serial and <span>USB</span> <span>MIDI</span>. In this retro-computing project, it seems wasteful to use the 600MHz Teensy 4.0 only for message passing: the Teensy has much more computing power than NeXTcube but it is cheap, easy to program, available and practical.</p>
<p>The RS-422 serial port uses -6V to 6V logic which needs to be transformed to the 0V to 3.3V logic for the Teensy microcontroller. A <span>PCB</span> provides this capability and is connected to a hardware serial port of the Teensy. The pinout of the RS-422 port was measured via a scope and matched the <a href="https://allpinouts.org/pinouts/connectors/serial/apple-macintosh-rs-422-serial/">documentation</a>.  The Teensy has an <code>usbMIDI</code> mode and can present itself as a standard <span>MIDI</span> device to a PC. Two <a href="https://www.sparkfun.com/products/12898">opto-isolated legacy <span>MIDI</span> <span>DIN</span>-5 ports</a> were connected to another hardware serial port. The software on the Teensy conducts the <a href="https://0110.be/files/attachments/514/midi_passthrough.ino">three-way <span>MIDI</span> message passing</a>.</p>
<center>
<video controls="" preload="none" poster="/files/attachments/514/midi_box_example_web.webp">
<source src="/files/attachments/514/midi_box_example_web.mp4" type="video/mp4"/>
</video>
<p><small>Vid: Max/<span>FTS</span> FM synth reacting to <span>USB</span> <span>MIDI</span> input.</small></p>
</center>
<p>The electronics were fixed into a reused metal enclosure. The front panel of the enclosure was replaced by a custom 3D printed panel. The front contains the RS-422 port, two <span>MIDI</span> <span>DIN</span> 5 ports and a micro usb port either for power alone or <span>MIDI</span> messages and power. Feel free to check out the <a href="https://0110.be/files/attachments/514/midi_box.scad">OpenSCAD design with a level <span>MINI</span> DIN8 hole</a>.</p>
<p>With a working <span>MIDI</span> interface for the NeXTcube allows interfacing with <span>MIDI</span> keyboards and controllers. It can also be used to measure roundtrip latency. <span>MIDI</span> to sound latency determines how long it takes between pressing a <span>MIDI</span> key and hearing sound. <span>MIDI</span> to <span>MIDI</span> roundtrip latency determines how long it takes to process, parse and return a <span>MIDI</span> message. For a responsive, reliable system both types of latencies should be constant and preferably in the range of 10ms or below.</p>
<center>
<p><img src="https://0110.be/files/attachments/514/midi_roundtrip_latency.svg"/></p>
</center>
<p>Measuring the <span>MIDI</span> roundtrip latency shows that the system is able to respond in 3.6+-0.4 ms (N=300). A combination of a <span>MAX</span> patch and <a href="https://0110.be/files/attachments/514/next_midi_roundtrip_latency.ino">Teensy firmware</a> was used to measure this automatically. The <span>MIDI</span>-to-audio latency was measured a few times manually and always was around 13ms. These figures show that the system is ideal for low-latency real-time music making in its default configuration. In <span>MAX</span> the audio buffer sizes could be reduced to achieve an even lower latency but with the risk of running into buffer underruns and audio glitches.</p>
<p>Small <a href="https://hackaday.com/2023/05/16/midi-interface-for-nextcube-plugs-into-the-past/#comments">discussion the <span>USB</span> <span>MIDI</span> interface for the NeXTCube on Hackaday</a></p>

	

	<span>
		<img src="https://0110.be/images/icons/tag_blue.png" alt="Tags" title="Tags"/>
		<a title="Everything tagged: Code" href="https://0110.be/tags/Code">Code</a>, <a title="Everything tagged: Harde waren" href="https://0110.be/tags/Harde%20waren">Harde waren</a>, <a title="Everything tagged: Muziek" href="https://0110.be/tags/Muziek">Muziek</a>, and <a title="Everything tagged: UGent" href="https://0110.be/tags/UGent">UGent</a>
	</span>	

	<span>
	<img src="https://0110.be/images/icons/attach.png" alt="Attachments" title="Attachments"/> 
	<a href="https://0110.be/files/attachments/514/ariel_soundcard_IRCAM_ISPW.jpg">ariel_soundcard_IRCAM_ISPW.jpg</a>, <a href="https://0110.be/files/attachments/514/midi_box.scad">midi_box.scad</a>, <a href="https://0110.be/files/attachments/514/midi_roundtrip_latency.svg">midi_roundtrip_latency.svg</a>, <a href="https://0110.be/files/attachments/514/midi_passthrough.ino">midi_passthrough.ino</a>, <a href="https://0110.be/files/attachments/514/next_midi_roundtrip_latency.ino">next_midi_roundtrip_latency.ino</a>, <a href="https://0110.be/files/attachments/514/midi_roundtrip_test.pat">midi_roundtrip_test.pat</a>, <a href="https://0110.be/files/attachments/514/nextcube_midi_proport.webp">nextcube_midi_proport.webp</a>, <a href="https://0110.be/files/attachments/514/midi_box_example_web.webp">midi_box_example_web.webp</a>, and <a href="https://0110.be/files/attachments/514/midi_box_example_web.mp4">midi_box_example_web.mp4</a>
	</span>


</article>


  </div></div>
  </body>
</html>
