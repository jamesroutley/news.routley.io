<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mary.codes/blog/programming/translating_openstreetmaps_to_HTML5_canvas_rust_wasm/">Original</a>
    <h1>Translating OpenStreetMap data to HTML5 Canvas with Rust and WebAssembly</h1>
    
    <div id="readability-page-1" class="page"><p>Using the Overpass API to read OSM data, parsing the data with Rust, and then drawing the map onto HTML5 canvas.</p><div><p>I&#39;m working on a revamp of an old project of mine called <a href="https://github.com/captainpainway/line-buddy">Line Buddy (github)</a>. It used a now-deprecated API library called <a href="https://github.com/cubehouse/themeparks">themeparks (github)</a> and <a href="https://aframe.io/">A-Frame</a> to visually represent the wait times in the Disney World theme parks in 3D.</p>
<p>The original project used OpenStreetMap screenshots as the base, with columns representing the wait times. (They&#39;re all zero now since this version of the API no longer works.)</p>
<p><span>
      <a href="https://mary.codes/static/b5dc3177f681dee9e6632689eec7a22d/e9bec/old-linebuddy.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/b5dc3177f681dee9e6632689eec7a22d/f51c2/old-linebuddy.webp 148w,
/static/b5dc3177f681dee9e6632689eec7a22d/66888/old-linebuddy.webp 295w,
/static/b5dc3177f681dee9e6632689eec7a22d/bc8a3/old-linebuddy.webp 590w,
/static/b5dc3177f681dee9e6632689eec7a22d/4ce34/old-linebuddy.webp 885w,
/static/b5dc3177f681dee9e6632689eec7a22d/f490a/old-linebuddy.webp 1180w,
/static/b5dc3177f681dee9e6632689eec7a22d/f98dc/old-linebuddy.webp 1392w" sizes="(max-width: 590px) 100vw, 590px" type="image/webp"/>
          <source srcset="/static/b5dc3177f681dee9e6632689eec7a22d/c5084/old-linebuddy.png 148w,
/static/b5dc3177f681dee9e6632689eec7a22d/60cc9/old-linebuddy.png 295w,
/static/b5dc3177f681dee9e6632689eec7a22d/6d370/old-linebuddy.png 590w,
/static/b5dc3177f681dee9e6632689eec7a22d/540ae/old-linebuddy.png 885w,
/static/b5dc3177f681dee9e6632689eec7a22d/2561a/old-linebuddy.png 1180w,
/static/b5dc3177f681dee9e6632689eec7a22d/e9bec/old-linebuddy.png 1392w" sizes="(max-width: 590px) 100vw, 590px" type="image/png"/>
          <img src="https://mary.codes/static/b5dc3177f681dee9e6632689eec7a22d/6d370/old-linebuddy.png" alt="Original version of the project" title="" loading="lazy" decoding="async"/>
        </picture>
  </a>
    </span></p>
<p>My plan is to use OpenStreetMap data to create a simplified version of the map. Eventually, I&#39;ll create the map in 3D. As a proof of concept, however, I&#39;m going to draw to an HTML5 canvas first. I want to make sure that I&#39;m able to get the data that I need, process it, and use it to create my own maps.</p>
<h3 id="table-of-contents"><a href="#table-of-contents" aria-label="table of contents permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Table of Contents</h3>
<ul>
<li><a href="#setting-up-the-project">Setting up the project</a></li>
<li><a href="#creating-a-new-project-with-wasm-pack">Creating a new project with wasm-pack</a></li>
<li><a href="#building-and-testing-wasm-code">Building and testing WASM code</a></li>
<li><a href="#getting-map-coordinates">Getting map coordinates</a></li>
<li><a href="#calling-the-overpass-api">Calling the Overpass API</a></li>
<li><a href="#writing-the-rust-code">Writing the Rust code</a></li>
<li><a href="#drawing-on-the-canvas">Drawing on the canvas</a></li>
<li><a href="#processing-ways-and-relations">Processing ways and relations</a></li>
<li><a href="#drawing-all-of-the-other-map-areas">Drawing all of the other map areas</a></li>
<li><a href="#the-finished-map">The finished map</a></li>
</ul>
<h3 id="setting-up-the-project"><a href="#setting-up-the-project" aria-label="setting up the project permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setting up the project</h3>
<p>I&#39;m not going to use any sort of JavaScript library for this first experiment. I set up a basic HTML page inside of a directory, and I&#39;m adding CSS and JavaScript directly to this page. A very simple setup because all I need the JavaScript to do is call the WASM code and draw to a canvas.</p>
<div data-language="html"><pre><code><span><span>&lt;!</span><span>DOCTYPE</span> <span>html</span><span>&gt;</span></span>
<span><span><span>&lt;</span>html</span> <span>lang</span><span><span>=</span><span>&#34;</span>en<span>&#34;</span></span><span>&gt;</span></span>
  <span><span><span>&lt;</span>head</span><span>&gt;</span></span>
  <span><span><span>&lt;</span>meta</span> <span>charset</span><span><span>=</span><span>&#34;</span>UTF-8<span>&#34;</span></span><span>&gt;</span></span>
  <span><span><span>&lt;</span>title</span><span>&gt;</span></span>OSM Maps<span><span><span>&lt;/</span>title</span><span>&gt;</span></span>
<span><span><span>&lt;</span>style</span><span>&gt;</span></span><span><span>
  <span>body</span> <span>{</span>
      <span>margin</span><span>:</span> 0<span>;</span>
      <span>padding</span><span>:</span> 0<span>;</span>
      <span>height</span><span>:</span> 100%<span>;</span>
      <span>width</span><span>:</span> 100%<span>;</span>
    <span>}</span>
</span></span><span><span><span>&lt;/</span>style</span><span>&gt;</span></span>
<span><span><span>&lt;/</span>head</span><span>&gt;</span></span>
<span><span><span>&lt;</span>body</span><span>&gt;</span></span>
  <span><span><span>&lt;</span>canvas</span> <span>id</span><span><span>=</span><span>&#34;</span>canvas<span>&#34;</span></span><span>&gt;</span></span><span><span><span>&lt;/</span>canvas</span><span>&gt;</span></span>
  <span><span><span>&lt;</span>script</span> <span>type</span><span><span>=</span><span>&#34;</span>module<span>&#34;</span></span><span>&gt;</span></span><span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
<span><span><span>&lt;/</span>body</span><span>&gt;</span></span>
<span><span><span>&lt;/</span>html</span><span>&gt;</span></span></code></pre></div>
<p>Most of the heavy lifting for the OSM data processing will be taken care of by Rust. While I haven&#39;t performed any benchmarks about whether Rust or JavaScript processing is faster, I decided to use Rust and WebAssembly because there will be a lot of coordinates to process, and Rust generally performs faster at large amounts of data processing.</p>
<h3 id="creating-a-new-project-with-wasm-pack"><a href="#creating-a-new-project-with-wasm-pack" aria-label="creating a new project with wasm pack permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Creating a new project with wasm-pack</h3>
<p>I decided to use <a href="https://rustwasm.github.io/wasm-pack/installer/">wasm-pack</a> to create a Rust library that will then be used by my client-side JavaScript. While I already had wasm-pack installed, I re-ran the installer because my installed version of wasm-pack was extremely out of date.</p>
<p>Creating a new wasm-pack project is easy. Instead of my normal workflow of using <code>cargo new process-maps</code> to create my new Rust project, I used <code>wasm-pack new process-maps</code>. This creates a new Rust project that is optimized for creating WASM files.</p>
<p>I created this project inside the same directory as my HTML file. This is because I want to be able to easily call the WASM code from my HTML file.</p>
<h3 id="building-and-testing-wasm-code"><a href="#building-and-testing-wasm-code" aria-label="building and testing wasm code permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Building and testing WASM code</h3>
<p>When I open up the <code>lib.rs</code> file generated by the wasm-pack tool, I see that it already contains some minimal code that will display an alert whenever the <code>greet()</code> function is called from JavaScript. There&#39;s a line-by-line explanation of this file at <a href="https://rustwasm.github.io/docs/wasm-pack/tutorials/npm-browser-packages/template-deep-dive/src-lib-rs.html">https://rustwasm.github.io/docs/wasm-pack/tutorials/npm-browser-packages/template-deep-dive/src-lib-rs.html</a>.</p>
<div data-language="rust"><pre><code><span>mod</span> <span>utils</span><span>;</span>

<span>use</span> <span>wasm_bindgen<span>::</span>prelude<span>::</span></span><span>*</span><span>;</span>

<span>#[wasm_bindgen]</span>
<span>extern</span> <span>&#34;C&#34;</span> <span>{</span>
    <span>fn</span> <span>alert</span><span>(</span>s<span>:</span> <span>&amp;</span><span>str</span><span>)</span><span>;</span>
<span>}</span>

<span>#[wasm_bindgen]</span>
<span>pub</span> <span>fn</span> <span>greet</span><span>(</span><span>)</span> <span>{</span>
    <span>alert</span><span>(</span><span>&#34;Hello, process-maps!&#34;</span><span>)</span><span>;</span>
<span>}</span></code></pre></div>
<p>I am going to compile this code and import it into my HTML file.</p>
<div data-language="bash"><pre><code>wasm-pack build <span>--target</span> web <span>--dev</span></code></pre></div>
<p>This creates a development build of my Rust code. Running the command without <code>--dev</code> will compile a production release, which is slower but optimized. I&#39;m targeting &#34;web&#34; since I&#39;m not using any sort of bundler or webpack in my project.</p>
<p>Under the canvas tag in my HTML file, I&#39;m going to import the WASM code and call the <code>greet</code> function.</p>
<div data-language="html"><pre><code><span><span><span>&lt;</span>script</span> <span>type</span><span><span>=</span><span>&#34;</span>module<span>&#34;</span></span><span>&gt;</span></span><span><span>
  <span>import</span> init<span>,</span> <span>{</span> greet <span>}</span> <span>from</span> <span>&#39;./process-maps/pkg/process_maps.js&#39;</span><span>;</span>

  <span>async</span> <span>function</span> <span>run</span><span>(</span><span>)</span> <span>{</span>
    <span>await</span> <span>init</span><span>(</span><span>)</span><span>;</span>
    <span>greet</span><span>(</span><span>)</span><span>;</span>
  <span>}</span>

  <span>run</span><span>(</span><span>)</span><span>;</span>
</span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span></code></pre></div>
<p>When I open my HTML file in a browser, I see an alert that says &#34;Hello, process-maps!&#34; This means that my WASM code is working and I can start writing the code to process the OSM data.</p>
<h3 id="getting-map-coordinates"><a href="#getting-map-coordinates" aria-label="getting map coordinates permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Getting map coordinates</h3>
<p>Before I can write any Rust code, I need to get the coordinates for a location. In this case, I want to get the coordinates for the different Disney World parks.</p>
<p>Because I want to pick a very specific area of the map, I will navigate to <a href="https://www.openstreetmap.org/">openstreetmap.org</a> and search for the locations I want to map. Then, I&#39;ll click the &#34;Export&#34; button. In the Export sidebar, I&#39;ll click &#34;Manually select a different area&#34;.</p>
<p><span>
      <a href="https://mary.codes/static/803704ed1ee35c3f328da61de41ddfd9/b0464/osm_magic_kingdom.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/803704ed1ee35c3f328da61de41ddfd9/f51c2/osm_magic_kingdom.webp 148w,
/static/803704ed1ee35c3f328da61de41ddfd9/66888/osm_magic_kingdom.webp 295w,
/static/803704ed1ee35c3f328da61de41ddfd9/bc8a3/osm_magic_kingdom.webp 590w,
/static/803704ed1ee35c3f328da61de41ddfd9/4ce34/osm_magic_kingdom.webp 885w,
/static/803704ed1ee35c3f328da61de41ddfd9/f490a/osm_magic_kingdom.webp 1180w,
/static/803704ed1ee35c3f328da61de41ddfd9/d8c84/osm_magic_kingdom.webp 1852w" sizes="(max-width: 590px) 100vw, 590px" type="image/webp"/>
          <source srcset="/static/803704ed1ee35c3f328da61de41ddfd9/c5084/osm_magic_kingdom.png 148w,
/static/803704ed1ee35c3f328da61de41ddfd9/60cc9/osm_magic_kingdom.png 295w,
/static/803704ed1ee35c3f328da61de41ddfd9/6d370/osm_magic_kingdom.png 590w,
/static/803704ed1ee35c3f328da61de41ddfd9/540ae/osm_magic_kingdom.png 885w,
/static/803704ed1ee35c3f328da61de41ddfd9/2561a/osm_magic_kingdom.png 1180w,
/static/803704ed1ee35c3f328da61de41ddfd9/b0464/osm_magic_kingdom.png 1852w" sizes="(max-width: 590px) 100vw, 590px" type="image/png"/>
          <img src="https://mary.codes/static/803704ed1ee35c3f328da61de41ddfd9/6d370/osm_magic_kingdom.png" alt="OSM Magic Kingdom" title="" loading="lazy" decoding="async"/>
        </picture>
  </a>
    </span></p>
<p>Once I have the area cropped, I&#39;m going to add the coordinates to my code. Since I&#39;m going to be creating maps of all the Disney parks, I&#39;m using query parameters to differentiate between which park map to draw.</p>
<div data-language="javascript"><pre><code><span>const</span> queryString <span>=</span> window<span>.</span>location<span>.</span>search<span>;</span>
<span>const</span> searchParams <span>=</span> <span>new</span> <span>URLSearchParams</span><span>(</span>queryString<span>)</span><span>;</span>
<span>let</span> park <span>=</span> searchParams<span>.</span><span>get</span><span>(</span><span>&#39;park&#39;</span><span>)</span><span>;</span>
<span>let</span> n<span>,</span> w<span>,</span> s<span>,</span> e<span>;</span>

<span>switch</span> <span>(</span>park<span>)</span> <span>{</span>
  <span>case</span> <span>&#39;epcot&#39;</span><span>:</span>
    n <span>=</span> <span>28.3768</span><span>;</span>
    w <span>=</span> <span>-</span><span>81.5553</span><span>;</span>
    s <span>=</span> <span>28.3661</span><span>;</span>
    e <span>=</span> <span>-</span><span>81.5425</span><span>;</span>
    <span>break</span><span>;</span>
  <span>case</span> <span>&#39;hollywood_studios&#39;</span><span>:</span>
  <span>case</span> <span>&#39;hs&#39;</span><span>:</span>
    n <span>=</span> <span>28.3625</span><span>;</span>
    w <span>=</span> <span>-</span><span>81.5641</span><span>;</span>
    s <span>=</span> <span>28.3523</span><span>;</span>
    e <span>=</span> <span>-</span><span>81.5561</span><span>;</span>
    <span>break</span><span>;</span>
  <span>case</span> <span>&#39;animal_kingdom&#39;</span><span>:</span>
  <span>case</span> <span>&#39;ak&#39;</span><span>:</span>
    n <span>=</span> <span>28.3692</span><span>;</span>
    w <span>=</span> <span>-</span><span>81.5984</span><span>;</span>
    s <span>=</span> <span>28.3524</span><span>;</span>
    e <span>=</span> <span>-</span><span>81.5831</span><span>;</span>
    <span>break</span><span>;</span>
  <span>case</span> <span>&#39;magic_kingdom&#39;</span><span>:</span>
  <span>case</span> <span>&#39;mk&#39;</span><span>:</span>
  <span>default</span><span>:</span>
    n <span>=</span> <span>28.42266</span><span>;</span>
    w <span>=</span> <span>-</span><span>81.58586</span><span>;</span>
    s <span>=</span> <span>28.41604</span><span>;</span>
    e <span>=</span> <span>-</span><span>81.57600</span><span>;</span>
    <span>break</span><span>;</span>
<span>}</span></code></pre></div>
<h3 id="calling-the-overpass-api"><a href="#calling-the-overpass-api" aria-label="calling the overpass api permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Calling the Overpass API</h3>
<p>OpenStreetMap&#39;s public API is called the <a href="https://wiki.openstreetmap.org/wiki/Overpass_API">Overpass API</a>. It has an interesting query language that I&#39;m not totally sure I understand, but I was able to create some queries that return the data I need.</p>
<p>Below, I have created query strings for all of the map items I need: walkways, gardens, water, and buildings. Below that, I&#39;m fetching the data for walkways.</p>
<div data-language="javascript"><pre><code><span>// The bounding box is described with the south, west, north, and east coordinates, in that order.</span>
<span>let</span> bbox <span>=</span> <span><span>`</span><span><span>${</span>s<span>}</span></span><span>,</span><span><span>${</span>w<span>}</span></span><span>,</span><span><span>${</span>n<span>}</span></span><span>,</span><span><span>${</span>e<span>}</span></span><span>`</span></span><span>;</span>
<span>// Queries for each map type.</span>
<span>let</span> buildings <span>=</span> <span><span>`</span><span>way[building][!name];foreach{(._;&gt;;);out;}</span><span>`</span></span><span>;</span>
<span>let</span> named_buildings <span>=</span> <span><span>`</span><span>way[building][name];foreach{(._;&gt;;);out;}</span><span>`</span></span><span>;</span>
<span>let</span> walkways <span>=</span> <span><span>`</span><span>way[highway];foreach{(._;&gt;;);out;}</span><span>`</span></span><span>;</span>
<span>let</span> trees <span>=</span> <span><span>`</span><span>node[natural=tree];foreach{(._;&gt;;);out;}</span><span>`</span></span><span>;</span>
<span>let</span> gardens <span>=</span> <span><span>`</span><span>(way[leisure=garden];way[landuse=forest];way[landuse=meadow];);foreach{(._;&gt;;);out;}</span><span>`</span></span><span>;</span>
<span>let</span> water <span>=</span> <span><span>`</span><span>relation[natural=water];foreach{(._;&gt;;);out;}</span><span>`</span></span><span>;</span>
<span>// Sets the timeout and bounding box.</span>
<span>let</span> query <span>=</span> <span><span>`</span><span>[timeout:90][bbox:</span><span><span>${</span>bbox<span>}</span></span><span>];</span><span>`</span></span><span>;</span>

<span>let</span> url <span>=</span> <span><span>`</span><span>https://overpass-api.de/api/interpreter?data=</span><span><span>${</span>query<span>}</span></span><span>`</span></span><span>;</span>


<span>function</span> <span>getWalkways</span><span>(</span><span>url</span><span>)</span> <span>{</span>
  <span>fetch</span><span>(</span><span><span>`</span><span><span>${</span>url<span>}</span></span><span><span>${</span>walkways<span>}</span></span><span>;out;</span><span>`</span></span><span>)</span><span>.</span><span>then</span><span>(</span><span>response</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> response<span>.</span><span>text</span><span>(</span><span>)</span><span>;</span>
  <span>}</span><span>)</span><span>.</span><span>then</span><span>(</span><span>data</span> <span>=&gt;</span> <span>{</span>
    console<span>.</span><span>log</span><span>(</span>data<span>)</span><span>;</span>
  <span>}</span><span>)</span><span>;</span>
<span>}</span></code></pre></div>
<p>The response in the console should look somewhat like this, a long XML document with coordinates.</p>
<p><span>
      <a href="https://mary.codes/static/da5ac250a567827e56bf8b2d722f42ff/97114/overpass-api-response.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/da5ac250a567827e56bf8b2d722f42ff/f51c2/overpass-api-response.webp 148w,
/static/da5ac250a567827e56bf8b2d722f42ff/66888/overpass-api-response.webp 295w,
/static/da5ac250a567827e56bf8b2d722f42ff/bc8a3/overpass-api-response.webp 590w,
/static/da5ac250a567827e56bf8b2d722f42ff/ffce4/overpass-api-response.webp 690w" sizes="(max-width: 590px) 100vw, 590px" type="image/webp"/>
          <source srcset="/static/da5ac250a567827e56bf8b2d722f42ff/c5084/overpass-api-response.png 148w,
/static/da5ac250a567827e56bf8b2d722f42ff/60cc9/overpass-api-response.png 295w,
/static/da5ac250a567827e56bf8b2d722f42ff/6d370/overpass-api-response.png 590w,
/static/da5ac250a567827e56bf8b2d722f42ff/97114/overpass-api-response.png 690w" sizes="(max-width: 590px) 100vw, 590px" type="image/png"/>
          <img src="https://mary.codes/static/da5ac250a567827e56bf8b2d722f42ff/6d370/overpass-api-response.png" alt="Overpass API response" title="" loading="lazy" decoding="async"/>
        </picture>
  </a>
    </span></p>
<p>I&#39;m going to send these coordinates to my Rust code, which will parse the XML file and return coordinates that I&#39;ll then be able to map to the canvas.</p>
<h3 id="writing-the-rust-code"><a href="#writing-the-rust-code" aria-label="writing the rust code permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Writing the Rust code</h3>
<p>To parse the XML file, I&#39;m using a crate called <a href="https://crates.io/crates/osm-xml/0.6.2">osm-xml</a>. It abstracts away the hard parts of parsing the OSM data. I tried doing it without this crate and trust me, it&#39;s very difficult.</p>
<p>I&#39;m adding osm-xml and js-sys to my Cargo.toml. The crate js-sys provides interop data structures for JavaScript.</p>
<div data-language="toml"><pre><code><span>[</span><span>dependencies</span><span>]</span>
<span>wasm-bindgen</span> <span>=</span> <span>&#34;0.2.84&#34;</span>
<span>console_error_panic_hook</span> <span>=</span> <span>{</span> <span>version</span> <span>=</span> <span>&#34;0.1.7&#34;</span><span>,</span> <span>optional</span> <span>=</span> <span>true</span> <span>}</span>
<span>osm-xml</span> <span>=</span> <span>&#34;0.6.2&#34;</span>
<span>js-sys</span> <span>=</span> <span>&#34;0.3.67&#34;</span></code></pre></div>
<p>OSM data can be thought of as three different types. There&#39;s nodes, which are discrete coordinates. The query for trees searches for nodes. Ways are polygons that are created from nodes, so processing a way requires processing the information for the way, and then the nodes. Buildings, walkways, and gardens are ways. Finally, there are relations, which are made of multiple ways. Water is a relation because there can be islands within the water. Any time there might need to be holes cut within a larger polygon, it will be a relation.</p>
<p>Since nodes are the easiest to parse, I&#39;m starting with processing the nodes first, then the ways, then relations.</p>
<p>First, I&#39;m going to turn my &#34;greet&#34; function into a log function. This way, I&#39;ll be able to log output to the JS console.</p>
<div data-language="rust"><pre><code><span>#[wasm_bindgen]</span>
<span>extern</span> <span>&#34;C&#34;</span> <span>{</span>
    <span>#[wasm_bindgen(js_namespace = console)]</span>
    <span>fn</span> <span>log</span><span>(</span>s<span>:</span> <span>&amp;</span><span>str</span><span>)</span><span>;</span>
<span>}</span></code></pre></div>
<p>Next, I&#39;m passing the string provided by the API (in the fetch call I&#39;m returning <code>response.text()</code>) to my WASM-bound function.</p>
<div data-language="rust"><pre><code><span>#[wasm_bindgen]</span>
<span>pub</span> <span>fn</span> <span>process_nodes</span><span>(</span>text<span>:</span> <span>String</span><span>)</span> <span>-&gt;</span> <span>js_sys<span>::</span></span><span>Array</span> <span>{</span>
    <span>// Parses the string into the OSM data structure.</span>
    <span>let</span> doc <span>=</span> <span>osm<span>::</span></span><span>OSM</span><span>::</span><span>parse</span><span>(</span>text<span>.</span><span>as_bytes</span><span>(</span><span>)</span><span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span><span>;</span>
    <span>// Bounds are the min and max latitudes and longitudes of the map.</span>
    <span>let</span> bounds <span>=</span> doc<span>.</span>bounds<span>.</span><span>unwrap</span><span>(</span><span>)</span><span>;</span>
    <span>// New JS array that will be returned.</span>
    <span>let</span> arr <span>=</span> <span>js_sys<span>::</span></span><span>Array</span><span>::</span><span>new</span><span>(</span><span>)</span><span>;</span>
    <span>// Iterate over the nodes found in the document.</span>
    <span>// Each node should be the location of a tree.</span>
    <span>for</span> <span>(</span>_id<span>,</span> node<span>)</span> <span>in</span> doc<span>.</span>nodes<span>.</span><span>iter</span><span>(</span><span>)</span> <span>{</span>
        <span>// The nodes will be processed and pushed to the JS array,</span>
        <span>// but for now, just logging out the data.</span>
        <span>log</span><span>(</span><span>&amp;</span><span>format!</span><span>(</span><span>&#34;{} {}&#34;</span><span>)</span><span>,</span> node<span>.</span>lat<span>,</span> node<span>.</span>lon<span>)</span><span>;</span>
    <span>}</span>
    arr
<span>}</span></code></pre></div>
<p>Now I have to call this function from JavaScript. I&#39;ll create a <code>getTrees</code> function that fetches data from the trees endpoint, then call the WASM <code>process_nodes</code> function.</p>
<div data-language="javascript"><pre><code><span>// First, update the import at the top of the script.</span>
<span>import</span> init<span>,</span> <span>{</span>process_nodes<span>}</span> <span>from</span> <span>&#39;./process-maps/pkg/process_maps.js&#39;</span><span>;</span>

<span>// Add getTrees to the bottom of the script.</span>
<span>function</span> <span>getTrees</span><span>(</span><span>url</span><span>)</span> <span>{</span>
  <span>fetch</span><span>(</span><span><span>`</span><span><span>${</span>url<span>}</span></span><span><span>${</span>trees<span>}</span></span><span>;out;</span><span>`</span></span><span>)</span><span>.</span><span>then</span><span>(</span><span>response</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> response<span>.</span><span>text</span><span>(</span><span>)</span><span>;</span>
  <span>}</span><span>)</span><span>.</span><span>then</span><span>(</span><span>data</span> <span>=&gt;</span> <span>{</span>
    <span>process_nodes</span><span>(</span>data<span>,</span> width<span>,</span> height<span>)</span><span>;</span>
  <span>}</span><span>)</span><span>;</span>
<span>}</span>
<span>getTrees</span><span>(</span>url<span>)</span><span>;</span></code></pre></div>
<p>After rebuilding the WASM code and refreshing the page, I see lists of coordinates in my developer console.</p>
<p><span>
      <a href="https://mary.codes/static/495151358d9754ac05bb54053c57a728/3c503/node-coords.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/495151358d9754ac05bb54053c57a728/f51c2/node-coords.webp 148w,
/static/495151358d9754ac05bb54053c57a728/66888/node-coords.webp 295w,
/static/495151358d9754ac05bb54053c57a728/bc8a3/node-coords.webp 590w,
/static/495151358d9754ac05bb54053c57a728/fac04/node-coords.webp 677w" sizes="(max-width: 590px) 100vw, 590px" type="image/webp"/>
          <source srcset="/static/495151358d9754ac05bb54053c57a728/c5084/node-coords.png 148w,
/static/495151358d9754ac05bb54053c57a728/60cc9/node-coords.png 295w,
/static/495151358d9754ac05bb54053c57a728/6d370/node-coords.png 590w,
/static/495151358d9754ac05bb54053c57a728/3c503/node-coords.png 677w" sizes="(max-width: 590px) 100vw, 590px" type="image/png"/>
          <img src="https://mary.codes/static/495151358d9754ac05bb54053c57a728/6d370/node-coords.png" alt="Node coordinates" title="" loading="lazy" decoding="async"/>
        </picture>
  </a>
    </span></p>
<p>I can&#39;t just use raw coordinates to draw to a canvas, however. I need to convert the geographical coordinates to xy coordinates that will map to the size of my canvas.</p>
<p>First, I need a function that will take a single coordinate value and map it to the range of 0 to the width or height of the canvas.</p>
<div data-language="rust"><pre><code><span>// start1 and stop1 are the min and max map bounds that were unwrapped earlier.</span>
<span>// start2 and stop2 are the min and max values of the canvas.</span>
<span>fn</span> <span>map_points</span><span>(</span>value<span>:</span> <span>f64</span><span>,</span> start1<span>:</span> <span>f64</span><span>,</span> stop1<span>:</span> <span>f64</span><span>,</span> start2<span>:</span> <span>f64</span><span>,</span> stop2<span>:</span> <span>f64</span><span>)</span> <span>-&gt;</span> <span>f64</span> <span>{</span>
    <span>(</span><span>(</span>value <span>-</span> start1<span>)</span> <span>/</span> <span>(</span>stop1 <span>-</span> start1<span>)</span> <span>*</span> <span>(</span>stop2 <span>-</span> start2<span>)</span> <span>+</span> start2<span>)</span><span>.</span><span>floor</span><span>(</span><span>)</span>
<span>}</span></code></pre></div>
<p>Next, I need to create the x and y coordinates and wrap them in an array for export to my JavaScript.</p>
<div data-language="rust"><pre><code><span>fn</span> <span>process_points</span><span>(</span>node<span>:</span> <span>&amp;</span><span>osm<span>::</span></span><span>Node</span><span>,</span> bounds<span>:</span> <span>&amp;</span><span>osm<span>::</span></span><span>Bounds</span><span>,</span> width<span>:</span> <span>f64</span><span>,</span> height<span>:</span> <span>f64</span><span>)</span> <span>-&gt;</span> <span>js_sys<span>::</span></span><span>Array</span> <span>{</span>
    <span>let</span> y <span>=</span> <span>map_points</span><span>(</span>node<span>.</span>lat<span>,</span> bounds<span>.</span>minlat<span>,</span> bounds<span>.</span>maxlat<span>,</span> <span>0.0</span><span>,</span> width<span>)</span><span>;</span>
    <span>let</span> x <span>=</span> <span>map_points</span><span>(</span>node<span>.</span>lon<span>,</span> bounds<span>.</span>minlon<span>,</span> bounds<span>.</span>maxlon<span>,</span> <span>0.0</span><span>,</span> height<span>)</span><span>;</span>
    <span>let</span> point <span>=</span> <span>js_sys<span>::</span></span><span>Array</span><span>::</span><span>new</span><span>(</span><span>)</span><span>;</span>
    <span>// Numbers being sent to JavaScript must be transformed into a JsValue.</span>
    point<span>.</span><span>push</span><span>(</span><span>&amp;</span><span>JsValue</span><span>::</span><span>from_f64</span><span>(</span>x<span>)</span><span>)</span><span>;</span>
    point<span>.</span><span>push</span><span>(</span><span>&amp;</span><span>JsValue</span><span>::</span><span>from_f64</span><span>(</span>y<span>)</span><span>)</span><span>;</span>
    point
<span>}</span></code></pre></div>
<p>Finally, I can add a call to <code>process_points</code> from my <code>process_nodes</code> function.</p>
<div data-language="rust"><pre><code><span>#[wasm_bindgen]</span>
<span>pub</span> <span>fn</span> <span>process_nodes</span><span>(</span>text<span>:</span> <span>String</span><span>,</span> width<span>:</span> <span>f64</span><span>,</span> height<span>:</span> <span>f64</span><span>)</span> <span>-&gt;</span> <span>js_sys<span>::</span></span><span>Array</span> <span>{</span>
    <span>let</span> doc <span>=</span> <span>osm<span>::</span></span><span>OSM</span><span>::</span><span>parse</span><span>(</span>text<span>.</span><span>as_bytes</span><span>(</span><span>)</span><span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span><span>;</span>
    <span>let</span> bounds <span>=</span> doc<span>.</span>bounds<span>.</span><span>unwrap</span><span>(</span><span>)</span><span>;</span>
    <span>let</span> arr <span>=</span> <span>js_sys<span>::</span></span><span>Array</span><span>::</span><span>new</span><span>(</span><span>)</span><span>;</span>
    <span>for</span> <span>(</span>_id<span>,</span> node<span>)</span> <span>in</span> doc<span>.</span>nodes<span>.</span><span>iter</span><span>(</span><span>)</span> <span>{</span>
        arr<span>.</span><span>push</span><span>(</span><span>&amp;</span><span>process_points</span><span>(</span>node<span>,</span> <span>&amp;</span>bounds<span>,</span> width<span>,</span> height<span>)</span><span>)</span><span>;</span>
    <span>}</span>
    arr
<span>}</span></code></pre></div>
<p>Now, calling this function from my JavaScript file should return an array of points. Since I&#39;m actually returning an array, I can stop calling log from the Rust script, and I can call console.log from JavaScript.</p>
<div data-language="javascript"><pre><code><span>function</span> <span>getTrees</span><span>(</span><span>url</span><span>)</span> <span>{</span>
  <span>fetch</span><span>(</span><span><span>`</span><span><span>${</span>url<span>}</span></span><span><span>${</span>trees<span>}</span></span><span>;out;</span><span>`</span></span><span>)</span><span>.</span><span>then</span><span>(</span><span>response</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> response<span>.</span><span>text</span><span>(</span><span>)</span><span>;</span>
  <span>}</span><span>)</span><span>.</span><span>then</span><span>(</span><span>data</span> <span>=&gt;</span> <span>{</span>
    <span>let</span> p <span>=</span> <span>process_nodes</span><span>(</span>data<span>,</span> width<span>,</span> height<span>)</span><span>;</span>
    console<span>.</span><span>log</span><span>(</span>p<span>)</span><span>;</span>
  <span>}</span><span>)</span><span>;</span>
<span>}</span>
<span>getTrees</span><span>(</span>url<span>)</span><span>;</span></code></pre></div>
<p>This returns a large array of arrays with length 2. Each point corresponds to a point on the canvas.</p>
<p><span>
      <a href="https://mary.codes/static/e79d16342937af5a2bb7c01663886b05/64252/array-of-points.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/e79d16342937af5a2bb7c01663886b05/f51c2/array-of-points.webp 148w,
/static/e79d16342937af5a2bb7c01663886b05/66888/array-of-points.webp 295w,
/static/e79d16342937af5a2bb7c01663886b05/bc8a3/array-of-points.webp 590w,
/static/e79d16342937af5a2bb7c01663886b05/9d172/array-of-points.webp 696w" sizes="(max-width: 590px) 100vw, 590px" type="image/webp"/>
          <source srcset="/static/e79d16342937af5a2bb7c01663886b05/c5084/array-of-points.png 148w,
/static/e79d16342937af5a2bb7c01663886b05/60cc9/array-of-points.png 295w,
/static/e79d16342937af5a2bb7c01663886b05/6d370/array-of-points.png 590w,
/static/e79d16342937af5a2bb7c01663886b05/64252/array-of-points.png 696w" sizes="(max-width: 590px) 100vw, 590px" type="image/png"/>
          <img src="https://mary.codes/static/e79d16342937af5a2bb7c01663886b05/6d370/array-of-points.png" alt="Array of points" title="" loading="lazy" decoding="async"/>
        </picture>
  </a>
    </span></p>
<h3 id="drawing-on-the-canvas"><a href="#drawing-on-the-canvas" aria-label="drawing on the canvas permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Drawing on the canvas</h3>
<p>Now that there are point coordinates, they can be drawn to the canvas itself. First, I need to prepare the canvas for drawing.</p>
<div data-language="javascript"><pre><code><span>let</span> canvas <span>=</span> document<span>.</span><span>getElementById</span><span>(</span><span>&#39;canvas&#39;</span><span>)</span><span>;</span>
<span>let</span> ratio <span>=</span> <span>(</span>Math<span>.</span><span>abs</span><span>(</span>w<span>)</span> <span>-</span> Math<span>.</span><span>abs</span><span>(</span>e<span>)</span><span>)</span> <span>/</span> <span>(</span>n <span>-</span> s<span>)</span><span>;</span>
<span>let</span> width <span>=</span> <span>1800</span><span>;</span>
<span>let</span> height <span>=</span> width <span>*</span> ratio<span>;</span>
canvas<span>.</span>width <span>=</span> height<span>;</span>
canvas<span>.</span>height <span>=</span> width<span>;</span>

<span>let</span> ctx <span>=</span> canvas<span>.</span><span>getContext</span><span>(</span><span>&#39;2d&#39;</span><span>)</span><span>;</span>
ctx<span>.</span><span>translate</span><span>(</span><span>0</span><span>,</span> width<span>)</span><span>;</span>
ctx<span>.</span><span>scale</span><span>(</span><span>1</span><span>,</span> <span>-</span><span>1</span><span>)</span><span>;</span>
ctx<span>.</span>fillStyle <span>=</span> <span>&#39;#ffffff&#39;</span><span>;</span>
ctx<span>.</span><span>fillRect</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> height<span>,</span> width<span>)</span><span>;</span></code></pre></div>
<p>I had to do some rotating and flipping of the canvas to get the map to draw in the correct direction. Perhaps this is a problem with my coordinate mapping, or some other issue, but this seems to fix it. Next, I have to get the processed tree coordinates, and once those are available, draw the trees to the canvas.</p>
<div data-language="javascript"><pre><code><span>const</span> tree_data <span>=</span> <span>getTrees</span><span>(</span>url<span>)</span><span>;</span> <span>// Returns the processed coordinates.</span>

<span>// Waits for all functions to resolve.</span>
<span>// Right now, it&#39;s just the getTrees function.</span>
Promise<span>.</span><span>all</span><span>(</span><span>[</span>tree_data<span>]</span><span>)</span><span>.</span><span>then</span><span>(</span><span>values</span> <span>=&gt;</span> <span>{</span>
  <span>const</span> <span>[</span>trees<span>]</span> <span>=</span> values<span>;</span>
  <span>for</span> <span>(</span><span>let</span> tree <span>of</span> trees<span>)</span> <span>{</span>
    ctx<span>.</span><span>beginPath</span><span>(</span><span>)</span><span>;</span>
    ctx<span>.</span><span>arc</span><span>(</span>tree<span>[</span><span>0</span><span>]</span><span>,</span> tree<span>[</span><span>1</span><span>]</span><span>,</span> <span>3</span><span>,</span> <span>0</span><span>,</span> <span>2</span> <span>*</span> Math<span>.</span><span>PI</span><span>)</span><span>;</span>
    ctx<span>.</span>fillStyle <span>=</span> <span>&#39;rgb(40,107,83)&#39;</span><span>;</span>
    ctx<span>.</span><span>fill</span><span>(</span><span>)</span><span>;</span>
    ctx<span>.</span><span>closePath</span><span>(</span><span>)</span><span>;</span>
  <span>}</span>
<span>}</span><span>)</span><span>;</span>

<span>// Updated this function to return the fetched and processed data.</span>
<span>function</span> <span>getTrees</span><span>(</span><span>url</span><span>)</span> <span>{</span>
  <span>return</span> <span>fetch</span><span>(</span><span><span>`</span><span><span>${</span>url<span>}</span></span><span><span>${</span>trees<span>}</span></span><span>;out;</span><span>`</span></span><span>)</span><span>.</span><span>then</span><span>(</span><span>response</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> response<span>.</span><span>text</span><span>(</span><span>)</span><span>;</span>
  <span>}</span><span>)</span><span>.</span><span>then</span><span>(</span><span>data</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> <span>process_nodes</span><span>(</span>data<span>,</span> width<span>,</span> height<span>)</span><span>;</span>
  <span>}</span><span>)</span><span>;</span>
<span>}</span></code></pre></div>
<p>All the trees should now be drawn to the canvas.</p>
<p><span>
      <a href="https://mary.codes/static/914742682bb55a5f120d64540a05b7ae/065ce/mk_canvas_trees.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/914742682bb55a5f120d64540a05b7ae/f51c2/mk_canvas_trees.webp 148w,
/static/914742682bb55a5f120d64540a05b7ae/66888/mk_canvas_trees.webp 295w,
/static/914742682bb55a5f120d64540a05b7ae/bc8a3/mk_canvas_trees.webp 590w,
/static/914742682bb55a5f120d64540a05b7ae/4ce34/mk_canvas_trees.webp 885w,
/static/914742682bb55a5f120d64540a05b7ae/f490a/mk_canvas_trees.webp 1180w,
/static/914742682bb55a5f120d64540a05b7ae/f93c5/mk_canvas_trees.webp 2680w" sizes="(max-width: 590px) 100vw, 590px" type="image/webp"/>
          <source srcset="/static/914742682bb55a5f120d64540a05b7ae/c5084/mk_canvas_trees.png 148w,
/static/914742682bb55a5f120d64540a05b7ae/60cc9/mk_canvas_trees.png 295w,
/static/914742682bb55a5f120d64540a05b7ae/6d370/mk_canvas_trees.png 590w,
/static/914742682bb55a5f120d64540a05b7ae/540ae/mk_canvas_trees.png 885w,
/static/914742682bb55a5f120d64540a05b7ae/2561a/mk_canvas_trees.png 1180w,
/static/914742682bb55a5f120d64540a05b7ae/065ce/mk_canvas_trees.png 2680w" sizes="(max-width: 590px) 100vw, 590px" type="image/png"/>
          <img src="https://mary.codes/static/914742682bb55a5f120d64540a05b7ae/6d370/mk_canvas_trees.png" alt="Trees only" title="" loading="lazy" decoding="async"/>
        </picture>
  </a>
    </span></p>
<h3 id="processing-ways-and-relations"><a href="#processing-ways-and-relations" aria-label="processing ways and relations permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Processing ways and relations</h3>
<p>To draw any other items to the map, I need to add the ability to process OpenStreetMap ways and relations to my Rust code. This is my initial code to extract ways from the OSM data. It&#39;s nearly identical to the <code>process_nodes</code> function, but I&#39;ll need to add another processing step.</p>
<div data-language="rust"><pre><code><span>#[wasm_bindgen]</span>
<span>pub</span> <span>fn</span> <span>process_ways</span><span>(</span>text<span>:</span> <span>String</span><span>,</span> width<span>:</span> <span>f64</span><span>,</span> height<span>:</span> <span>f64</span><span>)</span> <span>-&gt;</span> <span>js_sys<span>::</span></span><span>Array</span> <span>{</span>
    <span>let</span> doc <span>=</span> <span>osm<span>::</span></span><span>OSM</span><span>::</span><span>parse</span><span>(</span>text<span>.</span><span>as_bytes</span><span>(</span><span>)</span><span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span><span>;</span>
    <span>let</span> bounds <span>=</span> doc<span>.</span>bounds<span>.</span><span>unwrap</span><span>(</span><span>)</span><span>;</span>
    <span>let</span> arr <span>=</span> <span>js_sys<span>::</span></span><span>Array</span><span>::</span><span>new</span><span>(</span><span>)</span><span>;</span>
    <span>for</span> <span>(</span>_id<span>,</span> way<span>)</span> <span>in</span> doc<span>.</span>ways<span>.</span><span>iter</span><span>(</span><span>)</span> <span>{</span>
        <span>log</span><span>(</span><span>&amp;</span><span>format!</span><span>(</span><span>&#34;{:?}&#34;</span><span>,</span> way<span>)</span><span>)</span><span>;</span>
    <span>}</span>
    arr
<span>}</span></code></pre></div>
<p>Then, I import this function into my JavaScript code and call it.</p>
<div data-language="javascript"><pre><code><span>import</span> init<span>,</span> <span>{</span>process_nodes<span>,</span> process_ways<span>}</span> <span>from</span> <span>&#39;./process-maps/pkg/process_maps.js&#39;</span><span>;</span>

<span>const</span> walkway_data <span>=</span> <span>getWalkways</span><span>(</span>url<span>)</span><span>;</span>

<span>function</span> <span>getWalkways</span><span>(</span><span>url</span><span>)</span> <span>{</span>
  <span>return</span> <span>fetch</span><span>(</span><span><span>`</span><span><span>${</span>url<span>}</span></span><span><span>${</span>walkways<span>}</span></span><span>;out;</span><span>`</span></span><span>)</span><span>.</span><span>then</span><span>(</span><span>response</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> response<span>.</span><span>text</span><span>(</span><span>)</span><span>;</span>
  <span>}</span><span>)</span><span>.</span><span>then</span><span>(</span><span>data</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> <span>process_ways</span><span>(</span>data<span>,</span> width<span>,</span> height<span>)</span><span>;</span>
  <span>}</span><span>)</span><span>;</span>
<span>}</span></code></pre></div>
<p>Logging this out will return a &#34;Way&#34; object, which contains multiple nodes.</p>
<p><span>
      <a href="https://mary.codes/static/cab41503abf960d703b402af6016c1bd/11d18/ways-data.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/cab41503abf960d703b402af6016c1bd/f51c2/ways-data.webp 148w,
/static/cab41503abf960d703b402af6016c1bd/66888/ways-data.webp 295w,
/static/cab41503abf960d703b402af6016c1bd/7f45e/ways-data.webp 559w" sizes="(max-width: 559px) 100vw, 559px" type="image/webp"/>
          <source srcset="/static/cab41503abf960d703b402af6016c1bd/c5084/ways-data.png 148w,
/static/cab41503abf960d703b402af6016c1bd/60cc9/ways-data.png 295w,
/static/cab41503abf960d703b402af6016c1bd/11d18/ways-data.png 559w" sizes="(max-width: 559px) 100vw, 559px" type="image/png"/>
          <img src="https://mary.codes/static/cab41503abf960d703b402af6016c1bd/11d18/ways-data.png" alt="Walkway data" title="" loading="lazy" decoding="async"/>
        </picture>
  </a>
    </span></p>
<p>Now, I need to write an additional function that will process each of the nodes in the way and create canvas coordinates.</p>
<div data-language="rust"><pre><code><span>fn</span> <span>process_coords</span><span>(</span>doc<span>:</span> <span>&amp;</span><span>osm<span>::</span></span><span>OSM</span><span>,</span> way<span>:</span> <span>&amp;</span><span>osm<span>::</span></span><span>Way</span><span>,</span> bounds<span>:</span> <span>&amp;</span><span>osm<span>::</span></span><span>Bounds</span><span>,</span> width<span>:</span> <span>f64</span><span>,</span> height<span>:</span> <span>f64</span><span>)</span> <span>-&gt;</span> <span>js_sys<span>::</span></span><span>Array</span> <span>{</span>
    <span>// Create an empty array to return the coordinates.</span>
    <span>let</span> coords <span>=</span> <span>js_sys<span>::</span></span><span>Array</span><span>::</span><span>new</span><span>(</span><span>)</span><span>;</span>
    <span>// Iterate over each of the nodes in the way.</span>
    <span>for</span> node <span>in</span> way<span>.</span>nodes<span>.</span><span>iter</span><span>(</span><span>)</span> <span>{</span>
        <span>// Finds the node by its ID number.</span>
        <span>let</span> n <span>=</span> <span>&amp;</span>doc<span>.</span><span>resolve_reference</span><span>(</span><span>&amp;</span>node<span>)</span><span>;</span>
        <span>// Matches the node by reference and then generates coordinates.</span>
        <span>match</span> n <span>{</span>
            <span>osm<span>::</span></span><span>Reference</span><span>::</span><span>Node</span><span>(</span>node<span>)</span> <span>=&gt;</span> <span>{</span>
                <span>let</span> point <span>=</span> <span>process_points</span><span>(</span>node<span>,</span> <span>&amp;</span>bounds<span>,</span> width<span>,</span> height<span>)</span><span>;</span>
                coords<span>.</span><span>push</span><span>(</span><span>&amp;</span>point<span>)</span><span>;</span>
            <span>}</span><span>,</span>
            _ <span>=&gt;</span> <span>{</span><span>}</span>
        <span>}</span>
    <span>}</span>
    coords
<span>}</span></code></pre></div>
<p>I need to call this function from <code>process_ways</code>.</p>
<div data-language="rust"><pre><code><span>#[wasm_bindgen]</span>
<span>pub</span> <span>fn</span> <span>process_ways</span><span>(</span>text<span>:</span> <span>String</span><span>,</span> width<span>:</span> <span>f64</span><span>,</span> height<span>:</span> <span>f64</span><span>)</span> <span>-&gt;</span> <span>js_sys<span>::</span></span><span>Array</span> <span>{</span>
    <span>let</span> doc <span>=</span> <span>osm<span>::</span></span><span>OSM</span><span>::</span><span>parse</span><span>(</span>text<span>.</span><span>as_bytes</span><span>(</span><span>)</span><span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span><span>;</span>
    <span>let</span> bounds <span>=</span> doc<span>.</span>bounds<span>.</span><span>unwrap</span><span>(</span><span>)</span><span>;</span>
    <span>let</span> arr <span>=</span> <span>js_sys<span>::</span></span><span>Array</span><span>::</span><span>new</span><span>(</span><span>)</span><span>;</span>
    <span>for</span> <span>(</span>_id<span>,</span> way<span>)</span> <span>in</span> doc<span>.</span>ways<span>.</span><span>iter</span><span>(</span><span>)</span> <span>{</span>
        arr<span>.</span><span>push</span><span>(</span><span>&amp;</span><span>process_coords</span><span>(</span><span>&amp;</span>doc<span>,</span> way<span>,</span> <span>&amp;</span>bounds<span>,</span> width<span>,</span> height<span>)</span><span>)</span><span>;</span>
    <span>}</span>
    arr
<span>}</span></code></pre></div>
<p>Logging the result out from JavaScript will return an array of all the walkways, broken down into coordinate pairs.</p>
<p><span>
      <a href="https://mary.codes/static/eeb63e642e6436466f0c9e157126d9ad/98c96/array-of-ways.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/eeb63e642e6436466f0c9e157126d9ad/f51c2/array-of-ways.webp 148w,
/static/eeb63e642e6436466f0c9e157126d9ad/66888/array-of-ways.webp 295w,
/static/eeb63e642e6436466f0c9e157126d9ad/fac4c/array-of-ways.webp 555w" sizes="(max-width: 555px) 100vw, 555px" type="image/webp"/>
          <source srcset="/static/eeb63e642e6436466f0c9e157126d9ad/c5084/array-of-ways.png 148w,
/static/eeb63e642e6436466f0c9e157126d9ad/60cc9/array-of-ways.png 295w,
/static/eeb63e642e6436466f0c9e157126d9ad/98c96/array-of-ways.png 555w" sizes="(max-width: 555px) 100vw, 555px" type="image/png"/>
          <img src="https://mary.codes/static/eeb63e642e6436466f0c9e157126d9ad/98c96/array-of-ways.png" alt="Array of ways" title="" loading="lazy" decoding="async"/>
        </picture>
  </a>
    </span></p>
<p>Processing the relations (waterways, in the case of this map) requires a further breakdown step. Relations need to be mapped to ways, which are then mapped to nodes. When I process the ways, I&#39;m only going to push the coordinates for the &#34;outer&#34; way to my array. The &#34;inner&#34; ways are cutout areas of the larger polygon. For my purposes, I&#39;m going to draw the water first, then the land and everything else, so I really don&#39;t need to worry about the inner polygons. This cuts down on extra processing and drawing time.</p>
<div data-language="rust"><pre><code><span>#[wasm_bindgen]</span>
<span>pub</span> <span>fn</span> <span>process_relations</span><span>(</span>text<span>:</span> <span>String</span><span>,</span> width<span>:</span> <span>f64</span><span>,</span> height<span>:</span> <span>f64</span><span>)</span> <span>-&gt;</span> <span>js_sys<span>::</span></span><span>Array</span> <span>{</span>
    <span>let</span> doc <span>=</span> <span>osm<span>::</span></span><span>OSM</span><span>::</span><span>parse</span><span>(</span>text<span>.</span><span>as_bytes</span><span>(</span><span>)</span><span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span><span>;</span>
    <span>let</span> bounds <span>=</span> doc<span>.</span>bounds<span>.</span><span>unwrap</span><span>(</span><span>)</span><span>;</span>
    <span>let</span> arr <span>=</span> <span>js_sys<span>::</span></span><span>Array</span><span>::</span><span>new</span><span>(</span><span>)</span><span>;</span>
    <span>for</span> <span>(</span>_id<span>,</span> relation<span>)</span> <span>in</span> doc<span>.</span>relations<span>.</span><span>iter</span><span>(</span><span>)</span> <span>{</span>
        <span>for</span> member <span>in</span> relation<span>.</span>members<span>.</span><span>iter</span><span>(</span><span>)</span> <span>{</span>
            <span>match</span> member <span>{</span>
                <span>// Matching ways within the relation.</span>
                <span>osm<span>::</span></span><span>Member</span><span>::</span><span>Way</span><span>(</span>way<span>,</span> t<span>)</span> <span>=&gt;</span> <span>{</span>
                    <span>let</span> w <span>=</span> <span>&amp;</span>doc<span>.</span><span>resolve_reference</span><span>(</span><span>&amp;</span>way<span>)</span><span>;</span>
                    <span>match</span> w <span>{</span>
                        <span>osm<span>::</span></span><span>Reference</span><span>::</span><span>Way</span><span>(</span>way<span>)</span> <span>=&gt;</span> <span>{</span>
                            <span>// Only processing coordinates for the &#34;outer&#34; way.</span>
                            <span>if</span> t <span>==</span> <span>&#34;outer&#34;</span> <span>{</span>
                                arr<span>.</span><span>push</span><span>(</span><span>&amp;</span><span>process_coords</span><span>(</span><span>&amp;</span>doc<span>,</span> way<span>,</span> <span>&amp;</span>bounds<span>,</span> width<span>,</span> height<span>)</span><span>)</span><span>;</span>
                            <span>}</span>
                        <span>}</span><span>,</span>
                        _ <span>=&gt;</span> <span>{</span><span>}</span>
                    <span>}</span>
                <span>}</span><span>,</span>
                _ <span>=&gt;</span> <span>{</span><span>}</span>
            <span>}</span>
        <span>}</span>
    <span>}</span>
    arr
<span>}</span></code></pre></div>
<h3 id="drawing-all-of-the-other-map-areas"><a href="#drawing-all-of-the-other-map-areas" aria-label="drawing all of the other map areas permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Drawing all of the other map areas</h3>
<p>Since the rest of the map is constructed with filled polygons, I created a function to draw each polygon for the various map types. Each type of map item will have a different color, and walkways will only have a stroke and no fill.</p>
<p>Below is all the code that fetches the OSM data for each landmark, calls the WASM functions to process the data, then draws the coordinates to the canvas. I&#39;ve left out the Overpass API code, which can be referenced above at <a href="#calling-the-overpass-api">calling the Overpass API</a>.</p>
<div data-language="javascript"><pre><code><span>const</span> url <span>=</span> <span><span>`</span><span>https://overpass-api.de/api/interpreter?data=</span><span><span>${</span>query<span>}</span></span><span>`</span></span><span>;</span>
<span>const</span> water_data <span>=</span> <span>getWater</span><span>(</span>url<span>)</span><span>;</span>
<span>const</span> garden_data <span>=</span> <span>getGardens</span><span>(</span>url<span>)</span><span>;</span>
<span>const</span> walkway_data <span>=</span> <span>getWalkways</span><span>(</span>url<span>)</span><span>;</span>
<span>const</span> tree_data <span>=</span> <span>getTrees</span><span>(</span>url<span>)</span><span>;</span>
<span>const</span> building_data <span>=</span> <span>getBuildings</span><span>(</span>url<span>)</span><span>;</span>
<span>const</span> nbuilding_data <span>=</span> <span>getNamedBuildings</span><span>(</span>url<span>)</span><span>;</span>

Promise<span>.</span><span>all</span><span>(</span><span>[</span>water_data<span>,</span> garden_data<span>,</span> walkway_data<span>,</span> tree_data<span>,</span> building_data<span>,</span> nbuilding_data<span>]</span><span>)</span><span>.</span><span>then</span><span>(</span><span>values</span> <span>=&gt;</span> <span>{</span>
  <span>const</span> <span>[</span>water<span>,</span> gardens<span>,</span> walkways<span>,</span> trees<span>,</span> buildings<span>,</span> named_buildings<span>]</span> <span>=</span> values<span>;</span>
  <span>drawPolygons</span><span>(</span>water<span>,</span> <span>&#39;rgb(83,156,156)&#39;</span><span>,</span> <span>null</span><span>)</span><span>;</span>
  <span>drawPolygons</span><span>(</span>gardens<span>,</span> <span>&#39;rgb(136,172,140)&#39;</span><span>,</span> <span>null</span><span>)</span><span>;</span>
  <span>drawPolygons</span><span>(</span>walkways<span>,</span> <span>null</span><span>,</span> <span>&#39;rgb(0,0,0)&#39;</span><span>)</span><span>;</span>
  <span>for</span> <span>(</span><span>let</span> tree <span>of</span> trees<span>)</span> <span>{</span>
    ctx<span>.</span><span>beginPath</span><span>(</span><span>)</span><span>;</span>
    ctx<span>.</span><span>arc</span><span>(</span>tree<span>[</span><span>0</span><span>]</span><span>,</span> tree<span>[</span><span>1</span><span>]</span><span>,</span> <span>3</span><span>,</span> <span>0</span><span>,</span> <span>2</span> <span>*</span> Math<span>.</span><span>PI</span><span>)</span><span>;</span>
    ctx<span>.</span>fillStyle <span>=</span> <span>&#39;rgb(40,107,83)&#39;</span><span>;</span>
    ctx<span>.</span><span>fill</span><span>(</span><span>)</span><span>;</span>
    ctx<span>.</span><span>closePath</span><span>(</span><span>)</span><span>;</span>
  <span>}</span>
  <span>drawPolygons</span><span>(</span>buildings<span>,</span> <span>&#39;rgb(98,90,87)&#39;</span><span>,</span> <span>null</span><span>)</span><span>;</span>
  <span>drawPolygons</span><span>(</span>named_buildings<span>,</span> <span>&#39;rgb(220,177,102)&#39;</span><span>,</span> <span>null</span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span>

<span>function</span> <span>drawPolygons</span><span>(</span><span>p<span>,</span> fill<span>,</span> stroke</span><span>)</span> <span>{</span>
  <span>for</span> <span>(</span><span>let</span> polygon <span>of</span> p<span>)</span> <span>{</span>
    ctx<span>.</span><span>beginPath</span><span>(</span><span>)</span><span>;</span>
    <span>for</span> <span>(</span><span>let</span> point <span>of</span> polygon<span>)</span> <span>{</span>
      ctx<span>.</span><span>lineTo</span><span>(</span>point<span>[</span><span>0</span><span>]</span><span>,</span> point<span>[</span><span>1</span><span>]</span><span>)</span><span>;</span>
    <span>}</span>
    <span>if</span> <span>(</span>fill<span>)</span> <span>{</span>
      ctx<span>.</span>fillStyle <span>=</span> fill<span>;</span>
      ctx<span>.</span><span>fill</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
    <span>if</span> <span>(</span>stroke<span>)</span> <span>{</span>
      ctx<span>.</span>strokeStyle <span>=</span> stroke<span>;</span>
      ctx<span>.</span><span>stroke</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
    ctx<span>.</span><span>closePath</span><span>(</span><span>)</span><span>;</span>
  <span>}</span>
<span>}</span>

<span>function</span> <span>getWater</span><span>(</span><span>url</span><span>)</span> <span>{</span>
  <span>return</span> <span>fetch</span><span>(</span><span><span>`</span><span><span>${</span>url<span>}</span></span><span><span>${</span>water<span>}</span></span><span>;out;</span><span>`</span></span><span>)</span><span>.</span><span>then</span><span>(</span><span>response</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> response<span>.</span><span>text</span><span>(</span><span>)</span><span>;</span>
  <span>}</span><span>)</span><span>.</span><span>then</span><span>(</span><span>data</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> <span>process_relations</span><span>(</span>data<span>,</span> width<span>,</span> height<span>)</span><span>;</span>
  <span>}</span><span>)</span><span>;</span>
<span>}</span>

<span>function</span> <span>getWalkways</span><span>(</span><span>url</span><span>)</span> <span>{</span>
  <span>return</span> <span>fetch</span><span>(</span><span><span>`</span><span><span>${</span>url<span>}</span></span><span><span>${</span>walkways<span>}</span></span><span>;out;</span><span>`</span></span><span>)</span><span>.</span><span>then</span><span>(</span><span>response</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> response<span>.</span><span>text</span><span>(</span><span>)</span><span>;</span>
  <span>}</span><span>)</span><span>.</span><span>then</span><span>(</span><span>data</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> <span>process_ways</span><span>(</span>data<span>,</span> width<span>,</span> height<span>)</span><span>;</span>
  <span>}</span><span>)</span><span>;</span>
<span>}</span>

<span>function</span> <span>getBuildings</span><span>(</span><span>url</span><span>)</span> <span>{</span>
  <span>return</span> <span>fetch</span><span>(</span><span><span>`</span><span><span>${</span>url<span>}</span></span><span><span>${</span>buildings<span>}</span></span><span>;out;</span><span>`</span></span><span>)</span><span>.</span><span>then</span><span>(</span><span>response</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> response<span>.</span><span>text</span><span>(</span><span>)</span><span>;</span>
  <span>}</span><span>)</span><span>.</span><span>then</span><span>(</span><span>data</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> <span>process_ways</span><span>(</span>data<span>,</span> width<span>,</span> height<span>)</span><span>;</span>
  <span>}</span><span>)</span><span>;</span>
<span>}</span>

<span>function</span> <span>getNamedBuildings</span><span>(</span><span>url</span><span>)</span> <span>{</span>
  <span>return</span> <span>fetch</span><span>(</span><span><span>`</span><span><span>${</span>url<span>}</span></span><span><span>${</span>named_buildings<span>}</span></span><span>;out;</span><span>`</span></span><span>)</span><span>.</span><span>then</span><span>(</span><span>response</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> response<span>.</span><span>text</span><span>(</span><span>)</span><span>;</span>
  <span>}</span><span>)</span><span>.</span><span>then</span><span>(</span><span>data</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> <span>process_ways</span><span>(</span>data<span>,</span> width<span>,</span> height<span>)</span><span>;</span>
  <span>}</span><span>)</span><span>;</span>
<span>}</span>

<span>function</span> <span>getGardens</span><span>(</span><span>url</span><span>)</span> <span>{</span>
  <span>return</span> <span>fetch</span><span>(</span><span><span>`</span><span><span>${</span>url<span>}</span></span><span><span>${</span>gardens<span>}</span></span><span>;out;</span><span>`</span></span><span>)</span><span>.</span><span>then</span><span>(</span><span>response</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> response<span>.</span><span>text</span><span>(</span><span>)</span><span>;</span>
  <span>}</span><span>)</span><span>.</span><span>then</span><span>(</span><span>data</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> <span>process_ways</span><span>(</span>data<span>,</span> width<span>,</span> height<span>)</span><span>;</span>
  <span>}</span><span>)</span><span>;</span>
<span>}</span>

<span>function</span> <span>getTrees</span><span>(</span><span>url</span><span>)</span> <span>{</span>
  <span>return</span> <span>fetch</span><span>(</span><span><span>`</span><span><span>${</span>url<span>}</span></span><span><span>${</span>trees<span>}</span></span><span>;out;</span><span>`</span></span><span>)</span><span>.</span><span>then</span><span>(</span><span>response</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> response<span>.</span><span>text</span><span>(</span><span>)</span><span>;</span>
  <span>}</span><span>)</span><span>.</span><span>then</span><span>(</span><span>data</span> <span>=&gt;</span> <span>{</span>
    <span>return</span> <span>process_nodes</span><span>(</span>data<span>,</span> width<span>,</span> height<span>)</span><span>;</span>
  <span>}</span><span>)</span><span>;</span>
<span>}</span></code></pre></div>
<h3 id="the-finished-map"><a href="#the-finished-map" aria-label="the finished map permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The finished map</h3>
<p>I&#39;ve benchmarked the map&#39;s loading time, and it takes about 5.2 seconds on average when the Rust code is compiled in development mode, and about 2.3 seconds in production mode. In an earlier iteration I had each map endpoint individually queried, processed, and drawn before querying the next endpoint, which was much slower. Now, the map is at the mercy of the slowest query (around 2.1 seconds). A way to save more time would be to save the coordinates to a file instead of querying the API, but any changes wouldn&#39;t be reflected in the map.</p>
<p>Here&#39;s a finished screenshot of the Magic Kingdom&#39;s map.</p>
<p><span>
      <a href="https://mary.codes/static/994a26e9c7ff1d0d0155d52361d5a05f/065ce/mk_canvas_map.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/994a26e9c7ff1d0d0155d52361d5a05f/f51c2/mk_canvas_map.webp 148w,
/static/994a26e9c7ff1d0d0155d52361d5a05f/66888/mk_canvas_map.webp 295w,
/static/994a26e9c7ff1d0d0155d52361d5a05f/bc8a3/mk_canvas_map.webp 590w,
/static/994a26e9c7ff1d0d0155d52361d5a05f/4ce34/mk_canvas_map.webp 885w,
/static/994a26e9c7ff1d0d0155d52361d5a05f/f490a/mk_canvas_map.webp 1180w,
/static/994a26e9c7ff1d0d0155d52361d5a05f/f93c5/mk_canvas_map.webp 2680w" sizes="(max-width: 590px) 100vw, 590px" type="image/webp"/>
          <source srcset="/static/994a26e9c7ff1d0d0155d52361d5a05f/c5084/mk_canvas_map.png 148w,
/static/994a26e9c7ff1d0d0155d52361d5a05f/60cc9/mk_canvas_map.png 295w,
/static/994a26e9c7ff1d0d0155d52361d5a05f/6d370/mk_canvas_map.png 590w,
/static/994a26e9c7ff1d0d0155d52361d5a05f/540ae/mk_canvas_map.png 885w,
/static/994a26e9c7ff1d0d0155d52361d5a05f/2561a/mk_canvas_map.png 1180w,
/static/994a26e9c7ff1d0d0155d52361d5a05f/065ce/mk_canvas_map.png 2680w" sizes="(max-width: 590px) 100vw, 590px" type="image/png"/>
          <img src="https://mary.codes/static/994a26e9c7ff1d0d0155d52361d5a05f/6d370/mk_canvas_map.png" alt="Canvas map" title="" loading="lazy" decoding="async"/>
        </picture>
  </a>
    </span></p>
<p>I&#39;ve added a working demo <a href="https://mary.codes/demo-pages/linebuddy-2/">here</a>. If you want to check out other parks besides the Magic Kingdom, add the query strings &#34;?park=epcot&#34;, &#34;?park=hs&#34;, or &#34;?park=ak&#34; to the end of the URL.</p>
<p>This is part one of a much larger project, so while it feels a bit janky now, everything will be cleaned up in the future. The main goal here was to prove that it is possible to use Rust and WASM to process these coordinates to make my own maps.</p></div></div>
  </body>
</html>
