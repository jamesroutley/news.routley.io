<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://fasterthanli.me/articles/the-bottom-emoji-breaks-rust-analyzer">Original</a>
    <h1>The bottom emoji breaks rust-analyzer</h1>
    
    <div id="readability-page-1" class="page"><div>
  

  
    
      
    
  

  <p>Some bugs are merely fun. Others are simply delicious!</p>
<p>Today&#39;s pick is the latter.</p>

                        <h2>
                            <a id="reproducing-the-issue-part-1" href="#reproducing-the-issue-part-1">
                                Reproducing the issue, part 1
                            </a>
                        </h2>
                        
<p>(It may be tempting to skip that section, but reproducing an issue is an important
part of figuring it out, so.)</p>
<p>I&#39;ve never used Emacs before, so let&#39;s install it. I do most of my computing
on an era-appropriate Ubuntu, today it&#39;s Ubuntu 22.10, so I just need to:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ sudo apt install emacs-nox
</pre></div>
<p>And then create a new Rust crate, <code>cd</code> into it, and launch emacs:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ cargo new bottom
     Created binary (application) `bottom` package
$ cd bottom/
$ emacs
</pre></div>
<p>I am greeted with a terminal interface that says: &#34;Welcome to GNU Emacs, one
component of the GNU/Linux operating system&#34;. I feel
<a href="https://www.gnu.org/fun/jokes/gospel.html">religious</a> already.</p>
<p>To open <code>src/main.rs</code>, I can press <code>C-x C-f</code>, where <code>C-</code> means <code>Ctrl+</code> (and <code>M-</code>
means <code>Alt+</code>, at least for me), which opens a &#34;Find file&#34; prompt at the bottom,
pre-filled with the current working directory: for me that&#39;s <code>~/bearcove/bottom</code>.</p>
<p>There&#39;s tab-completion in there, so <code>s&lt;TAB&gt;m&lt;TAB&gt;</code> completes it to
<code>.../src/main.rs</code>, and pressing Enter (which I understand Emacs folks spell
<code>RET</code>, for Return) opens the file.</p>
<p>Without additional configuration, not much happens: there&#39;s no syntax
highlighting, no code intelligence of any kind, we have to ask for that.</p>
<p>So let&#39;s ask for that.</p>
<p>With guidance from a friend (on IRC, of all places! what year is this?), I ended
up putting the following in my <code>~/.emacs</code> file:</p>
<div translate="no"><p>Emacs Lisp</p><pre data-lang="emacslisp"><i>;; in `~/.emacs`
</i>
(require <i>&#39;</i>package)
(add-to-list <i>&#39;</i>package-archives <i>&#39;</i>(<i>&#34;melpa&#34;</i> . <i>&#34;https://melpa.org/packages/&#34;</i>))
(add-to-list <i>&#39;</i>package-archives <i>&#39;</i>(<i>&#34;gnu&#34;</i>   . <i>&#34;https://elpa.gnu.org/packages/&#34;</i>))

(package-refresh-contents)
(package-install <i>&#39;</i>use-package)

(require <i>&#39;</i>use-package-ensure)
(setq use-package-always-ensure t)

(use-package rustic)
(use-package lsp-mode
  <i>:ensure</i>
  <i>:commands</i> lsp
  <i>:custom</i>
  <i>;; what to use when checking on-save. &#34;check&#34; is default, I prefer clippy
</i>  (lsp-rust-analyzer-cargo-watch-command <i>&#34;clippy&#34;</i>)
  (lsp-eldoc-render-all t)
  (lsp-idle-delay 0.6)
  (lsp-rust-analyzer-server-display-inlay-hints t)
  <i>:config</i>
  (add-hook <i>&#39;</i>lsp-mode-hook <i>&#39;</i>lsp-ui-mode))

(use-package lsp-ui
  <i>:ensure</i>
  <i>:commands</i> lsp-ui-mode
  <i>:custom</i>
  (lsp-ui-peek-always-show t)
  (lsp-ui-sideline-enable <i>nil</i>)
  (lsp-ui-doc-enable t))

(custom-set-variables
 <i>;; custom-set-variables was added by Custom.
</i> <i>;; If you edit it by hand, you could mess it up, so be careful.
</i> <i>;; Your init file should contain only one such instance.
</i> <i>;; If there is more than one, they won&#39;t work right.
</i> <i>&#39;</i>(package-selected-packages <i>&#39;</i>(lsp-ui rustic lsp-mode ## cmake-mode)))
(custom-set-faces
 <i>;; custom-set-faces was added by Custom.
</i> <i>;; If you edit it by hand, you could mess it up, so be careful.
</i> <i>;; Your init file should contain only one such instance.
</i> <i>;; If there is more than one, they won&#39;t work right.
</i> )
</pre></div>
<p>(The bit at the bottom was there originally, I&#39;m guessing Ubuntu ships it? It
didn&#39;t have <code>lsp-ui</code> / <code>rustic</code> / <code>lsp-mode</code> before I restarted emacs).</p>
<p>Restarting emacs installs everything, just like Vim plug-in managers would do,
so far, so good.</p>
<p>Opening <code>src/main.rs</code> again prompts me to import a workspace root, I pick the
first option, which seems reasonable, and tada, we have Rust highlighting and
inline documentation and stuff!</p>

            <picture>
                <source type="image/avif" srcset="/content/articles/the-bottom-emoji-breaks-rust-analyzer/assets/emacs.2a2df3e94d6a282f.avif"/>
                <source type="image/webp" srcset="/content/articles/the-bottom-emoji-breaks-rust-analyzer/assets/emacs.80fade570368c0a0.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/articles/the-bottom-emoji-breaks-rust-analyzer/assets/emacs.76b66fda0c01dc2a.jpg" title="Windows Terminal screenshot showing emacs open on a Rust hello world source file" alt="Windows Terminal screenshot showing emacs open on a Rust hello world source file"/>
            </picture>
            
<p>Or rather, I do, because I have a <code>rust-analyzer</code> binary in path from a while
ago (I contribute occasionally):</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ which rust-analyzer
/home/amos/.cargo/bin/rust-analyzer

$ rust-analyzer --version
rust-analyzer 0.0.0 (caf23f291 2022-07-11)
</pre></div>
<p>This is old. <a href="https://rust-analyzer.github.io/">rust-analyzer</a> is released every
week. Let&#39;s remove it and see if things still work.</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ rm $(which rust-analyzer)

$ emacs src/main.rs

(cut)
Server rls:83343/starting exited (check corresponding stderr buffer
for details). Do you want to restart it? (y or n)
</pre></div>
<p>Ah. It doesn&#39;t. That&#39;s unfortunate!</p>

                        <h2>
                            <a id="how-rust-analyzer-is-distributed" href="#how-rust-analyzer-is-distributed">
                                How rust-analyzer is distributed
                            </a>
                        </h2>
                        
<p>Rust components are normally distributed with <code>rustup</code>. <code>rustc</code> is a Rust
component, so, it is:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ which rustc
/home/amos/.cargo/bin/rustc

$ rustc -V
rustc 1.67.1 (d5a82bbd2 2023-02-07)

$ rustup show active-toolchain
stable-x86_64-unknown-linux-gnu (default)

$ rustup which rustc
/home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin/rustc

$ ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin/rustc -V
rustc 1.67.1 (d5a82bbd2 2023-02-07)
</pre></div>
<p>You can also get it from elsewhere, and I&#39;m sure you have your reasons, but
they&#39;re not relevant to the topic at hand.</p>
<p>After rust-analyzer was promoted from &#34;very useful peripheral project&#34; to
<a href="https://blog.rust-lang.org/2022/02/21/rust-analyzer-joins-rust-org.html">official rust-lang project</a>, it started being distributed as a rustup component.</p>
<p>Back then, it was done by it being a git submodule in the
<a href="http://github.com/rust-lang/rust">rust-lang/rust</a> repository. Since then, it&#39;s
been <a href="https://github.com/rust-lang/rust/pull/99603">migrated to a git subtree</a>,
which helped resolve the <a href="https://fasterthanli.me/articles/proc-macro-support-in-rust-analyzer-for-nightly-rustc-versions">rust-analyzer support for proc macros in Rust
nightly</a> issue.</p>
<p>Why do we care? Because that means there&#39;s technically two trees for
rust-analyzer at any given moment in time: a git subtree can (and should) be
merged in <em>either direction</em>: ra-&gt;rust because ra moves fast and is developed
mostly in its own repository, and rust-&gt;ra because the proc-macro bridge might
change.</p>
<p>So! We can install <code>rust-analyzer</code> with rustup:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ rustup component add rust-analyzer
info: downloading component &#39;rust-analyzer&#39;
info: installing component &#39;rust-analyzer&#39;
</pre></div>
<p>But that doesn&#39;t set up a &#34;proxy binary&#34; under <code>~/.cargo/bin</code>:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ which rust-analyzer

(it prints nothing)
</pre></div>
<p>It is, however, somewhere on disk:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ rustup which rust-analyzer
/home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin/rust-analyzer
</pre></div>
<p>We can even try it out ourselves by launching it, and typing <code>{}</code> then Enter/Return:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin/rust-analyzer
{}
[ERROR rust_analyzer] Unexpected error: expected initialize request, got error: receiving on an empty and disconnected channel
expected initialize request, got error: receiving on an empty and disconnected channel

</pre></div>
<p>That&#39;s right! It&#39;s our old friend JSON-over-stdin.</p>
<p>Since this is a reasonable way in which users might want to install
rust-analyzer, let&#39;s see if our emacs setup picks it up:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ emacs src/main.rs
(cut)
Server rls:86574/starting exited (check corresponding stderr buffer for details).
Do you want to restart it? (y or n)
</pre></div>
<p>No. This is unfortunate, again.</p>
<p>And even if it <em>did</em> work, it would still not be ideal, because... that version
is old too:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ $(rustup which rust-analyzer) --version
rust-analyzer 1.67.1 (d5a82bb 2023-02-07)
</pre></div>
<p>Okay.. that one&#39;s only a few days old, but only because Rust 1.67.0 did an
<a href="https://blog.rust-lang.org/2023/02/09/Rust-1.67.1.html#whats-in-1671-stable">oopsie-woopsie when it comes to thin
archives</a>
and they had to release 1.67.1 shortly after.</p>
<p>But yeah, if we check the version shipped with Rust 1.67.0:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ $(rustup +1.67.0 which rust-analyzer) --version
rust-analyzer 1.67.0 (fc594f1 2023-01-24)
</pre></div>
<p>It&#39;s from around that time. And that hash refers to a a commit in
<a href="https://github.com/rust-lang/rust/commits/fc594f1">rust-lang/rust</a>, not
<code>rust-lang/rust-analyzer</code>, so depending when the the last sync has been made,
it might be even further behind.</p>
<p>rust-analyzer wants to ship every monday, and so, it does! At the time of this
writing, the latest release is from 2023-02-13, and it&#39;s <a href="https://github.com/rust-lang/rust-analyzer/releases/tag/2023-02-13">on
GitHub</a>, which
is where the VSCode extension <em>used</em> to download it from.</p>
<p>These days, it ships the rust-analyzer binary directly in the extension:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ unzip -l rust-lang.rust-analyzer-0.4.1398@linux-x64.vsix
Archive:  rust-lang.rust-analyzer-0.4.1398@linux-x64.vsix
  Length      Date    Time    Name
---------  ---------- -----   ----
     2637  2023-02-10 00:29   extension.vsixmanifest
      462  2023-02-10 00:29   [Content_Types].xml
    15341  2023-02-09 18:46   extension/icon.png
     1036  2023-02-09 18:46   extension/language-configuration.json
    12006  2023-02-09 18:46   extension/LICENSE.txt
   415788  2023-02-10 00:29   extension/out/main.js
   298705  2023-02-09 18:46   extension/package-lock.json
    86857  2023-02-10 00:29   extension/package.json
      756  2023-02-09 18:46   extension/ra_syntax_tree.tmGrammar.json
     2422  2023-02-10 00:29   extension/README.md
 41073816  2023-02-10 00:29   extension/server/rust-analyzer
   648798  2023-02-10 00:29   extension/node_modules/d3-graphviz/build/d3-graphviz.min.js
   279449  2023-02-10 00:29   extension/node_modules/d3/dist/d3.min.js
---------                     -------
 42838073                     13 files
</pre></div>
<p>But other editor plug-ins, like <a href="https://github.com/fannheyward/coc-rust-analyzer">coc-rust-analyzer</a>,
download it <a href="https://github.com/fannheyward/coc-rust-analyzer/blob/4a7ea2d7c3ba866d257b958175f4149823bc3a8f/src/downloader.ts">right from GitHub releases</a>.</p>
<p>It seemed odd that the Emacs ecosystem would lack such functionality, so I
looked it up: <code>rustic</code> says about automatic sever installation that <a href="https://github.com/brotzeit/rustic#automatic-server-installation">lsp-mode
provides this feature, but eglot
doesn&#39;t</a>, and
then it says &#34;Install rust-analyzer manually&#34;.</p>
<p>In lsp-mode, I found code that <a href="https://github.com/emacs-lsp/lsp-mode/blob/781889628b9e0504fde279371548149deae4849d/clients/lsp-rust.el#L894-L905">seems like it should download rust-analyzer</a>,
but I&#39;m not sure how to use it.</p>
<p>The docs talk about an <code>lsp-enable-suggest-server-download</code> option, which
<a href="https://emacs-lsp.github.io/lsp-mode/page/settings/mode/#lsp-enable-suggest-server-download">defaults to true</a>, but I&#39;ve never seen it download the server (I know because I checked <code>~/.emacs.d/.cache/lsp</code>).</p>
<p>Although... now that I look at it closer, this error message:</p>
<div translate="no"><pre data-lang="">Server rls:83343/starting exited (check corresponding stderr buffer
for details). Do you want to restart it? (y or n)
</pre></div>
<p>Mentions <code>rls</code>, which is the predecessor to <code>rust-analyzer</code>, and that definitely
sounds wrong. But <code>lsp-rust-server</code> defaults to <code>rust-analyzer</code>, so.. is it just
falling back? Setting the option explicitly doesn&#39;t seem to change much.</p>
<p>After more Emacs learning, I discovered how to switch to the <code>*lsp-log*</code> buffer
<a href="https://emacs-lsp.github.io/lsp-mode/page/troubleshooting/">the docs point to</a>
and discovered the following:</p>
<div translate="no"><pre data-lang="">Command &#34;rls&#34; is present on the path.
Command &#34;rust-analyzer&#34; is not present on the path.
Command &#34;rls&#34; is present on the path.
Command &#34;rust-analyzer&#34; is not present on the path.
Found the following clients for /home/amos/bearcove/bottom/src/main.rs: (server-id rls, priority -1)
The following clients were selected based on priority: (server-id rls, priority -1)
</pre></div>
<p>This is a <em>horrible</em> fallback. RLS <a href="https://github.com/rust-lang/rls#%EF%B8%8F-rls-is-no-longer-supported">is deprecated</a>. The only reason it&#39;s falling
back to it is because there <em>is</em> a proxy binary for it, that exists, but errors
out since the component is not installed:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ which rls
/home/amos/.cargo/bin/rls

$ rls
error: &#39;rls&#39; is not installed for the toolchain &#39;stable-x86_64-unknown-linux-gnu&#39;
To install, run `rustup component add rls`

$ echo $?
1
</pre></div>
<p>Let&#39;s summarize the situation:</p>
<ul>
<li>rustup is the &#34;blessed&#34; way to get a rust toolchain (you can do nice things
like <a href="https://rust-lang.github.io/rustup/overrides.html#the-toolchain-file">pinning</a> with it)</li>
<li>it sets up an <code>rls</code> proxy binary under <code>~/.cargo/bin</code> like it should, because even
though rls is deprecated, some folks still use it for now I guess</li>
<li><code>lsp-mode</code> looks for <code>rust-analyzer</code> first, <code>rls</code> second, and if it finds
the second (even if it&#39;s just a stub/proxy that says &#34;sorry not installed&#34;),
it falls back to it and the &#34;auto download rust-analyzer&#34; logic never triggers</li>
</ul>
<p>I must admit this is an even bigger deal than what I was originally planning to
write about! If this is the experience Emacs folks have been having with Rust,
this explains a lot of things.</p>
<p>My sample size is N=3, but everyone in that sample ended up building
rust-analyzer from source, and that means they get an extremely up-to-date RA
once, and then most probably forget to update it forever, which is even worse
than grabbing it from rustup.</p>
<p>Please remind me to submit a PR to <code>lsp-mode</code> that yanks ALL the rls stuff
after I&#39;m done writing this article. Someone must.</p>
<p>ANYWAY.</p>
<p>For today, let&#39;s just tell <code>lsp-mode</code> to use the one from rustup:</p>
<div translate="no"><p>Emacs Lisp</p><pre data-lang="emacslisp"><i>;; under (use-package lsp-mode
</i><i>;; in the :custom block
</i>  (lsp-rust-analyzer-server-command (list (string-trim (shell-command-to-string <i>&#34;rustup which rust-analyzer&#34;</i>))))
</pre></div>
<p>Just kidding! That doesn&#39;t work. And yes, that evaluates to the right path. And
yes, that &#34;custom&#34; option expects a list. And yes, I did learn what
<code>custom-set-variables</code> does while troubleshooting this, and no, setting it
through there doesn&#39;t work either.</p>
<p>The <code>*Messages*</code> buffer still shows that it couldn&#39;t find <code>rust-analyzer</code> in
PATH.</p>
<p>My best guess is that <code>rustic</code>, which can use either <code>lsp-mode</code> or <code>eglot</code>,
overrides this very late in the game, and I can&#39;t do a damn thing about it.
I&#39;m not sure why they even have an &#34;Automatic server installation&#34; section in
their docs then.</p>
<p>So. Fine. We&#39;ll use violence and create a shell script in
<code>~/.cargo/bin/rust-analyzer</code>, containing this:</p>
<div translate="no"><pre data-lang="">#!/bin/bash

$(rustup which rust-analyzer) &#34;$@&#34;
</pre></div><div translate="no"><p>Shell session</p><pre data-lang="shell">$ chmod +x ~/.cargo/bin/rust-analyzer
$ hash -r
$ rust-analyzer --version
rust-analyzer 1.67.1 (d5a82bb 2023-02-07)

</pre></div>
<p>Tada, we did a crime!</p>

                        <h2>
                            <a id="reproducing-the-issue-part-2" href="#reproducing-the-issue-part-2">
                                Reproducing the issue, part 2
                            </a>
                        </h2>
                        
<p>So, now that we have emacs configured with lsp-mode and rustic, using a
recent-ish rust-analyzer, we&#39;re back to square one.</p>
<p>Note that I forgot to add <a href="https://company-mode.github.io/">company-mode</a>, the
thing that actually provides completions: we can add it above <code>(use-package rustic)</code> in <code>~/.emacs</code>:</p>
<div translate="no"><p>Emacs Lisp</p><pre data-lang="emacslisp"><i>;; in `~/.emacs`
</i>
<i>;; cut: everything before that line
</i>
(require <i>&#39;</i>use-package-ensure)
(setq use-package-always-ensure t)

(use-package rustic)
<i>;; 👇 new!
</i>(use-package company-mode)
</pre></div>
<p>Restarting emacs installs it, and we now get completions &#34;after typing a few
characters and waiting a bit&#34;. You can bind a key combination to
&#34;company-complete&#34; to have it pop up on-demand, which I did, and then Emacs
told me &#34;no, you shouldn&#39;t write it <code>C-SPC</code>, you should write it <code>[?\C- ]</code>&#34;, which
is exceedingly rude, but let&#39;s move on.</p>
<p>(The keybinding didn&#39;t work in the terminal but it did work in emacs-gtk, which
I installed out of frustration).</p>
<p>Anyway!</p>
<p>Now onto the actual bug: let&#39;s add to our code.. an emoji! Any emoji.</p>
<div translate="no"><p>Rust code</p><pre data-lang="rust"><i>fn</i> <i>main</i><i>(</i><i>)</i> <i>{</i>
  <i>// 🥺</i>
  <i>println</i><i>!</i><i>(</i><i>&#34;Hello, world!&#34;</i><i>)</i><i>;</i>
<i>}</i>
</pre></div>
<p>Upon typing this emoji in the editor, a message will pop up in the bottom bar
(appropriate) saying the LSP server crashed, would you like to restart it, no I
wouldn&#39;t, I&#39;d like to see the messages, a little <code>C-x b *rust-anal&lt;TAB&gt;::std&lt;TAB&gt;</code> later I&#39;m in buffer <code>*rust-analyzer::stderr*</code> seeing
this:</p>
<div translate="no"><pre data-lang="">Panic context:
&gt;
version: 1.67.1 (d5a82bb 2023-02-07)
notification: textDocument/didChange

thread &#39;LspServer&#39; panicked at &#39;assertion failed: self.is_char_boundary(n)&#39;, /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/alloc/src/string.rs:1819:29
stack backtrace:
   0: rust_begin_unwind
             at /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/std/src/panicking.rs:575:5
   1: core::panicking::panic_fmt
             at /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/core/src/panicking.rs:64:14
   2: core::panicking::panic
             at /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/core/src/panicking.rs:111:5
   3: &lt;alloc::string::String&gt;::replace_range::&lt;core::ops::range::Range&lt;usize&gt;&gt;
   4: rust_analyzer::lsp_utils::apply_document_changes::&lt;&lt;rust_analyzer::global_state::GlobalState&gt;::on_notification::{closure#3}::{closure#0}&gt;
   5: &lt;&lt;rust_analyzer::global_state::GlobalState&gt;::on_notification::{closure#3} as core::ops::function::FnOnce&lt;(&amp;mut rust_analyzer::global_state::GlobalState, lsp_types::DidChangeTextD\
ocumentParams)&gt;&gt;::call_once
   6: &lt;rust_analyzer::dispatch::NotificationDispatcher&gt;::on::&lt;lsp_types::notification::DidChangeTextDocument&gt;
   7: &lt;rust_analyzer::global_state::GlobalState&gt;::handle_event
   8: &lt;rust_analyzer::global_state::GlobalState&gt;::run
   9: rust_analyzer::main_loop::main_loop
  10: rust_analyzer::run_server
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.

Process rust-analyzer stderr finished
</pre></div>
<p><em>That</em> is the bug we&#39;re interested in.</p>
<p>And if you have some instinct as to the source of this bug, let me tell you:
it&#39;s so much worse than you think.</p>

                        <h2>
                            <a id="exploring-utf-8-and-utf-16-with-rust" href="#exploring-utf-8-and-utf-16-with-rust">
                                Exploring UTF-8 and UTF-16 with Rust
                            </a>
                        </h2>
                        
<p>Rust strings are UTF-8, period.</p>
<p>And by &#34;Rust strings&#34; I mean the owned type <a href="https://doc.rust-lang.org/stable/std/string/struct.String.html">String</a>
and string slices, aka <a href="https://doc.rust-lang.org/stable/std/primitive.str.html">&amp;str</a>.</p>
<p>We can tell by printing the underlying byte representation:</p>
<div translate="no"><p>Rust code</p><pre data-lang="rust"><i>fn</i> <i>main</i><i>(</i><i>)</i> <i>{</i>
    <i>println</i><i>!</i><i>(</i><i>&#34;{:02x?}&#34;</i>, <i>&#34;abc&#34;</i>.as_bytes<i>(</i><i>)</i><i>)</i><i>;</i>
<i>}</i>
</pre></div><div translate="no"><p>Shell session</p><pre data-lang="shell">$ cargo run --quiet
[61, 62, 63]
</pre></div>
<p>Which is not to say that you cannot use UTF-16 string representation in Rust, you
just..  make your own type for it. Or, more likely, you use a crate, like
<a href="https://lib.rs/crates/widestring">widestring</a>:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ cargo add widestring
    Updating crates.io index
      Adding widestring v1.0.2 to dependencies.
             Features:
             + alloc
             + std
</pre></div><div translate="no"><p>Rust code</p><pre data-lang="rust"><i>fn</i> <i>main</i><i>(</i><i>)</i> <i>{</i>
    <i>// this is a macro, it does the right thing</i>
    <i>let</i> s = widestring<i>::</i>u16str!<i>(</i><i>&#34;abc&#34;</i><i>)</i><i>;</i>
    <i>println</i><i>!</i><i>(</i><i>&#34;{:04x?}&#34;</i>, s.as_slice<i>(</i><i>)</i><i>)</i><i>;</i>
<i>}</i>
</pre></div>
<p>This gives us a <code>&amp;[u16]</code>, so it&#39;s not quite what we&#39;re looking for:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ cargo run --quiet
[0061, 0062, 0063]
</pre></div>
<p>Getting at the bytes is harder, but not impossible:</p>
<div translate="no"><p>Rust code</p><pre data-lang="rust"><i>fn</i> <i>main</i><i>(</i><i>)</i> <i>{</i>
    <i>// this is a macro, it does the right thing</i>
    <i>let</i> s = widestring<i>::</i>u16str!<i>(</i><i>&#34;abc&#34;</i><i>)</i><i>;</i>
    <i>{</i>
        <i>let</i> u16s = s<i>.</i><i>as_slice</i><i>(</i><i>)</i><i>;</i>
        <i>let</i> <i>(</i>_<i>,</i> u8s<i>,</i> _<i>)</i> = <i>unsafe</i> <i>{</i> u16s<i>.</i><i>align_to</i><i>::</i><i>&lt;</i><i>u8</i><i>&gt;</i><i>(</i><i>)</i> <i>}</i><i>;</i>
        <i>println</i><i>!</i><i>(</i><i>&#34;{:02x?}&#34;</i>, u8s<i>)</i><i>;</i>
    <i>}</i>
<i>}</i>
</pre></div>
<p>Heck, it shouldn&#39;t even <em>really</em> require unsafe, since anything that&#39;s
u16-aligned is also definitely u8-aligned, here, let me make a safe wrapper
for it:</p>
<div translate="no"><p>Rust code</p><pre data-lang="rust"><i>fn</i> <i>u16_slice_to_u8_slice</i><i>(</i><i>s</i><i>:</i> <i>&amp;</i><i>[</i><i>u16</i><i>]</i><i>)</i> -&gt; <i>&amp;</i><i>[</i><i>u8</i><i>]</i> <i>{</i>
    <i>unsafe</i> <i>{</i>
        <i>// Safety: u8 slices don&#39;t require any alignment, it really doesn&#39;t</i>
        <i>// get any smaller without bit-twiddling</i>
        s<i>.</i><i>align_to</i><i>::</i><i>&lt;</i><i>u8</i><i>&gt;</i><i>(</i><i>)</i><i>.</i><i>1</i>
    <i>}</i>
<i>}</i>
</pre></div>
<p>There:</p>
<div translate="no"><p>Rust code</p><pre data-lang="rust"><i>fn</i> <i>main</i><i>(</i><i>)</i> <i>{</i>
    <i>// this is a macro, it does the right thing</i>
    <i>let</i> s = widestring<i>::</i>u16str!<i>(</i><i>&#34;abc&#34;</i><i>)</i><i>;</i>
    <i>{</i>
        <i>let</i> u16s = s<i>.</i><i>as_slice</i><i>(</i><i>)</i><i>;</i>
        <i>let</i> u8s = <i>u16_slice_to_u8_slice</i><i>(</i>u16s<i>)</i><i>;</i>
        <i>println</i><i>!</i><i>(</i><i>&#34;{:02x?}&#34;</i>, u8s<i>)</i><i>;</i>
    <i>}</i>
<i>}</i>
</pre></div><div translate="no"><p>Shell session</p><pre data-lang="shell">$ cargo run --quiet
[61, 00, 62, 00, 63, 00]
</pre></div>
<p>Okay, cool! So utf-16 is just utf-8 with extra zeroes.</p>

<p>No, of course not. It&#39;s easy with ASCII characters, but it gets more complicated
the fancier you want to get.</p>
<p>How about &#34;é&#34; for example. That sounds fancy! How does it look?</p>
<div translate="no"><p>Rust code</p><pre data-lang="rust"><i>const</i> S<i>:</i> <i>&amp;</i><i>str</i> = <i>&#34;é&#34;</i><i>;</i>

<i>fn</i> <i>main</i><i>(</i><i>)</i> <i>{</i>
    <i>println</i><i>!</i><i>(</i><i>&#34;{S:?}&#34;</i><i>)</i><i>;</i>
    <i>println</i><i>!</i><i>(</i><i>&#34;UTF-8   {:02x?}&#34;</i>, S.as_bytes<i>(</i><i>)</i><i>)</i><i>;</i>
    <i>println</i><i>!</i><i>(</i>
        <i>&#34;UTF-16  {:02x?}&#34;</i>,
        u16_slice_to_u8_slice<i>(</i><i>(</i>widestring::u16str!<i>(</i>S<i>)</i><i>)</i>.as_slice<i>(</i><i>)</i><i>)</i>
    <i>)</i><i>;</i>
<i>}</i>

<i>fn</i> <i>u16_slice_to_u8_slice</i><i>(</i><i>s</i><i>:</i> <i>&amp;</i><i>[</i><i>u16</i><i>]</i><i>)</i> -&gt; <i>&amp;</i><i>[</i><i>u8</i><i>]</i> <i>{</i>
    <i>unsafe</i> <i>{</i>
        <i>// Safety: u8 slices don&#39;t require any alignment, it really doesn&#39;t</i>
        <i>// get any smaller without bit-twiddling</i>
        s<i>.</i><i>align_to</i><i>::</i><i>&lt;</i><i>u8</i><i>&gt;</i><i>(</i><i>)</i><i>.</i><i>1</i>
    <i>}</i>
<i>}</i>
</pre></div><div translate="no"><p>Shell session</p><pre data-lang="shell">$ cargo run -q     
&#34;é&#34;
UTF-8   [c3, a9]
UTF-16  [e9, 00]
</pre></div>
<p>Ah, not fancy enough! It takes up 2 bytes in UTF-8, and one &#34;code unit&#34; in
UTF-16, which we&#39;re showing as two bytes, because we can.</p>
<p>Let&#39;s try something fancier! </p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ cargo run -q
&#34;œ&#34;
UTF-8   [c5, 93]
UTF-16  [53, 01]
</pre></div>
<p>&#34;Latin Small Ligature Oe&#34; is in the <a href="https://unicode-table.com/en/0153/">Latin
Extended-A</a> range: that goes <code>0100-017F</code>. We
no longer have a &#34;useless byte&#34; in the UTF-16 encoding, since the code unit is
actually &#34;0153&#34; (in hexadecimal).</p>
<p>Meanwhile, in UTF-8 land, we still need two bytes to encode it. All is well.</p>
<p>Let&#39;s get fancier still! How about some Hiragana? (<code>3040-309F</code>)</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ cargo run -q
&#34;ぁ&#34;
UTF-8   [e3, 81, 81]
UTF-16  [41, 30]
</pre></div>
<p>&#34;Hiragana Letter Small A&#34; takes 3 bytes in UTF-8, but only 2 bytes (one 16-bit
code unit) in UTF-16. Huh! That must be why people loved UTF-16 so much, they
made it the default string representation <a href="https://devdocs.io/openjdk~8/java/lang/string">for Java</a> <em>and</em> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String#utf-16_characters_unicode_codepoints_and_grapheme_clusters">JavaScript</a> (no
relation).</p>
<p>Because at some point in the history of the human race, we thought 65536
characters were <em>more than enough</em>. It would be <em>absurd</em> to need more characters
than that. And so we made UCS-2, which used two bytes for every character,
enabling the encoding of the BMP, the <a href="https://en.wikipedia.org/wiki/Universal_Coded_Character_Set#Encoding_forms">Basic Multilingual Plane</a>.</p>
<p>But that&#39;s a lie. We knew 65536 characters weren&#39;t enough, because China.</p>
<p>(Among other reasons).</p>
<p>So there were already 1.1 million characters defined by Unicode, and some of
those wouldn&#39;t fit, and so we made UCS-4, which used four bytes for every
character, but that sounds <em>terribly wasteful</em> compared to plain old
ASCII-with-a-codepage-good-luck-exporting-documents I guess.</p>
<p>So ISO/IEC 2022 specifies escape sequences to <em>switch between character sets</em>.
I wish I was making it up, but <a href="https://en.wikipedia.org/wiki/ISO/IEC_2022#Character_set_designations">I&#39;m
not</a>!
Apparently xterm supports some of it! I know!!! I can&#39;t believe it either!</p>
<p>So anyway, UTF-16 is an evolution of UCS-2 that says hey maybe switching
character encodings in-band isn&#39;t the greatest thing (also I&#39;m not sure how
widely adopted those escape sequences were in the first place), let&#39;s just have
a thing where <em>most</em> characters fit in 2 bytes, and those that don&#39;t fit in..
more.</p>
<p>So let&#39;s look at our Hiragana again but simply print UTF-16 code units now,
instead of the underlying two bytes:</p>
<div translate="no"><p>Rust code</p><pre data-lang="rust"><i>const</i> S<i>:</i> <i>&amp;</i><i>str</i> = <i>&#34;ぁ&#34;</i><i>;</i>

<i>fn</i> <i>main</i><i>(</i><i>)</i> <i>{</i>
    <i>println</i><i>!</i><i>(</i><i>&#34;{S:?}&#34;</i><i>)</i><i>;</i>
    <i>println</i><i>!</i><i>(</i><i>&#34;UTF-8   {:02x?}&#34;</i>, S.as_bytes<i>(</i><i>)</i><i>)</i><i>;</i>
    <i>println</i><i>!</i><i>(</i><i>&#34;UTF-16  {:02x?}&#34;</i>, <i>(</i>widestring::u16str!<i>(</i>S<i>)</i><i>)</i>.as_slice<i>(</i><i>)</i><i>)</i><i>;</i>
<i>}</i>
</pre></div><div translate="no"><p>Shell session</p><pre data-lang="shell">$ cargo run -q
&#34;ぁ&#34;
UTF-8   [e3, 81, 81]
UTF-16  [3041]
</pre></div>
<p>Okay, cool, so: for U+3041, we need 3 bytes in UTF-8, and one UTF-16 code unit
(2 bytes).</p>
<p>Let us now embark on a cross-plane journey:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ cargo run -q
&#34;𠀀&#34;
UTF-8   [f0, a0, 80, 80]
UTF-16  [d840, dc00]
</pre></div>
<p>But first, a minute of silence for anyone reading this from a Linux desktop
machine.</p>
<p>...</p>
<p>There. In case you can&#39;t see it, the character in question is <a href="https://unicode-table.com/en/20000/">Ideograph the
sound made by breathing in; oh! (cf. U+311B BOPOMOFO LETTER O, which is derived
from this character) CJK</a>, or &#34;hē&#34;, for
friends.</p>
<p>It is U+20000, which is outside the BMP.</p>

<p>BMP, <a href="https://en.wikipedia.org/wiki/Plane_(Unicode)#Basic_Multilingual_Plane">Basic Multilingual
Plane</a>,
we&#39;ve gone over this: it&#39;s <code>0000-FFFF</code>, except...  except part of it is reserved
for UTF-16 surrogates! High surrogates are <code>D800-DB7F</code>, and surprise surprise,
that&#39;s what our first code unit is: <code>d840</code>. Low surrogates are <code>DC00-DFFF</code>, and
that&#39;s what our second code unit is.</p>
<p>How does this work? Well, we take our codepoint, in our case <code>U+20000</code>, and
subtract 0x10000 from it. We get <code>0x10000</code>, or, in binary:</p>
<div translate="no"><pre data-lang=""> 0b00010000000000000000
   &lt;--------&gt;&lt;--------&gt;
       hi        lo
</pre></div>
<p>Then we take the high ten bits, add them to <code>0xD800</code>, in our case, <code>0b1000000</code>
gives <code>0x40</code>, so we get <code>0xD840</code>. As for the low ten bits, we add them to
<code>0xDC00</code>, for us that&#39;s 0x0 (should&#39;ve picked a different example), so we get
<code>0xDC00</code>.</p>
<p>Easy peasy.</p>
<p>And so, &#34;𠀀&#34; is:</p>
<ul>
<li>1 <a href="https://en.wikipedia.org/wiki/Universal_Character_Set_characters#Characters%2C_grapheme_clusters_and_glyphs">grapheme cluster</a></li>
<li>1 unicode character (with the unicode code point U+20000)</li>
<li>4 UTF-8 bytes</li>
<li>2 UTF-16 code units</li>
</ul>
<p>All clear? Good.</p>
<p>How about our emoji? Our innocent little emoji? Look at it. It didn&#39;t mean to
cause any trouble. Let&#39;s find out:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ cargo run -q
&#34;🥺&#34;
UTF-8   [f0, 9f, a5, ba]
UTF-16  [d83e, dd7a]
</pre></div>
<p>Okay, same! Ooh I bet we can find what codepoint it is by doing the inverse
transformation on the UTF-16 surrogate pair here:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ gdb --quiet
(cut)
(gdb) p/x 0xd83e - 0xd800
$1 = 0x3e
(gdb) p/x 0xdd7a - 0xdc00
$2 = 0x17a
</pre></div><div>

<p><em>That&#39;s</em> your hex calculator of choice?</p>
</div>
<div>

<p>Shh I&#39;m trying to focus here.</p>
</div>
<div translate="no"><p>Shell session</p><pre data-lang="shell">(continued)

(gdb) p/t 0x3e
$3 = 111110
(gdb) p/t 0x17a
$4 = 101111010
</pre></div><div>

<p>Wait wait why are you going through binary, you can just do a left shift here, right?</p>
</div>

<div translate="no"><p>Shell session</p><pre data-lang="shell">(continued)

(gdb) p/x (0x3e &lt;&lt; 10) + 0x17a + 0x10000
$5 = 0x1f97a
</pre></div>
<p>Hurray, here it is! <a href="https://unicode-table.com/en/1F97A/">U+1F97A Bottom Face Emoji</a>.</p>
<p>So. Rust really likes UTF-8, and so do I. Hence, I really like Rust.</p>
<p>Whereas some languages just do not let you mutate strings at all (it&#39;s safer
that way), Rust does! You can totally do this, for example:</p>
<div translate="no"><p>Rust code</p><pre data-lang="rust"><i>fn</i> <i>main</i><i>(</i><i>)</i> <i>{</i>
    <i>let</i> <i>mut</i> s = <i>String</i><i>::</i><i>from</i><i>(</i><i>&#34;amos&#34;</i><i>)</i><i>;</i>
    s<i>.</i><i>replace_range</i><i>(</i><i>0</i>..<i>1</i><i>,</i> <i>&#34;c&#34;</i><i>)</i><i>;</i>
    <i>dbg</i><i>!</i><i>(</i>s<i>)</i><i>;</i>
<i>}</i>
</pre></div><div translate="no"><p>Shell session</p><pre data-lang="shell">$ cargo run -q
[src/main.rs:4] s = &#34;cmos&#34;
</pre></div>
<p>Note that this is safe rust!</p>
<p>Also note that Amos is my first name, and <a href="https://en.wikipedia.org/wiki/CMOS">CMOS</a> is a type of
metal-oxide-semiconductor field-effect transistor fabrication process that uses
complementary and symmetrical pairs of p-type and n-type MOSFETs for logic
functions.</p>
<p>Coincidence? Probably.</p>
<p>We can also do this, using unsafe Rust:</p>
<div translate="no"><p>Rust code</p><pre data-lang="rust"><i>fn</i> <i>main</i><i>(</i><i>)</i> <i>{</i>
    <i>let</i> <i>mut</i> s = <i>String</i><i>::</i><i>from</i><i>(</i><i>&#34;amos&#34;</i><i>)</i><i>;</i>
    <i>// why b&#39;c&#39;? because &#39;c&#39; is a char, whereas b&#39;c&#39; is a u8 (a byte).</i>
    <i>unsafe</i> <i>{</i> s<i>.</i><i>as_bytes_mut</i><i>(</i><i>)</i><i>[</i><i>0</i><i>]</i> = <i>b&#39;c&#39;</i> <i>}</i><i>;</i>
    <i>dbg</i><i>!</i><i>(</i>s<i>)</i><i>;</i>
<i>}</i>
</pre></div>
<p>And we get the same output.</p>
<p>Which begs the question, why is the former safe and the latter unsafe, if they
do the same darn thing!</p>
<p>It&#39;s because they don&#39;t.</p>
<p>The unsafe version lets us do this:</p>
<div translate="no"><p>Rust code</p><pre data-lang="rust"><i>fn</i> <i>main</i><i>(</i><i>)</i> <i>{</i>
    <i>let</i> <i>mut</i> s = <i>String</i><i>::</i><i>from</i><i>(</i><i>&#34;🥺&#34;</i><i>)</i><i>;</i>
    <i>unsafe</i> <i>{</i>
        s<i>.</i><i>as_bytes_mut</i><i>(</i><i>)</i><i>[</i><i>3</i><i>]</i> = <i>b&#39;#&#39;</i><i>;</i>
    <i>}</i><i>;</i>
    <i>dbg</i><i>!</i><i>(</i>s<i>)</i><i>;</i>
<i>}</i>
</pre></div><div translate="no"><p>Shell session</p><pre data-lang="shell">$ cargo run --quiet
[src/main.rs:6] s = &#34;�#&#34;
</pre></div>
<p>Which is, say it with me: undefined behaviorrrr ooooh spooky ghost emoji! We
broke an invariant (strings must always be valid UTF-8) and now anything goes,
we could even have memory corruption come out of this! Probably!</p>
<p>Them&#39;s the rules of unsafe Rust: if we use it, we are suddenly responsible for
maintaining all the invariants ourselves. Just like we are, all the time, in
unsafe languages like C/C++ (also C, and C++).</p>
<p><code>replace_range</code> does not let us do that:</p>
<div translate="no"><p>Rust code</p><pre data-lang="rust"><i>fn</i> <i>main</i><i>(</i><i>)</i> <i>{</i>
    <i>let</i> <i>mut</i> s = <i>String</i><i>::</i><i>from</i><i>(</i><i>&#34;🥺&#34;</i><i>)</i><i>;</i>
    s<i>.</i><i>replace_range</i><i>(</i><i>3</i>..<i>4</i><i>,</i> <i>&#34;#&#34;</i><i>)</i><i>;</i>
    <i>dbg</i><i>!</i><i>(</i>s<i>)</i><i>;</i>
<i>}</i>
</pre></div><div translate="no"><p>Shell session</p><pre data-lang="shell">$ cargo run --quiet
thread &#39;main&#39; panicked at &#39;assertion failed: self.is_char_boundary(n)&#39;, /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/alloc/src/string.rs:1811:29
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</pre></div>
<p>Well well well, doesn&#39;t that look familiar.</p>
<p>Again with a backtrace:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ RUST_BACKTRACE=1 cargo run --quiet
thread &#39;main&#39; panicked at &#39;assertion failed: self.is_char_boundary(n)&#39;, /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/alloc/src/string.rs:1811:29
stack backtrace:
   0: rust_begin_unwind
             at /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/std/src/panicking.rs:575:5
   1: core::panicking::panic_fmt
             at /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/core/src/panicking.rs:64:14
   2: core::panicking::panic
             at /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/core/src/panicking.rs:111:5
   3: alloc::string::String::replace_range
             at /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/alloc/src/string.rs:1811:29
   4: bottom::main
             at ./src/main.rs:3:5
   5: core::ops::function::FnOnce::call_once
             at /rustc/d5a82bbd26e1ad8b7401f6a718a9c57c96905483/library/core/src/ops/function.rs:507:5
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.
</pre></div>
<p>Yep okay this is <em>definitely</em> familiar.</p>
<div>

<div>
<p>So this is what&#39;s happening with lsp-mode + rust-analyzer, right?</p>
<p>lsp-mode is sending bad offsets, rust-analyzer panics. Mystery solved?</p>
</div>
</div>
<p>Well, yes. But why does that happen? And what should rust-analyzer actually do
in this case?</p>

                        <h2>
                            <a id="the-language-server-protocol" href="#the-language-server-protocol">
                                The Language Server Protocol
                            </a>
                        </h2>
                        
<p>To answer these questions, we must look at the LSP: the <a href="https://microsoft.github.io/language-server-protocol/">Language Server
Protocol</a>.</p>
<p>And instead of reading the spec directly, let&#39;s look at what&#39;s <em>actually</em> being
sent between an LSP client (like lsp-mode for Emacs) and an LSP server (like
rust-analyzer).</p>
<p>There&#39;s something built into lsp-mode to do this, the <code>lsp-log-io</code> setting, but
I think it&#39;s a lot more fun to capture it ourselves, by providing a wrapper
for rust-analyzer.</p>
<div translate="no"><p>Zig</p><pre data-lang="zig"><i>// in `src/main.zig`</i>

<i>const</i> <i>std</i> <i>=</i> <i>@import</i><i>(</i><i>&#34;std&#34;</i><i>)</i><i>;</i>
<i>const</i> <i>ChildProcess</i> <i>=</i> <i>std</i><i>.</i><i>ChildProcess</i><i>;</i>
<i>const</i> <i>StdIo</i> <i>=</i> <i>ChildProcess</i><i>.</i><i>StdIo</i><i>;</i>
<i>const</i> <i>File</i> <i>=</i> <i>std</i><i>.</i><i>fs</i><i>.</i><i>File</i><i>;</i>
<i>const</i> <i>Thread</i> <i>=</i> <i>std</i><i>.</i><i>Thread</i><i>;</i>

<i>const</i> <i>DEBUG</i> <i>=</i> <i><i>false</i></i><i>;</i>
<i>const</i> <i>DEBUG_LEAKS</i> <i>=</i> <i><i>false</i></i><i>;</i>
<i>const</i> <i>CLEANUP_STREAMS_WORKAROUND_NAME</i> <i>=</i> <i>&#34;.cleanupStreamsWorkaround&#34;</i><i>;</i>

<i>fn</i> <i>debug</i><i>(</i><i>comptime</i> <i>fmt</i><i>:</i> <i>[</i><i>]</i><i>const</i> <i>u8</i><i>,</i> <i>args</i><i>:</i> <i>anytype</i><i>)</i> <i>void</i> <i>{</i>
    <i>if</i> <i>(</i><i>DEBUG</i><i>)</i> <i>{</i>
        <i>std</i><i>.</i><i>debug</i><i>.</i><i>print</i><i>(</i><i>fmt</i><i>,</i> <i>args</i><i>)</i><i>;</i>
    <i>}</i>
<i>}</i>

<i>pub</i> <i>fn</i> <i>main</i><i>(</i><i>)</i> <i>!</i><i>void</i> <i>{</i>
    <i>var</i> <i>alloc</i><i>:</i> <i>std</i><i>.</i>mem<i>.</i>Allocator <i>=</i> <i>undefined</i><i>;</i> <i>// like the behavior</i>

    <i>var</i> <i>gpa</i><i>:</i> <i>?</i><i>std</i><i>.</i>heap<i>.</i><i>GeneralPurposeAllocator</i><i>(</i><i>.{</i><i>}</i><i>)</i> <i>=</i> <i>undefined</i><i>;</i>
    <i>// this `defer` cannot live inside the `if DEBUG_LEAKS` block, because then</i>
    <i>// the allocator would be deinitialized before our program even runs.</i>
    <i>defer</i> <i>if</i> <i>(</i><i>gpa</i><i>)</i> <i>|</i><i>*</i>g<i>|</i> <i>{</i>
        <i>std</i><i>.</i><i>debug</i><i>.</i><i>print</i><i>(</i><i>&#34;Checking for memory leaks...<i>\n</i>&#34;</i><i>,</i> <i>.{</i><i>}</i><i>)</i><i>;</i>
        <i>std</i><i>.</i><i>debug</i><i>.</i><i>assert</i><i>(</i><i>!</i><i>g</i><i>.</i><i>deinit</i><i>(</i><i>)</i><i>)</i><i>;</i>
    <i>}</i><i>;</i>

    <i>if</i> <i>(</i><i>DEBUG_LEAKS</i><i>)</i> <i>{</i>
        <i>// can&#39;t figure out how to elide the type name here</i>
        <i>// assigning apparently promotes from `GPA` to `?GPA`</i>
        <i>gpa</i> <i>=</i> <i>std</i><i>.</i><i>heap</i><i>.</i><i>GeneralPurposeAllocator</i><i>(</i><i>.{</i><i>}</i><i>)</i><i></i><i>{</i><i>}</i><i>;</i>
        <i>// ...but we still need to &#39;unwrap&#39; it here (could get away</i>
        <i>// with a temporary variable)</i>
        <i>alloc</i> <i>=</i> <i>gpa</i><i>.?</i><i>.</i><i>allocator</i><i>(</i><i>)</i><i>;</i>
    <i>}</i> <i>else</i> <i>{</i>
        <i>alloc</i> <i>=</i> <i>std</i><i>.</i><i>heap</i><i>.</i><i>page_allocator</i><i>;</i>
    <i>}</i>

    <i>// note: on Linux, this ends up using `fork+execve`. this is a bad idea,</i>
    <i>// as others have found out before: https://github.com/golang/go/issues/5838</i>
    <i>//</i>
    <i>// I was curious why passing `rustup` here worked: for me it had to either</i>
    <i>// parse `PATH` or go through a shell of some sort. Turns out it _does_ parse</i>
    <i>// `PATH` (falling back to `/usr/local/bin:/bin:/usr/bin`) and then does</i>
    <i>// a _bunch_ of `execve` calls in a row, continuing until it doesn&#39;t return</i>
    <i>// &#34;AccessDenied&#34; or &#34;FileNotFound&#34;.</i>
    <i>var</i> <i>res</i> <i>=</i> <i>try</i> <i>ChildProcess</i><i>.</i><i>exec</i><i>(</i><i>.{</i> <i>// anonymous struct literal</i>
        <i>// C99 syntax, yum</i>
        <i>.</i><i>allocator</i> <i>=</i> <i>alloc</i><i>,</i>
        <i>.</i><i>argv</i> <i>=</i> <i>&amp;</i><i>[</i><i>_</i><i>]</i><i>[</i><i>]</i><i>const</i> <i>u8</i><i>{</i> <i>&#34;rustup&#34;</i><i>,</i> <i>&#34;which&#34;</i><i>,</i> <i>&#34;rust-analyzer&#34;</i> <i>}</i><i>,</i>
    <i>}</i><i>)</i><i>;</i>
    <i>// `ExecResult` doesn&#39;t have a `deinit` method, if you don&#39;t call these</i>
    <i>// you have a leak</i>
    <i>defer</i> <i>alloc</i><i>.</i><i>free</i><i>(</i><i>res</i><i>.</i><i>stdout</i><i>)</i><i>;</i>
    <i>defer</i> <i>alloc</i><i>.</i><i>free</i><i>(</i><i>res</i><i>.</i><i>stderr</i><i>)</i><i>;</i>

    <i>var</i> <i>ra_path</i> <i>=</i> x<i>:</i> <i>{</i> <i>// block with a label</i>
        <i>// I&#39;m not sure why I have to pass `u8` here instead of it being inferred</i>
        <i>var</i> <i>splits</i> <i>=</i> <i>std</i><i>.</i><i>mem</i><i>.</i><i>split</i><i>(</i><i>u8</i><i>,</i> <i>res</i><i>.</i><i>stdout</i><i>,</i> <i>&#34;<i>\n</i>&#34;</i><i>)</i><i>;</i>
        <i>// breaking the label - blocks aren&#39;t expressions, so this is how</i>
        <i>// it&#39;s done. note that `first()` doesn&#39;t return `?[]const u8`, it&#39;s</i>
        <i>// infallible</i>
        <i>break</i> <i>:</i>x <i>splits</i><i>.</i><i>first</i><i>(</i><i>)</i><i>;</i>
    <i>}</i><i>;</i>
    <i>// ra_path is a slice of res.stdout, so we can&#39;t free it first</i>
    <i>debug</i><i>(</i><i>&#34;RA path = &#39;{s}&#39;<i>\n</i>&#34;</i><i>,</i> <i>.{</i><i>ra_path</i><i>}</i><i>)</i><i>;</i>

    <i>var</i> <i>proc</i> <i>=</i> <i>ChildProcess</i><i>.</i><i>init</i><i>(</i>
        <i>// the array length can be inferred (from `_`), but the element type cannot</i>
        <i>&amp;</i><i>[</i><i>_</i><i>]</i><i>[</i><i>]</i><i>const</i> <i>u8</i><i>{</i><i>ra_path</i><i>}</i><i>,</i>
        <i>alloc</i><i>,</i>
    <i>)</i><i>;</i>
    <i>// nothing&#39;s stopping you from assigning `proc.stdin` etc. at this stage</i>
    <i>// but it won&#39;t do anything.</i>
    <i>proc</i><i>.</i><i>stdin_behavior</i> <i>=</i> <i>StdIo</i><i>.</i><i>Pipe</i><i>;</i>
    <i>proc</i><i>.</i><i>stdout_behavior</i> <i>=</i> <i>StdIo</i><i>.</i><i>Pipe</i><i>;</i>
    <i>proc</i><i>.</i><i>stderr_behavior</i> <i>=</i> <i>StdIo</i><i>.</i><i>Inherit</i><i>;</i>
    <i>try</i> <i>proc</i><i>.</i><i>spawn</i><i>(</i><i>)</i><i>;</i>

    <i>// the first argument is `SpawnConfig`, its only member right now</i>
    <i>// is `stack_size`, which defaults to 16MiB.</i>
    <i>//</i>
    <i>// the third argument is a tuple, which corresponds to the arguments of</i>
    <i>// the function you pass. the function takes a single argument which is an</i>
    <i>// anonyomus struct, hence the `.{.{}}` dance</i>
    <i>var</i> <i>copy_stdin</i> <i>=</i> <i>try</i> <i>Thread</i><i>.</i><i>spawn</i><i>(</i><i>.{</i><i>}</i><i>,</i> <i>forward</i><i>,</i> <i>.{</i><i>.{</i> <i>.</i><i>alloc</i> <i>=</i> <i>alloc</i><i>,</i> <i>.</i><i>dir</i> <i>=</i> <i>&#34;to-server&#34;</i><i>,</i> <i>.</i><i>src</i> <i>=</i> <i>std</i><i>.</i><i>io</i><i>.</i><i>getStdIn</i><i>(</i><i>)</i><i>,</i> <i>.</i><i>dst</i> <i>=</i> <i>&amp;</i><i>proc</i><i>.</i><i>stdin</i><i>.?</i><i>,</i> <i>.</i><i>close_on_eof</i> <i>=</i> <i><i>true</i></i> <i>}</i><i>}</i><i>)</i><i>;</i>
    <i>// this avoids an `expected *T but got *const T` error</i>
    <i>var</i> <i>our_stdout</i> <i>=</i> <i>std</i><i>.</i><i>io</i><i>.</i><i>getStdOut</i><i>(</i><i>)</i><i>;</i>

    <i>// close_on_eof is omitted here, so it takes the default value (which is nice)</i>
    <i>var</i> <i>copy_stdout</i> <i>=</i> <i>try</i> <i>Thread</i><i>.</i><i>spawn</i><i>(</i><i>.{</i><i>}</i><i>,</i> <i>forward</i><i>,</i> <i>.{</i><i>.{</i> <i>.</i><i>alloc</i> <i>=</i> <i>alloc</i><i>,</i> <i>.</i><i>dir</i> <i>=</i> <i>&#34;from-server&#34;</i><i>,</i> <i>.</i><i>src</i> <i>=</i> <i>proc</i><i>.</i><i>stdout</i><i>.?</i><i>,</i> <i>.</i><i>dst</i> <i>=</i> <i>&amp;</i><i>our_stdout</i> <i>}</i><i>}</i><i>)</i><i>;</i>

    <i>copy_stdin</i><i>.</i><i>join</i><i>(</i><i>)</i><i>;</i>
    <i>copy_stdout</i><i>.</i><i>join</i><i>(</i><i>)</i><i>;</i>

    <i>var</i> <i>term</i> <i>=</i> <i>try</i> <i>proc</i><i>.</i><i>wait</i><i>(</i><i>)</i><i>;</i>
    <i>// note: &#34;structs implement Debug&#34;, sort of — printing a `StringHashMap`</i>
    <i>// will make you really sad. any field that&#39;s `[]const u8` will be printed</i>
    <i>// as an array of numbers</i>
    <i>debug</i><i>(</i><i>&#34;term = {}<i>\n</i>&#34;</i><i>,</i> <i>.{</i><i>term</i><i>}</i><i>)</i><i>;</i>

    <i>try</i> <i>std</i><i>.</i><i>fs</i><i>.</i><i>cwd</i><i>(</i><i>)</i><i>.</i><i>deleteFile</i><i>(</i><i>CLEANUP_STREAMS_WORKAROUND_NAME</i><i>)</i><i>;</i>
<i>}</i>

<i>// note: `!void` means &#34;return any error or void&#34; (and then you can match on that).</i>
<i>// we could also list every possible error type we return, but it&#39;s a lot:</i>
<i>// error{AccessDenied,BadPathName,DeviceBusy,FileBusy,FileLocksNotSupported,</i>
<i>// FileNotFound,FileTooBig,InvalidHandle,InvalidUtf8,IsDir,NameTooLong,NoDevice,</i>
<i>// NoSpaceLeft,NotDir,PathAlreadyExists,PipeBusy,ProcessFdQuotaExceeded,</i>
<i>// SharingViolation,SymLinkLoop,SystemFdQuotaExceeded,SystemResources,</i>
<i>// Unexpected,WouldBlock}</i>
<i>//</i>
<i>// dst is a pointer, because we have to be able to close it _and_ replace it</i>
<i>// with a valid file descriptor, see below.</i>
<i>fn</i> <i>forward</i><i>(</i><i>args</i><i>:</i> <i>struct</i> <i>{</i> <i>alloc</i><i>:</i> <i>std</i><i>.</i>mem<i>.</i><i>Allocator</i><i>,</i> <i>dir</i><i>:</i> <i>[</i><i>]</i><i>const</i> <i>u8</i><i>,</i> <i>src</i><i>:</i> <i>File</i><i>,</i> <i>dst</i><i>:</i> <i>*</i><i>File</i><i>,</i> <i>close_on_eof</i><i>:</i> <i>bool</i> <i>=</i> <i><i>false</i></i> <i>}</i><i>)</i> <i>!</i><i>void</i> <i>{</i>
    <i>// note: no destructuring assignment, gotta keep the language small 🤷</i>
    <i>var</i> <i>alloc</i> <i>=</i> <i>args</i><i>.</i><i>alloc</i><i>;</i>
    <i>var</i> <i>src</i> <i>=</i> <i>args</i><i>.</i><i>src</i><i>;</i>
    <i>var</i> <i>dst</i> <i>=</i> <i>args</i><i>.</i><i>dst</i><i>;</i>

    <i>// note: removing the `@as` complains about something comptime related</i>
    <i>var</i> <i>msg_number</i> <i>=</i> <i>@as</i><i>(</i><i>usize</i><i>,</i> 1<i>)</i><i>;</i>
    <i>// note: try is sorta like `?` in Rust, it bubbles up any error</i>
    <i>var</i> <i>tmp</i> <i>=</i> <i>try</i> <i>std</i><i>.</i><i>fs</i><i>.</i><i>openDirAbsolute</i><i>(</i><i>&#34;/tmp&#34;</i><i>,</i> <i>.{</i><i>}</i><i>)</i><i>;</i>

    <i>// you can have tagged enums but you need to define two types</i>
    <i>const</i> <i>StageTag</i> <i>=</i> <i>enum</i> <i>{</i>
        headers<i>,</i>
        body<i>,</i>
    <i>}</i><i>;</i>
    <i>const</i> <i>Stage</i> <i>=</i> <i>union</i><i>(</i><i>StageTag</i><i>)</i> <i>{</i> headers<i>:</i> <i>void</i><i>,</i> body<i>:</i> <i>struct</i> <i>{</i>
        <i>headers</i><i>:</i> <i>std</i><i>.</i>StringHashMap<i>(</i><i>[</i><i>]</i><i>const</i> <i>u8</i><i>)</i><i>,</i>
        content_length<i>:</i> <i>usize</i><i>,</i>
    <i>}</i> <i>}</i><i>;</i>

    <i>var</i> <i>stage</i> <i>=</i> <i>Stage</i><i>{</i>
        <i>// `{}` is void, not sure why</i>
        <i>.</i><i>headers</i> <i>=</i> <i>{</i><i>}</i><i>,</i>
    <i>}</i><i>;</i>

    <i>const</i> <i>delimiter</i> <i>=</i> <i>&#34;<i>\r</i><i>\n</i><i>\r</i><i>\n</i>&#34;</i><i>;</i>
    <i>// note: intentionally starting with a small buffer to test realloc</i>
    <i>var</i> <i>buffer</i><i>:</i> <i>[</i><i>]</i><i>u8</i> <i>=</i> <i>try</i> <i>alloc</i><i>.</i><i>alloc</i><i>(</i><i>u8</i><i>,</i> 10<i>)</i><i>;</i>
    <i>// this makes me nervous, what if `buffer` is re-assigned before free-ing?</i>
    <i>// which value gets freed, the first one or the last one?</i>
    <i>defer</i> <i>alloc</i><i>.</i><i>free</i><i>(</i><i>buffer</i><i>)</i><i>;</i>

    <i>// using `@as` would&#39;ve been an option here too, not sure why</i>
    <i>// some std library code prefers `@as` to this:</i>
    <i>var</i> <i>read</i><i>:</i> <i>usize</i> <i>=</i> 0<i>;</i>

    <i>while</i> <i>(</i><i><i>true</i></i><i>)</i> <i>{</i>
        <i>debug</i><i>(</i><i>&#34;buffer is {} bytes<i>\n</i>&#34;</i><i>,</i> <i>.{</i><i>buffer</i><i>.</i><i>len</i><i>}</i><i>)</i><i>;</i>

        <i>// note: this does nothing in ReleaseFast and ReleaseSmall modes</i>
        <i>std</i><i>.</i><i>debug</i><i>.</i><i>assert</i><i>(</i><i>read</i> <i>&lt;</i> <i>buffer</i><i>.</i><i>len</i><i>)</i><i>;</i>

        <i>var</i> <i>n</i> <i>=</i> <i>try</i> <i>src</i><i>.</i><i>read</i><i>(</i><i>buffer</i><i>[</i><i>read</i><i>..</i><i>]</i><i>)</i><i>;</i>
        <i>debug</i><i>(</i><i>&#34;read {}<i>\n</i>&#34;</i><i>,</i> <i>.{</i><i>n</i><i>}</i><i>)</i><i>;</i>
        <i>if</i> <i>(</i><i>n</i> <i>==</i> 0<i>)</i> <i>{</i>
            <i>debug</i><i>(</i><i>&#34;zero-length read, probably EOF<i>\n</i>&#34;</i><i>,</i> <i>.{</i><i>}</i><i>)</i><i>;</i>
            <i>if</i> <i>(</i><i>args</i><i>.</i><i>close_on_eof</i><i>)</i> <i>{</i>
                <i>dst</i><i>.</i><i>close</i><i>(</i><i>)</i><i>;</i>
                <i>// `Process.wait` closes any stream that has StdIo.Pipe behavior,</i>
                <i>// but since we&#39;ve already closed it, it&#39;ll reach &#34;unreachable&#34;</i>
                <i>// code when it notices close returned .EBADF.</i>
                <i>// Unfortunately we really _do_ need to close it here, so we</i>
                <i>// substitute another valid file descriptor to work around this.</i>
                <i>dst</i><i>.*</i> <i>=</i> <i>try</i> <i>std</i><i>.</i><i>fs</i><i>.</i><i>cwd</i><i>(</i><i>)</i><i>.</i><i>createFile</i><i>(</i><i>CLEANUP_STREAMS_WORKAROUND_NAME</i><i>,</i> <i>.{</i><i>}</i><i>)</i><i>;</i>
            <i>}</i>
            <i>return</i><i>;</i>
        <i>}</i>
        <i>read</i> <i>+=</i> <i>n</i><i>;</i>
        <i>debug</i><i>(</i><i>&#34;{} bytes in buffer<i>\n</i>&#34;</i><i>,</i> <i>.{</i><i>read</i><i>}</i><i>)</i><i>;</i>

        <i>switch</i> <i>(</i><i>stage</i><i>)</i> <i>{</i>
            <i>StageTag</i><i>.</i><i>headers</i> <i>=&gt;</i> <i>{</i>
                <i>debug</i><i>(</i><i>&#34;Looking for CRLF<i>\n</i>&#34;</i><i>,</i> <i>.{</i><i>}</i><i>)</i><i>;</i>
                x<i>:</i> <i>{</i>
                    <i>// `orelse` unwraps optionals, going from `?T` to `T`.</i>
                    <i>// we use a labelled break to break out of this switch arm</i>
                    <i>// if we haven&#39;t found CRLF yet.</i>
                    <i>//</i>
                    <i>// we once again have to specify `u8` even though we&#39;re</i>
                    <i>// passing a `[]u8`</i>
                    <i>//</i>
                    <i>// note: `buffer[..n]` is not valid syntax, but `buffer[n..]` is.</i>
                    <i>var</i> <i>index</i> <i>=</i> <i>std</i><i>.</i><i>mem</i><i>.</i><i>indexOf</i><i>(</i><i>u8</i><i>,</i> <i>buffer</i><i>[</i>0.<i>.</i><i>n</i><i>]</i><i>,</i> <i>delimiter</i><i>)</i> <i>orelse</i> <i>break</i> <i>:</i>x<i>;</i>

                    <i>debug</i><i>(</i><i>&#34;found CRLF at {}<i>\n</i>&#34;</i><i>,</i> <i>.{</i><i>index</i><i>}</i><i>)</i><i>;</i>
                    <i>var</i> <i>msg</i> <i>=</i> <i>buffer</i><i>[</i>0.<i>.</i><i>index</i><i>]</i><i>;</i>
                    <i>debug</i><i>(</i><i>&#34;msg = {s}<i>\n</i>&#34;</i><i>,</i> <i>.{</i><i>msg</i><i>}</i><i>)</i><i>;</i>

                    <i>// this hashes keys as strings - `AutoHashMap` is very</i>
                    <i>// unhappy if you try to use it with `[]const u8` keys</i>
                    <i>var</i> <i>headers</i> <i>=</i> <i>std</i><i>.</i><i>StringHashMap</i><i>(</i><i>[</i><i>]</i><i>const</i> <i>u8</i><i>)</i><i>.</i><i>init</i><i>(</i><i>alloc</i><i>)</i><i>;</i>

                    <i>var</i> <i>splits</i> <i>=</i> <i>std</i><i>.</i><i>mem</i><i>.</i><i>split</i><i>(</i><i>u8</i><i>,</i> <i>msg</i><i>,</i> <i>&#34;<i>\r</i><i>\n</i>&#34;</i><i>)</i><i>;</i>
                    <i>while</i> <i>(</i><i>splits</i><i>.</i><i>next</i><i>(</i><i>)</i><i>)</i> <i>|</i>line<i>|</i> <i>{</i>
                        <i>var</i> <i>tokens</i> <i>=</i> <i>std</i><i>.</i><i>mem</i><i>.</i><i>split</i><i>(</i><i>u8</i><i>,</i> <i>line</i><i>,</i> <i>&#34;: &#34;</i><i>)</i><i>;</i>
                        <i>// essentially &#34;strdup&#34;, very important since there&#39;s no</i>
                        <i>// concept of ownership in zig: de/re-allocating after</i>
                        <i>// that would make the hashmap point to garbage</i>
                        <i>var</i> <i>k</i> <i>=</i> <i>try</i> <i>alloc</i><i>.</i><i>dupe</i><i>(</i><i>u8</i><i>,</i> <i>tokens</i><i>.</i><i>next</i><i>(</i><i>)</i><i>.?</i><i>)</i><i>;</i>
                        <i>var</i> <i>v</i> <i>=</i> <i>try</i> <i>alloc</i><i>.</i><i>dupe</i><i>(</i><i>u8</i><i>,</i> <i>tokens</i><i>.</i><i>next</i><i>(</i><i>)</i><i>.?</i><i>)</i><i>;</i>
                        <i>try</i> <i>headers</i><i>.</i><i>put</i><i>(</i><i>k</i><i>,</i> <i>v</i><i>)</i><i>;</i>
                    <i>}</i>

                    <i>var</i> <i>content_length_s</i> <i>=</i> <i>headers</i><i>.</i><i>get</i><i>(</i><i>&#34;Content-Length&#34;</i><i>)</i><i>.?</i><i>;</i>
                    <i>var</i> <i>content_length</i> <i>=</i> <i>try</i> <i>std</i><i>.</i><i>fmt</i><i>.</i><i>parseUnsigned</i><i>(</i><i>usize</i><i>,</i> <i>content_length_s</i><i>,</i> 10<i>)</i><i>;</i>
                    <i>debug</i><i>(</i><i>&#34;content-length = {}<i>\n</i>&#34;</i><i>,</i> <i>.{</i><i>content_length</i><i>}</i><i>)</i><i>;</i>

                    <i>// note: overlapping src/dst are fine as long as you&#39;re</i>
                    <i>// copying to the left, not to the right.</i>
                    <i>std</i><i>.</i><i>mem</i><i>.</i><i>copy</i><i>(</i><i>u8</i><i>,</i> <i>buffer</i><i>,</i> <i>buffer</i><i>[</i><i>index</i> <i>+</i> <i>delimiter</i><i>.</i><i>len</i> <i>..</i><i>]</i><i>)</i><i>;</i>
                    <i>read</i> <i>-=</i><i></i> <i>(</i><i>index</i> <i>+</i> <i>delimiter</i><i>.</i><i>len</i><i>)</i><i>;</i>

                    <i>stage</i> <i>=</i> <i>Stage</i><i>{</i>
                        <i>.</i><i>body</i> <i>=</i> <i>.{</i>
                            <i>.</i><i>headers</i> <i>=</i> <i>headers</i><i>,</i>
                            <i>.</i><i>content_length</i> <i>=</i> <i>content_length</i><i>,</i>
                        <i>}</i><i>,</i>
                    <i>}</i><i>;</i>
                <i>}</i>
            <i>}</i><i>,</i>
            <i>// note: if we used |head| we&#39;d get a copy of the struct, which means</i>
            <i>// a copy of the hashmap, which means we couldn&#39;t deinit it.</i>
            <i>StageTag</i><i>.</i><i>body</i> <i>=&gt;</i> <i>|</i><i>*</i>head<i>|</i> <i>{</i>
                <i>if</i> <i>(</i><i>read</i> <i>&gt;=</i> <i>head</i><i>.</i><i>content_length</i><i>)</i> <i>{</i>
                    <i>var</i> <i>body</i> <i>=</i> <i>buffer</i><i>[</i>0.<i>.</i><i>head</i><i>.</i><i>content_length</i><i>]</i><i>;</i>

                    <i>var</i> <i>msg_dst_path</i> <i>=</i> <i>try</i> <i>std</i><i>.</i><i>fmt</i><i>.</i><i>allocPrint</i><i>(</i><i>alloc</i><i>,</i> <i>&#34;{s}-{d:0&gt;3}.bin&#34;</i><i>,</i> <i>.{</i> <i>args</i><i>.</i><i>dir</i><i>,</i> <i>msg_number</i> <i>}</i><i>)</i><i>;</i>
                    <i>// note: unlike Go, `defer` happens at the end of the scope</i>
                    <i>// (a block is a scope, an if is a scope), not on function return</i>
                    <i>defer</i> <i>alloc</i><i>.</i><i>free</i><i>(</i><i>msg_dst_path</i><i>)</i><i>;</i>

                    <i>msg_number</i> <i>+=</i> 1<i>;</i>
                    <i>// note: this is why we opened `/tmp`, zig&#39;s stdlib is dead</i>
                    <i>// set on using `openat`.</i>
                    <i>var</i> <i>msg_dst</i> <i>=</i> <i>try</i> <i>tmp</i><i>.</i><i>createFile</i><i>(</i><i>msg_dst_path</i><i>,</i> <i>.{</i><i>}</i><i>)</i><i>;</i>
                    <i>defer</i> <i>msg_dst</i><i>.</i><i>close</i><i>(</i><i>)</i><i>;</i>

                    <i>var</i> <i>iter</i> <i>=</i> <i>head</i><i>.</i><i>headers</i><i>.</i><i>iterator</i><i>(</i><i>)</i><i>;</i>
                    <i>while</i> <i>(</i><i>iter</i><i>.</i><i>next</i><i>(</i><i>)</i><i>)</i> <i>|</i>entry<i>|</i> <i>{</i>
                        <i>debug</i><i>(</i><i>&#34;header: {s}: {s}<i>\n</i>&#34;</i><i>,</i> <i>.{</i> <i>entry</i><i>.</i><i>key_ptr</i><i>.*</i><i>,</i> <i>entry</i><i>.</i><i>value_ptr</i><i>.*</i> <i>}</i><i>)</i><i>;</i>
                        <i>var</i> <i>header_line</i> <i>=</i> <i>try</i> <i>std</i><i>.</i><i>fmt</i><i>.</i><i>allocPrint</i><i>(</i><i>alloc</i><i>,</i> <i>&#34;{s}: {s}<i>\r</i><i>\n</i>&#34;</i><i>,</i> <i>.{</i> <i>entry</i><i>.</i><i>key_ptr</i><i>.*</i><i>,</i> <i>entry</i><i>.</i><i>value_ptr</i><i>.*</i> <i>}</i><i>)</i><i>;</i>
                        <i>defer</i> <i>alloc</i><i>.</i><i>free</i><i>(</i><i>header_line</i><i>)</i><i>;</i>

                        <i>try</i> <i>dst</i><i>.</i><i>writeAll</i><i>(</i><i>header_line</i><i>)</i><i>;</i>
                        <i>try</i> <i>msg_dst</i><i>.</i><i>writeAll</i><i>(</i><i>header_line</i><i>)</i><i>;</i>
                    <i>}</i>
                    <i>try</i> <i>dst</i><i>.</i><i>writeAll</i><i>(</i><i>&#34;<i>\r</i><i>\n</i>&#34;</i><i>)</i><i>;</i>
                    <i>try</i> <i>msg_dst</i><i>.</i><i>writeAll</i><i>(</i><i>&#34;<i>\r</i><i>\n</i>&#34;</i><i>)</i><i>;</i>
                    <i>try</i> <i>dst</i><i>.</i><i>writeAll</i><i>(</i><i>body</i><i>)</i><i>;</i>
                    <i>try</i> <i>msg_dst</i><i>.</i><i>writeAll</i><i>(</i><i>body</i><i>)</i><i>;</i>

                    <i>std</i><i>.</i><i>mem</i><i>.</i><i>copy</i><i>(</i><i>u8</i><i>,</i> <i>buffer</i><i>,</i> <i>buffer</i><i>[</i><i>head</i><i>.</i><i>content_length</i><i>..</i><i>]</i><i>)</i><i>;</i>
                    <i>read</i> <i>-=</i> <i>head</i><i>.</i><i>content_length</i><i>;</i>

                    <i>var</i> <i>free_iter</i> <i>=</i> <i>head</i><i>.</i><i>headers</i><i>.</i><i>iterator</i><i>(</i><i>)</i><i>;</i>
                    <i>while</i> <i>(</i><i>free_iter</i><i>.</i><i>next</i><i>(</i><i>)</i><i>)</i> <i>|</i>entry<i>|</i> <i>{</i>
                        <i>// key/values need to be freed _before_ calling deinit</i>
                        <i>// if you remove `.*` from these, the compiler will crash</i>
                        <i>// with a monochrome message (it&#39;s usually colored)</i>
                        <i>alloc</i><i>.</i><i>free</i><i>(</i><i>entry</i><i>.</i><i>key_ptr</i><i>.*</i><i>)</i><i>;</i>
                        <i>alloc</i><i>.</i><i>free</i><i>(</i><i>entry</i><i>.</i><i>value_ptr</i><i>.*</i><i>)</i><i>;</i>
                    <i>}</i>
                    <i>head</i><i>.</i><i>headers</i><i>.</i><i>deinit</i><i>(</i><i>)</i><i>;</i>

                    <i>stage</i> <i>=</i> <i>Stage</i><i>{</i>
                        <i>.</i><i>headers</i> <i>=</i> <i>{</i><i>}</i><i>,</i>
                    <i>}</i><i>;</i>
                <i>}</i>
                <i>// otherwise keep reading</i>
            <i>}</i><i>,</i>
        <i>}</i><i></i>

        <i>if</i> <i>(</i><i>read</i> <i>&gt;=</i> <i>buffer</i><i>.</i><i>len</i><i>)</i> <i>{</i>
            <i>buffer</i> <i>=</i> <i>try</i> <i>alloc</i><i>.</i><i>realloc</i><i>(</i><i>buffer</i><i>,</i> <i>buffer</i><i>.</i><i>len</i> <i>*</i> 2<i>)</i><i>;</i>
            <i>debug</i><i>(</i><i>&#34;re-allocated buffer, new len = {}<i>\n</i>&#34;</i><i>,</i> <i>.{</i><i>buffer</i><i>.</i><i>len</i><i>}</i><i>)</i><i>;</i>
        <i>}</i>
    <i>}</i>
<i>}</i>
</pre></div>
<p>Of course we&#39;ll need a <code>build.zig</code> file too, which <code>zig init-exe</code> can generate,
this is what I got:</p>
<div translate="no"><p>Zig</p><pre data-lang="zig"><i>const</i> <i>std</i> <i>=</i> <i>@import</i><i>(</i><i>&#34;std&#34;</i><i>)</i><i>;</i>

<i>pub</i> <i>fn</i> <i>build</i><i>(</i><i>b</i><i>:</i> <i>*</i><i>std</i><i></i><i>.</i>build<i>.</i><i>Builder</i><i>)</i> void <i>{</i>
    <i>// Standard target options allows the person running `zig build` to choose</i>
    <i>// what target to build for. Here we do not override the defaults, which</i>
    <i>// means any target is allowed, and the default is native. Other options</i>
    <i>// for restricting supported target set are available.</i>
    <i>const</i> <i>target</i> <i>=</i> <i>b</i><i>.</i><i>standardTargetOptions</i><i>(</i><i>.{</i><i>}</i><i>)</i><i>;</i>

    <i>// Standard release options allow the person running `zig build` to select</i>
    <i>// between Debug, ReleaseSafe, ReleaseFast, and ReleaseSmall.</i>
    <i>const</i> <i>mode</i> <i>=</i> <i>b</i><i>.</i><i>standardReleaseOptions</i><i>(</i><i>)</i><i>;</i>

    <i>const</i> <i>exe</i> <i>=</i> <i>b</i><i>.</i><i>addExecutable</i><i>(</i><i>&#34;lsp-proxy&#34;</i><i>,</i> <i>&#34;src/main.zig&#34;</i><i>)</i><i>;</i>
    <i>exe</i><i>.</i><i>setTarget</i><i>(</i><i>target</i><i>)</i><i>;</i>
    <i>exe</i><i>.</i><i>setBuildMode</i><i>(</i><i>mode</i><i>)</i><i>;</i>
    <i>exe</i><i>.</i><i>install</i><i>(</i><i>)</i><i>;</i>

    <i>const</i> <i>run_cmd</i> <i>=</i> <i>exe</i><i>.</i><i>run</i><i>(</i><i>)</i><i>;</i>
    <i>run_cmd</i><i>.</i><i>step</i><i>.</i><i>dependOn</i><i>(</i><i>b</i><i>.</i><i>getInstallStep</i><i>(</i><i>)</i><i>)</i><i>;</i>
    <i>if</i> <i>(</i><i>b</i><i>.</i><i>args</i><i>)</i> <i>|</i>args<i>|</i> <i>{</i>
        <i>run_cmd</i><i>.</i><i>addArgs</i><i>(</i><i>args</i><i>)</i><i>;</i>
    <i>}</i>

    <i>const</i> <i>run_step</i> <i>=</i> <i>b</i><i>.</i><i>step</i><i>(</i><i>&#34;run&#34;</i><i>,</i> <i>&#34;Run the app&#34;</i><i>)</i><i>;</i>
    <i>run_step</i><i>.</i><i>dependOn</i><i>(</i><i>&amp;</i><i>run_cmd</i><i>.</i><i>step</i><i>)</i><i>;</i>

    <i>const</i> <i>exe_tests</i> <i>=</i> <i>b</i><i>.</i><i>addTest</i><i>(</i><i>&#34;src/main.zig&#34;</i><i>)</i><i>;</i>
    <i>exe_tests</i><i>.</i><i>setTarget</i><i>(</i><i>target</i><i>)</i><i>;</i>
    <i>exe_tests</i><i>.</i><i>setBuildMode</i><i>(</i><i>mode</i><i>)</i><i>;</i>

    <i>const</i> <i>test_step</i> <i>=</i> <i>b</i><i>.</i><i>step</i><i>(</i><i>&#34;test&#34;</i><i>,</i> <i>&#34;Run unit tests&#34;</i><i>)</i><i>;</i>
    <i>test_step</i><i>.</i><i>dependOn</i><i>(</i><i>&amp;</i><i>exe_tests</i><i>.</i><i>step</i><i>)</i><i>;</i>
<i>}</i>
</pre></div>
<p>We can then make a <code>ReleaseFast</code> build:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ time zig build -Drelease-fast
zig build -Drelease-fast  6.30s user 0.32s system 101% cpu 6.551 total
</pre></div>
<p>And drop it inside <code>~/.cargo/bin</code>:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ cp zig-out/bin/lsp-proxy ~/.cargo/bin/rust-analyzer
</pre></div>
<p>Now, if we run emacs again, and try to insert the emoji, we can see what
happens because each message is dumped as <code>/tmp/from-server-XXX.bin</code> and
<code>/tmp/to-server-XXX.bin</code>.</p>
<p>Here&#39;s the first message emacs/lsp-mode sends to rust-analyzer:</p>
<div translate="no"><pre data-lang="">Content-Length: 4467

{&#34;jsonrpc&#34;:&#34;2.0&#34;,&#34;method&#34;:&#34;initialize&#34;,&#34;params&#34;:{&#34;processId&#34;:252882,&#34;rootPath&#34;:&#34;/home/amos/bearcove/bottom&#34;,&#34;clientInfo&#34;:{&#34;name&#34;:&#34;emacs&#34;,&#34;version&#34;:&#34;GNU Emacs 27.1 (build 1, x86_64-pc-linux-gnu, GTK+ Version 3.24.30, cairo version 1.16.0)\n of 2022-01-24, modified by Debian&#34;},&#34;rootUri&#34;:&#34;file:///home/amos/bearcove/bottom&#34;,&#34;capabilities&#34;:{&#34;workspace&#34;:{&#34;workspaceEdit&#34;:{&#34;documentChanges&#34;:true,&#34;resourceOperations&#34;:[&#34;create&#34;,&#34;rename&#34;,&#34;delete&#34;]},&#34;applyEdit&#34;:true,&#34;symbol&#34;:{&#34;symbolKind&#34;:{&#34;valueSet&#34;:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26]}},&#34;executeCommand&#34;:{&#34;dynamicRegistration&#34;:false},&#34;didChangeWatchedFiles&#34;:{&#34;dynamicRegistration&#34;:true},&#34;workspaceFolders&#34;:true,&#34;configuration&#34;:true,&#34;codeLens&#34;:{&#34;refreshSupport&#34;:true},&#34;fileOperations&#34;:{&#34;didCreate&#34;:false,&#34;willCreate&#34;:false,&#34;didRename&#34;:true,&#34;willRename&#34;:true,&#34;didDelete&#34;:false,&#34;willDelete&#34;:false}},&#34;textDocument&#34;:{&#34;declaration&#34;:{&#34;dynamicRegistration&#34;:true,&#34;linkSupport&#34;:true},&#34;definition&#34;:{&#34;dynamicRegistration&#34;:true,&#34;linkSupport&#34;:true},&#34;references&#34;:{&#34;dynamicRegistration&#34;:true},&#34;implementation&#34;:{&#34;dynamicRegistration&#34;:true,&#34;linkSupport&#34;:true},&#34;typeDefinition&#34;:{&#34;dynamicRegistration&#34;:true,&#34;linkSupport&#34;:true},&#34;synchronization&#34;:{&#34;willSave&#34;:true,&#34;didSave&#34;:true,&#34;willSaveWaitUntil&#34;:true},&#34;documentSymbol&#34;:{&#34;symbolKind&#34;:{&#34;valueSet&#34;:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26]},&#34;hierarchicalDocumentSymbolSupport&#34;:true},&#34;formatting&#34;:{&#34;dynamicRegistration&#34;:true},&#34;rangeFormatting&#34;:{&#34;dynamicRegistration&#34;:true},&#34;onTypeFormatting&#34;:{&#34;dynamicRegistration&#34;:true},&#34;rename&#34;:{&#34;dynamicRegistration&#34;:true,&#34;prepareSupport&#34;:true},&#34;codeAction&#34;:{&#34;dynamicRegistration&#34;:true,&#34;isPreferredSupport&#34;:true,&#34;codeActionLiteralSupport&#34;:{&#34;codeActionKind&#34;:{&#34;valueSet&#34;:[&#34;&#34;,&#34;quickfix&#34;,&#34;refactor&#34;,&#34;refactor.extract&#34;,&#34;refactor.inline&#34;,&#34;refactor.rewrite&#34;,&#34;source&#34;,&#34;source.organizeImports&#34;]}},&#34;resolveSupport&#34;:{&#34;properties&#34;:[&#34;edit&#34;,&#34;command&#34;]},&#34;dataSupport&#34;:true},&#34;completion&#34;:{&#34;completionItem&#34;:{&#34;snippetSupport&#34;:false,&#34;documentationFormat&#34;:[&#34;markdown&#34;,&#34;plaintext&#34;],&#34;resolveAdditionalTextEditsSupport&#34;:true,&#34;insertReplaceSupport&#34;:true,&#34;deprecatedSupport&#34;:true,&#34;resolveSupport&#34;:{&#34;properties&#34;:[&#34;documentation&#34;,&#34;detail&#34;,&#34;additionalTextEdits&#34;,&#34;command&#34;]},&#34;insertTextModeSupport&#34;:{&#34;valueSet&#34;:[1,2]}},&#34;contextSupport&#34;:true,&#34;dynamicRegistration&#34;:true},&#34;signatureHelp&#34;:{&#34;signatureInformation&#34;:{&#34;parameterInformation&#34;:{&#34;labelOffsetSupport&#34;:true}},&#34;dynamicRegistration&#34;:true},&#34;documentLink&#34;:{&#34;dynamicRegistration&#34;:true,&#34;tooltipSupport&#34;:true},&#34;hover&#34;:{&#34;contentFormat&#34;:[&#34;markdown&#34;,&#34;plaintext&#34;],&#34;dynamicRegistration&#34;:true},&#34;foldingRange&#34;:{&#34;dynamicRegistration&#34;:true},&#34;selectionRange&#34;:{&#34;dynamicRegistration&#34;:true},&#34;callHierarchy&#34;:{&#34;dynamicRegistration&#34;:false},&#34;typeHierarchy&#34;:{&#34;dynamicRegistration&#34;:true},&#34;publishDiagnostics&#34;:{&#34;relatedInformation&#34;:true,&#34;tagSupport&#34;:{&#34;valueSet&#34;:[1,2]},&#34;versionSupport&#34;:true},&#34;linkedEditingRange&#34;:{&#34;dynamicRegistration&#34;:true}},&#34;window&#34;:{&#34;workDoneProgress&#34;:true,&#34;showDocument&#34;:{&#34;support&#34;:true}},&#34;experimental&#34;:{&#34;snippetTextEdit&#34;:null}},&#34;initializationOptions&#34;:{&#34;diagnostics&#34;:{&#34;enable&#34;:true,&#34;enableExperimental&#34;:false,&#34;disabled&#34;:[],&#34;warningsAsHint&#34;:[],&#34;warningsAsInfo&#34;:[]},&#34;imports&#34;:{&#34;granularity&#34;:{&#34;enforce&#34;:false,&#34;group&#34;:&#34;crate&#34;},&#34;group&#34;:true,&#34;merge&#34;:{&#34;glob&#34;:true},&#34;prefix&#34;:&#34;plain&#34;},&#34;lruCapacity&#34;:null,&#34;checkOnSave&#34;:{&#34;enable&#34;:true,&#34;command&#34;:&#34;clippy&#34;,&#34;extraArgs&#34;:[],&#34;features&#34;:[],&#34;overrideCommand&#34;:[]},&#34;files&#34;:{&#34;exclude&#34;:[],&#34;watcher&#34;:&#34;client&#34;,&#34;excludeDirs&#34;:[]},&#34;cargo&#34;:{&#34;allFeatures&#34;:false,&#34;noDefaultFeatures&#34;:false,&#34;features&#34;:[],&#34;target&#34;:null,&#34;runBuildScripts&#34;:true,&#34;loadOutDirsFromCheck&#34;:true,&#34;autoreload&#34;:true,&#34;useRustcWrapperForBuildScripts&#34;:true,&#34;unsetTest&#34;:[]},&#34;rustfmt&#34;:{&#34;extraArgs&#34;:[],&#34;overrideCommand&#34;:[],&#34;rangeFormatting&#34;:{&#34;enable&#34;:false}},&#34;inlayHints&#34;:{&#34;bindingModeHints&#34;:false,&#34;chainingHints&#34;:false,&#34;closingBraceHints&#34;:{&#34;enable&#34;:true,&#34;minLines&#34;:25},&#34;closureReturnTypeHints&#34;:false,&#34;lifetimeElisionHints&#34;:{&#34;enable&#34;:&#34;never&#34;,&#34;useParameterNames&#34;:false},&#34;maxLength&#34;:null,&#34;parameterHints&#34;:false,&#34;reborrowHints&#34;:&#34;never&#34;,&#34;renderColons&#34;:true,&#34;typeHints&#34;:{&#34;enable&#34;:true,&#34;hideClosureInitialization&#34;:false,&#34;hideNamedConstructor&#34;:false}},&#34;completion&#34;:{&#34;addCallParenthesis&#34;:true,&#34;addCallArgumentSnippets&#34;:true,&#34;postfix&#34;:{&#34;enable&#34;:true},&#34;autoimport&#34;:{&#34;enable&#34;:true},&#34;autoself&#34;:{&#34;enable&#34;:true}},&#34;callInfo&#34;:{&#34;full&#34;:true},&#34;procMacro&#34;:{&#34;enable&#34;:true},&#34;rustcSource&#34;:null,&#34;linkedProjects&#34;:[],&#34;highlighting&#34;:{&#34;strings&#34;:true},&#34;experimental&#34;:{&#34;procAttrMacros&#34;:true}},&#34;workDoneToken&#34;:&#34;1&#34;},&#34;id&#34;:1}
</pre></div>
<p>Interestingly, instead of going for newline-separated JSON, LSP goes for an
<a href="https://httpwg.org/specs/rfc9112.html#message.format">HTTP/1.1</a>-like protocol,
with a header section. I don&#39;t love this, but nobody asked.</p>
<p>One long line isn&#39;t very readable, I&#39;ve prettified the JSON for you:</p>
<div translate="no"><p>JSON</p><pre data-lang="json"><i>{</i>
  <i>&#34;jsonrpc&#34;</i>: <i>&#34;2.0&#34;</i><i>,</i>
  <i>&#34;method&#34;</i>: <i>&#34;initialize&#34;</i><i>,</i>
  <i>&#34;params&#34;</i>: <i>{</i>
    <i>&#34;processId&#34;</i>: 252882<i>,</i>
    <i>&#34;rootPath&#34;</i>: <i>&#34;/home/amos/bearcove/bottom&#34;</i><i>,</i>
    <i>&#34;clientInfo&#34;</i>: <i>{</i>
      <i>&#34;name&#34;</i>: <i>&#34;emacs&#34;</i><i>,</i>
      <i>&#34;version&#34;</i>: <i>&#34;GNU Emacs 27.1 (build 1, x86_64-pc-linux-gnu, GTK+ Version 3.24.30, cairo version 1.16.0)\n of 2022-01-24, modified by Debian&#34;</i>
    <i>}</i><i>,</i>
    <i>&#34;rootUri&#34;</i>: <i>&#34;file:///home/amos/bearcove/bottom&#34;</i><i>,</i>
    <i>&#34;capabilities&#34;</i>: <i>{</i>
      <i>&#34;workspace&#34;</i>: <i>{</i>
        <i>&#34;workspaceEdit&#34;</i>: <i>{</i>
          <i>&#34;documentChanges&#34;</i>: <i>true</i><i>,</i>
          <i>&#34;resourceOperations&#34;</i>: <i>[</i>
            <i>&#34;create&#34;</i><i>,</i>
            <i>&#34;rename&#34;</i><i>,</i>
            <i>&#34;delete&#34;</i>
          <i>]</i>
        <i>}</i><i>,</i>
        <i>&#34;applyEdit&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;symbol&#34;</i>: <i>{</i>
          <i>&#34;symbolKind&#34;</i>: <i>{</i>
            <i>&#34;valueSet&#34;</i>: <i>[</i>
              1<i>,</i>
              2<i>,</i>
              3<i>,</i>
              4<i>,</i>
              5<i>,</i>
              6<i>,</i>
              7<i>,</i>
              8<i>,</i>
              9<i>,</i>
              10<i>,</i>
              11<i>,</i>
              12<i>,</i>
              13<i>,</i>
              14<i>,</i>
              15<i>,</i>
              16<i>,</i>
              17<i>,</i>
              18<i>,</i>
              19<i>,</i>
              20<i>,</i>
              21<i>,</i>
              22<i>,</i>
              23<i>,</i>
              24<i>,</i>
              25<i>,</i>
              26
            <i>]</i>
          <i>}</i>
        <i>}</i><i>,</i>
        <i>&#34;executeCommand&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>false</i>
        <i>}</i><i>,</i>
        <i>&#34;didChangeWatchedFiles&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;workspaceFolders&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;configuration&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;codeLens&#34;</i>: <i>{</i>
          <i>&#34;refreshSupport&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;fileOperations&#34;</i>: <i>{</i>
          <i>&#34;didCreate&#34;</i>: <i>false</i><i>,</i>
          <i>&#34;willCreate&#34;</i>: <i>false</i><i>,</i>
          <i>&#34;didRename&#34;</i>: <i>true</i><i>,</i>
          <i>&#34;willRename&#34;</i>: <i>true</i><i>,</i>
          <i>&#34;didDelete&#34;</i>: <i>false</i><i>,</i>
          <i>&#34;willDelete&#34;</i>: <i>false</i>
        <i>}</i>
      <i>}</i><i>,</i>
      <i>&#34;textDocument&#34;</i>: <i>{</i>
        <i>&#34;declaration&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i><i>,</i>
          <i>&#34;linkSupport&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;definition&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i><i>,</i>
          <i>&#34;linkSupport&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;references&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;implementation&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i><i>,</i>
          <i>&#34;linkSupport&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;typeDefinition&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i><i>,</i>
          <i>&#34;linkSupport&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;synchronization&#34;</i>: <i>{</i>
          <i>&#34;willSave&#34;</i>: <i>true</i><i>,</i>
          <i>&#34;didSave&#34;</i>: <i>true</i><i>,</i>
          <i>&#34;willSaveWaitUntil&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;documentSymbol&#34;</i>: <i>{</i>
          <i>&#34;symbolKind&#34;</i>: <i>{</i>
            <i>&#34;valueSet&#34;</i>: <i>[</i>
              1<i>,</i>
              2<i>,</i>
              3<i>,</i>
              4<i>,</i>
              5<i>,</i>
              6<i>,</i>
              7<i>,</i>
              8<i>,</i>
              9<i>,</i>
              10<i>,</i>
              11<i>,</i>
              12<i>,</i>
              13<i>,</i>
              14<i>,</i>
              15<i>,</i>
              16<i>,</i>
              17<i>,</i>
              18<i>,</i>
              19<i>,</i>
              20<i>,</i>
              21<i>,</i>
              22<i>,</i>
              23<i>,</i>
              24<i>,</i>
              25<i>,</i>
              26
            <i>]</i>
          <i>}</i><i>,</i>
          <i>&#34;hierarchicalDocumentSymbolSupport&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;formatting&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;rangeFormatting&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;onTypeFormatting&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;rename&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i><i>,</i>
          <i>&#34;prepareSupport&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;codeAction&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i><i>,</i>
          <i>&#34;isPreferredSupport&#34;</i>: <i>true</i><i>,</i>
          <i>&#34;codeActionLiteralSupport&#34;</i>: <i>{</i>
            <i>&#34;codeActionKind&#34;</i>: <i>{</i>
              <i>&#34;valueSet&#34;</i>: <i>[</i>
                <i>&#34;&#34;</i><i>,</i>
                <i>&#34;quickfix&#34;</i><i>,</i>
                <i>&#34;refactor&#34;</i><i>,</i>
                <i>&#34;refactor.extract&#34;</i><i>,</i>
                <i>&#34;refactor.inline&#34;</i><i>,</i>
                <i>&#34;refactor.rewrite&#34;</i><i>,</i>
                <i>&#34;source&#34;</i><i>,</i>
                <i>&#34;source.organizeImports&#34;</i>
              <i>]</i>
            <i>}</i>
          <i>}</i><i>,</i>
          <i>&#34;resolveSupport&#34;</i>: <i>{</i>
            <i>&#34;properties&#34;</i>: <i>[</i>
              <i>&#34;edit&#34;</i><i>,</i>
              <i>&#34;command&#34;</i>
            <i>]</i>
          <i>}</i><i>,</i>
          <i>&#34;dataSupport&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;completion&#34;</i>: <i>{</i>
          <i>&#34;completionItem&#34;</i>: <i>{</i>
            <i>&#34;snippetSupport&#34;</i>: <i>false</i><i>,</i>
            <i>&#34;documentationFormat&#34;</i>: <i>[</i>
              <i>&#34;markdown&#34;</i><i>,</i>
              <i>&#34;plaintext&#34;</i>
            <i>]</i><i>,</i>
            <i>&#34;resolveAdditionalTextEditsSupport&#34;</i>: <i>true</i><i>,</i>
            <i>&#34;insertReplaceSupport&#34;</i>: <i>true</i><i>,</i>
            <i>&#34;deprecatedSupport&#34;</i>: <i>true</i><i>,</i>
            <i>&#34;resolveSupport&#34;</i>: <i>{</i>
              <i>&#34;properties&#34;</i>: <i>[</i>
                <i>&#34;documentation&#34;</i><i>,</i>
                <i>&#34;detail&#34;</i><i>,</i>
                <i>&#34;additionalTextEdits&#34;</i><i>,</i>
                <i>&#34;command&#34;</i>
              <i>]</i>
            <i>}</i><i>,</i>
            <i>&#34;insertTextModeSupport&#34;</i>: <i>{</i>
              <i>&#34;valueSet&#34;</i>: <i>[</i>
                1<i>,</i>
                2
              <i>]</i>
            <i>}</i>
          <i>}</i><i>,</i>
          <i>&#34;contextSupport&#34;</i>: <i>true</i><i>,</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;signatureHelp&#34;</i>: <i>{</i>
          <i>&#34;signatureInformation&#34;</i>: <i>{</i>
            <i>&#34;parameterInformation&#34;</i>: <i>{</i>
              <i>&#34;labelOffsetSupport&#34;</i>: <i>true</i>
            <i>}</i>
          <i>}</i><i>,</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;documentLink&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i><i>,</i>
          <i>&#34;tooltipSupport&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;hover&#34;</i>: <i>{</i>
          <i>&#34;contentFormat&#34;</i>: <i>[</i>
            <i>&#34;markdown&#34;</i><i>,</i>
            <i>&#34;plaintext&#34;</i>
          <i>]</i><i>,</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;foldingRange&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;selectionRange&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;callHierarchy&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>false</i>
        <i>}</i><i>,</i>
        <i>&#34;typeHierarchy&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;publishDiagnostics&#34;</i>: <i>{</i>
          <i>&#34;relatedInformation&#34;</i>: <i>true</i><i>,</i>
          <i>&#34;tagSupport&#34;</i>: <i>{</i>
            <i>&#34;valueSet&#34;</i>: <i>[</i>
              1<i>,</i>
              2
            <i>]</i>
          <i>}</i><i>,</i>
          <i>&#34;versionSupport&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;linkedEditingRange&#34;</i>: <i>{</i>
          <i>&#34;dynamicRegistration&#34;</i>: <i>true</i>
        <i>}</i>
      <i>}</i><i>,</i>
      <i>&#34;window&#34;</i>: <i>{</i>
        <i>&#34;workDoneProgress&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;showDocument&#34;</i>: <i>{</i>
          <i>&#34;support&#34;</i>: <i>true</i>
        <i>}</i>
      <i>}</i><i>,</i>
      <i>&#34;experimental&#34;</i>: <i>{</i>
        <i>&#34;snippetTextEdit&#34;</i>: <i>null</i>
      <i>}</i>
    <i>}</i><i>,</i>
    <i>&#34;initializationOptions&#34;</i>: <i>{</i>
      <i>&#34;diagnostics&#34;</i>: <i>{</i>
        <i>&#34;enable&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;enableExperimental&#34;</i>: <i>false</i><i>,</i>
        <i>&#34;disabled&#34;</i>: <i>[</i>
          
        <i>]</i><i>,</i>
        <i>&#34;warningsAsHint&#34;</i>: <i>[</i>
          
        <i>]</i><i>,</i>
        <i>&#34;warningsAsInfo&#34;</i>: <i>[</i>
          
        <i>]</i>
      <i>}</i><i>,</i>
      <i>&#34;imports&#34;</i>: <i>{</i>
        <i>&#34;granularity&#34;</i>: <i>{</i>
          <i>&#34;enforce&#34;</i>: <i>false</i><i>,</i>
          <i>&#34;group&#34;</i>: <i>&#34;crate&#34;</i>
        <i>}</i><i>,</i>
        <i>&#34;group&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;merge&#34;</i>: <i>{</i>
          <i>&#34;glob&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;prefix&#34;</i>: <i>&#34;plain&#34;</i>
      <i>}</i><i>,</i>
      <i>&#34;lruCapacity&#34;</i>: <i>null</i><i>,</i>
      <i>&#34;checkOnSave&#34;</i>: <i>{</i>
        <i>&#34;enable&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;command&#34;</i>: <i>&#34;clippy&#34;</i><i>,</i>
        <i>&#34;extraArgs&#34;</i>: <i>[</i>
          
        <i>]</i><i>,</i>
        <i>&#34;features&#34;</i>: <i>[</i>
          
        <i>]</i><i>,</i>
        <i>&#34;overrideCommand&#34;</i>: <i>[</i>
          
        <i>]</i>
      <i>}</i><i>,</i>
      <i>&#34;files&#34;</i>: <i>{</i>
        <i>&#34;exclude&#34;</i>: <i>[</i>
          
        <i>]</i><i>,</i>
        <i>&#34;watcher&#34;</i>: <i>&#34;client&#34;</i><i>,</i>
        <i>&#34;excludeDirs&#34;</i>: <i>[</i>
          
        <i>]</i>
      <i>}</i><i>,</i>
      <i>&#34;cargo&#34;</i>: <i>{</i>
        <i>&#34;allFeatures&#34;</i>: <i>false</i><i>,</i>
        <i>&#34;noDefaultFeatures&#34;</i>: <i>false</i><i>,</i>
        <i>&#34;features&#34;</i>: <i>[</i>
          
        <i>]</i><i>,</i>
        <i>&#34;target&#34;</i>: <i>null</i><i>,</i>
        <i>&#34;runBuildScripts&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;loadOutDirsFromCheck&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;autoreload&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;useRustcWrapperForBuildScripts&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;unsetTest&#34;</i>: <i>[</i>
          
        <i>]</i>
      <i>}</i><i>,</i>
      <i>&#34;rustfmt&#34;</i>: <i>{</i>
        <i>&#34;extraArgs&#34;</i>: <i>[</i>
          
        <i>]</i><i>,</i>
        <i>&#34;overrideCommand&#34;</i>: <i>[</i>
          
        <i>]</i><i>,</i>
        <i>&#34;rangeFormatting&#34;</i>: <i>{</i>
          <i>&#34;enable&#34;</i>: <i>false</i>
        <i>}</i>
      <i>}</i><i>,</i>
      <i>&#34;inlayHints&#34;</i>: <i>{</i>
        <i>&#34;bindingModeHints&#34;</i>: <i>false</i><i>,</i>
        <i>&#34;chainingHints&#34;</i>: <i>false</i><i>,</i>
        <i>&#34;closingBraceHints&#34;</i>: <i>{</i>
          <i>&#34;enable&#34;</i>: <i>true</i><i>,</i>
          <i>&#34;minLines&#34;</i>: 25
        <i>}</i><i>,</i>
        <i>&#34;closureReturnTypeHints&#34;</i>: <i>false</i><i>,</i>
        <i>&#34;lifetimeElisionHints&#34;</i>: <i>{</i>
          <i>&#34;enable&#34;</i>: <i>&#34;never&#34;</i><i>,</i>
          <i>&#34;useParameterNames&#34;</i>: <i>false</i>
        <i>}</i><i>,</i>
        <i>&#34;maxLength&#34;</i>: <i>null</i><i>,</i>
        <i>&#34;parameterHints&#34;</i>: <i>false</i><i>,</i>
        <i>&#34;reborrowHints&#34;</i>: <i>&#34;never&#34;</i><i>,</i>
        <i>&#34;renderColons&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;typeHints&#34;</i>: <i>{</i>
          <i>&#34;enable&#34;</i>: <i>true</i><i>,</i>
          <i>&#34;hideClosureInitialization&#34;</i>: <i>false</i><i>,</i>
          <i>&#34;hideNamedConstructor&#34;</i>: <i>false</i>
        <i>}</i>
      <i>}</i><i>,</i>
      <i>&#34;completion&#34;</i>: <i>{</i>
        <i>&#34;addCallParenthesis&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;addCallArgumentSnippets&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;postfix&#34;</i>: <i>{</i>
          <i>&#34;enable&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;autoimport&#34;</i>: <i>{</i>
          <i>&#34;enable&#34;</i>: <i>true</i>
        <i>}</i><i>,</i>
        <i>&#34;autoself&#34;</i>: <i>{</i>
          <i>&#34;enable&#34;</i>: <i>true</i>
        <i>}</i>
      <i>}</i><i>,</i>
      <i>&#34;callInfo&#34;</i>: <i>{</i>
        <i>&#34;full&#34;</i>: <i>true</i>
      <i>}</i><i>,</i>
      <i>&#34;procMacro&#34;</i>: <i>{</i>
        <i>&#34;enable&#34;</i>: <i>true</i>
      <i>}</i><i>,</i>
      <i>&#34;rustcSource&#34;</i>: <i>null</i><i>,</i>
      <i>&#34;linkedProjects&#34;</i>: <i>[</i>
        
      <i>]</i><i>,</i>
      <i>&#34;highlighting&#34;</i>: <i>{</i>
        <i>&#34;strings&#34;</i>: <i>true</i>
      <i>}</i><i>,</i>
      <i>&#34;experimental&#34;</i>: <i>{</i>
        <i>&#34;procAttrMacros&#34;</i>: <i>true</i>
      <i>}</i>
    <i>}</i><i>,</i>
    <i>&#34;workDoneToken&#34;</i>: <i>&#34;1&#34;</i>
  <i>}</i><i>,</i>
  <i>&#34;id&#34;</i>: 1
<i>}</i>
</pre></div>
<p>Good job on scrolling down all that way! Take a second to catch your breath.</p>
<p>You can check the <a href="https://www.jsonrpc.org/specification">JSON-RPC 2.0 spec</a> if
you&#39;re curious about the request/response coating we have here, but mostly,
yeah, the client is announcing capabilities to the server, and passing some
cargo/rustfmt specific config.</p>
<p>They even have a user-agent! (<code>clientInfo.version</code>).</p>
<p>Similarly, the server responds with its own capabilities:</p>
<div translate="no"><p>JSON</p><pre data-lang="json"><i>{</i>
  <i>&#34;jsonrpc&#34;</i>: <i>&#34;2.0&#34;</i><i>,</i>
  <i>&#34;id&#34;</i>: 1<i>,</i>
  <i>&#34;result&#34;</i>: <i>{</i>
    <i>&#34;capabilities&#34;</i>: <i>{</i>
      <i>&#34;textDocumentSync&#34;</i>: <i>{</i>
        <i>&#34;openClose&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;change&#34;</i>: 2<i>,</i>
        <i>&#34;save&#34;</i>: <i>{</i>
          
        <i>}</i>
      <i>}</i><i>,</i>
      <i>&#34;selectionRangeProvider&#34;</i>: <i>true</i><i>,</i>
      <i>&#34;hoverProvider&#34;</i>: <i>true</i><i>,</i>
      <i>&#34;completionProvider&#34;</i>: <i>{</i>
        <i>&#34;resolveProvider&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;triggerCharacters&#34;</i>: <i>[</i>
          <i>&#34;:&#34;</i><i>,</i>
          <i>&#34;.&#34;</i><i>,</i>
          <i>&#34;&#39;&#34;</i><i>,</i>
          <i>&#34;(&#34;</i>
        <i>]</i><i>,</i>
        <i>&#34;completionItem&#34;</i>: <i>{</i>
          <i>&#34;labelDetailsSupport&#34;</i>: <i>false</i>
        <i>}</i>
      <i>}</i><i>,</i>
      <i>&#34;signatureHelpProvider&#34;</i>: <i>{</i>
        <i>&#34;triggerCharacters&#34;</i>: <i>[</i>
          <i>&#34;(&#34;</i><i>,</i>
          <i>&#34;,&#34;</i><i>,</i>
          <i>&#34;&lt;&#34;</i>
        <i>]</i>
      <i>}</i><i>,</i>
      <i>&#34;definitionProvider&#34;</i>: <i>true</i><i>,</i>
      <i>&#34;typeDefinitionProvider&#34;</i>: <i>true</i><i>,</i>
      <i>&#34;implementationProvider&#34;</i>: <i>true</i><i>,</i>
      <i>&#34;referencesProvider&#34;</i>: <i>true</i><i>,</i>
      <i>&#34;documentHighlightProvider&#34;</i>: <i>true</i><i>,</i>
      <i>&#34;documentSymbolProvider&#34;</i>: <i>true</i><i>,</i>
      <i>&#34;workspaceSymbolProvider&#34;</i>: <i>true</i><i>,</i>
      <i>&#34;codeActionProvider&#34;</i>: <i>{</i>
        <i>&#34;codeActionKinds&#34;</i>: <i>[</i>
          <i>&#34;&#34;</i><i>,</i>
          <i>&#34;quickfix&#34;</i><i>,</i>
          <i>&#34;refactor&#34;</i><i>,</i>
          <i>&#34;refactor.extract&#34;</i><i>,</i>
          <i>&#34;refactor.inline&#34;</i><i>,</i>
          <i>&#34;refactor.rewrite&#34;</i>
        <i>]</i><i>,</i>
        <i>&#34;resolveProvider&#34;</i>: <i>true</i>
      <i>}</i><i>,</i>
      <i>&#34;codeLensProvider&#34;</i>: <i>{</i>
        <i>&#34;resolveProvider&#34;</i>: <i>true</i>
      <i>}</i><i>,</i>
      <i>&#34;documentFormattingProvider&#34;</i>: <i>true</i><i>,</i>
      <i>&#34;documentRangeFormattingProvider&#34;</i>: <i>false</i><i>,</i>
      <i>&#34;documentOnTypeFormattingProvider&#34;</i>: <i>{</i>
        <i>&#34;firstTriggerCharacter&#34;</i>: <i>&#34;=&#34;</i><i>,</i>
        <i>&#34;moreTriggerCharacter&#34;</i>: <i>[</i>
          <i>&#34;.&#34;</i><i>,</i>
          <i>&#34;&gt;&#34;</i><i>,</i>
          <i>&#34;{&#34;</i>
        <i>]</i>
      <i>}</i><i>,</i>
      <i>&#34;renameProvider&#34;</i>: <i>{</i>
        <i>&#34;prepareProvider&#34;</i>: <i>true</i>
      <i>}</i><i>,</i>
      <i>&#34;foldingRangeProvider&#34;</i>: <i>true</i><i>,</i>
      <i>&#34;declarationProvider&#34;</i>: <i>true</i><i>,</i>
      <i>&#34;workspace&#34;</i>: <i>{</i>
        <i>&#34;fileOperations&#34;</i>: <i>{</i>
          <i>&#34;willRename&#34;</i>: <i>{</i>
            <i>&#34;filters&#34;</i>: <i>[</i>
              <i>{</i>
                <i>&#34;scheme&#34;</i>: <i>&#34;file&#34;</i><i>,</i>
                <i>&#34;pattern&#34;</i>: <i>{</i>
                  <i>&#34;glob&#34;</i>: <i>&#34;**/*.rs&#34;</i><i>,</i>
                  <i>&#34;matches&#34;</i>: <i>&#34;file&#34;</i>
                <i>}</i>
              <i>}</i><i>,</i>
              <i>{</i>
                <i>&#34;scheme&#34;</i>: <i>&#34;file&#34;</i><i>,</i>
                <i>&#34;pattern&#34;</i>: <i>{</i>
                  <i>&#34;glob&#34;</i>: <i>&#34;**&#34;</i><i>,</i>
                  <i>&#34;matches&#34;</i>: <i>&#34;folder&#34;</i>
                <i>}</i>
              <i>}</i>
            <i>]</i>
          <i>}</i>
        <i>}</i>
      <i>}</i><i>,</i>
      <i>&#34;callHierarchyProvider&#34;</i>: <i>true</i><i>,</i>
      <i>&#34;semanticTokensProvider&#34;</i>: <i>{</i>
        <i>&#34;legend&#34;</i>: <i>{</i>
          <i>&#34;tokenTypes&#34;</i>: <i>[</i>
            <i>&#34;comment&#34;</i><i>,</i>
            <i>&#34;decorator&#34;</i><i>,</i>
            <i>&#34;enumMember&#34;</i><i>,</i>
            <i>&#34;enum&#34;</i><i>,</i>
            <i>&#34;function&#34;</i><i>,</i>
            <i>&#34;interface&#34;</i><i>,</i>
            <i>&#34;keyword&#34;</i><i>,</i>
            <i>&#34;macro&#34;</i><i>,</i>
            <i>&#34;method&#34;</i><i>,</i>
            <i>&#34;namespace&#34;</i><i>,</i>
            <i>&#34;number&#34;</i><i>,</i>
            <i>&#34;operator&#34;</i><i>,</i>
            <i>&#34;parameter&#34;</i><i>,</i>
            <i>&#34;property&#34;</i><i>,</i>
            <i>&#34;string&#34;</i><i>,</i>
            <i>&#34;struct&#34;</i><i>,</i>
            <i>&#34;typeParameter&#34;</i><i>,</i>
            <i>&#34;variable&#34;</i><i>,</i>
            <i>&#34;angle&#34;</i><i>,</i>
            <i>&#34;arithmetic&#34;</i><i>,</i>
            <i>&#34;attribute&#34;</i><i>,</i>
            <i>&#34;attributeBracket&#34;</i><i>,</i>
            <i>&#34;bitwise&#34;</i><i>,</i>
            <i>&#34;boolean&#34;</i><i>,</i>
            <i>&#34;brace&#34;</i><i>,</i>
            <i>&#34;bracket&#34;</i><i>,</i>
            <i>&#34;builtinAttribute&#34;</i><i>,</i>
            <i>&#34;builtinType&#34;</i><i>,</i>
            <i>&#34;character&#34;</i><i>,</i>
            <i>&#34;colon&#34;</i><i>,</i>
            <i>&#34;comma&#34;</i><i>,</i>
            <i>&#34;comparison&#34;</i><i>,</i>
            <i>&#34;constParameter&#34;</i><i>,</i>
            <i>&#34;derive&#34;</i><i>,</i>
            <i>&#34;deriveHelper&#34;</i><i>,</i>
            <i>&#34;dot&#34;</i><i>,</i>
            <i>&#34;escapeSequence&#34;</i><i>,</i>
            <i>&#34;formatSpecifier&#34;</i><i>,</i>
            <i>&#34;generic&#34;</i><i>,</i>
            <i>&#34;label&#34;</i><i>,</i>
            <i>&#34;lifetime&#34;</i><i>,</i>
            <i>&#34;logical&#34;</i><i>,</i>
            <i>&#34;macroBang&#34;</i><i>,</i>
            <i>&#34;parenthesis&#34;</i><i>,</i>
            <i>&#34;punctuation&#34;</i><i>,</i>
            <i>&#34;selfKeyword&#34;</i><i>,</i>
            <i>&#34;selfTypeKeyword&#34;</i><i>,</i>
            <i>&#34;semicolon&#34;</i><i>,</i>
            <i>&#34;typeAlias&#34;</i><i>,</i>
            <i>&#34;toolModule&#34;</i><i>,</i>
            <i>&#34;union&#34;</i><i>,</i>
            <i>&#34;unresolvedReference&#34;</i>
          <i>]</i><i>,</i>
          <i>&#34;tokenModifiers&#34;</i>: <i>[</i>
            <i>&#34;documentation&#34;</i><i>,</i>
            <i>&#34;declaration&#34;</i><i>,</i>
            <i>&#34;static&#34;</i><i>,</i>
            <i>&#34;defaultLibrary&#34;</i><i>,</i>
            <i>&#34;async&#34;</i><i>,</i>
            <i>&#34;attribute&#34;</i><i>,</i>
            <i>&#34;callable&#34;</i><i>,</i>
            <i>&#34;constant&#34;</i><i>,</i>
            <i>&#34;consuming&#34;</i><i>,</i>
            <i>&#34;controlFlow&#34;</i><i>,</i>
            <i>&#34;crateRoot&#34;</i><i>,</i>
            <i>&#34;injected&#34;</i><i>,</i>
            <i>&#34;intraDocLink&#34;</i><i>,</i>
            <i>&#34;library&#34;</i><i>,</i>
            <i>&#34;mutable&#34;</i><i>,</i>
            <i>&#34;public&#34;</i><i>,</i>
            <i>&#34;reference&#34;</i><i>,</i>
            <i>&#34;trait&#34;</i><i>,</i>
            <i>&#34;unsafe&#34;</i>
          <i>]</i>
        <i>}</i><i>,</i>
        <i>&#34;range&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;full&#34;</i>: <i>{</i>
          <i>&#34;delta&#34;</i>: <i>true</i>
        <i>}</i>
      <i>}</i><i>,</i>
      <i>&#34;inlayHintProvider&#34;</i>: <i>{</i>
        <i>&#34;resolveProvider&#34;</i>: <i>true</i>
      <i>}</i><i>,</i>
      <i>&#34;experimental&#34;</i>: <i>{</i>
        <i>&#34;externalDocs&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;hoverRange&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;joinLines&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;matchingBrace&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;moveItem&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;onEnter&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;openCargoToml&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;parentModule&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;runnables&#34;</i>: <i>{</i>
          <i>&#34;kinds&#34;</i>: <i>[</i>
            <i>&#34;cargo&#34;</i>
          <i>]</i>
        <i>}</i><i>,</i>
        <i>&#34;ssr&#34;</i>: <i>true</i><i>,</i>
        <i>&#34;workspaceSymbolScopeKindFiltering&#34;</i>: <i>true</i>
      <i>}</i>
    <i>}</i><i>,</i>
    <i>&#34;serverInfo&#34;</i>: <i>{</i>
      <i>&#34;name&#34;</i>: <i>&#34;rust-analyzer&#34;</i><i>,</i>
      <i>&#34;version&#34;</i>: <i>&#34;1.67.1 (d5a82bb 2023-02-07)&#34;</i>
    <i>}</i>
  <i>}</i>
<i>}</i>
</pre></div>
<p>Which is thankfully much shorter.</p>
<p>So, what character encoding do we have here? It&#39;s UTF-8. You can pass a
<code>Content-Type</code> header, but I don&#39;t think anyone does, and it defaults to
<code>application/vscode-jsonrpc; charset=utf-8</code>.</p>
<p>Note that headers are ASCII-only, just like HTTP/1.1 (<a href="https://httpwg.org/specs/rfc9112.html#rfc.section.1.2">don&#39;t lawyer me
on this</a>) — that
already lets us know it&#39;s <em>not</em> using UTF-16 for everything.</p>
<p>In this code, when inserting the bottom emoji at this location:</p>
<div translate="no"><p>Rust code</p><pre data-lang="rust"><i>fn</i> <i>main</i><i>(</i><i>)</i> <i>{</i>
  <i>// 🥺</i>
  <i>println</i><i>!</i><i>(</i><i>&#34;Hello, world!&#34;</i><i>)</i><i>;</i>
<i>}</i>
</pre></div>
<p>These are the messages sent by <code>lsp-mode</code> to <code>rust-analyzer</code>:</p>
<div translate="no"><p>JSON</p><pre data-lang="json"><i>{</i>
  <i>&#34;jsonrpc&#34;</i>: <i>&#34;2.0&#34;</i><i>,</i>
  <i>&#34;method&#34;</i>: <i>&#34;textDocument/didChange&#34;</i><i>,</i>
  <i>&#34;params&#34;</i>: <i>{</i>
    <i>&#34;textDocument&#34;</i>: <i>{</i>
      <i>&#34;uri&#34;</i>: <i>&#34;file:///home/amos/bearcove/bottom/src/main.rs&#34;</i><i>,</i>
      <i>&#34;version&#34;</i>: 1
    <i>}</i><i>,</i>
    <i>&#34;contentChanges&#34;</i>: <i>[</i>
      <i>{</i>
        <i>&#34;range&#34;</i>: <i>{</i>
          <i>&#34;start&#34;</i>: <i>{</i>
            <i>&#34;line&#34;</i>: 1<i>,</i>
            <i>&#34;character&#34;</i>: 7
          <i>}</i><i>,</i>
          <i>&#34;end&#34;</i>: <i>{</i>
            <i>&#34;line&#34;</i>: 1<i>,</i>
            <i>&#34;character&#34;</i>: 7
          <i>}</i>
        <i>}</i><i>,</i>
        <i>&#34;rangeLength&#34;</i>: 0<i>,</i>
        <i>&#34;text&#34;</i>: <i>&#34;🥺&#34;</i>
      <i>}</i>
    <i>]</i>
  <i>}</i>
<i>}</i>
</pre></div>
<p>It&#39;s important to note that the file hasn&#39;t been saved yet. You don&#39;t need to
save your code to get completions, or be able to hover symbols or jump to
definitions: that means the LSP server operates on what the editor has in
memory, and so it needs a view of <em>that</em>, not of the file. I don&#39;t think LSP
servers need to do any I/O at all (at least not for opened documents).</p>
<p>Here the change is: for line 1 (lines are zero-indexed), at character 7, we&#39;re
inserting &#34;🥺&#34;. I imagine if the range wasn&#39;t of length zero, this would serve
as a &#34;replace&#34; operation.</p>
<p>Then, we have:</p>
<div translate="no"><p>JSON</p><pre data-lang="json"><i>{</i>
  <i>&#34;jsonrpc&#34;</i>: <i>&#34;2.0&#34;</i><i>,</i>
  <i>&#34;method&#34;</i>: <i>&#34;textDocument/codeAction&#34;</i><i>,</i>
  <i>&#34;params&#34;</i>: <i>{</i>
    <i>&#34;textDocument&#34;</i>: <i>{</i>
      <i>&#34;uri&#34;</i>: <i>&#34;file:///home/amos/bearcove/bottom/src/main.rs&#34;</i>
    <i>}</i><i>,</i>
    <i>&#34;range&#34;</i>: <i>{</i>
      <i>&#34;start&#34;</i>: <i>{</i>
        <i>&#34;line&#34;</i>: 1<i>,</i>
        <i>&#34;character&#34;</i>: 8
      <i>}</i><i>,</i>
      <i>&#34;end&#34;</i>: <i>{</i>
        <i>&#34;line&#34;</i>: 1<i>,</i>
        <i>&#34;character&#34;</i>: 8
      <i>}</i>
    <i>}</i><i>,</i>
    <i>&#34;context&#34;</i>: <i>{</i>
      <i>&#34;diagnostics&#34;</i>: <i>[</i>
        
      <i>]</i>
    <i>}</i>
  <i>}</i><i>,</i>
  <i>&#34;id&#34;</i>: 17
<i>}</i>
</pre></div>
<p>According to <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_codeAction">the spec</a>:</p>
<blockquote>
<p>The code action request is sent from the client to the server to compute commands for a given text document and range.</p>
<p>These commands are typically code fixes to either fix problems or to beautify/refactor code.</p>
<p>The result of a <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_codeAction">textDocument/codeAction</a> request is an array of <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#command">Command</a> literals which are typically presented in the user interface.</p>
</blockquote>
<p>And here lies the heart of the issue: &#34;🥺&#34; was inserted at character 7. And
<code>lsp-mode</code> is now asking for code actions at character 8.</p>
<p>Which begs the question: what <em>is</em> a character?</p>

                        <h2>
                            <a id="what-is-a-character" href="#what-is-a-character">
                                What is a character?
                            </a>
                        </h2>
                        
<p>Of course, nobody can quite agree on the answer.</p>
<p>You won&#39;t make enemies by stating that &#34;a&#34; is a character.</p>
<p>You might even convince them that &#34;é&#34; is a character.</p>
<p>But is &#34;é&#34; one character?</p>
<div>

<p>Wait, you said the same thing twice.</p>
</div>
<p>No I didn&#39;t!</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">$ node
Welcome to Node.js v18.14.0.
Type &#34;.help&#34; for more information.
&gt; new TextEncoder().encode(&#34;é&#34;)
Uint8Array(2) [ 195, 169 ]
&gt; new TextEncoder().encode(&#34;é&#34;)
Uint8Array(3) [ 101, 204, 129 ]
</pre></div>
<p>The former is <a href="https://www.compart.com/en/unicode/U+00E9">U+00E9 Latin Small Letter E with Acute</a>,
whereas the latter is <a href="https://www.compart.com/en/unicode/U+0065">U+0065 Latin Small Letter E</a>
followed by <a href="https://www.compart.com/en/unicode/U+0301">U+0301 Combining Acute Accent</a></p>
<p>They&#39;re, respectively, one unicode code point...</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">&gt; &#34;é&#34;.length
1
&gt; &#34;é&#34;.charAt(0) 
&#34;é&#34;
</pre></div>
<p>...and two unicode code points:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">&gt; &#34;é&#34;.length
2
&gt; &#34;é&#34;.charAt(0)
&#39;e&#39;
&gt; &#34;é&#34;.charAt(1)
&#39;́&#39;
</pre></div>
<p>They are both, however, only one grapheme cluster.</p>
<p>What about emojis?</p>
<p>We already know &#34;🥺&#34; encodes to four bytes in utf-8:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">&gt; new TextEncoder(&#34;utf-8&#34;).encode(&#34;🥺&#34;)
Uint8Array(4) [ 240, 159, 165, 186 ]
</pre></div>
<p>And if you enjoyed things like
<a href="https://www.destroyallsoftware.com/talks/wat">Wat</a>, you might already know
what &#34;🥺&#34;.length is going to be:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">&gt; &#34;🥺&#34;.length
2
&gt; &#34;🥺&#34;.charAt(0)
&#39;\ud83e&#39;
&gt; &#34;🥺&#34;.charAt(1)
&#39;\udd7a&#39;
</pre></div><div>

<p>Hey... hey! Those are surrogates!</p>
</div>
<p>They sure are!
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/charAt">charAt</a>
returns UTF-16 code units!</p>
<p>It goes even deeper for more involved emojis:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">&gt; &#34;👨‍👩‍👦&#34;.length
8
</pre></div>
<p>This &#34;family: man, woman, boy&#34; emoji (which should render as a single grapheme
cluster for you, unless you&#39;re visiting us with a browser from the past, or from
the terminal) is actually made up of the <a href="https://emojipedia.org/man/">Man
emoji</a>, the <a href="https://emojipedia.org/woman/">Woman
emoji</a> and the <a href="https://emojipedia.org/boy/">Boy
emoji</a>, joined together with ZWJ, <a href="https://emojipedia.org/zero-width-joiner/">Zero Width Joiners</a>.</p>
<p>We can see each individual component:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">&gt; [...&#34;👨‍👩‍👦&#34;]
[ &#39;👨&#39;, &#39;‍&#39;, &#39;👩&#39;, &#39;‍&#39;, &#39;👦&#39; ]
</pre></div>
<p>What are these components exactly though? They&#39;re not UTF-16 code units: we know
that&#39;s what <code>.length</code> returns, and it said 8 (we also know each of these emojis
probably takes up 2 UTF-16 code units).</p>
<p>They&#39;re Unicode code points. We can get code units by iterating from 0 to
<code>s.length</code> and calling <code>charCodeAt</code>:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">&gt; var s = &#34;👨‍👩‍👦&#34;; for (let i = 0; i &lt; s.length; i++) { console.log(s.charCodeAt(i).toString(16)) }
d83d
dc68
200d
d83d
dc69
200d
d83d
dc66
</pre></div>
<p>And we can get code point values with <code>codePointAt</code>, which takes offsets in
UTF-16 code units. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/codePointAt">MDN says</a>:</p>
<blockquote>
<p>The <code>codePointAt()</code> method returns a non-negative integer that is the Unicode code point value at the given position. Note that this function does not give the nth code point in a string, but the code point starting at the specified string index.</p>
</blockquote>
<p>And further:</p>
<blockquote>
<p>If the element at pos is a UTF-16 high surrogate, returns the code point of the surrogate pair.</p>
</blockquote>
<p>And:</p>
<blockquote>
<p>If the element at pos is a UTF-16 low surrogate, returns only the low surrogate code point.</p>
</blockquote>
<p>So, if we <em>really</em> want to index into a string, we have to be very careful, or
we&#39;ll get wrong results (where Rust chooses to panic):</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">&gt; var s = &#34;👨‍👩‍👦&#34;; [0, 2, 3, 5, 7].map(i =&gt; `U+${s.codePointAt(i).toString(16)}`)
[ &#39;U+1f468&#39;, &#39;U+200d&#39;, &#39;U+1f469&#39;, &#39;U+200d&#39;, &#39;U+dc66&#39; ]
</pre></div>
<p><code>U+200D</code> is <a href="https://unicode-table.com/en/200D/">Zero-Width Joiner</a>, this checks out.</p>
<p>To <em>not</em> get it wrong, it&#39;s easier to use iteration, which is based on Unicode
code points, unlike indexing which is based on UTF-16 code units:</p>
<div translate="no"><p>Shell session</p><pre data-lang="shell">&gt; for (const c of &#34;👨‍👩‍👦&#34;) { console.log(`U+${c.codePointAt(0).toString(16)}`) }
U+1f468
U+200d
U+1f469
U+200d
U+1f466
</pre></div>
<p>Note that even though <code>for..of</code> is already iterating over codepoints, it
&#34;yields&#34; strings itself, since there&#39;s no &#34;character&#34; or &#34;rune&#34; type in
ECMAScript - the closest you get is what <code>codePointAt</code> returns, which is a
<code>Number</code>, which is only accurate for integer up to 53 bits wide.</p>
<p>Luckily, the maximum valid Unicode code point is <code>U+10FFFF</code>, so we only need 21
bits. (Also, only ~150K code points are defined by Unicode 15.0, the latest
version as of February of 2023).</p>
<p>Which explains why, if you go to read the documentation for Emacs, a 47-year-old
piece of software, you will find <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Text-Representations.html">the following</a>:</p>
<blockquote>
<p>To support this multitude of characters and scripts, Emacs closely follows the Unicode Standard.</p>
<p>The Unicode Standard assigns a unique number, called a codepoint, to each and every character. The range of codepoints defined by Unicode, or the Unicode codespace, is <code>0..#x10FFFF</code> (in hexadecimal notation), inclusive.</p>
<p>Emacs extends this range with codepoints in the range <code>#x110000..#x3FFFFF</code>, which it uses for representing characters that are not unified with Unicode and raw 8-bit bytes that cannot be interpreted as characters.</p>
<p>Thus, <strong>a character codepoint in Emacs is a 22-bit integer.</strong></p>
</blockquote>
<p>Makes perfect sense to me.</p>

                        <h2>
                            <a id="caught-in-the-middle" href="#caught-in-the-middle">
                                Caught in the middle
                            </a>
                        </h2>
                        
<p>In summary: no one can agree what a character is.</p>
<p>I can&#39;t find reliable sources on when &#34;multibyte support&#34; was added to Emacs,
but it&#39;s safe to say they decided a &#34;character&#34; was a &#34;Unicode code point&#34;,
ignoring zero-with joiners, combining characters, etc. Fair enough.</p>
<p>As for the LSP spec, it was originally developed for <a href="https://code.visualstudio.com/">Visual Studio
Code</a>, which is implemented in ECMAScript
(JavaScript).</p>
<p>And because indexing into strings in ECMAScript (and <code>s.length</code>, etc.) is based
on UTF-16 code units, they decided a character should be.. a UTF-16 code unit!</p>
<p>You may be recoiling in horror at this point, and who could blame you, but
the point is, this is a fantastic cautionary tale: if your API ever has
a field named <code>character</code>:</p>
<div translate="no"><p>JSON</p><pre data-lang="json"><i>&#34;start&#34;</i>: <i>{</i>
  <i>&#34;line&#34;</i>: 1<i>,</i>
  <i>&#34;character&#34;</i>: 8
<i>}</i>
</pre></div>
<p>...then you&#39;ve taken a wrong turn and need to reconsider. Immediately.</p>
<p>To finish elucidating the exact LSP transcript we&#39;ve obtained between lsp-mode
and rust-analyzer: that <code>&#34;character&#34;</code> field should have value <code>9</code>, not <code>8</code>,
because even though &#34;🥺&#34; is one &#34;Emacs character&#34; (one Unicode code point),
it is two &#34;LSP characters&#34; (two UTF-16 code units).</p>
<p>What of rust-analyzer then? Well, it certainly doesn&#39;t use UTF-16 as its
internal representation: like most Rust programs (that don&#39;t need to deal with
pre-UTF-8-codepage Windows APIs), it uses UTF-8.</p>
<p>But it does implement LSP to the letter and treat &#34;character offsets&#34; as UTF-16
code units. Which it can do because, thanks to <code>testDocument/didChange</code>, it has
its <em>own</em> copy of the document text (in UTF-8).</p>
<p>But it&#39;s able to translate UTF-16 code unit offsets to UTF-8 offsets: and up
until then I&#39;ve been making claims about rust-analyzer does without looking,
so it&#39;s time to look: if we follow the thread, we&#39;ll surely find... <a href="https://github.com/rust-lang/rust-analyzer/blob/c97aae38f20f64daede9877212aff83c259a4faa/crates/ide-db/src/line_index.rs#L8-L14">yes!</a>:</p>
<div translate="no"><p>Rust code</p><pre data-lang="rust"><i>// in `rust-analyzer/crates/ide-db/src/line_index.rs`</i>

<i>#<i>[</i>derive<i>(</i>Clone, Debug, PartialEq, Eq<i>)</i><i>]</i></i>
<i>pub</i> <i>struct</i> <i>LineIndex</i> <i>{</i>
    <i>/// Offset the the beginning of each line, zero-based</i>
    <i>pub</i><i>(</i><i>crate</i><i>)</i> <i>newlines</i><i>:</i> <i>Vec</i><i>&lt;</i><i>TextSize</i><i>&gt;</i><i>,</i>
    <i>/// List of non-ASCII characters on each line</i>
    <i>pub</i><i>(</i><i>crate</i><i>)</i> <i>utf16_lines</i><i>:</i> <i>NoHashHashMap</i><i>&lt;</i><i>u32</i><i>,</i> <i>Vec</i><i>&lt;</i><i>Utf16Char</i><i>&gt;</i><i>&gt;</i><i>,</i>
<i>}</i>

<i>#<i>[</i>derive<i>(</i>Clone, Debug, Hash, PartialEq, Eq<i>)</i><i>]</i></i>
<i>pub</i><i>(</i><i>crate</i><i>)</i> <i>struct</i> <i>Utf16Char</i> <i>{</i>
    <i>/// Start offset of a character inside a line, zero-based</i>
    <i>pub</i><i>(</i><i>crate</i><i>)</i> <i>start</i><i>:</i> <i>TextSize</i><i>,</i>
    <i>/// End offset of a character inside a line, zero-based</i>
    <i>pub</i><i>(</i><i>crate</i><i>)</i> <i>end</i><i>:</i> <i>TextSize</i><i>,</i>
<i>}</i>
</pre></div>
<p>...an index of every non-ASCII character for every line of every file, which it
can then use to do UTF-16 to UTF-8 index translation:</p>
<div translate="no"><p>Rust code</p><pre data-lang="rust"><i>impl</i> <i>LineIndex</i> <i>{</i>
    <i>fn</i> <i>utf8_to_utf16_col</i><i>(</i><i>&amp;</i><i>self</i><i>,</i> <i>line</i><i>:</i> <i>u32</i><i>,</i> <i>col</i><i>:</i> <i>TextSize</i><i>)</i> -&gt; <i>usize</i> <i>{</i>
        <i>let</i> <i>mut</i> res<i>:</i> <i>usize</i> = col<i>.</i><i>into</i><i>(</i><i>)</i><i>;</i>
        <i>if</i> <i>let</i> Some<i>(</i>utf16_chars<i>)</i> = <i>self</i><i>.</i><i>utf16_lines</i><i>.</i><i>get</i><i>(</i><i>&amp;</i>line<i>)</i> <i>{</i>
            <i>for</i> c <i>in</i> utf16_chars <i>{</i>
                <i>if</i> c<i>.</i><i>end</i> &lt;= col <i>{</i>
                    res -= usize<i>::</i><i>from</i><i>(</i>c<i>.</i><i>len</i><i>(</i><i>)</i><i>)</i> - c<i>.</i><i>len_utf16</i><i>(</i><i>)</i><i>;</i>
                <i>}</i> <i>else</i> <i>{</i>
                    <i>// From here on, all utf16 characters come *after* the character we are mapping,</i>
                    <i>// so we don&#39;t need to take them into account</i>
                    <i>break</i><i>;</i>
                <i>}</i>
            <i>}</i>
        <i>}</i>
        res
    <i>}</i>
<i>}</i>
</pre></div>
<p>To do that, it uses a nice property: if some codepoint needs 4 UTF-8 bytes, it
needs 2 UTF-16 code units:</p>
<div translate="no"><p>Rust code</p><pre data-lang="rust"><i>impl</i> <i>Utf16Char</i> <i>{</i>
    <i>/// Returns the length in 8-bit UTF-8 code units.</i>
    <i>fn</i> <i>len</i><i>(</i><i>&amp;</i><i>self</i><i>)</i> -&gt; <i>TextSize</i> <i>{</i>
        <i>self</i><i>.</i><i>end</i> - <i>self</i><i>.</i><i>start</i>
    <i>}</i>

    <i>/// Returns the length in 16-bit UTF-16 code units.</i>
    <i>fn</i> <i>len_utf16</i><i>(</i><i>&amp;</i><i>self</i><i>)</i> -&gt; <i>usize</i> <i>{</i>
        <i>//                             👇</i>
        <i>if</i> <i>self</i><i>.</i><i>len</i><i>(</i><i>)</i> == <i>TextSize</i><i>::</i><i>from</i><i>(</i><i>4</i><i>)</i> <i>{</i>
            <i>2</i>
        <i>}</i> <i>else</i> <i>{</i>
            <i>1</i>
        <i>}</i>
    <i>}</i>
<i>}</i>
</pre></div>
<p>And that&#39;s how rust-analyzer adheres to the LSP spec. And lsp-mode doesn&#39;t.</p>
<p>Of course, as a user, it&#39;s hard to bring oneself to care about that. As a
rust-analyzer user, it <em>feels</em> like rust-analyzer&#39;s bug. It&#39;s the one crashing!</p>
<p>Why does it crash? Couldn&#39;t it just... not?</p>
<p>Couldn&#39;t it just ignore erroneous input? Or... JSON-RPC has mechanisms for error
reporting, couldn&#39;t it just use that?</p>
<p>Both of these are nonstarters, and I&#39;ll explain why.</p>
<p>If rust-analyzer ever gets a character offset that&#39;s in the middle of an UTF-16
surrogate pair, like it did in our recorded sequence:</p>
<p><img src="https://fasterthanli.me/content/articles/the-bottom-emoji-breaks-rust-analyzer/assets/positions.9f991e8a0455ef9b.svg" title="A diagram showing the encoding of our comment then bottom emoji line, showing utf-8 bytes, where the emoji takes 4 slots, utf-16 code units, where it takes 2, and unicode code points like in Emacs, where it takes one" alt="A diagram showing the encoding of our comment then bottom emoji line, showing utf-8 bytes, where the emoji takes 4 slots, utf-16 code units, where it takes 2, and unicode code points like in Emacs, where it takes one" loading="lazy"/></p><p>Then... all bets are off!</p>
<p>It can&#39;t just &#34;assume there&#39;s been an oopsie&#34; and go to the <em>end</em> of the UTF-16
surrogate pair, because there might have already been errors <em>before</em> that:
if we had two similar emojis before, it would think it&#39;s <em>before</em> the bottom
emoji, rather than after.</p>
<p>That means completions would be wrong, which might seem innocent enough, but it
also means that any further <code>testDocument/didChange</code> requests will give the LSP
server (in this case rust-analyzer) a corrupted view of the document!</p>
<p>And that can <em>already happen</em>, without crashing!</p>
<p>If we insert &#34;🥲😎&#34; in one go, then &#34;🥺&#34; at offset 2, the Emacs buffer will
have &#34;🥲😎🥺&#34;, but any compliant LSP server will have &#34;🥲🥺😎&#34;.</p>
<p>So, when it <em>is</em> caught, when an LSP server detects that it&#39;s getting bad
offsets from the client (in this case lsp-mode), it absolutely should sound
the alarm!</p>
<div>

<div>
<p>But is <em>crashing</em> the right thing to do though?</p>
<p>Didn&#39;t you mention JSON-RPC had a built-in mechanism for reporting errors?</p>
</div>
</div>
<p>Oh <a href="https://www.jsonrpc.org/specification#error_object">it does</a>! But
unfortunately, error handling is hard. There&#39;s nothing in the LSP spec that says
&#34;your implementation is fundamentally flawed and we cannot rely on ANYTHING going
forward&#34;. At best you can do &#34;this specific request has failed&#34;.</p>
<p>But requests fail all the time for various reasons and LSP clients barely bother
to show you something (VSCode notably shows a notification, which is more
annoying than anything else, since you can&#39;t do anything about it).</p>
<p>How should a client behave when it gets an error? Should it decide to give up
after a certain amount of errors? How many is enough? Eight? Sixteen? The
situation isn&#39;t going to fix itself. If a <code>textDocument/didChange</code> request
fails, it&#39;s game over - the representations on either side have already
diverged.</p>
<p>Restarting the server, like lsp-mode suggests in a prompt, is not really going
to help either, because editing any code <em>after</em> the emoji will have the wrong
offsets, and so the representations will start to diverge again very soon.</p>
<p>This is an error condition that is rare (someone messed up the protocol in a BIG
way) and unrecoverable (there&#39;s a very low likelihood of anything correct or
useful happening after that): as frustrating as it is for Emacs users,
rust-analyzer is absolutely correct in panicking here.</p>
<p>(In fact, it would be neat if the LSP handshake include some basic checks to make
sure both ends agrees on what offsets mean, but it&#39;s a little late for that.)</p>

                        <h2>
                            <a id="the-way-forward" href="#the-way-forward">
                                The way forward
                            </a>
                        </h2>
                        
<p>This is where things get delicate.</p>
<p>Because the tech of it all, is, as usual, relatively straightforward. If you&#39;ve
made it this far, you have a thorough understanding of exactly what&#39;s going
wrong and why, going all the way back to <a href="https://www.computer.org/csdl/magazine/co/2012/02/mco2012020007/13rRUy08MzA">JavaScript was designed in 10 days in
1995</a>.</p>
<p>The way forward is for lsp-mode to fix itself, clearly. But if you&#39;re
maintaining the tool at the <em>other end</em> of the LSP discussion, it&#39;s hard to
politely yet urgently signify this to them. Ideally we should get along with
our neighbors just fine!</p>
<p>And in the neighbor&#39;s defense, using UTF-16 code units for offsets is... it&#39;s
not good. At all. Modelling a spec after a specific language&#39;s limitations is
how we ended up with &#34;you can&#39;t really send integers bigger than 9e15 in a JSON
document and be sure they&#39;ll come out okay on the other side&#34;.</p>
<p>&#34;Sending the correct UTF-16 code unit offsets&#34; would probably involve something
like re-encoding lines from &#34;whatever Emacs uses internally&#34; (presumably UTF-8)
to UTF-16, which can be time-consuming, especially if you&#39;re doing that in
<a href="https://en.wikipedia.org/wiki/Emacs_Lisp">Emacs Lisp</a> I suppose. Or you could
do something smarter, like rust-analyzer does, but then you better have good
unit tests (like rust-analyzer also does).</p>
<p>Still in the neighbor&#39;s defense, there&#39;s a <em>lot</em> of code out there that does not
use any code points outside of the BMP, thus doesn&#39;t have any UTF-16 surrogate
pairs. So it&#39;s seems like an edge case for lsp-mode (whereas it is, in fact,
a fundamental disagreement with the spec).</p>
<p>Luckily, and this is where I feel like the rust-analyzer project has been
diplomatic, there&#39;s <em>already</em> been steps taken to move this forward. You and I,
we&#39;re not the only UTF-16 haters in the world, there&#39;s also
<a href="https://clangd.llvm.org/">clangd</a>, the C/C++ language server, which went &#34;lol
what no&#34; and straight up decided to allow clients to <a href="https://clangd.llvm.org/extensions#utf-8-offsets">use UTF-8 offsets
instead</a>.</p>
<p>And, extending a hand to lsp-mode, so they don&#39;t have do something dumb but
expensive (re-encoding as UTF-16) or clever but fast (keep a cache of offsets,
use the length-in-other-encoding trick RA does), rust-analyzer has implemented
that extension.</p>
<p>So the timeline now goes:</p>
<ul>
<li>Aug 14, 2020 — issue <a href="https://github.com/emacs-lsp/lsp-mode/issues/2080">filed against lsp-mode</a></li>
<li>Jan 19, 2021 — rust-analyzer team learns about this</li>
<li>Jan 26, 2021 — rust-analyzer adds support for clangd UTF-8 offsets extensions</li>
<li>Jan 31, 2021 — someone makes <a href="https://github.com/yyoncho/lsp-mode/commit/aac9b6a10611ce9fcb4c9fe272f2835f0b6bb210">a fix for lsp-mode</a> to send proper UTF-16 offsets, that isn&#39;t merged</li>
<li>Feb 05, 2022 — someone <a href="https://github.com/emacs-lsp/lsp-mode/issues/3344">requests UTF-8 offset support in lsp-mode</a></li>
<li>May 10, 2022 — the LSP spec adds support for UTF-8 offsets officially in <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#version_3_17_0">3.17.0</a></li>
<li>Oct 05, 2022 — LSP 3.17.0 becomes the &#34;current&#34; version of the spec</li>
<li>Oct 21, 2022 — <code>lsp-types</code> (Rust crate) <a href="https://github.com/gluon-lang/lsp-types/pull/248">adds support for UTF-8 offsets</a></li>
<li>Oct 26, 2022 — rust-analyzer <a href="https://github.com/rust-lang/rust-analyzer/pull/13484">switches</a> from clangd UTF-8 offsets to the official way</li>
</ul>
<p>And here we are, 2.5 years after the initial filing, with the same issue being
noticed and reported over and over again against rust-analyzer (and, I imagine,
similarly correctness-minded language servers).</p>
<p>So, here&#39;s my call to action.</p>
<p>Dear <code>lsp-mode</code> maintainers, please, in that order:</p>
<ol>
<li>Do not fall back to RLS, <em>ever</em>.</li>
<li>Fix your &#34;character offsets&#34; to be UTF-16 code units. I know it&#39;s bad,
but it&#39;s bad for everyone and that&#39;s what the spec says.</li>
<li>Implement the UTF-8 offset extensions (LSP 3.17.0), that way we don&#39;t have this
silly situation where two tools that use UTF-8 internally do conversions
in both directions every time they speak.</li>
</ol>
<p>It&#39;s overdue.</p>

</div><div>
  
    
    
      

  


  







<div>
    <h2>
        Latest video
        <a href="https://fasterthanli.me/videos">View all</a>
    </h2>









<div>
    
        
        
        
            
        

        

        
        

        
        
        
        
        
            
        
        
         
        
        
        <div>
            <a href="https://fasterthanli.me/videos/cpp-vs-rust-which-is-faster">
                
                    
                    <div>
                        <picture>
                            <source type="image/avif" srcset="https://tube.fasterthanli.me/covers/cpp-vs-rust/cover.avif"/>
                            <source type="image/webp" srcset="https://tube.fasterthanli.me/covers/cpp-vs-rust/cover.webp"/>
                            <img alt="video cover image" src="https://tube.fasterthanli.me/covers/cpp-vs-rust/cover.jpg"/>
                        </picture>
                    </div>
                

                <span>
                    
                        
                        C++ vs Rust: which is faster?
                    
                </span>
            </a>
            <div>
                <div>
                    <div>
                        <p>Jan 17, 2023</p>
                        
                            
                                
                                    <p>
                                        21 minute watch
                                    </p>
                                
                            
                        

                        
                            
                            
                        

                        
                        
                        
                            
                        
                        

                        
                        
                    </div>
                </div>

                <div>
                    
                        
                            
                            <p>I ported some Advent of Code solutions from C/C++ to Rust, and used the
opportunity to compare performance. When I couldn&#39;t explain why they performed
differently, I had no choice but to disassemble both and look at what the
codegen was like!</p>
                        
                    
                </div>

                
                    <p><a href="https://fasterthanli.me/videos/cpp-vs-rust-which-is-faster">
                        <span>
                            
                                Watch now
                            
                        </span>
                    </a>
                
            </p></div>
        </div>
    
</div>

</div> <!-- Latest video -->

  
</div></div>
  </body>
</html>
