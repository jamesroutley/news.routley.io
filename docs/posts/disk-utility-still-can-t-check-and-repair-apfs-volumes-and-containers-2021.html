<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://eclecticlight.co/2021/11/19/disk-utility-still-cant-check-and-repair-apfs-volumes-and-containers/">Original</a>
    <h1>Disk Utility still can&#39;t check and repair APFS volumes and containers (2021)</h1>
    
    <div id="readability-page-1" class="page"><div data-first_letter="C">
		<p>Checking and repairing disks is one of the more important tasks performed by Disk Utility, but ever since the introduction of APFS, it has been more fraught than it should have been. One of its most persistent and pervasive problems has been complete failure because Disk Utility has been unable to unmount volumes or containers. To my shock, in Monterey 12.0.1 this problem appears worse than ever, and I now have one disk which Disk Utility is completely unable to check or repair. This article suggests ways around this, while we wait for Apple to fix this bug.</p>
<p>For much of this period, the First Aid tool in Disk Utility has relied on the command tool <code>fsck_apfs</code> to do the work, calling it using two options, <code>y</code> and <code>x</code>. The <code>y</code> option simply agrees to make all the repairs suggested by the tool, but the <code>x</code> option is private. I suspect that privacy isn’t sinister, merely allowing communication between the tool and app using XPC.</p>
<p>Best practice for performing disk checks and repairs like this isn’t with a live file system, and those options won’t work when the item being checked is still mounted. So to prepare for the call to <code>fsck_apfs</code>, Disk Utility has to unmount the volume or container, and that’s the step which appears to go awry.</p>
<p><span><img data-attachment-id="57308" data-permalink="https://eclecticlight.co/firstaid03/" data-orig-file="https://eclecticlight.co/wp-content/uploads/2021/02/firstaid03.jpg" data-orig-size="2140,942" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="firstaid03" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlight.co/wp-content/uploads/2021/02/firstaid03.jpg?w=300" data-large-file="https://eclecticlight.co/wp-content/uploads/2021/02/firstaid03.jpg?w=940" src="https://eclecticlight.co/wp-content/uploads/2021/02/firstaid03.jpg?w=940" alt="firstaid03" srcset="https://eclecticlight.co/wp-content/uploads/2021/02/firstaid03.jpg 2140w, https://eclecticlight.co/wp-content/uploads/2021/02/firstaid03.jpg?w=150&amp;h=66 150w, https://eclecticlight.co/wp-content/uploads/2021/02/firstaid03.jpg?w=300&amp;h=132 300w, https://eclecticlight.co/wp-content/uploads/2021/02/firstaid03.jpg?w=768&amp;h=338 768w, https://eclecticlight.co/wp-content/uploads/2021/02/firstaid03.jpg?w=1024&amp;h=451 1024w" sizes="(max-width: 2140px) 100vw, 2140px"/></span></p>
<p>In Catalina and Big Sur, the error reported was confusing, and the recommendation to “back up the data on this volume” inappropriate. It would have been far better if Disk Utility had told us honestly that “this is a known bug, and some day we might get round to fixing it.”</p>
<p><span><img data-attachment-id="57379" data-permalink="https://eclecticlight.co/diskutilfail/" data-orig-file="https://eclecticlight.co/wp-content/uploads/2021/02/diskutilfail.jpg" data-orig-size="1088,1148" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="diskutilfail" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlight.co/wp-content/uploads/2021/02/diskutilfail.jpg?w=284" data-large-file="https://eclecticlight.co/wp-content/uploads/2021/02/diskutilfail.jpg?w=940" src="https://eclecticlight.co/wp-content/uploads/2021/02/diskutilfail.jpg?w=940" alt="diskutilfail" srcset="https://eclecticlight.co/wp-content/uploads/2021/02/diskutilfail.jpg 1088w, https://eclecticlight.co/wp-content/uploads/2021/02/diskutilfail.jpg?w=142&amp;h=150 142w, https://eclecticlight.co/wp-content/uploads/2021/02/diskutilfail.jpg?w=284&amp;h=300 284w, https://eclecticlight.co/wp-content/uploads/2021/02/diskutilfail.jpg?w=768&amp;h=810 768w, https://eclecticlight.co/wp-content/uploads/2021/02/diskutilfail.jpg?w=970&amp;h=1024 970w" sizes="(max-width: 1088px) 100vw, 1088px"/></span></p>
<p>That some day clearly hasn’t come in Monterey 12.0.1. When I was researching <a href="https://eclecticlight.co/2021/11/18/how-should-you-check-an-apfs-backup-store/">yesterday’s article</a> about how to check Time Machine backup volumes, it hit me again and again, so I went back and had a closer look at what now goes wrong, and what to do about it.</p>
<p><span><img data-attachment-id="62338" data-permalink="https://eclecticlight.co/diskutil10/" data-orig-file="https://eclecticlight.co/wp-content/uploads/2021/11/diskutil10.jpg" data-orig-size="954,649" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="diskutil10" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlight.co/wp-content/uploads/2021/11/diskutil10.jpg?w=300" data-large-file="https://eclecticlight.co/wp-content/uploads/2021/11/diskutil10.jpg?w=940" loading="lazy" src="https://eclecticlight.co/wp-content/uploads/2021/11/diskutil10.jpg?w=940" alt="diskutil10" srcset="https://eclecticlight.co/wp-content/uploads/2021/11/diskutil10.jpg 954w, https://eclecticlight.co/wp-content/uploads/2021/11/diskutil10.jpg?w=150&amp;h=102 150w, https://eclecticlight.co/wp-content/uploads/2021/11/diskutil10.jpg?w=300&amp;h=204 300w, https://eclecticlight.co/wp-content/uploads/2021/11/diskutil10.jpg?w=768&amp;h=522 768w" sizes="(max-width: 954px) 100vw, 954px"/></span></p>
<p>This may happen persistently when you try to check and repair an APFS volume.</p>
<p><span><img data-attachment-id="62339" data-permalink="https://eclecticlight.co/diskutil11/" data-orig-file="https://eclecticlight.co/wp-content/uploads/2021/11/diskutil11.jpg" data-orig-size="952,583" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="diskutil11" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlight.co/wp-content/uploads/2021/11/diskutil11.jpg?w=300" data-large-file="https://eclecticlight.co/wp-content/uploads/2021/11/diskutil11.jpg?w=940" loading="lazy" src="https://eclecticlight.co/wp-content/uploads/2021/11/diskutil11.jpg?w=940" alt="diskutil11" srcset="https://eclecticlight.co/wp-content/uploads/2021/11/diskutil11.jpg 952w, https://eclecticlight.co/wp-content/uploads/2021/11/diskutil11.jpg?w=150&amp;h=92 150w, https://eclecticlight.co/wp-content/uploads/2021/11/diskutil11.jpg?w=300&amp;h=184 300w, https://eclecticlight.co/wp-content/uploads/2021/11/diskutil11.jpg?w=768&amp;h=470 768w" sizes="(max-width: 952px) 100vw, 952px"/></span></p>
<p>It can also happen every time with an APFS container.</p>
<p><span><img data-attachment-id="62340" data-permalink="https://eclecticlight.co/diskutil12/" data-orig-file="https://eclecticlight.co/wp-content/uploads/2021/11/diskutil12.jpg" data-orig-size="949,875" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="diskutil12" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlight.co/wp-content/uploads/2021/11/diskutil12.jpg?w=300" data-large-file="https://eclecticlight.co/wp-content/uploads/2021/11/diskutil12.jpg?w=940" loading="lazy" src="https://eclecticlight.co/wp-content/uploads/2021/11/diskutil12.jpg?w=940" alt="diskutil12" srcset="https://eclecticlight.co/wp-content/uploads/2021/11/diskutil12.jpg 949w, https://eclecticlight.co/wp-content/uploads/2021/11/diskutil12.jpg?w=150&amp;h=138 150w, https://eclecticlight.co/wp-content/uploads/2021/11/diskutil12.jpg?w=300&amp;h=277 300w, https://eclecticlight.co/wp-content/uploads/2021/11/diskutil12.jpg?w=768&amp;h=708 768w" sizes="(max-width: 949px) 100vw, 949px"/></span></p>
<p>Oddly, though, it doesn’t seem to affect HFS+ volumes.</p>
<p>One way around this is to cave in, start up in Recovery, and use Disk Utility there, where there’s no excuse for problems unmounting anything. If you’re intending to check and repair the boot volume group (System and/or Data) then this is the preferred way. macOS does now provide a good means of ‘freezing’ file system access if you do try that when running in normal user mode, but Recovery is always better.</p>
<p>The best news of all is that you can still use the command tool <code>fsck_apfs</code> directly, and work around this bug in Disk Utility. The bizarre twist is that you can use Disk Utility’s <strong>Unmount</strong> tool to unmount volumes and containers which the app itself appears unable to unmount successfully. Here’s a summary of the process:</p>
<ol>
<li>In Disk Utility (or Terminal) obtain the device name of the APFS container or volume you want to check. In this case, I’ll use <code>disk7s2</code>, which is the sort of volume name you’re looking for, or <code>disk7</code> for a container.</li>
<li>In Disk Utility (or Terminal) unmount the container or volume, by selecting it and clicking on the <strong>Unmount</strong> tool. When you’re checking a container, it’s best to unmount each of its volumes before unmounting the container itself.</li>
<li>Open Terminal and type the chosen command with the correct device name. Then enter your admin user’s password at the prompt.</li>
<li>Watch as the volume or container is checked.</li>
<li>Once that has completed, consider whether the container or volume needs any repair using <code>fsck_apfs</code>.</li>
<li>In Disk Utility (or Terminal) mount the container or volume again, by selecting it and clicking on the <strong>Mount</strong> tool.</li>
</ol>
<p>The command to use depends on whether you just want to check the item, or repair it as well. For the former, use the <code>-n</code> option, and for the latter the <code>-y</code> option will perform all repairs automatically. I advise you to include all snapshots, which are important, but if you want to exclude them all, use the <code>-S</code> option.</p>
<p>If the volume is encrypted, you could keep it mounted and use the <code>-l</code> option to check the live file system, or you can use a command like</p>
<p>For example, choose between the commands:</p>
<ul>
<li><code>sudo fsck_apfs -n /dev/disk7s2</code> just to check the volume disk7s2 but not repair it, and include snapshots.</li>
<li><code>sudo fsck_apfs -y /dev/disk7s2</code> to check and repair all errors automatically, and include snapshots.</li>
<li><code>sudo fsck_apfs -n -S /dev/disk7s2</code> to check but not repair, but excluding all snapshots.</li>
<li><code>sudo fsck_apfs -n -S /dev/disk7</code> to check but not repair the container disk7, excluding all snapshots.</li>
</ul>
<p>You can find details of all available options in <code>man fsck_apfs</code>.</p>
<p><a href="https://support.apple.com/HT210898" target="_blank" rel="noopener">Apple recommends</a> that you first check and repair volumes within a container, then the container itself, and finally the disk (which you can do completely within Disk Utility). That is oddly the exact opposite order previously recommended by many, and duplicates checks on volumes which are normally repeated when you check their container.</p>
<p>The disk which I have such problems with is a little unusual in that it’s partitioned into two: a small HFS+ volume, and a much larger APFS container. The irony is that Disk Utility’s advice to back up the affect volume is being offered for my Time Machine backup, which is not only a backup volume itself, but can’t be backed up because its backup snapshots can’t be copied to another disk.</p>
<p>It will be so good when Apple finally sorts these problems we’ve suffered for the last four years.</p>
	</div></div>
  </body>
</html>
