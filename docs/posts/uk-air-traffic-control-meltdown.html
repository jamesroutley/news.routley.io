<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jameshaydon.github.io/nats-fail/">Original</a>
    <h1>UK air traffic control meltdown</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
      <p>Comments on <a href="https://www.reddit.com/r/programming/comments/16fhmuq/a_deep_dive_into_the_bug_that_caused_the_uk_air/?utm_source=share&amp;utm_medium=web2x&amp;context=3">reddit</a> and <a href="https://news.ycombinator.com/item?id=37461695">Hacker News</a></p>
<p>On 28 August 2023 <em>NATS</em>, the UK&#39;s air traffic control operator, suffered a
<strong>major</strong> technical incident. The BBC reports that more than <a href="https://www.bbc.com/news/uk-66685349">2000 flights were
cancelled</a> and the cost has been estimated
at over <em>£100 million</em> GBP. The incident probably affected hundreds of thousands
of people.</p>
<p>The press initially reported the cause was a faulty flight plan: <em>&#34;UK air traffic
control: inquiry into whether French error caused failure&#34;</em> (The Times) and in
typical <em>Mail Online</em> reporting style: <em>&#34;Did blunder by French airline spark air
traffic control issues? Officials probe if a single badly filed travel plan
caused UK&#39;s entire flight-control system to collapse in worst outage for a
decade - with 1,000 flights cancelled and chaos set to last DAYS&#34;</em>.</p>
<p>So what happened? These are notes on my reading of the incident report:</p>
<blockquote>
<p>NATS Major Incident Preliminary Report</p>
</blockquote>
<p><em>NATS</em> is a &#34;public-private&#34; company in the UK that is responsible for all of
the UK&#39;s air traffic control:</p>
<blockquote>
<p>Air Traffic Control (ATC) is the provision and operation of a safe system for
controlling and monitoring aircraft.
[..] </p>
</blockquote>
<h2 id="what-went-wrong">What went wrong</h2>
<blockquote>
<p>The start of the sequence of events leading to the incident can be tracked
back to the point at which a flight plan was entered into the flight planning
system.</p>
<p>[Airlines] submit the plan into Eurocontrol’s Integrated Initial Flight Plan
Processing System (IFPS).
[..]</p>
<p>If the submitted flight plan is accepted by IFPS, i.e. it is compliant with
IFPS defined parameters [...] this is sufficient for a flight to depart with
local ATC approval. The flight plan will be sent from IFPS to all relevant
ANSPs who need to manage the flight.
[..]</p>
<p>Within the NATS En-route operations at Swanwick Centre, the data is passed to
FPRSA-R. The FPRSA-R sub-system exists to convert the data received from IFPS
(in a format known as ATS Data Exchange Presentation, ADEXP) into a format
that is compatible with the UK National Airspace System (NAS). NAS is the
flight data processing system which contains all of the relevant airspace and
routings.
[..]</p>
<p>FPRSA-R has a primary and backup system monitored both by dedicated Control
and Monitoring (C&amp;M) systems and also an aggregated central C&amp;M system.
Further resilience is provided by NAS storing 4 hours of previously filed
flight data to allow the operation to continue in the event of the loss of
automatic processing of flight data.
[..]</p>
<p>In addition to the technical resilience provided by backup systems, and the 4
hours of stored flight data, there is operational contingency available to
allow safe service to continue. This is provided through the ability to input
flight data manually, directly into NAS using a manual input system.</p>
</blockquote>
<p>To summarise:</p>
<ul>
<li>Flight plans are first submitted to a European-wide authority <em>IFPS</em>.</li>
<li>If a plan is accepted, the flight is cleared for takeoff.</li>
<li><em>NATS</em> requires the flight plan be transferred to them at least 4 hours before
the aircraft is due to enter UK airspace. This is supposed to give NATS a
4-hour window to be able to fix any problems in processing flight plans.</li>
<li>It seems that there is also probably some process which <em>delays</em> flight plans
until <em>close</em> to the deadline (see below). This might be to avoid congesting
the system with flight plans too early, or lots of plans that may later
change. Still, this results in flight plans being received by NATS sometimes
<em>hours</em> after the flight has taken off.</li>
</ul>
<blockquote>
<p>The NATS ATC System was operating normally.
[..]</p>
<p>[On] 28 August the airline submitted an ICAO4444 compliant flight plan into
Eurocontrol’s flight planning distribution system, IFPS.</p>
</blockquote>
<p>ICAO stands for <a href="https://en.wikipedia.org/wiki/International_Civil_Aviation_Organization" title="wikipedia">International Civil Aviation
Organization</a>, a United Nations agency.
An ICAO4444 flight plan looks like this:</p>
<pre><code><span>(FPL-TTT123-IS
</span><span>-C550/L-SDE1E2GHIJ3J5RWZ/SB1D1
</span><span>-KPWM1225
</span><span>-N0440F310 SSOXS5 SSOXS DCT BUZRD
</span><span>DCT SEY DCT HTO J174 ORF J121
</span><span>CHS EESNT LUNNI1
</span><span>-KJAX0214 KMCO
</span><span>-PBN/A1L1B1C1D1O1T1 NAV/Z1 GBAS
</span><span>DAT/1FANS2PDC SUR/260B RSP180
</span><span>DOF/220501 REG/N123A SEL/BPAM
</span><span>CODE/A05ED7)
</span></code></pre>
<p>Such messages are in a format that is meant to be read by machines, but also by
humans if necessary. The format is spec&#39;d over many many pages of PDF, but is
roughly:</p>
<pre><code><span>( FPL-ACID-Flt Rules Flight Type
</span><span>- AC Type/Wake Cat-
</span><span>Equip.&amp;Capability
</span><span>- Departure EOBT
</span><span>- Speed Altitude [sp] Route
</span><span>- Destination ETE [sp]
</span><span>Alternate(s)
</span><span>- Other Information )
</span></code></pre>
<p>The route part (in this example: <code>N0440F310 SSOXS5 SSOXS DCT BUZRD DCT SEY DCT HTO J174 ORF J121 CHS EESNT LUNNI1</code>) encodes an overall speed (here <code>N0440</code>
meaning <code>440 knots</code>), an overall altitude (here <code>F310</code> which means &#34;Flight
Level 310&#34; which means <code>310 × 100 ft</code> (can also be in <code>km</code>)), and a sequence of
waypoints (referenced by name) separated by a description of how to get from the
previous waypoint to the next one, usually by referencing a &#34;known route&#34; by
name.</p>
<blockquote>
<p>The flight plan was accepted by IFPS
[..] </p>
<p>At 08:32 the flight plan was received by NATS’ FPRSA-R sub-system from
Eurocontrol’s IFPS system. This is consistent with the 4 hour rule mentioned
above. The purpose of the FPRSA-R software is to extract the UK portion of the
flight plan [..]</p>
<p>The flight plans delivered to FPRSA-R by IFPS are converted from [..] ICAO4444
to [..] ADEXP. ADEXP is a European-wide flight plan specification that
includes, amongst other data, additional geographical waypoints within the
European region specific to the route of a flight. For flights transiting
through UK airspace, rather than landing in the UK, this will include
additional waypoints outside of UK airspace required for its onward journey.
Following this conversion the ADEXP version of a flight plan includes, amongst
other aspects, the original ICAO4444 flight plan plus an additional list of
waypoints and other data.</p>
</blockquote>
<p>ADEXP looks like this:</p>
<pre><code><span>-TITLE IFPL
</span><span>-BEGIN ADDR
</span><span>  -FAC LIIRZEZX
</span><span>  [...]
</span><span>  -FAC LYZZEBXX
</span><span>-END ADDR
</span><span>-ADEP EDDF
</span><span>-ADES LGTS
</span><span>-ARCID KIM1
</span><span>-ARCTYP B738
</span><span>-CEQPT SDGRWY
</span><span>-EOBD 170729
</span><span>-EOBT 0715
</span><span>-FILTIM 280832
</span><span>-IFPLID AT00441635
</span><span>-ORIGIN -NETWORKTYPE SITA -FAC FRAOXLH
</span><span>-SEQPT C
</span><span>-WKTRC M
</span><span>-PBN B2
</span><span>-REG DABHM
</span><span>-SEL KMGJ
</span><span>-SRC FPL
</span><span>-TTLEET 0210
</span><span>-RFL F330
</span><span>-SPEED N0417
</span><span>-FLTRUL I
</span><span>-FLTTYP S
</span><span>-ROUTE N0417F330 ANEKI8L ANEKI Y163 NATOR UN850 TRA UP131 RESIA Q333
</span><span>BABAG UN606 PEVAL DCT PETAK UL607 PINDO UM603 EDASI
</span><span>-ALTRNT1 LBSF
</span><span>-BEGIN RTEPTS
</span><span>  -PT -PTID EDDF -FL F004 -ETO 170729073000
</span><span>  -PT -PTID RID -FL F100 -ETO 170729073404
</span><span>  -PT -PTID ANEKI -FL F210 -ETO 170729073856
</span><span>  -PT -PTID NEKLO -FL F214 -ETO 170729073911
</span><span>  -PT -PTID BADLI -FL F248 -ETO 170729074118
</span><span>  -PT -PTID PABLA -FL F279 -ETO 170729074348
</span><span>  -PT -PTID HERBI -FL F308 -ETO 170729074624
</span><span>  -PT -PTID NATOR -FL F330 -ETO 170729074911
</span><span>  -PT -PTID TITIX -FL F330 -ETO 170729075154
</span><span>  -PT -PTID TRA -FL F330 -ETO 170729075323
</span><span>  -PT -PTID ARGAX -FL F330 -ETO 170729080055
</span><span>  -PT -PTID RESIA -FL F330 -ETO 170729080731
</span><span>  -PT -PTID UNTAD -FL F330 -ETO 170729081243
</span><span>  -PT -PTID DIKEM -FL F330 -ETO 170729081627
</span><span>  -PT -PTID ROKIB -FL F330 -ETO 170729081824
</span><span>  -PT -PTID BABAG -FL F330 -ETO 170729082816
</span><span>  -PT -PTID PEVAL -FL F330 -ETO 170729082916
</span><span>  -PT -PTID PETAK -FL F330 -ETO 170729091754
</span><span>  -PT -PTID PINDO -FL F330 -ETO 170729093322
</span><span>  -PT -PTID EDASI -FL F165 -ETO 170729094347
</span><span>  -PT -PTID LGTS -FL F000 -ETO 170729095713
</span><span>-END RTEPTS
</span><span>-SID ANEKI8L
</span><span>-ATSRT Y163 ANEKI NATOR
</span><span>-ATSRT UN850 NATOR TRA
</span><span>-ATSRT UP131 TRA RESIA
</span><span>-ATSRT Q333 RESIA BABAG
</span><span>-ATSRT UN606 BABAG PEVAL
</span><span>-DCT PEVAL PETAK
</span><span>-ATSRT UL607 PETAK PINDO
</span><span>n -ATSRT UM603 PINDO EDASI
</span></code></pre>
<p>You can read about ADEXP in the <a href="https://www.eurocontrol.int/sites/default/files/2023-06/eurocontrol-released-specification-adexp-3-4.pdf" title="pdf">official spec</a>.
Some notable fields (page 48):</p>
<table><thead><tr><th>Adexp Primary Field</th><th>Kind</th><th>Syntax</th><th>Semantic</th></tr></thead><tbody>
<tr><td>route</td><td>b</td><td><code>&#39;-&#39; &#34;ROUTE&#34; {LIM_CHAR}</code></td><td>Complete ICAO Field 15 information containing speed, RFL and route (conforming to the syntax given in Ref. [3]).</td></tr>
<tr><td>rtepts</td><td>c</td><td><code>&#39;-&#39; &#34;BEGIN&#34; &#34;RTEPTS&#34; { pt I ad / vec} &#39;-&#39; &#34;END&#34; &#34;RTEPTS&#34;</code></td><td>List of route points. May also contain an aerodrome identifier.</td></tr>
</tbody></table>
<p>In the example, we have the ICAO route:</p>
<pre><code><span>-ROUTE N0417F330 ANEKI8L ANEKI Y163 NATOR UN850 TRA UP131 RESIA Q333 BABAG UN606 PEVAL DCT PETAK UL607 PINDO UM603 EDASI
</span></code></pre>
<p>(9 waypoints, 11 if you add the start and end waypoints)</p>
<p>Visually, routes look like:
<img src="https://jameshaydon.github.io/nats-fail/flight_plan.png" alt="some route" title="A flight plan route"/></p>
<p>(You can play around with flight plans at
<a href="https://flightplandatabase.com">flightplandatabase.com</a>, a website for people
who like playing with flight simulators)</p>
<p>We can indent the &#34;route&#34; parts between the waypoints in the ICAO plan to make
things clearer:</p>
<pre><code><span>N0417F330
</span><span>  ANEKI8L 
</span><span>  ANEKI 
</span><span>    Y163
</span><span>  NATOR
</span><span>    UN850
</span><span>  TRA
</span><span>    UP131
</span><span>  RESIA
</span><span>    Q333
</span><span>  BABAG
</span><span>    UN606
</span><span>  PEVAL
</span><span>    DCT
</span><span>  PETAK
</span><span>    UL607
</span><span>  PINDO
</span><span>    UM603
</span><span>  EDASI
</span></code></pre>
<p>E.g. <code>ANEKI Y163 NATOR</code> means &#34;go from waypoint <code>ANEKI</code> to waypoint <code>NATOR</code> via
the route <code>Y163</code>&#34;. <code>DCT</code> means &#34;direct&#34;.</p>
<p>The <code>ADEXP</code> format has more waypoints, along with more precision about altitude and estimated time at each waypoint:</p>
<pre><code><span>-BEGIN RTEPTS
</span><span>-PT -PTID EDDF  -FL F004 -ETO 170729073000
</span><span>-PT -PTID RID   -FL F100 -ETO 170729073404
</span><span>-PT -PTID ANEKI -FL F210 -ETO 170729073856
</span><span>-PT -PTID NEKLO -FL F214 -ETO 170729073911
</span><span>-PT -PTID BADLI -FL F248 -ETO 170729074118
</span><span>-PT -PTID PABLA -FL F279 -ETO 170729074348
</span><span>-PT -PTID HERBI -FL F308 -ETO 170729074624
</span><span>-PT -PTID NATOR -FL F330 -ETO 170729074911
</span><span>-PT -PTID TITIX -FL F330 -ETO 170729075154
</span><span>-PT -PTID TRA   -FL F330 -ETO 170729075323
</span><span>-PT -PTID ARGAX -FL F330 -ETO 170729080055
</span><span>-PT -PTID RESIA -FL F330 -ETO 170729080731
</span><span>-PT -PTID UNTAD -FL F330 -ETO 170729081243
</span><span>-PT -PTID DIKEM -FL F330 -ETO 170729081627
</span><span>-PT -PTID ROKIB -FL F330 -ETO 170729081824
</span><span>-PT -PTID BABAG -FL F330 -ETO 170729082816
</span><span>-PT -PTID PEVAL -FL F330 -ETO 170729082916
</span><span>-PT -PTID PETAK -FL F330 -ETO 170729091754
</span><span>-PT -PTID PINDO -FL F330 -ETO 170729093322
</span><span>-PT -PTID EDASI -FL F165 -ETO 170729094347
</span><span>-PT -PTID LGTS  -FL F000 -ETO 170729095713
</span><span>-END RTEPTS
</span></code></pre>
<p>(21 waypoints)</p>
<p>We can mark which of the ADEXP waypoints have a corresponding waypoint in the ICAO plan (with a <code>+</code>) and which are implicit (with a <code>|</code>): </p>
<pre><code><span>EDDF   |
</span><span>RID    |
</span><span>ANEKI  + 
</span><span>NEKLO  |
</span><span>BADLI  |
</span><span>PABLA  |
</span><span>HERBI  |
</span><span>NATOR  +
</span><span>TITIX  |
</span><span>TRA    +
</span><span>ARGAX  |
</span><span>RESIA  +
</span><span>UNTAD  |
</span><span>DIKEM  |
</span><span>ROKIB  |
</span><span>BABAG  +
</span><span>PEVAL  |
</span><span>PETAK  +
</span><span>PINDO  +
</span><span>EDASI  +
</span><span>LGTS   |
</span></code></pre>
<p>Note that the ICAO waypoints do not contain the start and end, since in the
original ICAO format these are specified in other fields (so it would waste
space to list them again in this list).</p>
<blockquote>
<p>The ADEXP waypoints plan included two waypoints along its route that were
geographically distinct but which have the same designator.</p>
</blockquote>
<p>This means there were two lines like:</p>
<pre><code><span>-PT -PTID RESIA -FL F330 -ETO 170729080731
</span></code></pre>
<p>that had the same <code>PTID</code> string like <code>&#34;RESIA&#34;</code>.</p>
<blockquote>
<p>Although there has been work by ICAO and other bodies to eradicate non-unique
waypoint names there are duplicates around the world. In order to avoid
confusion latest standards state that such identical designators should be
geographically widely spaced. In this specific event, both of the waypoints
were located outside of the UK, one towards the beginning of the route and one
towards the end; approximately 4000 nautical miles apart.</p>
</blockquote>
<p>4000 nautical miles is 7408km. Here is an arc of that length on the globe:
<img src="https://jameshaydon.github.io/nats-fail/4000-nautical-miles.png" alt="4000 nautical miles on a globe"/></p>
<blockquote>
<p>Once the ADEXP file had been received, the FPRSA-R software commenced
searching for the UK airspace entry point in the waypoint information per the
ADEXP flight plan, commencing at the first line of that waypoint data. FPRSA-R
was able to specifically identify the character string as it appeared in the
ADEXP flight plan text.</p>
</blockquote>
<p>The programming style is very imperative. Furthermore, the description sounds
like the procedure is working directly on the textual representation of the
flight plan, rather than a data structure parsed from the text file. This would
be quite worrying, but it might also just be how it is explained.</p>
<blockquote>
<p>Having correctly identified the entry point, the software moved on to search
for the exit point from UK airspace in the waypoint data.</p>
<p>Having completed those steps,</p>
</blockquote>
<p>This part of the code identified <code>entry</code> and <code>exit</code> waypoints to UK airspace in
the list of <code>ADEXP</code> waypoints.</p>
<blockquote>
<p>FPRSA-R then searches the ICAO4444 section of
the ADEXP file.</p>
</blockquote>
<p>It seems at this point, having identified the entry and exit points from the
list of ADEXP waypoints, it will try to extract the UK portion of the flight plan from the ICAO route.</p>
<blockquote>
<p>It initially searches from the beginning of that data, to find
the identified UK airspace entry point. This was successfully found. Next, it
searches backwards, from the end of that section, to find the UK airspace exit
point. This did not appear in that section of the flight plan so the search
was unsuccessful. As there is no requirement for a flight plan to contain an
exit waypoint from a Flight Information Region (FIR) or a country’s airspace,
the software is designed to cope with this scenario.</p>
<p>Therefore, where there is no UK exit point explicitly included, the software
logic utilises the waypoints as detailed in the ADEXP file to search for the
next nearest point beyond the UK exit point. This was also not present.</p>
<p>The software therefore moved on to the next waypoint.</p>
</blockquote>
<p>OK, so I think this is what is going on, the situation looked something like
this:</p>
<pre><code><span>           4       2        8         5              1           9
</span><span>ICAO:  F------Q--------T--------O-----------P---------------Y--------U
</span><span>
</span><span>ADEXP: F   S  Q    C   T   A    O  E  X     P   W   B   Q   Y        U
</span><span>                       UK  UK   UK UK UK    UK  UK
</span></code></pre>
<p>Here the ICAO route has waypoints (represented by capital letters) separated by
known routes (numbers). On the bottom we have the ADEXP waypoints. The ADEXP
waypoints that are located in the UK airspace are marked with <code>UK</code>.</p>
<ul>
<li>The software has identified:
<ul>
<li><code>entry</code>: waypoint <code>T</code></li>
<li><code>exit</code>: waypoint <code>W</code>
in the ADEXP waypoints.</li>
</ul>
</li>
<li>The software finds waypoint <code>T</code> in the ICAO flight plan.</li>
<li>The software <em>does not</em> find waypoint <code>W</code> in the ICAO flight plan.</li>
<li>The software therefore takes the next waypoint in the ADEXP list, so <code>B</code>, and
tries to find it too, and also does not find it.</li>
<li>So it does this again, taking waypoint <code>Q</code>, and it <em>does</em> find it, but at the
<em>start</em> of the ICAO flight plan, before the plane even enters the UK.</li>
</ul>
<blockquote>
<p>This search was successful as a duplicate identifier appeared in the flight
plan.</p>
</blockquote>
<p>What should the software have done? Well, <code>Q</code> is clearly <em>not</em> the waypoint we
are searching for, we are searching for waypoint <code>Y</code>, since <code>[T, O, P, Y]</code> is
the smallest segment of the ICAO plan that contains all the UK waypoints.</p>
<p>It&#39;s important to note here that the original algorithm is buggy; it is perfectly
possible to unambiguously extract the UK portion of this example flight plan;
see <a href="https://jameshaydon.github.io/nats-fail/#how-to-code-this-properly">below</a>. And this is likely the case for the
flight plan that caused the meltdown too.</p>
<blockquote>
<p>Having found an entry and exit point, with the latter being the duplicate and
therefore geographically incorrect, the software could not extract a valid UK
portion of flight plan between these two points. This is the root cause of the
incident. We can therefore rule out any cyber related contribution to this
incident.</p>
</blockquote>
<p>It sounds like the exception was raised in a later portion of the code, which
converts the plan to an internal format for <em>NAS</em>. This part failed because the
identified entry/exit waypoints didn&#39;t even specify a valid segment of the ICAO
route.</p>
<blockquote>
<p>Safety critical software systems are designed to always fail safely. This
means that in the event they cannot proceed in a demonstrably safe manner,
they will move into a state that requires manual intervention.</p>
</blockquote>
<p>We are left wondering if, had the misidentified waypoint been in a more
plausible geographic location, the code might not have thrown an exception and
passed along wrong data to ATCOs.</p>
<blockquote>
<p>In this case the software within the FPRSA-R subsystem was unable to establish
a reasonable course of action that would preserve safety and so raised a
critical exception. A critical exception is, broadly speaking, an exception of
last resort after exploring all other handling options. Critical exceptions
can be raised as a result of software logic or hardware faults, but
essentially mark the point at which the affected system cannot continue.</p>
</blockquote>
<p>It sounds like the software was written thinking this exception would never
occur.</p>
<blockquote>
<p>Clearly a better way to handle this specific logic error would be for FPRSA-R
to identify and remove the message and avoid a critical exception. However,
since flight data is safety critical information that is passed to ATCOs the
system must be sure it is correct and could not do so in this case. It
therefore stopped operating, avoiding any opportunity for incorrect data being
passed to a controller. The change to the software will now remove the need
for a critical exception to be raised in these specific circumstances.</p>
<p>Having raised a critical exception the FPRSA-R primary system wrote a log file
into the system log. It then correctly placed itself into maintenance mode and
the C&amp;M system identified that the primary system was no longer available. In
the event of a failure of a primary system the backup system is designed to
take over processing seamlessly. In this instance the backup system took over
processing flight plan messages. As is common in complex real-time systems the
backup system software is located on separate hardware with separate power and
data feeds.</p>
<p>Therefore, on taking over the duties of the primary server, the backup system
applied the same logic to the flight plan with the same result. It
subsequently raised its own critical exception, writing a log file into the
system log and placed itself into maintenance mode.</p>
<p>At this point with both the primary and backup FPRSA-R sub-systems having
failed safely the FPRSA-R was no longer able to automatically process flight
plans. It required restoration to normal service through manual intervention.
The entire process described above, from the point of receipt of the ADEXP
message to both the primary and backup sub-systems moving into maintenance
mode, took less than 20 seconds. 08:32 therefore marks the point at which the
automatic processing of flight plans ceased and the 4 hour buffer to manual
flight plan input commenced. The steps taken to restore the FPRSA-R sub-system
are described in section 5 of this report.</p>
</blockquote>
<p>Then support teams tried to fix things, but unfortunately it took longer than
the 4 hours they had:</p>
<blockquote>
<p>The 1st Line support team were alerted to the incident through the C&amp;M systems
that directly monitor operational systems as well as through direct feedback
from the Operational teams using the FPRSA-R sub-system at the time. The
initial response for the team followed standard recovery processes using the
centralised C&amp;M systems to restart the sub-system. Following multiple attempts
to restore the service, which were unsuccessful, the 2nd Line engineering team
was mobilised and supported the on-site engineers remotely via video link.</p>
</blockquote>
<p><img src="https://jameshaydon.github.io/nats-fail/off-and-on-again.jpg" alt="have you tried turning it off and on again?"/></p>
<p>As sharp-eyed reddit user <code>voidstarcpp</code> <a href="https://www.reddit.com/r/programming/comments/16fhmuq/comment/k03tlx8/?utm_source=share&amp;utm_medium=web2x&amp;context=3">points out</a>, it&#39;s interesting to contrast these two parts of the report:</p>
<blockquote>
<p>However, since flight data is safety critical information that is passed to
ATCOs the system must be sure it is correct and could not do so in this case.
It therefore stopped operating, avoiding any opportunity for incorrect data
being passed to a controller.</p>
</blockquote>
<p>and</p>
<blockquote>
<p>The initial response for the team followed standard recovery processes using
the centralised C&amp;M systems to restart the sub-system.</p>
</blockquote>
<p>If a critical error had detected that incorrect data could be passed to ATCOs if
flight plan processing continue, then, since the team didn&#39;t know what was
wrong, why did they try to restart processing flight plans?</p>
<blockquote>
<p>The on-call teams working remotely with the on-site engineering teams followed
a staged analysis, involving increasingly detailed procedures to attempt to
resolve the issue, none of which were successful. As per standard escalation
procedures, 2nd Line engineers were engaged to provide further access to
advanced diagnostics and logging capabilities.</p>
</blockquote>
<p>It doesn&#39;t say how long it took, but the manufacturer of the <code>FPRSA-R</code> system was
eventually called:</p>
<blockquote>
<p>Additional support was then requested from the Technical Design team and
sub-system manufacturer as 1st and 2nd Line support had been unable to restore
the service or identify the precise root cause, which was unusual. The
manufacturer was able to offer further expertise including analysis of
lower-level software logs which led to identification of the likely flight
plan that had caused the software exception. Through understanding which
flight plan had caused the incident the manufacturer was able to provide the
precise sequence of actions necessary to recover the system in a controlled
and safe manner.</p>
</blockquote>
<p>The system was eventually restored, but unfortunately the knock-on effects by
that point were already disastrous.</p>
<p>The manufacturer is an Austrian company, <a href="https://en.wikipedia.org/wiki/Frequentis">Frequentis
AG</a>:</p>
<blockquote>
<p>An FPRSA sub-system has existed in NATS for many years and in 2018 the
previous FPRSA sub- system was replaced with new hardware and software
manufactured by Frequentis AG, one of the leading global ATC System providers.
The manufacturer’s ATC products are operating in approximately 150 countries
and they hold a world-leading position in aeronautical information management
(AIM) and message handling systems.</p>
</blockquote>
<p>The &#34;Nobody ever gets fired for hiring Accenture&#34; defence.</p>
<p>We can find a few job ads related to air traffic control systems at Frequentis
AG on their <a href="https://jobs.frequentis.com/careers/SearchJobs/air?listFilterMode=1">careers
page</a>
Programming languages used: <code>Ada</code>, <code>C++</code>, <code>Java</code>, <code>Python</code>, with <code>Java</code> being
the most common. The code above sounds like it could have been written in any of
these languages, but Ada would at least be safer than the others in other ways.</p>
<h2 id="thoughts">Thoughts</h2>
<p>Things that went wrong:</p>
<ol>
<li>The software that processes flight plans (<code>FPRSA-R</code>) was written in a buggy
way.</li>
<li>The software and system are not properly tested.</li>
<li>The <code>FPRSA-R</code> system has bad <a href="https://en.wikipedia.org/wiki/Failure_mode_and_effects_analysis" title="wikipedia">failure modes</a></li>
</ol>
<h3 id="the-software-was-buggy">The software was buggy</h3>
<p>The software was incapable of extracting the UK portion of the ICAO flight plan,
even though the flight plan was apparently valid (at least according to IFPS).</p>
<ul>
<li>
<p>The procedure was very fiddly and failed for a silly reason.</p>
</li>
<li>
<p>Waypoint markers are not globally unique, but this is a known issue, so NATS
should make sure their systems are robust enough to handle it. <em>All other air
traffic control authorities have to deal with this</em>. NATS says the following
about this in the report:</p>
<blockquote>
<p>Although there has been work by ICAO and other bodies to eradicate
non-unique waypoint names there are duplicates around the world. In order to
avoid confusion latest standards state that such identical designators
should be geographically widely spaced. In this specific event, both of the
waypoints were located outside of the UK, one towards the beginning of the
route and one towards the end; approximately 4000 nautical miles apart.</p>
</blockquote>
<p>When waypoints with the same name are widely spaced, this makes flight plans
unambiguous, because successive waypoints in a flight plan cannot be too far
apart. They also mention possible actions they will take:</p>
<blockquote>
<p>The feasibility of working through the UK state with ICAO to remove the
small number of duplicate waypoint names in the ICAO administered global
dataset that relate to this incident.</p>
</blockquote>
<p>Waypoint names are clearly chosen to be short and snappy. Here&#39;s a sequence
from some flight plan I found: <code>KOMAL</code>, <code>ATRAK</code>, <code>SORES</code>, <code>SAKTA</code>, <code>ALMIK</code>,
<code>IGORO</code>, <code>ATMED</code>, etc. It&#39;s clear that the system has been designed so these
names can be communicated quickly, e.g. over radio, and that pilots and
air traffic controllers can become familiar with those on the routes they
usually fly. Changing the name of a waypoint can be a scary operation.
Uniqueness is obviously desirable, but it has to be balanced against other
considerations. Including this suggestion in the initial report feels like
NATS is trying to shift the blame onto ICAO.</p>
<p>Furthermore, I don&#39;t see why a flight plan can&#39;t include the same <em>geographic</em>
waypoint several times; for example for leisure flights or military exercises.
Taking off and landing at the same airport is definitely a thing (called a
&#34;round-robin flight plan&#34;). It doesn&#39;t sound like the <code>FPRSA-R</code> algorithm
would be very robust to that.</p>
</li>
</ul>
<p>NATS officials are trying to spin this as:</p>
<blockquote>
<p>An air traffic meltdown in Britain was caused by a &#34;one in 15 million&#34; event,
the boss of traffic control provider NATS said, as initial findings showed how
a single flight plan with two identically labelled markers caused the chaos.</p>
<p>&#34;This was a one in 15 million chance. We&#39;ve processed 15 million flight plans
with this system up until this point and never seen this before,&#34; NATS CEO
Martin Rolfe told the BBC, as airlines stepped up calls for compensation for
the breakdown. <a href="https://www.reuters.com/world/uk/uk-aviation-regulator-review-air-traffic-control-failure-2023-09-06/">Reuters</a></p>
</blockquote>
<p>The system was put in place in 2018, so what Martin Rolfe is saying here is that
this sort of thing only had a chance of occurring &#34;once every 5 years&#34;, which is
apparently an acceptable frequency for having a complete air traffic control
meltdown.</p>
<h3 id="the-system-was-poorly-tested">The system was poorly tested</h3>
<p><a href="https://en.wikipedia.org/wiki/Fuzzing">fuzzing</a>, for example, may have
prevented this. By bombarding such a system with randomly generated flight
plans, you can see if any of them cause bad failure modes: a crashed system
where one doesn&#39;t know immediately what went wrong. By inspecting which sorts of
flight plans cause problems, it would become apparent that those with duplicate
waypoint identifiers in the ADEXP portion cannot be processed properly.</p>
<h3 id="the-fprsa-r-system-has-bad-failure-modes">The <code>FPRSA-R</code> system has bad failure modes</h3>
<p>All systems can malfunction, so the important thing is that they malfunction <em>in
a good way</em> and that those responsible are <em>prepared</em> for malfunctions.</p>
<p>A single flight plan caused a problem, and the entire <code>FPRSA-R</code> system crashed,
which means no flight plans are being processed at all. If there is a problem
with a single flight plan, it should be moved to a separate slower queue, for
manual processing by humans. NATS acknowledges this in their &#34;actions already
undertaken or in progress&#34;:</p>
<blockquote>
<p>The addition of specific message filters into the data flow between IFPS and
FPRSA-R to filter out any flight plans that fit the conditions that caused the
incident.</p>
</blockquote>
<p>When <code>FPRSA-R</code> it did crash, it did so in an obscure way. This is a system
which <em>processes flight plans</em>, yet the relevant flight plan was only found in
&#34;lower-level software logs&#34;. If there is an error processing a flight plan,
which brings down the whole system, a notification (including the flight plan)
should immediately be sent to some monitoring team.</p>
<p>NATS was also not prepared for an <code>FPRSA-R</code> system failure. The 1st
and 2nd Line support engineers were not able to locate, or did not think to
check, the low-level log files. This has been fixed:</p>
<blockquote>
<p>An operating instruction has been put in place to allow prompt recovery of the
FPRSA-R sub-system if the same circumstances recur. Each of the technical
operators have been trained to implement the new process. With enhanced
monitoring in place, additional engineering expertise will also be present to
oversee the activity.</p>
</blockquote>
<p>But, the low-level log files inside the magic <code>FPRSA-R</code> box provided by
Frequentis AG was not the only place where the flight plan existed. Indeed, when
the primary crashed, the queue of flight plans was redirected to the backup,
which failed in the exact same way on the exact same flight plan. It stands to
reason that if the system that is meant to process flight plans has crashed,
that might be because of a problematic flight plan. So they could have simply
tried skipping a few that were at the head of the queue, to see if this fixed
the problem. (And then processed those manually.)</p>
<h3 id="possible-lack-of-formal-verification">Possible lack of formal verification</h3>
<p>As reddit user <code>DontWannaMissAFling</code> <a href="https://www.reddit.com/r/programming/comments/16fhmuq/comment/k02o6n8/?utm_source=share&amp;utm_medium=web2x&amp;context=3">points out</a>:</p>
<blockquote>
<p>But what&#39;s wild to me is that something as safety critical as air traffic
control apparently isn&#39;t using proven techniques like formal verification,
model checking to eliminate these classes of bugs entirely.</p>
<p>Like as an industry we use TLA+ to stop AWS from having downtime or Xboxes
segfaulting, but not to keep planes in the air?</p>
</blockquote>
<p>I agree that it certainly doesn&#39;t sound like any formal verification was used in
this case (for this system), and the report doesn&#39;t mention anything. Using
formal verification would certainly have helped here, I might explore this in
subsequent posts.</p>
<p>But it&#39;s possible formal verification was used, but faulty code still made its
way into production: end-2-end formal verification for large systems is still in
its infancy. We&#39;ll have to wait for the result of the enquiry to know more.</p>
<h2 id="humans-were-kept-safe-at-all-times">Humans were kept safe at all times</h2>
<p>I&#39;d like to note (as does NATS in the report) that despite all the problems
highlighted above, planes in the air over the UK were still safe at all times.
They were being monitored by experienced ATCOs, which monitor planes by their
known flight plan, radio, radar and vision. The consequence of all this was not
that any human lives were put in danger, it&#39;s simply that far fewer flights
could take off in the first place, or had to be diverted away from UK airspace.
NATS did the right thing (reducing the number of flights), and kept everybody
safe.</p>
<h2 id="how-to-code-this-properly">How to code this properly</h2>
<p>So, how can we avoid this bug?</p>
<p>Let&#39;s recap the problem. There are two sequences of waypoints:</p>
<ul>
<li><code>ADEXP</code>: the full list of waypoints.</li>
<li><code>ICAO</code>: a subsequence of the ADEXP waypoints.</li>
</ul>
<p>Because the ICAO plan doesn&#39;t need to include the waypoints at which it
enters/exits an air traffic control region, extracting the segment of the ICAO
flight plan corresponding to the UK portion of the flight is not entirely
trivial. Of course, if we take the entire ICAO flight plan, it already contains
the UK portion, but what we really want is the <em>smallest</em> such segment. It&#39;s
interesting to note here that a flight could possibly enter UK airspace, and
then exit it again, and enter it again. We&#39;ll ignore this, that is, we will just
find a single contiguous segment that contains all UK portions of the flight,
since this is what the original code seemed to do.</p>
<p>I&#39;m unsure why this task attempts to do this only using the ADEXP data, rather
than consulting a database about how waypoints and flight segments intersect UK
airspace. It seems strange, but let&#39;s move on.</p>
<p>Note that it is impossible to achieve this task with the ICAO flight plan alone
(and no knowledge of routes), even if you know for each waypoint if it is in the
UK or not. Indeed you could even be in a situation where <em>none</em> of the waypoints
in the ICAO route are in the UK, for example when the flight plan clips a small
portion of the UK between two of the ICAO waypoints.</p>
<p>So this is why the ADEXP waypoint list is used, and the assumption here, I
assume, is that the ADEXP list contains <em>all</em> the waypoints, and that
furthermore, waypoint granularity is such that if <em>adjacent</em> waypoints both
don&#39;t intersect UK airspace, then the segment between them doesn&#39;t either.</p>
<p>The mistake of the faulty algorithm described above is to try to work on both
the ICAO data and the ADEXP data as they are, maintaining pointers into each of
them, updating them with vague and wrong invariants in the background of the
programmer&#39;s mind. This is a recipe for bugs. Instead, the first thing to do is
to reconcile the data and then carefully extract the UK portion from that.</p>
<p>So we create a data structure for a plan:</p>
<pre data-lang="haskell"><code data-lang="haskell"><span>-- A flight plan, with segments between points &#39;p&#39; via routes &#39;r&#39;.
</span><span>data </span><span>Plan</span><span> p r
</span><span>  = </span><span>End</span><span> p
</span><span>  | </span><span>Leg</span><span> p r (</span><span>Plan</span><span> p r)
</span></code></pre>
<p>(This is <a href="https://www.haskell.org/">Haskell</a> code, but the ideas apply to most languages.)</p>
<p>This says that a <code>Plan p r</code> has either arrived at its destination <code>End p</code>, or
consists of a segment starting from <code>p</code>, via <code>r</code>, and the <code>rest</code> of the plan:
<code>Leg p r rest</code>.</p>
<p>We can now define all the sorts of flight plan data we will deal with:</p>
<pre data-lang="haskell"><code data-lang="haskell"><span>type </span><span>ICAO</span><span>     p r = </span><span>Plan</span><span> p r         </span><span>-- points and routes, no intermediate waypoints
</span><span>type </span><span>ADEXP</span><span>    p   = </span><span>Plan</span><span> p [p]       </span><span>-- points and intermediate waypoints, no route data
</span><span>type </span><span>Combined</span><span> p r = </span><span>Plan</span><span> p (</span><span>Via</span><span> p r) </span><span>-- all the data combined
</span><span>
</span><span>data </span><span>Via</span><span> p r = </span><span>Via
</span><span>  { route   :: r,
</span><span>    </span><span>through </span><span>::</span><span> [</span><span>p</span><span>]
</span><span>  }
</span><span>  </span><span>deriving</span><span> stock (</span><span>Show</span><span>)
</span></code></pre>
<p>Here <code>Combined</code> is our reconciled flight plan, it combined all the information
form ICAO and ADEXP. We can project a <code>Plan</code> back down to <code>ICAO</code> or <code>ADEXP</code>:</p>
<pre data-lang="haskell"><code data-lang="haskell"><span>projectICAO </span><span>:: Combined </span><span>p r </span><span>-&gt; ICAO </span><span>p r
</span><span>projectICAO = mapRoutes (.route)
</span><span>
</span><span>projectADEXP </span><span>:: Combined </span><span>p r </span><span>-&gt; ADEXP </span><span>p
</span><span>projectADEXP = mapRoutes (.through)
</span><span>
</span><span>mapRoutes </span><span>::</span><span> (</span><span>r </span><span>-&gt; </span><span>r</span><span>&#39;) </span><span>-&gt; Plan </span><span>p r </span><span>-&gt; Plan </span><span>p r</span><span>&#39;
</span><span>mapRoutes _ (</span><span>End</span><span> p) = </span><span>End</span><span> p
</span><span>mapRoutes f (</span><span>Leg</span><span> p r rest) = </span><span>Leg</span><span> p (f r) (mapRoutes f rest)
</span></code></pre>
<p>We&#39;ll assume we have already parsed the data into the data structures above.
This is just a matter of reading the spec carefully and turning it into code,
and hopefully something the <code>FPRSA-R</code> did correctly, though as noted previously
it might be working on the text version directly.</p>
<p>Now we write our reconciliation function. For ICAO and ADEXP to reconcile, the
start and end points must match. When reconciling a leg of a flight plan, a
certain amount of waypoints can be skipped in the ICAO plan, and the rest of
them must reconcile with the rest of the flight plan:</p>
<pre data-lang="haskell"><code data-lang="haskell"><span>reconcile </span><span>::</span><span> (</span><span>Eq </span><span>p</span><span>) </span><span>=&gt; ICAO </span><span>p r </span><span>-&gt;</span><span> [</span><span>p</span><span>] </span><span>-&gt;</span><span> [</span><span>Combined </span><span>p r</span><span>]
</span><span>reconcile (</span><span>End</span><span> p) [p&#39;]             | p == p&#39; = pure (</span><span>End</span><span> p)
</span><span>reconcile (</span><span>Leg</span><span> p r rest) (p&#39; : ps) | p == p&#39; = </span><span>do
</span><span>  (through, restAdexp) &lt;- splits ps
</span><span>  recoRest &lt;- reconcile rest restAdexp
</span><span>  pure (</span><span>Leg</span><span> p </span><span>Via</span><span> {route = r, through} recoRest)
</span><span>reconcile _ _ = </span><span>[]
</span><span>
</span><span>-- | All the ways to snap a list in two.
</span><span>splits </span><span>::</span><span> [</span><span>a</span><span>] </span><span>-&gt;</span><span> [([</span><span>a</span><span>], [</span><span>a</span><span>])]
</span><span>splits </span><span>[] </span><span>= [(</span><span>[]</span><span>, </span><span>[]</span><span>)]
</span><span>splits xs@(x : rest) = (</span><span>[]</span><span>, xs) : (first (x :) &lt;$&gt; splits rest)
</span></code></pre>
<p>Note that the function produces <em>all</em> the possible reconciliations. This is
because reconciliations are not necessarily unique because waypoints can appear
more than once. By calculating all the possible reconciliations, we&#39;ll know if
the data is ambiguous, and flag those flight plans for manual processing.</p>
<p>Next, we extract the UK portion of the flight plan. This is done in 3 steps:</p>
<ol>
<li>Remove all legs at the start which don&#39;t cross into UK airspace.</li>
<li>Traverse the legs which are in UK airspace.</li>
<li>Once the rest of the flight plan is never again in the UK, cut it short.</li>
</ol>
<p>Each function calls the next step in sequence. Note that we return a
<code>NonUkPlan</code> error when the system reaches the end of the plan without having
found a UK part. By having a compiler which checks that pattern-matches are
covering, the possible failures arise naturally while coding.</p>
<pre data-lang="haskell"><code data-lang="haskell"><span>-- Extract the UK part of the flight.
</span><span>ukSegment </span><span>::</span><span> (</span><span>p </span><span>-&gt; Bool</span><span>) </span><span>-&gt; Combined </span><span>p r </span><span>-&gt; Either Err</span><span> (</span><span>Combined </span><span>p r</span><span>)
</span><span>ukSegment uk (</span><span>End</span><span> p)
</span><span>  | nonUkPlan uk (</span><span>End</span><span> p) = </span><span>Left NonUkPlan
</span><span>  | otherwise = pure (</span><span>End</span><span> p)
</span><span>ukSegment uk plan@(</span><span>Leg</span><span> _ _ rest) =
</span><span>  </span><span>if</span><span> nonUkLeg uk plan
</span><span>    </span><span>then</span><span> ukSegment uk rest
</span><span>    </span><span>else</span><span> pure (flyUK uk plan)
</span><span>
</span><span>-- Fly the UK part of the flight.
</span><span>flyUK </span><span>::</span><span> (</span><span>p </span><span>-&gt; Bool</span><span>) </span><span>-&gt; Combined </span><span>p r </span><span>-&gt; Combined </span><span>p r
</span><span>flyUK _ (</span><span>End</span><span> end) = </span><span>End</span><span> end
</span><span>flyUK uk (</span><span>Leg</span><span> p v rest)
</span><span>  | nonUkPlan uk rest = </span><span>Leg</span><span> p v (afterUK rest)
</span><span>  | otherwise = </span><span>Leg</span><span> p v (flyUK uk rest)
</span><span>
</span><span>-- Skip the rest of the flight.
</span><span>afterUK </span><span>:: Combined </span><span>p r </span><span>-&gt; Combined </span><span>p r
</span><span>afterUK plan = </span><span>End</span><span> (start plan)
</span></code></pre>
<p>These use some small functions:</p>
<pre data-lang="haskell"><code data-lang="haskell"><span>-- The next leg of the journey doesn&#39;t fly through the UK.
</span><span>nonUkLeg </span><span>::</span><span> (</span><span>p </span><span>-&gt; Bool</span><span>) </span><span>-&gt; Combined </span><span>p r </span><span>-&gt; Bool
</span><span>nonUkLeg uk (</span><span>End</span><span> p) = not (uk p)
</span><span>nonUkLeg uk (</span><span>Leg</span><span> p v _) = not (uk p) &amp;&amp; not (any uk v.through)
</span><span>
</span><span>-- The whole plan isn&#39;t in the UK.
</span><span>nonUkPlan </span><span>::</span><span> (</span><span>a </span><span>-&gt; Bool</span><span>) </span><span>-&gt; Combined </span><span>a r </span><span>-&gt; Bool
</span><span>nonUkPlan uk plan = all (nonUkLeg uk) (legs plan)
</span><span>
</span><span>legs </span><span>:: Plan </span><span>p r </span><span>-&gt;</span><span> [</span><span>Plan </span><span>p r</span><span>]
</span><span>legs (</span><span>End</span><span> p) = [</span><span>End</span><span> p]
</span><span>legs plan@(</span><span>Leg</span><span> _ _ rest) = plan : legs rest
</span><span>
</span><span>start </span><span>:: Plan </span><span>p r </span><span>-&gt; </span><span>p
</span><span>start (</span><span>End</span><span> p) = p
</span><span>start (</span><span>Leg</span><span> p _ _) = p
</span></code></pre>
<p>Putting it all together, we get:</p>
<pre data-lang="haskell"><code data-lang="haskell"><span>ukPartOfICAO </span><span>::</span><span> (</span><span>Eq </span><span>p</span><span>) </span><span>=&gt;</span><span> (</span><span>p </span><span>-&gt; Bool</span><span>) </span><span>-&gt; ICAO </span><span>p r </span><span>-&gt;</span><span> [</span><span>p</span><span>] </span><span>-&gt; Either Err</span><span> (</span><span>ICAO </span><span>p r</span><span>)
</span><span>ukPartOfICAO uk icao adexp = </span><span>case</span><span> reconcile icao adexp </span><span>of
</span><span>  [plan] -&gt; projectICAO &lt;$&gt; ukSegment uk plan
</span><span>  </span><span>[]     </span><span>-&gt; </span><span>Left CannotReconcileIcaoAdexp
</span><span>  _      -&gt; </span><span>Left AmbiguousReconciliationsOfIcaoAdexp
</span></code></pre>
<p>We collected the following errors while coding:</p>
<pre data-lang="haskell"><code data-lang="haskell"><span>data </span><span>Err
</span><span>  = </span><span>NonUkPlan
</span><span>  | </span><span>CannotReconcileIcaoAdexp
</span><span>  | </span><span>AmbiguousReconciliationsOfIcaoAdexp
</span></code></pre>
<p>Let&#39;s test it with our example:</p>
<pre><code><span>           4       2        8         5              1           9
</span><span>ICAO:  F------Q--------T--------O-----------P---------------Y--------U
</span><span>
</span><span>ADEXP: F   S  Q    C   T   A    O  E  X     P   W   B   Q   Y        U
</span><span>                       UK  UK   UK UK UK    UK  UK
</span></code></pre>
<pre data-lang="haskell"><code data-lang="haskell"><span>inUK = (</span><span>`</span><span>elem</span><span>`</span><span> [&#34;</span><span>T</span><span>&#34;, &#34;</span><span>A</span><span>&#34;, &#34;</span><span>O</span><span>&#34;, &#34;</span><span>E</span><span>&#34;, &#34;</span><span>X</span><span>&#34;, &#34;</span><span>P</span><span>&#34;, &#34;</span><span>W</span><span>&#34;])
</span><span>icao = (&#34;</span><span>F</span><span>&#34;, </span><span>4</span><span>) ~&gt; (&#34;</span><span>Q</span><span>&#34;, </span><span>2</span><span>) ~&gt; (&#34;</span><span>T</span><span>&#34;, </span><span>8</span><span>) ~&gt; (&#34;</span><span>O</span><span>&#34;, </span><span>5</span><span>) ~&gt; (&#34;</span><span>P</span><span>&#34;, </span><span>1</span><span>) ~&gt; (&#34;</span><span>Y</span><span>&#34;, </span><span>9</span><span>) ~&gt; </span><span>End </span><span>&#34;</span><span>U</span><span>&#34;
</span><span>adexp = [&#34;</span><span>F</span><span>&#34;, &#34;</span><span>S</span><span>&#34;, &#34;</span><span>Q</span><span>&#34;, &#34;</span><span>C</span><span>&#34;, &#34;</span><span>T</span><span>&#34;, &#34;</span><span>A</span><span>&#34;, &#34;</span><span>O</span><span>&#34;, &#34;</span><span>E</span><span>&#34;, &#34;</span><span>X</span><span>&#34;, &#34;</span><span>P</span><span>&#34;, &#34;</span><span>W</span><span>&#34;, &#34;</span><span>B</span><span>&#34;, &#34;</span><span>Q</span><span>&#34;, &#34;</span><span>Y</span><span>&#34;, &#34;</span><span>U</span><span>&#34;]
</span><span>
</span><span>infixr </span><span>6 </span><span>~&gt;
</span><span>(~&gt;) (p, r) = </span><span>Leg</span><span> p r
</span></code></pre>
<p>And try this at the REPL:</p>
<pre><code><span>λ&gt; ukPortionOfICAO inUK icao adexp
</span><span>Right (Leg &#34;T&#34; 8 (Leg &#34;O&#34; 5 (Leg &#34;P&#34; 1 (End &#34;Y&#34;))))
</span></code></pre>
<p>We can see that this is the correct result:</p>
<pre><code><span>                                 UK portion of ICAO
</span><span>                       ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
</span><span>           4       2        8         5              1           9
</span><span>ICAO:  F------Q--------T--------O-----------P---------------Y--------U
</span><span>
</span><span>ADEXP: F   S  Q    C   T   A    O  E  X     P   W   B   Q   Y        U
</span><span>                       UK  UK   UK UK UK    UK  UK
</span></code></pre>
<p>The waypoint <code>Q</code> is a duplicate in the ADEXP list, but the system still returns
the correct portion of the ICAO flight path. Crisis averted! The fact that there
is a duplicate identifier in this case is immaterial, the ICAO and ADEXP data
still reconcile unambiguously, and the correct sub-route is well-defined.</p>
<p>How large can flight plans get? Well here is a flight plan from London to Sydney
that contains a total of 158 waypoints, and about a third of them appear in the
ICAO route:
<img src="https://jameshaydon.github.io/nats-fail/london-sydney.png" alt="London to Sydney flight plan"/> 
<code>ukPortionOfICAO</code> returns practically instantly for such a flight plan.</p>
<p>Comments on <a href="https://www.reddit.com/r/programming/comments/16fhmuq/a_deep_dive_into_the_bug_that_caused_the_uk_air/?utm_source=share&amp;utm_medium=web2x&amp;context=3">reddit</a> and <a href="https://news.ycombinator.com/item?id=37461695">Hacker News</a></p>

    </div></div>
  </body>
</html>
