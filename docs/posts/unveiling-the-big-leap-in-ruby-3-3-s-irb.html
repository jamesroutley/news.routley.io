<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://railsatscale.com/2023-12-19-irb-for-ruby-3-3/">Original</a>
    <h1>Unveiling the big leap in Ruby 3.3&#39;s IRB</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p>In this blog post, we will delve into the major enhancements introduced in Ruby 3.3’s <a href="https://github.com/ruby/irb">IRB</a>,
as well as what’s currently planned for the next year.</p>

<p>In a nutshell, Ruby 3.3’s IRB offers <a href="#advancing-debugging-with-irb">improved debugging capabilities</a>,
an <a href="#enhancing-autocompletion">enhanced autocompletion experience</a>,
and an <a href="#quality-of-life-improvements">overall improved user experience</a>.</p>

<p>It’s worth noting that even if you don’t upgrade to Ruby 3.3 immediately, you can still install the same version of IRB
(<a href="https://github.com/ruby/irb/releases/tag/v1.11.0"><code>v1.11.0</code></a>) in any Ruby 2.7+ projects by adding <code>gem &#34;irb&#34;</code> to its Gemfile.</p>

<h3 id="table-of-contents">Table Of Contents</h3>

<ul>
  <li><a href="#advancing-debugging-with-irb">Advancing Debugging with IRB</a>
    <ul>
      <li><a href="#accessing-irbrdbg-from-bindingbreak--debugger">Accessing <code>irb:rdbg</code> from <code>binding.break</code> / <code>debugger</code></a></li>
    </ul>
  </li>
  <li><a href="#enhancing-autocompletion">Enhancing Autocompletion</a>
    <ul>
      <li><a href="#addressing-completion-dropdown-issues">Addressing Completion Dropdown Issues</a></li>
      <li><a href="#customizing-dropdown-ui-with-relineface">Customizing Dropdown UI with <code>Reline::Face</code></a></li>
      <li><a href="#experimenting-with-more-accurate-completion-using-rbs">Experimenting with More Accurate Completion Using RBS</a></li>
    </ul>
  </li>
  <li><a href="#quality-of-life-improvements">Quality of Life Improvements</a>
    <ul>
      <li><a href="#pager-support">Pager Support</a></li>
      <li><a href="#omitting-return-value-inspection-with-">Omitting Return Value Inspection with <code>;</code></a></li>
      <li><a href="#history-command">History Command</a></li>
      <li><a href="#streamlined-prompt">Streamlined Prompt</a></li>
      <li><a href="#enhanced-show_source-command">Enhanced <code>show_source</code> Command</a></li>
    </ul>
  </li>
  <li><a href="#whats-on-the-horizon-for-ruby-34">What’s on the Horizon for Ruby 3.4?</a>
    <ul>
      <li><a href="#the-help-command-will-print-help-message">The <code>help</code> Command Will Print Help Message</a></li>
      <li><a href="#enhancing-extensibility-command-and-helper-method">Enhancing Extensibility: Command and Helper Method</a></li>
    </ul>
  </li>
  <li><a href="#acknowledgements">Acknowledgements</a></li>
</ul>

<h2 id="advancing-debugging-with-irb">Advancing Debugging with IRB</h2>

<p>In Ruby 3.2’s IRB (<code>v1.6</code>), we introduced a set of shortcut commands such as <code>debug</code> and <code>next</code> that allowed for a swift
transition to the <a href="https://github.com/ruby/debug"><code>debug</code> gem</a>’s session from a <code>binding.irb</code> breakpoint.
(To avoid confusion, I’ll refer to the <code>debug</code> gem’s session as <code>rdbg</code> from here on.)</p>

<p>This was a significant improvement. However, with the switch, users would instantly lose certain IRB features, such as multi-line input:</p>

<div><div><pre><code>irb<span>(</span>main<span>)</span>:001:0&gt; debug
<span>(</span>ruby<span>)</span> <span>if </span><span>true
eval </span>error: <span>(</span>rdbg<span>)</span>/test.rb:1: syntax error, unexpected end-of-input, expecting <span>`</span><span>then</span><span>&#39; or &#39;</span><span>;</span><span>&#39; or &#39;</span><span>\n</span><span>&#39;
if true
       ^
nil
(rdbg)
</span></code></pre></div></div>

<p>This year, we’ve taken the user experience to a new level by introducing the <code>irb:rdbg</code> session, which allows users to execute all <code>rdbg</code> commands without exiting the IRB session.</p>

<div><div><pre><code>irb<span>(</span>main<span>)</span>:001&gt; debug
irb:rdbg<span>(</span>main<span>)</span>:002<span>*</span> <span>if </span><span>true
</span>irb:rdbg<span>(</span>main<span>)</span>:003<span>*</span>   puts <span>&#34;Multi-line input and more!&#34;</span>
irb:rdbg<span>(</span>main<span>)</span>:004&gt; end
Multi-line input and more!
nil
irb:rdbg<span>(</span>main<span>)</span>:005&gt; th
<span># `th` (show all threads) is a example of a command only present in a `rdbg` session</span>
<span>--</span><span>&gt;</span> <span>#0 (sleep)@test.rb:2:in `&lt;main&gt;&#39;</span>
irb:rdbg<span>(</span>main<span>)</span>:006&gt;
</code></pre></div></div>

<p>This deep integration offers several advantages:</p>

<ul>
  <li>Access to both <a href="https://github.com/ruby/irb?tab=readme-ov-file#commands">IRB</a> and <a href="https://github.com/ruby/debug?tab=readme-ov-file#debug-command-on-the-debug-console">rdbg’s commands</a></li>
  <li>Multi-line input</li>
  <li>Autocompletion</li>
  <li>Symbol aliases to commands, like <code>@</code> (<code>whereami</code>) and <code>$</code> (<code>show_source</code>)</li>
  <li><a href="#pager-support">Pager support</a></li>
</ul>

<p>But most importantly, it offers users a debugging experience equivalent to <code>pry-byebug</code>.</p>

<h3 id="accessing-irbrdbg-from-bindingbreak--debugger">Accessing <code>irb:rdbg</code> from <code>binding.break</code> / <code>debugger</code></h3>

<p>With the <code>debug</code> gem <code>v1.9.0</code>, which will also be part of Ruby 3.3, you can configure it to run <code>irb:rdbg</code> either by:</p>

<ul>
  <li>Setting its <code>irb_console</code> config through the <code>RUBY_DEBUG_IRB_CONSOLE=1</code> environment variable</li>
  <li>Running the <code>irb</code> command in a <code>rdbg</code> session</li>
</ul>

<p>Doing so will give you the same <code>irb:rdbg</code> session in your <code>debug</code> console:</p>

<div><div><pre><code><span>$ RUBY_DEBUG_IRB_CONSOLE</span><span>=</span>1 bundle <span>exec </span>rdbg test.rb
<span>[</span>1, 1] <span>in </span>test.rb
<span>=&gt;</span>   1| a <span>=</span> 1
<span>=&gt;</span><span>#0    &lt;main&gt; at test.rb:1</span>
irb:rdbg<span>(</span>main<span>)</span>:002&gt;
</code></pre></div></div>

<h2 id="enhancing-autocompletion">Enhancing Autocompletion</h2>

<h3 id="addressing-completion-dropdown-issues">Addressing Completion Dropdown Issues</h3>

<p>In Ruby 3.1, IRB introduced the autocompletion feature. While it has proven to be a useful feature for many users, it
also came with some issues that were hard to overlook:</p>

<ul>
  <li>The dropdown could push up the prompt when the candidate list is long. This not only distracts users but also pushes up
the output history, forcing users to frequently scroll up and down through the session.</li>
  <li>The dropdown’s colors are not configurable, making text hard to read with some terminal themes.</li>
  <li>Under certain conditions, the dropdown could erase previously rendered content.</li>
</ul>

<p>Here’s a short demonstration of these issues:</p>

<p><img src="https://poniesandlight.co.uk/reflect/island_video_decoder/images/autocompletion-issues.gif" alt="autocompletion issues demo" width="80%"/></p>

<p>However, thanks to several fixes on the <a href="https://github.com/ruby/reline">Reline</a> gem (a pure-Ruby replacement of <code>readline</code>),
these issues have been addressed.</p>

<p><img src="https://poniesandlight.co.uk/reflect/island_video_decoder/images/improved-autocompletion.gif" alt="improved autocompletion demo" width="80%"/></p>

<p>We are aware that there are other existing issues, such as the lack of debouncing or tab-completion options.
And we will keep improving the feature in future releases.</p>

<h3 id="customizing-dropdown-ui-with-relineface">Customizing Dropdown UI with <code>Reline::Face</code></h3>

<p>With <a href="https://github.com/ruby/reline"><code>Reline</code></a> <code>v0.4.0+</code>, you can use the <code>Reline::Face</code> class to customize the dropdown
UI’s style in your <code>.irbrc</code>.</p>

<p>For instance, this snippet will change the dropdown from its default color scheme to a black-and-white theme:</p>

<div><div><pre><code><span>Reline</span><span>::</span><span>Face</span><span>.</span><span>config</span><span>(</span><span>:completion_dialog</span><span>)</span> <span>do</span> <span>|</span><span>conf</span><span>|</span>
  <span>conf</span><span>.</span><span>define</span> <span>:default</span><span>,</span> <span>foreground: :white</span><span>,</span> <span>background: :black</span>
  <span>conf</span><span>.</span><span>define</span> <span>:enhanced</span><span>,</span> <span>foreground: :black</span><span>,</span> <span>background: :white</span>
  <span>conf</span><span>.</span><span>define</span> <span>:scrollbar</span><span>,</span> <span>foreground: :white</span><span>,</span> <span>background: :black</span>
<span>end</span>
</code></pre></div></div>

<p>The result can be seen below:</p>

<figure>
  <img src="https://poniesandlight.co.uk/reflect/island_video_decoder/images/black-and-white-completion-dropdown-with-reline-face.png"/>
  <figcaption>left: default, right: with the customization</figcaption>
</figure>

<h3 id="experimenting-with-more-accurate-completion-using-rbs">Experimenting with More Accurate Completion Using RBS</h3>

<p>Currently, IRB’s autocompletion is powered by a combination of regular expressions and runtime information from <code>Binding</code>.</p>

<p>This provides a decent result for the first level of completion, but can’t support chained method calls.</p>

<p>For example, when the user types <code>&#39;Ruby&#39;.up</code>, IRB can list <code>upcase</code> and <code>upcase!</code>, because it knows <code>&#39;Ruby&#39;</code> is a <code>String</code>.</p>

<p>But when the user types <code>&#39;Ruby&#39;.upcase.</code>, IRB can’t make another suggestion.
This is because it cannot evaluate <code>&#39;Ruby&#39;.upcase</code> to get its value as it risks causing side-effects
(for example, calling <code>User.all.</code> in a Rails app).</p>

<p>However, there is another way we can get an object’s information without evaluation in Ruby: gradual typing.
Therefore, this year <a href="https://github.com/tompng">@tompng</a> initiated the <a href="https://github.com/ruby/repl_type_completor"><code>repl_type_completor</code></a> project to explore if it’s a feasible replacement for the current regexp-based completor.</p>

<p>To give it a try, you need to add this to your Gemfile:</p>

<div><div><pre><code><span>gem</span> <span>&#34;repl_type_completor&#34;</span><span>,</span> <span>group: </span><span>[</span><span>:development</span><span>,</span> <span>:test</span><span>]</span>
</code></pre></div></div>

<p>And to activate it:</p>

<ul>
  <li>Pass the <code>--type-completor</code> flag when starting IRB</li>
  <li>Or add this to your <code>irbrc</code> file:</li>
</ul>

<div><div><pre><code><span>IRB</span><span>.</span><span>conf</span><span>[</span><span>:COMPLETOR</span><span>]</span> <span>=</span> <span>:type</span> <span># default is :regexp</span>
</code></pre></div></div>

<p>For more details, please refer to IRB readme’s <a href="https://github.com/ruby/irb?tab=readme-ov-file#type-based-completion">type completion section</a>.</p>

<h2 id="quality-of-life-improvements">Quality of Life Improvements</h2>



<p>This year, IRB has introduced pager support on the output of:</p>

<ul>
  <li>The <code>show_source</code>, <code>ls</code>, and <code>show_cmds</code> commands</li>
  <li>The new <code>history</code> command</li>
  <li>Evaluation result</li>
</ul>

<p>When these outputs’ height exceeds your terminal’s, IRB will now paginate them:</p>

<p><img src="https://poniesandlight.co.uk/reflect/island_video_decoder/images/pager-demo.gif" alt="pager demo" width="90%"/></p>

<p>This offers several benefits:</p>

<ul>
  <li>You can freely scroll up and down with your arrow-up/down keys</li>
  <li>You won’t overscroll to some previous IRB output</li>
  <li>By typing <code>/[search_term]</code>, like <code>/foo</code>, inside a pager, you can easily search any text that contains <code>foo</code>
    <ul>
      <li>This could be extremely useful when inspecting record(s) in a Rails console</li>
    </ul>
  </li>
</ul>

<p>We understand that for some users or under certain conditions, a pager could be more of a hindrance than a help.
Therefore, it’s also possible to disable it with the <code>--no-pager</code> flag, or by adding this to your <code>irbrc</code> file:</p>

<div><div><pre><code><span>IRB</span><span>.</span><span>conf</span><span>[</span><span>:USE_PAGER</span><span>]</span> <span>=</span> <span>false</span>
</code></pre></div></div>

<h3 id="omitting-return-value-inspection-with-">Omitting Return Value Inspection with <code>;</code></h3>

<p>Even though paging evaluation result should make long output easier to inspect, sometimes we simply don’t want to see
the return value of certain expressions. For example, the result of <code>users = User.all</code> when it returns hundreds of records.</p>

<p>In such cases, the new IRB allows users to omit the return value by adding a <code>;</code> at the end, like <code>users = User.all;</code>.</p>

<h4 id="example">Example</h4>

<div><div><pre><code>irb<span>(</span>main<span>)</span>:001&gt; long_string <span>=</span> <span>&#34;foo&#34;</span> <span>*</span> 10000<span>;</span>
irb<span>(</span>main<span>)</span>:002&gt; long_string.size
<span>=&gt;</span> 30000
</code></pre></div></div>

<h3 id="history-command">History Command</h3>

<p>IRB now has a <code>history</code> command to display all stored input history (which by default is limited to <code>1000</code>).</p>

<p>Since we usually have a long input history, this command also comes with a <code>-g [term]</code> flag for filtering.</p>

<pre><code>irb(main):006&gt; history -g self
1000: history -g self
803: self
769: self
731: watch self @foo
698: break self.inspect
584: self
582: self
</code></pre>

<h3 id="streamlined-prompt">Streamlined Prompt</h3>

<p>As you may have noticed, IRB’s prompt is now a bit shorter:</p>

<h4 id="before">Before</h4>



<h4 id="after">After</h4>



<p>The removed part is the indent level number, which became redundant after IRB implemented a robust auto-indent feature
for multi-line input.</p>

<h3 id="enhanced-show_source-command">Enhanced <code>show_source</code> Command</h3>

<p>The <code>show_source</code> command has always been an essential tool for many IRB users, especially for debugging.
This year it received two enhancements that will make it even more useful:</p>

<ul>
  <li>You can now use <code>-s</code> to get the method’s super definition if it has one</li>
  <li>It can now display private methods too</li>
</ul>

<h4 id="the--s-flag">The <code>-s</code> Flag</h4>

<p>Given this script:</p>

<div><div><pre><code><span>class</span> <span>Foo</span>
  <span>def</span> <span>foo</span>
    <span>&#34;foo&#34;</span>
  <span>end</span>
<span>end</span>

<span>class</span> <span>Bar</span> <span>&lt;</span> <span>Foo</span>
  <span>def</span> <span>foo</span>
    <span>super</span> <span>+</span> <span>&#34;bar&#34;</span>
  <span>end</span>
<span>end</span>
</code></pre></div></div>

<p>You can now get both <code>Bar#foo</code> and its super method (<code>Foo#foo</code>)’s definition:</p>

<pre><code>irb(main):001&gt; show_source Bar#foo

From: test.rb:8

  def foo
    super + &#34;bar&#34;
  end

=&gt; nil
irb(main):002&gt; show_source Bar#foo -s

From: test.rb:2

  def foo
    &#34;foo&#34;
  end

=&gt; nil
</code></pre>

<p>You can also stack the flag, like <code>-ss</code>, to walk up the super method chain. And if IRB can’t find the super definition anymore,
it’ll notify you with:</p>

<pre><code>irb(main):003&gt; show_source Bar#foo -ss
Error: Couldn&#39;t locate a super definition for Bar#foo
=&gt; nil
</code></pre>

<h2 id="whats-on-the-horizon-for-ruby-34">What’s on the Horizon for Ruby 3.4?</h2>

<h3 id="the-help-command-will-print-help-message">The <code>help</code> Command Will Print Help Message</h3>

<p>When we use a terminal-based application, the first thing we normally do is to type <code>help</code> and learn how to use it.</p>

<p>However, due to historical reasons, IRB’s <code>help</code> command opens up an <code>ri</code> input for Ruby document lookup instead.
This unconventional design can make it hard, especially for new Ruby developers, to learn IRB’s usage.
So we decided to change it in several steps:</p>

<ol>
  <li>In Ruby 3.2, we added <code>show_cmds</code> to print the help message and <code>show_doc</code> command as an alias to the <code>help</code> command.</li>
  <li>In Ruby 3.3, IRB will warn users that <code>help</code> is going to be repurposed to act as <code>show_cmds</code>.</li>
  <li>In early 2024, we plan to release IRB <code>v2.0</code>, with the repurposing of <code>help</code> command being one of the breaking changes.</li>
</ol>

<h3 id="enhancing-extensibility-command-and-helper-method">Enhancing Extensibility: Command and Helper Method</h3>

<p>Several major Ruby web frameworks, such as <a href="https://github.com/rails/rails">Rails</a> and <a href="https://github.com/hanami/hanami">Hanami</a>,
utilize IRB as a platform for their consoles. Additionally, other libraries extend IRB with their custom features via commands.</p>

<p>However, until now, there have been no standard APIs on the IRB side to accommodate new commands or helper methods.
This situation leads to several challenges:</p>

<ul>
  <li>IRB is unable to display these extended features in its help message.</li>
  <li>Refactoring the relevant parts becomes challenging because they are essentially public when private APIs are used directly.</li>
  <li>Projects need to devise their own ways to utilize IRB, often resulting in similar but slightly different solutions.</li>
</ul>

<p>To address these issues, we plan to provide official APIs and relevant documentation to help libraries and applications extend IRB.
Our goal is to transform IRB from not just a great tool, but also into a great platform for other tools.</p>

<h2 id="acknowledgements">Acknowledgements</h2>

<p>The remarkable progress we see on IRB was made possible by the IRB/Reline maintainers team:</p>

<ul>
  <li><a href="https://github.com/tompng">Tomoya Ishida (tompng)</a></li>
  <li><a href="https://github.com/ima1zumi">Mari Imaizumi (ima1zumi)</a></li>
  <li><a href="https://github.com/hasumikin">Hitoshi Hasumi (hasumikin)</a></li>
  <li><a href="https://github.com/st0012">Stan Lo (st0012)</a></li>
</ul>

<p>And also, a big thank you to all the community contributors.</p>

  </div>
</article>

      </div>
    </div></div>
  </body>
</html>
