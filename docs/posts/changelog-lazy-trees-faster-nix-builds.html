<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://determinate.systems/posts/changelog-determinate-nix-352/">Original</a>
    <h1>Changelog: Lazy trees (faster Nix builds)</h1>
    
    <div id="readability-page-1" class="page"><article>  <p><a href="#importance"><strong>Lazy trees</strong></a> have been one of the most hotly requested Nix features for quite some time.
They make Nix much more efficient in larger repositories, particularly in massive monorepos.
And so we’re excited to announce that lazy trees have landed in <a rel="noopener noreferrer" target="_blank" href="https://docs.determinate.systems/determinate-nix" target="_blank" rel="noopener noreferrer">Determinate Nix</a> version <strong>3.5.2</strong>, based on version <a rel="noopener noreferrer" target="_blank" href="https://nix.dev/manual/nix/latest/release-notes/rl-2.28" target="_blank" rel="noopener noreferrer">2.28.3</a> of upstream Nix.</p>
<p>We’re confident that this initial release of lazy trees should produce few issues for users.
But for the sake of caution, lazy trees is available solely on an <strong>opt-in basis</strong> for the time being.
To start using it today, first <a href="#upgrade-install">install or upgrade</a> Determinate Nix and enable lazy trees in your custom Nix configuration:</p>

<p>Our co-founder <a href="https://determinate.systems/people/eelco-dolstra">Eelco Dolstra</a> currently has a <a rel="noopener noreferrer" target="_blank" href="https://github.com/NixOS/nix/pull/13225" target="_blank" rel="noopener noreferrer">pull request open</a> to get lazy trees into <a rel="noopener noreferrer" target="_blank" href="https://github.com/NixOS/nix" target="_blank" rel="noopener noreferrer">upstream Nix</a> and we hope to see that merged soon.</p>
<h2 id="importance"> <a href="#importance"> Why lazy trees are important </a> </h2>
<p>In a nutshell, lazy trees provide <strong>faster and less resource-intensive evaluation</strong> in many standard usage scenarios.
For evaluations inside of the <a rel="noopener noreferrer" target="_blank" href="https://github.com/NixOS/nixpkgs" target="_blank" rel="noopener noreferrer">Nixpkgs</a> repo, for example, we’ve frequently seen reductions in wall time of <strong>3x or more</strong> and reductions in disk usage of <strong>20x or more</strong>—and occasionally reductions far beyond even this.</p>
<p>With lazy trees enabled, Nix scopes file copying to what the specific expression demands—and nothing more.
More specifically, Nix uses a <strong>virtual filesystem</strong> to gather the necessary file state prior to copying anything to the <ph-id><a target="_blank" href="https://zero-to-nix.com/concepts/nix-store" target="_blank">Nix store</a></ph-id>, “mounting” lazy source inputs to this virtual filesystem at <code>/nix/store/&lt;random-hash&gt;</code>.</p>
<p>This provides a much more parsimonious mode of operation that should quietly make just about everything in Nix better, from standard package builds to development environments to NixOS deployment and beyond.</p>
<p>If you’d like to see this in action, try evaluating something in Nixpkgs yourself.
<a href="#upgrade-install">Install or upgrade Determinate Nix</a> and run this sequence of commands:</p>
<div><figure><pre data-language="shell"><code><div><p><span># Clone Nixpkgs</span></p></div><div><p><span>git</span><span> </span><span>clone</span><span> </span><span>https://github.com/NixOS/nixpkgs</span></p></div><div><p><span>cd</span><span> </span><span>nixpkgs</span></p></div><div></div><div><p><span># Evaluate the cowsay derivation with lazy trees disabled</span></p></div><div><p><span>time</span><span> nix eval </span><span>\</span></p></div><div><p><span>  </span><span>--no-eval-cache</span><span> </span><span>\</span></p></div><div><p><span>  </span><span>.#cowsay</span></p></div><div></div><div><p><span># Make a meaningless change to the source tree</span></p></div><div><p><span>echo</span><span> </span><span>&#34;&#34;</span><span> </span><span>&gt;&gt;</span><span> </span><span>flake.nix</span></p></div><div></div><div><p><span># Evaluate the cowsay derivation again</span></p></div><div><p><span>time</span><span> nix eval </span><span>\</span></p></div><div><p><span>  </span><span>--no-eval-cache</span><span> </span><span>\</span></p></div><div><p><span>  </span><span>.#cowsay</span></p></div></code></pre></figure></div>
<p>Adding an empty line to <code>flake.nix</code> (a meaningless change) invalidates the evaluation cache and forces Nix to copy the <strong>entire source tree</strong> to the <ph-id><a target="_blank" href="https://zero-to-nix.com/concepts/nix-store" target="_blank">Nix store</a></ph-id>, otherwise the second evaluation would be faster.</p>
<p>Now the same sequence of steps with lazy trees:</p>
<div><figure><pre data-language="shell"><code><div><p><span># Enable lazy trees</span></p></div><div><p><span>echo</span><span> </span><span>&#34;lazy-trees = true&#34;</span><span> </span><span>|</span><span> </span><span>sudo</span><span> </span><span>tee</span><span> </span><span>-a</span><span> </span><span>/etc/nix/nix.custom.conf</span></p></div><div></div><div><p><span># Make a meaningless change to the source tree</span></p></div><div><p><span>echo</span><span> </span><span>&#34;&#34;</span><span> </span><span>&gt;&gt;</span><span> </span><span>flake.nix</span></p></div><div></div><div><p><span># Evaluate the cowsay derivation</span></p></div><div><p><span>time</span><span> nix eval </span><span>\</span></p></div><div><p><span>  </span><span>--no-eval-cache</span><span> </span><span>\</span></p></div><div><p><span>  </span><span>.#cowsay</span></p></div><div></div><div><p><span># Make a meaningless change to the source tree</span></p></div><div><p><span>echo</span><span> </span><span>&#34;&#34;</span><span> </span><span>&gt;&gt;</span><span> </span><span>flake.nix</span></p></div><div></div><div><p><span># Evaluate the cowsay derivation again</span></p></div><div><p><span>time</span><span> nix eval </span><span>\</span></p></div><div><p><span>  </span><span>--no-eval-cache</span><span> </span><span>\</span></p></div><div><p><span>  </span><span>.#cowsay</span></p></div></code></pre></figure></div>
<p>You’ll notice two things:</p>
<ol>
<li>The evaluation should be substantially faster with lazy trees (if not, please let us know <a href="mailto:support@determinate.systems">via email</a> or <a rel="noopener noreferrer" target="_blank" href="https://discord.com/invite/a4EcQQ8STr" target="_blank" rel="noopener noreferrer">on Discord</a>).</li>
<li>With lazy trees, you won’t see any indication that Nix is copying the source tree to the Nix store.
That’s because it’s able to determine, via evaluation, that only the sources for the <a rel="noopener noreferrer" target="_blank" href="https://github.com/piuccio/cowsay" target="_blank" rel="noopener noreferrer"><code>cowsay</code></a> package are necessary to achieve its ends.</li>
</ol>
<p>Saving time is good.
Also good: using less disk space.
I’ll provide an example.</p>
<p>First, let’s evaluate something in Nixpkgs using a <code>./tmp</code> subdirectory inside the current directory as a fresh <ph-id><a target="_blank" href="https://zero-to-nix.com/concepts/nix-store" target="_blank">Nix store</a></ph-id>:</p>
<div><figure><pre data-language="shell"><code><div><p><span># Disable lazy trees</span></p></div><div><p><span>echo</span><span> </span><span>&#34;lazy-trees = false&#34;</span><span> </span><span>|</span><span> </span><span>sudo</span><span> </span><span>tee</span><span> </span><span>-a</span><span> </span><span>/etc/nix/nix.custom.conf</span></p></div><div></div><div><p><span># Evaluate the cowsay package</span></p></div><div><p><span>nix</span><span> </span><span>eval</span><span> </span><span>\</span></p></div><div><p><span>  </span><span>--no-eval-cache</span><span> </span><span>\</span></p></div><div><p><span>  </span><span>--store</span><span> </span><span>./tmp</span><span> </span><span>\</span></p></div><div><p><span>  </span><span>.#cowsay</span></p></div><div></div><div><p><span># See how much disk space is used by the local Nix store</span></p></div><div><p><span>du</span><span> </span><span>-sh</span><span> </span><span>./tmp</span></p></div></code></pre></figure></div>
<p>On my machine, this yields <strong>304 megabytes</strong>.
Now let’s try the same thing with lazy trees enabled:</p>
<div><figure><pre data-language="shell"><code><div><p><span># Delete the local Nix store to start from scratch</span></p></div><div><p><span>sudo</span><span> </span><span>rm</span><span> </span><span>-rf</span><span> </span><span>./tmp</span></p></div><div></div><div><p><span># Enable lazy trees</span></p></div><div><p><span>echo</span><span> </span><span>&#34;lazy-trees = true&#34;</span><span> </span><span>|</span><span> </span><span>sudo</span><span> </span><span>tee</span><span> </span><span>-a</span><span> </span><span>/etc/nix/nix.custom.conf</span></p></div><div></div><div><p><span># Evaluate the cowsay package</span></p></div><div><p><span>nix</span><span> </span><span>eval</span><span> </span><span>\</span></p></div><div><p><span>  </span><span>--no-eval-cache</span><span> </span><span>\</span></p></div><div><p><span>  </span><span>--store</span><span> </span><span>./tmp</span><span> </span><span>\</span></p></div><div><p><span>  </span><span>.#cowsay</span></p></div><div></div><div><p><span># See how much disk space is used by the local Nix store</span></p></div><div><p><span>du</span><span> </span><span>-sh</span><span> </span><span>./tmp</span></p></div><div></div><div><p><span># Delete the local Nix store to clean up</span></p></div><div><p><span>sudo</span><span> </span><span>rm</span><span> </span><span>-rf</span><span> </span><span>./tmp</span></p></div></code></pre></figure></div>
<p>This yields <strong>13 megabytes</strong>.
That’s over 23 times less disk space.
This specific number isn’t generalizable across all situations, of course, but it does illustrate just how much more efficient Nix can become in a standard scenario when using lazy trees.</p>

<h2 id="ci-comparisons"> <a href="#ci-comparisons"> CI comparisons </a> </h2>
<p>To illustrate some of these differences in a CI environment, I’ve set up a GitHub repo at <a rel="noopener noreferrer" target="_blank" href="https://github.com/DeterminateSystems/lazy-trees-comparisons" target="_blank" rel="noopener noreferrer">DeterminateSystems/lazy-trees-comparisons</a>.
The <a rel="noopener noreferrer" target="_blank" href="https://github.com/DeterminateSystems/lazy-trees-comparisons/blob/main/.github/workflows/comparison.yaml" target="_blank" rel="noopener noreferrer">workflow configuration</a> shows the sequences of steps involved (similar to the steps <a href="#importance">above</a>).</p>
<p>As an example, check out <a rel="noopener noreferrer" target="_blank" href="https://github.com/DeterminateSystems/lazy-trees-comparisons/actions/runs/15051253370/job/42306364011" target="_blank" rel="noopener noreferrer">this CI run</a>, which evaluates the <code>stdenv</code> attribute of Nixpkgs on GitHub Actions’ <code>ubuntu-latest</code> runner.
The evaluation time without lazy trees:</p>
<div><figure><pre data-language="shell"><code><div><p><span>real</span><span>   </span><span>0m10.787s</span></p></div><div><p><span>user</span><span>   </span><span>0m3.655s</span></p></div><div><p><span>sys</span><span>    </span><span>0m6.759s</span></p></div></code></pre></figure></div>
<p>Wall time without lazy trees: almost <strong>11 seconds</strong>.
Disk usage without lazy trees: <strong>433 megabytes</strong>.</p>
<p>Evaluation time with lazy trees:</p>
<div><figure><pre data-language="shell"><code><div><p><span>real</span><span>   </span><span>0m3.500s</span></p></div><div><p><span>user</span><span>   </span><span>0m1.762s</span></p></div><div><p><span>sys</span><span>    </span><span>0m1.701s</span></p></div></code></pre></figure></div>
<p>Wall time without lazy trees: <strong>3.5 seconds</strong>.
Disk usage with lazy trees: <strong>11 megabytes</strong>.</p>
<p>Again, a substantial difference.
This is, of course, just one result of one run, but it’s consistent with <a rel="noopener noreferrer" target="_blank" href="https://github.com/DeterminateSystems/lazy-trees-comparisons/actions/runs/15051253370" target="_blank" rel="noopener noreferrer">more general runs</a> and we encourage you to make your own comparisons.</p>
<h2 id="new-warning"> <a href="#new-warning"> New warning </a> </h2>
<p>When using Determinate Nix with lazy trees, you may see warnings like this:</p>
<div><figure><pre data-language="shell"><code><div><p><span>warning:</span><span> </span><span>Performing</span><span> </span><span>inefficient</span><span> </span><span>double</span><span> </span><span>copy</span><span> </span><span>of</span><span> </span><span>path</span><span> </span><span>&#39;«github:nixos/nixpkgs/0c0bf9c057382d5f6f63d54fd61f1abd5e1c2f63»/&#39;</span><span> </span><span>to</span><span> </span><span>the</span><span> </span><span>store.</span><span> </span><span>This</span><span> </span><span>can</span><span> </span><span>typically</span><span> </span><span>be</span><span> </span><span>avoided</span><span> </span><span>by</span><span> </span><span>rewriting</span><span> </span><span>an</span><span> </span><span>attribute</span><span> </span><span>like</span><span> </span><span>`</span><span>src</span><span> = ./.`</span><span> </span><span>to</span><span> </span><span>`</span><span>src</span><span> = builtins.path { path = ./.; </span><span>name</span><span> = &#34;source&#34;; }`</span><span>.</span></p></div></code></pre></figure></div>
<p>You’ll see this in cases where you specify the root of a repo as the source for a derivation.
When you use <code>./.</code> as the source for a derivation, Nix copies your repo to the Nix store under the name <code>/nix/store/&lt;random-hash&gt;-source</code>, which is then copied <em>again</em> as <code>/nix/store/&lt;random-hash&gt;-&lt;other-random-hash&gt;-source</code>.</p>
<p>Because of that, this is an inefficient way to specify your source:</p>
<div><figure><pre data-language="nix"><code><div><p><span>{</span></p></div><div><p><span>  </span><span>myPackage</span><span> </span><span>=</span><span> </span><span>myDerivationFunction</span><span> {</span></p></div><div><p><span>    </span><span>src</span><span> </span><span>=</span><span> </span><span>./.</span><span>;</span></p></div><div><p><span><span>  </span></span><span>};</span></p></div><div><p><span>}</span></p></div></code></pre></figure></div>
<p>This is a much more efficient way:</p>
<div><figure><pre data-language="nix"><code><div><p><span>{</span></p></div><div><p><span>  </span><span>myPackage</span><span> </span><span>=</span><span> </span><span>myDerivationFunction</span><span> {</span></p></div><div><p><span>    </span><span>src</span><span> </span><span>=</span><span> </span><span>builtins</span><span>.</span><span>path</span><span> { </span><span>path</span><span> </span><span>=</span><span> </span><span>./.</span><span>; </span><span>name</span><span> </span><span>=</span><span> </span><span>&#34;my-package-source&#34;</span><span>; };</span></p></div><div><p><span><span>  </span></span><span>};</span></p></div><div><p><span>}</span></p></div></code></pre></figure></div>
<p>The <code>name</code> field can be whatever you like.
In a flake, you can also use <code>self</code> instead of <code>./.</code>, as in:</p>
<div><figure><pre data-language="nix"><code><div><p><span>{</span></p></div><div><p><span>  </span><span>myPackage</span><span> </span><span>=</span><span> </span><span>myDerivationFunction</span><span> {</span></p></div><div><p><span>    </span><span>src</span><span> </span><span>=</span><span> </span><span>self</span><span>;</span></p></div><div><p><span><span>  </span></span><span>};</span></p></div><div><p><span>}</span></p></div></code></pre></figure></div>
<p>Ideally, this wouldn’t be necessary and using <code>./.</code> wouldn’t produce any inefficiency.
But unfortunately, changing this behavior would constitute a backwards-incompatible change that we are highly averse to introducing.</p>
<h2 id="actions"> <a href="#actions"> How to use lazy trees in GitHub Actions </a> </h2>
<p>If you’d like to try out lazy trees in <a rel="noopener noreferrer" target="_blank" href="https://github.com/features/actions" target="_blank" rel="noopener noreferrer">GitHub Actions</a>, you can use our <a rel="noopener noreferrer" target="_blank" href="https://github.com/DeterminateSystems/determinate-nix-action" target="_blank" rel="noopener noreferrer">Determinate Nix Action</a> and supply <code>lazy-trees = true</code> in your configuration:</p>
<div><figure><pre data-language="yaml"><code><div><p><span>steps</span><span>:</span></p></div><div><p><span><span>  </span></span><span>- </span><span>uses</span><span>: </span><span>actions/checkout@v4</span></p></div><div></div><div><p><span><span>  </span></span><span>- </span><span>name</span><span>: </span><span>Install Determinate Nix with lazy trees enabled</span></p></div><div><p><span>    </span><span>uses</span><span>: </span><span>DeterminateSystems/determinate-nix-action@v3</span></p></div><div><p><span>    </span><span>with</span><span>:</span></p></div><div><p><span>      </span><span>extra-conf</span><span>:</span></p></div><div><p><span>        </span><span>lazy-trees = true</span></p></div><div></div><div><p><span><span>  </span></span><span>- </span><span>name</span><span>: </span><span>Set up FlakeHub Cache</span></p></div><div><p><span>    </span><span>uses</span><span>: </span><span>DeterminateSystems/flakehub-cache-action@main</span></p></div><div></div><div><p><span><span>  </span></span><span>- </span><span>name</span><span>: </span><span>Build default package output</span></p></div><div><p><span>    </span><span>run</span><span>: </span><span>nix build .</span></p></div></code></pre></figure></div>
<h2 id="upgrade-install"> <a href="#upgrade-install"> How to upgrade or install Determinate Nix </a> </h2>
<p>If you already have <a rel="noopener noreferrer" target="_blank" href="https://docs.determinate.systems/determinate-nix" target="_blank" rel="noopener noreferrer">Determinate Nix</a> installed, you can upgrade to 3.5.2 with one <a rel="noopener noreferrer" target="_blank" href="https://docs.determinate.systems/determinate-nix#determinate-nixd" target="_blank" rel="noopener noreferrer">Determinate Nixd</a> command:</p>
<div><figure><pre data-language="shell"><code><div><p><span>sudo</span><span> </span><span>determinate-nixd</span><span> </span><span>upgrade</span></p></div></code></pre></figure></div>
<p>If you don’t yet have Determinate Nix installed, you can install it on <strong>macOS</strong> using our graphical installer:</p>
<a rel="noopener noreferrer" target="_blank" href="https://install.determinate.systems/determinate-pkg/stable/Universal"> <div> <div> <p><img src="https://determinate.systems/_astro/pkg.MPL_Eg6I_Z1qTbaO.webp" alt="Logo for graphical installer" loading="eager" width="1024" height="1024" decoding="async"/></p><div> <p>
Install Determinate Nix on macOS now
</p> <p>Apple Silicon and Intel</p> </div> </div> </div> </a>
<p>On Linux:</p>
<div><figure><pre data-language="shell"><code><div><p><span>curl</span><span> </span><span>--proto</span><span> </span><span>&#39;=https&#39;</span><span> </span><span>--tlsv1.2</span><span> </span><span>-sSf</span><span> </span><span>-L</span><span> </span><span>https://install.determinate.systems/nix</span><span> </span><span>|</span><span> </span><span>\</span></p></div><div><p><span>  </span><span>sh</span><span> </span><span>-s</span><span> </span><span>--</span><span> </span><span>install</span><span> </span><span>--determinate</span></p></div></code></pre></figure></div>
<p>On NixOS, we recommend using our <a rel="noopener noreferrer" target="_blank" href="https://docs.determinate.systems/guides/advanced-installation#nixos" target="_blank" rel="noopener noreferrer">dedicated NixOS module</a>.</p>
<p>To verify that you’re on the most recent version of Determinate Nix at any time:</p>

<p>And again, once you <em>are</em> on the most recent version, you can enable lazy trees in your custom Nix configuration:</p>

<h2 id="more-to-come"> <a href="#more-to-come"> More to come </a> </h2>
<p><a rel="noopener noreferrer" target="_blank" href="https://docs.determinate.systems/determinate-nix" target="_blank" rel="noopener noreferrer">Determinate Nix</a> has introduced a number of improvements to Nix in recent months, including <a href="https://determinate.systems/posts/changelog-determinate-nix-331#json-logging">JSON logging</a> and <a href="https://determinate.systems/posts/changelog-determinate-nix-331#hash-mismatches">automatic fixes for hash mismatches</a>, but we’re confident that the lazy trees release presents the most consequential change to date because it establishes a new, qualitatively improved baseline for Nix performance.</p>
<p>But we are far from finished with improving Nix’s performance.
In the coming months, we intend to ship more improvements to Nix’s evaluation performance, including:</p>
<ol>
<li>Improving evaluation caching</li>
<li>Bringing <a href="https://determinate.systems/posts/parallel-nix-eval">parallel evaluation</a> to more Nix operations</li>
<li>Providing multi-threaded unpacking of flakes, both flakes from tarballs (like those from <ph-id><a target="_blank" href="https://flakehub.com" target="_blank">FlakeHub</a></ph-id>) and those from source forges like GitHub.</li>
</ol>
<p>Stay tuned!</p>  </article></div>
  </body>
</html>
