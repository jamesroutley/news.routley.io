<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://mywiki.wooledge.org/BashFAQ/105">Original</a>
    <h1>Why doesn&#39;t Bash&#39;s `set -e` do what I expected?</h1>
    
    <div id="readability-page-1" class="page"><div dir="ltr" id="content" lang="en"><h2 id="Why_doesn.27t_set_-e_.28or_set_-o_errexit.2C_or_trap_ERR.29_do_what_I_expected.3F">Why doesn&#39;t set -e (or set -o errexit, or trap ERR) do what I expected?</h2>
<p><tt>set -e</tt> was an attempt to add &#34;automatic error detection&#34; to the shell.  Its goal was to cause the shell to abort any time an error occurred, so you don&#39;t have to put <tt>|| exit 1</tt> after each important command.  This does not work well in practice. <span id="line-4"></span><span id="line-5"></span></p><p>The goal of automatic error detection is a noble one, but it requires the ability to <em>tell</em> when an error actually occurred.  In modern high-level languages, most tasks are performed by using the language&#39;s builtin commands or features.  The language knows whether (for example) you tried to divide by zero, or open a file that you can&#39;t open, and so on.  It can take action based on this knowledge. <span id="line-6"></span><span id="line-7"></span></p><p>But in the shell, most of the tasks you actually care about are done by <em>external</em> programs.  The shell can&#39;t tell whether an external program encountered something that it considers an error -- and even if it could, it wouldn&#39;t know whether the error is an <em>important</em> one, worthy of aborting the entire program, or whether it should carry on. <span id="line-8"></span><span id="line-9"></span></p><p>The only information conveyed to the shell by the external program is an exit status -- by convention, 0 for success, and non-zero for &#34;some kind of error&#34;.  The developers of the original Bourne shell decided that they would create a feature that would allow the shell to check the exit status of every command that it runs, and abort if one of them returns non-zero.  Thus, <tt>set -e</tt> was born. <span id="line-10"></span><span id="line-11"></span></p><p>But many commands return non-zero even when there <em>wasn&#39;t</em> an error.  For example, <span id="line-12"></span><span id="line-13"></span></p><pre><span id="line-1"></span>if [ -d /foo ]; then ...; else ...; fi</pre><p>If the directory doesn&#39;t exist, the <tt>[</tt> command returns non-zero.  Clearly we don&#39;t want to abort when that happens -- our script wants to handle that in the <tt>else</tt> part.  So the shell implementors made a bunch of special rules, like &#34;commands that are part of an <tt>if</tt> test are immune&#34;, and &#34;commands in a pipeline, other than the last one, are immune&#34;. <span id="line-18"></span><span id="line-19"></span></p><p>These rules are extremely convoluted, and they still fail to catch even some remarkably simple cases.  Even worse, the rules <em>change</em> from one Bash version to another, as Bash attempts to track the extremely slippery POSIX definition of this &#34;feature&#34;.  When a <a href="http://mywiki.wooledge.org/SubShell">SubShell</a> is involved, it gets worse still -- the behavior changes depending on whether Bash is invoked in POSIX mode.  <a href="http://fvue.nl/wiki/Bash:_Error_handling">Another wiki</a> has a page that covers this in more detail.  Be sure to check the caveats. <span id="line-20"></span><span id="line-21"></span></p><p><a href="https://www.in-ulm.de/~mascheck/various/set-e/">A reference comparing behavior across various historical shells</a> also exists. <span id="line-22"></span><span id="line-23"></span></p><h3 id="Story_time">Story time</h3>
<p>Consider this allegory, originally posted to <a href="https://lists.gnu.org/archive/html/bug-bash/2017-03/msg00171.html">bug-bash</a>: <span id="line-26"></span><span id="line-27"></span></p><div><div dir="ltr" lang="en">



<pre dir="ltr" id="CA-7d9888e2746ac12ca8e74f8a95b6cf4539d46358" lang="en"><span><span id="line-1-2"></span>Once upon a time, a man with a dirty lab coat and long, uncombed hair</span>
<span><span id="line-2-1"></span>showed up at the town police station, demanding to see the chief of</span>
<span><span id="line-3-1"></span>police.  &#34;I&#39;ve done it!&#34; he exclaimed.  &#34;I&#39;ve built the perfect</span>
<span><span id="line-4-1"></span>criminal-catching robot!&#34;</span>
<span><span id="line-5-1"></span></span>
<span><span id="line-6-1"></span>The police chief was skeptical, but decided that it might be worth</span>
<span><span id="line-7-1"></span>the time to see what the man had invented.  Also, he secretly thought,</span>
<span><span id="line-8-1"></span>it might be a somewhat unwise move to completely alienate the mad</span>
<span><span id="line-9-1"></span>scientist and his army of hunter robots.</span>
<span><span id="line-10-1"></span></span>
<span><span id="line-11-1"></span>So, the man explained to the police chief how his invention could tell</span>
<span><span id="line-12-1"></span>the difference between a criminal and law-abiding citizen using a</span>
<span><span id="line-13-1"></span>series of heuristics.  &#34;It&#39;s especially good at spotting recently</span>
<span><span id="line-14-1"></span>escaped prisoners!&#34; he said.  &#34;Guaranteed non-lethal restraints!&#34;</span>
<span><span id="line-15-1"></span></span>
<span><span id="line-16-1"></span>Frowning and increasingly skeptical, the police chief nevertheless</span>
<span><span id="line-17-1"></span>allowed the man to demonstrate one robot for a week.  They decided that</span>
<span><span id="line-18-1"></span>the robot should patrol around the jail.  Sure enough, there was a</span>
<span><span id="line-19-1"></span>jailbreak a few days later, and an inmate digging up through the</span>
<span><span id="line-20-1"></span>ground outside of the prison facility was grabbed by the robot and</span>
<span><span id="line-21-1"></span>carried back inside the prison.</span>
<span><span id="line-22-1"></span></span>
<span><span id="line-23-1"></span>The surprised police chief allowed the robot to patrol a wider area.</span>
<span><span id="line-24-1"></span>The next day, the chief received an angry call from the zookeeper.</span>
<span><span id="line-25-1"></span>It seems the robot had cut through the bars of one of the animal cages,</span>
<span><span id="line-26-1"></span>grabbed the animal, and delivered it to the prison.</span>
<span><span id="line-27-1"></span></span>
<span><span id="line-28-1"></span>The chief confronted the robot&#39;s inventor, who asked what animal it</span>
<span><span id="line-29-1"></span>was.  &#34;A zebra,&#34; replied the police chief.  The man slapped his head and</span>
<span><span id="line-30-1"></span>exclaimed, &#34;Curses!  It was fooled by the black and white stripes!</span>
<span><span id="line-31-1"></span>I shall have to recalibrate!&#34;  And so the man set about rewriting the</span>
<span><span id="line-32-1"></span>robot&#39;s code.  Black and white stripes would indicate an escaped</span>
<span><span id="line-33-1"></span>inmate UNLESS the inmate had more than two legs.  Then it should be</span>
<span><span id="line-34-1"></span>left alone.</span>
<span><span id="line-35-1"></span></span>
<span><span id="line-36-1"></span>The robot was redeployed with the updated code, and seemed to be</span>
<span><span id="line-37-1"></span>operating well enough for a few days.  Then on Saturday, a mob of</span>
<span><span id="line-38-1"></span>children in soccer clothing, followed by their parents, descended</span>
<span><span id="line-39-1"></span>on the police station.  After the chaos subsided, the chief was told</span>
<span><span id="line-40-1"></span>that the robot had absconded with the referee right in the middle of</span>
<span><span id="line-41-1"></span>a soccer game.</span>
<span><span id="line-42-1"></span></span>
<span><span id="line-43-1"></span>Scowling, the chief reported this to the scientist, who performed a</span>
<span><span id="line-44-1"></span>second calibration.  Black and white stripes would indicate an escaped</span>
<span><span id="line-45-1"></span>inmate UNLESS the inmate had more than two legs OR had a whistle on</span>
<span><span id="line-46-1"></span>a necklace.</span>
<span><span id="line-47-1"></span></span>
<span><span id="line-48-1"></span>Despite the second calibration, the police chief declared that the robot</span>
<span><span id="line-49-1"></span>would no longer be allowed to operate in his town.  However, the news</span>
<span><span id="line-50-1"></span>of the robot had spread, and requests from many larger cities were</span>
<span><span id="line-51-1"></span>pouring in.  The inventor made dozens more robots, and shipped them off</span>
<span><span id="line-52-1"></span>to eager police stations around the nation.  Every time a robot grabbed</span>
<span><span id="line-53-1"></span>something that wasn&#39;t an escaped inmate, the scientist was consulted,</span>
<span><span id="line-54-1"></span>and the robot was recalibrated.</span>
<span><span id="line-55-1"></span></span>
<span><span id="line-56-1"></span>Unfortunately, the inventor was just one man, and he didn&#39;t have the</span>
<span><span id="line-57-1"></span>time or the resources to recalibrate EVERY robot whenever one of them</span>
<span><span id="line-58-1"></span>went awry.  The robot in Shangri-La was recalibrated not to grab a</span>
<span><span id="line-59-1"></span>grave-digger working on a cold winter night while wearing a ski mask,</span>
<span><span id="line-60-1"></span>and the robot in Xanadu was recalibrated not to capture a black and</span>
<span><span id="line-61-1"></span>white television set that showed a movie about a prison break, and so</span>
<span><span id="line-62-1"></span>on.  But the robot in Xanadu would still grab grave-diggers with ski</span>
<span><span id="line-63-1"></span>masks (which it turns out was not common due to Xanadu&#39;s warmer climate),</span>
<span><span id="line-64-1"></span>and the robot in Shangri-La was still a menace to old televisions (of</span>
<span><span id="line-65-1"></span>which there were very few, the people of Shangri-La being on the average</span>
<span><span id="line-66-1"></span>more wealthy than those of Xanadu).</span>
<span><span id="line-67-1"></span></span>
<span><span id="line-68-1"></span>So, after a few years, there were different revisions of the</span>
<span><span id="line-69-1"></span>criminal-catching robot in most of the major cities.  In some places,</span>
<span><span id="line-70-1"></span>a clever criminal could avoid capture by wearing a whistle on a string</span>
<span><span id="line-71-1"></span>around the neck.  In others, one would be well-advised not to wear orange</span>
<span><span id="line-72-1"></span>clothing in certain rural areas, no matter how close to the Harvest</span>
<span><span id="line-73-1"></span>Festival it was, unless one also wore the traditional black triangular</span>
<span><span id="line-74-1"></span>eye-paint of the Pumpkin King.</span>
<span><span id="line-75-1"></span></span>
<span><span id="line-76-1"></span>Many people thought, &#34;This is lunacy!&#34;  But others thought the robots</span>
<span><span id="line-77-1"></span>did more good than harm, all things considered, and so in some places</span>
<span><span id="line-78-1"></span>the robots are used, while in other places they are shunned.</span>
<span><span id="line-79-1"></span></span>
<span><span id="line-80-1"></span>The end.</span>
</pre></div></div><h3 id="Exercises">Exercises</h3>
<p>Or, &#34;so you think <tt>set -e</tt> is OK, huh?&#34; <span id="line-111"></span><span id="line-112"></span></p><p><em>Exercise 1: why doesn&#39;t this example print anything?</em> <span id="line-113"></span><span id="line-114"></span></p><div><div dir="ltr" lang="en">

<pre dir="ltr" id="CA-13780b55bc71bb247e9b4022cb98f2a15561f579" lang="en"><span><span><a href="#CA-13780b55bc71bb247e9b4022cb98f2a15561f579_1">   1</a> </span><span id="CA-13780b55bc71bb247e9b4022cb98f2a15561f579_1"></span><span id="line-1-4"></span></span>
<span><span><a href="#CA-13780b55bc71bb247e9b4022cb98f2a15561f579_2">   2</a> </span><span id="CA-13780b55bc71bb247e9b4022cb98f2a15561f579_2"></span><span id="line-2-2"></span><span>set</span> -e</span>
<span><span><a href="#CA-13780b55bc71bb247e9b4022cb98f2a15561f579_3">   3</a> </span><span id="CA-13780b55bc71bb247e9b4022cb98f2a15561f579_3"></span><span id="line-3-2"></span><span>i</span>=<span>0</span></span>
<span><span><a href="#CA-13780b55bc71bb247e9b4022cb98f2a15561f579_4">   4</a> </span><span id="CA-13780b55bc71bb247e9b4022cb98f2a15561f579_4"></span><span id="line-4-2"></span><span>let</span> i++</span>
<span><span><a href="#CA-13780b55bc71bb247e9b4022cb98f2a15561f579_5">   5</a> </span><span id="CA-13780b55bc71bb247e9b4022cb98f2a15561f579_5"></span><span id="line-5-2"></span><span>echo</span> <span>&#34;</span><span>i is </span><span>$i</span><span>&#34;</span></span>
</pre></div></div><p><em>Exercise 2: why does <strong>this</strong> one sometimes appear to work?  In which versions of bash does it work, and in which versions does it fail?</em> <span id="line-123"></span><span id="line-124"></span></p><div><div dir="ltr" lang="en">

<pre dir="ltr" id="CA-01f8c1666f874e2cacb2f1afce1f0b638cbb4698" lang="en"><span><span><a href="#CA-01f8c1666f874e2cacb2f1afce1f0b638cbb4698_1">   1</a> </span><span id="CA-01f8c1666f874e2cacb2f1afce1f0b638cbb4698_1"></span><span id="line-1-6"></span></span>
<span><span><a href="#CA-01f8c1666f874e2cacb2f1afce1f0b638cbb4698_2">   2</a> </span><span id="CA-01f8c1666f874e2cacb2f1afce1f0b638cbb4698_2"></span><span id="line-2-3"></span><span>set</span> -e</span>
<span><span><a href="#CA-01f8c1666f874e2cacb2f1afce1f0b638cbb4698_3">   3</a> </span><span id="CA-01f8c1666f874e2cacb2f1afce1f0b638cbb4698_3"></span><span id="line-3-3"></span><span>i</span>=<span>0</span></span>
<span><span><a href="#CA-01f8c1666f874e2cacb2f1afce1f0b638cbb4698_4">   4</a> </span><span id="CA-01f8c1666f874e2cacb2f1afce1f0b638cbb4698_4"></span><span id="line-4-3"></span>((i++))</span>
<span><span><a href="#CA-01f8c1666f874e2cacb2f1afce1f0b638cbb4698_5">   5</a> </span><span id="CA-01f8c1666f874e2cacb2f1afce1f0b638cbb4698_5"></span><span id="line-5-3"></span><span>echo</span> <span>&#34;</span><span>i is </span><span>$i</span><span>&#34;</span></span>
</pre></div></div><p><em>Exercise 3: why aren&#39;t these two scripts identical?</em> <span id="line-133"></span><span id="line-134"></span></p><div><div dir="ltr" lang="en">

<pre dir="ltr" id="CA-a8524ceb12ffceed8f8e4b48c3e89a5d2fc15fe3" lang="en"><span><span><a href="#CA-a8524ceb12ffceed8f8e4b48c3e89a5d2fc15fe3_1">   1</a> </span><span id="CA-a8524ceb12ffceed8f8e4b48c3e89a5d2fc15fe3_1"></span><span id="line-1-8"></span></span>
<span><span><a href="#CA-a8524ceb12ffceed8f8e4b48c3e89a5d2fc15fe3_2">   2</a> </span><span id="CA-a8524ceb12ffceed8f8e4b48c3e89a5d2fc15fe3_2"></span><span id="line-2-4"></span><span>set</span> -e</span>
<span><span><a href="#CA-a8524ceb12ffceed8f8e4b48c3e89a5d2fc15fe3_3">   3</a> </span><span id="CA-a8524ceb12ffceed8f8e4b48c3e89a5d2fc15fe3_3"></span><span id="line-3-4"></span><span>test</span> -d nosuchdir &amp;&amp; <span>echo</span> no dir</span>
<span><span><a href="#CA-a8524ceb12ffceed8f8e4b48c3e89a5d2fc15fe3_4">   4</a> </span><span id="CA-a8524ceb12ffceed8f8e4b48c3e89a5d2fc15fe3_4"></span><span id="line-4-4"></span><span>echo</span> survived</span>
</pre></div></div><div><div dir="ltr" lang="en">

<pre dir="ltr" id="CA-3e7479e9aeb129ff4a8ab7d196cfb74198220dae" lang="en"><span><span><a href="#CA-3e7479e9aeb129ff4a8ab7d196cfb74198220dae_1">   1</a> </span><span id="CA-3e7479e9aeb129ff4a8ab7d196cfb74198220dae_1"></span><span id="line-1-10"></span></span>
<span><span><a href="#CA-3e7479e9aeb129ff4a8ab7d196cfb74198220dae_2">   2</a> </span><span id="CA-3e7479e9aeb129ff4a8ab7d196cfb74198220dae_2"></span><span id="line-2-5"></span><span>set</span> -e</span>
<span><span><a href="#CA-3e7479e9aeb129ff4a8ab7d196cfb74198220dae_3">   3</a> </span><span id="CA-3e7479e9aeb129ff4a8ab7d196cfb74198220dae_3"></span><span id="line-3-5"></span>f() { <span>test</span> -d nosuchdir &amp;&amp; <span>echo</span> no dir; }</span>
<span><span><a href="#CA-3e7479e9aeb129ff4a8ab7d196cfb74198220dae_4">   4</a> </span><span id="CA-3e7479e9aeb129ff4a8ab7d196cfb74198220dae_4"></span><span id="line-4-5"></span>f</span>
<span><span><a href="#CA-3e7479e9aeb129ff4a8ab7d196cfb74198220dae_5">   5</a> </span><span id="CA-3e7479e9aeb129ff4a8ab7d196cfb74198220dae_5"></span><span id="line-5-4"></span><span>echo</span> survived</span>
</pre></div></div><p><em>Exercise 4: why aren&#39;t <strong>these</strong> two scripts identical?</em> <span id="line-150"></span><span id="line-151"></span></p><div><div dir="ltr" lang="en">

<pre dir="ltr" id="CA-e6865e773913fc3d87a4167bb4cba5688bd12919" lang="en"><span><span><a href="#CA-e6865e773913fc3d87a4167bb4cba5688bd12919_1">   1</a> </span><span id="CA-e6865e773913fc3d87a4167bb4cba5688bd12919_1"></span><span id="line-1-12"></span><span>set</span> -e</span>
<span><span><a href="#CA-e6865e773913fc3d87a4167bb4cba5688bd12919_2">   2</a> </span><span id="CA-e6865e773913fc3d87a4167bb4cba5688bd12919_2"></span><span id="line-2-6"></span>f() { <span>test</span> -d nosuchdir &amp;&amp; <span>echo</span> no dir; }</span>
<span><span><a href="#CA-e6865e773913fc3d87a4167bb4cba5688bd12919_3">   3</a> </span><span id="CA-e6865e773913fc3d87a4167bb4cba5688bd12919_3"></span><span id="line-3-6"></span>f</span>
<span><span><a href="#CA-e6865e773913fc3d87a4167bb4cba5688bd12919_4">   4</a> </span><span id="CA-e6865e773913fc3d87a4167bb4cba5688bd12919_4"></span><span id="line-4-6"></span><span>echo</span> survived</span>
</pre></div></div><div><div dir="ltr" lang="en">

<pre dir="ltr" id="CA-393c20f1fb168b87ee18f8dfbfa15c14399dca5c" lang="en"><span><span><a href="#CA-393c20f1fb168b87ee18f8dfbfa15c14399dca5c_1">   1</a> </span><span id="CA-393c20f1fb168b87ee18f8dfbfa15c14399dca5c_1"></span><span id="line-1-14"></span><span>set</span> -e</span>
<span><span><a href="#CA-393c20f1fb168b87ee18f8dfbfa15c14399dca5c_2">   2</a> </span><span id="CA-393c20f1fb168b87ee18f8dfbfa15c14399dca5c_2"></span><span id="line-2-7"></span>f() { <span>if</span> <span>test</span> -d nosuchdir; <span>then</span> <span>echo</span> no dir; <span>fi</span>; }</span>
<span><span><a href="#CA-393c20f1fb168b87ee18f8dfbfa15c14399dca5c_3">   3</a> </span><span id="CA-393c20f1fb168b87ee18f8dfbfa15c14399dca5c_3"></span><span id="line-3-7"></span>f</span>
<span><span><a href="#CA-393c20f1fb168b87ee18f8dfbfa15c14399dca5c_4">   4</a> </span><span id="CA-393c20f1fb168b87ee18f8dfbfa15c14399dca5c_4"></span><span id="line-4-7"></span><span>echo</span> survived</span>
</pre></div></div><p><em>Exercise 5: under what conditions will this fail?</em> <span id="line-166"></span><span id="line-167"></span></p><div><div dir="ltr" lang="en">

<pre dir="ltr" id="CA-b178531111346b94bcd4a8e0a32cd52ce4446376" lang="en"><span><span><a href="#CA-b178531111346b94bcd4a8e0a32cd52ce4446376_1">   1</a> </span><span id="CA-b178531111346b94bcd4a8e0a32cd52ce4446376_1"></span><span id="line-1-16"></span><span>set</span> -e</span>
<span><span><a href="#CA-b178531111346b94bcd4a8e0a32cd52ce4446376_2">   2</a> </span><span id="CA-b178531111346b94bcd4a8e0a32cd52ce4446376_2"></span><span id="line-2-8"></span><span>read</span> -r foo &lt; configfile</span>
</pre></div></div><p>(<a href="http://mywiki.wooledge.org/BashFAQ/105/Answers">Answers</a>) <span id="line-173"></span><span id="line-174"></span></p><h3 id="But_wait.2C_there.27s_more.21">But wait, there&#39;s more!</h3>
<p>Even if you use <tt>expr(1)</tt> (which we <em>do not</em> recommend -- use <a href="http://mywiki.wooledge.org/ArithmeticExpression">arithmetic expressions</a> instead), you still run into the same problem: <span id="line-177"></span><span id="line-178"></span></p><div><div dir="ltr" lang="en">

<pre dir="ltr" id="CA-8dbbd6f09bac17ad897a9adce7ae6d60d3af6477" lang="en"><span><span><a href="#CA-8dbbd6f09bac17ad897a9adce7ae6d60d3af6477_1">   1</a> </span><span id="CA-8dbbd6f09bac17ad897a9adce7ae6d60d3af6477_1"></span><span id="line-1-18"></span><span>set</span> -e</span>
<span><span><a href="#CA-8dbbd6f09bac17ad897a9adce7ae6d60d3af6477_2">   2</a> </span><span id="CA-8dbbd6f09bac17ad897a9adce7ae6d60d3af6477_2"></span><span id="line-2-9"></span><span>foo</span>=<span>$(</span>expr <span>1</span> - <span>1</span><span>)</span></span>
<span><span><a href="#CA-8dbbd6f09bac17ad897a9adce7ae6d60d3af6477_3">   3</a> </span><span id="CA-8dbbd6f09bac17ad897a9adce7ae6d60d3af6477_3"></span><span id="line-3-8"></span></span>
<span><span><a href="#CA-8dbbd6f09bac17ad897a9adce7ae6d60d3af6477_4">   4</a> </span><span id="CA-8dbbd6f09bac17ad897a9adce7ae6d60d3af6477_4"></span><span id="line-4-8"></span><span>echo</span> survived</span>
</pre></div></div><p>Subshells from command substitution unset <tt>set -e</tt>, however (unless <tt>inherit_errexit</tt> is set with Bash 4.4): <span id="line-186"></span><span id="line-187"></span></p><div><div dir="ltr" lang="en">

<pre dir="ltr" id="CA-6a7d52e4f57b49d597ea81d82035cad67fcdeaa4" lang="en"><span><span><a href="#CA-6a7d52e4f57b49d597ea81d82035cad67fcdeaa4_1">   1</a> </span><span id="CA-6a7d52e4f57b49d597ea81d82035cad67fcdeaa4_1"></span><span id="line-1-20"></span><span>set</span> -e</span>
<span><span><a href="#CA-6a7d52e4f57b49d597ea81d82035cad67fcdeaa4_2">   2</a> </span><span id="CA-6a7d52e4f57b49d597ea81d82035cad67fcdeaa4_2"></span><span id="line-2-10"></span><span>foo</span>=<span>$(</span>expr <span>1</span> - <span>1</span>; <span>true</span><span>)</span></span>
<span><span><a href="#CA-6a7d52e4f57b49d597ea81d82035cad67fcdeaa4_3">   3</a> </span><span id="CA-6a7d52e4f57b49d597ea81d82035cad67fcdeaa4_3"></span><span id="line-3-9"></span></span>
<span><span><a href="#CA-6a7d52e4f57b49d597ea81d82035cad67fcdeaa4_4">   4</a> </span><span id="CA-6a7d52e4f57b49d597ea81d82035cad67fcdeaa4_4"></span><span id="line-4-9"></span><span>echo</span> survived</span>
</pre></div></div><p>Note that set -e is <strong>not</strong> unset for commands that are run asynchronously, for example with process substitution: <span id="line-195"></span><span id="line-196"></span></p><div><div dir="ltr" lang="en">

<pre dir="ltr" id="CA-8fbd127c179dac9362282120f2e122572fb0f2b1" lang="en"><span><span><a href="#CA-8fbd127c179dac9362282120f2e122572fb0f2b1_1">   1</a> </span><span id="CA-8fbd127c179dac9362282120f2e122572fb0f2b1_1"></span><span id="line-1-22"></span><span>set</span> -e</span>
<span><span><a href="#CA-8fbd127c179dac9362282120f2e122572fb0f2b1_2">   2</a> </span><span id="CA-8fbd127c179dac9362282120f2e122572fb0f2b1_2"></span><span id="line-2-11"></span>mapfile foo &lt; &lt;(true; <span>echo</span> foo)</span>
<span><span><a href="#CA-8fbd127c179dac9362282120f2e122572fb0f2b1_3">   3</a> </span><span id="CA-8fbd127c179dac9362282120f2e122572fb0f2b1_3"></span><span id="line-3-10"></span><span>echo</span> <span>${</span><span>foo</span>[-1]<span>}</span> </span>
<span><span><a href="#CA-8fbd127c179dac9362282120f2e122572fb0f2b1_4">   4</a> </span><span id="CA-8fbd127c179dac9362282120f2e122572fb0f2b1_4"></span><span id="line-4-10"></span>mapfile foo &lt; &lt;(false; <span>echo</span> foo)</span>
<span><span><a href="#CA-8fbd127c179dac9362282120f2e122572fb0f2b1_5">   5</a> </span><span id="CA-8fbd127c179dac9362282120f2e122572fb0f2b1_5"></span><span id="line-5-5"></span><span>echo</span> <span>${</span><span>foo</span>[-1]<span>}</span> </span>
</pre></div></div><p>Another pitfall associated with <tt>set -e</tt> occurs when you use commands that <em>look like</em> assignments but aren&#39;t, such as <tt>export</tt>, <tt>declare</tt>, <tt>typeset</tt> or <tt>local</tt>. <span id="line-205"></span><span id="line-206"></span></p><div><div dir="ltr" lang="en">

<pre dir="ltr" id="CA-a996413e8bc07980e43a5c77ff734372cbd1d6a3" lang="en"><span><span><a href="#CA-a996413e8bc07980e43a5c77ff734372cbd1d6a3_1">   1</a> </span><span id="CA-a996413e8bc07980e43a5c77ff734372cbd1d6a3_1"></span><span id="line-1-24"></span><span>set</span> -e</span>
<span><span><a href="#CA-a996413e8bc07980e43a5c77ff734372cbd1d6a3_2">   2</a> </span><span id="CA-a996413e8bc07980e43a5c77ff734372cbd1d6a3_2"></span><span id="line-2-12"></span>f() { <span>local</span> <span>var</span>=<span>$(</span>somecommand that fails<span>)</span>; }</span>
<span><span><a href="#CA-a996413e8bc07980e43a5c77ff734372cbd1d6a3_3">   3</a> </span><span id="CA-a996413e8bc07980e43a5c77ff734372cbd1d6a3_3"></span><span id="line-3-11"></span>f    </span>
<span><span><a href="#CA-a996413e8bc07980e43a5c77ff734372cbd1d6a3_4">   4</a> </span><span id="CA-a996413e8bc07980e43a5c77ff734372cbd1d6a3_4"></span><span id="line-4-11"></span></span>
<span><span><a href="#CA-a996413e8bc07980e43a5c77ff734372cbd1d6a3_5">   5</a> </span><span id="CA-a996413e8bc07980e43a5c77ff734372cbd1d6a3_5"></span><span id="line-5-6"></span>g() { <span>local</span> var; <span>var</span>=<span>$(</span>somecommand that fails<span>)</span>; }</span>
<span><span><a href="#CA-a996413e8bc07980e43a5c77ff734372cbd1d6a3_6">   6</a> </span><span id="CA-a996413e8bc07980e43a5c77ff734372cbd1d6a3_6"></span><span id="line-6-2"></span>g    </span>
</pre></div></div><p>In function <tt>f</tt>, the exit status of <tt>somecommand</tt> is discarded.  It won&#39;t trigger the <tt>set -e</tt> because the exit status of <tt>local</tt> masks it (the assignment to the variable succeeds, so <tt>local</tt> returns status 0).  In function <tt>g</tt>, the <tt>set -e</tt> is triggered because it uses a <em>real</em> assignment which returns the exit status of <tt>somecommand</tt>. <span id="line-216"></span><span id="line-217"></span></p><p>A particularly dangerous pitfall with <tt>set -e</tt> is combining functions with conditionals. The following snippets will not behave the same way: <span id="line-218"></span><span id="line-219"></span></p><div><div dir="ltr" lang="en">

<pre dir="ltr" id="CA-78c79833c55c7e0c9b3dce01f446de25ea964e3b" lang="en"><span><span><a href="#CA-78c79833c55c7e0c9b3dce01f446de25ea964e3b_1">   1</a> </span><span id="CA-78c79833c55c7e0c9b3dce01f446de25ea964e3b_1"></span><span id="line-1-26"></span><span>set</span> -e</span>
<span><span><a href="#CA-78c79833c55c7e0c9b3dce01f446de25ea964e3b_2">   2</a> </span><span id="CA-78c79833c55c7e0c9b3dce01f446de25ea964e3b_2"></span><span id="line-2-13"></span>f() { false; <span>echo</span> <span>&#34;This won&#39;t run, right?&#34;</span>; }</span>
<span><span><a href="#CA-78c79833c55c7e0c9b3dce01f446de25ea964e3b_3">   3</a> </span><span id="CA-78c79833c55c7e0c9b3dce01f446de25ea964e3b_3"></span><span id="line-3-12"></span>f</span>
<span><span><a href="#CA-78c79833c55c7e0c9b3dce01f446de25ea964e3b_4">   4</a> </span><span id="CA-78c79833c55c7e0c9b3dce01f446de25ea964e3b_4"></span><span id="line-4-12"></span><span>echo</span> survived</span>
</pre></div></div><div><div dir="ltr" lang="en">

<pre dir="ltr" id="CA-05b2275bc0dd2db6084741ad5a89a8c7db98b574" lang="en"><span><span><a href="#CA-05b2275bc0dd2db6084741ad5a89a8c7db98b574_1">   1</a> </span><span id="CA-05b2275bc0dd2db6084741ad5a89a8c7db98b574_1"></span><span id="line-1-28"></span><span>set</span> -e</span>
<span><span><a href="#CA-05b2275bc0dd2db6084741ad5a89a8c7db98b574_2">   2</a> </span><span id="CA-05b2275bc0dd2db6084741ad5a89a8c7db98b574_2"></span><span id="line-2-14"></span>f() { false; <span>echo</span> <span>&#34;This won&#39;t run, right?&#34;</span>; }</span>
<span><span><a href="#CA-05b2275bc0dd2db6084741ad5a89a8c7db98b574_3">   3</a> </span><span id="CA-05b2275bc0dd2db6084741ad5a89a8c7db98b574_3"></span><span id="line-3-13"></span><span>if</span> f; <span>then</span>  </span>
<span><span><a href="#CA-05b2275bc0dd2db6084741ad5a89a8c7db98b574_4">   4</a> </span><span id="CA-05b2275bc0dd2db6084741ad5a89a8c7db98b574_4"></span><span id="line-4-13"></span>    <span>echo</span> survived</span>
<span><span><a href="#CA-05b2275bc0dd2db6084741ad5a89a8c7db98b574_5">   5</a> </span><span id="CA-05b2275bc0dd2db6084741ad5a89a8c7db98b574_5"></span><span id="line-5-7"></span><span>fi</span></span>
</pre></div></div><p>As soon as a function is used as a conditional (in a <a href="http://mywiki.wooledge.org/BashGuide/TestsAndConditionals#Control_Operators_.28.26.26_and_.7C.7C.29">list</a> or with a <a href="http://mywiki.wooledge.org/BashGuide/TestsAndConditionals#Conditional_Blocks_.28if.2C_test_and_.5B.5B.29">conditional</a> test or loop) <tt>set -e</tt> stops being applied within the function. This may not only cause code to unexpectedly start executing in the function but also change its return status! <span id="line-235"></span><span id="line-236"></span></p><p>Using <a href="http://mywiki.wooledge.org/ProcessSubstitution">Process substitution</a>, the exit code is also discarded as it is not visible from the main script: <span id="line-237"></span><span id="line-238"></span></p><div><div dir="ltr" lang="en">

<pre dir="ltr" id="CA-3d07b634d4ca148365746dd1abb51e40e362384a" lang="en"><span><span><a href="#CA-3d07b634d4ca148365746dd1abb51e40e362384a_1">   1</a> </span><span id="CA-3d07b634d4ca148365746dd1abb51e40e362384a_1"></span><span id="line-1-30"></span><span>set</span> -e</span>
<span><span><a href="#CA-3d07b634d4ca148365746dd1abb51e40e362384a_2">   2</a> </span><span id="CA-3d07b634d4ca148365746dd1abb51e40e362384a_2"></span><span id="line-2-15"></span>cat &lt;(somecommand that fails)</span>
<span><span><a href="#CA-3d07b634d4ca148365746dd1abb51e40e362384a_3">   3</a> </span><span id="CA-3d07b634d4ca148365746dd1abb51e40e362384a_3"></span><span id="line-3-14"></span><span>echo</span> survived</span>
</pre></div></div><p>Using a pipe makes no difference, as only the <em>rightmost</em> process is considered: <span id="line-245"></span><span id="line-246"></span></p><div><div dir="ltr" lang="en">

<pre dir="ltr" id="CA-91235d29b66a250185fc16a0ef093a79c11a4ea0" lang="en"><span><span><a href="#CA-91235d29b66a250185fc16a0ef093a79c11a4ea0_1">   1</a> </span><span id="CA-91235d29b66a250185fc16a0ef093a79c11a4ea0_1"></span><span id="line-1-32"></span><span>set</span> -e</span>
<span><span><a href="#CA-91235d29b66a250185fc16a0ef093a79c11a4ea0_2">   2</a> </span><span id="CA-91235d29b66a250185fc16a0ef093a79c11a4ea0_2"></span><span id="line-2-16"></span>somecommand that fails | cat -</span>
<span><span><a href="#CA-91235d29b66a250185fc16a0ef093a79c11a4ea0_3">   3</a> </span><span id="CA-91235d29b66a250185fc16a0ef093a79c11a4ea0_3"></span><span id="line-3-15"></span><span>echo</span> survived</span>
</pre></div></div><p><tt>set -o pipefail</tt> is a workaround by returning the exit code of the <em>first</em> failed process: <span id="line-253"></span><span id="line-254"></span></p><div><div dir="ltr" lang="en">

<pre dir="ltr" id="CA-85519d4fc764a40e01e6c40fb6102770d056c4fc" lang="en"><span><span><a href="#CA-85519d4fc764a40e01e6c40fb6102770d056c4fc_1">   1</a> </span><span id="CA-85519d4fc764a40e01e6c40fb6102770d056c4fc_1"></span><span id="line-1-34"></span><span>set</span> -e -o pipefail</span>
<span><span><a href="#CA-85519d4fc764a40e01e6c40fb6102770d056c4fc_2">   2</a> </span><span id="CA-85519d4fc764a40e01e6c40fb6102770d056c4fc_2"></span><span id="line-2-17"></span>failcmd1 | failcmd2 | cat -</span>
<span><span><a href="#CA-85519d4fc764a40e01e6c40fb6102770d056c4fc_3">   3</a> </span><span id="CA-85519d4fc764a40e01e6c40fb6102770d056c4fc_3"></span><span id="line-3-16"></span></span>
<span><span><a href="#CA-85519d4fc764a40e01e6c40fb6102770d056c4fc_4">   4</a> </span><span id="CA-85519d4fc764a40e01e6c40fb6102770d056c4fc_4"></span><span id="line-4-14"></span><span>echo</span> survived</span>
</pre></div></div><p>though with pipefail in effect, code like this will sometimes cause an error, depending on whether the output of somecmd exceeds the size of the pipe buffer or not: <span id="line-262"></span><span id="line-263"></span></p><div><div dir="ltr" lang="en">

<pre dir="ltr" id="CA-b4374d844a4a2d1b77b65546ada25f83c1c6ec1a" lang="en"><span><span><a href="#CA-b4374d844a4a2d1b77b65546ada25f83c1c6ec1a_1">   1</a> </span><span id="CA-b4374d844a4a2d1b77b65546ada25f83c1c6ec1a_1"></span><span id="line-1-36"></span><span>set</span> -e -o pipefail</span>
<span><span><a href="#CA-b4374d844a4a2d1b77b65546ada25f83c1c6ec1a_2">   2</a> </span><span id="CA-b4374d844a4a2d1b77b65546ada25f83c1c6ec1a_2"></span><span id="line-2-18"></span>somecmd | head -n1</span>
<span><span><a href="#CA-b4374d844a4a2d1b77b65546ada25f83c1c6ec1a_3">   3</a> </span><span id="CA-b4374d844a4a2d1b77b65546ada25f83c1c6ec1a_3"></span><span id="line-3-17"></span></span>
<span><span><a href="#CA-b4374d844a4a2d1b77b65546ada25f83c1c6ec1a_4">   4</a> </span><span id="CA-b4374d844a4a2d1b77b65546ada25f83c1c6ec1a_4"></span><span id="line-4-15"></span><span>echo</span> survived</span>
</pre></div></div><h3 id="So-called_strict_mode">So-called strict mode</h3>
<p>In the mid 2010s, some people decided that the combination of <tt>set -e</tt>, <tt>set -u</tt> and <tt>set -o pipefail</tt> should be used <em>by default</em> in all new shell scripts.  They call this <a href="http://redsymbol.net/articles/unofficial-bash-strict-mode/">unofficial bash strict mode</a>, and they claim that it &#34;makes many classes of subtle bugs impossible&#34; and that if you follow this policy, you will &#34;spend much less time debugging, and also avoid having unexpected complications in production&#34;. <span id="line-274"></span><span id="line-275"></span></p><p>As we&#39;ve already seen in the exercises above, these claims are dubious at best.  The behavior of <tt>set -e</tt> is quite unpredictable.  If you choose to use it, you will have to be hyper-aware of all the false positives that can cause it to trigger, and work around them by &#34;marking&#34; every line that&#39;s <em>allowed</em> to fail with something like <tt>||true</tt>. <span id="line-276"></span><span id="line-277"></span></p><h3 id="Conclusions">Conclusions</h3>
<p><a href="http://mywiki.wooledge.org/GreyCat">GreyCat</a>&#39;s personal recommendation is simple: don&#39;t use <tt>set -e</tt>.  Add your own error checking instead. <span id="line-280"></span><span id="line-281"></span></p><p>rking&#39;s personal recommendation is to go ahead and use <tt>set -e</tt>, but beware of possible gotchas.  It has useful semantics, so to exclude it from the toolbox is to give into FUD. <span id="line-282"></span><span id="line-283"></span></p><p>geirha&#39;s personal recommendation is to handle errors properly and not rely on the unreliable <tt>set -e</tt>. <span id="line-284"></span><span id="bottom"></span></p></div></div>
  </body>
</html>
