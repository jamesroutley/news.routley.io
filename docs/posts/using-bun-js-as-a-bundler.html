<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://shaneosullivan.wordpress.com/2023/05/17/using-bun-js-as-a-bundler/">Original</a>
    <h1>Using Bun.js as a Bundler</h1>
    
    <div id="readability-page-1" class="page"><div>
		
<p>Bun.js is a new (as of 2023) JavaScript runtime that is still very much in development, with it’s primary focus being on extreme speed.  I’ve been following it for a while but until today haven’t had a good excuse to use it.</p>



<p>The author, Jarred Sumner, announced on Twitter today that they have shipped a beta version of a new code bundler for Bun, showing some crazy speed increases over other bundlers.  This piqued my interest, as I use a combination of Webpack, Browserify and Uglify on my side projects, in this case my tablet PWA that I built for my kids <a href="http://kidzfun.art">kidzfun.art</a>, which work but are really slow.</p>



<figure><div>
<div><blockquote data-width="550" data-dnt="true"><p lang="en" dir="ltr">Introducing the Bun Bundler</p>— Jarred Sumner (@jarredsumner) <a href="https://twitter.com/jarredsumner/status/1658552691927429121?ref_src=twsrc%5Etfw">May 16, 2023</a></blockquote></div>
</div></figure>



<p>My current workflow can result in a 5 – 7 second wait for all my JS files to rebuild when I save a file, and I thought that Bun could help with this.  It turns out I was right!  …. with caveats.</p>



<p>You can see the docs for <code>Bun.build()</code> at <a href="https://bun.sh/docs/cli/build" rel="nofollow">https://bun.sh/docs/cli/build</a> , and they are well written and quite comprehensive.  </p>



<p>My requirements were to</p>



<ul>
<li>Build multiple files quickly, each of which imports multiple other 3rd party files from <code>node_modules</code>.</li>



<li>Build minified and non-minified files</li>



<li>The resulting file can be included directly in a browser using a <code>&lt;script&gt;</code> tag. </li>
</ul>







<p>Getting started</p>



<p>I started off by running default build code (for Bun v0.6.1)</p>


<div><pre title="">const myFiles = [...];

await Bun.build({
  entrypoints: [myFiles],
  outdir: &#39;./build&#39;
});

</pre></div>


<p>by adding a script to my <code>package.json</code> file</p>


<div><pre title=""> &#34;build-browser&#34;: &#34;bun scripts/build-browser.js&#34;
</pre></div>


<p>and this worked just fine.  More importantly, it was crazily fast.  Instead of 5 seconds it now seemed to finish as the Enter key was still traveling back upwards from executing the command.  Nice!</p>



<p>Minification</p>



<p>Minification <a href="https://bun.sh/docs/cli/build#minify">looks simple in the docs</a>, but unfortunately it’s where the beta nature of Bun shows up.  Running the code above with minification</p>


<div><pre title="">const myFiles = [...];

await Bun.build({
  entrypoints: [myFiles],
  outdir: &#39;./build&#39;,
  minify: true
});
</pre></div>


<p>results in an error being thrown that shuts down the process if there is more than one entry point file.</p>





<p>Searching the web didn’t turn up anything, but the solution is to only pass a single entry point file path to <code>Bun.build()</code> if you are minifying the code. Throw that in a <code>for</code> loop to get through all the files and it runs just fine!</p>



<p>A second issue with the default minification is that it broke my app in strange ways that I could not track down – I’m guessing that it’s rewriting the code in some way that is not fully stable yet.  I solved it by turning off the <code>syntax</code> minification option</p>


<div><pre title="">const myFiles = [...];

await Bun.build({
  entrypoints: [myFiles],
  outdir: &#39;./build&#39;,
  minify:{
    whitespace: true,
    identifiers: true,
    syntax: false // Setting this to false fixes the issue
  }
});
</pre></div>


<p>Removing Exports</p>



<p>Bun inserts code that looks like this at the bottom of the built file, in this case from a file called <code>account.ts</code></p>


<div><pre title="">var account_default = {};
export {
  account_default as default
};
</pre></div>


<p>If you load this in a browser <code>&lt;script&gt;</code> tag it will throw an error.  I couldn’t find a way to tell Bun how to not output this, so I had to write a relatively simple function to detect this at the end of each output file and remove it.</p>







<p>Watch issues</p>



<p>I have some code that uses the <a href="https://www.npmjs.com/package/node-watch">node-watch</a> module to automatically re-run the build when a file changes. Under the hood this uses the <code>fs.watch</code> function, which it turns out Bun does not yet support.  <a href="https://github.com/oven-sh/bun/issues/832">Here’s the Github issue</a> tracking it.  I tried to use the <a href="https://bun.sh/docs/runtime/hot#watch-mode">native Bun watch</a> functionality, but this executed the script code which is not what I’m looking for.  </p>



<p>I came up with a hacky solution that works fairly well, where I use the <a href="https://marketplace.visualstudio.com/items?itemName=emeraldwalk.RunOnSave">RunOnSave extension</a> for VS Code to execute</p>


<div><pre title="">touch ./.last_modified_timestamp
</pre></div>


<p>every time I save a file.  Then in my build script I use <code>setInterval</code> to check the last modified time of this file and re-run the build if it has changed.  Hacky but it works.  Hopefully Bun will implement <code>fs.watch</code> soon and I can throw out this code.</p>


<div><pre title="">function build() {
  ...
}

const timestampFilePath = `${rootDir}/.last_modified_timestamp`;
if (fs.existsSync(timestampFilePath)) {
  let lastModifiedRootFolder = 0;
  setInterval(() =&gt; {
    const stat = fs.statSync(timestampFilePath);
    if (stat.mtime.getTime() !== lastModifiedRootFolder) {
      lastModifiedRootFolder = stat.mtime.getTime();
      build();
    }
  }, 500);
}
</pre></div>






<p>Vercel build failures</p>



<p>Once everything was running just fine locally on my Mac, I pushed the branch to Github so <a href="http://vercel.com">Vercel</a> would build it (it’s a NextJS application).  This threw up a new issue.  My build script uses the native Node <code>exec()</code> function to move and copy files.  This works just fine on my Mac, but when running the build in the cloud environment all these calls would fail.  There’s something unfinished with Bun’s implementation of the <code>child_process</code> module that breaks when run in the Vercel build environment.</p>



<p>My solution to this was to simply change all these <code>execSync</code> calls to use the Node <code>fs</code> functions, e.g.</p>


<div><pre title="">import fs from &#39;fs&#39;;
....
fs.copyFileSync(srcPath, destPath);
fs.renameSync(path, `${rootDir}/public/${fileName}`);
</pre></div>






<p>Epilogue</p>



<p>After a few hours of work, reading up on Bun and working my way through these issues, I now have a much simpler build system that runs in the blink of an eye.  My Vercel build times have reduced from 2 minutes to just 50 seconds (that’s all React stuff &amp; fetching node_modules).  My watch script runs in a few milliseconds instead of 5 or more seconds,  My code is much simpler and I’ve removed Webpack, Browserify and Uglify from my projects.  </p>



<p>Thanks so much to the Bun team for a great project.  Even as early as it is at time of writing (mid 2023), it’s highly useful, and as they work through all the kinks it will only get more so.  I look forward to using it more in the months and years to come!</p>
	</div><div>
			<div>
				<p><img alt="" src="https://1.gravatar.com/avatar/abaeb4f7149a11600f472c23652ae7db?s=80&amp;d=identicon&amp;r=G" height="80" width="80"/>		</p><!-- .author-avatar -->
		
		<p>
			<h2>Published by <span>Shane O&#39;Sullivan</span></h2>
		</p><!-- .author-heading -->

		<p>
			I am a software engineer and manager from Ireland.  I spent 7 years working in Ireland from 2003 – 2010, then ten years in Silicon Valley from 2010 to 2020.

In California I spent about 6.5 years at Facebook Engineering, the last three of which I was an engineering manager in the Ads organisation focusing on customer facing products for creating and managing ads.

At Stripe I built the Developer Productivity organisation, with teams that were responsible for the use of the Ruby language, testing infrastructure, documentation, developer tooling (e.g. IDE integrations) and more.

At Promise, I was Head of Engineering from 2018 – 2020, responsible for building the first few iterations of our products, hiring for all product roles, meeting with clients and investors, and anything else needed to get a tiny startup bootstrapped and successful.

Now I’m back in Ireland, working on my next company. Coming soon (as of early 2021!).

This blog contains my various musings on all things technical/interesting on the interweb and beyond.			<a href="https://shaneosullivan.wordpress.com/author/shaneosullivan/" rel="author">
				View all posts by Shane O&#39;Sullivan			</a>
		</p><!-- .author-bio -->
	</div><!-- .entry-auhtor -->
		<p><strong>Published</strong>
			<time datetime="2023-05-17T20:41:55+00:00">May 17, 2023</time><time datetime="2023-05-17T21:12:23+00:00">May 17, 2023</time>		</p><!-- .site-posted-on -->
	</div></div>
  </body>
</html>
