<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://maxhalford.github.io/blog/ogd-in-sql/">Original</a>
    <h1>Stochastic gradient descent written in SQL</h1>
    
    <div id="readability-page-1" class="page"><div><h2 id="toc">Table of contents</h2><nav id="TableOfContents"><ul><li><a href="#introduction">Introduction</a></li><li><a href="#some-data">Some data</a></li><li><a href="#running-average">Running average</a></li><li><a href="#running-covariance">Running covariance</a></li><li><a href="#handling-many-variables">Handling many variables</a></li><li><a href="#online-gradient-descent">Online gradient descent</a></li><li><a href="#conclusion">Conclusion</a></li></ul></nav><p><em>Edit: this post <a href="https://news.ycombinator.com/item?id=35054786">generated</a> a few insightful comments on Hacker News. I’ve also put the code in a <a href="https://gist.github.com/MaxHalford/823c4e7f9216607dc853724ec74ec692">notebook</a> for ease of use.</em></p><h2 id="introduction">Introduction</h2><p>Modern MLOps is complex because it involves too many components. You need a message bus, a stream processing engine, an API, a model store, a feature store, a monitoring service, etc. Sadly, containerisation software and the unbundling trend have encouraged an appetite for complexity. I believe MLOps shouldn’t be this complex. For instance, MLOps can be made simpler by <a href="https://www.ethanrosenthal.com/2022/05/10/database-bundling/">bundling the logic into your database</a>.</p><p>In this post, I want to push this idea, and actually implement a machine learning algorithm within a relational database, using SQL. <a href="https://mindsdb.com/">Some</a> <a href="https://supabase.com/blog/openai-embeddings-postgres-vector">databases</a> allow doing inference with an already trained model. Actually training the model in the database would remove altogether the need for a separate inference/training service.</p><p>Being familiar with online machine learning, I picked online gradient descent. My gut feeling is that this should be a straightforward implementation using <code>WITH RECURSIVE</code>. I decided to work my way up to it by first implementing simpler online algorithms, starting with a running average.</p><h2 id="some-data">Some data</h2><p>To illustrate, I took some Yahoo! Finance data:</p><div><pre tabindex="0"><code data-lang="py"><span><span><span>import</span> <span>yfinance</span> <span>as</span> <span>yf</span>
</span></span><span><span>
</span></span><span><span><span>figures</span> <span>=</span> <span>yf</span><span>.</span><span>download</span><span>(</span>
</span></span><span><span>    <span>tickers</span><span>=</span><span>[</span><span>&#39;AAPL&#39;</span><span>],</span>
</span></span><span><span>    <span>start</span><span>=</span><span>&#39;2020-01-01&#39;</span><span>,</span>
</span></span><span><span>    <span>end</span><span>=</span><span>&#39;2022-01-01&#39;</span>
</span></span><span><span><span>)</span>
</span></span><span><span><span>figures</span> <span>/=</span> <span>figures</span><span>.</span><span>std</span><span>()</span>
</span></span><span><span><span>figures</span><span>.</span><span>tail</span><span>()</span>
</span></span></code></pre></div><table><thead><tr><th>Date</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>Adj Close</th><th>Volume</th></tr></thead><tbody><tr><td>2021-12-27</td><td>2.00543</td><td>2.06042</td><td>2.06425</td><td>2.11303</td><td>2.11677</td><td>-0.7789</td></tr><tr><td>2021-12-28</td><td>2.10966</td><td>2.09118</td><td>2.11413</td><td>2.0777</td><td>2.08174</td><td>-0.712006</td></tr><tr><td>2021-12-29</td><td>2.08148</td><td>2.06752</td><td>2.1008</td><td>2.08076</td><td>2.08477</td><td>-0.977945</td></tr><tr><td>2021-12-30</td><td>2.08623</td><td>2.06549</td><td>2.0991</td><td>2.04068</td><td>2.04502</td><td>-1.01873</td></tr><tr><td>2021-12-31</td><td>2.03938</td><td>2.0202</td><td>2.07074</td><td>2.01928</td><td>2.0238</td><td>-0.950815</td></tr></tbody></table><p>☝️ <em>I normalized the data using standard scaling. This puts the figures on a friendlier scale. It will also help the online gradient descent converge. This could very well be done in SQL, but this is fine too.</em></p><h2 id="running-average">Running average</h2><p>With SQL, we could obviously just use <code>AVG</code> to obtain an average. We could also use a <a href="https://duckdb.org/docs/sql/window_functions.html">window function</a> if we wanted to calculate the average at every point in time.</p><p>I’m not sure how common knowledge this is, but there is a formula that allows <a href="https://nestedsoftware.com/2018/03/20/calculating-a-moving-average-on-streaming-data-5a7k.22879.html">updating a running average</a> with a new data point in $\mathcal{O}(1)$ time. This can be applied to a data stream, because the update formula only requires the current data point, as well as the current average.</p><p>$$\mu_0 = 0$$
$$\mu_{t+1} = \mu_t + \frac{x - \mu_t}{t + 1}$$</p><p>I’ll be using DuckDB. A nice feature is that it’s aware of any existing pandas dataframe – provided you’re running DuckDB <a href="https://duckdb.org/docs/api/python/overview">using Python</a>. Indeed, we can directly query the <code>figures</code> dataframe. Also, DuckDB supports <code>WITH RECURSIVE</code>, which is the cornerstone I’ll make heavy use of.</p><p>There are many good tutorials about how <code>WITH RECURSIVE</code> works, so I won’t expand on it. The way I will use it is a bit particular, in that I leverage it to update some current state. The current state points to the current row. At each recursion step, the current state is joined with the next row, which allows updating the state.</p><div><figure><img width="75%" src="https://maxhalford.github.io/img/blog/sgd-in-sql/recursion.png"/><figcaption>Recursive state update</figcaption></figure></div><p>The first idea is to assign a step number to each row. Assuming the rows are pre-sorted, a <code>ROW_NUMBER</code> can be used to assign an auto-incrementing integer to each row. This step column is then used to connect each state to the next row.</p><div><pre tabindex="0"><code data-lang="sql"><span><span><span>WITH</span><span> </span><span>RECURSIVE</span><span>
</span></span></span><span><span><span>    </span><span>stream</span><span> </span><span>AS</span><span> </span><span>(</span><span>
</span></span></span><span><span><span>        </span><span>SELECT</span><span>
</span></span></span><span><span><span>            </span><span>ROW_NUMBER</span><span>()</span><span> </span><span>OVER</span><span> </span><span>()</span><span> </span><span>AS</span><span> </span><span>step</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>&#34;Adj Close&#34;</span><span> </span><span>AS</span><span> </span><span>x</span><span>
</span></span></span><span><span><span>        </span><span>FROM</span><span> </span><span>figures</span><span>
</span></span></span><span><span><span>    </span><span>),</span><span>
</span></span></span><span><span><span>    </span><span>state</span><span>(</span><span>step</span><span>,</span><span> </span><span>x</span><span>,</span><span> </span><span>avg</span><span>)</span><span> </span><span>AS</span><span> </span><span>(</span><span>
</span></span></span><span><span><span>        </span><span>-- Initialize
</span></span></span><span><span><span></span><span>        </span><span>SELECT</span><span> </span><span>step</span><span>,</span><span> </span><span>x</span><span>,</span><span> </span><span>x</span><span> </span><span>AS</span><span> </span><span>avg</span><span>
</span></span></span><span><span><span>        </span><span>FROM</span><span> </span><span>stream</span><span>
</span></span></span><span><span><span>        </span><span>WHERE</span><span> </span><span>step</span><span> </span><span>=</span><span> </span><span>1</span><span>
</span></span></span><span><span><span>        </span><span>UNION</span><span> </span><span>ALL</span><span>
</span></span></span><span><span><span>        </span><span>-- Update
</span></span></span><span><span><span></span><span>        </span><span>SELECT</span><span>
</span></span></span><span><span><span>            </span><span>stream</span><span>.</span><span>step</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>stream</span><span>.</span><span>x</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>state</span><span>.</span><span>avg</span><span> </span><span>+</span><span> </span><span>(</span><span>stream</span><span>.</span><span>x</span><span> </span><span>-</span><span> </span><span>state</span><span>.</span><span>avg</span><span>)</span><span> </span><span>/</span><span> </span><span>stream</span><span>.</span><span>step</span><span> </span><span>AS</span><span> </span><span>avg</span><span>
</span></span></span><span><span><span>        </span><span>FROM</span><span> </span><span>stream</span><span>
</span></span></span><span><span><span>        </span><span>INNER</span><span> </span><span>JOIN</span><span> </span><span>state</span><span> </span><span>ON</span><span> </span><span>state</span><span>.</span><span>step</span><span> </span><span>+</span><span> </span><span>1</span><span> </span><span>=</span><span> </span><span>stream</span><span>.</span><span>step</span><span>
</span></span></span><span><span><span>    </span><span>)</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>SELECT</span><span> </span><span>*</span><span>
</span></span></span><span><span><span></span><span>FROM</span><span> </span><span>state</span><span>
</span></span></span><span><span><span></span><span>ORDER</span><span> </span><span>BY</span><span> </span><span>step</span><span> </span><span>DESC</span><span>
</span></span></span><span><span><span></span><span>LIMIT</span><span> </span><span>5</span><span>
</span></span></span></code></pre></div><pre tabindex="0"><code>┌───────┬───────────────────┬────────────────────┐
│ step  │         x         │        avg         │
│ int64 │      double       │       double       │
├───────┼───────────────────┼────────────────────┤
│   505 │ 5.981568542028378 │ 3.9577706471349923 │
│   504 │ 6.002789566151079 │  3.953755175121315 │
│   503 │ 6.042539700173864 │  3.949681548101375 │
│   502 │ 6.039508125299193 │  3.945512507957804 │
│   501 │ 6.074541325571636 │  3.941332875987063 │
└───────┴───────────────────┴────────────────────┘
</code></pre><p>We can verify this is correct by doing a rolling mean in pandas:</p><div><pre tabindex="0"><code data-lang="py"><span><span><span>(</span>
</span></span><span><span>    <span>figures</span><span>[</span><span>&#39;Adj Close&#39;</span><span>]</span>
</span></span><span><span>    <span>.</span><span>rolling</span><span>(</span><span>len</span><span>(</span><span>figures</span><span>),</span> <span>min_periods</span><span>=</span><span>1</span><span>)</span>
</span></span><span><span>    <span>.</span><span>mean</span><span>()</span>
</span></span><span><span>    <span>.</span><span>tail</span><span>()[::</span><span>-</span><span>1</span><span>]</span>
</span></span><span><span><span>)</span>
</span></span></code></pre></div><pre tabindex="0"><code>Date
2021-12-31    3.957771
2021-12-30    3.953755
2021-12-29    3.949682
2021-12-28    3.945513
2021-12-27    3.941333
</code></pre><p>☝️ <em>This usage of <code>WITH PARTITION</code> essentially boils down to a window function. This could be implemented as such, which would avoid the headache of thinking in terms of recursion. For instance, PostgreSQL supports <a href="https://www.postgresql.org/docs/current/xaggr.html">user-defined aggregates</a>, which can be applied over a window. However, the <code>WITH PARTITION</code> syntax has better support across databases.</em></p><h2 id="running-covariance">Running covariance</h2><p>The query above measures the running average for a single variable – namely <code>Adj Close</code>. What if we want to compute something that involves more than one variable? The naive way is to just copy/paste the logic for each variable. For instance, to calculate a running covariance, it is necessary to compute the running average of two variables. Check out <a href="https://www.wikiwand.com/en/Algorithms_for_calculating_variance#Covariance">Welford’s algorithm</a> for more information.</p><div><pre tabindex="0"><code data-lang="sql"><span><span><span>WITH</span><span> </span><span>RECURSIVE</span><span>
</span></span></span><span><span><span>    </span><span>stream</span><span> </span><span>AS</span><span> </span><span>(</span><span>
</span></span></span><span><span><span>        </span><span>SELECT</span><span>
</span></span></span><span><span><span>            </span><span>ROW_NUMBER</span><span>()</span><span> </span><span>OVER</span><span> </span><span>()</span><span> </span><span>AS</span><span> </span><span>step</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>&#34;Adj Close&#34;</span><span> </span><span>AS</span><span> </span><span>x</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>&#34;Close&#34;</span><span> </span><span>AS</span><span> </span><span>y</span><span>
</span></span></span><span><span><span>        </span><span>FROM</span><span> </span><span>figures</span><span>
</span></span></span><span><span><span>    </span><span>),</span><span>
</span></span></span><span><span><span>    </span><span>state</span><span>(</span><span>step</span><span>,</span><span> </span><span>x</span><span>,</span><span> </span><span>x_avg</span><span>,</span><span> </span><span>y</span><span>,</span><span> </span><span>y_avg</span><span>,</span><span> </span><span>cov</span><span>)</span><span> </span><span>AS</span><span> </span><span>(</span><span>
</span></span></span><span><span><span>        </span><span>-- Initialize
</span></span></span><span><span><span></span><span>        </span><span>SELECT</span><span>
</span></span></span><span><span><span>            </span><span>step</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>x</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>x</span><span> </span><span>AS</span><span> </span><span>x_avg</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>y</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>y</span><span> </span><span>AS</span><span> </span><span>y_avg</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>0</span><span>::</span><span>DOUBLE</span><span> </span><span>AS</span><span> </span><span>cov</span><span>
</span></span></span><span><span><span>        </span><span>FROM</span><span> </span><span>stream</span><span>
</span></span></span><span><span><span>        </span><span>WHERE</span><span> </span><span>step</span><span> </span><span>=</span><span> </span><span>1</span><span>
</span></span></span><span><span><span>        </span><span>UNION</span><span> </span><span>ALL</span><span>
</span></span></span><span><span><span>        </span><span>-- Update
</span></span></span><span><span><span></span><span>        </span><span>SELECT</span><span>
</span></span></span><span><span><span>            </span><span>step</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>x</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>x_new_avg</span><span> </span><span>AS</span><span> </span><span>x_avg</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>y</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>y_new_avg</span><span> </span><span>AS</span><span> </span><span>y_avg</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>cov</span><span> </span><span>+</span><span> </span><span>((</span><span>x</span><span> </span><span>-</span><span> </span><span>x_prev_avg</span><span>)</span><span> </span><span>*</span><span> </span><span>(</span><span>y</span><span> </span><span>-</span><span> </span><span>y_new_avg</span><span>)</span><span> </span><span>-</span><span> </span><span>cov</span><span>)</span><span> </span><span>/</span><span> </span><span>step</span><span> </span><span>AS</span><span> </span><span>cov</span><span>
</span></span></span><span><span><span>        </span><span>FROM</span><span> </span><span>(</span><span>
</span></span></span><span><span><span>            </span><span>SELECT</span><span>
</span></span></span><span><span><span>                </span><span>stream</span><span>.</span><span>step</span><span>,</span><span>
</span></span></span><span><span><span>                </span><span>stream</span><span>.</span><span>x</span><span>,</span><span>
</span></span></span><span><span><span>                </span><span>stream</span><span>.</span><span>y</span><span>,</span><span>
</span></span></span><span><span><span>                </span><span>state</span><span>.</span><span>x_avg</span><span> </span><span>AS</span><span> </span><span>x_prev_avg</span><span>,</span><span>
</span></span></span><span><span><span>                </span><span>state</span><span>.</span><span>x_avg</span><span> </span><span>+</span><span> </span><span>(</span><span>stream</span><span>.</span><span>x</span><span> </span><span>-</span><span> </span><span>state</span><span>.</span><span>x_avg</span><span>)</span><span> </span><span>/</span><span> </span><span>stream</span><span>.</span><span>step</span><span> </span><span>AS</span><span> </span><span>x_new_avg</span><span>,</span><span>
</span></span></span><span><span><span>                </span><span>state</span><span>.</span><span>y_avg</span><span> </span><span>AS</span><span> </span><span>y_prev_avg</span><span>,</span><span>
</span></span></span><span><span><span>                </span><span>state</span><span>.</span><span>y_avg</span><span> </span><span>+</span><span> </span><span>(</span><span>stream</span><span>.</span><span>y</span><span> </span><span>-</span><span> </span><span>state</span><span>.</span><span>y_avg</span><span>)</span><span> </span><span>/</span><span> </span><span>stream</span><span>.</span><span>step</span><span> </span><span>AS</span><span> </span><span>y_new_avg</span><span>,</span><span>
</span></span></span><span><span><span>                </span><span>state</span><span>.</span><span>cov</span><span>
</span></span></span><span><span><span>            </span><span>FROM</span><span> </span><span>stream</span><span>
</span></span></span><span><span><span>            </span><span>INNER</span><span> </span><span>JOIN</span><span> </span><span>state</span><span> </span><span>ON</span><span> </span><span>state</span><span>.</span><span>step</span><span> </span><span>+</span><span> </span><span>1</span><span> </span><span>=</span><span> </span><span>stream</span><span>.</span><span>step</span><span>
</span></span></span><span><span><span>        </span><span>)</span><span>
</span></span></span><span><span><span>    </span><span>)</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>SELECT</span><span> </span><span>step</span><span>,</span><span> </span><span>cov</span><span>
</span></span></span><span><span><span></span><span>FROM</span><span> </span><span>state</span><span>
</span></span></span><span><span><span></span><span>ORDER</span><span> </span><span>BY</span><span> </span><span>step</span><span> </span><span>DESC</span><span>
</span></span></span><span><span><span></span><span>LIMIT</span><span> </span><span>5</span><span>
</span></span></span></code></pre></div><pre tabindex="0"><code>┌───────┬────────────────────┐
│ step  │        cov         │
│ int64 │       double       │
├───────┼────────────────────┤
│   505 │ 0.9979967767965502 │
│   504 │ 0.9918524780369538 │
│   503 │  0.985478504290919 │
│   502 │ 0.9787158318485241 │
│   501 │ 0.9719167545245742 │
└───────┴────────────────────┘
</code></pre><p>Other than handling two variables, the major difference with this query is that a subquery is used to calculate some intermediary state. We will reuse this idea for online gradient descent.</p><p>We can also verify the output is correct by comparing to pandas:</p><div><pre tabindex="0"><code data-lang="py"><span><span><span>(</span>
</span></span><span><span>    <span>figures</span>
</span></span><span><span>    <span>.</span><span>rolling</span><span>(</span><span>len</span><span>(</span><span>figures</span><span>),</span> <span>min_periods</span><span>=</span><span>1</span><span>)</span>
</span></span><span><span>    <span>.</span><span>cov</span><span>(</span><span>ddof</span><span>=</span><span>0</span><span>)[</span><span>&#39;Adj Close&#39;</span><span>]</span>
</span></span><span><span>    <span>.</span><span>loc</span><span>[:,</span> <span>&#39;Close&#39;</span><span>]</span>
</span></span><span><span>    <span>.</span><span>tail</span><span>()[::</span><span>-</span><span>1</span><span>]</span>
</span></span><span><span><span>)</span>
</span></span></code></pre></div><pre tabindex="0"><code>Date
2021-12-31    0.997997
2021-12-30    0.991852
2021-12-29    0.985479
2021-12-28    0.978716
2021-12-27    0.971917
</code></pre><h2 id="handling-many-variables">Handling many variables</h2><p>The downside of the queries above is that the variable names have to be hardcoded. There is no way to handle an arbitrary number of variables. For instance, if we have several variables, how would we calculate the average of each variable, without expliciting them in the query?</p><p>As is often the case, converting the data to a <a href="https://r4ds.had.co.nz/tidy-data.html">tidy representation</a> makes life easier. In this case, tidy data is obtained by melting – i.e. unpivoting – the dataframe.</p><div><pre tabindex="0"><code data-lang="py"><span><span><span>figures_flat</span> <span>=</span> <span>figures</span><span>.</span><span>melt</span><span>(</span><span>ignore_index</span><span>=</span><span>False</span><span>)</span><span>.</span><span>reset_index</span><span>()</span>
</span></span><span><span><span>figures_flat</span><span>.</span><span>columns</span> <span>=</span> <span>[</span><span>&#39;date&#39;</span><span>,</span> <span>&#39;variable&#39;</span><span>,</span> <span>&#39;value&#39;</span><span>]</span>
</span></span><span><span><span>figures_flat</span> <span>=</span> <span>figures_flat</span><span>.</span><span>sort_values</span><span>([</span><span>&#39;date&#39;</span><span>,</span> <span>&#39;variable&#39;</span><span>])</span>
</span></span><span><span><span>figures_flat</span><span>.</span><span>head</span><span>(</span><span>10</span><span>)</span>
</span></span></code></pre></div><table><thead><tr><th>date</th><th>variable</th><th>value</th></tr></thead><tbody><tr><td>2020-01-02</td><td>Adj Close</td><td>-1.46542</td></tr><tr><td>2020-01-02</td><td>Close</td><td>-1.46182</td></tr><tr><td>2020-01-02</td><td>High</td><td>-1.49763</td></tr><tr><td>2020-01-02</td><td>Low</td><td>-1.46396</td></tr><tr><td>2020-01-02</td><td>Open</td><td>-1.49242</td></tr><tr><td>2020-01-02</td><td>Volume</td><td>0.180024</td></tr><tr><td>2020-01-03</td><td>Adj Close</td><td>-1.48965</td></tr><tr><td>2020-01-03</td><td>Close</td><td>-1.48662</td></tr><tr><td>2020-01-03</td><td>High</td><td>-1.4978</td></tr><tr><td>2020-01-03</td><td>Low</td><td>-1.45277</td></tr></tbody></table><div><pre tabindex="0"><code data-lang="sql"><span><span><span>WITH</span><span> </span><span>RECURSIVE</span><span>
</span></span></span><span><span><span>    </span><span>stream</span><span> </span><span>AS</span><span> </span><span>(</span><span>
</span></span></span><span><span><span>        </span><span>SELECT</span><span> </span><span>RANK_DENSE</span><span>()</span><span> </span><span>OVER</span><span> </span><span>(</span><span>ORDER</span><span> </span><span>BY</span><span> </span><span>date</span><span>)</span><span> </span><span>AS</span><span> </span><span>step</span><span>,</span><span> </span><span>*</span><span>
</span></span></span><span><span><span>        </span><span>FROM</span><span> </span><span>figures_flat</span><span>
</span></span></span><span><span><span>        </span><span>ORDER</span><span> </span><span>BY</span><span> </span><span>date</span><span>
</span></span></span><span><span><span>    </span><span>),</span><span>
</span></span></span><span><span><span>    </span><span>state</span><span>(</span><span>step</span><span>,</span><span> </span><span>variable</span><span>,</span><span> </span><span>value</span><span>,</span><span> </span><span>avg</span><span>)</span><span> </span><span>AS</span><span> </span><span>(</span><span>
</span></span></span><span><span><span>        </span><span>-- Initialize
</span></span></span><span><span><span></span><span>        </span><span>SELECT</span><span> </span><span>step</span><span>,</span><span> </span><span>variable</span><span>,</span><span> </span><span>value</span><span>,</span><span> </span><span>value</span><span> </span><span>AS</span><span> </span><span>avg</span><span>
</span></span></span><span><span><span>        </span><span>FROM</span><span> </span><span>stream</span><span>
</span></span></span><span><span><span>        </span><span>WHERE</span><span> </span><span>step</span><span> </span><span>=</span><span> </span><span>1</span><span>
</span></span></span><span><span><span>        </span><span>UNION</span><span> </span><span>ALL</span><span>
</span></span></span><span><span><span>        </span><span>-- Update
</span></span></span><span><span><span></span><span>        </span><span>SELECT</span><span>
</span></span></span><span><span><span>            </span><span>stream</span><span>.</span><span>step</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>stream</span><span>.</span><span>variable</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>stream</span><span>.</span><span>value</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>state</span><span>.</span><span>avg</span><span> </span><span>+</span><span> </span><span>(</span><span>stream</span><span>.</span><span>value</span><span> </span><span>-</span><span> </span><span>state</span><span>.</span><span>avg</span><span>)</span><span> </span><span>/</span><span> </span><span>stream</span><span>.</span><span>step</span><span> </span><span>AS</span><span> </span><span>avg</span><span>
</span></span></span><span><span><span>        </span><span>FROM</span><span> </span><span>stream</span><span>
</span></span></span><span><span><span>        </span><span>INNER</span><span> </span><span>JOIN</span><span> </span><span>state</span><span> </span><span>ON</span><span>
</span></span></span><span><span><span>            </span><span>state</span><span>.</span><span>step</span><span> </span><span>+</span><span> </span><span>1</span><span> </span><span>=</span><span> </span><span>stream</span><span>.</span><span>step</span><span> </span><span>AND</span><span>
</span></span></span><span><span><span>            </span><span>state</span><span>.</span><span>variable</span><span> </span><span>=</span><span> </span><span>stream</span><span>.</span><span>variable</span><span>
</span></span></span><span><span><span>    </span><span>)</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>SELECT</span><span> </span><span>*</span><span>
</span></span></span><span><span><span></span><span>FROM</span><span> </span><span>state</span><span>
</span></span></span><span><span><span></span><span>WHERE</span><span> </span><span>step</span><span> </span><span>=</span><span> </span><span>(</span><span>SELECT</span><span> </span><span>MAX</span><span>(</span><span>step</span><span>)</span><span> </span><span>FROM</span><span> </span><span>state</span><span>)</span><span>
</span></span></span><span><span><span></span><span>ORDER</span><span> </span><span>BY</span><span> </span><span>variable</span><span>
</span></span></span></code></pre></div><pre tabindex="0"><code>┌───────┬───────────┬────────────────────┬────────────────────┐
│ step  │ variable  │       value        │        avg         │
│ int64 │  varchar  │       double       │       double       │
├───────┼───────────┼────────────────────┼────────────────────┤
│   505 │ Adj Close │  5.981568542028378 │ 3.9577706471349923 │
│   505 │ Close     │   6.03165394229666 │  4.012373756823449 │
│   505 │ High      │  6.057853942108038 │   4.03765319364954 │
│   505 │ Low       │   6.05591789308585 │  3.985178489614261 │
│   505 │ Open      │  6.046125216781687 │  4.006746251814558 │
│   505 │ Volume    │ 1.0143664144585565 │ 1.9651814487272024 │
└───────┴───────────┴────────────────────┴────────────────────┘
</code></pre><p>The main difference with the first query is that the join condition in the recursion includes the variable name, as well as the step number. A <code>RANK_DENSE</code> statement is also used instead of <code>ROW_NUMBER</code> to assign a step number to each group of rows.</p><p>Here is the equivalent using pandas:</p><div><pre tabindex="0"><code data-lang="py"><span><span><span>(</span>
</span></span><span><span>    <span>figures_flat</span>
</span></span><span><span>    <span>.</span><span>groupby</span><span>(</span><span>&#39;variable&#39;</span><span>)[</span><span>&#39;value&#39;</span><span>]</span>
</span></span><span><span>    <span>.</span><span>rolling</span><span>(</span><span>len</span><span>(</span><span>figures_flat</span><span>),</span> <span>min_periods</span><span>=</span><span>1</span><span>)</span>
</span></span><span><span>    <span>.</span><span>mean</span><span>()</span>
</span></span><span><span>    <span>.</span><span>groupby</span><span>(</span><span>&#39;variable&#39;</span><span>)</span>
</span></span><span><span>    <span>.</span><span>tail</span><span>(</span><span>1</span><span>)[::</span><span>-</span><span>1</span><span>]</span><span>.</span><span>sort_index</span><span>()</span>
</span></span><span><span><span>)</span>
</span></span></code></pre></div><pre tabindex="0"><code>variable
Adj Close  3.957771
Close      4.012374
High       4.037653
Low        3.985178
Open       4.006746
Volume     1.965181
</code></pre><h2 id="online-gradient-descent">Online gradient descent</h2><p>Finally, we have enough experience to implement online gradient descent. To keep things simple, we will use a very vanilla version:</p><ul><li>Constant learning rate, as opposed to a <a href="https://www.wikiwand.com/en/Learning_rate#Learning_rate_schedule">schedule</a>.</li><li>Single epoch, we only do one pass on the data.</li><li>Not stochastic: the rows are not shuffled.</li><li>Squared loss, which is the standard loss for regression.</li><li>No gradient clipping.</li><li>No weight regularisation.</li><li>No intercept term.</li></ul><p>None of these are impossible to implement using SQL. I just thought I’d keep things simple in order to keep the code digest. Anyway, these assumptions lead to the following update formulas:</p><p>$$p_t = \dot{w}_t \cdot \dot{x}_t$$</p><p>$$l_t = p_t - y_t$$</p><p>$$\dot{g}_t = l_t \dot{x}_t$$</p><p>$$\dot{w}_{t+1} = \dot{w}_t - \eta \dot{g}_t$$</p><p>I’ve added a $\dot{}$ symbol to the vector variables. Therefore $p_t$ is the prediction, defined as the dot product between weights $\dot{w}_t$ and features $\dot{x}_t$. The gradient of the loss $l_t$ is used to obtain the error gradient for the features $\dot{g}_t$, which respect to the current weights. This all leads to the simple weight update formula $\dot{w}_t - \eta \dot{g}_t$.</p><p>As an example, I decided to predict the <code>Adj Close</code> variable using the other variables. I’m not saying this makes a lot of sense, it’s just for the sake of example.</p><div><pre tabindex="0"><code data-lang="sql"><span><span><span>WITH</span><span> </span><span>RECURSIVE</span><span>
</span></span></span><span><span><span>    </span><span>X</span><span> </span><span>AS</span><span> </span><span>(</span><span>
</span></span></span><span><span><span>        </span><span>SELECT</span><span>
</span></span></span><span><span><span>            </span><span>RANK_DENSE</span><span>()</span><span> </span><span>OVER</span><span> </span><span>(</span><span>ORDER</span><span> </span><span>BY</span><span> </span><span>date</span><span>)</span><span> </span><span>AS</span><span> </span><span>step</span><span>,</span><span> </span><span>*</span><span>
</span></span></span><span><span><span>        </span><span>FROM</span><span> </span><span>figures_flat</span><span>
</span></span></span><span><span><span>        </span><span>WHERE</span><span> </span><span>variable</span><span> </span><span>!=</span><span> </span><span>&#39;Adj Close&#39;</span><span>
</span></span></span><span><span><span>        </span><span>ORDER</span><span> </span><span>BY</span><span> </span><span>date</span><span>
</span></span></span><span><span><span>    </span><span>),</span><span>
</span></span></span><span><span><span>    </span><span>y</span><span> </span><span>AS</span><span> </span><span>(</span><span>
</span></span></span><span><span><span>        </span><span>SELECT</span><span>
</span></span></span><span><span><span>            </span><span>RANK_DENSE</span><span>()</span><span> </span><span>OVER</span><span> </span><span>(</span><span>ORDER</span><span> </span><span>BY</span><span> </span><span>date</span><span>)</span><span> </span><span>AS</span><span> </span><span>step</span><span>,</span><span> </span><span>*</span><span>
</span></span></span><span><span><span>        </span><span>FROM</span><span> </span><span>figures_flat</span><span>
</span></span></span><span><span><span>        </span><span>WHERE</span><span> </span><span>variable</span><span> </span><span>=</span><span> </span><span>&#39;Adj Close&#39;</span><span>
</span></span></span><span><span><span>        </span><span>ORDER</span><span> </span><span>BY</span><span> </span><span>date</span><span>
</span></span></span><span><span><span>    </span><span>),</span><span>
</span></span></span><span><span><span>    </span><span>stream</span><span> </span><span>AS</span><span> </span><span>(</span><span>
</span></span></span><span><span><span>        </span><span>SELECT</span><span> </span><span>X</span><span>.</span><span>*</span><span>,</span><span> </span><span>y</span><span>.</span><span>value</span><span> </span><span>AS</span><span> </span><span>target</span><span>
</span></span></span><span><span><span>        </span><span>FROM</span><span> </span><span>X</span><span>
</span></span></span><span><span><span>        </span><span>INNER</span><span> </span><span>JOIN</span><span> </span><span>y</span><span> </span><span>ON</span><span> </span><span>X</span><span>.</span><span>step</span><span> </span><span>=</span><span> </span><span>y</span><span>.</span><span>step</span><span>
</span></span></span><span><span><span>    </span><span>),</span><span>
</span></span></span><span><span><span>    </span><span>state</span><span> </span><span>AS</span><span> </span><span>(</span><span>
</span></span></span><span><span><span>        </span><span>-- Initialize
</span></span></span><span><span><span></span><span>        </span><span>SELECT</span><span>
</span></span></span><span><span><span>            </span><span>step</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>target</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>variable</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>value</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>0</span><span>::</span><span>DOUBLE</span><span> </span><span>AS</span><span> </span><span>weight</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>0</span><span>::</span><span>DOUBLE</span><span> </span><span>AS</span><span> </span><span>prediction</span><span>
</span></span></span><span><span><span>        </span><span>FROM</span><span> </span><span>stream</span><span>
</span></span></span><span><span><span>        </span><span>WHERE</span><span> </span><span>step</span><span> </span><span>=</span><span> </span><span>1</span><span>
</span></span></span><span><span><span>        </span><span>UNION</span><span> </span><span>ALL</span><span>
</span></span></span><span><span><span>        </span><span>-- Update
</span></span></span><span><span><span></span><span>        </span><span>SELECT</span><span>
</span></span></span><span><span><span>            </span><span>step</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>target</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>variable</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>value</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>weight</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>SUM</span><span>(</span><span>weight</span><span> </span><span>*</span><span> </span><span>value</span><span>)</span><span> </span><span>OVER</span><span> </span><span>()</span><span> </span><span>AS</span><span> </span><span>prediction</span><span>
</span></span></span><span><span><span>        </span><span>FROM</span><span> </span><span>(</span><span>
</span></span></span><span><span><span>            </span><span>SELECT</span><span>
</span></span></span><span><span><span>                </span><span>stream</span><span>.</span><span>step</span><span>,</span><span>
</span></span></span><span><span><span>                </span><span>stream</span><span>.</span><span>target</span><span>,</span><span>
</span></span></span><span><span><span>                </span><span>stream</span><span>.</span><span>variable</span><span>,</span><span>
</span></span></span><span><span><span>                </span><span>stream</span><span>.</span><span>value</span><span>,</span><span>
</span></span></span><span><span><span>                </span><span>state</span><span>.</span><span>prediction</span><span> </span><span>-</span><span> </span><span>state</span><span>.</span><span>target</span><span> </span><span>AS</span><span> </span><span>loss_gradient</span><span>,</span><span>
</span></span></span><span><span><span>                </span><span>loss_gradient</span><span> </span><span>*</span><span> </span><span>state</span><span>.</span><span>value</span><span> </span><span>AS</span><span> </span><span>gradient</span><span>,</span><span>
</span></span></span><span><span><span>                </span><span>state</span><span>.</span><span>weight</span><span> </span><span>-</span><span> </span><span>0</span><span>.</span><span>01</span><span> </span><span>*</span><span> </span><span>gradient</span><span> </span><span>AS</span><span> </span><span>weight</span><span>
</span></span></span><span><span><span>            </span><span>FROM</span><span> </span><span>stream</span><span>
</span></span></span><span><span><span>            </span><span>INNER</span><span> </span><span>JOIN</span><span> </span><span>state</span><span> </span><span>ON</span><span>
</span></span></span><span><span><span>                </span><span>state</span><span>.</span><span>step</span><span> </span><span>+</span><span> </span><span>1</span><span> </span><span>=</span><span> </span><span>stream</span><span>.</span><span>step</span><span> </span><span>AND</span><span>
</span></span></span><span><span><span>                </span><span>state</span><span>.</span><span>variable</span><span> </span><span>=</span><span> </span><span>stream</span><span>.</span><span>variable</span><span>
</span></span></span><span><span><span>        </span><span>)</span><span>
</span></span></span><span><span><span>    </span><span>)</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>SELECT</span><span> </span><span>*</span><span>
</span></span></span><span><span><span></span><span>FROM</span><span> </span><span>state</span><span>
</span></span></span><span><span><span></span><span>WHERE</span><span> </span><span>step</span><span> </span><span>=</span><span> </span><span>(</span><span>SELECT</span><span> </span><span>MAX</span><span>(</span><span>step</span><span>)</span><span> </span><span>FROM</span><span> </span><span>state</span><span>)</span><span>
</span></span></span><span><span><span></span><span>ORDER</span><span> </span><span>BY</span><span> </span><span>variable</span><span>
</span></span></span></code></pre></div><pre tabindex="0"><code>┌───────┬──────────┬──────────────────────┬───────────────────┬───────────────────┐
│ step  │ variable │        weight        │      target       │    prediction     │
│ int64 │ varchar  │        double        │      double       │      double       │
├───────┼──────────┼──────────────────────┼───────────────────┼───────────────────┤
│   505 │ Close    │   0.2511547716803354 │ 5.981568542028378 │ 5.938875441702928 │
│   505 │ High     │  0.24043897039853313 │ 5.981568542028378 │ 5.938875441702928 │
│   505 │ Low      │   0.2447191283620627 │ 5.981568542028378 │ 5.938875441702928 │
│   505 │ Open     │  0.23603830762609726 │ 5.981568542028378 │ 5.938875441702928 │
│   505 │ Volume   │ 0.057510279698874206 │ 5.981568542028378 │ 5.938875441702928 │
└───────┴──────────┴──────────────────────┴───────────────────┴───────────────────┘
</code></pre><p>It seems to be working! How can we check it is correct though? Well, we can fit an instance of scikit-learn’s <code>SGDRegressor</code>. The weights should correspond exactly to what we obtained in SQL, as long we provide the correct parameters. This is to align with the simplifying assumptions that were made in the SQL implementation.</p><div><pre tabindex="0"><code data-lang="py"><span><span><span>from</span> <span>pprint</span> <span>import</span> <span>pprint</span>
</span></span><span><span><span>from</span> <span>sklearn</span> <span>import</span> <span>linear_model</span>
</span></span><span><span>
</span></span><span><span><span>model</span> <span>=</span> <span>linear_model</span><span>.</span><span>SGDRegressor</span><span>(</span>
</span></span><span><span>    <span>loss</span><span>=</span><span>&#39;squared_error&#39;</span><span>,</span>
</span></span><span><span>    <span>penalty</span><span>=</span><span>None</span><span>,</span>
</span></span><span><span>    <span>fit_intercept</span><span>=</span><span>False</span><span>,</span>
</span></span><span><span>    <span>learning_rate</span><span>=</span><span>&#39;constant&#39;</span><span>,</span>
</span></span><span><span>    <span>eta0</span><span>=</span><span>0.01</span><span>,</span>
</span></span><span><span>    <span>max_iter</span><span>=</span><span>1</span><span>,</span>
</span></span><span><span>    <span>shuffle</span><span>=</span><span>False</span>
</span></span><span><span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>X</span> <span>=</span> <span>figures</span><span>[:</span><span>-</span><span>1</span><span>]</span><span>.</span><span>copy</span><span>()</span>
</span></span><span><span><span>y</span> <span>=</span> <span>X</span><span>.</span><span>pop</span><span>(</span><span>&#39;Adj Close&#39;</span><span>)</span>
</span></span><span><span><span>model</span> <span>=</span> <span>model</span><span>.</span><span>fit</span><span>(</span><span>X</span><span>,</span> <span>y</span><span>)</span>
</span></span><span><span><span>pprint</span><span>(</span><span>dict</span><span>(</span><span>zip</span><span>(</span><span>X</span><span>.</span><span>columns</span><span>,</span> <span>model</span><span>.</span><span>coef_</span><span>)))</span>
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="py"><span><span><span>{</span><span>&#39;Close&#39;</span><span>:</span> <span>0.2511547716803354</span><span>,</span>
</span></span><span><span> <span>&#39;High&#39;</span><span>:</span> <span>0.2404389703985331</span><span>,</span>
</span></span><span><span> <span>&#39;Low&#39;</span><span>:</span> <span>0.2447191283620624</span><span>,</span>
</span></span><span><span> <span>&#39;Open&#39;</span><span>:</span> <span>0.23603830762609757</span><span>,</span>
</span></span><span><span> <span>&#39;Volume&#39;</span><span>:</span> <span>0.05751027969887417</span><span>}</span>
</span></span></code></pre></div><p>Spot on! To be even more certain this is correct, we can compare with <a href="https://riverml.xyz">River</a>’s linear regression implementation, which uses online gradient descent under the hood.</p><div><pre tabindex="0"><code data-lang="py"><span><span><span>from</span> <span>river</span> <span>import</span> <span>linear_model</span>
</span></span><span><span><span>from</span> <span>river</span> <span>import</span> <span>optim</span>
</span></span><span><span>
</span></span><span><span><span>class</span> <span>CustomSquaredLoss</span><span>:</span>
</span></span><span><span>
</span></span><span><span>    <span>def</span> <span>gradient</span><span>(</span><span>self</span><span>,</span> <span>y_true</span><span>,</span> <span>y_pred</span><span>):</span>
</span></span><span><span>        <span>return</span> <span>y_pred</span> <span>-</span> <span>y_true</span>
</span></span><span><span>
</span></span><span><span><span>model</span> <span>=</span> <span>linear_model</span><span>.</span><span>LinearRegression</span><span>(</span>
</span></span><span><span>    <span>optimizer</span><span>=</span><span>optim</span><span>.</span><span>SGD</span><span>(</span><span>lr</span><span>=</span><span>0.01</span><span>),</span>
</span></span><span><span>    <span>loss</span><span>=</span><span>CustomSquaredLoss</span><span>(),</span>
</span></span><span><span>    <span>intercept_lr</span><span>=</span><span>0.0</span><span>,</span>
</span></span><span><span>    <span>l2</span><span>=</span><span>0.0</span>
</span></span><span><span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>for</span> <span>i</span><span>,</span> <span>x</span> <span>in</span> <span>enumerate</span><span>(</span><span>figures</span><span>[:</span><span>-</span><span>1</span><span>]</span><span>.</span><span>to_dict</span><span>(</span><span>orient</span><span>=</span><span>&#39;records&#39;</span><span>)):</span>
</span></span><span><span>    <span>y</span> <span>=</span> <span>x</span><span>.</span><span>pop</span><span>(</span><span>&#39;Adj Close&#39;</span><span>)</span>
</span></span><span><span>    <span>model</span><span>.</span><span>learn_one</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>pprint</span><span>(</span><span>model</span><span>.</span><span>weights</span><span>)</span>
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="py"><span><span><span>{</span><span>&#39;Close&#39;</span><span>:</span> <span>0.2511547716803356</span><span>,</span>
</span></span><span><span> <span>&#39;High&#39;</span><span>:</span> <span>0.2404389703985331</span><span>,</span>
</span></span><span><span> <span>&#39;Low&#39;</span><span>:</span> <span>0.24471912836206253</span><span>,</span>
</span></span><span><span> <span>&#39;Open&#39;</span><span>:</span> <span>0.2360383076260972</span><span>,</span>
</span></span><span><span> <span>&#39;Volume&#39;</span><span>:</span> <span>0.057510279698874255</span><span>}</span>
</span></span></code></pre></div><p>✅ 🎯 💯 🎉</p><h2 id="conclusion">Conclusion</h2><p>A machine learning algorithm which can be trained using SQL opens a world of possibilities. The model and the data live in the same space. This is as simple as it gets in terms of architecture. Basically, you only need a database which runs SQL.</p><p>Of course, the implementation we made is quite basic. Moreover, models using online gradient descent aren’t necessarily the strongest ones. However, one could argue that what matters most in a model are the features you feed it with. As such, online gradient descent done in the database can be a great baseline from which to start with.</p><p>The key advantage of online machine learning is that you don’t need to revisit past data points to update a model. However, all the queries we’ve written are stateless, and will run from the top when they are refreshed. This sort of defeats the purpose of doing things online. Thankfully, stream processing engines are popping up, and they usually provide an SQL interface. For instance, Materialize is working on <a href="https://materialize.com/blog/recursion-in-materialize/">providing</a> <code>WITH RECURSIVE</code> semantics. Doing online gradient descent on top of Materialize sounds very powerful to me.</p></div></div>
  </body>
</html>
