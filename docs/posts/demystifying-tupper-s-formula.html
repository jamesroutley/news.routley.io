<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://eli.thegreenplace.net/2023/demystifying-tuppers-formula/">Original</a>
    <h1>Demystifying Tupper&#39;s Formula</h1>
    
    <div id="readability-page-1" class="page"><div>
                
                <p>A <a href="https://makeanddo4d.com/">book I was recently reading</a> mentioned a
mathematical curiosity I haven&#39;t seen before - <a href="https://en.wikipedia.org/wiki/Tupper%27s_self-referential_formula">Tupper&#39;s self-referential
formula</a>.
There are some resources about it online, but this post is <em>my</em> attempt to
explain how it works - along with an interactive implementation you can try
in the browser.</p>
<div id="tupper-s-formula">
<h2>Tupper&#39;s formula</h2>
<p>Here is the formula:</p>
<p>We want to plot this formula, but how?</p>
<p>For this purpose, it&#39;s more useful to think of Tupper&#39;s formula not as a
function but as a <em>relation</em>, in the mathematical sense. In Tupper&#39;s paper
this is a relation on <img alt="\mathbb{R}" src="https://eli.thegreenplace.net/images/math/0ed839b111fe0e3ca2b2f618b940893eaea88a57.png"/>, meaning that it&#39;s a set of pairs
in  that satisfy the inequality.</p>
<p>For our task we&#39;ll use discrete indices for <em>x</em> and <em>y</em>, so the relation is
on . We&#39;ll plot the relation by using a dark pixel (or
square) for a <tt>x,y</tt> coordinate where the inequality holds and a light pixel
for a coordinate where it doesn&#39;t hold.</p>
<p>The &#34;mind-blowing&#34; fact about Tupper&#39;s formula is that when plotted for
a certain range of <em>x</em> and <em>y</em>, it produces this:</p>
<p><img alt="Tupper&#39;s formula own plot" src="https://eli.thegreenplace.net/images/2023/tupper-plot.png"/></p><p>Note that while <em>x</em> runs in the inclusive range of 0-105 on the plot, <em>y</em> starts
at a mysterious <em>K</em> and ends at <em>K+16</em>. For the plot above, <em>K</em> needs to be:</p>
<div><pre><span></span>4858450636189713423582095962494202044581400587983244549483
0930850619347047088099284506447698655243648499972470249151
1911041160573917740785691975432657185544205721044573588368
1829823754139634338225199452191651284348332905131193199953
5024137587652392648746133949068701305622958132194811136853
3953556529085002387509285689269455597428154638651073004910
6723058933586052544096664351265349363643957125565695936815
1843348576052669401612512669514215505395545191537854575257
5659074054015792900176596796548006442782913148854825991472
1248506352686630476300
</pre></div>
<p>The amazement subsides slightly when we discover that for a different <em>K</em> <a href="#footnote-1" id="footnote-reference-1">[1]</a>,
we get a different plot:</p>
<p><img alt="Tupper&#39;s formula producing a pacman plot" src="https://eli.thegreenplace.net/images/2023/tupper-pacman.png"/></p><p>And, in fact, this formula can produce any 2D grid of 106x17 pixels, given the
right coordinates. Since the formula itself is so simple, it is quite apparent
that the value of <em>K</em> is the key here; these are huge numbers with hundreds of
digits, so clearly they encode the image information somehow. Read on to see
how this actually works.</p>
</div>
<div id="a-javascript-demo">
<h2>A JavaScript demo</h2>
<p>I&#39;ve implemented a simple online demo of plotting the Tupper formula - available
at <a href="https://eliben.github.io/tupperformula/">https://eliben.github.io/tupperformula/</a> (with <a href="https://github.com/eliben/tupperformula">source code on GitHub</a>). It was used to produce the images
shown above. The code is fairly straightforward, so I&#39;ll just focus on the
interesting part.</p>
<p>The core of the code is a 2D grid that&#39;s plotted for <em>x</em> running from 0 to
105 and <em>y</em> from <em>K</em> to <em>K+16</em> (both ranges inclusive). The grid is populated
every time the number changes:</p>
<div><pre><span></span><span>const</span><span> </span><span>GridWidth</span><span> </span><span>=</span><span> </span><span>106</span><span>;</span><span></span>
<span>const</span><span> </span><span>GridHeight</span><span> </span><span>=</span><span> </span><span>17</span><span>;</span><span></span>
<span>let</span><span> </span><span>K</span><span> </span><span>=</span><span> </span><span>BigInt</span><span>(</span><span>Knum</span><span>.</span><span>value</span><span>);</span><span></span>

<span>for</span><span> </span><span>(</span><span>let</span><span> </span><span>x</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span><span> </span><span>x</span><span> </span><span>&lt;</span><span> </span><span>GridWidth</span><span>;</span><span> </span><span>x</span><span>++</span><span>)</span><span> </span><span>{</span><span></span>
<span>    </span><span>for</span><span> </span><span>(</span><span>let</span><span> </span><span>y</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span><span> </span><span>y</span><span> </span><span>&lt;</span><span> </span><span>GridHeight</span><span>;</span><span> </span><span>y</span><span>++</span><span>)</span><span> </span><span>{</span><span></span>
<span>        </span><span>Grid</span><span>.</span><span>setCell</span><span>(</span><span>x</span><span>,</span><span> </span><span>y</span><span>,</span><span> </span><span>tupperFormula</span><span>(</span><span>BigInt</span><span>(</span><span>x</span><span>),</span><span> </span><span>K</span><span> </span><span>+</span><span> </span><span>BigInt</span><span>(</span><span>y</span><span>)));</span><span></span>
<span>    </span><span>}</span><span></span>
<span>}</span><span></span>
</pre></div>
<p>Note the use of JavaScript&#39;s <tt>BigInt</tt> types here - very handy when dealing
with such huge numbers. Here is <tt>tupperFormula</tt>:</p>
<div><pre><span></span><span>function</span><span> </span><span>tupperFormula</span><span>(</span><span>x</span><span>,</span><span> </span><span>y</span><span>)</span><span> </span><span>{</span><span></span>
<span>    </span><span>let</span><span> </span><span>d</span><span> </span><span>=</span><span> </span><span>(</span><span>y</span><span> </span><span>/</span><span> </span><span>17n</span><span>)</span><span> </span><span>&gt;&gt;</span><span> </span><span>(</span><span>17n</span><span> </span><span>*</span><span> </span><span>x</span><span> </span><span>+</span><span> </span><span>y</span><span> </span><span>%</span><span> </span><span>17n</span><span>);</span><span></span>
<span>    </span><span>return</span><span> </span><span>d</span><span> </span><span>%</span><span> </span><span>2n</span><span> </span><span>==</span><span> </span><span>1n</span><span>;</span><span></span>
<span>}</span><span></span>
</pre></div>
<p>It looks quite different from the mathematical formula at the top of this post;
why? Because - as mentioned before - while Tupper&#39;s original formula works on
real numbers, our program only needs the discrete integer range of
<tt>x in [0, 105]</tt> and <tt>y in [K, K+16]</tt>. When we deal with discrete numbers,
the formula can be simplified greatly.</p>
<p>Let&#39;s start with the original formula and simplify it step by step:</p>
<p>First of all, since <em>x</em> and <em>y</em> are natural numbers, the floor operations on
them don&#39;t do anything, so we can drop them (including on the division by
17, if we just assume integer division that rounds down by default):</p>
<p>Next, since the result of the  operation for a natural <em>N</em> is
either 0 or 1, the comparison to half is just a fancy way of saying &#34;equals 1&#34;;
we can replace the inequality by:</p>
<p>Note the negative power of 2; multiplying by it is the same as dividing by its
positive counterpart. Another way to express division by  for natural
numbers is a bit shift right by <em>p</em> bits. So we get the code of the
<tt>tupperFormula</tt> function shown above:</p>
<div><pre><span></span><span>let</span><span> </span><span>d</span><span> </span><span>=</span><span> </span><span>(</span><span>y</span><span> </span><span>/</span><span> </span><span>17n</span><span>)</span><span> </span><span>&gt;&gt;</span><span> </span><span>(</span><span>17n</span><span> </span><span>*</span><span> </span><span>x</span><span> </span><span>+</span><span> </span><span>y</span><span> </span><span>%</span><span> </span><span>17n</span><span>);</span><span></span>
<span>return</span><span> </span><span>d</span><span> </span><span>%</span><span> </span><span>2n</span><span> </span><span>==</span><span> </span><span>1n</span><span>;</span><span></span>
</pre></div>
</div>
<div id="how-the-tupper-formula-works">
<h2>How the Tupper formula works</h2>
<p>The distillation of the Tupper to JS code already peels off a few layers of
mystery. Let&#39;s now remove the rest of the curtain on its inner workings.</p>
<p>I&#39;ll start by explaining how to take an image we want the formula
to produce and encode it into <em>K</em>. Here are the first three columns of the
Tupper formula plot:</p>
<p><img alt="Closeup of tupper plot with encoding of pixels" src="https://eli.thegreenplace.net/images/2023/tupper-closeup.png"/></p><p>Each pixel in the plot is converted to a bit (0 for light, 1 for dark). We
start at the bottom left corner (<em>x=0</em> and <em>y=K</em>), which is the LSB
(least-significant bit) and move up through the first column; when we reach the
top (<em>x=0</em> and <em>y=K+16</em>), we continue from the bottom of the next column
(<em>x=1</em> and <em>y=K</em>). In the example above, the first bits (from lowest to highest)
of the number are:</p>
<div><pre><span></span>00110010101000100 00101010101111100 ...
</pre></div>
<p>Once we&#39;re done with the whole number (106x17 = 1802 bits), we convert it to
decimal - let&#39;s call this number <em>IMG</em>, and multiply by 17. The result is <em>K</em>.</p>
<p>Now back to <tt>tupperFormula</tt>, looking at how it decodes the image back from
<em>x</em> and <em>y</em> (recall that <em>y</em> runs from <em>K</em> to <em>K+16</em>). Let&#39;s work through
the first coordinate in detail:</p>
<p>For <em>x=0</em> and <em>y=K</em>, in <tt>tupperFormula</tt> we get:</p>
<div><pre><span></span>d = (y/17) &gt;&gt; (17x + y%17)
...
substitute x=0, y=K (and recall that K = IMG * 17)
...
d = IMG &gt;&gt; 0
</pre></div>
<p>In other words, <em>d</em> is the lowest bit of <em>IMG</em> - the lowest bit of our image!
We can continue for <em>x=0</em> and <em>y=K+1</em>:</p>
<div><pre><span></span>d = (y/17) &gt;&gt; (17x + y%17)
...
substitute x=0, y=K+1 (and recall that K = IMG * 17)
...
d = IMG &gt;&gt; 1
</pre></div>
<p>Here <em>d</em> is the second lowest bit of <em>IMG</em>. The pattern should be clear by now.</p>
<div><pre><span></span>d = (y/17) &gt;&gt; (17x + y%17)
...
x=0  y=K+2:  IMG &gt;&gt; (0 + 2)
x=0  y=K+3:  IMG &gt;&gt; (0 + 3)
...
x=0  y=K+16  IMG &gt;&gt; (0 + 16)
x=1  y=K:    IMG &gt;&gt; (17 + 0)
x=1  y=K+1:  IMG &gt;&gt; (17 + 1)
x=1  y=K+2:  IMG &gt;&gt; (17 + 2)
</pre></div>
<p>The formula simply calculates the correct bit of <em>IMG</em> given <em>x</em> and <em>y</em>, using
a modular arithmetic trick to &#34;fold&#34; the 2D <em>x</em> and <em>y</em> into a 1D
sequence (this is just customary <a href="https://eli.thegreenplace.net/2015/memory-layout-of-multi-dimensional-arrays">column-major layout</a>).</p>
<p>This is why the formula can plot any 106x17 grid, given the right <em>K</em>. In the
formula, 17 is not some piece of magic - it&#39;s just the height of the grid. As an
exercise, you can modify the formula and code to plot larger or smaller grids.</p>
<p>As a bonus, the JavaScript demo can also encode a grid back to its
representative <em>K</em>; here&#39;s the code for it:</p>
<div><pre><span></span><span>// Calculate K value from the grid.</span><span></span>
<span>function</span><span> </span><span>encodeGridToK</span><span>()</span><span> </span><span>{</span><span></span>
<span>    </span><span>let</span><span> </span><span>kval</span><span> </span><span>=</span><span> </span><span>BigInt</span><span>(</span><span>0</span><span>);</span><span></span>

<span>    </span><span>// Build up K from MSB to LSB, scanning from the top-right corner down and</span><span></span>
<span>    </span><span>// then moving left by column.</span><span></span>
<span>    </span><span>for</span><span> </span><span>(</span><span>let</span><span> </span><span>x</span><span> </span><span>=</span><span> </span><span>GridWidth</span><span> </span><span>-</span><span> </span><span>1</span><span>;</span><span> </span><span>x</span><span> </span><span>&gt;=</span><span> </span><span>0</span><span>;</span><span> </span><span>x</span><span>--</span><span>)</span><span> </span><span>{</span><span></span>
<span>        </span><span>for</span><span> </span><span>(</span><span>let</span><span> </span><span>y</span><span> </span><span>=</span><span> </span><span>GridHeight</span><span> </span><span>-</span><span> </span><span>1</span><span>;</span><span> </span><span>y</span><span> </span><span>&gt;=</span><span> </span><span>0</span><span>;</span><span> </span><span>y</span><span>--</span><span>)</span><span> </span><span>{</span><span></span>
<span>            </span><span>kval</span><span> </span><span>=</span><span> </span><span>2n</span><span> </span><span>*</span><span> </span><span>kval</span><span> </span><span>+</span><span> </span><span>BigInt</span><span>(</span><span>Grid</span><span>.</span><span>getCell</span><span>(</span><span>x</span><span>,</span><span> </span><span>y</span><span>));</span><span></span>
<span>        </span><span>}</span><span></span>
<span>    </span><span>}</span><span></span>
<span>    </span><span>return</span><span> </span><span>kval</span><span> </span><span>*</span><span> </span><span>17n</span><span>;</span><span></span>
<span>}</span><span></span>
</pre></div>
<p>It constructs <em>K</em> starting with the MSB, but otherwise the code is
straightforward to follow.</p>
</div>
<div id="background">
<h2>Background</h2>
<p>The formula was first describe by Jeff Tupper in a 2001 paper titled
&#34;Reliable Two-Dimensional Graphing Methods for Mathematical Formulae with Two
Free Variables&#34;. The paper itself focuses on methods of precisely graphing
relations and presents several algorithms to do so. This formula is described
in passing in section 12, and presented as follows:</p>
<p><img alt="Screenshot from Tupper&#39;s paper describing the formula" src="https://eli.thegreenplace.net/images/2023/tupper-paper-crop1.png"/></p><p>And Figure 13 is:</p>
<p><img alt="Screenshot from Tupper&#39;s paper showing the formula itself" src="https://eli.thegreenplace.net/images/2023/tupper-paper-crop2.png"/></p><p>Interestingly, the <em>K</em> provided by Tupper&#39;s paper renders the formula flipped
on both the <em>x</em> and <em>y</em> axes using the standard grid used in this post <a href="#footnote-2" id="footnote-reference-2">[2]</a>.
This is why my JavaScript demo has flip toggles that let you flip the axes of any
plot.</p>
<hr/>

<div><pre><span></span>1445202489708975828479425373371945674812777822151507024797
1881396854908873568298734888825132090576643817888323197692
3440016667764749242125128995265907053708020473915320841631
7920255490054180047686572016997304663833949016013743197155
2099618114524978194501906835950051065780432564080119786755
6863142280259694206254096081665642417367403946384170774537
4273196064438999230103793989386750257869294552344763192918
6095761834543224800492172803334941981620674985447203819393
9738513848960476759782673313437697051994580681869819330446
336774047268864
</pre></div>

</div>

            </div></div>
  </body>
</html>
