<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.golioth.io/the-miserable-state-of-modems-and-mobile-network-operators/">Original</a>
    <h1>The Miserable State of Modems and Mobile Network Operators</h1>
    
    <div id="readability-page-1" class="page"><div data-td-block-uid="tdi_74">

<div><p><span data-token-index="0">Golioth recently received a number of customer reports regarding connectivity issues on a specific vendor’s cellular chipset series.</span> We immediately contacted the vendor and began working towards reproducing and isolating the behavior. What ensued was a lengthy investigation that ultimately revealed some unexpected and highly undesirable behavior. This is a story of the complexities of cellular connectivity, the perils of closed ecosystems, and how to debug what you cannot see.<!-- notionvc: 0cbb8223-3cd5-4c29-a5ce-2b0badc516e7 --></p>
<p><em>We previously <a tabindex="0" href="https://forum.golioth.io/t/addressing-dns-related-connectivity-issues-on-the-nrf9160/1238" rel="noopener noreferrer" data-token-index="1"><span>posted on the Golioth forum</span></a> with a description of this issue and potential workarounds.</em><!-- notionvc: cf32956d-109a-49f5-8579-04385e24910f --></p>
<h2><a href="#to-live-is-to-be-connected" aria-hidden="true" id="to-live-is-to-be-connected"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>To Live is to Be Connected</h2>
<p>Before going into detail about the sad state of affairs that is the telecommunications industry, it is important to provide some context around why connectivity is so important for large fleets of devices. Sure, it can be frustrating when your phone or laptop is unable to access the internet. Whether it is because your internet service provider (ISP) is having an outage, there is a bug in your device’s network stack, or any other issue, you may not be able to complete essential tasks. However, you can call your ISP, go to a coffee shop and use their Wi-Fi to download a software update, or execute the tried and true “turn it off then turn it back on” strategy. While the lack of connectivity is not convenient for personal devices, it usually is temporary and does not render the device permanently useless.</p>
<p>The same cannot be said for large fleets of devices deployed in hard-to-access locations. Connection failures that require physical intervention can be fatal for a device, as it might be literally inaccessible, or the cost of accessing it may be so exorbitant that it might as well be. Because of this, we, and our customers, go to great lengths to ensure that devices that fail to connect are able to recover gracefully.<!-- notionvc: eb225e09-23f7-49b9-81fc-9fff0d05b5e9 --></p>
<p>For example, Golioth’s Over-the-Air (OTA) firmware update implementation integrates with recommended frameworks for each supported platform, such as <a href="https://docs.mcuboot.com/design.html">mcuboot</a> and <a href="https://espressif-docs.readthedocs-hosted.com/projects/esp-idf/en/stable/api-reference/system/ota.html">esp-idf OTA</a>, to ensure that a deployed firmware update is able to be rolled back in the case of failure to connect. When a firmware update is initiated via the Golioth cloud platform, devices in the field that are currently connected are notified that a new image is available, and those that are not are notified on next connection. The device will then download the new image into flash in a secondary or “candidate” partition. If download and image verification is successful, the device will subsequently mark the new image as the boot image in a “test” mode, then reboot into it. If there is a crash after reboot or the device is unable to connect for a configurable time window, the device will swap the previous image back, reboot, and continue operation as before.</p>
<h2><a href="#signs-of-trouble" aria-hidden="true" id="signs-of-trouble"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Signs of Trouble</h2>

<p>Initial reports regarding connectivity issues with the nRF9160 centered around devices that had recently performed OTA firmware updates. It manifested as some devices in a cohort targeted by a deployment successfully downloading the new firmware image, starting an update, then eventually rolling back to a previous version. While this would typically indicate an issue in the new firmware image, it appeared to only be impacting a subset of devices in the cohort. Furthermore, a number of the devices eventually successfully updated to the new image after a handful of retries.</p>
<p>There are three broad categories of issues one can encounter when working with devices on a cellular connection:</p>
<ul>
<li>Firmware</li>
<li>Connectivity</li>
<li>Cloud</li>
</ul>
<p>We like firmware and cloud issues because they are domains that we and our customers can, for the most part, control. If something is going wrong on either side of a connection we are typically able to track down and resolve the issue using observability and debugging tooling. Given the correlation of the nRF9160 connectivity issues with recent firmware updates, our immediate inclination was that customers had updated to the latest version of the Golioth Firmware SDK (<code>v0.17.0</code>) and there had been a regression either in our SDK or one of the platform versions it pins (i.e. nRF Connect SDK, Zephyr). However, reports indicated that multiple versions of both our SDK and the nRF Connect SDK were exhibiting the issue.</p>
<p>We started out by attempting to reproduce the behavior using <code>v0.17.0</code>. The nRF9160 development kit is one of our <a href="https://docs.golioth.io/firmware/hardware/catalog/boards/continuously-verified/nrf9160dk_nrf9160">continuously verified boards</a>, meaning that we are constantly running continuous integration tests on it via our <a href="https://blog.golioth.io/how-we-use-allure-report-to-understand-continuous-integration-tests/">hardware-in-the-loop (HIL) infrastructure</a>. In fact, the history of firmware update test statuses for the nRF9160DK are available on our <a href="https://golioth.github.io/allure-reports/main">public dashboard</a>. However, after running a large number of firmware updates across a variety of geographic locations, we observed an issue that exhibited in a manner similar to the received reports. After downloading a new firmware image, devices would report an inability to resolve the <a href="http://coap.golioth.io"><code>coap.golioth.io</code></a> domain name to an address, then subsequently rollback to the previous image.</p>
<pre data-enlighter-language="generic">[00:01:40.747,802] &lt;err&gt; golioth_coap_client_zephyr: Fail to get address (coap.golioth.io 5684) -2
[00:01:40.747,802] &lt;err&gt; golioth_coap_client_zephyr: Failed to connect: -11
[00:01:40.747,802] &lt;wrn&gt; golioth_coap_client_zephyr: Failed to connect: -11
[00:01:45.756,652] &lt;err&gt; golioth_coap_client_zephyr: Fail to get address (coap.golioth.io 5684) -2
[00:01:45.756,683] &lt;err&gt; golioth_coap_client_zephyr: Failed to connect: -11
[00:01:45.756,683] &lt;wrn&gt; golioth_coap_client_zephyr: Failed to connect: -11
[00:01:50.765,533] &lt;err&gt; golioth_coap_client_zephyr: Fail to get address (coap.golioth.io 5684) -2
[00:01:50.765,563] &lt;err&gt; golioth_coap_client_zephyr: Failed to connect: -11
[00:01:50.765,563] &lt;wrn&gt; golioth_coap_client_zephyr: Failed to connect: -11</pre>
<p>Unfortunately, the behavior was intermittent, and upon testing older versions of our SDK and the nRF Connect SDK, we were still able to observe the behavior seemingly at random after a reboot, whether updating to a new firmware image or not. <span data-token-index="1">Even more confounding, when using the Zephyr network shell to manually issue a DNS request, the resolution was successful…</span><span data-token-index="2">on the same device</span><span data-token-index="3">… </span><span data-token-index="4">while it was reporting DNS failures</span><span data-token-index="5">.</span><!-- notionvc: a58243b0-8853-4e5f-bc8d-d44cd5fa4547 --></p>
<pre data-enlighter-language="generic">[01:42:28.365,356] &lt;err&gt; golioth_coap_client_zephyr: Fail to get address (coap.golioth.io 5684) -2
[01:42:28.365,386] &lt;err&gt; golioth_coap_client_zephyr: Failed to connect: -11
[01:42:28.365,417] &lt;wrn&gt; golioth_coap_client_zephyr: Failed to connect: -11
uart:~$ net dns coap.golioth.io
Query for &#39;coap.golioth.io&#39; sent.
dns: 34.135.90.112
dns: All results received
[01:42:33.365,875] &lt;err&gt; golioth_coap_client_zephyr: Fail to get address (coap.golioth.io 5684) -2
[01:42:33.365,905] &lt;err&gt; golioth_coap_client_zephyr: Failed to connect: -11
[01:42:33.365,936] &lt;wrn&gt; golioth_coap_client_zephyr: Failed to connect: -11</pre>
<p>When I said there were three broad categories of issues with cellular devices, I probably should have split the first, firmware, into two separate domains. We like solving problems in the application domain, but a large portion of the firmware running on a cellular device resides in the <em>modem</em>.</p>
<h2><a href="#secret-handshakes-and-back-alleys" aria-hidden="true" id="secret-handshakes-and-back-alleys"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Secret Handshakes and Back Alleys</h2>
<p>In some cases, there is some limited access to firmware on a modem. For example, we <a href="https://blog.golioth.io/golioth-can-now-run-entirely-on-qualcomm-modems/">recently announced</a> support for running Golioth on modem processors. However, even when limited access is available, it typically depends upon encrypted binary blobs, new versions of which are distributed at the whim of the silicon vendor. The nRF9160 modem falls into the category of lesser access, though we are fortunate enough to be blessed with <a href="https://nsscprodmedia.blob.core.windows.net/prod/software-and-other-downloads/dev-kits/nrf9160-dk/release_notes_modemfirmware/mfw_nrf9160_1.3.7_release_notes.txt">moderately detailed release notes</a> when a new firmware version is available.</p>
<p>But before you go egging the Nordic Semiconductor headquarters, consider the fact that they are one of the most open vendors in the industry. They invest heavily in the Zephyr RTOS ecosystem, open source the vast majority of their SDK, provide better developer tooling than their competitors, and are generally fairly responsive on their public forums. Let this blog post not be a slandering of their fine handiwork.</p>
<p>No, Nordic is merely a participant in a vast ecosystem that convenes via the 3rd Generation Partnership Project, or 3GPP as it’s known among friends. 3GPP was formed in 1998 out of the joining of seven different standards organizations — queue the <a href="https://xkcd.com/927/">xkcd meme</a>. 3GPP develops the standards that underpin all wireless communication in the world today. These technical specifications (TS) are aggregated and included in “releases”, which are made freely available. Unfortunately, much of the technology that is <em>required to implement the standards</em> is patented. The patents are referred to as <a href="https://en.wikipedia.org/wiki/Essential_patent">Standards Essential Patents</a>, or SEPs. Because of this arrangement, a vendor like Nordic probably can’t open source their modem firmware even if they wanted to.</p>
<p>Nevertheless, if some brave soul was willing to painstakingly navigate the deluge of 3GPP specifications, they would be able to get an idea of what a modem and the cellular networks it connects to <em>should</em> be doing by reading through the hundreds of documents. In the case of the nRF9160, the primary specifications of interest would be part of <a href="https://en.wikipedia.org/wiki/LTE_Advanced#LTE_Advanced_Pro">3GPP Release 13</a>, which introduced <a href="https://en.wikipedia.org/wiki/LTE-M">LTE Cat-M1</a> (eMTC) and <a href="https://en.wikipedia.org/wiki/Narrowband_IoT">NB-IoT</a>.</p>
<h2><a href="#figuring-out-what-is-going-on" aria-hidden="true" id="figuring-out-what-is-going-on"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Figuring Out What Is Going On</h2>
<p>Prior to my divergence into the morass of intellectual property that provides the foundation of wireless communication, we had just observed that DNS requests were successful when issued via the Zephyr network shell. That felt like a good place to probe deeper, given that we clearly had an internet connection and were simply unable to use it.</p>
<p>The firmware used for testing was the Zephyr <code>fw_update</code> <a href="https://github.com/golioth/golioth-firmware-sdk/tree/main/examples/zephyr/fw_update">example</a> in the Golioth Firmware SDK. The Golioth Zephyr CoAP client implementation <a href="https://github.com/golioth/golioth-firmware-sdk/blob/e97dae07c5af785497089baebb4957c22478cbf5/src/coap_client_zephyr.c#L975">uses</a> <code>zsock_getaddrinfo</code> to resolve the server domain name (<code>coap.golioth.io</code>) to an IP address.</p>

<pre data-enlighter-language="c">ret = zsock_getaddrinfo(host, port, &amp;hints, &amp;addrs);
if (ret &lt; 0)
{
    LOG_ERR(&#34;Fail to get address (%s %s) %d&#34;, host, port, ret);
    return -EAGAIN;
}</pre>
<p>We could see the error log emitted on failure in the output of our reproduction. When using nRF91 series devices, <a href="https://docs.nordicsemi.com/bundle/ncs-latest/page/nrf/libraries/modem/nrf_modem_lib/nrf_modem_lib_socket_offloading.html">socket offloading</a> must be enabled for LTE connectivity. This <a href="https://github.com/nrfconnect/sdk-nrf/blob/859caae972f33e147649af67aea71e00c35006a2/lib/nrf_modem_lib/nrf9x_sockets.c#L1172">results</a> in the creation of an offloaded network interface and binds it to the <code>nrf9x_socket</code> device.<!-- notionvc: d489ef57-4aa7-488a-b54d-f41fbc970dfd --></p>
<pre data-enlighter-language="c">static struct offloaded_if_api nrf9x_iface_offload_api = {
    .iface_api.init = nrf9x_iface_api_init,
    .enable = nrf9x_iface_enable,
};

/* Actual MTU for the nRF9x LTE link is handled by `lte_net_if.c` */
NET_DEVICE_OFFLOAD_INIT(nrf9x_socket, &#34;nrf9x_socket&#34;,
            nrf9x_socket_offload_init,
            NULL,
            &amp;nrf9x_iface_data, NULL,
            0, &amp;nrf9x_iface_offload_api, 1280);</pre>
<p>The initialization function then calls <code>socket_offload_dns_register</code>, to setup the corresponding offload implementations for <code>getaddrinfo</code> and <code>freeaddrinfo</code>.</p>

<pre data-enlighter-language="c">static const struct socket_dns_offload nrf9x_socket_dns_offload_ops = {
    .getaddrinfo = nrf9x_socket_offload_getaddrinfo,
    .freeaddrinfo = nrf9x_socket_offload_freeaddrinfo,
};

static struct nrf9x_iface_data {
    struct net_if *iface;
} nrf9x_iface_data;

static void nrf9x_iface_api_init(struct net_if *iface)
{
    nrf9x_iface_data.iface = iface;

    iface-&gt;if_dev-&gt;socket_offload = nrf9x_socket_create;

    socket_offload_dns_register(&amp;nrf9x_socket_dns_offload_ops);

    if (!IS_ENABLED(CONFIG_NRF_MODEM_LIB_NET_IF_AUTO_START)) {
        net_if_flag_set(iface, NET_IF_NO_AUTO_START);
    }
}</pre>
<p>The former <a href="https://github.com/nrfconnect/sdk-nrf/blob/859caae972f33e147649af67aea71e00c35006a2/lib/nrf_modem_lib/nrf9x_sockets.c#L774">ultimately calls</a> <code>nrf_getaddrinfo</code>, which is provided by the binary <a href="https://github.com/nrfconnect/sdk-nrfxlib/tree/85954588939b0d6c46a84ae39ef7926cc2fe9810/nrf_modem">modem library</a> distributed by Nordic. This is <em>not</em> the modem firmware, but rather the interface from the application processor to the modem firmware. It’s a shame that they don’t provide the source, but disassembling the binary mostly just shows performing some sort of inter-processor RPC with the modem.</p>

<pre data-enlighter-language="generic">00000000 &lt;nrf_getaddrinfo&gt;:
   0:	e92d 4ff0 	stmdb	sp!, {r4, r5, r6, r7, r8, r9, sl, fp, lr}
   4:	469a      	mov	sl, r3
   6:	2300      	movs	r3, #0
   8:	b087      	sub	sp, #28
   a:	4681      	mov	r9, r0
   c:	460e      	mov	r6, r1
   e:	4614      	mov	r4, r2
  10:	e9cd 3303 	strd	r3, r3, [sp, #12]
  14:	9305      	str	r3, [sp, #20]
  16:	f7ff fffe 	bl	0 &lt;nrf_modem_state_is_initialized&gt;
...
  b4:	f7ff fffe 	bl	0 &lt;rpc_client_msg_alloc&gt;
  b8:	4606      	mov	r6, r0
  ba:	2800      	cmp	r0, #0
  bc:	d159      	bne.n	172 &lt;nrf_getaddrinfo+0x172&gt;
  be:	4b76      	ldr	r3, [pc, #472]	; (298 &lt;nrf_getaddrinfo+0x298&gt;)
  c0:	f06f 0409 	mvn.w	r4, #9
  c4:	6818      	ldr	r0, [r3, #0]
  c6:	f7ff fffe 	bl	0 &lt;nrf_modem_os_sem_give&gt;
...</pre>
<p>This is ultimately where the error on the application processor originates, but the issue is only being propagated from the modem. At this point we turned our attention to the <code>net dns</code> handler in the network shell, which appeared to be communicating with the modem via another mechanism. Sure enough, following the call stack <a href="https://github.com/zephyrproject-rtos/zephyr/blob/8748a056f0d8b8aa15f6c9203c34a1849960f1bf/subsys/net/lib/shell/dns.c#L182">from <code>cmd_net_dns_query</code></a> revealed a <a href="https://github.com/zephyrproject-rtos/zephyr/blob/8748a056f0d8b8aa15f6c9203c34a1849960f1bf/subsys/net/lib/dns/resolve.c#L1233">call to <code>zsock_sendto</code></a>, notably with the server address provided.</p>

<pre data-enlighter-language="c">ret = zsock_sendto(sock, buf, len, 0, server, server_addr_len);</pre>
<p>The implementation is defined in the <a href="https://github.com/nrfconnect/sdk-nrf/blob/859caae972f33e147649af67aea71e00c35006a2/lib/nrf_modem_lib/nrf9x_sockets.c#L1014">offloaded sockets vtable</a>.</p>

<pre data-enlighter-language="c">static const struct socket_op_vtable nrf9x_socket_fd_op_vtable = {
    .fd_vtable = {
        .read = nrf9x_socket_offload_read,
        .write = nrf9x_socket_offload_write,
        .close = nrf9x_socket_offload_close,
        .ioctl = nrf9x_socket_offload_ioctl,
    },
    .bind = nrf9x_socket_offload_bind,
    .connect = nrf9x_socket_offload_connect,
    .listen = nrf9x_socket_offload_listen,
    .accept = nrf9x_socket_offload_accept,
    .sendto = nrf9x_socket_offload_sendto,
    .sendmsg = nrf9x_socket_offload_sendmsg,
    .recvfrom = nrf9x_socket_offload_recvfrom,
    .getsockopt = nrf9x_socket_offload_getsockopt,
    .setsockopt = nrf9x_socket_offload_setsockopt,
};</pre>
<p><code>nrf9x_socket_offload_sendto</code> then calls <code>nrf_sendto</code>, which takes us back into the binary modem library. The key difference between these paths is that the former asks the modem to perform a DNS request on its behalf, while in the latter, the DNS request is formed, then the modem is asked to send the request to the specified server. In this case, the server happens to be Cloudflare’s <code>1.1.1.1</code> , which is <a href="https://github.com/golioth/golioth-firmware-sdk/blob/e97dae07c5af785497089baebb4957c22478cbf5/examples/zephyr/common/Kconfig.defconfig#L23">set as the default</a> in the Golioth Firmware SDK for Zephyr examples.</p>
<p>At this point, we considered whether there could be a bug in the modem firmware. We had already reached out Nordic, but we needed to move quickly to address the issue. Unfortunately, we were unable to disassemble the encrypted modem firmware binary that Nordic distributes, and dumping the unencrypted firmware proved difficult. We quickly tested a few different versions of the modem firmware to ensure that the behavior had not been corrected in a newer version. The issue reproduced intermittently across all of them.</p>
<p>Perhaps there was an issue with the DNS server used by the modem? This raised the question of how the modem was deciding upon a DNS server to use in the first place. We discovered the <code>nrf_setdnsaddr</code> function in the modem library, which provided some <a href="https://github.com/nrfconnect/sdk-nrfxlib/blob/85954588939b0d6c46a84ae39ef7926cc2fe9810/nrf_modem/include/nrf_socket.h#L1124C1-L1130C37">interesting documentation</a>.</p>

<pre data-enlighter-language="c">/**
 * @brief Set a secondary DNS address.
 *
 * @details
 * The secondary DNS address is only used in case the primary DNS address is unreachable,
 * or if no DNS address is provided by the operator. The secondary DNS address does not
 * override the primary DNS address.</pre>
<p>It was still unclear as to how the primary DNS server address was being set, but we figured calling the function prior to attempting DNS resolution was worth a shot.<!-- notionvc: f0313c1e-933a-499d-9f79-2bca6f1eca29 --></p>
<pre data-enlighter-language="c">struct nrf_in_addr dns;
dns.s_addr = 16843009;  // Cloudflare DNS, 1.1.1.1
nrf_setdnsaddr(NRF_AF_INET, &amp;dns, sizeof(dns));
LOG_INF(&#34;manually set DNS server via nrf_setdnsaddr&#34;);</pre>
<p>Maddeningly, it worked. Given the behavior was intermittent, we made sure to test repeatedly, but the device connected every time. Suddenly we had the only thing worse than no solution: a solution that you don’t understand. Hardly comfortable recommending this as a generic workaround to our customers, our pursuit continued.</p>
<p>Curious as to what the modem considered its primary and secondary DNS server addresses, we began pouring through the AT commands supported by the nRF91 series. The <a href="https://docs.nordicsemi.com/bundle/ref_at_commands/page/REF/at_commands/packet_domain/cgcontrdp.html">PDN connection dynamic parameters</a> (<code>AT+CGCONTRDP</code>) command returns information about an active Packet Data Network (PDN) connection, including fields described as primary and secondary DNS. After removing the <code>nrf_setdnsaddr</code> call, we added the following immediately after successful LTE registration.</p>

<pre data-enlighter-language="c">err = nrf_modem_at_cmd(at_resp, sizeof(at_resp), &#34;AT+CGCONTRDP=0&#34;);
if (err)
{
    LOG_WRN(&#34;nrf_modem_at_cmd failed. errno: %d&#34;, err);
    return -1;
}
LOG_INF(&#34;%s&#34;, at_resp);</pre>
<p>The first test was successful and revealed <code>8.8.8.8</code> and <code>8.8.4.4</code> as primary and secondary DNS servers respectively.</p>

<pre data-enlighter-language="generic">[00:00:00.510,864] &lt;dbg&gt; fw_update_sample: main: Start FW Update sample
[00:00:00.510,894] &lt;inf&gt; golioth_samples: Bringing up network interface
[00:00:00.510,894] &lt;inf&gt; golioth_samples: Waiting to obtain IP address
[00:00:10.049,316] &lt;inf&gt; lte_monitor: Network: Searching
[00:00:11.140,258] &lt;wrn&gt; lte_lc: Registration rejected, EMM cause: 15, Cell ID: 39848451, Tracking area: 39680, LTE mode: 7
[00:00:15.617,614] &lt;inf&gt; lte_monitor: Network: Registered (roaming)
[00:00:15.618,591] &lt;inf&gt; fw_update_sample: +CGCONTRDP: 0,,&#34;hologram&#34;,&#34;&#34;,&#34;&#34;,&#34;8.8.8.8&#34;,&#34;8.8.4.4&#34;
[00:00:15.848,937] &lt;inf&gt; golioth_mbox: Mbox created, bufsize: 1232, num_items: 10, item_size: 112
[00:00:15.849,731] &lt;inf&gt; golioth_fw_update: Current firmware version: main - 0.0.8
[00:00:15.851,470] &lt;inf&gt; golioth_fw_update: State = Idle
[00:00:17.516,204] &lt;inf&gt; golioth_coap_client_zephyr: Golioth CoAP client connected
[00:00:17.516,479] &lt;inf&gt; fw_update_sample: Golioth client connected</pre>
<p>However, on a subsequent failed test, the first indication of the root cause appeared.<!-- notionvc: b1db5662-5475-4d19-958a-d02699c9b515 --></p>
<pre data-enlighter-language="generic">[00:01:03.706,878] &lt;inf&gt; lte_monitor: Network: Registered (roaming)
[00:01:03.707,672] &lt;inf&gt; fw_update_sample: +CGCONTRDP: 0,,&#34;hologram&#34;,&#34;&#34;,&#34;&#34;
[00:01:03.708,526] &lt;inf&gt; golioth_mbox: Mbox created, bufsize: 1232, num_items: 10, item_size: 112
[00:01:03.709,320] &lt;inf&gt; golioth_fw_update: Current firmware version: main - 0.0.8
[00:01:03.711,059] &lt;inf&gt; golioth_fw_update: State = Idle
[00:01:03.711,639] &lt;err&gt; golioth_coap_client_zephyr: Fail to get address (coap.golioth.io 5684) -2
[00:01:03.711,669] &lt;err&gt; golioth_coap_client_zephyr: Failed to connect: -11
[00:01:03.711,669] &lt;wrn&gt; golioth_coap_client_zephyr: Failed to connect: -11</pre>
<p>The DNS server addresses were missing! After re-adding <code>nrf_setdnsaddr</code>, then invoking <code>AT+CGCONTRDP</code> both before and after calling it, both the primary and secondary appeared to be missing intermittently, <em>but the subsequent DNS resolution was always successful</em>.</p>

<pre data-enlighter-language="generic">[00:00:41.886,840] &lt;inf&gt; lte_monitor: Network: Registered (roaming)
[00:00:41.892,913] &lt;inf&gt; fw_update_sample: +CGCONTRDP: 0,,&#34;hologram&#34;,&#34;&#34;,&#34;&#34;
[00:00:41.895,119] &lt;inf&gt; fw_update_sample: manually set DNS server via nrf_setdnsaddr
[00:00:41.899,688] &lt;inf&gt; fw_update_sample: +CGCONTRDP: 0,,&#34;hologram&#34;,&#34;&#34;,&#34;&#34;
[00:00:42.950,469] &lt;inf&gt; golioth_mbox: Mbox created, bufsize: 1232, num_items: 10, item_size: 112
[00:00:42.951,263] &lt;inf&gt; golioth_fw_update: Current firmware version: main - 0.0.8
[00:00:42.953,002] &lt;inf&gt; golioth_fw_update: State = Idle
[00:00:44.462,677] &lt;inf&gt; golioth_coap_client_zephyr: Golioth CoAP client connected
[00:00:44.462,951] &lt;inf&gt; fw_update_sample: Golioth client connected</pre>
<h2><a href="#you-can-just-read-stuff" aria-hidden="true" id="you-can-just-read-stuff"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>You Can Just Read Stuff</h2>
<p>Remember our good friends at 3GPP and all of their wonderful specifications? It turns out that the aforementioned theoretical brave souls who operate outside of the telecom companies and silicon vendors, but venture into the specification mines nonetheless, are not so theoretical. You can find us at the bottom of the <em>r/telecom</em> Reddit threads where someone is claiming that “carrier standards are so complex that you couldn’t hope to understand them even if you tried”.</p>
<p>As previously mentioned, the 3GPP release that introduced the technology supported by the nRF91 series modems is Release 13. Specifications across releases are organized into <a href="https://www.3gpp.org/specifications-technologies/specifications-by-series">series</a>. For example, <a href="https://portal.etsi.org/webapp/workprogram/Report_WorkItem.asp?WKI_ID=62371">3GPP TS 36.331 version 13.17.0 Release 13</a>, is a 3GPP technical specification (TS) in series 36 (LTE (Evolved UTRA), LTE-Advanced, LTE-Advanced Pro radio technology), with ID 331. It is under <a href="https://portal.3gpp.org/ChangeRequests.aspx?q=1&amp;specnumber=36.331">change control</a>, meaning that new versions may be released and included in subsequent releases. Version 13.17.0 was the final iteration included in 3GPP Release 13.</p>
<p>This specific TS is entitled “<em>LTE; Evolved Universal Terrestrial Radio Access (E-UTRA); Radio Resource Control (RRC); Protocol specification</em>” — really roles off the tongue. Radio Resource Control (RRC) is the protocol used for signalling between <a href="https://en.wikipedia.org/wiki/User_equipment">User Equipment (UE)</a> and <a href="https://en.wikipedia.org/wiki/ENodeB">E-UTRAN Node B (Evolved Node B, eNodeB, eNB)</a>. To greatly simplify for our specific use case, the nRF9160 device is serving as the UE and the cell towers it attempts to connect to can be thought of as the eNodeB. We start with TS 36.331 because before the device can communicate with the network, it needs to communicate with towers, and it will use RRC to do so.</p>
<p>Once again giving credit to Nordic where it is due, they offer a terrific <a href="https://docs.nordicsemi.com/bundle/ncs-latest/page/nrfxlib/nrf_modem/doc/modem_trace.html">modem trace</a> feature on the nRF91 series devices. A firmware application can be configured to <a href="https://academy.nordicsemi.com/courses/cellular-iot-fundamentals/lessons/lesson-7-cellular-fundamentals/topic/lesson-7-modem-trace/">forward trace data</a> from the modem core over UART or RTT, or write it to flash or RAM. The binary modem trace data can be <a href="https://docs.nordicsemi.com/bundle/nrfutil/page/nrfutil-trace/guides/tracing_converting_data.html">converted</a> into multiple formats, including a <a href="https://pcapng.com/">PcapNG (PCAP Next Generation)</a> file that can be opened in <a href="https://www.wireshark.org/">Wireshark</a>. Furthermore, the <code>nrfutil</code> <a href="https://www.nordicsemi.com/Products/Development-tools/nRF-Util">tool</a> enables live capturing from UART to Wireshark with the following command.</p>

<pre data-enlighter-language="generic">nrfutil trace lte --input-serial-port &lt;serial port&gt; --output-wireshark &lt;/path/to/wireshark/binary&gt;</pre>
<p>The first set of RRC messages we observed in the modem trace were <code>SystemInformationBlockType1</code>. According to TS 36.331: <em><code>SystemInformationBlockType1</code> contains information relevant when evaluating if a UE is allowed to access a cell and defines the scheduling of other system information (page 265)</em>.</p>

<pre data-enlighter-language="generic">29	3.411529			LTE RRC DL_SCH	117	SystemInformationBlockType1
30	5.831665			LTE RRC DL_SCH	117	SystemInformationBlockType1
31	6.021637			LTE RRC DL_SCH	117	SystemInformationBlockType1
32	7.271698			LTE RRC DL_SCH	117	SystemInformationBlockType1
33	7.700806			LTE RRC DL_SCH	117	SystemInformation [ SIB2 SIB3 ]
36	7.718628			LTE RRC DL_SCH	60	SystemInformation [ SIB4 ]</pre>
<p>Section 5.2.2.7 of TS 36.331 provides the logic for evaluating whether the Evolved Universal Terrestrial Radio Access Network (E-UTRAN) is a candidate for a given UE. After evaluating candidacy and receiving all necessary system information, the UE will send an <code>RRCConnectionRequest</code>, which the E-UTRAN will respond to with an <code>RRCConnectionSetup</code> message.</p>

<pre data-enlighter-language="generic">37	7.729614			LTE RRC UL_CCCH	30	RRCConnectionRequest
38	7.772034			LTE RRC DL_CCCH	74	RRCConnectionSetup</pre>
<p>These messages between the UR and the E-UTRAN are referred to as <a href="https://en.wikipedia.org/wiki/Access_stratum">Access Stratum (AS)</a> signalling. After the connection is established, the UE is then able to communicate with the Evolved Packet Core (EPC). Messages between the UE and the EPC are referred to as <a href="https://en.wikipedia.org/wiki/Non-access_stratum">Non-Access Stratum (NAS)</a> signalling. Perhaps the most helpful overview of this architecture is buried in <a href="https://www.etsi.org/deliver/etsi_ts/136400_136499/136401/13.02.00_60/ts_136401v130200p.pdf">3GPP TS 36.401 version 13.2.0 Release 13</a>, entitled <em>“LTE; Evolved Universal Terrestrial Radio Access Network (E-UTRAN); Architecture description”</em>, in Section 5.3.</p>

<p><img fetchpriority="high" decoding="async" src="https://blog.golioth.io/wp-content/uploads/2025/02/image-2.png" alt="3GPP LTE Architecture" width="733" height="340" srcset="https://blog.golioth.io/wp-content/uploads/2025/02/image-2.png 733w, https://blog.golioth.io/wp-content/uploads/2025/02/image-2-320x148.png 320w, https://blog.golioth.io/wp-content/uploads/2025/02/image-2-150x70.png 150w, https://blog.golioth.io/wp-content/uploads/2025/02/image-2-300x139.png 300w, https://blog.golioth.io/wp-content/uploads/2025/02/image-2-696x323.png 696w" sizes="(max-width: 733px) 100vw, 733px"/></p>
<p>NAS messages may be piggybacked on AS messages, and you’ll also note the presence of the Evolved Packet System (EPS) Mobility Management (EMM) and Session Management (ESM) protocols on top of the Non-Access Stratum. We saw both appear in the next communication.<!-- notionvc: 14f374d7-e328-44aa-8ac6-12f3827cab09 --></p>
<pre data-enlighter-language="generic">39	7.772736			LTE RRC UL_DCCH/NAS-EPS	110	RRCConnectionSetupComplete, Attach request, PDN connectivity request
41	8.378113			LTE RRC DL_DCCH/NAS-EPS	63	DLInformationTransfer, Authentication request
44	8.433136			LTE RRC UL_DCCH/NAS-EPS	38	ULInformationTransfer, Authentication response
45	8.521912			LTE RRC DL_DCCH/NAS-EPS	41	DLInformationTransfer, Security mode command
48	8.523621			LTE RRC UL_DCCH/NAS-EPS	46	ULInformationTransfer, Ciphered message
49	8.899994			LTE RRC DL_DCCH/NAS-EPS	36	DLInformationTransfer</pre>
<p>The <code>Attach request</code> is an EMM message, while the <code>PDN connectivity request</code> is an ESM message, and both are encapsulated in the <code>RRCConectionSetupComplete</code> message sent by the UR. To understand the structure of NAS messages, we have to look at, you guessed it, another 3GPP TS. This time is it <a href="https://www.etsi.org/deliver/etsi_ts/124300_124399/124301/13.12.00_60/ts_124301v131200p.pdf">3GPP TS 24.301 version 13.12.0 Release 13</a>, entitled <em>“Universal Mobile Telecommunications System (UMTS); LTE; 5G; Non-Access-Stratum (NAS) protocol for Evolved Packet System (EPS); Stage 3”</em>. I promise I’m not making these names up. The <code>PDN connectivity request</code> is, according to the specification, sent by the UE to the network to initiate establishment of a Packet Data Network (PDN) connection (Section 8.3.20). It includes a variety of parameters, which which we were able see when expanding the data in Wireshark.</p>

<pre data-enlighter-language="generic">ESM message container
    Length: 41
    ESM message container contents: 0201d03127238080211001000010810600000000830600000000000d00000300000a00001000001600
        0000 .... = EPS bearer identity: No EPS bearer identity assigned (0)
        .... 0010 = Protocol discriminator: EPS session management messages (0x2)
        Procedure transaction identity: 1
        NAS EPS session management messages: PDN connectivity request (0xd0)
        0011 .... = PDN type: IPv4v6 (3)
        .... 0001 = Request type: Initial request (1)
        Protocol Configuration Options
            Element ID: 0x27
            Length: 35
            [Link direction: MS to network (0)]
            1... .... = Extension: True
            .... .000 = Configuration Protocol: PPP for use with IP PDP type or IP PDN type (0)
            Protocol or Container ID: Internet Protocol Control Protocol (0x8021)
            Protocol or Container ID: DNS Server IPv4 Address Request (0x000d)
                Length: 0x00 (0)
            Protocol or Container ID: DNS Server IPv6 Address Request (0x0003)
                Length: 0x00 (0)
            Protocol or Container ID: IP address allocation via NAS signalling (0x000a)
            Protocol or Container ID: IPv4 Link MTU Request (0x0010)
            Protocol or Container ID: APN rate control support indicator (0x0016)
</pre>
<p>The vast majority of them fall under <code>Protocol Configuration Options</code> (PCO). Thankfully there is some information about these options in Section 9.9.4.11 of TS 24.301. It reads:</p>
<p><em>See subclause 10.5.6.3 in 3GPP TS 24.008.</em></p>
<p>You’ve got to be kidding me. We’ll skip the big reveal and jump right to the description in <a href="https://www.etsi.org/deliver/etsi_ts/124000_124099/124008/13.13.00_60/ts_124008v131300p.pdf">TS 24.008</a>.</p>
<p><em>The purpose of the protocol configuration options information element is to:</em></p>
<ul>
<li><em>transfer external network protocol options associated with a PDP context activation, and</em></li>
<li><em>transfer additional (protocol) data (e.g. configuration parameters, error codes or messages/events) associated with an external protocol or an application.</em></li>
</ul>
<p>A Packet Data Protocol (PDP) context is the connection over which the UE can send packets to the network. The options that immediately stuck out when investigating our DNS issue was the presence of the <code>DNS Server IPv4 Address Request</code> and <code>DNS Server IPv6 Address Request</code>. In the <code>PDN connectivity request</code>, these indicate that the UE is requesting these addresses from the network. We can see the response in the <code>Attach accept</code> message which includes an <code>Activate default EPS bearer context</code> ESM message.</p>

<pre data-enlighter-language="generic">125	73.928986			NAS-EPS	177	Attach accept, Activate default EPS bearer context request (PDN type IPv4 only allowed)</pre>
<p>It includes its own set of protocol configuration options, providing responses for the requests made by the UE.<!-- notionvc: 55d32f94-f357-40ea-92ac-c3fa5f4f7db9 --></p>
<pre data-enlighter-language="generic">ESM message container
    Length: 86
    ESM message container contents: 5204c101091c08686f6c6f6772616d066d6e63303530066d636332333404677072730501644bab975e06fefe66660101583227228080211003030010810608080808830608080404000d0408080808000d0408080404
        0101 .... = EPS bearer identity: EPS bearer identity value 5 (5)
        .... 0010 = Protocol discriminator: EPS session management messages (0x2)
        Procedure transaction identity: 4
        NAS EPS session management messages: Activate default EPS bearer context request (0xc1)
        EPS quality of service
        Access Point Name
        PDN address
        APN aggregate maximum bit rate
        ESM cause
        Protocol Configuration Options
            Element ID: 0x27
            Length: 34
            [Link direction: Network to MS (1)]
            1... .... = Extension: True
            .... .000 = Configuration Protocol: PPP for use with IP PDP type or IP PDN type (0)
            Protocol or Container ID: Internet Protocol Control Protocol (0x8021)
            Protocol or Container ID: DNS Server IPv4 Address (0x000d)
                Length: 0x04 (4)
                IPv4: 8.8.8.8
            Protocol or Container ID: DNS Server IPv4 Address (0x000d)
                Length: 0x04 (4)
                IPv4: 8.8.4.4</pre>
<p><code>8.8.8.8</code> and <code>8.8.4.4</code> are Google’s primary and secondary DNS server addresses and matched what we already observed in the output from the <code>AT+CGCONTRDP</code> AT command. The nRF9160 was able to successfully resolve DNS and connect to the Golioth cloud platform after completing this attach procedure. However, upon rebooting and capturing another modem trace, the device failed DNS and the sequence of messages revealed a few differences.</p>
<p>First of all, the SIB messages were post-fixed with <code>-NB</code>, indicating we were receiving system information from an NB-IoT E-UTRAN rather than LTE Cat-M1.</p>

<pre data-enlighter-language="generic">60	30.905853			LTE RRC DL_SCH_NB	73	SystemInformationBlockType1-NB
61	35.066010			LTE RRC DL_SCH_NB	73	SystemInformationBlockType1-NB
62	49.306519			LTE RRC DL_SCH_NB	73	SystemInformationBlockType1-NB
63	51.546601			LTE RRC DL_SCH_NB	73	SystemInformationBlockType1-NB
64	56.026764			LTE RRC DL_SCH_NB	73	SystemInformationBlockType1-NB
65	59.575012			LTE RRC DL_SCH_NB	87	SystemInformation-NB [ SIB2 SIB3 ]</pre>
<p>Nevertheless, the general procedure looked fairly similar, and the familiar piggybacked attach request and PDN connectivity request was once again present.<!-- notionvc: 3addfe6e-859b-48d8-afde-b2b53f5ced03 --></p>
<pre data-enlighter-language="generic">70	59.777832			LTE RRC UL_DCCH_NB/NAS-EPS	104	RRCConnectionSetupComplete-NB, Attach request, PDN connectivity request</pre>
<p>However, when investigating the contents of the <code>PDN connectivity request</code>, we observed a slightly different structure.</p>

<pre data-enlighter-language="generic">ESM message container
    Length: 42
    ESM message container contents: 0202d0317b00238080211001010010810600000000830600000000000d00000300000a00001000001600
        0000 .... = EPS bearer identity: No EPS bearer identity assigned (0)
        .... 0010 = Protocol discriminator: EPS session management messages (0x2)
        Procedure transaction identity: 2
        NAS EPS session management messages: PDN connectivity request (0xd0)
        0011 .... = PDN type: IPv4v6 (3)
        .... 0001 = Request type: Initial request (1)
        Extended protocol configuration options
            Element ID: 0x7b
            Length: 35
            [Link direction: MS to network (0)]
            1... .... = Extension: True
            .... .000 = Configuration Protocol: PPP for use with IP PDP type or IP PDN type (0)
            Protocol or Container ID: Internet Protocol Control Protocol (0x8021)
            Protocol or Container ID: DNS Server IPv4 Address Request (0x000d)
                Length: 0x00 (0)
            Protocol or Container ID: DNS Server IPv6 Address Request (0x0003)
                Length: 0x00 (0)
            Protocol or Container ID: IP address allocation via NAS signalling (0x000a)
            Protocol or Container ID: IPv4 Link MTU Request (0x0010)
            Protocol or Container ID: APN rate control support indicator (0x0016)</pre>
<p>Rather than Procotol Configuration Options (PCO), there were Extended Protocol Configuration Options (ePCO). They are defined in Section 9.9.4.26 of TS 24.301.</p>
<p><em>The purpose of the extended protocol configuration options information element is to:</em></p>
<ul>
<li><em>transfer external network protocol options associated with a EPS bearer context activation, and</em></li>
<li><em>transfer additional (protocol) data (e.g. configuration parameters, error codes or messages/events) associated with an external protocol or an application.</em></li>
</ul>
<p>Sounds pretty similar to PCO. Looking at one more specification, <a href="https://www.etsi.org/deliver/etsi_ts/129200_129299/129274/13.13.00_60/ts_129274v131300p.pdf">3GPP TS 29.274 version 13.13.0 Release 13</a>, entitled <em>“Universal Mobile Telecommunications System (UMTS); LTE; 3GPP Evolved Packet System (EPS); Evolved General Packet Radio Service (GPRS) Tunnelling Protocol for Control plane (GTPv2-C); Stage 3”</em> , states the following in Section 7.2.1 Note 15.</p>
<p><em>An MME, SGW and PGW which supports NB-IoT and/or Non-IP PDN type shall support ePCO. A UE supporting NB-IoT access and/or Non-IP PDN type also support ePCO.</em></p>
<p>GTP is the <a href="https://en.wikipedia.org/wiki/GPRS_Tunnelling_Protocol">GPRS Tunnelling Protocol</a>, and GTP-C is the “control” section. LTE uses GTPv2, which is described as follows on the Wikipedia page.</p>
<p><em>The eGTP-C (or, GTPv2-C) protocol is responsible for creating, maintaining and deleting tunnels on multiple Sx interfaces. It is used for the control plane path management, tunnel management and mobility management. It also controls forwarding relocation messages; SRNS context and creating forward tunnels during inter LTE handovers.</em></p>
<p>Looking back at the diagram from TS 36.401, GTPv2 is the protocol that allows communication between the E-UTRAN and the EPC. That traffic is not observable from the modem trace, but TS 29.274 tells us that both the UE and the entities that make up the EPC must support ePCO when using NB-IoT. We already observed the UE support in the <code>PDN connectivity request</code>, and the accept and activate response was received shortly after.</p>

<pre data-enlighter-language="generic">83	70.641510			NAS-EPS	108	Attach accept, Activate default EPS bearer context request (PDN type IPv4 only allowed)</pre>
<p>However, upon inspecting the contents, there were no ePCO responses to be found.<!-- notionvc: 04ddd1ee-ceea-4796-a19b-43419073dc5e --></p>
<pre data-enlighter-language="generic">ESM message container
    Length: 49
    ESM message container contents: 5202c101091c08686f6c6f6772616d066d6e63303530066d636332333404677072730501644bab975e04fefec56c583291
        0101 .... = EPS bearer identity: EPS bearer identity value 5 (5)
        .... 0010 = Protocol discriminator: EPS session management messages (0x2)
        Procedure transaction identity: 2
        NAS EPS session management messages: Activate default EPS bearer context request (0xc1)
        EPS quality of service
        Access Point Name
        PDN address
        APN aggregate maximum bit rate
        ESM cause
        Control plane only indication</pre>
<p>This was despite the fact the that the same message indicates support for ePCO.<!-- notionvc: 882221b5-aa22-4ceb-8d1e-2163e6e6e1ef --></p>
<pre data-enlighter-language="generic">EPS network feature support
    Element ID: 0x64
    Length: 2
    1... .... = Control plane CIoT EPS optimization: Supported
    .0.. .... = EMM-REGISTERED w/o PDN connectivity: Not supported
    ..0. .... = Support of EXTENDED SERVICE REQUEST for packet services: Not supported
    ...0 0... = CS-LCS: no information about support of location services via CS domain is available (0)
    .... .0.. = Location services via EPC: Not supported
    .... ..0. = Emergency bearer services in S1 mode: Not supported
    .... ...1 = IMS voice over PS session in S1 mode: Supported
    0... .... = Signalling for a maximum number of 15 EPS bearer contexts: Not supported
    .0.. .... = Interworking without N26 interface: Not supported
    ..0. .... = Restriction on the use of dual connectivity with NR: Not restricted
    ...0 .... = Restriction on enhanced coverage: Not restricted
    .... 1... = Extended protocol configuration options: Supported
    .... .0.. = Header compression for control plane CIoT EPS optimization: Not supported
    .... ..0. = S1-u data transfer: Not supported
    .... ...0 = User plane CIoT EPS optimization: Not supported</pre>
<h2><a href="#what-went-wrong" aria-hidden="true" id="what-went-wrong"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What Went Wrong</h2>
<p>At this point everything was starting to make sense.</p>
<ul>
<li>When using the nRF9160 modem for LTE connectivity, offloaded sockets must be enabled, which forces the use of offloaded DNS resolution.</li>
<li>The nRF9160 modem firmware was using PCO for LTE Cat-M1 networks and ePCO for NB-IoT.</li>
<li>When a DNS server address was provided, either via PCO or ePCO, by the network, the offloaded DNS functionality in the modem firmware would always use it as the first option.</li>
<li>If a DNS server address was not provided by the network, the offloaded DNS resolution would fail to resolve unless a fallback was explicitly set with <code>nrf_setdnsaddr</code>.</li>
<li>Some NB-IoT networks are not compliant with 3GPP specifications, leading to DNS failures when using nRF91 series modem firmware.</li>
</ul>
<p>So who is to blame for this state of affairs? The network provider seems to not be implementing the specification correctly, which certainly is not great. However, Nordic also does not fail gracefully in this scenario or document the possibility of its occurrence. In our investigation, we discovered a plethora tickets on their <a href="https://devzone.nordicsemi.com/">DevZone</a> forum detailing issues with DNS on nRF91 series modems. Most of the threads either fizzled out without resolution, or there was a suggestion to set <code>CONFIG_LEGACY_PDN_PCO=y</code>, <a href="https://docs.nordicsemi.com/bundle/ncs-1.9.0/page/kconfig/CONFIG_PDN_LEGACY_PCO.html">completely disabling the use of ePCO</a>, which may cause issues in the event that ePCO <em>is</em> supported. In our testing, ensuring that a secondary DNS address is always configured via <code>nrf_setdnsaddr</code> appears to be a more reliable option.</p>
<p>However, I would argue that the details of this specific issue are not the root of the problem. The root of the problem is an ecosystem that is built on secretive, proprietary technology and complex specifications that even the people involved in writing them have trouble implementing. While some of us may have a strange obsession with combing through 3GPP documents, that shouldn’t be a prerequisite for a company to build a reliable cellular-enabled product. The root of the problem is that, even though we have performed a thorough investigation, tested extensively, and communicated with vendors about the issue, we are still guessing because the modem firmware is closed source and the mobile network operator (MNO) infrastructure is opaque.</p>

<h2><a href="#a-call-for-change" aria-hidden="true" id="a-call-for-change"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A Call for Change</h2>
<p>You may say this is the way it has always been, or that if you want something to change you better be ready to hire a small army of lawyers. We prefer a more optimistic, though perhaps naive, outlook.</p>
<p>The reality is that the most effective way to inspire change in a commercial context is to appeal to a major player’s self-interest. As previously noted, modem designers like Nordic may have limited control over which parts of the modem firmware can be open source and which cannot. However, given their embrace of open source application firmware, it is clear that they recognize the benefits of both building an ecosystem and allowing customers and other organizations to contribute.</p>
<p>For Nordic and other vendors like them, open source is not only the best thing for their customers, it is the best thing for their business. The same is true for MNOs and MVNOs. The number one reason we see customers opt to not use cellular when another connectivity option is on the table is due to concerns around cost and reliability. Because telecom is a heavily regulated industry, utilizing cellular connectivity when building a product almost always requires taking a dependency on a third party. In order to serve your customers well, you need to have a relationship with your vendors that is based on trust. Transparency is a foundational building block of trust, and vendors that are willing to embrace that will be able to differentiate in the market.</p>
<p>Until then, you can find us combing through 3GPP specifications and reverse engineering their infrastructure to ensure that our customers are able to build cellular-enabled devices with confidence.</p>


</div></div></div>
  </body>
</html>
