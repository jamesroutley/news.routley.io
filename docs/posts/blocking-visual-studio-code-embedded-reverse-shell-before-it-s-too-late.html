<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ipfyx.fr/post/visual-studio-code-tunnel/">Original</a>
    <h1>Blocking Visual Studio Code embedded reverse shell before it&#39;s too late</h1>
    
    <div id="readability-page-1" class="page"><div>
<h2 id="introduction">Introduction</h2>
<p>Since July 2023, Microsoft is offering  the perfect reverse shell, embedded inside Visual Studio Code, a widely used development tool. With just a few clicks, any user with a github account can share their visual studio desktop on the web. VS code tunnel is almost considered a <a href="https://lolbas-project.github.io/lolbas/HonorableMentions/Code/">lolbin (Living Of the Land Binary)</a>.</p>
<p>I am so glad that my users now have the ability to expose their computer with highly sensitive data right on the web, through an authentication I nor control, nor supervise. My internal network is now accessible from anywhere !</p>
<p>The worse part is that this tunnel can be triggered <a href="https://badoption.eu/blog/2023/01/31/code_c2.html">from the cmdline</a> with the <a href="https://code.visualstudio.com/sha/download?build=stable&amp;os=cli-win32-x64">portable version of code.exe</a>. An attacker just has to upload the binary, which won&#39;t be detected by any anti-virus since it is legitimate and singed windows binary.</p>
<p>It is therefore something to watch out for.</p>
<p>Execute it, open the link mentioned, log in to your github account and there is your reverse shell.</p>
<div><pre tabindex="0"><code data-lang="powershell"><span><span> 1</span><span><span>.\</span><span>code</span><span>.</span><span>exe</span> <span>tunnel</span>
</span></span><span><span> 2</span><span><span>*</span>
</span></span><span><span> 3</span><span><span>*</span> <span>Visual</span> <span>Studio</span> <span>Code</span> <span>Server</span>
</span></span><span><span> 4</span><span><span>*</span>
</span></span><span><span> 5</span><span><span>*</span> <span>By</span> <span>using</span> <span>the</span> <span>software</span><span>,</span> <span>you</span> <span>agree</span> <span>to</span>
</span></span><span><span> 6</span><span><span>*</span> <span>the</span> <span>Visual</span> <span>Studio</span> <span>Code</span> <span>Server</span> <span>License</span> <span>Terms</span> <span>(</span><span>https</span><span>:</span><span>//</span><span>aka</span><span>.</span><span>ms</span><span>/</span><span>vscode-server</span><span>-license</span><span>)</span> <span>and</span> 
</span></span><span><span> 7</span><span><span>*</span> <span>the</span> <span>Microsoft</span> <span>Privacy</span> <span>Statement</span> <span>(</span><span>https</span><span>:</span><span>//</span><span>privacy</span><span>.</span><span>microsoft</span><span>.</span><span>com</span><span>/</span><span>en-US</span><span>/</span><span>privacystatement</span><span>).</span>
</span></span><span><span> 8</span><span><span>*</span>
</span></span><span><span> 9</span><span>
</span></span><span><span>10</span><span><span>Open</span> <span>this</span> <span>link</span> <span>in</span> <span>your</span> <span>browser</span> <span>https</span><span>:</span><span>//</span><span>vscode</span><span>.</span><span>dev</span><span>/</span><span>tunnel</span><span>/</span><span>sauceTomate</span><span>/</span><span>C:</span><span>/</span><span>Users</span><span>/</span><span>ipfyx</span><span>/</span><span>Downloads</span><span>/</span><span>vscode_cli_win32_x64_cli</span>
</span></span></code></pre></div><p>The binary is definitely signed :</p>
<div><pre tabindex="0"><code data-lang="powershell"><span><span>1</span><span><span>Get-AppLockerFileInformation</span> <span>&#39;C:\Users\ipfyx\AppData\Local\Programs\Microsoft VS Code\bin\code-tunnel.exe&#39;</span><span>|</span><span>Select-Object</span> <span>-ExpandProperty</span> <span>Publisher</span>
</span></span><span><span>2</span><span><span>PublisherName</span>    <span>:</span> <span>O</span><span>=</span><span>MICROSOFT</span> <span>CORPORATION</span><span>,</span> <span>L</span><span>=</span><span>REDMOND</span><span>,</span> <span>S</span><span>=</span><span>WASHINGTON</span><span>,</span> <span>C</span><span>=</span><span>US</span>
</span></span><span><span>3</span><span><span>ProductName</span>      <span>:</span>
</span></span><span><span>4</span><span><span>BinaryName</span>       <span>:</span>
</span></span><span><span>5</span><span><span>BinaryVersion</span>    <span>:</span> <span>0</span><span>.</span><span>0</span><span>.</span><span>0</span><span>.</span><span>0</span>
</span></span><span><span>6</span><span><span>HasPublisherName</span> <span>:</span> <span>True</span>
</span></span><span><span>7</span><span><span>HasProductName</span>   <span>:</span> <span>False</span>
</span></span><span><span>8</span><span><span>HasBinaryName</span>    <span>:</span> <span>False</span>
</span></span></code></pre></div><p>Notice how there are nor ProductName nor BinaryName value, we will use them later.</p>
<p><a href="https://badoption.eu/blog/2023/01/31/code_c2.html">pfiatde blog post</a> already did a great job at describing what an attacker can do so I won&#39;t say much more. Go check his awesome blog post.</p>
<h2 id="mitigation">Mitigation</h2>
<p>But now, as a defender, how do we block or detect its usage ?</p>
<h3 id="domains-blacklist">Domains blacklist</h3>
<p>Microsoft documentation states :</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>1</span><span>If you&#39;re part of an organization who wants to control access to Remote Tunnels, you can do so by allowing or denying access to the domain global.rel.tunnels.api.visualstudio.com.
</span></span></code></pre></div><p>Yeah it&#39;s not that simple. It will indeed block most users but, from my testing, it won&#39;t block an attacker that has already established a tunnel once. Meaning the tunnel can be kept active or restarted at will despite this domain being blacklisted.</p>
<p>From my understanding, VScode contacts <em>global.rel.tunnels.api.visualstudio.com</em> to get its &#34;clusters&#34; : <a href="https://global.rel.tunnels.api.visualstudio.com/api/v1/clusters">https://global.rel.tunnels.api.visualstudio.com/api/v1/clusters</a></p>
<p>Here is a sample of the resulting json :</p>
<div><pre tabindex="0"><code data-lang="json"><span><span> 1</span><span><span>[</span>
</span></span><span><span> 2</span><span>  <span>{</span>
</span></span><span><span> 3</span><span>    <span>&#34;clusterId&#34;</span><span>:</span> <span>&#34;auc1&#34;</span><span>,</span>
</span></span><span><span> 4</span><span>    <span>&#34;uri&#34;</span><span>:</span> <span>&#34;https://auc1.rel.tunnels.api.visualstudio.com&#34;</span><span>,</span>
</span></span><span><span> 5</span><span>    <span>&#34;azureLocation&#34;</span><span>:</span> <span>&#34;AustraliaCentral&#34;</span>
</span></span><span><span> 6</span><span>  <span>},</span>
</span></span><span><span> 7</span><span>  <span>{</span>
</span></span><span><span> 8</span><span>    <span>&#34;clusterId&#34;</span><span>:</span> <span>&#34;aue&#34;</span><span>,</span>
</span></span><span><span> 9</span><span>    <span>&#34;uri&#34;</span><span>:</span> <span>&#34;https://aue.rel.tunnels.api.visualstudio.com&#34;</span><span>,</span>
</span></span><span><span>10</span><span>    <span>&#34;azureLocation&#34;</span><span>:</span> <span>&#34;AustraliaEast&#34;</span>
</span></span><span><span>11</span><span>  <span>},</span>
</span></span><span><span>12</span><span>  <span>etc.</span>
</span></span><span><span>13</span><span><span>]</span>
</span></span></code></pre></div><p>Those domains are also mentioned in another <a href="https://learn.microsoft.com/en-us/azure/developer/dev-tunnels/security">Microsoft documentation</a> :</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>1</span><span>- Dev Tunnels
</span></span><span><span>2</span><span>  - global.rel.tunnels.api.visualstudio.com
</span></span><span><span>3</span><span>  - [clusterId].rel.tunnels.api.visualstudio.com
</span></span><span><span>4</span><span>  - [clusterId]-data.rel.tunnels.api.visualstudio.com
</span></span><span><span>5</span><span>  - *.[clusterId].devtunnels.ms
</span></span><span><span>6</span><span>  - *.devtunnels.ms
</span></span></code></pre></div><p>Blocking those domains will block and cut off any VS code tunnel :</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>1</span><span>*.tunnels.api.visualstudio.com
</span></span><span><span>2</span><span>*.devtunnels.ms
</span></span></code></pre></div><h3 id="applocker">Applocker</h3>
<p>Applocker is Microsoft application whitelisting technology. When enabled and configured, with default rules for example, everything is blocked by default except for the executables and scripts defined in the preceding rules.
Let&#39;s pretend we use Microsoft default rules for demo purpose.</p>
<p>To generate them, in <em>Group Policy Management Editor</em>, go to <em>Computer Configuration -&gt; Windows Settings -&gt; Security Settings -&gt; Application Control Policies -&gt; AppLocker</em>.
Right Click on <em>Create Default Rules</em>.</p>
<p>Then right click on <em>AppLocker</em> and <em>Export Policy</em>.</p>
<figure>
  <picture>

    
      
        
        
        
        
        
        
    <img loading="lazy" decoding="async" alt="MS Applocker default rules generation" src="https://ipfyx.fr/images/applocker-generate-ms-default-rules.png" title="MS Applocker default rules generation"/>

    <figcaption>MS Applocker default rules generation</figcaption></picture>
</figure>

<p>Here is the resulting xml :</p>
<div><pre tabindex="0"><code data-lang="xml"><span><span> 1</span><span><span>&lt;AppLockerPolicy</span> <span>Version=</span><span>&#34;1&#34;</span><span>&gt;</span>
</span></span><span><span> 2</span><span>  <span>&lt;RuleCollection</span> <span>Type=</span><span>&#34;Appx&#34;</span> <span>EnforcementMode=</span><span>&#34;Enabled&#34;</span> <span>/&gt;</span>
</span></span><span><span> 3</span><span>  <span>&lt;RuleCollection</span> <span>Type=</span><span>&#34;Dll&#34;</span> <span>EnforcementMode=</span><span>&#34;NotConfigured&#34;</span> <span>/&gt;</span>
</span></span><span><span> 4</span><span>  <span>&lt;RuleCollection</span> <span>Type=</span><span>&#34;Exe&#34;</span> <span>EnforcementMode=</span><span>&#34;Enabled&#34;</span><span>&gt;</span>
</span></span><span><span> 5</span><span>    <span>&lt;FilePathRule</span> <span>Id=</span><span>&#34;921cc481-6e17-4653-8f75-050b80acca20&#34;</span> <span>Name=</span><span>&#34;(Default Rule) All files located in the Program Files folder&#34;</span> <span>Description=</span><span>&#34;Allows members of the Everyone group to run applications that are located in the Program Files folder.&#34;</span> <span>UserOrGroupSid=</span><span>&#34;S-1-1-0&#34;</span> <span>Action=</span><span>&#34;Allow&#34;</span><span>&gt;</span>
</span></span><span><span> 6</span><span>      <span>&lt;Conditions&gt;</span>
</span></span><span><span> 7</span><span>        <span>&lt;FilePathCondition</span> <span>Path=</span><span>&#34;%PROGRAMFILES%\*&#34;</span> <span>/&gt;</span>
</span></span><span><span> 8</span><span>      <span>&lt;/Conditions&gt;</span>
</span></span><span><span> 9</span><span>    <span>&lt;/FilePathRule&gt;</span>
</span></span><span><span>10</span><span>    <span>&lt;FilePathRule</span> <span>Id=</span><span>&#34;a61c8b2c-a319-4cd0-9690-d2177cad7b51&#34;</span> <span>Name=</span><span>&#34;(Default Rule) All files located in the Windows folder&#34;</span> <span>Description=</span><span>&#34;Allows members of the Everyone group to run applications that are located in the Windows folder.&#34;</span> <span>UserOrGroupSid=</span><span>&#34;S-1-1-0&#34;</span> <span>Action=</span><span>&#34;Allow&#34;</span><span>&gt;</span>
</span></span><span><span>11</span><span>      <span>&lt;Conditions&gt;</span>
</span></span><span><span>12</span><span>        <span>&lt;FilePathCondition</span> <span>Path=</span><span>&#34;%WINDIR%\*&#34;</span> <span>/&gt;</span>
</span></span><span><span>13</span><span>      <span>&lt;/Conditions&gt;</span>
</span></span><span><span>14</span><span>    <span>&lt;/FilePathRule&gt;</span>
</span></span><span><span>15</span><span>    <span>&lt;FilePathRule</span> <span>Id=</span><span>&#34;fd686d83-a829-4351-8ff4-27c7de5755d2&#34;</span> <span>Name=</span><span>&#34;(Default Rule) All files&#34;</span> <span>Description=</span><span>&#34;Allows members of the local Administrators group to run all applications.&#34;</span> <span>UserOrGroupSid=</span><span>&#34;S-1-5-32-544&#34;</span> <span>Action=</span><span>&#34;Allow&#34;</span><span>&gt;</span>
</span></span><span><span>16</span><span>      <span>&lt;Conditions&gt;</span>
</span></span><span><span>17</span><span>        <span>&lt;FilePathCondition</span> <span>Path=</span><span>&#34;*&#34;</span> <span>/&gt;</span>
</span></span><span><span>18</span><span>      <span>&lt;/Conditions&gt;</span>
</span></span><span><span>19</span><span>    <span>&lt;/FilePathRule&gt;</span>
</span></span><span><span>20</span><span>  <span>&lt;/RuleCollection&gt;</span>
</span></span><span><span>21</span><span>  <span>&lt;RuleCollection</span> <span>Type=</span><span>&#34;Msi&#34;</span> <span>EnforcementMode=</span><span>&#34;NotConfigured&#34;</span> <span>/&gt;</span>
</span></span><span><span>22</span><span>  <span>&lt;RuleCollection</span> <span>Type=</span><span>&#34;Script&#34;</span> <span>EnforcementMode=</span><span>&#34;Enabled&#34;</span> <span>/&gt;</span>
</span></span><span><span>23</span><span><span>&lt;/AppLockerPolicy&gt;</span>
</span></span></code></pre></div><p>When using those rules, everything that is in Program Files and Windows is allowed, everything else is blocked. Administrators are allowed to execute anything, VSCode for instance.
But if you were to define a rule that blocks VSCode, this rule would apply first, since &#34;Deny rules&#34; are applied before &#34;Allowed rules&#34;.</p>
<p>Let&#39;s build a rule to block VScode altogether. The rule applies to Everyone (SID S-1-1-0), therefore to Administrators (SID S-1-5-32-544).</p>
<div><pre tabindex="0"><code data-lang="powershell"><span><span>1</span><span><span>Get-AppLockerFileInformation</span> <span>&#39;C:\Users\ipfyx\AppData\Local\Programs\Microsoft VS Code\Code.exe&#39;</span><span>|</span> <span>New-AppLockerPolicy</span> <span>-RuleType</span> <span>Publisher</span> <span>-User</span> <span>S</span><span>-</span><span>1</span><span>-</span><span>1</span><span>-</span><span>0</span> <span>-Optimize</span> <span>-Xml</span>
</span></span></code></pre></div><p>In the resulting xml, I replaced Action=&#34;Allow&#34; with Action=&#34;Deny&#34;. I also removed my current VSCode version from <em>BinaryVersionRange</em> to match any VScode version.</p>
<p><SPAN color="red">Warning : Do not import the following xml in Applocker. Imported alone, this rule will completely block your system. Add a Allow * rule beforehand</SPAN>.</p>
<div><pre tabindex="0"><code data-lang="xml"><span><span> 1</span><span><span>&lt;AppLockerPolicy</span> <span>Version=</span><span>&#34;1&#34;</span><span>&gt;</span>
</span></span><span><span> 2</span><span>	<span>&lt;RuleCollection</span> <span>Type=</span><span>&#34;Exe&#34;</span> <span>EnforcementMode=</span><span>&#34;NotConfigured&#34;</span><span>&gt;</span>
</span></span><span><span> 3</span><span>		<span>&lt;FilePublisherRule</span> <span>Id=</span><span>&#34;1dd70b30-eb06-4220-b808-bd8d368624c0&#34;</span> <span>Name=</span><span>&#34;VScode&#34;</span> <span>Description=</span><span>&#34;&#34;</span> <span>UserOrGroupSid=</span><span>&#34;S-1-5-21-1935059010-3323107334-3352698520-500&#34;</span> <span>Action=</span><span>&#34;Deny&#34;</span><span>&gt;</span>
</span></span><span><span> 4</span><span>			<span>&lt;Conditions&gt;</span>
</span></span><span><span> 5</span><span>				<span>&lt;FilePublisherCondition</span> <span>PublisherName=</span><span>&#34;O=MICROSOFT CORPORATION, L=REDMOND, S=WASHINGTON, C=US&#34;</span> <span>ProductName=</span><span>&#34;VISUAL STUDIO CODE&#34;</span> <span>BinaryName=</span><span>&#34;*&#34;</span><span>&gt;</span>
</span></span><span><span> 6</span><span>					<span>&lt;BinaryVersionRange</span> <span>LowSection=</span><span>&#34;*&#34;</span> <span>HighSection=</span><span>&#34;*&#34;</span> <span>/&gt;</span>
</span></span><span><span> 7</span><span>				<span>&lt;/FilePublisherCondition&gt;</span>
</span></span><span><span> 8</span><span>			<span>&lt;/Conditions&gt;</span>
</span></span><span><span> 9</span><span>		<span>&lt;/FilePublisherRule&gt;</span>
</span></span><span><span>10</span><span>	<span>&lt;/RuleCollection&gt;</span>
</span></span><span><span>11</span><span><span>&lt;/AppLockerPolicy&gt;</span>
</span></span></code></pre></div><p>Included in MS default rules, here is the resulting xml (called vscode.xml from now on) :</p>
<div><pre tabindex="0"><code data-lang="xml"><span><span> 1</span><span><span>&lt;AppLockerPolicy</span> <span>Version=</span><span>&#34;1&#34;</span><span>&gt;</span>
</span></span><span><span> 2</span><span>  <span>&lt;RuleCollection</span> <span>Type=</span><span>&#34;Appx&#34;</span> <span>EnforcementMode=</span><span>&#34;Enabled&#34;</span> <span>/&gt;</span>
</span></span><span><span> 3</span><span>  <span>&lt;RuleCollection</span> <span>Type=</span><span>&#34;Dll&#34;</span> <span>EnforcementMode=</span><span>&#34;NotConfigured&#34;</span> <span>/&gt;</span>
</span></span><span><span> 4</span><span>  <span>&lt;RuleCollection</span> <span>Type=</span><span>&#34;Exe&#34;</span> <span>EnforcementMode=</span><span>&#34;Enabled&#34;</span><span>&gt;</span>
</span></span><span><span> 5</span><span>    <span>&lt;FilePathRule</span> <span>Id=</span><span>&#34;921cc481-6e17-4653-8f75-050b80acca20&#34;</span> <span>Name=</span><span>&#34;(Default Rule) All files located in the Program Files folder&#34;</span> <span>Description=</span><span>&#34;Allows members of the Everyone group to run applications that are located in the Program Files folder.&#34;</span> <span>UserOrGroupSid=</span><span>&#34;S-1-1-0&#34;</span> <span>Action=</span><span>&#34;Allow&#34;</span><span>&gt;</span>
</span></span><span><span> 6</span><span>      <span>&lt;Conditions&gt;</span>
</span></span><span><span> 7</span><span>        <span>&lt;FilePathCondition</span> <span>Path=</span><span>&#34;%PROGRAMFILES%\*&#34;</span> <span>/&gt;</span>
</span></span><span><span> 8</span><span>      <span>&lt;/Conditions&gt;</span>
</span></span><span><span> 9</span><span>    <span>&lt;/FilePathRule&gt;</span>
</span></span><span><span>10</span><span>    <span>&lt;FilePathRule</span> <span>Id=</span><span>&#34;a61c8b2c-a319-4cd0-9690-d2177cad7b51&#34;</span> <span>Name=</span><span>&#34;(Default Rule) All files located in the Windows folder&#34;</span> <span>Description=</span><span>&#34;Allows members of the Everyone group to run applications that are located in the Windows folder.&#34;</span> <span>UserOrGroupSid=</span><span>&#34;S-1-1-0&#34;</span> <span>Action=</span><span>&#34;Allow&#34;</span><span>&gt;</span>
</span></span><span><span>11</span><span>      <span>&lt;Conditions&gt;</span>
</span></span><span><span>12</span><span>        <span>&lt;FilePathCondition</span> <span>Path=</span><span>&#34;%WINDIR%\*&#34;</span> <span>/&gt;</span>
</span></span><span><span>13</span><span>      <span>&lt;/Conditions&gt;</span>
</span></span><span><span>14</span><span>    <span>&lt;/FilePathRule&gt;</span>
</span></span><span><span>15</span><span>    <span>&lt;FilePathRule</span> <span>Id=</span><span>&#34;fd686d83-a829-4351-8ff4-27c7de5755d2&#34;</span> <span>Name=</span><span>&#34;(Default Rule) All files&#34;</span> <span>Description=</span><span>&#34;Allows members of the local Administrators group to run all applications.&#34;</span> <span>UserOrGroupSid=</span><span>&#34;S-1-5-32-544&#34;</span> <span>Action=</span><span>&#34;Allow&#34;</span><span>&gt;</span>
</span></span><span><span>16</span><span>      <span>&lt;Conditions&gt;</span>
</span></span><span><span>17</span><span>        <span>&lt;FilePathCondition</span> <span>Path=</span><span>&#34;*&#34;</span> <span>/&gt;</span>
</span></span><span><span>18</span><span>      <span>&lt;/Conditions&gt;</span>
</span></span><span><span>19</span><span>    <span>&lt;/FilePathRule&gt;</span>
</span></span><span><span>20</span><span>		<span>&lt;FilePublisherRule</span> <span>Id=</span><span>&#34;1dd70b30-eb06-4220-b808-bd8d368624c0&#34;</span> <span>Name=</span><span>&#34;VScode&#34;</span> <span>Description=</span><span>&#34;&#34;</span> <span>UserOrGroupSid=</span><span>&#34;S-1-5-21-1935059010-3323107334-3352698520-500&#34;</span> <span>Action=</span><span>&#34;Deny&#34;</span><span>&gt;</span>
</span></span><span><span>21</span><span>			<span>&lt;Conditions&gt;</span>
</span></span><span><span>22</span><span>				<span>&lt;FilePublisherCondition</span> <span>PublisherName=</span><span>&#34;O=MICROSOFT CORPORATION, L=REDMOND, S=WASHINGTON, C=US&#34;</span> <span>ProductName=</span><span>&#34;VISUAL STUDIO CODE&#34;</span> <span>BinaryName=</span><span>&#34;*&#34;</span><span>&gt;</span>
</span></span><span><span>23</span><span>					<span>&lt;BinaryVersionRange</span> <span>LowSection=</span><span>&#34;*&#34;</span> <span>HighSection=</span><span>&#34;*&#34;</span> <span>/&gt;</span>
</span></span><span><span>24</span><span>				<span>&lt;/FilePublisherCondition&gt;</span>
</span></span><span><span>25</span><span>			<span>&lt;/Conditions&gt;</span>
</span></span><span><span>26</span><span>		<span>&lt;/FilePublisherRule&gt;</span>
</span></span><span><span>27</span><span>  <span>&lt;/RuleCollection&gt;</span>
</span></span><span><span>28</span><span>  <span>&lt;RuleCollection</span> <span>Type=</span><span>&#34;Msi&#34;</span> <span>EnforcementMode=</span><span>&#34;NotConfigured&#34;</span> <span>/&gt;</span>
</span></span><span><span>29</span><span>  <span>&lt;RuleCollection</span> <span>Type=</span><span>&#34;Script&#34;</span> <span>EnforcementMode=</span><span>&#34;Enabled&#34;</span> <span>/&gt;</span>
</span></span><span><span>30</span><span><span>&lt;/AppLockerPolicy&gt;</span>
</span></span></code></pre></div><p>Unfortunately, this rule won&#39;t apply to code tunnel because this binary doesn&#39;t have a product name (thanks Microsoft !) :</p>
<div><pre tabindex="0"><code data-lang="powershell"><span><span>1</span><span><span>Get-AppLockerFileInformation</span> <span>&#39;C:\Users\ipfyx\AppData\Local\Programs\Microsoft VS Code\bin\code-tunnel.exe&#39;</span> <span>|</span> <span>New-AppLockerPolicy</span> <span>-RuleType</span> <span>Publisher</span> <span>-User</span> <span>S</span><span>-</span><span>1</span><span>-</span><span>1</span><span>-</span><span>0</span> <span>-Optimize</span> <span>-Xml</span>                           
</span></span><span><span>2</span><span><span>New-AppLockerPolicy</span> <span>:</span> <span>Les</span> <span>règles</span> <span>ne</span> <span>peuvent</span> <span>pas</span> <span>être</span> <span>créées</span><span>.</span> <span>Les</span> <span>informations</span> <span>de</span> <span>fichier</span> <span>requises</span> <span>sont</span> <span>absentes</span> <span>dans</span> <span>le</span> <span>fichier</span> <span>suivant</span><span>:</span>
</span></span><span><span>3</span><span><span>%</span><span>OSDRIVE</span><span>%\</span><span>USERS</span><span>\</span><span>ipfyx</span><span>\</span><span>DOWNLOADS</span><span>\</span><span>VSCODE_CLI_WIN32_X64_CLI</span><span>\</span><span>CODE</span><span>.</span><span>EXE</span>
</span></span></code></pre></div><p>To be sure, let&#39;s test the previously generated vscode rule.</p>
<div><pre tabindex="0"><code data-lang="powershell"><span><span> 1</span><span><span># Portable code tunnel is blocked but not by the rule</span>
</span></span><span><span> 2</span><span><span>Test-AppLockerPolicy</span> <span>-XmlPolicy</span> <span>.\</span><span>vscode</span><span>.</span><span>xml</span> <span>-Path</span> <span>.\</span><span>code</span><span>.</span><span>exe</span> <span>-User</span> <span>S</span><span>-</span><span>1</span><span>-</span><span>1</span><span>-</span><span>0</span><span>|</span><span>fl
</span></span></span><span><span> 3</span><span><span></span><span>FilePath</span>       <span>:</span> <span>C:</span><span>\</span><span>Users</span><span>\</span><span>ipfyx</span><span>\</span><span>Downloads</span><span>\</span><span>vscode_cli_win32_x64_cli</span><span>\</span><span>code</span><span>.</span><span>exe</span>
</span></span><span><span> 4</span><span><span>PolicyDecision</span> <span>:</span> <span>DeniedByDefault</span>
</span></span><span><span> 5</span><span><span>MatchingRule</span>   <span>:</span>
</span></span><span><span> 6</span><span>
</span></span><span><span> 7</span><span><span># Code tunnel is blocked but not by the rule</span>
</span></span><span><span> 8</span><span><span>Test-AppLockerPolicy</span> <span>-XmlPolicy</span> <span>.\</span><span>vscode</span><span>.</span><span>xml</span> <span>-Path</span> <span>&#39;C:\Users\ipfyx\AppData\Local\Programs\Microsoft VS Code\bin\code-tunnel.exe&#39;</span> <span>-User</span> <span>S</span><span>-</span><span>1</span><span>-</span><span>1</span><span>-</span><span>0</span><span>|</span><span>fl
</span></span></span><span><span> 9</span><span><span></span><span>FilePath</span>       <span>:</span> <span>C:</span><span>\</span><span>Users</span><span>\</span><span>ipfyx</span><span>\</span><span>AppData</span><span>\</span><span>Local</span><span>\</span><span>Programs</span><span>\</span><span>Microsoft</span> <span>VS</span> <span>Code</span><span>\</span><span>bin</span><span>\</span><span>code-tunnel</span><span>.</span><span>exe</span>
</span></span><span><span>10</span><span><span>PolicyDecision</span> <span>:</span> <span>DeniedByDefault</span>
</span></span><span><span>11</span><span><span>MatchingRule</span>   <span>:</span>
</span></span><span><span>12</span><span>
</span></span><span><span>13</span><span><span># VScode is blocked by the rule</span>
</span></span><span><span>14</span><span><span>Test-AppLockerPolicy</span> <span>-XmlPolicy</span> <span>.\</span><span>vscode</span><span>.</span><span>xml</span> <span>-Path</span> <span>&#39;C:\Users\ipfyx\AppData\Local\Programs\Microsoft VS Code\Code.exe&#39;</span> <span>-User</span> <span>S</span><span>-</span><span>1</span><span>-</span><span>1</span><span>-</span><span>0</span><span>|</span><span>fl
</span></span></span><span><span>15</span><span><span></span><span>FilePath</span>       <span>:</span> <span>C:</span><span>\</span><span>Users</span><span>\</span><span>ipfyx</span><span>\</span><span>AppData</span><span>\</span><span>Local</span><span>\</span><span>Programs</span><span>\</span><span>Microsoft</span> <span>VS</span> <span>Code</span><span>\</span><span>Code</span><span>.</span><span>exe</span>
</span></span><span><span>16</span><span><span>PolicyDecision</span> <span>:</span> <span>Denied</span>
</span></span><span><span>17</span><span><span>MatchingRule</span>   <span>:</span> <span>VScode</span>
</span></span></code></pre></div><p>The <em>PolicyDecision</em> is <em>DeniedByDefault</em>, which means the rule we just built from the vscode binary does not apply to code-tunnel. If no rules matches, the default behaviour for applocker is to deny any execution.
Code-tunnel is denied there, but it would not be if it was placed in the allowed directories. It could be placed there by an attacker or by a legitimate vscode, installed by an admin.</p>
<p>A solution could be to use a Hash Condition.</p>
<div><pre tabindex="0"><code data-lang="powershell"><span><span>1</span><span><span># Export</span>
</span></span><span><span>2</span><span><span>Get-AppLockerFileInformation</span> <span>.\</span><span>code</span><span>.</span><span>exe</span> <span>|</span> <span>New-AppLockerPolicy</span> <span>-RuleType</span> <span>Hash</span> <span>-User</span> <span>S</span><span>-</span><span>1</span><span>-</span><span>1</span><span>-</span><span>0</span> <span>-Optimize</span> <span>-Xml</span> <span>&gt;</span> <span>.\</span><span>vscode-tunnel</span><span>-hash</span><span>.</span><span>xml</span>
</span></span><span><span>3</span><span>
</span></span><span><span>4</span><span><span># Code tunnel is blocked</span>
</span></span><span><span>5</span><span><span>Test-AppLockerPolicy</span> <span>-XmlPolicy</span> <span>.\</span><span>vscode-tunnel</span><span>-hash</span><span>.</span><span>xml</span> <span>-Path</span> <span>&#39;C:\Users\ipfyx\AppData\Local\Programs\Microsoft VS Code\bin\code-tunnel.exe&#39;</span> <span>-User</span> <span>S</span><span>-</span><span>1</span><span>-</span><span>1</span><span>-</span><span>0</span><span>|</span><span>fl
</span></span></span><span><span>6</span><span><span></span><span>FilePath</span>       <span>:</span> <span>C:</span><span>\</span><span>Users</span><span>\</span><span>ipfyx</span><span>\</span><span>AppData</span><span>\</span><span>Local</span><span>\</span><span>Programs</span><span>\</span><span>Microsoft</span> <span>VS</span> <span>Code</span><span>\</span><span>bin</span><span>\</span><span>code-tunnel</span><span>.</span><span>exe</span>
</span></span><span><span>7</span><span><span>PolicyDecision</span> <span>:</span> <span>Denied</span>
</span></span><span><span>8</span><span><span>MatchingRule</span>   <span>:</span> <span>code</span><span>.</span><span>exe</span>
</span></span></code></pre></div><p><SPAN color="red">Warning : Do not import the following xml in Applocker. Imported alone, this rule will completely block your system. Add a Allow * rule beforehand</SPAN></p>
<div><pre tabindex="0"><code data-lang="xml"><span><span> 1</span><span><span>&lt;AppLockerPolicy</span> <span>Version=</span><span>&#34;1&#34;</span><span>&gt;</span>
</span></span><span><span> 2</span><span>	<span>&lt;RuleCollection</span> <span>Type=</span><span>&#34;Exe&#34;</span> <span>EnforcementMode=</span><span>&#34;NotConfigured&#34;</span><span>&gt;</span>
</span></span><span><span> 3</span><span>		<span>&lt;FileHashRule</span> <span>Id=</span><span>&#34;15b4ef38-5f18-484b-bc83-e03d24076a0d&#34;</span> <span>Name=</span><span>&#34;code.exe&#34;</span> <span>Description=</span><span>&#34;&#34;</span> <span>UserOrGroupSid=</span><span>&#34;S-1-1-0&#34;</span> <span>Action=</span><span>&#34;Deny&#34;</span><span>&gt;</span>
</span></span><span><span> 4</span><span>			<span>&lt;Conditions&gt;</span>
</span></span><span><span> 5</span><span>				<span>&lt;FileHashCondition&gt;</span>
</span></span><span><span> 6</span><span>					<span>&lt;FileHash</span> <span>Type=</span><span>&#34;SHA256&#34;</span> <span>Data=</span><span>&#34;0xAC60D7CA817ED4BEF562D07DEB4BE730413BD23B3ABFE0DFC78B1DDC866F85BA&#34;</span> <span>SourceFileName=</span><span>&#34;code.exe&#34;</span> <span>SourceFileLength=</span><span>&#34;16738736&#34;</span> <span>/&gt;</span>
</span></span><span><span> 7</span><span>				<span>&lt;/FileHashCondition&gt;</span>
</span></span><span><span> 8</span><span>			<span>&lt;/Conditions&gt;</span>
</span></span><span><span> 9</span><span>		<span>&lt;/FileHashRule&gt;</span>
</span></span><span><span>10</span><span>	<span>&lt;/RuleCollection&gt;</span>
</span></span><span><span>11</span><span><span>&lt;/AppLockerPolicy&gt;</span>
</span></span></code></pre></div><p>But this solution is nor resilient nor sustainable since the hash can change at the first update.</p>
<h3 id="gpo">GPO</h3>
<p><a href="https://learn.microsoft.com/en-us/visualstudio/install/administrative-templates?view=vs-2022#acquiring-the-visual-studio-administrative-template-admx">Visual Studio</a> has the so wanted features :</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>1</span><span>- Dev Tunnels - controls test functionality
</span></span></code></pre></div><p>But as of today (1.8.82), VScode doesn&#39;t. You can force automatic updates though ! UpdateMode_default would be my goto.</p>
<div><pre tabindex="0"><code data-lang="powershell"><span><span>1</span><span><span>gc </span><span>&#39;C:\Users\ipfyx\AppData\Local\Programs\Microsoft VS Code\policies\en-us\VSCode.adml&#39;</span>
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="xml"><span><span> 1</span><span><span>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span><span> 2</span><span><span>&lt;policyDefinitionResources</span> <span>revision=</span><span>&#34;1.0&#34;</span> <span>schemaVersion=</span><span>&#34;1.0&#34;</span><span>&gt;</span>
</span></span><span><span> 3</span><span>        <span>&lt;displayName</span> <span>/&gt;</span>
</span></span><span><span> 4</span><span>        <span>&lt;description</span> <span>/&gt;</span>
</span></span><span><span> 5</span><span>        <span>&lt;resources&gt;</span>
</span></span><span><span> 6</span><span>                <span>&lt;stringTable&gt;</span>
</span></span><span><span> 7</span><span>                        <span>&lt;string</span> <span>id=</span><span>&#34;Application&#34;</span><span>&gt;</span>Visual Studio Code<span>&lt;/string&gt;</span>
</span></span><span><span> 8</span><span>                        <span>&lt;string</span> <span>id=</span><span>&#34;Supported_1_67&#34;</span><span>&gt;</span>Visual Studio Code <span>&amp;gt;</span>= 1.67<span>&lt;/string&gt;</span>
</span></span><span><span> 9</span><span>                        <span>&lt;string</span> <span>id=</span><span>&#34;Category_updateConfigurationTitle&#34;</span><span>&gt;</span>Update<span>&lt;/string&gt;</span>
</span></span><span><span>10</span><span>                        <span>&lt;string</span> <span>id=</span><span>&#34;UpdateMode&#34;</span><span>&gt;</span>UpdateMode<span>&lt;/string&gt;</span>
</span></span><span><span>11</span><span>                        <span>&lt;string</span> <span>id=</span><span>&#34;UpdateMode_updateMode&#34;</span><span>&gt;</span>Configure whether you receive automatic updates. Requires a restart after change. The updates are fetched from a Microsoft online service.<span>&lt;/string&gt;</span>
</span></span><span><span>12</span><span>                        <span>&lt;string</span> <span>id=</span><span>&#34;UpdateMode_none&#34;</span><span>&gt;</span>Disable updates.<span>&lt;/string&gt;</span>
</span></span><span><span>13</span><span>                        <span>&lt;string</span> <span>id=</span><span>&#34;UpdateMode_manual&#34;</span><span>&gt;</span>Disable automatic background update checks. Updates will be available if you manually check for updates.<span>&lt;/string&gt;</span>
</span></span><span><span>14</span><span>                        <span>&lt;string</span> <span>id=</span><span>&#34;UpdateMode_start&#34;</span><span>&gt;</span>Check for updates only on startup. Disable automatic background update checks.<span>&lt;/string&gt;</span>
</span></span><span><span>15</span><span>                        <span>&lt;string</span> <span>id=</span><span>&#34;UpdateMode_default&#34;</span><span>&gt;</span>Enable automatic update checks. Code will check for updates automatically and periodically.<span>&lt;/string&gt;</span>
</span></span><span><span>16</span><span>                <span>&lt;/stringTable&gt;</span>
</span></span><span><span>17</span><span>                <span>&lt;presentationTable&gt;</span>
</span></span><span><span>18</span><span>                        <span>&lt;presentation</span> <span>id=</span><span>&#34;UpdateMode&#34;</span><span>&gt;&lt;dropdownList</span> <span>refId=</span><span>&#34;UpdateMode&#34;</span> <span>/&gt;&lt;/presentation&gt;</span>
</span></span><span><span>19</span><span>                <span>&lt;/presentationTable&gt;</span>
</span></span><span><span>20</span><span>        <span>&lt;/resources&gt;</span>
</span></span><span><span>21</span><span><span>&lt;/policyDefinitionResources&gt;</span>
</span></span></code></pre></div><h2 id="detection">Detection</h2>
<h3 id="process">Process</h3>
<h4 id="looking-for-code-tunnel-execution">Looking for code-tunnel execution</h4>
<p>A simple detection could be :</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>1</span><span>index=win sourcetype=&#34;XmlWinEventLog&#34; EventCode=4688 code tunnel cmdline=&#34;*code*.exe*tunnel*&#34;
</span></span><span><span>2</span><span>| stats min(_time) as time_min max(_time) as time_max count as occurence values(NewProcess) as NewProcess values(ParentProcess) as ParentProcess values(CommandLine) as CommandLine by host, SubjectUser file_name
</span></span></code></pre></div><table>
<thead>
<tr>
<th>host</th>
<th>SubjectUser</th>
<th>cmdline</th>
<th>file_name</th>
<th>time_min</th>
<th>time_max</th>
<th>occurence</th>
<th>NewProcess</th>
<th>ParentProcess</th>
</tr>
</thead>
<tbody>
<tr>
<td>sauteTomate</td>
<td>ipfyx</td>
<td>&#34;c:\Users\ipfyx\AppData\Local\Programs\Microsoft VS Code\bin\code-tunnel&#34; tunnel --accept-server-license-terms --name totallyNotSuspicious</td>
<td>code-tunnel.exe</td>
<td>2023-09-18 11:31:54</td>
<td>2023-09-18 11:31:54</td>
<td>1</td>
<td>C:\Users\ipfyx\AppData\Local\Programs\Microsoft VS Code\code-tunnel.exe</td>
<td>C:\Windows\System32\cmd.exe</td>
</tr>
</tbody>
</table>
<p>But the binary <em>code.exe</em> could be renamed. However, what an attacker can&#39;t change are the <em>tunnel</em> and <em>--accept-server-license-terms</em> options :</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>1</span><span>index=win sourcetype=&#34;XmlWinEventLog&#34; EventCode=4688 tunnel accept server license terms cmdline=&#34;*.exe*tunnel*--accept-server-license-terms*&#34;
</span></span><span><span>2</span><span>| stats min(_time) as time_min max(_time) as time_max count as occurence values(NewProcess) as NewProcess values(ParentProcess) as ParentProcess values(CommandLine) as CommandLine by host, SubjectUser file_name
</span></span></code></pre></div><table>
<thead>
<tr>
<th>host</th>
<th>SubjectUser</th>
<th>cmdline</th>
<th>file_name</th>
<th>time_min</th>
<th>time_max</th>
<th>occurence</th>
<th>NewProcess</th>
<th>ParentProcess</th>
</tr>
</thead>
<tbody>
<tr>
<td>sauteTomate</td>
<td>ipfyx</td>
<td>&#34;c:\Users\ipfyx\AppData\Local\Programs\Microsoft VS Code\bin\c0de.exe&#34; tunnel --accept-server-license-terms --name totallyNotSuspicious</td>
<td>c0de.exe</td>
<td>2023-09-18 11:35:54</td>
<td>2023-09-18 11:35:54</td>
<td>1</td>
<td>C:\Users\ipfyx\AppData\Local\Programs\Microsoft VS Code\c0de.exe</td>
<td>C:\Windows\System32\cmd.exe</td>
</tr>
<tr>
<td>sauteTomate</td>
<td>ipfyx</td>
<td>&#34;c:\Users\ipfyx\AppData\Local\Programs\Microsoft VS Code\bin\code-tunnel&#34; tunnel --accept-server-license-terms --name totallyNotSuspicious</td>
<td>code-tunnel.exe</td>
<td>2023-09-18 11:31:54</td>
<td>2023-09-18 11:31:54</td>
<td>1</td>
<td>C:\Users\ipfyx\AppData\Local\Programs\Microsoft VS Code\code-tunnel.exe</td>
<td>C:\Windows\System32\cmd.exe</td>
</tr>
</tbody>
</table>
<p>If you use sysmon, you can switch to EventCode=1 and Sysmon sourcetype instead of EventCode 4688.</p>
<h4 id="looking-for-suspicious-child-process">Looking for suspicious child process</h4>
<p>Great idea from <a href="https://lolbas-project.github.io/lolbas/HonorableMentions/Code/">lobas</a> :</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>1</span><span>IOC: Process tree: code.exe -&gt; cmd.exe -&gt; node.exe -&gt; winpty-agent.exe
</span></span></code></pre></div><p>A straightforward search would be :</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>1</span><span>index=win sourcetype=&#34;XmlWinEventLog&#34; EventCode=4688 code (cmd OR powershell) ParentProcess=&#34;*code-tunnel.exe&#34; NewProcess IN (&#34;*cmd*&#34;, &#34;*powershell*&#34;)
</span></span><span><span>2</span><span>| table _time, host, NewProcess, ParentProcess
</span></span></code></pre></div><p>But once again, <em>code.exe</em> could be renamed</p>
<p>We could use the search above to look for suspicious child process from our process with <em>accept-server-license-terms</em> option :</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>1</span><span>index=win sourcetype=&#34;XmlWinEventLog&#34; EventCode=4688 (cmd OR powershell) ParentProcess=&#34;*code*.exe&#34; NewProcess IN (&#34;*cmd*&#34;, &#34;*powershell*&#34;)
</span></span><span><span>2</span><span>    [search index=win sourcetype=&#34;XmlWinEventLog&#34; EventCode=4688 tunnel accept server license terms CommandLine=&#34;*.exe*tunnel*--accept-server-license-terms*&#34;
</span></span><span><span>3</span><span>    | table host NewProcessId
</span></span><span><span>4</span><span>    | rename NewProcessId as ParentProcessId
</span></span><span><span>5</span><span>    | format]
</span></span><span><span>6</span><span>| table _time, host, NewProcess, ParentProcess
</span></span></code></pre></div><table>
<thead>
<tr>
<th>_time</th>
<th>host</th>
<th>NewProcess</th>
<th>ParentProcess</th>
</tr>
</thead>
<tbody>
<tr>
<td>2023-09-18 11:36:21</td>
<td>sauteTomate</td>
<td>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</td>
<td>c:\Users\ipfyx\AppData\Local\Programs\Microsoft VS Code\bin\c0de.exe</td>
</tr>
</tbody>
</table>
<h3 id="file-creation">File creation</h3>
<p>Another great idea from <a href="https://lolbas-project.github.io/lolbas/HonorableMentions/Code/">lobas</a> :</p>
<p><code>IOC: File write of code_tunnel.json which is parametizable, but defaults to: %UserProfile%\.vscode-cli\code_tunnel.json</code></p>
<p><em>license_consent.json</em> file could also be watched.</p>
<div><pre tabindex="0"><code data-lang="powershell"><span><span>1</span><span><span>PS </span><span>&gt;</span> <span>gc </span><span>C:</span><span>\</span><span>Users</span><span>\</span><span>ipfyx</span><span>\.</span><span>vscode</span><span>\</span><span>cli</span><span>\</span><span>code_tunnel</span><span>.</span><span>json</span>
</span></span><span><span>2</span><span><span>{</span><span>&#34;name&#34;</span><span>:</span><span>&#34;sauceTomate&#34;</span><span>,</span><span>&#34;id&#34;</span><span>:</span><span>&#34;9s43zAc9&#34;</span><span>,</span><span>&#34;cluster&#34;</span><span>:</span><span>&#34;uks1&#34;</span><span>}</span>
</span></span><span><span>3</span><span><span>PS </span><span>&gt;</span> <span>gc </span><span>C:</span><span>\</span><span>Users</span><span>\</span><span>ipfyx</span><span>\.</span><span>vscode</span><span>\</span><span>cli</span><span>\</span><span>license_consent</span><span>.</span><span>json</span>
</span></span><span><span>4</span><span><span>{</span><span>&#34;consented&#34;</span><span>:</span><span>true</span><span>}</span>
</span></span></code></pre></div><p>I do not have sysmon EventCode 11 yet, so I will leave the SPL search as an exercise for the user. Watching for those files creation inside the UserProfile directory is not enough since it can be changed with the <em>--cli-data-dir</em> option.</p>
<div><pre tabindex="0"><code data-lang="powershell"><span><span>1</span><span><span>.\</span><span>code</span><span>.</span><span>exe</span> <span>tunnel</span> <span>help</span>
</span></span><span><span>2</span><span><span>...</span>
</span></span><span><span>3</span><span><span>GLOBAL</span> <span>OPTIONS</span><span>:</span>
</span></span><span><span>4</span><span>      <span>-</span><span>-cli-data-dir</span> <span>&lt;</span><span>CLI_DATA_DIR</span><span>&gt;</span>  <span>Directory</span> <span>where CLI </span><span>metadata</span> <span>should</span> <span>be</span> <span>stored</span> <span>[</span><span>env</span><span>:</span> <span>VSCODE_CLI_DATA_DIR</span><span>=]</span>
</span></span></code></pre></div><h3 id="web-traffic-monitoring">Web traffic monitoring</h3>
<p>If you haven&#39;t blocked the domains I mentioned earlier, watch out for any HTTP traffic toward those domains.</p>
<h2 id="conclusion">Conclusion</h2>
<p>A GPO parameter would be awesome but it is yet to be seen. An Applocker hash rule is not sustainable. Moreover, your non-domain-joined computers would not be concerned by neither of them. Therefore, for now, we are only left to blocking those two bad boys :</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>1</span><span>*.tunnels.api.visualstudio.com
</span></span><span><span>2</span><span>*.devtunnels.ms
</span></span></code></pre></div>
    </div></div>
  </body>
</html>
