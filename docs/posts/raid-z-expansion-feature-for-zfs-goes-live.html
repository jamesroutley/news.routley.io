<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://freebsdfoundation.org/blog/raid-z-expansion-feature-for-zfs-goes-live/">Original</a>
    <h1>Raid-Z Expansion Feature for ZFS Goes Live</h1>
    
    <div id="readability-page-1" class="page"><div>
            <div>
              
<article id="post-10949">
  <!-- .post-header -->

  
  <div>
    <h5>February 7, 2022</h5><section>
<h3>How it works</h3>
</section>

<section>
<p>The feature reflows existing data, essentially rewriting it onto a new arrangement of disks – meaning the original group plus a newly added disk. In so doing, a new adjacent chunk of free space is created at the end of the logical RAID-Z group and thus at the end of each physical disk. </p>
</section>

<section>
<p>The reflowed data retains the original logical stripe width, meaning the ratio of data to parity will remain the same. Newly written data will use the new logical stripe width with an improved data to parity ratio.  The reflow happens online, while other zfs and zpool operations are also in progress.</p>
</section>

<section>
<p>Expansions can be made multiple times. However, pools must be healthy and if a disk were to die, the process will pause to allow for it to be reconstructed. It works with RAIDZ-1/2/3.</p>
</section>

<section>
<p>Below are two figures illustrating the difference in how traditional expansion of RAID 4/5/6 works (Fig 1) versus how this new RAID-Z Expansion Feature works (Fig2).</p>
</section>

<section>
<h4>Figure 1:</h4>
</section>

<section>
<figure><img src="https://lh5.googleusercontent.com/y7OwejZNQAaNrLXVL-k60PZk78PmkZz7VIF4mHvLXG2m_nJ8tHhrLBstBO3xZYkRDZ0XZ1nmZs-lIh94TWat9WQozflZDiK1Zw0CrEJn26UP4z48VYJvaDkEmmhp6Y912yDbw7o" alt=""/></figure>
</section>

<section>
<p>Reflowing data doesn’t change or read block pointers. Reads and writes are performed sequentially. Spacemaps reveal what data needs to be copied. Last but not least, each logical stripe is independent making it unnecessary to know where parity is. Segments are still stored on different disks which preserves redundancy.</p>
</section>

<section>
<h4>Figure 2: </h4>
</section>

<section>
<figure><img src="https://lh4.googleusercontent.com/UDEC2zM7E10hnPITO3kJU4pI0Npo0IZPr7nRhFIWzdejjmkIQUmUjqpLuWscvOX_1wgn4Rfsdbq8paOrr_k5RHhQek5GLjPaizzmqqxykvoDM658uLZEAVdY56BcRhkcZTlezbE" alt=""/></figure>
</section>

<section>

</section>

<section>
<h4>How to use it:</h4>
</section>

<section>
<p>Start with the command:</p>
</section>

<section>
<p><code>+ zpool attach test raidz2-0 /var/tmp/6</code></p>
</section>

<section>
<p><strong>In this command example </strong>“<code>zpool attach</code>” means attach a disk to the pool and “test” is the name of the pool. The name of the existing raidz vdev is “<code>raidz2-0</code>” and “<code>/var/tmp/6</code>” is the name of the new disk. That looks a little different than disk names in production. The point here is to show placement in the command line for the actual name of the disk.</p>
</section>

<section>
<h4>Figure 3</h4>
</section>

<section>
<p><img loading="lazy" width="623" height="309" src="https://lh5.googleusercontent.com/Azyb0HEIpr9qpH1pFhCTOdgDkULYIo-7E7EVnr0J3EpdCfw452YEjR0kAuPI0ddkwDp2x5LH2plkyv0A4kuocdFodKTEj2dZxmUpv7e5EZu2BKbUVYblUEgxvCcWi-xRgmFLMwE"/></p>
</section>

<section>
<p>Expect it to take a while as it has to move the data around on the disks.  This line will report the progress it is making for you:</p>
</section>

<section>
<p><code>“raidz expand: Expansion of vdev 0 in progress since Wed Jun  9 16:36:19 2021</code></p>
</section>

<section>
<p><code>    444M copied out of 4.29G at 22.2M/s, 10.12% done, 0h2m to go”</code></p>
</section>

<section>
<p>It will also tell you when the action is completed: </p>
</section>

<section>
<p><code>“raidz expand: Expansion of vdev 0 copied 4.27G in 0h3m, completed on Wed Jun  9 16:39:31 2021”</code></p>
</section>

<section>
<p>Now more space is available:</p>
</section>

<section>
<h4>Figure 4</h4>
</section>

<section>
<div><figure><img src="https://lh6.googleusercontent.com/SQ4_NjAO0x39OhsbacwbB36GiiwDNdRFroWbqZVdvSaZqeEo-EojRFlefPkkILiahVZwvKeFymiK-yFwh1eih7S1S3lAfmaW2VPqM2VlH30_Kv7U53vyOBfpv5aEhRj38-IvxUg" alt=""/></figure></div>
</section>

<section>

</section>

<section>
<h4>The status report</h4>
</section>

<section>
<p>While all capabilities of this feature have been implemented and all tests so far have been passed, there are still a few loose ends to tie up. Specifically, there is some code cleanup to do, some verbose logging to remove, some code documentation to write, and similar relatively minor tasks. We aim for this to be integrated by Q3.</p>
</section>

<section>
<p>But the biggest need for additional help is in testing the feature further and in doing a code review before this feature can be integrated. </p>
</section><p><span><a href="https://freebsdfoundation.org/blog/2021-freebsd-foundation-impact-report/" rel="prev">Previous</a></span><span></span>  </p></div><!-- .post-content -->

</article><!-- #post-10949 -->
            </div><!-- content -->
          </div></div>
  </body>
</html>
