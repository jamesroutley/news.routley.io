<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://vermaden.wordpress.com/2023/06/28/freebsd-jails-containers/">Original</a>
    <h1>FreeBSD Jails Containers</h1>
    
    <div id="readability-page-1" class="page"><div>
			<p>FreeBSD networking and containers (Jails) stacks are very mature and provide lots of useful features â€¦ yet for some reason these features are not properly advertised by the FreeBSD project â€¦ or not even documented at all. I remember when Solaris was still under Sun before â€˜fatalâ€™ 2008 Oracle acquisition and one of the advertised Solaris features was its networking capabilities â€“ along with virtual switches etc. that were administrated with the <tt><b>ipadm(1M)</b></tt> and <tt><b>dladm(1M)</b></tt> commands. FreeBSD while having technologies like Netgraph or Jails lightweight containers â€“ along with VNET Jails that have full independent of the host virtual network stack â€¦ almost does not advertise them at all. The VNET Jails â€“ while being production ready and used by thousands of sysadmins â€“ are still not documented in the FreeBSD Handbook or FreeBSD FAQ at all â€¦ you will not be able to find a single VNET mention in the FreeBSD Handbook. Even the FreeBSD Man Pages like <tt><b>jail.conf(5)</b></tt> does not mention it â€“ only <tt><b>jail(8)</b></tt>partially mentions VNET feature.</p>
<p>There are however two <a href="https://vermaden.wordpress.com/2022/02/04/books-about-freebsd/">FreeBSD Books</a> dedicated to Jails â€¦ one free <i>FreeBSD Jails Using VNETs</i> (from 2020) and one non-free <i>FreeBSD Mastery â€“ Jails</i> (from 2019).</p>
<p>The <i>Table of Contents</i> for this article is:</p>
<ul>
<li><strong>FreeBSD Host Setup</strong></li>
<li><strong>Classic Jails</strong></li>
<li><strong>VNET Jails</strong></li>
<li><strong>Thin Provisioning Jails</strong></li>
<li><strong>Single Process Jails</strong></li>
<li><strong>Removing Jails</strong></li>
<li><strong>Summary</strong></li>
</ul>
<p>This guide aims to make VNET Jails networking little closer and simple. While one can use Netgraph bridge for this purpose â€“ we will use the simpler and more obvious classic network bridge supported by <tt><b>if_bridge(4)</b></tt> driver on FreeBSD. I also encourage you to check the <a href="https://docs.freebsd.org/en/books/handbook/jails/">FreeBSD Handbook â€“ Jails</a> chapter.</p>
<p><img data-attachment-id="5058" data-permalink="https://vermaden.wordpress.com/2023/06/28/freebsd-jails-containers/jails/" data-orig-file="https://vermaden.files.wordpress.com/2023/06/jails.png" data-orig-size="920,1020" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="jails" data-image-description="" data-image-caption="" data-medium-file="https://vermaden.files.wordpress.com/2023/06/jails.png?w=271" data-large-file="https://vermaden.files.wordpress.com/2023/06/jails.png?w=920" src="https://vermaden.files.wordpress.com/2023/06/jails.png?w=960" alt="jails" srcset="https://vermaden.files.wordpress.com/2023/06/jails.png 920w, https://vermaden.files.wordpress.com/2023/06/jails.png?w=135 135w, https://vermaden.files.wordpress.com/2023/06/jails.png?w=271 271w, https://vermaden.files.wordpress.com/2023/06/jails.png?w=768 768w" sizes="(max-width: 920px) 100vw, 920px"/></p>

<p>The first thing we will do is to prepare the host networking. This is the typical static network configuration on FreeBSD with single IPv4 IP address without any VLANs in <tt><b>/etc/rc.conf</b></tt> file. We will also enable the Jails subsystem.</p>
<pre><strong>host # <span>cat /etc/rc.conf</span></strong>
# NETWORK
  hostname=&#34;host&#34;
  ifconfig_em0=&#34;inet 20.0.0.20/24&#34;
  defaultrouter=&#34;20.0.0.1&#34;

# JAILS
  jail_enable=&#34;YES&#34;
  jail_parallel_start=&#34;YES&#34;
  jail_list=&#34;classic vnet shadow&#34;
</pre>
<p>With that setup â€“ your classic Jails will be able to connect to the outside World.</p>
<p>It can be visualized more or less like that.</p>
<pre>              +--------+    +-----------------+
              |GATEWAY |    |<strong>20.0.0.20</strong>    HOST|
(Internet)&lt;==&gt;|        |&lt;==&gt;|em0              |
              |<strong>20.0.0.1</strong>|    |                 |
              +--------+    +-----------------+
</pre>
<p>Below we will create a classic Jail for a start. Each such setup requires certain decisions to be made â€“ one of them will be using <tt><b>/jail</b></tt> as our Jails root.</p>
<p>We will create one with ZFS datasets now.</p>
<pre><strong>host # <span>zfs create -o mountpoint=/jail -p zroot/jail</span></strong>
<strong>host # <span>zfs create                     -p zroot/jail/BASE</span></strong>
<strong>host # <span>zfs create                     -p zroot/jail/classic
</span></strong></pre>
<p>I have also create <tt><b>/jail/BASE</b></tt> and <tt><b>/jail/classic</b></tt> dirs. The first one will be used as a placeholder for various FreeBSD versions <tt><b>*-base.txz</b></tt> files. The latter will be used for our â€˜classicâ€™ FreeBSD Jail.</p>
<pre><strong>host # <span>find /jail -maxdepth 1</span></strong>
/jail
/jail/BASE
/jail/classic
</pre>

<p>I will be using FreeBSD 13.2-RELEASE for the <tt><b>host</b></tt> system so this is the Jail version I would use for â€˜classicâ€™ Jail.</p>
<pre><strong>host # <span>fetch -o /jail/BASE/13.2-RELEASE-base.txz http://ftp.freebsd.org/pub/FreeBSD/releases/amd64/13.2-RELEASE/base.txz
</span></strong></pre>
<p>The FreeBSD host can run any other FreeBSD as long as its not newer then the host system version. That means that while we use FreeBSD 13.2-RELEASE you are able to run and consolidate a farm of any older FreeBSD version â€“ along with legendary 4.11-RELEASE â€¦ or one of the most problematic 5.0-RELEASE that was the first one that introduced the SMP with its M:N model.</p>
<p>We will now create the â€˜classicâ€™ Jail.</p>
<pre><strong>host # <span>tar -xf /jail/BASE/13.2-RELEASE-base.txz -C /jail/classic --unlink
</span></strong></pre>
<p>We will now create our â€˜classicâ€™ Jail configuration. Usually the <tt><b>jail.conf(5)</b></tt> file is used for that â€¦ but as you grow more Jails it becomes less practical to scroll through this file to â€˜findâ€™ your desired Jail that you want to modify. This is where the <tt><b>/etc/jail.conf.d</b></tt> dir comes handy. You will be able to place each Jail config as <tt><b>/etc/jail.conf.d/JAILNAME.conf</b></tt> file. This is what we will use here â€“ leaving <tt><b>/etc/jail.conf</b></tt> file empty or non-existent.</p>
<p>This is the config we will use for the â€˜classicâ€™ Jail.</p>
<pre><strong>host # <span>cat /etc/jail.conf.d/classic.conf</span></strong>
classic {
  # STARTUP/LOGGING
    exec.start = &#34;/bin/sh /etc/rc&#34;;
    exec.stop  = &#34;/bin/sh /etc/rc.shutdown&#34;;
    exec.consolelog = &#34;/var/log/jail_console_${name}.log&#34;;

  # PERMISSIONS
    allow.raw_sockets;
    exec.clean;

  # PATH/HOSTNAME
    path = &#34;/jail/${name}&#34;;
    host.hostname = &#34;${name}&#34;;

  # NETWORK
    ip4.addr = 20.0.0.50;
    interface = em0;
}
</pre>
<p>Now we will start that Jail.</p>
<pre><strong>host # <span>service jail start classic</span></strong>
Starting jails: classic.

<strong>host # <span>jls</span></strong>
   JID  IP Address      Hostname                      Path
    31  20.0.0.50       classic                       /jail/classic
</pre>
<p>Our â€˜classicâ€™ Jail successfully started.</p>
<p>The <tt><b>20.0.0.50</b></tt> IP address was added to the host <tt><b>em0</b></tt> interface as shown below.</p>
<pre><strong>host # <span>ifconfig em0</span></strong>
em0: flags=8963&lt;UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        options=481009b&lt;RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,VLAN_HWFILTER,NOMAP&gt;
        ether 08:00:27:09:cc:a8
        inet 20.0.0.20/24 broadcast 20.0.0.255
        inet 20.0.0.50/32 broadcast 20.0.0.50
        media: Ethernet autoselect (1000baseT &lt;full-duplex&gt;)
        status: active
        nd6 options=29&lt;PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL&gt;
</pre>
<p>It can be visualized like that.</p>
<pre>              +--------+    +-----------------------------+
              |GATEWAY |    |<strong>20.0.0.20</strong>                HOST|
(Internet)&lt;==&gt;|        |&lt;==&gt;|em0          +-------------+ |
              |<strong>20.0.0.1</strong>|    |<strong>20.0.0.50</strong>&lt;==&gt;|____jail0____| |
              +--------+    |<strong>20.0.0.51</strong>&lt;==&gt;|____jail1____| |
                            |(.......)&lt;==&gt;|    (...)    | |
                            |             +-------------+ |
                            +-----------------------------+
</pre>
<p>We can also <tt><b>ping(8)</b></tt> the Jail IP address from the host system.</p>
<pre><strong>host # <span>ping -c 3 20.50</span></strong>
PING 20.50 (20.0.0.50): 56 data bytes
64 bytes from 20.0.0.50: icmp_seq=0 ttl=64 time=0.114 ms
64 bytes from 20.0.0.50: icmp_seq=1 ttl=64 time=0.049 ms
64 bytes from 20.0.0.50: icmp_seq=2 ttl=64 time=0.046 ms

--- 20.50 ping statistics ---
3 packets transmitted, 3 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.046/0.069/0.114/0.031 ms
</pre>
<p>Lets login into the â€˜classicâ€™ Jail.</p>
<pre><strong>host # <span>jls</span></strong>
   JID  IP Address      Hostname                      Path
     1  20.0.0.50       classic                       /jail/classic

<strong>host # <span>jexec classic</span></strong>

<strong>root@classic:/ # <span>hostname</span></strong>
classic
</pre>
<p>Inside the â€˜classicâ€™ Jail we are able to <tt><b>ping(8)</b></tt> the host gateway.</p>
<pre><strong>root@classic:/ # <span>ping -c 3 20.1</span></strong>
PING 20.1 (20.0.0.1): 56 data bytes
64 bytes from 20.0.0.1: icmp_seq=0 ttl=255 time=0.083 ms
64 bytes from 20.0.0.1: icmp_seq=1 ttl=255 time=0.314 ms
64 bytes from 20.0.0.1: icmp_seq=2 ttl=255 time=0.256 ms

--- 20.1 ping statistics ---
3 packets transmitted, 3 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.083/0.218/0.314/0.098 ms
</pre>
<p>We can also reach outside World popular DNS public servers.</p>
<pre><strong>root@classic:/ # <span>nc -v -u 1.1.1.1 53</span></strong>
Connection to 1.1.1.1 53 port [udp/domain] succeeded!
^C
</pre>
<p>Lets configure one of those DNS servers for our â€˜classicâ€™ Jail and test it.</p>
<pre><strong>root@classic:/ # <span>echo nameserver 1.1.1.1 &gt; /etc/resolv.conf</span></strong>

<strong>root@classic:/ # <span>drill freebsd.org | grep &#39;^[^;]&#39;</span></strong>
freebsd.org.    240     IN      A       96.47.72.84
</pre>
<p>Seems to work properly. Lets enable <tt><b>sshd(8)</b></tt> service on it.</p>
<pre><strong>root@classic:/ # <span>service sshd enable</span></strong>
sshd enabled in /etc/rc.conf

<strong>root@classic:/ # <span>service sshd start</span></strong>
Generating RSA host key.
3072 SHA256:mSVNDUSi14S+GiaFJgNHNLCqQi6ndFG9JaSyA/wev1k root@classic (RSA)
Generating ECDSA host key.
256 SHA256:Hij315+3C/IMVJ1RX+hNJynGtVSU7ALYN0AS9/lxpJY root@classic (ECDSA)
Generating ED25519 host key.
256 SHA256:qzQnJCHjhHB7jQzmimSLayBfOc3dkLzIVhmrL2r9qxM root@classic (ED25519)
Performing sanity check on sshd configuration.
Starting sshd.

<strong>root@classic:/ # <span>sockstat -l4</span></strong>
USER     COMMAND    PID   FD PROTO  LOCAL ADDRESS         FOREIGN ADDRESS
root     sshd       15049 3  tcp4   20.0.0.50:22          *:*
root     sendmail   18689 3  tcp4   20.0.0.50:25          *:*
root     syslogd    84689 5  udp4   20.0.0.50:514         *:*
</pre>
<p>Seems to work properly. We will now try to login to it from other host on the <tt><b>20.0.0.0/24</b></tt> network.</p>
<pre><strong>laptop % <span>ssh 20.50</span></strong>
The authenticity of host &#39;20.0.0.50 (20.0.0.50)&#39; can&#39;t be established.
ED25519 key fingerprint is SHA256:qzQnJCHjhHB7jQzmimSLayBfOc3dkLzIVhmrL2r9qxM.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? <span><strong>yes</strong></span>
Warning: Permanently added &#39;20.0.0.50&#39; (ED25519) to the list of known hosts.
(root@20.0.0.50) Password for root@classic:
(root@20.0.0.50) Password for root@classic:
(root@20.0.0.50) Password for root@classic:
root@20.0.0.50: Permission denied (publickey,keyboard-interactive).
</pre>
<p>Works. I was not able to login as by default login to <tt><b>root</b></tt> account is disabled.</p>

<p>On the other hand the VNET Jails (with <tt><b>options VIMAGE</b></tt> in the kernel) are quite other beasts. While on the file/dir/config level they work the same â€“ on the network part they are a lot different. They come with separate network stack and do not add their IP to the host network interface.</p>
<p>Also the current configuration of the host (as repeated below) would also <span>not work</span> for the VNET Jails network connectivity with the outside World.</p>
<pre><strong>host # <span>cat /etc/rc.conf</span></strong>
# NETWORK
  hostname=&#34;host&#34;
  ifconfig_em0=&#34;inet 20.0.0.20/24&#34;
  defaultrouter=&#34;20.0.0.1&#34;
</pre>
<p>To allow VNET Jails entry to the World outside of the host system we need to use â€“ for example â€“ <tt><b>if_bridge(4)</b></tt> interface â€“ and move out host IP address there. Below is the not working for the VNET Jails current host network configuration.</p>
<pre><strong>host # <span>ifconfig</span></strong>
em0: flags=8963&lt;UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        options=481009b&lt;RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,VLAN_HWFILTER,NOMAP&gt;
        ether 08:00:27:09:cc:a8
        inet 20.0.0.20/24 broadcast 20.0.0.255
        inet 20.0.0.50/32 broadcast 20.0.0.50
        media: Ethernet autoselect (1000baseT &lt;full-duplex&gt;)
        status: active
        nd6 options=29&lt;PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL&gt;
lo0: flags=8049&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; metric 0 mtu 16384
        options=680003&lt;RXCSUM,TXCSUM,LINKSTATE,RXCSUM_IPV6,TXCSUM_IPV6&gt;
        inet6 ::1 prefixlen 128
        inet6 fe80::1%lo0 prefixlen 64 scopeid 0x2
        inet 127.0.0.1/8
        groups: lo
        nd6 options=21&lt;PERFORMNUD,AUTO_LINKLOCAL&gt;


<strong>host # <span>netstat -Win -f inet</span></strong>
Name      Mtu Network            Address              Ipkts Ierrs Idrop    Opkts Oerrs  Coll
em0         - 20.0.0.0/24        20.0.0.20           164406     -     -    91934     -     -
em0         - 20.0.0.50/32       20.0.0.50              207     -     -      168     -     -
lo0         - 127.0.0.0/8        127.0.0.1                6     -     -        6     -     -

<strong>host # <span>route get 0</span></strong>
   route to: default
destination: default
       mask: default
    gateway: 20.0.0.1
        fib: 0
  interface: bridge0
      flags: &lt;UP,GATEWAY,DONE,STATIC&gt;
 recvpipe  sendpipe  ssthresh  rtt,msec    mtu        weight    expire
       0         0         0         0      1500         1         0
</pre>
<p>This is how now the <tt><b>rc.conf(5)</b></tt> file needs to look like.</p>
<pre><strong>host # <span>cat /etc/rc.conf</span></strong>

# NETWORK
  hostname=&#34;host&#34;
  cloned_interfaces=&#34;bridge0&#34;
  ifconfig_em0=&#34;up&#34;
  ifconfig_bridge0=&#34;inet 20.0.0.20/24 up addm em0&#34;
  defaultrouter=&#34;20.0.0.1&#34;
  gateway_enable=YES

# JAILS
  jail_enable=&#34;YES&#34;
  jail_parallel_start=&#34;YES&#34;
  jail_list=&#34;classic&#34;
</pre>
<p>â€¦ and this is how it looks in the <tt><b>ifconfig(8)</b></tt> and <strong><tt>netstat(8)</tt></strong> commands.</p>
<pre><strong>host # <span>ifconfig</span></strong>
em0: flags=8963&lt;UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        options=481009b&lt;RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,VLAN_HWFILTER,NOMAP&gt;
        ether 08:00:27:09:cc:a8
        inet 20.0.0.50/32 broadcast 20.0.0.50
        media: Ethernet autoselect (1000baseT &lt;full-duplex&gt;)
        status: active
        nd6 options=29&lt;PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL&gt;
lo0: flags=8049&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; metric 0 mtu 16384
        options=680003&lt;RXCSUM,TXCSUM,LINKSTATE,RXCSUM_IPV6,TXCSUM_IPV6&gt;
        inet6 ::1 prefixlen 128
        inet6 fe80::1%lo0 prefixlen 64 scopeid 0x2
        inet 127.0.0.1/8
        groups: lo
        nd6 options=21&lt;PERFORMNUD,AUTO_LINKLOCAL&gt;
bridge0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        ether 58:9c:fc:10:ff:b6
        inet 20.0.0.20/24 broadcast 20.0.0.255
        id 00:00:00:00:00:00 priority 32768 hellotime 2 fwddelay 15
        maxage 20 holdcnt 6 proto rstp maxaddr 2000 timeout 1200
        root id 00:00:00:00:00:00 priority 32768 ifcost 0 port 0
        member: em0 flags=143&lt;LEARNING,DISCOVER,AUTOEDGE,AUTOPTP&gt;
                ifmaxaddr 0 port 1 priority 128 path cost 20000
        groups: bridge
        nd6 options=9&lt;PERFORMNUD,IFDISABLED&gt;

<strong>host # <span>netstat -Win -f inet</span></strong>
Name      Mtu Network            Address              Ipkts Ierrs Idrop    Opkts Oerrs  Coll
em0         - 20.0.0.50/32       20.0.0.50              207     -     -      168     -     -
lo0         - 127.0.0.0/8        127.0.0.1                6     -     -        6     -     -
bridge0     - 20.0.0.0/24        20.0.0.20           164576     -     -    92109     -     -

<strong>host # <span>route get 0</span></strong>
   route to: default
destination: default
       mask: default
    gateway: 20.0.0.1
        fib: 0
  interface: bridge0
      flags: &lt;UP,GATEWAY,DONE,STATIC&gt;
 recvpipe  sendpipe  ssthresh  rtt,msec    mtu        weight    expire
       0         0         0         0      1500         1         0
</pre>
<p>The â€˜classicâ€™ Jail IP address is still bound to the <tt><b>em0</b></tt> interface while the host IP address has been moved to the <tt><b>bridge0</b></tt> bridge. If needed you can also move all the â€˜classicâ€™ Jails IP addresses to the <tt><b>bridge0</b></tt> interface but its not mandatory.</p>
<p>It can be visualized like that. Keep in mind that <tt><b>em0</b></tt> and <tt><b>epair*a</b></tt> interfaces are members of <tt><b>bridge0</b></tt> interface.</p>
<pre>                            +--------------------------------------------+
                            |                        +-------------+ HOST|
                            |       em0 <strong>20.0.0.50</strong>&lt;==&gt;|____jail0____|     |
                            |      /    <strong>20.0.0.51</strong>&lt;==&gt;|____jail1____|     |
              +--------+    |     /     (.......)&lt;==&gt;|    (...)    |     |
              |GATEWAY |    |<strong>20.0.0.20</strong>               +-------------+     |
(Internet)&lt;==&gt;|        |&lt;==&gt;|bridge0                                     |
              |<strong>20.0.0.1</strong>|    |  \ \ \           +-----------------------+ |
              +--------+    |   \ \ epairXa&lt;==&gt;|epairXb <strong>20.0.0.60</strong> vnet0| |
                            |    \ \           +-----------------------+ |
                            |     \ epairYa&lt;==&gt;|epairYb <strong>20.0.0.61</strong> vnet1| |
                            |      \           +-----------------------+ |
                            |       (....)a&lt;==&gt;|(....)b (.......) (...)| |
                            |                  +-----------------------+ |
                            +--------------------------------------------+
</pre>
<p>Lets create now our first VNET Jail. The beginning is the same â€“ we will extract <tt><b>base.txz</b></tt> file from the 13.2-RELEASE system.</p>
<pre><strong>host # <span>zfs create -p zroot/jail/vnet</span></strong>

<strong>host # <span>tar -xf /jail/BASE/13.2-RELEASE-base.txz -C /jail/vnet --unlink
</span></strong></pre>
<p>We will now also need the VNET Jail config.</p>
<pre><strong>host # <span>cat /etc/jail.conf.d/vnet.conf</span></strong>
vnet {
  # STARTUP/LOGGING
    exec.start = &#34;/bin/sh /etc/rc&#34;;
    exec.stop  = &#34;/bin/sh /etc/rc.shutdown&#34;;
    exec.consolelog = &#34;/var/log/jail_console_${name}.log&#34;;

  # PERMISSIONS
    allow.raw_sockets;
    exec.clean;

  # PATH/HOSTNAME
    path = &#34;/jail/${name}&#34;;
    host.hostname = &#34;${name}&#34;;

  # VNET/VIMAGE
    vnet;
    vnet.interface = &#34;${if}b&#34;;

  # NETWORKS/INTERFACES
    $id = &#34;60&#34;;
    $ip = &#34;20.0.0.${id}/24&#34;;
    $gw = &#34;20.0.0.1&#34;;
    $br = &#34;bridge0&#34;;
    $if = &#34;epair${id}&#34;;

  # ADD TO bridge0 INTERFACE
    exec.prestart += &#34;ifconfig ${if} create up&#34;;
    exec.prestart += &#34;ifconfig ${if}a up descr jail:${name}&#34;;
    exec.prestart += &#34;ifconfig ${br} addm ${if}a up&#34;;
    exec.start    += &#34;ifconfig ${if}b ${ip} up&#34;;
    exec.start    += &#34;route add default ${gw}&#34;;
    exec.poststop += &#34;ifconfig ${if}a destroy&#34;;
}
</pre>
<p>Lets now start the VNET Jail.</p>
<pre><strong>host # <span>service jail start vnet</span></strong>
Starting jails: vnet.

<strong>host # <span>jls</span></strong>
   JID  IP Address      Hostname                      Path
     1  20.0.0.50       classic                       /jail/classic
     2                  vnet                          /jail/vnet
</pre>
<p>One thing to notice here is that the <tt><b>jls(8)</b></tt> tool does not show the VNET Jails IP addresses.</p>
<p>You can of course overcome that limitation â€“ but IMHO after 10+ years of VNET Jails being production ready its PITA to say the least.</p>
<pre><strong>host # <span>jexec vnet ifconfig | grep &#39;inet &#39;</span></strong>
        inet 127.0.0.1/8
        inet 20.0.0.60/24 broadcast 20.0.0.255
</pre>
<p>Lets now try our VNET Jail network connectivity to the outside World.</p>
<pre><strong>host # <span>jexec vnet</span></strong>

<strong>root@vnet:/ # <span>ping -c 3 20.1</span></strong>
PING 20.1 (20.0.0.1): 56 data bytes
64 bytes from 20.0.0.1: icmp_seq=0 ttl=255 time=0.853 ms
64 bytes from 20.0.0.1: icmp_seq=1 ttl=255 time=0.474 ms
64 bytes from 20.0.0.1: icmp_seq=2 ttl=255 time=1.355 ms

--- 20.1 ping statistics ---
3 packets transmitted, 3 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.474/0.894/1.355/0.361 ms

<strong>root@vnet:/ # <span>nc -v -u 1.1.1.1 53</span></strong>
Connection to 1.1.1.1 53 port [udp/domain] succeeded!
^C
</pre>
<p>Works as desired.</p>
<p>This is how the networking looks like inside the VNET Jail.</p>
<pre><strong>root@vnet:/ # <span>ifconfig</span></strong>
lo0: flags=8049&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; metric 0 mtu 16384
        options=680003&lt;RXCSUM,TXCSUM,LINKSTATE,RXCSUM_IPV6,TXCSUM_IPV6&gt;
        inet6 ::1 prefixlen 128
        inet6 fe80::1%lo0 prefixlen 64 scopeid 0x1
        inet 127.0.0.1/8
        groups: lo
        nd6 options=21&lt;PERFORMNUD,AUTO_LINKLOCAL&gt;
epair60b: flags=8863&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        options=8&lt;VLAN_MTU&gt;
        ether 02:47:e8:2e:6b:0b
        inet 20.0.0.60/24 broadcast 20.0.0.255
        groups: epair
        media: Ethernet 10Gbase-T (10Gbase-T &lt;full-duplex&gt;)
        status: active
        nd6 options=29&lt;PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL&gt;

<strong>root@vnet:/ # <span>netstat -Win -f inet</span></strong>
Name       Mtu Network            Address              Ipkts Ierrs Idrop    Opkts Oerrs  Coll
lo0          - 127.0.0.0/8        127.0.0.1             2848     -     -     2848     -     -
epair60b     - 20.0.0.0/24        20.0.0.60                5     -     -        9     -     -

<strong>root@vnet:/ # <span>route get 0</span></strong>
   route to: default
destination: default
       mask: default
    gateway: 20.0.0.1
        fib: 0
  interface: epair60b
      flags: &lt;UP,GATEWAY,DONE,STATIC&gt;
 recvpipe  sendpipe  ssthresh  rtt,msec    mtu        weight    expire
       0         0         0         0      1500         1         0
</pre>
<p>Same as with â€˜classicâ€™ Jail â€“ we will enable the <tt><b>sshd(8)</b></tt> service.</p>
<pre><strong>root@vnet:/ # <span>service sshd enable</span></strong>
sshd enabled in /etc/rc.conf

<strong>root@vnet:/ # <span>service sshd start</span></strong>
Generating RSA host key.
3072 SHA256:n9sGBV1bmz3bT4+qKuFE5fZHjnBcYlOMxXCq98z7/r0 root@vnet (RSA)
Generating ECDSA host key.
256 SHA256:A+gDtzkkrhNnGRGR4Yf27cqME8/NZk5NCHrxwyEO9oM root@vnet (ECDSA)
Generating ED25519 host key.
256 SHA256:aojc9Kbyd32HkllG9+noKL8GvKMjObuLrUNiq24+OFk root@vnet (ED25519)
Performing sanity check on sshd configuration.
Starting sshd.

<strong>root@vnet:/ # <span>sockstat -l4</span></strong>
USER     COMMAND    PID   FD PROTO  LOCAL ADDRESS         FOREIGN ADDRESS
root     sshd       37145 4  tcp4   *:22                  *:*
root     sendmail   99914 4  tcp4   127.0.0.1:25          *:*
root     syslogd    71123 6  udp4   *:514                 *:*
</pre>
<p>We will try to connect to it from a system other then the host.</p>
<pre><strong>laptop % <span>ssh 20.60</span></strong>
The authenticity of host &#39;20.0.0.60 (20.0.0.60)&#39; can&#39;t be established.
ED25519 key fingerprint is SHA256:aojc9Kbyd32HkllG9+noKL8GvKMjObuLrUNiq24+OFk.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? <span><strong>yes</strong></span>
Warning: Permanently added &#39;20.0.0.60&#39; (ED25519) to the list of known hosts.
(root@20.0.0.60) Password for root@vnet:
(root@20.0.0.60) Password for root@vnet:
(root@20.0.0.60) Password for root@vnet:
root@20.0.0.60: Permission denied (publickey,keyboard-interactive).
</pre>
<p>Same as with the â€˜classicâ€™ Jail â€“ we will not login with <tt><b>root</b></tt> user as its disabled by default â€“ but that is not the task of this exercise.</p>

<p>While this will not be possible on UFS filesystem â€“ the ZFS allows that without any hassle.</p>
<p>We will now create a template for the â€˜classicâ€™ Jails on ZFS.</p>
<pre><strong>host # <span>zfs snapshot zroot/jail/classic@template

</span></strong></pre>
<p>The only things we did with the â€˜classicâ€™ Jail was to setup DNS server in <tt><b>/etc/resolv.conf</b></tt> file and we enabled <tt><b>sshd(8)</b></tt> service. We generally want that from any of our future Jails â€“ so its a good candidate for a <tt><b>template</b></tt> Jail.</p>
<p>As we created the <tt><b>classic@template</b></tt> ZFS snapshot â€“ we can not create unlimited <i>thin provisioning</i> â€˜classicâ€™ Jails from it. Just make sure to create needed <tt><b>/etc/jail.conf.d</b></tt> Jail config files.</p>
<p>Lets create a new <i>thin provisioning</i> Jail from it now.</p>
<pre><strong>host # <span>zfs list -t snapshot</span></strong>
NAME                          USED  AVAIL     REFER  MOUNTPOINT
zroot/jail/classic@template   224K      -      503M  -

<strong>host # <span>zfs clone zroot/jail/classic@template zroot/jail/shadow</span></strong>

<strong>host # <span>zfs list -t all</span></strong>
NAME                          USED  AVAIL     REFER  MOUNTPOINT
zroot                        3.31G  15.6G       96K  none
zroot/ROOT                    700M  15.6G       96K  none
zroot/ROOT/default            699M  15.6G      699M  /
zroot/jail                   1.86G  15.6G      194M  /jail
zroot/jail/BASE               191M  15.6G      191M  /jail/BASE
zroot/jail/classic            503M  15.6G      503M  /jail/classic
zroot/jail/classic@template   224K      -      503M  -
zroot/jail/shadow               8K  15.6G      503M  /jail/shadow
zroot/jail/vnet               503M  15.6G      503M  /jail/vnet
zroot/tmp                      96K  15.6G       96K  /tmp
zroot/usr                     780M  15.6G       96K  /usr
zroot/usr/home                 96K  15.6G       96K  /usr/home
zroot/usr/ports                96K  15.6G       96K  /usr/ports
zroot/usr/src                 780M  15.6G      780M  /usr/src
zroot/var                     684K  15.6G       96K  /var
zroot/var/audit                96K  15.6G       96K  /var/audit
zroot/var/crash                96K  15.6G       96K  /var/crash
zroot/var/log                 204K  15.6G      204K  /var/log
zroot/var/mail                 96K  15.6G       96K  /var/mail
zroot/var/tmp                  96K  15.6G       96K  /var/tmp

<strong>host # <span>zfs list -r -o space zroot/jail</span></strong>
NAME                AVAIL   USED  USEDSNAP  USEDDS  USEDREFRESERV  USEDCHILD
zroot/jail          15.6G  1.88G        0B    212M             0B      1.67G
zroot/jail/BASE     15.6G   191M        0B    191M             0B         0B
zroot/jail/classic  15.6G   503M      260K    503M             0B         0B
zroot/jail/nfsd     15.6G   513M        0B    513M             0B         0B
<strong><span>zroot/jail/shadow   15.6G   <span>392K</span>        0B    <span>392K</span>             0B         0B</span></strong>
zroot/jail/vnet     15.6G   505M        0B    505M             0B         0B

<strong>host # <span>cp /etc/jail.conf.d/classic.conf /etc/jail.conf.d/shadow.conf</span></strong>

<strong>host # <span>sed -i &#39;&#39; -e &#39;s|classic|shadow|g&#39; -e &#39;s|20.0.0.50|20.0.0.51|g&#39; /etc/jail.conf.d/shadow.conf</span></strong>

<strong>host # <span>cat /etc/jail.conf.d/shadow.conf</span></strong>
shadow {
  # STARTUP/LOGGING
    exec.start = &#34;/bin/sh /etc/rc&#34;;
    exec.stop  = &#34;/bin/sh /etc/rc.shutdown&#34;;
    exec.consolelog = &#34;/var/log/jail_console_${name}.log&#34;;

  # PERMISSIONS
    allow.raw_sockets;
    exec.clean;

  # PATH/HOSTNAME
    path = &#34;/jail/${name}&#34;;
    host.hostname = &#34;${name}&#34;;

  # NETWORK
    ip4.addr = 20.0.0.51;
    interface = em0;
}

<strong>host # <span>service jail start shadow</span></strong>
Starting jails: shadow.

<strong>host # <span>jls</span></strong>
   JID  IP Address      Hostname                      Path
     1  20.0.0.50       classic                       /jail/classic
     2                  vnet                          /jail/vnet
     3  20.0.0.51       shadow                        /jail/shadow

<strong>host # <span>netstat -Win -f inet</span></strong>
Name      Mtu Network            Address              Ipkts Ierrs Idrop    Opkts Oerrs  Coll
em0         - 20.0.0.50/32       20.0.0.50             2854     -     -     2746     -     -
em0         - 20.0.0.51/32       20.0.0.51                3     -     -        0     -     -
lo0         - 127.0.0.0/8        127.0.0.1                6     -     -        6     -     -
bridge0     - 20.0.0.0/24        20.0.0.20           195544     -     -   150555     -     -
</pre>
<p>While the â€˜classicâ€™ Jail uses about <strong>500 MB</strong> of space the <em>Thin Provisioning</em> <tt><b>shadow</b></tt> Jail uses less then <strong>1 MB </strong>of space.</p>
<p>We can now test its <tt><b>sshd(8)</b></tt> daemon connection.</p>
<pre><strong>laptop % <span>ssh 20.51</span></strong>
The authenticity of host &#39;20.0.0.51 (20.0.0.51)&#39; can&#39;t be established.
ED25519 key fingerprint is SHA256:qzQnJCHjhHB7jQzmimSLayBfOc3dkLzIVhmrL2r9qxM.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? <span><strong>yes</strong></span>
Warning: Permanently added &#39;20.0.0.51&#39; (ED25519) to the list of known hosts.
(root@20.0.0.51) Password for root@shadow:
(root@20.0.0.51) Password for root@shadow:
(root@20.0.0.51) Password for root@shadow:
root@20.0.0.51: Permission denied (publickey,keyboard-interactive).
</pre>
<p>Yep. Works as it should.</p>
<p>You can create a template for VNET Jail in the same manner.</p>

<p>The Docker is mostly know from its single process execution. You choose a process/daemon that you want to run isolated â€“ copy it into the Docker container with its dependencies and you start it.</p>
<p>Exactly the same can be achieved with FreeBSD Jails.</p>
<p>For the purposes of this guide we will execute <tt><b>/bin/sh</b></tt> POSIX shell interpreter in a separated FreeBSD Jail. To omit copying additional files we will use the statically compiled version from the well know FreeBSD <i>Rescue System</i>.</p>
<pre><strong>host # <span>mkdir -p /jail/shell/dev</span></strong>

<strong>host # <span>cp /rescue/sh /rescue/hostname /jail/shell/</span></strong>
<strong>
host # <span>jail -n shell \
            -c path=/jail/shell \
               mount.devfs \
               host.hostname=shell \
               ip4.addr=20.0.0.111 \
               command=/sh</span></strong>

<strong>shell # <span>/hostname</span></strong>
shell

<strong>shell # <span>/sh</span></strong>
Cannot read termcap database;
using dumb terminal settings.

<strong>shell # <span>for I in 1 2 3; do echo ${I}; done</span></strong>
1
2
3

<strong>shell # <span>echo /*</span></strong>
/dev /hostname /sh
</pre>
<p>You can login to the host system from other SSH session to see that <tt><b>shell</b></tt> Jail is running among our other FreeBSD Jails.</p>
<pre><strong>host # <span>jls</span></strong>
   JID  IP Address      Hostname                      Path
     1  20.0.0.50       classic                       /jail/classic
     2                  vnet                          /jail/vnet
     3  20.0.0.51       shadow                        /jail/shadow
     4  20.0.0.111      shell                         /jail/shell
</pre>

<p>For that purpose we will remove the â€˜classicâ€™ Jail.</p>
<p>We will first stop our Jail.</p>
<pre><strong>host # <span>service jail stop classic
</span></strong></pre>
<pre><strong>host # <span>rm -rf /jail/classic</span></strong>
rm: /jail/classic/var/empty: Operation not permitted
rm: /jail/classic/var: Directory not empty
rm: /jail/classic/libexec/ld-elf32.so.1: Operation not permitted
rm: /jail/classic/libexec/ld-elf.so.1: Operation not permitted
rm: /jail/classic/libexec: Directory not empty
rm: /jail/classic/lib/libthr.so.3: Operation not permitted
rm: /jail/classic/lib/libcrypt.so.5: Operation not permitted
rm: /jail/classic/lib/libc.so.7: Operation not permitted
rm: /jail/classic/lib: Directory not empty
(...)
</pre>
<p>Wait â€¦ you are <tt><b>root</b></tt> and you can not delete files? ðŸ™‚ This is just another FreeBSD features. The <i>File Flags</i>. They can also be used with FreeBSD <em>Secure Levels</em> feature. By default some files and directories are marked with some of these flags. To be able to remove these files you first need to remove these flags. We can do that with <tt><b>chflags(1)</b></tt> command.</p>
<pre><strong>host # <span>chflags -R 0 /jail/classic</span>
host # <span>rm -rf /jail/classic</span>
host # <span>echo ${?}</span></strong>
0
</pre>
<p>Now as the <i>File Flags</i> have been removed we can delete all files and dirs with usual <tt><b>rm(1)</b></tt> command. As our â€˜classicâ€™ Jail files are gone we should also delete the Jail config at <tt><b>/etc/jail.conf.d/classic.conf</b></tt> file.</p>
<pre><strong>host # <span>rm -f /etc/jail.conf.d/classic.conf
</span></strong></pre>

<p>I am not sure what else I should add here â€¦ but I am sure that you will let me know in the comments section ðŸ™‚</p>
<p>Regards.</p>
<p>EOF</p>
			
			
								</div></div>
  </body>
</html>
