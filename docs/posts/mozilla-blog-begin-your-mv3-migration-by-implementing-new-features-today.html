<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.mozilla.org/addons/2022/10/31/begin-your-mv3-migration-by-implementing-new-features-today/">Original</a>
    <h1>Mozilla blog: Begin your MV3 migration by implementing new features today</h1>
    
    <div id="readability-page-1" class="page"><div>
    <p><img width="160" height="160" src="https://blog.mozilla.org/addons/files/2019/10/Fx-Browser-icon-fullColor-160x160.png" alt="" title="" srcset="https://blog.mozilla.org/addons/files/2019/10/Fx-Browser-icon-fullColor-160x160.png 160w, https://blog.mozilla.org/addons/files/2019/10/Fx-Browser-icon-fullColor-252x252.png 252w, https://blog.mozilla.org/addons/files/2019/10/Fx-Browser-icon-fullColor-768x768.png 768w, https://blog.mozilla.org/addons/files/2019/10/Fx-Browser-icon-fullColor-600x600.png 600w, https://blog.mozilla.org/addons/files/2019/10/Fx-Browser-icon-fullColor.png 2048w" sizes="(max-width: 160px) 100vw, 160px"/></p><p>Early next year, Firefox will release Mozilla’s Manifest V3 (MV3). Therefore, it’s an ideal time to consider <a href="https://extensionworkshop.com/documentation/develop/manifest-v3-migration-guide/" target="_blank" rel="noopener">migrating your Manifest V2 extensions</a>. One of our goals throughout our approach to MV3 has been to gradually release new WebExtensions features that enable you to begin implementing APIs that are compatible with MV3. To this end, we recently released some exciting new features you should know about…</p>

<h2>MV3 changes you can make to your extension right now</h2>

<h3>Event Pages</h3>
<p>In Firefox MV3, we’re providing Event Pages as the background script. Event Pages retain several important features, including access to DOM and <a href="https://developer.mozilla.org/en-US/docs/Web/API" target="_blank" rel="noopener">WebAPIs</a> that are not available with the new service worker backgrounds used in Google Chrome.</p>
<p>We enabled Event Pages for MV2 (aka non-persistent background pages that can be closed and respawned based on browser events) in Firefox 106. This update is a major step toward MV3 because all extensions must adopt Event Pages in MV3. But you can make this change today and use new Event Pages benefits such as:</p>
<ul>
<li aria-level="1">Resiliency against unexpected system crashes. Now we can restart a corrupted background page without hindering the user.</li>
<li aria-level="1">No need for an extension reboot to reset a background page.</li>
<li aria-level="1">Save on memory resources by putting idle background pages to sleep.</li>
</ul>
<h4>How do I implement Event Pages?</h4>
<p>To turn your background into an Event Page, set `persistent: false` on the background page in your manifest.json. Here’s more <a href="https://developer.mozilla.org/docs/Mozilla/Add-ons/WebExtensions/Background_scripts" target="_blank" rel="noopener">info on background scripts</a> with <a href="https://developer.mozilla.org/docs/Mozilla/Add-ons/WebExtensions/Background_scripts#specify_the_background_scripts" target="_blank" rel="noopener">implementation details</a>.</p>
<p>Now that your background script is non-persistent, you need to tell Firefox when to wake up the page if it’s suspended. There are two methods available:</p>
<ol>
<li aria-level="1"><b>Use an event listener like `browser.tabs.onCreated` in your background script</b>.  Event listeners must be added at the top level execution of your script. This way, if your background is sleeping Firefox knows to wake the script whenever a new tab is spawned. This works with nearly all events in the WebExtensions API. Here’s more <a href="https://developer.mozilla.org/docs/Mozilla/Add-ons/WebExtensions/Background_scripts#add_listeners" target="_blank" rel="noopener">info on adding listeners</a>. (Note that Firefox recognizes arguments passed to addListener and does not create multiple listeners for the same set of arguments.)</li>
<li aria-level="1"><b>Use `browser.runtime.getBackgroundPage` if you need a background page to run processes unrelated to events</b>. For instance, you may need a background script to run a process while the user is involved with a browser action or side panel. Use this API anytime you need direct access to a background page that may be suspended or closed. Here’s more <a href="https://developer.mozilla.org/docs/Mozilla/Add-ons/WebExtensions/Background_scripts#update_calls_for_background_script_functions" target="_blank" rel="noopener">info on background script functions</a>.</li>
</ol>
<p><a href="https://developer.mozilla.org/docs/Mozilla/Add-ons/WebExtensions/API/menus" target="_blank" rel="noopener">Menus</a> and <a href="https://developer.mozilla.org/docs/Mozilla/Add-ons/WebExtensions/API/scripting" target="_blank" rel="noopener">Scripting</a> APIs also support persistent data:</p>
<ul>
<li aria-level="1">Menu items created by an event page are available after they’re registered — even if the event page is terminated. The event page respawns as necessary to menu events.</li>
<li aria-level="1">Registered scripts can be injected into matching web pages without the need for a running Event Page.</li>
</ul>
<h3>Scripting</h3>
<p>You can take another big step toward MV3 by switching to the new Scripting API. This API consolidates several scripting related APIs — contentScripts.register(), tabs.insertCSS(), tabs.removeCSS(), and tabs.executeScript() — and adds capabilities to register, update, and unregister content scripts at runtime.</p>
<p>Also, arbitrary strings can no longer be executed because the code parameter has been removed. So you’ll need to move any arbitrary strings executed as scripts into files contained within the extension, or to the func property used with, if necessary, the args parameter.</p>
<p>This API requires the<a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions" target="_blank" rel="noopener"> scripting permission</a>.</p>
<h2>Preparing for MV3 restrictions</h2>
<p>MV3 will impose enhanced restrictions on several features. Most of these restrictions are outlined in the <a href="https://extensionworkshop.com/documentation/develop/manifest-v3-migration-guide/" target="_blank" rel="noopener">MV3 migration guide</a>. By following the steps detailed in the guide, there are some ways you can begin modifying your MV2 extension to make it comply more closely with MV3 requirements. A few noteworthy areas include…</p>
<h3>Conform to MV3’s Content Security Policy</h3>
<p>Mozilla’s long-standing <a href="https://extensionworkshop.com/documentation/publish/add-on-policies/" target="_blank" rel="noopener">add-on policies</a> prohibit remote code execution. In keeping with these policies, the <a href="https://developer.mozilla.org/docs/Mozilla/Add-ons/WebExtensions/manifest.json/content_security_policy" target="_blank" rel="noopener">content_security_policy</a> field no longer supports sources permitting remote code in script-related directives, such as script-src or `’unsafe-eval’`. The only permitted values for the `script-src` directive is `’self’` and `’wasm-unsafe-eval’`. `’wasm-unsafe-eval’` must be specified in the CSP if an extension wants to use WebAssembly. In MV3, content scripts are subject to the same CSP as other parts of the extension.</p>
<p>Historically, a custom extension CSP required object-src to be specified. This is not required in MV3 and was removed from MV2 in Firefox 106 (see <a href="https://developer.mozilla.org/docs/Mozilla/Add-ons/WebExtensions/manifest.json/content_security_policy#object-src_directive" target="_blank" rel="noopener">object-src in content_security_policy on MDN</a>). This change makes it easier for extensions to customize the CSP with minimal boilerplate.</p>
<p>The <a href="https://developer.mozilla.org/docs/Web/HTTP/CSP" target="_blank" rel="noopener">Content Security Policy</a> (CSP) is more restrictive in MV3. If you are using a custom CSP in your MV2 add-on, you can validate the CSP by temporarily running it as an MV3 extension.  See the <a href="https://extensionworkshop.com/documentation/develop/manifest-v3-migration-guide/" target="_blank" rel="noopener">MV3 migration guide</a> for details.</p>
<h3>Upgrade insecure requests – https by default</h3>
<p>When communicating with external servers, extensions <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1797086" target="_blank" rel="noopener">will use https by default</a>. Extensions should replace the “http:” and ”ws:” schemes in their source code with secure alternatives, “https:” and ”wss:”. The default MV3 CSP includes the upgrade-secure-requests directive, to enforce the use of secure schemes even if an insecure scheme was used.</p>
<p>Extensions can opt out of this https requirement by overriding the content_security_policy and omitting the upgrade-secure-requests, provided that no user data is transmitted insecurely through the extension.</p>
<h3>Opt-in permissions</h3>
<p>All MV3 permissions, including host permissions, are opt-in for users. This necessitated a significant Firefox design change — the introduction of the Unified Extensions button — so users can easily grant or deny website specific permissions at any time (the button is enabled on Firefox Nightly for early testing and feedback).</p>
<div id="attachment_9067"><p><img aria-describedby="caption-attachment-9067" loading="lazy" src="https://blog.mozilla.org/addons/files/2022/10/blog_uni_ex_btn-600x405.png" alt="" width="600" height="405" srcset="https://blog.mozilla.org/addons/files/2022/10/blog_uni_ex_btn-600x405.png 600w, https://blog.mozilla.org/addons/files/2022/10/blog_uni_ex_btn-252x170.png 252w, https://blog.mozilla.org/addons/files/2022/10/blog_uni_ex_btn-768x519.png 768w, https://blog.mozilla.org/addons/files/2022/10/blog_uni_ex_btn.png 1332w" sizes="(max-width: 600px) 100vw, 600px"/></p><p id="caption-attachment-9067">The Unified Extensions button gives Firefox users direct control over website specific extension permissions.</p></div>
<p>Therefore, you must ensure your extension has permission whenever it accesses APIs covered by a permission, accesses a tab, or uses <a href="https://developer.mozilla.org/docs/Web/API/Fetch_API" target="_blank" rel="noopener">Fetch API</a>. MV2 already has APIs that enables you to check for permissions and watch for changes in permission. When necessary, you can get the current permission status. However, rather than always checking, use the permissions.onAdded and permissions.onRemoved event APIs to watch for changes.</p>
<h3>Update content scripts</h3>
<p>While content scripts continue to have access to the same extension APIs in MV3 as in MV2, most of the special exceptions and extension specific capabilities have been removed from the web platform APIs (DOM APIs). In particular, the extension’s host permissions no longer apply to Fetch and XMLHttpRequest.</p>
<h4>CSP for content scripts</h4>
<p>With MV2 no CSP is applied to content scripts. In MV3, content scripts are subjected to the same CSP as other parts of the extension (see <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_Security_Policy#csp_for_content_scripts" target="_blank" rel="noopener">CSP for content scripts on MDN</a>). Notably, this means that remote code cannot be executed from the content script. Some existing uses can be replaced with functionality from the Scripting API such as func and args (see the “Scripting” section above), which is available to MV2 extensions.</p>
<h4>XHR and Fetch</h4>
<p>With MV2 you also have access to some APIs, such as XMLHttpRequest and Fetch, from both extension and web page contexts. This allows for cross origin requests in a way that is not available in MV3. In MV3, XHR and Fetch operate as if the web page itself was using them, and are subject to cross origin controls.</p>
<p>Content scripts can continue using XHR and Fetch by first making requests to background scripts. A background script can then use Fetch to get the data and return the necessary information to the content script. To avoid privacy issues, set the “credentials” option to “omit” and cache option to “no-cache”. In the future, we may offer an API to support the make-request-on-behalf-of-a-document-in-a-tab use case.</p>
<h3>Will Chrome MV3 extensions work in Firefox MV2?</h3>
<p>The release of MV3 in Firefox is distinct from Chrome. Add-ons intended to work across different browsers will, in most cases, require some level of adjustment to be compatible in both Firefox and Chrome. That said, we are committed to a high level of compatibility. We will be providing additional APIs and features in the near future. If you’ve converted your Chrome extension to Google’s MV3, you may be able to consolidate some of those changes into your Firefox MV2 extension. Here are a few areas to investigate:</p>
<ul>
<li aria-level="1">Services Workers are not yet available in Firefox; however many scripts may work interchangeably between Service Workers and Event Pages, depending on functionality. To get things working, you may need to remove service worker specific APIs. See <a href="https://developer.mozilla.org/docs/Web/API/ServiceWorkerGlobalScope" target="_blank" rel="noopener">Service Worker Global Scope fo</a>r more information.</li>
<li aria-level="1">DNR is not yet available in Firefox. Firefox retains WebRequest blocking in MV3, which can be used in place of DNR. When DNR is available, simple request modifications can be moved over to DNR.</li>
<li aria-level="1">The storage.session API is not yet available in Firefox. You can use other storage mechanisms in the meantime.</li>
</ul>
<p>Hopefully, we’ve provided helpful information so you can use the new MV2 features to start your migration to MV3. As always, we appreciate your feedback and welcome questions. Here are the ways to get in touch:</p>
<ul>
<li aria-level="1">Chat: <a href="https://chat.mozilla.org/#/room/#addons:mozilla.org" target="_blank" rel="noopener">chat.mozilla.org</a></li>
<li aria-level="1">Report issues and ask questions on <a href="https://discourse.mozilla.org/c/add-ons/35" target="_blank" rel="noopener">Discourse</a> (where knowledge may be shared among other developers)</li>
<li aria-level="1">Report problems on: <a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=WebExtensions" target="_blank" rel="noopener">Bugzilla</a></li>
</ul>
      </div></div>
  </body>
</html>
