<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.infochunk.com/schannel/index.html">Original</a>
    <h1>Reverse engineering the Sega Channel game image file format</h1>
    
    <div id="readability-page-1" class="page">

<hr/>
<h3>Introduction</h3>
<p>Sega Channel was a games-on-demand service that gave cable subscribers access to a library of around 50 Sega Genesis games per month in exchange for a monthly fee (typically $10-$15/month depending on the cable provider). It operated between June 1994 (with a nationwide rollout in December 1994) and June 1998. Cable subscribers would be given an adapter cartridge that would connect their Genesis to a cable TV line. On boot, the cartridge would search for the Sega Channel signal, then download the game menu. This process typically took around 20 seconds. The user would then pick a game and wait about a minute for it to be downloaded to the adapter&#39;s RAM. At this point, the game would function exactly the same as a retail cartridge. Turning the system off or pressing the menu button on the adapter would erase the downloaded game, but game save data was retained unless the user downloaded a different game. Besides retail games, Sega Channel offered a &#34;Test Drives&#34; section where users could play time or content restricted versions of games before they got a retail release. There were also a number of games that were only available via Sega Channel, although it seems that most of them were titles where either Sega or the publisher weren&#39;t confident enough in their quality to give them a physical cartridge release. Sega Channel was a modest success, peaking at around 250,000 subscribers.</p>
<img src="https://www.infochunk.com/schannel/adapter.jpg" alt="photograph of a Sega Channel adapter"/>

<p>Sega Channel data was delivered to cable customers through a somewhat long-winded process. First, Sega Channel employees would select the game line-up and other content (game hints, manuals, news, digitized fan-art, etc.) for a given month. They would then send everything to a company called Foley Hi-Tech, who would create the game menu graphics/animations and insert all the monthly content. They ended up with a ~60MB file called a &#34;game image&#34;, which was burnt to a CD and sent to a satellite uplink facility in Denver, Colorado. The CD would then be installed in the uplink game server computer, which would continuously transmit the game data in a loop over satellite. Cable headends all over the US would receive the satellite transmission and send it to cable subscribers. The data being sent in a continuous loop is how the service&#39;s &#34;interactivity&#34; was achieved at a time when cable TV providers could only transmit data to all subscribers and couldn&#39;t receive data (i.e. what game a given subscriber wants to download). When a user chose a game from the menu, their adapter was instructed to look through the Sega Channel data stream and pick out the data for the game they selected. The ~60MB game image file was transmitted at a rate of about 8Mbps. Assuming that there were no signal problems, the user always got to play whatever game they picked within a minute (one loop of the data). The menu downloaded in less than a minute because additional redundant copies of it were added to the data stream to speed up downloads.</p>
<img src="https://www.infochunk.com/schannel/servicediagram.jpg" alt="Diagram showing how Sega Channel service worked"/>

<h3>Game Image</h3>
<p>In November 2024, the user RisingFromRuins on the Sonic Retro forum <a href="https://forums.sonicretro.org/index.php?posts/1084673/">announced</a> that he had found a Sega Channel game image CD for September 1996 while he was going through a lot of PC equipment he had bought years earlier. He posted pictures of the CD and <a href="https://retrocdn.net/File:DOM0816_zipped_image_file.zip">uploaded a copy</a> of the game image file on the disc. I thought it would be a fun project to see if I could extract the data from the game image file to see if there were any exclusive or prototype games on there. It&#39;s always neat to see games that nobody&#39;s been able to play for over 25 years.</p>
<p><img src="https://www.infochunk.com/schannel/gameimagecase.jpg" width="400" alt="photograph of a Sega Channel game image CD case"/>
<img src="https://www.infochunk.com/schannel/gameimagedisc.jpg" width="400" alt="photograph of a Sega Channel game image CD"/>
</p>

<h3>Process</h3>
<p>My first idea was to check out the image file&#39;s contents in a hex editor. Genesis games all have a standardized ASCII header, and I figured the game hints/downloadable manuals would be readable as well. Unfortunately, when I scrolled through the image file, there wasn&#39;t anything readable. My best guess was that the image file was either scrambled or encrypted.</p>
<img src="https://www.infochunk.com/schannel/hxd.png" width="500" alt="screenshot of a portion of the image file being displayed in a hex editor"/>

<p>At this point, I hit a lucky break. In 2017, someone with the username tdijital had <a href="https://hiddenpalace.org/Sega_Channel_(January_1996_dev_disc)">uploaded</a> a backup CD from Foley Hi-Tech (company I mentioned earlier that made the Sega Channel menus) containing Sega Channel development materials. People had <a href="https://forums.sonicretro.org/index.php?posts/897224/">previously gone over</a> some of the CD&#39;s contents and found some interesting stuff, including contest versions of Primal Rage, a couple quiz games from the Japanese version of Sega Channel, and standalone menu demo ROMs for December 1994 - January 1996 that could be run in an emulator and acted as time capsules for what was on the service that month. However, as far as I was aware, nobody had looked at any of the development tooling on the disc. My point of view was that if I wanted to extract the data from the game image file, it would be easier to reverse engineer the tooling that created the game image than to reverse engineer the Genesis-side downloading code and hope that the image file remained mostly intact during the data transmission process.</p>

<p>After a bit of trial and error, I figured out how the image files were created. First, developers would add all the games, descriptions, news text, art, music, etc. using a program called MENUMAKR. They&#39;d end up with a menu binary file and a script file (misleadingly named MENUSPIN.BAT despite not being a batch file) containing the ROM file paths, data offsets, how many copies of the ROM to include, and other metadata for each game.</p>
<img src="https://www.infochunk.com/schannel/menumakr.png" alt="screenshot of MENUMAKR program"/>

<p>Next, they&#39;d run a program written by Scientific Atlanta (a cable equipment company that Sega partnered with to create the Sega Channel broadcast equipment and cartridge adapter) called PKSPREAD. This would validate the contents of the MENUSPIN.BAT file and output a binary file called PMAP.DAT, which contained instructions on how to split up and process the menu and game data for transmission.</p>
<img src="https://www.infochunk.com/schannel/pkspread.png" alt="screenshot of PKSPREAD program"/>

<p>Finally, they&#39;d run another program written by Scientific Atlanta called NSF, which would use the PMAP.DAT file to encode all the input files and create the game image file. I decided that if I wanted to decode the image file, this was the program I should focus on.</p>
<img src="https://www.infochunk.com/schannel/nsf.png" alt="screenshot of NSF program"/>

<p>At this point, I hit another lucky break. I found that NSF.EXE had been compiled in debug mode, with optimizations turned off and with symbols embedded into the EXE. This meant that it would be easy to reverse engineer. Unfortunately, IDA Pro didn&#39;t automatically pick up the debug symbols from the executable, so I had to open NSF in Turbo Debugger (it was compiled with Borland C++ 4.1) and manually copy them over. Fortunately, the program was pretty small so this didn&#39;t take too long.</p>
<p><img src="https://www.infochunk.com/schannel/td.png" width="500" alt="screenshot of portion of NSF code in Turbo Debugger"/>
<img src="https://www.infochunk.com/schannel/ida.png" width="500" alt="screenshot of portion of NSF code in IDA"/>
</p>

<p>I could have gone straight to writing a decoder program here, but I thought it would be a better idea to first write an equivalent program to NSF.EXE. That way, if I was able to make a byte-for-byte identical image file to one created by the DOS NSF.EXE utility, I knew I had the algorithm figured out correctly. I created a test game image file (what the above screenshots of PKSPREAD and NSF show) and set about trying to match it. It took me a day of work and another couple evenings of debugging, but I wrote an <a href="https://github.com/nfroggy/sctools/blob/master/nsf.c">equivalent C program</a> to NSF.EXE and got the output to match. My basic process was I had IDA open on one monitor and Visual Studio open on the other, and I tried to match the assembly as closely as possible. This led to a couple interesting insights. Whoever wrote NSF was likely a novice C programmer. They also spent considerable effort on making everything 1-indexed rather than 0-indexed (maybe they were a Pascal fan?). Note that I made no effort to try to get the compiled binary to match the original. In fact, it likely won&#39;t even compile as a C file under Borland C++ 4, as I used C99 declarations and stdint.h types everywhere.</p>

<details><summary><b>Simplified overview of what NSF does (click to expand)</b></summary>
<ol>
<li>The GetData function pulls information such as what file to open for a given packet, where to seek into the file for the packet, and Sega Channel specific metadata (file ID, how long the game should be playable for if it&#39;s a time-limited demo, etc.) from the PMAP.DAT file. It then loads a 246-byte chunk of data from the data file.</li>
<li>The LoadFrame function adds a header to the start of the data packet and reverses all the data bytes (not sure if this is some data transmission thing, or if it was just to obfuscate the packet contents). It also intersperses <a href="https://en.wikipedia.org/wiki/BCH_code">BCH error-correcting codes</a> and parity bits throughout the game data. After this, 288 bytes are now used to hold the 246 bytes of data. Here&#39;s what the header structure looks like: (all multi-bit fields are in reverse bit order):
<table>
<thead><tr><th>Bit # (0-indexed)</th> <th>Bit Length</th> <th>Item</th> <th>Description</th></tr></thead>
<tbody>
<tr><td>0</td> <td>27</td> <td>Unknown</td> <td>Not added by NSF, maybe added at transmission by the server?</td></tr>
<tr><td>27</td> <td>2</td> <td>Padding</td> <td>Always 0.</td></tr>
<tr><td>29</td> <td>1</td> <td>GameTimeSync</td> <td>1 when the GameTimeBit field contains bit 15 of the game time-out value.</td></tr>
<tr><td>30</td> <td>1</td> <td>GameTimeBit</td> <td>Contains one bit of the game time-out value (how long to allow the game to be played in 10-second intervals), clocked out for a given file in reverse bit order (highest bit first).</td></tr>
<tr><td>31</td> <td>7</td> <td>ServiceID</td> <td>This is usually 1. May have something to do with Express Games (new titles that had to be individually ordered from a cable operator for an additional fee).</td></tr>
<tr><td>38</td> <td>14</td> <td>FileID</td> <td>Uniquely identifies each file in the game image. The menu is always file 0.</td></tr>
<tr><td>52</td> <td>15</td> <td>Address</td> <td>Where in RAM the adapter should download the file to.</td></tr>
<tr><td>67</td> <td>16</td> <td>HeaderCRC</td> <td>16-bit CRC of bits 27-66 of the header.</td>
</tr><tr><td>83</td> <td>56</td> <td>Header Copy</td> <td>Copy of bits 27-82 of the header.</td></tr>
</tbody>
</table>
</li>
<li>The InterLeave function splits the packet into 450-bit chunks and scrambles the bits around for each chunk. I think this has to have been done to obfuscate the data stream, as I can&#39;t think of a practical reason for this.</li>
<li>The above steps are repeated for another 9 packets.</li>
<li>All 10 packets are bundled up into a 2880 byte frame, and the data is woven together such that the first two bytes are from packet 0, the next two are from packet 1, and so on. The frame is then written to disk.</li>
<li>This process repeats until the entire image file has been created.</li>
</ol>
</details>

<p>Once I figured out how NSF works, it was fairly easy to write <a href="https://github.com/nfroggy/sctools/blob/master/densf.cpp">a decoder program</a> that would undo all these steps in reverse and spit out a bunch of individual data files. However, the data my decoder program output still wasn&#39;t valid Genesis ROM data:</p>
<img src="https://www.infochunk.com/schannel/hexcompare.png" width="800" alt="screenshot of a game from an image file compared to a regular ROM"/>

<p>Thankfully, this was just because the game data was compressed before transmission. The tool used to compress ROMS was in the Foley Hi-Tech CD (GAMEEDIT.EXE) but I didn&#39;t have to reverse engineer it because a GitHub user named Octocontrabass had <a href="https://github.com/Octocontrabass/channelzss">already done so</a>. I used his/her &#34;unsa&#34; tool to decompress all the .SA files into standard ROM files.</p>

<h3>Findings</h3>
<p>The most notable games from the image file are the two exclusive games that were broadcast in September 1996, Chessmaster and Klondike. Chessmaster is a chess game that was available on many platforms in the 90s (but not Genesis) and Klondike is a solitaire game commissioned by Sega for Sega Channel and programmed by David Crane of Pitfall fame.</p>
<p><img src="https://www.infochunk.com/schannel/chessmaster.png" width="320" alt="Chessmaster title screen"/>
<img src="https://www.infochunk.com/schannel/klondike.png" width="320" alt="Klondike title screen"/>
</p>

<p>Here&#39;s a categorized full list of all the games from the image file (list by <a href="http://www.retrolel.com/en/">ICEknight</a>):</p>
<details><summary><b>Sega Channel September 1996 game list (click to expand)</b></summary>
<h4>Exclusives</h4>
<ul>
<li>Chessmaster, The</li>
<li>Klondike</li>
<li>Olympic Summer Games - Test Drive</li>
<li>Sega Channel Game Guide</li>
</ul>

<h4>New Builds</h4>
<ul>
<li>Bugs Bunny in Double Trouble</li>
<li>OutRunners</li>
<li>Super Volleyball</li>
<li>World Series Baseball &#39;96</li>
</ul>

<h4>Known Dumps with Different Padding</h4>
<ul>
<li>Flashback - The Quest for Identity (USA) (En,Fr)</li>
<li>Phantasy Star II (USA, Europe) (Rev A)</li>
<li>Punisher, The (USA)</li>
</ul>

<h4>Known Dumps with Watermarks Added</h4>
<ul>
<li>Alex Kidd in the Enchanted Castle (USA)</li>
<li>Berenstain Bears&#39; Camping Adventure, The (USA)</li>
<li>Ecco - The Tides of Time (USA)</li>
<li>Richard Scarry&#39;s Busytown (USA)</li>
<li>Sonic &amp; Knuckles (World)</li>
<li>Strider (USA, Europe)</li>
<li>World Series Baseball (USA)</li>
</ul>

<h4>Match Known Dumps</h4>
<ul>
<li>Aaahh!!! Real Monsters (USA)</li>
<li>Arcus Odyssey (USA)</li>
<li>B.O.B. (USA, Europe)</li>
<li>Ballz 3D - The Battle of the Ballz (USA, Europe)</li>
<li>Castlevania - Bloodlines (USA)</li>
<li>College Football&#39;s National Championship II (USA)</li>
<li>Dr. Robotnik&#39;s Mean Bean Machine (USA)</li>
<li>Fatal Labyrinth (USA, Europe) (En,Ja)</li>
<li>G-LOC - Air Battle (World)</li>
<li>Generations Lost (USA, Europe)</li>
<li>Granada (Japan, USA) (En) (Rev A)</li>
<li>Hard Drivin&#39; (World)</li>
<li>Junction (Japan, USA) (En)</li>
<li>Jungle Strike (USA, Europe)</li>
<li>M-1 Abrams Battle Tank (USA, Europe)</li>
<li>Marsupilami (USA) (En,Fr,De,Es,It)</li>
<li>Mega Bomberman (USA)</li>
<li>NCAA Football (USA)</li>
<li>Pele! (USA, Europe)</li>
<li>PGA Tour Golf III (USA, Europe)</li>
<li>Rugby World Cup 95 (USA, Europe) (En,Fr,It)</li>
<li>Saint Sword (USA)</li>
<li>Shinobi III - Return of the Ninja Master (USA)</li>
<li>Space Harrier II (World)</li>
<li>Streets of Rage 2 (USA)</li>
<li>Taz-Mania (World)</li>
<li>ToeJam &amp; Earl (USA, Europe, Korea) (En)</li>
<li>Ultimate QIX (USA)</li>
<li>Valis (USA)</li>
<li>Vectorman (USA) (Sega Smash Pack)</li>
<li>X-Men (USA)</li>
<li>Ys III (USA)</li>
<li>Zoop (USA)</li>
</ul>
</details>

<p>After I posted my findings, Black Squirrel on Sonic Retro <a href="https://forums.sonicretro.org/index.php?posts/1085118/">found</a> that it was possible to get the September 1996 menu running in an emulator by copying bytes 0-0x1003FF from one of the Sega Channel demo cartridge ROMs and appending the menu data from the game image to the end. Obviously the download functionality doesn&#39;t work, but it&#39;s still fun to look around in the menu.</p>
<img src="https://www.infochunk.com/schannel/sep96menu.png" width="320" alt="Sega Channel September 1996 menu screenshot"/>

<p>The final bit of content from the image file was the game instructions ROM. It looked like a normal Genesis ROM file, but when I tried to run it in an emulator I just got a black screen. The problem here turned out to be that the ROM was linked with a base address of 0x100000 rather than 0 like a normal cartridge. It seems like it was meant to be run directly out of the Sega Channel adapter&#39;s memory without it getting mapped to the normal cartridge address space. My best guess is this had something to do with the functionality for jumping into the manual for a specific game from the game menu. I got it working in an emulator by adding zeroes after the header until the code lined up correctly with the vectors in the header. When it&#39;s started like this, at boot you see a menu intended for developers with all the internal names for each game. At this point, all of the content from the game image file was now able to be run in an emulator.</p>
<p><img src="https://www.infochunk.com/schannel/sep96helpindex.png" width="320" alt="Sega Channel September 1996 manual index screenshot"/>
<img src="https://www.infochunk.com/schannel/sep96help.png" width="320" alt="Sega Channel September 1996 manual screenshot"/>
</p>

<h3>Conclusion</h3>
<p>I have to thank Tdijital for releasing the Sega Channel development backup CD, Octocontrabass for reverse engineeering the .SA compression format, and whoever at Scientific Atlanta compiled NSF.EXE in debug mode. This project would have been much harder without all of their assistance. Most of all, I have to thank RisingFromRuins for releasing the game image file. I hope if anyone else has a Sega Channel game image disc, they follow his example.</p>

<h3>Downloads</h3>
<ul>
<li><a href="https://www.infochunk.com/schannel/sep96_unique_roms.zip">Unique ROMs from the game image file</a></li>
<li><a href="https://www.infochunk.com/schannel/sep96menu.bin">Sega Channel September 1996 menu demo ROM</a></li>
<li><a href="https://www.infochunk.com/schannel/sep96help.bin">Sega Channel September 1996 game instructions ROM</a></li>
</ul>

</div>
  </body>
</html>
