<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://domluna.com/blog/tiny-binary-rag">Original</a>
    <h1>Exact binary vector search for RAG in 100 lines of Julia</h1>
    
    <div id="readability-page-1" class="page"><div><section><p>May 16, 2024</p><article><blockquote>
<p><a target="_blank" rel="noopener noreferrer" href="https://github.com/domluna/tinyrag/tree/main">source</a></p>
</blockquote>
<p>I wanted to experiment in how quickly precise RAG lookups could be performed with a binary vector space.</p>
<p>Why binary?</p>
<p>It turns out the accuracy is <a target="_blank" rel="noopener noreferrer" href="https://huggingface.co/blog/embedding-quantization">very similar to a full 32-bit vector</a>. But we save a lot in terms of server costs, and it makes in-memory retrieval more feasible.</p>
<p>A database that was once 1TB is now ~32GB, which can easily fit in RAM on a much cheaper setup.</p>
<p>Assuming each row is a 1024-dim float32 vector, that&#39;s 4096 bytes per row. or ~244 million rows.</p>
<p>For some added context Wikipedia, which is arguably the largest publicly available data to RAG might only be around 15 million rows.</p>
<p>https://en.wikipedia.org/wiki/Wikipedia:Size_of_Wikipedia</p>
<ul>
<li>6,818,523 articles</li>
<li>average 668 words per article (4.55B billion words)</li>
<li>According to OpenAI <a target="_blank" rel="noopener noreferrer" href="https://openai.com/api/pricing/">750 words is roughly 1000 tokens</a>. So let&#39;s say 6B tokens.</li>
<li>if we use the mixedbread model we can represent 512 tokens in a vector, assuming overlap let’s say 400 tokens new tokens in each vector with 112 being used for overlap</li>
</ul>
<p>6B / 400 = ~15,000,000 vectors</p>
<p>Chances are internal RAGs are going to be significantly smaller than this.</p>
<p>And so this opens up the question:</p>
<p>&#34;At what point is the dataset too big that exact brute search over binary vectors is not entirely feasible?&#34;</p>
<p>If our dataset is smaller than this, then we can just do the dumb thing in a very small amount of code and be completely fine.</p>
<p>We might not need a fancy vector DB or the newest HSNW library (HNSW is approximate search anyway, we&#39;re doing exact).</p>
<p>I&#39;m doing this in Julia because:</p>
<ol>
<li>I like it. :-)</li>
<li>It should be able to get comparable performance for this relative to C, C++ or Rust. So we&#39;re not missing out on potential gains.</li>
</ol>
<pre><code><span><span>julia</span><span>&gt;</span><span> </span><span>versioninfo</span><span>(</span><span>)</span><span></span></span>
<span><span>Julia</span><span> </span><span>Version</span><span> </span><span>1</span><span>.</span><span>11</span><span>.</span><span>0</span><span>-</span><span>beta1</span><span></span></span>
<span><span>Commit</span><span> </span><span>08e1fc0abb9</span><span> </span><span>(</span><span>2024</span><span>-</span><span>04</span><span>-</span><span>10</span><span> </span><span>08</span><span>:</span><span>40</span><span> </span><span>UTC</span><span>)</span><span></span></span>
<span><span>Build</span><span> </span><span>Info</span><span>:</span><span></span></span>
<span><span>  </span><span>Official</span><span> </span><span>https</span><span>:</span></span>
<span><span>Platform</span><span> </span><span>Info</span><span>:</span><span></span></span>
<span><span>  </span><span>OS</span><span>:</span><span> </span><span>macOS</span><span> </span><span>(</span><span>arm64</span><span>-</span><span>apple</span><span>-</span><span>darwin22</span><span>.</span><span>4</span><span>.</span><span>0</span><span>)</span><span></span></span>
<span><span>  </span><span>CPU</span><span>:</span><span> </span><span>8</span><span> </span><span>×</span><span> </span><span>Apple</span><span> </span><span>M1</span><span></span></span>
<span><span>  </span><span>WORD_SIZE</span><span>:</span><span> </span><span>64</span><span></span></span>
<span><span>  </span><span>LLVM</span><span>:</span><span> </span><span>libLLVM</span><span>-</span><span>16</span><span>.</span><span>0</span><span>.</span><span>6</span><span> </span><span>(</span><span>ORCJIT</span><span>,</span><span> </span><span>apple</span><span>-</span><span>m1</span><span>)</span><span></span></span>
<span><span>Threads</span><span>:</span><span> </span><span>4</span><span> </span><span>default</span><span>,</span><span> </span><span>0</span><span> </span><span>interactive</span><span>,</span><span> </span><span>2</span><span> </span><span>GC</span><span> </span><span>(</span><span>on</span><span> </span><span>4</span><span> </span><span>virtual</span><span> </span><span>cores</span><span>)</span><span></span></span>
<span><span>Environment</span><span>:</span><span></span></span>
<span><span>  </span><span>JULIA_STACKTRACE_MINIMAL</span><span> </span><span>=</span><span> </span><span>true</span><span></span></span>
<span><span>  </span><span>DYLD_LIBRARY_PATH</span><span> </span><span>=</span><span> </span><span>/Users/lunaticd</span><span>/</span><span>.</span><span>wasmedge</span><span>/</span><span>lib</span><span></span></span>
<span><span>  </span><span>JULIA_EDITOR</span><span> </span><span>=</span><span> </span><span>nvim</span><span></span></span></code></pre>
<p>Ok, let&#39;s begin!</p>
<h2 id="implementation"><a href="#implementation"></a>Implementation</h2>
<p>Each vector is going to be n bits, where n in the size of the embedding. This will vary depending on the embedder used, there are several proprietary and open source variations. I&#39;ll be assuming we&#39;re using the mixedbread model: <code><span><span>mixedbread</span><span>-</span><span>ai</span><span>/</span><span>mxbai</span><span>-</span><span>embed</span><span>-</span><span>large</span><span>-</span><span>v1</span></span></code></p>
<p>This model returns a 1024 element float32 vector. Through binarization, this is converted into a 1024 bit vector, which is then represented as a 128 element int8 vector or 128 bytes. Additionally, this can be further reduced to <a target="_blank" rel="noopener noreferrer" href="https://www.mixedbread.ai/blog/binary-mrl">64 bytes</a>, which is our final representation.</p>
<p>A 512 bit vector represented as 64 int8 or uint8 elements.</p>
<pre><code><span><span>julia</span><span>&gt;</span><span> </span><span>x</span><span> </span><span>=</span><span> </span><span>rand</span><span>(</span><span>Int8</span><span>,</span><span> </span><span>64</span><span>)</span><span></span></span>
<span><span>64</span><span>-</span><span>element</span><span> </span><span>Vector</span><span>{</span><span>Int8</span><span>}</span><span>:</span><span></span></span>
<span><span>   </span><span>26</span><span></span></span>
<span><span>  </span><span>123</span><span></span></span>
<span><span>   </span><span>70</span><span></span></span>
<span><span>   </span><span>-</span><span>2</span><span></span></span>
<span><span>    </span><span>⋮</span><span></span></span></code></pre>
<p>Keep in mind that although the representation is in bytes we&#39;re operating at the bit level.</p>
<p>Comparing two bit vectors will require using the <a target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/Hamming_distance#">Hamming distance</a>. Luckily the definition is very straightforward, each time a bit in the vectors doesn&#39;t match add 1 to the distance. So two bit vectors of length 512 that are entirely different will have a hamming distance of 512, and if they are the same a distance of 0.</p>
<p>An easy to do this is to turn the integer representation into a bitstring and then compute the distance on that.</p>
<pre><code><span><span>julia</span><span>&gt;</span><span> </span><span>bitstring</span><span>(</span><span>Int8</span><span>(</span><span>125</span><span>)</span><span>)</span><span></span></span>
<span><span>&#34;</span><span>01111101</span><span>&#34;</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>bitstring</span><span>(</span><span>Int8</span><span>(</span><span>33</span><span>)</span><span>)</span><span></span></span>
<span><span>&#34;</span><span>00100001</span><span>&#34;</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>function</span><span> </span><span>hamming_distance</span><span>(</span><span>s1</span><span>:</span><span>:</span><span>AbstractString</span><span>,</span><span> </span><span>s2</span><span>:</span><span>:</span><span>AbstractString</span><span>)</span><span>:</span><span>:</span><span>Int</span><span></span></span>
<span><span>           </span><span>s</span><span> </span><span>=</span><span> </span><span>0</span><span></span></span>
<span><span>           </span><span>for</span><span> </span><span>(</span><span>c1</span><span>,</span><span> </span><span>c2</span><span>)</span><span> </span><span>in</span><span> </span><span>zip</span><span>(</span><span>s1</span><span>,</span><span> </span><span>s2</span><span>)</span><span></span></span>
<span><span>               </span><span>if</span><span> </span><span>c1</span><span> </span><span>!</span><span>=</span><span> </span><span>c2</span><span></span></span>
<span><span>                   </span><span>s</span><span> </span><span>+</span><span>=</span><span> </span><span>1</span><span></span></span>
<span><span>               </span><span>end</span><span></span></span>
<span><span>           </span><span>end</span><span></span></span>
<span><span>           </span><span>s</span><span></span></span>
<span><span>       </span><span>end</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>hamming_distance</span><span>(</span><span>bitstring</span><span>(</span><span>Int8</span><span>(</span><span>125</span><span>)</span><span>)</span><span>,</span><span> </span><span>bitstring</span><span>(</span><span>Int8</span><span>(</span><span>33</span><span>)</span><span>)</span><span>)</span><span> </span><span>#</span><span> </span><span>should</span><span> </span><span>be</span><span> </span><span>4</span><span></span></span>
<span><span>4</span><span></span></span></code></pre>
<p>Julia has a lovely benchmarking package called <code><span><span>Chairmarks</span></span></code>. Let&#39;s see how fast this implementation is.</p>
<pre><code><span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>using</span><span> </span><span>Chairmarks</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>hamming_distance</span><span>(</span><span>bitstring</span><span>(</span><span>Int8</span><span>(</span><span>125</span><span>)</span><span>)</span><span>,</span><span> </span><span>bitstring</span><span>(</span><span>Int8</span><span>(</span><span>33</span><span>)</span><span>)</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>6053</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>317</span><span> </span><span>evaluations</span><span></span></span>
<span><span>min</span><span> </span><span>   </span><span>36</span><span>.</span><span>672</span><span> </span><span>ns</span><span> </span><span>(</span><span>4</span><span> </span><span>allocs</span><span>:</span><span> </span><span>128</span><span> </span><span>bytes</span><span>)</span><span></span></span>
<span><span>median</span><span> </span><span>38</span><span>.</span><span>514</span><span> </span><span>ns</span><span> </span><span>(</span><span>4</span><span> </span><span>allocs</span><span>:</span><span> </span><span>128</span><span> </span><span>bytes</span><span>)</span><span></span></span>
<span><span>mean</span><span> </span><span>  </span><span>46</span><span>.</span><span>525</span><span> </span><span>ns</span><span> </span><span>(</span><span>4</span><span> </span><span>allocs</span><span>:</span><span> </span><span>128</span><span> </span><span>bytes</span><span>,</span><span> </span><span>0</span><span>.</span><span>13</span><span>%</span><span> </span><span>gc</span><span> </span><span>time</span><span>)</span><span></span></span>
<span><span>max</span><span> </span><span>   </span><span>8</span><span>.</span><span>737</span><span> </span><span>μs</span><span> </span><span>(</span><span>4</span><span> </span><span>allocs</span><span>:</span><span> </span><span>128</span><span> </span><span>bytes</span><span>,</span><span> </span><span>98</span><span>.</span><span>30</span><span>%</span><span> </span><span>gc</span><span> </span><span>time</span><span>)</span><span></span></span></code></pre>
<p>This is honestly pretty good. For comparison let&#39;s do a simple addition:</p>
<pre><code><span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>125</span><span> </span><span>+</span><span> </span><span>33</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>7274</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>8775</span><span> </span><span>evaluations</span><span></span></span>
<span><span>min</span><span> </span><span>   </span><span>1</span><span>.</span><span>239</span><span> </span><span>ns</span><span></span></span>
<span><span>median</span><span> </span><span>1</span><span>.</span><span>339</span><span> </span><span>ns</span><span></span></span>
<span><span>mean</span><span> </span><span>  </span><span>1</span><span>.</span><span>453</span><span> </span><span>ns</span><span></span></span>
<span><span>max</span><span> </span><span>   </span><span>6</span><span>.</span><span>990</span><span> </span><span>ns</span><span></span></span></code></pre>
<p>We&#39;re not going to get lower than this for an operation. The nanosecond is basically the atomic measurement unit for time when working with CPUs.</p>
<p>However, this does not mean each operation has to take ~1ns. There are various optimizations that hardware can do such that <a target="_blank" rel="noopener noreferrer" href="https://ppc.cs.aalto.fi/ch1/#:~:text=Hence%2C%20a%20modern%204%2Dcore,billion%20clock%20cycles%20per%20second">several operations are done each clock cycle</a>. Each core of a CPU has a number of arithmetic units which are used to process elementary operations (addition, subtraction, xor, or, and, etc), the arithmetic units are fed by what is known as pipelining. The point is there is more than 1 arithmetic unit, so we can conceivably do several additons or bit operations in the same clock cycle as long as they do not depend on each other. Let&#39;s rewrite <code><span><span>hamming_distance</span></span></code> using only elementary operations so that we might take advantage of this.</p>
<p>Let&#39;s consider comparing two bits:</p>
<ul>
<li>0, 0 -&gt; 0</li>
<li>1, 0 -&gt; 1</li>
<li>0, 1 -&gt; 1</li>
<li>1, 1 -&gt; 0</li>
</ul>
<p>This is the XOR operation. We want to XOR all the bits and keep track of which ones are 1, and return the sum.</p>
<p>In order to do this over all the bits we can shift the integer by the number of bits, for an 8-bit number we would perform the shift 7 times.</p>
<p>Here&#39;s what this looks like:</p>
<pre><code><span><span>@</span><span>inline</span><span> </span><span>function</span><span> </span><span>hamming_distance</span><span>(</span><span>x1</span><span>:</span><span>:</span><span>T</span><span>,</span><span> </span><span>x2</span><span>:</span><span>:</span><span>T</span><span>)</span><span>:</span><span>:</span><span>Int</span><span> </span><span>where</span><span> </span><span>{</span><span>T</span><span>&lt;</span><span>:</span><span>Union</span><span>{</span><span>Int8</span><span>,</span><span>UInt8</span><span>}</span><span>}</span><span></span></span>
<span><span>    </span><span>r</span><span> </span><span>=</span><span> </span><span>x1</span><span> </span><span>⊻</span><span> </span><span>x2</span><span> </span><span>#</span><span> </span><span>xor</span><span></span></span>
<span><span>    </span><span>#</span><span> </span><span>how</span><span> </span><span>many</span><span> </span><span>xored</span><span> </span><span>bits</span><span> </span><span>are</span><span> </span><span>1</span><span></span></span>
<span><span>    </span><span>c</span><span> </span><span>=</span><span> </span><span>0</span><span></span></span>
<span><span>    </span><span>for</span><span> </span><span>i</span><span> </span><span>in</span><span> </span><span>0</span><span>:</span><span>7</span><span></span></span>
<span><span>        </span><span>c</span><span> </span><span>+</span><span>=</span><span> </span><span>(</span><span>r</span><span> </span><span>&gt;</span><span>&gt;</span><span> </span><span>i</span><span>)</span><span> </span><span>&amp;</span><span> </span><span>1</span><span></span></span>
<span><span>    </span><span>end</span><span></span></span>
<span><span>    </span><span>return</span><span> </span><span>Int</span><span>(</span><span>c</span><span>)</span><span></span></span>
<span><span>end</span><span></span></span>
<span><span></span></span>
<span><span>#</span><span> </span><span>benchmark</span><span> </span><span>again</span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>hamming_distance</span><span>(</span><span>Int8</span><span>(</span><span>33</span><span>)</span><span>,</span><span> </span><span>Int8</span><span>(</span><span>125</span><span>)</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>4797</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>8966</span><span> </span><span>evaluations</span><span></span></span>
<span><span>min</span><span> </span><span>   </span><span>2</span><span>.</span><span>175</span><span> </span><span>ns</span><span></span></span>
<span><span>median</span><span> </span><span>2</span><span>.</span><span>189</span><span> </span><span>ns</span><span></span></span>
<span><span>mean</span><span> </span><span>  </span><span>2</span><span>.</span><span>205</span><span> </span><span>ns</span><span></span></span>
<span><span>max</span><span> </span><span>   </span><span>5</span><span>.</span><span>279</span><span> </span><span>ns</span><span></span></span></code></pre>
<p>This is huge improvement, almost as fast as doing an addition operation!</p>
<p>Now we need to do this for an vector:</p>
<pre><code><span><span>@</span><span>inline</span><span> </span><span>function</span><span> </span><span>hamming_distance1</span><span>(</span><span>x1</span><span>:</span><span>:</span><span>AbstractArray</span><span>{</span><span>T</span><span>}</span><span>,</span><span> </span><span>x2</span><span>:</span><span>:</span><span>AbstractArray</span><span>{</span><span>T</span><span>}</span><span>)</span><span>:</span><span>:</span><span>Int</span><span> </span><span>where</span><span> </span><span>{</span><span>T</span><span>&lt;</span><span>:</span><span>Union</span><span>{</span><span>Int8</span><span>,</span><span>UInt8</span><span>}</span><span>}</span><span></span></span>
<span><span>    </span><span>s</span><span> </span><span>=</span><span> </span><span>0</span><span></span></span>
<span><span>    </span><span>for</span><span> </span><span>i</span><span> </span><span>in</span><span> </span><span>1</span><span>:</span><span>length</span><span>(</span><span>x1</span><span>)</span><span></span></span>
<span><span>        </span><span>s</span><span> </span><span>+</span><span>=</span><span> </span><span>hamming_distance</span><span>(</span><span>x1</span><span>[</span><span>i</span><span>]</span><span>,</span><span> </span><span>x2</span><span>[</span><span>i</span><span>]</span><span>)</span><span></span></span>
<span><span>    </span><span>end</span><span></span></span>
<span><span>    </span><span>s</span><span></span></span>
<span><span>end</span><span></span></span></code></pre>
<p>We expect this to take around 128ns (~2 * 64).</p>
<pre><code><span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>hamming_distance1</span><span>(</span><span>q1</span><span>,</span><span> </span><span>q2</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>4469</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>256</span><span> </span><span>evaluations</span><span></span></span>
<span><span>min</span><span> </span><span>   </span><span>69</span><span>.</span><span>500</span><span> </span><span>ns</span><span></span></span>
<span><span>median</span><span> </span><span>75</span><span>.</span><span>035</span><span> </span><span>ns</span><span></span></span>
<span><span>mean</span><span> </span><span>  </span><span>80</span><span>.</span><span>240</span><span> </span><span>ns</span><span></span></span>
<span><span>max</span><span> </span><span>   </span><span>189</span><span>.</span><span>941</span><span> </span><span>ns</span><span></span></span></code></pre>
<p>There are a few more things we can do do further optimize this loop, the compiler sometimes does these automatically but we can manually annotate it to be certain.</p>
<pre><code><span><span>@</span><span>inline</span><span> </span><span>function</span><span> </span><span>hamming_distance</span><span>(</span><span>x1</span><span>:</span><span>:</span><span>AbstractArray</span><span>{</span><span>T</span><span>}</span><span>,</span><span> </span><span>x2</span><span>:</span><span>:</span><span>AbstractArray</span><span>{</span><span>T</span><span>}</span><span>)</span><span>:</span><span>:</span><span>Int</span><span> </span><span>where</span><span> </span><span>{</span><span>T</span><span>&lt;</span><span>:</span><span>Union</span><span>{</span><span>Int8</span><span>,</span><span>UInt8</span><span>}</span><span>}</span><span></span></span>
<span><span>    </span><span>s</span><span> </span><span>=</span><span> </span><span>0</span><span></span></span>
<span><span>    </span><span>@</span><span>inbounds</span><span> </span><span>@</span><span>simd</span><span> </span><span>for</span><span> </span><span>i</span><span> </span><span>in</span><span> </span><span>eachindex</span><span>(</span><span>x1</span><span>,</span><span> </span><span>x2</span><span>)</span><span></span></span>
<span><span>        </span><span>s</span><span> </span><span>+</span><span>=</span><span> </span><span>hamming_distance</span><span>(</span><span>x1</span><span>[</span><span>i</span><span>]</span><span>,</span><span> </span><span>x2</span><span>[</span><span>i</span><span>]</span><span>)</span><span></span></span>
<span><span>    </span><span>end</span><span></span></span>
<span><span>    </span><span>s</span><span></span></span>
<span><span>end</span><span></span></span></code></pre>
<ul>
<li><code><span><span>@</span><span>inbounds</span></span></code> removes any boundary checking.</li>
<li><code><span><span>@</span><span>simd</span></span></code> tells the compiler to use SIMD instructions if possible.</li>
</ul>
<pre><code><span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>hamming_distance</span><span>(</span><span>q1</span><span>,</span><span> </span><span>q2</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>4441</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>323</span><span> </span><span>evaluations</span><span></span></span>
<span><span>min</span><span> </span><span>   </span><span>52</span><span>.</span><span>759</span><span> </span><span>ns</span><span></span></span>
<span><span>median</span><span> </span><span>56</span><span>.</span><span>245</span><span> </span><span>ns</span><span></span></span>
<span><span>mean</span><span> </span><span>  </span><span>61</span><span>.</span><span>721</span><span> </span><span>ns</span><span></span></span>
<span><span>max</span><span> </span><span>   </span><span>163</span><span>.</span><span>827</span><span> </span><span>ns</span><span></span></span></code></pre>
<p>That&#39;s a decent improvement. This benchmark is 20-30ns on a fresh REPL session. I think it depends current background usage and how well SIMD can be utilized at that time.</p>
<pre><code><span><span>julia</span><span>&gt;</span><span> </span><span>q1</span><span> </span><span>=</span><span> </span><span>rand</span><span>(</span><span>Int8</span><span>,</span><span> </span><span>64</span><span>)</span><span>;</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>q2</span><span> </span><span>=</span><span> </span><span>rand</span><span>(</span><span>Int8</span><span>,</span><span> </span><span>64</span><span>)</span><span>;</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>hamming_distance</span><span>(</span><span>q1</span><span>,</span><span> </span><span>q2</span><span>)</span><span>;</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>hamming_distance</span><span>(</span><span>q1</span><span>,</span><span> </span><span>q2</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>3546</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>1000</span><span> </span><span>evaluations</span><span></span></span>
<span><span>min</span><span> </span><span>   </span><span>23</span><span>.</span><span>333</span><span> </span><span>ns</span><span></span></span>
<span><span>median</span><span> </span><span>23</span><span>.</span><span>459</span><span> </span><span>ns</span><span></span></span>
<span><span>mean</span><span> </span><span>  </span><span>24</span><span>.</span><span>461</span><span> </span><span>ns</span><span></span></span>
<span><span>max</span><span> </span><span>   </span><span>59</span><span>.</span><span>542</span><span> </span><span>ns</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>hamming_distance</span><span>(</span><span>q1</span><span>,</span><span> </span><span>q2</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>4653</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>749</span><span> </span><span>evaluations</span><span></span></span>
<span><span>min</span><span> </span><span>   </span><span>23</span><span>.</span><span>308</span><span> </span><span>ns</span><span></span></span>
<span><span>median</span><span> </span><span>25</span><span>.</span><span>088</span><span> </span><span>ns</span><span></span></span>
<span><span>mean</span><span> </span><span>  </span><span>26</span><span>.</span><span>595</span><span> </span><span>ns</span><span></span></span>
<span><span>max</span><span> </span><span>   </span><span>62</span><span>.</span><span>473</span><span> </span><span>ns</span><span></span></span></code></pre>
<p>It&#39;s good to know in a perfect environment, such as an isolated machine, you could make really good use of the hardware.</p>
<p>Let&#39;s say each comparison takes 50ns, then we can search over 20M rows in a second, or 80M rows if we used 4 cores.</p>
<p>1M rows should take 12ms over 4 cores. And Wikipedia at 15M rows 180ms.</p>
<p>In practice it turns out it&#39;s faster than this:</p>
<pre><code><span><span>mutable</span><span> </span><span>struct</span><span> </span><span>MaxHeap</span><span></span></span>
<span><span>    </span><span>const</span><span> </span><span>data</span><span>:</span><span>:</span><span>Vector</span><span>{</span><span>Pair</span><span>{</span><span>Int</span><span>,</span><span>Int</span><span>}</span><span>}</span><span></span></span>
<span><span>    </span><span>current_idx</span><span>:</span><span>:</span><span>Int</span><span> </span><span>#</span><span> </span><span>add</span><span> </span><span>pairs</span><span> </span><span>until</span><span> </span><span>current_idx</span><span> </span><span>&gt;</span><span> </span><span>length</span><span>(</span><span>data</span><span>)</span><span></span></span>
<span><span>    </span><span>const</span><span> </span><span>k</span><span>:</span><span>:</span><span>Int</span><span></span></span>
<span><span></span></span>
<span><span>    </span><span>function</span><span> </span><span>MaxHeap</span><span>(</span><span>k</span><span>:</span><span>:</span><span>Int</span><span>)</span><span></span></span>
<span><span>        </span><span>new</span><span>(</span><span>fill</span><span>(</span><span>(</span><span>typemax</span><span>(</span><span>Int</span><span>)</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>-</span><span>1</span><span>)</span><span>,</span><span> </span><span>k</span><span>)</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>k</span><span>)</span><span></span></span>
<span><span>    </span><span>end</span><span></span></span>
<span><span>end</span><span></span></span>
<span><span></span></span>
<span><span>function</span><span> </span><span>insert</span><span>!</span><span>(</span><span>heap</span><span>:</span><span>:</span><span>MaxHeap</span><span>,</span><span> </span><span>value</span><span>:</span><span>:</span><span>Pair</span><span>{</span><span>Int</span><span>,</span><span>Int</span><span>}</span><span>)</span><span></span></span>
<span><span>    </span><span>if</span><span> </span><span>heap</span><span>.</span><span>current_idx</span><span> </span><span>&lt;</span><span>=</span><span> </span><span>heap</span><span>.</span><span>k</span><span></span></span>
<span><span>        </span><span>heap</span><span>.</span><span>data</span><span>[</span><span>heap</span><span>.</span><span>current_idx</span><span>]</span><span> </span><span>=</span><span> </span><span>value</span><span></span></span>
<span><span>        </span><span>heap</span><span>.</span><span>current_idx</span><span> </span><span>+</span><span>=</span><span> </span><span>1</span><span></span></span>
<span><span>        </span><span>if</span><span> </span><span>heap</span><span>.</span><span>current_idx</span><span> </span><span>&gt;</span><span> </span><span>heap</span><span>.</span><span>k</span><span></span></span>
<span><span>            </span><span>makeheap</span><span>!</span><span>(</span><span>heap</span><span>)</span><span></span></span>
<span><span>        </span><span>end</span><span></span></span>
<span><span>    </span><span>elseif</span><span> </span><span>value</span><span>.</span><span>first</span><span> </span><span>&lt;</span><span> </span><span>heap</span><span>.</span><span>data</span><span>[</span><span>1</span><span>]</span><span>.</span><span>first</span><span></span></span>
<span><span>        </span><span>heap</span><span>.</span><span>data</span><span>[</span><span>1</span><span>]</span><span> </span><span>=</span><span> </span><span>value</span><span></span></span>
<span><span>        </span><span>heapify</span><span>!</span><span>(</span><span>heap</span><span>,</span><span> </span><span>1</span><span>)</span><span></span></span>
<span><span>    </span><span>end</span><span></span></span>
<span><span>end</span><span></span></span>
<span><span></span></span>
<span><span>function</span><span> </span><span>makeheap</span><span>!</span><span>(</span><span>heap</span><span>:</span><span>:</span><span>MaxHeap</span><span>)</span><span></span></span>
<span><span>    </span><span>for</span><span> </span><span>i</span><span> </span><span>in</span><span> </span><span>div</span><span>(</span><span>heap</span><span>.</span><span>k</span><span>,</span><span> </span><span>2</span><span>)</span><span>:</span><span>-</span><span>1</span><span>:</span><span>1</span><span></span></span>
<span><span>        </span><span>heapify</span><span>!</span><span>(</span><span>heap</span><span>,</span><span> </span><span>i</span><span>)</span><span></span></span>
<span><span>    </span><span>end</span><span></span></span>
<span><span>end</span><span></span></span>
<span><span></span></span>
<span><span>function</span><span> </span><span>heapify</span><span>!</span><span>(</span><span>heap</span><span>:</span><span>:</span><span>MaxHeap</span><span>,</span><span> </span><span>i</span><span>:</span><span>:</span><span>Int</span><span>)</span><span></span></span>
<span><span>    </span><span>left</span><span> </span><span>=</span><span> </span><span>2</span><span> </span><span>*</span><span> </span><span>i</span><span></span></span>
<span><span>    </span><span>right</span><span> </span><span>=</span><span> </span><span>2</span><span> </span><span>*</span><span> </span><span>i</span><span> </span><span>+</span><span> </span><span>1</span><span></span></span>
<span><span>    </span><span>largest</span><span> </span><span>=</span><span> </span><span>i</span><span></span></span>
<span><span></span></span>
<span><span>    </span><span>if</span><span> </span><span>left</span><span> </span><span>&lt;</span><span>=</span><span> </span><span>length</span><span>(</span><span>heap</span><span>.</span><span>data</span><span>)</span><span> </span><span>&amp;</span><span>&amp;</span><span> </span><span>heap</span><span>.</span><span>data</span><span>[</span><span>left</span><span>]</span><span>.</span><span>first</span><span> </span><span>&gt;</span><span> </span><span>heap</span><span>.</span><span>data</span><span>[</span><span>largest</span><span>]</span><span>.</span><span>first</span><span></span></span>
<span><span>        </span><span>largest</span><span> </span><span>=</span><span> </span><span>left</span><span></span></span>
<span><span>    </span><span>end</span><span></span></span>
<span><span></span></span>
<span><span>    </span><span>if</span><span> </span><span>right</span><span> </span><span>&lt;</span><span>=</span><span> </span><span>length</span><span>(</span><span>heap</span><span>.</span><span>data</span><span>)</span><span> </span><span>&amp;</span><span>&amp;</span><span> </span><span>heap</span><span>.</span><span>data</span><span>[</span><span>right</span><span>]</span><span>.</span><span>first</span><span> </span><span>&gt;</span><span> </span><span>heap</span><span>.</span><span>data</span><span>[</span><span>largest</span><span>]</span><span>.</span><span>first</span><span></span></span>
<span><span>        </span><span>largest</span><span> </span><span>=</span><span> </span><span>right</span><span></span></span>
<span><span>    </span><span>end</span><span></span></span>
<span><span></span></span>
<span><span>    </span><span>if</span><span> </span><span>largest</span><span> </span><span>!</span><span>=</span><span> </span><span>i</span><span></span></span>
<span><span>        </span><span>heap</span><span>.</span><span>data</span><span>[</span><span>i</span><span>]</span><span>,</span><span> </span><span>heap</span><span>.</span><span>data</span><span>[</span><span>largest</span><span>]</span><span> </span><span>=</span><span> </span><span>heap</span><span>.</span><span>data</span><span>[</span><span>largest</span><span>]</span><span>,</span><span> </span><span>heap</span><span>.</span><span>data</span><span>[</span><span>i</span><span>]</span><span></span></span>
<span><span>        </span><span>heapify</span><span>!</span><span>(</span><span>heap</span><span>,</span><span> </span><span>largest</span><span>)</span><span></span></span>
<span><span>    </span><span>end</span><span></span></span>
<span><span>end</span><span></span></span>
<span><span></span></span>
<span><span>function</span><span> </span><span>_k_closest</span><span>(</span><span></span></span>
<span><span>    </span><span>db</span><span>:</span><span>:</span><span>AbstractVector</span><span>{</span><span>V</span><span>}</span><span>,</span><span></span></span>
<span><span>    </span><span>query</span><span>:</span><span>:</span><span>AbstractVector</span><span>{</span><span>T</span><span>}</span><span>,</span><span></span></span>
<span><span>    </span><span>k</span><span>:</span><span>:</span><span>Int</span><span>;</span><span></span></span>
<span><span>    </span><span>startind</span><span>:</span><span>:</span><span>Int</span><span> </span><span>=</span><span> </span><span>1</span><span>,</span><span></span></span>
<span><span>)</span><span> </span><span>where</span><span> </span><span>{</span><span>T</span><span>&lt;</span><span>:</span><span>Union</span><span>{</span><span>Int8</span><span>,</span><span>UInt8</span><span>}</span><span>,</span><span>V</span><span>&lt;</span><span>:</span><span>AbstractVector</span><span>{</span><span>T</span><span>}</span><span>}</span><span></span></span>
<span><span>    </span><span>heap</span><span> </span><span>=</span><span> </span><span>MaxHeap</span><span>(</span><span>k</span><span>)</span><span></span></span>
<span><span>    </span><span>@</span><span>inbounds</span><span> </span><span>for</span><span> </span><span>i</span><span> </span><span>in</span><span> </span><span>eachindex</span><span>(</span><span>db</span><span>)</span><span></span></span>
<span><span>        </span><span>d</span><span> </span><span>=</span><span> </span><span>hamming_distance</span><span>(</span><span>db</span><span>[</span><span>i</span><span>]</span><span>,</span><span> </span><span>query</span><span>)</span><span></span></span>
<span><span>        </span><span>insert</span><span>!</span><span>(</span><span>heap</span><span>,</span><span> </span><span>d</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>startind</span><span> </span><span>+</span><span> </span><span>i</span><span> </span><span>-</span><span> </span><span>1</span><span>)</span><span></span></span>
<span><span>    </span><span>end</span><span></span></span>
<span><span>    </span><span>return</span><span> </span><span>heap</span><span>.</span><span>data</span><span></span></span>
<span><span>end</span><span></span></span>
<span><span></span></span>
<span><span>function</span><span> </span><span>k_closest</span><span>(</span><span></span></span>
<span><span>    </span><span>db</span><span>:</span><span>:</span><span>AbstractVector</span><span>{</span><span>V</span><span>}</span><span>,</span><span></span></span>
<span><span>    </span><span>query</span><span>:</span><span>:</span><span>AbstractVector</span><span>{</span><span>T</span><span>}</span><span>,</span><span></span></span>
<span><span>    </span><span>k</span><span>:</span><span>:</span><span>Int</span><span>;</span><span></span></span>
<span><span>    </span><span>startind</span><span>:</span><span>:</span><span>Int</span><span> </span><span>=</span><span> </span><span>1</span><span>,</span><span></span></span>
<span><span>)</span><span> </span><span>where</span><span> </span><span>{</span><span>T</span><span>&lt;</span><span>:</span><span>Union</span><span>{</span><span>Int8</span><span>,</span><span>UInt8</span><span>}</span><span>,</span><span>V</span><span>&lt;</span><span>:</span><span>AbstractVector</span><span>{</span><span>T</span><span>}</span><span>}</span><span></span></span>
<span><span>    </span><span>data</span><span> </span><span>=</span><span> </span><span>_k_closest</span><span>(</span><span>db</span><span>,</span><span> </span><span>query</span><span>,</span><span> </span><span>k</span><span>;</span><span> </span><span>startind</span><span>=</span><span>startind</span><span>)</span><span></span></span>
<span><span>    </span><span>return</span><span> </span><span>sort</span><span>!</span><span>(</span><span>data</span><span>,</span><span> </span><span>by</span><span> </span><span>=</span><span> </span><span>x</span><span> </span><span>-</span><span>&gt;</span><span> </span><span>x</span><span>[</span><span>1</span><span>]</span><span>)</span><span></span></span>
<span><span>end</span><span></span></span>
<span><span></span></span>
<span><span>function</span><span> </span><span>k_closest_parallel</span><span>(</span><span></span></span>
<span><span>    </span><span>db</span><span>:</span><span>:</span><span>AbstractArray</span><span>{</span><span>V</span><span>}</span><span>,</span><span></span></span>
<span><span>    </span><span>query</span><span>:</span><span>:</span><span>AbstractVector</span><span>{</span><span>T</span><span>}</span><span>,</span><span></span></span>
<span><span>    </span><span>k</span><span>:</span><span>:</span><span>Int</span><span>,</span><span></span></span>
<span><span>)</span><span> </span><span>where</span><span> </span><span>{</span><span>T</span><span>&lt;</span><span>:</span><span>Union</span><span>{</span><span>Int8</span><span>,</span><span>UInt8</span><span>}</span><span>,</span><span>V</span><span>&lt;</span><span>:</span><span>AbstractVector</span><span>{</span><span>T</span><span>}</span><span>}</span><span></span></span>
<span><span>    </span><span>n</span><span> </span><span>=</span><span> </span><span>length</span><span>(</span><span>db</span><span>)</span><span></span></span>
<span><span>    </span><span>t</span><span> </span><span>=</span><span> </span><span>nthreads</span><span>(</span><span>)</span><span></span></span>
<span><span>    </span><span>task_ranges</span><span> </span><span>=</span><span> </span><span>[</span><span>(</span><span>i</span><span>:</span><span>min</span><span>(</span><span>i</span><span> </span><span>+</span><span> </span><span>n</span><span> </span><span>÷</span><span> </span><span>t</span><span> </span><span>-</span><span> </span><span>1</span><span>,</span><span> </span><span>n</span><span>)</span><span>)</span><span> </span><span>for</span><span> </span><span>i</span><span> </span><span>=</span><span> </span><span>1</span><span>:</span><span>n÷t</span><span>:</span><span>n</span><span>]</span><span></span></span>
<span><span>    </span><span>tasks</span><span> </span><span>=</span><span> </span><span>map</span><span>(</span><span>task_ranges</span><span>)</span><span> </span><span>do</span><span> </span><span>r</span><span></span></span>
<span><span>        </span><span>Threads</span><span>.</span><span>@</span><span>spawn</span><span> </span><span>_k_closest</span><span>(</span><span>view</span><span>(</span><span>db</span><span>,</span><span> </span><span>r</span><span>)</span><span>,</span><span> </span><span>query</span><span>,</span><span> </span><span>k</span><span>;</span><span> </span><span>startind</span><span>=</span><span>r</span><span>[</span><span>1</span><span>]</span><span>)</span><span></span></span>
<span><span>    </span><span>end</span><span></span></span>
<span><span>    </span><span>results</span><span> </span><span>=</span><span> </span><span>fetch</span><span>.</span><span>(</span><span>tasks</span><span>)</span><span></span></span>
<span><span>    </span><span>sort</span><span>!</span><span>(</span><span>vcat</span><span>(</span><span>results</span><span>.</span><span>.</span><span>.</span><span>)</span><span>,</span><span> </span><span>by</span><span> </span><span>=</span><span> </span><span>x</span><span> </span><span>-</span><span>&gt;</span><span> </span><span>x</span><span>[</span><span>1</span><span>]</span><span>)</span><span>[</span><span>1</span><span>:</span><span>k</span><span>]</span><span></span></span>
<span><span>end</span><span></span></span></code></pre>
<p>The heap structure can be ignored, it&#39;s just a max heap with a maximum size. Each section of the database being searched has it&#39;s own heap and then sort and pick the top k results at the end.</p>
<h2 id="benchmarks"><a href="#benchmarks"></a>Benchmarks</h2>
<p>1M rows benchmark:</p>
<pre><code><span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>X1</span><span> </span><span>=</span><span> </span><span>[</span><span>rand</span><span>(</span><span>Int8</span><span>,</span><span> </span><span>64</span><span>)</span><span> </span><span>for</span><span> </span><span>_</span><span> </span><span>in</span><span> </span><span>1</span><span>:</span><span>(</span><span>10</span><span>^</span><span>6</span><span>)</span><span>]</span><span>;</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>k_closest</span><span>(</span><span>X1</span><span>,</span><span> </span><span>q1</span><span>,</span><span> </span><span>1</span><span>)</span><span></span></span>
<span><span>1</span><span>-</span><span>element</span><span> </span><span>Vector</span><span>{</span><span>Pair</span><span>{</span><span>Int64</span><span>,</span><span> </span><span>Int64</span><span>}</span><span>}</span><span>:</span><span></span></span>
<span><span> </span><span>200</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>770015</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>k_closest</span><span>(</span><span>X1</span><span>,</span><span> </span><span>q1</span><span>,</span><span> </span><span>1</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>7</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>1</span><span> </span><span>evaluation</span><span></span></span>
<span><span>min</span><span> </span><span>   </span><span>14</span><span>.</span><span>767</span><span> </span><span>ms</span><span> </span><span>(</span><span>3</span><span> </span><span>allocs</span><span>:</span><span> </span><span>112</span><span> </span><span>bytes</span><span>)</span><span></span></span>
<span><span>median</span><span> </span><span>14</span><span>.</span><span>811</span><span> </span><span>ms</span><span> </span><span>(</span><span>3</span><span> </span><span>allocs</span><span>:</span><span> </span><span>112</span><span> </span><span>bytes</span><span>)</span><span></span></span>
<span><span>mean</span><span> </span><span>  </span><span>15</span><span>.</span><span>209</span><span> </span><span>ms</span><span> </span><span>(</span><span>3</span><span> </span><span>allocs</span><span>:</span><span> </span><span>112</span><span> </span><span>bytes</span><span>)</span><span></span></span>
<span><span>max</span><span> </span><span>   </span><span>16</span><span>.</span><span>196</span><span> </span><span>ms</span><span> </span><span>(</span><span>3</span><span> </span><span>allocs</span><span>:</span><span> </span><span>112</span><span> </span><span>bytes</span><span>)</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>k_closest_parallel</span><span>(</span><span>X1</span><span>,</span><span> </span><span>q1</span><span>,</span><span> </span><span>1</span><span>)</span><span></span></span>
<span><span>1</span><span>-</span><span>element</span><span> </span><span>Vector</span><span>{</span><span>Pair</span><span>{</span><span>Int64</span><span>,</span><span> </span><span>Int64</span><span>}</span><span>}</span><span>:</span><span></span></span>
<span><span> </span><span>200</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>770015</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>k_closest_parallel</span><span>(</span><span>X1</span><span>,</span><span> </span><span>q1</span><span>,</span><span> </span><span>1</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>24</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>1</span><span> </span><span>evaluation</span><span></span></span>
<span><span>min</span><span> </span><span>   </span><span>4</span><span>.</span><span>061</span><span> </span><span>ms</span><span> </span><span>(</span><span>54</span><span> </span><span>allocs</span><span>:</span><span> </span><span>3</span><span>.</span><span>422</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>median</span><span> </span><span>4</span><span>.</span><span>097</span><span> </span><span>ms</span><span> </span><span>(</span><span>54</span><span> </span><span>allocs</span><span>:</span><span> </span><span>3</span><span>.</span><span>422</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>mean</span><span> </span><span>  </span><span>4</span><span>.</span><span>187</span><span> </span><span>ms</span><span> </span><span>(</span><span>54</span><span> </span><span>allocs</span><span>:</span><span> </span><span>3</span><span>.</span><span>422</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>max</span><span> </span><span>   </span><span>5</span><span>.</span><span>060</span><span> </span><span>ms</span><span> </span><span>(</span><span>54</span><span> </span><span>allocs</span><span>:</span><span> </span><span>3</span><span>.</span><span>422</span><span> </span><span>KiB</span><span>)</span><span></span></span></code></pre>
<p>Each vector comparison is ~15ns rather than ~50ns.</p>
<p>But wait, There&#39;s more! We can do even better using <code><span><span>StaticArrays</span></span></code>:</p>
<pre><code><span><span>using</span><span> </span><span>StaticArrays</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>q1</span><span> </span><span>=</span><span> </span><span>SVector</span><span>{</span><span>64</span><span>,</span><span> </span><span>Int8</span><span>}</span><span>(</span><span>rand</span><span>(</span><span>Int8</span><span>,</span><span> </span><span>64</span><span>)</span><span>)</span><span>;</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>X1</span><span> </span><span>=</span><span> </span><span>[</span><span>SVector</span><span>{</span><span>64</span><span>,</span><span> </span><span>Int8</span><span>}</span><span>(</span><span>rand</span><span>(</span><span>Int8</span><span>,</span><span> </span><span>64</span><span>)</span><span>)</span><span> </span><span>for</span><span> </span><span>_</span><span> </span><span>in</span><span> </span><span>1</span><span>:</span><span>(</span><span>10</span><span>^</span><span>6</span><span>)</span><span>]</span><span>;</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>k_closest</span><span>(</span><span>X1</span><span>,</span><span> </span><span>q1</span><span>,</span><span> </span><span>1</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>9</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>1</span><span> </span><span>evaluation</span><span></span></span>
<span><span>min</span><span> </span><span>   </span><span>11</span><span>.</span><span>551</span><span> </span><span>ms</span><span> </span><span>(</span><span>3</span><span> </span><span>allocs</span><span>:</span><span> </span><span>112</span><span> </span><span>bytes</span><span>)</span><span></span></span>
<span><span>median</span><span> </span><span>11</span><span>.</span><span>555</span><span> </span><span>ms</span><span> </span><span>(</span><span>3</span><span> </span><span>allocs</span><span>:</span><span> </span><span>112</span><span> </span><span>bytes</span><span>)</span><span></span></span>
<span><span>mean</span><span> </span><span>  </span><span>11</span><span>.</span><span>669</span><span> </span><span>ms</span><span> </span><span>(</span><span>3</span><span> </span><span>allocs</span><span>:</span><span> </span><span>112</span><span> </span><span>bytes</span><span>)</span><span></span></span>
<span><span>max</span><span> </span><span>   </span><span>12</span><span>.</span><span>272</span><span> </span><span>ms</span><span> </span><span>(</span><span>3</span><span> </span><span>allocs</span><span>:</span><span> </span><span>112</span><span> </span><span>bytes</span><span>)</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>k_closest_parallel</span><span>(</span><span>X1</span><span>,</span><span> </span><span>q1</span><span>,</span><span> </span><span>1</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>31</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>1</span><span> </span><span>evaluation</span><span></span></span>
<span><span>min</span><span> </span><span>   </span><span>3</span><span>.</span><span>132</span><span> </span><span>ms</span><span> </span><span>(</span><span>54</span><span> </span><span>allocs</span><span>:</span><span> </span><span>3</span><span>.</span><span>672</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>median</span><span> </span><span>3</span><span>.</span><span>136</span><span> </span><span>ms</span><span> </span><span>(</span><span>54</span><span> </span><span>allocs</span><span>:</span><span> </span><span>3</span><span>.</span><span>672</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>mean</span><span> </span><span>  </span><span>3</span><span>.</span><span>161</span><span> </span><span>ms</span><span> </span><span>(</span><span>54</span><span> </span><span>allocs</span><span>:</span><span> </span><span>3</span><span>.</span><span>672</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>max</span><span> </span><span>   </span><span>3</span><span>.</span><span>385</span><span> </span><span>ms</span><span> </span><span>(</span><span>54</span><span> </span><span>allocs</span><span>:</span><span> </span><span>3</span><span>.</span><span>672</span><span> </span><span>KiB</span><span>)</span><span></span></span></code></pre>
<p>Now each vector comparison is taking ~11ns!</p>
<p>However, we don&#39;t want just closest vector, but the &#34;k&#34; closest ones, so let&#39;s set &#34;k&#34; to something more realistic:</p>
<pre><code><span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>k_closest</span><span>(</span><span>X1</span><span>,</span><span> </span><span>q1</span><span>,</span><span> </span><span>20</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>8</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>1</span><span> </span><span>evaluation</span><span></span></span>
<span><span>min</span><span> </span><span>   </span><span>11</span><span>.</span><span>559</span><span> </span><span>ms</span><span> </span><span>(</span><span>5</span><span> </span><span>allocs</span><span>:</span><span> </span><span>832</span><span> </span><span>bytes</span><span>)</span><span></span></span>
<span><span>median</span><span> </span><span>11</span><span>.</span><span>759</span><span> </span><span>ms</span><span> </span><span>(</span><span>5</span><span> </span><span>allocs</span><span>:</span><span> </span><span>832</span><span> </span><span>bytes</span><span>)</span><span></span></span>
<span><span>mean</span><span> </span><span>  </span><span>12</span><span>.</span><span>243</span><span> </span><span>ms</span><span> </span><span>(</span><span>5</span><span> </span><span>allocs</span><span>:</span><span> </span><span>832</span><span> </span><span>bytes</span><span>)</span><span></span></span>
<span><span>max</span><span> </span><span>   </span><span>14</span><span>.</span><span>431</span><span> </span><span>ms</span><span> </span><span>(</span><span>5</span><span> </span><span>allocs</span><span>:</span><span> </span><span>832</span><span> </span><span>bytes</span><span>)</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>k_closest_parallel</span><span>(</span><span>X1</span><span>,</span><span> </span><span>q1</span><span>,</span><span> </span><span>20</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>31</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>1</span><span> </span><span>evaluation</span><span></span></span>
<span><span>min</span><span> </span><span>   </span><span>3</span><span>.</span><span>139</span><span> </span><span>ms</span><span> </span><span>(</span><span>64</span><span> </span><span>allocs</span><span>:</span><span> </span><span>9</span><span>.</span><span>391</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>median</span><span> </span><span>3</span><span>.</span><span>149</span><span> </span><span>ms</span><span> </span><span>(</span><span>64</span><span> </span><span>allocs</span><span>:</span><span> </span><span>9</span><span>.</span><span>391</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>mean</span><span> </span><span>  </span><span>3</span><span>.</span><span>165</span><span> </span><span>ms</span><span> </span><span>(</span><span>64</span><span> </span><span>allocs</span><span>:</span><span> </span><span>9</span><span>.</span><span>391</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>max</span><span> </span><span>   </span><span>3</span><span>.</span><span>228</span><span> </span><span>ms</span><span> </span><span>(</span><span>64</span><span> </span><span>allocs</span><span>:</span><span> </span><span>9</span><span>.</span><span>391</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>k_closest</span><span>(</span><span>X1</span><span>,</span><span> </span><span>q1</span><span>,</span><span> </span><span>100</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>9</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>1</span><span> </span><span>evaluation</span><span></span></span>
<span><span>min</span><span> </span><span>   </span><span>11</span><span>.</span><span>598</span><span> </span><span>ms</span><span> </span><span>(</span><span>5</span><span> </span><span>allocs</span><span>:</span><span> </span><span>3</span><span>.</span><span>281</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>median</span><span> </span><span>11</span><span>.</span><span>604</span><span> </span><span>ms</span><span> </span><span>(</span><span>5</span><span> </span><span>allocs</span><span>:</span><span> </span><span>3</span><span>.</span><span>281</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>mean</span><span> </span><span>  </span><span>11</span><span>.</span><span>644</span><span> </span><span>ms</span><span> </span><span>(</span><span>5</span><span> </span><span>allocs</span><span>:</span><span> </span><span>3</span><span>.</span><span>281</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>max</span><span> </span><span>   </span><span>11</span><span>.</span><span>831</span><span> </span><span>ms</span><span> </span><span>(</span><span>5</span><span> </span><span>allocs</span><span>:</span><span> </span><span>3</span><span>.</span><span>281</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>k_closest_parallel</span><span>(</span><span>X1</span><span>,</span><span> </span><span>q1</span><span>,</span><span> </span><span>100</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>31</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>1</span><span> </span><span>evaluation</span><span></span></span>
<span><span>min</span><span> </span><span>   </span><span>3</span><span>.</span><span>174</span><span> </span><span>ms</span><span> </span><span>(</span><span>66</span><span> </span><span>allocs</span><span>:</span><span> </span><span>30</span><span>.</span><span>406</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>median</span><span> </span><span>3</span><span>.</span><span>190</span><span> </span><span>ms</span><span> </span><span>(</span><span>66</span><span> </span><span>allocs</span><span>:</span><span> </span><span>30</span><span>.</span><span>406</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>mean</span><span> </span><span>  </span><span>3</span><span>.</span><span>206</span><span> </span><span>ms</span><span> </span><span>(</span><span>66</span><span> </span><span>allocs</span><span>:</span><span> </span><span>30</span><span>.</span><span>406</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>max</span><span> </span><span>   </span><span>3</span><span>.</span><span>295</span><span> </span><span>ms</span><span> </span><span>(</span><span>66</span><span> </span><span>allocs</span><span>:</span><span> </span><span>30</span><span>.</span><span>406</span><span> </span><span>KiB</span><span>)</span><span></span></span></code></pre>
<p>Similar timings since we&#39;re using a heap to order the entries.</p>
<p>Just for fun let&#39;s search over 15M rows (Wikipedia).</p>
<pre><code><span><span>julia</span><span>&gt;</span><span> </span><span>X1</span><span> </span><span>=</span><span> </span><span>[</span><span>SVector</span><span>{</span><span>64</span><span>,</span><span> </span><span>Int8</span><span>}</span><span>(</span><span>rand</span><span>(</span><span>Int8</span><span>,</span><span> </span><span>64</span><span>)</span><span>)</span><span> </span><span>for</span><span> </span><span>_</span><span> </span><span>in</span><span> </span><span>1</span><span>:</span><span>(</span><span>15</span><span> </span><span>*</span><span> </span><span>10</span><span>^</span><span>6</span><span>)</span><span>]</span><span>;</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>k_closest_parallel</span><span>(</span><span>X1</span><span>,</span><span> </span><span>q1</span><span>,</span><span> </span><span>10</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>3</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>1</span><span> </span><span>evaluation</span><span></span></span>
<span><span>       </span><span>46</span><span>.</span><span>547</span><span> </span><span>ms</span><span> </span><span>(</span><span>56</span><span> </span><span>allocs</span><span>:</span><span> </span><span>5</span><span>.</span><span>625</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>       </span><span>46</span><span>.</span><span>563</span><span> </span><span>ms</span><span> </span><span>(</span><span>56</span><span> </span><span>allocs</span><span>:</span><span> </span><span>5</span><span>.</span><span>625</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>       </span><span>47</span><span>.</span><span>186</span><span> </span><span>ms</span><span> </span><span>(</span><span>56</span><span> </span><span>allocs</span><span>:</span><span> </span><span>5</span><span>.</span><span>625</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>k_closest_parallel</span><span>(</span><span>X1</span><span>,</span><span> </span><span>q1</span><span>,</span><span> </span><span>50</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>3</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>1</span><span> </span><span>evaluation</span><span></span></span>
<span><span>       </span><span>46</span><span>.</span><span>547</span><span> </span><span>ms</span><span> </span><span>(</span><span>58</span><span> </span><span>allocs</span><span>:</span><span> </span><span>14</span><span>.</span><span>062</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>       </span><span>46</span><span>.</span><span>621</span><span> </span><span>ms</span><span> </span><span>(</span><span>58</span><span> </span><span>allocs</span><span>:</span><span> </span><span>14</span><span>.</span><span>062</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>       </span><span>46</span><span>.</span><span>624</span><span> </span><span>ms</span><span> </span><span>(</span><span>58</span><span> </span><span>allocs</span><span>:</span><span> </span><span>14</span><span>.</span><span>062</span><span> </span><span>KiB</span><span>)</span><span></span></span></code></pre>
<p>And over 100,000 rows:</p>
<pre><code><span><span>julia</span><span>&gt;</span><span> </span><span>X1</span><span> </span><span>=</span><span> </span><span>[</span><span>SVector</span><span>{</span><span>64</span><span>,</span><span> </span><span>Int8</span><span>}</span><span>(</span><span>rand</span><span>(</span><span>Int8</span><span>,</span><span> </span><span>64</span><span>)</span><span>)</span><span> </span><span>for</span><span> </span><span>_</span><span> </span><span>in</span><span> </span><span>1</span><span>:</span><span>(</span><span>10</span><span>^</span><span>5</span><span>)</span><span>]</span><span>;</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>k_closest_parallel</span><span>(</span><span>X1</span><span>,</span><span> </span><span>q1</span><span>,</span><span> </span><span>30</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>281</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>1</span><span> </span><span>evaluation</span><span></span></span>
<span><span>min</span><span> </span><span>   </span><span>330</span><span>.</span><span>792</span><span> </span><span>μs</span><span> </span><span>(</span><span>56</span><span> </span><span>allocs</span><span>:</span><span> </span><span>10</span><span>.</span><span>000</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>median</span><span> </span><span>331</span><span>.</span><span>625</span><span> </span><span>μs</span><span> </span><span>(</span><span>56</span><span> </span><span>allocs</span><span>:</span><span> </span><span>10</span><span>.</span><span>000</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>mean</span><span> </span><span>  </span><span>340</span><span>.</span><span>101</span><span> </span><span>μs</span><span> </span><span>(</span><span>56</span><span> </span><span>allocs</span><span>:</span><span> </span><span>10</span><span>.</span><span>000</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>max</span><span> </span><span>   </span><span>729</span><span>.</span><span>500</span><span> </span><span>μs</span><span> </span><span>(</span><span>56</span><span> </span><span>allocs</span><span>:</span><span> </span><span>10</span><span>.</span><span>000</span><span> </span><span>KiB</span><span>)</span><span></span></span></code></pre>
<p>Under 1ms!</p>
<h2 id="object-object"><a href="#object-object"></a><code><span><span>usearch</span></span></code></h2>
<p><a target="_blank" rel="noopener noreferrer" href="https://unum-cloud.github.io/usearch/">usearch</a> appears to be state of the art for in-memory vector similarity searches.</p>
<pre><code><span><span>In</span><span> </span><span>[</span><span>8</span><span>]</span><span>:</span><span> </span><span>from</span><span> </span><span>usearch</span><span>.</span><span>index</span><span> </span><span>import</span><span> </span><span>search</span><span>,</span><span> </span><span>MetricKind</span><span></span></span>
<span><span>   </span><span>.</span><span>.</span><span>.</span><span>:</span><span> </span><span>import</span><span> </span><span>numpy</span><span> </span><span>as</span><span> </span><span>np</span><span></span></span>
<span><span></span></span>
<span><span>In</span><span> </span><span>[</span><span>12</span><span>]</span><span>:</span><span> </span><span>X</span><span> </span><span>=</span><span> </span><span>np</span><span>.</span><span>random</span><span>.</span><span>randint</span><span>(</span><span>-</span><span>128</span><span>,</span><span> </span><span>128</span><span>,</span><span> </span><span>size</span><span>=</span><span>(</span><span>10</span><span>*</span><span>*</span><span>6</span><span>,</span><span> </span><span>64</span><span>)</span><span>,</span><span> </span><span>dtype</span><span>=</span><span>np</span><span>.</span><span>int8</span><span>)</span><span></span></span>
<span><span></span></span>
<span><span>In</span><span> </span><span>[</span><span>13</span><span>]</span><span>:</span><span> </span><span>q</span><span> </span><span>=</span><span> </span><span>np</span><span>.</span><span>random</span><span>.</span><span>randint</span><span>(</span><span>-</span><span>128</span><span>,</span><span> </span><span>128</span><span>,</span><span> </span><span>64</span><span>,</span><span> </span><span>dtype</span><span>=</span><span>np</span><span>.</span><span>int8</span><span>)</span><span></span></span>
<span><span></span></span>
<span><span>In</span><span> </span><span>[</span><span>14</span><span>]</span><span>:</span><span> </span><span>%</span><span>timeit</span><span> </span><span>search</span><span>(</span><span>X</span><span>,</span><span> </span><span>q</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>MetricKind</span><span>.</span><span>Hamming</span><span>,</span><span> </span><span>exact</span><span>=</span><span>True</span><span>)</span><span></span></span>
<span><span>62</span><span>.</span><span>4</span><span> </span><span>ms</span><span> </span><span>±</span><span> </span><span>494</span><span> </span><span>µs</span><span> </span><span>per</span><span> </span><span>loop</span><span> </span><span>(</span><span>mean</span><span> </span><span>±</span><span> </span><span>std</span><span>.</span><span> </span><span>dev</span><span>.</span><span> </span><span>of</span><span> </span><span>7</span><span> </span><span>runs</span><span>,</span><span> </span><span>10</span><span> </span><span>loops</span><span> </span><span>each</span><span>)</span><span></span></span>
<span><span></span></span>
<span><span>In</span><span> </span><span>[</span><span>15</span><span>]</span><span>:</span><span> </span><span>%</span><span>timeit</span><span> </span><span>search</span><span>(</span><span>X</span><span>,</span><span> </span><span>q</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>MetricKind</span><span>.</span><span>Hamming</span><span>,</span><span> </span><span>exact</span><span>=</span><span>True</span><span>,</span><span> </span><span>threads</span><span>=</span><span>4</span><span>)</span><span></span></span>
<span><span>32</span><span>.</span><span>7</span><span> </span><span>ms</span><span> </span><span>±</span><span> </span><span>1</span><span>.</span><span>7</span><span> </span><span>ms</span><span> </span><span>per</span><span> </span><span>loop</span><span> </span><span>(</span><span>mean</span><span> </span><span>±</span><span> </span><span>std</span><span>.</span><span> </span><span>dev</span><span>.</span><span> </span><span>of</span><span> </span><span>7</span><span> </span><span>runs</span><span>,</span><span> </span><span>10</span><span> </span><span>loops</span><span> </span><span>each</span><span>)</span><span></span></span></code></pre>
<p>The Julia implementation is ~6x faster single threaded and ~10x faster when using 4 cores.</p>
<p>Maybe there&#39;s a way to make <code><span><span>usearch</span></span></code> faster, and in all fairness exact search is likely not the priority to get as fast a possible.</p>
<p>That being said this is around 100 lines of Julia code and we&#39;re not doing anything fancy. Even using StaticArrays onlygave around a 25-33% improvement, not anything mindblowing.</p>
<h2 id="conclusion"><a href="#conclusion"></a>Conclusion</h2>
<p>With ~100 lines of Julia code we&#39;re able to achieve state of the art results in exact search similarity search for binary vector spaces.</p>
<p>I don&#39;t know about you but I think this is pretty damn awesome!</p>

<p>I realized I never answered the original question (my bad).</p>
<p>&#34;At what point is the dataset too big that exact brute search over binary vectors is not entirely feasible?&#34;</p>
<p>Well it depends, how many RPS do you need to handle? What is the upper limit on how long the query should take?</p>
<p>Right now were at ~3ms for 1M rows. 10M rows would be ~30ms.</p>
<pre><code><span><span>julia</span><span>&gt;</span><span> </span><span>X1</span><span> </span><span>=</span><span> </span><span>[</span><span>SVector</span><span>{</span><span>64</span><span>,</span><span> </span><span>Int8</span><span>}</span><span>(</span><span>rand</span><span>(</span><span>Int8</span><span>,</span><span> </span><span>64</span><span>)</span><span>)</span><span> </span><span>for</span><span> </span><span>_</span><span> </span><span>in</span><span> </span><span>1</span><span>:</span><span>(</span><span>20</span><span> </span><span>*</span><span> </span><span>10</span><span>^</span><span>6</span><span>)</span><span>]</span><span>;</span><span></span></span>
<span><span></span></span>
<span><span>julia</span><span>&gt;</span><span> </span><span>@</span><span>be</span><span> </span><span>k_closest_parallel</span><span>(</span><span>X1</span><span>,</span><span> </span><span>q1</span><span>,</span><span> </span><span>100</span><span>)</span><span></span></span>
<span><span>Benchmark</span><span>:</span><span> </span><span>2</span><span> </span><span>samples</span><span> </span><span>with</span><span> </span><span>1</span><span> </span><span>evaluation</span><span></span></span>
<span><span>       </span><span>62</span><span>.</span><span>155</span><span> </span><span>ms</span><span> </span><span>(</span><span>58</span><span> </span><span>allocs</span><span>:</span><span> </span><span>23</span><span>.</span><span>906</span><span> </span><span>KiB</span><span>)</span><span></span></span>
<span><span>       </span><span>63</span><span>.</span><span>807</span><span> </span><span>ms</span><span> </span><span>(</span><span>58</span><span> </span><span>allocs</span><span>:</span><span> </span><span>23</span><span>.</span><span>906</span><span> </span><span>KiB</span><span>)</span><span></span></span></code></pre>
<p>Even at 20M rows this query is unlikely to be the bottleneck of the application. 20M rows would be 76GB of the original encoded data vectors: 1024 element 32-bit vector. That&#39;s a big dataset, do you have that dataset? Probably not.</p></article></section></div></div>
  </body>
</html>
