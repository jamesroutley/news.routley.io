<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tracebit.com/blog/a-hard-look-at-guardduty-shortcomings">Original</a>
    <h1>A hard look at AWS GuardDuty shortcomings</h1>
    
    <div id="readability-page-1" class="page"><div><div><h6><em>Is GuardDuty all you need for AWS threat detection? We‚Äôve asked our friend </em><a href="https://ramimac.me/" target="_blank"><em>Rami McCarthy</em></a><em> to dive into GuardDuty‚Äôs performance and consider the potential place for Canary Infrastructure.</em></h6><p>AWS GuardDuty is a belt and suspenders security control for your cloud. However, it‚Äôs often taken as a panacea for cloud threat detection. I wanted to dive deeper and run some concrete experiments. Read on for the results of adversarial simulation, a review of detection latency, and an analysis of projected S3 ransomware timing.</p><p><strong>The conclusion?</strong> GuardDuty has coverage, cost, and efficacy gaps. These limitations make Canary Infrastructure a great complement, with a best-in-class signal-to-noise ratio, consistently low latency, and lower cost. </p><p>If you&#39;re interested in how Tracebit can help, click <strong>Book a demo</strong>¬†above to schedule a call with one of our founders.</p><h3>üè´ GuardDuty 101</h3><p>GuardDuty‚Äôs role as a required control for <a href="https://docs.aws.amazon.com/securityhub/latest/userguide/guardduty-controls.html%23guardduty-1&amp;sa=D&amp;source=editors&amp;ust=1720806142813908&amp;usg=AOvVaw2pR2BsTCzbBwnuCroMlcU5" target="_blank">PCI DSS and NIST.800-53.r5</a> and place in Scott Piper‚Äôs <a href="https://summitroute.com/downloads/aws_security_maturity_roadmap-Summit_Route.pdf">AWS Security Maturity Roadmap</a> is evidence of its cornerstone role in AWS security. It provides a baseline threat detection capability with <a href="https://aws.amazon.com/guardduty/">a mix of signature, heuristic, and machine learning based rules</a>. It‚Äôs strengths lie in:</p><ul role="list"><li>Turn-key setup</li><li>Deep integration with a diverse set of AWS native log sources</li><li>Use of bundled threat intelligence</li></ul><p>The past two years have brought significantly expanded coverage to GuardDuty. AWS has launched <a href="https://aws.amazon.com/blogs/aws/introducing-amazon-guardduty-malware-protection-for-amazon-s3/">Malware Protection for S3</a>, <a href="https://aws.amazon.com/blogs/aws/amazon-guardduty-ec2-runtime-monitoring-is-now-generally-available/">EC2 Runtime Monitoring</a>, <a href="https://aws.amazon.com/blogs/aws/introducing-amazon-guardduty-ecs-runtime-monitoring-including-aws-fargate/">ECS and Fargate support</a>, and <a href="https://aws.amazon.com/blogs/aws/amazon-guardduty-now-supports-amazon-eks-runtime-monitoring/">EKS Runtime Monitoring</a>.</p><p>GuardDuty has a compelling pitch. It has detections for some of the top cloud risks, including:</p><ul role="list"><li>Anomalous S3 usage, indicating exfiltration of data (or ransomware)</li><li>Workloads querying cryptocurrency-related domain names (cryptojacking)</li><li>Stolen EC2 Instance credentials being used by a different AWS account or outside AWS entirely</li></ul><h3>üßê Grading GuardDuty</h3><p>In security, validating assumptions is crucial. Security is a <a href="https://iang.org/papers/market_for_silver_bullets.html">Market for Silver Bullets</a>, where both buyers and sellers have incomplete information. To cut through GuardDuty‚Äôs marketing, I focused on three elements: coverage, cost, and efficacy. To measure efficacy, I conducted multiple hands-on experiments to better approximate GuardDuty‚Äôs performance.</p><h4>Coverage</h4><p>When considering GuardDuty as the exclusive cloud threat detection tool, it is essential to check its coverage. GuardDuty supports fewer than a dozen services<sup>[</sup><a href="#footnote-1"><sup>1]</sup></a>, while AWS is <a href="https://www.awsgeek.com/AWS-History/">rapidly approaching 250</a>. The addition of new SKUs over the past few years has turned much of GuardDuty&#39;s coverage into an optional add-on with additional costs. Rollouts of these new SKUs happen slowly, resulting in patchy regional coverage.<a href="#footnote-2"><sup>[2]</sup></a> </p><p>In total, GuardDuty has <a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-active.html">176 finding types</a>. While more isn‚Äôt always more in threat detection, the infrequent addition of new findings, when paired with the slow expansion of service support, paints a picture of GuardDuty only covering a few core parts of AWS‚Äôs growing attack surface and complexity.</p><h4>Cost</h4><p>An effective security program maximizes return on investment (ROI). To do so, you need to accurately cost out the investment any given control introduces.</p><p>Projecting the cost of GuardDuty can be challenging due to the variety of factors involved. Rates are based on volume of analyzed data, from unpredictable sources like CloudTrail Events, VPC Flow Logs, or DNS Query Logs. The new SKUs add to this complexity, incorporating data from EKS Audit Logs and S3 Data Events.</p><p>GuardDuty costs can quickly spiral out of control, as illustrated by real-world experiences:</p><ul role="list"><li><a href="https://x.com/QuinnyPig/status/1488243625213321216">Corey Quinn had an experience</a> where a third party vendor caused enough cloudtrail events to make GuardDuty the account‚Äôs most expensive service</li><li><a href="https://www.reddit.com/r/aws/comments/wjuu3w/how_to_manage_guardduty_costs/">A Redditor saw</a> monthly charges for S3 Protection creep up from $2.5k to $6.5k in a single account</li><li><a href="https://medium.com/@pjastrza/lowering-guardduty-costs-for-eks-clusters-742b4e868f5f">An EKS Protection user</a> found GuardDuty costs initially were larger than the cost of the cluster itself</li></ul><p>While the cost of foundational GuardDuty features is non-negligible<a href="#footnote-3"><sup>[3]</sup></a>, they are worth enabling. Consider that, according to AWS, <a href="https://aws.amazon.com/about-aws/whats-new/2023/03/amazon-guardduty-enforcement-threat-detection-organization/">90% of the 2000 largest customers</a> do so. Unfortunately, the arithmetic for other features is very case-specific, the price is high, and the best projection model AWS offers involves using the 30-day free trial and checking the bill.</p><h4>Efficacy</h4><p><em>Will GuardDuty detect threats and reduce my risk?</em></p><p>This remaining question is at the heart of validating GuardDuty‚Äôs place in your security program. There are a few inherent tradeoffs to GuardDuty‚Äôs efficacy as a stand alone threat detection tool. First, GuardDuty can miss environmental context. Regardless of the sensitivity of various resources and workloads, GuardDuty findings have a static risk rating. GuardDuty also tends to generate significant noise, including a high volume of Low findings in an account with standard traffic. This leads to a variety of standard guidance on tuning and handling the alert volume, including blanket exclusion of Low findings.<a href="#footnote-4"><sup>[4]</sup></a> Finally, while GuardDuty‚Äôs machine learning models can occasionally filter out important findings, they bring along non-determinism and tend to struggle with low-volume, high impact attacks<a href="#footnote-5"><sup>[5]</sup></a>.</p><p><strong>Adversarial Simulation using Stratus Red Team</strong></p><p>To better understand GuardDuty‚Äôs efficacy, I started by simulating six different attack techniques using <a href="https://stratus-red-team.cloud/">stratus-red-team</a>. Attacks were orchestrated via VPN from diverse geolocations.</p><p>I focused on attacks related to data exfiltration, specifically testing the following Stratus attacks:</p><ul role="list"><li>Retrieve a High Number of Secrets Manager secrets (Batch)</li><li>Retrieve a High Number of Secrets Manager secrets</li><li>Retrieve And Decrypt SSM Parameters</li><li>Exfiltrate EBS Snapshot by Sharing It</li><li>Exfiltrate RDS Snapshot by Sharing</li><li>S3 Ransomware through batch file deletion</li></ul><p>This simulation resulted in zero GuardDuty alerts.<a href="#footnote-6"><sup>[6]</sup></a></p><p><strong>Experiment 2: Detection Validation using </strong><a href="https://github.com/awslabs/amazon-guardduty-tester"><strong>amazon-guardduty-tester</strong></a></p><p>I wanted to follow up the first experiment with an approach that could answer two questions:</p><ol start="1" role="list"><li>Does GuardDuty consistently detect actions in line with its findings?</li><li>How quickly do GuardDuty findings appear?</li></ol><p>To answer these questions, I turned to <a href="https://github.com/awslabs/amazon-guardduty-tester">amazon-guardduty-tester</a>, an AWS published tool for generating GuardDuty findings. This tool uses the CDK to spin up a Kali instance in AWS and the necessary infrastructure to simulate attacks and trigger GuardDuty.</p><p>I attempted to run 12 different findings. Of the 11 that successfully ran, three did not result in the expected GuardDuty findings. It is unclear whether the lack of finding is indicative of an issue with GuardDuty, or with the tester. ¬†</p><ul role="list"><li>Recon:EC2/Portscan</li><li>Recon:IAMUser/TorIPCaller</li><li>PenTest:S3/KaliLinux</li></ul><p>The remaining 8 findings covered ¬†a variety of data sources and threat purposes. Four used DNS logs, two used VPC flow logs, one used data events, and one used management events.</p><ul role="list"><li>UnauthorizedAccess:EC2/TorClient</li><li>CryptoCurrency:EC2/BitcoinTool.B!DNS</li><li>Impact:EC2/MaliciousDomainRequest.Reputation</li><li>Trojan:EC2/DNSDataExfiltration</li><li>UnauthorizedAccess:EC2/SSHBruteForce (triggered 2 findings)</li><li>UnauthorizedAccess:S3/MaliciousIPCaller.Custom</li><li>Backdoor:EC2/C&amp;CActivity.B!DNS (triggered 3 findings)</li><li>Stealth:IAMUser/CloudTrailLoggingDisabled</li></ul><p>The median detection latency was 15 minutes:</p><p>‚Äç</p><p><a href="#" aria-label="open lightbox" aria-haspopup="dialog"><img src="https://cdn.prod.website-files.com/664246e98a546954e1135e70/66957f53a0389c7da9354b4a_guardduty-delay.png" loading="lazy" width="100%" alt="" srcset="https://cdn.prod.website-files.com/664246e98a546954e1135e70/66957f53a0389c7da9354b4a_guardduty-delay.png"/></a></p><p>‚Äç</p><p><strong>S3 Ransomware Benchmarking</strong></p><p>Going further, I wanted to analyze the growing trend of S3 ransomware<a href="#footnote-7"><sup>[7]</sup></a> in the context of GuardDuty‚Äôs efficacy. AWS <a href="https://reinforce.awsevents.com/content/dam/reinforce/2024/slides/TDR432_New-tactics-and-techniques-for-proactive-threat-detection.pdf">has reported a rise in this class of attack [pdf]</a>, which involves exfiltration of data from S3 followed by a ransom note, often paired with data deletion. As we saw in the previous experiment, there can be considerable latency before GuardDuty detections fire. Also, in the first experiment we saw that Status Red Team‚Äôs ‚ÄúS3 Ransomware through batch file deletion‚Äù technique didn‚Äôt trigger GuardDuty at all.</p><p>I wanted to offer a very simplistic benchmark of how quickly a naive attacker could exfiltrate data and then delete it. I avoided optimization, but chose to use <a href="https://github.com/peak/s5cmd">s5cmd</a> as an example of an efficient off the shelf tool. The prior benchmark of s5cmd also included download statistics:</p><figure><p><img src="https://cdn.prod.website-files.com/664246e98a546954e1135e70/66957ecd3d52a0bb562b86ed_get_put_performance.png" loading="lazy" alt=""/></p></figure><p>I tried to match the experimental design, using a c5n.18xlarge instance in the same region as our test bucket. However, I also leveraged a large attached EBS volume, to better simulate the infrastructure needed to directly download a large volume of data.<a href="#footnote-8"><sup>[8]</sup></a></p><p>‚Äç</p><div>
<table><thead>
  <tr>
    <th><span>Operation</span></th>
    <th><span>Data</span></th>
    <th><span>Performance</span></th>
  </tr></thead>
<tbody>
  <tr>
    <td><span>GET</span></td>
    <td><span>50,000 x 1MB files</span></td>
    <td><span>316 MB/s</span></td>
  </tr>
  <tr>
    <td><span>GET</span></td>
    <td><span>1 x 50GB file</span></td>
    <td><span>305 MB/s</span></td>
  </tr>
  <tr>
    <td><span>DELETE</span></td>
    <td><span>50,000 x 1MB files</span></td>
    <td><span>1781 files/s</span></td>
  </tr>
</tbody></table></div><p>‚Äç</p><p>We can pair benchmarks with our test of GuardDuty to assess how GuardDuty might hold up against an S3 ransomware attack.<a href="#footnote-9"><sup>[9]</sup></a></p><p>It‚Äôs worth noting that detecting any malicious actions targeting S3 can be challenging due to the cost and volume of the requisite logs. These logs are also not available by default. For a deeper dive into S3 logging, check out <a href="http://ramimac.me/s3-logging">ramimac.me/s3-logging</a>.</p><p>To be generous, we can take the best case 5:08 latency observed in UnauthorizedAccess:S3/MaliciousIPCaller.Custom:</p><ul role="list"><li>Using our very conservative results, an attacker could exfiltrate 100GB before the alert fires</li><li>Using the s5cmd benchmark, that number is 1.324 TB</li><li>Looking at s3p instead, it would be 2.464 TB</li></ul><p>It‚Äôs clear that GuardDuty‚Äôs alert latency would limit response efficacy, even if you implemented auto-remediation.</p><h3>üê¶ Canary Infra: A Complimentary control</h3><p>I asked at the outset: ‚ÄúIs GuardDuty all you need for AWS threat detection?‚Äù</p><p>Having broken down the cost, coverage, and efficacy limitations of GuardDuty, it‚Äôs clear that it leaves room to buffer your threat detection capabilities. That‚Äôs where <a href="https://tracebit.com/blog/canary-infra-bringing-honeypots-towards-general-adoption">canary infrastructure</a> comes in.</p><p>If you&#39;d like to learn more about how Tracebit can level up your detections - click <strong><em>Book a demo</em></strong> above to schedule a call with one of our founders.</p><p><em>Coverage</em></p><p>Canary infrastructure is flexible and extensible, allowing you to blanket your cloud far beyond GuardDuty‚Äôs ten supported services.</p><p><em>Cost</em> </p><p>The usage-based billing model makes it cheap to deploy. Tracebit automates deployment and maintenance, making it turn-key to operate.</p><p><em>Efficacy</em></p><p>The latency on most canary alerts are bounded by Cloudtrail speed. <a href="https://tracebit.com/blog/how-fast-is-cloudtrail-today-investigating-cloudtrail-delays-using-athena">Tracebit‚Äôs prior research</a> demonstrates that the average CloudTrail delay is around two and a half minutes, substantially faster than our GuardDuty test.</p><p>Canary infrastructure allows you to create high signal alerts, especially as <a href="https://tracebit.com/blog/honeypots-for-intrusion-detection">Tracebit auto-filters false positives driven by security tooling</a>. Alerts are deterministic, firing reliably, unlike GuardDuty‚Äôs anomaly detection.</p><p>Simply publicizing use of canary infrastructure has been proven to be ‚Äù<a href="https://www.usenix.org/publications/loginonline/imposing-cyber-penalty-against-attackers-cyber-deception">effective at impeding attacker forward progress</a>.‚Äù</p><p><strong><em>Footnotes</em></strong></p><p>‚Äç</p></div></div><div><p>Subscribe to receive our latest research in your inbox</p><div><div><p>Thank you! Your submission has been received!</p></div><div><p>Oops! Something went wrong while submitting the form.</p></div></div></div></div>
  </body>
</html>
