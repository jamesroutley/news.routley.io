<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://chrispenner.ca/posts/views-for-debugging">Original</a>
    <h1>You Should Add Debug Views to Your DB</h1>
    
    <div id="readability-page-1" class="page"><article>
        <p>This one will be quick.</p>
<p>Imagine this, you get a report from your bug tracker:</p>
<blockquote>
<p>Sophie got an error when viewing the diff after her most recent push
to her contribution to the <code>@unison/cloud</code> project on Unison
Share</p>
</blockquote>
<p>(BTW, contributions are like pull requests, but for Unison code)</p>
<p>Okay, this is great, we have something to start with, let&#39;s go look
up that contribution and see if any of the data there is suspicious.</p>
<p>Uhhh, okay, I know the error is related to one of Sophie&#39;s
contributions, but how do I actually <strong>find it</strong>?</p>
<p>I know Sophie&#39;s username from the bug report, that helps, but I don&#39;t
know which project she was working on, or what the contribution ID is,
which branches are involved, etc. Okay no problem, our data is
relational, so I can dive in and figure it out with a query:</p>
<div id="cb1"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span>&gt;</span> <span>SELECT</span> </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  contribution.<span>*</span> </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span>FROM</span> contributions <span>AS</span> contribution</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span>JOIN</span> projects <span>AS</span> project </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span>ON</span> contribution.project_id <span>=</span> project.<span>id</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span>JOIN</span> users <span>AS</span> unison_user </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span>ON</span> project.owner <span>=</span> unison_user.<span>id</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span>JOIN</span> users <span>AS</span> contribution_author </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span>ON</span> contribution.author_id <span>=</span> contribution_author.<span>id</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span>JOIN</span> branches <span>AS</span> source_branch </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span>ON</span> contribution.source_branch <span>=</span> source_branch.<span>id</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span>WHERE</span> contribution_author.username <span>=</span> <span>&#39;sophie&#39;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span>AND</span> project.name <span>=</span> <span>&#39;cloud&#39;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span>AND</span> unison_user.username <span>=</span> <span>&#39;unison&#39;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span>ORDER</span> <span>BY</span> source_branch.updated_at <span>DESC</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span>-</span>[ <span>RECORD</span> <span>1</span> ]<span>--------+----------------------------------------------------</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span>id</span>                   | C<span>-</span><span>4567</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>project_id           | P<span>-</span><span>9999</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>contribution_number  | <span>21</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>title                | Fix bug</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>description          | Prevent <span>the</span> app <span>from</span> deleting <span>the</span> User<span>&#39;s hard drive</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span>status               | open</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span>source_branch        | B-1111</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span>target_branch        | B-2222</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span>created_at           | 2025-05-28 13:06:09.532103+00</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span>updated_at           | 2025-05-28 13:54:23.954913+00</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span>author_id            | U-1234</span></span></code></pre></div>
<p>It&#39;s not the worst query I&#39;ve ever had to write out, but if you&#39;re
doing this a couple times a day on a couple different tables, writing
out the joins gets pretty old <strong>real fast</strong>. Especially so
if you&#39;re writing it in a CLI interface where&#39;s it&#39;s a royal pain to
edit the middle of a query.</p>
<p>Even after we get the data we get a very ID heavy view of what&#39;s
going on, what&#39;s the actual project name? What are the branch names?
Etc.</p>
<p>We can solve both of these problems by writing a bunch of joins
<strong>ONCE</strong> by creating a debugging view over the table we&#39;re
interested in. Something like this:</p>
<div id="cb2"><pre><code><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span>CREATE</span> <span>VIEW</span> debug_contributions <span>AS</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span>SELECT</span> </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  contribution.<span>id</span> <span>AS</span> contribution_id,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  contribution.project_id,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  contribution.contribution_number,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  contribution.title,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  contribution.description,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  contribution.status,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  contribution.source_branch <span>as</span> source_branch_id,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  source_branch.name <span>AS</span> source_branch_name,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  source_branch.updated_at <span>AS</span> source_branch_updated_at,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  contribution.target_branch <span>as</span> target_branch_id,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  target_branch.name <span>AS</span> target_branch_name,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  target_branch.updated_at <span>AS</span> target_branch_updated_at,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  contribution.created_at,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  contribution.updated_at,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  contribution.author_id,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  author.username <span>AS</span> author_username,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  author.display_name <span>AS</span> author_name,</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  project.name <span>AS</span> project_name,</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span>&#39;@&#39;</span><span>||</span> project_owner.username <span>||</span> <span>&#39;/&#39;</span> <span>||</span> project.name <span>AS</span> project_shorthand,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  project.owner <span>AS</span> project_owner_id,</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  project_owner.username <span>AS</span> project_owner_username</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span>FROM</span> contributions <span>AS</span> contribution</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span>JOIN</span> projects <span>AS</span> project <span>ON</span> contribution.project_id <span>=</span> project.<span>id</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span>JOIN</span> users <span>AS</span> author <span>ON</span> contribution.author_id <span>=</span> author.<span>id</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span>JOIN</span> users <span>AS</span> project_owner <span>ON</span> project.owner <span>=</span> project_owner.<span>id</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span>JOIN</span> branches <span>AS</span> source_branch <span>ON</span> contribution.source_branch <span>=</span> source_branch.<span>id</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span>JOIN</span> branches <span>AS</span> target_branch <span>ON</span> contribution.target_branch <span>=</span> target_branch.<span>id</span>;</span></code></pre></div>
<p>Okay, that&#39;s a lot to write out at once, but we never need to write
that again. Now if we need to answer the same question we did above we
do:</p>
<div id="cb3"><pre><code><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span>SELECT</span> <span>*</span> <span>from</span> debug_contributions </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span>WHERE</span> author.username <span>=</span> <span>&#39;sophie&#39;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span>AND</span> project_shorthand <span>=</span> <span>&#39;@unison/cloud&#39;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span>ORDER</span> <span>BY</span> source_branch_updated_at <span>DESC</span>;</span></code></pre></div>
<p>Which is <em>considerably</em> easier on both my brain and my
fingers. I also get all the information I could possibly want in the
result!</p>
<p>You can craft one of these debug tables for whatever your needs are
for each and every table you work with, and since it&#39;s just a view, it&#39;s
trivial to update or delete, and doesn&#39;t take any space in the DB
itself.</p>
<p>Obviously querying over
<code>project_shorthand = &#39;@unison/cloud&#39;</code> isn&#39;t going to be able
to use an index, so isn&#39;t going to be the most performant query; but
these are one off queries, so it&#39;s not a concern (to me at least). If
you care about that sort of thing you can leave out the computed columns
so you won&#39;t have to worry about that.</p>
<p>Anyways, that&#39;s it, that&#39;s the whole trick. Go make some debugging
views and save your future self some time.</p>

        <p>
          Hopefully you learned something 🤞! If you did, please consider
          checking out my book: It teaches the principles of using optics in
          Haskell and other functional programming languages and takes you all
          the way from an beginner to wizard in all types of optics! You can get
          it <a href="https://leanpub.com/optics-by-example/">here</a>. Every
          sale helps me justify more time writing blog posts like this one and
          helps me to continue writing educational functional programming
          content. Cheers!
        </p>

        <!--Share buttons-->
        

        <!-- Disqus Comments -->
        <!-- <div id="disqus_thread"></div> -->
        <!-- <script type="text/javascript"> -->
        <!--     var disqus_shortname = 'chrispenner'; -->
        <!--     var disqus_identifier = ''; -->
        <!--     var disqus_url = 'http://chrispenner.ca'; -->

        <!-- (function() { -->
        <!-- var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; -->
        <!-- dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; -->
        <!-- (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); -->
        <!-- })(); -->
        <!-- </script> -->
      </article></div>
  </body>
</html>
