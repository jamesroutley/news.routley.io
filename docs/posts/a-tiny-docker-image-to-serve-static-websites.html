<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lipanski.com/posts/smallest-docker-image-static-website">Original</a>
    <h1>A tiny Docker image to serve static websites</h1>
    
    <div id="readability-page-1" class="page"><div>
      <header>
        
        <a href="https://lipanski.com/"><img src="https://lipanski.com/assets/images/coryphaena-pentadactyla.jpg"/></a>
        
        
        <p>Welcome to my personal website.</p>
      </header>
      <section>
        <!-- <p><em>Scroll down for my blog.</em></p> -->
        <p>
          <em>Salut!</em>
          I&#39;m a Ruby developer with a devops background and leadership experience.
          I have a personal interest in languages like Crystal and Rust.
          You can also find me here: <a href="https://github.com/lipanski" target="blank">GitHub</a> / <a href="https://twitter.com/helloflorin" target="blank">Twitter</a> / <a href="https://www.linkedin.com/in/florinlipan/" target="blank">LinkedIn</a> / <a href="mailto:florinlipan@gmail.com">Email</a>.
        </p>
      </section>
      <section>
        
        <p><a href="https://lipanski.com/"><em>↞ Back</em></a></p>
        

        

<p>Until recently, I used to think that serving static websites from Docker would be a waste of bandwith and storage. Bundling nginx or various other heavy runtimes inside a Docker image for the sole purpose of serving static files didn’t seem like the best idea - Netlify or Github Pages can handle this much better. But my hobby server was sad and cried digital tears.</p>

<p>A recent HackerNews post about <a href="https://justine.lol/redbean/index.html">redbean</a>, a single-binary, super tiny, static file server got me thinking. So begins my journey to find the most time/storage efficient Docker image to serve a static website.</p>

<p>After evaluating a few static file servers with similar specs, I settled for <a href="https://www.acme.com/software/thttpd/">thttpd</a>, which comes with a similar small footprint but seems a bit more battle-tested.</p>

<p>Running <code>thttpd</code> goes like this:</p>

<div><div><pre><code>thttpd -D -h 0.0.0.0 -p 3000 -d /static-website -u static-user -l - -M 60
</code></pre></div></div>

<p>This will launch the server in foreground (<code>-D</code>), listening on host <code>0.0.0.0</code> (<code>-h</code>) and port <code>3000</code> (<code>-p</code>), serving all files inside <code>/static-website</code> (<code>-d</code>) that are accessible to <code>static-user</code> (<code>-u</code>). It will print access logs to <code>STDOUT</code> (<code>-l -</code>) and set the <code>Cache-Control</code> header to <code>60</code> seconds (<code>-M</code>). There are a couple of other neat features, like basic auth, throttling and virtual hosts, which you can read about in the <a href="https://linux.die.net/man/8/thttpd">documentation</a>.</p>

<p>My first attempt uses the small <code>alpine</code> image, which already packages <code>thttpd</code>:</p>

<div><div><pre><code><span>FROM</span><span> alpine:3.13.2</span>

<span># Install thttpd</span>
<span>RUN </span>apk add thttpd

<span># Create a non-root user to own the files and run our server</span>
<span>RUN </span>adduser <span>-D</span> static
<span>USER</span><span> static</span>
<span>WORKDIR</span><span> /home/static</span>

<span># Copy the static website</span>
<span># Use the .dockerignore file to control what ends up inside the image!</span>
<span>COPY</span><span> . .</span>

<span># Run thttpd</span>
<span>CMD</span><span> [&#34;thttpd&#34;, &#34;-D&#34;, &#34;-h&#34;, &#34;0.0.0.0&#34;, &#34;-p&#34;, &#34;3000&#34;, &#34;-d&#34;, &#34;/home/static&#34;, &#34;-u&#34;, &#34;static&#34;, &#34;-l&#34;, &#34;-&#34;, &#34;-M&#34;, &#34;60&#34;]</span>
</code></pre></div></div>

<p>You can build and run the image by calling:</p>

<div><div><pre><code>docker build <span>-t</span> static:latest <span>.</span>
docker run <span>-it</span> <span>--rm</span> <span>-p</span> 3000:3000 static:latest
</code></pre></div></div>

<p>…then browse to <code>http://localhost:3000</code>.</p>

<p>The image builds quickly and, at <em>7.77MB</em>, is fairly small:</p>

<div><div><pre><code>&gt; docker images | grep static
static              latest              cb1750e32562        About an hour ago    7.77MB
</code></pre></div></div>

<p>We can improve further by using Docker <a href="https://hub.docker.com/_/scratch"><code>scratch</code></a>, which is basically a <em>no-op</em> image, light as vacuum. The problem with <code>scratch</code> is that you can’t really do much inside: you can’t create new users, there is no package manager or any executable for that matter - aside from the ones you copied over yourself.</p>

<p>Using the <code>scratch</code> image usually requires a multi-stage approach. We start from <code>alpine</code>, download and compile <code>thttpd</code> as a static binary, create a user, then copy these assets over to <code>scratch</code> and add our static files to the mix:</p>

<div><div><pre><code><span>FROM</span><span> alpine:3.13.2 AS builder</span>

<span>ARG</span><span> THTTPD_VERSION=2.29</span>

<span># Install all dependencies required for compiling thttpd</span>
<span>RUN </span>apk add gcc musl-dev make

<span># Download thttpd sources</span>
<span>RUN </span>wget http://www.acme.com/software/thttpd/thttpd-<span>${</span><span>THTTPD_VERSION</span><span>}</span>.tar.gz <span>\
</span>  <span>&amp;&amp;</span> <span>tar </span>xzf thttpd-<span>${</span><span>THTTPD_VERSION</span><span>}</span>.tar.gz <span>\
</span>  <span>&amp;&amp;</span> <span>mv</span> /thttpd-<span>${</span><span>THTTPD_VERSION</span><span>}</span> /thttpd

<span># Compile thttpd to a static binary which we can copy around</span>
<span>RUN </span><span>cd</span> /thttpd <span>\
</span>  <span>&amp;&amp;</span> ./configure <span>\
</span>  <span>&amp;&amp;</span> make <span>CCOPT</span><span>=</span><span>&#39;-O2 -s -static&#39;</span> thttpd

<span># Create a non-root user to own the files and run our server</span>
<span>RUN </span>adduser <span>-D</span> static

<span># Switch to the scratch image</span>
<span>FROM</span><span> scratch</span>

<span>EXPOSE</span><span> 3000</span>

<span># Copy over the user</span>
<span>COPY</span><span> --from=builder /etc/passwd /etc/passwd</span>

<span># Copy the thttpd static binary</span>
<span>COPY</span><span> --from=builder /thttpd/thttpd /</span>

<span># Use our non-root user</span>
<span>USER</span><span> static</span>
<span>WORKDIR</span><span> /home/static</span>

<span># Copy the static website</span>
<span># Use the .dockerignore file to control what ends up inside the image!</span>
<span>COPY</span><span> . .</span>

<span># Run thttpd</span>
<span>CMD</span><span> [&#34;/thttpd&#34;, &#34;-D&#34;, &#34;-h&#34;, &#34;0.0.0.0&#34;, &#34;-p&#34;, &#34;3000&#34;, &#34;-d&#34;, &#34;/home/static&#34;, &#34;-u&#34;, &#34;static&#34;, &#34;-l&#34;, &#34;-&#34;, &#34;-M&#34;, &#34;60&#34;]</span>
</code></pre></div></div>

<p>Let’s have another look at those numbers:</p>

<div><div><pre><code>&gt; docker images | grep static
static              latest              ab0699ed2690        About a minute ago   186kB
</code></pre></div></div>

<p><img src="https://lipanski.com/assets/images/excellent.png" alt="Excellent"/></p>

<p>The <em>186KB</em> we’re left with correspond to the size of the <em>thttpd</em> static binary and the static files that were copied over, which in my case was just one file containing the text <code>hello world</code>. Note that the <code>alpine</code> step of the multi-stage build is actually quite large in size (<em>~130MB</em>), but it can be reused across builds and doesn’t get pushed to the registry.</p>

<p>At this point, you can convert the image we built so far into a base image for all your static websites and push it to a registry, so that you can skip the <code>alpine</code> step entirely. Or you can simply use <a href="https://hub.docker.com/r/lipanski/docker-static-website">my Docker Hub build</a>:</p>

<div><div><pre><code><span>FROM</span><span> lipanski/docker-static-website:latest</span>

<span>COPY</span><span> . .</span>
</code></pre></div></div>

<p>This produces a single-layer image of <em>186KB</em> + whatever the size of your static website and <em>nothing else</em>. If you need to configure <em>thttpd</em> in a different way, you can just override the <code>CMD</code> line:</p>

<div><div><pre><code><span>FROM</span><span> lipanski/docker-static-website:latest</span>

<span>COPY</span><span> . .</span>

<span>CMD</span><span> [&#34;/thttpd&#34;, &#34;-D&#34;, &#34;-h&#34;, &#34;0.0.0.0&#34;, &#34;-p&#34;, &#34;3000&#34;, &#34;-d&#34;, &#34;/home/static&#34;, &#34;-u&#34;, &#34;static&#34;, &#34;-l&#34;, &#34;-&#34;, &#34;-M&#34;, &#34;60&#34;]</span>
</code></pre></div></div>

<p>To conclude, Docker <em>can</em> be used efficiently to package and serve static websites.</p>

<p>The code is available at <a href="https://github.com/lipanski/docker-static-website">https://github.com/lipanski/docker-static-website</a>.</p>


        
        <p><em>If you enjoyed my blog post, please spread the news:</em></p>
        <!-- Sharingbutton Twitter -->
        <a href="https://twitter.com/intent/tweet/?text=The smallest Docker image to serve static websites&amp;url=https://lipanski.com/posts/smallest-docker-image-static-website" target="_blank" rel="noopener" aria-label="Share on Twitter">
          
        </a>

        <!-- Sharingbutton Hacker News -->
        <a href="https://news.ycombinator.com/submitlink?u=https://lipanski.com/posts/smallest-docker-image-static-website&amp;t=The smallest Docker image to serve static websites" target="_blank" rel="noopener" aria-label="Share on Hacker News">
          
        </a>

        <!-- Sharingbutton Reddit -->
        <a href="https://reddit.com/submit/?url=https://lipanski.com/posts/smallest-docker-image-static-website&amp;resubmit=true&amp;title=The smallest Docker image to serve static websites" target="_blank" rel="noopener" aria-label="Share on Reddit">
          
        </a>
        

        
      </section>

      
      
      
      
      

    </div></div>
  </body>
</html>
