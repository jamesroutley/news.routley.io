<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lutrasecurity.com/en/articles/kobold-letters/">Original</a>
    <h1>Kobold letters: Why HTML emails are a risk to your organization</h1>
    
    <div id="readability-page-1" class="page"><article><p>Anyone who has had to deal with HTML emails on a technical level has probably reached the point where they wanted to quit their job or just set fire to all the mail clients due to their inconsistent implementations. But HTML emails are not just a source of frustration, they can also be a serious security risk.</p><p>Imagine you receive an email forwarded by your manager asking you to wire a large sum of money to a bank account. Of course, you have heard of CEO fraud, so you double-check that the email really comes from your manager. It does, and it may even be cryptographically signed – if you do that in your company. However, you are still not convinced, so you call your manager to ensure that the email is legit. He confirms, so you transfer the money.</p><p>Yet this would be the end of the article if this wasn’t a <em>scam</em>. So what went wrong?</p><img src="https://lutrasecurity.com/en/articles/kobold-letters/kobold_letter.png" alt="Kobold holding a letter by oira.art"/><p>The email your manager received and forwarded to you was something completely innocent, such as a potential customer asking a few questions. All that email was supposed to achieve was being forwarded to you. However, the moment the email appeared in your inbox, it changed. The innocent pretext disappeared and the real phishing email became visible. A phishing email you <em>had</em> to trust because you knew the sender and they even confirmed that they had forwarded it to you.</p><p>This attack is possible because most email clients allow CSS to be used to style HTML emails. When an email is forwarded, the position of the original email in the DOM usually changes, allowing for CSS rules to be selectively applied only when an email has been forwarded.</p><p>An attacker can use this to include elements in the email that appear or disappear depending on the context in which the email is viewed. Because they are usually invisible, only appear in certain circumstances, and can be used for all sorts of mischief, I’ll refer to these elements as <em>kobold letters</em>, after the elusive sprites of mythology.</p><p>This affects all types of email clients and webmailers that support HTML email. So pretty much all of them. For the moment, however, I’ll focus on selected clients to demonstrate the problem, and leave it to others (or future me) to extend the principle to other clients.</p><h2 id="thunderbird">Thunderbird</h2><hr/><p>This issue was reported to Mozilla on 05.03.2024.</p><hr/><p>Exploiting this in Thunderbird is fairly straightforward. Thunderbird wraps emails in <code>&lt;div class=&#34;moz-text-html&#34; lang=&#34;x-unicode&#34;&gt;&lt;/div&gt;</code> and leaves them otherwise unchanged, making it a good example to demonstrate the principle. When forwarding an email, the quoted email will be enclosed in another <code>&lt;div&gt;&lt;/div&gt;</code>, moving it down one level in the DOM.</p><p>Taking this into account leads to the following proof of concept:</p><div><pre tabindex="0"><code data-lang="html"><span><span><span>&lt;!DOCTYPE html&gt;</span>
</span></span><span><span>&lt;<span>html</span>&gt;
</span></span><span><span>
</span></span><span><span>&lt;<span>head</span>&gt;
</span></span><span><span>    &lt;<span>style</span>&gt;
</span></span><span><span>        .<span>kobold-letter</span> {
</span></span><span><span>            <span>display</span>: <span>none</span>;
</span></span><span><span>        }
</span></span><span><span>
</span></span><span><span>        .<span>moz-text-html</span><span>&gt;</span><span>div</span><span>&gt;</span>.<span>kobold-letter</span> {
</span></span><span><span>            <span>display</span>: <span>block</span> <span>!important</span>;
</span></span><span><span>        }
</span></span><span><span>    &lt;/<span>style</span>&gt;
</span></span><span><span>&lt;/<span>head</span>&gt;
</span></span><span><span>
</span></span><span><span>&lt;<span>body</span>&gt;
</span></span><span><span>    &lt;<span>p</span>&gt;This text is always visible.&lt;/<span>p</span>&gt;
</span></span><span><span>    &lt;<span>p</span> <span>class</span><span>=</span><span>&#34;kobold-letter&#34;</span>&gt;This text will only appear after forwarding.&lt;/<span>p</span>&gt;
</span></span><span><span>&lt;/<span>body</span>&gt;
</span></span><span><span>
</span></span><span><span>&lt;/<span>html</span>&gt;
</span></span></code></pre></div><p>The email contains two paragraphs, one that has no styling and should always be visible, and one that is hidden with <code>display: none;</code>. This is how it looks when the email is displayed in Thunderbird:</p><figure><img src="https://lutrasecurity.com/en/articles/kobold-letters/kobold-moz-1.png" alt="A simple email containing the sentence &#34;This text is always visible.&#34;"/><figcaption><h4>This email may look harmless...</h4></figcaption></figure><p>As expected, only the paragraph “<em>This text is always visible.</em>” is shown. However, when we forward the email, the second paragraph becomes suddenly visible. Albeit only to the new recipient – the original recipient who forwarded the email remains unaware.</p><figure><img src="https://lutrasecurity.com/en/articles/kobold-letters/kobold-moz-2.png" alt="The sentence &#34;This text will only appear after forwarding.&#34; is now visible."/><figcaption><h4>...until it has been forwarded.</h4></figcaption></figure><p>Because we know exactly where each element will be in the DOM relative to <code>.moz-text-html</code>, and because we control the CSS, we can easily hide and show any part of the email, changing the content completely. If we style the kobold letter as an overlay, we can not only affect the forwarded email, but also (for example) replace any comments your manager might have had on the original mail, opening up even more opportunities for phishing.</p><h2 id="outlook-on-the-web">Outlook on the web</h2><hr/><p>This issue was reported to Microsoft on 05.03.2024.</p><hr/><p>In <em>Outlook on the web</em> (OWA) the situation is slightly more complicated, as it is a webmailer. Emails are contained in <code>&lt;div class=&#34;rps_78fa&#34;&gt;&lt;/div&gt;</code>, but the exact class name will change. To prevent the CSS of emails to affect the style of the webmailer, Outlook modifies the email by prefixing all ids and classes with <code>x_</code> and adjust the CSS accordingly.</p><p>Considering all this, we get the following proof of concept:</p><div><pre tabindex="0"><code data-lang="html"><span><span><span>&lt;!DOCTYPE html&gt;</span>
</span></span><span><span>&lt;<span>html</span>&gt;
</span></span><span><span>
</span></span><span><span>&lt;<span>head</span>&gt;
</span></span><span><span>    &lt;<span>style</span>&gt;
</span></span><span><span>        .<span>kobold-letter</span> {
</span></span><span><span>            <span>display</span>: <span>none</span>;
</span></span><span><span>        }
</span></span><span><span>
</span></span><span><span>        <span>body</span><span>&gt;</span><span>div</span><span>&gt;</span>.<span>kobold-letter</span> {
</span></span><span><span>            <span>display</span>: <span>block</span> <span>!important</span>;
</span></span><span><span>        }
</span></span><span><span>    &lt;/<span>style</span>&gt;
</span></span><span><span>&lt;/<span>head</span>&gt;
</span></span><span><span>
</span></span><span><span>&lt;<span>body</span>&gt;
</span></span><span><span>    &lt;<span>p</span>&gt;This text is always visible.&lt;/<span>p</span>&gt;
</span></span><span><span>    &lt;<span>p</span> <span>class</span><span>=</span><span>&#34;kobold-letter&#34;</span>&gt;This text will only appear after forwarding.&lt;/<span>p</span>&gt;
</span></span><span><span>&lt;/<span>body</span>&gt;
</span></span><span><span>
</span></span><span><span>&lt;/<span>html</span>&gt;
</span></span></code></pre></div><p>When the email is displayed by OWA, the CSS will look like this:</p><div><pre tabindex="0"><code data-lang="html"><span><span>&lt;<span>style</span>&gt;
</span></span><span><span><span>&lt;!</span><span>--</span>
</span></span><span><span>.<span>rps_78fa</span> .<span>x_kobold-letter</span>
</span></span><span><span>	{<span>display</span>:<span>none</span>}
</span></span><span><span>.<span>rps_78fa</span> <span>&gt;</span> <span>div</span> <span>&gt;</span> <span>div</span> <span>&gt;</span> .<span>x_kobold-letter</span>
</span></span><span><span>	{<span>display</span>:<span>block</span><span>!important</span>}
</span></span><span><span><span>--</span><span>&gt;</span>
</span></span><span><span>&lt;/<span>style</span>&gt;
</span></span></code></pre></div><p>The email will be displayed as expected:</p><figure><img src="https://lutrasecurity.com/en/articles/kobold-letters/kobold-owa-1.png" alt="A simple email containing the sentence &#34;This text is always visible.&#34;"/><figcaption><h4>This email could ask for a harmless favour...</h4></figcaption></figure><p>After forwarding, the kobold letter will be enclosed by another <code>&lt;div&gt;</code> and the CSS will be updated again:</p><div><pre tabindex="0"><code data-lang="html"><span><span>&lt;<span>style</span>&gt;
</span></span><span><span><span>&lt;!</span><span>--</span>
</span></span><span><span>.<span>rps_78fa</span> .<span>x_x_kobold-letter</span>
</span></span><span><span>	{<span>display</span>:<span>none</span>}
</span></span><span><span>.<span>rps_78fa</span> <span>div</span> <span>&gt;</span> <span>div</span> <span>&gt;</span> .<span>x_x_kobold-letter</span>
</span></span><span><span>	{<span>display</span>:<span>block</span><span>!important</span>}
</span></span><span><span><span>--</span><span>&gt;</span>
</span></span><span><span>&lt;/<span>style</span>&gt;
</span></span></code></pre></div><p>Note that in the second rule, the <code>&gt;</code> between <code>.rps_78fa</code> and <code>div</code> has been dropped. This must be taken into account when creating more complicated selectors. Our proof of concept works as intended:</p><figure><img src="https://lutrasecurity.com/en/articles/kobold-letters/kobold-owa-2.png" alt="The sentence &#34;This text will only appear after forwarding.&#34; is now visible."/><figcaption><h4>...or all your money.</h4></figcaption></figure><p>The adjustments that OWA applies to the email do not interfere with the attack, but need to be considered when crafting a kobold letter. As we don’t have an easily recognizable anchor point, this can become a nuisance when trying to create a kobold letter that works for multiple clients at the same time.</p><h2 id="gmail">Gmail</h2><hr/><p>This issue was reported to Google on 05.03.2024.</p><hr/><p>So far, we could define kobold letters as elements that use CSS selectors to be shown or hidden depending on the context in which the email is displayed. By this definition, Gmail is technically not vulnerable to kobold letters because it strips all styling from the email when forwarding it.</p><p>This allows for an even simpler – albeit more limited – attack: It is now sufficient to hide the kobold letter with CSS, and it will automatically appear when forwarded. However, this does not allow the opposite behaviour, where the kobold letter is visible in the original email and invisible in the forwarded email.</p><div><pre tabindex="0"><code data-lang="html"><span><span><span>&lt;!DOCTYPE html&gt;</span>
</span></span><span><span>&lt;<span>html</span>&gt;
</span></span><span><span>
</span></span><span><span>&lt;<span>head</span>&gt;
</span></span><span><span>    &lt;<span>style</span>&gt;
</span></span><span><span>        .<span>kobold-letter</span> {
</span></span><span><span>            <span>display</span>: <span>none</span>;
</span></span><span><span>        }
</span></span><span><span>    &lt;/<span>style</span>&gt;
</span></span><span><span>&lt;/<span>head</span>&gt;
</span></span><span><span>
</span></span><span><span>&lt;<span>body</span>&gt;
</span></span><span><span>    &lt;<span>p</span>&gt;This text is always visible.&lt;/<span>p</span>&gt;
</span></span><span><span>    &lt;<span>p</span> <span>class</span><span>=</span><span>&#34;kobold-letter&#34;</span>&gt;This text will only appear after forwarding.&lt;/<span>p</span>&gt;
</span></span><span><span>&lt;/<span>body</span>&gt;
</span></span><span><span>
</span></span><span><span>&lt;/<span>html</span>&gt;
</span></span></code></pre></div><p>This is aided by the fact that when the email is forwarded, the CSS is not removed until after it has been sent:</p><figure><img src="https://lutrasecurity.com/en/articles/kobold-letters/kobold-gmail-1.png" alt="A simple email containing the sentence &#34;This text is always visible.&#34;"/><figcaption><h4>Even while commenting on the forwarded message, the illusion is maintained...</h4></figcaption></figure><p>While the second paragraph was clearly not visible in the editor, it is in the resulting email:</p><figure><img src="https://lutrasecurity.com/en/articles/kobold-letters/kobold-gmail-2.png" alt="The sentence &#34;This text will only appear after forwarding.&#34; is now visible."/><figcaption><h4>...but in the end it will betray you.</h4></figcaption></figure><p>While it is difficult to fix kobold letters in general without breaking too much, Google could mitigate the problem by removing the CSS already in the editor. This would at least allow the sender to detect the attack before forwarding the email.</p><p>The fact that this is possible in one way or another is neither surprising nor new. Therefore similar issues have been reported in the past:</p><ul><li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1796180" target="_blank" rel="noopener noreferrer">Thunderbird - Modification of replied mail content without knowledge of replier of the mail using CSS</a></li><li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1836276" target="_blank" rel="noopener noreferrer">Treat OpenPGP/SMIME email messages with certain CSS elements as unsigned</a></li><li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1731198" target="_blank" rel="noopener noreferrer">Composition should use inline styling so that styles from quotes don’t leak into the message</a></li></ul><p>The novelty of kobold letters lies in the focus on a specific attack scenario, while looking at multiple email clients. This hopefully will help raise awareness of the risks associated with HTML emails and contribute to the discussion of what trade-offs are acceptable to mitigate these risks.</p><p>Users can mitigate kobold letters by disabling HTML email altogether or viewing it in a restricted mode (e.g. “plain HTML” in Thunderbird). For email clients, it is more difficult to implement a mitigation, as preventing the use of <code>&lt;style&gt;</code><sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup> would fix this, but would also break a lot of existing solutions in the email ecosystem. An implementation like the one Google already uses for Gmail could be a compromise that allows for stylized corporate newsletters while limiting the risks of HTML email.</p><p>Unfortunately, for the foreseeable future, it is sadly not realistic to expect email clients to implement robust mitigation. This means that it is up to the users to be aware of the dangers of HTML emails and to take the necessary precautions.</p><figure><img src="https://lutrasecurity.com/en/articles/kobold-letters/This-is-fine.jpg" alt="This is fine meme"/><figcaption><h4>But I guess this is fine.</h4></figcaption></figure></article></div>
  </body>
</html>
