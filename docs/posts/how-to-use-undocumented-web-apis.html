<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jvns.ca/blog/2022/03/10/how-to-use-undocumented-web-apis/">Original</a>
    <h1>How to use undocumented web APIs</h1>
    
    

<p>Hello! A couple of days I wrote about <a href="https://jvns.ca/blog/2022/03/08/tiny-programs/">tiny personal programs</a>, and I mentioned that
it can be fun to use &ldquo;secret&rdquo; undocumented APIs where you need to copy your
cookies out of the browser to get access to them.</p>

<p>A couple of people asked how to do this, so I wanted to explain how because
it&rsquo;s pretty straightforward. We&rsquo;ll also talk a tiny bit about what can go
wrong, ethical issues, and how this applies to your undocumented APIs.</p>

<p>As an example, let&rsquo;s use Google Hangouts. I&rsquo;m picking this not because it&rsquo;s the
most useful example (I think there&rsquo;s an official API which would be much more
practical to use), but because many sites where this is actually useful are
smaller sites that are more vulnerable to abuse. So we&rsquo;re just going to use
Google Hangouts because I&rsquo;m 100% sure that the Google Hangouts backend is
designed to be resilient to this kind of poking around.</p>

<p>Let&rsquo;s get started!</p>

<h3 id="step-1-look-in-developer-tools-for-a-promising-json-response">step 1: look in developer tools for a promising JSON response</h3>

<p>I start out by going to <a href="https://hangouts.google.com">https://hangouts.google.com</a>, opening the network tab in
Firefox developer tools and looking for JSON responses. You can use Chrome developer tools too.</p>

<p>Here&rsquo;s what that looks like</p>

<p><img src="https://jvns.ca/images/network-tab.png"></p>

<p>The request is a good candidate if it says &ldquo;json&rdquo; in the &ldquo;Type&rdquo; column&rdquo;</p>

<p>I had to look around for a while until I found something interesting, but
eventually I found a &ldquo;people&rdquo; endpoint that seems to return information about
my contacts. Sounds fun, let&rsquo;s take a look at that.</p>

<h3 id="step-2-copy-as-curl">step 2: copy as cURL</h3>

<p>Next, I right click on the request I&rsquo;m interested in, and click &ldquo;Copy&rdquo; -&gt; &ldquo;Copy as cURL&rdquo;.</p>

<p>Then I paste the <code>curl</code> command in my terminal and run it. Here&rsquo;s what happens.</p>

<pre><code>$ curl 'https://people-pa.clients6.google.com/v2/people/?key=REDACTED' -X POST ........ (a bunch of headers removed)
Warning: Binary output can mess up your terminal. Use &quot;--output -&quot; to tell 
Warning: curl to output it to your terminal anyway, or consider &quot;--output 
Warning: &lt;FILE&gt;&quot; to save to a file.
</code></pre>

<p>You might be thinking &ndash; that&rsquo;s weird, what&rsquo;s this &ldquo;binary output can mess up
your terminal&rdquo; error?  That&rsquo;s because by default, browsers send an
<code>Accept-Encoding: gzip, deflate</code> header to the server, to get compressed
output.</p>

<p>We could decompress it by piping the output to <code>gunzip</code>, but I find it simpler
to just not send that header. So let&rsquo;s remove some irrelevant headers.</p>

<h3 id="step-3-remove-irrelevant-headers">step 3: remove irrelevant headers</h3>

<p>Here&rsquo;s the full <code>curl</code> command line that I got from the browser. There&rsquo;s a lot here!
I start out by splitting up the request with backslashes (<code>\</code>) so that each header is on a different line to make it easier to work with:</p>

<pre><code>curl 'https://people-pa.clients6.google.com/v2/people/?key=REDACTED' \
-X POST \
-H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:96.0) Gecko/20100101 Firefox/96.0' \
-H 'Accept: */*' \
-H 'Accept-Language: en' \
-H 'Accept-Encoding: gzip, deflate' \
-H 'X-HTTP-Method-Override: GET' \
-H 'Authorization: SAPISIDHASH REDACTED' \
-H 'Cookie: REDACTED'
-H 'Content-Type: application/x-www-form-urlencoded' \
-H 'X-Goog-AuthUser: 0' \
-H 'Origin: https://hangouts.google.com' \
-H 'Connection: keep-alive' \
-H 'Referer: https://hangouts.google.com/' \
-H 'Sec-Fetch-Dest: empty' \
-H 'Sec-Fetch-Mode: cors' \
-H 'Sec-Fetch-Site: same-site' \
-H 'Sec-GPC: 1' \
-H 'DNT: 1' \
-H 'Pragma: no-cache' \
-H 'Cache-Control: no-cache' \
-H 'TE: trailers' \
--data-raw 'personId=101777723309&amp;personId=1175339043204&amp;personId=1115266537043&amp;personId=116731406166&amp;extensionSet.extensionNames=HANGOUTS_ADDITIONAL_DATA&amp;extensionSet.extensionNames=HANGOUTS_OFF_NETWORK_GAIA_GET&amp;extensionSet.extensionNames=HANGOUTS_PHONE_DATA&amp;includedProfileStates=ADMIN_BLOCKED&amp;includedProfileStates=DELETED&amp;includedProfileStates=PRIVATE_PROFILE&amp;mergedPersonSourceOptions.includeAffinity=CHAT_AUTOCOMPLETE&amp;coreIdParams.useRealtimeNotificationExpandedAcls=true&amp;requestMask.includeField.paths=person.email&amp;requestMask.includeField.paths=person.gender&amp;requestMask.includeField.paths=person.in_app_reachability&amp;requestMask.includeField.paths=person.metadata&amp;requestMask.includeField.paths=person.name&amp;requestMask.includeField.paths=person.phone&amp;requestMask.includeField.paths=person.photo&amp;requestMask.includeField.paths=person.read_only_profile_info&amp;requestMask.includeField.paths=person.organization&amp;requestMask.includeField.paths=person.location&amp;requestMask.includeField.paths=person.cover_photo&amp;requestMask.includeContainer=PROFILE&amp;requestMask.includeContainer=DOMAIN_PROFILE&amp;requestMask.includeContainer=CONTACT&amp;key=REDACTED'
</code></pre>

<p>This can seem like an overwhelming amount of stuff at first, but you don&rsquo;t need
to think about what any of it means at this stage. You just need to delete
irrelevant lines.</p>

<p>I usually just figure out which headers I can delete with trial and error &ndash; I
keep removing headers until the request starts failing. In general you probably
don&rsquo;t need <code>Accept*</code>, <code>Referer</code>, <code>Sec-*</code>, <code>DNT</code>, <code>User-Agent</code>, and caching
headers though.</p>

<p>In this example, I was able to cut the request down to this:</p>

<pre><code>curl 'https://people-pa.clients6.google.com/v2/people/?key=REDACTED' \
-X POST \
-H 'Authorization: SAPISIDHASH REDACTED' \
-H 'Content-Type: application/x-www-form-urlencoded' \
-H 'Origin: https://hangouts.google.com' \
-H 'Cookie: REDACTED'\
--data-raw 'personId=101777723309&amp;personId=1175339043204&amp;personId=1115266537043&amp;personId=116731406166&amp;extensionSet.extensionNames=HANGOUTS_ADDITIONAL_DATA&amp;extensionSet.extensionNames=HANGOUTS_OFF_NETWORK_GAIA_GET&amp;extensionSet.extensionNames=HANGOUTS_PHONE_DATA&amp;includedProfileStates=ADMIN_BLOCKED&amp;includedProfileStates=DELETED&amp;includedProfileStates=PRIVATE_PROFILE&amp;mergedPersonSourceOptions.includeAffinity=CHAT_AUTOCOMPLETE&amp;coreIdParams.useRealtimeNotificationExpandedAcls=true&amp;requestMask.includeField.paths=person.email&amp;requestMask.includeField.paths=person.gender&amp;requestMask.includeField.paths=person.in_app_reachability&amp;requestMask.includeField.paths=person.metadata&amp;requestMask.includeField.paths=person.name&amp;requestMask.includeField.paths=person.phone&amp;requestMask.includeField.paths=person.photo&amp;requestMask.includeField.paths=person.read_only_profile_info&amp;requestMask.includeField.paths=person.organization&amp;requestMask.includeField.paths=person.location&amp;requestMask.includeField.paths=person.cover_photo&amp;requestMask.includeContainer=PROFILE&amp;requestMask.includeContainer=DOMAIN_PROFILE&amp;requestMask.includeContainer=CONTACT&amp;key=REDACTED'
</code></pre>

<p>So I just need 4 headers: <code>Authorization</code>, <code>Content-Type</code>, <code>Origin</code>, and <code>Cookie</code>. That&rsquo;s a lot more manageable.</p>

<h3 id="step-4-translate-it-into-python">step 4: translate it into Python</h3>

<p>Now that we know what headers we need, we can translate our <code>curl</code> command into a Python program!
This part is also a pretty mechanical process, the goal is just to send exactly the same data with Python as we were with curl.</p>

<p>Here&rsquo;s what that looks like. This is exactly the same as the previous <code>curl</code>
command, but using Python&rsquo;s <code>requests</code>. I also broke up the very long request body
string into an array of tuples to make it easier to work with
programmmatically.</p>

<pre><code>import requests
import urllib

data = [
    ('personId','101777723'), # I redacted these IDs a bit too
    ('personId','117533904'),
    ('personId','111526653'),
    ('personId','116731406'),
    ('extensionSet.extensionNames','HANGOUTS_ADDITIONAL_DATA'),
    ('extensionSet.extensionNames','HANGOUTS_OFF_NETWORK_GAIA_GET'),
    ('extensionSet.extensionNames','HANGOUTS_PHONE_DATA'),
    ('includedProfileStates','ADMIN_BLOCKED'),
    ('includedProfileStates','DELETED'),
    ('includedProfileStates','PRIVATE_PROFILE'),
    ('mergedPersonSourceOptions.includeAffinity','CHAT_AUTOCOMPLETE'),
    ('coreIdParams.useRealtimeNotificationExpandedAcls','true'),
    ('requestMask.includeField.paths','person.email'),
    ('requestMask.includeField.paths','person.gender'),
    ('requestMask.includeField.paths','person.in_app_reachability'),
    ('requestMask.includeField.paths','person.metadata'),
    ('requestMask.includeField.paths','person.name'),
    ('requestMask.includeField.paths','person.phone'),
    ('requestMask.includeField.paths','person.photo'),
    ('requestMask.includeField.paths','person.read_only_profile_info'),
    ('requestMask.includeField.paths','person.organization'),
    ('requestMask.includeField.paths','person.location'),
    ('requestMask.includeField.paths','person.cover_photo'),
    ('requestMask.includeContainer','PROFILE'),
    ('requestMask.includeContainer','DOMAIN_PROFILE'),
    ('requestMask.includeContainer','CONTACT'),
    ('key','REDACTED')
]
response = requests.post('https://people-pa.clients6.google.com/v2/people/?key=REDACTED',
    headers={
        'X-HTTP-Method-Override': 'GET',
        'Authorization': 'SAPISIDHASH REDACTED',
        'Content-Type': 'application/x-www-form-urlencoded',
        'Origin': 'https://hangouts.google.com',
        'Cookie': 'REDACTED',
    },
    data=urllib.parse.urlencode(data),
)

print(response.text)
</code></pre>

<p>I ran this program and it works &ndash; it prints out a bunch of JSON! Hooray!</p>

<p>You&rsquo;ll notice that I replaced a bunch of things with <code>REDACTED</code>, that&rsquo;s because
if I included those values you could access the Google Hangouts API for my
account which would be no good.</p>

<h3 id="and-we-re-done">and we&rsquo;re done!</h3>

<p>Now I can modify the Python program to do whatever I want, like passing
different parameters or parsing the output.</p>

<p>I&rsquo;m not going to do anything interesting with it because I&rsquo;m not actually
interested in using this API at all, I just wanted to show what the process looks like.</p>

<p>But we get back a bunch of JSON that you could definitely do something with.</p>

<h3 id="curlconverter-looks-great">curlconverter looks great</h3>

<p>Someone commented that you can translate curl to Python (and a bunch of other
languages!) automatically with <a href="https://curlconverter.com/">https://curlconverter.com/</a> which looks amazing
&ndash; I&rsquo;ve always done it manually.  I tried it out on this example and it seems
to work great.</p>

<h3 id="figuring-out-how-the-api-works-is-nontrivial">figuring out how the API works is nontrivial</h3>

<p>I don&rsquo;t want to undersell how difficult it can be to figure out how an unknown
API works &ndash; it&rsquo;s not obvious! I have no idea what a lot of the parameters to
this Google Hangouts API do!</p>

<p>But a lot of the time there are some parameters that seem pretty straightforward,
like <code>requestMask.includeField.paths=person.email</code> probably means &ldquo;include each
person&rsquo;s email address&rdquo;. So I try to focus on the parameters I <em>do</em> understand
more than the ones I <em>don&rsquo;t</em> understand.</p>

<h3 id="this-always-works-in-theory">this always works (in theory)</h3>

<p>Some of you might be wondering &ndash; can you always do this?</p>

<p>The answer is sort of yes &ndash; browsers aren&rsquo;t magic! All the information
browsers send to your backend is just HTTP requests. So if I copy all of the
HTTP headers that my browser is sending, there&rsquo;s literally no way for the
backend to tell that the request <em>isn&rsquo;t</em> sent by my browser and is actually
being sent by a random Python program.</p>

<p>Of course, we removed a bunch of the headers the browser sent so theoretically
the backend <em>could</em> tell, but usually they won&rsquo;t check.</p>

<p>There are some caveats though &ndash; for example a lot of Google services have
backends that communicate with the frontend in a totally inscrutable (to me)
way, so even though in theory you could mimic what they&rsquo;re doing, in practice
it might be almost impossible.</p>

<p>Now that we&rsquo;ve seen how to use undocumented APIs like this, let&rsquo;s talk about
some things that can go wrong.</p>

<h3 id="problem-1-expiring-session-cookies">problem 1: expiring session cookies</h3>

<p>One big problem here is that I&rsquo;m using my Google session cookie for
authentication, so this script will stop working whenever my browser session
expires.</p>

<p>That means that this approach wouldn&rsquo;t work for a long running program (I&rsquo;d
want to use a real API), but if I just need to quickly grab a little bit of data as a
1-time thing, it can work great!</p>

<h3 id="problem-2-abuse">problem 2: abuse</h3>

<p>If I&rsquo;m using a small website, there&rsquo;s a chance that my little Python script
could take down their service because it&rsquo;s doing way more requests than they&rsquo;re
able to handle. So when I&rsquo;m doing this I try to be respectful and not make too
many requests too quickly.</p>

<p>This is especially important because a lot of sites which don&rsquo;t have official
APIs are smaller sites with less resources.</p>

<p>In this example obviously this isn&rsquo;t a problem &ndash; I think I made 20 requests
total to the Google Hangouts backend while writing this blog post, which they
can definitely handle.</p>

<p>Also if you&rsquo;re using your account credentials to access the API in a excessive
way and you cause problems, you might (very reasonably) get your account
suspended.</p>

<p>I also stick to downloading data that&rsquo;s either mine or that&rsquo;s intended to be
publicly accessible &ndash; I&rsquo;m not searching for vulnerabilities.</p>

<h3 id="remember-that-anyone-can-use-your-undocumented-apis">remember that anyone can use your undocumented APIs</h3>

<p>I think the most important thing to know about this isn&rsquo;t actually how to use <em>other
people&rsquo;s</em> undocumented APIs. It&rsquo;s fun to do, but it has a lot
of limitations and I don&rsquo;t actually do it that often.</p>

<p>It&rsquo;s much more important to understand that anyone can do this to <em>your</em>
backend API!  Everyone has developer tools and the network tab, and it&rsquo;s pretty
easy to see which parameters you&rsquo;re passing to the backend and to change them.</p>

<p>So if anyone can just change some parameters to get another user&rsquo;s information,
that&rsquo;s no good. I think most developers building publicly availble APIs know
this, but I&rsquo;m mentioning it because everyone needs to learn it for the first
time at some point :)</p>

  </body>
</html>
