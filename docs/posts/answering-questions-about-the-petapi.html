<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.jeffgeerling.com/blog/2022/answering-questions-about-petapi">Original</a>
    <h1>Answering Questions about the PetaPi</h1>
    
    <div id="readability-page-1" class="page"><div><p>A few weeks ago, I posted a video about the <a href="https://www.youtube.com/watch?v=BBnomwpF_uY">Petabyte Pi Project</a>—an experiment to see if a single Raspberry Pi Compute Module 4 could directly address <em>sixty</em> 20TB hard drives, totaling 1.2 Petabytes.</p>

<p><img src="https://www.jeffgeerling.com/sites/default/files/images/petabyte-of-seagate-exos-hard-drives.jpeg" width="700" height="423" data-insert-type="image" data-entity-type="file" data-entity-uuid="insert-image-db7c2d9c-38c3-4272-80cc-61f374485eca" data-insert-attach="{&#34;id&#34;:&#34;db7c2d9c-38c3-4272-80cc-61f374485eca&#34;,&#34;attributes&#34;:{&#34;alt&#34;:[&#34;alt&#34;,&#34;description&#34;],&#34;title&#34;:[&#34;title&#34;]}}" alt="Petabyte of Seagate Exos Hard Drives"/></p>

<p>And in that video, it <em>did</em>, but with a caveat: RAID was unstable. For some reason, after writing 2 or 3 GB of data at a time, one of the HBAs I was using would flake out and reset itself, due to PCI Express bus errors.</p>

<p><img src="https://www.jeffgeerling.com/sites/default/files/images/raspberry-pi-petapi-hbas-storinator.jpeg" width="700" height="467" data-insert-type="image" data-entity-type="file" data-entity-uuid="insert-image-b7e7fcd1-6758-47d4-9bb5-6136e7b190b5" data-insert-attach="{&#34;id&#34;:&#34;b7e7fcd1-6758-47d4-9bb5-6136e7b190b5&#34;,&#34;attributes&#34;:{&#34;alt&#34;:[&#34;alt&#34;,&#34;description&#34;],&#34;title&#34;:[&#34;title&#34;]}}" alt="Raspberry Pi inside Storinator XL60 with 4 HBAs 60 drive PetaPi"/></p>

<p>Since publishing that video, I&#39;ve done a lot more testing, based on suggestions from viewers and the Broadcom engineers I&#39;ve worked with to get <a href="https://pipci.jeffgeerling.com/#sata-cards-and-storage">some of their LSI HBAs and RAID cards working on the Pi</a>.</p>

<blockquote>
  <p>I also made a video for this blog post answering even more questions than I do in this blog post, like &#39;what does it sound like when 60 enterprise hard drives power down?&#39;—check it out here: <a href="https://www.youtube.com/watch?v=R2S2RMNv7OU">It works! 1.2 Petabytes on the Raspberry Pi</a>.</p>
</blockquote>

<h2>HBA Firmware</h2>

<p>The first thing I tried was upgrading the firmware on the HBAs—four Broadcom 9405W-16i cards. I noticed they were on version 5, which was from <em>November 2017</em>. A <em>lot</em> has changed in the past five years, and HBAs and RAID cards see a lot of active development to fix bugs, optimize throughput, etc., since they basically run their own on-chip OS.</p>

<p>But upgrading firmware wasn&#39;t a walk in the park. I tried on the Pi, but got an &#39;image signature validation&#39; error.</p>

<p><img src="https://www.jeffgeerling.com/sites/default/files/images/flash-broadcom-hba-pc.jpg" width="700" height="394" data-insert-type="image" data-entity-type="file" data-entity-uuid="insert-image-5b0d631b-21ae-4742-b0c1-6761d6fff83f" data-insert-attach="{&#34;id&#34;:&#34;5b0d631b-21ae-4742-b0c1-6761d6fff83f&#34;,&#34;attributes&#34;:{&#34;alt&#34;:[&#34;alt&#34;,&#34;description&#34;],&#34;title&#34;:[&#34;title&#34;]}}" alt="Flash Broadcom HBA in Windows PC"/></p>

<p>So I popped one of the cards into my little HP desktop running Windows 10, and tried upgrading, but got a similar error: &#34;The firmware flash image is invalid&#34;</p>

<p>You can <a href="https://github.com/geerlingguy/raspberry-pi-pcie-devices/issues/196#issuecomment-1140383611">read through the whole journey in this GitHub issue</a>, but I&#39;ll just get to the point: I had to use a very old version of StorCLI (Broadcom&#39;s storage CLI utility) to flash any firmware version newer than 14 to these 94xx-series cards.</p>

<p>And it&#39;s not just me—another user in that GitHub thread had the same problem, and wound up confirming the same fix worked for him. Maybe this blog post will motivate one of the Broadcom engineers to fix up whatever bug was introduced in storcli that breaks firmware upgrades for their older 94xx lineup of HBAs... or at least the 9405W-16i!</p>

<p>Once I upgraded the firmware on all four cards to the latest version (23 as of this writing), I re-tested all 60 drives in a Btrfs RAID 0 array, and this time, it was more stable, and <em>very</em> slightly (but measurably) faster.</p>

<p><img src="https://www.jeffgeerling.com/sites/default/files/images/card-reset-fault-state-hba-mpt3sas.jpg" width="700" height="394" data-insert-type="image" data-entity-type="file" data-entity-uuid="insert-image-c55a9dba-d431-4c8e-baf8-ad63948afa9f" data-insert-attach="{&#34;id&#34;:&#34;c55a9dba-d431-4c8e-baf8-ad63948afa9f&#34;,&#34;attributes&#34;:{&#34;alt&#34;:[&#34;alt&#34;,&#34;description&#34;],&#34;title&#34;:[&#34;title&#34;]}}" alt="Card reset diagnostics from mpt3sas driver in Linux"/></p>

<p>I still experienced random card resets under load (see dmesg output above), but now instead of having one or two hard drives drop off after the card came back up, all drives would come back, and long file copies (e.g. 50+ GB) would complete!</p>

<p>But that&#39;s still not a great experience—a card reset takes 1-3 minutes, and during that time, no disk activity goes through, so users are stranded until the drives come back online.</p>

<h2>Forcing PCI Express Gen 1 speeds</h2>

<p>Some users suggested I force PCI Express Gen 1 speeds (2500 MT/sec versus 5000 MT/sec on Gen 2). This would result in diminished performance, but the hope is that with a slower speed, the USB 3-cable-based link between the Pi&#39;s x1 slot and the PCI Express switch board I was using would be more stable—if that was the issue.</p>

<p>So I found <a href="https://www.alexforencich.com/wiki/en/pcie/set-speed">Alex Forencich&#39;s <code>pcie-set-speed.sh</code> script</a> and ran it:</p>

<pre><code><a href="https://www.jeffgeerling.com/cdn-cgi/l/email-protection" data-cfemail="66160f26150715">[email protected]</a>:~ $ sudo ./pcie-set-speed.sh 03:00.0 1
Link capabilities: 0173dc12
Max link speed: 2
Link status: 7012
Current link speed: 2
Configuring 0000:02:01.0...
Original link control 2: 00000002
Original link target speed: 2
New target link speed: 1
New link control 2: 00000001
Triggering link retraining...
Original link control: 70110040
New link control: 70110060
Link status: 7011
Current link speed: 1
</code></pre>

<p>I confirmed the link speed as reported by <code>lspci</code> was downgraded:</p>

<pre><code>        LnkSta: Speed 2.5GT/s (downgraded), Width x1 (downgraded)
            TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt-
</code></pre>

<p>And I did the same for all four HBAs. I re-created my Btrfs RAID 0 array, and as expected, the raw performance under Gen 1 speeds was slower than under Gen 2 (at least for short periods):</p>

<p><img src="https://www.jeffgeerling.com/sites/default/files/images/pcie-speed-comparison-gen1-gen2-hbas.png" width="700" height="394" data-insert-type="image" data-entity-type="file" data-entity-uuid="insert-image-fbdf5411-07a1-47e8-8acc-a047d358cf93" data-insert-attach="{&#34;id&#34;:&#34;fbdf5411-07a1-47e8-8acc-a047d358cf93&#34;,&#34;attributes&#34;:{&#34;alt&#34;:[&#34;alt&#34;,&#34;description&#34;],&#34;title&#34;:[&#34;title&#34;]}}" alt="PCIe Gen 1 vs Gen 2 link speed file benchmark performance"/></p>

<p>But as long as the performance is able to stay above 110 MB/sec, that&#39;s still plenty to saturate the Pi&#39;s 1 Gbps Ethernet connection.</p>

<p>So I tried a few file copies to the Pi running at Gen 1 speeds, and this time, it was very stable, allowing me to copy 70 GB at a time without breaking a sweat. Write speeds varied between 50 and 100 MB/sec, averaging around 70, and Read speeds averaged 100 MB/sec.</p>

<h2>Overclocking</h2>

<p>Because a lot of the slowdown for a network copy comes from the Pi&#39;s SoC itself, I also tested an <a href="https://www.jeffgeerling.com/blog/2020/overclocking-raspberry-pi-compute-module-4">overclock</a> from the base clock of 1.5 GHz to 2.2 GHz, and that resulted in a noticeable speedup, especially in terms of the consistency of read and write speeds over long periods:</p>

<p><img src="https://www.jeffgeerling.com/sites/default/files/images/network-copy-performance-overclock.png" width="700" height="394" data-insert-type="image" data-entity-type="file" data-entity-uuid="insert-image-da106d6c-b47c-46d9-8ef9-f7d49016327d" data-insert-attach="{&#34;id&#34;:&#34;da106d6c-b47c-46d9-8ef9-f7d49016327d&#34;,&#34;attributes&#34;:{&#34;alt&#34;:[&#34;alt&#34;,&#34;description&#34;],&#34;title&#34;:[&#34;title&#34;]}}" alt="Network Copy Performance - SMB with Pi Overclock"/></p>

<h2>Other questions</h2>

<p>Viewers asked a number of other questions I thought I&#39;d answer here:</p>

<ul>
<li><strong>How much power does it use?</strong></li>
<li><strong>How much does it weigh?</strong></li>
<li><strong>How much does it cost?</strong></li>
<li><strong>How loud is it?</strong></li>
</ul>

<h2>Future Plans</h2>

<p><img src="https://www.jeffgeerling.com/sites/default/files/images/storinator-in-homelab-rack.jpeg" width="375" height="500" data-insert-type="image" data-entity-type="file" data-entity-uuid="insert-image-ac44b882-36c5-487d-a08b-50236a642c4b" data-insert-attach="{&#34;id&#34;:&#34;ac44b882-36c5-487d-a08b-50236a642c4b&#34;,&#34;attributes&#34;:{&#34;alt&#34;:[&#34;alt&#34;,&#34;description&#34;],&#34;title&#34;:[&#34;title&#34;]}}" alt="Storinator in homelab rack"/></p>

<p>I do plan on deploying the Storinator XL60 in my basement homelab, but I will likely not run all 60 hard drives inside for the short term... because try as I might, I have nowhere <em>near</em> 1 PiB of files to store. <em>Yet.</em></p>

<p>Plus, I&#39;d have to figure out a way to back up a whole petabyte! Right now I only have the capacity / need for two local copies (plus one offsite) for a few dozen TB.</p>

<p>If you have any other questions about the Storinator or the PetaPi, leave &#39;em below!</p></div></div>
  </body>
</html>
