<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/mezantrop/i486SX_soft_FPU">Original</a>
    <h1>Show HN: I486SX_soft_FPU ‚Äì Software FPU Emulator for NetBSD 10 on 486SX</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/mezantrop/i486SX_soft_FPU/blob/main/media/i486sx_fpu_emulation.jpg"><img src="https://github.com/mezantrop/i486SX_soft_FPU/raw/main/media/i486sx_fpu_emulation.jpg" width="200" alt="NetBSD 10.x with FPU_emulation on i486sx"/></a></p>
<p dir="auto">This retro-computing project restores support for x87 floating-point unit (FPU) emulation in the NetBSD kernel,
targeting legacy 486SX-class processors without hardware FPUs. It brings back the original <code>MATH_EMULATE</code> option into
NetBSD 10.x and beyond, as well as reverts and reworks the changes introduced in
<a href="https://github.com/NetBSD/src/commit/dfe83e08ca9688dd195a43113e7bc7c58fcdd14a">commit dfe83e0</a>, which removed FPU
emulation support from the kernel.</p>

<p dir="auto">This project is a work in progress and may contain bugs or incomplete functionality. Use at your own risk.
The author is not responsible for any issues caused by its use.</p>

<ul dir="auto">
<li><code>fyl2x</code> seems to work properly on FPU, but when executed from <code>libc</code>, <code>log</code> functions bring incorrect results</li>
<li>Some operations have hard-to-detect issues with precision</li>
</ul>
<div dir="auto"><h2 tabindex="-1" dir="auto">x87 FPU Emulated Instructions</h2><a id="user-content-x87-fpu-emulated-instructions" aria-label="Permalink: x87 FPU Emulated Instructions" href="#x87-fpu-emulated-instructions"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">üß† Control &amp; Initialization</h3><a id="user-content--control--initialization" aria-label="Permalink: üß† Control &amp; Initialization" href="#-control--initialization"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Instruction</th>
<th>Status</th>
<th>Description</th>
<th>Opcode</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fninit</code></td>
<td>‚úÖ OK</td>
<td>Initialize FPU</td>
<td><code>9B DB E3</code></td>
<td><code>fninit</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>

<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Instruction</th>
<th>Status</th>
<th>Description</th>
<th>Opcode</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fld</code></td>
<td>‚úÖ OK</td>
<td>Load floating-point value</td>
<td><code>D9 /0</code></td>
<td><code>fld st(1)</code></td>
</tr>
<tr>
<td><code>fldt</code></td>
<td>‚úÖ OK</td>
<td>Load 80-bit extended precision</td>
<td><code>DB /5</code></td>
<td><code>fldt [mem]</code></td>
</tr>
<tr>
<td><code>filds</code></td>
<td>‚úÖ OK</td>
<td>Load integer (short)</td>
<td><code>DB /0</code></td>
<td><code>filds [mem]</code></td>
</tr>
<tr>
<td><code>fildl</code></td>
<td>‚úÖ OK</td>
<td>Load long integer</td>
<td><code>DB /A</code></td>
<td><code>fildl [mem]</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h3 tabindex="-1" dir="auto">üì§ Store from FPU Stack</h3><a id="user-content--store-from-fpu-stack" aria-label="Permalink: üì§ Store from FPU Stack" href="#-store-from-fpu-stack"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Instruction</th>
<th>Status</th>
<th>Description</th>
<th>Opcode</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fstps</code></td>
<td>‚úÖ OK</td>
<td>Store and pop single precision</td>
<td><code>D9 /3</code></td>
<td><code>fstps [mem]</code></td>
</tr>
<tr>
<td><code>fstpt</code></td>
<td>‚úÖ OK</td>
<td>Store 80-bit extended precision &amp; pop</td>
<td><code>DB /7</code></td>
<td><code>fstpt [mem]</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h3 tabindex="-1" dir="auto">‚ûï‚ûñ‚úñÔ∏è‚ûó Arithmetic Operations</h3><a id="user-content-Ô∏è-arithmetic-operations" aria-label="Permalink: ‚ûï‚ûñ‚úñÔ∏è‚ûó Arithmetic Operations" href="#Ô∏è-arithmetic-operations"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Instruction</th>
<th>Status</th>
<th>Description</th>
<th>Opcode</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fadd</code></td>
<td>‚úÖ OK</td>
<td>Add floating-point values</td>
<td><code>D8 /0</code></td>
<td><code>fadd st(1), st</code></td>
</tr>
<tr>
<td><code>faddl</code></td>
<td>‚úÖ OK</td>
<td>Add long double from memory</td>
<td><code>DA /0</code></td>
<td><code>faddl [mem]</code></td>
</tr>
<tr>
<td><code>fsub</code></td>
<td>‚úÖ OK</td>
<td>Subtract floating-point values</td>
<td><code>D8 /4</code></td>
<td><code>fsub st(1), st</code></td>
</tr>
<tr>
<td><code>fsubp</code></td>
<td>‚úÖ OK</td>
<td>Subtract with pop</td>
<td><code>DE /5</code></td>
<td><code>fsubp st(1), st(0)</code></td>
</tr>
<tr>
<td><code>fmul</code></td>
<td>‚úÖ OK</td>
<td>Multiply floating-point values</td>
<td><code>D8 /1</code></td>
<td><code>fmul st(1), st</code></td>
</tr>
<tr>
<td><code>fdiv</code></td>
<td>‚úÖ OK</td>
<td>Divide floating-point values</td>
<td><code>D8 /6</code></td>
<td><code>fdiv st(1), st</code></td>
</tr>
<tr>
<td><code>fdivp</code></td>
<td>‚úÖ OK</td>
<td>Divide with pop</td>
<td><code>DE /7</code></td>
<td><code>fdivp st(1), st(0)</code></td>
</tr>
<tr>
<td><code>fscale</code></td>
<td>‚úÖ OK</td>
<td>Scale ST(0) by ST(1)</td>
<td><code>D9 FD</code></td>
<td><code>fscale</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>

<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Instruction</th>
<th>Status</th>
<th>Description</th>
<th>Opcode</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fcom</code></td>
<td>‚úÖ OK</td>
<td>Compare floating-point values</td>
<td><code>D8 /2</code></td>
<td><code>fcom st(1)</code></td>
</tr>
<tr>
<td><code>fucom</code></td>
<td>‚úÖ OK</td>
<td>Unordered compare ST(0) with ST(i)</td>
<td><code>DD E0+i</code></td>
<td><code>fucom st(1)</code></td>
</tr>
<tr>
<td><code>fucomp</code></td>
<td>‚úÖ OK</td>
<td>Unordered compare and pop</td>
<td><code>DD E8+i</code></td>
<td><code>fucomp st(1)</code></td>
</tr>
<tr>
<td><code>ftst</code></td>
<td>‚úÖ OK</td>
<td>Compare ST(0) with 0.0</td>
<td><code>D9 E4</code></td>
<td><code>ftst</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h3 tabindex="-1" dir="auto">üîÅ Stack Manipulation &amp; Modification</h3><a id="user-content--stack-manipulation--modification" aria-label="Permalink: üîÅ Stack Manipulation &amp; Modification" href="#-stack-manipulation--modification"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Instruction</th>
<th>Status</th>
<th>Description</th>
<th>Opcode</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fxch</code></td>
<td>‚úÖ OK</td>
<td>Exchange ST(0) with ST(i)</td>
<td><code>D9 C8+i</code></td>
<td><code>fxch st(1)</code></td>
</tr>
<tr>
<td><code>fchs</code></td>
<td>‚úÖ OK</td>
<td>Change sign of ST(0)</td>
<td><code>D9 E0</code></td>
<td><code>fchs</code></td>
</tr>
<tr>
<td><code>fabs</code></td>
<td>‚úÖ OK</td>
<td>Absolute value of ST(0)</td>
<td><code>D9 E1</code></td>
<td><code>fabs</code></td>
</tr>
<tr>
<td><code>frndint</code></td>
<td>‚úÖ OK</td>
<td>Round ST(0) to integer</td>
<td><code>D9 FC</code></td>
<td><code>frndint</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h3 tabindex="-1" dir="auto">üìà Logarithmic and Special Math Operations</h3><a id="user-content--logarithmic-and-special-math-operations" aria-label="Permalink: üìà Logarithmic and Special Math Operations" href="#-logarithmic-and-special-math-operations"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Instruction</th>
<th>Status</th>
<th>Description</th>
<th>Opcode</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fyl2x</code></td>
<td>‚è≥ TBD</td>
<td>Compute y √ó log‚ÇÇ(x) (ST(1) √ó log‚ÇÇ(ST(0))) and pop</td>
<td><code>D9 F1</code></td>
<td><code>fyl2x</code></td>
</tr>
<tr>
<td><code>fyl2xp1</code></td>
<td>‚ùå N/A</td>
<td>Compute y √ó log‚ÇÇ(x+1) and pop</td>
<td><code>D9 F9</code></td>
<td><code>fyl2xp1</code></td>
</tr>
<tr>
<td><code>fxtract</code></td>
<td>‚ùå N/A</td>
<td>Extract: ST(0) ‚Üí ST = significand, ST+1 = exponent</td>
<td><code>D9 F4</code></td>
<td><code>fxtract</code></td>
</tr>
<tr>
<td><code>f2xm1</code></td>
<td>‚úÖ OK</td>
<td>Compute 2^x - 1 for ST(0)</td>
<td><code>D9 F0</code></td>
<td><code>f2xm1</code></td>
</tr>
<tr>
<td><code>fpatan</code></td>
<td>‚ùå N/A</td>
<td>Compute arctangent(ST(1)/ST(0)) and pop</td>
<td><code>D9 F3</code></td>
<td><code>fpatan</code></td>
</tr>
<tr>
<td><code>fsqrt</code></td>
<td>‚ùå N/A</td>
<td>Compute square root of ST(0)</td>
<td><code>D9 FA</code></td>
<td><code>fsqrt</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>

<ul dir="auto">
<li>Read <a href="https://www.netbsd.org/docs/guide/en/chap-fetch.html" rel="nofollow">Chapter 32. Obtaining the sources</a></li>
<li>Read <a href="https://www.netbsd.org/docs/guide/en/chap-kernel.html" rel="nofollow">Chapter 34. Compiling the kernel</a></li>
<li>Add the repository contents under <code>/src/sys/arch</code> on NetBSD 10.x machine, then run:</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="$ cd /usr/src/sys/arch/i386/conf/
$ vi GENERIC_TINY_486SX# or GENERIC_PS2TINY_486SX or create your own kernel configuration with &#34;options MATH_EMULATE&#34;
$ config GENERIC_TINY_486SX
$ cd ../compile/GENERIC_TINY_486SX
$ make depend
$ make

# If everythig good, install the new kernel under root:
# mv /netbsd /netbsd.old
# mv netbsd /"><pre>$ <span>cd</span> /usr/src/sys/arch/i386/conf/
$ vi GENERIC_TINY_486SX# or GENERIC_PS2TINY_486SX or create your own kernel configuration with <span><span>&#34;</span>options MATH_EMULATE<span>&#34;</span></span>
$ config GENERIC_TINY_486SX
$ <span>cd</span> ../compile/GENERIC_TINY_486SX
$ make depend
$ make

<span><span>#</span> If everythig good, install the new kernel under root:</span>
<span><span>#</span> mv /netbsd /netbsd.old</span>
<span><span>#</span> mv netbsd /</span></pre></div>

<p dir="auto">Check <a href="https://github.com/mezantrop/i486SX_soft_FPU/releases">Releases</a> for the compiled <code>netbsd</code> kernel with FPU-emulation
as well, as the drive image</p>

<p dir="auto">If you have an idea, a question, or have found a problem, feel free to open an issue or contact me directly:
<a href="mailto:zmey20000@yahoo.com">Mikhail Zakharov</a>.</p>
<p dir="auto">My changes to the original code by Linus Torvalds, William &#34;Bill&#34; Jolitz, and NetBSD are licensed under
the BSD-2-Clause license.</p>
</article></div></div>
  </body>
</html>
