<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://doubleagent.net/onavo-facebook-ssl-mitm-technical-analysis/">Original</a>
    <h1>How did Facebook intercept their competitor&#39;s encrypted mobile app traffic?</h1>
    
    <div id="readability-page-1" class="page"><section>
        <p>There is a current class action lawsuit against Meta in which court documents include claims that the company had breached the <a href="https://en.wikipedia.org/wiki/Electronic_Communications_Privacy_Act?ref=doubleagent.net" rel="noreferrer">Wiretap Act</a>. The analysis made in this post is based on content <a href="https://www.documentcloud.org/documents/24520332-merged-fb?ref=doubleagent.net" rel="noreferrer">court documents</a> and reverse engineering sections of archived Onavo Protect app packages for Android. </p><p>It is suggested to read a recent <a href="https://techcrunch.com/2024/03/26/facebook-secret-project-snooped-snapchat-user-traffic/?ref=doubleagent.net" rel="noreferrer">TechCrunch</a> article for additional background on the case.</p><p>It is claimed that Facebook intercepted user&#39;s encrypted HTTPS traffic by using what would be considered the a <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack?ref=doubleagent.net" rel="noreferrer">MITM attack</a>. Facebook called this technique &#34;ssl bump&#34;, appropriately named after the transparent proxy <a href="https://www.squid-cache.org/Doc/config/ssl_bump/?ref=doubleagent.net" rel="noreferrer">feature</a> in the <a href="https://www.squid-cache.org/?ref=doubleagent.net" rel="noreferrer">Squid caching</a> proxy software which was used to (allegedly) decrypt specific Snapchat, YouTube and Amazon domain(s). </p><div><p>Due to the limited and partial information, some facts may be inaccurate or incomplete in this post. As such this post is subject to updates if corrections are warranted or new discoveries made. Feel free to subscribe to this blog to receive updates in your inbox, or follow me on <a href="https://twitter.com/haxrob?ref=doubleagent.net" rel="noreferrer">X (ex Twitter</a>).</p></div><h3 id="summary">Summary</h3><ul><li><a href="https://apkpure.com/onavo-protect-from-facebook/com.onavo.spaceship?ref=doubleagent.net" rel="noreferrer">Onavo Protect Android app</a> contained code to prompt the user to install a CA (certificate authority) certificate issued by &#34;Facebook Research&#34; in the user trust store of the device. This certificate was required for Facebook to decrypt TLS traffic.</li><li>Some versions of the older app contain the Facebook Research CA certs as embedded assets in the distributed app from 2016. One cert is valid until 2027. Data discovery content in court documents state certificates are &#34;generated on the server and sent to the device&#34;.</li><li>Soon after the &#34;ssl bump&#34; feature was deployed in the Protect app, a newer version of Android was released that included improved security controls that would render this method unusable on devices with the newer operating system.</li><li>A review of an old Snapchat app shows that it&#39;s analytics domain did not employ certificate pinning, meaning that MITM / &#34;ssl bumping&#34; would have worked as described.</li><li>In addition to the core functionality of gathering other app&#39;s usage statistics through abusing a permission granted by the user, there also appears to be other functionality to obtain questionable sensitive data, such as the <a href="https://en.wikipedia.org/wiki/International_mobile_subscriber_identity?ref=doubleagent.net" rel="noreferrer">subscriber IMSI</a>.</li></ul><p>The setup most likely would have looked something the following diagram:</p><figure><img src="https://doubleagent.net/content/images/2024/04/fb1-3-1.png" alt="" loading="lazy" width="844" height="305" srcset="https://doubleagent.net/content/images/size/w600/2024/04/fb1-3-1.png 600w, https://doubleagent.net/content/images/2024/04/fb1-3-1.png 844w" sizes="(min-width: 720px) 720px"/><figcaption><span>An interpretation of FB&#39;s setup based on court documents and app analysis</span></figcaption></figure><p>Here we have a trusted cert installed on the device, all device traffic going over a VPN to Facebook controlled infrastructure, traffic redirected into a Squid caching proxy setup as a transparent proxy with the &#39;ssl bump&#39; feature configured. We know from the documents that various domains belonging to Snapchat, Amazon and Youtube were of interest. It&#39;s not known if any other user traffic was intercepted, or just proxied on. This type of information we can&#39;t obtain from looking at the archived Onavo Protect apps, rather for the time being, we have to rely on the content in the court documents made available to the public.</p><p>Over time the success of their strategy to employ a transparent TLS proxy was diminishing due to improved security controls in Android.  Additionally certificate pinning adoption was said to be an issue. As an alterative, Facebook were considering using the <a href="https://support.google.com/googleplay/android-developer/answer/10964491?hl=en&amp;ref=doubleagent.net#:~:text=Google%20Play%20permits%20the%20use,that%20they%20are%20accessibility%20tools." rel="noreferrer">Accessibility API</a> as an alternative. </p><figure><img src="https://doubleagent.net/content/images/2024/04/image-14.png" alt="" loading="lazy" width="818" height="161" srcset="https://doubleagent.net/content/images/size/w600/2024/04/image-14.png 600w, https://doubleagent.net/content/images/2024/04/image-14.png 818w" sizes="(min-width: 720px) 720px"/><figcaption><span>Page 3 - Case 3:20-cv-08570-JD Document 736</span></figcaption></figure><p>This is what Google has to say about using the accessibility features on their operating system:</p><blockquote>&#34;only services that are designed to help people with disabilities access their device or otherwise overcome challenges stemming from their disabilities are eligible to declare that they are accessibility tools.&#34;</blockquote><p>It&#39;s somewhat telling of a company that would consider abusing features designed to support people with disabilities for a competitive advantage. Generally, Android accessibility functionality misuse is attributed to malicious applications such as <a href="https://blog.pradeo.com/accessibility-services-mobile-analysis-malware?ref=doubleagent.net" rel="noreferrer">banking malware</a>.</p><h2 id="motivation">Motivation</h2><p>Mark Zuckerberg states the need for &#34;<em>reliable analytics</em>&#34; on Snapchat:</p><figure><img src="https://doubleagent.net/content/images/2024/04/image-4.png" alt="" loading="lazy" width="617" height="335" srcset="https://doubleagent.net/content/images/size/w600/2024/04/image-4.png 600w, https://doubleagent.net/content/images/2024/04/image-4.png 617w"/></figure><p>The solution? &#34;<em>Kits that can be installed on iOS and Android that intercept traffic for specific sub-domains</em>&#34;:</p><figure><img src="https://doubleagent.net/content/images/2024/04/image-6.png" alt="" loading="lazy" width="1311" height="614" srcset="https://doubleagent.net/content/images/size/w600/2024/04/image-6.png 600w, https://doubleagent.net/content/images/size/w1000/2024/04/image-6.png 1000w, https://doubleagent.net/content/images/2024/04/image-6.png 1311w" sizes="(min-width: 720px) 720px"/></figure><p>My take on the above is that in addition to utilizing the Onavo Protect VPN app to intercept traffic for specific domains, there was an intention to rebrand the core technology and having it distributed in other applications. Facebook had <a href="https://techcrunch.com/2013/10/13/facebook-buys-mobile-analytics-company-onavo-and-finally-gets-its-office-in-israel/?ref=doubleagent.net" rel="noreferrer">acquired </a>Onavo for approximately $120M USD in 2013 and needed to put this technology in good use. That price point should give a clear indication on the value they placed on the ability to gain competitor intelligence from people&#39;s phones and tablets. </p><p><a href="https://medium.com/@chronic_9612/notes-on-analytics-and-tracking-in-onavo-protect-for-ios-904bdff346c0?ref=doubleagent.net" rel="noreferrer">Prior research</a> on the iOS version notes that the Onavo VPN app was collecting some usage telemetry from iPhones. On Android we can see the app was pulling much more fine grained statistics from their user&#39;s devices by utilizing permissions granted under the pretext of showing the user app data usage (we will see how this looked in an embedded video below). But that was not enough, Facebook wanted to take this one step further and intercept encrypted traffic towards specific competitor&#39;s analytics domains in order to obtain data on the &#34;<strong>in-app actions&#34;</strong>.</p><p>All they would need to do is to get the user to install a custom certificate into the user&#39;s phone&#39;s trust store (and be on specific Android releases).</p><div><p>ðŸ’¡</p><div><p>The wiretapping claim is new and perhaps not to be confused with the prior controversy and litigation: </p></div></div><h2 id="technical-analysis">Technical analysis</h2><p>Websites and applications on end user devices trust remote websites or servers over HTTPS/TLS due to public certificates that are stored in the device&#39;s trust store. These &#34;certificate authority&#34; certs are the &#34;trust anchor&#34; that applications rely on to verify they communicating with the intended party. These certificates are generally distributed and stored within the operating system. By adding your own self-signed certificate to the appropriate trust store, it is often possible to intercept encrypted TLS traffic. Corporations may also do this as a means of inspecting outbound traffic from employee&#39;s devices. Security testers may also do this on their own devices. There are legitimate reasons for doing this. The question here is if what Facebook did was legitimate, meaning, was it legal or not.</p><div><p>There is some irony that the documentation for software that Facebook is said to employ to do the interception contains the following <a href="https://wiki.squid-cache.org/Features/SslBump?ref=doubleagent.net" rel="noreferrer">warning</a>:</p></div><blockquote>HTTPS was designed to give users an expectation of privacy and security. Decrypting HTTPS tunnels without user consent or knowledge may violate ethical norms and may be illegal in your jurisdiction. </blockquote><p>Unlike iOS on the iPhone, Google has made numerous changes to make it extremely difficult to install a CA cert that will be trusted by most applications on the phone. In Android 11, released in September 2020, Google had completely blocked the mechanism which the app used to prompt a user to install the cert and no application would trust any certificate in the user store by default.</p><div><p>ðŸ’¡</p><div><p>People have asked &#34;<i><em>what about cert pinning? wouldn&#39;t this have prevented successful MITM of the traffic?</em></i>&#34;</p></div></div><p>So today, technically speaking, is is simply is not possible to do what Facebook had done back in 2016 to 2019. But it worked - so how did they do it? Fortunately, at least with Android and the Play store ecosystem, we are able to often go back in time and sometimes dig up old Android app packages.</p><p>The first thing is to install the Onavo app on a test handset to see how users would interact with the app.  Despite the VPN connectivity not working and the actual backend service being down, we do get a glimpse on how the application coerces the user into accepting multiple permissions:</p><figure data-kg-thumbnail="https://doubleagent.net/content/media/2024/04/zszPzD8NSHAFb9W1_thumb.jpg" data-kg-custom-thumbnail="">
            <div>
                <video src="https://doubleagent.net/content/media/2024/04/zszPzD8NSHAFb9W1.mp4" poster="https://img.spacergif.org/v1/480x852/0a/spacer.png" width="480" height="852" playsinline="" preload="metadata"></video>
                
                <div>
                    <div>
                        <p>
                        
                        <span>0:00</span></p><p>
                            /<span>0:45</span>
                        </p>
                        </div>
                </div>
            </div>
            
        </figure><p>What we see here under pretext of providing the user &#39;protection&#39;, two particular permissions are of concern:</p><ul><li>Display over other apps</li><li>Access past and deleted app usage</li></ul><blockquote>&#34;<em>We need this permission to show you how much mobile data your apps use.</em>&#34; </blockquote><p>What they didn&#39;t explain is that this feature is not so much for the benefit of the user who installed the app, but actually Onavo/Facebook. And this type of information is valuable, to the tune of $120M (what FB paid in the acquisition).</p><figure><img src="https://pbs.twimg.com/media/GJpCkIEbkAAsckm?format=jpg&amp;name=small" alt="Image" loading="lazy" width="486" height="680"/></figure><p>The Android manifest includes the <code>uses-permission</code> directive <code>android.permission.PACKAGE_USAGE_STATS</code> which is what we are agreeing to in the screenshot above:</p><figure><img src="https://pbs.twimg.com/media/GJptvfla8AA0rVZ?format=png&amp;name=medium" alt="Image" loading="lazy" width="903" height="412"/></figure><p>Continuing with the &#34;application stats&#34; feature (assumed to be the original core functionality), we can dump the schema of the local database on the handset to get an idea on exactly what it was collecting on the device itself:</p><figure><img src="https://pbs.twimg.com/media/GJpyTakbIAAeD_A?format=png&amp;name=large" alt="Image" loading="lazy" width="1882" height="460"/></figure><p>Mostly it seems they could just obtain statistics on in app usage of other applications and of course the network traffic usage for the apps. It&#39;s still somewhat high level statistics and clearly not enough granularity for what Mark was after, implied by one of the emails in the court documents. Intercepting the actual encrypted traffic towards the analytics domains of various competitors on the other hand, would do the trick. And to do this, Facebook would have to get a CA certificate somehow on the device.</p><p>But we don&#39;t see any prompt to install any certificate. This is because the VPN did not successfully connect to the remote service, which appears to be precondition. Time or interest permitting, I may go back to figure out how to trigger the certificate installation prompt.</p><figure><img src="https://doubleagent.net/content/images/2024/04/GJo--s8aQAAYwtL.png" alt="" loading="lazy" width="1062" height="365" srcset="https://doubleagent.net/content/images/size/w600/2024/04/GJo--s8aQAAYwtL.png 600w, https://doubleagent.net/content/images/size/w1000/2024/04/GJo--s8aQAAYwtL.png 1000w, https://doubleagent.net/content/images/2024/04/GJo--s8aQAAYwtL.png 1062w" sizes="(min-width: 720px) 720px"/><figcaption><span>Connections timing out, and a tcpdump shows that all traffic from the device is dropped after the VPN connection is initiated</span></figcaption></figure><h3 id="onto-the-ca-certificates">Onto the CA certificates</h3><p>Decompiling the app, we do see the functionality is there. In the following image, the method highlighted calls <code>KeyChain.createInstallIntent()</code> to install a certificate. Here a popup would appear asking the user for permission, with the name &#34;Facebook Research&#34;</p><figure><img src="https://doubleagent.net/content/images/2024/04/GJpP7rmaAAAQDKI.png" alt="" loading="lazy" width="680" height="424" srcset="https://doubleagent.net/content/images/size/w600/2024/04/GJpP7rmaAAAQDKI.png 600w, https://doubleagent.net/content/images/2024/04/GJpP7rmaAAAQDKI.png 680w"/></figure><p><code>KeyChain.createInstallIntent()</code> <a href="https://commonsware.com/R/pages/chap-security-004.html?ref=doubleagent.net" rel="noreferrer">stopped working</a> in Android 7 (Nougat). A user would have to manually install the certificate. It would no longer be possible to have Facebook&#39;s CA cert installed directly in the app.</p><p>Another notable change in Android 7 - According to the <a href="https://developer.android.com/privacy-and-security/security-config?ref=doubleagent.net" rel="noreferrer">Android documentation</a> (emphasis mine):</p><blockquote>By default, secure connections (using protocols like TLS and HTTPS) from all apps trust the pre-installed system CAs, and <strong>apps targeting Android 6.0 (API level 23) and lower also trust the user-added CA store by default</strong></blockquote><p>In other words, it appears other apps would have trusted certs in the user store from Android Marshmallow (Android 6) and below, but from Android 7, released in August 22, 2016, they would no longer be trusted at all by other applications, unless due to a security configuration in the app&#39;s manifest file.</p><p>Another  improvement to Android in version 7 was that it was made impossible to install certificates into the system store by <em>any</em> means except by fully rooting the device. </p><p>Regardless, the functionality remained in both the older version and newer, all the way to the last published app in 2019. The actual MITM certificate was removed in 2017. Detail in the court documents may offer plausible explanation:</p><blockquote>Where is the key generated that&#39;s used for the SSL bump and how it protected from abuse? (e.g., is generated on the device, specific to that device, and never leaves the device, or is there a shared key that&#39;s downloaded with the app and installed)</blockquote><figure><img src="https://doubleagent.net/content/images/2024/04/image-15.png" alt="" loading="lazy" width="933" height="104" srcset="https://doubleagent.net/content/images/size/w600/2024/04/image-15.png 600w, https://doubleagent.net/content/images/2024/04/image-15.png 933w" sizes="(min-width: 720px) 720px"/><figcaption><span>Page 3 - Case 3:20-cv-08570-JD Document 736</span></figcaption></figure><p>So we need to go back to much older releases before 2019, specifically a version from September 2017. The certificates in this version are found as assets named &#34;<code>old_ca.cer</code>&#34; and &#34;<code>new_ca.cer</code>&#34;. The relevant code is found in the class <code>ResearchCertificateManager</code>.</p><figure><img src="https://doubleagent.net/content/images/2024/04/image-7.png" alt="" loading="lazy" width="773" height="462" srcset="https://doubleagent.net/content/images/size/w600/2024/04/image-7.png 600w, https://doubleagent.net/content/images/2024/04/image-7.png 773w" sizes="(min-width: 720px) 720px"/></figure><p>The can be found under the &#34;assets&#34; folder (if uncompressing the .apk as a zip file). Observed in JADX:</p><figure><img src="https://doubleagent.net/content/images/2024/04/image-9.png" alt="" loading="lazy" width="476" height="390"/></figure><p>Also observing the routine to check if the certificates have been installed or not:</p><figure><img src="https://doubleagent.net/content/images/2024/04/image-8.png" alt="" loading="lazy" width="1187" height="811" srcset="https://doubleagent.net/content/images/size/w600/2024/04/image-8.png 600w, https://doubleagent.net/content/images/size/w1000/2024/04/image-8.png 1000w, https://doubleagent.net/content/images/2024/04/image-8.png 1187w" sizes="(min-width: 720px) 720px"/></figure><p>Now why would there be two certificates? (old and new)? Here are the two certificates pulled from one version of the app. Whoever had created the first certificate had only issued it to be valid for one year. If this was an oversight, they did manage to figure it out before the expiry time. </p><figure><div><div><p><img src="https://doubleagent.net/content/images/2024/04/GJq8BYsbUAAiREe.png" width="680" height="500" loading="lazy" alt="" srcset="https://doubleagent.net/content/images/size/w600/2024/04/GJq8BYsbUAAiREe.png 600w, https://doubleagent.net/content/images/2024/04/GJq8BYsbUAAiREe.png 680w"/></p><p><img src="https://doubleagent.net/content/images/2024/04/GJq8JjeaAAA59Ec.png" width="680" height="533" loading="lazy" alt="" srcset="https://doubleagent.net/content/images/size/w600/2024/04/GJq8JjeaAAA59Ec.png 600w, https://doubleagent.net/content/images/2024/04/GJq8JjeaAAA59Ec.png 680w"/></p></div></div><figcaption><p><span>old_va.cer vs new_ca.cer</span></p></figcaption></figure><p>I have not been able to find all versions of the .apk online, but enough to draw the following conclusion:</p><ul><li>The first certificate was valid from Sep 8th 2016, some months before Mark Zuckerberg put the call out to gain further insight into Snapchat (email dated June 9th, 2016)</li><li>The second certificate was added alongside the first which was valid from Jun 8th, 2017. It will be valid until Jun 8 2027.</li><li>At least from Oct 19th, 2027, there are no certs, the second cert was deleted from the app completely. As stated earlier, court documents explain certificates were obtained from the server. I have yet to locate the functionality relevant to this in the apps I have obtained from <a href="https://apkpure.com/onavo-protect-from-facebook/com.onavo.spaceship?ref=doubleagent.net" rel="noreferrer">archives</a>, and more work needs to be done here.</li></ul><p>Versions with certificates found with their respective fingerprints:  </p><figure><img src="https://pbs.twimg.com/media/GJrEPLeaEAAhjQM?format=png&amp;name=900x900" alt="Image" loading="lazy" width="745" height="208"/></figure><p>The court documents state that there was additional interception of YouTube and Amazon at later dates. Here we would have to dig further to find out in which apps and how this was done:</p><figure><img src="https://doubleagent.net/content/images/2024/04/image-12.png" alt="" loading="lazy" width="1345" height="387" srcset="https://doubleagent.net/content/images/size/w600/2024/04/image-12.png 600w, https://doubleagent.net/content/images/size/w1000/2024/04/image-12.png 1000w, https://doubleagent.net/content/images/2024/04/image-12.png 1345w" sizes="(min-width: 720px) 720px"/><figcaption><span>Page 2, case 3:20-cv-08570-JD Document 735</span></figcaption></figure><h3 id="back-to-the-pinning-question">Back to the pinning question</h3><p>Any app doing full certificate pinning would have prevented this technique from working.  Around the time period in question, Snapchat was doing some certificate pinning. But not everywhere.</p><p>We can go back and grab an old Snapchat app and check for ourselves. What was the domain? According to one the artefacts in the document discovery, it was <code>sc-analytics.appspot.com</code>:</p><figure><img src="https://pbs.twimg.com/media/GKBeIsTbgAAdHpH?format=png&amp;name=small" alt="Image" loading="lazy" width="613" height="430"/></figure><p>And behold, in a decompilation of and old Snapchat app, traffic to this domain did not use certificate pinning:</p><figure><img src="https://pbs.twimg.com/media/GKBnQNdb0AA2M8t?format=png&amp;name=medium" alt="Image" loading="lazy" width="1075" height="402"/></figure><p>As discussed earlier, Facebook were aware of the security enhancements in Android and the wider adoption of pinning, with the statement included (reference earlier):</p><blockquote>There is a general question on SSL bump long term applicability on Android as SSL pinning by default is present on newer devices.</blockquote><h2 id="what-else">What else?</h2><p>This one caught my eye, a request to obtain the <a href="https://en.wikipedia.org/wiki/International_mobile_subscriber_identity?ref=doubleagent.net" rel="noreferrer">subscriber IMSI</a>. A very sensitive bit of data indeed: </p><figure><img src="https://pbs.twimg.com/media/GJp7AoJaQAA5E-N?format=png&amp;name=medium" alt="Image" loading="lazy" width="1031" height="309"/></figure><p>Initially I was wondering how this is even possible, and it seems at the time, it was actually possible with the permission <code>READ_PHONE_STATE</code>:</p><figure><img src="https://pbs.twimg.com/media/GJqOvKmbwAAmL_p?format=png&amp;name=medium" alt="Image" loading="lazy" width="942" height="273"/></figure><p>Which of course was defined in the app&#39;s manifest:</p><figure><img src="https://doubleagent.net/content/images/2024/04/image-10.png" alt="" loading="lazy" width="1679" height="449" srcset="https://doubleagent.net/content/images/size/w600/2024/04/image-10.png 600w, https://doubleagent.net/content/images/size/w1000/2024/04/image-10.png 1000w, https://doubleagent.net/content/images/size/w1600/2024/04/image-10.png 1600w, https://doubleagent.net/content/images/2024/04/image-10.png 1679w" sizes="(min-width: 720px) 720px"/></figure><p>Given this discovery, there is probably more to explore.</p><h2 id="wrapping-up">Wrapping up</h2><p>While this is all &#34;old news&#34; in the sense that happened years ago, it is interesting from a technical standpoint to see how far application developers, and even companies like Facebook will go to abuse permission models on mobile phones.</p><p>And there is certainly is more to dig into, such as the routine to trigger the CA install procedure, how certs were added after 2017 and what else the Onavo application was collecting. Also, it would also be nice to find iPhone version of the application if anyone knows where to find copies.</p><p> If the class action lawsuit progresses in an interesting way, perhaps this could provide further motivation to continue the exploration. </p><p>If you are interested in receiving further updates, feel free to subscribe below with an email address, and/or follow me on <a href="https://twitter.com/haxrob?ref=doubleagent.net" rel="noreferrer">X</a>.  </p>
    </section></div>
  </body>
</html>
