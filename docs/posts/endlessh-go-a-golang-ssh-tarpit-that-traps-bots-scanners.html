<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/shizunge/endlessh-go">Original</a>
    <h1>Endlessh-go: a Golang SSH tarpit that traps bots/scanners</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">A golang implementation of <a href="https://nullprogram.com/blog/2019/03/22/" rel="nofollow">endlessh</a> exporting Prometheus metrics, visualized by a Grafana dashboard.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/shizunge/endlessh-go/raw/main/dashboard/screenshot.png"><img src="https://github.com/shizunge/endlessh-go/raw/main/dashboard/screenshot.png" alt="screenshot"/></a></p>

<p dir="auto"><a href="https://nullprogram.com/blog/2019/03/22/" rel="nofollow">Endlessh</a> is a great idea that not only blocks the brute force SSH attacks, but also wastes attackers time as a kind of counter-attack. Besides trapping the attackers, I also want to visualize the Geolocations and other statistics of the sources of attacks. Unfortunately the wonderful original <a href="https://github.com/skeeto/endlessh">C implementation of endlessh</a> only provides text based log, but I do not like the solution that writes extra scripts to parse the log outputs, then exports the results to a dashboard, because it would introduce extra layers in my current setup and it would depend on the format of the text log file rather than some structured data. Thus I create this golang implementation of endlessh to export <a href="https://prometheus.io/" rel="nofollow">Prometheus</a> metrics and a <a href="https://grafana.com/" rel="nofollow">Grafana</a> dashboard to visualize them.</p>
<p dir="auto">If you want a dashboard of sources of attacks and do not mind the endlessh server, besides trapping the attackers, does extra things including: translating IP to Geohash, exporting Prometheus metrics, and using more memory (about 10MB), this is the solution for you.</p>

<p dir="auto">Clone the repo then build from source:</p>
<div data-snippet-clipboard-copy-content="go build .
./endlessh-go &amp;"><pre><code>go build .
./endlessh-go &amp;
</code></pre></div>
<p dir="auto">Alternatively, you can use the <a href="https://hub.docker.com/r/shizunge/endlessh-go" rel="nofollow">docker image</a>:</p>
<div data-snippet-clipboard-copy-content="docker run -d -p 2222:2222 shizunge/endlessh-go -logtostderr -v=1"><pre><code>docker run -d -p 2222:2222 shizunge/endlessh-go -logtostderr -v=1
</code></pre></div>
<p dir="auto">It listens to port <code>2222</code> by default.</p>
<p dir="auto">Then you can try to connect to the endlessh server. Your SSH client should hang there.</p>

<p dir="auto">If you want log like the <a href="https://github.com/skeeto/endlessh">C implementation</a>, you need to set both CLI arguments <code>-logtostderr</code> and <code>-v=1</code>, then the log will go to stderr. You can set different log destinations via CLI arguments.</p>
<p dir="auto">Also check out <a href="https://github.com/shizunge/endlessh-go/blob/main/examples/README.md">examples</a> for the setup of the full stack.</p>

<p dir="auto"><code>./endlessh-go --help</code></p>
<div data-snippet-clipboard-copy-content="Usage of ./endlessh-go
  -alsologtostderr
        log to standard error as well as files
  -conn_type string
        Connection type. Possible values are tcp, tcp4, tcp6 (default &#34;tcp&#34;)
  -enable_prometheus
        Enable prometheus
  -geoip_supplier string
        Supplier to obtain Geohash of IPs. Possible values are &#34;off&#34;, &#34;ip-api&#34;, &#34;max-mind-db&#34; (default &#34;off&#34;)
  -host string
        SSH listening address (default &#34;0.0.0.0&#34;)
  -interval_ms int
        Message millisecond delay (default 1000)
  -line_length int
        Maximum banner line length (default 32)
  -log_backtrace_at value
        when logging hits line file:N, emit a stack trace
  -log_dir string
        If non-empty, write log files in this directory
  -log_link string
        If non-empty, add symbolic links in this directory to the log files
  -logbuflevel int
        Buffer log messages logged at this level or lower (-1 means don&#39;t buffer; 0 means buffer INFO only; ...). Has limited applicability on non-prod platforms.
  -logtostderr
        log to standard error instead of files
  -max_clients int
        Maximum number of clients (default 4096)
  -max_mind_db string
        Path to the MaxMind DB file.
  -port value
        SSH listening port. You may provide multiple -port flags to listen to multiple ports. (default &#34;2222&#34;)
  -prometheus_clean_unseen_seconds int
        Remove series if the IP is not seen for the given time. Set to 0 to disable. (default 0)
  -prometheus_entry string
        Entry point for prometheus (default &#34;metrics&#34;)
  -prometheus_host string
        The address for prometheus (default &#34;0.0.0.0&#34;)
  -prometheus_port string
        The port for prometheus (default &#34;2112&#34;)
  -stderrthreshold value
        logs at or above this threshold go to stderr (default 2)
  -v value
        log level for V logs
  -vmodule value
        comma-separated list of pattern=N settings for file-filtered logging"><pre><code>Usage of ./endlessh-go
  -alsologtostderr
        log to standard error as well as files
  -conn_type string
        Connection type. Possible values are tcp, tcp4, tcp6 (default &#34;tcp&#34;)
  -enable_prometheus
        Enable prometheus
  -geoip_supplier string
        Supplier to obtain Geohash of IPs. Possible values are &#34;off&#34;, &#34;ip-api&#34;, &#34;max-mind-db&#34; (default &#34;off&#34;)
  -host string
        SSH listening address (default &#34;0.0.0.0&#34;)
  -interval_ms int
        Message millisecond delay (default 1000)
  -line_length int
        Maximum banner line length (default 32)
  -log_backtrace_at value
        when logging hits line file:N, emit a stack trace
  -log_dir string
        If non-empty, write log files in this directory
  -log_link string
        If non-empty, add symbolic links in this directory to the log files
  -logbuflevel int
        Buffer log messages logged at this level or lower (-1 means don&#39;t buffer; 0 means buffer INFO only; ...). Has limited applicability on non-prod platforms.
  -logtostderr
        log to standard error instead of files
  -max_clients int
        Maximum number of clients (default 4096)
  -max_mind_db string
        Path to the MaxMind DB file.
  -port value
        SSH listening port. You may provide multiple -port flags to listen to multiple ports. (default &#34;2222&#34;)
  -prometheus_clean_unseen_seconds int
        Remove series if the IP is not seen for the given time. Set to 0 to disable. (default 0)
  -prometheus_entry string
        Entry point for prometheus (default &#34;metrics&#34;)
  -prometheus_host string
        The address for prometheus (default &#34;0.0.0.0&#34;)
  -prometheus_port string
        The port for prometheus (default &#34;2112&#34;)
  -stderrthreshold value
        logs at or above this threshold go to stderr (default 2)
  -v value
        log level for V logs
  -vmodule value
        comma-separated list of pattern=N settings for file-filtered logging
</code></pre></div>

<p dir="auto">Endlessh-go exports the following Prometheus metrics.</p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>endlessh_client_open_count_total</td>
<td>count</td>
<td>Total number of clients that tried to connect to this host.</td>
</tr>
<tr>
<td>endlessh_client_closed_count_total</td>
<td>count</td>
<td>Total number of clients that stopped connecting to this host.</td>
</tr>
<tr>
<td>endlessh_sent_bytes_total</td>
<td>count</td>
<td>Total bytes sent to clients that tried to connect to this host.</td>
</tr>
<tr>
<td>endlessh_trapped_time_seconds_total</td>
<td>count</td>
<td>Total seconds clients spent on endlessh.</td>
</tr>
<tr>
<td>endlessh_client_open_count</td>
<td>count</td>
<td>Number of connections of clients. </td>
</tr>
<tr>
<td>endlessh_client_trapped_time_seconds</td>
<td>count</td>
<td>Seconds a client spends on endlessh. </td>
</tr>
</tbody>
</table>
<p dir="auto">The metrics is off by default, you can turn it via the CLI argument <code>-enable_prometheus</code>.</p>
<p dir="auto">It listens to port <code>2112</code> and entry point is <code>/metrics</code> by default. The port and entry point can be changed via CLI arguments.</p>
<p dir="auto">The endlessh-go server stores the geohash of attackers as a label on <code>endlessh_client_open_count</code>, which is also off by default. You can turn it on via the CLI argument <code>-geoip_supplier</code>. The endlessh-go uses service from <a href="https://ip-api.com/" rel="nofollow">ip-api</a>, which may enforce a query rate and limit commercial use. Visit their website for their terms and policies.</p>
<p dir="auto">You could also use an offline GeoIP database from <a href="https://www.maxmind.com" rel="nofollow">MaxMind</a> by setting <code>-geoip_supplier</code> to <em>max-mind-db</em> and <code>-max_mind_db</code> to the path of the database file.</p>

<p dir="auto">The dashboard requires Grafana 8.2.</p>
<p dir="auto">You can import the dashboard from Grafana.com using ID <a href="https://grafana.com/grafana/dashboards/15156" rel="nofollow">15156</a></p>
<p dir="auto">The dashboard visualizes data for the selected time range.</p>
<p dir="auto">The IP addresses are clickable and link you to the <a href="https://www.arin.net/" rel="nofollow">ARIN</a> database.</p>

<p dir="auto">If you have any problems or questions, please contact me through a <a href="https://github.com/shizunge/endlessh-go/issues">GitHub issue</a></p>
</article></div></div>
  </body>
</html>
