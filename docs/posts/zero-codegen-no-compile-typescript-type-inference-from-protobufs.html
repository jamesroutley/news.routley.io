<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/nathanhleung/protobuf-ts-types">Original</a>
    <h1>Show HN: Zero-codegen, no-compile TypeScript type inference from Protobufs</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<blockquote>
<p dir="auto">Zero-codegen, no-compile TypeScript <code>type</code> inference from protobuf <code>message</code>s.</p>
</blockquote>
<p dir="auto"><code>protobuf-ts-types</code> lets you define language-agnostic <code>message</code> types in <code>proto</code> format, then infers TypeScript types from them with no additional codegen.</p>
<p dir="auto"><a href="https://github.dev/nathanhleung/protobuf-ts-types/blob/main/examples/basic/index.ts" rel="nofollow">Try on github.dev</a> | <a href="https://codesandbox.io/p/github/nathanhleung/protobuf-ts-types/main?import=true&amp;embed=1&amp;file=%2Fexamples%2Fbasic%2Findex.ts" rel="nofollow">View on CodeSandbox</a></p>
<div dir="auto"><p dir="auto"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</p><p dir="auto">Proof of concept, not production ready. See <a href="#limitations">Limitations</a> below for more details.</p>
</div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/nathanhleung/protobuf-ts-types/blob/main/screenshot.png"><img src="https://github.com/nathanhleung/protobuf-ts-types/raw/main/screenshot.png" width="400px" alt="Screenshot"/></a></p>

<p dir="auto">In short, aggressive use of TypeScript&#39;s <a href="https://www.typescriptlang.org/docs/handbook/2/template-literal-types.html" rel="nofollow">template literal types</a>. Annotated example from the source:</p>
<div dir="auto" data-snippet-clipboard-copy-content="// Pass the proto string you want to infer `message` names from as a generic parameter
type MessageNames&lt;Proto extends string&gt; =
  // Infer `message` parts using template literal type
  WrapWithNewlines&lt;Proto&gt; extends `${string}${Whitespace}message${Whitespace}${infer MessageName}${OptionalWhitespace}{${string}}${infer Rest}`
    ? // Recursively infer remaining message names
      [MessageName, ...MessageNames&lt;Rest&gt;]
    : [];"><pre><span>// Pass the proto string you want to infer `message` names from as a generic parameter</span>
<span>type</span> <span>MessageNames</span><span>&lt;</span><span>Proto</span> <span>extends</span> <span>string</span><span>&gt;</span> <span>=</span>
  <span>// Infer `message` parts using template literal type</span>
  <span>WrapWithNewlines</span><span>&lt;</span><span>Proto</span><span>&gt;</span> <span>extends</span> `${<span>string</span><span>}</span>${<span>Whitespace</span><span>}</span>message${<span>Whitespace</span><span>}</span>${infer <span>MessageName</span><span>}</span>${<span>OptionalWhitespace</span><span>}</span>{${<span>string</span><span>}</span>}${infer <span>Rest</span><span>}</span>`
    ? <span>// Recursively infer remaining message names</span>
      <span>[</span><span>MessageName</span><span>,</span> ...<span>MessageNames</span><span>&lt;</span><span>Rest</span><span>&gt;</span><span>]</span>
    : <span>[</span><span>]</span><span>;</span></pre></div>
<p dir="auto">See more in <a href="https://github.com/nathanhleung/protobuf-ts-types/blob/main/src/proto.ts"><code>src/proto.ts</code></a>.</p>

<p dir="auto">First, install the package.</p>
<div data-snippet-clipboard-copy-content="npm install https://github.com/nathanhleung/protobuf-ts-types"><pre><code>npm install https://github.com/nathanhleung/protobuf-ts-types
</code></pre></div>
<p dir="auto">Then, use it in TypeScript.</p>
<div dir="auto" data-snippet-clipboard-copy-content="import { pbt } from &#34;protobuf-ts-types&#34;;

const proto = `
    syntax = &#34;proto3&#34;;

    message Person {
      string name = 1;
      int32 id = 2;
      bool is_ceo = 3;
      optional string description = 4;
    }

    message Group {
        string name = 1;
        repeated Person people = 2;
    }
`;

// `Proto` is a mapping of message names to message types, inferred from the
// `proto` source string above.
type Proto = pbt.infer&lt;typeof proto&gt;;

type Person = Proto[&#34;Person&#34;];
type Person2 = pbt.infer&lt;typeof proto, &#34;Person&#34;&gt;;

// `Person` and `Person2` are the same type:
// ```
// {
//     name: string;
//     id: number;
//     is_ceo: boolean;
//     description?: string;
// }
// ```

type Group = pbt.infer&lt;typeof proto, &#34;Group&#34;&gt;;

function greetPerson(person: Person) {
  console.log(`Hello, ${person.name}!`);

  if (person.description) {
    console.log(`${person.description}`);
  } else {
    console.log(&#34;(no description)&#34;);
  }
}

function greetGroup(group: Group) {
  console.log(`=========${&#34;=&#34;.repeat(group.name.length)}===`);
  console.log(`= Hello, ${group.name}! =`);
  console.log(`=========${&#34;=&#34;.repeat(group.name.length)}===`);

  for (const person of group.people) {
    greetPerson(person);
    console.log();
  }
}

// If the structure of the `Group` or any of the individual `Person`s does not
// match the type, TypeScript will show an error.
greetGroup({
  name: &#34;Hooli&#34;,
  people: [
    {
      name: &#34;Gavin Belson&#34;,
      id: 0,
      is_ceo: true,
      description: &#34;CEO of Hooli&#34;,
    },
    {
      name: &#34;Richard Hendricks&#34;,
      id: 1,
      is_ceo: true,
      description: &#34;CEO of Pied Piper&#34;,
    },
    {
      name: &#34;Dinesh Chugtai&#34;,
      id: 2,
      is_ceo: false,
      description: &#34;Software Engineer&#34;,
    },
    {
      name: &#34;Jared Dunn&#34;,
      id: 3,
      is_ceo: false,
    },
  ],
});

// Output:
// ```
// =================
// = Hello, Hooli! =
// =================
// Hello, Gavin Belson!
// CEO of Hooli

// Hello, Richard Hendricks!
// CEO of Pied Piper

// Hello, Dinesh Chugtai!
// Software Engineer

// Hello, Jared Dunn!
// (no description)
// ```"><pre><span>import</span> <span>{</span> <span>pbt</span> <span>}</span> <span>from</span> <span>&#34;protobuf-ts-types&#34;</span><span>;</span>

<span>const</span> <span>proto</span> <span>=</span> <span>`</span>
<span>    syntax = &#34;proto3&#34;;</span>
<span></span>
<span>    message Person {</span>
<span>      string name = 1;</span>
<span>      int32 id = 2;</span>
<span>      bool is_ceo = 3;</span>
<span>      optional string description = 4;</span>
<span>    }</span>
<span></span>
<span>    message Group {</span>
<span>        string name = 1;</span>
<span>        repeated Person people = 2;</span>
<span>    }</span>
<span>`</span><span>;</span>

<span>// `Proto` is a mapping of message names to message types, inferred from the</span>
<span>// `proto` source string above.</span>
<span>type</span> <span>Proto</span> <span>=</span> <span>pbt</span><span>.</span><span>infer</span><span>&lt;</span><span>typeof</span> <span>proto</span><span>&gt;</span><span>;</span>

<span>type</span> <span>Person</span> <span>=</span> <span>Proto</span><span>[</span><span>&#34;Person&#34;</span><span>]</span><span>;</span>
<span>type</span> <span>Person2</span> <span>=</span> <span>pbt</span><span>.</span><span>infer</span><span>&lt;</span><span>typeof</span> <span>proto</span><span>,</span> <span>&#34;Person&#34;</span><span>&gt;</span><span>;</span>

<span>// `Person` and `Person2` are the same type:</span>
<span>// ```</span>
<span>// {</span>
<span>//     name: string;</span>
<span>//     id: number;</span>
<span>//     is_ceo: boolean;</span>
<span>//     description?: string;</span>
<span>// }</span>
<span>// ```</span>

<span>type</span> <span>Group</span> <span>=</span> <span>pbt</span><span>.</span><span>infer</span><span>&lt;</span><span>typeof</span> <span>proto</span><span>,</span> <span>&#34;Group&#34;</span><span>&gt;</span><span>;</span>

<span>function</span> <span>greetPerson</span><span>(</span><span>person</span>: <span>Person</span><span>)</span> <span>{</span>
  <span>console</span><span>.</span><span>log</span><span>(</span><span>`Hello, <span><span>${</span><span>person</span><span>.</span><span>name</span><span>}</span></span>!`</span><span>)</span><span>;</span>

  <span>if</span> <span>(</span><span>person</span><span>.</span><span>description</span><span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`<span><span>${</span><span>person</span><span>.</span><span>description</span><span>}</span></span>`</span><span>)</span><span>;</span>
  <span>}</span> <span>else</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;(no description)&#34;</span><span>)</span><span>;</span>
  <span>}</span>
<span>}</span>

<span>function</span> <span>greetGroup</span><span>(</span><span>group</span>: <span>Group</span><span>)</span> <span>{</span>
  <span>console</span><span>.</span><span>log</span><span>(</span><span>`=========<span><span>${</span><span>&#34;=&#34;</span><span>.</span><span>repeat</span><span>(</span><span>group</span><span>.</span><span>name</span><span>.</span><span>length</span><span>)</span><span>}</span></span>===`</span><span>)</span><span>;</span>
  <span>console</span><span>.</span><span>log</span><span>(</span><span>`= Hello, <span><span>${</span><span>group</span><span>.</span><span>name</span><span>}</span></span>! =`</span><span>)</span><span>;</span>
  <span>console</span><span>.</span><span>log</span><span>(</span><span>`=========<span><span>${</span><span>&#34;=&#34;</span><span>.</span><span>repeat</span><span>(</span><span>group</span><span>.</span><span>name</span><span>.</span><span>length</span><span>)</span><span>}</span></span>===`</span><span>)</span><span>;</span>

  <span>for</span> <span>(</span><span>const</span> <span>person</span> <span>of</span> <span>group</span><span>.</span><span>people</span><span>)</span> <span>{</span>
    <span>greetPerson</span><span>(</span><span>person</span><span>)</span><span>;</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>)</span><span>;</span>
  <span>}</span>
<span>}</span>

<span>// If the structure of the `Group` or any of the individual `Person`s does not</span>
<span>// match the type, TypeScript will show an error.</span>
<span>greetGroup</span><span>(</span><span>{</span>
  <span>name</span>: <span>&#34;Hooli&#34;</span><span>,</span>
  <span>people</span>: <span>[</span>
    <span>{</span>
      <span>name</span>: <span>&#34;Gavin Belson&#34;</span><span>,</span>
      <span>id</span>: <span>0</span><span>,</span>
      <span>is_ceo</span>: <span>true</span><span>,</span>
      <span>description</span>: <span>&#34;CEO of Hooli&#34;</span><span>,</span>
    <span>}</span><span>,</span>
    <span>{</span>
      <span>name</span>: <span>&#34;Richard Hendricks&#34;</span><span>,</span>
      <span>id</span>: <span>1</span><span>,</span>
      <span>is_ceo</span>: <span>true</span><span>,</span>
      <span>description</span>: <span>&#34;CEO of Pied Piper&#34;</span><span>,</span>
    <span>}</span><span>,</span>
    <span>{</span>
      <span>name</span>: <span>&#34;Dinesh Chugtai&#34;</span><span>,</span>
      <span>id</span>: <span>2</span><span>,</span>
      <span>is_ceo</span>: <span>false</span><span>,</span>
      <span>description</span>: <span>&#34;Software Engineer&#34;</span><span>,</span>
    <span>}</span><span>,</span>
    <span>{</span>
      <span>name</span>: <span>&#34;Jared Dunn&#34;</span><span>,</span>
      <span>id</span>: <span>3</span><span>,</span>
      <span>is_ceo</span>: <span>false</span><span>,</span>
    <span>}</span><span>,</span>
  <span>]</span><span>,</span>
<span>}</span><span>)</span><span>;</span>

<span>// Output:</span>
<span>// ```</span>
<span>// =================</span>
<span>// = Hello, Hooli! =</span>
<span>// =================</span>
<span>// Hello, Gavin Belson!</span>
<span>// CEO of Hooli</span>

<span>// Hello, Richard Hendricks!</span>
<span>// CEO of Pied Piper</span>

<span>// Hello, Dinesh Chugtai!</span>
<span>// Software Engineer</span>

<span>// Hello, Jared Dunn!</span>
<span>// (no description)</span>
<span>// ```</span></pre></div>

<ul dir="auto">
<li>If not using inline (i.e., literals in TypeScript) proto <code>string</code>s <code>as const</code>, probably requires a <a href="https://github.com/nonara/ts-patch"><code>ts-patch</code></a> compiler patch to import <code>.proto</code> files until <a data-error-text="Failed to load title" data-id="779392318" data-permission-text="Title is private" data-url="https://github.com/microsoft/TypeScript/issues/42219" data-hovercard-type="issue" data-hovercard-url="/microsoft/TypeScript/issues/42219/hovercard" href="https://github.com/microsoft/TypeScript/issues/42219">microsoft/TypeScript#42219</a> is resolved</li>
<li><code>service</code>s and <code>rpc</code>s are not supported (only <code>message</code>s)</li>
<li><code>oneof</code> and <code>map</code> fields are not supported</li>
<li><code>import</code>s are not supported (for now, concatenate)</li>
</ul>


<p dir="auto">Top-level exported namespace.</p>
<div data-snippet-clipboard-copy-content="import { pbt } from &#34;protobuf-ts-types&#34;;"><pre><code>import { pbt } from &#34;protobuf-ts-types&#34;;
</code></pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto"><code>pbt.infer&lt;Proto extends string, MessageName extends string = &#34;&#34;&gt;</code></h3><a id="user-content-pbtinferproto-extends-string-messagename-extends-string--" aria-label="Permalink: pbt.infer&lt;Proto extends string, MessageName extends string = &#34;&#34;&gt;" href="#pbtinferproto-extends-string-messagename-extends-string--"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Given a proto source string, infers the types of the <code>message</code>s in the source.</p>

<ul dir="auto">
<li>If <code>MessageName</code> is an empty string, the returned type is a mapping from message names to message types.</li>
<li>If <code>MessageName</code> is a known <code>message</code>, the returned type is the inferred type of the given <code>MessageName</code>.</li>
<li>If <code>MessageName</code> is not a known <code>message</code>, the returned type is <code>never</code>.</li>
</ul>
</article></div></div>
  </body>
</html>
