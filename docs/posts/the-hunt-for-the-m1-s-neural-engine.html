<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://eclecticlight.co/2022/03/30/the-hunt-for-the-m1s-neural-engine/">Original</a>
    <h1>The hunt for the M1’s neural engine</h1>
    
    <div id="readability-page-1" class="page"><article id="post-64655">
	
	<!-- .entry-header -->

	
		<div data-first_letter="A">
		<p>After yesterday’s <a href="https://eclecticlight.co/2022/03/29/live-text-visual-look-up-face-recognition-ml-and-privacy/">explanation of the Apple Neural Engine</a> (ANE) in M1 series Macs, it’s time to go in search of this elusive part of Apple Silicon chips, and discover how it’s used.</p>
<p>So far, all I have seen of the ANE are some entries in the log, and claims for how much it can accelerate Machine Learning (ML). The ANE first makes its appearance early during the kernel phase of the boot process, initially through its Load Balancer, which is initialised with</p>
<p>That’s followed by the ANE interface:</p>
<p>After that, ANE seems to get along with its work quietly. During Visual Look Up, <code>mediaanalysisd</code> is a bit more forthcoming, posting short sequences at the start of each run of the ANE like</p>
<p>Those are followed by a series of messages written by <code>com.apple.Espresso</code>, which manages the ANE during Visual Look Up.</p>
<p>I next looked for an app which might load the ANE. Geekbench ML looked promising, but so far only seems available for iOS and Android, so I built my own using one of Apple’s ML demo projects. That ran consistently faster on M1 series Macs than on this Intel iMac Pro. For instance, the median time to complete one learn and test cycle was 2.26 seconds on Intel, and 1.21 seconds on M1 Macs. That’s a similar magnitude of acceleration that I have seen during neural network sections of Visual Look Up.</p>
<p>The acid test, though, was inspecting the responses of the ANE using <code>powermetrics</code>. That’s something of a monster, which can dump fine detail about each core and a great deal more, including a little about the ANE. Once running my test ML app, it was soon taking 100% active residency on the first of the P cores at a frequency of 3036-3228 MHz. However, that app didn’t make the ANE or GPU blink: ANE power remained steadfastly at 0 mW, with GPU power at only 5 mW and idling at 4 MHz. That’s in spite of the app making plenty of calls to use BNNS, and running for several seconds.</p>
<p>It was therefore time to return to the one feature which I know reliably invokes the ANE repeatedly, Visual Look Up (VLU). Running a series of <code>powermetrics</code> samples during successful VLU finally demonstrated the salience of the ANE.</p>
<p>In the first sampling period of a second, ANE drew 30 mW power, dropping slightly to 22 mW in the second period, then peaking at 49 mW in the third. ANE read reached a maximum of 232 MB/s and write 167 MB/s. GPU power and frequency remained low, suggesting that the ML code in VLU is normally handled by the ANE. Those figures correspond to the first phase of VLU involving analysis and parsing. The second, of visual search, was accompanied by shorter and lower ANE activity.</p>
<p><strong>Conclusions</strong></p>
<ul>
<li>Visual Look Up on M1 series Macs consistently uses the Apple Neural Engine.</li>
<li>VLU’s call chain is through <code>mediaanalysisd</code>, which uses Espresso to manage the ANE. Espresso is also used on Intel Macs to manage neural networks run on their CPU cores.</li>
<li>Maximum power drawn by the ANE was 49 mW, which is low even in comparison to that required by E cores.</li>
<li>The ANE reached high peak (memory) read and write rates of 232 and 167 MB/s during use.</li>
<li>BNNS functions may be run entirely on CPU cores, even when they appear suitable for the ANE, and the ANE is available.</li>
<li><code>powermetrics</code> is the tool of choice for observing ANE activity; indeed, it appears to be the only tool.</li>
</ul>
	</div><!-- .entry-content -->

	
	<!-- .entry-footer -->

</article></div>
  </body>
</html>
