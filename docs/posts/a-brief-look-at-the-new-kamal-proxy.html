<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://nts.strzibny.name/kamal-proxy/">Original</a>
    <h1>A brief look at the new Kamal Proxy</h1>
    
    <div id="readability-page-1" class="page"><section>
  <article>

    

    <p>Kamal 2 is coming with a brand new custom proxy that’s replacing Traefik. Let’s have a look at why is that and what it means.</p>

<h2 id="why-kamal-needs-a-proxy">Why Kamal needs a proxy</h2>

<p>Kamal is a simple deployment tool built around Docker containers. While Docker itself has a Swarm mode allowing for more robust deploys, Kamal keeps things simple by running the containers with straightforward <code>docker run</code> calls. But starting and stopping containers this way comes without their automatic replacement. Kamal needs a way to handle zero-downtime deployment for web containers so it originally incorporated Traefik.</p>

<h2 id="why-traefik">Why Traefik</h2>

<p>While there are many HTTP proxies around, Kamal was in the market for something of the auto-discovery of Docker containers. Something could make the proxy configuration management minimal. Traefik is such a proxy – it was specifically built as a dynamic reverse proxy for orchestrating container traffic. This meant that Kamal would only need to label the web containers for Traefik to select them. Docker health checks then did the rest by pointing to the healthy containers that should receive new traffic.</p>

<h2 id="why-a-new-proxy">Why a new proxy</h2>

<p>There was one problem with Traefik. Kamal had to create a special cord file on the host and bind mount it into the container to be able to control the health check that was responsible for driving traffic alongside the label. By introducing the cord file check Kamal could make any container unhealthy by deleting their associated cord file. And while it mostly worked, it was seen as a hack.</p>

<p>Kamal is an imperative tool and so it needs a proxy that works in a similar way. Traefik was also the most complex and misunderstood part of Kamal’s stack. So while people mostly figure things out in the end, there was an opportunity to simplify it. This is especially true when it comes to the most requested feature for Kamal – hosting multiple apps on the same system with automatic TLS certificates.</p>

<h2 id="kamal-proxy">Kamal Proxy</h2>

<p>The new Kamal proxy is simply called <code>kamal-proxy</code> and it’s designed to make it easy to coordinate zero-downtime deployments with an option of issuing TLS certificates. Instead of labeling containers, we tell the proxy what kind of service to deploy with a <code>hostname:port</code> target:</p>

<div><div><pre><code><span>$ </span>kamal-proxy deploy my-app <span>--target</span> web-1:3000
</code></pre></div></div>

<p>This reads as deploy <code>myapp</code> service with <code>web-1</code> hostname on port <code>3000</code>. We can reference the container like this thanks to the Docker DNS on the same network. Deploying a service like this will wait for the containers to become healthy and reroute the traffic from any previously deployed instance of the service.</p>

<p>But that’s not all. We can also specify a host to run more services on the same server:</p>

<div><div><pre><code><span>$ </span>kamal-proxy deploy first-app <span>--target</span> web-1:3000 <span>--host</span> app1.example.com
<span>$ </span>kamal-proxy deploy second-app <span>--target</span> web-2:3000 <span>--host</span> app2.example.com
</code></pre></div></div>

<p>Providing a host will ensure the ports are not in conflict.</p>

<p>And finally, if we need a certificate for the domain name we pass <code>--tls</code> at the end:</p>

<div><div><pre><code><span>$ </span>kamal-proxy deploy first-app <span>--target</span> web-1:3000 <span>--host</span> app1.example.com <span>--tls</span>
</code></pre></div></div>

<p>Note that there is no specific configuration file and the proxy itself has to be running.</p>

<h2 id="kamal-2-configuration">Kamal 2 configuration</h2>

<p>There will be little need for you to run the proxy commands yourself as it will be done by Kamal. Here’s how it will look in the Kamal <code>deploy/config.yml</code> file:</p>

<div><div><pre><code><span># config/deploy.yml</span>
<span>...</span>
<span># The new proxy config</span>
<span>proxy</span><span>:</span>
  <span>ssl</span><span>:</span> <span>true</span>
  <span>host</span><span>:</span> <span>app.example.com</span>
</code></pre></div></div>

<p>The new <code>proxy</code> settings have two parts. A required <code>host</code> for routing on the same system and optional <code>ssl</code> for automatic TLS certs.</p>

<h2 id="kamal-proxy-features">Kamal Proxy features</h2>

<p>To sum up the new proxy feature set:</p>

<ul>
  <li>Routing based on provided hosts</li>
  <li>Automatic TLS certificates via Let’s Encrypt</li>
  <li>Request and response buffering</li>
  <li>Maximum requests and response sizes</li>
</ul>

<p>The new proxy should also bring new features to Kamal such as pausing requests, maintenance mode and gradual rollouts.</p>



    <!-- Post Content End -->
<!--
    <div class="post-meta-down">
      
        <a href="/tag/kamal/" class="post-tag">kamal</a>
      
    </div>
-->

    
    <p>Check out my book</p>
    
    <div>

      <p><a href="https://kamalmanual.com/handbook/"><img src="https://nts.strzibny.name/img/kamalhandbook_cover.png" width="400"/></a></p>
      <p>
        Learn how to use Kamal to deploy your web applications with <a href="https://kamalmanual.com/handbook/">Kamal Handbook</a>. Visualize Kamal&#39;s concepts, understand Kamal&#39;s configuration, and deploy practical life examples.
      </p>
    </div>
    

    <p>
        Published on <time datetime="">21 Sep 2024</time>, updated on <time datetime="22 Sep 2024">22 Sep 2024</time>
        
      </p>

  </article>



</section></div>
  </body>
</html>
