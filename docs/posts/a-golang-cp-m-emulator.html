<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/skx/cpmulator">Original</a>
    <h1>Show HN: A Golang CP/M emulator</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">This repository contains a CP/M emulator, with integrated CCP, which is designed to run CP/M binaries:</p>
<ul dir="auto">
<li>The project was initially created to run <a href="https://github.com/skx/lighthouse-of-doom/">my text-based adventure game</a>, which I wrote a few years ago, to amuse my child.
<ul dir="auto">
<li>That was written in Z80 assembly language and initially targeted CP/M, although it was later ported to the ZX Spectrum.</li>
</ul>
</li>
</ul>
<p dir="auto">Over time this project has become more complete, and more complex, and I&#39;ve implemented enough functionity to run simple binaries and many of the well-known CP/M programs:</p>
<ul dir="auto">
<li>The Aztec C-Compiler.
<ul dir="auto">
<li>You can edit and compile C code within the emulator, then run it!</li>
</ul>
</li>
<li>Borland&#39;s Turbo Pascal
<ul dir="auto">
<li>You can edit and compile Pascal code within the emulator, then run it!</li>
</ul>
</li>
<li>Many early Infocom games:
<ul dir="auto">
<li>Zork 1, 2, &amp; 3.</li>
<li>Planetfall.</li>
<li>etc.</li>
</ul>
</li>
<li>Microsoft BASIC</li>
<li>Wordstar</li>
</ul>
<p dir="auto">The biggest caveat is that I&#39;ve not implemented any notion of disk-based access.  This means that, for example, opening, reading/writing, and closing files is absolutely fine, but any API call that refers to tracks, sectors, or disks will fail.</p>
<p dir="auto">A companion repository contains a collection of vintage CP/M software you can use with this, or any other, emulator:</p>
<ul dir="auto">
<li><a href="https://github.com/skx/cpm-dist">https://github.com/skx/cpm-dist</a></li>
</ul>

<p dir="auto">This emulator is written using golang, so if you have a working golang toolchain you can install in the standard way:</p>
<div data-snippet-clipboard-copy-content="go install github.com/skx/cpmulator@latest"><pre><code>go install github.com/skx/cpmulator@latest
</code></pre></div>
<p dir="auto">If you were to clone this repository to your local system you could then build and install by running:</p>

<p dir="auto">If neither of these options are suitable you may download the latest binary from <a href="https://github.com/skx/cpmulator/releases">the release page</a>.</p>
<p dir="auto">Releases will be made as/when features seem to justify it, but it should be noted that I consider the CLI tool, and the emulator itself, the &#34;product&#34;.  That means that the internal APIs will change around as/when necessary.</p>
<p dir="auto">If you wish to import any of the internal APIs you do so at the risk of changes happening at any time - although so far these have been minor I&#39;m not averse to changing parameters to internal packages, or adding/renaming/removing methods as necessary without any regard for external users.</p>

<ul dir="auto">
<li>Build/Install this application.</li>
<li>Clone the associated repository of binaries
<ul dir="auto">
<li><code>git clone https://github.com/skx/cpm-dist.git /tmp/cpm-dist</code></li>
</ul>
</li>
<li>Launch the emulator, pointing at the binaries
<ul dir="auto">
<li><code>cpmulator -cd /tmp/cpm-dist -directories</code></li>
</ul>
</li>
<li>Start something:
<ul dir="auto">
<li>&#34;B:&#34;, then &#34;MBASIC&#34; - to run BASIC.  (&#34;SYSTEM&#34; to exit)</li>
<li>&#34;G:&#34;, then &#34;ZORK1&#34; - to play zork1.</li>
<li>&#34;P:&#34;, then &#34;TURBO&#34; - to run turbo pascal.</li>
<li>&#34;E:&#34;, then &#34;WS&#34; - to run worstar.</li>
</ul>
</li>
</ul>

<p dir="auto">The CP/M input handlers need to disable echoing when reading (single) characters from STDIN.  There isn&#39;t a simple and portable solution for this in golang - so I&#39;ve resorted to the naive approach of executing <code>stty</code> when necessary.</p>
<p dir="auto">This means the code in this repository isn&#39;t 100% portable; it will work on Linux and MacOS hosts, but not Windows.</p>
<p dir="auto">There <em>is</em> code to set a console into RAW mode, and disable echoing input, for example you can <a href="https://cs.opensource.google/go/x/term/+/refs/tags/v0.20.0:term_unix.go" rel="nofollow">consider the code in the readPassword function</a> in <code>x/term</code>.  Unfortunately the facilities there are only sufficient for reading a <em>line</em>, not a <em>character</em> which means we&#39;ll need to essentially copy and paste their implementations inline to take advantage of this, and restore portability.</p>
<p dir="auto">This is tracked in #65.</p>

<p dir="auto">If you launch <code>cpmulator</code> with no arguments then one of the integrated CCPs (&#34;console command processor&#34;) will be launched, dropping you into a familiar shell:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ cpmulator
A&gt;dir

A: LICENSE .    | README  .MD  | CPMULATO.    | GO      .MOD
A: GO      .SUM | MAIN    .GO  | RET     .COM

A&gt;TYPE LICENSE
The MIT License (MIT)
..
A&gt;"><pre>$ cpmulator
A<span>&gt;</span>dir

A: LICENSE <span>.</span>    <span>|</span> README  .MD  <span>|</span> CPMULATO.    <span>|</span> GO      .MOD
A: GO      .SUM <span>|</span> MAIN    .GO  <span>|</span> RET     .COM

A<span>&gt;</span>TYPE LICENSE
The MIT License (MIT)
..
A<span>&gt;</span></pre></div>
<p dir="auto">You can terminate the CCP by pressing Ctrl-C, or typing <code>EXIT</code>.  The following built-in commands are available:</p>
<details>
<summary>Show the built-in commands of the default CCP:</summary>
<ul dir="auto">
<li><code>CLS</code>
<ul dir="auto">
<li>Clear the screen.</li>
</ul>
</li>
<li><code>DIR</code>
<ul dir="auto">
<li>List files, by default this uses &#34;<code>*.*</code>&#34;.
<ul dir="auto">
<li>Try &#34;<code>DIR *.COM</code>&#34; if you want to see something more specific, for example.</li>
</ul>
</li>
</ul>
</li>
<li><code>EXIT</code> / <code>HALT</code> / <code>QUIT</code>
<ul dir="auto">
<li>Terminate the CCP.</li>
</ul>
</li>
<li><code>ERA</code>
<ul dir="auto">
<li>Erase the named files, wildcards are permitted.</li>
</ul>
</li>
<li><code>TYPE</code>
<ul dir="auto">
<li>View the contents of the named file - wildcards are not permitted.</li>
</ul>
</li>
<li><code>REN</code>
<ul dir="auto">
<li>Rename files, so &#34;<code>REN NEW=OLD</code>&#34; - again note that wildcards are not permitted, nor is cross-drive renaming.</li>
</ul>
</li>
</ul>
</details>
<p dir="auto">There are currently a pair of CCP implementations included within the emulator, and they can be selected via the <code>-ccp</code> command-line flag:</p>
<ul dir="auto">
<li>&#34;ccp&#34;
<ul dir="auto">
<li>This is the default, but you can choose it explicitly via <code>cpmulator -ccp=ccp ..</code>.</li>
<li>The original/default one, from Digital Research</li>
</ul>
</li>
<li>&#34;ccpz&#34;
<ul dir="auto">
<li>Launch this via <code>cpmulate -ccp=ccpz ..</code></li>
<li>An enhanced one with extra built-in commands.</li>
<li>Notably &#34;GET 0100 FOO.COM&#34; will load a binary into RAM, at address 0x100.  Then &#34;JMP 0100&#34; will launch it.</li>
<li>The prompt changes to show user-number, for example if you run &#34;USER 3&#34;.</li>
<li>If a command isn&#39;t found in the current drive A: will be searched instead, which is handy.</li>
</ul>
</li>
</ul>
<p dir="auto">You can also launch a binary directly by specifying it&#39;s path upon the command-line, followed by any optional arguments that the binary accepts or requires:</p>
<div data-snippet-clipboard-copy-content="$ cpmulator /path/to/binary [optional-args]"><pre><code>$ cpmulator /path/to/binary [optional-args]
</code></pre></div>
<p dir="auto">Other options are shown in the output of <code>cpmulator -help</code>, but in brief:</p>
<ul dir="auto">
<li><code>-cd /path/to/directory</code>
<ul dir="auto">
<li>Change to the given directory before running.</li>
</ul>
</li>
<li><code>-directories</code>
<ul dir="auto">
<li>Use directories on the host for drive-contents, discussed later in this document.</li>
</ul>
</li>
<li><code>-log-path /path/to/file</code>
<ul dir="auto">
<li>Output debug-logs to the given file, creating it if necessary.</li>
</ul>
</li>
<li><code>-prn-path /path/to/file</code>
<ul dir="auto">
<li>All output which CP/M sends to the &#34;printer&#34; will be written to the given file.</li>
</ul>
</li>
</ul>

<p dir="auto">I&#39;ve placed some games within the <code>dist/</code> directory, to make it easier for you to get started:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ cd dist/
$ cpmulator ZORK1.COM
ZORK I: The Great Underground Empire
Copyright (c) 1981, 1982, 1983 Infocom, Inc. All rights
reserved.
ZORK is a registered trademark of Infocom, Inc.
Revision 88 / Serial number 840726

West of House
You are standing in an open field west of a white house, with
a boarded front door.
There is a small mailbox here.

&gt;"><pre>$ <span>cd</span> dist/
$ cpmulator ZORK1.COM
ZORK I: The Great Underground Empire
Copyright (c) 1981, 1982, 1983 Infocom, Inc. All rights
reserved.
ZORK is a registered trademark of Infocom, Inc.
Revision 88 / Serial number 840726

West of House
You are standing <span>in</span> an open field west of a white house, with
a boarded front door.
There is a small mailbox here.

<span>&gt;</span></pre></div>
<p dir="auto">A companion repository contains a larger collection of vintage CP/M software you can use with this emulator:</p>
<ul dir="auto">
<li><a href="https://github.com/skx/cpm-dist">https://github.com/skx/cpm-dist</a></li>
</ul>

<p dir="auto">By default when you launch <code>cpmulator</code> with no arguments you&#39;ll be presented with the CCP interface, with A: as the current drive.   In this mode A:, B:, C:, and all other drives, will refer to the current-working directory where you launched the emulator from (i.e. they have the same view of files).  This is perhaps the most practical way to get started, but it means that files are repeated across drives:</p>
<ul dir="auto">
<li>i.e. &#34;<code>A:FOO</code>&#34; is the same as &#34;<code>B:FOO</code>&#34;, and if you delete &#34;<code>C:FOO</code>&#34; you&#39;ll find it has vanished from all drives.
<ul dir="auto">
<li>In short &#34;<code>FOO</code>&#34; will exist on drives <code>A:</code> all the way through to <code>P:</code>.</li>
</ul>
</li>
</ul>
<p dir="auto">If you prefer you may configure drives to be distinct, each drive referring to a distinct sub-directory upon the host system (i.e. the machine you&#39;re running on):</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ mkdir A/  ; touch A/LS.COM ; touch A/FOO.COM
$ mkdir B/  ; touch B/DU.COM ; touch B/BAR.COM
$ mkdir G/  ; touch G/ME.COM ; touch G/BAZ.COM"><pre>$ mkdir A/  <span>;</span> touch A/LS.COM <span>;</span> touch A/FOO.COM
$ mkdir B/  <span>;</span> touch B/DU.COM <span>;</span> touch B/BAR.COM
$ mkdir G/  <span>;</span> touch G/ME.COM <span>;</span> touch G/BAZ.COM</pre></div>
<p dir="auto">Now if you launch the emulator you&#39;ll see only the files which <em>should</em> be visible on the appropriate drive:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ cpmulator -directories
A&gt;DIR A:
A: FOO     .COM | LS      .COM

A&gt;DIR B:
B: BAR     .COM | DU      .COM

A&gt;DIR G:
G: BAZ     .COM | ME      .COM

A&gt;DIR E:
No file"><pre>$ cpmulator -directories
A<span>&gt;</span>DIR A:
A: FOO     .COM <span>|</span> LS      .COM

A<span>&gt;</span>DIR B:
B: BAR     .COM <span>|</span> DU      .COM

A<span>&gt;</span>DIR G:
G: BAZ     .COM <span>|</span> ME      .COM

A<span>&gt;</span>DIR E:
No file</pre></div>
<p dir="auto">A companion repository contains a larger collection of vintage CP/M software you can use with this emulator:</p>
<ul dir="auto">
<li><a href="https://github.com/skx/cpm-dist">https://github.com/skx/cpm-dist</a></li>
</ul>
<p dir="auto">This is arranged into subdirectories, on the assumption you&#39;ll run with the <code>-directories</code> flag, and the drives are thus used as a means of organization.  For example you might want to look at games, on the <code>G:</code> drive, or the BASIC interpreters on the <code>B:</code> drive:</p>
<div data-snippet-clipboard-copy-content="frodo ~/Repos/github.com/skx/cpm-dist $ cpmulator  -directories
A&gt;g:
G&gt;dir *.com
G: HITCH   .COM | LEATHER .COM | LIHOUSE .COM | PLANET  .COM
G: ZORK1   .COM | ZORK2   .COM | ZORK3   .COM

G&gt;dir b:*.com
B: MBASIC  .COM | OBASIC  .COM | TBASIC  .COM"><pre><code>frodo ~/Repos/github.com/skx/cpm-dist $ cpmulator  -directories
A&gt;g:
G&gt;dir *.com
G: HITCH   .COM | LEATHER .COM | LIHOUSE .COM | PLANET  .COM
G: ZORK1   .COM | ZORK2   .COM | ZORK3   .COM

G&gt;dir b:*.com
B: MBASIC  .COM | OBASIC  .COM | TBASIC  .COM
</code></pre></div>
<p dir="auto">Note that it isn&#39;t currently possibly to point different drives to arbitrary paths on your computer, but that might be considered if you have a use-case for it.</p>

<p dir="auto">You can see the list of implemented syscalls, along with a mention of how complete their implementation is, by running:</p>
<div data-snippet-clipboard-copy-content="$ cpmulator -syscalls
BDOS
	00 P_TERMCPM
	01 C_READ
	02 C_WRITE
	03 A_READ
..snip..
BIOS
	00  BOOT
	01  WBOOT
..snip.."><pre><code>$ cpmulator -syscalls
BDOS
	00 P_TERMCPM
	01 C_READ
	02 C_WRITE
	03 A_READ
..snip..
BIOS
	00  BOOT
	01  WBOOT
..snip..
</code></pre></div>
<p dir="auto">Items marked &#34;FAKE&#34; return &#34;appropriate&#34; values, rather than real values.  Or are otherwise incomplete.</p>
<blockquote>
<p dir="auto">The only functions with significantly different behaviour are those which should send a single character to the printer (BDOS &#34;L_WRITE&#34; / BIOS &#34;LIST&#34;), they actually send their output to the file <code>print.log</code> in the current-directory, creating it if necessary.  (The path may be altered via the <code>-prn-path</code> command-line argument.)</p>
</blockquote>
<p dir="auto">The implementation of the syscalls is the core of our emulator, and they can be found here:</p>
<ul dir="auto">
<li><a href="https://github.com/skx/cpmulator/blob/master/cpm/cpm_bdos.go">cpm/cpm_bdos.go</a> - BDOS functions.
<ul dir="auto">
<li><a href="https://www.seasip.info/Cpm/bdos.html" rel="nofollow">https://www.seasip.info/Cpm/bdos.html</a></li>
</ul>
</li>
<li><a href="https://github.com/skx/cpmulator/blob/master/cpm/cpm_bios.go">cpm/cpm_bios.go</a> - BIOS functions.
<ul dir="auto">
<li><a href="https://www.seasip.info/Cpm/bios.html" rel="nofollow">https://www.seasip.info/Cpm/bios.html</a></li>
</ul>
</li>
</ul>

<p dir="auto">When an unimplemented BIOS call is attempted the program it will abort with a fatal error, for example:</p>
<div data-snippet-clipboard-copy-content="$ ./cpmulator FOO.COM
{&#34;time&#34;:&#34;2024-04-14T15:39:34.560609302+03:00&#34;,
  &#34;level&#34;:&#34;ERROR&#34;,
  &#34;msg&#34;:&#34;Unimplemented syscall&#34;,
  &#34;syscall&#34;:255,
  &#34;syscallHex&#34;:&#34;0xFF&#34;}
Error running FOO.COM: UNIMPLEMENTED"><pre><code>$ ./cpmulator FOO.COM
{&#34;time&#34;:&#34;2024-04-14T15:39:34.560609302+03:00&#34;,
  &#34;level&#34;:&#34;ERROR&#34;,
  &#34;msg&#34;:&#34;Unimplemented syscall&#34;,
  &#34;syscall&#34;:255,
  &#34;syscallHex&#34;:&#34;0xFF&#34;}
Error running FOO.COM: UNIMPLEMENTED
</code></pre></div>
<p dir="auto">If things are <em>mostly</em> working, but something is not quite producing the correct result then we have some notes on debugging:</p>
<ul dir="auto">
<li><a href="https://github.com/skx/cpmulator/blob/master/DEBUGGING.md">DEBUGGING.md</a></li>
</ul>
<p dir="auto">The following environmental variables influence runtime behaviour:</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>SIMPLE_CHAR</td>
<td>Avoid the attempted VT52 output conversion.</td>
</tr>
</tbody>
</table>
<p dir="auto">For reference the memory map of our CP/M looks like this:</p>
<ul dir="auto">
<li>0x0000 - Start of RAM</li>
<li>0xDE00 - The CCP</li>
<li>0xF000 - The BDOS (fake)</li>
<li>0xFE00 - The BIOS (fake)</li>
</ul>

<p dir="auto">You&#39;ll see some Z80 assembly programs beneath <a href="https://github.com/skx/cpmulator/blob/master/samples">samples</a> which are used to check my understanding.  If you have the <code>pasmo</code> compiler enabled you can build them all by running &#34;make&#34;, in case you don&#39;t I&#39;ve also committed the generated binaries.</p>

<ul dir="auto">
<li>Much of the functionality of this repository comes from the <a href="https://github.com/koron-go/z80">excellent Z80 emulator library</a> it is using, written by <a href="https://github.com/koron-go">@koron-go</a>.</li>
<li>The CCP comes from <a href="https://github.com/skx/z80-playground-cpm-fat/">my fork</a> of the original <a href="https://github.com/z80playground/cpm-fat/">cpm-fat</a>
<ul dir="auto">
<li>However this is largely unchanged from the <a href="http://www.cpm.z80.de/source.html" rel="nofollow">original CCP</a> from Digital Research, although I did add the <code>CLS</code>, <code>EXIT</code>, <code>HALT</code> &amp; <code>QUIT</code> built-in commands.</li>
</ul>
</li>
</ul>
<p dir="auto">When I was uncertain of how to implement a specific system call the following two emulators were also useful:</p>
<ul dir="auto">
<li><a href="https://github.com/ivanizag/iz-cpm">https://github.com/ivanizag/iz-cpm</a>
<ul dir="auto">
<li>Portable CP/M emulation to run CP/M 2.2 binaries for Z80.
<ul dir="auto">
<li>Has a handy &#34;download&#34; script to fetch some CP/M binaries, including BASIC, Turbo Pascal, and WordStar.</li>
</ul>
</li>
<li>Written in Rust.</li>
</ul>
</li>
<li><a href="https://github.com/jhallen/cpm">https://github.com/jhallen/cpm</a>
<ul dir="auto">
<li>Run CP/M commands in Linux/Cygwin with this Z80 / BDOS / ADM-3A emulator.</li>
<li>Written in C.</li>
</ul>
</li>
</ul>

<ul dir="auto">
<li><a href="http://www.gaby.de/cpm/manuals/archive/cpm22htm/" rel="nofollow">Digital Research - CP/M Operating System Manual</a>
<ul dir="auto">
<li>Particularly the syscall reference in <a href="http://www.gaby.de/cpm/manuals/archive/cpm22htm/ch5.htm" rel="nofollow">Section 5: CP/M 2 System Interface</a>.</li>
</ul>
</li>
<li>Sample code
<ul dir="auto">
<li><a href="https://github.com/Laci1953/RC2014-CPM/tree/main">https://github.com/Laci1953/RC2014-CPM/tree/main</a></li>
</ul>
</li>
</ul>

<p dir="auto">The testing that I should do before a release:</p>
<ul>
<li> Play lighthouse of doom to completion, either victory or death.</li>
<li> Compile a program with ASM &amp; LOAD.  Confirm it runs.</li>
<li> Compile HELLO.C and ECHO.C with Aztec C Compiler.
<ul>
<li> Confirm the generated binaries run.</li>
</ul>
</li>
<li> Run BBC Basic, and play a game.
<ul>
<li> Test &#34;SAVE&#34; and &#34;LOAD&#34; commands.</li>
<li> Test saving tokenized AND raw versions. (i.e <code>SAVE &#34;FOO&#34;</code>, and <code>SAVE &#34;FOO&#34;, A</code>.)</li>
</ul>
</li>
<li> Compile a program with Turbo Pascal.
<ul>
<li> Confirm the generated binary runs.</li>
</ul>
</li>
<li> Play Zork1 for a few turns.
<ul>
<li> Test SAVE and RESTORE commands, and confirm they work.</li>
</ul>
</li>
<li> Test BE.COM</li>
<li> Test STAT.COM</li>
<li> Test some built-in shell-commands; ERA TYPE, and EXIT.</li>
<li> Test <code>samples/INTEST.COM</code> <code>samples/READ.COM</code>, <code>samples/WRITE.COM</code>.</li>
</ul>

<p dir="auto">Let me know by filing an issue.  If your program is &#34;real&#34; then it is highly likely it will try to invoke an unimplemented BIOS function.</p>
<p dir="auto">Known issues:</p>
<ul dir="auto">
<li>Wordstar is broken.
<ul dir="auto">
<li>Don&#39;t care, because I have no strong attachment to it.</li>
<li>Seems to be related to console I/O via &#34;<code>RST xx</code>&#34; instructions.</li>
</ul>
</li>
<li>SUBMIT.COM doesn&#39;t work.
<ul dir="auto">
<li>I suspect at least part of this is CCP-related.</li>
<li>It can <em>print</em> the last record of a file, but not execute it.</li>
<li>I think it also doesn&#39;t work in reverse like it is supposed to.</li>
</ul>
</li>
</ul>
<p dir="auto">Steve</p>
</article></div></div>
  </body>
</html>
