<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://developer.chrome.com/blog/memory-safety-fonts">Original</a>
    <h1>Memory safety for web fonts</h1>
    
    <div id="readability-page-1" class="page">
    <devsite-progress type="indeterminate" id="app-progress"></devsite-progress>
  
    <a href="#main-content">
      
      Skip to main content
    </a>
    <section>
      <devsite-cookie-notification-bar></devsite-cookie-notification-bar><devsite-header role="banner">
  
    



























  
</devsite-header>
      
      <section id="gc-wrapper">
        <main role="main" id="main-content" has-sidebar="">
          
          
          
          <devsite-content>
            
              














<article>
  
  
  
  
  

  
  
    
  
  

  <devsite-toc depth="2" devsite-toc-embedded="">
  </devsite-toc>
  
    
  

  






<div>

  
    






<p>
  Published: March 19, 2025
</p>


<p><a href="https://github.com/googlefonts/fontations/tree/main/skrifa">Skrifa</a>
is written in
Rust,
and created as a replacement for FreeType to make font processing in Chrome
secure for all our users.
Skifra takes advantage of Rust&#39;s memory safety,
and lets us iterate faster on font technology improvements in Chrome.
Moving from FreeType to Skrifa allows us to be both agile and fearless when
making changes to our font code. We now spend far less time fixing security bugs,
resulting in faster updates, and better code quality.</p>

<p>This post shares why Chrome has moved away from FreeType,
and some interesting technical details of the improvements this move has enabled.</p>

<h2 id="why_replace_freetype" data-text="Why replace FreeType?" tabindex="-1">Why replace FreeType?</h2>

<p>The web is unique in that it allows users to fetch untrusted resources from a
wide variety of untrusted sources with the expectation that things will just
work, and that they are safe in doing so. This assumption is generally correct,
but keeping that promise to users comes at a cost. For example, to use a web
font safely (a font delivered over the network) Chrome employs several security
mitigations:</p>

<ul>
<li>Font processing is
<a href="https://chromium.googlesource.com/chromium/src/+/HEAD/docs/design/sandbox.md">sandboxed</a>
per the <a href="https://chromium.googlesource.com/chromium/src/+/main/docs/security/rule-of-2.md">rule of
two</a>:
they are untrustworthy and the consuming code is unsafe.</li>
<li>Fonts are passed through the <a href="https://github.com/khaledhosny/ots">OpenType
Sanitizer</a> prior to processing.</li>
<li>All the libraries involved in decompressing and processing fonts are <a href="https://en.wikipedia.org/wiki/Fuzzing">fuzz
tested</a>.</li>
</ul>

<p>Chrome ships with FreeType and makes use of it as the primary font processing
library on Android, ChromeOS, and Linux. That means a <strong>lot</strong> of users are
exposed if there is a vulnerability in FreeType.</p>

<p>The FreeType library is used by Chrome to compute metrics and load hinted
outlines from fonts. Overall, use of FreeType has been a huge win for Google. It
does a complex job, and does it well, we rely on it extensively and contribute
back to it. However, it is written in unsafe code and has its origins in a time
when malicious inputs were less likely. Merely keeping up with the stream of
issues found by fuzzing costs Google at least 0.25 full time software
engineers. Worse, we observably don&#39;t find everything or find things only after
the code has shipped to users.</p>

<p>This pattern of problems is not unique to FreeType, we observe that other unsafe
libraries admit issues even when we use the best software engineers we can find,
code review every change, and require tests.</p>

<h3 id="why_issues_keep_sneaking_in" data-text="Why issues keep sneaking in" tabindex="-1">Why issues keep sneaking in</h3>

<p>When we evaluated FreeType&#39;s security, we observed three main classes of issue
to occur (non-exhaustive):</p>

<h4 id="use_of_an_unsafe_language" data-text="Use of an unsafe language" tabindex="-1">Use of an unsafe language</h4>

<table>
  <thead>
    <tr>
      <th>Pattern/Issue</th>
      <th>Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Manual memory management</td>
      <td><ul>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2014-9661">CVE-2014-9661</a>, use after free, identified by Project Zero, <a href="https://project-zero.issues.chromium.org/issues/42450955">Project Zero tracker</a></li>
</ul>
<ul>
<li><a href="https://nvd.nist.gov/vuln/detail/cve-2020-15999">CVE-2020-15999</a>, heap overflow identified to be <a href="https://googleprojectzero.blogspot.com/2021/03/in-wild-series-october-2020-0-day.html">actively exploited</a> by Project Zero</li>
</ul>
</td>
    </tr>
    <tr>
      <td>Unchecked array access</td>
      <td><a href="https://nvd.nist.gov/vuln/detail/CVE-2022-27404">CVE-2022-27404</a></td>
    </tr>
    <tr>
      <td>Integer overflows</td>
      <td>During execution of embedded virtual machines for TrueType hinting of CFF drawing and hinting</td>
    </tr>
    <tr>
      <td>Incorrect use of zeroing versus non-zeroing allocation</td>
      <td>Discussion in <a href="https://gitlab.freedesktop.org/freetype/freetype/-/merge_requests/94">https://gitlab.freedesktop.org/freetype/freetype/-/merge_requests/94</a>, <a href="http://issues.chromium.org/issues?q=id:(40055682%20%7C%2040055692%20%7C%2040057647%20%7C%2040057647%20%7C%2040057653%20%7C%2040057656%20%7C%2040057666%20%7C%2040057667)">8 fuzzer issues found</a> afterwards </td>
    </tr>
    <tr>
      <td>Invalid casts</td>
      <td>See the following row on macro usage</td>
    </tr>
  </tbody>
</table>

<h4 id="project_specific_issues" data-text="Project specific issues" tabindex="-1">Project specific issues</h4>

<table>
  <thead>
    <tr>
      <th>Pattern/Issue</th>
      <th>Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Macros obscure lack of explicit size typing</td>
      <td><ul>
<li>Macros such as <code translate="no" dir="ltr">FT_READ_*</code> and <code translate="no" dir="ltr">FT_PEEK_*</code> obscure what integer types are being used, hiding that C99 types with explicit sizes (int16_t, etc) are not used</li>
</ul>
<ul>
<li><a href="https://gitlab.freedesktop.org/freetype/freetype/-/merge_requests/175">Fix reading s32 when long is s64</a></li>
</ul>
</td>
    </tr>
    <tr>
      <td>New code consistently adds bugs, even when written defensively.</td>
      <td><ul>
<li>COLRv1 and OT-SVG support both produced issues</li>
</ul>
<ul>
<li>Fuzzing finds some, but not necessarily all, <a href="https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=32421">#32421</a>, <a href="https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=52404">#52404</a></li>
</ul>
</td>
    </tr>
    <tr>
      <td>Lack of tests</td>
      <td><ul>
<li>Crafting test fonts is time consuming and difficult</li>
</ul>
<ul>
<li>For example, the <a href="https://gitlab.freedesktop.org/freetype/freetype/-/commit/a3bab162b2ae616074c8877a04556932998aeacd">fix</a> for <a href="https://nvd.nist.gov/vuln/detail/cve-2020-15999">CVE-2020-15999</a> adds no test </li>
</ul>
</td>
    </tr>
  </tbody>
</table>

<h4 id="dependency_issues" data-text="Dependency issues" tabindex="-1">Dependency issues</h4>

<p>Fuzzing has repeatedly identified issues in libraries FreeType depends on, such
as bzip2, libpng, and zlib. As an example, compare <a href="https://issues.chromium.org/issues/40055682">freetype_bdf_fuzzer:
Use-of-uninitialized-value in
inflate</a>.</p>

<h4 id="fuzzing_isnt_enough" data-text="Fuzzing isn&#39;t enough" tabindex="-1">Fuzzing isn&#39;t enough</h4>

<p>Fuzzing–automated testing with a wide range of inputs, including randomized
invalid ones–is meant to find many of the types of issues that get into the
stable release of Chrome. We fuzz FreeType as part of Google&#39;s
<a href="https://github.com/google/oss-fuzz">oss-fuzz</a> project. It does find issues, but
fonts have proven somewhat resistant to fuzzing, for the following reasons.</p>

<p>Font files are complex, comparable to video files as they contain multiple
different types of information. Font files are a container format for multiple
tables, where each table serves a different purpose in processing text and fonts
together to produce a correctly positioned glyph on the screen. In a font file
you will find:</p>

<ul>
<li>Static metadata such as font names and parameters for variable fonts.</li>
<li>Mappings from Unicode characters to glyphs.</li>
<li>A complex ruleset and grammar for screen layout of glyphs.</li>
<li>Visual information: Glyph shapes and image information describing what the
glyphs placed on the screen look like.
<ul>
<li>The visual tables can in turn include TrueType hinting programs, which
are mini programs executed to change the glyph shape.</li>
<li>Char strings in the CFF or CFF2 tables which are imperative curve
drawing and hinting instructions executed in the CFF rendering engine.</li>
</ul></li>
</ul>

<p>There is complexity in font files equivalent to having its own programming
language and state machine processing, requiring specific virtual machines to
execute them.</p>

<p>Because of the complexity of the format, fuzzing has shortcomings in finding
issues in font files.</p>

<p>Good code coverage or fuzzer progress is difficult to achieve for the following
reasons:</p>

<ul>
<li>Fuzzing TrueType hinting programs, CFF char strings and OpenType layout
using simple bit-flipping/shift/insertion/deletion-style mutators struggles
to reach all combinations of states.</li>
<li>Fuzzing needs to at least produce partially valid structures. Random
mutation rarely does so, making good coverage hard to achieve, particularly
for deeper levels of code.</li>
<li>The current fuzzing efforts in ClusterFuzz and oss-fuzz are not yet using
structure-aware mutation. Use of grammar- or structure-aware mutators might
help avoid production of variants that are rejected early, at the cost of
taking more time to develop, and introducing chances which miss parts of the
search space.</li>
</ul>

<p>Data in multiple tables needs to be in sync for fuzzing to make progress:</p>

<ul>
<li>The usual mutation patterns of fuzzers don&#39;t produce partially valid data
so many iterations get rejected and progress becomes slow.</li>
<li>The glyph mapping, the OpenType layout tables and glyph drawing are
connected and depend on each other, forming a combinatorial space whose
corners are hard to reach with fuzzing.</li>
<li>For example, the high-severity <a href="https://issues.chromium.org/40055587">tt_face_get_paint
COLRv1</a> vulnerability took more than
10 months to find.</li>
</ul>

<p>Despite our best efforts, font security issues have repeatedly reached end
users. Replacing FreeType with a Rust alternative will prevent multiple entire
classes of vulnerability.</p>

<h2 id="skrifa_in_chrome" data-text="Skrifa in Chrome" tabindex="-1">Skrifa in Chrome</h2>

<p><a href="https://skia.org/">Skia</a> is the graphics library used by Chrome. Skia relies on
FreeType to load metadata and letterforms from fonts.
<a href="https://github.com/googlefonts/fontations/tree/main/skrifa">Skrifa</a> is a Rust
library, part of the <a href="https://github.com/googlefonts/fontations">Fontations</a>
family of libraries, that provides a safe replacement for the parts of FreeType
used by Skia.</p>

<p>To transition FreeType to Skia the Chrome team developed a new Skia font backend
based on <a href="https://github.com/googlefonts/fontations/tree/main/skrifa">Skrifa</a>
and gradually rolled out the change to users:</p>

<ul>
<li>In <a href="https://chromiumdash.appspot.com/commit/6df58d58e667f19490acc1c51095aaf08842bea7">Chrome 128 (August 2024) we enabled
Fontations</a>
for use in less commonly used font formats, such as for color fonts and
CFF2, as a safe trial run.</li>
<li>In <a href="https://chromestatus.com/feature/5717358869217280">Chrome 133 (February 2025) we enabled
Fontations</a> for all web
fonts usage on Linux, Android and ChromeOS, and for web fonts usage as
fallback on Windows and Mac—in cases where the system does not support a
font format but Chrome needs to display it.</li>
</ul>

<p>For the integration into Chrome, we rely on the smooth integration of Rust into
the codebase introduced by the <a href="https://security.googleblog.com/2023/01/supporting-use-of-rust-in-chromium.html">Chrome security
team</a>.</p>

<p>In the future we&#39;ll switch to Fontations for operating system fonts as well,
starting with Linux and ChromeOS, then on Android.</p>

<h3 id="safety_first_and_foremost" data-text="Safety, first and foremost" tabindex="-1">Safety, first and foremost</h3>

<p>Our primary goal is to reduce (or ideally, eliminate!) security vulnerabilities
that are caused by out of bounds access to memory. Rust provides this out of the
box as long as you avoid any <em>unsafe</em> code blocks.</p>

<p>Our performance goals require us to perform one operation that is currently
unsafe: reinterpretation of arbitrary bytes as a strongly typed data structure.
This allows us to read the data from a font file without performing <a href="https://en.wikipedia.org/wiki/Zero-copy">unnecessary
copies</a> and is essential for producing
a fast font parser.</p>

<p>To avoid our own unsafe code, we&#39;ve chosen to outsource this responsibility to
<a href="https://crates.io/crates/bytemuck">bytemuck</a> which is a Rust library designed
specifically for this purpose and is widely tested and used across the
ecosystem. Concentrating raw data reinterpretation in bytemuck ensures we have
this functionality in one place and audited, and avoid repeating unsafe code for
the purpose. The <a href="https://rust-lang.github.io/rfcs/2835-project-safe-transmute.html">safe transmute
project</a> aims
to incorporate this functionality directly into the Rust compiler and we will
make the switch as soon as it is available.</p>

<h3 id="correctness_matters" data-text="Correctness matters" tabindex="-1">Correctness matters</h3>

<p>Skrifa is built out of independent components where most data structures are
designed to be immutable. This improves readability, maintainability and
multithreading. It also makes the code more amenable to unit testing. We&#39;ve
taken advantage of this opportunity and have produced a suite of roughly 700
unit tests that cover our full stack from low level parsing routines to high
level hinting virtual machines.</p>

<p>Correctness also implies fidelity and FreeType is highly regarded for its
generation of high quality outlines. We must match this quality to be a suitable
replacement. To that end, we have built a bespoke tool called
<a href="https://github.com/googlefonts/fontations/tree/main/fauntlet">fauntlet</a> that
compares the output of Skrifa and FreeType for batches of font files across a
wide range of configurations. This affords us some assurance that we can avoid
regressions in quality.</p>

<p>In addition, before the integration into Chromium, we ran a <a href="https://source.chromium.org/chromium/chromium/src/+/main:third_party/skia/gm/fontations_ft_compare.cpp">wide set of pixel
comparisons</a>
in Skia, comparing FreeType rendering to Skrifa and Skia rendering to ensure the
pixel differences are absolutely minimal, in all required rendering modes
(across different antialiasing and hinting modes).</p>

<p><a href="https://en.wikipedia.org/wiki/Fuzzing">Fuzz testing</a> is an important tool for
determining how a piece of software will react to malformed and malicious
inputs. We&#39;ve been continuously fuzzing our new code since June of 2024. This
covers the Rust libraries itself and the integration code. While the fuzzer has
found (as of this writing) 39 bugs, it&#39;s worth noting that <strong>none of these have
been security critical</strong>. They may cause undesired visual results or even
controlled crashes, but won&#39;t lead to exploitable vulnerabilities.</p>

<h2 id="onward" data-text="Onward!" tabindex="-1">Onward!</h2>

<p>We are very pleased with the results of our efforts to use Rust for text.
Delivering safer code to users <em>and</em> gaining developer productivity is a huge
win for us. We plan to continue to seek opportunities to use Rust in our text
stacks. If you&#39;d like to know more,
<a href="https://github.com/googlefonts/oxidize">Oxidize</a> outlines some of Google Fonts
future plans.</p>

  

  
</div>

  

  
    
    
      
    <devsite-thumb-rating position="footer">
    </devsite-thumb-rating>
  
       
    
    
  

  
  
</article>


<devsite-content-footer>
  <p>Except as otherwise noted, the content of this page is licensed under the <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 License</a>, and code samples are licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>. For details, see the <a href="https://developers.google.com/site-policies">Google Developers Site Policies</a>. Java is a registered trademark of Oracle and/or its affiliates.</p>
  <p>Last updated 2025-03-19 UTC.</p>
</devsite-content-footer>


<devsite-notification>
</devsite-notification>


  
<p>
  
  
    <template>
      [[[&#34;Easy to understand&#34;,&#34;easyToUnderstand&#34;,&#34;thumb-up&#34;],[&#34;Solved my problem&#34;,&#34;solvedMyProblem&#34;,&#34;thumb-up&#34;],[&#34;Other&#34;,&#34;otherUp&#34;,&#34;thumb-up&#34;]],[[&#34;Missing the information I need&#34;,&#34;missingTheInformationINeed&#34;,&#34;thumb-down&#34;],[&#34;Too complicated / too many steps&#34;,&#34;tooComplicatedTooManySteps&#34;,&#34;thumb-down&#34;],[&#34;Out of date&#34;,&#34;outOfDate&#34;,&#34;thumb-down&#34;],[&#34;Samples / code issue&#34;,&#34;samplesCodeIssue&#34;,&#34;thumb-down&#34;],[&#34;Other&#34;,&#34;otherDown&#34;,&#34;thumb-down&#34;]],[&#34;Last updated 2025-03-19 UTC.&#34;],[],[]]
    </template>
  
</p>
            
          </devsite-content>
        </main>
        
        
        
        <devsite-panel></devsite-panel>
        
      </section></section>
    <devsite-sitemask></devsite-sitemask>
    <devsite-snackbar></devsite-snackbar>
    <devsite-tooltip></devsite-tooltip>
    <devsite-heading-link></devsite-heading-link>
    <devsite-analytics>
      
        

      
    </devsite-analytics>
    
      <devsite-badger></devsite-badger>
    
    
    


    <devsite-a11y-announce></devsite-a11y-announce>
  
</div>
  </body>
</html>
