<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.huy.rocks/everyday/04-01-2022-typescript-how-the-compiler-compiles">Original</a>
    <h1>How the TypeScript Compiler Compiles</h1>
    
    <div id="readability-page-1" class="page"><div><div><p><span>«</span> <a href="https://www.huy.rocks/everyday">All posts</a></p>
<p>This article is inspired by the talk <a href="https://www.youtube.com/watch?v=X8k_4tZ16qU" target="_blank" rel="noopener">How the TypeScript compiler compiles</a><sup>◹</sup>, you should really check it out for a more in-depth understanding about the TypeScript’s compiling process.</p>
<p>At a high level, the TypeScript compiler is a tool to help us analyze and compile the TypeScript code into JavaScript (*.js), as well as some type definition files (*.d.ts) or source maps (*.js.map).</p>
<p><img src="https://raw.githubusercontent.com/huytd/everyday/master/_meta/tsc-high-level.png" alt=""/></p>
<p>If the source file contains some problems, the TypeScript compiler is also able to provide the diagnostics, so we know what went wrong and how to fix it.</p>
<h2><a name="the-compilation-process" href="#the-compilation-process">The compilation process</a></h2><p>Internally, it’s a complex process that involves many different parts, here’s the summary of the process:</p>
<p><img src="https://raw.githubusercontent.com/huytd/everyday/master/_meta/tsc-overview.png" alt=""/></p>
<p>The compilation process starts when you invoke the <code>tsc</code> command. To run, the TypeScript compiler needs a <code>tsconfig.json</code> file, this file essentially defines two parts: the <strong>Compiler Options</strong> and the <strong>Input Files</strong>.</p>
<pre><code><span><span>{</span></span>
<span>    <span>&#34;files&#34;</span><span>:</span> <span>[</span></span>
<span>        <span>&#34;src/*.ts&#34;</span></span>
<span>    <span>]</span><span>,</span></span>
<span>    <span>&#34;compilerOptions&#34;</span><span>:</span> <span>{</span></span>
<span>        ...</span>
<span>    <span>}</span></span>
<span><span>}</span></span>
</code></pre>
<p>The compilation context will be created as a <strong>Program</strong> object, defined in the <strong>src/compiler/program.ts</strong> file. When created, it loads all the input files and their imports. And call the <strong>Parser</strong> (defined in <strong>src/compiler/parser.ts</strong>) to parse each file into an <strong>AST</strong> (Abstract Syntax Tree).</p>
<p><img src="https://raw.githubusercontent.com/huytd/everyday/master/_meta/tsc-program-to-ast.png" alt=""/></p>
<p>Under the hood, the <strong>Parser</strong> creates a <strong>Scanner</strong> instance (defined in <strong>src/compiler/scanner.ts</strong>), which will scan the source code and generate a stream of <code>SyntaxKind</code> tokens.</p>
<p>The parsing process did not stop here, after this, the <strong>AST</strong> will be fed to the <strong>Binder</strong> (defined in <strong>src/compiler/binder.ts</strong>), to create a map between the <strong>AST Nodes</strong> and the <strong>Symbols</strong>.</p>
<p><img src="https://raw.githubusercontent.com/huytd/everyday/master/_meta/tsc-binder-symbols.png" alt=""/></p>
<p>A <strong>Symbol</strong> is additional metadata to store the type information of each <strong>Node</strong>. The <strong>Binder</strong> creates a <strong>Symbols Table</strong>, which will be used in later phases like type checking.</p>
<p> After this, with the <code>Program.emit</code> call, the <strong>Emit Worker</strong> will be created to transform the <strong>AST</strong> into a string of JavaScript source code and other stuff. There are 2 types of <strong>Emitter</strong>:</p>
<ul>
<li><strong>The JavaScript Emitter</strong>: defined in <strong>src/compiler/emitter.ts</strong>, emitting JavaScript source code and Source Maps.</li>
<li><strong>Type Definition Emitter</strong>: defined in <strong>src/compiler/definitionEmitter.ts</strong>, emitting type definition files.</li>
</ul>
<p>When the <strong>Emitter</strong> running, it will call the <code>getDiagnostics()</code> function to create a <strong>Type Checker</strong>, this object is defined in the <strong>src/compiler/checker.ts</strong> file. Then the <strong>Emitter</strong> will walk the <strong>AST</strong> to process each <strong>Node</strong>.</p>
<p>On each <strong>Node</strong>, it will perform code analysis, using the type data from the <strong>Symbols Table</strong>, and if everything goes well, the final JavaScript sources will be generated.</p>
<p><img src="https://raw.githubusercontent.com/huytd/everyday/master/_meta/tsc-emitter.png" alt=""/></p>
<h2><a name="error-reporting" href="#error-reporting">Error reporting</a></h2><p>There are different types of errors that could be returned during the compilation process, depending on what phase the compiler found the error.</p>
<pre><code><span><span>enum</span> <span>BuildResultFlags</span> {</span>
<span>    <span>None</span> = <span>0</span>,</span>
<span>    <span>Success</span> = <span>1</span> &lt;&lt; <span>0</span>,</span>
<span>    <span>DeclarationOutputUnchanged</span> = <span>1</span> &lt;&lt; <span>1</span>,</span>
<span> </span>
<span>    <span>ConfigFileErrors</span> = <span>1</span> &lt;&lt; <span>2</span>,</span>
<span>    <span>SyntaxErrors</span> = <span>1</span> &lt;&lt; <span>3</span>,</span>
<span>    <span>TypeErrors</span> = <span>1</span> &lt;&lt; <span>4</span>,</span>
<span>    <span>DeclarationEmitErrors</span> = <span>1</span> &lt;&lt; <span>5</span>,</span>
<span>    <span>EmitErrors</span> = <span>1</span> &lt;&lt; <span>6</span>,</span>
<span> </span>
<span>    <span>AnyErrors</span> = <span>ConfigFileErrors</span> | <span>SyntaxErrors</span> | <span>TypeErrors</span> | <span>DeclarationEmitErrors</span> | <span>EmitErrors</span></span>
<span>}</span>
</code></pre>
<p>For example, if there is an error in <code>tsconfig.json</code> file, the <code>ConfigFileErrors</code> will be returned.</p>
<p>If an error is found by the <strong>Scanner</strong>, it is the <code>SyntaxErrors</code>. Sometimes, the code is written in the correct syntax, but semantically incorrect, most of the time they are <code>TypeErrors</code>, which can be caught by the <strong>Parser</strong> or the <strong>Type Checker</strong>. For example:</p>
<pre><code><span><span>let</span> <span>a</span>: <span>number</span> = <span>&#34;hello&#34;</span>;</span>
</code></pre>
<p>This code is written in the correct syntax, but semantically incorrect because you cannot assign a string value to a number variable.</p>
<h2><a name="conclusion" href="#conclusion">Conclusion</a></h2><p>In this article, I only illustrate the overview and the relation between each part of the compilation process, with this, you are able to explore the TypeScript source code to see how things are actually implemented.</p>
<p>It is recommended to read the <a href="https://basarat.gitbook.io/typescript/overview" target="_blank" rel="noopener">TypeScript Compiler Internals</a><sup>◹</sup> document for a more in-depth version of this article (which also dives into which part of the code, and how things are called each other).</p>
<h2>Read more</h2>

<ul>
<li><a href="https://www.huy.rocks/everyday/04-04-2022-reading-notes-understand-complex-code-with-dry-run">04.04.2022 - Reading Notes/Understand Complex Code with Dry Run</a></li>
<li><a href="https://www.huy.rocks/everyday/04-03-2022-algorithms-sliding-window-with-two-pointers">04.03.2022 - Algorithms/Sliding Window With Two Pointers</a></li>
<li><a href="https://www.huy.rocks/everyday/04-02-2022-algorithms-merge-two-sorted-arrays-with-extra-space">04.02.2022 - Algorithms/Merge two sorted arrays with extra space</a></li>
<li><a href="https://www.huy.rocks/everyday/03-31-2022-typescript-the-intrinsic-keyword">03.31.2022 - TypeScript/The intrinsic keyword</a></li>
<li><a href="https://www.huy.rocks/everyday/03-30-2022-typescript-how-some-utility-types-are-implemented">03.30.2022 - TypeScript/How some utility types are implemented</a></li>
</ul>
</div></div></div>
  </body>
</html>
