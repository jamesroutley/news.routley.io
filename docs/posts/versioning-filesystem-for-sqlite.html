<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/sudeep9/mojo">Original</a>
    <h1>Show HN: Versioning Filesystem for SQLite</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">MojoFS is a versioning, userspace filesystem for sqlite DB. It is tailor made for sqlite and not supposed to be used as a general purpose fs.</p>
<p dir="auto">The main feature of the fs is versioning/snapshotting. Only one version is writable and all the old versions are immutable.</p>
<ul dir="auto">
<li><a href="#mojofs">MojoFS</a></li>
<li><a href="#license">License</a></li>
<li><a href="#development-status">Development status</a></li>
<li><a href="#build">Build</a></li>
<li><a href="#usage">Usage</a>
<ul dir="auto">
<li><a href="#create-databse-using-mojo-and-insert-few-records">Create databse using mojo and insert few records</a></li>
<li><a href="#select-data">Select data</a></li>
<li><a href="#commit-the-database">Commit the database</a></li>
<li><a href="#write-to-active-version2">Write to active version=2</a></li>
<li><a href="#read-old-version1">Read old version=1</a></li>
<li><a href="#read-active-version2">Read active version=2:</a></li>
</ul>
</li>
<li><a href="#docs">Docs</a></li>
<li><a href="#limits">Limits</a></li>
<li><a href="#testing">Testing</a></li>
<li><a href="#performance">Performance</a></li>
<li><a href="#road-to-v10">Road to v1.0</a></li>
</ul>

<p dir="auto">I have changed it to MIT. See the LICENSE file.</p>

<table>
<thead>
<tr>
<th>Item</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Quality</td>
<td>pre-alpha</td>
</tr>
<tr>
<td>Maintainance</td>
<td>active</td>
</tr>
</tbody>
</table>

<p dir="auto">At present only mac/linux is supported. Windows is not supported only because I do not have windows machine. This may change in future.</p>
<p dir="auto">The build expects the following in the environment:</p>
<ol dir="auto">
<li>Meson Build + Ninja (see <a href="https://mesonbuild.com/Getting-meson.html" rel="nofollow">here</a>)</li>
<li>C compiler (gcc or clang)</li>
<li>Rust version v1.59+</li>
<li>sqlite headers + libraries</li>
<li>Optional: python3 for testing (most versions should be ok)</li>
</ol>
<div data-snippet-clipboard-copy-content="git clone github.com/sudeep9/mojo
cd mojo
./build.sh release"><pre><code>git clone github.com/sudeep9/mojo
cd mojo
./build.sh release
</code></pre></div>
<p dir="auto">Following artifacts will be in <code>build</code> dir:</p>
<ul dir="auto">
<li><code>build/libmojo.dylib</code> (<code>.so</code> extension in linux) =&gt; The sqlite extension/vfs</li>
<li><code>build/mojo-cli</code> =&gt; mojo cli tool to manage the file system</li>
</ul>

<p dir="auto">All the examples below uses sqlite3 binary. However, you can use any bindings of sqlite.</p>
<h2 dir="auto"><a id="user-content-create-databse-using-mojo-and-insert-few-records" aria-hidden="true" href="#create-databse-using-mojo-and-insert-few-records"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Create databse using mojo and insert few records</h2>
<div data-snippet-clipboard-copy-content="rm -fR a.db
sqlite3 &lt;&lt;EOF
pragma page_size = 4096;
.load ./build/libmojo
.open &#39;file:a.db?vfs=mojo&amp;pagesz=4096&#39;
create table if not exists test (n int);
insert into test values(1);
insert into test values(2);
EOF"><pre><code>rm -fR a.db
sqlite3 &lt;&lt;EOF
pragma page_size = 4096;
.load ./build/libmojo
.open &#39;file:a.db?vfs=mojo&amp;pagesz=4096&#39;
create table if not exists test (n int);
insert into test values(1);
insert into test values(2);
EOF
</code></pre></div>
<p dir="auto">The <code>.load</code> loads the extension and registers the mojo vfs.</p>
<p dir="auto">The <code>.open</code> creates the database <code>a.db</code>. The mojofs creates a dir <code>a.db</code> instead of a file.</p>
<p dir="auto">The <code>pagesz=4096</code> is the page size which the fs will use.
This needs to be same as the page size used by sqlite.
I am not aware of any way this can be detected automatically by VFS layer.
Unfortunately its upto the user to ensure that these values are consistent.
If these values mismatch the database is bound to be corrupted.</p>
<h2 dir="auto"><a id="user-content-select-data" aria-hidden="true" href="#select-data"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Select data</h2>
<div data-snippet-clipboard-copy-content="sqlite3 &lt;&lt;EOF
pragma page_size = 4096;
.load ./build/libmojo
.open &#39;file:a.db?vfs=mojo&amp;pagesz=4096&#39;
select * from test;
EOF"><pre><code>sqlite3 &lt;&lt;EOF
pragma page_size = 4096;
.load ./build/libmojo
.open &#39;file:a.db?vfs=mojo&amp;pagesz=4096&#39;
select * from test;
EOF
</code></pre></div>
<p dir="auto">Output:</p>

<h2 dir="auto"><a id="user-content-commit-the-database" aria-hidden="true" href="#commit-the-database"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Commit the database</h2>
<div data-snippet-clipboard-copy-content="./build/mojo-cli ./a.db commit"><pre><code>./build/mojo-cli ./a.db commit
</code></pre></div>
<p dir="auto">Output:</p>
<div data-snippet-clipboard-copy-content="active version before commit: 1
active version after commit: 2"><pre><code>active version before commit: 1
active version after commit: 2
</code></pre></div>
<p dir="auto">New databases always start with version=1. The commit advances the version number. Here the version=1 is immutable and version=2 is now writable. Lets write again</p>
<h2 dir="auto"><a id="user-content-write-to-active-version2" aria-hidden="true" href="#write-to-active-version2"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Write to active version=2</h2>
<div data-snippet-clipboard-copy-content="sqlite3 &lt;&lt;EOF
pragma page_size = 4096;
.load ./build/libmojo
.open &#39;file:a.db?vfs=mojo&amp;pagesz=4096&#39;
insert into test values(3);
insert into test values(4);
EOF"><pre><code>sqlite3 &lt;&lt;EOF
pragma page_size = 4096;
.load ./build/libmojo
.open &#39;file:a.db?vfs=mojo&amp;pagesz=4096&#39;
insert into test values(3);
insert into test values(4);
EOF
</code></pre></div>
<h2 dir="auto"><a id="user-content-read-old-version1" aria-hidden="true" href="#read-old-version1"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Read old version=1</h2>
<div data-snippet-clipboard-copy-content="sqlite3 &lt;&lt;EOF
pragma page_size = 4096;
.load ./build/libmojo
.open &#39;file:a.db?vfs=mojo&amp;pagesz=4096&amp;ver=1&amp;mode=ro&#39;
select * from test;
EOF"><pre><code>sqlite3 &lt;&lt;EOF
pragma page_size = 4096;
.load ./build/libmojo
.open &#39;file:a.db?vfs=mojo&amp;pagesz=4096&amp;ver=1&amp;mode=ro&#39;
select * from test;
EOF
</code></pre></div>
<p dir="auto">We specify the <code>ver=1</code> and <code>mode=ro</code> (i.e. readonly)</p>
<p dir="auto">Output:</p>

<h2 dir="auto"><a id="user-content-read-active-version2" aria-hidden="true" href="#read-active-version2"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Read active version=2:</h2>
<div data-snippet-clipboard-copy-content="sqlite3 &lt;&lt;EOF
pragma page_size = 4096;
.load ./build/libmojo
.open &#39;file:a.db?vfs=mojo&amp;pagesz=4096&#39;
select * from test;
EOF"><pre><code>sqlite3 &lt;&lt;EOF
pragma page_size = 4096;
.load ./build/libmojo
.open &#39;file:a.db?vfs=mojo&amp;pagesz=4096&#39;
select * from test;
EOF
</code></pre></div>
<p dir="auto">Output:</p>


<p dir="auto">There is a design doc <a href="https://github.com/sudeep9/mojo/blob/main/design.md">here</a></p>
<p dir="auto">There is a user-guide <a href="https://github.com/sudeep9/mojo/blob/main/user-guide.md">here</a></p>

<p dir="auto">For a page size = 4KB (which is the default for sqlite for some years now) following are the limits:</p>
<ul dir="auto">
<li>
<p dir="auto">Max sqlite db file size (KB) = <code>pow(2,32) * 4</code> = 17179869184 KB or 16TB</p>
<p dir="auto">16TB is logical size i.e. file size reported by stat like call in any version. Since there could be multiple versions of the file, the total size of all such versions taken together can exceed 16TB.</p>
</li>
<li>
<p dir="auto">Max version num = <code>pow(2,24)</code> = 16777216 or 16 million</p>
<p dir="auto">To put 16M versions in perspective, even if you create a version every 1 min, it will take ~31.92 years to reach the max version.</p>
</li>
</ul>
<p dir="auto">Note: All these limits are actually artificial to keep the memory usage reasonable. In future, these will be tunable and also have the ability to baseline the versions.</p>

<p dir="auto">I wanted to use sqlite <a href="https://www.sqlite.org/th3.html" rel="nofollow">test harness</a> but it requires license. Quoting from the test harness link:</p>
<blockquote>
<p dir="auto">SQLite itself is in the public domain and can be used for any purpose. But TH3 is proprietary and requires a license.</p>
</blockquote>
<p dir="auto">Instead there is <code>testdb.py</code> for black box testing and <code>perftest.py</code> for perf tests.
At present the <code>testdb.py</code> tests combinations of the following:</p>
<div data-snippet-clipboard-copy-content="page_sizes = [4096]
journal_modes = [&#34;OFF&#34;, &#34;WAL&#34;, &#34;MEMORY&#34;, &#34;DELETE&#34;, &#34;TRUNCATE&#34;, &#34;PERSIST&#34;]
vacuum_modes = [&#34;NONE&#34;, &#34;FULL&#34;, &#34;INCREMENTAL&#34;]"><pre><code>page_sizes = [4096]
journal_modes = [&#34;OFF&#34;, &#34;WAL&#34;, &#34;MEMORY&#34;, &#34;DELETE&#34;, &#34;TRUNCATE&#34;, &#34;PERSIST&#34;]
vacuum_modes = [&#34;NONE&#34;, &#34;FULL&#34;, &#34;INCREMENTAL&#34;]
</code></pre></div>
<p dir="auto">For each of the combination, there are about ~11 subtests so in all 18 x 11 = 198 tests.
These are early days and off-course there is a long way to go.</p>
<p dir="auto">To run the full suite:</p>
<div data-snippet-clipboard-copy-content="python3 testdb.py build/libmojo full"><pre><code>python3 testdb.py build/libmojo full
</code></pre></div>

<p dir="auto">About <code>10_000_000</code> rows are inserted and then for reading we select the rows and get the row count.
Finally it updates half the rows.</p>
<p dir="auto">To run the perf test:</p>
<div data-snippet-clipboard-copy-content="MOJOKV_CLI=build/mojo-cli python3 perftest.py ./build/libmojo"><pre><code>MOJOKV_CLI=build/mojo-cli python3 perftest.py ./build/libmojo
</code></pre></div>
<p dir="auto">Output on 2018/19 macbook:</p>
<div data-snippet-clipboard-copy-content="Running perf for: insert
	vfs=std time elapsed (s): 20.524982929229736
	vfs=mojo time elapsed (s): 21.202611923217773
	Mojo takes 1.033 times than std vfs
------------------------
Running perf for: update rows
	vfs=std time elapsed (s): 2.871242046356201
	vfs=mojo time elapsed (s): 2.439574956893921
	Mojo takes 0.85 times than std vfs
------------------------
Running perf for: select
select iter count: 10000000
	vfs=std time elapsed (s): 8.659775018692017
select iter count: 10000000
	vfs=mojo time elapsed (s): 5.907814025878906
	Mojo takes 0.682 times than std vfs
------------------------
Running perf for: row count
row count: 0
	vfs=std time elapsed (s): 2.96425199508667
row count: 0
	vfs=mojo time elapsed (s): 1.5106308460235596
	Mojo takes 0.51 times than std vfs
------------------------"><pre><code>Running perf for: insert
	vfs=std time elapsed (s): 20.524982929229736
	vfs=mojo time elapsed (s): 21.202611923217773
	Mojo takes 1.033 times than std vfs
------------------------
Running perf for: update rows
	vfs=std time elapsed (s): 2.871242046356201
	vfs=mojo time elapsed (s): 2.439574956893921
	Mojo takes 0.85 times than std vfs
------------------------
Running perf for: select
select iter count: 10000000
	vfs=std time elapsed (s): 8.659775018692017
select iter count: 10000000
	vfs=mojo time elapsed (s): 5.907814025878906
	Mojo takes 0.682 times than std vfs
------------------------
Running perf for: row count
row count: 0
	vfs=std time elapsed (s): 2.96425199508667
row count: 0
	vfs=mojo time elapsed (s): 1.5106308460235596
	Mojo takes 0.51 times than std vfs
------------------------
</code></pre></div>
<p dir="auto">The writes being only <code>1.033</code> times worse is in line with my expectations. However, I am investigating why the reads are so better with mojo.</p>
<p dir="auto">My guess as of now is that in the standard default vfs at <a href="https://github.com/sqlite/sqlite/blob/master/src/os_unix.c">https://github.com/sqlite/sqlite/blob/master/src/os_unix.c</a> does not use pread, whereas mojo uses pread. Lack of pread results into two system call i.e. seek + read. This <em><strong>might</strong></em> explain the perf difference. This need further confirmation though.</p>
<p dir="auto">See the comment and code in the c file above:</p>
<div data-snippet-clipboard-copy-content="** ... Since SQLite does not define USE_PREAD
** in any form by default, we will not attempt to define _XOPEN_SOURCE.
** See tickets #2741 and #2681."><pre><code>** ... Since SQLite does not define USE_PREAD
** in any form by default, we will not attempt to define _XOPEN_SOURCE.
** See tickets #2741 and #2681.
</code></pre></div>
<p dir="auto">In seekAndRead function:</p>
<div data-snippet-clipboard-copy-content="#if defined(USE_PREAD)
    got = osPread(id-&gt;h, pBuf, cnt, offset);
    SimulateIOError( got = -1 );
#elif defined(USE_PREAD64)
    got = osPread64(id-&gt;h, pBuf, cnt, offset);
    SimulateIOError( got = -1 );
#else
    newOffset = lseek(id-&gt;h, offset, SEEK_SET);
    SimulateIOError( newOffset = -1 );
    if( newOffset&lt;0 ){
      storeLastErrno((unixFile*)id, errno);
      return -1;
    }
    got = osRead(id-&gt;h, pBuf, cnt);"><pre><code>#if defined(USE_PREAD)
    got = osPread(id-&gt;h, pBuf, cnt, offset);
    SimulateIOError( got = -1 );
#elif defined(USE_PREAD64)
    got = osPread64(id-&gt;h, pBuf, cnt, offset);
    SimulateIOError( got = -1 );
#else
    newOffset = lseek(id-&gt;h, offset, SEEK_SET);
    SimulateIOError( newOffset = -1 );
    if( newOffset&lt;0 ){
      storeLastErrno((unixFile*)id, errno);
      return -1;
    }
    got = osRead(id-&gt;h, pBuf, cnt);
</code></pre></div>

<p dir="auto">It needs atleast the following:</p>
<ul>
<li> Top-notch unit &amp; black box test coverage</li>
<li> Ease of use e.g debugability, add more mojo-cli admin commands</li>
<li> Ability to diff the versions</li>
<li> Ability to delete versions</li>
<li> Ability to merge versions (not like git merge)</li>
<li> Ability to recover from corrupted fs.</li>
<li> Stablize on-disk format</li>
<li> User guide</li>
</ul>
<p dir="auto">A lot of the above needs to be clearly defined.</p>
</article>
          </div></div>
  </body>
</html>
