<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.scannedinavian.com/my-own-system-packages-in-nixos.html">Original</a>
    <h1>My own system packages in NixOS</h1>
    
    <div id="readability-page-1" class="page"><div id="content">
	    
	    <p>
    Posted on 2024-04-27
    
</p>

<p><img src="https://www.scannedinavian.com/images/brynslustafirB.png"/></p>
<p>I haven’t blogged about my <a href="https://github.com/shapr/bloohm">cool command line tool</a> before, but <a href="https://mclare.blog/posts/adapting-a-bloom-filter-to-rust/">mclare has</a>. The idea is to show the status of multiple processes at the same time, using a bloom filter for layout.</p>
<p>It works great, but I want to make it a system wide package in NixOS.</p>
<p>I’ve bounced off this several times before, let’s see how it goes.</p>

<p>We have a Haskell command line program in a git repository.</p>
<p>I figure we can start with one that already works, utdemir’s <a href="https://github.com/utdemir/nix-tree">nix-tree</a>.</p>
<p>Let’s steal the flake.nix from nix-tree and drop it into the bloohm repo.</p>

<pre><code>error: Package ‘serialport-0.5.5’ in /nix/store/2z3llj8h7kwc3s6xw49zpy5vvqqimyr3-source/pkgs/development/haskell-modules/hackage-packages.nix:267788 is marked as broken, refusing to evaluate.
</code></pre>
<p>It seems that the serialport library is marked as “broken” in the nix packages collection.</p>
<p>How does that happen? How are Haskell libraries marked broken?</p>

<p>A short duck search later I find something on the NixOS discourse, <a href="https://discourse.nixos.org/t/working-with-haskell-broken-packages/30126">How to work with broken Haskell packages</a>.</p>
<p>There’s a link to the <a href="https://nixos.org/manual/nixpkgs/stable/#haskell-available-packages">Haskell section</a> of the nix manual, and from there to the <a href="https://github.com/NixOS/nixpkgs/blob/haskell-updates/pkgs/development/haskell-modules/configuration-hackage2nix/broken.yaml">list of broken packages</a>.</p>
<p>Searching inside that page for serialport turns up:</p>
<div id="cb2"><pre><code><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span>-</span><span> serialport</span><span> # failure in job https://hydra.nixos.org/build/233201348 at 2023-09-02</span></span></code></pre></div>
<p>As far as I can tell, the serialport library tests don’t pass unless you have an arduino running the <a href="https://github.com/standardsemiconductor/serialport/blob/main/tests/haskell_serial_test/haskell_serial_test.ino">test code</a> attached to a serial port. That’s not gonna happen on a Nix builder, and I don’t know how to fix that.</p>

<p>I can ugly-hack my way around that by adding <code>allowBroken = true</code> which makes me sad.</p>
<div id="cb3"><pre><code><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>pkgs = <span>import</span> nixpkgs <span>{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span>inherit</span> system<span>;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span>overlays</span> <span>=</span> <span>[</span> overlay <span>];</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span>config</span> <span>=</span> <span>{</span> <span>allowBroken</span> <span>=</span> <span>true</span><span>;</span> <span>};</span> <span># THIS MAKES ME SAD</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span>}</span>;</span></code></pre></div>

<p>I know I need to use an overlay, but after reading about overlays and how to call them, I gave up and used <code>nix profile install &#39;.#&#39;</code> .</p>
<p>This caused me a bit of extra excitement when I upgraded my package, I can’t reinstall an already installed package.</p>
<p>I got an error telling me to run this command:</p>
<pre><code>nix profile remove git+file:///home/shae/build/bloohm#defaultPackage.x86_64-linux
</code></pre>
<p>but that failed, and I had to remove the nix store path directly:</p>
<pre><code>&gt; nix profile remove &#39;/nix/store/74s361g85hxm4c1iw2bkvbprv6xvnjpc-bloohm-1.0.0.0&#39;
removing &#39;git+file:///home/shae/build/bloohm#defaultPackage.x86_64-linux&#39;
</code></pre>
<p>That’s good enough for now, hopefully I’ll learn enough about overlays to make this a system package.</p>

<p>I updated <a href="https://github.com/shapr/bloohm/blob/main/flake.nix">bloohm</a> to use Nix Flakes, and I published a <a href="https://hackage.haskell.org/package/bloohm">new version</a> to the official Haskell repository!</p>
<p>And there’s something wrong with the build <strong>grumble</strong> I’ll get back to that later.</p>

	</div></div>
  </body>
</html>
