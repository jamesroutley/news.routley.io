<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.phoronix.com/review/amd-zen4-spectrev2">Original</a>
    <h1>AMD Ryzen 7000 Series performs better with Spectre V2 Mitigations enabled</h1>
    
    <div id="readability-page-1" class="page"><div>

<p>Last week I shared some initial numbers how <a href="https://www.phoronix.com/news/AMD-Zen-4-Mitigations-Off">surprisingly when disabling Zen 4 CPU security mitigations can actually *hurt* the Ryzen 7000 series CPU performance</a>. While conventional wisdom and with past Intel/AMD processors yield better performance when disabling the CPU security mitigations, with the Ryzen 9 7950X it was found to be basically the opposite. I have since conducted more tests and using an AMD Ryzen 5 7600X to confirm the earlier results and dig deeper into the data.</p>
<p><a href="https://www.phoronix.com/image-viewer.php?id=amd-zen4-spectrev2&amp;image=zen4_spectre_1_lrg" target="_blank"><img src="https://www.phoronix.net/image.php?id=amd-zen4-spectrev2&amp;image=zen4_spectre_1_med"/></a></p>
<p>The data shared last week showed that for most tests, it was actually faster keeping the AMD Ryzen 9 7950X in its default and secure mitigated state with still having some software controls pertaining to Spectre V1/V2/V4. That&#39;s the out-of-the-box Linux state for the Ryzen 7000 &#34;Zen 4&#34; processors where booting the kernel with &#34;mitigations=off&#34; was actually leading to worse performance - the opposite compared to what we&#39;ve seen out of earlier x86_64 processors.</p>
<p><a href="https://www.phoronix.com/image-viewer.php?id=amd-zen4-spectrev2&amp;image=zen4_spectre_2_lrg" target="_blank"><img src="https://www.phoronix.net/image.php?id=amd-zen4-spectrev2&amp;image=zen4_spectre_2_med"/></a></p>
<p>Using an AMD Ryzen 5 7600X along with some other slight hardware/software differences and mostly the same benchmarks, I repeated the testing just to confirm last week&#39;s finding. And sure, enough, the Ryzen 5 7600X was clearly performing better with the default mitigations than in the mitigations=off state. Here is the side-by-side on the Ryzen 5 7600X with the defaults versus mitigations=off on Linux 6.0:</p>

<p>For the vast majority of the benchmarks, keeping to the default state was faster than mitigations=off. Disabling the mitigations did help in a small subset of tests, mostly the various synthetic kernel benchmarks. OpenJDK Java workloads, database workloads, web browser tests, and many other workloads normally negatively impacted by the Spectre mitigations were actually running better on this Ryzen 5 7600X system than when disabling the mitigations.</p>

<p>As a reminder, Zen 4 is not affected by most of the known CPU security vulnerabilities. What is still relevant from a software perspective based on the CPU MSRs and applied with Linux 6.0 is Speculative Store Bypass disabled via prctl for the SSBD / Spectre V4 mitigation and Spectre V1 mitigations of usercopy/SWAPGS barriers and __user pointer sanitization. Then for Spectre V2 there are Retpolines, conditional Indirect Branch Predictor Barriers (IBPB), IBRS firmware, always-on Single Threaded Indirect Branch Predictors (STIBP), and Return Stack Buffer (RSB) filling.</p>
<p>So to dig deeper and being curious, I was trying out some of the more targeting kernel options for these mitigations to see what in particular is causing Zen 4 to run slower when disabled.</p>
</div></div>
  </body>
</html>
