<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.timschumi.net/2024/01/20/ah532-bios-investigation.html">Original</a>
    <h1>Investigating a vanishing BIOS on the Fujitsu Lifebook AH532</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p>A few months ago, I got given a laptop with a very interesting condition.
The BIOS setup menu was supposedly inaccessible, and nothing apart from the default
boot option works. Time to investigate to see what is actually happening
and what we can do about it.</p>

<h2 id="the-status-quo">The status quo</h2>

<p>When starting the laptop without doing anything special, the default option
boots just fine, as expected. However, while pressing F2 during boot causes
a beep tone, it ends up falling through to the same behavior as if nothing
was pressed. On the other hand, pressing F12 lands us in a very empty
boot menu:</p>

<p><img src="https://blog.timschumi.net/images/ah532-bios-investigation/boot-menu-broken.png" alt="The broken boot menu"/>
<img src="https://blog.timschumi.net/images/ah532-bios-investigation/application-menu-broken.png" alt="The broken application menu"/></p>

<p>This, obviously, is not good. The boot menu should (at least) show all bootable
UEFI devices in addition to the boot entries that have been created manually.</p>



<p>Of course, the first thing that one would try is to reset the BIOS settings.
Since the CMOS battery is quite hidden behind plastic shielding, I instead
bridged the <code>CL1_CL2</code> test point that is located under the RAM slot.</p>

<p>After the BIOS reinitialized, the boot menu looks like the following:</p>

<p><img src="https://blog.timschumi.net/images/ah532-bios-investigation/boot-menu-partial.png" alt="The partially fixed boot menu"/>
<img src="https://blog.timschumi.net/images/ah532-bios-investigation/application-menu-partial.png" alt="The partially fixed application menu"/></p>

<p>The manually created boot option is now gone, and device-based boot options
show up instead. However, trying to enter the BIOS setup menu still shows the same
fallthrough behavior as it did before.</p>

<p>Luckily, there now is the option to boot from USB storage, so the BIOS
flash utilities <a href="https://support.ts.fujitsu.com">provided by Fujitsu</a>
are a possibility going forward. Note that (at least for the AH532)
there are multiple hardware revisions, so I had to go through the
device serial number to arrive at the correct set of downloads.</p>

<p>After flashing the BIOS and rebooting, the boot menu looks normal
and pressing F2 to enter the BIOS setup menu works like a charm:</p>

<p><img src="https://blog.timschumi.net/images/ah532-bios-investigation/boot-menu-complete.png" alt="The complete boot menu"/>
<img src="https://blog.timschumi.net/images/ah532-bios-investigation/application-menu-complete.png" alt="The complete application menu"/></p>

<h2 id="isolating-a-reproducer">Isolating a reproducer</h2>

<p>Now that I was back in a working setup, the first thing I did was to make
a backup of the current configuration. For that, I made an image of the
Winbond 25Q32BVSIG SPI flash chip that is marked as “U35” on the motherboard,
as it contains the whole UEFI PI firmware volume including executable code
and data storage. Whenever something is broken, I can now just flash back
the image instead of going through a full reset-CMOS-and-update-firmware cycle.</p>

<p><img src="https://blog.timschumi.net/images/ah532-bios-investigation/u35-location.png" alt="Location of the U35 chip on the motherboard"/></p>

<p>For easier testing, I also wanted a better reproducer than “reinstall your distribution of choice”.
Therefore, I tried the first thing that came to mind, and it immediately broke the boot menu again:</p>

<div><div><pre><code># efibootmgr -c
BootOrder: 0000
Boot0000* Linux
</code></pre></div></div>

<p><strong>Warning</strong>: Do <em>NOT</em> run this command twice. Doing so made the boot menu completely inaccessible.</p>

<h2 id="excursion-uefi-boot-entry-handling">Excursion: UEFI boot entry handling</h2>

<p>At a high level, UEFI stores data in a large key-value store that is collectively called
“UEFI variables”. Included in those variables are (among other things) boot entries and
related settings. Variable access is done through <a href="https://web.archive.org/web/20181025075625/wiki.phoenix.com/wiki/index.php/EFI_RUNTIME_SERVICES#GetNextVariableName.28.29">standardized interfaces</a>
that are documented in <a href="https://uefi.org/sites/default/files/resources/UEFI_Spec_2_10_Aug29.pdf">the UEFI specification</a>.</p>

<p>Boot entries are stored in entries named <code>BootXXXX</code>, where <code>XXXX</code> is a four digit hexadecimal
number. Boot option order is determined through the <code>BootOrder</code> entry, which lists all
four digit hexadecimal numbers in the order that they should appear in.</p>

<p>On my Framework laptop, the boot entries are set up as follows:</p>

<div><div><pre><code>BootOrder: 0002, 0001, 2001, 2002, 2003
Boot0001: &#34;Windows Boot Manager&#34;
Boot0002: &#34;GRUB&#34;
Boot2001: &#34;EFI USB Device&#34;
Boot2002: &#34;EFI DVD/CDROM&#34;
Boot2003: &#34;EFI Network&#34;
</code></pre></div></div>

<h2 id="putting-the-pieces-together">Putting the pieces together</h2>

<p>Suddenly, the <code>efibootmgr -c</code> output above doesn’t look all that confidence-inspiring.
The command is supposed to create a new entry and insert it at the top of the
boot entry list, but it ended up clearing the entire list instead. Running <code>efibootmgr</code>
on a fresh boot also doesn’t result in quite the expected output:</p>

<div><div><pre><code># efibootmgr -v
Could not read variable &#39;BootNext&#39;: No such file or directory
Could not read variable &#39;BootCurrent&#39;: No such file or directory
Could not read variable &#39;BootTimeout&#39;: No such file or directory
Could not read variable &#39;BootOrder&#39;: No such file or directory
No BootOrder is set; firmware will attempt recovery
Could not read variable &#39;MirrorCurrent&#39;: No such file or directory
Could not read variable &#39;MirrorRequest&#39;: No such file or directory
</code></pre></div></div>

<p>It appears that Linux is unable to read existing variables from storage, which is
immediately confirmed by inspecting the source of truth:</p>

<div><div><pre><code># ls -al /sys/firmware/efi/efivars/
total 0
drwxr-xr-x 2 root root 0 Jan 15 16:09 .
drwxr-xr-x 5 root root 0 Jan 15 16:09 ..
</code></pre></div></div>

<p><strong>Note</strong>: At this point, I checked that Windows and various other UEFI tools are
able to read the variables just fine, so Linux’ output is confirmed to be incorrect.</p>

<p>Now, this explains why the custom boot entries and the device-based boot entries
end up being gone. <code>efibootmgr</code> can’t find any existing boot entry setup and just
assumes that it can create a new setup without repercussions.</p>

<p>But why does it make the BIOS setup unusable? Using <a href="https://github.com/LongSoft/UEFITool">UEFITool</a>,
I inspected the flash image I made earlier, and reconstructed the following entries:</p>

<div><div><pre><code>BootOrder: 000E, 000D, 0006, 0007, 0008, 0009, 000A, 000B
Boot0000: &#34;BIOS Setup&#34;
Boot0001: &#34;Boot Menu&#34;
Boot0002: &#34;Diagnostic Screen&#34;
Boot0003: &#34;Recovery and Utility&#34;
Boot0004: &#34;Diagnostic Program&#34;
Boot0005: &#34;Diagnostic Progrogram ROM&#34;
Boot0006: &#34;Floppy Disk Drive&#34;
Boot0007: &#34;Drive0 HDD&#34;
Boot0008: &#34;CD/DVD Drive&#34;
Boot0009: &#34;NETWORK&#34;
Boot000A: &#34;USB HDD&#34;
Boot000B: &#34;USB CD/DVD&#34;
Boot000C: &#34;Erase Disk&#34;
Boot000D: &#34;Windows Boot Manager&#34;
Boot000E: &#34;proxmox&#34;
</code></pre></div></div>

<p><em>Oh, no…</em></p>

<p>“BIOS Setup” is an actual boot menu entry.</p>

<p>And it gets overwritten by the new boot entry that gets placed erroneously.</p>

<p><strong>Note</strong>: Attentive readers might have noticed the reason for why everything breaks
completely when running <code>efibootmgr -c</code> twice: The second boot entry that
is created would be <code>Boot0001</code>, which successfully replaces “Boot Menu”.</p>

<h2 id="creating-a-temporary-band-aid">Creating a temporary band-aid</h2>

<p>Now that I knew what went wrong, I was able to create a small program that resets
the boot order, as well as the BIOS setup and boot menu entries to their expected
contents.</p>

<p><strong>Note</strong>: This program is based on an UEFI dump of a Fujitsu LIFEBOOK AH532 (YLKV).
It is unlikely that it will work on any other hardware (revision) that happens to have
the same symptoms. Furthermore, the written data may also be dependent on the firmware
revision, so take caution when running this on a firmware version that is not v1.08 or
v1.09.</p>

<p><strong>Warning</strong>: I assume no liability for broken hardware or software due to correct or incorrect
usage of this tool.</p>

<div><div><pre><code><span>#include</span> <span>&lt;efivar/efivar.h&gt;</span><span>
</span>
<span>uint32_t</span> <span>boot_attributes</span> <span>=</span> <span>EFI_VARIABLE_NON_VOLATILE</span> <span>|</span> <span>EFI_VARIABLE_BOOTSERVICE_ACCESS</span> <span>|</span> <span>EFI_VARIABLE_RUNTIME_ACCESS</span><span>;</span>

<span>unsigned</span> <span>char</span> <span>bootorder_data</span><span>[]</span> <span>=</span> <span>{</span>
    <span>0x06</span><span>,</span> <span>0x00</span><span>,</span> <span>// Boot0006</span>
    <span>0x07</span><span>,</span> <span>0x00</span><span>,</span> <span>// Boot0007</span>
    <span>0x08</span><span>,</span> <span>0x00</span><span>,</span> <span>// Boot0008</span>
    <span>0x09</span><span>,</span> <span>0x00</span><span>,</span> <span>// Boot0009</span>
    <span>0x0A</span><span>,</span> <span>0x00</span><span>,</span> <span>// Boot000A</span>
    <span>0x0B</span><span>,</span> <span>0x00</span><span>,</span> <span>// Boot000B</span>
<span>};</span>

<span>unsigned</span> <span>char</span> <span>boot0000_data</span><span>[]</span> <span>=</span> <span>{</span>
    <span>0x00</span><span>,</span> <span>0x01</span><span>,</span> <span>0x00</span><span>,</span> <span>0x00</span><span>,</span> <span>// Attributes</span>
    <span>0x18</span><span>,</span> <span>0x00</span><span>,</span>             <span>// FilePathListLength</span>

    <span>// Description: &#34;BIOS Setup       &#34;</span>
    <span>0x42</span><span>,</span> <span>0x00</span><span>,</span> <span>0x49</span><span>,</span> <span>0x00</span><span>,</span> <span>0x4F</span><span>,</span> <span>0x00</span><span>,</span> <span>0x53</span><span>,</span> <span>0x00</span><span>,</span> <span>0x20</span><span>,</span> <span>0x00</span><span>,</span> <span>0x53</span><span>,</span> <span>0x00</span><span>,</span> <span>0x65</span><span>,</span> <span>0x00</span><span>,</span> <span>0x74</span><span>,</span> <span>0x00</span><span>,</span> <span>0x75</span><span>,</span> <span>0x00</span><span>,</span> <span>0x70</span><span>,</span> <span>0x00</span><span>,</span> <span>0x20</span><span>,</span> <span>0x00</span><span>,</span> <span>0x20</span><span>,</span> <span>0x00</span><span>,</span> <span>0x20</span><span>,</span> <span>0x00</span><span>,</span>
    <span>0x20</span><span>,</span> <span>0x00</span><span>,</span> <span>0x20</span><span>,</span> <span>0x00</span><span>,</span> <span>0x20</span><span>,</span> <span>0x00</span><span>,</span> <span>0x20</span><span>,</span> <span>0x00</span><span>,</span> <span>0x00</span><span>,</span> <span>0x00</span><span>,</span>

    <span>// FilePathList[0]</span>
    <span>0x04</span><span>,</span>       <span>// Type: Media Device Path</span>
    <span>0x06</span><span>,</span>       <span>// Sub-Type: PIWG Firmware File</span>
    <span>0x14</span><span>,</span> <span>0x00</span><span>,</span> <span>// Length: 4 + 0x14</span>
    <span>0x66</span><span>,</span> <span>0x8B</span><span>,</span> <span>0x1C</span><span>,</span> <span>0x72</span><span>,</span> <span>0x6C</span><span>,</span> <span>0x42</span><span>,</span> <span>0x86</span><span>,</span> <span>0x4E</span><span>,</span> <span>0x8E</span><span>,</span> <span>0x99</span><span>,</span> <span>0x34</span><span>,</span> <span>0x57</span><span>,</span> <span>0xC4</span><span>,</span> <span>0x6A</span><span>,</span> <span>0xB0</span><span>,</span> <span>0xB9</span><span>,</span>

    <span>// FilePathList[1]</span>
    <span>0x7F</span><span>,</span>       <span>// Type: End of Hardware Device Path</span>
    <span>0xFF</span><span>,</span>       <span>// Sub-Type: End Entire Device Path</span>
    <span>0x04</span><span>,</span> <span>0x00</span><span>,</span> <span>// Length: 4</span>

    <span>// OptionalData (empty)</span>
<span>};</span>

<span>unsigned</span> <span>char</span> <span>boot0001_data</span><span>[]</span> <span>=</span> <span>{</span>
    <span>0x00</span><span>,</span> <span>0x01</span><span>,</span> <span>0x00</span><span>,</span> <span>0x00</span><span>,</span> <span>// Attributes</span>
    <span>0x18</span><span>,</span> <span>0x00</span><span>,</span>             <span>// FilePathListLength</span>

    <span>// Description: &#34;Boot Menu&#34;</span>
    <span>0x42</span><span>,</span> <span>0x00</span><span>,</span> <span>0x6F</span><span>,</span> <span>0x00</span><span>,</span> <span>0x6F</span><span>,</span> <span>0x00</span><span>,</span> <span>0x74</span><span>,</span> <span>0x00</span><span>,</span> <span>0x20</span><span>,</span> <span>0x00</span><span>,</span> <span>0x4D</span><span>,</span> <span>0x00</span><span>,</span> <span>0x65</span><span>,</span> <span>0x00</span><span>,</span> <span>0x6E</span><span>,</span> <span>0x00</span><span>,</span> <span>0x75</span><span>,</span> <span>0x00</span><span>,</span> <span>0x00</span><span>,</span> <span>0x00</span><span>,</span>

    <span>// FilePathList[0]</span>
    <span>0x04</span><span>,</span>       <span>// Type: Media Device Path</span>
    <span>0x06</span><span>,</span>       <span>// Sub-Type: PIWG Firmware File</span>
    <span>0x14</span><span>,</span> <span>0x00</span><span>,</span> <span>// Length: 4 + 0x14</span>
    <span>0x40</span><span>,</span> <span>0x84</span><span>,</span> <span>0x48</span><span>,</span> <span>0x86</span><span>,</span> <span>0xBB</span><span>,</span> <span>0x41</span><span>,</span> <span>0xC7</span><span>,</span> <span>0x42</span><span>,</span> <span>0x93</span><span>,</span> <span>0xAC</span><span>,</span> <span>0x45</span><span>,</span> <span>0x0F</span><span>,</span> <span>0xBF</span><span>,</span> <span>0x77</span><span>,</span> <span>0x66</span><span>,</span> <span>0xBF</span><span>,</span>

    <span>// FilePathList[1]</span>
    <span>0x7F</span><span>,</span>       <span>// Type: End of Hardware Device Path</span>
    <span>0xFF</span><span>,</span>       <span>// Sub-Type: End Entire Device Path</span>
    <span>0x04</span><span>,</span> <span>0x00</span><span>,</span> <span>// Length: 4</span>

    <span>// OptionalData (empty)</span>
<span>};</span>

<span>int</span> <span>main</span><span>()</span> <span>{</span>
    <span>int</span> <span>rc</span> <span>=</span> <span>efi_set_variable</span><span>(</span><span>EFI_GLOBAL_GUID</span><span>,</span> <span>&#34;BootOrder&#34;</span><span>,</span> <span>bootorder_data</span><span>,</span> <span>sizeof</span><span>(</span><span>bootorder_data</span><span>),</span> <span>boot_attributes</span><span>,</span> <span>0644</span><span>);</span>
    <span>if</span> <span>(</span><span>rc</span> <span>&lt;</span> <span>0</span><span>)</span> <span>{</span>
        <span>efi_error</span><span>(</span><span>&#34;Resetting BootOrder failed&#34;</span><span>);</span>
        <span>return</span> <span>1</span><span>;</span>
    <span>}</span>

    <span>rc</span> <span>=</span> <span>efi_set_variable</span><span>(</span><span>EFI_GLOBAL_GUID</span><span>,</span> <span>&#34;Boot0000&#34;</span><span>,</span> <span>boot0000_data</span><span>,</span> <span>sizeof</span><span>(</span><span>boot0000_data</span><span>),</span> <span>boot_attributes</span><span>,</span> <span>0644</span><span>);</span>
    <span>if</span> <span>(</span><span>rc</span> <span>&lt;</span> <span>0</span><span>)</span> <span>{</span>
        <span>efi_error</span><span>(</span><span>&#34;Resetting Boot0000 failed&#34;</span><span>);</span>
        <span>return</span> <span>1</span><span>;</span>
    <span>}</span>

    <span>rc</span> <span>=</span> <span>efi_set_variable</span><span>(</span><span>EFI_GLOBAL_GUID</span><span>,</span> <span>&#34;Boot0001&#34;</span><span>,</span> <span>boot0001_data</span><span>,</span> <span>sizeof</span><span>(</span><span>boot0001_data</span><span>),</span> <span>boot_attributes</span><span>,</span> <span>0644</span><span>);</span>
    <span>if</span> <span>(</span><span>rc</span> <span>&lt;</span> <span>0</span><span>)</span> <span>{</span>
        <span>efi_error</span><span>(</span><span>&#34;Resetting Boot0001 failed&#34;</span><span>);</span>
        <span>return</span> <span>1</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre></div></div>

<p>Naturally, this isn’t a great solution, since users will continue to brick their installations initially, just like they
did <a href="https://bugs.launchpad.net/ubuntu/+source/efibootmgr/+bug/1082418">for the last 10 years</a>. However, this is everything
that I managed to research so far, and the band-aid fix makes it reasonable for publication.</p>

<p>I will look into fixing this properly at some point in the future, and if I manage to do so this post will probably get a part
two, so stay tuned. (Apparently Jekyll supports RSS?)</p>

  </div>
</article>

      </div>
    </div></div>
  </body>
</html>
