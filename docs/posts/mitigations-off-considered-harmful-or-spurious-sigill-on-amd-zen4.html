<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://forum.level1techs.com/t/mitigations-off-considered-harmful-or-spurious-sigill-on-amd-zen4/202049">Original</a>
    <h1>Mitigations=off considered harmful or spurious SIGILL on AMD Zen4</h1>
    
    <div id="readability-page-1" class="page"><div id="main-outlet" role="main">
        

  


      <div id="post_1" itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          


          <p><span>
              <time itemprop="datePublished" datetime="2023-10-02T22:05:57Z">
                October 2, 2023, 10:05pm
              </time>
              <meta itemprop="dateModified" content="2023-10-02T22:07:55Z"/>
          <span itemprop="position">#1</span>
          </span>
        </p></div>
        <p>Hunting spurious illegal instructions where there were none on AMD Ryzen 7950x for months compiling OpenSource packages with GCC (for <a href="https://t2sde.org" rel="noopener nofollow ugc">https://t2sde.org</a>), I finally found this regular user-land code causing some pseudo random speculative execution state corruption on Zen 4! The good news: actually running with mitigations=on (I had it =off for performance) or disabling SMT works around it for now. <a href="https://www.youtube.com/watch?v=1UnoBfw6soI" rel="noopener nofollow ugc">https://www.youtube.com/watch?v=1UnoBfw6soI</a> I guess one of the first documented cases of regular user programs causing speculative execution marginalities! So much for running with mitigations=off for performance even with your “own” trusted code, … not anymore. I’ll continue to further reduce the test case and hope to eventually reach AMD and linux-kernel to further find the root cause of this, … :-/</p>

        <meta itemprop="headline" content="Mitigations=off considered harmful or spurious SIGILL on AMD Zen4"/>
          <meta itemprop="keywords" content="kernel"/>

        

         

      </div>
      <div id="post_2" itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        
        <div itemprop="articleBody">
          <p>Wow, that is crazy. I wonder how many others have run into similar issues and did not attribute it to Speculative Execution bugs.</p>
<p><a href="https://forum.level1techs.com/u/rener">@rener</a> Is there a significant hit in performance between mitigations on and mitigations off? I am still running the heavy machinery architecture on my desktop. My laptop is Zen3.5 (6800U) but I have to run MS Windows for school and I have not been able to get T2 or any GNU/Linux to run properly on the laptop just yet (I think TPM 2.0 issues). BSD seems to work fine, if not slow on  the laptop though. haha.</p>
        </div>

        <meta itemprop="headline" content="Mitigations=off considered harmful or spurious SIGILL on AMD Zen4"/>

        

         

      </div>
      <div id="post_3" itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://forum.level1techs.com/u/rener"><span itemprop="name">rener</span></a>
            
          </span></p>


          <p><span>
              <time itemprop="datePublished" datetime="2023-10-03T10:21:49Z">
                October 3, 2023, 10:21am
              </time>
              <meta itemprop="dateModified" content="2023-10-03T10:21:49Z"/>
          <span itemprop="position">#3</span>
          </span>
        </p></div>
        <p>thankfully currently on Zen4 the performance impact for my usecase with mitigations=on is barely meassurable. For Zen3 and Zen2 it was quite some % in the meantime with years of mitigations. A kernel dev commented in the meantime it could also be generic TLB bugs in the linux kernel. So the research will continue, …</p>

        <meta itemprop="headline" content="Mitigations=off considered harmful or spurious SIGILL on AMD Zen4"/>

        

         

      </div>
      <div id="post_4" itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        
        <p>I will give it a try on my Ryzen 7 6800U and my FX-6300 and see what happens.</p>

        <meta itemprop="headline" content="Mitigations=off considered harmful or spurious SIGILL on AMD Zen4"/>

        

         

      </div>
      <div id="post_5" itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        
        <div itemprop="articleBody">
          <p>It’s probably not a speculation problem at all but a correctness problem in AMD’s CPU cores. A similar problem was recently found in zen2. (zenbleed)</p>
<p>It stems from the CPU core logic being fundamentally unsound and causing corruption of the CPU’s internal state. Speculation just introduces a ton of added complexity which exposes the bug. Pile on memory barriers and it masks the corruption.</p>
<p>Guy found it through fuzzing, where he ran the same code with and without a ton of memory barriers before and after each instruction. Any time the results were different, it meant CPU state had been corrupted.</p>
<p>I’d report this to AMD immediately.</p>
        </div>

        <meta itemprop="headline" content="Mitigations=off considered harmful or spurious SIGILL on AMD Zen4"/>

        

         

      </div>






    </div></div>
  </body>
</html>
