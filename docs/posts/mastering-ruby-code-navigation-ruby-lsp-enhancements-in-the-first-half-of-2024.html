<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://railsatscale.com/2024-07-18-mastering-ruby-code-navigation-major-enhancements-in-ruby-lsp-2024/">Original</a>
    <h1>Mastering Ruby Code Navigation: Ruby LSP Enhancements in the First Half of 2024</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p>In the first half of 2024, <a href="https://github.com/Shopify/ruby-lsp">Ruby LSP</a> has seen significant enhancements, particularly in the area of code navigation, thanks to the advancement of its indexer.</p>

<p>In this post, we’ll dive into the major code navigation enhancements that have been made to Ruby LSP. We’ll also touch on some experimental features that are on the horizon.</p>

<blockquote>
  <p><strong>NOTE</strong></p>

  <p>While the Ruby LSP server (<code>ruby-lsp</code> gem) can be integrated with <a href="https://github.com/Shopify/ruby-lsp/blob/main/EDITORS.md">many editors</a>, all the features in this article will be demoed in VS Code with the <a href="https://marketplace.visualstudio.com/items?itemName=Shopify.ruby-lsp"><code>Ruby LSP</code> extension</a> on a macOS machine.</p>

  <p>Therefore, some of the features may not work the same way in non-VS Code editors, or may require different keyboard shortcuts depending on your development environment.</p>
</blockquote>

<h2 id="table-of-contents">Table of Contents</h2>

<ul>
  <li><a href="#code-navigation-with-ruby-lsp">Code Navigation With Ruby LSP</a>
    <ul>
      <li><a href="#hover">Hover</a></li>
      <li><a href="#go-to-definition">Go-to-Definition</a></li>
      <li><a href="#completion">Completion</a></li>
      <li><a href="#signature-help">Signature Help</a></li>
    </ul>
  </li>
  <li><a href="#code-navigation-enhancements">Code Navigation Enhancements</a>
    <ul>
      <li><a href="#singleton-methods">Singleton Methods</a></li>
      <li><a href="#local-variables">Local Variables</a></li>
      <li><a href="#inheritance-and-mixins">Inheritance and Mixins</a></li>
      <li><a href="#ruby-core-classes-modules-and-methods">Ruby Core Classes, Modules, and Methods</a></li>
    </ul>
  </li>
  <li><a href="#code-navigation-enhancements-for-the-rails-addon">Code Navigation Enhancements for the Rails Addon</a>
    <ul>
      <li><a href="#go-to-definition-for-activerecord-model-callbacks-and-associations">Go-to-Definition for ActiveRecord Model Callbacks and Associations</a></li>
      <li><a href="#navigation-to-routes-and-views">Navigation to Routes and Views</a></li>
      <li><a href="#code-navigation-in-erb-files">Code Navigation in <code>.erb</code> Files</a></li>
    </ul>
  </li>
  <li><a href="#experimental-features">Experimental Features</a>
    <ul>
      <li><a href="#ancestors-hierarchy-request">Ancestors Hierarchy Request</a></li>
      <li><a href="#guessed-types">Guessed Types</a></li>
    </ul>
  </li>
  <li><a href="#recap">Recap</a></li>
</ul>

<h2 id="code-navigation-with-ruby-lsp">Code Navigation With Ruby LSP</h2>

<p>Since this post focuses heavily on code navigation features in editors, let’s dive into these features in more detail.</p>

<p>Code navigation generally refers to four key editor features: hover, go-to-definition, completion, and signature help. When paired with language servers, these features can dramatically improve developer productivity.</p>

<h3 id="hover">Hover</h3>

<p>The hover feature displays comments or documentation for the target constant or method when the cursor hovers over them.</p>

<p>In VS Code, if you hover while pressing <code>Command</code>, it will also send a <code>definition</code> request to locate the possible target sources. And it will display the target’s source code if only one source is located (e.g., the class is not reopened in multiple places).</p>

<video src="images/ruby-lsp-hover-demo-basic.mp4" width="100%" controls="">
Sorry, your browser doesn&#39;t support embedded videos. This video demonstrates the hover feature, showing how comments and documentation are displayed for the target constant or method.
</video>

<h3 id="go-to-definition">Go-to-Definition</h3>

<p>Go-to-definition allows users to navigate to the target constant or method’s definition,
whether they’re defined in your project or its dependencies.</p>

<p>This feature can be triggered by one of the following methods:</p>

<ul>
  <li><code>Right click</code> on the target, and then select <code>Go to Definition</code></li>
  <li>Placing the cursor on the target, and then hit <code>F12</code></li>
  <li><code>Command + click</code> the target</li>
</ul>

<p><strong>With One Definition:</strong></p>

<p>Users are taken directly to the source.</p>

<video src="images/ruby-lsp-definition-demo-basic.mp4" width="100%" controls="">
Sorry, your browser doesn&#39;t support embedded videos. This video shows the go-to-definition feature in action, navigating directly to the source of the target constant or method.
</video>

<p><strong>With Multiple Definitions:</strong></p>

<p>Users see a dropdown with all the sources, along with a preview window on the side.</p>

<video src="images/ruby-lsp-definition-demo-multi-source.mp4" width="100%" controls="">
Sorry, your browser doesn&#39;t support embedded videos. This video demonstrates the go-to-definition feature when multiple definitions are found, showing the dropdown and preview window.
</video>

<h3 id="completion">Completion</h3>

<p>The completion feature provides users with completion candidates when the text they type matches certain indexed components. This helps speed up coding by reducing the need to type out full method names or constants.
It also allows developers to discover constants or methods that are available to them.</p>

<video src="images/ruby-lsp-completion-demo-basic.mp4" width="100%" controls="">
Sorry, your browser doesn&#39;t support embedded videos. This video illustrates the completion feature, providing completion candidates as the user types.
</video>

<h3 id="signature-help">Signature Help</h3>

<p>Signature help often appears right after users finish typing a method, providing hints about the method’s parameters. This feature is invaluable for understanding the expected arguments and improving code accuracy.</p>

<video src="images/ruby-lsp-signature-help-demo-basic.mp4" width="100%" controls="">
Sorry, your browser doesn&#39;t support embedded videos. This video demonstrates the signature help feature, showing hints about the parameters the target method takes.
</video>

<h2 id="code-navigation-enhancements">Code Navigation Enhancements</h2>

<p>Let’s take a closer look at the improvements that have been made to these features.</p>

<h3 id="singleton-methods">Singleton Methods</h3>

<p>All code navigation features for singleton methods have been significantly improved.</p>

<video src="images/ruby-lsp-singleton-demo.mp4" width="100%" controls="">
Sorry, your browser doesn&#39;t support embedded videos. This video shows the improved code navigation features for singleton methods.
</video>

<h3 id="local-variables">Local Variables</h3>

<p>Ruby LSP now offers <strong>completion</strong> support for local variables. This improvement helps developers understand the scope and usage of variables within their code, reducing the likelihood of errors and improving code readability.</p>

<h3 id="inheritance-and-mixins">Inheritance and Mixins</h3>

<p>Ruby LSP’s indexer is now capable of estimating the inheritance hierarchy of your program, allowing it to locate method, variable, and constant definitions through the ancestors list. This includes superclasses and mixins (<code>prepend</code>, <code>include</code>, and <code>extend</code>).</p>

<p>The reason this is considered an estimation is due to Ruby’s <code>autoload</code> feature making it difficult to determine the exact order in which files end up being required (which may impact how the inheritance chain is constructed).</p>

<p>This advancement has enabled several new enhancements that were previously difficult to achieve:</p>

<ul>
  <li><strong>Singleton Methods:</strong> All code navigation support for singleton methods now works on inherited singleton methods too.</li>
  <li><strong>Super:</strong> Added <strong>hover</strong> and <strong>go-to-definition</strong> support for the <code>super</code> keyword, allowing developers to easily trace the method call chain.</li>
  <li><strong>Methods Defined Through Superclasses and Mixins:</strong> All code navigation features now support methods defined in superclasses and mixins, making it easier to understand the inheritance structure.</li>
  <li><strong>Instance and Class Instance Variables:</strong> Added <strong>hover</strong>, <strong>go-to-definition</strong>, and <strong>completion</strong> support for instance variables and class instance variables, including inherited variables.</li>
</ul>

<p>This video demonstrates some of these enhancements:</p>

<video src="images/ruby-lsp-code-navigation-with-inheritance-demo.mp4" width="100%" controls="">
Sorry, your browser doesn&#39;t support embedded videos. This video demonstrates the enhancements in code navigation for inheritance and mixins.
</video>

<p><strong>Limitations:</strong></p>

<ul>
  <li>Ruby LSP indexes the user’s entire codebase and dependencies by default, but it doesn’t know which files will eventually be required in your application. In some rare cases, class, module, or method definitions may show up in the <strong>go-to-definition</strong> or <strong>completion</strong> results, but may not be used by your application during runtime.</li>
  <li>While the navigation improvements are substantial, there are still some limitations, such as runtime mixin operations, or mixins added through <code>instance_eval</code>, <code>module_eval</code>, and <code>class_eval</code>. For certain cases, like Rails Concerns, the plan is to support them through addons.</li>
</ul>

<h3 id="ruby-core-classes-modules-and-methods">Ruby Core Classes, Modules, and Methods</h3>

<p>Ruby LSP now offers various code navigation features for Ruby core classes and modules, such as <code>String</code> and <code>Enumerable</code>, as well as methods:</p>

<ul>
  <li><strong>Hover</strong> displays documentation.</li>
  <li><strong>Go-to-definition</strong> leads users to the respective RBS declarations.</li>
  <li><strong>Completion</strong> provides them as completion candidates.</li>
  <li><strong>Signature help</strong> provides signature information when invoking methods.</li>
</ul>

<p><strong>Limitation:</strong></p>

<p>While Ruby LSP can provide documentation for literal class constants, like <code>String</code> or <code>Array</code>, it still cannot provide documentation for their literals, like <code>&#34;str&#34;</code> or <code>[1, 2, 3]</code>.</p>

<p>We’re building a type inferrer to enable such functionality and support on literals should come soon.
So stay tuned!</p>

<h2 id="code-navigation-enhancements-for-the-rails-addon">Code Navigation Enhancements for the Rails Addon</h2>

<p>The Rails addon has also seen significant improvements in the area of code navigation.</p>

<p>The table below summarizes the available navigation features and the components they connect:</p>

<table>
  <thead>
    <tr>
      <th>Navigation Feature</th>
      <th>From</th>
      <th>To</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Go-to-definition</td>
      <td>Model</td>
      <td>Model</td>
      <td>Navigate to another model through associations.</td>
    </tr>
    <tr>
      <td>CodeLens</td>
      <td>Controller</td>
      <td>View</td>
      <td>Jump to relevant views on action methods.</td>
    </tr>
    <tr>
      <td>Go-to-definition</td>
      <td>Controller</td>
      <td>Route</td>
      <td>Navigate to relevant routes through route helpers.</td>
    </tr>
    <tr>
      <td>CodeLens</td>
      <td>Controller</td>
      <td>Route</td>
      <td>Navigate to relevant route definitions on action methods.</td>
    </tr>
    <tr>
      <td>Go-to-definition</td>
      <td>Controller</td>
      <td>Model</td>
      <td>Navigate to relevant models through constants.</td>
    </tr>
    <tr>
      <td>Go-to-definition</td>
      <td>View</td>
      <td>Model</td>
      <td>Navigate to relevant models through constants.</td>
    </tr>
    <tr>
      <td>Go-to-definition</td>
      <td>View</td>
      <td>Route</td>
      <td>Navigate to relevant routes through route helpers.</td>
    </tr>
  </tbody>
</table>

<p>(Note: CodeLens are clickable items that can be surfaced on top of code in the editor.
It’s not a code-navigation-specific feature, but in the Rails addon we use it to trigger jumping actions in controllers.)</p>

<p><img src="https://railsatscale.com/2024-07-18-mastering-ruby-code-navigation-major-enhancements-in-ruby-lsp-2024/images/code-lens.png" alt="example screenshot of codelens"/></p>

<p>Now let’s dive into the specific improvements.</p>

<h3 id="go-to-definition-for-activerecord-model-callbacks-and-associations">Go-to-Definition for ActiveRecord Model Callbacks and Associations</h3>

<p>Developers can now navigate to the definitions of ActiveRecord callbacks and between associated models.</p>

<video src="images/ruby-lsp-rails-ar-definitions-demo.mp4" width="100%" controls="">
Sorry, your browser doesn&#39;t support embedded videos. This video shows the go-to-definition feature for ActiveRecord model callbacks and associations.
</video>

<h3 id="navigation-to-routes-and-views">Navigation to Routes and Views</h3>

<p>The Rails addon now provides two new ways of navigating between controllers, route definitions, and views:</p>

<ul>
  <li><strong>Go-to-definition</strong> for route helper definitions.</li>
  <li><strong>CodeLens</strong> for route definitions and view files.</li>
</ul>

<video src="images/ruby-lsp-rails-route-and-view-navigation-demo.mp4" width="100%" controls="">
Sorry, your browser doesn&#39;t support embedded videos. This video demonstrates the navigation features for routes and views, including go-to-definition and CodeLens.
</video>

<h3 id="code-navigation-in-erb-files">Code Navigation in <code>.erb</code> Files</h3>

<p>Ruby LSP now adds code navigation support to <code>.erb</code> files, allowing users to access all code navigation
 features in those files as well.</p>

<video src="images/ruby-lsp-rails-erb-support-demo.mp4" width="100%" controls="">
Sorry, your browser doesn&#39;t support embedded videos. This video illustrates the code navigation support in `.erb` files, showing the go-to-definition and hover features.
</video>

<p>(Technically, this is not a Rails-exclusive enhancement, but because it enables all the previously mentioned
code navigation features in view files, it brings a dramatic improvement to the Rails development experience.)</p>

<h2 id="experimental-features">Experimental Features</h2>

<p>The Ruby LSP team is constantly working on new features to enhance the development experience. Here are a couple of experimental features that are currently in the works:</p>

<h3 id="ancestors-hierarchy-request">Ancestors Hierarchy Request</h3>

<p>The ancestors hierarchy request feature aims to provide a better understanding of the inheritance hierarchy within your Ruby code. This feature helps developers trace the lineage of their classes and modules, making it easier to:</p>

<ul>
  <li>Visualize the inheritance hierarchy of classes and modules.</li>
  <li>Quickly navigate through the inheritance chain.</li>
</ul>

<video src="images/ruby-lsp-type-hierarchy-demo.mp4" width="100%" controls="">
Sorry, your browser doesn&#39;t support embedded videos. This video demonstrates the ancestors hierarchy request feature, visualizing the inheritance hierarchy.
</video>

<h4 id="why-is-it-experimental">Why Is It Experimental?</h4>

<p>This feature is supported by the <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#typeHierarchy_supertypes">Type Hierarchy Supertypes LSP request</a>. During implementation, we encountered some ambiguities when applying it to Ruby. For example:</p>

<ul>
  <li>Should the list include only classes (pure inheritance chain), or should it include modules too (current behavior)?</li>
  <li>How should the inheritance chain of singleton classes be triggered and displayed?</li>
  <li>If a class or module is reopened multiple times, it will appear multiple times in the list. In real-world applications, this can make the list very long.</li>
</ul>

<p>We created <a href="https://github.com/microsoft/language-server-protocol/issues/1984">an issue</a> to seek clarification from the LSP maintainers. We will adjust this feature’s design and behavior based on their response and your feedback.</p>

<h3 id="guessed-types">Guessed Types</h3>

<p>The guessed types feature is an experimental addition to Ruby LSP that attempts to identify the type of a receiver based on its identifier name. This helps improve code completion and navigation by providing type information.</p>

<p>This feature is disabled by default but can be enabled with the <code>rubyLsp.enableExperimentalFeatures</code> setting in VS Code.</p>

<h4 id="how-it-works">How It Works</h4>

<p>Ruby LSP guesses the type of a variable by matching its identifier name to a class. For example, a variable named <code>user</code> would be assigned the <code>User</code> type if such a class exists:</p>

<div><div><pre><code><span>user</span><span>.</span><span>name</span>  <span># Guessed to be of type `User`</span>
<span>@post</span><span>.</span><span>like!</span>  <span># Guessed to be of type `Post`</span>
</code></pre></div></div>

<p>By guessing the types of variables, Ruby LSP can expand the code navigation features to even more cases.</p>

<h4 id="important-notes">Important Notes</h4>

<ul>
  <li>Identifiers are not ideal for complex type annotations and can be easily misled by non-matching names.</li>
  <li>We do NOT recommend renaming identifiers just to make this feature work.</li>
</ul>

<p>For more information, please refer to the <a href="https://github.com/Shopify/ruby-lsp/blob/main/DESIGN_AND_ROADMAP.md#guessed-types">documentation</a>.</p>

<h2 id="recap">Recap</h2>

<p>The first half of 2024 has brought significant improvements to Ruby LSP, particularly in the area of code navigation.
From enhanced support for singleton methods, local variables, and inheritance, to ERB support, Ruby LSP is evolving to make Ruby developers’ lives easier.
The Rails addon has also seen major enhancements, simplifying navigation between models, views, and controllers.
With experimental features like the ancestors hierarchy request and guess type, Ruby LSP continues to adopt new LSP features and explore creative approaches.</p>

<p>While Ruby LSP project is primarily driven by the Ruby Developer Experience team at Shopify, our aim is to continue running it as a collaborative open-source project serving the Ruby community overall. For that reason, we’d like to thank all the contributors who have reported issues, provided feedback, or contributed code to Ruby LSP and its Rails addon. For contributions from outside Shopify, we would like to give a special shoutout to <a href="https://github.com/snutij">@snutij</a> and <a href="https://github.com/Earlopain">@Earlopain</a> for their continuous contributions to the project.</p>

<p>Please give these new features a try, and share your feedback via <a href="https://github.com/Shopify/ruby-lsp/issues">GitHub issues</a> or the <a href="https://join.slack.com/t/ruby-dx/shared_invite/zt-2c8zjlir6-uUDJl8oIwcen_FS_aA~b6Q">Ruby DX Slack</a>.</p>

  </div>
</article>

      </div>
    </div></div>
  </body>
</html>
