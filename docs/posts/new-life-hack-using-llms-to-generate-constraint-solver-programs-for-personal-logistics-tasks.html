<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://emschwartz.me/new-life-hack-using-llms-to-generate-constraint-solver-programs-for-personal-logistics-tasks/">Original</a>
    <h1>New Life Hack: Using LLMs to Generate Constraint Solver Programs for Personal Logistics Tasks</h1>
    
    <div id="readability-page-1" class="page"><div>
    

    
        
    

    
        

        <p>
            <i>
                <time datetime="2025-05-16T18:34Z">
                    May 16, 2025
                </time>
            </i>
        </p>
    

    <p>I enjoy doing escape rooms and was planning to do a couple of them with a group of friends this weekend. The very minor and not-very-important challenge, however, was that I couldn&#39;t figure out how to assign friends to rooms. I want to do at least one room with each person, different people are arriving and leaving at different times, and there are only so many time slots. Both Claude 3.7 Sonnet and ChatGPT o3 tried and failed to figure out a workable solution given my constraints. However, after asking the LLMs to generate a constraint solver program and massaging the constraints a bit, I was able to find a solution.</p>
<p>TL;DR: If you need help juggling between a bunch of constraints for some personal logistical task, try asking an LLM to translate your requirements into a constraint solver program. You&#39;ll quickly find if there exists a solution and, if not, you can edit the constraints to find the best approach.</p>
<h2 id="background">Background</h2><p>The escape room location we&#39;re going to is <a href="https://puzzleconnect.com/">PuzzleConnect</a> in New Jersey. They have 3 rooms that are all Overwhelmingly Positively rated on <a href="https://morty.app/location/puzzleconnect-escape-rooms/holmdel">Morty</a>, which practically guarantees that they&#39;re going to be good.</p>
<blockquote>
<p>Side note on Morty: Escape rooms as a category are fun but very hit-or-miss. Knowing which rooms are going to be great and which aren&#39;t is a game changer because you can skip the duds. <a href="https://morty.app">Morty</a> is an app specifically for reviewing escape rooms, and it shows you how many rooms each reviewer has played. If someone who has gone out of their way to play 100+ escape rooms says a room is great, you can probably take their word for it. If you happen to be in the Netherlands, Belgium, or Luxembourg, <a href="https://escapetalk.nl/">EscapeTalk.nl</a> is also fantastic.</p>
</blockquote>
<blockquote>
<p>Side side note: I&#39;m not affiliated with Morty or EscapeTalk in any way. I just appreciate what they do.</p>
</blockquote>
<h2 id="constraints">Constraints</h2><ul>
<li>We have 8 players. I&#39;ll just identify them as A, B, D, E, J, P, S, and T. Unsurprisingly, I&#39;m E.</li>
<li>The three escape rooms are Candy, Christmas, and Temple themed.</li>
<li>Originally, we had 7 time slots (2, 2, and 3) to work with. PuzzleConnect, however, was flexible and let us add a few more.</li>
<li>5 players are arriving at 11am, 3 could only arrive after 12pm. 2 players need to leave by 3:30pm.</li>
<li>I want to play at least one room with each person.</li>
<li>Every room can technically take 2-5+ people, but it&#39;s more fun if you limit it to 2-3.</li>
<li>Each room takes roughly 1 hour and no player can be in more than one room at a time.</li>
<li>Most players wanted to play all 3 rooms, but a couple were flexible or preferred playing 2.</li>
</ul>
<p>As you can see, these are a fair number of constraints to juggle. I started with pen and paper, then a spreadsheet, but quickly gave up and asked the LLMs.</p>
<h2 id="constraint-solvers">Constraint Solvers</h2><p>Constraint solvers are programs in which you declaratively express constraints on the solution and the solver effectively tries to explore all possible states to find a valid solution. In practice, they use lots of clever methods and heuristics to efficiently explore the state space.</p>
<p>Unlike with imperative programming where you specify the steps for the program to take, under this paradigm you are just describing a valid final state. In addition to specifying hard constraints, you can also provide soft constraints that the solver will attempt to maximize.</p>
<p>I would not have thought to ask the LLMs to build a constraint solver program for me if not for Carolyn Zech&#39;s talk at this week&#39;s Rust NYC meetup about verifying the Rust standard library (see the <a href="https://www.linkedin.com/pulse/cmu-students-push-rust-stdlib-verification-rahul-kumar-qlwrc/">announcement</a> and the <a href="https://github.com/model-checking/verify-rust-std/">project on Github</a>).</p>
<h2 id="escaping-the-escape-room-assignment-puzzle">Escaping the Escape Room Assignment Puzzle</h2><p>I have no experience writing programs for constraint solvers, but I was able to describe all of my constraints and ChatGPT was perfectly capable of translating those requirements into code.</p>
<p>In this case, we used Google&#39;s <a href="https://developers.google.com/optimization/">OR-Tools</a> python package.</p>
<p>The first version was impossible to satisfy, but it worked once I added and moved around some time slots. After finding a workable solution, I think it&#39;s interesting to note how hard and soft constraints are expressed.</p>
<p>For example, each player can only play each room once:</p>
<div><pre><span></span><span># ---------------------------------------------------------------------------</span>
<span># 2.2  One session per theme for each player (no repeats)</span>
<span># ---------------------------------------------------------------------------</span>
<span>for</span> <span>p</span> <span>in</span> <span>players</span><span>:</span>
    <span>for</span> <span>theme</span> <span>in</span> <span>{</span><span>s</span><span>[</span><span>1</span><span>]</span> <span>for</span> <span>s</span> <span>in</span> <span>sessions</span><span>}:</span>
        <span>same_theme</span> <span>=</span> <span>[</span><span>i</span> <span>for</span> <span>i</span><span>,</span> <span>s</span> <span>in</span> <span>enumerate</span><span>(</span><span>sessions</span><span>)</span> <span>if</span> <span>s</span><span>[</span><span>1</span><span>]</span> <span>==</span> <span>theme</span><span>]</span>
        <span>if</span> <span>len</span><span>(</span><span>same_theme</span><span>)</span> <span>&gt;</span> <span>1</span><span>:</span>
            <span>model</span><span>.</span><span>Add</span><span>(</span><span>sum</span><span>(</span><span>x</span><span>[</span><span>p</span><span>][</span><span>i</span><span>]</span> <span>for</span> <span>i</span> <span>in</span> <span>same_theme</span><span>)</span> <span>&lt;=</span> <span>1</span><span>)</span>
</pre></div>
<p>Or, my desire to play at least one room with each person expressed as a soft constraint looks like this:</p>
<div><pre><span></span><span># Nice 3 â€“ E plays with everyone at least once</span>
<span>if</span> <span>NICE_E_WITH_ALL</span><span>:</span>
    <span>for</span> <span>q</span> <span>in</span> <span>players</span><span>:</span>
        <span>if</span> <span>q</span> <span>==</span> <span>&#34;E&#34;</span><span>:</span>
            <span>continue</span>
        <span>together</span> <span>=</span> <span>[]</span>
        <span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>num_sessions</span><span>):</span>
            <span>both</span> <span>=</span> <span>model</span><span>.</span><span>NewBoolVar</span><span>(</span><span>f</span><span>&#34;E_</span><span>{</span><span>q</span><span>}</span><span>_</span><span>{</span><span>i</span><span>}</span><span>&#34;</span><span>)</span>
            <span>model</span><span>.</span><span>Add</span><span>(</span><span>both</span> <span>&lt;=</span> <span>x</span><span>[</span><span>&#34;E&#34;</span><span>][</span><span>i</span><span>])</span>
            <span>model</span><span>.</span><span>Add</span><span>(</span><span>both</span> <span>&lt;=</span> <span>x</span><span>[</span><span>q</span><span>][</span><span>i</span><span>])</span>
            <span>model</span><span>.</span><span>Add</span><span>(</span><span>both</span> <span>&gt;=</span> <span>x</span><span>[</span><span>&#34;E&#34;</span><span>][</span><span>i</span><span>]</span> <span>+</span> <span>x</span><span>[</span><span>q</span><span>][</span><span>i</span><span>]</span> <span>-</span> <span>1</span><span>)</span>
            <span>together</span><span>.</span><span>append</span><span>(</span><span>both</span><span>)</span>
        <span>meet_flag</span> <span>=</span> <span>model</span><span>.</span><span>NewBoolVar</span><span>(</span><span>f</span><span>&#34;E_with_</span><span>{</span><span>q</span><span>}</span><span>&#34;</span><span>)</span>
        <span>model</span><span>.</span><span>AddMaxEquality</span><span>(</span><span>meet_flag</span><span>,</span> <span>together</span><span>)</span>
        <span>obj_terms</span><span>.</span><span>append</span><span>(</span><span>meet_flag</span><span>)</span>
</pre></div>
<p>You can find the full code below.</p>
<h2 id="conclusion">Conclusion</h2><p>I&#39;m not a big fan of balancing logistical tasks and constraints, but I do like finding optimal solutions. Getting an LLM to generate a constraint solver program for me to find optimal or feasible solutions is a nice new life hack that I&#39;m sure I&#39;ll be using again.</p>
<p>ChatGPT can run Python code that it generates for you, but <code>ortools</code> isn&#39;t available as an import (for now!). It would be neat if OpenAI or Anthropic added it as a dependency and trained the models to reach for it when given some set of hard constraints or an optimization problem to solve. In the meantime, though, I&#39;ll just use <code>uv run --with ortools ...</code> to optimize random life logistics.</p>
<h2 id="code">Code</h2><div><pre><span></span><span>from</span><span> </span><span>ortools.sat.python</span><span> </span><span>import</span> <span>cp_model</span>
<span>from</span><span> </span><span>datetime</span><span> </span><span>import</span> <span>datetime</span>

<span># ---------------------------------------------------------------------------</span>
<span># Helper to convert &#34;HH:MM&#34; âžœ minutes since 00:00</span>
<span># ---------------------------------------------------------------------------</span>

<span>def</span><span> </span><span>t</span><span>(</span><span>hhmm</span><span>:</span> <span>str</span><span>)</span> <span>-&gt;</span> <span>int</span><span>:</span>
    <span>h</span><span>,</span> <span>m</span> <span>=</span> <span>map</span><span>(</span><span>int</span><span>,</span> <span>hhmm</span><span>.</span><span>split</span><span>(</span><span>&#34;:&#34;</span><span>))</span>
    <span>return</span> <span>h</span> <span>*</span> <span>60</span> <span>+</span> <span>m</span>

<span># ---------------------------------------------------------------------------</span>
<span># 1)  INPUT DATA  â”€â”€â”€ tweak these dictionaries / lists as you like</span>
<span># ---------------------------------------------------------------------------</span>

<span>players</span> <span>=</span> <span>[</span><span>&#34;A&#34;</span><span>,</span> <span>&#34;B&#34;</span><span>,</span> <span>&#34;D&#34;</span><span>,</span> <span>&#34;E&#34;</span><span>,</span> <span>&#34;J&#34;</span><span>,</span> <span>&#34;P&#34;</span><span>,</span> <span>&#34;S&#34;</span><span>,</span> <span>&#34;T&#34;</span><span>]</span>

<span># (min, max) rooms each player must play</span>
<span>quota</span> <span>=</span> <span>{</span>
    <span>&#34;A&#34;</span><span>:</span> <span>(</span><span>2</span><span>,</span> <span>2</span><span>),</span>
    <span>&#34;B&#34;</span><span>:</span> <span>(</span><span>2</span><span>,</span> <span>2</span><span>),</span>
    <span>&#34;S&#34;</span><span>:</span> <span>(</span><span>2</span><span>,</span> <span>3</span><span>),</span> 
    <span>&#34;D&#34;</span><span>:</span> <span>(</span><span>3</span><span>,</span> <span>3</span><span>),</span>
    <span>&#34;E&#34;</span><span>:</span> <span>(</span><span>3</span><span>,</span> <span>3</span><span>),</span>
    <span>&#34;J&#34;</span><span>:</span> <span>(</span><span>3</span><span>,</span> <span>3</span><span>),</span>
    <span>&#34;P&#34;</span><span>:</span> <span>(</span><span>3</span><span>,</span> <span>3</span><span>),</span>
    <span>&#34;T&#34;</span><span>:</span> <span>(</span><span>3</span><span>,</span> <span>3</span><span>),</span>
<span>}</span>

<span># (label, theme, startâ€‘time, endâ€‘time)  â€“Â freely add / remove sessions</span>
<span>sessions</span> <span>=</span> <span>[</span>
    <span>(</span><span>&#34;Candy1&#34;</span><span>,</span> <span>&#34;Candy&#34;</span><span>,</span> <span>t</span><span>(</span><span>&#34;11:00&#34;</span><span>),</span> <span>t</span><span>(</span><span>&#34;11:50&#34;</span><span>)),</span>
    <span>(</span><span>&#34;Candy2&#34;</span><span>,</span> <span>&#34;Candy&#34;</span><span>,</span> <span>t</span><span>(</span><span>&#34;12:00&#34;</span><span>),</span> <span>t</span><span>(</span><span>&#34;12:50&#34;</span><span>)),</span>
    <span>(</span><span>&#34;Candy3&#34;</span><span>,</span> <span>&#34;Candy&#34;</span><span>,</span> <span>t</span><span>(</span><span>&#34;13:00&#34;</span><span>),</span> <span>t</span><span>(</span><span>&#34;13:50&#34;</span><span>)),</span>

    <span>(</span><span>&#34;Xmas1&#34;</span><span>,</span>  <span>&#34;Christmas&#34;</span><span>,</span> <span>t</span><span>(</span><span>&#34;11:00&#34;</span><span>),</span> <span>t</span><span>(</span><span>&#34;11:50&#34;</span><span>)),</span>
    <span>(</span><span>&#34;Xmas2&#34;</span><span>,</span>  <span>&#34;Christmas&#34;</span><span>,</span> <span>t</span><span>(</span><span>&#34;12:00&#34;</span><span>),</span> <span>t</span><span>(</span><span>&#34;12:50&#34;</span><span>)),</span>
    <span>(</span><span>&#34;Xmas3&#34;</span><span>,</span>  <span>&#34;Christmas&#34;</span><span>,</span> <span>t</span><span>(</span><span>&#34;13:00&#34;</span><span>),</span> <span>t</span><span>(</span><span>&#34;13:50&#34;</span><span>)),</span>
    <span>(</span><span>&#34;Xmas4&#34;</span><span>,</span>  <span>&#34;Christmas&#34;</span><span>,</span> <span>t</span><span>(</span><span>&#34;14:00&#34;</span><span>),</span> <span>t</span><span>(</span><span>&#34;14:50&#34;</span><span>)),</span>

    <span>(</span><span>&#34;Temple1&#34;</span><span>,</span> <span>&#34;Temple&#34;</span><span>,</span> <span>t</span><span>(</span><span>&#34;11:00&#34;</span><span>),</span> <span>t</span><span>(</span><span>&#34;11:50&#34;</span><span>)),</span>
    <span>(</span><span>&#34;Temple2&#34;</span><span>,</span> <span>&#34;Temple&#34;</span><span>,</span> <span>t</span><span>(</span><span>&#34;12:00&#34;</span><span>),</span> <span>t</span><span>(</span><span>&#34;12:50&#34;</span><span>)),</span>
    <span>(</span><span>&#34;Temple3&#34;</span><span>,</span> <span>&#34;Temple&#34;</span><span>,</span> <span>t</span><span>(</span><span>&#34;13:00&#34;</span><span>),</span> <span>t</span><span>(</span><span>&#34;13:50&#34;</span><span>)),</span>
    <span>(</span><span>&#34;Temple4&#34;</span><span>,</span> <span>&#34;Temple&#34;</span><span>,</span> <span>t</span><span>(</span><span>&#34;14:00&#34;</span><span>),</span> <span>t</span><span>(</span><span>&#34;14:50&#34;</span><span>)),</span>
    <span># (&#34;Temple5&#34;, &#34;Temple&#34;, t(&#34;15:00&#34;), t(&#34;15:50&#34;)),</span>
<span>]</span>

<span># Niceâ€‘toâ€‘haves â€“Â set False if you do not care</span>
<span>NICE_EDT_T2</span>       <span>=</span> <span>True</span>   <span># E, D, T together in Temple2</span>
<span>NICE_AB_TOGETHER</span>  <span>=</span> <span>True</span>   <span># A &amp; B share at least one session</span>
<span>NICE_E_WITH_ALL</span>   <span>=</span> <span>True</span>   <span># E meets everyone at least once</span>

<span># Arrival / departure windows</span>
<span>arrival</span> <span>=</span> <span>{</span><span>p</span><span>:</span> <span>t</span><span>(</span><span>&#34;11:00&#34;</span><span>)</span> <span>for</span> <span>p</span> <span>in</span> <span>players</span><span>}</span>
<span>arrival</span><span>.</span><span>update</span><span>({</span><span>&#34;A&#34;</span><span>:</span> <span>t</span><span>(</span><span>&#34;12:15&#34;</span><span>),</span> <span>&#34;B&#34;</span><span>:</span> <span>t</span><span>(</span><span>&#34;12:15&#34;</span><span>),</span> <span>&#34;S&#34;</span><span>:</span> <span>t</span><span>(</span><span>&#34;12:15&#34;</span><span>)})</span>
<span>depart</span> <span>=</span> <span>{</span><span>p</span><span>:</span> <span>t</span><span>(</span><span>&#34;23:59&#34;</span><span>)</span> <span>for</span> <span>p</span> <span>in</span> <span>players</span><span>}</span>
<span>depart</span><span>.</span><span>update</span><span>({</span><span>&#34;P&#34;</span><span>:</span> <span>t</span><span>(</span><span>&#34;15:30&#34;</span><span>),</span> <span>&#34;T&#34;</span><span>:</span> <span>t</span><span>(</span><span>&#34;15:30&#34;</span><span>)})</span>

<span># Capacity limits (min only applies if the session is actually used)</span>
<span>CAP_MIN</span> <span>=</span> <span>2</span>
<span>CAP_MAX</span> <span>=</span> <span>3</span>

<span># ---------------------------------------------------------------------------</span>
<span># 2)  CPâ€‘SAT MODEL</span>
<span># ---------------------------------------------------------------------------</span>

<span>model</span> <span>=</span> <span>cp_model</span><span>.</span><span>CpModel</span><span>()</span>
<span>num_sessions</span> <span>=</span> <span>len</span><span>(</span><span>sessions</span><span>)</span>

<span># x[p][i] == 1  â‡” player p attends session i</span>
<span>x</span> <span>=</span> <span>{</span>
    <span>p</span><span>:</span> <span>[</span><span>model</span><span>.</span><span>NewBoolVar</span><span>(</span><span>f</span><span>&#34;x[</span><span>{</span><span>p</span><span>}</span><span>,</span><span>{</span><span>i</span><span>}</span><span>]&#34;</span><span>)</span> <span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>num_sessions</span><span>)]</span>
    <span>for</span> <span>p</span> <span>in</span> <span>players</span>
<span>}</span>

<span># y[i] == 1 â‡” session i is actually used (â‰¥1 player)</span>
<span>y</span> <span>=</span> <span>[</span><span>model</span><span>.</span><span>NewBoolVar</span><span>(</span><span>f</span><span>&#34;used[</span><span>{</span><span>i</span><span>}</span><span>]&#34;</span><span>)</span> <span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>num_sessions</span><span>)]</span>

<span># ---------------------------------------------------------------------------</span>
<span># 2.1  Quotas</span>
<span># ---------------------------------------------------------------------------</span>
<span>for</span> <span>p</span> <span>in</span> <span>players</span><span>:</span>
    <span>lo</span><span>,</span> <span>hi</span> <span>=</span> <span>quota</span><span>[</span><span>p</span><span>]</span>
    <span>model</span><span>.</span><span>Add</span><span>(</span><span>sum</span><span>(</span><span>x</span><span>[</span><span>p</span><span>][</span><span>i</span><span>]</span> <span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>num_sessions</span><span>))</span> <span>&gt;=</span> <span>lo</span><span>)</span>
    <span>model</span><span>.</span><span>Add</span><span>(</span><span>sum</span><span>(</span><span>x</span><span>[</span><span>p</span><span>][</span><span>i</span><span>]</span> <span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>num_sessions</span><span>))</span> <span>&lt;=</span> <span>hi</span><span>)</span>

<span># ---------------------------------------------------------------------------</span>
<span># 2.2  One session per theme for each player (no repeats)</span>
<span># ---------------------------------------------------------------------------</span>
<span>for</span> <span>p</span> <span>in</span> <span>players</span><span>:</span>
    <span>for</span> <span>theme</span> <span>in</span> <span>{</span><span>s</span><span>[</span><span>1</span><span>]</span> <span>for</span> <span>s</span> <span>in</span> <span>sessions</span><span>}:</span>
        <span>same_theme</span> <span>=</span> <span>[</span><span>i</span> <span>for</span> <span>i</span><span>,</span> <span>s</span> <span>in</span> <span>enumerate</span><span>(</span><span>sessions</span><span>)</span> <span>if</span> <span>s</span><span>[</span><span>1</span><span>]</span> <span>==</span> <span>theme</span><span>]</span>
        <span>if</span> <span>len</span><span>(</span><span>same_theme</span><span>)</span> <span>&gt;</span> <span>1</span><span>:</span>
            <span>model</span><span>.</span><span>Add</span><span>(</span><span>sum</span><span>(</span><span>x</span><span>[</span><span>p</span><span>][</span><span>i</span><span>]</span> <span>for</span> <span>i</span> <span>in</span> <span>same_theme</span><span>)</span> <span>&lt;=</span> <span>1</span><span>)</span>

<span># ---------------------------------------------------------------------------</span>
<span># 2.3  Arrival / departure filtering</span>
<span># ---------------------------------------------------------------------------</span>
<span>for</span> <span>p</span> <span>in</span> <span>players</span><span>:</span>
    <span>for</span> <span>i</span><span>,</span> <span>(</span><span>_</span><span>,</span> <span>_</span><span>,</span> <span>start</span><span>,</span> <span>end</span><span>)</span> <span>in</span> <span>enumerate</span><span>(</span><span>sessions</span><span>):</span>
        <span>if</span> <span>start</span> <span>&lt;</span> <span>arrival</span><span>[</span><span>p</span><span>]</span> <span>or</span> <span>end</span> <span>&gt;</span> <span>depart</span><span>[</span><span>p</span><span>]:</span>
            <span>model</span><span>.</span><span>Add</span><span>(</span><span>x</span><span>[</span><span>p</span><span>][</span><span>i</span><span>]</span> <span>==</span> <span>0</span><span>)</span>

<span># ---------------------------------------------------------------------------</span>
<span># 2.4  No overlaps per player</span>
<span># ---------------------------------------------------------------------------</span>
<span>for</span> <span>p</span> <span>in</span> <span>players</span><span>:</span>
    <span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>num_sessions</span><span>):</span>
        <span>si</span><span>,</span> <span>ei</span> <span>=</span> <span>sessions</span><span>[</span><span>i</span><span>][</span><span>2</span><span>:</span><span>4</span><span>]</span>
        <span>for</span> <span>j</span> <span>in</span> <span>range</span><span>(</span><span>i</span> <span>+</span> <span>1</span><span>,</span> <span>num_sessions</span><span>):</span>
            <span>sj</span><span>,</span> <span>ej</span> <span>=</span> <span>sessions</span><span>[</span><span>j</span><span>][</span><span>2</span><span>:</span><span>4</span><span>]</span>
            <span>if</span> <span>si</span> <span>&lt;</span> <span>ej</span> <span>and</span> <span>sj</span> <span>&lt;</span> <span>ei</span><span>:</span>  <span># true overlap (shared minutes)</span>
                <span>model</span><span>.</span><span>Add</span><span>(</span><span>x</span><span>[</span><span>p</span><span>][</span><span>i</span><span>]</span> <span>+</span> <span>x</span><span>[</span><span>p</span><span>][</span><span>j</span><span>]</span> <span>&lt;=</span> <span>1</span><span>)</span>

<span># ---------------------------------------------------------------------------</span>
<span># 2.5  Link &#34;used&#34; variable with player attendance + capacity bounds</span>
<span># ---------------------------------------------------------------------------</span>
<span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>num_sessions</span><span>):</span>
    <span>total_here</span> <span>=</span> <span>sum</span><span>(</span><span>x</span><span>[</span><span>p</span><span>][</span><span>i</span><span>]</span> <span>for</span> <span>p</span> <span>in</span> <span>players</span><span>)</span>
    <span>model</span><span>.</span><span>Add</span><span>(</span><span>total_here</span> <span>&gt;=</span> <span>CAP_MIN</span><span>)</span><span>.</span><span>OnlyEnforceIf</span><span>(</span><span>y</span><span>[</span><span>i</span><span>])</span>
    <span>model</span><span>.</span><span>Add</span><span>(</span><span>total_here</span> <span>&lt;=</span> <span>CAP_MAX</span><span>)</span>
    <span># If anyone attends âžœ session is used</span>
    <span>for</span> <span>p</span> <span>in</span> <span>players</span><span>:</span>
        <span>model</span><span>.</span><span>Add</span><span>(</span><span>x</span><span>[</span><span>p</span><span>][</span><span>i</span><span>]</span> <span>&lt;=</span> <span>y</span><span>[</span><span>i</span><span>])</span>
    <span># At least 1 attend =&gt; used=1  (bigâ€‘M style)</span>
    <span>model</span><span>.</span><span>Add</span><span>(</span><span>total_here</span> <span>&gt;=</span> <span>1</span><span>)</span><span>.</span><span>OnlyEnforceIf</span><span>(</span><span>y</span><span>[</span><span>i</span><span>])</span>
    <span>model</span><span>.</span><span>Add</span><span>(</span><span>total_here</span> <span>&lt;=</span> <span>0</span><span>)</span><span>.</span><span>OnlyEnforceIf</span><span>(</span><span>y</span><span>[</span><span>i</span><span>]</span><span>.</span><span>Not</span><span>())</span>

<span># ---------------------------------------------------------------------------</span>
<span># 3)  SOFT CONSTRAINTS  /  OBJECTIVE FUNCTION</span>
<span># ---------------------------------------------------------------------------</span>
<span>obj_terms</span> <span>=</span> <span>[]</span>

<span># Nice 1 â€“ E, D, T together in Temple2</span>
<span>if</span> <span>NICE_EDT_T2</span><span>:</span>
    <span>idx_t2</span> <span>=</span> <span>next</span><span>(</span><span>i</span> <span>for</span> <span>i</span><span>,</span> <span>s</span> <span>in</span> <span>enumerate</span><span>(</span><span>sessions</span><span>)</span> <span>if</span> <span>s</span><span>[</span><span>0</span><span>]</span> <span>==</span> <span>&#34;Temple2&#34;</span><span>)</span>
    <span>edt</span> <span>=</span> <span>model</span><span>.</span><span>NewBoolVar</span><span>(</span><span>&#34;edt_in_T2&#34;</span><span>)</span>
    <span>model</span><span>.</span><span>Add</span><span>(</span><span>x</span><span>[</span><span>&#34;E&#34;</span><span>][</span><span>idx_t2</span><span>]</span> <span>+</span> <span>x</span><span>[</span><span>&#34;D&#34;</span><span>][</span><span>idx_t2</span><span>]</span> <span>+</span> <span>x</span><span>[</span><span>&#34;T&#34;</span><span>][</span><span>idx_t2</span><span>]</span> <span>&gt;=</span> <span>3</span> <span>*</span> <span>edt</span><span>)</span>
    <span>model</span><span>.</span><span>Add</span><span>(</span><span>x</span><span>[</span><span>&#34;E&#34;</span><span>][</span><span>idx_t2</span><span>]</span> <span>+</span> <span>x</span><span>[</span><span>&#34;D&#34;</span><span>][</span><span>idx_t2</span><span>]</span> <span>+</span> <span>x</span><span>[</span><span>&#34;T&#34;</span><span>][</span><span>idx_t2</span><span>]</span> <span>&lt;=</span> <span>edt</span> <span>+</span> <span>2</span><span>)</span>
    <span>obj_terms</span><span>.</span><span>append</span><span>(</span><span>edt</span><span>)</span>

<span># Nice 2 â€“ at least one game with A &amp; B together</span>
<span>if</span> <span>NICE_AB_TOGETHER</span><span>:</span>
    <span>ab_shared</span> <span>=</span> <span>model</span><span>.</span><span>NewBoolVar</span><span>(</span><span>&#34;A_B_together&#34;</span><span>)</span>
    <span>ab_in_any</span> <span>=</span> <span>[]</span>
    <span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>num_sessions</span><span>):</span>
        <span>s_var</span> <span>=</span> <span>model</span><span>.</span><span>NewBoolVar</span><span>(</span><span>f</span><span>&#34;AB_</span><span>{</span><span>i</span><span>}</span><span>&#34;</span><span>)</span>
        <span>model</span><span>.</span><span>Add</span><span>(</span><span>s_var</span> <span>&lt;=</span> <span>x</span><span>[</span><span>&#34;A&#34;</span><span>][</span><span>i</span><span>])</span>
        <span>model</span><span>.</span><span>Add</span><span>(</span><span>s_var</span> <span>&lt;=</span> <span>x</span><span>[</span><span>&#34;B&#34;</span><span>][</span><span>i</span><span>])</span>
        <span>model</span><span>.</span><span>Add</span><span>(</span><span>s_var</span> <span>&gt;=</span> <span>x</span><span>[</span><span>&#34;A&#34;</span><span>][</span><span>i</span><span>]</span> <span>+</span> <span>x</span><span>[</span><span>&#34;B&#34;</span><span>][</span><span>i</span><span>]</span> <span>-</span> <span>1</span><span>)</span>
        <span>ab_in_any</span><span>.</span><span>append</span><span>(</span><span>s_var</span><span>)</span>
    <span>model</span><span>.</span><span>AddMaxEquality</span><span>(</span><span>ab_shared</span><span>,</span> <span>ab_in_any</span><span>)</span>
    <span>obj_terms</span><span>.</span><span>append</span><span>(</span><span>ab_shared</span><span>)</span>

<span># Nice 3 â€“ E plays with everyone at least once</span>
<span>if</span> <span>NICE_E_WITH_ALL</span><span>:</span>
    <span>for</span> <span>q</span> <span>in</span> <span>players</span><span>:</span>
        <span>if</span> <span>q</span> <span>==</span> <span>&#34;E&#34;</span><span>:</span>
            <span>continue</span>
        <span>together</span> <span>=</span> <span>[]</span>
        <span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>num_sessions</span><span>):</span>
            <span>both</span> <span>=</span> <span>model</span><span>.</span><span>NewBoolVar</span><span>(</span><span>f</span><span>&#34;E_</span><span>{</span><span>q</span><span>}</span><span>_</span><span>{</span><span>i</span><span>}</span><span>&#34;</span><span>)</span>
            <span>model</span><span>.</span><span>Add</span><span>(</span><span>both</span> <span>&lt;=</span> <span>x</span><span>[</span><span>&#34;E&#34;</span><span>][</span><span>i</span><span>])</span>
            <span>model</span><span>.</span><span>Add</span><span>(</span><span>both</span> <span>&lt;=</span> <span>x</span><span>[</span><span>q</span><span>][</span><span>i</span><span>])</span>
            <span>model</span><span>.</span><span>Add</span><span>(</span><span>both</span> <span>&gt;=</span> <span>x</span><span>[</span><span>&#34;E&#34;</span><span>][</span><span>i</span><span>]</span> <span>+</span> <span>x</span><span>[</span><span>q</span><span>][</span><span>i</span><span>]</span> <span>-</span> <span>1</span><span>)</span>
            <span>together</span><span>.</span><span>append</span><span>(</span><span>both</span><span>)</span>
        <span>meet_flag</span> <span>=</span> <span>model</span><span>.</span><span>NewBoolVar</span><span>(</span><span>f</span><span>&#34;E_with_</span><span>{</span><span>q</span><span>}</span><span>&#34;</span><span>)</span>
        <span>model</span><span>.</span><span>AddMaxEquality</span><span>(</span><span>meet_flag</span><span>,</span> <span>together</span><span>)</span>
        <span>obj_terms</span><span>.</span><span>append</span><span>(</span><span>meet_flag</span><span>)</span>

<span># Nice 4 â€“ at least one game with T &amp; P together</span>
<span>TP_shared</span> <span>=</span> <span>model</span><span>.</span><span>NewBoolVar</span><span>(</span><span>&#34;T_P_together&#34;</span><span>)</span>
<span>tp_in_any</span> <span>=</span> <span>[]</span>
<span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>num_sessions</span><span>):</span>
    <span>s_var</span> <span>=</span> <span>model</span><span>.</span><span>NewBoolVar</span><span>(</span><span>f</span><span>&#34;TP_</span><span>{</span><span>i</span><span>}</span><span>&#34;</span><span>)</span>
    <span>model</span><span>.</span><span>Add</span><span>(</span><span>s_var</span> <span>&lt;=</span> <span>x</span><span>[</span><span>&#34;T&#34;</span><span>][</span><span>i</span><span>])</span>
    <span>model</span><span>.</span><span>Add</span><span>(</span><span>s_var</span> <span>&lt;=</span> <span>x</span><span>[</span><span>&#34;P&#34;</span><span>][</span><span>i</span><span>])</span>
    <span>model</span><span>.</span><span>Add</span><span>(</span><span>s_var</span> <span>&gt;=</span> <span>x</span><span>[</span><span>&#34;T&#34;</span><span>][</span><span>i</span><span>]</span> <span>+</span> <span>x</span><span>[</span><span>&#34;P&#34;</span><span>][</span><span>i</span><span>]</span> <span>-</span> <span>1</span><span>)</span>
    <span>tp_in_any</span><span>.</span><span>append</span><span>(</span><span>s_var</span><span>)</span>
<span>model</span><span>.</span><span>AddMaxEquality</span><span>(</span><span>TP_shared</span><span>,</span> <span>tp_in_any</span><span>)</span>
<span>obj_terms</span><span>.</span><span>append</span><span>(</span><span>TP_shared</span><span>)</span>

<span># Maximise the total number of soft constraints satisfied</span>
<span>if</span> <span>obj_terms</span><span>:</span>
    <span>model</span><span>.</span><span>Maximize</span><span>(</span><span>sum</span><span>(</span><span>obj_terms</span><span>))</span>

<span># ---------------------------------------------------------------------------</span>
<span># 4)  SOLVE &amp; PRINT RESULT</span>
<span># ---------------------------------------------------------------------------</span>

<span>solver</span> <span>=</span> <span>cp_model</span><span>.</span><span>CpSolver</span><span>()</span>
<span>solver</span><span>.</span><span>parameters</span><span>.</span><span>max_time_in_seconds</span> <span>=</span> <span>60</span>  <span># increase if needed</span>
<span>status</span> <span>=</span> <span>solver</span><span>.</span><span>Solve</span><span>(</span><span>model</span><span>)</span>

<span>if</span> <span>status</span> <span>in</span> <span>(</span><span>cp_model</span><span>.</span><span>OPTIMAL</span><span>,</span> <span>cp_model</span><span>.</span><span>FEASIBLE</span><span>):</span>
    <span>print</span><span>(</span><span>&#34;</span><span>\n</span><span>âœ” Schedule found (softâ€‘score =&#34;</span><span>,</span> <span>solver</span><span>.</span><span>ObjectiveValue</span><span>(),</span> <span>&#34;)</span><span>\n</span><span>&#34;</span><span>)</span>
    <span>def</span><span> </span><span>hm</span><span>(</span><span>m</span><span>):</span>
        <span>return</span> <span>f</span><span>&#34;</span><span>{</span><span>m</span><span> </span><span>//</span><span> </span><span>60</span><span>:</span><span>02d</span><span>}</span><span>:</span><span>{</span><span>m</span><span> </span><span>%</span><span> </span><span>60</span><span>:</span><span>02d</span><span>}</span><span>&#34;</span>

    <span>for</span> <span>i</span><span>,</span> <span>(</span><span>label</span><span>,</span> <span>theme</span><span>,</span> <span>start</span><span>,</span> <span>end</span><span>)</span> <span>in</span> <span>enumerate</span><span>(</span><span>sessions</span><span>):</span>
        <span>ppl</span> <span>=</span> <span>[</span><span>p</span> <span>for</span> <span>p</span> <span>in</span> <span>players</span> <span>if</span> <span>solver</span><span>.</span><span>Value</span><span>(</span><span>x</span><span>[</span><span>p</span><span>][</span><span>i</span><span>])]</span>
        <span>if</span> <span>ppl</span><span>:</span>
            <span>print</span><span>(</span><span>f</span><span>&#34;</span><span>{</span><span>theme</span><span>:</span><span>&lt;10</span><span>}</span><span> </span><span>{</span><span>label</span><span>:</span><span>&lt;7</span><span>}</span><span> </span><span>{</span><span>hm</span><span>(</span><span>start</span><span>)</span><span>}</span><span>â€“</span><span>{</span><span>hm</span><span>(</span><span>end</span><span>)</span><span>}</span><span> :  </span><span>{</span><span>&#39;, &#39;</span><span>.</span><span>join</span><span>(</span><span>ppl</span><span>)</span><span>}</span><span>&#34;</span><span>)</span>
<span>else</span><span>:</span>
    <span>print</span><span>(</span><span>&#34;</span><span>\n</span><span>âœ˜ No feasible schedule under the current hard constraints.&#34;</span><span>)</span>
</pre></div>


    

    
        
            <p>
                
                    <a href="https://news.ycombinator.com/blog/?q=ai">#ai</a>
                
            </p>
        

        
            


        
    


  </div></div>
  </body>
</html>
