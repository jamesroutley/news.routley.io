<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://nshipster.com/uncertainty/">Original</a>
    <h1>Uncertain&lt;T&gt;</h1>
    
    <div id="readability-page-1" class="page"><div>
              <p>You know whatâ€™s wrong with people?
                Theyâ€™re too sure of themselves.</p>
              <p>Better to be wrong and own it than be right with caveats.
                Hard to build a personal brand out of nuance these days.
                People are attracted to confidence â€” however misplaced.</p>
              <p>But can you blame them? (People, that is)
                Working in software,
                the most annoying part of reaching Senior level
                is having to say <em>â€œit dependsâ€</em> all the time.
                Much more fun getting to say
                <em>â€œletâ€™s ship it and iterateâ€</em> as Staff or
                <em>â€œthat wonâ€™t scaleâ€</em> as a Principal.</p>
              <p>Yet, for all of our intellectual humility,
                why do we <del>write</del> vibe code like this?</p>
              <pre data-lang="Swift"><code><span>if</span> <span>current<wbr/>Location</span><span>.</span><span>distance</span><span>(</span><span>to</span><span>:</span> <span>target</span><span>)</span> <span>&lt;</span> <span>100</span> <span>{</span>
    <span>print</span><span>(</span><span>&#34;You&#39;ve arrived!&#34;</span><span>)</span> <span>// But have you, really? ğŸ¤¨</span>
<span>}</span>
</code></pre>
              <p>GPS coordinates arenâ€™t exact.
                Theyâ€™re noisy. Theyâ€™re approximate. Theyâ€™re probabilistic.
                That <code>horizontal<wbr/>Accuracy</code> property tucked away in your <code>CLLocation</code> object
              is trying to tell you something important:
              youâ€™re <em>probably</em> within that radius.
              <em>Probably.</em></p>
            <p>A <code>Bool</code>, meanwhile, can be only <code>true</code> or <code>false</code>.
              That <code>if</code> statement needs to make a choice one way or another,
              but code like this doesnâ€™t capture the uncertainty of the situation.
              If truth is light,
              then current programming models collapse the wavefunction too early.</p>
            <h2>
              <a aria-hidden="true" id="picking-the-right-abstraction" href="#picking-the-right-abstraction"></a>Picking the Right Abstraction</h2>
            <p>In 2014, researchers at the University of Washington and Microsoft Research
              proposed a radical idea:
              What if uncertainty were encoded directly into the type system?
              Their paper,
              <em><a href="https://www.microsoft.com/en-us/research/publication/uncertaint-a-first-order-type-for-uncertain-data-2/">Uncertain&lt;T&gt;: A First-Order Type for Uncertain Data</a></em>
              introduced a probabilistic programming approach thatâ€™s both
              mathematically rigorous and surprisingly practical.</p>
            
            <p>As youâ€™d expect for something from Microsoft in the 2010s,
              the paper is implemented in C#.
              But the concepts translate beautifully to Swift.</p>
            <p>You can find <a href="https://github.com/mattt/Uncertain">my port on GitHub</a>:</p>
            <pre data-lang="Swift"><code><span>import</span> <span>Uncertain</span>
<span>import</span> <span>Core<wbr/>Location</span>

<span>let</span> <span>uncertain<wbr/>Location</span> <span>=</span> <span>Uncertain</span><span>&lt;</span><span>CLLocation</span><span>&gt;.</span><span>from</span><span>(</span><span>current<wbr/>Location</span><span>)</span>
<span>let</span> <span>nearby<wbr/>Evidence</span> <span>=</span> <span>uncertain<wbr/>Location</span><span>.</span><span>distance</span><span>(</span><span>to</span><span>:</span> <span>target</span><span>)</span> <span>&lt;</span> <span>100</span>
<span>if</span> <span>nearby<wbr/>Evidence</span><span>.</span><span>probability</span><span>(</span><span>exceeds</span><span>:</span> <span>0.95</span><span>)</span> <span>{</span>
    <span>print</span><span>(</span><span>&#34;You&#39;ve arrived!&#34;</span><span>)</span> <span>// With 2Ïƒ confidence ğŸ¤“</span>
<span>}</span>
</code></pre>
            <p>When you compare two <code>Uncertain</code> values,
              you donâ€™t get a definitive <code>true</code> or <code>false</code>.
              You get an <code>Uncertain&lt;Bool&gt;</code> that represents the <em>probability</em> of the comparison being <code>true</code>.</p>
            
            <p>The same is true for other operators, too:</p>
            <pre data-lang="Swift"><code><span>// How fast did we run around the track?</span>
<span>let</span> <span>distance</span><span>:</span> <span>Double</span> <span>=</span> <span>400</span> <span>// meters</span>
<span>let</span> <span>time</span><span>:</span> <span>Uncertain</span><span>&lt;</span><span>Double</span><span>&gt;</span> <span>=</span> <span>.</span><span>normal</span><span>(</span><span>mean</span><span>:</span> <span>60</span><span>,</span> <span>standard<wbr/>Deviation</span><span>:</span> <span>5.0</span><span>)</span> <span>// seconds</span>
<span>let</span> <span>running<wbr/>Speed</span> <span>=</span> <span>distance</span> <span>/</span> <span>time</span> <span>// Uncertain&lt;Double&gt;</span>

<span>// How much air resistance?</span>
<span>let</span> <span>air<wbr/>Density</span><span>:</span> <span>Uncertain</span><span>&lt;</span><span>Double</span><span>&gt;</span> <span>=</span> <span>.</span><span>normal</span><span>(</span><span>mean</span><span>:</span> <span>1.225</span><span>,</span> <span>standard<wbr/>Deviation</span><span>:</span> <span>0.1</span><span>)</span> <span>// kg/mÂ³</span>
<span>let</span> <span>drag<wbr/>Coefficient</span><span>:</span> <span>Uncertain</span><span>&lt;</span><span>Double</span><span>&gt;</span> <span>=</span> <span>.</span><span>kumaraswamy</span><span>(</span><span>alpha</span><span>:</span> <span>9</span><span>,</span> <span>beta</span><span>:</span> <span>3</span><span>)</span> <span>// slightly right-skewed distribution</span>
<span>let</span> <span>frontal<wbr/>Area</span><span>:</span> <span>Uncertain</span><span>&lt;</span><span>Double</span><span>&gt;</span> <span>=</span> <span>.</span><span>normal</span><span>(</span><span>mean</span><span>:</span> <span>0.45</span><span>,</span> <span>standard<wbr/>Deviation</span><span>:</span> <span>0.05</span><span>)</span> <span>// mÂ²</span>
<span>let</span> <span>air<wbr/>Resistance</span> <span>=</span> <span>0.5</span> <span>*</span> <span>air<wbr/>Density</span> <span>*</span> <span>frontal<wbr/>Area</span> <span>*</span> <span>drag<wbr/>Coefficient</span> <span>*</span> <span>(</span><span>running<wbr/>Speed</span> <span>*</span> <span>running<wbr/>Speed</span><span>)</span>
</code></pre>
            <p>This code builds a computation graph,
              sampling only when you ask for concrete results.
              The library uses
              <a href="https://en.wikipedia.org/wiki/Sequential_probability_ratio_test">Sequential Probability Ratio Testing (SPRT)</a>
              to efficiently determine how many samples are needed â€”
              maybe a few dozen times for simple comparisons,
              scaling up automatically for complex calculations.</p>
            <pre data-lang="Swift"><code><span>// Sampling happens only when we need to evaluate</span>
<span>if</span> <span>~</span><span>(</span><span>running<wbr/>Speed</span> <span>&gt;</span> <span>6.0</span><span>)</span> <span>{</span>
    <span>print</span><span>(</span><span>&#34;Great pace for a 400m sprint!&#34;</span><span>)</span>
<span>}</span>
<span>// SPRT might only need a dozen samples for this simple comparison</span>

<span>let</span> <span>sustainable<wbr/>For5K</span> <span>=</span> <span>(</span><span>running<wbr/>Speed</span> <span>&lt;</span> <span>6.0</span><span>)</span> <span>&amp;&amp;</span> <span>(</span><span>air<wbr/>Resistance</span> <span>&lt;</span> <span>50.0</span><span>)</span>
<span>print</span><span>(</span><span>&#34;Can sustain for 5K: </span><span>\(</span><span>sustainable<wbr/>For5K</span><span>.</span><span>probability</span><span>(</span><span>exceeds</span><span>:</span> <span>0.9</span><span>)</span><span>)</span><span>&#34;</span><span>)</span>
<span>// Might use 100+ samples for this compound condition</span>
</code></pre>
            <p>Using an abstraction like <code>Uncertain&lt;T&gt;</code> forces you to deal with uncertainty as a first-class concept
              rather than pretending it doesnâ€™t exist.
              And in doing so, you end up with much smarter code.</p>
            <p>To quote <a href="https://en.wikipedia.org/wiki/Alan_Kay">Alan Kay</a>:</p>
            <blockquote>
              <p>Point of view is worth 80 IQ points
                </p>
            </blockquote>
            <hr/><p>Before we dive deeper into probability distributions,
              letâ€™s take a detour to Monaco and talk about
              <a href="https://en.wikipedia.org/wiki/Monte_Carlo_method">Monte Carlo sampling</a>.</p>
            <h2>
              <a aria-hidden="true" id="the-monte-carlo-method" href="#the-monte-carlo-method"></a>The Monte Carlo Method</h2>
            <p>Behold, a classic slot machine (or â€œfruit machineâ€ for our UK readers ğŸ‡¬ğŸ‡§):</p>
            <pre data-lang="Swift"><code><span>enum</span> <span>Slot<wbr/>Machine</span> <span>{</span>
    <span>static</span> <span>func</span> <span>spin</span><span>()</span> <span>-&gt;</span> <span>Int</span> <span>{</span>
        <span>let</span> <span>symbols</span> <span>=</span> <span>[</span>
            <span>&#34;â—»ï¸&#34;</span><span>,</span> <span>&#34;â—»ï¸&#34;</span><span>,</span> <span>&#34;â—»ï¸&#34;</span><span>,</span>  <span>// blanks</span>
            <span>&#34;ğŸ’&#34;</span><span>,</span> <span>&#34;ğŸ‹&#34;</span><span>,</span> <span>&#34;ğŸŠ&#34;</span><span>,</span> <span>&#34;ğŸ‡&#34;</span><span>,</span> <span>&#34;ğŸ’&#34;</span>
        <span>]</span>

        <span>// Spin three reels independently</span>
        <span>let</span> <span>reel1</span> <span>=</span> <span>symbols</span><span>.</span><span>random<wbr/>Element</span><span>()</span><span>!</span>
        <span>let</span> <span>reel2</span> <span>=</span> <span>symbols</span><span>.</span><span>random<wbr/>Element</span><span>()</span><span>!</span>
        <span>let</span> <span>reel3</span> <span>=</span> <span>symbols</span><span>.</span><span>random<wbr/>Element</span><span>()</span><span>!</span>

        <span>switch</span> <span>(</span><span>reel1</span><span>,</span> <span>reel2</span><span>,</span> <span>reel3</span><span>)</span> <span>{</span>
        <span>case</span> <span>(</span><span>&#34;ğŸ’&#34;</span><span>,</span> <span>&#34;ğŸ’&#34;</span><span>,</span> <span>&#34;ğŸ’&#34;</span><span>):</span> <span>return</span> <span>100</span>  <span>// Jackpot!</span>
        <span>case</span> <span>(</span><span>&#34;ğŸ’&#34;</span><span>,</span> <span>&#34;ğŸ’&#34;</span><span>,</span> <span>&#34;ğŸ’&#34;</span><span>):</span> <span>return</span> <span>10</span>
        <span>case</span> <span>(</span><span>&#34;ğŸ‡&#34;</span><span>,</span> <span>&#34;ğŸ‡&#34;</span><span>,</span> <span>&#34;ğŸ‡&#34;</span><span>):</span> <span>return</span> <span>5</span>
        <span>case</span> <span>(</span><span>&#34;ğŸŠ&#34;</span><span>,</span> <span>&#34;ğŸŠ&#34;</span><span>,</span> <span>&#34;ğŸŠ&#34;</span><span>):</span> <span>return</span> <span>3</span>
        <span>case</span> <span>(</span><span>&#34;ğŸ‹&#34;</span><span>,</span> <span>&#34;ğŸ‹&#34;</span><span>,</span> <span>&#34;ğŸ‹&#34;</span><span>):</span> <span>return</span> <span>2</span>
        <span>case</span> <span>(</span><span>&#34;ğŸ’&#34;</span><span>,</span> <span>_</span><span>,</span> <span>_</span><span>),</span> <span>// Any cherry</span>
             <span>(</span><span>_</span><span>,</span> <span>&#34;ğŸ’&#34;</span><span>,</span> <span>_</span><span>),</span>
             <span>(</span><span>_</span><span>,</span> <span>_</span><span>,</span> <span>&#34;ğŸ’&#34;</span><span>):</span>
            <span>return</span> <span>1</span>
        <span>default</span><span>:</span>
            <span>return</span> <span>0</span>  <span>// Better luck next time</span>
        <span>}</span>
    <span>}</span>
<span>}</span>
</code></pre>
            <p>Should we play it?</p>
            
            <p>Now, we <em>could</em> work out these probabilities analytically â€”
              counting combinations,
              calculating conditional probabilities,
              maybe even busting out some combinatorics.</p>
            <p>Or we could just let the computer pull the lever a bunch and see what happens.</p>
            
            <pre data-lang="Swift"><code><span>let</span> <span>expected<wbr/>Payout</span> <span>=</span> <span>Uncertain</span><span>&lt;</span><span>Int</span><span>&gt;</span> <span>{</span>
    <span>Slot<wbr/>Machine</span><span>.</span><span>spin</span><span>()</span>
<span>}</span><span>.</span><span>expected<wbr/>Value</span><span>(</span><span>sample<wbr/>Count</span><span>:</span> <span>10_000</span><span>)</span>
<span>print</span><span>(</span><span>&#34;Expected value per spin: $</span><span>\(</span><span>expected<wbr/>Payout</span><span>)</span><span>&#34;</span><span>)</span>
<span>// Expected value per spin: â‰ˆ $0.56</span>
</code></pre>
            <p>At least we know one thing for certain:
              <em>The house always wins.</em></p>
            <h2>
              <a aria-hidden="true" id="beyond-simple-distributions" href="#beyond-simple-distributions"></a>Beyond Simple Distributions</h2>
            <p>While one-armed bandits demonstrate pure randomness,
              real-world applications often deal with more predictable uncertainty.</p>
            <p><code>Uncertain&lt;T&gt;</code> provides a
              <a href="https://github.com/mattt/Uncertain?tab=readme-ov-file#distribution-constructors">rich set of probability distributions</a>:</p>
            <pre data-lang="Swift"><code><span>// Modeling sensor noise</span>
<span>let</span> <span>raw<wbr/>Gyro<wbr/>Data</span> <span>=</span> <span>0.85</span>  <span>// rad/s</span>
<span>let</span> <span>gyro<wbr/>Reading</span> <span>=</span> <span>Uncertain</span><span>.</span><span>normal</span><span>(</span>
    <span>mean</span><span>:</span> <span>raw<wbr/>Gyro<wbr/>Data</span><span>,</span>
    <span>standard<wbr/>Deviation</span><span>:</span> <span>0.05</span>  <span>// Typical gyroscope noise in rad/s</span>
<span>)</span>

<span>// User behavior modeling</span>
<span>let</span> <span>user<wbr/>Will<wbr/>Tap<wbr/>Button</span> <span>=</span> <span>Uncertain</span><span>.</span><span>bernoulli</span><span>(</span><span>probability</span><span>:</span> <span>0.3</span><span>)</span>

<span>// Network latency with long tail</span>
<span>let</span> <span>api<wbr/>Response<wbr/>Time</span> <span>=</span> <span>Uncertain</span><span>.</span><span>exponential</span><span>(</span><span>rate</span><span>:</span> <span>0.1</span><span>)</span>

<span>// Coffee shop visit times (bimodal: morning rush + afternoon break)</span>
<span>let</span> <span>morning<wbr/>Rush</span> <span>=</span> <span>Uncertain</span><span>.</span><span>normal</span><span>(</span><span>mean</span><span>:</span> <span>8.5</span><span>,</span> <span>standard<wbr/>Deviation</span><span>:</span> <span>0.5</span><span>)</span>  <span>// 8:30 AM</span>
<span>let</span> <span>afternoon<wbr/>Break</span> <span>=</span> <span>Uncertain</span><span>.</span><span>normal</span><span>(</span><span>mean</span><span>:</span> <span>15.0</span><span>,</span> <span>standard<wbr/>Deviation</span><span>:</span> <span>0.8</span><span>)</span>  <span>// 3:00 PM</span>
<span>let</span> <span>visit<wbr/>Time</span> <span>=</span> <span>Uncertain</span><span>.</span><span>mixture</span><span>(</span>
    <span>of</span><span>:</span> <span>[</span><span>morning<wbr/>Rush</span><span>,</span> <span>afternoon<wbr/>Break</span><span>],</span>
    <span>weights</span><span>:</span> <span>[</span><span>0.6</span><span>,</span> <span>0.4</span><span>]</span>  <span>// Slightly prefer morning coffee</span>
<span>)</span>
</code></pre>
            
          <p><code>Uncertain&lt;T&gt;</code> also provides comprehensive
            <a href="https://github.com/mattt/Uncertain?tab=readme-ov-file#statistical-operations">statistical operations</a>:</p>
          <pre data-lang="Swift"><code><span>// Basic statistics</span>
<span>let</span> <span>temperature</span> <span>=</span> <span>Uncertain</span><span>.</span><span>normal</span><span>(</span><span>mean</span><span>:</span> <span>23.0</span><span>,</span> <span>standard<wbr/>Deviation</span><span>:</span> <span>1.0</span><span>)</span>
<span>let</span> <span>avg<wbr/>Temp</span> <span>=</span> <span>temperature</span><span>.</span><span>expected<wbr/>Value</span><span>()</span> <span>// about 23Â°C</span>
<span>let</span> <span>temp<wbr/>Spread</span> <span>=</span> <span>temperature</span><span>.</span><span>standard<wbr/>Deviation</span><span>()</span> <span>// about 1Â°C</span>

<span>// Confidence intervals</span>
<span>let</span> <span>(</span><span>lower</span><span>,</span> <span>upper</span><span>)</span> <span>=</span> <span>temperature</span><span>.</span><span>confidence<wbr/>Interval</span><span>(</span><span>0.95</span><span>)</span>
<span>print</span><span>(</span><span>&#34;95% of temperatures between </span><span>\(</span><span>lower</span><span>)</span><span>Â°C and </span><span>\(</span><span>upper</span><span>)</span><span>Â°C&#34;</span><span>)</span>

<span>// Distribution shape analysis</span>
<span>let</span> <span>network<wbr/>Delay</span> <span>=</span> <span>Uncertain</span><span>.</span><span>exponential</span><span>(</span><span>rate</span><span>:</span> <span>0.1</span><span>)</span>
<span>let</span> <span>skew</span> <span>=</span> <span>network<wbr/>Delay</span><span>.</span><span>skewness</span><span>()</span> <span>// right skew</span>
<span>let</span> <span>kurt</span> <span>=</span> <span>network<wbr/>Delay</span><span>.</span><span>kurtosis</span><span>()</span> <span>// heavy tail</span>

<span>// Working with discrete distributions</span>
<span>let</span> <span>dice<wbr/>Roll</span> <span>=</span> <span>Uncertain</span><span>.</span><span>categorical</span><span>([</span><span>1</span><span>:</span> <span>1</span><span>,</span> <span>2</span><span>:</span> <span>1</span><span>,</span> <span>3</span><span>:</span> <span>1</span><span>,</span> <span>4</span><span>:</span> <span>1</span><span>,</span> <span>5</span><span>:</span> <span>1</span><span>,</span> <span>6</span><span>:</span> <span>1</span><span>])</span><span>!</span>
<span>dice<wbr/>Roll</span><span>.</span><span>entropy</span><span>()</span>  <span>// Randomness measure (~2.57)</span>
<span>(</span><span>dice<wbr/>Roll</span> <span>+</span> <span>dice<wbr/>Roll</span><span>)</span><span>.</span><span>mode</span><span>()</span> <span>// Most frequent outcome (7, perhaps?)</span>

<span>// Cumulative probability</span>
<span>if</span> <span>temperature</span><span>.</span><span>cdf</span><span>(</span><span>at</span><span>:</span> <span>25.0</span><span>)</span> <span>&lt;</span> <span>0.2</span> <span>{</span>  <span>// P(temp â‰¤ 25Â°C) &lt; 20%</span>
    <span>print</span><span>(</span><span>&#34;Unlikely to be 25Â°C or cooler&#34;</span><span>)</span>
<span>}</span>
</code></pre>
          <p>The statistics are computed through sampling.
            The number of samples is configurable, letting you trade computation time for accuracy.</p>
          <h2>
            <a aria-hidden="true" id="putting-theory-to-practice" href="#putting-theory-to-practice"></a>Putting Theory to Practice</h2>
          <p>Users donâ€™t notice when things work correctly,
            but they definitely notice impossible behavior.
            When your running app claims they just sprinted at 45 mph,
            or your IRL meetup app shows someone 500 feet away when GPS accuracy is Â±1000 meters,
            thatâ€™s a bad look ğŸ¤¡</p>
          <p>So where do we go from here?
            Letâ€™s channel our Senior+ memes from before for guidance.</p>
          <p>That Staff engineer saying <em>â€œletâ€™s ship it and iterateâ€</em>
            is right about the incremental approach.
            You can migrate uncertain calculations piecemeal
            rather than rewriting everything at once:</p>
          <pre data-lang="Swift"><code><span>extension</span> <span>CLLocation</span> <span>{</span>
    <span>var</span> <span>uncertain</span><span>:</span> <span>Uncertain</span><span>&lt;</span><span>CLLocation</span><span>&gt;</span> <span>{</span>
        <span>Uncertain</span><span>&lt;</span><span>CLLocation</span><span>&gt;.</span><span>from</span><span>(</span><span>self</span><span>)</span>
    <span>}</span>
<span>}</span>

<span>// Gradually migrate critical paths</span>
<span>let</span> <span>is<wbr/>Nearby</span> <span>=</span> <span>(</span>
    <span>current<wbr/>Location</span><span>.</span><span>uncertain</span><span>.</span><span>distance</span><span>(</span><span>to</span><span>:</span> <span>destination</span><span>)</span> <span>&lt;</span> <span>threshold</span>
<span>)</span><span>.</span><span>probability</span><span>(</span><span>exceeds</span><span>:</span> <span>0.68</span><span>)</span>
</code></pre>
          <p>And we should consider the Principal engineerâ€™s warning of <em>â€œthat wonâ€™t scaleâ€</em>.
            Sampling has a cost, and you should understand the
            computational overhead for probabilistic accuracy:</p>
          <pre data-lang="Swift"><code><span>// Fast approximation for UI updates</span>
<span>let</span> <span>quick<wbr/>Estimate</span> <span>=</span> <span>speed</span><span>.</span><span>probability</span><span>(</span>
    <span>exceeds</span><span>:</span> <span>walking<wbr/>Speed</span><span>,</span>
    <span>max<wbr/>Samples</span><span>:</span> <span>100</span>
<span>)</span>

<span>// High precision for critical decisions</span>
<span>let</span> <span>precise<wbr/>Result</span> <span>=</span> <span>speed</span><span>.</span><span>probability</span><span>(</span>
    <span>exceeds</span><span>:</span> <span>walking<wbr/>Speed</span><span>,</span>
    <span>confidence<wbr/>Level</span><span>:</span> <span>0.99</span><span>,</span>
    <span>max<wbr/>Samples</span><span>:</span> <span>10_000</span>
<span>)</span>
</code></pre>
          
          <p>Start small.
            Pick one feature where GPS glitches cause user complaints.
            Replace your distance calculations with uncertain versions.
            Measure the impact.</p>
          <p>Remember:
            the goal isnâ€™t to eliminate uncertainty â€”
            itâ€™s to acknowledge that it exists and handle it gracefully.
            Because in the real world,
            nothing is certain except uncertainty itself.</p>
          <p>And perhaps,
            with better tools,
            we can finally stop pretending otherwise.</p>
        </div></div>
  </body>
</html>
