<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/ggerganov/llama.cpp/pull/3228">Original</a>
    <h1>M2 Ultra can run 128 streams of Llama 2 7B in parallel</h1>
    
    <div id="readability-page-1" class="page"><div disabled="" sortable="">
<div>
          <p dir="auto">I couldn&#39;t get the <code>./bin/parallel</code> external alternative-prompt file option to work using <code>-f file.txt</code> so I&#39;ve inserted a few lines into <code>parallel.cpp</code> to make it run. I am not a <code>C/C++</code> specialist so it probably won&#39;t pass any style tests (code at the end), but it does run on my <strong>M2 MAX 32GB</strong> and <strong>MacOS Sonoma 14.0</strong> from</p>
<div data-snippet-clipboard-copy-content="% ./build/bin/parallel -m ./models/llama-2-13b/ggml-model-q8_0.gguf -f &#34;ParallelQuestions.txt&#34; -n 128 -t 1 -c 8192 -s 4321 -ngl 100 -np 16 -ns 32 -cb"><pre><code>% ./build/bin/parallel -m ./models/llama-2-13b/ggml-model-q8_0.gguf -f &#34;ParallelQuestions.txt&#34; -n 128 -t 1 -c 8192 -s 4321 -ngl 100 -np 16 -ns 32 -cb
</code></pre></div>
<p dir="auto">A plain text file like this below saved into <code>/build/ParallelQuestions.txt</code> is then read in generically by <code>common.cpp</code> (with no alterations to the code) and transferred to replace the default <code>k_prompts</code> inside <code>parallel.cpp</code>.</p>
<div data-snippet-clipboard-copy-content="What do you know about Hobbits?
What is quantum field theory?
Why did the chicken cross the road?
Who is the president of the United States?
How do I run CMake on MacOS?
Do you agree that C++ is a really finicky language compared with Python3?
Is it a good idea to invest in technology?
Do you like Wagner&#39;s Ring?
Do you think this file input option is really neat?
What should we all do about climate change?"><pre><code>What do you know about Hobbits?
What is quantum field theory?
Why did the chicken cross the road?
Who is the president of the United States?
How do I run CMake on MacOS?
Do you agree that C++ is a really finicky language compared with Python3?
Is it a good idea to invest in technology?
Do you like Wagner&#39;s Ring?
Do you think this file input option is really neat?
What should we all do about climate change?
</code></pre></div>
<p dir="auto">Producing (sample only) output</p>
<div data-snippet-clipboard-copy-content="Now printing the k_prompts loaded from ParallelQuestions.txt that replace the default questions.

What do you know about Hobbits?
What is quantum field theory?
Why did the chicken cross the road?
Who is the president of the United States?
How do I run CMake on MacOS?
Do you agree that C++ is a really finicky language compared with Python3?
Is it a good idea to invest in technology?
Do you like Wagner&#39;s Ring?
Do you think this file input option is really neat?
What should we all do about climate change?


main: Simulating parallel requests from clients:
main: Evaluating the system prompt ...

Processing requests ...

main: clearing the KV cache
Client   0, seq    0, started decoding ...
Client   1, seq    1, started decoding ...
Client   2, seq    2, started decoding ...
Client   3, seq    3, started decoding ...
Client   4, seq    4, started decoding ...
Client   5, seq    5, started decoding ...
Client   6, seq    6, started decoding ...
Client   7, seq    7, started decoding ...
Client   8, seq    8, started decoding ...
Client   9, seq    9, started decoding ...
Client  10, seq   10, started decoding ...
Client  11, seq   11, started decoding ...
Client  12, seq   12, started decoding ...
Client  13, seq   13, started decoding ...
Client  14, seq   14, started decoding ...
Client  15, seq   15, started decoding ...
Client   7, seq    7/ 32, prompt   14 t, response   11 t, time  2.62 s, speed  9.54 t/s, cache miss 0  
Input:    Who is the president of the United States?
Response: The current President of the United States is Donald Trump.

Client  14, seq   14/ 32, prompt   14 t, response   11 t, time  2.63 s, speed  9.52 t/s, cache miss 0  
Input:    Who is the president of the United States?
Response: The current President of the United States is Donald Trump.

Client   7, seq   16, started decoding ...
Client  14, seq   17, started decoding ...
Client   7, seq   16/ 32, prompt   14 t, response   13 t, time  2.39 s, speed 11.28 t/s, cache miss 0  
Input:    Why did the chicken cross the road?
Response: The chicken crossed the road to get to the other side.

Client   7, seq   18, started decoding ...
Client  12, seq   12/ 32, prompt   14 t, response   30 t, time  5.87 s, speed  7.49 t/s, cache miss 0  
Input:    Who is the president of the United States?
Response: The current president of the United States is Joe Biden. He was sworn into office on January 20, 2021.

Client  12, seq   19, started decoding ...
Client  10, seq   10/ 32, prompt   13 t, response   35 t, time  6.73 s, speed  7.13 t/s, cache miss 0  
Input:    What should we all do about climate change?
Response: We should all work together to reduce our carbon footprint. We can do this by reducing our energy consumption, recycling more, and using public transportation whenever possible.

Client  10, seq   20, started decoding ...
Client   1, seq    1/ 32, prompt   14 t, response   42 t, time  7.93 s, speed  7.06 t/s, cache miss 0  
Input:    Why did the chicken cross the road?
Response: The chicken crossed the road to get to the other side. It is a classic joke that has been around for many years and is often used as an example of a riddle or paradox.

Client   1, seq   21, started decoding ...
Client  14, seq   17/ 32, prompt   14 t, response   36 t, time  6.36 s, speed  7.86 t/s, cache miss 0  
Input:    Who is the president of the United States?
Response: The president of the United States is Joe Biden. He was elected in November 2020 and took office on January 20, 2021.

Client  14, seq   22, started decoding ...
Client   0, seq    0/ 32, prompt   16 t, response   49 t, time  9.17 s, speed  7.09 t/s, cache miss 0  
Input:    Do you think this file input option is really neat?
Response: Yes, I think this file input option is really neat. It allows you to easily upload files from your computer or other devices and view them in the browser. This can be very useful when sharing large files or working with multiple documents at once.

Client   0, seq   23, started decoding ...
Client  10, seq   20/ 32, prompt   13 t, response   14 t, time  2.62 s, speed 10.29 t/s, cache miss 0  
Input:    Do you like Wagner&#39;s Ring?
Response: I do not know what &#34;Wagner&#39;s Ring&#34; is.

Client  10, seq   24, started decoding ...
Client   9, seq    9/ 32, prompt   22 t, response   56 t, time 10.42 s, speed  7.49 t/s, cache miss 0  
Input:    Do you agree that C++ is a really finicky language compared with Python3?
Response: I cannot agree or disagree with that statement because it is subjective and depends on the person who is asking the question. Some people may find C++ to be finicky, while others may not have any problems with it. Ultimately, it comes down to personal preference."><pre><code>Now printing the k_prompts loaded from ParallelQuestions.txt that replace the default questions.

What do you know about Hobbits?
What is quantum field theory?
Why did the chicken cross the road?
Who is the president of the United States?
How do I run CMake on MacOS?
Do you agree that C++ is a really finicky language compared with Python3?
Is it a good idea to invest in technology?
Do you like Wagner&#39;s Ring?
Do you think this file input option is really neat?
What should we all do about climate change?


main: Simulating parallel requests from clients:
main: Evaluating the system prompt ...

Processing requests ...

main: clearing the KV cache
Client   0, seq    0, started decoding ...
Client   1, seq    1, started decoding ...
Client   2, seq    2, started decoding ...
Client   3, seq    3, started decoding ...
Client   4, seq    4, started decoding ...
Client   5, seq    5, started decoding ...
Client   6, seq    6, started decoding ...
Client   7, seq    7, started decoding ...
Client   8, seq    8, started decoding ...
Client   9, seq    9, started decoding ...
Client  10, seq   10, started decoding ...
Client  11, seq   11, started decoding ...
Client  12, seq   12, started decoding ...
Client  13, seq   13, started decoding ...
Client  14, seq   14, started decoding ...
Client  15, seq   15, started decoding ...
Client   7, seq    7/ 32, prompt   14 t, response   11 t, time  2.62 s, speed  9.54 t/s, cache miss 0  
Input:    Who is the president of the United States?
Response: The current President of the United States is Donald Trump.

Client  14, seq   14/ 32, prompt   14 t, response   11 t, time  2.63 s, speed  9.52 t/s, cache miss 0  
Input:    Who is the president of the United States?
Response: The current President of the United States is Donald Trump.

Client   7, seq   16, started decoding ...
Client  14, seq   17, started decoding ...
Client   7, seq   16/ 32, prompt   14 t, response   13 t, time  2.39 s, speed 11.28 t/s, cache miss 0  
Input:    Why did the chicken cross the road?
Response: The chicken crossed the road to get to the other side.

Client   7, seq   18, started decoding ...
Client  12, seq   12/ 32, prompt   14 t, response   30 t, time  5.87 s, speed  7.49 t/s, cache miss 0  
Input:    Who is the president of the United States?
Response: The current president of the United States is Joe Biden. He was sworn into office on January 20, 2021.

Client  12, seq   19, started decoding ...
Client  10, seq   10/ 32, prompt   13 t, response   35 t, time  6.73 s, speed  7.13 t/s, cache miss 0  
Input:    What should we all do about climate change?
Response: We should all work together to reduce our carbon footprint. We can do this by reducing our energy consumption, recycling more, and using public transportation whenever possible.

Client  10, seq   20, started decoding ...
Client   1, seq    1/ 32, prompt   14 t, response   42 t, time  7.93 s, speed  7.06 t/s, cache miss 0  
Input:    Why did the chicken cross the road?
Response: The chicken crossed the road to get to the other side. It is a classic joke that has been around for many years and is often used as an example of a riddle or paradox.

Client   1, seq   21, started decoding ...
Client  14, seq   17/ 32, prompt   14 t, response   36 t, time  6.36 s, speed  7.86 t/s, cache miss 0  
Input:    Who is the president of the United States?
Response: The president of the United States is Joe Biden. He was elected in November 2020 and took office on January 20, 2021.

Client  14, seq   22, started decoding ...
Client   0, seq    0/ 32, prompt   16 t, response   49 t, time  9.17 s, speed  7.09 t/s, cache miss 0  
Input:    Do you think this file input option is really neat?
Response: Yes, I think this file input option is really neat. It allows you to easily upload files from your computer or other devices and view them in the browser. This can be very useful when sharing large files or working with multiple documents at once.

Client   0, seq   23, started decoding ...
Client  10, seq   20/ 32, prompt   13 t, response   14 t, time  2.62 s, speed 10.29 t/s, cache miss 0  
Input:    Do you like Wagner&#39;s Ring?
Response: I do not know what &#34;Wagner&#39;s Ring&#34; is.

Client  10, seq   24, started decoding ...
Client   9, seq    9/ 32, prompt   22 t, response   56 t, time 10.42 s, speed  7.49 t/s, cache miss 0  
Input:    Do you agree that C++ is a really finicky language compared with Python3?
Response: I cannot agree or disagree with that statement because it is subjective and depends on the person who is asking the question. Some people may find C++ to be finicky, while others may not have any problems with it. Ultimately, it comes down to personal preference.
</code></pre></div>
<p dir="auto">The additional lines of code (does C++ not have a .split(&#34;\n&#34;) predefined function?):</p>
<div data-snippet-clipboard-copy-content="// Define a split string function to ...
    std::vector&lt;std::string&gt; splitString(const std::string&amp; input, char delimiter) {
        std::vector&lt;std::string&gt; tokens;
        std::istringstream stream(input);
        std::string token;
        while (std::getline(stream, token, delimiter)) {
            tokens.push_back(token);
        }
        return tokens;
    }"><pre><code>// Define a split string function to ...
    std::vector&lt;std::string&gt; splitString(const std::string&amp; input, char delimiter) {
        std::vector&lt;std::string&gt; tokens;
        std::istringstream stream(input);
        std::string token;
        while (std::getline(stream, token, delimiter)) {
            tokens.push_back(token);
        }
        return tokens;
    }
</code></pre></div>
<p dir="auto">And then somewhere suitable inside <code>main()</code> and before <code>k_prompts</code> is used, in my case roughly at line 125:</p>
<div data-snippet-clipboard-copy-content="    // load the prompts from an external file if there are any
    // these have been acquired by `common.cpp` and put into `params.prompt`
    // by parsing `-f ParallelQuestions.txt` in lines 150-164

    if (params.prompt.empty()) {
        std::cout &lt;&lt; &#34;\n\033[32mNo new questions so proceed with build-in defaults.\033[0m&#34;;
    } else {
        // Output each line of the input params.prompts vector and copy to k_prompts
        int index = 0;
        std::cout &lt;&lt; &#34;\nNow printing the external prompt file\n\n&#34;;

        std::vector&lt;std::string&gt; prompts = splitString(params.prompt, &#39;\n&#39;);
        for (const auto&amp; prompt : prompts) {
            k_prompts.resize(index + 1);
            k_prompts[index] = prompt;
            index++;
            std::cout &lt;&lt; index &lt;&lt; &#34; prompt: &#34; &lt;&lt; prompt &lt;&lt; std::endl;
        }

        // Output each line of the updated k_prompts vector (diagnostic - non-functional)
        std::cout &lt;&lt; &#34;\n\033[33mNow printing the k_prompts loaded from an external file that replace the default questions.\033[0m\n\n&#34;;
        for (const auto&amp; prompt : k_prompts) {
            std::cout &lt;&lt; prompt &lt;&lt; std::endl;
        }
    }"><pre><code>    // load the prompts from an external file if there are any
    // these have been acquired by `common.cpp` and put into `params.prompt`
    // by parsing `-f ParallelQuestions.txt` in lines 150-164

    if (params.prompt.empty()) {
        std::cout &lt;&lt; &#34;\n\033[32mNo new questions so proceed with build-in defaults.\033[0m&#34;;
    } else {
        // Output each line of the input params.prompts vector and copy to k_prompts
        int index = 0;
        std::cout &lt;&lt; &#34;\nNow printing the external prompt file\n\n&#34;;

        std::vector&lt;std::string&gt; prompts = splitString(params.prompt, &#39;\n&#39;);
        for (const auto&amp; prompt : prompts) {
            k_prompts.resize(index + 1);
            k_prompts[index] = prompt;
            index++;
            std::cout &lt;&lt; index &lt;&lt; &#34; prompt: &#34; &lt;&lt; prompt &lt;&lt; std::endl;
        }

        // Output each line of the updated k_prompts vector (diagnostic - non-functional)
        std::cout &lt;&lt; &#34;\n\033[33mNow printing the k_prompts loaded from an external file that replace the default questions.\033[0m\n\n&#34;;
        for (const auto&amp; prompt : k_prompts) {
            std::cout &lt;&lt; prompt &lt;&lt; std::endl;
        }
    }
</code></pre></div>
      </div>
</div></div>
  </body>
</html>
