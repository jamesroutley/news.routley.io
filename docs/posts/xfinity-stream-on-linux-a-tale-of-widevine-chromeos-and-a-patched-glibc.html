<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://thebrokenrail.com/2022/12/31/xfinity-stream-on-linux.html">Original</a>
    <h1>Xfinity Stream on Linux: A Tale of Widevine, ChromeOS, and a patched Glibc</h1>
    
    <div id="readability-page-1" class="page"><div>
      
        <header>
          
          

  <p>
    

    

    
      
      

      <span>
        <i aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


        </header>
      

      <section itemprop="text">
        
        <p><img src="https://thebrokenrail.com/assets/images/blog/xfinity-stream-on-linux/working.png" alt="Working Xfinity Stream"/></p>

<p><em>(If you want to skip to the tutorial, <a href="#how-do-i-actually-do-this">click here</a>.)</em></p>

<p>If your household uses Xfinity for cable, you have almost definitely heard of <a href="https://www.xfinity.com/stream/">Xfinity Stream</a> at some point. If you haven’t, Xfinity Stream is a service that allows you to access Xfinity’s on-demand TV over the internet. This can be useful if you want to watch something on Xfinity’s on-demand TV but do not want to go to your actual TV.</p>

<p>This is nice because some media still goes to on-demand before its respective streaming service (if it even has one). And of course, if you are already paying for Xfinity, it is nice not to have to pay for another streaming service if you can avoid it.</p>

<p>However, it has some limitations as well, mainly that you can only access it on your local Xfinity network… and its completely arbitrary Linux block. That’s right, if you have ever tried to load Xfinity Stream on Linux, you will have seen this lovely error message:</p>

<p><img src="https://thebrokenrail.com/assets/images/blog/xfinity-stream-on-linux/broken.png" alt="Broken Xfinity Stream"/></p>

<p>And if you look up that error message, you will find <a href="https://forums.xfinity.com/conversations/xfinity-stream-website/what-is-error-player900214007/602db156c5375f08cd4d3380">a common theme</a>: Xfinity Stream does not support Linux.</p>

<p>Also of note is that Xfinity Stream will <a href="https://www.reddit.com/r/linux/comments/q8mvb3/xfinity_stream_fully_blocks_linux_its_not_a/">refuse to load at all</a> on Google Chrome without changing your user-agent, but it will load on Firefox, just for it to fail when you try to watch anything.</p>

<h2 id="how-does-it-block-linux">How does it block Linux?</h2>

<p>One of the first methods I tried to use to bypass this block was changing my user-agent… just for the block to persist anyways. Which raised the question “how does Xfinity know I am running Linux?” Because if I can trick it into thinking I am running Windows or MacOS, then it should not be able to block me anymore.</p>

<p>So I dug into Firefox’s network logs, which led me to the source of the error:</p>

<p><img src="https://thebrokenrail.com/assets/images/blog/xfinity-stream-on-linux/license-request.png" alt="Widevine License Request"/></p>

<p>This <code>POST</code> request was generated using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/MediaKeySession/generateRequest"><code>MediaKeySession.generateRequest()</code></a> API, which isn turn used the browser’s built-in <a href="https://developers.google.com/widevine/drm/overview">Widevine CDM</a> to generate a DRM license request. At this point, I had formed a hypothesis: the Linux build of the Widevine CDM was embedding metadata into this request which Xfinity was using to block Linux.</p>

<h2 id="how-do-i-bypass-that">How do I bypass that?</h2>

<p>Unfortunately, just patching the Widevine CDM’s binary is beyond my skill set, especially since it is ridiculously obfuscated.</p>

<p>However, I eventually came to a realization: Xfinity Stream probably does not block Chrome OS, and Chrome OS is basically GNU/Linux internally. So I formed a plan: extract Chrome OS’s Widevine CDM from a recovery image, load it into Firefox, and try to use Xfinity Stream.</p>

<p>It did not work, at all.</p>

<p>The Widevine CDM immediately crashed, and when I tried to load it into a standalone program using <code>dlopen()</code>, it caused a segmentation fault before it even finished loading. This incredibly vague error stumped me for a while until I found <a href="https://github.com/xbmc/inputstream.adaptive/issues/678">this</a> incredibly helpful GitHub issue from a project that was trying to do something similar.</p>

<p>This GitHub issue revealed the problem: Chrome OS was not <em>exactly</em> GNU/Linux. Namely, it was complied with a feature that was not included in my version of <code>glibc</code> that Google had patched into their version: the <code>DT_RELR</code> relocation format.</p>

<p>With some more research, I learned that <code>glibc</code> had actually merged support for this feature in version 2.36! So I loaded Ubuntu 22.10 on a USB flash drive and tried loading Chrome OS’s Widevine CDM into my testing program again.</p>

<p>And it <em>still</em> did not work.</p>

<p>This time the error was slightly more helpful though: <code>DT_RELR without GLIBC_ABI_DT_RELR dependency</code>.</p>

<h2 id="what-in-the-world-is-a-glibc_abi_dt_relr-dependency">What in the world is a <code>GLIBC_ABI_DT_RELR</code> dependency?</h2>

<p>It turns out, the <code>glibc</code> maintainers <a href="https://maskray.me/blog/2021-10-31-relative-relocations-and-relr#time-travel-compatibility">actually agreed</a> with my earlier assessment: immediately causing a segmentation fault on older versions of <code>glibc</code> just because a program used the <code>DT_RELR</code> relocation format was not good behavior.</p>

<p>They decided that for every binary compiled with the <code>DT_RELR</code> relocation format, the linker would include a version dependency called <code>GLIBC_ABI_DT_RELR</code> on <code>libc.so.6</code>. This would cause any program using the <code>DT_RELR</code> relocation format to give a more sane error on older versions of <code>glibc</code>: <code>/lib/x86_64-linux-gnu/libc.so.6: version `GLIBC_ABI_DT_RELR&#39; not found (required by ./program)</code>.</p>

<p>However, the <code>glibc</code> maintainers also decided to implement this functionality in reverse as well: <code>glibc</code> refuses to load any binary containing the <code>DT_RELR</code> relocation format that does not also contain the <code>GLIBC_ABI_DT_RELR</code> version dependency. I do not know why they did this, but this is what caused the previous error. This is because Chrome OS’s toolchain evidently predates <code>GLIBC_ABI_DT_RELR</code> so it was never included when linking the Widevine CDM.</p>

<p>Originally, I tried to patch the Widevine CDM binary to include the <code>GLIBC_ABI_DT_RELR</code> version dependency using <a href="https://github.com/lief-project/LIEF">LIEF</a>. However, the resulting binary was invalid and caused a segmentation fault when started. Ultimately, I decided to instead remove the check itself from <code>&#39;glibc</code> manually.</p>

<p>The <code>GLIBC_ABI_DT_RELR</code> check was quite trivial to patch out of <code>glibc</code> (although waiting for <code>glibc</code> to compile was certainly tedious). And once done, I was able to load up Firefox with Chrome OS’s Widevine CDM… and Xfinity Stream finally worked on Linux!</p>

<h2 id="how-do-i-actually-do-this">How do I actually do this?</h2>

<ol>
  <li>Install a Linux distribution that contains <code>glibc</code> v2.36 or higher. I would also recommend taking a backup or using a more disposable installation medium such as a USB flash drive or a VM.
    <ul>
      <li>You could use an older version of <code>glibc</code> if you really want to, but you would have to patch in support for the <code>DT_RELR</code> relocation format yourself.</li>
    </ul>
  </li>
  <li>Use this script to patch <code>glibc</code> (this script is Debian-specific, but it should not be too hard to adapt it to other distributions):
    <div><div><pre><code><span>#!/bin/sh</span>

<span>set</span> <span>-e</span>

<span># Create Working Directory</span>
<span>rm</span> <span>-rf</span> glibc-work
<span>mkdir </span>glibc-work
<span>cd </span>glibc-work

<span># Download Sources</span>
apt-get <span>source </span>glibc
<span>cd </span>glibc-<span>*</span>

<span># Patch</span>
patch <span>-p1</span> <span>&lt;&lt;</span> <span>EOF</span><span>
--- glibc-master-old/elf/dl-version.c
+++ glibc-master/elf/dl-version.c
@@ -362,7 +362,7 @@
   /* When there is a DT_VERNEED entry with libc.so on DT_NEEDED, issue
      an error if there is a DT_RELR entry without GLIBC_ABI_DT_RELR
      dependency.  */
-  if (dyn != NULL
+  if (0 &amp;&amp; dyn != NULL
       &amp;&amp; map-&gt;l_info[DT_NEEDED] != NULL
       &amp;&amp; map-&gt;l_info[DT_RELR] != NULL
       &amp;&amp; __glibc_unlikely (!map-&gt;l_dt_relr_ref))
</span><span>EOF

</span><span># Commit Patch</span>
<span>EDITOR</span><span>=</span><span>&#39;/bin/true&#39;</span> dpkg-source <span>-q</span> <span>--commit</span> <span>.</span> disable-GLIBC_ABI_DT_RELR-check.patch

<span># Update Package Version</span>
<span>EMAIL</span><span>=</span><span>&#39;example@example.com&#39;</span> dch <span>-n</span> <span>&#39;Disable GLIBC_ABI_DT_RELR Check&#39;</span>

<span># Disable Testing</span>
<span>export </span><span>DEB_BUILD_OPTIONS</span><span>=</span>nocheck

<span># Build</span>
dpkg-buildpackage <span>-us</span> <span>-uc</span>

<span># Install</span>
<span>sudo </span>apt-get <span>install</span> <span>-y</span> ../<span>*</span>.deb
</code></pre></div>    </div>
  </li>
  <li><a href="https://chromiumdash.appspot.com/serving-builds?deviceCategory=Chrome%20OS">Download</a> an x86_64 Chrome OS recovery image. I used the stable version of <code>atlas</code>, which was Chrome OS v107 at the time of writing.</li>
  <li>Extract <code>/opt/google/chrome/WidevineCdm/_platform_specific/cros_x64/libwidevinecdm.so</code> from the image.</li>
  <li>Browser-specific steps:
    <ul>
      <li>Google Chrome
        <ol>
          <li>Copy <code>libwidevinecdm.so</code> to <code>/opt/google/chrome/WidevineCdm/_platform_specific/linux_x64/libwidevinecdm.so</code>.</li>
          <li>You will need to use the Chrome Developer Tools user-agent switcher when using Xfinity Stream. Other user-agent switcher extensions do not appear to work.</li>
        </ol>
      </li>
      <li>Firefox
        <ol>
          <li><a href="https://www.omgubuntu.co.uk/2022/04/how-to-install-firefox-deb-apt-ubuntu-22-04">Install</a> a non-Snap/Flatpak version of Firefox. This is needed because we need Firefox (and therefore the Widevine CDM) to use the host’s <code>glibc</code>.</li>
          <li>If you are using the Firefox build from <code>ppa:mozillateam/ppa</code>, you will also need to <a href="https://askubuntu.com/a/1439304">modify Firefox’s AppArmor configuration</a> so that the Widevine CDM does not crash.</li>
        </ol>
      </li>
    </ul>
  </li>
  <li>Use Xfinity Stream!</li>
  <li>You will need to re-patch <code>glibc</code> every time your distribution releases an updated version.</li>
</ol>

<h2 id="conclusion">Conclusion</h2>

<p>All in all, this whole situation is ridiculous. It should not be <em>this</em> much harder to access media legally than it is to pirate. It is insane how much effort we as a species waste on this DRM that <em>does not stop anybody</em>. If I wanted to pirate anything, I could probably pull up a high-resolution copy in under an hour with minimal effort. But instead, because I tried to access this media the legal way, I have to either go through this whole complicated process or set up an entirely different operating system solely for that purpose. That is so unbelievably silly. The only reason I can remotely justify the time spent on this is because it was more enjoyable than watching whatever it was I was originally planning to watch!</p>

<p>In all honesty, if you want to use Xfinity Stream, I would recommend just setting up a Windows VM. It will probably be much more resistant to whatever nonsense Xfinity or Google try to pull in the future. But if you would rather not watch it at all than set up a Windows VM like me, well here is your method.</p>

        
      </section>

      

      


      
    </div></div>
  </body>
</html>
