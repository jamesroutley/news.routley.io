<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://goteleport.com/blog/security-hardening-ssh-bastion-best-practices/">Original</a>
    <h1>SSH Bastion Host Best Practices</h1>
    
    <div id="readability-page-1" class="page"><article>
      
      <a href="https://goteleport.com/blog/index.xml"><i></i></a>
      
      

        

<p><img src="https://goteleport.com/blog/images/2022/hardening-ssh-bastion@2x.png" alt="Best practices to create a security hardening SSH bastion hosts"/></p>

<p>SSH bastion hosts are an indispensable security enforcement stack for secure infrastructure access. Every security compliance standard that deals with remote infrastructure access (e.g., FedRAMP AC-17 - Remote Access, HIPAA §164.312(a)(1) - Access control, SOC2 CC6.1 - Manage Points of Access) mandates preventing direct network access to the servers and APIs. Although it is relatively easy to deploy a bastion host in your infrastructure, it should be noted that securing a bastion host requires careful consideration from design to deployment. After all, bastion hosts are the first target for attackers looking to compromise access to infrastructure.</p>

<p>This blog post focuses on following best practices on building and deploying a secure SSH bastion server based on OpenSSH. If you are looking for a quick guide on creating an SSH bastion, check our previous blog post on <a href="https://goteleport.com/blog/ssh-bastion-host/">setting up an SSH Bastion</a>.</p>

<h2 id="bastion-host-attack-surface">Bastion host attack surface</h2>

<p>Adversaries can either compromise a bastion host (e.g. OS and network exploitation) or find a network policy misconfiguration that allows bypassing the bastion host entirely. Thus, security of both the server deployed as a bastion host and the network in which the bastion host will be placed must be carefully considered as an attack surface for bastion host exploitation.</p>

<p>Since the services behind the bastion are configured to trust incoming connections from the bastion host, principles of zero trust networking should be applied so that incoming connections from the bastion host are further verified, which would help in case the bastion host is already compromised.</p>

<h2 id="designing-and-building-the-bastion-host">Designing and building the bastion host</h2>

<p>The end capability of the bastion host depends on the use case of infrastructure access. For example, access requirements via bastion for a database server can be different than those for a Windows server. For generic use cases, Linux OS with an OpenSSH server is one of the popular choices for setting up a bastion host. OpenSSH lets you connect to any service with SSH and port forwarding features, making it the most versatile solution. However, this setup is pretty limited if you want protocol-level control and visibility.</p>

<p>Overall, the core concept of security hardening a bastion host is to run a bastion server with minimal components and reduce the attack surface as much as possible. As you will find below, most of the controls required to secure bastion hosts are, in fact, the same as hardening an operating system. Below, we present a few important things to consider while designing a bastion host.</p>

<h3 id="picking-up-the-right-server-os">Picking up the right Server OS</h3>

<p>Quickly checking with <code>$ dpkg-query -W | wc -l</code> command shows there are 567 packages pre-installed in a fresh AWS Ubuntu 20.04 LTS server image. Similarly, <code>$ yum list installed | wc -l</code> command shows there are 453 packages pre-installed in a fresh AWS Amazon Linux 2 server image. Your bastion host may not need all of these packages! It is a good practice to review all of the pre-installed packages and remove those that are not required for your bastion host.</p>

<p>A rule of thumb is to use minimal OS images and installation packages as required. For example, refer to these websites that should guide you in installing a minimal OS: <a href="https://help.ubuntu.com/community/Installation/MinimalCD">ubuntu minimal</a>, <a href="https://www.debian.org/CD/netinst/">debian netinst</a>, and <a href="https://wiki.centos.org/Download">centos</a>. As for picking up the right distribution, understand that any system is as secure as how properly you know the system and configure it. If you or your team are comfortable with any particular OS, go for it.</p>

<h3 id="limiting-active-services-that-run-on-the-os">Limiting active services that run on the OS</h3>

<p>Once the right server OS is used, ensure that only required services are installed and run. For example, an SSH bastion host should only be running <code>sshd</code> daemon and nothing else. Running unnecessary services only increases the attack surface of the bastion host.
To quickly view active and running services under <strong>Systemd</strong>, use the following <code>systemctl</code> command:</p>
<pre><code>$ systemctl list-units --type=service --state=running</code></pre>
<p>Alternatively, you can also use the process status command <a href="https://man7.org/linux/man-pages/man1/ps.1.html"><code>ps</code></a> such as <code>$ ps aux</code>, <a href="https://man7.org/linux/man-pages/man1/top.1.html"><code>top</code></a>, or <a href="https://man7.org/linux/man-pages/man1/htop.1.html"><code>htop</code></a> commands to list running processes. These commands help you identify all the running processes and services and stop or remove them as required.</p>

<h3 id="lock-down-os-networking-capabilities">Lock down OS networking capabilities</h3>

<p>Similar to limiting active services on the bastion host, limit networking capabilities and lock down all the ports with a deny all strategy. In the case of the bastion host configured with OpenSSH, only allow ingress to SSH (port 22 or a custom port if the default is changed) and egress to the upstream SSH server. For managing ingress and egress traffic, nothing beats the power of the native <a href="https://www.netfilter.org/projects/iptables/index.html">netfilter iptables</a>. A quick check with the iptables command <code>$ iptables -L</code> will show you if the network firewall has been configured. To only allow SSH from a specific IP address, use the following <code>iptables</code> command:</p>
<pre><code>$ iptables -A INPUT -p tcp -s your-ip-address --dport 22 -j ACCEPT</code></pre>
<p>If you prefer simplicity, you can also use <a href="https://help.ubuntu.com/community/UFW">UFW</a>, which vastly simplifies iptables management. Another handy Linux tool to view open network ports is <a href="https://man7.org/linux/man-pages/man8/lsof.8.html"><code>lsof</code></a>. <code>lsof</code> lists the process ID of a service that is listening on a particular port. For example, to list open TCP ports that are in a listening state, use the following <code>lsof</code> command:</p>
<pre><code>$ lsof -i -P -n | grep LISTEN</code></pre>
<h3 id="limiting-user-accounts-and-restricting-account-capabilities">Limiting user accounts and restricting account capabilities</h3>

<p>In a bastion host, sparingly create extra user accounts. If you need a user account besides an administrative root account, enforce access controls using <a href="https://www.redhat.com/en/topics/linux/what-is-selinux">SELinux</a> or <a href="https://man7.org/linux/man-pages/man7/capabilities.7.html">Capabilities</a>. If a user account is required to run a specific service, make sure to  disable shell access. This can be done in ubuntu using the <code>usermod</code> command:</p>
<pre><code>$ usermod &lt;username&gt; -s /sbin/nologin</code></pre>
<h3 id="implement-access-logging">Implement access logging</h3>

<p>OS authentication events are logged by default. You can check auth events in Debian systems under <code>/var/log/auth.log</code> and <code>/var/log/secure</code> on centos/RHEL systems.</p>
<pre><code>[<a href="https://goteleport.com/cdn-cgi/l/email-protection" data-cfemail="61130e0e152102040f150e12">[email protected]</a> ~]# tail /var/log/secure
Dec 30 06:21:51 centos sshd[1287]: Server listening on 0.0.0.0 port 22.
Dec 30 06:21:51 centos sshd[1287]: Server listening on :: port 22.
Dec 30 06:22:21 centos sshd[5012]: Accepted publickey for root from 122.254.81.217 port 54660 ssh2: RSA SHA256:55nl8iEyh3L2trQhhc4aq+5qgEAdM0mnmYIYC7g/k6Y
Dec 30 06:22:21 centos systemd[5100]: pam_unix(systemd-user:session): session opened for user root by (uid=0)
Dec 30 06:22:21 centos sshd[5012]: pam_unix(sshd:session): session opened for user root by (uid=0)
Dec 30 06:41:39 centos sshd[13532]: error: kex_exchange_identification: Connection closed by remote host</code></pre>
<p>These logs are limited to authentication events only, and if you want to get more detailed access and accounting events, <a href="https://linux.die.net/man/8/auditd"><code>auditd</code></a> is a popular choice. <code>auditd</code> hooks to the syscall and logs system call events such as opening and closing files. Since everything is a file on the Linux system, it means <code>auditd</code> can capture process, networking, and file events.</p>

<p>One of the challenges with logging events is related to log storage. Storing logs on the same server is risky since root users can alter them, or the files can be destroyed during system crashes. These logs should be shipped to an external centralized logging server. <a href="https://www.elastic.co/what-is/elk-stack">ELK stack</a> and <a href="https://www.graylog.org/products/open-source">Graylog</a> are popular choices for storing access logs.</p>

<h3 id="limit-the-requirement-to-log-in-to-bastion-host">Limit the requirement to log in to bastion host</h3>

<p>It is easier to lock down the OS when you limit the requirement for users to log in to the bastion host. For instance, the requirement to troubleshoot and debug servers is one of the reasons SSH access is preferred. It may be tempting for an administrator to SSH into a bastion host for debugging and troubleshooting purposes, but it creates security risks because allowing SSH access opens up one additional attack vector.</p>

<p>To overcome this, implement proper debug logging into the remote log server and prioritize immutable infrastructure principles. To patch the server, rather than updating the bastion host during runtime, create a new bastion image with the required patch and replace the old bastion host with the new updated one.</p>

<h3 id="implement-a-host-intrusion-detection-system">Implement a Host Intrusion Detection System</h3>

<p>Host Intrusion Detection Systems (HIDS) are best for detecting anomalies in operating systems. Most modern IDS also help enforce security policies and implement security baselines. <a href="https://www.ossec.net/">OSSEC</a> and <a href="https://wazuh.com/">Wazuh</a> are two popular open-source projects for host security monitoring.</p>

<h2 id="hardening-openssh-server">Hardening OpenSSH server</h2>

<p>Since we are focusing on a bastion host based on the OpenSSH server, below we list some of the best practices to harden the OpenSSH server. If your bastion host is not based on the OpenSSH server, follow best practices to harden the configurations of that server.</p>

<h3 id="update-default-configurations-that-may-pose-security-risks">Update default configurations that may pose security risks</h3>

<p>In the <code>sshd_config</code> file found under <code>/etc/ssh/sshd_config</code>, update the defaults to disable root login, disable password authentication, configure an idle timeout, and whitelist SSH users as shown below.</p>
<div><pre><code data-lang="bash"><span># Disable root ssh acces</span>
PermitRootLogin no

<span># Disable password login</span>
PasswordAuthentication no
AuthenticationMethods publickey,keyboard-interactive:pam

<span># Configure idle time logout</span>
ClientAliveInterval &lt;value in seconds&gt;

<span># Explicitly Allow SSH users</span>
AllowUsers &lt;user names&gt;</code></pre></div>
<h3 id="safe-cryptographic-operations">Safe cryptographic operations</h3>

<p>OpenSSH supports many cryptographic algorithms that may be outdated or vulnerable. Following are a few tasks to ensure our OpenSSH is configured with the most robust cryptographic algorithms and operations.</p>

<ul>
<li><p>Regenerate server host keys.</p>
<pre><code>$ ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key -N &#34;&#34;
$ ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N &#34;&#34;</code></pre></li>

<li><p>Deactivate Diffie-Hellman short moduli.</p>
<pre><code>$ awk &#39;$5 &gt;= 3071&#39; /etc/ssh/moduli &gt; /etc/ssh/moduli.tmp &amp;&amp; mv /etc/ssh/moduli.tmp /etc/ssh/moduli`</code></pre>
<p>This will ensure that DH moduli less than 3071 bits are never used for DH exchange.</p></li>

<li><p>Use strong ciphers and algorithms.</p></li>
</ul>

<h3 id="use-second-factor-authentication">Use second-factor authentication</h3>

<p>Probably the simplest yet most effective control is to implement a second factor authentication in your SSH server. Google’s <a href="https://goteleport.com/blog/how-to-setup-ssh-2fa/">Google Authenticator PAM</a> module is the popular choice. But it only supports TOTP-based authentication. For more robust authentication, opt for solutions that enable authentication based on <a href="https://www.yubico.com/authentication-standards/fido-u2f/">U2F</a> or <a href="https://en.wikipedia.org/wiki/WebAuthn">WebAuthn</a> for SSH.</p>

<h3 id="use-certificates-for-user-authentication">Use certificates for user authentication</h3>

<p>Certificate-based authentication for SSH solves key management issues that come with key-based authentication and adds the additional security of time-scoped access and the ability to revoke access on the fly. While maintaining a Certificate Authority is equally challenging, there are solutions that completely automate CA management for SSH. Read our previous article on how to properly implement <a href="https://goteleport.com/blog/ssh-certificates/">certificate-based authentication for SSH</a>.</p>

<h2 id="deploying-the-bastion-host">Deploying the bastion host</h2>

<p>The placement of bastion hosts in the infrastructure plays an important role in the overall security of bastion hosts. Improper network configuration may allow attackers to completely bypass the bastion host and directly reach their target server. Additionally, insufficient resources may give attackers the chance to execute Denial of Service attacks which may cause service downtime.</p>

<h3 id="ensuring-high-availability-of-the-bastion-host">Ensuring high availability of the bastion host</h3>

<p>Adhering to the Confidentiality, Integrity, and Availability (CIA) triad, security controls should enhance the availability of the service — not vice versa. Since access via bastion hosts is the only way in, the availability of bastion hosts plays a critical role. Ensure adequate server and network resources are allocated for the bastion host. A multi-node deployment and setting up multiple availability zones are effective ways to ensure the availability of bastion hosts.</p>

<h3 id="addressing-latency-issues">Addressing latency issues</h3>

<p>Nobody likes slow access to remote servers. In fact, latency issues are one of the reasons many users prefer fast access solutions over secure solutions. If your teams are distributed, latency can be a serious issue for users who access infrastructure from different geographical zones. Since the network route within cloud providers is usually fast, the latency problem can be solved by placing the bastion host closer to the user’s nearest cloud availability zone.</p>

<h3 id="protection-from-ddos">Protection from DDOS</h3>

<p>Since bastion hosts are exposed to the internet, they are a good target for Distributed Denial of Service (DDOS) attacks. Protection from DDOS attacks is not an easy task, and if the attack vector includes flooding the service with multiple gigabits, chances are your bastion host will not survive them unless your infrastructure sits behind a DDOS protection service. Microsoft reported they were recently the victim of <a href="https://azure.microsoft.com/en-us/blog/business-as-usual-for-azure-customers-despite-24-tbps-ddos-attack/">2.4 TBPS DDOS attack</a>. If your bastion provides access to mission-critical service, it is worth purchasing a DDOS protection service.</p>

<h2 id="conclusion">Conclusion</h2>

<p>We walked you through designing, building, and deploying a bastion host based on an OpenSSH server in this post. The important things to consider are running the bastion host with minimal essential services, user accounts, and networking capabilities and deploying the bastion host as a highly available server.</p>

<p>Although this setup is pretty versatile, we mentioned that its capabilities are limited if you want protocol-level control and visibility. We built <a href="https://goteleport.com/">Teleport</a> to solve this problem and give a deep protocol-level control to infrastructure access. Teleport is a modern bastion server and allows unifying access for SSH and Windows servers, Kubernetes clusters, web applications, and databases across all environments. Further, Teleport is an open-source project, and everything is <a href="https://github.com/gravitational/teleport">designed and developed in the open</a>. Find out more <a href="https://goteleport.com/case-study/">here</a> about how Teleport is used in production.</p>



<div id="email-subscribe">
  <div>
    
    <p id="email-subtitle">
      Every other week we&#39;ll send a newsletter with the latest cybersecurity
      news and Teleport updates.
    </p>
    
  </div>
</div>


        
        
        <p><strong>Related Posts</strong></p>
          <ul>
            
            <li><a href="https://goteleport.com/blog/how-to-setup-ssh-2fa/">Set Up TOTP-Based Two-Factor Authentication for SSH Using Google Authenticator</a></li>
            
            <li><a href="https://goteleport.com/blog/ssh-client-config-file-example/">SSH Client Config File Example</a></li>
            
            <li><a href="https://goteleport.com/blog/5-ssh-best-practices/">5 Best Practices for Securing SSH</a></li>
            
          </ul>
        

        
        
        <a href="https://goteleport.com/tags/ssh/">ssh</a>
        
        <a href="https://goteleport.com/tags/bastion/">bastion</a>
        

      
      
       
      </article></div>
  </body>
</html>
