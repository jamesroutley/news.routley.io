<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gricha.dev/blog/the-highest-quality-codebase">Original</a>
    <h1>Show HN: I&#39;ve asked Claude to improve codebase quality 200 times</h1>
    
    <div id="readability-page-1" class="page"><div><p>Have you seen one of <a href="https://www.reddit.com/r/ChatGPT/comments/1kbj71z/i_tried_the_create_the_exact_replica_of_this/?utm_source=chatgpt.com" target="_blank" rel="noopener noreferrer">the experiments</a> where people have been re-feeding the same image to the AI agent a bunch of times?</p>
<p>Or Marques Brownlee&#39;s youtube videos where the <a href="https://www.youtube.com/watch?v=JR4KHfqw-oE" target="_blank" rel="noopener noreferrer">video is reuploaded a 1000 times</a>?</p>
<p>Over the Thanksgiving weekend I had some time on my hands and tasked Claude to write an app that guestimates macronutrients in some foods based on description + photo. There&#39;s some interesting setup in getting it right, but that&#39;s boring. It has created a great, functional app for me, but then I forced it to do a small, evil experiment for me.</p>
<p>I&#39;ve written a quick script that looped over my codebase and ran this command.</p>
<pre><code><span>#!/usr/bin/env bash</span>

<span>set</span> -euo pipefail

PROMPT=<span>&#34;Ultrathink. You&#39;re a principal engineer. Do not ask me any questions. We need to improve the quality of this codebase.  Implement improvements to codebase quality.&#34;</span>
MAX_ITERS=<span>&#34;200&#34;</span>

<span>for</span> i <span>in</span> $(<span>seq</span> 1 <span>&#34;<span>$MAX_ITERS</span>&#34;</span>); <span>do</span>
  claude --dangerously-skip-permissions -p <span>&#34;<span>$PROMPT</span>&#34;</span>

  git add -A

  <span>if</span> git diff --cached --quiet; <span>then</span>
    <span>echo</span> <span>&#34;No changes this round, skipping commit.&#34;</span>
  <span>else</span>
    git commit --no-verify -m <span>&#34;yolo run #<span>$i</span>: <span>$PROMPT</span>&#34;</span>
  <span>fi</span>
<span>done</span>
</code></pre>
<p>...and havoc it wrecked. Over 200 times of unmitigated madness. I have tweaked the prompt here and there when I&#39;ve been seeing it overindexing on a single thing, but with enough iterations it started covering a lot of ground.. from full code coverage and more tests than functional code, to rust-style Result types, to.. estimating entropy of hashing function (???).</p>
<p>This was running for around 36 hours and took me some time to grok through, but let&#39;s see what it did. The entire <a href="https://github.com/Gricha/macro-photo/tree/highest-quality" target="_blank" rel="noopener noreferrer">repo is here btw</a>. The branch you&#39;re looking for is <code>highest-quality</code>.</p>
<h2>The app</h2>
<p>This app is around 4-5 screens. Take a photo, add description, get AI response. Simple as that.</p>
<p><img src="https://gricha.dev/macroPhotoList.png" alt="Main screen"/>
  <img src="https://gricha.dev/macroPhotoDetails.png" alt="Details page"/>
</p>
<h2>Pure numbers</h2>
<p>The version &#34;pre improving quality&#34; was already pretty large. We are talking around 20k lines of TS, around 9.7k is in various <code>__tests__</code> directories. This was <em>slightly</em> intentional - when working with Claude Code, having good self-validation harness greatly improves the quality of results.</p>
<pre><code>cloc . --exclude-dir=node_modules,dist,build,.expo,.husky,.maestro,Pods
     132 text files.
     127 unique files.
      11 files ignored.
github.com/AlDanial/cloc v 2.04  T=0.11 s (1167.4 files/s, 487085.6 lines/s)
-------------------------------------------------------------------------------
Language                     files          blank        comment           code
-------------------------------------------------------------------------------
JSON                             4              0              0          23733
TypeScript                      99           3019           1541          20160
Markdown                        11           1004              0           2700
JavaScript                       9             26             51            269
Bourne Shell                     2             34             41            213
YAML                             2             35              2            162
-------------------------------------------------------------------------------
SUM:                           127           4118           1635          47237
-------------------------------------------------------------------------------
</code></pre>
<p>But in the aftermath - <strong>84 thousand!</strong> We went 20k -&gt; 84k on &#34;improvements&#34; to the quality of the codebase.</p>
<pre><code> cloc . --exclude-dir=node_modules,dist,build,.expo,.husky,.maestro,Pods
     285 text files.
     281 unique files.
      10 files ignored.
github.com/AlDanial/cloc v 2.04  T=0.60 s (468.1 files/s, 268654.5 lines/s)
-------------------------------------------------------------------------------
Language                     files          blank        comment           code
-------------------------------------------------------------------------------
TypeScript                     247          17587          18749          84185
JSON                             5              0              0          24863
Markdown                        14           4151              0          10391
JavaScript                       9             41            140            598
Bourne Shell                     3             41             41            228
YAML                             3             50              3            215
-------------------------------------------------------------------------------
SUM:                           281          21870          18933         120480
-------------------------------------------------------------------------------
</code></pre>
<p>Tests alone went from 10k to <strong>60k</strong> LOC!</p>
<pre><code>cloc . \
  --exclude-dir=node_modules,dist,build,.expo,.husky,.maestro,Pods \
  --match-d=&#39;__tests__&#39;
     138 text files.
     138 unique files.
       1 file ignored.
github.com/AlDanial/cloc v 2.04  T=0.23 s (612.9 files/s, 346313.3 lines/s)
-------------------------------------------------------------------------------
Language                     files          blank        comment           code
-------------------------------------------------------------------------------
TypeScript                     138          13919           3685          60366
-------------------------------------------------------------------------------
SUM:                           138          13919           3685          60366
-------------------------------------------------------------------------------
</code></pre>
<p>I feel much safer.</p>
<p>We went from around 700 to a whooping <strong>5369</strong> tests. In the original project I had e2e tests using actual simulator - they are pretty important to make sure that the coding agent has closed feedback loop, but in the process of improving the quality they seemed to have been forgotten ¯\_(ツ)_/¯.</p>
<p>Btw. we went from ~1500 lines of comments to 18.7k.</p>
<p>OK, but what did it <em>actually do</em>? I have the full log of what Claude Code was outputting in the summary after every run in. <a href="https://github.com/Gricha/macro-photo/blob/highest-quality/MESSAGE_LOG.md" target="_blank" rel="noopener noreferrer">You can check it here</a></p>
<h2>Not-Invented-Here</h2>
<p>Claude Code really didn&#39;t like using 3rd party libraries and created <em>a ton</em> of <a href="https://github.com/Gricha/macro-photo/tree/highest-quality/lib" target="_blank" rel="noopener noreferrer">random utilities</a>.</p>
<p>I can sort of respect that the <a href="https://github.com/Gricha/macro-photo/blob/highest-quality/package.json#L37-L64" target="_blank" rel="noopener noreferrer">dependency list</a> is pretty small, but at the cost of very unmaintainable 20k+ lines of utilities. I guess it really wanted to avoid supply-chain attacks.</p>
<p>Some of them are really unnecessary and could be replaced with off the shelf solution:</p>
<ul>
<li>Full on hierarchical logger with built in performance tracking instead of using something simple off the shelf <a href="https://github.com/Gricha/macro-photo/blob/highest-quality/lib/logger.ts" target="_blank" rel="noopener noreferrer">lib/logger.ts</a></li>
<li><a href="https://github.com/Gricha/macro-photo/tree/highest-quality/hooks" target="_blank" rel="noopener noreferrer">React Hooks</a>. Some of them are specific to our use-case, but bunch of them really doesn&#39;t have to be reinvented (or invented in the first place).</li>
</ul>
<p>Some are just insane - here are my favorites!</p>
<ul>
<li>The Result Type implementation <a href="https://github.com/Gricha/macro-photo/blob/highest-quality/lib/result.ts" target="_blank" rel="noopener noreferrer">lib/result.ts</a> - <code>This module provides a Result type (similar to Rust&#39;s Result&lt;T, E&gt;)</code>.</li>
</ul>
<p>I <em>like</em> Rust&#39;s result-handling system, I don&#39;t think it works very well if you try to bring it to the entire ecosystem that already is standardized on error throwing. In my previous job we experimented with doing that in Python. It wasn&#39;t clicking very well with people and using it felt pretty forced. I&#39;d stray away from it.</p>
<p>This made me giggle because of course AI started bringing patterns from Rust. There&#39;s <a href="https://github.com/Gricha/macro-photo/blob/highest-quality/lib/option.ts" target="_blank" rel="noopener noreferrer">lib/option.ts</a> too.</p>
<ul>
<li>Functional programming utilities <a href="https://github.com/Gricha/macro-photo/blob/highest-quality/lib/functional.ts" target="_blank" rel="noopener noreferrer">lib/functional.ts</a> - Type-safe composition, currying, overloads for 20+ params, this has it all.</li>
<li>Circuit breaking <a href="https://github.com/Gricha/macro-photo/blob/highest-quality/lib/circuitBreaker.ts" target="_blank" rel="noopener noreferrer">lib/circuitBreaker.ts</a></li>
</ul>
<h2>Infra</h2>
<p>In some iterations, coding agent put on a hat of security engineer. For instance - it created a <code>hasMinimalEntropy</code> function meant to &#34;detect obviously fake keys with low character variety&#34;. I don&#39;t know why.</p>
<p>To ensure we have proper scalability it has implemented circuit breaking and jittering exponential backoff. The only API we are talking to is OpenAI/Anthropic. You&#39;re welcome.</p>
<p><strong>The positive</strong> - there&#39;s been a lot of time spent on making sure that we have strict type checking, we don&#39;t overly cast (<code>as any as T</code>) and, hey, I respect that.</p>
<h2>The success criteria - Quality Metrics</h2>
<p>The prompt, in all its versions, always focuses on us improving the codebase quality. It was disappointing to see how that metric is perceived by AI agent. The leading principle was to define a few vanity metrics and push for &#34;more is better&#34;.</p>
<p>In message log, the agent often boasts about the number of tests added, or that code coverage (ugh) is over some arbitrary percentage. We end up with an absolute moloch of unmaintainable code in the name of quality. But hey, the number is going up.</p>

<p>All in all, the project has more code to maintained, most of it largely useless. Tons of tests got added, but some tests that mattered the most (maestro e2e tests that validated the app still works) were forgotten. It had some moments of &#34;goodness&#34;, like making sure typechecks are of high quality.</p>
<p>To truly resemble the test of &#34;redraw this image 1000 times&#34;/&#34;reupload this video 1000 times&#34;, I think the loop would have to be two step:</p>
<ul>
<li>Read and summarize the project</li>
<li>Implement a fresh project based off of this description</li>
</ul>
<p>This was obviously done in jest, I didn&#39;t expect that this will improve the quality of codebase in the ways that I think truly matters. I&#39;ve prompted Claude Code to failure here and it definitely produced some funny results.</p>
<p>I still use coding agents for my day to day development. If anything it feels like time spent reviewing AI code was not a waste of time.</p>
<p>...oh and the app still works, there&#39;s no new features, and just a few new bugs.</p></div></div>
  </body>
</html>
