<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mouha.be/sha-3-buffer-overflow/">Original</a>
    <h1>SHA-3 Buffer Overflow</h1>
    
    <div id="readability-page-1" class="page"><div>
		
<p>Over the past few months, I’ve been coordinating the disclosure of a new vulnerability that I’ve found. Today is the disclosure date, so I am excited that I can finally talk about what I’ve been working on! The vulnerability has been assigned <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-37454">CVE-2022-37454</a> and the security advisory is available <a href="https://github.com/XKCP/XKCP/security/advisories/GHSA-6w4m-2xhg-2658">here</a>.</p>



<p>The vulnerability impacts the <a href="https://github.com/XKCP/XKCP">eXtended Keccak Code Package (XKCP)</a>, which is the “official” <a href="https://csrc.nist.gov/projects/hash-functions/sha-3-project">SHA-3</a> implementation by its designers. It also impacts various projects that have incorporated this code, such as the <a href="https://www.python.org/">Python</a> and <a href="https://www.php.net/">PHP</a> scripting languages.</p>



<p>Perhaps the best way to introduce the vulnerability is to give a short proof of concept.</p>



<p>On an older (vulnerable) implementation, the following Python script will generate a segmentation fault:</p>



<pre><code>import hashlib
h = hashlib.sha3_224()
m1 = b&#34;\x00&#34; * 1;
m2 = b&#34;\x00&#34; * 4294967295;
h.update(m1)
h.update(m2)
print(h.hexdigest())</code></pre>



<p>And the same code in PHP is as follows:</p>



<pre><code>&lt;?php
$ctx = hash_init(&#34;sha3-224&#34;);
hash_update($ctx, str_repeat(&#34;\x00&#34;, 1));
hash_update($ctx, str_repeat(&#34;\x00&#34;, 4294967295));
echo hash_final($ctx);
?&gt;</code></pre>



<p>(The scripts use quite a bit of memory, so it may happen that the Out Of Memory (OOM) killer will terminate the process.)</p>



<p>The reason for the segmentation fault is that the scripts will attempt to write more data to a buffer than it can hold. Such a vulnerability is known as a <a href="https://en.wikipedia.org/wiki/Buffer_overflow">buffer overflow</a>, which <a href="https://owasp.org/">OWASP</a> describes as “<a href="https://owasp.org/www-community/vulnerabilities/Buffer_Overflow">probably the best-known form of software security vulnerability</a>.”</p>



<p>A small variant of the code will cause an infinite loop: just replace 4294967295 with 4294967296. Note the similarity with <a href="https://nvd.nist.gov/vuln/detail/CVE-2019-8741">CVE-2019-8741</a>, another vulnerability that I found that affected the firmware of over 1.4 billion Apple devices, which also caused an infinite loop.</p>



<p>This type of behavior is not supposed to happen for “safe” languages such as Python and PHP, as they check that all read and write operations are within the bounds of the buffer. However, the problem is that the vulnerability is present in the underlying “unsafe” C language…</p>



<p>I’ve shown how this vulnerability in XKCP can be used to violate the <a href="https://cacr.uwaterloo.ca/hac/about/chap9.pdf">cryptographic properties of the hash function</a> to create preimages, second preimages, and collisions. Moreover, I’ve also shown how a specially constructed file can result in arbitrary code execution, and the vulnerability can also impact signature verification algorithms such as <a href="https://csrc.nist.gov/publications/detail/fips/186/5/draft">Ed448</a> that require the use of SHA-3. The details of these attacks will be made public at a later date. </p>



<p>The vulnerable code was released in January 2011, so it took well over a decade for this vulnerability to be found. It appears to be difficult to find vulnerabilities in cryptographic implementations, even though they play a critical role in the overall security of a system. (Perhaps people are not even looking for such vulnerabilities, as neither this vulnerability in XKCP nor the <a href="https://nvd.nist.gov/vuln/detail/CVE-2019-8741">Apple vulnerability</a> mentioned earlier are eligible for any bug bounty program!)</p>



<p>So this is just the beginning… Expect more to come as soon as I can disclose other vulnerabilities that I’ve found!</p>



<p>For comments or questions, feel free to send me an email: </p>
	</div></div>
  </body>
</html>
