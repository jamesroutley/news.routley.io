<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mclare.blog/posts/mapping-los-angeles-soft-story-retrofit-program">Original</a>
    <h1>Mapping Los Angeles&#39; Soft-Story Retrofit Program</h1>
    
    <div id="readability-page-1" class="page"><div><p><span><figure>
    <span>
      <a href="https://www.swpc.noaa.gov/static/001395e4b34b7993ee7cd808c447008d/04784/soft_story_selection.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/001395e4b34b7993ee7cd808c447008d/8ac56/soft_story_selection.webp 240w,
/static/001395e4b34b7993ee7cd808c447008d/d3be9/soft_story_selection.webp 480w,
/static/001395e4b34b7993ee7cd808c447008d/e46b2/soft_story_selection.webp 960w,
/static/001395e4b34b7993ee7cd808c447008d/963af/soft_story_selection.webp 1174w" sizes="(max-width: 960px) 100vw, 960px" type="image/webp"/>
          <source srcset="/static/001395e4b34b7993ee7cd808c447008d/8ff5a/soft_story_selection.png 240w,
/static/001395e4b34b7993ee7cd808c447008d/e85cb/soft_story_selection.png 480w,
/static/001395e4b34b7993ee7cd808c447008d/d9199/soft_story_selection.png 960w,
/static/001395e4b34b7993ee7cd808c447008d/04784/soft_story_selection.png 1174w" sizes="(max-width: 960px) 100vw, 960px" type="image/png"/>
          <img src="https://www.swpc.noaa.gov/static/001395e4b34b7993ee7cd808c447008d/d9199/soft_story_selection.png" alt="Soft-Story Interactive Map" title="" loading="lazy" decoding="async"/>
        </picture>
  </a>
    </span>
    <figcaption>Soft-Story Interactive Map</figcaption>
  </figure></span></p><p><a href="https://mclare.dev/soft-stories" target="_blank" rel="nofollow noopener noreferrer">Los Angeles’ Soft-Story Retrofits</a></p>
<h2 id="motivation"><a href="#motivation" aria-label="motivation permalink"><span><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></span></a>Motivation</h2>
<p>In the wake of the 7.8 magnitude earthquake that devasted parts of Turkey, a <a href="https://www.latimes.com/california/story/2023-02-06/earthquake-like-turkeys-would-devastate-southern-california" target="_blank" rel="nofollow noopener noreferrer">lot</a> of <a href="https://www.nytimes.com/2023/02/27/climate/turkey-syria-earthquakes-california.html?searchResultPosition=16" target="_blank" rel="nofollow noopener noreferrer">press</a> in the U.S. turned to what <em>could</em> happen if a similarly sized earthquake occurred on the west coast. One <a href="https://www.latimes.com/california/story/2023-04-03/hidden-flaw-in-california-homes-can-cause-earthquake-damage" target="_blank" rel="nofollow noopener noreferrer">story</a> from the LATimes focused on the risks of “soft-story” failures in single family homes, but also mentioned the <a href="https://www.latimes.com/california/story/2022-10-20/l-a-hits-1-billion-earthquake-milestone-8-000-buildings-retrofitted" target="_blank" rel="nofollow noopener noreferrer">previous initiative</a> to retrofit multifamily condos and apartments throughout Los Angeles. There are some rudimentary <a href="https://www.ladbs.org/docs/default-source/publications/misc-publications/soft-story-compliance-report.pdf?sfvrsn=bbe9f553_144" target="_blank" rel="nofollow noopener noreferrer">bar charts</a> based on council district currently available from the Los Angeles Department of Building Services’ (LADBS) <a href="https://www.ladbs.org/services/core-services/plan-check-permit/plan-check-permit-special-assistance/mandatory-retrofit-programs/soft-story-retrofit-program" target="_blank" rel="nofollow noopener noreferrer">website</a>, but I wanted to try out some open source mapping and work with Postgis to see how difficult it would be to get a detailed map of all soft-story retrofits (and which ones were still outstanding) as of April 1, 2023.</p>
<h2 id="the-data"><a href="#the-data" aria-label="the data permalink"><span><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></span></a>The data</h2>
<p>I had several xlsx files containing 23,059 addresses (many are duplicate addresses from condos; there are only about 13,500 unique buildings) from the original <a href="https://graphics.latimes.com/soft-story-apartments-needing-retrofit/" target="_blank" rel="nofollow noopener noreferrer">graphic</a> accompanying the <a href="https://www.latimes.com/local/california/la-me-quake-risk-20160415-story.html" target="_blank" rel="nofollow noopener noreferrer">story</a> about the soft-story ordinance in the LATimes. However, this data was incomplete for being able to plot locations on a map, as it lacked latitudes and longitudes. I used <a href="https://www.visidata.org/" target="_blank" rel="nofollow noopener noreferrer">Visidata</a> to get the files into a format that I could feed into the United States Census Bureau’s <a href="https://geocoding.geo.census.gov/geocoder/" target="_blank" rel="nofollow noopener noreferrer">geocoder</a>. It was able to match 95% of the addresses, which I deemed “good enough” for my purposes (Part of the challenge of this project was to do all of this for free. I <em>could</em> have paid for access to Google’s geocoder or another website).</p>
<p>I also had the full list of LADBS permits from <a href="https://data.lacity.org/City-Infrastructure-Service-Requests/Building-and-Safety-Permit-Information-Old/yv23-pmwf" target="_blank" rel="nofollow noopener noreferrer">LA Open Data</a>, which often include if work is part of the retrofit program in the <span><code>work_description</code></span> field. Most of the permits within this data set come with a latitude and longitude, so that made it easier to add this data to the project.</p>
<p><span><figure>
    <span>
      <a href="https://www.swpc.noaa.gov/static/b3eec5b4c142f489d735f6fc2475d3b4/fa2f5/visidata.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/b3eec5b4c142f489d735f6fc2475d3b4/8ac56/visidata.webp 240w,
/static/b3eec5b4c142f489d735f6fc2475d3b4/d3be9/visidata.webp 480w,
/static/b3eec5b4c142f489d735f6fc2475d3b4/7f59e/visidata.webp 517w" sizes="(max-width: 517px) 100vw, 517px" type="image/webp"/>
          <source srcset="/static/b3eec5b4c142f489d735f6fc2475d3b4/8ff5a/visidata.png 240w,
/static/b3eec5b4c142f489d735f6fc2475d3b4/e85cb/visidata.png 480w,
/static/b3eec5b4c142f489d735f6fc2475d3b4/fa2f5/visidata.png 517w" sizes="(max-width: 517px) 100vw, 517px" type="image/png"/>
          <img src="https://www.swpc.noaa.gov/static/b3eec5b4c142f489d735f6fc2475d3b4/fa2f5/visidata.png" alt="Examining the work_description field in Viisidata" title="" loading="lazy" decoding="async"/>
        </picture>
  </a>
    </span>
    <figcaption>Examining the work_description field in Viisidata</figcaption>
  </figure></span></p><h2 id="database-in-postgrespostgis"><a href="#database-in-postgrespostgis" aria-label="database in postgrespostgis permalink"><span><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></span></a>Database in Postgres/PostGIS</h2>
<p>The database design was pretty simple. I had a table for the matched geocoded data, as well as a table for the permit data. Once I’d imported the data and cleaned any empty strings from latitudes and longitudes, I was able to create a new column in both tables as a PostGIS <span><code>ST_Point</code></span>. I also added a column to do a simple string match on the addresses to filter out all the retrofitted buildings from the LA Times dataset.</p>
<p>In addition to the point information, I also wanted to use PostGIS to highlight the building footprints for retrofit buildings. I ultimately decided not to include this in the final visualization, but I did take some time to utilize Microsoft’s publicly available <a href="https://github.com/microsoft/USBuildingFootprints" target="_blank" rel="nofollow noopener noreferrer">US Building footprints</a>. I did some complicated joins to try and get matching building footprints that contained the permit point data or geocoded point data, but I only got hits on about 8,000 buildings out of 13,500 total. In examining the map later, it was clear that a lot of the points were directly on roads, rather than <em>inside</em> the building footprints. I could have done a <a href="https://www.postgis.net/workshops/postgis-intro/knn.html" target="_blank" rel="nofollow noopener noreferrer">Nearest-Neighbor Search</a> with Postgis, but I didn’t want to risk getting false highlights on buildings that either didn’t need to be retrofitted or already had been.</p>
<p><span><figure>
    <span>
      <a href="https://www.swpc.noaa.gov/static/66e05c546045d63598ec9c53704c4658/f213e/building_footprints.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/66e05c546045d63598ec9c53704c4658/8ac56/building_footprints.webp 240w,
/static/66e05c546045d63598ec9c53704c4658/d3be9/building_footprints.webp 480w,
/static/66e05c546045d63598ec9c53704c4658/e46b2/building_footprints.webp 960w,
/static/66e05c546045d63598ec9c53704c4658/afd7b/building_footprints.webp 1192w" sizes="(max-width: 960px) 100vw, 960px" type="image/webp"/>
          <source srcset="/static/66e05c546045d63598ec9c53704c4658/8ff5a/building_footprints.png 240w,
/static/66e05c546045d63598ec9c53704c4658/e85cb/building_footprints.png 480w,
/static/66e05c546045d63598ec9c53704c4658/d9199/building_footprints.png 960w,
/static/66e05c546045d63598ec9c53704c4658/f213e/building_footprints.png 1192w" sizes="(max-width: 960px) 100vw, 960px" type="image/png"/>
          <img src="https://www.swpc.noaa.gov/static/66e05c546045d63598ec9c53704c4658/d9199/building_footprints.png" alt="Incomplete mapping of building footprints" title="" loading="lazy" decoding="async"/>
        </picture>
  </a>
    </span>
    <figcaption>Incomplete mapping of building footprints</figcaption>
  </figure></span></p><p>Once I’d isolated retrofit buildings, missing retrofit buildings, and buildings that were verified as not requiring a retrofit based on the <span><code>work_description</code></span> field in LADBS, I used a geojson export from Postgres to create a custom data layer for my map. I did a bit of postprocessing with <a href="https://observablehq.com" target="_blank" rel="nofollow noopener noreferrer">Observable</a> to cut down on duplicate data and consolidate entries that had the same address (e.g. multiple permits for the same address, or multiple condos at the same address).</p>
<h2 id="mapping"><a href="#mapping" aria-label="mapping permalink"><span><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></span></a>Mapping</h2>
<p>The happy path for completely free open source mapping turned out to be <a href="https://www.geofabrik.de/" target="_blank" rel="nofollow noopener noreferrer">Geofabrik</a> -&gt; <a href="https://github.com/onthegomap/planetiler" target="_blank" rel="nofollow noopener noreferrer">Planetiler</a> -&gt; <a href="https://protomaps.com/" target="_blank" rel="nofollow noopener noreferrer">pmtiles (Protomaps)</a>. At the time I was doing this, I also had to use
<a href="https://github.com/mapbox/tippecanoe" target="_blank" rel="nofollow noopener noreferrer">tippecanoe</a> to convert from the <span><code>mbtiles</code></span> I got from planetiler to the <span><code>pmtiles</code></span> I needed, but recently, <span><code>pmtiles</code></span> support has been added to Planetiler so you can take a <span><code>osm.pbf</code></span> from Geofabrik and make <span><code>pmtiles</code></span>. I used a default style with some tweaks from <a href="https://github.com/openmaptiles/maptiler-basic-gl-style" target="_blank" rel="nofollow noopener noreferrer">OpenMapTiles</a>, but with more time, I could’ve played around with <a href="https://github.com/maputnik/editor" target="_blank" rel="nofollow noopener noreferrer">Maputnik</a> to really customize the look and feel of the map. I utilized Maplibre’s example <a href="https://maplibre.org/maplibre-gl-js-docs/example/" target="_blank" rel="nofollow noopener noreferrer">library</a> for a number of elements with the map (the examples are really great for giving you an idea of the breadth of possibilities for mapping!)</p>
<h2 id="create-react-app"><a href="#create-react-app" aria-label="create react app permalink"><span><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></span></a>Create React App</h2>
<p>While I initially scaffolded this using NextJS, I couldn’t get around Webpack bundler issues (I ended up using Vite), and I wanted to deploy this as a static site (the actual data layer is only 10 mb). I ended up using <a href="https://create-react-app.dev/" target="_blank" rel="nofollow noopener noreferrer">Create-React-App</a> with <a href="https://mui.com/core/" target="_blank" rel="nofollow noopener noreferrer">Material UI</a>. With some tweaks to my NGINX configuration to access the app at a subdirectory on <span><code>https://mclare.dev</code></span>, I uploaded the results of <span><code>vite build</code></span> to my server (which hosts my <a href="https://mclare.blog" target="_blank" rel="nofollow noopener noreferrer">blog</a>, <a href="https://bridge.watch" target="_blank" rel="nofollow noopener noreferrer">bridge.watch</a>, and my <a href="https://mclare.dev" target="_blank" rel="nofollow noopener noreferrer">portfolio site</a>, and had plenty of room leftover for the ~400 mb PMtiles file). One of the best parts of doing this is not needing to set up a full web application with a server, as the map tiles are just stored in the public folder with CRA.</p>
<h2 id="learning-from-the-data"><a href="#learning-from-the-data" aria-label="learning from the data permalink"><span><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></span></a>Learning from the Data</h2>
<p>I feel like this project only scraped the surface of what could be done with the LADBS Building Permit Data (even just for soft-story retrofits). The map itself allows users to see a number of different fields from the permit database upon selecting a marker, including the contractor responsible, the scope of work (including the type of structural retrofit in some cases!), and the LADBS permit status (some of the retrofits are still in progress). For buildings that are currently missing from the LADBS database, I’ve kept the log_ids from the original LATimes xlsx files. It’s interesting to see the distribution of buildings that were part of the retrofit program, as well as where there are pockets in neighborhoods that have yet to be retrofit. I’ve already drafted some plots in <a href="https://observablehq.com" target="_blank" rel="nofollow noopener noreferrer">Observable</a> to take a closer look at which companies are performing the retrofit work (and where they work) as well as the rate at which retrofit work is being done.</p>
<h2 id="acknowledgements"><a href="#acknowledgements" aria-label="acknowledgements permalink"><span><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></span></a>Acknowledgements</h2>
<p>Many thanks to Brandon Liu, the creator of Protomaps, for answering all my questions (even when they weren’t Protomaps related)!</p>
<p><img src="https://www.swpc.noaa.gov/static/soft-story_demo-a04f5f821ad7e087af64cda5a8b91637.gif" alt="Soft Story Demo"/></p>
<p><a href="https://mclare.dev/soft-stories" target="_blank" rel="nofollow noopener noreferrer">Los Angeles’ Soft-Story Retrofits</a></p>
<p><a href="https://github.com/m-clare/soft-story-map" target="_blank" rel="nofollow noopener noreferrer">Github</a></p></div></div>
  </body>
</html>
