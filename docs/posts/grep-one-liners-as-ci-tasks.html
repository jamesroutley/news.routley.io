<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://phili.pe/posts/using-grep-for-simple-ci-tasks/">Original</a>
    <h1>Grep one-liners as CI tasks</h1>
    
    <div id="readability-page-1" class="page"><div id="main"><article>
  <header>
    
    <p>
      January 8, 2022
    </p>
  </header><p>The ubiquitous <code>grep</code> utility can go a long way in enforcing simple rules in a codebase. Plenty of options and readable output combined with a smart exit status allow for simple one-liners in your continuous integration setup that are easy to write and maintain.</p>

<p>The other day my team encountered an issue that we wanted to prevent via a CI task. We needed a quick way to ensure that our automated Android release builds would not contain any missing translations. These are typically stored in <code>strings.xml</code> files using <code>&lt;string&gt;</code> XML tags.</p>

<p>This <code>grep</code> command was all we needed to quickly<sup id="fnref:ripgrep"><a href="#fn:ripgrep">1</a></sup> find such offenses:</p>

<pre><code>$ grep --recursive --line-number --include=strings.xml &#39;&gt;\(&#34;&#34;\| *\)&lt;/string&gt;$&#39;
</code></pre>

<p>The output reads rather nicely and tells us precisely where the offenses are, also thanks to the additional <code>--line-number</code> option:</p>

<pre><code>./app/src/main/res/values/strings.xml:23:    &lt;string name=&#34;some_key&#34;&gt;&lt;/string&gt;
./app/src/main/res/values-fr/strings.xml:147:    &lt;string name=&#34;another_key&#34;&gt;&#34;&#34;&lt;/string&gt;
</code></pre>

<p>A cool thing about <code>grep</code> is that it has a smart exit status. From <a href="https://www.gnu.org/software/grep/manual/grep.html#Exit-Status">GNU grep’s man page</a>:</p>

<blockquote>
  <p>Normally the exit status is 0 if a line is selected, 1 if no lines were selected, and 2 if an error occurred.</p>
</blockquote>

<p>Thus, as long as we have offenses we get an exit status <code>0</code>, denoting success. Once we fix the offenses no lines will be matched by <code>grep</code> and the exit status will be <code>1</code>, denoting that it was unsuccessful.</p>

<p>Since we want to fail the CI task in our <code>grep</code> one-liner, we need to invert this exit status. Thus, when no offenses are found, we need to exit with <code>0</code>, otherwise with <code>1</code>.</p>

<p>Shell script allows a pipeline of one or more commands such as <code>cmdA</code> or <code>cmdA | cmdB</code> to be prefixed with a <code>!</code> (followed by a space), i.e. <code>! cmdA</code> or <code>! cmdA | cmdB</code>. This alters the exit status as described in the <a href="https://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_09_02">Shell Command Language reference</a>:</p>

<blockquote>
  <p>If the pipeline does not begin with the <code>!</code> reserved word, the exit status shall be the exit status of the last command specified in the pipeline. Otherwise, the exit status shall be the logical NOT of the exit status of the last command. That is, if the last command returns zero, the exit status shall be 1; if the last command returns greater than zero, the exit status shall be zero.</p>
</blockquote>

<p>Thus, to get the desired inverted exit status for our CI task we just need to prefix <code>grep</code> with <code>!</code>.</p>

<p>If we want to additionally print a success message when no offenses where found, we can do so with an <code>echo &#34;message&#34;</code> which we combine with a logical <code>&amp;&amp;</code> operator.</p>

<p>Equipped with this knowledge, we conclude with a generic one-liner that <strong>fails the task in case offenses are found and prints a success message otherwise</strong>:</p>

<pre><code>! grep [option...] [patterns] [file...] &amp;&amp; echo &#34;No offenses found&#34;
</code></pre>


  
</article>
    </div></div>
  </body>
</html>
