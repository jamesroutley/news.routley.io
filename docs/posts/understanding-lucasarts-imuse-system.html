<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/meshula/LabMidi/blob/main/LabMuse/imuse-technical.md">Original</a>
    <h1>Understanding LucasArts&#39; iMUSE System</h1>
    
    <div id="readability-page-1" class="page"><div>
    <p><img alt="Ferris the crab" src="https://sharphall.org/posts/2025/May/13/ferris.png"/></p>
<p>Recently I&#39;ve been learning and building in Rust
to the point where I&#39;m feeling productive with it.</p>
<p>Like many others, I&#39;ve found the <a href="https://doc.rust-lang.org/book/">&#34;The Rust Programming Language&#34; book</a>
(or &#34;the book&#34; as my rustacean friends like to call it) to be an incredibly
helpful resource. But as I&#39;ve progressed beyond the book I&#39;ve found that
reading the source code of the standard library
and the crates I was using was extremely illuminating, and revealed
common motifs in Rust development.</p>
<p>There are a few things I&#39;ve found that I thought might be especially
helpful for those new to Rust, which I&#39;ve collected here.</p>
<h2><code>Rc&lt;RefCell&lt;T&gt;&gt;</code> (or <code>Arc&lt;RwLock&lt;T&gt;&gt;</code> or <code>Arc&lt;Mutex&lt;T&gt;&gt;</code>)</h2>
<p>This one is <a href="https://doc.rust-lang.org/stable/book/ch15-04-rc.html">in the book</a>, but it&#39;s in the last 3/4, and if you&#39;re jumping into
the language you might be worried that data structures that were easy in
other languages might seem impossible in Rust.</p>
<p><a href="https://doc.rust-lang.org/std/rc/struct.Rc.html"><code>Rc&lt;T&gt;</code></a> and its thread-safe
counterpart <a href="https://doc.rust-lang.org/std/sync/struct.Arc.html"><code>Arc&lt;T&gt;</code></a>
allow you to reference-count
(or in the case of <code>Arc</code>, <em>atomically</em> reference-count)
allocated memory.</p>
<p><code>.clone()</code> on an <code>Rc&lt;T&gt;</code> will no longer <code>.clone()</code> (and copy) the
wrapped value. Instead, a counter representing how many times the <code>Rc</code>
is owned will be incremented and the same <code>Rc</code> will be effectively owned in
multiple places. As these owned references are dropped the counter decrements,
and when the last reference is finally dropped, <code>Rc</code> will drop the wrapped value
before it is removed itself.</p>
<p><code>Rc</code> implements <a href="https://doc.rust-lang.org/std/ops/trait.Deref.html"><code>Deref</code></a>
(but not <code>DerefMut</code>), which allows
you to easily access the value it wraps via <a href="https://doc.rust-lang.org/std/ops/trait.Deref.html#deref-coercion">&#34;Deref coercion&#34;</a>.</p>
<p>Meanwhile, <a href="https://doc.rust-lang.org/std/cell/struct.RefCell.html"><code>RefCell&lt;T&gt;</code></a>
(or <a href="https://doc.rust-lang.org/std/sync/struct.RwLock.html"><code>RwLock&lt;T&gt;</code></a> and
<a href="https://doc.rust-lang.org/std/sync/struct.Mutex.html"><code>Mutex&lt;T&gt;</code></a>)
lets you separate the mutability
of the type that they wrap from the struct or reference that holds it. This
is called <a href="https://doc.rust-lang.org/reference/interior-mutability.html">&#34;interior mutability&#34;</a>.
Anywhere a <code>RefCell</code>, <code>RwLock</code> or <code>Mutex</code> is
<em>borrowed as immutable</em>, you can try to <em>mutably</em> borrow the
interior value with <a href="https://doc.rust-lang.org/std/cell/struct.RefCell.html#method.borrow_mut"><code>.borrow_mut</code></a> or similar.</p>
<p><code>RefCell&lt;T&gt;</code> and <code>Rc&lt;T&gt;</code> (and their respective thread-safe counterparts)
can be combined to create a value that can be shared (with <code>Rc</code>) and mutated
in multiple places
(inside of a <code>RefCell</code>, which temporarily provides a borrowed <code>mut</code> value).</p>
<ul>
<li><code>Rc&lt;T&gt;</code> can be owned in many places with <code>.clone()</code></li>
<li>Each clone of <code>Rc</code> points to the same immutable value</li>
<li>You can ask to <em>mutably</em> borrow the value inside the <code>RefCell</code>
  anywhere the <code>RefCell</code> is immutably borrowed</li>
<li>A <code>RefCell&lt;T&gt;</code> wrapped in <code>Rc</code> can be borrowed immutably
  anywhere the <code>Rc</code> is owned</li>
<li>You can ask to <em>mutably</em> borrow the value inside the <code>RefCell</code>
  anywhere the <code>Rc</code> is owned</li>
<li>With this pattern, the interface to <em>ask</em> to borrow a
  shared value
  mutably can have many owners</li>
</ul>
<p>One data structure that might be impossible or needlessly difficult to
create in Rust without reference counting and
interior mutability is a graph. Below is an example that
uses reference counting with <code>Rc&lt;T&gt;</code> to create nodes, one of which is referenced multiple
times from multiple other nodes. <code>RefCell&lt;T&gt;</code> is utilized to borrow a mutable
reference to the node so that it can be set as <code>visited</code> so we can avoid
visiting a node multiple times during a depth-first search.</p>
<div><pre><span></span><code><span>use</span><span> </span><span>std</span><span>::</span><span>cell</span><span>::</span><span>RefCell</span><span>;</span>
<span>use</span><span> </span><span>std</span><span>::</span><span>error</span><span>::</span><span>Error</span><span>;</span>
<span>use</span><span> </span><span>std</span><span>::</span><span>rc</span><span>::</span><span>Rc</span><span>;</span>

<span>fn</span><span> </span><span>main</span><span>()</span><span> </span><span>-&gt;</span><span> </span><span>Result</span><span>&lt;</span><span>(),</span><span> </span><span>Box</span><span>&lt;</span><span>dyn</span><span> </span><span>Error</span><span>&gt;&gt;</span><span> </span><span>{</span>
<span>    </span><span>graph_demo</span><span>()</span>
<span>}</span>

<span>#[derive(Debug)]</span>
<span>struct</span><span> </span><span>Node</span><span> </span><span>{</span>
<span>    </span><span>name</span><span>:</span><span> </span><span>String</span><span>,</span>
<span>    </span><span>value</span><span>:</span><span> </span><span>i64</span><span>,</span>
<span>    </span><span>children</span><span>:</span><span> </span><span>Vec</span><span>&lt;</span><span>Rc</span><span>&lt;</span><span>RefCell</span><span>&lt;</span><span>Node</span><span>&gt;&gt;&gt;</span><span>,</span>
<span>    </span><span>visited</span><span>:</span><span> </span><span>bool</span><span>,</span>
<span>}</span>

<span>impl</span><span> </span><span>Node</span><span> </span><span>{</span>
<span>    </span><span>fn</span><span> </span><span>new</span><span>(</span><span>name</span><span>:</span><span> </span><span>String</span><span>,</span><span> </span><span>value</span><span>:</span><span> </span><span>i64</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>Self</span><span> </span><span>{</span>
<span>        </span><span>Self</span><span> </span><span>{</span>
<span>            </span><span>name</span><span>,</span>
<span>            </span><span>value</span><span>,</span>
<span>            </span><span>children</span><span>:</span><span> </span><span>vec</span><span>!</span><span>[],</span>
<span>            </span><span>visited</span><span>:</span><span> </span><span>false</span><span>,</span>
<span>        </span><span>}</span>
<span>    </span><span>}</span>
<span>}</span>

<span>fn</span><span> </span><span>graph_demo</span><span>()</span><span> </span><span>-&gt;</span><span> </span><span>Result</span><span>&lt;</span><span>(),</span><span> </span><span>Box</span><span>&lt;</span><span>dyn</span><span> </span><span>Error</span><span>&gt;&gt;</span><span> </span><span>{</span>
<span>    </span><span>let</span><span> </span><span>a</span><span> </span><span>=</span><span> </span><span>Rc</span><span>::</span><span>new</span><span>(</span><span>RefCell</span><span>::</span><span>new</span><span>(</span><span>Node</span><span>::</span><span>new</span><span>(</span><span>&#34;A&#34;</span><span>.</span><span>into</span><span>(),</span><span> </span><span>5</span><span>)));</span>
<span>    </span><span>let</span><span> </span><span>b</span><span> </span><span>=</span><span> </span><span>Rc</span><span>::</span><span>new</span><span>(</span><span>RefCell</span><span>::</span><span>new</span><span>(</span><span>Node</span><span>::</span><span>new</span><span>(</span><span>&#34;B&#34;</span><span>.</span><span>into</span><span>(),</span><span> </span><span>10</span><span>)));</span>
<span>    </span><span>let</span><span> </span><span>c</span><span> </span><span>=</span><span> </span><span>Rc</span><span>::</span><span>new</span><span>(</span><span>RefCell</span><span>::</span><span>new</span><span>(</span><span>Node</span><span>::</span><span>new</span><span>(</span><span>&#34;C&#34;</span><span>.</span><span>into</span><span>(),</span><span> </span><span>10</span><span>)));</span>
<span>    </span><span>a</span><span>.</span><span>try_borrow_mut</span><span>()</span><span>?</span><span>.</span><span>children</span><span>.</span><span>push</span><span>(</span><span>b</span><span>.</span><span>clone</span><span>());</span>
<span>    </span><span>// try_borrow_mut() gets a mutable reference to the interior of the</span>
<span>    </span><span>// RefCell, or errors if already currently mutably borrowed.</span>
<span>    </span><span>// b.clone() increments the reference count, instead of copying the</span>
<span>    </span><span>// whole struct</span>
<span>    </span><span>b</span><span>.</span><span>try_borrow_mut</span><span>()</span><span>?</span><span>.</span><span>children</span><span>.</span><span>push</span><span>(</span><span>c</span><span>.</span><span>clone</span><span>());</span>
<span>    </span><span>a</span><span>.</span><span>try_borrow_mut</span><span>()</span><span>?</span><span>.</span><span>children</span><span>.</span><span>push</span><span>(</span><span>c</span><span>.</span><span>clone</span><span>());</span>
<span>    </span><span>c</span><span>.</span><span>try_borrow_mut</span><span>()</span><span>?</span><span>.</span><span>value</span><span> </span><span>=</span><span> </span><span>100</span><span>;</span>

<span>    </span><span>let</span><span> </span><span>mut</span><span> </span><span>stack</span><span>:</span><span> </span><span>Vec</span><span>&lt;</span><span>_</span><span>&gt;</span><span> </span><span>=</span><span> </span><span>vec!</span><span>[</span><span>a</span><span>.</span><span>clone</span><span>()];</span>
<span>    </span><span>while</span><span> </span><span>let</span><span> </span><span>Some</span><span>(</span><span>current</span><span>)</span><span> </span><span>=</span><span> </span><span>stack</span><span>.</span><span>pop</span><span>()</span><span> </span><span>{</span>
<span>        </span><span>let</span><span> </span><span>mut</span><span> </span><span>current</span><span> </span><span>=</span><span> </span><span>current</span><span>.</span><span>try_borrow_mut</span><span>()</span><span>?</span><span>;</span>
<span>        </span><span>if</span><span> </span><span>current</span><span>.</span><span>visited</span><span> </span><span>{</span>
<span>            </span><span>println!</span><span>(</span><span>&#34;Already visited {:?}&#34;</span><span>,</span><span> </span><span>current</span><span>);</span>
<span>            </span><span>continue</span><span>;</span>
<span>        </span><span>}</span>
<span>        </span><span>println!</span><span>(</span><span>&#34;Visiting {:?}&#34;</span><span>,</span><span> </span><span>current</span><span>);</span>
<span>        </span><span>current</span><span>.</span><span>visited</span><span> </span><span>=</span><span> </span><span>true</span><span>;</span>
<span>        </span><span>for</span><span> </span><span>child</span><span> </span><span>in</span><span> </span><span>current</span><span>.</span><span>children</span><span>.</span><span>iter</span><span>()</span><span> </span><span>{</span>
<span>            </span><span>stack</span><span>.</span><span>push</span><span>(</span><span>child</span><span>.</span><span>clone</span><span>());</span>
<span>        </span><span>}</span>
<span>    </span><span>}</span>
<span>    </span><span>Ok</span><span>(())</span>
<span>}</span>
</code></pre></div>

<h2><code>std::collections</code></h2>
<p>Rust beginners know about <a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code>Vec&lt;T&gt;</code></a>.
A <code>Vec</code> is essentially a growable region of
linear memory. Like in a C array, the location in memory of the n&#39;th element
is just the memory location of the first element + n * the size of the stored
type.</p>
<p><code>Vec&lt;T&gt;</code> is growable at the last value in
<a href="https://en.wikipedia.org/wiki/Time_complexity#Table_of_common_time_complexities">constant time</a>.
(...sometimes -- if new capacity needs to be allocated, the new continious capacity
will be allocated and the data copied, which happens in linear time.)</p>
<p>But if you need to insert or delete values at the <em>beginning</em> of the collection
or somewhere in the middle, values will have to be shuffled in memory
to make sure the list stays in order.</p>
<p>Luckily, Rust makes other ways of storing collections of values available in
the <code>std::collections</code> module. The module&#39;s documentation provides a good
summary of when to use the different options.</p>
<ul>
<li><a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html"><code>VecDeque</code></a> (a ring buffer) and
<a href="https://doc.rust-lang.org/std/collections/struct.LinkedList.html"><code>LinkedList</code></a> provide a structure for sequences with
efficient insertion and deletion at both ends of the sequence.</li>
<li><a href="https://doc.rust-lang.org/std/collections/hash_map/struct.HashMap.html"><code>HashMap</code></a> and
<a href="https://doc.rust-lang.org/std/collections/hash_set/struct.HashSet.html"><code>HashSet</code></a>
provide O(1) lookups for a key-value map and set, respectively,
for keys or items that implement the <a href="https://doc.rust-lang.org/std/hash/trait.Hash.html"><code>Hash</code></a> trait.
(You can often derive <code>Hash</code> with <code>#[derive(Hash)]</code>.)</li>
<li><a href="https://doc.rust-lang.org/std/collections/struct.BTreeMap.html"><code>BTreeMap</code></a> and
<a href="https://doc.rust-lang.org/std/collections/struct.BTreeSet.html"><code>BTreeSet</code></a>
provide O(log(n)) lookups for a key-value map and set,
respectively, for keys or items that implement the <a href="https://doc.rust-lang.org/std/cmp/trait.Ord.html"><code>Ord</code></a>
trait. They can also be
iterated through in order as determined by the <code>Ord</code> trait.</li>
</ul>
<p><img alt="Sea shells 1 by Leonardo Aguiar" src="https://sharphall.org/posts/2025/May/13/shells.jpg"/>
<em><a href="https://flickr.com/photos/sensechange/523200676">Sea shells 1 by Leonardo Aguiar</a> <a href="https://creativecommons.org/licenses/by/2.0/deed.en">CC BY 2.0</a></em></p>
<h2><code>.await</code>ing for events</h2>
<p>Developers using dynamic languages like JavaScript and Python may be used
to using event handlers for new connections or incoming messages.</p>
<p>For example, if you are setting up a WebSocket server, you attach a handler
to handle incoming connections. That handler sets up other handlers to define
what happens
when that connection receives an incoming message.</p>
<div><pre><span></span><code><span>// javascript example</span>

<span>import</span><span> </span><span>{</span><span> </span><span>WebSocketServer</span><span> </span><span>}</span><span> </span><span>from</span><span> </span><span>&#39;ws&#39;</span><span>;</span>

<span>const</span><span> </span><span>wss</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>WebSocketServer</span><span>({</span><span> </span><span>port</span><span>:</span><span> </span><span>8080</span><span> </span><span>});</span>

<span>wss</span><span>.</span><span>on</span><span>(</span><span>&#39;connection&#39;</span><span>,</span><span> </span><span>function</span><span> </span><span>connection</span><span>(</span><span>ws</span><span>)</span><span> </span><span>{</span>
<span>  </span><span>ws</span><span>.</span><span>on</span><span>(</span><span>&#39;error&#39;</span><span>,</span><span> </span><span>console</span><span>.</span><span>error</span><span>);</span>

<span>  </span><span>ws</span><span>.</span><span>on</span><span>(</span><span>&#39;message&#39;</span><span>,</span><span> </span><span>function</span><span> </span><span>message</span><span>(</span><span>data</span><span>)</span><span> </span><span>{</span>
<span>    </span><span>console</span><span>.</span><span>log</span><span>(</span><span>&#39;received: %s&#39;</span><span>,</span><span> </span><span>data</span><span>);</span>
<span>  </span><span>});</span>

<span>  </span><span>ws</span><span>.</span><span>send</span><span>(</span><span>&#39;hello!&#39;</span><span>);</span>
<span>});</span>
</code></pre></div>

<p>Rust tends to use a different pattern, where an infinite loop waits on
a listener that blocks the thread or future until it has received a connection.
This connection can then be moved to a new thread or future to handle that
connection, while the loop to accept more connections keeps running.</p>
<div><pre><span></span><code><span>use</span><span> </span><span>futures_util</span><span>::{</span><span>SinkExt</span><span>,</span><span> </span><span>StreamExt</span><span>};</span>
<span>use</span><span> </span><span>tokio</span><span>::</span><span>net</span><span>::</span><span>TcpListener</span><span>;</span>
<span>use</span><span> </span><span>tokio_websockets</span><span>::{</span><span>Error</span><span>,</span><span> </span><span>Message</span><span>,</span><span> </span><span>ServerBuilder</span><span>};</span>

<span>#[tokio::main]</span>
<span>async</span><span> </span><span>fn</span><span> </span><span>main</span><span>()</span><span> </span><span>-&gt;</span><span> </span><span>Result</span><span>&lt;</span><span>(),</span><span> </span><span>Error</span><span>&gt;</span><span> </span><span>{</span>
<span>    </span><span>let</span><span> </span><span>listener</span><span> </span><span>=</span><span> </span><span>TcpListener</span><span>::</span><span>bind</span><span>(</span><span>&#34;0.0.0.0:3000&#34;</span><span>).</span><span>await</span><span>?</span><span>;</span>
<span>    </span><span>while</span><span> </span><span>let</span><span> </span><span>Ok</span><span>((</span><span>stream</span><span>,</span><span> </span><span>_</span><span>))</span><span> </span><span>=</span><span> </span><span>listener</span><span>.</span><span>accept</span><span>().</span><span>await</span><span> </span><span>{</span>
<span>        </span><span>tokio</span><span>::</span><span>spawn</span><span>(</span><span>async</span><span> </span><span>move</span><span> </span><span>{</span>
<span>            </span><span>let</span><span> </span><span>mut</span><span> </span><span>ws_stream</span><span> </span><span>=</span><span> </span><span>ServerBuilder</span><span>::</span><span>new</span><span>().</span><span>accept</span><span>(</span><span>stream</span><span>).</span><span>await</span><span>?</span><span>;</span>

<span>            </span><span>ws_stream</span><span>.</span><span>send</span><span>(</span><span>Message</span><span>::</span><span>text</span><span>(</span><span>&#34;hello!&#34;</span><span>)).</span><span>await</span><span>?</span><span>;</span>

<span>            </span><span>while</span><span> </span><span>let</span><span> </span><span>Some</span><span>(</span><span>Ok</span><span>(</span><span>msg</span><span>))</span><span> </span><span>=</span><span> </span><span>ws_stream</span><span>.</span><span>next</span><span>().</span><span>await</span><span> </span><span>{</span>
<span>                </span><span>if</span><span> </span><span>let</span><span> </span><span>Some</span><span>(</span><span>txt</span><span>)</span><span> </span><span>=</span><span> </span><span>msg</span><span>.</span><span>as_text</span><span>()</span><span> </span><span>{</span>
<span>                    </span><span>println!</span><span>(</span><span>&#34;received: {}&#34;</span><span>,</span><span> </span><span>txt</span><span>);</span>
<span>                </span><span>}</span>
<span>            </span><span>}</span>
<span>            </span><span>Ok</span><span>::</span><span>&lt;</span><span>_</span><span>,</span><span> </span><span>Error</span><span>&gt;</span><span>(())</span>
<span>        </span><span>});</span>
<span>    </span><span>}</span>
<span>    </span><span>Ok</span><span>(())</span>
<span>}</span>
</code></pre></div>

<p>In this example, it&#39;s worth taking a look at <code>SinkExt</code> and <code>StreamExt</code>,
extension traits provided by <code>futures_util</code>.
These two traits provide an interface for asyncronously
handling polling a sink or a stream with <code>.await</code> syntax.
<code>ws_stream</code> in this example
is a <code>futures_sink::Sink</code> and a
<code>futures_core::Stream</code>.
Because a <code>Future</code> is, at its essence, an
interface that is polled to see if a result is ready, it is possible
for <code>SinkExt</code> and <code>StreamExt</code> to
wrap a similarly pollable <code>Sink</code> or <code>Stream</code>
and provide a <code>Future</code> interface with <code>ws_stream.send</code> and <code>ws_stream.next</code>.</p>
<p>Note that because the stream is owned by the function or closure using it,
if we want to wait for messages from a second source -- like a channel -- so we
can forward it
to the stream, while also waiting for messages from the stream to send back
to the channel,
we need to
use something like <code>tokio::select</code> which will use the result from the first
ready <code>Future</code>, and cancel the others:</p>
<div><pre><span></span><code><span>use</span><span> </span><span>futures_util</span><span>::{</span><span>SinkExt</span><span>,</span><span> </span><span>StreamExt</span><span>};</span>
<span>use</span><span> </span><span>std</span><span>::</span><span>error</span><span>::</span><span>Error</span><span>;</span>
<span>use</span><span> </span><span>tokio</span><span>::</span><span>net</span><span>::</span><span>TcpListener</span><span>;</span>
<span>use</span><span> </span><span>tokio</span><span>::</span><span>sync</span><span>::</span><span>watch</span><span>;</span>
<span>use</span><span> </span><span>tokio_websockets</span><span>::{</span><span>Message</span><span>,</span><span> </span><span>ServerBuilder</span><span>};</span>

<span>#[tokio::main]</span>
<span>async</span><span> </span><span>fn</span><span> </span><span>main</span><span>()</span><span> </span><span>-&gt;</span><span> </span><span>Result</span><span>&lt;</span><span>(),</span><span> </span><span>Box</span><span>&lt;</span><span>dyn</span><span> </span><span>Error</span><span>&gt;&gt;</span><span> </span><span>{</span>
<span>    </span><span>let</span><span> </span><span>listener</span><span> </span><span>=</span><span> </span><span>TcpListener</span><span>::</span><span>bind</span><span>(</span><span>&#34;127.0.0.1:3000&#34;</span><span>).</span><span>await</span><span>?</span><span>;</span>
<span>    </span><span>let</span><span> </span><span>(</span><span>pubsub_tx</span><span>,</span><span> </span><span>pubsub_rx</span><span>)</span><span> </span><span>=</span><span> </span><span>watch</span><span>::</span><span>channel</span><span>(</span><span>&#34;initial value&#34;</span><span>.</span><span>to_string</span><span>());</span>

<span>    </span><span>while</span><span> </span><span>let</span><span> </span><span>Ok</span><span>((</span><span>stream</span><span>,</span><span> </span><span>_</span><span>))</span><span> </span><span>=</span><span> </span><span>listener</span><span>.</span><span>accept</span><span>().</span><span>await</span><span> </span><span>{</span>
<span>        </span><span>let</span><span> </span><span>tx</span><span> </span><span>=</span><span> </span><span>pubsub_tx</span><span>.</span><span>clone</span><span>();</span>
<span>        </span><span>let</span><span> </span><span>mut</span><span> </span><span>rx</span><span> </span><span>=</span><span> </span><span>pubsub_rx</span><span>.</span><span>clone</span><span>();</span>
<span>        </span><span>rx</span><span>.</span><span>borrow_and_update</span><span>();</span><span> </span><span>// marks latest value as seen</span>
<span>        </span><span>tokio</span><span>::</span><span>spawn</span><span>(</span><span>async</span><span> </span><span>move</span><span> </span><span>{</span>
<span>            </span><span>let</span><span> </span><span>Ok</span><span>(</span><span>mut</span><span> </span><span>ws_stream</span><span>)</span><span> </span><span>=</span><span> </span><span>ServerBuilder</span><span>::</span><span>new</span><span>().</span><span>accept</span><span>(</span><span>stream</span><span>).</span><span>await</span><span> </span><span>else</span><span> </span><span>{</span>
<span>                </span><span>return</span><span>;</span>
<span>            </span><span>};</span>

<span>            </span><span>loop</span><span> </span><span>{</span>
<span>                </span><span>tokio</span><span>::</span><span>select</span><span>!</span><span> </span><span>{</span>
<span>                    </span><span>msg</span><span> </span><span>=</span><span> </span><span>ws_stream</span><span>.</span><span>next</span><span>()</span><span> </span><span>=&gt;</span><span> </span><span>{</span>
<span>                        </span><span>if</span><span> </span><span>let</span><span> </span><span>Some</span><span>(</span><span>Ok</span><span>(</span><span>msg</span><span>))</span><span> </span><span>=</span><span> </span><span>msg</span><span> </span><span>{</span>
<span>                            </span><span>if</span><span> </span><span>let</span><span> </span><span>Some</span><span>(</span><span>txt</span><span>)</span><span> </span><span>=</span><span> </span><span>msg</span><span>.</span><span>as_text</span><span>()</span><span> </span><span>{</span>
<span>                                </span><span>println!</span><span>(</span><span>&#34;received: {}&#34;</span><span>,</span><span> </span><span>txt</span><span>);</span>
<span>                                </span><span>if</span><span> </span><span>tx</span><span>.</span><span>send</span><span>(</span><span>txt</span><span>.</span><span>to_string</span><span>()).</span><span>is_err</span><span>()</span><span> </span><span>{</span>
<span>                                    </span><span>return</span><span>;</span>
<span>                                </span><span>}</span>
<span>                            </span><span>}</span>
<span>                        </span><span>}</span><span> </span><span>else</span><span> </span><span>{</span>
<span>                            </span><span>break</span><span>;</span>
<span>                        </span><span>}</span>
<span>                    </span><span>}</span>
<span>                    </span><span>result</span><span> </span><span>=</span><span> </span><span>rx</span><span>.</span><span>changed</span><span>()</span><span> </span><span>=&gt;</span><span> </span><span>{</span>
<span>                        </span><span>if</span><span> </span><span>result</span><span>.</span><span>is_err</span><span>()</span><span> </span><span>{</span>
<span>                            </span><span>return</span><span>;</span>
<span>                        </span><span>}</span>
<span>                        </span><span>let</span><span> </span><span>msg</span><span> </span><span>=</span><span> </span><span>rx</span><span>.</span><span>borrow_and_update</span><span>().</span><span>clone</span><span>();</span>
<span>                        </span><span>if</span><span> </span><span>ws_stream</span><span>.</span><span>send</span><span>(</span><span>Message</span><span>::</span><span>text</span><span>(</span><span>msg</span><span>)).</span><span>await</span><span>.</span><span>is_err</span><span>()</span><span> </span><span>{</span>
<span>                            </span><span>return</span><span>;</span>
<span>                        </span><span>}</span>
<span>                    </span><span>}</span>
<span>                </span><span>}</span>
<span>            </span><span>}</span>
<span>        </span><span>});</span>
<span>    </span><span>}</span>
<span>    </span><span>Ok</span><span>(())</span>
<span>}</span>
</code></pre></div>

<h2>Error handling with <code>thiserror</code> and <code>anyhow</code></h2>
<p>The first time I implemented an <code>Error</code>, I found that more boilerplate than I was
used to from other languages was required.</p>
<p><code>thiserror</code> provides macros to implement the <code>Error</code> trait. Error types can be created
with an enum or a struct:</p>
<div><pre><span></span><code><span>use</span><span> </span><span>thiserror</span><span>::</span><span>Error</span><span>;</span>

<span>#[derive(Error, Debug)]</span>
<span>pub</span><span> </span><span>enum</span><span> </span><span>ErrorEnum</span><span> </span><span>{</span>
<span>    </span><span>#[error(</span><span>&#34;Not found&#34;</span><span>)]</span>
<span>    </span><span>NotFound</span><span>,</span>
<span>    </span><span>#[error(</span><span>&#34;Permission {0} required&#34;</span><span>)]</span>
<span>    </span><span>PermissionRequired</span><span>(</span><span>String</span><span>),</span>
<span>}</span>

<span>#[derive(Error, Debug)]</span>
<span>pub</span><span> </span><span>struct</span><span> </span><span>RemoteError</span><span> </span><span>{</span>
<span>    </span><span>msg</span><span>:</span><span> </span><span>String</span><span>,</span>
<span>    </span><span>source</span><span>:</span><span> </span><span>anyhow</span><span>::</span><span>Error</span><span>,</span>
<span>}</span>
</code></pre></div>

<p><code>anyhow</code> works well with <code>thiserror</code> (or separately) and does a couple things:</p>
<ul>
<li>Provides an <code>anyhow::Error</code> type that is a lot like <code>Box&lt;dyn Error&gt;</code>, but
with some extra helpful guarantees like thread-safety and backtraces.</li>
<li>Provides an <code>anyhow::Result&lt;T&gt;</code> type that is a shortcut for <code>Result&lt;T, anyhow::Error&gt;</code></li>
<li>Provides a <code>context</code> method allowing you to add context when an error happens
that is included in the printed output or can assist in handling by calling
functions.</li>
</ul>
<div><pre><span></span><code><span>use</span><span> </span><span>anyhow</span><span>::{</span><span>Context</span><span>,</span><span> </span><span>Result</span><span>};</span>

<span>fn</span><span> </span><span>fail_for_some_reason</span><span>()</span><span> </span><span>-&gt;</span><span> </span><span>Result</span><span>&lt;</span><span>()</span><span>&gt;</span><span> </span><span>{</span>
<span>    </span><span>this_will_fail</span><span>().</span><span>context</span><span>(</span><span>&#34;Failed in example fn&#34;</span><span>)</span><span>?</span><span>;</span>
<span>    </span><span>Ok</span><span>(())</span>
<span>}</span>
</code></pre></div>

<p>There&#39;s more to <code>anyhow</code> than this brief example, and <a href="https://docs.rs/anyhow/latest/anyhow/index.html">the docs</a>
are a good resource.</p>
<h2>Any</h2>
<p>The <code>Any</code> trait -- which <a href="https://doc.rust-lang.org/std/any/trait.Any.html">&#34;most types implement&#34;</a> --
can allow you to downcast generic types.</p>
<p>In the following example, we can pass any type of <code>Vehicle</code> to the <code>take_public_transit</code>
function. Since we are using static dispatch, the compiler should compile
the <code>take_public_transit</code> function multiple times for every type of <code>Vehicle</code>
that we pass to it. <code>generic_obj.downcast_ref::&lt;T&gt;()</code> checks to see if the <a href="https://doc.rust-lang.org/std/any/struct.TypeId.html"><code>TypeId</code></a>
of the passed value is the same for the specified type, and if it is, it returns
<code>Some(&amp;T)</code>. This is an equality comparison of
static values for each compiled iteration of <code>take_public_transit</code>, and <em>so for optimized builds, the
type check
and dead code paths for specific types
should be optimized away!</em> This is very cool!</p>
<div><pre><span></span><code><span>use</span><span> </span><span>anyhow</span><span>::{</span><span>bail</span><span>,</span><span> </span><span>Result</span><span>};</span>
<span>use</span><span> </span><span>std</span><span>::</span><span>any</span><span>::</span><span>Any</span><span>;</span>

<span>trait</span><span> </span><span>Vehicle</span><span> </span><span>{</span>
<span>    </span><span>fn</span><span> </span><span>alert</span><span>(</span><span>&amp;</span><span>self</span><span>);</span>
<span>}</span>

<span>#[derive(Default)]</span>
<span>struct</span><span> </span><span>Car</span><span> </span><span>{}</span>

<span>impl</span><span> </span><span>Vehicle</span><span> </span><span>for</span><span> </span><span>Car</span><span> </span><span>{</span>
<span>    </span><span>fn</span><span> </span><span>alert</span><span>(</span><span>&amp;</span><span>self</span><span>)</span><span> </span><span>{</span>
<span>        </span><span>println!</span><span>(</span><span>&#34;Honk! Honk!&#34;</span><span>);</span>
<span>    </span><span>}</span>
<span>}</span>

<span>impl</span><span> </span><span>Car</span><span> </span><span>{</span>
<span>    </span><span>fn</span><span> </span><span>drive</span><span>(</span><span>&amp;</span><span>self</span><span>)</span><span> </span><span>{</span>
<span>        </span><span>println!</span><span>(</span><span>&#34;Driving the car!&#34;</span><span>);</span>
<span>    </span><span>}</span>
<span>}</span>

<span>#[derive(Default)]</span>
<span>struct</span><span> </span><span>Trolley</span><span> </span><span>{}</span>

<span>impl</span><span> </span><span>Vehicle</span><span> </span><span>for</span><span> </span><span>Trolley</span><span> </span><span>{</span>
<span>    </span><span>fn</span><span> </span><span>alert</span><span>(</span><span>&amp;</span><span>self</span><span>)</span><span> </span><span>{</span>
<span>        </span><span>println!</span><span>(</span><span>&#34;Ding! Ding!&#34;</span><span>);</span>
<span>    </span><span>}</span>
<span>}</span>

<span>impl</span><span> </span><span>Trolley</span><span> </span><span>{</span>
<span>    </span><span>fn</span><span> </span><span>ride</span><span>(</span><span>&amp;</span><span>self</span><span>)</span><span> </span><span>{</span>
<span>        </span><span>println!</span><span>(</span><span>&#34;Riding the trolley!&#34;</span><span>);</span>
<span>    </span><span>}</span>
<span>}</span>

<span>#[derive(Default)]</span>
<span>struct</span><span> </span><span>Dog</span><span> </span><span>{}</span>

<span>fn</span><span> </span><span>watch_out</span><span>(</span><span>vehicle</span><span>:</span><span> </span><span>&amp;</span><span>impl</span><span> </span><span>Vehicle</span><span>)</span><span> </span><span>{</span>
<span>    </span><span>vehicle</span><span>.</span><span>alert</span><span>();</span>
<span>}</span>

<span>fn</span><span> </span><span>take_public_transit</span><span>&lt;</span><span>V</span><span>:</span><span> </span><span>Any</span><span> </span><span>+</span><span> </span><span>Vehicle</span><span>&gt;</span><span>(</span><span>vehicle</span><span>:</span><span> </span><span>&amp;</span><span>V</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>Result</span><span>&lt;</span><span>()</span><span>&gt;</span><span> </span><span>{</span>
<span>    </span><span>let</span><span> </span><span>vehicle_any</span><span> </span><span>=</span><span> </span><span>vehicle</span><span> </span><span>as</span><span> </span><span>&amp;</span><span>dyn</span><span> </span><span>Any</span><span>;</span>
<span>    </span><span>if</span><span> </span><span>let</span><span> </span><span>Some</span><span>(</span><span>trolley</span><span>)</span><span> </span><span>=</span><span> </span><span>vehicle_any</span><span>.</span><span>downcast_ref</span><span>::</span><span>&lt;</span><span>Trolley</span><span>&gt;</span><span>()</span><span> </span><span>{</span>
<span>        </span><span>trolley</span><span>.</span><span>ride</span><span>();</span>
<span>    </span><span>}</span><span> </span><span>else</span><span> </span><span>{</span>
<span>        </span><span>bail</span><span>!</span><span>(</span><span>&#34;Not sure how to ride this vehicle!&#34;</span><span>);</span>
<span>    </span><span>}</span>
<span>    </span><span>Ok</span><span>(())</span>
<span>}</span>

<span>fn</span><span> </span><span>main</span><span>()</span><span> </span><span>-&gt;</span><span> </span><span>Result</span><span>&lt;</span><span>()</span><span>&gt;</span><span> </span><span>{</span>
<span>    </span><span>let</span><span> </span><span>car</span><span> </span><span>=</span><span> </span><span>Car</span><span>::</span><span>default</span><span>();</span>
<span>    </span><span>let</span><span> </span><span>trolley</span><span> </span><span>=</span><span> </span><span>Trolley</span><span>::</span><span>default</span><span>();</span>
<span>    </span><span>let</span><span> </span><span>rover</span><span> </span><span>=</span><span> </span><span>Dog</span><span>::</span><span>default</span><span>();</span>
<span>    </span><span>take_public_transit</span><span>(</span><span>&amp;</span><span>trolley</span><span>)</span><span>?</span><span>;</span>
<span>    </span><span>car</span><span>.</span><span>drive</span><span>();</span>
<span>    </span><span>watch_out</span><span>(</span><span>&amp;</span><span>car</span><span>);</span>
<span>    </span><span>// take_public_transit(&amp;rover);</span>
<span>    </span><span>// The above line produces a compiler error</span>
<span>    </span><span>// since it doesn&#39;t satisfy trait bounds</span>
<span>    </span><span>Ok</span><span>(())</span>
<span>}</span>
</code></pre></div>

<p><code>Any</code> can also downcast trait objects. Trait objects use
&#34;dynamic dispatch&#34;. Unlike in our last example where
<code>take_public_transit</code> is compiled for every type that
it supports, trait objects have a shared
&#34;<a href="https://doc.rust-lang.org/reference/types/trait-object.html#trait-objects">vtable</a>&#34; that points to the implementation for each type.
At <em>runtime</em>,
the memory location of the implementation for the
specific type is looked up
in this vtable when it is called.
This has a very small performance
hit, but it lets us put objects of different types side by
side in a collection like a <code>Vec&lt;_&gt;</code>. (It&#39;s worth noting
here that the ability to do this is useful by itself.
It doesn&#39;t necessarily need to be paired with <code>Any</code> --
only if you want to be able to downcast.)</p>
<p>To make downcasting work, a function that casts the trait object to <code>Any</code>
(<code>.as_any</code> in this example)
must be added to
the trait.</p>
<div><pre><span></span><code><span>use</span><span> </span><span>anyhow</span><span>::{</span><span>bail</span><span>,</span><span> </span><span>Result</span><span>};</span>
<span>use</span><span> </span><span>std</span><span>::</span><span>any</span><span>::</span><span>Any</span><span>;</span>

<span>trait</span><span> </span><span>Vehicle</span><span> </span><span>{</span>
<span>    </span><span>fn</span><span> </span><span>alert</span><span>(</span><span>&amp;</span><span>self</span><span>);</span>
<span>    </span><span>fn</span><span> </span><span>as_any</span><span>(</span><span>&amp;</span><span>self</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>&amp;</span><span>dyn</span><span> </span><span>Any</span><span>;</span>
<span>}</span>

<span>#[derive(Default)]</span>
<span>struct</span><span> </span><span>Car</span><span> </span><span>{}</span>

<span>impl</span><span> </span><span>Vehicle</span><span> </span><span>for</span><span> </span><span>Car</span><span> </span><span>{</span>
<span>    </span><span>fn</span><span> </span><span>alert</span><span>(</span><span>&amp;</span><span>self</span><span>)</span><span> </span><span>{</span>
<span>        </span><span>println!</span><span>(</span><span>&#34;Honk! Honk!&#34;</span><span>);</span>
<span>    </span><span>}</span>

<span>    </span><span>fn</span><span> </span><span>as_any</span><span>(</span><span>&amp;</span><span>self</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>&amp;</span><span>dyn</span><span> </span><span>Any</span><span> </span><span>{</span>
<span>        </span><span>self</span>
<span>    </span><span>}</span>
<span>}</span>

<span>impl</span><span> </span><span>Car</span><span> </span><span>{</span>
<span>    </span><span>fn</span><span> </span><span>drive</span><span>(</span><span>&amp;</span><span>self</span><span>)</span><span> </span><span>{</span>
<span>        </span><span>println!</span><span>(</span><span>&#34;Driving the car!&#34;</span><span>);</span>
<span>    </span><span>}</span>
<span>}</span>

<span>#[derive(Default)]</span>
<span>struct</span><span> </span><span>Trolley</span><span> </span><span>{}</span>

<span>impl</span><span> </span><span>Vehicle</span><span> </span><span>for</span><span> </span><span>Trolley</span><span> </span><span>{</span>
<span>    </span><span>fn</span><span> </span><span>alert</span><span>(</span><span>&amp;</span><span>self</span><span>)</span><span> </span><span>{</span>
<span>        </span><span>println!</span><span>(</span><span>&#34;Ding! Ding!&#34;</span><span>);</span>
<span>    </span><span>}</span>

<span>    </span><span>fn</span><span> </span><span>as_any</span><span>(</span><span>&amp;</span><span>self</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>&amp;</span><span>dyn</span><span> </span><span>Any</span><span> </span><span>{</span>
<span>        </span><span>self</span>
<span>    </span><span>}</span>
<span>}</span>

<span>impl</span><span> </span><span>Trolley</span><span> </span><span>{</span>
<span>    </span><span>fn</span><span> </span><span>ride</span><span>(</span><span>&amp;</span><span>self</span><span>)</span><span> </span><span>{</span>
<span>        </span><span>println!</span><span>(</span><span>&#34;Riding the trolley!&#34;</span><span>);</span>
<span>    </span><span>}</span>
<span>}</span>

<span>fn</span><span> </span><span>take_public_transit</span><span>(</span><span>vehicle</span><span>:</span><span> </span><span>&amp;</span><span>Box</span><span>&lt;</span><span>dyn</span><span> </span><span>Vehicle</span><span>&gt;</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>Result</span><span>&lt;</span><span>()</span><span>&gt;</span><span> </span><span>{</span>
<span>    </span><span>let</span><span> </span><span>vehicle_any</span><span> </span><span>=</span><span> </span><span>vehicle</span><span>.</span><span>as_any</span><span>();</span>
<span>    </span><span>if</span><span> </span><span>let</span><span> </span><span>Some</span><span>(</span><span>trolley</span><span>)</span><span> </span><span>=</span><span> </span><span>vehicle_any</span><span>.</span><span>downcast_ref</span><span>::</span><span>&lt;</span><span>Trolley</span><span>&gt;</span><span>()</span><span> </span><span>{</span>
<span>        </span><span>trolley</span><span>.</span><span>ride</span><span>();</span>
<span>    </span><span>}</span><span> </span><span>else</span><span> </span><span>{</span>
<span>        </span><span>bail</span><span>!</span><span>(</span><span>&#34;Not sure how to ride this vehicle!&#34;</span><span>);</span>
<span>    </span><span>}</span>
<span>    </span><span>Ok</span><span>(())</span>
<span>}</span>

<span>fn</span><span> </span><span>main</span><span>()</span><span> </span><span>{</span>
<span>    </span><span>let</span><span> </span><span>vehicles</span><span>:</span><span> </span><span>Vec</span><span>&lt;</span><span>Box</span><span>&lt;</span><span>dyn</span><span> </span><span>Vehicle</span><span>&gt;&gt;</span><span> </span><span>=</span>
<span>        </span><span>vec!</span><span>[</span><span>Box</span><span>::</span><span>new</span><span>(</span><span>Car</span><span>::</span><span>default</span><span>()),</span><span> </span><span>Box</span><span>::</span><span>new</span><span>(</span><span>Trolley</span><span>::</span><span>default</span><span>())];</span>
<span>    </span><span>for</span><span> </span><span>vehicle</span><span> </span><span>in</span><span> </span><span>vehicles</span><span>.</span><span>iter</span><span>()</span><span> </span><span>{</span>
<span>        </span><span>if</span><span> </span><span>take_public_transit</span><span>(</span><span>vehicle</span><span>).</span><span>is_err</span><span>()</span><span> </span><span>{</span>
<span>            </span><span>println!</span><span>(</span><span>&#34;Didn&#39;t ride public transit!&#34;</span><span>);</span>
<span>        </span><span>}</span>
<span>        </span><span>vehicle</span><span>.</span><span>alert</span><span>();</span>
<span>    </span><span>}</span>
<span>}</span>
</code></pre></div>

<h2>That&#39;s all for now</h2>
<p>So that&#39;s a few cool things about Rust that once I figured
out, unlocked the ability to write programs that really
do useful things. I hope it helps some folks out there climb
up the Rust learning curve!</p>
<p>Thanks to <a href="https://jordan.matelsky.com/">Jordan</a>
for reviewing an early draft of this post!</p>
  </div></div>
  </body>
</html>
