<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/robjinman/richard">Original</a>
    <h1>Show HN: Richard â€“ A CNN written in C&#43;&#43; and Vulkan (no ML or math libs)</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><em>Richard is gaining power.</em></p>
<p dir="auto">Named after one of the first programs I ever wrote as a child, Richard started out as a personal effort to learn more about machine learning. The original Richard was meant to be a &#34;virus&#34;, but the most malicious thing I could do on my Psion Series 3 personal organiser was print the phrase &#34;Richard is gaining power&#34; in an infinite loop.</p>
<p dir="auto">The new version of Richard is strictly benevolent.</p>
<p dir="auto">In its current form, Richard is a CLI application that performs classification using a neural network. Supported layer types include dense, convolutional, and max pooling, but there will likely be others in the future.</p>
<p dir="auto">GPU acceleration is supported with Vulkan compute shaders.</p>



<p dir="auto">Install CMake.</p>
<p dir="auto">Install the Vulkan SDK</p>
<div data-snippet-clipboard-copy-content="    # See https://vulkan.lunarg.com/sdk/home

    wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
    sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-1.3.275-jammy.list https://packages.lunarg.com/vulkan/1.3.275/lunarg-vulkan-1.3.275-jammy.list
    sudo apt update
    sudo apt install vulkan-sdk"><pre><code>    # See https://vulkan.lunarg.com/sdk/home

    wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
    sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-1.3.275-jammy.list https://packages.lunarg.com/vulkan/1.3.275/lunarg-vulkan-1.3.275-jammy.list
    sudo apt update
    sudo apt install vulkan-sdk
</code></pre></div>
<p dir="auto">Install development dependencies</p>
<div data-snippet-clipboard-copy-content="    sudo apt install \
        build-essential \
        libboost-program-options-dev"><pre><code>    sudo apt install \
        build-essential \
        libboost-program-options-dev
</code></pre></div>

<p dir="auto">To make a release build</p>
<div data-snippet-clipboard-copy-content="    mkdir -p build/release &amp;&amp; cd &#34;$_&#34;
    cmake -D CMAKE_BUILD_TYPE=Release -G &#34;Unix Makefiles&#34; ../..
    make -j8"><pre><code>    mkdir -p build/release &amp;&amp; cd &#34;$_&#34;
    cmake -D CMAKE_BUILD_TYPE=Release -G &#34;Unix Makefiles&#34; ../..
    make -j8
</code></pre></div>
<p dir="auto">And for a debug build</p>
<div data-snippet-clipboard-copy-content="    mkdir -p build/debug &amp;&amp; cd &#34;$_&#34;
    cmake -D CMAKE_BUILD_TYPE=Debug -G &#34;Unix Makefiles&#34; ../..
    make -j8"><pre><code>    mkdir -p build/debug &amp;&amp; cd &#34;$_&#34;
    cmake -D CMAKE_BUILD_TYPE=Debug -G &#34;Unix Makefiles&#34; ../..
    make -j8
</code></pre></div>


<p dir="auto">Install CMake, Python 3, and the Vulkan SDK.</p>

<p dir="auto">To build the release configuration, open a powershell and run</p>
<div data-snippet-clipboard-copy-content="    cd (mkdir build/release)
    cmake -D CMAKE_BUILD_TYPE=Release -G &#34;Visual Studio 17 2022&#34; ../..
    cmake --build . --config Release"><pre><code>    cd (mkdir build/release)
    cmake -D CMAKE_BUILD_TYPE=Release -G &#34;Visual Studio 17 2022&#34; ../..
    cmake --build . --config Release
</code></pre></div>
<p dir="auto">And for the debug configuration</p>
<div data-snippet-clipboard-copy-content="    cd (mkdir build/debug)
    cmake -D CMAKE_BUILD_TYPE=Debug -G &#34;Visual Studio 17 2022&#34; ../..
    cmake --build . --config Debug"><pre><code>    cd (mkdir build/debug)
    cmake -D CMAKE_BUILD_TYPE=Debug -G &#34;Visual Studio 17 2022&#34; ../..
    cmake --build . --config Debug
</code></pre></div>
<p dir="auto">Supply the <code>-D BUILD_TOOLS=1</code> option if you want to build the tools.</p>

<p dir="auto">To see usage</p>
<div data-snippet-clipboard-copy-content="    ./richardcli/richardcli -h"><pre><code>    ./richardcli/richardcli -h
</code></pre></div>

<p dir="auto">All examples are run from the build directory, e.g. build/release, and assume you have datasets located under data/.</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Classifying hand-written digits with a fully connected network</h3><a id="user-content-classifying-hand-written-digits-with-a-fully-connected-network" aria-label="Permalink: Classifying hand-written digits with a fully connected network" href="#classifying-hand-written-digits-with-a-fully-connected-network"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>

<div data-snippet-clipboard-copy-content="    {
        &#34;data&#34;: {
            &#34;classes&#34;: [&#34;0&#34;, &#34;1&#34;, &#34;2&#34;, &#34;3&#34;, &#34;4&#34;, &#34;5&#34;, &#34;6&#34;, &#34;7&#34;, &#34;8&#34;, &#34;9&#34;],
            &#34;shape&#34;: [784, 1, 1],
            &#34;normalization&#34;: {
                &#34;min&#34;: 0,
                &#34;max&#34;: 255
            }
        },
        &#34;dataLoader&#34;: {
          &#34;fetchSize&#34;: 512
        },
        &#34;classifier&#34;: {
            &#34;network&#34;: {
                &#34;hyperparams&#34;: {
                    &#34;epochs&#34;: 30,
                    &#34;batchSize&#34;: 1024,
                    &#34;miniBatchSize&#34;: 32,
                },
                &#34;hiddenLayers&#34;: [
                    {
                        &#34;type&#34;: &#34;dense&#34;,
                        &#34;size&#34;: 320,
                        &#34;learnRate&#34;: 0.1,
                        &#34;learnRateDecay&#34;: 1.0,
                        &#34;dropoutRate&#34;: 0.0
                    },
                    {
                        &#34;type&#34;: &#34;dense&#34;,
                        &#34;size&#34;: 64,
                        &#34;learnRate&#34;: 0.1,
                        &#34;learnRateDecay&#34;: 1.0,
                        &#34;dropoutRate&#34;: 0.0
                    }
                ],
                &#34;outputLayer&#34;: {
                    &#34;size&#34;: 10,
                    &#34;learnRate&#34;: 0.1,
                    &#34;learnRateDecay&#34;: 1.0
                }
            }
        }
    }
"><pre><code>    {
        &#34;data&#34;: {
            &#34;classes&#34;: [&#34;0&#34;, &#34;1&#34;, &#34;2&#34;, &#34;3&#34;, &#34;4&#34;, &#34;5&#34;, &#34;6&#34;, &#34;7&#34;, &#34;8&#34;, &#34;9&#34;],
            &#34;shape&#34;: [784, 1, 1],
            &#34;normalization&#34;: {
                &#34;min&#34;: 0,
                &#34;max&#34;: 255
            }
        },
        &#34;dataLoader&#34;: {
          &#34;fetchSize&#34;: 512
        },
        &#34;classifier&#34;: {
            &#34;network&#34;: {
                &#34;hyperparams&#34;: {
                    &#34;epochs&#34;: 30,
                    &#34;batchSize&#34;: 1024,
                    &#34;miniBatchSize&#34;: 32,
                },
                &#34;hiddenLayers&#34;: [
                    {
                        &#34;type&#34;: &#34;dense&#34;,
                        &#34;size&#34;: 320,
                        &#34;learnRate&#34;: 0.1,
                        &#34;learnRateDecay&#34;: 1.0,
                        &#34;dropoutRate&#34;: 0.0
                    },
                    {
                        &#34;type&#34;: &#34;dense&#34;,
                        &#34;size&#34;: 64,
                        &#34;learnRate&#34;: 0.1,
                        &#34;learnRateDecay&#34;: 1.0,
                        &#34;dropoutRate&#34;: 0.0
                    }
                ],
                &#34;outputLayer&#34;: {
                    &#34;size&#34;: 10,
                    &#34;learnRate&#34;: 0.1,
                    &#34;learnRateDecay&#34;: 1.0
                }
            }
        }
    }

</code></pre></div>
<div data-snippet-clipboard-copy-content="    ./richardcli/richardcli --train \
        --samples ../../data/ocr/train.csv \
        --config ../../data/ocr/config.json \
        --network ../../data/ocr/network \
        --gpu

    ../richardcli/richardcli --eval \
        --samples ../../data/ocr/test.csv \
        --network ../../data/ocr/network \
        --gpu"><pre><code>    ./richardcli/richardcli --train \
        --samples ../../data/ocr/train.csv \
        --config ../../data/ocr/config.json \
        --network ../../data/ocr/network \
        --gpu

    ../richardcli/richardcli --eval \
        --samples ../../data/ocr/test.csv \
        --network ../../data/ocr/network \
        --gpu
</code></pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">Classifying cats and dogs with a CNN</h3><a id="user-content-classifying-cats-and-dogs-with-a-cnn" aria-label="Permalink: Classifying cats and dogs with a CNN" href="#classifying-cats-and-dogs-with-a-cnn"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>

<div data-snippet-clipboard-copy-content="    {
        &#34;data&#34;: {
            &#34;classes&#34;: [&#34;cat&#34;, &#34;dog&#34;],
            &#34;shape&#34;: [100, 100, 3],
            &#34;normalization&#34;: {
                &#34;min&#34;: 0,
                &#34;max&#34;: 255
            }
        },
        &#34;dataLoader&#34;: {
          &#34;fetchSize&#34;: 512
        },
        &#34;classifier&#34;: {
            &#34;network&#34;: {
                &#34;hyperparams&#34;: {
                    &#34;epochs&#34;: 10,
                    &#34;batchSize&#34;: 1024,
                    &#34;miniBatchSize&#34;: 32,
                },
                &#34;hiddenLayers&#34;: [
                    {
                        &#34;type&#34;: &#34;convolutional&#34;,
                        &#34;depth&#34;: 32,
                        &#34;kernelSize&#34;: [3, 3],
                        &#34;learnRate&#34;: 0.01,
                        &#34;learnRateDecay&#34;: 1.0,
                        &#34;dropoutRate&#34;: 0.0
                    },
                    {
                        &#34;type&#34;: &#34;maxPooling&#34;,
                        &#34;regionSize&#34;: [2, 2]
                    },
                    {
                        &#34;type&#34;: &#34;convolutional&#34;,
                        &#34;depth&#34;: 64,
                        &#34;kernelSize&#34;: [4, 4],
                        &#34;learnRate&#34;: 0.01,
                        &#34;learnRateDecay&#34;: 1.0,
                        &#34;dropoutRate&#34;: 0.0
                    },
                    {
                        &#34;type&#34;: &#34;maxPooling&#34;,
                        &#34;regionSize&#34;: [2, 2]
                    },
                    {
                        &#34;type&#34;: &#34;dense&#34;,
                        &#34;size&#34;: 64,
                        &#34;learnRate&#34;: 0.01,
                        &#34;learnRateDecay&#34;: 1.0,
                        &#34;dropoutRate&#34;: 0.0
                    }
                ],
                &#34;outputLayer&#34;: {
                    &#34;size&#34;: 2,
                    &#34;learnRate&#34;: 0.01,
                    &#34;learnRateDecay&#34;: 1.0
                }
            }
        }
    }"><pre><code>    {
        &#34;data&#34;: {
            &#34;classes&#34;: [&#34;cat&#34;, &#34;dog&#34;],
            &#34;shape&#34;: [100, 100, 3],
            &#34;normalization&#34;: {
                &#34;min&#34;: 0,
                &#34;max&#34;: 255
            }
        },
        &#34;dataLoader&#34;: {
          &#34;fetchSize&#34;: 512
        },
        &#34;classifier&#34;: {
            &#34;network&#34;: {
                &#34;hyperparams&#34;: {
                    &#34;epochs&#34;: 10,
                    &#34;batchSize&#34;: 1024,
                    &#34;miniBatchSize&#34;: 32,
                },
                &#34;hiddenLayers&#34;: [
                    {
                        &#34;type&#34;: &#34;convolutional&#34;,
                        &#34;depth&#34;: 32,
                        &#34;kernelSize&#34;: [3, 3],
                        &#34;learnRate&#34;: 0.01,
                        &#34;learnRateDecay&#34;: 1.0,
                        &#34;dropoutRate&#34;: 0.0
                    },
                    {
                        &#34;type&#34;: &#34;maxPooling&#34;,
                        &#34;regionSize&#34;: [2, 2]
                    },
                    {
                        &#34;type&#34;: &#34;convolutional&#34;,
                        &#34;depth&#34;: 64,
                        &#34;kernelSize&#34;: [4, 4],
                        &#34;learnRate&#34;: 0.01,
                        &#34;learnRateDecay&#34;: 1.0,
                        &#34;dropoutRate&#34;: 0.0
                    },
                    {
                        &#34;type&#34;: &#34;maxPooling&#34;,
                        &#34;regionSize&#34;: [2, 2]
                    },
                    {
                        &#34;type&#34;: &#34;dense&#34;,
                        &#34;size&#34;: 64,
                        &#34;learnRate&#34;: 0.01,
                        &#34;learnRateDecay&#34;: 1.0,
                        &#34;dropoutRate&#34;: 0.0
                    }
                ],
                &#34;outputLayer&#34;: {
                    &#34;size&#34;: 2,
                    &#34;learnRate&#34;: 0.01,
                    &#34;learnRateDecay&#34;: 1.0
                }
            }
        }
    }
</code></pre></div>
<div data-snippet-clipboard-copy-content="    ./richardcli/richardcli --train \
        --samples ../../data/catdog/train \
        --config ../../data/catdog/config.json \
        --network ../../data/catdog/network \
        --gpu

    ./richardcli/richardcli --eval \
        --samples ../../data/catdog/test \
        --network ../../data/catdog/network \
        --gpu"><pre><code>    ./richardcli/richardcli --train \
        --samples ../../data/catdog/train \
        --config ../../data/catdog/config.json \
        --network ../../data/catdog/network \
        --gpu

    ./richardcli/richardcli --eval \
        --samples ../../data/catdog/test \
        --network ../../data/catdog/network \
        --gpu
</code></pre></div>


<p dir="auto">Install google perftools</p>
<div data-snippet-clipboard-copy-content="    sudo apt install google-perftools"><pre><code>    sudo apt install google-perftools
</code></pre></div>
<p dir="auto">Make a release build and supply the -D CPU_PROFILE=1 option</p>
<div data-snippet-clipboard-copy-content="    cmake -D CMAKE_BUILD_TYPE=Release -D CPU_PROFILE=1 -G &#34;Unix Makefiles&#34; ../..
    make -j8"><pre><code>    cmake -D CMAKE_BUILD_TYPE=Release -D CPU_PROFILE=1 -G &#34;Unix Makefiles&#34; ../..
    make -j8
</code></pre></div>
<p dir="auto">Specify the intermediate file in the CPUPROFILE environment variable and run as usual, e.g.</p>
<div data-snippet-clipboard-copy-content="    CPUPROFILE=./prof.out ./richardcli/richardcli --train \
        --samples ../../data/ocr/train.csv \
        --config ../../data/ocr/config_cnn.json \
        --network ../../data/ocr/network"><pre><code>    CPUPROFILE=./prof.out ./richardcli/richardcli --train \
        --samples ../../data/ocr/train.csv \
        --config ../../data/ocr/config_cnn.json \
        --network ../../data/ocr/network
</code></pre></div>
<p dir="auto">For text output</p>
<div data-snippet-clipboard-copy-content="    google-pprof --text ./richardcli/richardcli ./prof.out &gt; ./prof.txt"><pre><code>    google-pprof --text ./richardcli/richardcli ./prof.out &gt; ./prof.txt
</code></pre></div>
<p dir="auto">For graphical output</p>
<div data-snippet-clipboard-copy-content="    google-pprof --gv ./richardcli/richardcli ./prof.out "><pre><code>    google-pprof --gv ./richardcli/richardcli ./prof.out 
</code></pre></div>

<p dir="auto">The text file should contain something like this</p>
<div data-snippet-clipboard-copy-content="    Total: 2823 samples
        1166  41.3%  41.3%     1277  45.2% richard::computeCrossCorrelation
        1039  36.8%  78.1%     1145  40.6% richard::computeFullCrossCorrelation
        199   7.0%  85.2%      199   7.0% richard::Kernel::at (inline)
        ..."><pre><code>    Total: 2823 samples
        1166  41.3%  41.3%     1277  45.2% richard::computeCrossCorrelation
        1039  36.8%  78.1%     1145  40.6% richard::computeFullCrossCorrelation
        199   7.0%  85.2%      199   7.0% richard::Kernel::at (inline)
        ...
</code></pre></div>
<p dir="auto">The first column is the number of samples spent inside the function.</p>
<p dir="auto">The second column is this same number expressed as a percentage of the total samples taken. So in this case, we spent 41.3% of the time executing computeCrossCorrelation.</p>
<p dir="auto">The third column is the cumulative time spent inside the function. In this example, 85.2% of the execution time is accounted for by these top 3 functions.</p>
<p dir="auto">The next two columns tell us for how long the given function was part of the call stack. In other words, it includes time spent executing child calls. So in this example, we spent 40.6% of the time inside computeFullCrossCorrelation (including child calls), but only 36.8% actually within the computeFullCrossCorrelation function itself.</p>
</article></div></div>
  </body>
</html>
