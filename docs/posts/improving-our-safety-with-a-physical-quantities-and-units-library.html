<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2023/p2981r1.html">Original</a>
    <h1>Improving our safety with a physical quantities and units library</h1>
    
    <div id="readability-page-1" class="page"><div>

<div>


<h2 data-number="1.1" id="changes-since-p2981r0"> Changes since <span data-cites="P2981R0">[<a href="#ref-P2981R0" role="doc-biblioref">P2981R0</a>]</span><a href="#changes-since-p2981r0"></a></h2>
<ul>
<li>Added The Guardian’s Fahrenheit issue to <a href="#mismeasure-for-measure">Mismeasure for measure</a>.</li>
<li>Fuel consumption example extended in <a href="#converting-between-quantities-of-the-same-kind">Converting
between quantities of the same kind</a>.</li>
<li><span data-cites="VCINL">[<a href="#ref-VCINL" role="doc-biblioref">Value Category Is Not Lifetime</a>]</span>
reference added to <a href="#preventing-dangling-references">Preventing
dangling references</a>.</li>
<li>Value-preserving type trait mentioned in <a href="#lack-of-safe-numeric-types">Lack of safe numeric types</a>.</li>
<li><a href="#non-negative-quantities">Non-negative quantities</a>
rewritten.</li>
<li><a href="#limitations-of-systems-of-quantities">Limitations of
systems of quantities</a> added.</li>
<li><a href="#temperatures">Temperatures</a> added.</li>
<li>Some small editorial fixes.</li>
</ul>

<p>One of the ways C++ can significantly improve the safety of
applications being written by thousands of developers is by introducing
a type-safe, well-tested, proven in production, standardized way to
handle physical quantities and their units. The rationale is that people
tend to have problems communicating or using proper units in code and
daily life. Another benefit of adding strongly typed quantities and
units to the standard is that it will allow catching some mistakes at
compile-time instead of relying on runtime checks which might have
spotty coverage.</p>
<p>This paper scopes on the safety aspects of introducing such a library
to the C++ standard. In the following chapters, we will describe which
industries are desperately looking for such standardized solutions,
enumerate some failures and accidents caused by misinterpretation of
quantities and units in human history, review all the features of such a
library that improve the safety of our code, and also discuss potential
safety issues that the library does not prevent against.</p>
<p><em>Note: This paper refers to practices used in the <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span> library and presents code
examples using its interfaces. Those may not exactly reflect the final
interface design that is going to be proposed in the follow-up papers.
We are still doing some small fine-tuning to improve the
library.</em></p>

<p>This document consistently uses the official metrology vocabulary
defined in the <span data-cites="ISO-GUIDE">[<a href="#ref-ISO-GUIDE" role="doc-biblioref">ISO/IEC Guide 99</a>]</span>
and <span data-cites="BIPM-VIM">[<a href="#ref-BIPM-VIM" role="doc-biblioref">JCGM 200:2012</a>]</span>.</p>

<p>Not that long ago, self-driving cars were a thing from SciFi movies.
It was something so futuristic and hard to imagine that it only appeared
in movies set in the very far future. Today, autonomous cars are
becoming a reality on our streets even if they are not (yet) widely
adopted.</p>
<p>It is no longer only the space industry or airline pilots that
benefit from the autonomous operations of some machines. We live in a
world where more and more ordinary people trust machines with their
lives daily. The autonomous car is just one example which will affect
our daily life. Medical devices, such as surgical robots and smart
health care devices, are already a thing and will see wider adoption in
the future. And there will be more machines with safety- or even
life-critical tasks in the future. As a result, many more C++ engineers
are expected to write life-critical software today than a few years
ago.</p>
<p>Unfortunately, experience in this domain is hard to come by, and
training alone will not solve the issue of mistakes caused by confusing
units or quantities. Additionally, the C++ standard does not change fast
enough to enforce a safe-by-construction code, which becomes even more
critical if the code handling the physical computation is written by
domain experts such as physicists that are not necessarily fluent in
C++.</p>

<p>When people think about industries that could use physical quantities
and unit libraries, they think of a few companies related to aerospace,
autonomous cars, or embedded industries. That is all true, but there are
many other potential users for such a library.</p>
<p>Here is a list of some less obvious candidates:</p>
<ul>
<li>Manufacturing,</li>
<li>maritime industry,</li>
<li>freight transport,</li>
<li>military,</li>
<li>astronomy,</li>
<li>3D design,</li>
<li>robotics,</li>
<li>audio,</li>
<li>medical devices,</li>
<li>national laboratories,</li>
<li>scientific institutions and universities,</li>
<li>all kinds of navigation and charting,</li>
<li>GUI frameworks,</li>
<li>finance (including HFT).</li>
</ul>
<p>As we can see, the range of domains for such a library is vast and
not limited to applications involving specifically physical units. Any
software that involves measurements, or operations on counts of some
standard or domain-specific quantities, could benefit from a zero-cost
abstraction for operating on quantity values and their units. The
library also provides affine space abstractions, which may prove useful
in many applications.</p>

<p>Human history knows many expensive failures and accidents caused by
mistakes in calculations involving different physical units. The most
famous and probably the most expensive example in the software
engineering domain is the Mars Climate Orbiter that in 1999 failed to
enter Mars’ orbit and crashed while entering its atmosphere <span data-cites="MARS_ORBITER">[<a href="#ref-MARS_ORBITER" role="doc-biblioref">Mars Orbiter</a>]</span>. This is one of many
examples here. People tend to confuse units quite often. We see similar
errors occurring in various domains over the years:</p>
<ul>
<li>On October 12, 1492, Christopher Columbus unintentionally discovered
the sea route from Europe to America because, during his travel
preparations, he mixed the Arabic mile with a Roman mile, which led to
the wrong estimation of the equator and his expected travel distance
<span data-cites="COLUMBUS">[<a href="#ref-COLUMBUS" role="doc-biblioref">Columbus</a>]</span>.</li>
<li>In 1628, a new warship, Vasa, accidentally had an asymmetrical hull
(being thicker on the port side than the starboard side), which was one
of the reasons for her sinking less than a mile into her maiden voyage,
resulting in the death of 30 people on board. This asymmetry could have
been caused by the use of different systems of measurement, as
archaeologists have found four rulers used by the workers who built the
ship. Two were calibrated in Swedish feet, which had 12 inches, while
the other two measured Amsterdam feet, which had 11 inches <span data-cites="VASA">[<a href="#ref-VASA" role="doc-biblioref">Vasa</a>]</span>.</li>
<li>Air Canada Flight 143 ran out of fuel on July 23, 1983, at an
altitude of 41 000 feet (12 000 metres), midway through the flight
because the fuel had been calculated in pounds instead of kilograms by
the ground crew <span data-cites="GIMLI_GLIDER">[<a href="#ref-GIMLI_GLIDER" role="doc-biblioref">Gimli
Glider</a>]</span>.</li>
<li>The British rock band Black Sabbath, during its Born Again tour in
1983, ordered a replica of Stonehenge as props for the scene.
Unfortunately, they had to leave them in the storage area because, while
submitting the order, their manager wrote dimensions down in meters when
he meant feet, and so the stones didn’t fit the scene. “It cost a
fortune to make, but there was not a building on Earth that you could
fit it into” <span data-cites="STONEHENGE">[<a href="#ref-STONEHENGE" role="doc-biblioref">Stonehenge</a>]</span>.</li>
<li>On April 15, 1999, Korean Air Cargo Flight 6316 crashed due to a
miscommunication between pilots about the desired flight altitude <span data-cites="FLIGHT_6316">[<a href="#ref-FLIGHT_6316" role="doc-biblioref">Flight 6316</a>]</span>.</li>
<li>In February 2001, the crew of the Moorpark College Zoo built an
enclosure for Clarence the Tortoise with a weight of 250 pounds instead
of 250 kilograms <span data-cites="CLARENCE">[<a href="#ref-CLARENCE" role="doc-biblioref">Clarence</a>]</span>.</li>
<li>In December 2003, one of the roller coaster’s cars at Tokyo
Disneyland’s Space Mountain attraction suddenly derailed due to a broken
axle caused by confusion after upgrading the specification from imperial
to metric units <span data-cites="DISNEY">[<a href="#ref-DISNEY" role="doc-biblioref">Disney</a>]</span>.</li>
<li>During the construction of the Hochrheinbrücke bridge to connect the
small German town of Laufenburg with Swiss Laufenburg, the construction
team made a sign error that resulted in a discrepancy of 54 cm between
the two outer ends of the bridge <span data-cites="HOCHRHEINBRÜCKE">[<a href="#ref-HOCHRHEINBRÜCKE" role="doc-biblioref">Hochrheinbrücke</a>]</span>.</li>
<li>An American company sold a shipment of wild rice to a Japanese
customer, quoting a price of 39 cents per pound, but the customer
thought the quote was for 39 cents per kilogram <span data-cites="WILD_RICE">[<a href="#ref-WILD_RICE" role="doc-biblioref">Wild Rice</a>]</span>.</li>
<li>On October 17, 2023, The Guardian published an article titled
“Record Heat: Malawi swelters with temperatures nearly 68F above
average” with many issues related to the affine space types and
temperature units. Due to incorrect logic, probably during the
translation of the article to the U.S. market,
<code>20 °C</code> above the average
temperature was converted to
<code>68 °F</code>. The actual temperature
increase was <code>32 °F</code>, not
<code>68 °F</code> <span data-cites="THE_GUARDIAN">[<a href="#ref-THE_GUARDIAN" role="doc-biblioref">The Guardian</a>]</span>.</li>
<li>A whole set of <span data-cites="MEDICATION_DOSE_ERRORS">[<a href="#ref-MEDICATION_DOSE_ERRORS" role="doc-biblioref">Medication dose
errors</a>]</span>…</li>
</ul>

<p>In this chapter, we are going to review typical safety issues related
to physical quantities and units in the C++ code when a proper library
is not used. Even though all the examples come from the Open Source
projects, expensive revenue-generating production source code often is
similar.</p>
<h2 data-number="7.1" id="the-proliferation-of-double"> The proliferation of
<code>double</code><a href="#the-proliferation-of-double"></a></h2>
<p>It turns out that in the C++ software, most of our calculations in
the physical quantities and units domain are handled with fundamental
types like <code>double</code>. Code like
below is a typical example here:</p>
<div id="cb1"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span>double</span> GlidePolar<span>::</span>MacCreadyAltitude<span>(</span><span>double</span> MCREADY,</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>                                     <span>double</span> Distance,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                                     <span>const</span> <span>double</span> Bearing,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>                                     <span>const</span> <span>double</span> WindSpeed,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>                                     <span>const</span> <span>double</span> WindBearing,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>                                     <span>double</span> <span>*</span>BestCruiseTrack,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>                                     <span>double</span> <span>*</span>VMacCready,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>                                     <span>const</span> <span>bool</span> isFinalGlide,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>                                     <span>double</span> <span>*</span>TimeToGo,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>                                     <span>const</span> <span>double</span> AltitudeAboveTarget<span>=</span><span>1.0e6</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>                                     <span>const</span> <span>double</span> cruise_efficiency<span>=</span><span>1.0</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>                                     <span>const</span> <span>double</span> TaskAltDiff<span>=-</span><span>1.0e6</span><span>)</span>;</span></code></pre></div>
<p><a href="https://github.com/LK8000/LK8000/blob/af404168ff5f92b03ab0c5db336ed8f01a792cda/Common/Header/McReady.h#L7-L21">Original
code here</a>.</p>
<p>There are several problems with such an approach: The abundance of
<code>double</code> parameters makes it easy
to accidentally switch values and there is no way of noticing such a
mistake at compile-time. The code is not self-documenting in what units
the parameters are expected. Is
<code>Distance</code> in meters or
kilometers? Is <code>WindSpeed</code> in
meters per second or knots? Different code bases choose different ways
to encode this information, which may be internally inconsistent. A
strong type system would help answer these questions at the time the
interface is written, and the compiler would verify it at
compile-time.</p>
<h2 data-number="7.2" id="the-proliferation-of-magic-numbers"> The proliferation of magic
numbers<a href="#the-proliferation-of-magic-numbers"></a></h2>
<p>There are a lot of constants and conversion factors involved in the
quantity equations. Source code responsible for such computations is
often trashed with magic numbers:</p>
<div id="cb2"><pre><code><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span>double</span> AirDensity<span>(</span><span>double</span> hr, <span>double</span> temp, <span>double</span> abs_press<span>)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span>return</span> <span>(</span><span>1</span><span>/(</span><span>287.06</span><span>*(</span>temp<span>+</span><span>273.15</span><span>)))*(</span>abs_press <span>-</span> <span>230.617</span> <span>*</span> hr <span>*</span> exp<span>((</span><span>17.5043</span><span>*</span>temp<span>)/(</span><span>241.2</span><span>+</span>temp<span>)))</span>;</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p><a href="https://github.com/LK8000/LK8000/blob/af404168ff5f92b03ab0c5db336ed8f01a792cda/Common/Source/Library/PressureFunctions.cpp#L134-L136">Original
code here</a>.</p>
<p>Apart from the obvious readability issues, such code is hard to
maintain, and it needs a lot of domain knowledge on the developer’s
side. While it would be easy to replace these numbers with named
constants, the question of which unit the constant is in remains. Is
<code>287.06</code> in pounds per square inch
(psi) or millibars (mbar)?</p>
<h2 data-number="7.3" id="the-proliferation-of-conversion-macros"> The proliferation of conversion
macros<a href="#the-proliferation-of-conversion-macros"></a></h2>
<p>The lack of automated unit conversions often results in handwritten
conversion functions or macros that are spread everywhere among the code
base:</p>
<div id="cb3"><pre><code><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span>#ifndef PI</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span>static</span> <span>const</span> <span>double</span> PI <span>=</span> <span>(</span><span>4</span><span>*</span>atan<span>(</span><span>1</span><span>))</span>;</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span>#endif</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span>#define EARTH_DIAMETER    </span><span>12733426.0</span><span>    </span><span>// Diameter of earth in meters</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span>#define SQUARED_EARTH_DIAMETER  </span><span>162140137697476.0</span><span> </span><span>// Diameter of earth in meters (EARTH_DIAMETER*EARTH_DIAMETER)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span>#ifndef DEG_TO_RAD</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span>#define DEG_TO_RAD  </span><span>(</span>PI<span> </span><span>/</span><span> </span><span>180</span><span>)</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span>#define RAD_TO_DEG  </span><span>(</span><span>180</span><span> </span><span>/</span><span> </span>PI<span>)</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span>#endif</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span>#define NAUTICALMILESTOMETRES </span><span>(</span><span>double</span><span>)</span><span>1851.96</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span>#define KNOTSTOMETRESSECONDS </span><span>(</span><span>double</span><span>)</span><span>0.5144</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span>#define TOKNOTS </span><span>(</span><span>double</span><span>)</span><span>1.944</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span>#define TOFEETPERMINUTE </span><span>(</span><span>double</span><span>)</span><span>196.9</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span>#define TOMPH   </span><span>(</span><span>double</span><span>)</span><span>2.237</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span>#define TOKPH   </span><span>(</span><span>double</span><span>)</span><span>3.6</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span>// meters to.. conversion</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span>#define TONAUTICALMILES </span><span>(</span><span>1.0</span><span> </span><span>/</span><span> </span><span>1852.0</span><span>)</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span>#define TOMILES         </span><span>(</span><span>1.0</span><span> </span><span>/</span><span> </span><span>1609.344</span><span>)</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span>#define TOKILOMETER     </span><span>(</span><span>0.001</span><span>)</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span>#define TOFEET          </span><span>(</span><span>1.0</span><span> </span><span>/</span><span> </span><span>0.3048</span><span>)</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span>#define TOMETER         </span><span>(</span><span>1.0</span><span>)</span></span></code></pre></div>
<p><a href="https://github.com/LK8000/LK8000/blob/052bbc20a106fda4db41874e788e39020fb86512/Common/Header/Defines.h#L901-L924">Original
code here</a>.</p>
<p>Again, the question of which unit the constant is in remains. Without
looking at the code, it is impossible to tell from which unit
<code>TOMETER</code> converts. Also, macros
have the problem that they are not scoped to a namespace and thus can
easily clash with other macros or functions, especially if they have
such common names like <code>PI</code> or
<code>RAD_TO_DEG</code>. A quick search
through open source C++ code bases reveals that, for example, the
<code>RAD_TO_DEG</code> macro is defined in a
multitude of different ways – sometimes even within the same
repository:</p>
<div id="cb4"><pre><code><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span>#define RAD_TO_DEG </span><span>(</span><span>180</span><span> </span><span>/</span><span> </span>PI<span>)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span>#define RAD_TO_DEG </span><span>57.2957795131</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span>#define RAD_TO_DEG </span><span>(</span><span> </span>radians<span> </span><span>)</span><span> </span><span>((</span>radians<span> </span><span>)</span><span> </span><span>*</span><span> </span><span>180.0</span><span> </span><span>/</span><span> </span>M_PI<span>)</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span>#define RAD_TO_DEG </span><span>57.2957805</span><span>f</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span>...</span></span></code></pre></div>
<p><a href="https://github.com/search?q=lang%3AC%2B%2B++%22%23define+RAD_TO_DEG%22&amp;type=code">Example
search across multiple repositories</a></p>
<p><a href="https://github.com/search?q=repo%3ALK8000%2FLK8000%20rad_to_deg&amp;type=code">Multiple
redefinitions in the same repository</a></p>
<p>Another safety issue occurring here is the fact that macro values can
be deliberately tainted by compiler settings at built time and can
acquire values that are not present in the source code. Human reviews
won’t catch such issues.</p>
<p>Also, most of the macros do not follow best practices. Often,
necessary parentheses are missing, processing in a preprocessor ends up
with redundant casts, or some compile-time constants use too many digits
for a value to be exact for a specific type
(e.g. <code>float</code>).</p>
<h2 data-number="7.4" id="lack-of-consistency"> Lack of consistency<a href="#lack-of-consistency"></a></h2>
<p>If we not only lack strong types to isolate the abstractions from
each other, but also lack discipline to keep our code consistent, we end
up in an awful place:</p>
<div id="cb5"><pre><code><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span>void</span> DistanceBearing<span>(</span><span>double</span> lat1, <span>double</span> lon1,</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                     <span>double</span> lat2, <span>double</span> lon2,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                     <span>double</span> <span>*</span>Distance, <span>double</span> <span>*</span>Bearing<span>)</span>;</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span>double</span> DoubleDistance<span>(</span><span>double</span> lat1, <span>double</span> lon1,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                      <span>double</span> lat2, <span>double</span> lon2,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>                      <span>double</span> lat3, <span>double</span> lon3<span>)</span>;</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span>void</span> FindLatitudeLongitude<span>(</span><span>double</span> Lat, <span>double</span> Lon,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>                           <span>double</span> Bearing, <span>double</span> Distance,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>                           <span>double</span> <span>*</span>lat_out, <span>double</span> <span>*</span>lon_out<span>)</span>;</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span>double</span> CrossTrackError<span>(</span><span>double</span> lon1, <span>double</span> lat1,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>                       <span>double</span> lon2, <span>double</span> lat2,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>                       <span>double</span> lon3, <span>double</span> lat3,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>                       <span>double</span> <span>*</span>lon4, <span>double</span> <span>*</span>lat4<span>)</span>;</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span>double</span> ProjectedDistance<span>(</span><span>double</span> lon1, <span>double</span> lat1,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>                         <span>double</span> lon2, <span>double</span> lat2,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>                         <span>double</span> lon3, <span>double</span> lat3,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>                         <span>double</span> <span>*</span>xtd, <span>double</span> <span>*</span>crs<span>)</span>;</span></code></pre></div>
<p><a href="https://github.com/LK8000/LK8000/blob/af404168ff5f92b03ab0c5db336ed8f01a792cda/Common/Header/NavFunctions.h#L7C1-L27">Original
code here</a>.</p>
<p>Users can easily make errors if the interface designers are not
consistent in ordering parameters. It is really hard to remember which
function takes latitude or
<code>Bearing</code> first and when a
latitude or <code>Distance</code> is in the
front.</p>
<h2 data-number="7.5" id="lack-of-a-conceptual-framework"> Lack of a conceptual
framework<a href="#lack-of-a-conceptual-framework"></a></h2>
<p>The previous points mean that the fundamental types can’t be
leveraged to model the different concepts of quantities and units
frameworks. There is no shared vocabulary between different libraries.
User-facing APIs use ad-hoc conventions. Even internal interfaces are
inconsistent between themselves.</p>
<p>Arithmetic types such as <code>int</code>
and <code>double</code> are used to model
different concepts. They are used to represent any abstraction (be it a
magnitude, difference, point, or kind) of any quantity type of any unit.
These are weak types that make up weakly-typed interfaces. The resulting
interfaces and implementations built with these types easily allow
mixing up parameters and using operations that are not part of the
represented quantity.</p>

<p>This chapter describes the features that enforce safety in our code
bases. It starts with obvious things, but then it moves to probably less
known benefits of using physical quantities and units libraries. This
chapter also serves as a proof that it is not easy to implement such a
library correctly, and that there are many cases where the lack of
experience or time for the development of such a utility may easily lead
to safety issues as well.</p>
<p>Before we go through all the features, it is essential to note that
they do not introduce any runtime overhead over the raw unsafe code
doing the same thing. This is a massive benefit of C++ compared to other
programming languages (e.g., Python, Java, etc.).</p>
<h2 data-number="8.1" id="unit-conversions"> Unit conversions<a href="#unit-conversions"></a></h2>
<p>The first thing that comes to our mind when discussing the safety of
such libraries is automated unit conversions between values of the same
physical quantity. This is probably the most important subject here. We
learned about its huge benefits long ago thanks to the
<code>std::chrono::duration</code> that made
conversions of time durations error-proof.</p>
<p>Unit conversions are typically performed either via a converting
constructor or a dedicated conversion function:</p>
<div id="cb6"><pre><code><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span>auto</span> q1 <span>=</span> <span>5</span> <span>*</span> km;</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>std<span>::</span>cout <span>&lt;&lt;</span> q1<span>.</span>in<span>(</span>m<span>)</span> <span>&lt;&lt;</span> <span>&#39;</span><span>\n</span><span>&#39;</span>;</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>si<span>::</span>metre, <span>int</span><span>&gt;</span> q2 <span>=</span> q1;</span></code></pre></div>
<p>Such a feature benefits from the fact that the library knows about
the magnitudes of the source and destination units at compile-time, and
may use that information to calculate and apply a conversion factor
automatically for the user.</p>
<p>In <code>std::chrono::duration</code>, the
magnitude of a unit is always expressed with
<code>std::ratio</code>. This is not enough
for a general-purpose physical units library. Some of the derived units
have huge or tiny ratios. The difference from the base units is so huge
that it cannot be expressed with
<code>std::ratio</code>, which is implemented
in terms of <code>std::intmax_t</code>. This
makes it impossible to define units like electronvolt (eV), where 1 eV =
1.602176634×10<sup>−19</sup> J, or Dalton (Da), where 1 Da =
1.660539040(20)×10<sup>−27</sup> kg. Moreover, some conversions, such as
radian to a degree, require a conversion factor based on an irrational
number like pi.</p>
<h2 data-number="8.2" id="preventing-truncation-of-data"> Preventing truncation of data<a href="#preventing-truncation-of-data"></a></h2>
<p>The second safety feature of such libraries is preventing accidental
truncation of a quantity value. If we try the operations above with
swapped units, both conversions should fail to compile:</p>
<div id="cb7"><pre><code><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span>auto</span> q1 <span>=</span> <span>5</span> <span>*</span> m;</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>std<span>::</span>cout <span>&lt;&lt;</span> q1<span>.</span>in<span>(</span>km<span>)</span> <span>&lt;&lt;</span> <span>&#39;</span><span>\n</span><span>&#39;</span>;              <span>// Compile-time error</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>si<span>::</span>kilo<span>&lt;</span>si<span>::</span>metre<span>&gt;</span>, <span>int</span><span>&gt;</span> q2 <span>=</span> q1;  <span>// Compile-time error</span></span></code></pre></div>
<p>We can’t preserve the value of a source quantity when we convert it
to one with a unit of a lower resolution while dealing with an integral
representation type for a quantity. In the example above, converting
<code>5</code> meters would result in
<code>0</code> kilometers if internal
conversion is performed using regular integer arithmetic.</p>
<p>While this could be a valid behavior, the problem arises when the
user expects to be able to convert the quantity back to the original
unit without loss of information. So the library should prevent such
conversions from happening implicitly; <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span> offers the named cast
<code>value_cast</code> for these conversions
marked as unsafe.</p>
<p>To make the above conversions compile, we could use a floating-point
representation type:</p>
<div id="cb8"><pre><code><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span>auto</span> q1 <span>=</span> <span>5.</span> <span>*</span> m;    <span>// source quantity uses `double` as a representation type</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>std<span>::</span>cout <span>&lt;&lt;</span> q1<span>.</span>in<span>(</span>km<span>)</span> <span>&lt;&lt;</span> <span>&#39;</span><span>\n</span><span>&#39;</span>;</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>si<span>::</span>kilo<span>&lt;</span>si<span>::</span>metre<span>&gt;&gt;</span> q2 <span>=</span> q1;</span></code></pre></div>
<p>or:</p>
<div id="cb9"><pre><code><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span>auto</span> q1 <span>=</span> <span>5</span> <span>*</span> m;     <span>// source quantity uses `int` as a representation type</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>std<span>::</span>cout <span>&lt;&lt;</span> value_cast<span>&lt;</span><span>double</span><span>&gt;(</span>q1<span>).</span>in<span>(</span>km<span>)</span> <span>&lt;&lt;</span> <span>&#39;</span><span>\n</span><span>&#39;</span>;</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>si<span>::</span>kilo<span>&lt;</span>si<span>::</span>metre<span>&gt;&gt;</span> q2 <span>=</span> q1;  <span>// `double` by default</span></span></code></pre></div>
<p><em>The <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span> library
follows <code>std::chrono::duration</code>
logic and treats floating-point types as value-preserving.</em></p>
<p>Another possibility would be to force such a truncating conversion
explicitly from the code:</p>
<div id="cb10"><pre><code><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span>auto</span> q1 <span>=</span> <span>5</span> <span>*</span> m;     <span>// source quantity uses `int` as a representation type</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>std<span>::</span>cout <span>&lt;&lt;</span> q1<span>.</span>force_in<span>(</span>km<span>)</span> <span>&lt;&lt;</span> <span>&#39;</span><span>\n</span><span>&#39;</span>;</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>si<span>::</span>kilo<span>&lt;</span>si<span>::</span>metre<span>&gt;</span>, <span>int</span><span>&gt;</span> q2 <span>=</span> value_cast<span>&lt;</span>km<span>&gt;(</span>q1<span>)</span>;</span></code></pre></div>
<p>The code above makes it clear that “something bad” may happen here if
we are not extra careful.</p>
<p>Another case for truncation happens when we assign a quantity with a
floating-point representation type to the one using an integral
representation type for its value:</p>
<div id="cb11"><pre><code><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span>auto</span> q1 <span>=</span> <span>2.5</span> <span>*</span> m;</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>si<span>::</span>metre, <span>int</span><span>&gt;</span> q2 <span>=</span> q1;</span></code></pre></div>
<p>Such an operation should fail to compile as well. Again, to force
such a truncation, we have to be explicit in the code:</p>
<div id="cb12"><pre><code><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span>auto</span> q1 <span>=</span> <span>2.5</span> <span>*</span> m;</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>si<span>::</span>metre, <span>int</span><span>&gt;</span> q2 <span>=</span> value_cast<span>&lt;</span><span>int</span><span>&gt;(</span>q1<span>)</span>;</span></code></pre></div>
<p>As we can see, it is essential not to allow such truncating
conversions to happen implicitly, and a good physical quantities and
units library should fail at compile-time in case an user makes such a
mistake.</p>
<h2 data-number="8.3" id="the-affine-space"> The affine space<a href="#the-affine-space"></a></h2>
<p>The affine space has two types of entities:</p>
<ul>
<li>point - a position specified with coordinate values (i.e., location,
address, etc.)</li>
<li>vector - the difference between two points (i.e., shift, offset,
displacement, duration, etc.)</li>
</ul>
<p>One can do a limited set of operations in affine space on points and
vectors. This greatly helps to prevent quantity equations that do not
have physical sense.</p>
<p>People often think that affine space is needed only to model
temperatures and maybe time points (following the <a href="https://en.cppreference.com/w/cpp/chrono/time_point"><code>std::chrono::time_point</code></a>
example). Still, the applicability of this concept is much wider.</p>
<p>For example, if we would like to model a Mount Everest climbing
expedition, we would deal with two kinds of altitude-related entities.
The first would be absolute altitudes above the mean sea level (points)
like base camp altitude, mount peak altitude, etc. The second one would
be the heights of daily climbs (vectors). Although it makes physical
sense to add heights of daily climbs, there is no sense in adding
altitudes. What does adding the altitude of a base camp and the mountain
peak mean after all?</p>
<p>Modeling such affine space entities with the
<code>quantity</code> (vector) and
<code>quantity_point</code> (point) class
templates improves the overall project’s safety by only providing the
operators defined by the concepts.</p>
<h2 data-number="8.4" id="explicit-is-not-explicit-enough">
<code>explicit</code> is not explicit
enough<a href="#explicit-is-not-explicit-enough"></a></h2>
<p>Consider the following structure and a code using it:</p>
<div id="cb13"><pre><code><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span>struct</span> X <span>{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  std<span>::</span>vector<span>&lt;</span>std<span>::</span>chrono<span>::</span>milliseconds<span>&gt;</span> vec;</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span>// ...</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span>}</span>;</span></code></pre></div>
<div id="cb14"><pre><code><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>X x;</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>x<span>.</span>vec<span>.</span>emplace_back<span>(</span><span>42</span><span>)</span>;</span></code></pre></div>
<p>Everything works fine for years until, at some point, someone changes
the structure to:</p>
<div id="cb15"><pre><code><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span>struct</span> X <span>{</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  std<span>::</span>vector<span>&lt;</span>std<span>::</span>chrono<span>::</span>microseconds<span>&gt;</span> vec;</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span>// ...</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span>}</span>;</span></code></pre></div>
<p>The code continues to compile fine, but all the calculations are now
off by orders of magnitude. This is why a good physical quantities and
units library should not provide an explicit quantity constructor taking
a raw value.</p>
<p>To solve this issue, a quantity in the <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span> library always requires
information about both a number and a unit during construction:</p>
<div id="cb16"><pre><code><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span>struct</span> X <span>{</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  std<span>::</span>vector<span>&lt;</span>quantity<span>&lt;</span>si<span>::</span>milli<span>&lt;</span>si<span>::</span>seconds<span>&gt;&gt;&gt;</span> vec;</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span>// ...</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span>}</span>;</span></code></pre></div>
<div id="cb17"><pre><code><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>X x;</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>x<span>.</span>vec<span>.</span>emplace_back<span>(</span><span>42</span><span>)</span>;       <span>// Compile-time error</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>x<span>.</span>vec<span>.</span>emplace_back<span>(</span><span>42</span> <span>*</span> ms<span>)</span>;  <span>// OK</span></span></code></pre></div>
<p>For consistency and to prevent similar safety issues, the
<code>quantity_point</code> in the <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span> library can’t be created from
a standalone value of a <code>quantity</code>
(contrary to the
<code>std::chrono::time_point</code> design).
Such a point has to always be associated with an explicit origin:</p>
<div id="cb18"><pre><code><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>quantity_point qp1 <span>=</span> mean_sea_level <span>+</span> <span>42</span> <span>*</span> m;</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>quantity_point qp2 <span>=</span> si<span>::</span>ice_point <span>+</span> <span>21</span> <span>*</span> deg_C;</span></code></pre></div>
<h2 data-number="8.5" id="obtaining-the-numerical-value-of-a-quantity"> Obtaining the numerical value
of a quantity<a href="#obtaining-the-numerical-value-of-a-quantity"></a></h2>
<p>Continuing our previous example, let’s assume that we have an
underlying “legacy” API that requires us to pass a raw numerical value
of a quantity and that we do the following to use it:</p>
<div id="cb19"><pre><code><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span>void</span> legacy_func<span>(</span>std<span>::</span><span>int64_t</span> seconds<span>)</span>;</span></code></pre></div>
<div id="cb20"><pre><code><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>X x;</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>x<span>.</span>vec<span>.</span>emplace_back<span>(</span><span>42</span><span>s</span><span>)</span>;</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>legacy_func<span>(</span>x<span>.</span>vec<span>[</span><span>0</span><span>].</span>count<span>())</span>;</span></code></pre></div>
<p>The preceding code is incorrect. Even though the duration stores a
quantity equal to 42 s, it is not stored in seconds (it’s either
microseconds or milliseconds, depending on which of the interfaces from
the previous chapter is the current one). Such issues can be prevented
with the usage of
<code>std::chrono::duration_cast</code>:</p>
<div id="cb21"><pre><code><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>legacy_func<span>(</span>duration_cast<span>&lt;</span>seconds<span>&gt;(</span>x<span>.</span>vec<span>[</span><span>0</span><span>]).</span>count<span>())</span>;</span></code></pre></div>
<p>However, users often forget about this step, especially when, at the
moment of writing such code, the duration stores the underlying raw
value in the expected unit. But as we know, the interface can be
refactored at any point to use a different unit, and the code using an
underlying numerical value without the usage of an explicit cast will
become incorrect.</p>
<p>To prevent such safety issues, the <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span> library exposes only the
interface that returns a quantity numerical value in the required unit
to ensure that no data truncation happens:</p>
<div id="cb22"><pre><code><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>X x;</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>x<span>.</span>vec<span>.</span>emplace_back<span>(</span><span>42</span> <span>*</span> s<span>)</span>;</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>legacy_func<span>(</span>x<span>.</span>vec<span>[</span><span>0</span><span>].</span>numerical_value_in<span>(</span>si<span>::</span>second<span>))</span>;</span></code></pre></div>
<p>or in case we are fine with data truncation:</p>
<div id="cb23"><pre><code><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>X x;</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>x<span>.</span>vec<span>.</span>emplace_back<span>(</span><span>42</span> <span>*</span> s<span>)</span>;</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>legacy_func<span>(</span>x<span>.</span>vec<span>[</span><span>0</span><span>].</span>force_numerical_value_in<span>(</span>si<span>::</span>second<span>))</span>;</span></code></pre></div>
<p>As the above member functions may need to do a conversion to provide
a value in the expected unit, their results are prvalues.</p>
<h2 data-number="8.6" id="preventing-dangling-references"> Preventing dangling
references<a href="#preventing-dangling-references"></a></h2>
<p>Besides returning prvalues, sometimes users need to get an actual
reference to the underlying numerical value stored in a
<code>quantity</code>. For those cases, the
<span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span> library exposes <code>quantity::numerical_value_ref_in(Unit)</code>
that participates in overload resolution only:</p>
<ul>
<li>for lvalues (rvalue reference qualified overload is explicitly
deleted),</li>
<li>when the provided <code>Unit</code> has
the same magnitude as the one currently used by the quantity.</li>
</ul>
<p>The first condition above aims to limit the possibility of dangling
references. We want to increase the chances that the reference/pointer
provided to an underlying API remains valid for the time of its usage.
(We’re much less concerned about performance aspects for a
<code>quantity</code> here, as we expect the
majority (if not all) of representation types to be cheap to copy.)</p>
<p>That said, we acknowledge that this approach to preventing dangling
references conflates value category with lifetime. While it may prevent
the majority of dangling references, it also admits both false positives
and false negatives, as explained in <span data-cites="VCINL">[<a href="#ref-VCINL" role="doc-biblioref">Value
Category Is Not Lifetime</a>]</span>. We want to highlight this dilemma
for the committee’s consideration.</p>
<p>In case we do decide to keep this policy of deleting rvalue
overloads, here’s an example of code that it would prevent from
compiling.</p>
<div id="cb24"><pre><code><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span>void</span> legacy_func<span>(</span><span>const</span> <span>int</span><span>&amp;</span> seconds<span>)</span>;</span></code></pre></div>
<div id="cb25"><pre><code><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>legacy_func<span>((</span><span>4</span> <span>*</span> s <span>+</span> <span>2</span> <span>*</span> s<span>).</span>numerical_value_ref_in<span>(</span>si<span>::</span>second<span>))</span>;  <span>// Compile-time error</span></span></code></pre></div>
<p>The <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span> library
goes one step further, by implementing all compound assignments,
pre-increment, and pre-decrement operators as non-member functions that
preserve the initial value category. Thanks to that, the following will
also not compile:</p>
<div id="cb26"><pre><code><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>si<span>::</span>second, <span>int</span><span>&gt;</span> get_duration<span>()</span>;</span></code></pre></div>
<div id="cb27"><pre><code><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>legacy_func<span>((</span><span>4</span> <span>*</span> s <span>+=</span> <span>2</span> <span>*</span> s<span>).</span>numerical_value_ref_in<span>(</span>si<span>::</span>second<span>))</span>;    <span>// Compile-time error</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>legacy_func<span>((++</span>get_duration<span>()).</span>numerical_value_ref_in<span>(</span>si<span>::</span>second<span>))</span>;  <span>// Compile-time error</span></span></code></pre></div>
<p>The second condition above enables the usage of various equivalent
units. For example, <code>J</code> is
equivalent to <code>N * m</code>, and
<code>kg * m2 / s2</code>. As those have the
same magnitude, it does not matter exactly which one is being used here,
as the same numerical value should be returned for all of them.</p>
<div id="cb28"><pre><code><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span>void</span> legacy_func<span>(</span><span>const</span> <span>int</span><span>&amp;</span> joules<span>)</span>;</span></code></pre></div>
<div id="cb29"><pre><code><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>quantity q1 <span>=</span> <span>42</span> <span>*</span> J;</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>quantity q2 <span>=</span> <span>42</span> <span>*</span> N <span>*</span> <span>(</span><span>2</span> <span>*</span> m<span>)</span>;</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>quantity q3 <span>=</span> <span>42</span> <span>*</span> kJ;</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>legacy_func<span>(</span>q1<span>.</span>numerical_value_ref_in<span>(</span>si<span>::</span>joule<span>))</span>; <span>// OK</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>legacy_func<span>(</span>q2<span>.</span>numerical_value_ref_in<span>(</span>si<span>::</span>joule<span>))</span>; <span>// OK</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>legacy_func<span>(</span>q3<span>.</span>numerical_value_ref_in<span>(</span>si<span>::</span>joule<span>))</span>; <span>// Compile-time error</span></span></code></pre></div>
<p>Here are a few examples provided by our users where enabling a
quantity type to return a reference to its underlying numerical value is
required:</p>
<ul>
<li><p>Interoperability with the <a href="https://github.com/ocornut/imgui/blob/19ae142bdddf9fcb840549b4b1279739a36c3fa6/imgui.h#L551">Dear
ImGui</a>:</p>
<div id="cb30"><pre><code><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>IMGUI_API <span>bool</span> DragInt<span>(</span><span>const</span> <span>char</span><span>*</span> label, <span>int</span><span>*</span> v,</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>                       <span>float</span> v_speed <span>=</span> <span>1.0</span><span>f</span>, <span>int</span> v_min <span>=</span> <span>0</span>, <span>int</span> v_max <span>=</span> <span>0</span>,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>                       <span>const</span> <span>char</span><span>*</span> format <span>=</span> <span>&#34;</span><span>%d</span><span>&#34;</span>, ImGuiSliderFlags flags <span>=</span> <span>0</span><span>)</span>;  <span>// If v_min &gt;= v_max we have no bound</span></span></code></pre></div>
<div id="cb31"><pre><code><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>ImGui<span>::</span>DragInt<span>(</span><span>&#34;Frames&#34;</span>, <span>&amp;</span>frame_frequency<span>.</span>value<span>.</span>numerical_value_ref_in<span>(</span>Hz<span>)</span>, <span>1</span>,</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>               frame_frequency<span>.</span>min<span>.</span>numerical_value_in<span>(</span>Hz<span>)</span>,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>               frame_frequency<span>.</span>max<span>.</span>numerical_value_in<span>(</span>Hz<span>)</span>,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>               <span>&#34;</span><span>%d</span><span> Hz&#34;</span><span>)</span>;</span></code></pre></div></li>
<li><p>Obtaining a temperature via the C library:</p>
<div id="cb32"><pre><code><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span>// read_temperature is in the BSP defined as</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span>void</span> read_temperature<span>(</span><span>float</span><span>*</span> temp_in_celsius<span>)</span>;</span></code></pre></div>
<div id="cb33"><pre><code><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span>using</span> Celsius_point <span>=</span> quantity_point<span>&lt;</span>isq<span>::</span>Celsius_temperature<span>[</span>deg_C<span>]</span>, si<span>::</span>ice_point, <span>float</span><span>&gt;</span>;</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>Celsius_point temp;</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>read_temperature<span>(&amp;</span>temp<span>.</span>quantity_ref_from<span>(</span>si<span>::</span>ice_point<span>).</span>numerical_value_ref_in<span>(</span>si<span>::</span>degree_Celsius<span>))</span>;</span></code></pre></div></li>
</ul>
<p>As we can see in the second example,
<code>quantity_point</code> also provides an
lvalue-ref-qualified
<code>quantity_ref_from(PointOrigin)</code>
member function that returns a reference to its stored
<code>quantity</code>. Also, for reasons
similar to the ones described in the previous chapter, this function
requires that the argument provided by the user is the same as the
origin of a quantity point.</p>
<h2 data-number="8.7" id="quantity-kinds"> Quantity kinds<a href="#quantity-kinds"></a></h2>
<p>What should be the result of the following quantity equation?</p>
<div id="cb34"><pre><code><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span>auto</span> res <span>=</span> <span>1</span> <span>*</span> Hz <span>+</span> <span>1</span> <span>*</span> Bq <span>+</span> <span>1</span> <span>*</span> Bd;</span></code></pre></div>
<p>We have checked a few leading libraries on the market, and here are
the results:</p>
<ul>
<li><span data-cites="BOOST-UNITS">[<a href="#ref-BOOST-UNITS" role="doc-biblioref">Boost.Units</a>]</span>
claims the answer to be 2 Hz (bauds are not supported by it, so we
removed it from the equation),</li>
<li><span data-cites="NIC-UNITS">[<a href="#ref-NIC-UNITS" role="doc-biblioref">nholthaus/units</a>]</span>
claims it is 2 s<sup>-1</sup> (no support for bauds as well),</li>
<li><span data-cites="PINT">[<a href="#ref-PINT" role="doc-biblioref">Pint</a>]</span> library in Python claims that the
result is 3.0 Hz,</li>
<li><span data-cites="JSR-385">[<a href="#ref-JSR-385" role="doc-biblioref">JSR 385</a>]</span> library in Java throws an
exception saying that we can’t add those quantities.</li>
</ul>
<p>Now let’s check what <span data-cites="ISO-GUIDE">[<a href="#ref-ISO-GUIDE" role="doc-biblioref">ISO/IEC Guide 99</a>]</span> says about quantity
kinds:</p>
<ul>
<li>Quantities may be grouped together into categories of quantities
that are <strong>mutually comparable</strong></li>
<li>Mutually comparable quantities are called <strong>quantities of the
same kind</strong></li>
<li>Two or more quantities <strong>cannot be added or subtracted unless
they belong to the same category of mutually comparable
quantities</strong></li>
<li>Quantities of the <strong>same kind</strong> within a given system
of quantities <strong>have the same quantity dimension</strong></li>
<li>Quantities of the <strong>same dimension are not necessarily of the
same kind</strong></li>
</ul>
<p><span data-cites="ISO80000">[<a href="#ref-ISO80000" role="doc-biblioref">ISO 80000</a>]</span> also explicitly notes:</p>
<blockquote>
<p><strong>Measurement units of quantities of the same quantity
dimension may be designated by the same name and symbol even when the
quantities are not of the same kind</strong>. For example, joule per
kelvin and J/K are respectively the name and symbol of both a
measurement unit of heat capacity and a measurement unit of entropy,
which are generally not considered to be quantities of the same kind.
<strong>However, in some cases special measurement unit names are
restricted to be used with quantities of specific kind only</strong>.
For example, the measurement unit ‘second to the power minus one’ (1/s)
is called hertz (Hz) when used for frequencies and becquerel (Bq) when
used for activities of radionuclides. As another example, the joule (J)
is used as a unit of energy, but never as a unit of moment of force,
i.e. the newton metre (N · m).</p>
</blockquote>
<p>To summarize the above, <span data-cites="ISO80000">[<a href="#ref-ISO80000" role="doc-biblioref">ISO
80000</a>]</span> explicitly states that frequency is measured in Hz and
activity is measured in Bq, which are quantities of different kinds. As
such, they should not be able to be compared, added, or subtracted. So,
the only library from the above that was correct was <span data-cites="JSR-385">[<a href="#ref-JSR-385" role="doc-biblioref">JSR 385</a>]</span>. The rest of them are wrong to
allow such operations. Doing so may lead to vulnerable safety issues
when two unrelated quantities of the same dimension are accidentally
added or assigned to each other.</p>
<p>The reason for most of the libraries on the market to be wrong in
this field is the fact that their quantities are implemented only in
terms of the concept of dimension. However, we’ve just learned that a
dimension is not enough to express a quantity type.</p>
<p>The <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span> library
goes beyond that and properly models quantity kinds. We believe that it
is a significant feature that improves the safety of the library, and
that is why we also plan to propose quantity kinds for standardization
as mentioned in <span data-cites="P2980R0">[<a href="#ref-P2980R0" role="doc-biblioref">P2980R0</a>]</span>.</p>
<h2 data-number="8.8" id="various-quantities-of-the-same-kind"> Various quantities of the same
kind<a href="#various-quantities-of-the-same-kind"></a></h2>
<p>Proper modeling of distinct kinds for quantities of the same
dimension is often not enough from the safety point of view. Most of the
libraries allow us to write the following code in the type-safe way:</p>
<div id="cb35"><pre><code><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>isq<span>::</span>speed<span>[</span>m<span>/</span>s<span>]&gt;</span> avg_speed<span>(</span>quantity<span>&lt;</span>isq<span>::</span>length<span>[</span>m<span>]&gt;</span> l, quantity<span>&lt;</span>isq<span>::</span>time<span>[</span>s<span>]&gt;</span> t<span>)</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span>return</span> l <span>/</span> t;</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>However, they fail when we need to model an abstraction using more
than one quantity of the same kind:</p>
<div id="cb36"><pre><code><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span>class</span> Box <span>{</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  quantity<span>&lt;</span>isq<span>::</span>area<span>[</span>m2<span>]&gt;</span> base_;</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  quantity<span>&lt;</span>isq<span>::</span>length<span>[</span>m<span>]&gt;</span> height_;</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span>public</span><span>:</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  Box<span>(</span>quantity<span>&lt;</span>isq<span>::</span>length<span>[</span>m<span>]&gt;</span> l, quantity<span>&lt;</span>isq<span>::</span>length<span>[</span>m<span>]&gt;</span> w, quantity<span>&lt;</span>isq<span>::</span>length<span>[</span>m<span>]&gt;</span> h<span>)</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span>:</span> base_<span>(</span>l <span>*</span> w<span>)</span>, height_<span>(</span>h<span>)</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span>{}</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span>// ...</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span>}</span>;</span></code></pre></div>
<p>This does not provide strongly typed interfaces anymore.</p>
<p>Again, it turns out that <span data-cites="ISO80000">[<a href="#ref-ISO80000" role="doc-biblioref">ISO
80000</a>]</span> has an answer. This specification standardizes
hundreds of quantities, many of which are of the same kind. For example,
for quantities of the kind length, it provides the following:</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyBhcmlhLXJvbGVkZXNjcmlwdGlvbj0iZmxvd2NoYXJ0LXYyIiByb2xlPSJncmFwaGljcy1kb2N1bWVudCBkb2N1bWVudCIgdmlld0JveD0iLTggLTggMTA3Mi43NTc4MTI1IDM0NiIgc3R5bGU9Im1heC13aWR0aDogMTAwJTsiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGlkPSJncmFwaC1kaXYiIGhlaWdodD0iMTAwJSIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxzdHlsZT5AaW1wb3J0IHVybCgiaHR0cHM6Ly9jZG5qcy5jbG91ZGZsYXJlLmNvbS9hamF4L2xpYnMvZm9udC1hd2Vzb21lLzYuNC4yL2Nzcy9hbGwubWluLmNzcyIpOyc8L3N0eWxlPjxzdHlsZT4jZ3JhcGgtZGl2e2ZvbnQtZmFtaWx5OiJ0cmVidWNoZXQgbXMiLHZlcmRhbmEsYXJpYWwsc2Fucy1zZXJpZjtmb250LXNpemU6MTZweDtmaWxsOiMzMzM7fSNncmFwaC1kaXYgLmVycm9yLWljb257ZmlsbDojNTUyMjIyO30jZ3JhcGgtZGl2IC5lcnJvci10ZXh0e2ZpbGw6IzU1MjIyMjtzdHJva2U6IzU1MjIyMjt9I2dyYXBoLWRpdiAuZWRnZS10aGlja25lc3Mtbm9ybWFse3N0cm9rZS13aWR0aDoycHg7fSNncmFwaC1kaXYgLmVkZ2UtdGhpY2tuZXNzLXRoaWNre3N0cm9rZS13aWR0aDozLjVweDt9I2dyYXBoLWRpdiAuZWRnZS1wYXR0ZXJuLXNvbGlke3N0cm9rZS1kYXNoYXJyYXk6MDt9I2dyYXBoLWRpdiAuZWRnZS1wYXR0ZXJuLWRhc2hlZHtzdHJva2UtZGFzaGFycmF5OjM7fSNncmFwaC1kaXYgLmVkZ2UtcGF0dGVybi1kb3R0ZWR7c3Ryb2tlLWRhc2hhcnJheToyO30jZ3JhcGgtZGl2IC5tYXJrZXJ7ZmlsbDojMzMzMzMzO3N0cm9rZTojMzMzMzMzO30jZ3JhcGgtZGl2IC5tYXJrZXIuY3Jvc3N7c3Ryb2tlOiMzMzMzMzM7fSNncmFwaC1kaXYgc3Zne2ZvbnQtZmFtaWx5OiJ0cmVidWNoZXQgbXMiLHZlcmRhbmEsYXJpYWwsc2Fucy1zZXJpZjtmb250LXNpemU6MTZweDt9I2dyYXBoLWRpdiAubGFiZWx7Zm9udC1mYW1pbHk6InRyZWJ1Y2hldCBtcyIsdmVyZGFuYSxhcmlhbCxzYW5zLXNlcmlmO2NvbG9yOiMzMzM7fSNncmFwaC1kaXYgLmNsdXN0ZXItbGFiZWwgdGV4dHtmaWxsOiMzMzM7fSNncmFwaC1kaXYgLmNsdXN0ZXItbGFiZWwgc3BhbiwjZ3JhcGgtZGl2IHB7Y29sb3I6IzMzMzt9I2dyYXBoLWRpdiAubGFiZWwgdGV4dCwjZ3JhcGgtZGl2IHNwYW4sI2dyYXBoLWRpdiBwe2ZpbGw6IzMzMztjb2xvcjojMzMzO30jZ3JhcGgtZGl2IC5ub2RlIHJlY3QsI2dyYXBoLWRpdiAubm9kZSBjaXJjbGUsI2dyYXBoLWRpdiAubm9kZSBlbGxpcHNlLCNncmFwaC1kaXYgLm5vZGUgcG9seWdvbiwjZ3JhcGgtZGl2IC5ub2RlIHBhdGh7ZmlsbDojRUNFQ0ZGO3N0cm9rZTojOTM3MERCO3N0cm9rZS13aWR0aDoxcHg7fSNncmFwaC1kaXYgLmZsb3djaGFydC1sYWJlbCB0ZXh0e3RleHQtYW5jaG9yOm1pZGRsZTt9I2dyYXBoLWRpdiAubm9kZSAubGFiZWx7dGV4dC1hbGlnbjpjZW50ZXI7fSNncmFwaC1kaXYgLm5vZGUuY2xpY2thYmxle2N1cnNvcjpwb2ludGVyO30jZ3JhcGgtZGl2IC5hcnJvd2hlYWRQYXRoe2ZpbGw6IzMzMzMzMzt9I2dyYXBoLWRpdiAuZWRnZVBhdGggLnBhdGh7c3Ryb2tlOiMzMzMzMzM7c3Ryb2tlLXdpZHRoOjIuMHB4O30jZ3JhcGgtZGl2IC5mbG93Y2hhcnQtbGlua3tzdHJva2U6IzMzMzMzMztmaWxsOm5vbmU7fSNncmFwaC1kaXYgLmVkZ2VMYWJlbHtiYWNrZ3JvdW5kLWNvbG9yOiNlOGU4ZTg7dGV4dC1hbGlnbjpjZW50ZXI7fSNncmFwaC1kaXYgLmVkZ2VMYWJlbCByZWN0e29wYWNpdHk6MC41O2JhY2tncm91bmQtY29sb3I6I2U4ZThlODtmaWxsOiNlOGU4ZTg7fSNncmFwaC1kaXYgLmxhYmVsQmtne2JhY2tncm91bmQtY29sb3I6cmdiYSgyMzIsIDIzMiwgMjMyLCAwLjUpO30jZ3JhcGgtZGl2IC5jbHVzdGVyIHJlY3R7ZmlsbDojZmZmZmRlO3N0cm9rZTojYWFhYTMzO3N0cm9rZS13aWR0aDoxcHg7fSNncmFwaC1kaXYgLmNsdXN0ZXIgdGV4dHtmaWxsOiMzMzM7fSNncmFwaC1kaXYgLmNsdXN0ZXIgc3BhbiwjZ3JhcGgtZGl2IHB7Y29sb3I6IzMzMzt9I2dyYXBoLWRpdiBkaXYubWVybWFpZFRvb2x0aXB7cG9zaXRpb246YWJzb2x1dGU7dGV4dC1hbGlnbjpjZW50ZXI7bWF4LXdpZHRoOjIwMHB4O3BhZGRpbmc6MnB4O2ZvbnQtZmFtaWx5OiJ0cmVidWNoZXQgbXMiLHZlcmRhbmEsYXJpYWwsc2Fucy1zZXJpZjtmb250LXNpemU6MTJweDtiYWNrZ3JvdW5kOmhzbCg4MCwgMTAwJSwgOTYuMjc0NTA5ODAzOSUpO2JvcmRlcjoxcHggc29saWQgI2FhYWEzMztib3JkZXItcmFkaXVzOjJweDtwb2ludGVyLWV2ZW50czpub25lO3otaW5kZXg6MTAwO30jZ3JhcGgtZGl2IC5mbG93Y2hhcnRUaXRsZVRleHR7dGV4dC1hbmNob3I6bWlkZGxlO2ZvbnQtc2l6ZToxOHB4O2ZpbGw6IzMzMzt9I2dyYXBoLWRpdiA6cm9vdHstLW1lcm1haWQtZm9udC1mYW1pbHk6InRyZWJ1Y2hldCBtcyIsdmVyZGFuYSxhcmlhbCxzYW5zLXNlcmlmO308L3N0eWxlPjxnPjxtYXJrZXIgb3JpZW50PSJhdXRvIiBtYXJrZXJIZWlnaHQ9IjEyIiBtYXJrZXJXaWR0aD0iMTIiIG1hcmtlclVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgcmVmWT0iNSIgcmVmWD0iNiIgdmlld0JveD0iMCAwIDEwIDEwIiBjbGFzcz0ibWFya2VyIGZsb3djaGFydCIgaWQ9ImdyYXBoLWRpdl9mbG93Y2hhcnQtcG9pbnRFbmQiPjxwYXRoIHN0eWxlPSJzdHJva2Utd2lkdGg6IDE7IHN0cm9rZS1kYXNoYXJyYXk6IDEsIDA7IiBjbGFzcz0iYXJyb3dNYXJrZXJQYXRoIiBkPSJNIDAgMCBMIDEwIDUgTCAwIDEwIHoiPjwvcGF0aD48L21hcmtlcj48bWFya2VyIG9yaWVudD0iYXV0byIgbWFya2VySGVpZ2h0PSIxMiIgbWFya2VyV2lkdGg9IjEyIiBtYXJrZXJVbml0cz0idXNlclNwYWNlT25Vc2UiIHJlZlk9IjUiIHJlZlg9IjQuNSIgdmlld0JveD0iMCAwIDEwIDEwIiBjbGFzcz0ibWFya2VyIGZsb3djaGFydCIgaWQ9ImdyYXBoLWRpdl9mbG93Y2hhcnQtcG9pbnRTdGFydCI+PHBhdGggc3R5bGU9InN0cm9rZS13aWR0aDogMTsgc3Ryb2tlLWRhc2hhcnJheTogMSwgMDsiIGNsYXNzPSJhcnJvd01hcmtlclBhdGgiIGQ9Ik0gMCA1IEwgMTAgMTAgTCAxMCAwIHoiPjwvcGF0aD48L21hcmtlcj48bWFya2VyIG9yaWVudD0iYXV0byIgbWFya2VySGVpZ2h0PSIxMSIgbWFya2VyV2lkdGg9IjExIiBtYXJrZXJVbml0cz0idXNlclNwYWNlT25Vc2UiIHJlZlk9IjUiIHJlZlg9IjExIiB2aWV3Qm94PSIwIDAgMTAgMTAiIGNsYXNzPSJtYXJrZXIgZmxvd2NoYXJ0IiBpZD0iZ3JhcGgtZGl2X2Zsb3djaGFydC1jaXJjbGVFbmQiPjxjaXJjbGUgc3R5bGU9InN0cm9rZS13aWR0aDogMTsgc3Ryb2tlLWRhc2hhcnJheTogMSwgMDsiIGNsYXNzPSJhcnJvd01hcmtlclBhdGgiIHI9IjUiIGN5PSI1IiBjeD0iNSI+PC9jaXJjbGU+PC9tYXJrZXI+PG1hcmtlciBvcmllbnQ9ImF1dG8iIG1hcmtlckhlaWdodD0iMTEiIG1hcmtlcldpZHRoPSIxMSIgbWFya2VyVW5pdHM9InVzZXJTcGFjZU9uVXNlIiByZWZZPSI1IiByZWZYPSItMSIgdmlld0JveD0iMCAwIDEwIDEwIiBjbGFzcz0ibWFya2VyIGZsb3djaGFydCIgaWQ9ImdyYXBoLWRpdl9mbG93Y2hhcnQtY2lyY2xlU3RhcnQiPjxjaXJjbGUgc3R5bGU9InN0cm9rZS13aWR0aDogMTsgc3Ryb2tlLWRhc2hhcnJheTogMSwgMDsiIGNsYXNzPSJhcnJvd01hcmtlclBhdGgiIHI9IjUiIGN5PSI1IiBjeD0iNSI+PC9jaXJjbGU+PC9tYXJrZXI+PG1hcmtlciBvcmllbnQ9ImF1dG8iIG1hcmtlckhlaWdodD0iMTEiIG1hcmtlcldpZHRoPSIxMSIgbWFya2VyVW5pdHM9InVzZXJTcGFjZU9uVXNlIiByZWZZPSI1LjIiIHJlZlg9IjEyIiB2aWV3Qm94PSIwIDAgMTEgMTEiIGNsYXNzPSJtYXJrZXIgY3Jvc3MgZmxvd2NoYXJ0IiBpZD0iZ3JhcGgtZGl2X2Zsb3djaGFydC1jcm9zc0VuZCI+PHBhdGggc3R5bGU9InN0cm9rZS13aWR0aDogMjsgc3Ryb2tlLWRhc2hhcnJheTogMSwgMDsiIGNsYXNzPSJhcnJvd01hcmtlclBhdGgiIGQ9Ik0gMSwxIGwgOSw5IE0gMTAsMSBsIC05LDkiPjwvcGF0aD48L21hcmtlcj48bWFya2VyIG9yaWVudD0iYXV0byIgbWFya2VySGVpZ2h0PSIxMSIgbWFya2VyV2lkdGg9IjExIiBtYXJrZXJVbml0cz0idXNlclNwYWNlT25Vc2UiIHJlZlk9IjUuMiIgcmVmWD0iLTEiIHZpZXdCb3g9IjAgMCAxMSAxMSIgY2xhc3M9Im1hcmtlciBjcm9zcyBmbG93Y2hhcnQiIGlkPSJncmFwaC1kaXZfZmxvd2NoYXJ0LWNyb3NzU3RhcnQiPjxwYXRoIHN0eWxlPSJzdHJva2Utd2lkdGg6IDI7IHN0cm9rZS1kYXNoYXJyYXk6IDEsIDA7IiBjbGFzcz0iYXJyb3dNYXJrZXJQYXRoIiBkPSJNIDEsMSBsIDksOSBNIDEwLDEgbCAtOSw5Ij48L3BhdGg+PC9tYXJrZXI+PGcgY2xhc3M9InJvb3QiPjxnIGNsYXNzPSJjbHVzdGVycyI+PC9nPjxnIGNsYXNzPSJlZGdlUGF0aHMiPjxwYXRoIHN0eWxlPSJmaWxsOm5vbmU7IiBjbGFzcz0iZWRnZS10aGlja25lc3Mtbm9ybWFsIGVkZ2UtcGF0dGVybi1zb2xpZCBmbG93Y2hhcnQtbGluayBMUy1sZW5ndGggTEUtd2lkdGgiIGlkPSJMLWxlbmd0aC13aWR0aC0wIiBkPSJNNjA3LjI3MywyMi4xNDhMNTI3Ljg2LDI5LjEyNEM0NDguNDQ3LDM2LjA5OSwyODkuNjIsNTAuMDQ5LDIxMC4yMDYsNjMuMTkxQzEzMC43OTMsNzYuMzMzLDEzMC43OTMsODguNjY3LDEzMC43OTMsOTQuODMzTDEzMC43OTMsMTAxIj48L3BhdGg+PHBhdGggc3R5bGU9ImZpbGw6bm9uZTsiIGNsYXNzPSJlZGdlLXRoaWNrbmVzcy1ub3JtYWwgZWRnZS1wYXR0ZXJuLXNvbGlkIGZsb3djaGFydC1saW5rIExTLWxlbmd0aCBMRS1oZWlnaHQiIGlkPSJMLWxlbmd0aC1oZWlnaHQtMCIgZD0iTTYwNy4yNzMsMjMuODkzTDU2MS4zOTEsMzAuNTc3QzUxNS41MDgsMzcuMjYyLDQyMy43NDIsNTAuNjMxLDM3Ny44NTksNjMuNDgyQzMzMS45NzcsNzYuMzMzLDMzMS45NzcsODguNjY3LDMzMS45NzcsOTQuODMzTDMzMS45NzcsMTAxIj48L3BhdGg+PHBhdGggc3R5bGU9ImZpbGw6bm9uZTsiIGNsYXNzPSJlZGdlLXRoaWNrbmVzcy1ub3JtYWwgZWRnZS1wYXR0ZXJuLXNvbGlkIGZsb3djaGFydC1saW5rIExTLXdpZHRoIExFLXRoaWNrbmVzcyIgaWQ9Ikwtd2lkdGgtdGhpY2tuZXNzLTAiIGQ9Ik05OS42NDEsMTQwTDg5Ljc4OSwxNDYuMTY3Qzc5LjkzOCwxNTIuMzMzLDYwLjIzNCwxNjQuNjY3LDUwLjM4MywxNzVDNDAuNTMxLDE4NS4zMzMsNDAuNTMxLDE5My42NjcsNDAuNTMxLDE5Ny44MzNMNDAuNTMxLDIwMiI+PC9wYXRoPjxwYXRoIHN0eWxlPSJmaWxsOm5vbmU7IiBjbGFzcz0iZWRnZS10aGlja25lc3Mtbm9ybWFsIGVkZ2UtcGF0dGVybi1zb2xpZCBmbG93Y2hhcnQtbGluayBMUy13aWR0aCBMRS1kaWFtZXRlciIgaWQ9Ikwtd2lkdGgtZGlhbWV0ZXItMCIgZD0iTTE0NC43MjIsMTQwTDE0OS4xMjcsMTQ2LjE2N0MxNTMuNTMyLDE1Mi4zMzMsMTYyLjM0MiwxNjQuNjY3LDE2Ni43NDcsMTc1QzE3MS4xNTIsMTg1LjMzMywxNzEuMTUyLDE5My42NjcsMTcxLjE1MiwxOTcuODMzTDE3MS4xNTIsMjAyIj48L3BhdGg+PHBhdGggc3R5bGU9ImZpbGw6bm9uZTsiIGNsYXNzPSJlZGdlLXRoaWNrbmVzcy1ub3JtYWwgZWRnZS1wYXR0ZXJuLXNvbGlkIGZsb3djaGFydC1saW5rIExTLXdpZHRoIExFLXJhZGl1cyIgaWQ9Ikwtd2lkdGgtcmFkaXVzLTAiIGQ9Ik0xODUuODc5LDE0MEwyMDMuMywxNDYuMTY3QzIyMC43MiwxNTIuMzMzLDI1NS41NjEsMTY0LjY2NywyNzIuOTgyLDE3NUMyOTAuNDAyLDE4NS4zMzMsMjkwLjQwMiwxOTMuNjY3LDI5MC40MDIsMTk3LjgzM0wyOTAuNDAyLDIwMiI+PC9wYXRoPjxwYXRoIHN0eWxlPSJmaWxsOm5vbmU7IiBjbGFzcz0iZWRnZS10aGlja25lc3Mtbm9ybWFsIGVkZ2UtcGF0dGVybi1zb2xpZCBmbG93Y2hhcnQtbGluayBMUy1sZW5ndGggTEUtcGF0aF9sZW5ndGgiIGlkPSJMLWxlbmd0aC1wYXRoX2xlbmd0aC0wIiBkPSJNNjA3LjI3MywzMS4xNzVMNTkzLjE0NCwzNi42NDZDNTc5LjAxNCw0Mi4xMTcsNTUwLjc1NSw1My4wNTgsNTM2LjYyNiw2NC42OTZDNTIyLjQ5Niw3Ni4zMzMsNTIyLjQ5Niw4OC42NjcsNTIyLjQ5Niw5NC44MzNMNTIyLjQ5NiwxMDEiPjwvcGF0aD48cGF0aCBzdHlsZT0iZmlsbDpub25lOyIgY2xhc3M9ImVkZ2UtdGhpY2tuZXNzLW5vcm1hbCBlZGdlLXBhdHRlcm4tc29saWQgZmxvd2NoYXJ0LWxpbmsgTFMtcGF0aF9sZW5ndGggTEUtZGlzdGFuY2UiIGlkPSJMLXBhdGhfbGVuZ3RoLWRpc3RhbmNlLTAiIGQ9Ik01MjIuNDk2LDE0MEw1MjIuNDk2LDE0Ni4xNjdDNTIyLjQ5NiwxNTIuMzMzLDUyMi40OTYsMTY0LjY2Nyw1MjIuNDk2LDE3NUM1MjIuNDk2LDE4NS4zMzMsNTIyLjQ5NiwxOTMuNjY3LDUyMi40OTYsMTk3LjgzM0w1MjIuNDk2LDIwMiI+PC9wYXRoPjxwYXRoIHN0eWxlPSJmaWxsOm5vbmU7IiBjbGFzcz0iZWRnZS10aGlja25lc3Mtbm9ybWFsIGVkZ2UtcGF0dGVybi1zb2xpZCBmbG93Y2hhcnQtbGluayBMUy1kaXN0YW5jZSBMRS1yYWRpYWxfZGlzdGFuY2UiIGlkPSJMLWRpc3RhbmNlLXJhZGlhbF9kaXN0YW5jZS0wIiBkPSJNNTIyLjQ5NiwyNDFMNTIyLjQ5NiwyNDUuMTY3QzUyMi40OTYsMjQ5LjMzMyw1MjIuNDk2LDI1Ny42NjcsNTIyLjQ5NiwyNjZDNTIyLjQ5NiwyNzQuMzMzLDUyMi40OTYsMjgyLjY2Nyw1MjIuNDk2LDI4Ni44MzNMNTIyLjQ5NiwyOTEiPjwvcGF0aD48cGF0aCBzdHlsZT0iZmlsbDpub25lOyIgY2xhc3M9ImVkZ2UtdGhpY2tuZXNzLW5vcm1hbCBlZGdlLXBhdHRlcm4tc29saWQgZmxvd2NoYXJ0LWxpbmsgTFMtbGVuZ3RoIExFLXdhdmVsZW5ndGgiIGlkPSJMLWxlbmd0aC13YXZlbGVuZ3RoLTAiIGQ9Ik02NTIuNDE3LDM5TDY1NS42Miw0My4xNjdDNjU4LjgyNCw0Ny4zMzMsNjY1LjIzLDU1LjY2Nyw2NjguNDMzLDY2QzY3MS42MzcsNzYuMzMzLDY3MS42MzcsODguNjY3LDY3MS42MzcsOTQuODMzTDY3MS42MzcsMTAxIj48L3BhdGg+PHBhdGggc3R5bGU9ImZpbGw6bm9uZTsiIGNsYXNzPSJlZGdlLXRoaWNrbmVzcy1ub3JtYWwgZWRnZS1wYXR0ZXJuLXNvbGlkIGZsb3djaGFydC1saW5rIExTLWxlbmd0aCBMRS1wb3NpdGlvbl92ZWN0b3IiIGlkPSJMLWxlbmd0aC1wb3NpdGlvbl92ZWN0b3ItMCIgZD0iTTY2Ny41NzgsMjYuMzU2TDY5NS4xNjksMzIuNjNDNzIyLjc2LDM4LjkwNCw3NzcuOTQzLDUxLjQ1Miw4MDUuNTM0LDYxLjg5M0M4MzMuMTI1LDcyLjMzMyw4MzMuMTI1LDgwLjY2Nyw4MzMuMTI1LDg0LjgzM0w4MzMuMTI1LDg5Ij48L3BhdGg+PHBhdGggc3R5bGU9ImZpbGw6bm9uZTsiIGNsYXNzPSJlZGdlLXRoaWNrbmVzcy1ub3JtYWwgZWRnZS1wYXR0ZXJuLXNvbGlkIGZsb3djaGFydC1saW5rIExTLWxlbmd0aCBMRS1kaXNwbGFjZW1lbnQiIGlkPSJMLWxlbmd0aC1kaXNwbGFjZW1lbnQtMCIgZD0iTTY2Ny41NzgsMjMuMTg3TDcyMy4yMTQsMjkuOTg5Qzc3OC44NDksMzYuNzkxLDg5MC4xMiw1MC4zOTYsOTQ1Ljc1NSw2MS4zNjRDMTAwMS4zOTEsNzIuMzMzLDEwMDEuMzkxLDgwLjY2NywxMDAxLjM5MSw4NC44MzNMMTAwMS4zOTEsODkiPjwvcGF0aD48cGF0aCBzdHlsZT0iZmlsbDpub25lOyIgY2xhc3M9ImVkZ2UtdGhpY2tuZXNzLW5vcm1hbCBlZGdlLXBhdHRlcm4tc29saWQgZmxvd2NoYXJ0LWxpbmsgTFMtcmFkaXVzIExFLXJhZGl1c19vZl9jdXJ2YXR1cmUiIGlkPSJMLXJhZGl1cy1yYWRpdXNfb2ZfY3VydmF0dXJlLTAiIGQ9Ik0yOTAuNDAyLDI0MUwyOTAuNDAyLDI0NS4xNjdDMjkwLjQwMiwyNDkuMzMzLDI5MC40MDIsMjU3LjY2NywyOTAuNDAyLDI2NkMyOTAuNDAyLDI3NC4zMzMsMjkwLjQwMiwyODIuNjY3LDI5MC40MDIsMjg2LjgzM0wyOTAuNDAyLDI5MSI+PC9wYXRoPjwvZz48ZyBjbGFzcz0iZWRnZUxhYmVscyI+PGcgY2xhc3M9ImVkZ2VMYWJlbCI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMCwgMCkiIGNsYXNzPSJsYWJlbCI+PGZvcmVpZ25PYmplY3QgaGVpZ2h0PSIwIiB3aWR0aD0iMCI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyB3aGl0ZS1zcGFjZTogbm93cmFwOyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiPjxzcGFuIGNsYXNzPSJlZGdlTGFiZWwiPjwvc3Bhbj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PC9nPjwvZz48ZyBjbGFzcz0iZWRnZUxhYmVsIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLCAwKSIgY2xhc3M9ImxhYmVsIj48Zm9yZWlnbk9iamVjdCBoZWlnaHQ9IjAiIHdpZHRoPSIwIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IHdoaXRlLXNwYWNlOiBub3dyYXA7IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCI+PHNwYW4gY2xhc3M9ImVkZ2VMYWJlbCI+PC9zcGFuPjwvZGl2PjwvZm9yZWlnbk9iamVjdD48L2c+PC9nPjxnIGNsYXNzPSJlZGdlTGFiZWwiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsIDApIiBjbGFzcz0ibGFiZWwiPjxmb3JlaWduT2JqZWN0IGhlaWdodD0iMCIgd2lkdGg9IjAiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgd2hpdGUtc3BhY2U6IG5vd3JhcDsiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIj48c3BhbiBjbGFzcz0iZWRnZUxhYmVsIj48L3NwYW4+PC9kaXY+PC9mb3JlaWduT2JqZWN0PjwvZz48L2c+PGcgY2xhc3M9ImVkZ2VMYWJlbCI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMCwgMCkiIGNsYXNzPSJsYWJlbCI+PGZvcmVpZ25PYmplY3QgaGVpZ2h0PSIwIiB3aWR0aD0iMCI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyB3aGl0ZS1zcGFjZTogbm93cmFwOyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiPjxzcGFuIGNsYXNzPSJlZGdlTGFiZWwiPjwvc3Bhbj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PC9nPjwvZz48ZyBjbGFzcz0iZWRnZUxhYmVsIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLCAwKSIgY2xhc3M9ImxhYmVsIj48Zm9yZWlnbk9iamVjdCBoZWlnaHQ9IjAiIHdpZHRoPSIwIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IHdoaXRlLXNwYWNlOiBub3dyYXA7IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCI+PHNwYW4gY2xhc3M9ImVkZ2VMYWJlbCI+PC9zcGFuPjwvZGl2PjwvZm9yZWlnbk9iamVjdD48L2c+PC9nPjxnIGNsYXNzPSJlZGdlTGFiZWwiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsIDApIiBjbGFzcz0ibGFiZWwiPjxmb3JlaWduT2JqZWN0IGhlaWdodD0iMCIgd2lkdGg9IjAiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgd2hpdGUtc3BhY2U6IG5vd3JhcDsiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIj48c3BhbiBjbGFzcz0iZWRnZUxhYmVsIj48L3NwYW4+PC9kaXY+PC9mb3JlaWduT2JqZWN0PjwvZz48L2c+PGcgY2xhc3M9ImVkZ2VMYWJlbCI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMCwgMCkiIGNsYXNzPSJsYWJlbCI+PGZvcmVpZ25PYmplY3QgaGVpZ2h0PSIwIiB3aWR0aD0iMCI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyB3aGl0ZS1zcGFjZTogbm93cmFwOyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiPjxzcGFuIGNsYXNzPSJlZGdlTGFiZWwiPjwvc3Bhbj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PC9nPjwvZz48ZyBjbGFzcz0iZWRnZUxhYmVsIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLCAwKSIgY2xhc3M9ImxhYmVsIj48Zm9yZWlnbk9iamVjdCBoZWlnaHQ9IjAiIHdpZHRoPSIwIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IHdoaXRlLXNwYWNlOiBub3dyYXA7IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCI+PHNwYW4gY2xhc3M9ImVkZ2VMYWJlbCI+PC9zcGFuPjwvZGl2PjwvZm9yZWlnbk9iamVjdD48L2c+PC9nPjxnIGNsYXNzPSJlZGdlTGFiZWwiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsIDApIiBjbGFzcz0ibGFiZWwiPjxmb3JlaWduT2JqZWN0IGhlaWdodD0iMCIgd2lkdGg9IjAiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgd2hpdGUtc3BhY2U6IG5vd3JhcDsiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIj48c3BhbiBjbGFzcz0iZWRnZUxhYmVsIj48L3NwYW4+PC9kaXY+PC9mb3JlaWduT2JqZWN0PjwvZz48L2c+PGcgY2xhc3M9ImVkZ2VMYWJlbCI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMCwgMCkiIGNsYXNzPSJsYWJlbCI+PGZvcmVpZ25PYmplY3QgaGVpZ2h0PSIwIiB3aWR0aD0iMCI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyB3aGl0ZS1zcGFjZTogbm93cmFwOyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiPjxzcGFuIGNsYXNzPSJlZGdlTGFiZWwiPjwvc3Bhbj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PC9nPjwvZz48ZyBjbGFzcz0iZWRnZUxhYmVsIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLCAwKSIgY2xhc3M9ImxhYmVsIj48Zm9yZWlnbk9iamVjdCBoZWlnaHQ9IjAiIHdpZHRoPSIwIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IHdoaXRlLXNwYWNlOiBub3dyYXA7IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCI+PHNwYW4gY2xhc3M9ImVkZ2VMYWJlbCI+PC9zcGFuPjwvZGl2PjwvZm9yZWlnbk9iamVjdD48L2c+PC9nPjxnIGNsYXNzPSJlZGdlTGFiZWwiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsIDApIiBjbGFzcz0ibGFiZWwiPjxmb3JlaWduT2JqZWN0IGhlaWdodD0iMCIgd2lkdGg9IjAiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgd2hpdGUtc3BhY2U6IG5vd3JhcDsiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIj48c3BhbiBjbGFzcz0iZWRnZUxhYmVsIj48L3NwYW4+PC9kaXY+PC9mb3JlaWduT2JqZWN0PjwvZz48L2c+PC9nPjxnIGNsYXNzPSJub2RlcyI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNjM3LjQyNTc4MTI1LCAxOS41KSIgaWQ9ImZsb3djaGFydC1sZW5ndGgtMTg4IiBjbGFzcz0ibm9kZSBkZWZhdWx0IGRlZmF1bHQgZmxvd2NoYXJ0LWxhYmVsIj48cmVjdCBoZWlnaHQ9IjM5IiB3aWR0aD0iNjAuMzA0Njg3NSIgeT0iLTE5LjUiIHg9Ii0zMC4xNTIzNDM3NSIgcnk9IjAiIHJ4PSIwIiBzdHlsZT0iIiBjbGFzcz0iYmFzaWMgbGFiZWwtY29udGFpbmVyIj48L3JlY3Q+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTIyLjY1MjM0Mzc1LCAtMTIpIiBzdHlsZT0iIiBjbGFzcz0ibGFiZWwiPjxyZWN0PjwvcmVjdD48Zm9yZWlnbk9iamVjdCBoZWlnaHQ9IjI0IiB3aWR0aD0iNDUuMzA0Njg3NSI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyB3aGl0ZS1zcGFjZTogbm93cmFwOyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiPjxzcGFuIGNsYXNzPSJub2RlTGFiZWwiPmxlbmd0aDwvc3Bhbj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PC9nPjwvZz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMzAuNzkyOTY4NzUsIDEyMC41KSIgaWQ9ImZsb3djaGFydC13aWR0aC0xODkiIGNsYXNzPSJub2RlIGRlZmF1bHQgZGVmYXVsdCBmbG93Y2hhcnQtbGFiZWwiPjxyZWN0IGhlaWdodD0iMzkiIHdpZHRoPSIxMjIuNDI5Njg3NSIgeT0iLTE5LjUiIHg9Ii02MS4yMTQ4NDM3NSIgcnk9IjAiIHJ4PSIwIiBzdHlsZT0iIiBjbGFzcz0iYmFzaWMgbGFiZWwtY29udGFpbmVyIj48L3JlY3Q+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTUzLjcxNDg0Mzc1LCAtMTIpIiBzdHlsZT0iIiBjbGFzcz0ibGFiZWwiPjxyZWN0PjwvcmVjdD48Zm9yZWlnbk9iamVjdCBoZWlnaHQ9IjI0IiB3aWR0aD0iMTA3LjQyOTY4NzUiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgd2hpdGUtc3BhY2U6IG5vd3JhcDsiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIj48c3BhbiBjbGFzcz0ibm9kZUxhYmVsIj53aWR0aCwgYnJlYWR0aDwvc3Bhbj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PC9nPjwvZz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgzMzEuOTc2NTYyNSwgMTIwLjUpIiBpZD0iZmxvd2NoYXJ0LWhlaWdodC0xOTEiIGNsYXNzPSJub2RlIGRlZmF1bHQgZGVmYXVsdCBmbG93Y2hhcnQtbGFiZWwiPjxyZWN0IGhlaWdodD0iMzkiIHdpZHRoPSIxNzkuOTM3NSIgeT0iLTE5LjUiIHg9Ii04OS45Njg3NSIgcnk9IjAiIHJ4PSIwIiBzdHlsZT0iIiBjbGFzcz0iYmFzaWMgbGFiZWwtY29udGFpbmVyIj48L3JlY3Q+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTgyLjQ2ODc1LCAtMTIpIiBzdHlsZT0iIiBjbGFzcz0ibGFiZWwiPjxyZWN0PjwvcmVjdD48Zm9yZWlnbk9iamVjdCBoZWlnaHQ9IjI0IiB3aWR0aD0iMTY0LjkzNzUiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgd2hpdGUtc3BhY2U6IG5vd3JhcDsiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIj48c3BhbiBjbGFzcz0ibm9kZUxhYmVsIj5oZWlnaHQsIGRlcHRoLCBhbHRpdHVkZTwvc3Bhbj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PC9nPjwvZz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg0MC41MzEyNSwgMjIxLjUpIiBpZD0iZmxvd2NoYXJ0LXRoaWNrbmVzcy0xOTMiIGNsYXNzPSJub2RlIGRlZmF1bHQgZGVmYXVsdCBmbG93Y2hhcnQtbGFiZWwiPjxyZWN0IGhlaWdodD0iMzkiIHdpZHRoPSI4MS4wNjI1IiB5PSItMTkuNSIgeD0iLTQwLjUzMTI1IiByeT0iMCIgcng9IjAiIHN0eWxlPSIiIGNsYXNzPSJiYXNpYyBsYWJlbC1jb250YWluZXIiPjwvcmVjdD48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMzMuMDMxMjUsIC0xMikiIHN0eWxlPSIiIGNsYXNzPSJsYWJlbCI+PHJlY3Q+PC9yZWN0Pjxmb3JlaWduT2JqZWN0IGhlaWdodD0iMjQiIHdpZHRoPSI2Ni4wNjI1Ij48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IHdoaXRlLXNwYWNlOiBub3dyYXA7IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCI+PHNwYW4gY2xhc3M9Im5vZGVMYWJlbCI+dGhpY2tuZXNzPC9zcGFuPjwvZGl2PjwvZm9yZWlnbk9iamVjdD48L2c+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE3MS4xNTIzNDM3NSwgMjIxLjUpIiBpZD0iZmxvd2NoYXJ0LWRpYW1ldGVyLTE5NSIgY2xhc3M9Im5vZGUgZGVmYXVsdCBkZWZhdWx0IGZsb3djaGFydC1sYWJlbCI+PHJlY3QgaGVpZ2h0PSIzOSIgd2lkdGg9IjgwLjE3OTY4NzUiIHk9Ii0xOS41IiB4PSItNDAuMDg5ODQzNzUiIHJ5PSIwIiByeD0iMCIgc3R5bGU9IiIgY2xhc3M9ImJhc2ljIGxhYmVsLWNvbnRhaW5lciI+PC9yZWN0PjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0zMi41ODk4NDM3NSwgLTEyKSIgc3R5bGU9IiIgY2xhc3M9ImxhYmVsIj48cmVjdD48L3JlY3Q+PGZvcmVpZ25PYmplY3QgaGVpZ2h0PSIyNCIgd2lkdGg9IjY1LjE3OTY4NzUiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgd2hpdGUtc3BhY2U6IG5vd3JhcDsiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIj48c3BhbiBjbGFzcz0ibm9kZUxhYmVsIj5kaWFtZXRlcjwvc3Bhbj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PC9nPjwvZz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyOTAuNDAyMzQzNzUsIDIyMS41KSIgaWQ9ImZsb3djaGFydC1yYWRpdXMtMTk3IiBjbGFzcz0ibm9kZSBkZWZhdWx0IGRlZmF1bHQgZmxvd2NoYXJ0LWxhYmVsIj48cmVjdCBoZWlnaHQ9IjM5IiB3aWR0aD0iNTguMzIwMzEyNSIgeT0iLTE5LjUiIHg9Ii0yOS4xNjAxNTYyNSIgcnk9IjAiIHJ4PSIwIiBzdHlsZT0iIiBjbGFzcz0iYmFzaWMgbGFiZWwtY29udGFpbmVyIj48L3JlY3Q+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTIxLjY2MDE1NjI1LCAtMTIpIiBzdHlsZT0iIiBjbGFzcz0ibGFiZWwiPjxyZWN0PjwvcmVjdD48Zm9yZWlnbk9iamVjdCBoZWlnaHQ9IjI0IiB3aWR0aD0iNDMuMzIwMzEyNSI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyB3aGl0ZS1zcGFjZTogbm93cmFwOyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiPjxzcGFuIGNsYXNzPSJub2RlTGFiZWwiPnJhZGl1czwvc3Bhbj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PC9nPjwvZz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1MjIuNDk2MDkzNzUsIDEyMC41KSIgaWQ9ImZsb3djaGFydC1wYXRoX2xlbmd0aC0xOTkiIGNsYXNzPSJub2RlIGRlZmF1bHQgZGVmYXVsdCBmbG93Y2hhcnQtbGFiZWwiPjxyZWN0IGhlaWdodD0iMzkiIHdpZHRoPSIxMDEuMTAxNTYyNSIgeT0iLTE5LjUiIHg9Ii01MC41NTA3ODEyNSIgcnk9IjAiIHJ4PSIwIiBzdHlsZT0iIiBjbGFzcz0iYmFzaWMgbGFiZWwtY29udGFpbmVyIj48L3JlY3Q+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTQzLjA1MDc4MTI1LCAtMTIpIiBzdHlsZT0iIiBjbGFzcz0ibGFiZWwiPjxyZWN0PjwvcmVjdD48Zm9yZWlnbk9iamVjdCBoZWlnaHQ9IjI0IiB3aWR0aD0iODYuMTAxNTYyNSI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyB3aGl0ZS1zcGFjZTogbm93cmFwOyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiPjxzcGFuIGNsYXNzPSJub2RlTGFiZWwiPnBhdGhfbGVuZ3RoPC9zcGFuPjwvZGl2PjwvZm9yZWlnbk9iamVjdD48L2c+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDUyMi40OTYwOTM3NSwgMjIxLjUpIiBpZD0iZmxvd2NoYXJ0LWRpc3RhbmNlLTIwMSIgY2xhc3M9Im5vZGUgZGVmYXVsdCBkZWZhdWx0IGZsb3djaGFydC1sYWJlbCI+PHJlY3QgaGVpZ2h0PSIzOSIgd2lkdGg9Ijc1LjA5Mzc1IiB5PSItMTkuNSIgeD0iLTM3LjU0Njg3NSIgcnk9IjAiIHJ4PSIwIiBzdHlsZT0iIiBjbGFzcz0iYmFzaWMgbGFiZWwtY29udGFpbmVyIj48L3JlY3Q+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTMwLjA0Njg3NSwgLTEyKSIgc3R5bGU9IiIgY2xhc3M9ImxhYmVsIj48cmVjdD48L3JlY3Q+PGZvcmVpZ25PYmplY3QgaGVpZ2h0PSIyNCIgd2lkdGg9IjYwLjA5Mzc1Ij48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IHdoaXRlLXNwYWNlOiBub3dyYXA7IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCI+PHNwYW4gY2xhc3M9Im5vZGVMYWJlbCI+ZGlzdGFuY2U8L3NwYW4+PC9kaXY+PC9mb3JlaWduT2JqZWN0PjwvZz48L2c+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNTIyLjQ5NjA5Mzc1LCAzMTAuNSkiIGlkPSJmbG93Y2hhcnQtcmFkaWFsX2Rpc3RhbmNlLTIwMyIgY2xhc3M9Im5vZGUgZGVmYXVsdCBkZWZhdWx0IGZsb3djaGFydC1sYWJlbCI+PHJlY3QgaGVpZ2h0PSIzOSIgd2lkdGg9IjEyNC43MTA5Mzc1IiB5PSItMTkuNSIgeD0iLTYyLjM1NTQ2ODc1IiByeT0iMCIgcng9IjAiIHN0eWxlPSIiIGNsYXNzPSJiYXNpYyBsYWJlbC1jb250YWluZXIiPjwvcmVjdD48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtNTQuODU1NDY4NzUsIC0xMikiIHN0eWxlPSIiIGNsYXNzPSJsYWJlbCI+PHJlY3Q+PC9yZWN0Pjxmb3JlaWduT2JqZWN0IGhlaWdodD0iMjQiIHdpZHRoPSIxMDkuNzEwOTM3NSI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyB3aGl0ZS1zcGFjZTogbm93cmFwOyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiPjxzcGFuIGNsYXNzPSJub2RlTGFiZWwiPnJhZGlhbF9kaXN0YW5jZTwvc3Bhbj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PC9nPjwvZz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg2NzEuNjM2NzE4NzUsIDEyMC41KSIgaWQ9ImZsb3djaGFydC13YXZlbGVuZ3RoLTIwNSIgY2xhc3M9Im5vZGUgZGVmYXVsdCBkZWZhdWx0IGZsb3djaGFydC1sYWJlbCI+PHJlY3QgaGVpZ2h0PSIzOSIgd2lkdGg9Ijk3LjE3OTY4NzUiIHk9Ii0xOS41IiB4PSItNDguNTg5ODQzNzUiIHJ5PSIwIiByeD0iMCIgc3R5bGU9IiIgY2xhc3M9ImJhc2ljIGxhYmVsLWNvbnRhaW5lciI+PC9yZWN0PjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC00MS4wODk4NDM3NSwgLTEyKSIgc3R5bGU9IiIgY2xhc3M9ImxhYmVsIj48cmVjdD48L3JlY3Q+PGZvcmVpZ25PYmplY3QgaGVpZ2h0PSIyNCIgd2lkdGg9IjgyLjE3OTY4NzUiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgd2hpdGUtc3BhY2U6IG5vd3JhcDsiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIj48c3BhbiBjbGFzcz0ibm9kZUxhYmVsIj53YXZlbGVuZ3RoPC9zcGFuPjwvZGl2PjwvZm9yZWlnbk9iamVjdD48L2c+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDgzMy4xMjUsIDEyMC41KSIgaWQ9ImZsb3djaGFydC1wb3NpdGlvbl92ZWN0b3ItMjA3IiBjbGFzcz0ibm9kZSBkZWZhdWx0IGRlZmF1bHQgZmxvd2NoYXJ0LWxhYmVsIj48cmVjdCBoZWlnaHQ9IjYzIiB3aWR0aD0iMTI1Ljc5Njg3NSIgeT0iLTMxLjUiIHg9Ii02Mi44OTg0Mzc1IiByeT0iMCIgcng9IjAiIHN0eWxlPSIiIGNsYXNzPSJiYXNpYyBsYWJlbC1jb250YWluZXIiPjwvcmVjdD48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtNTUuMzk4NDM3NSwgLTI0KSIgc3R5bGU9IiIgY2xhc3M9ImxhYmVsIj48cmVjdD48L3JlY3Q+PGZvcmVpZ25PYmplY3QgaGVpZ2h0PSI0OCIgd2lkdGg9IjExMC43OTY4NzUiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgd2hpdGUtc3BhY2U6IG5vd3JhcDsiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIj48c3BhbiBjbGFzcz0ibm9kZUxhYmVsIj5wb3NpdGlvbl92ZWN0b3I8YnIvPnt2ZWN0b3J9PC9zcGFuPjwvZGl2PjwvZm9yZWlnbk9iamVjdD48L2c+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEwMDEuMzkwNjI1LCAxMjAuNSkiIGlkPSJmbG93Y2hhcnQtZGlzcGxhY2VtZW50LTIwOSIgY2xhc3M9Im5vZGUgZGVmYXVsdCBkZWZhdWx0IGZsb3djaGFydC1sYWJlbCI+PHJlY3QgaGVpZ2h0PSI2MyIgd2lkdGg9IjExMC43MzQzNzUiIHk9Ii0zMS41IiB4PSItNTUuMzY3MTg3NSIgcnk9IjAiIHJ4PSIwIiBzdHlsZT0iIiBjbGFzcz0iYmFzaWMgbGFiZWwtY29udGFpbmVyIj48L3JlY3Q+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTQ3Ljg2NzE4NzUsIC0yNCkiIHN0eWxlPSIiIGNsYXNzPSJsYWJlbCI+PHJlY3Q+PC9yZWN0Pjxmb3JlaWduT2JqZWN0IGhlaWdodD0iNDgiIHdpZHRoPSI5NS43MzQzNzUiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgd2hpdGUtc3BhY2U6IG5vd3JhcDsiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIj48c3BhbiBjbGFzcz0ibm9kZUxhYmVsIj5kaXNwbGFjZW1lbnQ8YnIvPnt2ZWN0b3J9PC9zcGFuPjwvZGl2PjwvZm9yZWlnbk9iamVjdD48L2c+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI5MC40MDIzNDM3NSwgMzEwLjUpIiBpZD0iZmxvd2NoYXJ0LXJhZGl1c19vZl9jdXJ2YXR1cmUtMjExIiBjbGFzcz0ibm9kZSBkZWZhdWx0IGRlZmF1bHQgZmxvd2NoYXJ0LWxhYmVsIj48cmVjdCBoZWlnaHQ9IjM5IiB3aWR0aD0iMTU4Ljc1NzgxMjUiIHk9Ii0xOS41IiB4PSItNzkuMzc4OTA2MjUiIHJ5PSIwIiByeD0iMCIgc3R5bGU9IiIgY2xhc3M9ImJhc2ljIGxhYmVsLWNvbnRhaW5lciI+PC9yZWN0PjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC03MS44Nzg5MDYyNSwgLTEyKSIgc3R5bGU9IiIgY2xhc3M9ImxhYmVsIj48cmVjdD48L3JlY3Q+PGZvcmVpZ25PYmplY3QgaGVpZ2h0PSIyNCIgd2lkdGg9IjE0My43NTc4MTI1Ij48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IHdoaXRlLXNwYWNlOiBub3dyYXA7IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCI+PHNwYW4gY2xhc3M9Im5vZGVMYWJlbCI+cmFkaXVzX29mX2N1cnZhdHVyZTwvc3Bhbj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PC9nPjwvZz48L2c+PC9nPjwvZz48L3N2Zz4="/></p>
<p>As we can see, various quantities of the same kind are not a flat
set. They form a hierarchy tree which influences</p>
<ul>
<li>conversion rules, and</li>
<li>the quantity type being the result of adding or subtracting
different quantities of the same kind.</li>
</ul>
<p>The <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span> library
is probably the first one on the market (in any programming language)
that models such abstractions.</p>
<h3 data-number="8.8.1" id="converting-between-quantities-of-the-same-kind"> Converting between quantities
of the same kind<a href="#converting-between-quantities-of-the-same-kind"></a></h3>
<p>Quantity conversion rules can be defined based on the same hierarchy
of quantities of kind length.</p>
<ol type="1">
<li><p><strong>Implicit conversions</strong></p>
<ul>
<li>Every <code>width</code> is a
<code>length</code>.</li>
<li>Every <code>radius</code> is a
<code>width</code>.</li>
</ul>
<div id="cb37"><pre><code><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>implicitly_convertible<span>(</span>isq<span>::</span>width, isq<span>::</span>length<span>))</span>;</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>implicitly_convertible<span>(</span>isq<span>::</span>radius, isq<span>::</span>length<span>))</span>;</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>implicitly_convertible<span>(</span>isq<span>::</span>radius, isq<span>::</span>width<span>))</span>;</span></code></pre></div>
<p>In the <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span> library,
implicit conversions are allowed on copy-initialization:</p>
<div id="cb38"><pre><code><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span>void</span> foo<span>(</span>quantity<span>&lt;</span>isq<span>::</span>length<span>&lt;</span>m<span>&gt;&gt;</span> q<span>)</span>;</span></code></pre></div>
<div id="cb39"><pre><code><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>isq<span>::</span>width<span>&lt;</span>m<span>&gt;&gt;</span> q1 <span>=</span> <span>42</span> <span>*</span> m;</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>isq<span>::</span>length<span>&lt;</span>m<span>&gt;&gt;</span> q2 <span>=</span> q1;  <span>// implicit quantity conversion</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>foo<span>(</span>q1<span>)</span>;                           <span>// implicit quantity conversion</span></span></code></pre></div></li>
<li><p><strong>Explicit conversions</strong></p>
<ul>
<li>Not every <code>length</code> is a
<code>width</code>.</li>
<li>Not every <code>width</code> is a
<code>radius</code>.</li>
</ul>
<div id="cb40"><pre><code><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(!</span>implicitly_convertible<span>(</span>isq<span>::</span>length, isq<span>::</span>width<span>))</span>;</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(!</span>implicitly_convertible<span>(</span>isq<span>::</span>length, isq<span>::</span>radius<span>))</span>;</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(!</span>implicitly_convertible<span>(</span>isq<span>::</span>width, isq<span>::</span>radius<span>))</span>;</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>explicitly_convertible<span>(</span>isq<span>::</span>length, isq<span>::</span>width<span>))</span>;</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>explicitly_convertible<span>(</span>isq<span>::</span>length, isq<span>::</span>radius<span>))</span>;</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>explicitly_convertible<span>(</span>isq<span>::</span>width, isq<span>::</span>radius<span>))</span>;</span></code></pre></div>
<p>In the <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span> library,
explicit conversions are forced by passing the quantity to a call
operator of a <code>quantity_spec</code>
type:</p>
<div id="cb41"><pre><code><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>isq<span>::</span>length<span>&lt;</span>m<span>&gt;&gt;</span> q1 <span>=</span> <span>42</span> <span>*</span> m;</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>isq<span>::</span>height<span>&lt;</span>m<span>&gt;&gt;</span> q2 <span>=</span> isq<span>::</span>height<span>(</span>q1<span>)</span>;  <span>// explicit quantity conversion</span></span></code></pre></div></li>
<li><p><strong>Explicit casts</strong></p>
<ul>
<li><code>height</code> is never a
<code>width</code>, and vice versa.</li>
<li>Both <code>height</code> and
<code>width</code> are quantities of kind
<code>length</code>.</li>
</ul>
<div id="cb42"><pre><code><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(!</span>implicitly_convertible<span>(</span>isq<span>::</span>height, isq<span>::</span>width<span>))</span>;</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(!</span>explicitly_convertible<span>(</span>isq<span>::</span>height, isq<span>::</span>width<span>))</span>;</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>castable<span>(</span>isq<span>::</span>height, isq<span>::</span>width<span>))</span>;</span></code></pre></div>
<p>In the <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span> library,
explicit casts are forced with a dedicated
<code>quantity_cast</code> function:</p>
<div id="cb43"><pre><code><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>isq<span>::</span>width<span>&lt;</span>m<span>&gt;&gt;</span> q1 <span>=</span> <span>42</span> <span>*</span> m;</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>isq<span>::</span>height<span>&lt;</span>m<span>&gt;&gt;</span> q2 <span>=</span> quantity_cast<span>&lt;</span>isq<span>::</span>height<span>&gt;(</span>q1<span>)</span>;  <span>// explicit quantity cast</span></span></code></pre></div></li>
<li><p><strong>No conversion</strong></p>
<ul>
<li><code>time</code> has nothing in common
with <code>length</code>.</li>
</ul>
<div id="cb44"><pre><code><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(!</span>implicitly_convertible<span>(</span>isq<span>::</span>time, isq<span>::</span>length<span>))</span>;</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(!</span>explicitly_convertible<span>(</span>isq<span>::</span>time, isq<span>::</span>length<span>))</span>;</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(!</span>castable<span>(</span>isq<span>::</span>time, isq<span>::</span>length<span>))</span>;</span></code></pre></div>
<p>In the <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span> library,
even the explicit casts will not force such a conversion:</p>
<div id="cb45"><pre><code><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span>void</span> foo<span>(</span>quantity<span>&lt;</span>isq<span>::</span>length<span>[</span>m<span>]&gt;)</span>;</span></code></pre></div>
<div id="cb46"><pre><code><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>foo<span>(</span>quantity_cast<span>&lt;</span>isq<span>::</span>length<span>&gt;(</span><span>42</span> <span>*</span> s<span>))</span>; <span>// Compile-time error</span></span></code></pre></div></li>
</ol>
<p>With the above rules, one can write the following short application
to calculate a fuel consumption:</p>
<div id="cb47"><pre><code><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span>inline</span> <span>constexpr</span> <span>struct</span> fuel_volume <span>:</span> quantity_spec<span>&lt;</span>isq<span>::</span>volume<span>&gt;</span> <span>{}</span> fuel_volume;</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span>inline</span> <span>constexpr</span> <span>struct</span> fuel_consumption <span>:</span> quantity_spec<span>&lt;</span>fuel_volume <span>/</span> isq<span>::</span>distance<span>&gt;</span> <span>{}</span> fuel_consumption;</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span>const</span> quantity fuel <span>=</span> fuel_volume<span>(</span><span>40.</span> <span>*</span> l<span>)</span>;</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span>const</span> quantity distance <span>=</span> isq<span>::</span>distance<span>(</span><span>550.</span> <span>*</span> km<span>)</span>;</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span>const</span> quantity<span>&lt;</span>fuel_consumption<span>[</span>l <span>/</span> <span>(</span>mag<span>&lt;</span><span>100</span><span>&gt;</span> <span>*</span> km<span>)]&gt;</span> q <span>=</span> fuel <span>/</span> distance;</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>std<span>::</span>cout <span>&lt;&lt;</span> <span>&#34;Fuel consumption: &#34;</span> <span>&lt;&lt;</span> q <span>&lt;&lt;</span> <span>&#34;</span><span>\n</span><span>&#34;</span>;</span></code></pre></div>
<p>The above code prints:</p>
<pre><code>Fuel consumption: 7.27273 × 10⁻² l/km</code></pre>
<p>Please note that, despite the dimensions of
<code>fuel_consumption</code> and
<code>isq::area</code> being the same (L²),
the constructor of a quantity <code>q</code>
below will fail to compile when we pass an argument being the quantity
of area:</p>
<div id="cb48"><pre><code><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>fuel_consumption<span>.</span>dimension <span>==</span> isq<span>::</span>area<span>.</span>dimension<span>)</span>;</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span>const</span> quantity<span>&lt;</span>isq<span>::</span>area<span>[</span>m2<span>]&gt;</span> football_field <span>=</span> isq<span>::</span>length<span>(</span><span>105</span> <span>*</span> m<span>)</span> <span>*</span> isq<span>::</span>width<span>(</span><span>68</span> <span>*</span> m<span>)</span>;</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span>const</span> quantity<span>&lt;</span>fuel_consumption<span>[</span>l <span>/</span> <span>(</span>mag<span>&lt;</span><span>100</span><span>&gt;</span> <span>*</span> km<span>)]&gt;</span> q2 <span>=</span> football_field;  <span>// Compile-time error</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span>const</span> quantity q3 <span>=</span> q <span>+</span> football_field;                                     <span>// Compile-time error</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span>if</span> <span>(</span>q <span>==</span> football_field<span>)</span> <span>{</span>                                                  <span>// Compile-time error</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span>// ...</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<h3 data-number="8.8.2" id="comparing-adding-and-subtracting-quantities-of-the-same-kind"> Comparing, adding, and
subtracting quantities of the same kind<a href="#comparing-adding-and-subtracting-quantities-of-the-same-kind"></a></h3>
<p><span data-cites="ISO-GUIDE">[<a href="#ref-ISO-GUIDE" role="doc-biblioref">ISO/IEC Guide 99</a>]</span>
explicitly states that <code>width</code> and
<code>height</code> are quantities of the
same kind and as such they</p>
<ul>
<li>are mutually comparable, and</li>
<li>can be added and subtracted.</li>
</ul>
<p>If we take the above for granted, the only reasonable result of
<code>1 * width + 1 * height</code> is
<code>2 * length</code>, where the result of
<code>length</code> is known as a common
quantity type. A result of such an equation is always the first common
node in a hierarchy tree of the same kind. For example:</p>
<div id="cb49"><pre><code><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>common_quantity_spec<span>(</span>isq<span>::</span>width, isq<span>::</span>height<span>)</span> <span>==</span> isq<span>::</span>length<span>)</span>;</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>common_quantity_spec<span>(</span>isq<span>::</span>thickness, isq<span>::</span>radius<span>)</span> <span>==</span> isq<span>::</span>width<span>)</span>;</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>common_quantity_spec<span>(</span>isq<span>::</span>distance, isq<span>::</span>path_length<span>)</span> <span>==</span> isq<span>::</span>path_length<span>)</span>;</span></code></pre></div>
<div id="cb50"><pre><code><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>quantity q <span>=</span> isq<span>::</span>thickness<span>(</span><span>1</span> <span>*</span> m<span>)</span> <span>+</span> isq<span>::</span>radius<span>(</span><span>1</span> <span>*</span> m<span>)</span>;</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>q<span>.</span>quantity_spec <span>==</span> isq<span>::</span>width<span>)</span>;</span></code></pre></div>
<p>One could argue that allowing to add or compare quantities of height
and width might be a safety issue, but we need to be consistent with the
requirements of <span data-cites="ISO80000">[<a href="#ref-ISO80000" role="doc-biblioref">ISO 80000</a>]</span>.
Moreover, from our experience, disallowing such operations and requiring
an explicit cast to a common quantity in every single place makes the
code so cluttered with casts that it nearly renders the library
unusable.</p>
<p>Fortunately, the above-mentioned conversion rules make the code safe
by construction anyway. Let’s analyze the following example:</p>
<div id="cb51"><pre><code><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span>inline</span> <span>constexpr</span> <span>struct</span> horizontal_length <span>:</span> quantity_spec<span>&lt;</span>isq<span>::</span>length<span>&gt;</span> <span>{}</span> horizontal_length;</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span>namespace</span> christmas <span>{</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span>struct</span> gift <span>{</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  quantity<span>&lt;</span>horizontal_length<span>[</span>m<span>]&gt;</span> length;</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  quantity<span>&lt;</span>isq<span>::</span>width<span>[</span>m<span>]&gt;</span> width;</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  quantity<span>&lt;</span>isq<span>::</span>height<span>[</span>m<span>]&gt;</span> height;</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span>}</span>;</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>std<span>::</span>array<span>&lt;</span>quantity<span>&lt;</span>isq<span>::</span>length<span>[</span>m<span>]&gt;</span>, <span>2</span><span>&gt;</span> gift_wrapping_paper_size<span>(</span><span>const</span> gift<span>&amp;</span> g<span>)</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>  <span>const</span> <span>auto</span> dim1 <span>=</span> <span>2</span> <span>*</span> g<span>.</span>width <span>+</span> <span>2</span> <span>*</span> g<span>.</span>height <span>+</span> <span>0.5</span> <span>*</span> g<span>.</span>width;</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>  <span>const</span> <span>auto</span> dim2 <span>=</span> g<span>.</span>length <span>+</span> <span>2</span> <span>*</span> <span>0.75</span> <span>*</span> g<span>.</span>height;</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>  <span>return</span> <span>{</span> dim1, dim2 <span>}</span>;</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a><span>}</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a><span>}</span>  <span>// namespace christmas</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a><span>int</span> main<span>()</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>  <span>const</span> christmas<span>::</span>gift lego <span>=</span> <span>{</span> horizontal_length<span>(</span><span>40</span> <span>*</span> cm<span>)</span>, isq<span>::</span>width<span>(</span><span>30</span> <span>*</span> cm<span>)</span>, isq<span>::</span>height<span>(</span><span>15</span> <span>*</span> cm<span>)</span> <span>}</span>;</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>  <span>auto</span> paper <span>=</span> christmas<span>::</span>gift_wrapping_paper_size<span>(</span>lego<span>)</span>;</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>  std<span>::</span>cout <span>&lt;&lt;</span> <span>&#34;Paper needed to pack a lego box:</span><span>\n</span><span>&#34;</span>;</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>  std<span>::</span>cout <span>&lt;&lt;</span> <span>&#34;- &#34;</span> <span>&lt;&lt;</span> paper<span>[</span><span>0</span><span>]</span> <span>&lt;&lt;</span> <span>&#34; X &#34;</span> <span>&lt;&lt;</span> paper<span>[</span><span>1</span><span>]</span> <span>&lt;&lt;</span> <span>&#34;</span><span>\n</span><span>&#34;</span>;  <span>// - 1.05 m X 0.625 m</span></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>  std<span>::</span>cout <span>&lt;&lt;</span> <span>&#34;- area = &#34;</span> <span>&lt;&lt;</span> paper<span>[</span><span>0</span><span>]</span> <span>*</span> paper<span>[</span><span>1</span><span>]</span> <span>&lt;&lt;</span> <span>&#34;</span><span>\n</span><span>&#34;</span>;     <span>// - area = 0.65625 m²</span></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>In the beginning, we introduce a custom quantity
<code>horizontal_length</code> of a kind
length, which then, together with
<code>isq::width</code> and
<code>isq::height</code>, are used to define
the dimensions of a Christmas gift. Next, we provide a function that
calculates the dimensions of a gift wrapping paper with some wraparound.
The result of both those expressions is a quantity of
<code>isq::length</code>, as this is the
closest common quantity for the arguments used in this quantity
equation.</p>
<p>Regarding safety, it is important to mention here, that thanks to the
conversion rules provided above, it would be impossible to accidentally
do the following:</p>
<div id="cb52"><pre><code><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span>void</span> foo<span>(</span>quantity<span>&lt;</span>horizontal_length<span>[</span>m<span>]&gt;</span> q<span>)</span>;</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>isq<span>::</span>width<span>[</span>m<span>]&gt;</span> q1 <span>=</span> dim1;  <span>// Compile-time error</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>isq<span>::</span>height<span>[</span>m<span>]&gt;</span> q2<span>{</span>dim1<span>}</span>;  <span>// Compile-time error</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>foo<span>(</span>dim1<span>)</span>;                          <span>// Compile-time error</span></span></code></pre></div>
<p>The reason of compilation errors above is the fact that
<code>isq::length</code> is not implicitly
convertible to the quantities defined based on it. To make the above
code compile, an explicit conversion of a quantity type is needed:</p>
<div id="cb53"><pre><code><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span>void</span> foo<span>(</span>quantity<span>&lt;</span>horizontal_length<span>[</span>m<span>]&gt;</span> q<span>)</span>;</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>isq<span>::</span>width<span>[</span>m<span>]&gt;</span> q1 <span>=</span> isq<span>::</span>width<span>(</span>dim1<span>)</span>;</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>isq<span>::</span>height<span>[</span>m<span>]&gt;</span> q2<span>{</span>isq<span>::</span>height<span>(</span>dim1<span>)}</span>;</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>foo<span>(</span>horizontal_length<span>(</span>dim1<span>))</span>;</span></code></pre></div>
<p>To summarize, rules for addition, subtraction, and comparison of
quantities improve the library usability, while the conversion rules
enhance the safety of the library compared to the libraries that do not
model quantity kinds.</p>
<h3 data-number="8.8.3" id="modeling-a-quantity-kind"> Modeling a quantity kind<a href="#modeling-a-quantity-kind"></a></h3>
<p>In the physical units library, we also need an abstraction describing
an entire family of quantities of the same kind. Such quantities have
not only the same dimension but also can be expressed in the same
units.</p>
<p>To annotate a quantity to represent its kind we introduced the
<code>kind_of&lt;&gt;</code> specifier. For
example, to express any quantity of length, we need to type
<code>kind_of&lt;isq::length&gt;</code>. Such
an entity behaves as any quantity of its kind. This means that it is
implicitly convertible to any quantity in a hierarchy tree.</p>
<div id="cb54"><pre><code><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(!</span>implicitly_convertible<span>(</span>isq<span>::</span>length, isq<span>::</span>height<span>))</span>;</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>implicitly_convertible<span>(</span>kind_of<span>&lt;</span>isq<span>::</span>length<span>&gt;</span>, isq<span>::</span>height<span>))</span>;</span></code></pre></div>
<p>Additionally, the result of operations on quantity kinds is also a
quantity kind:</p>
<div id="cb55"><pre><code><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>same_type<span>&lt;</span>kind_of<span>&lt;</span>isq<span>::</span>length<span>&gt;</span> <span>/</span> kind_of<span>&lt;</span>isq<span>::</span>time<span>&gt;</span>, kind_of<span>&lt;</span>isq<span>::</span>length <span>/</span> isq<span>::</span>time<span>&gt;&gt;)</span>;</span></code></pre></div>
<p>However, if at least one equation’s operand is not a kind, the result
becomes a “strong” quantity where all the kinds are converted to the
hierarchy tree’s root quantities:</p>
<div id="cb56"><pre><code><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(!</span>same_type<span>&lt;</span>kind_of<span>&lt;</span>isq<span>::</span>length<span>&gt;</span> <span>/</span> isq<span>::</span>time, kind_of<span>&lt;</span>isq<span>::</span>length <span>/</span> isq<span>::</span>time<span>&gt;&gt;)</span>;</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>same_type<span>&lt;</span>kind_of<span>&lt;</span>isq<span>::</span>length<span>&gt;</span> <span>/</span> isq<span>::</span>time, isq<span>::</span>length <span>/</span> isq<span>::</span>time<span>&gt;)</span>;</span></code></pre></div>
<h3 data-number="8.8.4" id="restricting-units-to-specific-quantity-kinds"> Restricting units to specific
quantity kinds<a href="#restricting-units-to-specific-quantity-kinds"></a></h3>
<p>By default, units can be used to measure any kind of quantity with
the same dimension. However, as we have mentioned above, some units
(e.g., Hz, Bq) are constrained to be used only with a specific kind.
Also, base units of the SI are meant to measure all of the quantities of
their kinds. To model this, in the <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span> library, we do the
following:</p>
<div id="cb57"><pre><code><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span>// base units</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span>inline</span> <span>constexpr</span> <span>struct</span> metre <span>:</span> named_unit<span>&lt;</span><span>&#34;m&#34;</span>, kind_of<span>&lt;</span>isq<span>::</span>length<span>&gt;&gt;</span> <span>{}</span> metre;</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span>inline</span> <span>constexpr</span> <span>struct</span> second <span>:</span> named_unit<span>&lt;</span><span>&#34;s&#34;</span>, kind_of<span>&lt;</span>isq<span>::</span>time<span>&gt;&gt;</span> <span>{}</span> second;</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span>// derived units</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span>inline</span> <span>constexpr</span> <span>struct</span> hertz <span>:</span> named_unit<span>&lt;</span><span>&#34;Hz&#34;</span>, <span>1</span> <span>/</span> second, kind_of<span>&lt;</span>isq<span>::</span>frequency<span>&gt;&gt;</span> <span>{}</span> hertz;</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span>inline</span> <span>constexpr</span> <span>struct</span> becquerel <span>:</span> named_unit<span>&lt;</span><span>&#34;Bq&#34;</span>, <span>1</span> <span>/</span> second, kind_of<span>&lt;</span>isq<span>::</span>activity<span>&gt;&gt;</span> <span>{}</span> becquerel;</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span>inline</span> <span>constexpr</span> <span>struct</span> baud <span>:</span> named_unit<span>&lt;</span><span>&#34;Bd&#34;</span>, <span>1</span> <span>/</span> si<span>::</span>second, kind_of<span>&lt;</span>iec80000<span>::</span>modulation_rate<span>&gt;&gt;</span> <span>{}</span> baud;</span></code></pre></div>
<p>This means that every time we type
<code>42 * m</code>, we create a quantity of
a kind length with the length dimension. Such a quantity can be added,
subtracted, or compared to any other quantity of the same kind.
Moreover, it is implicitly convertible to any quantity of its kind.
Again, this could be considered a safety issue as one could type:</p>
<div id="cb58"><pre><code><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span>const</span> christmas<span>::</span>gift lego <span>=</span> <span>{</span> <span>40</span> <span>*</span> cm, <span>30</span> <span>*</span> cm, <span>15</span> <span>*</span> cm <span>}</span>;</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span>auto</span> paper <span>=</span> christmas<span>::</span>gift_wrapping_paper_size<span>(</span>lego<span>)</span>;</span></code></pre></div>
<p>The above code compiles fine without the need to force specific
quantity types during construction. This is another tradeoff we have to
do here in order to improve the usability. Otherwise, we would need to
type the following every single time we want to initialize an array or
aggregate:</p>
<div id="cb59"><pre><code><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span>const</span> quantity<span>&lt;</span>isq<span>::</span>position_vector<span>[</span>m<span>]</span>, <span>int</span><span>&gt;</span> measurements<span>[]</span> <span>=</span> <span>{</span> isq<span>::</span>position_vector<span>(</span><span>30&#39;160</span> <span>*</span> m<span>)</span>,</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>                                                                isq<span>::</span>position_vector<span>(</span><span>30&#39;365</span> <span>*</span> m<span>)</span>,</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>                                                                isq<span>::</span>position_vector<span>(</span><span>30&#39;890</span> <span>*</span> m<span>)</span>,</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>                                                                isq<span>::</span>position_vector<span>(</span><span>31&#39;050</span> <span>*</span> m<span>)</span>,</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>                                                                isq<span>::</span>position_vector<span>(</span><span>31&#39;785</span> <span>*</span> m<span>)</span>,</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>                                                                isq<span>::</span>position_vector<span>(</span><span>32&#39;215</span> <span>*</span> m<span>)</span>,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>                                                                isq<span>::</span>position_vector<span>(</span><span>33&#39;130</span> <span>*</span> m<span>)</span>,</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>                                                                isq<span>::</span>position_vector<span>(</span><span>34&#39;510</span> <span>*</span> m<span>)</span>,</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>                                                                isq<span>::</span>position_vector<span>(</span><span>36&#39;010</span> <span>*</span> m<span>)</span>,</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>                                                                isq<span>::</span>position_vector<span>(</span><span>37&#39;265</span> <span>*</span> m<span>)</span> <span>}</span>;</span></code></pre></div>
<p>As we can see above, it would be really inconvenient. With the
current rules, we type:</p>
<div id="cb60"><pre><code><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span>const</span> quantity<span>&lt;</span>isq<span>::</span>position_vector<span>[</span>m<span>]</span>, <span>int</span><span>&gt;</span> measurements<span>[]</span> <span>=</span> <span>{</span> <span>30&#39;160</span> <span>*</span> m, <span>30&#39;365</span> <span>*</span> m, <span>30&#39;890</span> <span>*</span> m, <span>31&#39;050</span> <span>*</span> m,</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>                                                                <span>31&#39;785</span> <span>*</span> m, <span>32&#39;215</span> <span>*</span> m, <span>33&#39;130</span> <span>*</span> m, <span>34&#39;510</span> <span>*</span> m,</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>                                                                <span>36&#39;010</span> <span>*</span> m, <span>37&#39;265</span> <span>*</span> m <span>}</span>;</span></code></pre></div>
<p>which is more user-friendly.</p>
<p>Having such two options also gives users a choice. When we use
different quantities of the same kind in a project (e.g., radius,
wavelength, altitude), we should probably reach for strongly-typed
quantities to bring additional safety for those cases. Otherwise, we can
just use the simple mode for the remaining quantities. We can easily mix
simple and strongly-typed quantities in our projects, and the library
will do its best to protect us based on the information provided.</p>
<h2 data-number="8.9" id="non-negative-quantities"> Non-negative quantities<a href="#non-negative-quantities"></a></h2>
<p>Some quantity types are defined by <span data-cites="ISO80000">[<a href="#ref-ISO80000" role="doc-biblioref">ISO
80000</a>]</span> as explicitly non-negative. Those include quantities
like width, thickness, diameter, and radius. However, it turns out that
it is possible to have negative values of quantities defined as
non-negative. For example,
<code>-1 * isq::diameter[mm]</code> could
represent a change in the diameter of some object. Also, a subtraction
<code>4 * width[mm] - 6 * width[mm]</code>
results in a negative value as the width of the second argument is
larger than the first one.</p>
<p>Non-negative quantities are not limited to those explicitly stated as
being non-negative in the <span data-cites="ISO80000">[<a href="#ref-ISO80000" role="doc-biblioref">ISO
80000</a>]</span>. Some quantities are implicitly non-negative from
their definition. The most obvious example here might be scalar
quantities specified as magnitudes of a vector quantity. For example,
speed is defined as the magnitude of velocity. Again,
<code>-1 * speed[m/s]</code> could represent
a change in average speed between two measurements.</p>
<p>This means that enforcing such constraints for quantity types might
be impossible as those typically are used to represent a difference
between two states or measurements. However, we could apply such
constraints to quantity points, which, by definition, describe the
absolute quantity values. For example, when height is the measure of an
object, a negative value is physically meaningless.</p>
<p>Such logic errors could be detected at runtime with contracts or some
other preconditions or invariants checks.</p>
<!-- Lots of exciting discussion at https://github.com/mpusz/mp-units/issues/468 -->
<h2 data-number="8.10" id="vector-and-tensor-quantities"> Vector and tensor quantities<a href="#vector-and-tensor-quantities"></a></h2>
<p>While talking about physical quantities and units libraries, everyone
expects that the library will protect (preferably at compile-time) from
accidentally replacing multiplication with division operations or vice
versa. Everyone knows and expects that the multiplication of length and
time should not result in speed. It does not mean that such a quantity
equation is invalid. It just results in a quantity of a different
type.</p>
<p>If we expect the above protection for scalar quantities, we should
also strive to provide similar guarantees for vector and tensor
quantities. First, the multiplication or division of two vectors or
tensors is not even mathematically defined. Such operations should be
impossible on quantities using vector or tensor representation
types.</p>
<p>While multiplication and division are with scalars, the dot and cross
products are for vector quantities. The result of the first one is a
scalar. The second one results in a vector perpendicular to both vectors
passed as arguments. A good physical quantities and units library should
protect the user from making such an error of accidentally replacing
those operations.</p>
<p>Vector and tensor quantities can be implemented in two ways:</p>
<ol type="1">
<li><p>Encapsulating multiple quantities into a homogeneous vector or
tensor representation type</p>
<p>This solution is the most common in the C++ market. It requires the
quantities library to provide only basic arithmetic operations
(addition, subtraction, multiplication, and division) which are being
used to calculate the result of linear algebra math. However, this
solution can’t provide any compile-time safety described above, and will
also crash when someone passes a proper vector and tensor representation
type to a quantity, expecting it to work.</p></li>
<li><p>Encapsulating a vector or tensor as a representation type of a
quantity</p>
<p>This provides all the required type safety, but requires the library
to implement more operations on quantities and properly constrain them
so they are selectively enabled when needed. Besides <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span>, the only library that
supports such an approach is <span data-cites="PINT">[<a href="#ref-PINT" role="doc-biblioref">Pint</a>]</span>. Such a solution requires the
following operations to be exposed for quantity types (note that
character refers to the algebraic structure of either scalar, vector and
tensor):</p>
<ul>
<li><code>a + b</code> - addition where both
arguments should be of the same quantity kind and character</li>
<li><code>a - b</code> - subtraction where
both arguments should be of the same quantity kind and character</li>
<li><code>a % b</code> - modulo where both
arguments should be of the same quantity kind and character</li>
<li><code>a * b</code> - multiplication where
one of the arguments has to be a scalar</li>
<li><code>a / b</code> - division where the
divisor has to be scalar</li>
<li><code>a ⋅ b</code> - dot product of two
vectors</li>
<li><code>a × b</code> - cross product of two
vectors</li>
<li><code>|a|</code> - magnitude of a
vector</li>
<li><code>a ⊗ b</code> - tensor product of
two vectors or tensors</li>
<li><code>a ⋅ b</code> - inner product of two
tensors</li>
<li><code>a ⋅ b</code> - inner product of
tensor and vector</li>
<li><code>a : b</code> - scalar product of
two tensors</li>
</ul></li>
</ol>
<p>Additionally, the <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span> library
knows the expected quantity character, which is provided (implicitly or
explicitly) in the definition of each quantity type. Thanks to that, it
prevents the user, for example, from providing a scalar representation
type for force or a vector representation for power quantities.</p>
<div id="cb61"><pre><code><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>QuantityOf<span>&lt;</span>isq<span>::</span>velocity<span>&gt;</span> q1 <span>=</span> <span>60</span> <span>*</span> km <span>/</span> h;                             <span>// Compile-time error</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>QuantityOf<span>&lt;</span>isq<span>::</span>velocity<span>&gt;</span> q2 <span>=</span> la_vector<span>{</span><span>0</span>, <span>0</span>, <span>-</span><span>60</span><span>}</span> <span>*</span> km <span>/</span> h;           <span>// OK</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>QuantityOf<span>&lt;</span>isq<span>::</span>force<span>&gt;</span> q3 <span>=</span> <span>80</span> <span>*</span> kg <span>*</span> <span>(</span><span>10</span> <span>*</span> m <span>/</span> s2<span>)</span>;                    <span>// Compile-time error</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>QuantityOf<span>&lt;</span>isq<span>::</span>force<span>&gt;</span> q4 <span>=</span> <span>80</span> <span>*</span> kg <span>*</span> <span>(</span>la_vector<span>{</span><span>0</span>, <span>0</span>, <span>-</span><span>10</span><span>}</span> <span>*</span> m <span>/</span> s2<span>)</span>;  <span>// OK</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>QuantityOf<span>&lt;</span>isq<span>::</span>power<span>&gt;</span> q5 <span>=</span> q2 <span>*</span> q4;                                    <span>// Compile-time error</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>QuantityOf<span>&lt;</span>isq<span>::</span>power<span>&gt;</span> q5 <span>=</span> dot<span>(</span>q2, q4<span>)</span>;                                <span>// OK</span></span></code></pre></div>
<p><em>Note: <code>q1</code> and
<code>q3</code> can be permitted to compile
by explicitly specializing the
<code>is_vector&lt;T&gt;</code> trait for the
representation type.</em></p>
<p>As we can see above, such features additionally improves the
compile-time safety of the library by ensuring that quantities are
created with proper quantity equations and are using correct
representation types.</p>

<h2 data-number="9.1" id="integer-division"> Integer division<a href="#integer-division"></a></h2>
<p>The physical units library can’t do any runtime branching logic for
the division operator. All logic has to be done at compile-time when the
actual values are not known, and the quantity types can’t change at
runtime.</p>
<p>If we expect
<code>120 * km / (2 * h)</code> to return
<code>60 km / h</code>, we have to agree with
the fact that <code>5 * km / (24 * h)</code>
returns <code>0 km/h</code>. We can’t do a
range check at runtime to dynamically adjust scales and types based on
the values of provided function arguments.</p>
<p>The same applies to:</p>
<div id="cb62"><pre><code><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span><span>5</span> <span>*</span> h <span>/</span> <span>(</span><span>120</span> <span>*</span> min<span>)</span> <span>==</span> <span>0</span> <span>*</span> one<span>)</span>;</span></code></pre></div>
<p>This is why floating-point representation types are recommended as a
default to store the numerical value of a quantity. Some popular
physical units libraries even <a href="https://aurora-opensource.github.io/au/main/troubleshooting/#integer-division-forbidden">forbid
integer division at all</a>.</p>
<p>The problem is similar to the one described in the section about
accidental truncation of values through conversion. While the consequent
use of floating-point representation types may be a good idea, it is not
always possible. Especially in close-to-the-metal applications and small
embedded systems, the use of floating-point types is sometimes not an
option, either for performance reasons or lack of hardware support.
Having different operators for safe floating-point operations and unsafe
integer operations would hurt generic programming. As such, users should
instead use safer representation types.</p>
<h2 data-number="9.2" id="lack-of-safe-numeric-types"> Lack of safe numeric types<a href="#lack-of-safe-numeric-types"></a></h2>
<p>Integers can overflow on arithmetics. This has already caused some
expensive failures in engineering <span data-cites="ARIANE">[<a href="#ref-ARIANE" role="doc-biblioref">Ariane
flight V88</a>]</span>.</p>
<p>Integers can also be truncated during assignment to a narrower
type.</p>
<p>Floating-point types may lose precision during assignment to a
narrower type. Conversion from
<code>std::int64_t</code> to
<code>double</code> may also lose
precision.</p>
<p>If we had safe numeric types in the C++ standard library, they could
easily be used as a <code>quantity</code>
representation type in the physical quantities and units library, which
would address these safety concerns.</p>
<p>Also, having a type trait informing if a conversion from one type to
another is value-preserving would help to address some of the issues
mentioned above.</p>
<h2 data-number="9.3" id="potential-surprises-during-units-composition"> Potential surprises during
units composition<a href="#potential-surprises-during-units-composition"></a></h2>
<p>One of the most essential requirements for a good physical quantities
and units library is to implement units in such a way that they compose.
With that, one can easily create any derived unit using a simple unit
equation on other base or derived units. For example:</p>
<div id="cb63"><pre><code><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span>constexpr</span> Unit <span>auto</span> kmph <span>=</span> km <span>/</span> h;</span></code></pre></div>
<p>We can also easily obtain a quantity with:</p>
<div id="cb64"><pre><code><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>quantity q <span>=</span> <span>60</span> <span>*</span> km <span>/</span> h;</span></code></pre></div>
<p>Such a solution is an industry standard and is implemented not only
in <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span>, but also is available for
many years now in both <span data-cites="BOOST-UNITS">[<a href="#ref-BOOST-UNITS" role="doc-biblioref">Boost.Units</a>]</span> and <span data-cites="PINT">[<a href="#ref-PINT" role="doc-biblioref">Pint</a>]</span>.</p>
<p>We believe that is the correct thing to do. However, we want to make
it straight in this paper that some potential issues are associated with
such a syntax. Inexperienced users are often surprised by the results of
the following expression:</p>
<div id="cb65"><pre><code><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>quantity q <span>=</span> <span>60</span> <span>*</span> km <span>/</span> <span>2</span> <span>*</span> h;</span></code></pre></div>
<p>This looks like like <code>30 km/h</code>,
right? But it is not. Thanks to the order of operations, it results in
<code>30 km⋅h</code>. In case we want to
divide <code>60 km</code> by
<code>2 h</code>, parentheses are needed:</p>
<div id="cb66"><pre><code><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>quantity q <span>=</span> <span>60</span> <span>*</span> km <span>/</span> <span>(</span><span>2</span> <span>*</span> h<span>)</span>;</span></code></pre></div>
<p>Another surprising issue may result from the following code:</p>
<div id="cb67"><pre><code><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span>template</span><span>&lt;</span><span>typename</span> T<span>&gt;</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span>auto</span> make_length<span>(</span>T v<span>)</span> <span>{</span> <span>return</span> v <span>*</span> si<span>::</span>metre; <span>}</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span>auto</span> v <span>=</span> <span>42</span>;</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>quantity q <span>=</span> make_length<span>(</span>v<span>)</span>;</span></code></pre></div>
<p>This might look like a good idea, but let’s consider what would
happen if the user provided a quantity as input:</p>
<div id="cb68"><pre><code><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span>auto</span> v <span>=</span> <span>42</span> <span>*</span> m;</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>quantity q <span>=</span> make_length<span>(</span>v<span>)</span>;</span></code></pre></div>
<p>The above function call will result in a quantity of area instead of
the expected quantity of length.</p>
<p>The issues mentioned above could be turned into compilation errors by
disallowing multiplying or dividing a quantity by a unit. The <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span> library initially provided
such an approach, but with time, we decided this to not be
user-friendly. Forcing the user to put the parenthesis around all
derived units in quantity equations like the one below, was too verbose
and confusing:</p>
<div id="cb69"><pre><code><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>quantity q <span>=</span> <span>60</span> <span>*</span> <span>(</span>km <span>/</span> h<span>)</span>;</span></code></pre></div>
<p>It is important to notice that the problems mentioned above will
always surface with a compile-time error at some point in the user’s
code when they assign the resulting quantity to one with an explicitly
provided quantity type.</p>
<p>Below, we provide a few examples that correctly detect such issues at
compile-time:</p>
<div id="cb70"><pre><code><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>si<span>::</span>kilo<span>&lt;</span>si<span>::</span>metre<span>&gt;</span> <span>/</span> non_si<span>::</span>hour, <span>int</span><span>&gt;</span> q1 <span>=</span> <span>60</span> <span>*</span> km <span>/</span> <span>2</span> <span>*</span> h;             <span>// Compile-time error</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>isq<span>::</span>speed<span>[</span>si<span>::</span>kilo<span>&lt;</span>si<span>::</span>metre<span>&gt;</span> <span>/</span> non_si<span>::</span>hour<span>]</span>, <span>int</span><span>&gt;</span> q2 <span>=</span> <span>60</span> <span>*</span> km <span>/</span> <span>2</span> <span>*</span> h; <span>// Compile-time error</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>QuantityOf<span>&lt;</span>isq<span>::</span>speed<span>&gt;</span> <span>auto</span> q3 <span>=</span> <span>60</span> <span>*</span> km <span>/</span> <span>2</span> <span>*</span> h;                                   <span>// Compile-time error</span></span></code></pre></div>
<div id="cb71"><pre><code><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span>template</span><span>&lt;</span><span>typename</span> T<span>&gt;</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span>auto</span> make_length<span>(</span>T v<span>)</span> <span>{</span> <span>return</span> v <span>*</span> si<span>::</span>metre; <span>}</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span>auto</span> v <span>=</span> <span>42</span> <span>*</span> m;</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>si<span>::</span>metre, <span>int</span><span>&gt;</span> q1 <span>=</span> make_length<span>(</span>v<span>)</span>;           <span>// Compile-time error</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>isq<span>::</span>length<span>[</span>si<span>::</span>metre<span>]&gt;</span> q2 <span>=</span> make_length<span>(</span>v<span>)</span>;   <span>// Compile-time error</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>QuantityOf<span>&lt;</span>isq<span>::</span>length<span>&gt;</span> q3 <span>=</span> make_length<span>(</span>v<span>)</span>;            <span>// Compile-time error</span></span></code></pre></div>
<div id="cb72"><pre><code><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span>template</span><span>&lt;</span><span>typename</span> T<span>&gt;</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>QuantityOf<span>&lt;</span>isq<span>::</span>length<span>&gt;</span> <span>auto</span> make_length<span>(</span>T v<span>)</span> <span>{</span> <span>return</span> v <span>*</span> si<span>::</span>metre; <span>}</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span>auto</span> v <span>=</span> <span>42</span> <span>*</span> m;</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>quantity q <span>=</span> make_length<span>(</span>v<span>)</span>;  <span>// Compile-time error</span></span></code></pre></div>
<div id="cb73"><pre><code><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span>template</span><span>&lt;</span>Representation T<span>&gt;</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span>auto</span> make_length<span>(</span>T v<span>)</span> <span>{</span> <span>return</span> v <span>*</span> si<span>::</span>metre; <span>}</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span>auto</span> v <span>=</span> <span>42</span> <span>*</span> m;</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>quantity q <span>=</span> make_length<span>(</span>v<span>)</span>;  <span>// Compile-time error</span></span></code></pre></div>
<h2 data-number="9.4" id="limitations-of-systems-of-quantities"> Limitations of systems of
quantities<a href="#limitations-of-systems-of-quantities"></a></h2>
<p>As stated before, modeling systems of quantities and <a href="#various-quantities-of-the-same-kind">Various quantities of the
same kind</a> significantly improves the safety of the project. However,
it is essential to mention here that such modeling is not ideal and
there might be some pitfalls and surprises associated with some corner
cases.</p>
<h3 data-number="9.4.1" id="allowing-irrational-quantity-combinations"> Allowing irrational quantity
combinations<a href="#allowing-irrational-quantity-combinations"></a></h3>
<p>Everyone probably agrees that multiplying two lengths is an area, and
that area should be implicitly convertible to the result of such a
multiplication:</p>
<div id="cb74"><pre><code><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>implicitly_convertible<span>(</span>isq<span>::</span>length <span>*</span> isq<span>::</span>length, isq<span>::</span>area<span>))</span>;</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>implicitly_convertible<span>(</span>isq<span>::</span>area, isq<span>::</span>length <span>*</span> isq<span>::</span>length<span>))</span>;</span></code></pre></div>
<p>Also, probably no one would be surprised by the fact that the
multiplication of width and height is also convertible to area. Still,
the reverse operation is not valid in this case. Not every area is an
area over width and height, so we need an explicit cast to make such a
conversion:</p>
<div id="cb75"><pre><code><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>implicitly_convertible<span>(</span>isq<span>::</span>width <span>*</span> isq<span>::</span>height, isq<span>::</span>area<span>))</span>;</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(!</span>implicitly_convertible<span>(</span>isq<span>::</span>area, isq<span>::</span>width <span>*</span> isq<span>::</span>height<span>))</span>;</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>explicitly_convertible<span>(</span>isq<span>::</span>area, isq<span>::</span>width <span>*</span> isq<span>::</span>height<span>))</span>;</span></code></pre></div>
<p>However, it might be surprising to some that the similar behavior
will also be observed for the product of two heights:</p>
<div id="cb76"><pre><code><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>implicitly_convertible<span>(</span>isq<span>::</span>height <span>*</span> isq<span>::</span>height, isq<span>::</span>area<span>))</span>;</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(!</span>implicitly_convertible<span>(</span>isq<span>::</span>area, isq<span>::</span>height <span>*</span> isq<span>::</span>height<span>))</span>;</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>explicitly_convertible<span>(</span>isq<span>::</span>area, isq<span>::</span>height <span>*</span> isq<span>::</span>height<span>))</span>;</span></code></pre></div>
<p>For humans, it is hard to imagine how two heights form an area, but
the library’s logic has no way to prevent such operations.</p>
<h3 data-number="9.4.2" id="quantities-of-dimension-one"> Quantities of dimension one<a href="#quantities-of-dimension-one"></a></h3>
<p>Some pitfalls might also arise when dealing with quantities of
dimension one (also known as dimensionless quantities).</p>
<p>If we divide two quantities of the same kind, we end up with a
quantity of dimension one. For example, we can divide two lengths to get
a slope of the ramp or two durations to get the clock accuracy. Those
ratios mean something fundamentally different, but from the dimensional
analysis standpoint, they are mutually comparable.</p>
<p>The above means that the following code is valid:</p>
<div id="cb77"><pre><code><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>quantity q1 <span>=</span> <span>1</span> <span>*</span> m <span>/</span> <span>(</span><span>10</span> <span>*</span> m<span>)</span> <span>+</span> <span>1</span> <span>*</span> us <span>/</span> <span>(</span><span>1</span> <span>*</span> h<span>)</span>;</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>quantity q2 <span>=</span> isq<span>::</span>length<span>(</span><span>1</span> <span>*</span> m<span>)</span> <span>/</span> isq<span>::</span>length<span>(</span><span>10</span> <span>*</span> m<span>)</span> <span>+</span> isq<span>::</span>time<span>(</span><span>1</span> <span>*</span> us<span>)</span> <span>/</span> isq<span>::</span>time<span>(</span><span>1</span> <span>*</span> h<span>)</span>;</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>quantity q3 <span>=</span> isq<span>::</span>height<span>(</span><span>1</span> <span>*</span> m<span>)</span> <span>/</span> isq<span>::</span>length<span>(</span><span>10</span> <span>*</span> m<span>)</span> <span>+</span> isq<span>::</span>time<span>(</span><span>1</span> <span>*</span> us<span>)</span> <span>/</span> isq<span>::</span>time<span>(</span><span>1</span> <span>*</span> h<span>)</span>;</span></code></pre></div>
<p>The fact that the above code compiles fine might again be surprising
to some users of such a library. The result of all such quantity
equations is a <code>dimensionless</code>
quantity as it is the root of this hierarchy tree.</p>
<p>Now, let’s try to convert such results to some quantities of
dimension one. The <code>q1</code> was
obtained from the expression that only used units in the equation, which
means that the actual result of it is a quantity of
<code>kind_of&lt;dimensionless&gt;</code>,
which behaves like any quantity from the tree. Because of it, all of the
below will compile for <code>q1</code>:</p>
<div id="cb78"><pre><code><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>si<span>::</span>metre <span>/</span> si<span>::</span>metre<span>&gt;</span> ok1 <span>=</span> q1;</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;(</span>isq<span>::</span>length <span>/</span> isq<span>::</span>length<span>)[</span>m <span>/</span> m<span>]&gt;</span> ok2 <span>=</span> q1;</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;(</span>isq<span>::</span>height <span>/</span> isq<span>::</span>length<span>)[</span>m <span>/</span> m<span>]&gt;</span> ok3 <span>=</span> q1;</span></code></pre></div>
<p>For <code>q2</code> and
<code>q3</code>, the two first conversions
also succeed. The first one passes because all quantities of a kind are
convertible to such kind. The type of the second quantity is <code>quantity&lt;dimensionless[one]&gt;</code> in
disguise. Such a quantity is a root of the kind tree, so again, all the
quantities from such a tree are convertible to it.</p>
<p>The third conversion fails in both cases, though. Not every
dimensionless quantity is a result of dividing height and length, so an
explicit conversion would be needed to force it to work.</p>
<div id="cb79"><pre><code><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>si<span>::</span>metre <span>/</span> si<span>::</span>metre<span>&gt;</span> ok4 <span>=</span> q2;</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;(</span>isq<span>::</span>length <span>/</span> isq<span>::</span>length<span>)[</span>m <span>/</span> m<span>]&gt;</span> ok5 <span>=</span> q2;</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;(</span>isq<span>::</span>height <span>/</span> isq<span>::</span>length<span>)[</span>m <span>/</span> m<span>]&gt;</span> bad1 <span>=</span> q2;</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;</span>si<span>::</span>metre <span>/</span> si<span>::</span>metre<span>&gt;</span> ok6 <span>=</span> q3;</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;(</span>isq<span>::</span>length <span>/</span> isq<span>::</span>length<span>)[</span>m <span>/</span> m<span>]&gt;</span> ok7 <span>=</span> q3;</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>quantity<span>&lt;(</span>isq<span>::</span>height <span>/</span> isq<span>::</span>length<span>)[</span>m <span>/</span> m<span>]&gt;</span> bad2 <span>=</span> q3;</span></code></pre></div>
<h2 data-number="9.5" id="temperatures"> Temperatures<a href="#temperatures"></a></h2>
<p>Temperature support is one the most challenging parts of any physical
quantities and units library design. This is why it is probably
reasonable to dedicate a chapter to this subject to describe how they
are intended to work and what are the potential pitfalls or
surprises.</p>
<p>First, let’s run the following code:</p>
<div id="cb80"><pre><code><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>quantity q1 <span>=</span> isq<span>::</span>thermodynamic_temperature<span>(</span><span>30.</span> <span>*</span> K<span>)</span>;</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>quantity q2 <span>=</span> isq<span>::</span>Celsius_temperature<span>(</span><span>30.</span> <span>*</span> deg_C<span>)</span>;</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>std<span>::</span>println<span>(</span><span>&#34;q1: {}, {}, {}&#34;</span>, q1, q1<span>.</span>in<span>(</span>deg_C<span>)</span>, q1<span>.</span>in<span>(</span>deg_F<span>))</span>;</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>std<span>::</span>println<span>(</span><span>&#34;q2: {}, {}, {}&#34;</span>, q2<span>.</span>in<span>(</span>K<span>)</span>, q2, q2<span>.</span>in<span>(</span>deg_F<span>))</span>;</span></code></pre></div>
<p>This outputs:</p>
<pre><code>q1: 30 K, 30 °C, 54 °F
q2: 30 K, 30 °C, 54 °F</code></pre>
<p>Also doing the following:</p>
<div id="cb81"><pre><code><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>quantity q3 <span>=</span> isq<span>::</span>Celsius_temperature<span>(</span>q1<span>)</span>;</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>quantity q4 <span>=</span> isq<span>::</span>thermodynamic_temperature<span>(</span>q2<span>)</span>;</span></code></pre></div>
<p>outputs:</p>
<pre><code>q3: 30 K
q4: 30 °C</code></pre>
<p>Even though the <span data-cites="ISO80000">[<a href="#ref-ISO80000" role="doc-biblioref">ISO 80000</a>]</span> provides
dedicated quantity types for thermodynamic temperature and Celsius
temperature, it explicitly states in the description of the first
one:</p>
<blockquote>
<p>Differences of thermodynamic temperatures or changes may be expressed
either in kelvin, symbol K, or in degrees Celsius, symbol °C</p>
</blockquote>
<p>In the description of the second quantity type, we can read:</p>
<blockquote>
<p>The unit degree Celsius is a special name for the kelvin for use in
stating values of Celsius temperature. The unit degree Celsius is by
definition equal in magnitude to the kelvin. A difference or interval of
temperature may be expressed in kelvin or in degrees Celsius.</p>
</blockquote>
<p>As the <code>quantity</code> is a
differential quantity type, it is okay to use any temperature unit for
those, and the results should differ only by the conversion factor. No
offset should be applied here to convert between the origins of
different unit scales.</p>
<p>It is important to mention here that the existence of Celsius
temperature quantity type in <span data-cites="ISO80000">[<a href="#ref-ISO80000" role="doc-biblioref">ISO
80000</a>]</span> is controversial.</p>
<p><span data-cites="ISO80000">[<a href="#ref-ISO80000" role="doc-biblioref">ISO 80000</a>]</span> (part 1) says:</p>
<blockquote>
<p>The system of quantities presented in this document is named the
International System of Quantities (ISQ), in all languages. This name
was not used in ISO 31 series, from which the present harmonized series
has evolved. However, the ISQ does appear in ISO/IEC Guide 99 and is the
system of quantities underlying the International System of Units,
denoted “SI”, in all languages according to the SI Brochure.</p>
</blockquote>
<p>According to the <span data-cites="ISO-GUIDE">[<a href="#ref-ISO-GUIDE" role="doc-biblioref">ISO/IEC Guide 99</a>]</span>,
a system of quantities is a “set of quantities together with a set of
non-contradictory equations relating those quantities”. It also defines
the system of units as “set of base units and derived units, together
with their multiples and submultiples, defined in accordance with given
rules, for a given system of quantities”.</p>
<p>To say it explicitly, the system of quantities should not assume or
use any specific units in its definitions. It is essential as various
systems of units can be defined on top of it, and none of those should
be favored.</p>
<p>However, the Celsius temperature quantity type is defined in <span data-cites="ISO80000">[<a href="#ref-ISO80000" role="doc-biblioref">ISO 80000</a>]</span> (part 5) as:</p>
<blockquote>
<p>temperature difference from the thermodynamic temperature of the ice
point is called the Celsius temperature <span>\(t\)</span>, which is defined by the quantity
equation:</p>
<p><span>\(t = T − T_0\)</span></p>
<p>where <span>\(T\)</span> is thermodynamic
temperature (item 5-1) and <span>\(T_0 =
273,15\:K\)</span></p>
</blockquote>
<p>Celsius temperature is an exceptional quantity in the ISQ as it uses
specific SI units in its definition. This breaks the direction of
dependencies between systems of quantities and units and imposes
significant implementation issues.</p>
<p>As <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span>
implementation clearly distinguishes between systems of quantities and
units and assumes that the latter directly depends on the former, this
quantity definition does not enforce any units or offsets. It is defined
as just a more specialized quantity of the kind of thermodynamic
temperature. We have added the Celsius temperature quantity type for
completeness and to gain more experience with it. Still, maybe a good
decision would be to skip it in the standardization process not to
confuse users.</p>
<p>After quoting the official definitions and terms and presenting how
quantities work, let’s discuss quantity points. Those describe specific
points and are measured relative to a provided origin:</p>
<div id="cb82"><pre><code><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>quantity_point qp1 <span>=</span> si<span>::</span>absolute_zero <span>+</span> isq<span>::</span>thermodynamic_temperature<span>(</span><span>300.</span> <span>*</span> K<span>)</span>;</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>quantity_point qp2 <span>=</span> si<span>::</span>ice_point <span>+</span> isq<span>::</span>Celsius_temperature<span>(</span><span>30.</span> <span>*</span> deg_C<span>)</span>;</span></code></pre></div>
<p>The above provides two different temperature points. The first one is
measured as a relative quantity to the absolute zero
(<code>0 K</code>), and the second one stores
the value relative to the ice point being the beginning of the degree
Celsius scale.</p>
<p>It is essential to understand that the origins of quantity points
will not change if we convert their units:</p>
<div id="cb83"><pre><code><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>quantity_point qp3 <span>=</span> qp1<span>.</span>in<span>(</span>deg_C<span>)</span>;</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>quantity_point qp4 <span>=</span> qp2<span>.</span>in<span>(</span>K<span>)</span>;</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>std<span>::</span>is_same_v<span>&lt;</span><span>decltype</span><span>(</span>qp3<span>.</span>point_origin<span>)</span>, <span>decltype</span><span>(</span>si<span>::</span>absolute_zero<span>)&gt;)</span>;</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span>static_assert</span><span>(</span>std<span>::</span>is_same_v<span>&lt;</span><span>decltype</span><span>(</span>qp4<span>.</span>point_origin<span>)</span>, <span>decltype</span><span>(</span>si<span>::</span>ice_point<span>)&gt;)</span>;</span></code></pre></div>
<p>If we want to obtain the values of quantities in specific units
relative to the origins of their scales, we have to be explicit:</p>
<div id="cb84"><pre><code><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>std<span>::</span>println<span>(</span><span>&#34;qp1: {}, {}, {}&#34;</span>,</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>              qp1<span>.</span>quantity_from<span>(</span>si<span>::</span>absolute_zero<span>)</span>,</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>              qp1<span>.</span>quantity_from<span>(</span>si<span>::</span>ice_point<span>).</span>in<span>(</span>deg_C<span>)</span>,</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>              qp1<span>.</span>quantity_from<span>(</span>usc<span>::</span>zero_Fahrenheit<span>).</span>in<span>(</span>deg_F<span>))</span>;</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>std<span>::</span>println<span>(</span><span>&#34;qp2: {}, {}, {}&#34;</span>,</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>              qp2<span>.</span>quantity_from<span>(</span>si<span>::</span>absolute_zero<span>).</span>in<span>(</span>K<span>)</span>,</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>              qp2<span>.</span>quantity_from<span>(</span>si<span>::</span>ice_point<span>)</span>,</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>              qp2<span>.</span>quantity_from<span>(</span>usc<span>::</span>zero_Fahrenheit<span>).</span>in<span>(</span>deg_F<span>))</span>;</span></code></pre></div>
<p>The above outputs:</p>
<pre><code>qp1: 300 K, 26.85 °C, 80.33 °F
qp2: 303.15 K, 30 °C, 86 °F</code></pre>
<p>Of course, all other combinations are also possible. For example,
nothing should prevent us from checking how many degrees of Celsius are
there starting from the
<code>zero_Fahrenheit</code> for a quantity
point using kelvins with the
<code>absolute_zero</code> origin:</p>
<div id="cb85"><pre><code><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>quantity q <span>=</span> qp1<span>.</span>quantity_from<span>(</span>usc<span>::</span>zero_Fahrenheit<span>).</span>in<span>(</span>deg_C<span>)</span>;</span></code></pre></div>
<p>Please also note that there is no text output support for quantity
points in the <span data-cites="MP-UNITS">[<a href="#ref-MP-UNITS" role="doc-biblioref">mp-units</a>]</span>
library.</p>
<h2 data-number="9.6" id="structural-types"> Structural types<a href="#structural-types"></a></h2>
<p>The <code>quantity</code> and
<code>quantity_point</code> class templates
are structural types to allow them to be passed as template arguments.
For example, we can write the following:</p>
<div id="cb86"><pre><code><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span>constexpr</span> <span>struct</span> amsterdam_sea_level <span>:</span> absolute_point_origin<span>&lt;</span>isq<span>::</span>altitude<span>&gt;</span> <span>{</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span>}</span> amsterdam_sea_level;</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span>constexpr</span> <span>struct</span> mediterranean_sea_level <span>:</span> relative_point_origin<span>&lt;</span>amsterdam_sea_level <span>+</span> isq<span>::</span>altitude<span>(-</span><span>27</span> <span>*</span> cm<span>)&gt;</span> <span>{</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span>}</span> mediterranean_sea_level;</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span>using</span> altitude_DE <span>=</span> quantity_point<span>&lt;</span>isq<span>::</span>altitude<span>[</span>m<span>]</span>, amsterdam_sea_level<span>&gt;</span>;</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span>using</span> altitude_CH <span>=</span> quantity_point<span>&lt;</span>isq<span>::</span>altitude<span>[</span>m<span>]</span>, mediterranean_sea_level<span>&gt;</span>;</span></code></pre></div>
<p>Unfortunately, current language rules require that all member data of
a structural type are public. This could be considered a safety issue.
We try really hard to provide unit-safe interfaces, but at the same time
expose the public “naked” data member that can be freely read or
manipulated by anyone.</p>
<p>Hopefully, this requirement on structural types will be relaxed
before the library gets standardized.</p>

<p>Special thanks and recognition goes to <a href="http://www.epam.com">Epam Systems</a> for supporting Mateusz’s
membership in the ISO C++ Committee and the production of this
proposal.</p>
<p>We would also like to thank Peter Sommerlad for providing valuable
feedback that helped us shape the final version of this document.</p>
<!-- markdownlint-disable -->

<div id="refs" role="doc-bibliography">

<div id="ref-BOOST-UNITS" role="doc-biblioentry"><p>
[Boost.Units] Matthias C. Schabel and Steven Watanabe. Boost.Units. </p><a href="https://www.boost.org/doc/libs/1_83_0/doc/html/boost_units.html"><p>https://www.boost.org/doc/libs/1_83_0/doc/html/boost_units.html</p></a>
</div>





<div id="ref-HOCHRHEINBRÜCKE" role="doc-biblioentry"><p>
[Hochrheinbrücke] An embarrassing discovery during the construction of a
bridge. </p><a href="https://www.normaalamsterdamspeil.nl/wp-content/uploads/2015/03/website_bridge.pdf"><p>https://www.normaalamsterdamspeil.nl/wp-content/uploads/2015/03/website_bridge.pdf</p></a>
</div>
<div id="ref-ISO80000" role="doc-biblioentry"><p>
[ISO 80000] ISO80000: Quantities and units. </p><a href="https://www.iso.org/standard/76921.html"><p>https://www.iso.org/standard/76921.html</p></a>
</div>
<div id="ref-ISO-GUIDE" role="doc-biblioentry"><p>
[ISO/IEC Guide 99] ISO/IEC Guide 99: International vocabulary of
metrology — Basic and general concepts and associated terms (VIM). </p><a href="https://www.iso.org/obp/ui#iso:std:iso-iec:guide:99"><p>https://www.iso.org/obp/ui#iso:std:iso-iec:guide:99</p></a>
</div>
<div id="ref-BIPM-VIM" role="doc-biblioentry"><p>
[JCGM 200:2012] International vocabulary of metrology - Basic and
general concepts and associated terms (VIM) (JCGM 200:2012, 3rd
edition). </p><a href="https://jcgm.bipm.org/vim/en"><p>https://jcgm.bipm.org/vim/en</p></a>
</div>


<div id="ref-MEDICATION_DOSE_ERRORS" role="doc-biblioentry"><p>
[Medication dose errors] Alma Mulac, Ellen Hagesaether, and Anne Gerd
Granas. Medication dose calculation errors and other numeracy mishaps in
hospitals: Analysis of the nature and enablers of incident reports. </p><a href="https://onlinelibrary.wiley.com/doi/10.1111/jan.15072"><p>https://onlinelibrary.wiley.com/doi/10.1111/jan.15072</p></a>
</div>
<div id="ref-MP-UNITS" role="doc-biblioentry"><p>
[mp-units] mp-units - A Physical Quantities and Units library for C++.
</p><a href="https://mpusz.github.io/mp-units"><p>https://mpusz.github.io/mp-units</p></a>
</div>

<div id="ref-P2980R0" role="doc-biblioentry"><p>
[P2980R0] Mateusz Pusz, Dominik Berner, Johel Ernesto Guerrero Peña,
Charles Hogg, Nicolas Holthaus, Roth Michaels, Vincent Reverdy.
2023-10-15. A motivation, scope, and plan for a physical quantities and
units library. </p><a href="https://wg21.link/p2980r0"><p>https://wg21.link/p2980r0</p></a>
</div>
<div id="ref-P2981R0" role="doc-biblioentry"><p>
[P2981R0] Mateusz Pusz, Dominik Berner, Johel Ernesto Guerrero Peña.
2023-10-15. Improving our safety with a physical quantities and units
library. </p><a href="https://wg21.link/p2981r0"><p>https://wg21.link/p2981r0</p></a>
</div>


<div id="ref-THE_GUARDIAN" role="doc-biblioentry"><p>
[The Guardian] Charles Pensulo. Record Heat: Malawi swelters with
temperatures nearly 68F above average. </p><a href="https://randomascii.wordpress.com/2023/10/17/localization-failure-temperature-is-hard"><p>https://randomascii.wordpress.com/2023/10/17/localization-failure-temperature-is-hard</p></a>
</div>
<div id="ref-VCINL" role="doc-biblioentry"><p>
[Value Category Is Not Lifetime] Arthur O’Dwyer. Value Category Is Not
Lifetime. </p><a href="https://quuxplusone.github.io/blog/2019/03/11/value-category-is-not-lifetime/"><p>https://quuxplusone.github.io/blog/2019/03/11/value-category-is-not-lifetime/</p></a>
</div>
<div id="ref-VASA" role="doc-biblioentry"><p>
[Vasa] Rhitu Chatterjee and Lisa Mullins. New Clues Emerge in
Centuries-Old Swedish Shipwreck. </p><a href="https://theworld.org/stories/2012-02-23/new-clues-emerge-centuries-old-swedish-shipwreck"><p>https://theworld.org/stories/2012-02-23/new-clues-emerge-centuries-old-swedish-shipwreck</p></a>
</div>

</div>
</div>
</div></div>
  </body>
</html>
