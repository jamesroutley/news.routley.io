<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://swagnikd.com/posts/the-hobby-project-that-drained-my-wallet-and-taught-me-things/">Original</a>
    <h1>The hobby project that drained my wallet and taught me things</h1>
    
    <div id="readability-page-1" class="page"><div>

<article>
   
  <div><p>I first got the idea during covid lockdown. The world was slowly getting used to remote work, appreciating its benefits and navigating the challenges it brought as the line separating personal and professional worlds got increasingly bleaker.</p>
<p>A mild inconvenience I often faced was that I would be on a call and my parents would call me for lunch or dinner — not knowing I was busy. I bought a smart light and put it in a place where it could be easily seen. Before a meeting started I would turn it on from the mobile app and give it a red color implying that I was busy. I saw this practice in hospitals where a red light above the doctor’s door indicated they were seeing a patient. So it wasn’t a novel idea by any means.</p>
<p>Last year in 2024, when I was applying for jobs I got a take-home assignment from a company in which I had to build something using Gmail APIs. Things didn’t work out in the end, but the exercise gave me decent familiarity with Google APIs and its cloud console.</p>
<p>And somewhere around the same time, I came across this open-source library called <a href="https://github.com/openhue/openhue-go">openhue-go</a> while scrolling reddit.</p>
<p>These individual events or inputs marinated in my mind for sometime and eventually, something clicked. I realised I had all the tools I needed. A perfect use case, experience working with Google APIs, and an open source library to control lights. I just had to tie them together.</p>
<p>I wanted the bulb to light up automatically whenever there was an event on my google calendar and turn off when the event ended — without requiring any human involvement.</p>
<p>Here’s a sneak peak into the final result.</p>
<p>
  <iframe src="https://player.vimeo.com/video/1094283903?dnt=1" title="vimeo video" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>
</p>

<p>At a very high level there are 3 logical pieces involved.</p>
<ul>
<li>A calendar app whose purpose would be to notify on event start and end.</li>
<li>A bulb handler that will act on the notifications.</li>
<li>The bulb itself.</li>
</ul>
<p><img loading="lazy" src="https://swagnikd.com/posts/the-hobby-project-that-drained-my-wallet-and-taught-me-things/img/components-at-high-level.png" alt=""/>
</p>

<p>I wrote this in Go and named it <a href="https://github.com/swagnikdutta/gcal-notify">gcal-notify</a>. The logic is simple. I fetch all events for the current day and merge the ones that overlap. I merge because I want the light to stay “on” for as long as there is an ongoing event on my calendar. By merging overlapping events I get the final time boundaries — between which the bulb must “on”.</p>
<p><img loading="lazy" src="https://swagnikd.com/posts/the-hobby-project-that-drained-my-wallet-and-taught-me-things/img/merged-events-diagram.png" alt="Diagram showing how overlapping calendar events are merged"/>
</p>
<p>It reduces to an interval merging problem. We store the events in a list, sort them by their start times, iterate the list and merge two events if they overlap.</p>
<p>Once I have my list of events for the day, I find out the start time of the upcoming event and save it locally. Whenever the current time equals the upcoming event’s start time, I invoke the logic that lights up the bulb.</p>
<p><code>UpcomingEvent</code> is an important logical construct in this application. It refers to an event that’s currently in progress, if one exists, or the next event relative to current time.</p>
<p>To achieve this, I run a ticker that ticks every second, and in each tick I check if the upcoming event has started. If the current time is within the bounds of the upcoming event’s start and end times, it implies that the event is in progress, and I call a function to turn on the bulb. Likewise, when the current time is past the upcoming event’s end time — implying that the event has ended — I call the appropriate function to turn it off. Lastly and most importantly, I set the next upcoming event.</p>
<p>Here’s the code. I have skipped few portions that handle a couple of edge-cases to keep it short and convey the crux of the logic. If you’re interested to know more, see the <a href="https://github.com/swagnikdutta/gcal-notify/blob/main/types.go#L237">source</a>.</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>func</span> <span>(</span><span>n</span> <span>*</span><span>Notifier</span><span>)</span> <span>watch</span><span>()</span> <span>{</span>
</span></span><span><span>	<span>for</span> <span>{</span>
</span></span><span><span>		<span>select</span> <span>{</span>
</span></span><span><span>		<span>case</span> <span>&lt;-</span><span>n</span><span>.</span><span>done</span><span>:</span>
</span></span><span><span>			<span>return</span>
</span></span><span><span>
</span></span><span><span>		<span>case</span> <span>&lt;-</span><span>n</span><span>.</span><span>t</span><span>.</span><span>C</span><span>:</span>
</span></span><span><span>			<span>if</span> <span>n</span><span>.</span><span>UpcomingEvent</span><span>.</span><span>inProgress</span><span>()</span> <span>&amp;&amp;</span> <span>n</span><span>.</span><span>StartEventThrottler</span><span>.</span><span>Allow</span><span>()</span> <span>{</span>
</span></span><span><span>				<span>// Light it up!
</span></span></span><span><span><span></span>				<span>n</span><span>.</span><span>notifyHueAgent</span><span>(</span><span>eventStarted</span><span>)</span>
</span></span><span><span>				<span>continue</span>
</span></span><span><span>			<span>}</span>
</span></span><span><span>
</span></span><span><span>			<span>if</span> <span>n</span><span>.</span><span>UpcomingEvent</span><span>.</span><span>hasEnded</span><span>()</span> <span>{</span>
</span></span><span><span>				<span>// You think darkness is your ally
</span></span></span><span><span><span></span>				<span>n</span><span>.</span><span>notifyHueAgent</span><span>(</span><span>eventEnded</span><span>)</span>
</span></span><span><span>				<span>// Don&#39;t forget to calculate the next upcoming event
</span></span></span><span><span><span></span>				<span>n</span><span>.</span><span>setUpcomingEvent</span><span>()</span>
</span></span><span><span>			<span>}</span>
</span></span><span><span>		<span>}</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>I have put a throttler <code>n.StartEventThrottler.Allow()</code> in place. It’s for rate limiting requests to the bulb controller. Since the ticker runs every second, I definitely don’t want to bombard the light with repeated “turn-on”/“turn-off” requests. At the same time, some spaced repetition is needed because, its possible that the first request might not reach the bulb. It’s a network call after all. Secondly, I need to consider the possibility of intermittent power cuts. Whenever the power comes back, I want the light to act as per the intended logic.</p>
<p><code>n.notifyHueAgent</code> is the function that instructs the bulb handler to turn on/off the bulb.</p>
<p>Figuring out next upcoming event is straightforward. The events (<code>n.MergedEvents</code>) are already stored, so we just return the next event on the calendar relative to current time.</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>func</span> <span>(</span><span>n</span> <span>*</span><span>Notifier</span><span>)</span> <span>setUpcomingEvent</span><span>()</span> <span>{</span>
</span></span><span><span>	<span>n</span><span>.</span><span>UpcomingEvent</span> <span>=</span> <span>nil</span>
</span></span><span><span>
</span></span><span><span>	<span>for</span> <span>_</span><span>,</span> <span>mergedEvent</span> <span>:=</span> <span>range</span> <span>n</span><span>.</span><span>MergedEvents</span> <span>{</span>
</span></span><span><span>		<span>now</span> <span>:=</span> <span>time</span><span>.</span><span>Now</span><span>()</span>
</span></span><span><span>
</span></span><span><span>		<span>// start &gt;= now &lt;= end
</span></span></span><span><span><span></span>		<span>onGoingEvent</span> <span>:=</span> <span>(</span><span>now</span><span>.</span><span>After</span><span>(</span><span>mergedEvent</span><span>.</span><span>StartTime</span><span>)</span> <span>||</span> <span>now</span><span>.</span><span>Equal</span><span>(</span><span>mergedEvent</span><span>.</span><span>StartTime</span><span>))</span> <span>&amp;&amp;</span>
</span></span><span><span>			<span>(</span><span>now</span><span>.</span><span>Before</span><span>(</span><span>mergedEvent</span><span>.</span><span>EndTime</span><span>)</span> <span>||</span> <span>now</span><span>.</span><span>Equal</span><span>(</span><span>mergedEvent</span><span>.</span><span>EndTime</span><span>))</span>
</span></span><span><span>
</span></span><span><span>		<span>upComingEvent</span> <span>:=</span> <span>now</span><span>.</span><span>Before</span><span>(</span><span>mergedEvent</span><span>.</span><span>StartTime</span><span>)</span>
</span></span><span><span>
</span></span><span><span>		<span>if</span> <span>onGoingEvent</span> <span>||</span> <span>upComingEvent</span> <span>{</span>
</span></span><span><span>			<span>n</span><span>.</span><span>UpcomingEvent</span> <span>=</span> <span>mergedEvent</span>
</span></span><span><span>			<span>break</span>
</span></span><span><span>		<span>}</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Recall that <code>UpcomingEvent</code> is the in-progress event — if there exists one, or else the next immediate event that’s coming up. That’s why, I have that <code>onGoingEvent</code> check there.</p>
<h2 id="a-new-day-comes-with-new-events">A new day comes with new events</h2>
<p>Since I fetch events only for the current day.</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>now</span> <span>:=</span> <span>time</span><span>.</span><span>Now</span><span>()</span>
</span></span><span><span><span>startOfDay</span> <span>:=</span> <span>time</span><span>.</span><span>Date</span><span>(</span><span>now</span><span>.</span><span>Year</span><span>(),</span> <span>now</span><span>.</span><span>Month</span><span>(),</span> <span>now</span><span>.</span><span>Day</span><span>(),</span> 0<span>,</span> 0<span>,</span> 0<span>,</span> 0<span>,</span> <span>time</span><span>.</span><span>Local</span><span>).</span><span>Format</span><span>(</span><span>time</span><span>.</span><span>RFC3339</span><span>)</span>
</span></span><span><span><span>endOfDay</span> <span>:=</span> <span>time</span><span>.</span><span>Date</span><span>(</span><span>now</span><span>.</span><span>Year</span><span>(),</span> <span>now</span><span>.</span><span>Month</span><span>(),</span> <span>now</span><span>.</span><span>Day</span><span>(),</span> 23<span>,</span> 59<span>,</span> 59<span>,</span> 0<span>,</span> <span>time</span><span>.</span><span>Local</span><span>).</span><span>Format</span><span>(</span><span>time</span><span>.</span><span>RFC3339</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>events</span><span>,</span> <span>err</span> <span>:=</span> <span>n</span><span>.</span><span>Service</span><span>.</span><span>Events</span><span>.</span><span>List</span><span>(</span><span>n</span><span>.</span><span>calendarId</span><span>).</span><span>TimeMin</span><span>(</span><span>startOfDay</span><span>).</span><span>TimeMax</span><span>(</span><span>endOfDay</span><span>).</span><span>Do</span><span>()</span>
</span></span><span><span><span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>	<span>// handle error
</span></span></span><span><span><span></span><span>}</span>
</span></span></code></pre></div><p>There is an obvious need to refresh the events list post midnight. It seemed reasonable to place this new-day-detection logic inside the ticker.</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>func</span> <span>(</span><span>n</span> <span>*</span><span>Notifier</span><span>)</span> <span>watch</span><span>()</span> <span>{</span>
</span></span><span><span>	<span>for</span> <span>{</span>
</span></span><span><span>		<span>select</span> <span>{</span>
</span></span><span><span>		<span>case</span> <span>&lt;-</span><span>n</span><span>.</span><span>done</span><span>:</span>
</span></span><span><span>			<span>return</span>
</span></span><span><span>
</span></span><span><span>		<span>case</span> <span>&lt;-</span><span>n</span><span>.</span><span>t</span><span>.</span><span>C</span><span>:</span>
</span></span><span><span>
</span></span><span><span>			<span>if</span> <span>n</span><span>.</span><span>currentDay</span> <span>!=</span> <span>time</span><span>.</span><span>Now</span><span>().</span><span>Day</span><span>()</span> <span>{</span>
</span></span><span><span>				<span>log</span><span>.</span><span>Println</span><span>(</span><span>&#34;syncing calendar post midnight&#34;</span><span>)</span>
</span></span><span><span>
</span></span><span><span>				<span>n</span><span>.</span><span>currentDay</span> <span>=</span> <span>time</span><span>.</span><span>Now</span><span>().</span><span>Day</span><span>()</span>
</span></span><span><span>
</span></span><span><span>				<span>err</span> <span>:=</span> <span>n</span><span>.</span><span>syncCalendar</span><span>()</span>
</span></span><span><span>				<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>					<span>log</span><span>.</span><span>Println</span><span>(</span><span>&#34;error syncing calendar post midnight&#34;</span><span>)</span>
</span></span><span><span>					<span>continue</span>
</span></span><span><span>				<span>}</span>
</span></span><span><span>			<span>}</span>
</span></span><span><span>
</span></span><span><span>			<span>// code for turning bulb on/off on event start/end.
</span></span></span><span><span><span></span>		<span>}</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><h2 id="handling-calendar-updates">Handling calendar updates</h2>
<p>So far, I didn’t talk about how to handle calendar updates. A calendar gets updated when a new event is added, or an old one is deleted or modified. Everytime that happens, I need to repeat the steps I did above — fetch all events, sort them, merge the overlapping ones, set the upcoming event and save its start time.</p>
<p>To get notified on updates, Google provides a <a href="https://developers.google.com/workspace/calendar/api/v3/reference/events/watch">Watch API</a>. The idea is to register a watcher to watch over a resource you care about — in my case, it’s <a href="https://developers.google.com/workspace/calendar/api/v3/reference/events#resource">events</a>. The watcher notifies you when anything about that resource changes. This watch API is common for all <em>watchable</em> Calendar API <a href="https://developers.google.com/workspace/calendar/api/v3/reference#resource-types">resources</a>.</p>
<p>Notifications are delivered through <a href="https://cloud.google.com/monitoring/support/notification-options">notification channels</a> which must be set up individually for each resource type you want to monitor. It is setup by invoking the Watch API.</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>ch</span><span>,</span> <span>err</span> <span>:=</span> <span>notifier</span><span>.</span><span>Service</span><span>.</span><span>Events</span><span>.</span><span>Watch</span><span>(</span><span>os</span><span>.</span><span>Getenv</span><span>(</span><span>calendarId</span><span>),</span> <span>&amp;</span><span>calendar</span><span>.</span><span>Channel</span><span>{</span>
</span></span><span><span>	<span>Id</span><span>:</span>      <span>uuid</span><span>.</span><span>New</span><span>().</span><span>String</span><span>(),</span>
</span></span><span><span>	<span>Address</span><span>:</span> <span>fmt</span><span>.</span><span>Sprintf</span><span>(</span><span>&#34;%s/notify&#34;</span><span>,</span> <span>os</span><span>.</span><span>Getenv</span><span>(</span><span>notificationChannelEndpoint</span><span>)),</span>
</span></span><span><span>	<span>Type</span><span>:</span>    <span>channelTypeWebhook</span><span>,</span>
</span></span><span><span><span>}).</span><span>Do</span><span>()</span>
</span></span></code></pre></div><p>The API takes a <code>calendar.Channel</code> instance. The <code>Address</code> field of the channel is set to the webhook callback url where notifications are delivered. It must be an HTTPS address with a valid SSL certificate — otherwise, Google Calendar API won’t be able to send notifications. Invalid certificates include</p>
<ul>
<li>Self-signed certificates</li>
<li>Certificates signed by untrusted source.</li>
<li>Revoked certificates.</li>
<li>Certificates that have a subject that does not match with target hostname.</li>
</ul>
<p>Notification channels come with expiry. As of now, the calendar API does not support automatic renewal of channels. When a channel is close to its expiry, we have to replace it with a new one by calling the Watch API again.</p>
<p>It’s also important to clarify that the callback request doesn’t give any details about the nature of update. As in, we don’t get to know what was updated or how. We are just told that <em>something</em> has changed — which I feel is a intended design choice. It keeps things simple. Anyway, here’s my handler that recalibrates everything on update.</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>func</span> <span>NewRequestMultiplexer</span><span>(</span><span>notifier</span> <span>*</span><span>Notifier</span><span>)</span> <span>http</span><span>.</span><span>Handler</span> <span>{</span>
</span></span><span><span>	<span>mux</span> <span>:=</span> <span>http</span><span>.</span><span>NewServeMux</span><span>()</span>
</span></span><span><span>	<span>mux</span><span>.</span><span>HandleFunc</span><span>(</span><span>&#34;/notify&#34;</span><span>,</span> <span>notifier</span><span>.</span><span>handleCalendarUpdates</span><span>)</span>
</span></span><span><span>	<span>return</span> <span>mux</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>func</span> <span>(</span><span>n</span> <span>*</span><span>Notifier</span><span>)</span> <span>handleCalendarUpdates</span><span>(</span><span>w</span> <span>http</span><span>.</span><span>ResponseWriter</span><span>,</span> <span>r</span> <span>*</span><span>http</span><span>.</span><span>Request</span><span>)</span> <span>{</span>
</span></span><span><span>	<span>// validation logic
</span></span></span><span><span><span></span>	<span>err</span> <span>:=</span> <span>n</span><span>.</span><span>syncCalendar</span><span>()</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>// log error, do nothing else
</span></span></span><span><span><span></span>	<span>}</span>
</span></span><span><span>	<span>w</span><span>.</span><span>WriteHeader</span><span>(</span><span>http</span><span>.</span><span>StatusOK</span><span>)</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div>
<p>I had recently rented a digital ocean droplet for hosting my hobby projects. Each project runs in its own dedicated container with a reverse proxy sitting at front — also inside a container. I wanted this calendar app to run there too because, I wanted this system to work 24/7, like a background process.</p>
<p>I had previously configured the authorization to use the OAuth flow where the user is shown a consent screen and is asked to grant permissions to the app. This step required manual intervention. With the app running inside a VPS, there was no scope for that. The right choice for this kind of scenario is to use a <a href="https://cloud.google.com/docs/authentication#service-accounts">service account</a>.</p>
<p>A service account is essentially an identity. When you create a service account, you are creating an account of a user impersonating you. Just that this user is not a human. Yet it will have its own google calendar, own “primary” calendar — this bit is important, I will explain later.</p>
<p>To authenticate with a service account, there are two mandatory steps that needs to be done.</p>
<ul>
<li>
<p>First, I have to share my calendar with this service account user. This can be done from the calendar settings.
<img loading="lazy" src="https://swagnikd.com/posts/the-hobby-project-that-drained-my-wallet-and-taught-me-things/img/calendar-shared-with-svc-account.png" alt="How to share your google calendar with a service account"/>
</p>

</li>
<li>
<p>Secondly, my primary calendar — where I create events, must be included in the <a href="https://developers.google.com/workspace/calendar/api/v3/reference/calendarList">calendar list</a> of the service account user. The code below ensures exactly that. I first check if my primary calendar exists in the list — if not, I insert it.</p>

<p>This is a one-time-only action. I do this on application startup.</p>

<div><pre tabindex="0"><code data-lang="go"><span><span><span>func</span> <span>assertUserCalendarExistsInSvcAccount</span><span>(</span><span>notifier</span> <span>*</span><span>Notifier</span><span>)</span> <span>{</span>
</span></span><span><span>
</span></span><span><span>	<span>calendarList</span><span>,</span> <span>err</span> <span>:=</span> <span>notifier</span><span>.</span><span>Service</span><span>.</span><span>CalendarList</span><span>.</span><span>List</span><span>().</span><span>Do</span><span>()</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>// handle error
</span></span></span><span><span><span></span>	<span>}</span>
</span></span><span><span>
</span></span><span><span>	<span>// ensure calendar with my calendar id exists
</span></span></span><span><span><span></span>	<span>idx</span> <span>:=</span> <span>slices</span><span>.</span><span>IndexFunc</span><span>(</span><span>calendarList</span><span>.</span><span>Items</span><span>,</span> <span>func</span><span>(</span><span>entry</span> <span>*</span><span>calendar</span><span>.</span><span>CalendarListEntry</span><span>)</span> <span>bool</span> <span>{</span>
</span></span><span><span>		<span>return</span> <span>entry</span><span>.</span><span>Id</span> <span>==</span> <span>notifier</span><span>.</span><span>calendarId</span>
</span></span><span><span>	<span>})</span>
</span></span><span><span>
</span></span><span><span>	<span>if</span> <span>idx</span> <span>&lt;</span> 0 <span>{</span>
</span></span><span><span>		<span>entry</span> <span>:=</span> <span>&amp;</span><span>calendar</span><span>.</span><span>CalendarListEntry</span><span>{</span>
</span></span><span><span>			<span>Id</span><span>:</span> <span>notifier</span><span>.</span><span>calendarId</span><span>,</span>
</span></span><span><span>		<span>}</span>
</span></span><span><span>
</span></span><span><span>		<span>entry</span><span>,</span> <span>err</span> <span>:=</span> <span>notifier</span><span>.</span><span>Service</span><span>.</span><span>CalendarList</span><span>.</span><span>Insert</span><span>(</span><span>entry</span><span>).</span><span>Do</span><span>()</span>
</span></span><span><span>		<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>			<span>// handle error
</span></span></span><span><span><span></span>		<span>}</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div>
</li>
</ul>
<p>These two are nitty gritty, yet mandatory steps — without which my calendar app won’t work as intended.</p>
<p>Since I authenticated using service account, the app will only know the service account user. It won’t know me.
All future API requests will be made on behalf of this user. So when I fetched calendar list in the above code, it is fetching the calendar list of the service account user.</p>
<p>It’s essential to understand that, even though the service account user is mimicking my identity, it’s still a different user. It won’t have access to <em>my</em> primary calendar unless <em>I</em> grant it access. If it can’t see my calendar, it obviously can’t see my events. If it can’t see my events, it won’t know when to turn the bulb on or off.</p>
<p>I feel these distinctions are not widely talked about — or atleast I couldn’t find them when I was struggling to get it working. So I hope this was helpful.</p>
<h3 id="primary-calendar-is-a-matter-of-perspective">“primary” calendar is a matter of perspective</h3>
<p>Primary calendar is the default calendar associated with your Google account — where events are created by default and where invitations are sent. Since the service account user and I are different users, our primary calendars are going to be different.</p>
<p>So in these two portions of the above snippet,</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>idx</span> <span>:=</span> <span>slices</span><span>.</span><span>IndexFunc</span><span>(</span><span>calendarList</span><span>.</span><span>Items</span><span>,</span> <span>func</span><span>(</span><span>entry</span> <span>*</span><span>calendar</span><span>.</span><span>CalendarListEntry</span><span>)</span> <span>bool</span> <span>{</span>
</span></span><span><span>	<span>return</span> <span>entry</span><span>.</span><span>Id</span> <span>==</span> <span>notifier</span><span>.</span><span>calendarId</span>
</span></span><span><span><span>})</span>
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="go"><span><span><span>entry</span> <span>:=</span> <span>&amp;</span><span>calendar</span><span>.</span><span>CalendarListEntry</span><span>{</span>
</span></span><span><span>	<span>Id</span><span>:</span> <span>notifier</span><span>.</span><span>calendarId</span><span>,</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>If I had set <code>notifier.calendarId</code> to <code>&#34;primary&#34;</code>, I won’t get the intended outcome. The right value for <code>calendarId</code> in this context is my email id.</p>
<p><code>&#34;primary&#34;</code> works fine if you’re <em>not</em> using a service account. But if you are, the meaning of <code>&#34;primary&#34;</code> becomes obscure. The program needs to know specifically <em>whose</em> primary calendar I am refering to — mine or the service account user’s. Using email id removes that ambiguity.</p>
<p>A natural takeaway from all of that is, a calendar owner’s email id can be used interchangeably with <code>&#34;primary&#34;</code> when making API calls on their behalf.</p>

<p>Once I got the setup working on my VPS, I went ahead and purchased the lights. Up until that point, I was just printing messages on stdout — “light it up!”, and “put that thing off”. I wasn’t willing to spend money unless things looked promising.</p>
<p>I bought the white-ambiance <a href="https://www.philips-hue.com/en-in/p/hue-white-ambiance-a60-e27-smart-bulb-800/8718696670361">bulb</a> since it was cheaper among the other options, and it served my usecase perfectly. I also had to purchase a <a href="https://www.philips-hue.com/en-in/p/hue-bridge/8719514342545">hue bridge</a>, as it’s needed to control these bulbs. Once the bridge is setup, it gets its own IP address.</p>
<p>Whether I control the lights programmatically or from the mobile app, all communication goes through the bridge. My app talks to the bridge over the network, and the bridge, in turn, communicates with the bulbs using <a href="https://en.wikipedia.org/wiki/Zigbee#:~:text=A%20Zigbee%20module,with%20radios%20and%20with%20microcontrollers.">Zigbee</a> protocol.</p>
<p>This purchase cost me INR 6300 (bulb: 1800, bridge: 4500).</p>

<p>I got the light and the bridge delivered next day and as I was unpacking it, a realization started to dawn on me. My calendar app is running in my VPS. The bridge will be working within my home network. These are two different networks, so unless I expose the bridge’s IP to the public internet - which is a very bad idea, there was no way I can make this communication happen.</p>
<p>I found myself stuck for a while and spent this time looking for advice/suggestions on the internet. Reddit was particularly helpful here, especially subreddits such as <a href="https://www.reddit.com/r/selfhosted/">r/selfhosted</a>, and <a href="https://www.reddit.com/r/homelab/">r/homelab</a>. There were multiple suggestions, but one particular approach seemed like a common choice among many.</p>
<p>The suggestions didn’t make complete sense right away, so I spent a night or more letting it all soak in. My attempts to give meaning to differing suggestions made it time taking. I took a step back and tried to reason through the problem from first principles.</p>
<p>What’s known is that, there are two different networks involved — one containing the VPS, and the other, my home network, has the hue bridge. This part was not going to change. Hence, some REST API call must be involved — so that the “turn on”, “turn off” communication can take place.</p>
<ul>
<li>If I take the REST API approach to communicate, there has to be a server running on the same network as the bridge. So where would it run? Another computer? A Raspberry Pi? That seems more practical because, my laptop won’t be on 24/7.</li>
<li>But, even with a Pi, I would still have the same security concern that I had with the bridge — I can’t expose its IP to the public internet. How does a Pi help me then?</li>
<li>Can I mask the Pi’s IP address? Sounds like a VPN thingy. Do I need a VPN?</li>
<li>This can’t be a new problem I’m tackling, what’s the go-to solution in the nerdverse?</li>
</ul>
<p>This internal dialogue led me to discovering Tailscale. It’s a fascinating piece of technology and I highly respect its creators. Their official <a href="https://tailscale.com/blog/how-tailscale-works">blog</a> probably does the best job explaining it, but if I have to explain from my limited understanding, tailscale makes it possible for computers to share files, communicate with each another as if they were connected over <a href="https://tailscale.com/blog/remembering-the-lan">LAN</a> — even if these computers are geographically apart. It creates a private <a href="https://tailscale.com/learn/understanding-mesh-vpns">mesh</a> VPN network called a <em>tailnet</em>, and assigns virtual IP addresses to all devices on that network.</p>
<p>All I needed to do was to install tailscale on my VPS and my Pi, sign in to my tailscale account from both these devices to get them added to my tailnet. That was it. It was done! My VPS and Pi could now freely talk to each other, without any concern of exposing IP addresses. And it works. It just works!</p>
<p>And to answer my own question,</p>
<blockquote>
<ul>
<li>But, even with a Pi, I would still have the same security concern that I had with the bridge — I can’t expose its IP to the public internet. How does a Pi help me then?</li>
</ul>
</blockquote>
<p>It helps because, you can install Tailscale on your Pi, but not on your hue bridge.</p>

<p>So I bought myself a Raspberry Pi 4 Model B. This cost me about INR 8000 — including few extra things like the pi case, a memory card, HDMI cable and the power adapter. I find it mildly annoying that the power adapter doesn’t come with the Pi and has to be bought separately.</p>
<p>Anyway, the case had a design flaw. The Pi won’t fit in it properly with the SD card inserted in it. And if I try to insert the the card later — i.e, after putting the Pi inside the case, it won’t go in either, as the case blocks the card slot. So, I chiseled the opening around the slot a bit so that I could slide it in.</p>
<p><img loading="lazy" src="https://swagnikd.com/posts/the-hobby-project-that-drained-my-wallet-and-taught-me-things/img/scraping-rpi.png" alt="Scraping the Raspberry Pi case with a chisel around the SD card slot"/>
</p>


<p>I had to run a web server on this Pi that will respond to the http requests from the calendar app, and control the lights accordingly. I created a small repo called <a href="https://github.com/swagnikdutta/hue-agent">hue-agent</a> that will run this server and expose an API <code>/light/state</code> for the calendar app to communicate.</p>
<p>I defined a light state request type.</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>type</span> <span>LightStateRequest</span> <span>struct</span> <span>{</span>
</span></span><span><span>	<span>On</span>         <span>bool</span>    <span>`json:&#34;on,omitempty&#34;`</span>
</span></span><span><span>	<span>Mirek</span>      <span>int</span>     <span>`json:&#34;mirek,omitempty&#34;`</span>
</span></span><span><span>	<span>Brightness</span> <span>float32</span> <span>`json:&#34;brightness,omitempty&#34;`</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Here <code>Mirek</code> or <a href="https://en.wikipedia.org/wiki/Mired#:~:text=where%20T%20is%20the%20colour,term%20has%20not%20gained%20traction.">mired</a> is a unit for color temperature. A lower value produces cooler, bluish light, while a higher value produces warmer, yellowish light.</p>
<p>And this is the API and its handler</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>func</span> <span>NewRequestMultiplexer</span><span>(</span><span>agent</span> <span>*</span><span>HueAgent</span><span>)</span> <span>http</span><span>.</span><span>Handler</span> <span>{</span>
</span></span><span><span>	<span>mux</span> <span>:=</span> <span>http</span><span>.</span><span>NewServeMux</span><span>()</span>
</span></span><span><span>	<span>mux</span><span>.</span><span>HandleFunc</span><span>(</span><span>&#34;/light/state&#34;</span><span>,</span> <span>validationMiddleware</span><span>(</span><span>agent</span><span>.</span><span>updateBulbState</span><span>))</span>
</span></span><span><span>	<span>return</span> <span>mux</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>func</span> <span>(</span><span>agent</span> <span>*</span><span>HueAgent</span><span>)</span> <span>updateBulbState</span><span>(</span><span>w</span> <span>http</span><span>.</span><span>ResponseWriter</span><span>,</span> <span>r</span> <span>*</span><span>http</span><span>.</span><span>Request</span><span>)</span> <span>{</span>
</span></span><span><span>	<span>// unmarshalling and validation done in validation middleware
</span></span></span><span><span><span></span>
</span></span><span><span>	<span>body</span><span>,</span> <span>ok</span> <span>:=</span> <span>r</span><span>.</span><span>Context</span><span>().</span><span>Value</span><span>(</span><span>lightStatePayloadKey</span><span>).(</span><span>LightStateRequest</span><span>)</span>
</span></span><span><span>	<span>if</span> <span>!</span><span>ok</span> <span>{</span>
</span></span><span><span>		<span>// handle error and return
</span></span></span><span><span><span></span>	<span>}</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span>	<span>var</span> <span>myLight</span> <span>openhue</span><span>.</span><span>LightGet</span>
</span></span><span><span>	<span>lightsMap</span><span>,</span> <span>err</span> <span>:=</span> <span>agent</span><span>.</span><span>home</span><span>.</span><span>GetLights</span><span>()</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>// handle error and return
</span></span></span><span><span><span></span>	<span>}</span>
</span></span><span><span>
</span></span><span><span>	<span>for</span> <span>k</span><span>,</span> <span>v</span> <span>:=</span> <span>range</span> <span>lightsMap</span> <span>{</span>
</span></span><span><span>		<span>if</span> <span>k</span> <span>==</span> <span>os</span><span>.</span><span>Getenv</span><span>(</span><span>lightId</span><span>)</span> <span>{</span>
</span></span><span><span>			<span>myLight</span> <span>=</span> <span>v</span>
</span></span><span><span>		<span>}</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>:=</span> <span>agent</span><span>.</span><span>home</span><span>.</span><span>UpdateLight</span><span>(</span><span>*</span><span>myLight</span><span>.</span><span>Id</span><span>,</span> <span>openhue</span><span>.</span><span>LightPut</span><span>{</span>
</span></span><span><span>		<span>On</span><span>:</span> <span>&amp;</span><span>openhue</span><span>.</span><span>On</span><span>{</span><span>On</span><span>:</span> <span>&amp;</span><span>body</span><span>.</span><span>On</span><span>},</span>
</span></span><span><span>		<span>ColorTemperature</span><span>:</span> <span>&amp;</span><span>openhue</span><span>.</span><span>ColorTemperature</span><span>{</span>
</span></span><span><span>			<span>Mirek</span><span>:</span> <span>&amp;</span><span>body</span><span>.</span><span>Mirek</span><span>,</span>
</span></span><span><span>		<span>},</span>
</span></span><span><span>		<span>Dimming</span><span>:</span> <span>&amp;</span><span>openhue</span><span>.</span><span>Dimming</span><span>{</span><span>Brightness</span><span>:</span> <span>&amp;</span><span>body</span><span>.</span><span>Brightness</span><span>},</span>
</span></span><span><span>	<span>});</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>// handle error and return
</span></span></span><span><span><span></span>	<span>}</span>
</span></span><span><span>
</span></span><span><span>	<span>// return success response HTTP 200
</span></span></span><span><span><span></span><span>}</span>
</span></span></code></pre></div>
<p>This was a genuinely fun project. I picked up some devopsy skills simply because I chose to host it on a VPS — instead of abandoing it after few successful local runs — which I have often done with my previous projects. And that choice made all the difference. It taught me things I wouldn’t have learned otherwise. It pushed me to go deep into some details that I usually don’t tinker with in day-to-day work. If that’s not all, the process has left me with new ideas around how to improve my existing build system, with new tools.</p>
<p>I’m excited because this setup can be used in a lot of interesting ways. The scope for being creative is wide. For example, this can act as a noise-less, yet very effective and annoying morning alarm. Although my wife didn’t seem too excited about this idea.</p>
<p>The first time I saw the bulb light up when an event started, it was a moment of pure joy! I watched the logs on my VPS terminal, and the logs from hue-agent on my Pi, and I could mentally trace the entire path the request travelled through — to eventually light up the bulb. It was my mini eureka moment.</p>
<p>Here’s a diagram that shows the architectural as well as some of the logical components of the calendar app.</p>
<p><img loading="lazy" src="https://swagnikd.com/posts/the-hobby-project-that-drained-my-wallet-and-taught-me-things/img/complete-architectural-diagram.png" alt="A diagram showcasing the logical and architectural components"/>
</p>

<p>I want to say that I tend to use em dashes(—) a lot when I write. I think it looks neat and offers the right amount of pause without breaking the flow. I say this because there is a growing <a href="https://bsky.app/profile/gergely.pragmaticengineer.com/post/3lrisucffwc2f">assumption online</a> that anything containing em dashes is written using ChatGPT.</p>
<p>Having said that, English isn’t my first language and there are times when I struggle to convery my thoughts and explanations in simpler words. This commonly happens when I’m explaining something technical, and going deep into the finer details. In those cases, I <em>take</em> help. Because I don’t want to overwhelm the reader.</p>
<p>For anyone who’s curious, you can type em dash on mac using <code>option</code> + <code>shift</code> + <code>-</code></p>

<ul>
<li><a href="https://developers.google.com/workspace/calendar/api/guides/push">Google notification channels and push notifications</a></li>
<li><a href="https://tailscale.com/blog/how-tailscale-works">How Tailscale works</a></li>
<li>Additional reading
<ul>
<li><a href="https://tailscale.com/learn/understanding-mesh-vpns">Understanding mesh VPNs</a></li>
<li><a href="https://tailscale.com/blog/remembering-the-lan">Remembering the LAN</a></li>
</ul>
</li>
</ul>


  </div>

  
</article>
    </div></div>
  </body>
</html>
