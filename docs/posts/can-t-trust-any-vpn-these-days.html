<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.orhun.dev/cant-trust-any-vpn/">Original</a>
    <h1>Can&#39;t trust any VPN these days</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
      <p>After Turkey banned Discord, I had to jump through some hoops, fix my VPN, and learn a bit about how DNS works.</p>
<p><span id="continue-reading"></span><q>
On October 9th 2024, Discord was banned in Turkey due to various criminal allegations.</q></p><p>Today I&#39;m here to share what I have learned while trying to... you know. Find a way to use Discord again. Surprisingly, this ban ended up being a positive experience for me.</p>
<p><small>I hope the officials are ̶n̶o̶t̶ reading this.</small></p>
<hr/>
<h3 id="timeline"><strong>Timeline</strong></h3>
<p>In the early morning hours of the day that our beloved platform, Discord, got its ass whooped, I was actually at the airport heading to Vienna for the <a href="https://eurorust.eu">EuroRust</a> conference. Before my flight, I tried checking my messages to see if there was anything new - to my surprise, I was greeted with this:</p>
<pre><code><span>----- Certificate i=0 (emailAddress=root@localhost.localdomain,
</span><span>CN=localhost.localdomain,OU=IT,O=MyCompany,L=Seattle,ST=WA,C=US) -----
</span><span>ERROR: No matching issuer found
</span><span>Error downloading with electron net: net::ERR_CERT_AUTHORITY_INVALID
</span></code></pre>
<p>In other words:</p>
<pre><code><span>discord.com uses an invalid security certificate.
</span><span>The certificate is not trusted because it is self-signed.
</span><span>Error code: MOZILLA_PKIX_ERROR_SELF_SIGNED_CERT
</span></code></pre>
<p>I thought:</p>
<blockquote>
<p>Ah, maybe the airport Wi-Fi is acting up. But wait... I&#39;m already connected to the VPN. 🤔</p>
</blockquote>
<p>So I tried using the Discord app on my phone and it worked as usual. Later on, I saw the news when I did a quick research but I didn&#39;t think much about it because I had a flight and a conference ahead. I could always look into it when I&#39;m back home, right? After all, I had a VPN, so it should be fine, <em>right???</em></p>
<p>Well, I came home last night and realized I can&#39;t use Discord at all, even with a VPN.</p>
<p>That&#39;s why I&#39;m writing this blog post in the morning.</p>
<p>Pain.</p>
<hr/>
<h3 id="vpn-setup"><strong>VPN Setup</strong></h3>
<p><small>Not sponsored!</small></p>
<p>You might be asking, &#34;Hey Orhun, VPNs should work out of the box, what kind of a shitty setup do you have?&#34; and you are absolutely right.</p>
<p>I have my own VPN (😎) - in other uncool words, I set up <a href="https://github.com/OpenVPN/openvpn">OpenVPN</a> on a VPS and I have been using it for a while without any issues.</p>
<p><q>Wow, setting that up must be a lot of work!</q></p>
<p>No. In fact, I just ran the <a href="https://github.com/angristan/openvpn-install"><code>openvpn-install</code></a> script to set everything up:</p>
<pre data-lang="bash"><code data-lang="bash"><span>curl</span><span> -O</span><span> https://raw.githubusercontent.com/angristan/openvpn-install/master/openvpn-install.sh
</span><span>chmod +x openvpn-install.sh
</span><span>./openvpn-install.sh
</span></code></pre>
<p>This gives you a configuration file such as <code>client.ovpn</code> which contains your server address, port and certificates and you can simply run this command to connect to the VPN on Linux:</p>
<pre data-lang="bash"><code data-lang="bash"><span>openvpn</span><span> --config </span><span>$HOME/.openvpn/client.ovpn
</span></code></pre>
<p>I use the <a href="https://play.google.com/store/apps/details?id=de.blinkt.openvpn&amp;hl=en&amp;pli=1">Android app</a> as well and everything works like a charm! At least that&#39;s what I thought until this blog post...</p>
<p>Here is the relevant part of my VPN configuration:</p>
<pre data-lang="ini"><code data-lang="ini"><span>client
</span><span>proto </span><span>udp
</span><span>explicit-exit-notify
</span><span>remote </span><span>&lt;</span><span>ip</span><span>&gt; </span><span>1194
</span><span>dev </span><span>tun
</span><span>resolv-retry </span><span>infinite
</span><span>nobind
</span><span>persist-key
</span><span>persist-tun
</span><span>remote-cert-tls </span><span>server
</span><span>verify-x509-name </span><span>server name
</span><span>auth </span><span>SHA256
</span><span>auth-nocache
</span><span>cipher </span><span>AES</span><span>-</span><span>128</span><span>-</span><span>GCM
</span><span>tls-client
</span><span>tls-version-min </span><span>1</span><span>.</span><span>2
</span><span>tls-cipher </span><span>TLS</span><span>-</span><span>ECDHE</span><span>-</span><span>ECDSA</span><span>-</span><span>WITH</span><span>-</span><span>AES</span><span>-</span><span>128</span><span>-</span><span>GCM</span><span>-</span><span>SHA256
</span><span>ignore-unknown-option </span><span>block</span><span>-</span><span>outside</span><span>-</span><span>dns
</span><span>setenv </span><span>opt block</span><span>-</span><span>outside</span><span>-</span><span>dns </span><span># Prevent Windows 10 DNS leak
</span><span>verb </span><span>3
</span></code></pre>
<p>This is a vanilla configuration so I&#39;m mostly using the defaults. See the <a href="https://openvpn.net/community-resources/reference-manual-for-openvpn-2-6/">reference manual</a> for detailed information about these values.</p>
<hr/>
<h3 id="debugging"><strong>Debugging</strong></h3>
<p>The most mind-boggling part of the problem for me was that I was able to use Discord via OpenVPN on my phone but not on my computer. Whenever I try to launch the desktop app, it gets stuck at the loading screen with the error message I shared above. To limit the scope of the problem, I also tried the website app directly, which resulted in the certificate error.</p>
<p><q>How does Discord know that I&#39;m still in Turkey!?</q></p>
<p>I searched around the internet and found out that nearly all the website restrictions in Turkey are done on the DNS level. I quickly brought out <a href="https://github.com/fujiapple852/trippy"><code>trippy</code></a> from my terminal toolbox to check the network hops that are happening while I&#39;m connecting to Discord:</p>
<pre data-lang="bash"><code data-lang="bash"><span>trip discord.com
</span></code></pre>
<p><img src="https://blog.orhun.dev/trippy.jpg" alt="trippy"/></p>
<p><small>I hope I&#39;m not doxxing myself with that image. Maybe I&#39;m just *tripping*... </small></p>
<p>So from 9th hop to 11th, I can see that I am connecting to my OpenVPN server in Frankfurt. But after the 12th hop, it goes back to the Turkey DNS.</p>
<p><q>What? What&#39;s the point of the VPN then lmao</q></p>
<p>Okay, at that point I was clueless. I tried changing the DNS settings of OpenVPN (i.e. <code>dhcp-option DNS 1.1.1.1</code>) but it didn&#39;t work. After a couple of iterations with ChatGPT, it finally led me to the correct path.</p>
<p>It turns out, <strong>my DNS was leaking</strong>.</p>
<blockquote>
<p>The DNS leak is a security flaw that allows your DNS requests to be revealed to your ISP, and anyone else who might be snooping on the network.</p>
</blockquote>
<p>I discovered a website called <a href="https://www.dnsleaktest.com/">DNSLeakTest</a> which you can use to check that:</p>
<p><img src="https://blog.orhun.dev/dns-leak-test.png" alt="DNSLeakTest"/></p>
<p><q>Sheesh dats indeed leakin&#39;</q></p>
<p>So I was using my ISP&#39;s DNS instead of the VPN&#39;s DNS the whole time.</p>
<p>Using this VPN was just pointless. 💀</p>
<hr/>
<h3 id="solution"><strong>Solution</strong></h3>
<p>Remember these lines from my config above?</p>
<pre data-lang="ini"><code data-lang="ini"><span>ignore-unknown-option </span><span>block</span><span>-</span><span>outside</span><span>-</span><span>dns
</span><span>setenv </span><span>opt block</span><span>-</span><span>outside</span><span>-</span><span>dns </span><span># Prevent Windows 10 DNS leak
</span></code></pre>
<p>Using <code>block-outside-dns</code> is also suggested by DNSLeakTest and it sounds like the correct option:</p>
<blockquote>
<p>Block DNS servers on other network adapters to prevent DNS leaks.</p>
</blockquote>
<p><q>Well then, what&#39;s the problem?</q></p>
<blockquote>
<p>It uses Windows Filtering Platform (WFP) and works on Windows Vista or later.</p>
</blockquote>
<p><q>Bruh... Windows Vista mentioned tho o7</q></p>
<p>I&#39;m on <a href="https://archlinux.org/">Arch Linux</a> btw - and it has a very detailed wiki about OpenVPN, as always. It wasn&#39;t very hard to find the exact thing I needed, it&#39;s right there under the <a href="https://wiki.archlinux.org/title/OpenVPN#DNS">DNS section</a>.</p>
<p>In a nutshell:</p>
<ul>
<li>The DNS changes are not automatically applied by the OpenVPN client on Linux.</li>
<li>You need to configure <code>up</code> and <code>down</code> scripts for managing the DNS updates.</li>
<li>The recommended script is <a href="https://github.com/alfredopalhares/openvpn-update-resolv-conf"><code>update-resolv-conf</code></a>, which modifies DNS settings when the VPN connects and restores them upon disconnection.</li>
<li>That script consists of a bunch of arcane bash commands that I don&#39;t understand.</li>
</ul>
<p><q>So how is any of that relevant to DNS leaking?</q></p>
<p>When the DNS changes aren&#39;t automatically applied when connecting to the VPN, the system will continue to use the default DNS settings thus your ISP&#39;s DNS. 💀</p>
<p>So the solution for me was to firstly install the following packages:</p>
<pre data-lang="bash"><code data-lang="bash"><span># install Openresolv for managing DNS settings
</span><span>pacman</span><span> -S</span><span> openresolv
</span><span>
</span><span># install the script for updating DNS with OpenVPN
</span><span># (use your favorite AUR helper)
</span><span>paru</span><span> -S</span><span> openvpn-update-resolv-conf-git
</span></code></pre>
<p>Then add the following lines to the OpenVPN configuration:</p>
<pre data-lang="ini"><code data-lang="ini"><span>script-security </span><span>2 </span><span># Allow script execution
</span><span>up </span><span>/</span><span>etc</span><span>/</span><span>openvpn</span><span>/</span><span>update</span><span>-</span><span>resolv</span><span>-</span><span>conf
</span><span>down </span><span>/</span><span>etc</span><span>/</span><span>openvpn</span><span>/</span><span>update</span><span>-</span><span>resolv</span><span>-</span><span>conf
</span></code></pre>
<p>And run the VPN as usual:</p>
<pre data-lang="bash"><code data-lang="bash"><span>openvpn</span><span> --config </span><span>$HOME/.openvpn/client.ovpn
</span></code></pre>
<p>Boom, no more leaks!</p>
<p><img src="https://blog.orhun.dev/dns-leak-test2.png" alt="DNSLeakTest"/></p>
<p><img src="https://blog.orhun.dev/trippy2.jpg" alt="trippy"/></p>
<p>It goes through Frankfurt as expected!</p>
<p>And I can use Discord again! 🎉</p>
<hr/>

<h4 id="dnsleaktest-tui"><code>dnsleaktest-tui</code></h4>
<p>Since I&#39;m a big fan of terminal tools, I wrote a small proof-of-concept TUI using <a href="https://www.rust-lang.org/">Rust</a>/<a href="https://ratatui.rs/">Ratatui</a> to check if my DNS is leaking. I also added a small traceroute feature to see the network hops.</p>
<p>Here is how it looks like without VPN:</p>
<p><img src="https://blog.orhun.dev/dns-leak-test-poc.jpg" alt="PoC"/></p>
<p>And most importantly, I can observe that my DNS is leaking while I&#39;m connected to the VPN:</p>
<p><img src="https://blog.orhun.dev/dns-leak-test-poc2.jpg" alt="PoC"/></p>
<p>The code is based on <a href="https://github.com/macvk/dnsleaktest">dnsleaktest</a> and I used <a href="https://github.com/fujiapple852/trippy"><code>trippy</code></a> as a library.</p>
<p>⭐ Here is the repository: <a href="https://github.com/orhun/dnsleaktest-tui">https://github.com/orhun/dnsleaktest-tui</a></p>
<h4 id="i3-integration"><strong>i3 integration</strong></h4>
<p>I don&#39;t like running this command every time I want to connect to the VPN:</p>
<pre data-lang="bash"><code data-lang="bash"><span>openvpn</span><span> --config </span><span>$HOME/.openvpn/client.ovpn
</span></code></pre>
<p>So I wanted to add a keybinding to my <a href="https://i3wm.org/">i3</a> configuration to enable/disable the VPN and show a notification on the status bar when it&#39;s connected/disconnected.</p>
<p>So...</p>
<ul>
<li>I switched to <a href="https://community.openvpn.net/openvpn/wiki/Systemd">a systemd service</a> to manage the VPN.</li>
<li>I created a simple script to start/stop the service.</li>
<li>I added a keybinding to my <code>i3</code> configuration to run the script via <code>pkexec</code> (since it requires root privileges).</li>
<li>I installed <code>lxsession-gtk3</code> package as the authentication agent.</li>
<li>I updated my <code>i3status</code> configuration to show the VPN status.</li>
</ul>
<p>⭐ <a href="https://github.com/orhun/dotfiles/commit/1d3cacc54342311d347d1b06a768311d81e5ec7f">Here</a> is how I implemented it.</p>
<p>At the end of the day, I just press <code>Super + Shift + V</code> to connect/disconnect:</p>
<p><img src="https://blog.orhun.dev/lxpolkit.png" alt="lxpolkit"/></p>
<p>And I can see the status (&#34;V: UP&#34;)</p>
<p><img src="https://blog.orhun.dev/i3status.png" alt="i3status"/></p>
<p>Cheers!</p>

    </div></div>
  </body>
</html>
