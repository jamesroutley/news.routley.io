<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.vrk.dev/2024/01/24/just-a-little-form-using-netlify-functions-airtable-sendgrid-and-cloudinary-because-i-like-customization-for-free/">Original</a>
    <h1>Just a little form using Netlify Functions, Airtable, Sendgrid, and Cloudinary because I like customization for free</h1>
    
    <div id="readability-page-1" class="page"><div id="page">

	<!-- #masthead -->
	<div id="content">

	<div id="primary">
		<main id="main">

		
<article id="post-1161">
	<!-- .entry-header -->

	
	<div>
		
<p>Hello everyone! It’s 2024, I did some coding yesterday, and I felt like writing about it!</p>



<p>Yesterday I moved a form on my website <a href="https://pouch.cafe/">Pouch Cafe</a> from a Google Form to a form I coded myself:</p>



<figure><img decoding="async" fetchpriority="high" width="1024" height="592" src="https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-11.35.24@2x-1024x592.png" alt="" srcset="https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-11.35.24@2x-1024x592.png 1024w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-11.35.24@2x-300x174.png 300w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-11.35.24@2x-768x444.png 768w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-11.35.24@2x-1536x888.png 1536w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-11.35.24@2x-2048x1185.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>Basically:</p>



<ul>
<li>I wanted to make a contribution form for my new zine store, <a href="https://pouch.cafe/">Pouch Cafe</a></li>



<li>At first I just made a Google Form <em>(0 code and free!)</em></li>



<li>But then I realized I was unsatisfied with Google Forms <em>(requires a Google login to do what I want, and just takes you out of the Pouch Cafe fantasy)</em></li>



<li>Looked at TypeForm, but requires the paid tier to allow users to submit images <em>(and like Google Forms, takes you out of the fantasy)</em></li>



<li>So then I rewrote the form from “scratch” using (as promised) <a href="https://www.netlify.com/platform/core/functions/">Netlify functions</a>, <a href="https://cloudinary.com/">Cloudinary</a>, <a href="https://airtable.com/">Airtable</a>, and <a href="https://sendgrid.com/en-us/solutions/email-api">Sendgrid</a></li>



<li>And everything is easily within the free tier which we love!!</li>
</ul>



<p>💿 The form is here: <a href="https://pouch.cafe/contribute/">https://pouch.cafe/contribute/</a></p>



<p>I’m pleased with my setup and I’m pleased I made the move, and I wanted to tell you about it!</p>



<p><strong>I’m not going to write a tutorial because it would be FAR too long</strong>, but I will highlight the tutorials &amp; documentation I followed as well as any gotchas on the each step.</p>



<p>Here we go!!</p>



<hr/>



<h2>🌁 Architecture diagram</h2>



<figure><img decoding="async" width="1024" height="615" src="https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-08.57.21@2x-1024x615.png" alt="" srcset="https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-08.57.21@2x-1024x615.png 1024w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-08.57.21@2x-300x180.png 300w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-08.57.21@2x-768x461.png 768w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-08.57.21@2x-1536x922.png 1536w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-08.57.21@2x.png 1812w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>I’ll touch upon each of these things in a tad more detail but here’s a quick runthrough:</p>



<p><strong>Frontend:</strong></p>



<p>My frontend is just an 11ty-powered static site, <a href="https://www.vrk.dev/2021/03/09/guide-how-to-pleasantly-host-a-website-for-free-2021-edition/">which I talked about in 2021</a>, and still holds up! It’s still my go-to setup for a simple website. (tbh the web doesn’t move <em>that</em> fast, but that’s a different topic). </p>



<p>No libraries, just native web APIs.</p>







<ol>
<li>I have a Netlify function that processes the form request from my frontend. CORS-restricted to only allow requests from pouch.cafe domain.</li>



<li>I want to host my form data in an Airtable spreadsheet, BUT there’s one wrinkle – my form requires the user to upload an image. The Airtable API doesn’t let you upload an image directly; you need to give Airtable a public URL of the image hosted somewhere else, which Airtable will then download and reupload onto their own servers. (This means you can delete the image later; the URL is just needed to do this transfer.) So for this intermediate image host, I’m using Cloudinary.</li>



<li>After the image is uploaded to Cloudinary, I can make the API call to add the record to my Airtable spreadsheet.</li>



<li>After that, I want to send the user a confirmation email of their submission! For this I am using the <a href="https://docs.netlify.com/integrations/email-integration/">Netlify Email</a> integration, which required a free <a href="https://sendgrid.com/en-us/solutions/email-api">Sendgrid account</a></li>



<li>I <em>also</em> wanted to send myself an email every time there was a new submission to the Airtable. I could have used Netlify Emails + Sendgrid, but it was simpler and no-code to configure an Airtable Automation for this step.</li>



<li>Once all that’s done, the Netlify function returns a status 200 back to the frontend and the form shows a success page 🥳</li>
</ol>



<h2>💿 Unintelligible GitHub Repos</h2>



<p>I didn’t write these for anyone but me to read or use, so the code is what it is!! But I have no problems with you seeing my mess in case it can help you:</p>



<ul>
<li>Frontend: <a href="https://github.com/vrk/pouch.cafe">vrk/pouch.cafe</a></li>



<li>Backend: <a href="https://github.com/vrk/pouch.cafe-backend">vrk/pouch.cafe-backend</a></li>
</ul>



<hr/>



<h2>📝 Frontend notes &amp; gotchas</h2>



<p><em>(For a guide on my frontend setup, see <a href="https://www.vrk.dev/2021/03/09/guide-how-to-pleasantly-host-a-website-for-free-2021-edition/">Guide: How to pleasantly host a website for free, 2021 edition</a> (My now-setup is identical to then, except RIP Google Domains))</em></p>



<ul>
<li>Wow I love the <a href="https://developer.mozilla.org/en-US/docs/Learn/Forms/Form_validation#built-in_form_validation_examples">Form Validation API</a>. Client-side form validation was WAY less JavaScript than I was expecting. </li>



<li>Particularly the <code><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/required">required</a></code> attribute is… outstanding lol. I love how it prevents form submission AND focuses &amp; highlights the part that wasn’t filled out yet. So easy!!</li>



<li>Then for the form submission, I construct my own <code>fetch</code> request and build up the POST body by constructing the <a href="https://developer.mozilla.org/en-US/docs/Web/API/FormData"><code>FormData</code></a> object. (<a href="https://github.com/vrk/pouch.cafe/blob/48bf4e0c58be0c1f8bf1b59c31fb578d0eac01db/js/journal.js#L19">code</a>) </li>



<li>And just for kindness, I cache the in-progress form data into <code>LocalStorage</code> so that you don’t lose your progress after an accidental navigation</li>



<li>The only real ugly part was the<strong> file submission</strong>, i.e. letting someone choose a file. So let me talk about that real quick….</li>
</ul>



<hr/>



<h3>👻 Tricky bit: Client-side image selection</h3>



<p>Whereas the <code><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/required">required</a></code> attribute feels so much like the dream of modern web development (easy! native! so little code! but customizable! etc), <code><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file">input type=&#34;file&#34;</a></code> feels like 2000s web development lol</p>



<p>This HTML:</p>



<pre><code>&lt;input type=&#34;file&#34; id=&#34;avatar&#34; name=&#34;avatar&#34; accept=&#34;image/png, image/jpeg&#34; /&gt;</code></pre>



<p>Get rendered approximately like this:</p>



<figure><img decoding="async" src="https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-09.47.14@2x.png" alt="" width="214" height="43" srcset="https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-09.47.14@2x.png 402w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-09.47.14@2x-300x61.png 300w" sizes="(max-width: 214px) 100vw, 214px"/></figure>



<p>Aaaaand there’s no way to style this without hacks. Like you can’t change the button style, can’t change “Choose File” or “No file chosen” — AFAICT, it’s either you use ~<em>exactly</em> this, or you <em>hide this element</em> and construct your own UI that calls this underneath.</p>



<p>Which is what I ended up doing!</p>



<h4>Approach #1: The <code>input</code> elements lives in JavaScript alone</h4>



<p>Described in this <a href="https://stackoverflow.com/questions/16215771/how-to-open-select-file-dialog-via-js">StackOverflow post</a>: You can create a fake UI for your image selection UI using <code>div</code>s or whatever you want, add a click event listener to the element, and in the event handler, dynamically create the file element and simulate the click in JavaScript:</p>



<pre><code>const input = document.createElement(&#39;input&#39;);</code></pre>



<p><strong>Downside of this approach:</strong></p>



<ul>
<li>This works perfectly fine, BUT!!!!</li>



<li>Remember how I love the <code><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/required">required</a></code> attribute? Well in my form, the image upload is required!! But if I dynamically create the <code>input</code> like this, I don’t get the nice free form validation upon submit that the <code>required</code> attribute gives me.</li>
</ul>



<p>So instead I wanted an approach that put the <code>input</code> element in the HTML still.</p>



<h4>Approach #2: Styled <code>`label` </code>with `<code>opacity: 0</code>` form element</h4>



<p>Described in this <a href="https://stackoverflow.com/questions/5813344/how-to-customize-input-type-file">StackOverflow post</a>:</p>



<p>You can create a <code>label</code> element for the input:</p>



<pre><code>&lt;label for=&#34;upload-photo&#34;&gt;Browse...&lt;/label&gt;</code></pre>



<p>And then style the <code>label</code> however you want, while hiding the <code>input</code> with <code>opacity: 0</code>:</p>



<pre><code>label {</code></pre>



<p><strong>Downside of this approach:</strong></p>



<ul>
<li>This too works just fine</li>



<li>HOWEVER! lol remember how I love the <code><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/required">required</a></code> attribute? In this approach, when you try to submit the form without having selected a file, the warning will appear underneath the invisible <code>input</code> tag, like so:</li>
</ul>



<figure><img decoding="async" loading="lazy" src="https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.05.22@2x.png" alt="" width="378" height="387" srcset="https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.05.22@2x.png 846w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.05.22@2x-293x300.png 293w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.05.22@2x-768x786.png 768w" sizes="(max-width: 378px) 100vw, 378px"/></figure>



<p>Not the worst but not ideal!</p>



<h4>Approach #3: <code>input</code> within the <code>label</code> with <code>opacity: 0</code> and height &amp; width of 1</h4>



<p>No StackOverflow post for this, just my brain 😎</p>



<p>Here’s the solution I went with:</p>



<pre><code>#journal-img-input {</code></pre>



<pre><code>&lt;label id=&#34;upload-photo&#34; taborder=&#34;0&#34;&gt;</code></pre>



<p>Which, if you try to submit without a photo, looks like this:</p>



<figure><img decoding="async" loading="lazy" src="https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.11.01@2x.png" alt="" width="325" height="309" srcset="https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.11.01@2x.png 708w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.11.01@2x-300x286.png 300w" sizes="(max-width: 325px) 100vw, 325px"/></figure>



<p>Pleasing!!</p>



<hr/>



<h2>📝 Netlify function notes &amp; gotchas</h2>



<p>This was pretty smooth sailing! Love Netlify!!</p>



<ul>
<li>Created a separate repo for the backend, <a href="https://github.com/vrk/pouch.cafe-backend">vrk/pouch.cafe-backend</a>. </li>



<li>Could have done a monorepo, but ehhh that would have required mucking with my <a href="https://github.com/vrk/pouch.cafe">vrk/pouch.cafe</a> frontend config and I was like ehhhh</li>



<li>I basically just followed <a href="https://docs.netlify.com/functions/get-started/?fn-language=ts">Netlify Functions: Getting Started</a> from beginning through “Synchronous function”, then skipped down to “Test Locally”. Tested locally and got Hello World working, then deployed and got Hello World working.</li>



<li>Updated my frontend to call into the function, which required some CORS fiddling (described in more detail below)</li>



<li><strong>Gotcha #1: </strong>FYI <a href="https://docs.netlify.com/functions/overview/#default-deployment-options">Netlify functions must return within 10s</a>. That’s totally fine for my use case, but just a heads up in case you were considering it for a longer request.</li>



<li><strong>Gotcha #2:</strong> Netlify functions also have a <a href="https://docs.netlify.com/functions/overview/#default-deployment-options">6mb payload limit</a> for “buffered synchronous functions” — in this situation, basically that means I can’t send form data that is over 6mb. This is relevant to me because I am uploading an image from the user! So I limited the image file size to 5mb on the client. (The request will, indeed, fail on Netlify if you attempt to send more than 6mb.)</li>
</ul>



<p>OK the CORS fiddling:</p>



<h3>🔒 Restrict requests to only pouch.cafe origin via CORS</h3>



<ul>
<li>Because I am hosting my backend separately from my frontend, I will run into CORS issues when fetching from <code>pouch.cafe</code> origin, to my backend function (which is on a subdomain of <code>netlify.app</code>)</li>



<li>So I needed to send this header in my Netlify function request: <code>&#34;access-control-allow-origin&#34;: &#34;https://pouch.cafe&#34;</code></li>
</ul>



<p>So instead of:</p>



<pre><code>// Requests from pouch.cafe runs into CORS issues, bc function is on a different domain</code></pre>



<p>Do this:</p>



<pre><code>// Requests from pouch.cafe are OK</code></pre>



<p>Hackers, please kindly let me know (like, via words, not hacking) if I did this totally wrong – security stuff is not my expertise at all!</p>



<hr/>



<h2>📝 Cloudinary notes &amp; gotchas</h2>



<p>Shoutout to <a href="https://chinarajames.com/how-to-upload-images-to-airtable-using-their-api/">Chinara James’s post here</a> that put me onto using Cloudinary for this Airtable step! </p>



<p>Cloudinary has a very generous free tier and was super easy to use.</p>



<ul>
<li>My use case was a bit simpler than Chinara’s so I didn’t bother with <code>multer</code>, and hmm now that I’m revisiting this, I forgot to validate that the uploaded file is indeed an image 🤫 maybe I’ll patch it later today</li>



<li>I followed the <a href="https://cloudinary.com/documentation/node_image_and_video_upload#node_js_upload_stream">Cloudinary docs: upload_stream</a></li>
</ul>



<p>Function ended up looking like:</p>



<pre><code>async function uploadToCloudinary(byteArrayBuffer: ArrayBuffer): Promise&lt;UploadApiResponse|undefined&gt; {  </code></pre>



<p>And then the image URL is just here :</p>



<pre><code>  const result = await uploadToCloudinary(arrayBuffer);</code></pre>



<hr/>



<h2>📝 Airtable notes &amp; gotchas</h2>



<p>LOL OK the biggest surprise that came up while implementing my Airtable backend:<strong> </strong></p>



<p>Like literally:</p>



<figure><img decoding="async" loading="lazy" width="1024" height="384" src="https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.51.05@2x-1024x384.png" alt="" srcset="https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.51.05@2x-1024x384.png 1024w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.51.05@2x-300x112.png 300w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.51.05@2x-768x288.png 768w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.51.05@2x.png 1308w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>The Team plan is $24 seat/month btw lolll</p>



<p>sssssssiiiiiiiighhhhhhhhh!!!!!!!!!!!!!!!!!!!!!!!</p>



<blockquote>
<p><strong>sorry it’s rant time<br/></strong></p>



<p><em>imagine charging your users $24/month just to not be blinded by this particular shade of purple that you inflicted upon them:</em></p>



<figure><img decoding="async" loading="lazy" width="1024" height="75" src="https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.57.52@2x-1024x75.png" alt="" srcset="https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.57.52@2x-1024x75.png 1024w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.57.52@2x-300x22.png 300w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.57.52@2x-768x56.png 768w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.57.52@2x-1536x113.png 1536w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-10.57.52@2x-2048x150.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p><em>LIKE WHAT</em></p>



<p><em>sigh but at the same time I am using airtable’s api for free, subsidized by the users who are converting to this Teams plan, presumably via upsells like this, so who am I to complain, but HERE I AM COMPLAINING<br/></em></p>
</blockquote>







<p>My Airtable is in the non-pastel Gray, btw</p>



<p>Other notes:</p>



<ul>
<li>…Not really anything! I’ve used the Airtable API before. Love the interactive docs.</li>



<li>The image was trivial to upload once I had the URL from Cloudinary.</li>
</ul>



<p>API call looked like this:</p>



<pre><code>  const newRecord = {</code></pre>



<p><strong>Gotcha:</strong> Oh yeah, I did have to do an <code>as any</code> cast for the attachment record, since the TypeScript types for Airtable library seems slightly wrong (it has a bunch of required fields that aren’t actually required for the write request)</p>



<hr/>



<h2>📝 Netlify emails notes &amp; gotchas</h2>



<p>Alrighty we’re on the home stretch!</p>



<p>The form data is now saved in Airtable, now we gotta email the form submitter with their submission. (Not required but nice to have!)</p>



<p>This one was a little wonky but for unsatisfying reasons!</p>



<ul>
<li>I set up a free <a href="https://sendgrid.com/en-us">Sendgrid account</a> followed the <a href="https://docs.netlify.com/integrations/email-integration/">Netlify Emails documentation</a>…</li>



<li>…but at first try I couldn’t get my local dev environment to run BOTH the Netlify Emails function (automagically generated) and my handwritten Netlify Function together. Everytime I got the Emails function to run, the other function would be killed, which meant I couldn’t test the emails functionality</li>



<li>I was poking around trying various things, getting nowhere, and then finally was like “eh screw it I’m gonna ditch Netlify Email and just try to use the Sendgrid API directly” — and then as soon as I started converting my code to use the Sendgrid API, the Netlify emails thing started working for me locally????</li>



<li>SO I HAVE NO IDEA WHAT HAPPENED!</li>



<li>But now that it’s working, Netlify Emails is super nice!! 😆</li>
</ul>



<p>The only sorta? tricky part: I add the image that the user submitted as an attachment to the email by converting it to a base64 string like so:</p>



<pre><code>const fileString = Buffer.from(arrayBuffer).toString(&#39;base64&#39;)</code></pre>



<p>Then you can just add an <code>attachments</code> section to the email API call:</p>



<pre><code></code></pre>



<hr/>



<h2></h2>



<p>In addition to sending the user an email, I want to send <em>myself</em> an email every time a user submits something to my form.</p>



<p>I definitely could have used Netlify Emails + Sendgrid for this too!</p>



<p>But I was actually trying to see if I could use Airtable Automation INSTEAD of Netlify Emails + Sendgrid since that’d be simpler + no-code.</p>



<p>However, this was infeasible: Airtable makes you pay to send emails to anyone but owners of that spreadsheet, and AFAICT, the email sent isn’t dynamic, i.e. you can’t inject the form contents into the email that you send to folks, so wouldn’t be good for a form confirmation even if I did pay.</p>



<p>So nothing too much more to say, I just set up a simple email automation that looks like this:</p>



<figure><img decoding="async" loading="lazy" src="https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-11.29.34@2x-1024x632.png" alt="" width="692" height="427" srcset="https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-11.29.34@2x-1024x632.png 1024w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-11.29.34@2x-300x185.png 300w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-11.29.34@2x-768x474.png 768w, https://www.vrk.dev/wp-content/uploads/2024/01/CleanShot-2024-01-24-at-11.29.34@2x.png 1322w" sizes="(max-width: 692px) 100vw, 692px"/></figure>



<hr/>



<h2>🎉 We’re done!!</h2>



<p>COOL</p>



<p>DONE</p>



<p>I’m super satisfied with my form!! And despite the length of this post, this took me about 1 leisurely day to complete. (Roughly half of which was spent mentally screaming about Airtable charging for pastel colors.)</p>



<p>I do lament that it’s 2024 and still not at all easy to create a custom form like this — sure, it took me a leisurely day, but I have over 13 years of professional coding experience, and full-stack web is my expertise!</p>



<p>So until it’s easier to do this stuff, I’ll occasionally leave notes like these on the internet, in hope that maybe a fragment will be helpful to someone somewhere on their own form implementation journey! ✨</p>
	</div><!-- .entry-content -->

	<!-- .entry-footer -->
</article><!-- #post-1161 -->

		</main><!-- #main -->
	</div><!-- #primary -->


	</div><!-- #content -->

	<!-- #colophon -->
</div></div>
  </body>
</html>
