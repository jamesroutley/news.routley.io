<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://badshah.io/guardduty-good-bad-ugly/">Original</a>
    <h1>AWS GuardDuty ‚Äì the Good, the Bad, and the Ugly</h1>
    
    <div id="readability-page-1" class="page"><div id="content"><p>If you listen to anyone discussing AWS security, you probably heard about <a href="https://aws.amazon.com/guardduty/" target="_blank" rel="noopener noreferrer">Amazon GuardDuty</a>. It‚Äôs an intelligent ‚Äúthreat detection‚Äù service from AWS. It‚Äôs similar to an IDS system because it detects issues but doesn‚Äôt prevent them.</p>
<hr/>
<p><strong>TL;DR:</strong></p>
<ul>
<li>The Good
<ul>
<li>Easy to setup</li>
<li>It covers important services and detects a good number of issues</li>
<li>No need to explicitly setup data sources</li>
<li>Seamless integration with other AWS services</li>
<li>No extra infra provisioning</li>
<li>Supports custom trusted IP lists and threat lists</li>
</ul>
</li>
<li>The Bad
<ul>
<li>Not a lot of options (hence not very flexible)</li>
<li>It‚Äôs not foolproof and there are a few bypasses for some checks</li>
</ul>
</li>
<li>The Ugly
<ul>
<li>It‚Äôs cost can get sky-high</li>
</ul>
</li>
<li>Should you enable it? Yes and No (<em>check the conclusion</em> üòâ)</li>
</ul>
<hr/>
<h3 id="guardduty">GuardDuty</h3>
<p>If you ask me to describe GuardDuty‚Äôs detection capabilities in one word - I would say it‚Äôs ‚Äúamazing.‚Äù It detects a variety of issues - from S3 policy allowing public read access, EC2 instances communicating with Tor nodes, and even exfiltration of data over DNS.</p>
<p>It detects these issues using different techniques and data sources. It‚Äôs <a href="https://aws.amazon.com/guardduty/features/" target="_blank" rel="noopener noreferrer">documentation</a> mentions:</p>
<blockquote>
<p>GuardDuty combines machine learning, anomaly detection, network monitoring, and malicious file discovery, utilizing both AWS-developed and industry-leading third-party sources to help protect workloads and data on AWS. GuardDuty is capable of analyzing tens of billions of events across multiple AWS data sources‚Ä¶</p>
</blockquote>
<p>Now, you ask me the important question: <em>Should I enable GuardDuty?</em></p>
<p>I hope you‚Äôll reach closer to your answer by the end of this blog post. üòâ</p>
<p><em><strong>NOTE</strong>: This blog post is based on my experience with GuardDuty on AWS accounts (enabled for almost a year now). S3 Protection got enabled by default. I HAVEN‚ÄôT experimented with Kubernetes Protection and Malware Protection yet.</em></p>
<h3 id="the-good">The Good</h3>
<h4 id="easy-to-setup">Easy to setup</h4>
<p>GuardDuty is a regional service and is recommended to be enabled in every active region. Enabling it is <a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_settingup.html#guardduty_enable-gd" target="_blank" rel="noopener noreferrer">just a few clicks away</a>.</p>
<p>If you have multiple accounts under AWS Organization, then enabling it across accounts needs some additional clicks. Even if you have 100 accounts, enabling it across all doesn‚Äôt take more than 10 minutes for a single region. Also, you get the option to enable/disable certain features for each account from your <a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_organizations.html" target="_blank" rel="noopener noreferrer">AWS Org management or delegated admin account</a>.</p>
<p>Unlike Amazon Inspector or AWS Systems Manager, you don‚Äôt need an agent running on EC2 instances to detect issues like malware and traffic to crypto mining servers.</p>
<h4 id="covers-important-services-and-detects-a-good-number-of-issues">Covers important services and detects a good number of issues</h4>
<p>At the time of writing this blog post, GuardDuty detects issues/anomalies in the following services:</p>
<ul>
<li>Amazon IAM</li>
<li>Amazon S3</li>
<li>Amazon EC2 (and EBS)</li>
<li>Amazon EKS</li>
</ul>
<p>These services, in general, are used to store and process business-critical data. All of them (except EKS) are used by most AWS customers. GuardDuty has <a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-active.html" target="_blank" rel="noopener noreferrer">a good number of findings</a> for these services.</p>
<h4 id="no-need-to-explicitly-setup-data-sources">No need to explicitly setup data sources</h4>
<p>GuardDuty uses different <a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_data-sources.html" target="_blank" rel="noopener noreferrer">data sources</a> to find <a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-active.html" target="_blank" rel="noopener noreferrer">different types of issues</a>. The data sources include VPC flow logs, DNS query logs, CloudTrail logs, and more. You can check the full list of <a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_data-sources.html" target="_blank" rel="noopener noreferrer">data sources in the official documentation</a>.</p>
<p>Once GuardDuty is enabled, these logs are generated and analyzed on the AWS side.</p>
<blockquote>
<p><strong>Note:</strong> These data sources will not be accessible to you on your AWS account. Let‚Äôs say entities on your VPC does thousands of DNS queries. You will get an alert if a DNS query relates to crypto mining servers. However, you can‚Äôt see the other DNS queries.</p>
</blockquote>
<h4 id="seamless-integration-with-other-aws-services">Seamless integration with other AWS services</h4>
<p>If you are already invested in AWS Security Hub for CSPM, then you don‚Äôt need to make any extra configurations. Any issues GuardDuty detects are sent to Security Hub.</p>
<p>You can also use other AWS services to automate the actions based on the finding. Let‚Äôs say a lambda that disables an IAM user if GuardDuty raises <a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#recon-iam-maliciousipcaller" target="_blank" rel="noopener noreferrer">MaliciousIPCaller</a> finding.</p>

<p>Let‚Äôs say you don‚Äôt want to use Amazon GuardDuty and want to build it on your own. Good. Let‚Äôs give it a try.</p>
<p>Some findings of GuardDuty are easy to implement. Like <a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-s3.html#policy-s3-bucketanonymousaccessgranted" target="_blank" rel="noopener noreferrer">BucketAnonymousAccessGranted</a> and <a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#policy-iam-rootcredentialusage" target="_blank" rel="noopener noreferrer">RootCredentialUsage</a>. They are just static event-based findings. Just tap into CloudTrail management events using EventBridge and trigger a Lambda function depending on the event. These lambda functions check if the recently modified bucket allows public access, whether the root user logged in to AWS Console, etc.</p>
<p>The next category of findings requires a bit of computation and querying. For example: <a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-ec2.html#recon-ec2-portscan" target="_blank" rel="noopener noreferrer">Portscan</a>, <a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-ec2.html#unauthorizedaccess-ec2-sshbruteforce" target="_blank" rel="noopener noreferrer">SSHBruteForce</a> and <a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-ec2.html#unauthorizedaccess-ec2-rdpbruteforce" target="_blank" rel="noopener noreferrer">RDPBruteForce</a>. These findings require you to enable data sources (like VPC flow logs), configure their storage (like sending logs to S3 in text/parquet format) and then do a continuous/periodic check for patterns (maybe using Amazon Athena).</p>
<p>The final category of findings requires a lot of effort to set up and get it working. Most anomalous behavior and exfiltration findings fall under this category. You will need to fetch all data sources and create a data lake. Then create and finetune ML models to find valid issues while keeping the false positive rate down and the false negative rate near zero.</p>
<p>*<em>author sighs deeply</em>*</p>
<p>If you successfully did it - Congrats!</p>
<p>You have reinvented GuardDuty. You now have greater control and understanding of its functionalities.</p>
<p>What was the cost of this setup? Thousands of man-hours, uncountable trials and errors, large infra setup, and a huge AWS bill.</p>
<p>Now, compare it with enabling GuardDuty with a few clicks.</p>
<p>Zero infra provisioning. Logs get generated and analyzed behind the scenes. ML models and threat intel data are regularly updated behind the scenes.</p>
<h4 id="supports-custom-trusted-ip-lists-and-threat-lists">Supports custom trusted IP lists and threat lists</h4>
<p>GuardDuty has the option to whitelist/blacklist certain IPs using trusted IP lists and threat lists. Findings for these lists are generated if the IPs were found in VPC Flow logs and CloudTrail logs.</p>
<p>You can add a <a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_upload-lists.html" target="_blank" rel="noopener noreferrer">trusted IP list</a> to make sure no GuardDuty alerts are generated for those IPs. One common whitelisting use case is with your network scanners running on EC2 instances. You can have only one trusted IP list per AWS account per region.</p>
<p><a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_upload-lists.html" target="_blank" rel="noopener noreferrer">Threat lists</a> are the exact opposite of a trusted IP list. These lists contain IP addresses of threat actors, malware CNC servers, and more. If there‚Äôs any communication to these IPs, a finding gets generated. You can add up to 6 threat lists per AWS account per region.</p>
<h3 id="the-bad">The Bad</h3>
<h4 id="not-a-lot-of-options">Not a lot of options</h4>
<p>GuardDuty options don‚Äôt allow flexibility. You have few options, and that‚Äôs it. In some cases, it‚Äôs just yes or no.</p>
<p>There‚Äôs no option to:</p>
<ul>
<li>add a DNS-based threat list</li>
<li>enable S3 protection on a subset of buckets containing sensitive data</li>
<li>reset the baseline for GuardDuty machine learning models</li>
</ul>
<p>It‚Äôs good from a beginner‚Äôs standpoint - fewer options mean lesser chances of insecure (mis)configuration.</p>
<p>It‚Äôs bad from an experienced user standpoint. I don‚Äôt have flexibility even if I know what I‚Äôm doing.</p>
<h4 id="its-not-foolproof">It‚Äôs not foolproof</h4>
<p>Its detection capabilities are great, but that doesn‚Äôt mean it can‚Äôt be bypassed.</p>
<p>There are a few public (and active) bypasses:</p>
<ul>
<li><a href="https://blog.devgenius.io/aws-guardduty-exfiltration-bypass-4720f6ed16a4" target="_blank" rel="noopener noreferrer">AWS GuardDuty Exfiltration Bypass with VPC Endpoints</a> - describes how <a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws" target="_blank" rel="noopener noreferrer">UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS</a> can be bypassed using VPC endpoints</li>
<li><a href="https://www.youtube.com/watch?v=DKSa32qWiRw" target="_blank" rel="noopener noreferrer">Evading AWS GuardDuty and Network Firewall using Privacy Enhancing tech - Dhruv AHUJA</a> - describes how GuardDuty exfiltration findings can be bypassed using public DNS resolvers.</li>
</ul>
<h3 id="the-ugly">The Ugly</h3>
<h4 id="cost-can-get-sky-high">Cost can get sky-high</h4>
<p>GuardDuty‚Äôs <a href="https://aws.amazon.com/guardduty/pricing/" target="_blank" rel="noopener noreferrer">pricing</a> looks innocent at the first glance. The CloudTrail logs, S3 Data event logs, and EKS audit logs are priced per one million events per month. The VPC flow logs, DNS query logs, and EBS data volume are priced per GB per month.</p>
<p>In oversimplified terms, the price of GuardDuty is proportional to the number of resources and the logs they generate.</p>
<p>If you read the statement carefully, you will understand the devil in the details. üòà</p>
<p>You can always know the number of resources in your account while enabling GuardDuty. The mysterious part is the number of events/logs it generates. If you haven‚Äôt explicitly set up VPC flow logs, S3 access logs, etc you cannot estimate the amount of logs generated.</p>
<blockquote>
<p>GuardDuty‚Äôs <a href="https://docs.aws.amazon.com/guardduty/latest/ug/monitoring_costs.html" target="_blank" rel="noopener noreferrer">cost estimation page</a> doesn‚Äôt give a simple calculator to estimate costs. Instead, it recommends enabling the GuardDuty 30-day trial and checking the average daily cost. But keep in mind that the estimate is just for the existing resources and logs generated. It need not be the same one month, six months, or one year down the line.</p>
</blockquote>
<p>If the resources and/or the amount of logs generated increase, GuardDuty price can go sky-high.</p>
<p><em>I learned this the hard way after enabling GuardDuty with S3 protection on a data engineering account.</em></p>
<p>In that particular AWS account, S3 buckets were used as data lake storage (as per <a href="https://aws.amazon.com/products/storage/data-lake-storage/" target="_blank" rel="noopener noreferrer">AWS recommendation</a>). These buckets had a lot of data engineering tasks going on. Like AWS Glue ETL output saved to certain prefixes, adhoc Athena queries over the data, and daily aggregation queries from BI tools (using Athena connectors).</p>
<p>In 6 months, the business grew, the data generated and analyzed grew, and so did the GuardDuty pricing.</p>
<p><img src="https://badshah.io/svg/loading.min.svg" data-src="guardduty-cost.png" data-srcset="/guardduty-good-bad-ugly/guardduty-cost.png, guardduty-cost.png 1.5x, /guardduty-good-bad-ugly/guardduty-cost.png 2x" data-sizes="auto" alt="/guardduty-good-bad-ugly/guardduty-cost.png" title="GuardDuty cost"/></p>
<p>This graph represents the cost of GuardDuty in a single AWS account over 6 months. More than 85% of the cost was because of S3 data events.</p>
<h3 id="conclusion">Conclusion</h3>
<p>AWS GuardDuty is an amazing service that intelligently detects different threats across important AWS services. It‚Äôs very easy to set up on single and multi-account environments doesn‚Äôt need any infra provisioning or existing infra changes, and integrates seamlessly with other AWS services.</p>
<p>While it‚Äôs great on some fronts, it has its fair share of issues - not very flexible, not foolproof, and can cost a bomb if the amount of logs generated or the number of resources increase over time.</p>
<p>GuardDuty (without S3 protection) has a huge bang for your buck. Adding S3 protection to the equation, in general, will have good coverage but comes with a cost.</p>
<p>Enough explanation so far. Now the important question - should you enable GuardDuty?</p>
<p>Here‚Äôs my recommendation:</p>
<p><em>Enable GuardDuty in all active regions across all accounts. <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_examples_aws_deny-requested-region.html" target="_blank" rel="noopener noreferrer">Disable access to services</a> in all non-active regions using SCPs. Enabling GuardDuty enables S3 protection by default. Disable the S3 protection in accounts that doesn‚Äôt contain business-critical data (like nonprod accounts). If you find S3 protection costs a lot in prod accounts during GuardDuty trial, disable S3 Protection and try to solve the issue from a different angle - maybe stringent S3 access policies, additional protection to sensitive S3 buckets, and more.</em></p>
<hr/>
<p>Please feel free to reach out to me on <a href="https://twitter.com/bnchandrapal" target="_blank" rel="noopener noreferrer">Twitter</a> or <a href="https://www.linkedin.com/in/bnchandrapal/" target="_blank" rel="noopener noreferrer">LinkedIn</a> if you have any queries. Follow me to get more insights on AWS security and other experiments.</p>
<p>If you have experimented with GuardDuty‚Äôs EKS and malware protection, I‚Äôd love to discuss it.</p></div></div>
  </body>
</html>
