<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://yurichev.org/clang/">Original</a>
    <h1>Clang is better than GCC</h1>
    
    <div id="readability-page-1" class="page">
<img src="https://x.od.ua/tracker/dot.php" referrerpolicy="unsafe-url"/>


<!-- blog post begin -->

<p>
Sorry for the provocative title, but I&#39;m too emotional these days.
</p>

<p>
This code:  
</p>

<pre>#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

struct tmp
{
  int x, y, z;
};

int main()
{
  struct tmp* m_result_original=NULL;
  struct tmp* m_result_my_version=NULL;

  // m_result_original=do_something_version_1();
  // m_result_my_version=do_something_version_2();

  if (memcmp(m_result_original, m_result_my_version, sizeof(struct tmp)!=0))
    {
      printf (&#34;Error - test failed!\n&#34;);
    };
};
</pre>

<p>
  There is an unnoticed typo. in memcmp().
  I wrote here:
</p>

<pre>  if (memcmp(m_result_original, m_result_my_version, sizeof(struct tmp)!=0))
</pre>

<p>
  But must be (note closing brackets at the end):
</p>

<pre>  if (memcmp(m_result_original, m_result_my_version, sizeof(struct tmp))!=0)
</pre>

<p>
  Yes, this is a problem of weak static typing of pure C.
  Pure C is a great tool for some jobs, but <i>here be dragons</i>, as they say.
</p>

<p>
  The problem is that <i>(sizeof(struct ...)!=0)==1</i>, so size=1 always for memcmp().
  Instead of comparing two <i>tmp</i>, my code compared only 1 byte of each structs.
</p>

<p>
  And GCC 9.4 was silent, even with <i>-Wall</i>, and so is G++.
  And MSVC 2017 is silent as well, with <i>/Owall</i>.
  But Clang 10 warns even without  <i>-Wall</i>:
</p>

<pre>2.c:17:72: warning: size argument in &#39;memcmp&#39; call is a comparison [-Wmemsize-comparison]
  if (memcmp(m_result_original, m_result_my_version, sizeof(struct tmp)!=0))
                                                     ~~~~~~~~~~~~~~~~~~^~~
2.c:17:7: note: did you mean to compare the result of &#39;memcmp&#39; instead?
  if (memcmp(m_result_original, m_result_my_version, sizeof(struct tmp)!=0))
      ^                                                                   ~
                                                                       )
2.c:17:54: note: explicitly cast the argument to size_t to silence this warning
  if (memcmp(m_result_original, m_result_my_version, sizeof(struct tmp)!=0))
                                                     ^
                                                     (size_t)(            )
1 warning generated.
</pre>

<p>
  Yes, venerable GCC is a very important and respected tool.
  And this is my bug, not GCC&#39;s flaw.
</p>

<p>
  But that bug in my code ruined one month of my work.
  I coded without realizing tests don&#39;t work at all.
  OUCH!
</p>

<p>
  I probably should have tried Clang at start.
  Or try several compilers in parallel, maybe?
  Or maybe I should stop using pure C...
</p>

<hr/>

<p>
<a href="https://lobste.rs/s/clibpz">Comments at lobste.rs</a>.
</p>

<!-- blog post end -->

<h6>(the post first published at 20221126.)</h6>

<p><img src="https://yurichev.org/dot.png?body_clang"/></p>

<!-- blog footer begin -->
<hr/>
<p>
<a href="https://yurichev.org/blog.html">List of my other blog posts.</a>
</p>

<p>
Yes, I know about these lousy Disqus ads.
Please use adblocker.
I would consider to subscribe to &#39;pro&#39; version of Disqus if the signal/noise ratio in comments would be good enough.
</p>





<!-- blog footer end -->




</div>
  </body>
</html>
