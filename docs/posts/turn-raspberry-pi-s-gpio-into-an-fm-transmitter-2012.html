<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://www.icrobotics.co.uk/wiki/index.php/Turning_the_Raspberry_Pi_Into_an_FM_Transmitter">Original</a>
    <h1>Turn Raspberry Pi’s GPIO into an FM Transmitter (2012)</h1>
    
    <div id="readability-page-1" class="page"><div id="mw-content-text" lang="en" dir="ltr">
<div>
<p><iframe src="http://www.youtube.com/embed/ekcdAX53-S8#!?showsearch=0&amp;modestbranding=1" width="425" height="319" frameborder="0" allowfullscreen="true"></iframe>
from a <a rel="nofollow" href="http://blog.makezine.com/2012/12/10/raspberry-pi-as-an-fm-transmitter/?parent=Electronics">post on MAKE</a> by Matt Richardson
</p>
</div>
<div id="toc"><p id="toctitle"><h2>Contents</h2></p>
<ul>
<li><a href="#Steps_to_play_sound:"><span>1</span> <span>Steps to play sound:</span></a></li>
<li><a href="#New.21_Now_with_stereo"><span>2</span> <span>New!  Now with stereo</span></a></li>
<li><a href="#How_to_change_the_broadcast_frequency"><span>3</span> <span>How to change the broadcast frequency</span></a></li>
<li><a href="#The_details_of_how_it_works"><span>4</span> <span>The details of how it works</span></a>
<ul>
<li><a href="#Accessing_Hardware"><span>4.1</span> <span>Accessing Hardware</span></a></li>
</ul>
</li>
</ul>
</div>

<h2><span id="Steps_to_play_sound:">Steps to play sound:</span></h2>
<p><small>(Created by Oliver Mattos and Oskar Weigl. Code is GPL)</small>
</p>
<pre>sudo python
&gt;&gt;&gt; import PiFm
&gt;&gt;&gt; PiFm.play_sound(&#34;sound.wav&#34;)
</pre>
<p>Download the module here:
</p>
<ul>
<li> [<a rel="nofollow" href="http://omattos.com/pifm.tar.gz">Download Now!</a>]
</li>
</ul>
<p>(this contains both source and a ready to go binary. Just run the above code in the same folder. The antenna is optional, but range is reduced from ~100 meters to ~10cm without the antenna. The sound file must be 16 bit mono wav format. )
</p>
<h2><span id="New.21_Now_with_stereo">New!  Now with stereo</span></h2>
<pre>sudo ./pifm left_right.wav 103.3 22050 stereo

# Example command lines
# play an MP3
ffmpeg -i input.mp3 -f s16le -ar 22.05k -ac 1 - | sudo ./pifm -

# Broadcast from a usb microphone (see arecord manual page for config)
arecord -d0 -c2 -f S16_LE -r 22050 -twav -D copy | sudo ./pifm -
</pre>
<h2><span id="How_to_change_the_broadcast_frequency">How to change the broadcast frequency</span></h2>
<p>Run the ./pifm binary with no command line arguments to find usage.
</p><p>The second command line argument is the frequency to transmit on, as a number in Mhz.  Eg. This will transmit on 100.0
</p>
<pre>sudo ./pifm sound.wav 100.0
</pre>
<p>It will work from about 1Mhz up to 250Mhz, although the useful FM band is 88 Mhz to 108 Mhz in most countries.
</p><p>Most radio receivers want a signal to be an odd multiple of 0.1 MHz to work properly.
</p>
<h2><span id="The_details_of_how_it_works">The details of how it works</span></h2>
<p>Below is some code that was hacked together over a few hours at the <a rel="nofollow" href="http://blog.codeclub.org.uk/blog/brief/">Code Club pihack</a>. It uses the hardware on the raspberry pi that is actually meant to generate spread-spectrum clock signals on the GPIO pins to output FM Radio energy. This means that all you need to do to turn the Raspberry-Pi into a (ridiculously powerful) FM Transmitter is to plug in a wire as the antenna (as little as 20cm will do) into GPIO pin 4 and run the code posted below. It transmits on 100.0 MHz.
</p><p>When testing, the signal only started to break up after we went through several conference rooms with heavy walls, at least 50m away, and crouched behind a heavy metal cabinet. The sound quality is ok, but not amazing, as it currently plays some clicks when the CPU gets switched away to do anything else than play the music. The plan was to make a kernel mode driver that would be able to use the <strike>DMA controller to offload the CPU and play smooth music without loading the CPU, but we ran out of time.</strike> Now Done and working, DMA from userspace is awesome and awful at the same time!
</p><p><strike>If you&#39;re v. smart, you might be able to get stereo going!</strike> Done! 
</p>
<h3><span id="Accessing_Hardware">Accessing Hardware</span></h3>
<p>The python library calls a C program (provided both precompiled and in source form).  The C program maps the Peripheral Bus (0x20000000) in physical memory into virtual address space using /dev/mem and mmap.  To do this it needs root access, hence the sudo.  Next it sets the clock generator module to enabled and sets it to output on GPIO4 (no other accessible pins can be used).  It also sets the frequency to 100.0Mhz (provided from PLLD@500Mhz, divided by 5), which provides a carrier.  At this point, radios will stop making a &#34;fuzz&#34; noise, and become silent.
</p><p>Modulation is done by adjusting the frequency using the fractional divider between 100.025Mhz and 99.975Mhz, which makes the audio signal.  <strike> The fractional divider doesn&#39;t have enough resolution to produce more than ~6 bit audio, but since the PI is very fast, we can do oversampling to provide about 9.5 bit audio by using 128 subsamples per real audio sample.</strike>  We were being naieve with our subsampling algorithm - you can now get full 16 bit quality sound, and it even does FM pre-emphasis so that the result doesn&#39;t sound bass-heavy.
</p>
<!-- 
NewPP limit report
CPU time usage: 0.020 seconds
Real time usage: 0.034 seconds
Preprocessor visited node count: 26/1000000
Preprocessor generated node count: 50/1000000
Post‐expand include size: 35/2097152 bytes
Template argument size: 0/2097152 bytes
Highest expansion depth: 2/40
Expensive parser function count: 0/100
-->

<!-- Saved in parser cache with key rcc_icrobotics-icrs_wiki_:pcache:idhash:802-0!*!*!!en!*!* and timestamp 20221112032135 and revision id 6284
 -->
</div></div>
  </body>
</html>
