<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://op-co.de/blog/posts/grub2_bios_bootloop/">Original</a>
    <h1>Backward-incompatible GRUB2 change causing BIOS setup bootloop</h1>
    
    <div id="readability-page-1" class="page"><div class="page">









<div id="pagebody">

<div id="content" role="main">
<p><span>Georg Lukas, <span>2024-12-16 18:06</span></span></p>
<p>Exactly one year ago, after updating a bunch of Debian packages, my laptop stopped booting Linux. Instead, it briefly showed the GRUB banner, then rebooted into the BIOS setup. On every startup. Reproducibly. Last Friday 13th, I was bitten by this bug again, on a machine running Kali Linux, and had to spend an extra hour at work to fix it.</p>

<p><strong>TL;DR:</strong> the GRUB config got extended with a call to <code>fwsetup --is-supported</code>. Older GRUB binaries don&#39;t know the parameter and will just reboot into the BIOS setup instead. Oops!</p>

<p><img src="https://op-co.de/blog/posts/grub2_bios_bootloop/og.png" alt="Screenshots of GRUB2 and BIOS setup overlaid with a red double-arrow"/></p>




<h2><a name="index1h2"></a>The analysis</h2>

<p>Of course, I didn&#39;t know the root cause yet, and it took me two hours to isolate
the problem and some more time to identify the root cause. This post documents
the steps of the <del>systematic analyis approach</del> f*cking around and
finding out phase, in the hope that it might help future you and me.</p>

<p>Booting my Debian via UEFI or from the SSD&#39;s &#34;legacy&#34; boot sector reproducibly
crashed into BIOS setup. Upgrading the BIOS didn&#39;t improve the situation.</p>

<p>Starting the Debian 12 recovery worked, however.
Manually typing the <code>linux /boot/vmlinux-something root=UUID=long-hex-number</code>
and <code>initrd /boot/initrd-same-something</code> and <code>boot</code> commands from the Debian 12
GRUB also brought me back into &#34;my&#34; Linux.</p>

<p>Running <code>update-grub</code> and <code>grub-install</code> from there, in order to fix my GRUB, had no positive effect.</p>

<p>The installed GRUB wasn&#39;t displaying anything, so I used the recovery to
disable gfx mode in GRUB. It still crashed, but there was a brief flash of some
text output. Reading it required a camera, as it disappeared after half a
second:</p>

<pre><code>   bli.mod not found
</code></pre>

<p>A relevant error or a red herring? Googling it didn&#39;t yield anything back in 2023, but it was indeed <a href="https://github.com/fedora-silverblue/issue-tracker/issues/587">another symptom of the same issue</a>.</p>

<p>Another, probably much more significant finding was that merely loading my installation&#39;s <code>grub.cfg</code> from the Debian 12 installer&#39;s GRUB also crashed into the BIOS. So there was something wrong with the GRUB config after all.</p>

<p>Countless config changes and reboots later, the problem was bisected to the rather new &#34;UEFI Firmware Settings&#34; menu item. In retrospect, it&#39;s quite obvious that the enter setup menu will enter setup, except that... I wasn&#39;t selecting it.</p>

<p>But the config file ran <code>fwsetup --is-supported</code> in order to check whether to even display the new menu item. Quite sensible, isn&#39;t it?</p>

<p>Manually running <code>fwsetup --is-supported</code> from my installed GRUB or from the Debian installer... crashed into the BIOS setup! The obvious conclusion was that the new feature somehow had a bug or triggered a bug in the laptop&#39;s UEFI firmware.</p>

<p>But given that I was pretty late to the GRUB update, and I was running on a quite common Lenovo device, there should have been hundreds of users complaining about their Debian falling apart. And there were none. So it was something unique to my setup after all?</p>

<h2><a name="index2h2"></a>The code change</h2>

<p>The &#34;UEFI Firmware Settings&#34; menu used to be unconditional on EFI systems. But then, somebody complained, and a <a href="http://git.savannah.gnu.org/cgit/grub.git/commit/?id=26031d3b101648352e4e427f04bf69d320088e77">small pre-check was added to <code>grub_cmd_fwsetup()</code> in the <code>efifwsetup</code> module in 2022</a>:</p>

<div><pre><span>if</span> <span>(</span>argc <span>&gt;=</span> <span>1</span> <span>&amp;&amp;</span> <span>grub_strcmp</span><span>(</span>args<span>[</span><span>0</span><span>],</span> <span>&#34;--is-supported&#34;</span><span>) ==</span> <span>0</span><span>)</span>
    <span>return</span> <span>!</span><span>efifwsetup_is_supported</span> <span>();</span>
</pre></div>


<p>If the argument is passed, the module will check for support and return 0 or 1. If it&#39;s not passed, the code will fall through to resetting the system into BIOS setup.</p>

<p>No further argument checks exist in the module.</p>

<p>Before this addition, there were no checks for module arguments. None at all.
Calling the pervious version of the module with <code>--is-supported</code> wouldn&#39;t check
for support. It wouldn&#39;t abort with an unsupported argument error. It would do
what the <code>fwsetup</code> call would do without arguments. It would reboot into the
BIOS setup. This is where I opened
<a href="https://bugs-devel.debian.org/cgi-bin/bugreport.cgi?bug=1058818">Debian bug #1058818</a>,
deleted the whole <code>/etc/grub.d/30_uefi-firmware</code> file and moved on.</p>

<h2><a name="index3h2"></a>The root cause</h2>

<p>The Debian 12 installer quite obviously had the old version of the module. My laptop, for some weird (specific to me) reason, also had the old module.</p>

<p>The relevant file, <code>/boot/grub/x86_64-efi/efifwsetup.mod</code> is not part of any Debian package, but there exists another copy that&#39;s normally distributed as part of the  <code>grub-efi-amd64-bin</code> package, and gets installed to <code>/boot/grub/</code> by <code>grub-install</code>:</p>

<pre><code>   grub-efi-amd64-bin: /usr/lib/grub/x86_64-efi/efifwsetup.mod
</code></pre>

<p>My laptop had the file, but didn&#39;t have this package installed. This was caused by installing Debian, then restoring a full backup from the old laptop, which didn&#39;t use EFI yet, over the root filesystem.</p>

<p>The old system had the <code>grub-pc</code> package which satisfies the dependencies but only had the files to install GRUB into the [MBR] (https://en.wikipedia.org/wiki/Master_boot_record).</p>

<p><code>grub-install</code> correctly identified the system as EFI, and copied the stale(!) modules from <code>/usr/lib/grub/x86_64-efi/</code> to <code>/boot/grub/</code>. This had been working for two years, until Debian integrated the breaking change into the config and into the not installed <code>grub-efi-amd64-bin</code> package, and I upgraded GRUB2 from 2.04-1 to 2.12~rc1-12.</p>

<p>Simply installing <code>grub-efi-amd64-bin</code> properly resolved the issue for me, until
one year later.</p>

<h2><a name="index4h2"></a>The Kali machine</h2>

<p>Last Friday (Friday the 13th), I was preparing a headless pentest box for a
weekend run on a slow network, and it refused to boot up. After attaching a
HDMI-to-USB grabber I was greeted with this unwelcoming screen:</p>

<p><img src="https://op-co.de/blog/posts/grub2_bios_bootloop/grub.png" alt="Screenshots of GRUB2 shell from Kali"/></p>

<p>Manually loading the <code>grub.cfg</code> restarted the box into UEFI setup. Now this is
something I know from last year! Let&#39;s kickstart recovery and check the GRUB2 install:</p>

<pre><code>┌──(root㉿pentest-mobil)-[~]
└─# dpkg -l | grep grub
ii  grub-common               2.12-5+kali1   amd64   GRand Unified Bootloader (common files)
ii  grub-efi                  2.12-5+kali1   amd64   GRand Unified Bootloader, version 2 (dummy package)
ii  grub-efi-amd64            2.12-5+kali1   amd64   GRand Unified Bootloader, version 2 (EFI-AMD64 version)
ii  grub-efi-amd64-bin        2.12-5+kali1   amd64   GRand Unified Bootloader, version 2 (EFI-AMD64 modules)
ii  grub-efi-amd64-unsigned   2.12-5+kali1   amd64   GRand Unified Bootloader, version 2 (EFI-AMD64 images)
ii  grub2-common              2.12-5+kali1   amd64   GRand Unified Bootloader (common files for version 2)

┌──(root㉿pentest-mobil)-[~]
└─# grub-install
Installing for x86_64-efi platform.
Installation finished. No error reported.

┌──(root㉿pentest-mobil)-[~]
└─# 
</code></pre>

<p>That looks like it should be working. Why isn&#39;t it?</p>

<pre><code>┌──(root㉿pentest-mobil)-[~]
└─# ls -al /boot/efi/EFI 
total 16
drwx------ 4 root root 4096 Dec 13 17:11 .
drwx------ 3 root root 4096 Jan  1  1970 ..
drwx------ 2 root root 4096 Sep 12  2023 debian
drwx------ 2 root root 4096 Nov  4 12:53 kali
</code></pre>

<p>Oh no! This also used to be a Debian box before, but the rootfs got properly
formatted when moving to Kali. The whole rootfs? Yes! But the EFI files are on
a separate partition!</p>

<p>Apparently, the UEFI firmware is still starting the <code>grubx64.efi</code> file from
Debian, which comes with a <code>grub.cfg</code> that will bootstrap the config from
<code>/boot/</code> and that... will run <code>fwsetup --is-supported</code>. BOOM!</p>

<p>Renaming the <code>debian</code> folder into something that comes after <code>kali</code> in the
alphabet finally allowed me to call it a day.</p>

<h2><a name="index5h2"></a>The conclusion</h2>

<p>When adding a feature that is spread over multiple places, it is very important
to consider the potential side-effects. Not only of what the new feature adds,
but also what a partial change can cause. This is especially true for complex
software like GRUB2, that comes with different targeted installation pathways
and is spread over a bunch of packages.</p>

<hr/>

<p><em><a href="https://news.ycombinator.com/item?id=42432979">Comments on HN</a></em></p>

<p><em><a href="https://chaos.social/@ge0rg/113663603716943232">Comments on Mastodon</a></em></p>

</div>









</div>



</div></div>
  </body>
</html>
