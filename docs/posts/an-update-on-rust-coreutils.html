<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://sylvestre.ledru.info/blog/2022/01/29/an-update-on-rust-coreutils">Original</a>
    <h1>An update on rust/coreutils</h1>
    
    <div id="readability-page-1" class="page"><div><div><div><p>TLDR: we are making progress on the Rust implementation of the GNU coreutils.</p>
<p>Well, it is an understatement to say <a href="https://sylvestre.ledru.info/blog/2021/03/09/debian-running-on-rust-coreutils">my previous blog post</a> interested many people. Many articles, blog posts and some podcasts talked about it! As we pushed <a href="https://crates.io/crates/coreutils">coreutils 0.0.12</a> a few days ago and getting closer to the 10 000 stars on github, it is now time to give an update!</p>
<p>This has brought a lot of new contributors to this project. Instead of 30 to 60 patches per month, we jumped to 400 to 472 patches every month. Similarly, we saw an increase in the number of contributors (20 to 50 per month from 3 to 8). Two new maintainers (Michael Debertol &amp; Terts Diepraam) stepped in and have been doing a much better job than myself as reviewers now! As a silly metric, according to github, we had <span>5 561 clones of the repository over the last 2 weeks!</span></p>
<p>The new contributors focused on:</p>
<ul>
<li>Performances. Now, some binaries are significantly faster than GNU (ex: <a href="https://github.com/uutils/coreutils/pull/2712#issuecomment-946264620">head</a>, <a href="https://github.com/uutils/coreutils/pull/2111#issue-622623570">cut</a>, etc)</li>
<li>Adding missing binaries or options (see below)</li>
<li>Improve the testsuite: we grew the overall code coverage <a href="https://app.codecov.io/gh/uutils/coreutils">from 55% to 75%</a> (in general, we consider that a 80% code coverage on a project is excellent).</li>
<li><p>Refactoring the code to simplify the maintenance. Examples:</p>
<ul>
<li>Using the same code for <a href="https://github.com/uutils/coreutils/pull/2570">permissions for chgrp and chown</a></li>
<li>Managing error the same way in the various binaries - (Kudos to Jeffrey Finkelstein for the huge work)</li>
<li>Improving the GNU compatibility (thanks to Jan Verbeek, <span><span>Jan Scheer, </span></span><span>kimono-koans </span> and many others)</li>
<li><a href="https://github.com/uutils/coreutils/commit/55a47f6fc0363b314c5ba41e44fb27a2f5a69031">Move to</a> <a href="https://epage.github.io/blog/2021/12/clap3/">clap 3</a>. Upgrade by Terts which unblocks us on various problems.</li>
</ul>
</li>
<li>...</li>
</ul>
<p><strong>Closing the gap with GNU</strong></p>
<p>As far as I know, we are only missing <code>stty (change and print terminal line settings)</code> as a program.</p>
<p>Thanks to some heroes, <a href="https://github.com/uutils/coreutils/pull/2547">basenc</a>, <a href="https://github.com/uutils/coreutils/pull/2300">pr</a>, <a href="https://github.com/uutils/coreutils/pull/2075">chcon</a> and <a href="https://github.com/uutils/coreutils/pull/2574">runcon</a> have been implemented. For example, for the two last programs, Koutheir Attouchi wrote new crates to <a href="https://crates.io/crates/selinux">manage SELinux properly</a>. This crate has been used for some other utilities like cp, ls or id.</p>
<p><strong>Leveraging the GNU testsuite to test this implementation</strong></p>
<p>Because the GNU testsuite is excellent, we now have a proper CI using it to run the tests. It is pretty long on the Github action CI (almost two hours to run it) but it is an amazing improvement to the way we work. It was a joint work from a bunch of folks (James Robson, Roy Ivy III, etc). To achieve this, we also made it easier to run the GNU testsuite locally with the Rust implementation but also to ignore some tests or adjust some error messages (see <a href="https://github.com/uutils/coreutils/blob/master/util/build-gnu.sh">build-gnu.sh</a> and <a href="https://github.com/uutils/coreutils/blob/master/util/run-gnu-test.sh">run-gnu-test.sh</a>).</p>
<p>Following a suggestion of Brian G, a colleague at Mozilla (he did the same for some Firefox major change), we are now collecting the history of fail/pass/error <a href="https://github.com/uutils/coreutils-tracking">into a separate repository</a> and generating a daily graph showing the evolution of regression. <img src="https://github.com/uutils/coreutils-tracking/raw/main/gnu-results.png?raw=true" alt="Evolution over time"/> At this date, we have, with GNU/Coreutils 9.0:</p>
<table>
<tbody>
<tr>
<td>Total</td>
<td>611 tests</td>
</tr>
<tr>
<td>Pass</td>
<td>214</td>
</tr>
<tr>
<td>Skip</td>
<td>84</td>
</tr>
<tr>
<td>Fail</td>
<td>298</td>
</tr>
<tr>
<td>Error</td>
<td>15</td>
</tr>
</tbody>
</table>
<p>We are now automatically identifying new passing tests and regressions in the CI.</p>
<p>For example: <code><br/>
</code></p>
<p><code>Warning: Congrats! The gnu test tests/chmod/c-option is now passing!</code></p>

<p>This is also <span>beneficial</span> to GNU as, by implementing some options, Michael Debertol noticed some incorrect behaviors (<a href="https://debbugs.gnu.org/cgi/bugreport.cgi?bug=49239">with sort</a> and <a href="https://debbugs.gnu.org/cgi/bugreport.cgi?bug=49925">cat</a>) or an uninitialized variable (with <a href="https://debbugs.gnu.org/cgi/bugreport.cgi?bug=50070">chmod</a>).</p>
<p><strong> Documentations</strong></p>
<p>Every day, we are generating the user documentation and of the internal coreutils.</p>
<p>User documentation: <a href="https://uutils.github.io/coreutils-docs/user/">https://uutils.github.io/coreutils-docs/user/</a> Example: <a href="https://uutils.github.io/coreutils-docs/user/utils/ls.html">ls</a> or <a href="https://uutils.github.io/coreutils-docs/user/utils/cp.html">cp</a></p>
<p>The internal documentation can be seen on:<a href="https://uutils.github.io/coreutils-docs/dev/uucore/index.html"> </a><a href="https://uutils.github.io/coreutils-docs/dev/uucore/"></a><a href="https://uutils.github.io/coreutils-docs/dev/uucore/">https://uutils.github.io/coreutils-docs/dev/uucore/</a> </p>
<p><strong>More?</strong></p>
<p>Besides my work on Debian/Ubuntu, I have also noticed that more and more operating systems are starting to look at this:</p>
<ul>
<li>Brew is proposing coreutils (with the latest version) <a href="https://github.com/Homebrew/homebrew-core/pull/93404 ">https://github.com/Homebrew/homebrew-core/pull/93404 </a></li>
<li>Sandro is working to be able to run NixOS on Rust/Coreutils. See <a href="https://github.com/NixOS/nixpkgs/pull/116274">https://github.com/NixOS/nixpkgs/pull/116274</a> for the interesting discussions there.</li>
<li>Apertis (Linux distro for the automotive industry) has forked my Debian patches to make it the default coreutils <a href="https://gitlab.apertis.org/pkg/rust-coreutils/-/tree/apertis/v2023dev1/debian">https://gitlab.apertis.org/pkg/rust-coreutils/-/tree/apertis/v2023dev1/debian </a></li>
<li>I also noticed an <a href="https://github.com/uutils/coreutils/pull/2550">interest from Redox OS</a>.</li>
</ul>
<p>In parallel, <a href="https://github.com/uutils/findutils/">https://github.com/uutils/findutils/,</a> a rust dropped-in replacement for find, is getting more attention lately! Here, the graph showing the evolution of the program using the <a href="https://github.com/tavianator/bfs.git">BFS testsuite</a> (much better than GNU&#39;s).</p>
<p><img src="https://github.com/uutils/findutils-tracking/raw/main/bfs-results.png?raw=true" alt="Evolution over time - BFS testsuite"/></p>
<p><strong>What is next?</strong></p>
<ol>
<li>stty needs to be implemented</li>
<li>Improve the GNU compatibility on key programs and reduce the gap</li>
<li>Investigate how to reduce the size of the binaries</li>
<li>Allow Debian and Ubuntu to switch by default without tricky manipulation</li>
</ol>
<p><strong>How to help?</strong></p>
<p>I have been maintaining a l<a href="https://github.com/uutils/coreutils/issues?q=is%3Aissue+is%3Aopen+label%3A%22good+first+issue%22">ist of good first bugs</a> for new comers in the repo!</p>
<p>Don&#39;t hesitate to contribute, it is much easier than it seems and a terrific way to learn Rust!</p>
</div></div></div></div>
  </body>
</html>
