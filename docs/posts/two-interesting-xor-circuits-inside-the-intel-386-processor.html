<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.righto.com/2023/12/386-xor-circuits.html">Original</a>
    <h1>Two interesting XOR circuits inside the Intel 386 processor</h1>
    
    <div id="readability-page-1" class="page"><div id="post-body-8647315208322441005" itemprop="description articleBody">
<p>Intel&#39;s 386 processor (1985) was an important advance in the x86 architecture, not only moving to a 32-bit processor but also switching to a CMOS implementation.
I&#39;ve been reverse-engineering parts of the 386 chip and came across two interesting and completely different
circuits that the 386 uses to implement an XOR gate: one uses standard-cell logic while the other uses pass-transistor logic.
In this article, I take a look at those circuits.</p>
<p><a href="https://static.righto.com/images/386-xor/386-die-labeled.jpg"><img alt="The die of the 386. Click this image (or any other) for a larger version." height="640" src="https://static.righto.com/images/386-xor/386-die-labeled-w600.jpg" title="The die of the 386. Click this image (or any other) for a larger version." width="600"/></a></p><p>The die of the 386. Click this image (or any other) for a larger version.</p>
<p>The die photo above shows the two metal layers of the 386 die. The polysilicon and silicon layers underneath
are mostly hidden by the metal.
The black dots around the edges are the bond wires connecting the die to the external pins.
The 386 is a complicated chip with 285,000 transistor sites. I&#39;ve labeled the main functional blocks.
The datapath in the lower left does the actual computations, controlled by the microcode ROM in the lower right.</p>
<p>Despite the complexity of the 386, if you zoom in enough, you can see individual XOR gates.
The red rectangle at the top (below) is a shift register for the chip&#39;s self-test. Zooming in again shows the silicon for an XOR gate
implemented with pass transistors.
The purple outlines reveal active silicon regions, while the stripes are transistor gates.
The yellow rectangle zooms in on part of the standard-cell logic that controls the prefetch queue.
The closeup shows the silicon for an XOR gate implemented with two logic gates.
Counting the stripes shows that the first XOR gate is implemented with 8 transistors while the second uses 10 transistors. I&#39;ll explain below how these transistors are connected to form the XOR gates.</p>
<p><a href="https://static.righto.com/images/386-xor/die-zoom.jpg"><img alt="The die of the 386, zooming in on two XOR gates." height="489" src="https://static.righto.com/images/386-xor/die-zoom-w600.jpg" title="The die of the 386, zooming in on two XOR gates." width="600"/></a></p><p>The die of the 386, zooming in on two XOR gates.</p>
<h2>A brief introduction to CMOS</h2>
<p>CMOS circuits are used in almost all modern processors.
These circuits are built from two types of transistors: NMOS and PMOS.
These transistors can be viewed as switches between the <em>source</em> and <em>drain</em> controlled by the <em>gate</em>.
A high voltage on the gate of an NMOS transistor turns the transistor on, while a low voltage on the gate of
a PMOS transistor turns the transistor on.
An NMOS transistor is good at pulling the output low, while a PMOS transistor is good at pulling the output high.
Thus, NMOS and PMOS transistors are opposites in many ways; they are <em>complementary</em>, which is the &#34;C&#34; in CMOS.</p>
<p><a href="https://static.righto.com/images/386-xor/mosfet.jpg"><img alt="Structure of a MOS transistor. Although the transistor&#39;s name represents the Metal-Oxide-Semiconductor layers, modern MOS transistors typically use polysilicon instead of metal for the gate." height="207" src="https://static.righto.com/images/386-xor/mosfet-w400.jpg" title="Structure of a MOS transistor. Although the transistor&#39;s name represents the Metal-Oxide-Semiconductor layers, modern MOS transistors typically use polysilicon instead of metal for the gate." width="400"/></a></p><p>Structure of a MOS transistor. Although the transistor&#39;s name represents the Metal-Oxide-Semiconductor layers, modern MOS transistors typically use polysilicon instead of metal for the gate.</p>
<p>In a CMOS circuit, the NMOS and PMOS transistors work together, with the NMOS transistors pulling the output low
as needed while the PMOS transistors pull the output high.
By arranging the transistors in different ways, different logic gates can be created.
The diagram below shows a NAND gate constructed from two PMOS transistors (top) and two NMOS transistors (bottom).
If both inputs are high, the NMOS transistors turn on and pull the output low. But if either input is low, a PMOS transistor
will pull the output high. Thus, the circuit below implements a NAND gate.</p>
<p><a href="https://static.righto.com/images/386-xor/nand.png"><img alt="A NAND gate implemented in CMOS." height="177" src="https://static.righto.com/images/386-xor/nand-w160.png" title="A NAND gate implemented in CMOS." width="160"/></a></p><p>A NAND gate implemented in CMOS.</p>
<p>Notice that NMOS and PMOS transistors have an inherent inversion: a high input produces a low (for NMOS) or a low input produces a high (for PMOS).
Thus, it is straightforward to produce logic circuits such as an inverter, NAND gate, NOR gate,
or an AND-OR-INVERT gate.
However, producing an XOR (exclusive-or) gate doesn&#39;t work with this approach:
an XOR gate produces a 1 if either input is high, but not both.<span id="fnref:and"><a href="#fn:and">1</a></span>
The XNOR (exclusive-NOR) gate, the complement of XOR, also has this problem.
As a result, chips often have creative implementations of XOR gates.</p>
<h2>The standard-cell two-gate XOR circuit</h2>
<p>Parts of the 386 were implemented with standard-cell logic.
The idea of standard-cell logic is to build circuitry out of standardized building blocks that can be wired
by a computer program.
In earlier processors such as the 8086, each transistor was carefully positioned by hand to create a chip layout
that was as dense as possible.
This was a tedious, error-prone process since the transistors were fit together like puzzle pieces.
Standard-cell logic is more like building with LEGO. Each gate is implemented as a standardized block and the blocks are arranged
in rows, as shown below.
The space between the rows holds the wiring that connects the blocks.</p>
<p><a href="https://static.righto.com/images/386-xor/standard-cell.jpg"><img alt="Some rows of standard-cell logic in the 386 processor. This is part of the segment descriptor control circuitry." height="410" src="https://static.righto.com/images/386-xor/standard-cell-w500.jpg" title="Some rows of standard-cell logic in the 386 processor. This is part of the segment descriptor control circuitry." width="500"/></a></p><p>Some rows of standard-cell logic in the 386 processor. This is part of the segment descriptor control circuitry.</p>
<p>The advantage of standard-cell logic is that it is much faster to create a design since the process can be
automated.
The engineer described the circuit in terms of the logic gates and their connections.
A computer algorithm placed the blocks so related blocks are near each other.
An algorithm then routed the circuit, creating the wiring between the blocks.
These &#34;place and route&#34; algorithms are challenging since it is an extremely difficult optimization problem,
determining the best locations for the blocks and how to pack the wiring as densely as possible.
At the time, the algorithm took a day on a powerful IBM mainframe to compute the layout.
Nonetheless, the automated process was much faster than manual layout, cutting weeks off the development
time for the 386.
The downside is that the automated layout is less dense than manually optimized layout, with a lot more wasted
space. 
(As you can see in the photo above, the density is low in the wiring channels.)
For this reason, the 386 used manual layout for circuits where a dense layout was important, such as the datapath.</p>
<p>In the 386, the standard-cell XOR gate is built by combining a NOR gate with an AND-NOR gate as shown below.<span id="fnref:xnor"><a href="#fn:xnor">2</a></span>
(Although AND-NOR looks complicated, it is implemented as a single gate in CMOS.)
You can verify that if both inputs are 0, the NOR gate forces the output low, while if both inputs are 1, the AND gate forces the output low, providing the XOR functionality.</p>
<p><a href="https://static.righto.com/images/386-xor/xor-schematic.png"><img alt="Schematic of an XOR circuit." height="157" src="https://static.righto.com/images/386-xor/xor-schematic-w300.png" title="Schematic of an XOR circuit." width="300"/></a></p><p>Schematic of an XOR circuit.</p>
<p>The photo below shows the layout of this XOR gate as a standard cell.
I have removed the metal and polysilicon layers to show the underlying silicon. The outlined regions are the
active silicon, with PMOS above and NMOS below. The stripes are the transistor gates, normally covered by polysilicon wires.
Notice that neighboring transistors are connected by shared silicon; there is no demarcation between the source
of one transistor and the drain of the next.</p>
<p><a href="https://static.righto.com/images/386-xor/xor-cell.jpg"><img alt="The silicon implementing the XOR standard cell. This image is rotated 180° from the layout on the die to put PMOS at the top." height="270" src="https://static.righto.com/images/386-xor/xor-cell-w300.jpg" title="The silicon implementing the XOR standard cell. This image is rotated 180° from the layout on the die to put PMOS at the top." width="300"/></a></p><p>The silicon implementing the XOR standard cell. This image is rotated 180° from the layout on the die to put PMOS at the top.</p>
<p>The schematic below corresponds to the silicon above. Transistors <em>a</em>, <em>b</em>, <em>c</em>, and <em>d</em> implement the first
NOR gate. Transistors <em>g</em>, <em>h</em>, <em>i</em>, and <em>j</em> implement the AND part of the AND-NOR gate.
Transistors <em>e</em> and <em>f</em>
implement the NOR input of the AND-NOR gate, fed from the first NOR gate.
The standard cell library is designed so all the cells are the same height
with a power rail at the top and a ground rail at the bottom. This allows the cells to &#34;snap together&#34; in rows.
The wiring inside the cell is implemented in polysilicon and the lower metal layer (M1), while the wiring between
cells uses the upper metal layer (M2) for vertical connections and lower metal (M1) for horizontal connections.
This strategy allows vertical wires to pass over the cells without interfering with the cell&#39;s wiring.</p>
<p><a href="https://static.righto.com/images/386-xor/xor-cell-schematic.png"><img alt="Transistor layout in the XOR standard cell." height="186" src="https://static.righto.com/images/386-xor/xor-cell-schematic-w500.png" title="Transistor layout in the XOR standard cell." width="500"/></a></p><p>Transistor layout in the XOR standard cell.</p>
<p>One important factor in a chip such as the 386 is optimizing the sizes of transistors.
If a transistor is too small, it will take too much time to switch its output line, reducing performance.
But if a transistor is too large, it will waste power as well as slowing down the circuit that is driving it.
Thus, the standard-cell library for the 386 includes several XOR gates of various sizes.
The diagram below shows a considerably larger XOR standard cell. The cell is the same height as the previous XOR
(as required by the standard cell layout), but it is much wider and the transistors inside the cell are taller.
Moreover, the PMOS side uses pairs
of transistors to double the current capacity. (NMOS has better performance than PMOS so doesn&#39;t require
doubling of the transistors.) Thus, there are 10 PMOS transistors and 5 NMOS transistors in this XOR cell.</p>
<p><a href="https://static.righto.com/images/386-xor/large-xor-cell.jpg"><img alt="A large XOR standard cell. This cell is also rotated from the die layout." height="232" src="https://static.righto.com/images/386-xor/large-xor-cell-w400.jpg" title="A large XOR standard cell. This cell is also rotated from the die layout." width="400"/></a></p><p>A large XOR standard cell. This cell is also rotated from the die layout.</p>
<h2>The pass transistor circuit</h2>
<p>Some parts of the 386 implement XOR gates completely differently, using <a href="https://en.wikipedia.org/wiki/Pass_transistor_logic">pass transistor logic</a>.
The idea of pass transistor logic is to use transistors as switches that pass inputs through to the output,
rather than using transistors as switches to pull the output high or low.
The pass transistor XOR circuit uses 8 transistors, compared with 10 for the previous circuit.<span id="fnref:advantages"><a href="#fn:advantages">3</a></span></p>
<p>The die photo below shows a pass-transistor XOR circuit, highlighted in red.
Note that the surrounding circuitry is irregular and much more tightly packed than the standard-cell circuitry.
This circuit was laid out manually producing an optimized layout compared to standard cells.
It has four PMOS transistors at the top and four NMOS transistors at the bottom.</p>
<p><a href="https://static.righto.com/images/386-xor/xor-pass-die.jpg"><img alt="The pass-transistor XOR circuit on the die. The green regions are oxide that was not completely removed causing thin-film interference." height="376" src="https://static.righto.com/images/386-xor/xor-pass-die-w500.jpg" title="The pass-transistor XOR circuit on the die. The green regions are oxide that was not completely removed causing thin-film interference." width="500"/></a></p><p>The pass-transistor XOR circuit on the die. The green regions are oxide that was not completely removed causing thin-film interference.</p>
<p>The schematic below shows the heart of the circuit, computing the exclusive-NOR (XNOR) of X and Y with four pass transistors.
To understand the circuit, consider the four input cases for X and Y.
If X and Y are both 0, PMOS transistor <em>a</em> will turn on (because Y is low), passing 1
to the XNOR output.
(<span>X</span> is the complemented value of the X input.)
If X and Y are both 1, PMOS transistor <em>b</em> will turn on (because
<span>X</span>
 is low), passing 1.
If X and Y are 1 and 0 respectively, NMOS transistor <em>c</em> will turn on (because X is high), passing 0.
If X and Y are 0 and 1 respectively, transistor <em>d</em> will turn on (because Y is high), passing 0.
Thus, the four transistors implement the XNOR function, with a 1 output if both inputs are the same.</p>
<p><a href="https://static.righto.com/images/386-xor/xnor-pass.png"><img alt="Partial implementation of XNOR with four pass transistors." height="198" src="https://static.righto.com/images/386-xor/xnor-pass-w300.png" title="Partial implementation of XNOR with four pass transistors." width="300"/></a></p><p>Partial implementation of XNOR with four pass transistors.</p>
<p>To make an XOR gate out of this requires two additional inverters.
The first inverter produces <span>X</span> from X.
The second inverter generates the XOR output by inverting the XNOR output.
The output inverter also has the important function of
buffering the output since the pass transistor output is weaker than the inputs.
Since each inverter takes two transistors, the complete XOR circuit uses 8 transistors.
The schematic below shows the full circuit. The <em>i1</em> transistors implement the input inverter and the <em>i2</em>
transistors implement the output inverter.
The layout of this schematic matches the earlier die photo.<span id="fnref:alternatives"><a href="#fn:alternatives">5</a></span></p>
<p><a href="https://static.righto.com/images/386-xor/xor-pass.png"><img alt="Implementation of NOR with eight pass transistors." height="197" src="https://static.righto.com/images/386-xor/xor-pass-w500.png" title="Implementation of NOR with eight pass transistors." width="500"/></a></p><p>Implementation of NOR with eight pass transistors.</p>
<h2>Conclusions</h2>
<p>An XOR gate may seem like a trivial circuit, but there is more going on than you might expect.
I think it is interesting that there isn&#39;t a single solution for implementing XOR; even inside a
single chip, multiple approaches can be used.
(If you&#39;re interested in XOR circuits, I also looked at the <a href="https://www.righto.com/2013/09/understanding-z-80-processor-one-gate.html">XOR circuit in the Z80</a>.)
It&#39;s also reassuring to see that even for a complex chip such as the 386, the circuitry can be broken down into
logic gates and then understood at the transistor level.</p>
<p>I plan to write more about the 386, so 
follow me on Twitter <a href="https://twitter.com/kenshirriff">@kenshirriff</a> or <a href="https://www.righto.com/feeds/posts/default">RSS</a> for updates.
I&#39;m also on Mastodon occasionally as <a href="https://oldbytes.space/@kenshirriff">@<span data-cfemail="5d3638332e35342f2f343b3b1d3231393f2429382e732e2d3c3e38">[email protected]</span></a>.</p>
<h2>Notes and references</h2>


</div></div>
  </body>
</html>
