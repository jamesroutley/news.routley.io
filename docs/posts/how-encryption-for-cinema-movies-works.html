<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://serverless.industries/2024/05/31/digital-cinema.en.html">Original</a>
    <h1>How encryption for Cinema Movies works</h1>
    
    <div id="readability-page-1" class="page"><div>
        <p>The Cinema Industry is using its own standards for creating and distributing movies in a secure way. The DCI (Digital Cinema Initiatives) specification defines everything from file formats and encryption to the projection systems itself.</p>

<p>The specification itself is <a href="https://www.dcimovies.com/" target="_blank">publicly available</a> but relies on various IEEE (Institute of Electrical and Electronics Engineers) and SMPTE (Society of Motion Picture and Television Engineers) standards, which have to be purchased.</p>

<h2 id="scope">Scope</h2>

<p>This document will show a rough overview of the DCI workflow and describe in detail how the encryption of a DCI movie works. It will <strong>not</strong> show how to break any encryption and no encryption has been broken while writing this document. <strong>From our perspective, the DCI standard is safe</strong>.</p>

<p>The author of this document has been operating a cinema since 2021, without any insight to the distribution or production side of the industry. Some information may be incomplete.</p>

<h2 id="how-its-started">How it’s started</h2>

<p>End of 2023 the movie <a href="https://www.imdb.com/title/tt6166392/" target="_blank">WONKA</a> was released. Some cinemas reported, that they are unable to start this movie on their projector.</p>

<p>The reason was, that a certificate used by the distributor was expired. This certificate was used to sign the DCP files.</p>

<p>The distributor published new files, starting the movie worked again.</p>

<p>Out of curiosity the author started to check how the validation process on the projector is working.</p>

<h2 id="glossar">Glossar</h2>

<ul>
  <li>
<strong>DCP</strong>: Digital Cinema Package - A folder which contains all components of a movie. Metadata, Subtitles, Audio and Picture in seperate files</li>
  <li>
<strong>CPL</strong>: Composition Playlist - A DCP can contain multiple audio and video streams which will combined in a CPL</li>
  <li>
<strong>KDM</strong>: Key Delivery Message - A XML file which contains the cryptographical information to allow a movie playback on a specific DCI certified projection system</li>
  <li>
<strong>DKDM</strong>: Distribution Key Delivery Message - Similar to a KDM, but for a remastering or distribution system, not for a projection system</li>
</ul>

<h2 id="distribution-process">Distribution Process</h2>

<pre><code>graph TD
    classDef red fill:#a91900
    classDef green fill:#126500
    classDef purple fill:#650072
    legendprod[Producer]:::red
    legenddist[Distributor]:::green
    legendcine[Cinema]:::purple
    legendvendors[Projector Manufacturer]
</code></pre>

<pre><code>graph LR
    classDef red fill:#a91900
    classDef green fill:#126500
    classDef purple fill:#650072

    dcpcreated([&#34;DCP\ncreated&#34;]):::red --&#34;AES Key&#34;--&gt; dkdmcreated
    dkdmcreated([&#34;DKDM\ncreated&#34;]):::red --&#34;encrypted\nAES Key&#34;--&gt; dkdmp
    
    dkdmp[DKDM]:::green --&gt; verify([&#34;Projector\nverified&#34;]):::green
    dcpcreated --&#34;to Distributor&#34;--&gt; dcp([&#34;DCP by\nDownload or\nHarddrive&#34;]):::green
    distcert[&#34;Distributor\nCertificate&#34;]:::green --&#34;to Producer&#34;--&gt; dkdmcreated
    
    verify --&#34;to Cinema&#34;--&gt; kdm[KDM]:::purple
    dcp --&#34;to Cinema&#34;--&gt; dcp2[&#34;DCP&#34;]:::purple
    cinecert[&#34;Projector\nCertificate&#34;]:::purple --&#34;to Distributor&#34;--&gt; verify
    trusted[&#34;Trusted Device List&#34;] --&gt; verify
    dcp2 --&gt; projector[Projector]:::purple
    kdm --&gt; projector
</code></pre>

<h2 id="projection-systems">Projection Systems</h2>

<p>Most of the Projection Systems consists of Server, Audio Processor and Projector.</p>

<pre><code>graph LR
  server[Server] --&gt; mediablock[Media Block]
  hdmi[HDMI Source] --&gt; splitter[Audio Splitter]
  splitter --&#34;Video&#34;--&gt; projector
  splitter --&#34;Audio&#34;--&gt; sound
  subgraph Projector
   mediablock --&#34;Video&#34;--&gt; projector[Projector]
  end
  
  projector --&gt; screen[Theatre Screen]
  mediablock --&#34;Audio&#34;--&gt; sound[Audio Processor]
  sound --&gt; speakers[Speakers]
</code></pre>

<p>The Server stores the DCPs and KDMs, manages Playlists and controls the Projector and Audio Processor hardware.</p>

<p>Many Cinemas also connect their Theatre Automation (light, curtains, etc.) to the projector. By setting time-based commands into the playlists, lights and screen curtain can be controlled automatically. The Projector Server provides 12V/24V relays for this.</p>

<p>These time-based commands are also used to set the correct Aspect Ratio and Volume on the different DCPs in a Playlist.</p>

<p>The Server can be controlled remotely by a PC or in larger cinemas by a Theatre Management System.</p>

<p>The DCPs are imported from USB/CRU hard drives or by internet download to the server. They are stored encrypted at all times.</p>

<p>The projector includes a so called “Media Block” which handles DRM and decryption. It receives the DCP data and the KDM to decrypt each frame in real time.</p>

<p>On DCP playback the Projector will send the decrypted PCM audio to the Audio Processor which will then send each processed Audio Channel to the respective Speakers.</p>

<p><img src="https://serverless.industries/assets/digital-cinema-disks.jpg" alt="DCP Disks"/></p>

<h2 id="dcp-format">DCP Format</h2>

<p>A DCP is a folder which contains XML metadata files and multiple MXF files for the actual movie.</p>

<h3 id="folder-naming-pattern">Folder Naming Pattern</h3>

<pre><code>AwesomeMovie_FTR-2_S_DE-XX_DE-16_51_4K_20240119_SMPTE_OV
</code></pre>

<ul>
  <li>
<code>AwesomeMovie</code>: A short version of the movie title</li>
  <li>
<code>FTR</code>: Media Type, in this case “Feature”</li>
  <li>
<code>2</code>: Version Number</li>
  <li>
<code>S</code>: Aspect ratio, in this case 2.35:1 aka “Sope”</li>
  <li>
<code>DE</code>: Audio Language</li>
  <li>
<code>XX</code>: Subtitle Language, in this case is no subtitle available</li>
  <li>
<code>DE</code>: Territory</li>
  <li>
<code>16</code>: Age Rating</li>
  <li>
<code>51</code>: Audio channels, in this case 5.1 surround sound</li>
  <li>
<code>4K</code>: Movie resolution, in this case 4096x1716 pixels</li>
  <li>
<code>20240119</code>: Mastering timestamp</li>
  <li>
<code>SMPTE</code>: DCP standard, there is also <code>Interop</code>
</li>
  <li>
<code>OV</code>: Package type, original version or <code>VF</code> for version file</li>
</ul>

<p>Credits: <a href="http://static.kinofreund.com/dcnt/" target="_blank">http://static.kinofreund.com/dcnt/</a></p>

<h3 id="mastering-process">Mastering Process</h3>

<p>During the Mastering Process a static AES 128 bit key is generated and the original medium is converted into MXF files. One for picture and one for audio.</p>

<p>For mastering the tool <a href="https://dcpomatic.com/" target="_blank">DCP-o-matic</a> can be used. There are also some commercial products.</p>

<pre><code>graph LR
    movie[&#34;Source&#34;] --&gt; mastering{{&#34;Movie Mastering&#34;}}
    mastering --&gt; dcpkey[&#34;Static&lt;br&gt;AES-128 Key&#34;]
    mastering --&gt; dcp[&#34;Digital Cinema Package (DCP)&#34;]
    dcp --&gt; dcppics[&#34;Encrypted&lt;br&gt;Picture Data&#34;]
    dcp --&gt; dcpsound[&#34;Encrypted&lt;br&gt;Audio Data&#34;]
    dcp --&gt; dcpsub[&#34;Encrypted&lt;br&gt;Subtitle Data&#34;]
</code></pre>

<p>The video stream is encoded as one single JPEG2000 picture per frame. Each frame is encrypted with the same static AES key.</p>

<p>The audio stream is (most likely) chunked into one BWF (Broadcast Wave Format) stream per frame and also encrypted separately. (The author haven’t found any information about this yet.)</p>

<p>A DCP can have a size of 200 GB or more. Some newer releases can hit the Terabyte, if multiple versions (Languages, Subtitles, 2D/3D) are shipped on the same harddrive.</p>

<p>The subtitles are provided in an XML file or are burned directly into the picture frames. If it is provided as an XML file, the projector will render the subtitles using a TTF font file.</p>

<div><div><pre><code><span>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span>&lt;DCSubtitle</span> <span>Version=</span><span>&#34;1.0&#34;</span><span>&gt;</span>
    <span>&lt;SubtitleID&gt;</span>xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx<span>&lt;/SubtitleID&gt;</span>
    <span>&lt;MovieTitle&gt;</span>MovieTitle<span>&lt;/MovieTitle&gt;</span>
    <span>&lt;ReelNumber&gt;</span>1<span>&lt;/ReelNumber&gt;</span>
    <span>&lt;Language&gt;</span>de<span>&lt;/Language&gt;</span>
    <span>&lt;LoadFont</span> <span>Id=</span><span>&#34;Font1&#34;</span> <span>URI=</span><span>&#34;Arial.ttf&#34;</span> <span>/&gt;</span>
    <span>&lt;Font</span> <span>Id=</span><span>&#34;Font1&#34;</span> <span>Color=</span><span>&#34;ffffffff&#34;</span> <span>Effect=</span><span>&#34;border&#34;</span> <span>EffectColor=</span><span>&#34;ff000000&#34;</span> <span>Italic=</span><span>&#34;no&#34;</span> <span>Script=</span><span>&#34;normal&#34;</span> <span>Size=</span><span>&#34;42&#34;</span> <span>Underlined=</span><span>&#34;no&#34;</span> <span>Weight=</span><span>&#34;normal&#34;</span> <span>AspectAdjust=</span><span>&#34;1&#34;</span> <span>Spacing=</span><span>&#34;0em&#34;</span><span>&gt;</span>
        <span>&lt;Subtitle</span> <span>SpotNumber=</span><span>&#34;1&#34;</span> <span>TimeIn=</span><span>&#34;00:07:45:094&#34;</span> <span>TimeOut=</span><span>&#34;00:07:48:000&#34;</span> <span>FadeUpTime=</span><span>&#34;000&#34;</span> <span>FadeDownTime=</span><span>&#34;000&#34;</span><span>&gt;</span>
            <span>&lt;Text</span> <span>HPosition=</span><span>&#34;0&#34;</span> <span>VAlign=</span><span>&#34;bottom&#34;</span> <span>VPosition=</span><span>&#34;7&#34;</span><span>&gt;</span>WÜSTE VON NEVADA - HEUTE<span>&lt;/Text&gt;</span>
        <span>&lt;/Subtitle&gt;</span>
    <span>&lt;/Font&gt;</span>
<span>&lt;/DCSubtitle&gt;</span>
</code></pre></div></div>



<p>A supplemental DCP allows to reuse the Original DCP (OV, Original File) picture and replace audio or subtitle tracks. This makes it possible to support different languages without the need of shipping hundreds of gigabytes of duplicated picture data to the cinemas.</p>

<pre><code>graph TD
    f[PaktDerWoelfe_FTR_S-235_FR-XX_DE_51_4K_SC_20230926_EGB_SMPTE_OV]
    f --&gt; a[PaktDerWoelBoC_FTR_S-235_DE-DE_DE_51_4K_SC_20231115_EGB_SMPTE_VF]
    f --&gt; b[PaktDerWoelBoC_FTR_S-235_FR-DE_DE_51_4K_SC_20231115_EGB_SMPTE_VF]
</code></pre>

<p>Example: One version file for German with German subtitles and one for French with German subtitles.</p>

<p>It is even possible to provide differnt cuts of a movie for different regions.</p>

<h3 id="software">Software</h3>

<p>Two Open Source C++ implementations, both in active development, one from the industry!</p>

<p>cth103/libdcp, a C++ library written by the makers of DCP-o-matic:</p>

<ul>
  <li><a href="https://git.carlh.net/gitweb/?p=dcpomatic.git;a=shortlog;h=refs/heads/main" target="_blank">https://git.carlh.net/gitweb/?p=dcpomatic.git;a=shortlog</a></li>
  <li>
<a href="https://dcpomatic.com/" target="_blank">https://dcpomatic.com/</a> (<a href="https://git.carlh.net/gitweb/?p=libdcp.git;a=summary" target="_blank">source code</a>)</li>
</ul>

<p>asdcplib, a C++ library written by companies active in the cinema industry:</p>

<blockquote>
  <p>The asdcplib project was originally exchanged by FTP. The project was on SourceForge between 2005 and 2008, when it moved to a release-only distribution via CineCert. As of late February 2019, its new home is on github.</p>

  <p>– <a href="https://github.com/cinecert/asdcplib" target="_blank">https://github.com/cinecert/asdcplib</a></p>
</blockquote>

<p>Almost all software, commercial or open source is using one of these libraries.</p>

<h2 id="distribution">Distribution</h2>

<p>The symmetric encryption key for the DCP has to be protected in some way. For this, the producer will create a DKDM XML file, containing the AES Key, which has been encrypted with the Certificate Public Key of the distributor.</p>

<p>The distributor can then use the DKDM to create KDM XML files for cinemas. This means decrypting the DCP AES Key and encrypting it again with the Certificate Public Key of the target projection system.</p>

<h2 id="certificate-chains">Certificate Chains</h2>

<p>Both projectors and distributors use SSL certificate chains to sign and encrypt/decrypt data.</p>

<p>A chain always consists of a Root Certificate Authority (CA), Intermediate CA and a Leaf Certificate.</p>

<pre><code>graph TD
    a[&#34;dnQualifier=ZwVjULQy61,CN=.smpte-430-2.root,OU=movies.serverless.industries,O=serverless.industries&#34;]
    a --&gt; b[&#34;dnQualifier=/JLF0JtscFuJahVNXfYu1w1u7SI=,CN=.smpte-430-2.intermediate,OU=movies.serverless.industries,O=serverless.industries&#34;]
    b --&gt; c[&#34;dnQualifier=TEqiLeRuVnkbNOUsPlbDHIdp1tM=,CN=CS.smpte-430-2.leaf,OU=movies.serverless.industries,O=serverless.industries&#34;]
</code></pre>

<p>The field <code>dnQualifier</code> in the subject is the fingerprint of the public key of the generated certificate:</p>

<div><div><pre><code><span>cat </span>leaf.pem | openssl x509 <span>-pubkey</span> <span>-noout</span> | <span>\</span>
    openssl <span>base64</span> <span>-d</span> | <span>dd </span><span>bs</span><span>=</span>1 <span>skip</span><span>=</span>24 2&gt;/dev/null | <span>\</span>
    openssl sha1 <span>-binary</span> | openssl <span>base64</span>
</code></pre></div></div>

<p>Script for creating a certificate chain: <a href="https://github.com/NEU-Deli/dcitools/blob/master/create-smpte-chain.sh" target="_blank">create-smpte-chain.sh</a></p>

<h2 id="key-delivery-messages">Key Delivery Messages</h2>

<p>A KDM is a XML file which contains the AES key of the DCP encrypted with the projectors Public Key.</p>

<ul>
  <li>Various XML Schemas: SMPTE 430-1, SMPTE 430-3</li>
  <li>Document signing with XML-DSig</li>
  <li>One or more <code>&lt;enc:CipherValue&gt;</code> elements contain the AES keys and some metadata for multiple DCP OV/VF, both encrypted</li>
</ul>

<p>Decrypt the <code>&lt;enc:CipherValue&gt;</code> with <code>openssl</code>:</p>

<div><div><pre><code><span>cat </span>KDM_KaizoTrap_FTR-1_F_XX-XX_20_2K_20240119_SMPTE_OV_My_nonexistent_cinema_Nonexistent_Screen_1.xml | <span>\</span>
    xq <span>-r</span> <span>&#39;.DCinemaSecurityMessage.AuthenticatedPrivate.&#34;enc:EncryptedKey&#34;[0].&#34;enc:CipherData&#34;.&#34;enc:CipherValue&#34;&#39;</span> | <span>\</span>
    <span>base64</span> <span>-d</span> | <span>\</span>
    openssl pkeyutl <span>-decrypt</span> <span>-inkey</span> leaf.key <span>-pkeyopt</span> rsa_padding_mode:oaep <span>&gt;</span> kdminfo.bin
</code></pre></div></div>

<p>Output of <code>hexdump -C kdminfo.bin</code>:</p>

<pre><code>00000000  f1 dc 12 44 60 16 9a 0e  85 bc 30 06 42 f8 66 ab  |...D`.....0.B.f.|
00000010  28 fd 80 bf a9 bb f1 dc  48 d9 87 e9 5c c9 a5 41  |(.......H...\..A|
00000020  ab 8e 14 82 88 40 c3 90  2a 0b 46 21 b4 10 49 6b  |.....@..*.F!..Ik|
00000030  b8 a4 a9 4f 4d 44 41 4b  2e 2e 05 b5 bb ed 45 79  |...OMDAK......Ey|
00000040  96 cc 9c d6 00 ed db 4c  32 30 32 34 2d 30 31 2d  |.......L2024-01-|
00000050  32 38 54 31 39 3a 30 30  3a 30 30 2b 30 31 3a 30  |28T19:00:00+01:0|
00000060  30 32 30 32 34 2d 30 32  2d 30 34 54 32 30 3a 30  |02024-02-04T20:0|
00000070  30 3a 30 30 2b 30 31 3a  30 30 4c 3a b6 ed 71 eb  |0:00+01:00L:..q.|
00000080  29 25 90 48 6b 4f 96 2f  44 f6                    |)%.HkO./D.|
0000008a
</code></pre>

<p>The file can now be sliced into single fields with <code>dd</code>:</p>

<div><div><pre><code><span># fingerprint base64 encoded</span>
<span>dd </span><span>if</span><span>=</span>kdminfo.bin <span>bs</span><span>=</span>1 <span>skip</span><span>=</span>16 <span>count</span><span>=</span>20 <span>status</span><span>=</span>none | <span>base64</span>

<span># AES key in hexadecimal</span>
<span>dd </span><span>if</span><span>=</span>kdminfo.bin <span>bs</span><span>=</span>1 <span>skip</span><span>=</span>122 <span>count</span><span>=</span>16 <span>status</span><span>=</span>none | hexdump <span>-C</span>

<span># date string in plain text ASCII</span>
<span>dd </span><span>if</span><span>=</span>kdminfo.bin <span>bs</span><span>=</span>1 <span>skip</span><span>=</span>97 <span>count</span><span>=</span>25 <span>status</span><span>=</span>none<span>;</span> <span>echo</span>
</code></pre></div></div>

<p>Format:</p>

<table>
  <thead>
    <tr>
      <th>Start</th>
      <th>Length</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>16</td>
      <td>Structure ID, binary, static <code>0xf1dc124460169a0e85bc300642f866ab</code>
</td>
    </tr>
    <tr>
      <td>16</td>
      <td>20</td>
      <td>Signer certificate fingerprint, binary, <code>KP2Av6m78dxI2YfpXMmlQauOFII=</code>
</td>
    </tr>
    <tr>
      <td>36</td>
      <td>16</td>
      <td>Composition Playlist UUID, <code>8840c390-2a0b-4621-b410-496bb8a4a94f</code>
</td>
    </tr>
    <tr>
      <td>52</td>
      <td>4</td>
      <td>Key Type, ASCII, <code>MDAK</code> = Main Sound</td>
    </tr>
    <tr>
      <td>56</td>
      <td>16</td>
      <td>Key UUID, <code>2e2e05b5-bbed-4579-96cc-9cd600eddb4c</code>
</td>
    </tr>
    <tr>
      <td>72</td>
      <td>25</td>
      <td>Not valid before date string, ASCII, <code>2024-01-28T19:00:00+01:00</code>
</td>
    </tr>
    <tr>
      <td>97</td>
      <td>25</td>
      <td>Not valid after date string, ASCII, <code>2024-02-04T20:00:00+01:00</code>
</td>
    </tr>
    <tr>
      <td>122</td>
      <td>16</td>
      <td>AES decryption key, binary, <code>0x4c3ab6ed71eb292590486b4f962f44f6</code>
</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>Validate signer certificate: Should match the fingerprint of the leaf certificate used to sign the KDM XML structure</li>
</ul>

<div><div><pre><code>openssl asn1parse <span>-in</span> leaf.pem <span>-noout</span> <span>-strparse</span> 4 <span>-out</span> - | <span>\</span>
    openssl dgst <span>-sha1</span> <span>-binary</span> | <span>\</span>
    openssl <span>base64</span>
</code></pre></div></div>

<ul>
  <li>Validate Composition Playlist UUID: Should appear in the KDM XML field <code>&lt;CompositionPlaylistId&gt;</code>
</li>
  <li>Validate Key UUID: Should appear in the KDM XML field <code>&lt;KeyId&gt;</code>
</li>
  <li>Validate Key Type: Should match the type for the respective Key UUID <code>&lt;TypedKeyId&gt;</code> block</li>
  <li>Validate Dates: Should appear in the KDM XML fields <code>&lt;ContentKeysNotValidBefore&gt;</code> and <code>&lt;ContentKeysNotValidAfter&gt;</code>
</li>
</ul>

<p>(This is a subset of checks documented in the <a href="https://www.dcimovies.com/compliance_test_plan/" target="_blank">DCI Compliance Test Plan</a>)</p>

<p>The projector itself has no trusted CA store for validating KDMs or DCPs. The whole process relies on the fingerprint stored in the <code>&lt;enc:CipherValue&gt;</code> and that the recipient cinema has no access to the Projectors Private Key.</p>

<h2 id="trusted-device-list">Trusted Device List</h2>

<p>Could one just build their own DCI/DCP projector?</p>

<p>Yes and no.</p>

<p>The software exists, in theory just a Linux PC and any projector / sound system is required.</p>

<p>The distributors use a so called “Trusted Device List” provided by the DCI certified projection system manufacturers. Projectors which are not mentioned on these lists will not get a DCP/KDM from many distributors.</p>

<p>Also a DCI certified projection system must be installed by an authorized company.</p>

<ul>
  <li>KDM Request by Serial Number: Many distributors just ask for projector model and serial number. They can query the actual projection system certificate in their distribution system</li>
  <li>KDM Request by Certificate: The cinema has to provide their projector certificate which is then validated against the projection systems manufacturer root certificate</li>
</ul>

<p>If a cinema is not “playing by the rules”, a 30k+ EUR projection system will become an expensive brick.</p>

<h2 id="mxf-file-format">MXF File Format</h2>

<p>MXF is used by the whole movie and broadcasting industry.</p>

<p>The paper of the SMPTE standard is again purchase-only.</p>

<p>Since the standard is quite complex, the Author used <a href="https://github.com/Myriadbits/MXFInspect" target="_blank">MXFInspect</a> as a shortcut and only parsed a single Frame / Triplet.</p>

<h3 id="ber-encoding">BER Encoding</h3>

<p><strong>B</strong>asic <strong>E</strong>ncoding <strong>R</strong>ules:</p>

<ul>
  <li>BER is indicated if the first bit of the byte is a <code>1</code>
</li>
  <li>Bits 2-8 contain the number of bytes used for the length</li>
  <li>The length bytes contain the length of the data</li>
</ul>

<table>
  <thead>
    <tr>
      <th>BER Indicator</th>
      <th>Length</th>
      <th>Content</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
<code>0x83</code> = <code>10000011b</code></td>
      <td>
<code>0x004F0C</code></td>
      <td>20236 bytes of data</td>
    </tr>
  </tbody>
</table>

<h3 id="triplet-format-single-movie-frame">Triplet Format (Single Movie Frame)</h3>

<h4 id="frame-triplet-structure">Frame Triplet Structure</h4>

<table>
  <thead>
    <tr>
      <th>Start</th>
      <th>Type</th>
      <th>Length</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>DAT</td>
      <td>16</td>
      <td>Encrypted triplet key</td>
    </tr>
    <tr>
      <td>16</td>
      <td>BER</td>
      <td>1</td>
      <td>BER <code>0x83</code> = <code>10000011b</code> = Next field is 3 bytes long</td>
    </tr>
    <tr>
      <td>17</td>
      <td>LEN</td>
      <td>3</td>
      <td>
<code>0x004F0C</code> = <code>20236d</code> = Length of the data</td>
    </tr>
    <tr>
      <td>20</td>
      <td>BER</td>
      <td>1</td>
      <td>BER <code>0x83</code> = <code>10000011b</code> = Next field is 3 bytes long</td>
    </tr>
    <tr>
      <td>21</td>
      <td>LEN</td>
      <td>3</td>
      <td>
<code>0x000010</code> = <code>16d</code> = Length of the next field</td>
    </tr>
    <tr>
      <td>24</td>
      <td>DAT</td>
      <td>16</td>
      <td>Cryptographic Context Link</td>
    </tr>
    <tr>
      <td>40</td>
      <td>BER</td>
      <td>1</td>
      <td>BER <code>0x83</code> = <code>10000011b</code> = Next field is 3 bytes long</td>
    </tr>
    <tr>
      <td>41</td>
      <td>LEN</td>
      <td>3</td>
      <td>
<code>0x000008</code> = <code>8d</code> = Length of the next field</td>
    </tr>
    <tr>
      <td>44</td>
      <td>DAT</td>
      <td>8</td>
      <td>Plaintext offset</td>
    </tr>
    <tr>
      <td>52</td>
      <td>BER</td>
      <td>1</td>
      <td>BER <code>0x83</code> = <code>10000011b</code> = Next field is 3 bytes long</td>
    </tr>
    <tr>
      <td>53</td>
      <td>LEN</td>
      <td>3</td>
      <td>
<code>0x000010</code> = <code>16d</code> = Length of the next field</td>
    </tr>
    <tr>
      <td>56</td>
      <td>DAT</td>
      <td>16</td>
      <td>Source Key</td>
    </tr>
    <tr>
      <td>72</td>
      <td>BER</td>
      <td>1</td>
      <td>BER <code>0x83</code> = <code>10000011b</code> = Next field is 3 bytes long</td>
    </tr>
    <tr>
      <td>73</td>
      <td>LEN</td>
      <td>3</td>
      <td>
<code>0x000008</code> = <code>8d</code> = Length of the next field</td>
    </tr>
    <tr>
      <td>76</td>
      <td>DAT</td>
      <td>8</td>
      <td>Source Length</td>
    </tr>
    <tr>
      <td>84</td>
      <td>BER</td>
      <td>1</td>
      <td>BER <code>0x83</code> = <code>10000011b</code> = Next field is 3 bytes long</td>
    </tr>
    <tr>
      <td>85</td>
      <td>LEN</td>
      <td>3</td>
      <td>
<code>0x004e90</code> = <code>20112d</code> = Length of the next field</td>
    </tr>
    <tr>
      <td>88</td>
      <td>DAT</td>
      <td>20112</td>
      <td>Encrypted Source Value</td>
    </tr>
  </tbody>
</table>

<!--
```
Cryptographic Context Link = 2F347C27660A4F87844B36F957D753A6
Plaintext Offset           = 0000000000000000
Source Key                 = 060E2B34010201010D01030115010801
Source Length              = 0000000000004E61 = 20065d
```

> [color=#e862ea] TODO: What are these fields? 🤷‍♂️
-->

<h4 id="slice-the-data">Slice the data</h4>

<div><div><pre><code><span># slice the first frame from the MXF bodypartition</span>
<span># offsets from MXFInspect</span>
<span>dd </span><span>if</span><span>=</span>file.mxf <span>bs</span><span>=</span>1 <span>count</span><span>=</span>20256 <span>skip</span><span>=</span>16524 <span>of</span><span>=</span>block.bin

<span># slice data from the frame</span>
<span>dd </span><span>if</span><span>=</span>block.bin <span>skip</span><span>=</span>88 <span>count</span><span>=</span>20112 <span>bs</span><span>=</span>1 <span>of</span><span>=</span>block-encrypted-data.bin
</code></pre></div></div>

<h3 id="decrypt-frame-data">Decrypt Frame Data</h3>

<p>The DCP encryption key: <code>4c3ab6ed71eb292590486b4f962f44f6</code></p>

<h4 id="the-frame-iv">The frame IV</h4>

<p>Every Frame is using a unique IV (Initialization Vector), which ensures that the AES Block Cipher generates always different cipher texts and makes brute force harder. This works similar to a Password Salt.</p>

<div><div><pre><code><span># the data starts with 16 bytes of iv and 16 bytes of cv</span>
<span># AES iv bytes</span>
<span>dd </span><span>if</span><span>=</span>block-encrypted-data.bin <span>bs</span><span>=</span>1 <span>count</span><span>=</span>16 <span>of</span><span>=</span>iv.bin
</code></pre></div></div>

<p>Output of <code>hexdump -C iv.bin</code>:</p>

<div><div><pre><code>00000000  16 6e 7b d1 67 81 44 2e  7a ca de 3c 46 cc d7 39  |.n{.g.D.z..&lt;F..9|
00000010
</code></pre></div></div>

<h4 id="validate-cv">Validate CV</h4>

<p>Since there is no way to know if a decryption was successful when the content of the data is unknown, a CV (Check Value) is used. The Check Value is encrypted with the same AES Key + IV, but the plain text value is known.</p>

<div><div><pre><code><span># the data starts with 16 bytes of iv and 16 bytes of cv</span>
<span># AES cv bytes</span>
<span>dd </span><span>if</span><span>=</span>block-encrypted-data.bin <span>bs</span><span>=</span>1 <span>count</span><span>=</span>16 <span>skip</span><span>=</span>16 <span>of</span><span>=</span>cv.bin
</code></pre></div></div>

<div><div><pre><code><span>cat </span>cv.bin | openssl enc <span>-aes128</span> <span>-d</span> <span>\</span>
    <span>-K</span> 4c3ab6ed71eb292590486b4f962f44f6 <span>\</span>
    <span>-iv</span> 166e7bd16781442e7acade3c46ccd739 <span>\</span>
    <span>-nosalt</span> <span>-nopad</span> | hexdump <span>-C</span>
</code></pre></div></div>

<div><div><pre><code>00000000  43 48 55 4b 43 48 55 4b  43 48 55 4b 43 48 55 4b  |CHUKCHUKCHUKCHUK|
00000010
</code></pre></div></div>

<p>If the result matches <code>0x4348554B4348554B4348554B4348554B</code> the key is correct.</p>

<h4 id="decrypt-data">Decrypt data</h4>

<div><div><pre><code><span># Remove IV and CV from the encrypted data block</span>
<span>dd </span><span>bs</span><span>=</span>1 <span>skip</span><span>=</span>32 <span>\</span>
    <span>if</span><span>=</span>block-encrypted-data.bin <span>\</span>
    <span>of</span><span>=</span>block-encrypted-data-nocryptinfo.bin
</code></pre></div></div>

<div><div><pre><code><span># Decrypt data block</span>
<span>cat </span>block-encrypted-data-nocryptinfo.bin | <span>\</span>
    openssl enc <span>-aes128</span> <span>-d</span> <span>\</span>
        <span>-K</span> 4c3ab6ed71eb292590486b4f962f44f6 <span>\</span>
        <span>-iv</span> 166e7bd16781442e7acade3c46ccd739 <span>\</span>
        <span>-nosalt</span> <span>-nopad</span> <span>&gt;</span> block-decrypted-data.bin
</code></pre></div></div>

<p>MXFs created by DCP-o-Matic contain <code>libdcp</code> in the hexdump, which indicates that the decryption was successful.</p>

<p>Output of <code>hexdump -C block-decrypted-data.bin | head</code>:</p>

<div><div><pre><code>00000000  3a f0 b7 f5 53 49 eb b7  c0 c0 cb a5 c9 2f 35 19  |:...SI......./5.|
00000010  00 00 00 00 00 00 00 00  00 00 07 ce 00 00 04 38  |...............8|
00000020  00 00 00 00 00 00 00 00  00 03 0b 01 01 0b 01 01  |................|
00000030  0b 01 01 ff 52 00 12 01  04 00 01 01 05 03 03 00  |....R...........|
00000040  00 77 88 88 88 88 88 ff  5c 00 23 22 97 20 96 f0  |.w......\.#&#34;. ..|
00000050  96 f0 96 c0 8f 00 8f 00  8e e0 87 50 87 50 87 68  |...........P.P.h|
00000060  70 05 70 05 70 47 77 d3  77 d3 77 62 ff 55 00 13  |p.p.pGw.w.wb.U..|
00000070  00 50 00 00 00 4d 40 00  00 00 00 49 00 00 00 00  |.P...M@....I....|
00000080  49 ff 64 00 0a 00 01 6c  69 62 64 63 70 ff 90 00  |I.d....libdcp...|
00000090  0a 00 00 00 00 4d 40 00  03 ff 93 ef fe 2c 71 ff  |.....M@......,q.|
</code></pre></div></div>

<h2 id="magic-signatures">Magic Signatures</h2>

<p>At first, the decrypted Frame could not be opened in GIMP.</p>

<p>To enable programs to open a file in the correct way, many files contain so called “<a href="https://en.wikipedia.org/wiki/List_of_file_signatures" target="_blank">Magic Signatures</a>” at its beginning.</p>

<p>This magic value in <code>block-decrypted-data.bin</code> is incorrect for unknown reasons. When extracting a JPEG2000 frame from an unencrypted MXF, the signature is correct. As a simple hack, the author just copied the signature from the unencrypted MXF frame to the decrypted one:</p>

<div><div><pre><code><span># offset again from MXFInspect</span>
<span>dd </span><span>if</span><span>=</span>j2c_caa6b39e-bd57-4676-9797-112e96a6f0c3.mxf <span>bs</span><span>=</span>1 <span>skip</span><span>=</span>16524 <span>count</span><span>=</span>20085 <span>of</span><span>=</span>frame.bin

<span># unencrypted frame does not contain crypto info</span>
<span># so we just have to slice the first BER header</span>
<span>dd </span><span>if</span><span>=</span>framedata.bin.j2k <span>bs</span><span>=</span>1 <span>skip</span><span>=</span>20 <span>count</span><span>=</span>16 <span>of</span><span>=</span>j2k_header.bin

<span># now back to the decrypted mxf frame</span>
<span># replace signature</span>
<span>cp </span>j2k_header.bin frame.j2k
<span>dd </span><span>if</span><span>=</span>block-decrypted-data.bin <span>bs</span><span>=</span>1 <span>skip</span><span>=</span>16 <span>&gt;&gt;</span> image.j2k
</code></pre></div></div>

<p>It should now be possible to open the file in GIMP. GIMP will show the frame with wrong colors, as MXF files use a custom color space.</p>

<p><img src="https://serverless.industries/assets/kaizotrap-decrypted.jpg" alt="Movie Screenshot with wrong color space"/></p>

<p>The original Frame with correct colors:</p>

<p><img src="https://serverless.industries/assets/kaizotrap-original.jpg" alt="Movie Screenshot with correct colors"/></p>

<p>Credit: <a href="https://www.youtube.com/watch?v=lIES3ii-IOg" target="_blank">Kaizo Trap by Guy Collins Animation</a></p>

<h2 id="why-its-safe">Why it’s safe</h2>

<p>Everything relies on “never reusing AES Keys” and “protected private keys”.</p>

<ul>
  <li>KDM data is encrypted with a 2048 bit RSA key</li>
  <li>MXF data is encrypted with AES-128</li>
  <li>Decryption keys are always stored in TPM-like hardware</li>
  <li>Every DCP uses unique encryption keys</li>
  <li>Every projector uses unique certificates/keys</li>
  <li>A DCI certified projector is required</li>
  <li>Distributors can verify if a certificate belongs to a certified DCI projector</li>
</ul>

<h2 id="just-record-it">Just record it</h2>

<p>Encrypted DCPs use <a href="https://dcpomatic.com/forum/viewtopic.php?t=2372" target="_blank">Forensic Watermarks</a> which contain the serial number of the
projection system. So if a recorded copy of a movie appears online, the theatre will have to answer
serious questions and may never get movies again.</p>

<p>Pirated copies of movies have it’s origin most likely from other sources.</p>

<h2 id="how-its-going">How it’s going</h2>

<p>DCI has released version 1.4.4 of the <a href="https://www.dcimovies.com/specification/" target="_blank">specification</a>, which now allows playback of DCPs with expired signer certificate.</p>

<p>The manufacturers already started to work on a software update.</p>

<h2 id="sources">Sources</h2>

<ul>
  <li><a href="https://www.dcimovies.com/specification/index.html" target="_blank">DCI Specification</a></li>
  <li><a href="https://www.dcimovies.com/compliance_test_plan/" target="_blank">DCI Compliance Test Plan</a></li>
  <li><a href="https://marc.info/?l=openssl-users&amp;m=114884533706459&amp;w=2" target="_blank">OpenSSL Foo</a></li>
  <li><a href="https://github.com/wolfgangw/digital_cinema_tools_distribution/blob/master/cinemaslides#L1737" target="_blank">Key Types</a></li>
  <li><a href="https://github.com/wolfgangw/digital_cinema_tools_distribution/tree/master" target="_blank">DC Tools by WolfgangW</a></li>
  <li><a href="https://github.com/Myriadbits/MXFInspect" target="_blank">MXFInspect</a></li>
  <li><a href="https://tech.ebu.ch/docs/techreview/trev_2010-Q3_MXF-2.pdf" target="_blank">MXF Triplets</a></li>
  <li><a href="https://web.archive.org/web/20201103045630id_/https://ieeexplore.ieee.org/ielx7/8984679/8984680/08984681.pdf" target="_blank">SMPTE Standard</a></li>
  <li><a href="https://interop-docs.cinepedia.com/Document_Release_2.0/mpeg_ii_track_file_encryption.pdf" target="_blank">MXF Triplet Encryption</a></li>
  <li><a href="https://github.com/cth103/libdcp/issues/11" target="_blank">Showing jpeg2000 in Gimp / parsing jpeg2000 data from mxf</a></li>
  <li><a href="https://en.wikipedia.org/wiki/List_of_file_signatures" target="_blank">List of magic signatures</a></li>
  <li><a href="https://dcpomatic.com/forum/viewtopic.php?t=2372" target="_blank">Forensic Watermarks in DCPs</a></li>
</ul>

<h2 id="credits">Credits</h2>

<p>Thanks for reading and feedback goes to: Pliskin, babel</p>

    </div></div>
  </body>
</html>
