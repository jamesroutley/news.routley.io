<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://albertpedersen.com/blog/hijacking-email-with-cloudflare-email-routing/">Original</a>
    <h1>Hijacking Email with Cloudflare Email Routing</h1>
    
    <div id="readability-page-1" class="page"><div>
      
  <article>
    
    <div>
      <p>On Tuesday, December 7th 2021 I discovered a critical vulnerability in Cloudflare’s Email Routing service. This vulnerabilty enabled anyone to modify the routing configuration of any domain using the service. A bad actor could have overwritten the destination address to their own email address in order to read any email sent to the victim’s domain. The bug has since been fixed and Cloudflare has kindly allowed me to publish this write-up. <a href="https://hackerone.com/reports/1419341">View the report on HackerOne</a>.</p>
<h3 id="the-beta">The beta</h3>
<p>Cloudflare Email Routing was in closed beta back when I discovered this vulnerability, with only a few domains having been granted access. Sadly, I was not invited to the party, so I was simply going to have to crash it instead.</p>
<p>When the Cloudflare dashboard is loaded, a request is made to <code>https://dash.cloudflare.com/api/v4/zones/&lt;zone_tag&gt;/flags</code>. The response includes several properties that affect which features appear in the dashboard, and one of them is for the Email Routing beta.</p>
<div><pre tabindex="0"><code data-lang="json"><span><span>{
</span></span><span><span>    <span>&#34;email&#34;</span>: {
</span></span><span><span>        <span>&#34;beta&#34;</span>: <span>false</span>,
</span></span><span><span>        <span>&#34;visible&#34;</span>: <span>false</span>
</span></span><span><span>    }
</span></span><span><span>}
</span></span></code></pre></div><p>I used Burp to intercept the response and replace <code>&#34;beta&#34;: false</code> with <code>&#34;beta&#34;: true</code>, which made the dashboard think I had been given access to the beta.</p>
<div><pre tabindex="0"><code data-lang="json"><span><span>{
</span></span><span><span>    <span>&#34;email&#34;</span>: {
</span></span><span><span>        <span>&#34;beta&#34;</span>: <span>true</span>,
</span></span><span><span>        <span>&#34;visible&#34;</span>: <span>false</span>
</span></span><span><span>    }
</span></span><span><span>}
</span></span></code></pre></div><p>I assumed there would be server-side checks to prevent me from actually setting up Email Routing, but this turned out not to be the case. The restrictions were all client-side as the API did not check whether I’d been given access to the beta. I was able to successfully set up Email Routing on one of my domains which I’ll refer to it as <code>example.com</code> from now on. Any email sent to e.g. <code><a href="https://albertpedersen.com/cdn-cgi/l/email-protection" data-cfemail="32535e5057404672574a535f425e571c515d5f">[email protected]</a></code> would now be forwarded to my personal Gmail address.</p>
<h3 id="the-bug">The bug</h3>
<p>After having bypassed the beta restrictions and successfully configured Email Routing, I wondered what would happen if I tried to set up Email Routing on an unverified zone. I assumed either the API would throw an error or the configuration simply would not take effect, but of course I had to test it.</p>
<p>An unverified/pending zone is a domain that has been added to your Cloudflare account, but that you have not yet pointed to your assigned name servers to verify ownership. Any changes you make to this zone, such as modifying DNS records or enabling features, should not take effect until you verify ownership. A domain can only be active in a single Cloudflare account, but it can be unverified/pending in several accounts at a time.</p>
<p>To test this, I added <code>example.com</code> to my secondary Cloudflare account. <code>example.com</code> was now present in both my primary and secondary account, but it was only verified in my primary account. I followed the steps to set up Email Routing just like before, but this time I entered a different email address as the destination. This way any hijacked email would land in a different inbox and I would clearly be able to tell whether it had worked.</p>
<p>I sent an email to <code><a href="https://albertpedersen.com/cdn-cgi/l/email-protection" data-cfemail="8feee3edeafdfbcfeaf7eee2ffe3eaa1ece0e2">[email protected]</a></code> and waited… but nothing happened. Apparently my email client had just been slow to update, because after a few minutes the email landed in the inbox of the rogue destination address rather than my personal Gmail address. I have to say I was quite surprised as I really didn’t expect this to work. When I set up Email Routing for <code>example.com</code> on my secondary Cloudflare account, the original routing configuration for <code>example.com</code> was overwritten with my rogue settings.</p>
<h3 id="the-impact">The impact</h3>
<p>By exploiting this vulnerability a bad actor would’ve been able to:</p>
<ul>
<li>Read email sent to the target domain by forwarding it to a rogue destination address</li>
<li>Prevent email sent to the target domain from arriving at the original destination address</li>
</ul>
<p>Not only is this a huge privacy issue, but due to the fact that password reset links are often sent to the email address of the user, a bad actor could also potentially gain control of any accounts linked to that email address. This is a good example of why you should be using 2-factor authentication.</p>
<p>Due to the fact that you cannot change DNS records for a pending zone, the domain had to already be using Cloudflare Email Routing. I suspect that Cloudflare’s mail server only keeps a single record for each address, and that it was simply overwritten when I applied my rogue settings.</p>
<p>Unfortunately (or fortunately, depending on your motives), it is quite easily find a list of domains that use Cloudflare Email Routing and <a href="https://securitytrails.com/list/mx/amir.mx.cloudflare.net">SecurityTrails</a> is a good example of that. There were around 600 domains on the list at the time of finding, and all of them could’ve had their email hijacked if this was discovered by a bad actor.</p>
<h3 id="the-timeline">The timeline</h3>
<p>I managed to hijack the first email at 18:03 which led me to investigate further. At 18:44, after having reproduced the bug on multiple accounts and domains, I was able to confirm there was definitely an issue and started writing my report. Following is the HackerOne report timeline in CEST.</p>
<ul>
<li>2021-12-07 20:11 - Report submitted</li>
<li>2021-12-08 18:53 - First response</li>
<li>2021-12-09 15:10 - Report triaged</li>
<li>Fix implemented by Cloudflare</li>
<li>2021-12-13 21:59 - Bounty awarded</li>
<li>2021-12-14 11:46 - Report resolved</li>
<li>2022-07-28 18:35 - Report disclosed</li>
</ul>
<h3 id="conclusion">Conclusion</h3>
<p>Thanks to Cloudflare for reacting quickly to my bug report and for driving transparency by allowing me to publish this write-up. If you believe you’ve found a vulnerability in one of Cloudflare’s products or services, please submit a report to <a href="https://hackerone.com/cloudflare">Cloudflare Bug Bounty</a> on HackerOne.</p>

    </div>
    
  </article>

    </div></div>
  </body>
</html>
