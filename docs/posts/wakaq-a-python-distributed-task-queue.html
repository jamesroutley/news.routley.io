<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://wakatime.com/blog/56-building-a-distributed-task-queue-in-python">Original</a>
    <h1>Show HN: WakaQ - a Python distributed task queue</h1>
    
    <div id="readability-page-1" class="page"><div>
  
    <p><img src="https://wakatime.com/static/img/blog/light-queue.png" alt="light queue"/></p>

<h2>Why not just use Celery/RQ/Huey/TaskTiger?</h2>

<p>Unfortunately, WakaTime has been using Celery for almost 10 years now.
During that time I’ve experienced <a rel="nofollow noopener" target="_blank" href="https://github.com/celery/celery/issues?q=author%3Aalanhamlett">many critical bugs</a>, some still open years after being introduced.
Celery used to be pretty good, but feature bloat made the project difficult to maintain.
Also in my opinion, splitting the code into <a rel="nofollow noopener" target="_blank" href="https://docs.celeryq.dev/en/2.5-archived/changelog.html">three separate GitHub repos</a> made the codebase hard to read.</p>

<p>However, the main reason:
<strong>Celery delayed tasks don’t scale.</strong></p>

<p>If you use Celery delayed tasks, as your website grows eventually you’ll start seeing <a rel="nofollow noopener" target="_blank" href="https://github.com/celery/celery/issues/3267">this error message</a>:</p>

<pre><code>QoS: Disabled: prefetch_count exceeds 65535
</code></pre>

<p>When that happens the worker stops processing all tasks, not just delayed ones!
As WakaTime grew, we started running into this bug more frequently.</p>

<p>I tried <a rel="nofollow noopener" target="_blank" href="https://github.com/rq/rq">RQ</a>, <a rel="nofollow noopener" target="_blank" href="https://github.com/coleifer/huey">Huey</a>, and <a rel="nofollow noopener" target="_blank" href="https://github.com/closeio/tasktiger">TaskTiger</a>, but they were missing features and processed tasks slower than Celery.
A distributed task queue is indispensable for a website like WakaTime, and I was tired of running into bugs.
For that reason, I decided to build the simplest distributed task queue possible while still providing all the features required by WakaTime.</p>

<h2>Introducing WakaQ</h2>

<p><a rel="nofollow noopener" target="_blank" href="https://github.com/wakatime/wakaq">WakaQ</a> is a new Python distributed task queue.
Use it to run code in the background so your website stays fast and snappy, and your users stay happy.</p>

<h2>WakaQ is simple</h2>

<p>It’s only 1,264 lines of code!</p>

<pre><code>$ find . -name &#39;*.py&#39; -not -path &#34;./migrations*&#34; -not -path &#34;./venv*&#34; | xargs wc -l | grep &#34; total&#34; | awk &#39;{print $1}&#39; | numfmt --grouping
1,264
</code></pre>

<p>It only took <a rel="nofollow noopener" target="_blank" href="https://github.com/wakatime/wakaq/commits/main?after=a11d22b6a743e4fb0e220673085297bdc4aab710+104&amp;branch=main&amp;qualified_name=refs%2Fheads%2Fmain">one week</a> from the first line of code until fully replacing Celery at WakaTime.
That says something about it’s simplicity.</p>

<p>Each queue is implemented using a <a rel="nofollow noopener" target="_blank" href="https://redis.io/docs/data-types/lists/">Redis list</a>.
Delayed tasks get their own queues implemented using <a rel="nofollow noopener" target="_blank" href="https://redis.io/docs/data-types/sorted-sets/">Redis sorted sets</a>.
Broadcast tasks share a single <a rel="nofollow noopener" target="_blank" href="https://redis.io/docs/manual/pubsub/">Redis Pub/Sub queue</a>.</p>

<h2>WakaQ has all the necessary features</h2>

<ul>
<li>Queue priorities</li>
<li>Delayed tasks (run tasks after a timedelta eta)</li>
<li>Scheduled cron periodic tasks</li>
<li><a rel="nofollow noopener" target="_blank" href="https://github.com/wakatime/wakaq/blob/761d08f06d7d88941491e48d1cb524a1c35788ad/wakaq/task.py#L47">Broadcast</a> tasks (run a task on all workers)</li>
<li>Task <a rel="nofollow noopener" target="_blank" href="https://github.com/wakatime/wakaq/blob/761d08f06d7d88941491e48d1cb524a1c35788ad/wakaq/exceptions.py#L8">soft</a> and <a rel="nofollow noopener" target="_blank" href="https://github.com/wakatime/wakaq/blob/761d08f06d7d88941491e48d1cb524a1c35788ad/wakaq/worker.py#L370">hard</a> timeout limits</li>
<li>Optionally retry tasks on soft timeouts</li>
<li>Combats memory leaks by restarting workers when <a rel="nofollow noopener" target="_blank" href="https://github.com/wakatime/wakaq/blob/a11d22b6a743e4fb0e220673085297bdc4aab710/wakaq/worker.py#L339">max_mem_percent</a> reached</li>
<li>Super minimal and maintainable</li>
</ul>

<p>Features considered out of scope are rate limiting, exclusive locking, storing task results, and task chaining.
Those are easy to add in your application’s task code, and you probably want to implement these specific to your app’s needs anyway.</p>

<h2>WakaQ is ready to use</h2>

<p><a rel="nofollow noopener" target="_blank" href="https://github.com/wakatime/wakaq">WakaQ</a> is stable and ready to use in production.
WakaQ currently powers all background tasks in prod for the <a rel="nofollow noopener" target="_blank" href="https://wakatime.com/">WakaTime</a> website, including but not limited to:</p>

<ul>
<li>sending code stats email reports</li>
<li>renewing our LetsEncrypt SSL certs</li>
<li>pre caching dashboards, repo badges, and embeddable charts</li>
<li>anything else we don’t want holding up the web requests</li>
</ul>

<p>It’s released under a <a rel="nofollow noopener" target="_blank" href="https://github.com/wakatime/wakaq/blob/main/LICENSE">BSD license</a>, so you can use it in open and closed source projects.
If you find any bugs please <a rel="nofollow noopener" target="_blank" href="https://github.com/wakatime/wakaq/issues">open an issue</a>, but think twice before requesting new features :-)</p>

<p>Happy coding!</p>

<p>- <a rel="nofollow noopener" target="_blank" href="https://wakatime.com/@alan">Alan</a> from <a rel="nofollow noopener" target="_blank" href="https://wakatime.com/">WakaTime</a></p>

  
</div></div>
  </body>
</html>
