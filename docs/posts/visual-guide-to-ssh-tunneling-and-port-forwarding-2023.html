<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ittavern.com/visual-guide-to-ssh-tunneling-and-port-forwarding/">Original</a>
    <h1>Visual guide to SSH tunneling and port forwarding (2023)</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>To make it quick, I wish I had known about port forwarding and tunneling earlier. With this blog post, I try to understand it better myself and share some experiences and tips with you.</p>
<p><strong>Topics</strong>: use cases, configuration, SSH jumphosts, local/remote/dynamic port forwarding, and limitations</p>
<h2 id="use-cases-a-hrefuse-cases-iduse-casesa">Use cases <a href="#use-cases" id="use-cases">#</a></h2>
<p>SSH tunneling and port forwarding can be used to forward TCP traffic over a secure SSH connection from the SSH client to the SSH server, or vice versa. TCP ports or UNIX sockets can be used, but in this post I’ll focus on TCP ports only.</p>
<p>I won’t go into details, but the following post should show enough examples and options to find use in your day-to-day work.</p>
<dl>
<dt>Security:</dt>
<dd>encrypt insecure connections (FTP, other legacy protocols)</dd>
<dd>access web admin panels via secure SSH tunnel (Pub Key Authentication)</dd>
<dd>having potentially less ports exposed (only 22, instead of additional 80/443)</dd>
<dt>Troubleshooting:</dt>
<dd>bypassing firewalls/content filters</dd>
<dd>choosing different routes</dd>
<dt>Connection:</dt>
<dd>reach server behind NAT</dd>
<dd>use jumphost to reach internal servers over the internet</dd>
<dd>exposing local ports to the internet</dd>
</dl>
<p>There are many more use cases, but this overview should give you a sense of possibilities.</p>

<p>Before we start: the options of the following examples and be combined and configured to suit your setup. As a side note: if the <code>bind_address</code> isn’t set, localhost will be the default</p>
<h2 id="configuration--preparation-a-hrefconfiguration-idconfigurationa">Configuration / Preparation <a href="#configuration" id="configuration">#</a></h2>
<ul>
<li>The <strong>local and remote users must have the necessary permissions</strong> on the local and remote machines respectivly to open ports. <strong>Ports between 0-1024 require root privileges</strong> - if not configured differently - and the rest of the ports can be configured by standard users.</li>
<li><strong>configure clients and network firewalls accordingly</strong></li>
</ul>
<dl>
<dt>SSH port forwarding must be enabled on the server:</dt>
<dd><code>AllowTcpForwarding yes</code></dd>
<dd><em>It is enabled by default, if I recall it correctly</em></dd>
<dt>If you forward ports on interfaces other than 127.0.01, then you’ll need to enable <code>GatewayPorts</code> on the SSH server:</dt>
<dd><code>GatewayPorts yes</code></dd>
</dl>
<p>Remember to <strong>restart the ssh server service</strong>.</p>
<h2 id="ssh-jumphost--ssh-tunnel-a-hrefjumphost-idjumphosta">SSH jumphost / SSH tunnel <a href="#jumphost" id="jumphost">#</a></h2>
<p>Transparently connecting to a remote host through one or more hosts.</p>
<p><code>ssh -J user@REMOTE-MACHINE:22 -p 22 user@10.99.99.1</code></p>
<p><img src="https://ittavern.com/images/blog/ssh-jh-1.png" alt="ssh-port-forwarding-info"/></p>
<p><strong>Side note</strong>: The port addressing can be removed, if the default port 22 is used!</p>
<p>On REMOTE-MACHINE as jumphost:</p>
<pre><code>[user@REMOTE-MACHINE]$ ss | grep -i ssh
tcp   ESTAB 0      0                                             167.135.173.108:ssh    192.160.140.207:45960
tcp   ESTAB 0      0                                             10.99.99.2:49770      10.99.99.1:ssh
</code></pre>
<dl>
<dt>Explanation:</dt>
<dd><code>167.135.173.108</code> - public IP of REMOTE-MACHINE</dd>
<dd><code>92.160.120.207</code> - public IP of LOCAL-MACHINE</dd>
<dd><code>10.99.99.2</code> - internal IP of REMOTE-MACHINE</dd>
<dd><code>10.99.99.1</code> - internal IP of REMOTE-WEBAPP</dd>
</dl>
<h4 id="using-multiple-jumphosts">Using multiple jumphosts</h4>
<dl>
<dt>Jumphosts must be separated by commas:</dt>
<dd><code>ssh -J user@REMOTE-MACHINE:22,user@ANOTHER-REMOTE-MACHINE:22 -p 22 user@10.99.99.1</code></dd>
</dl>
<h2 id="local-port-forwarding-a-hreflocal-port-forwarding-idlocal-port-forwardinga">Local Port Forwarding <a href="#local-port-forwarding" id="local-port-forwarding">#</a></h2>
<h4 id="example-1">Example 1</h4>
<p><code>ssh -L 10.10.10.1:8001:localhost:8000 user@REMOTE-MACHINE</code></p>
<p><img src="https://ittavern.com/images/blog/ssh-lpf-1.png" alt="ssh-port-forwarding-info"/></p>
<dl>
<dt>Access logs of the webserver on REMOTE-MACHINE that only listens on 127.0.0.1:</dt>
<dd><code>127.0.0.1 - - [30/Dec/2022 18:05:15] &#34;GET / HTTP/1.1&#34; 200</code></dd>
<dd>the request originates from LOCAL-MACHINE</dd>
</dl>
<h4 id="example-2">Example 2</h4>
<p><code>ssh -L 8001:10.99.99.1:8000 user@REMOTE-MACHINE</code></p>
<p><img src="https://ittavern.com/images/blog/ssh-lpf-2.png" alt="ssh-port-forwarding-info"/></p>
<dl>
<dt>Access logs of the webserver on REMOTE-WEBAPP:</dt>
<dd><code>10.99.99.2 - - [30/Dec/2022 21:28:42] &#34;GET / HTTP/1.1&#34; 200</code></dd>
<dd>the request originates from the intern IP of LOCAL-MACHINE (10.99.99.2)</dd>
</dl>
<h2 id="remote-port-forwarding-a-hrefremote-port-forwarding-idremote-port-forwardinga">Remote Port Forwarding <a href="#remote-port-forwarding" id="remote-port-forwarding">#</a></h2>
<h4 id="example-12">Example 1+2</h4>
<p><code>ssh -R 8000:localhost:8001 user@REMOTE-MACHINE</code></p>
<p><img src="https://ittavern.com/images/blog/ssh-rpf-1.png" alt="ssh-port-forwarding-info"/></p>
<p><code>ssh -R 8000:10.10.10.2:8001 user@REMOTE-MACHINE</code></p>
<p><img src="https://ittavern.com/images/blog/ssh-rpf-2.png" alt="ssh-port-forwarding-info"/></p>
<h4 id="example-3">Example 3</h4>
<p><code>ssh -R 10.99.99.2:8000:10.10.10.2:8001 user@REMOTE-MACHINE</code></p>
<p><img src="https://ittavern.com/images/blog/ssh-rpf-3.png" alt="ssh-port-forwarding-info"/></p>
<p><strong>Important</strong>: <code>GatewayPorts yes</code> must be enabled on the SSH server to listen on another interface than the loopback interface.</p>
<h2 id="dynamic-port-forwarding-a-hrefdynamic-port-forwarding-iddynamic-port-forwardinga">Dynamic port forwarding <a href="#dynamic-port-forwarding" id="dynamic-port-forwarding">#</a></h2>
<p>To forward more than one port, SSH uses the <a href="https://en.wikipedia.org/wiki/SOCKS">SOCKS</a> protocol. This is a transparent proxy protocol and SSH makes us of the most recent version SOCKS5.</p>
<p>Default port for SOCKS5 server is 1080 as defined in <a href="https://datatracker.ietf.org/doc/html/rfc1928">RFC 1928</a>.</p>
<p>The client must be configured correctly to use a SOCKS proxy. Either on the application or OS layer.</p>
<h4 id="example">Example</h4>
<p><code>ssh -D 10.10.10.1:5555 user@REMOTE-MACHINE</code></p>
<p><img src="https://ittavern.com/images/blog/ssh-dpf-1.png" alt="ssh-port-forwarding-info"/></p>
<dl>
<dt>Use <code>curl</code> on a ‘LOCAL’ client to test the correct connection/path:</dt>
<dd><code>curl -L -x socks5://10.10.10.1:5555 brrl.net/ip</code></dd>
<dd><em>If everything works out, you should get the public IP of the REMOTE-MACHINE back</em></dd>
</dl>
<h2 id="ssh-tuntap-tunneling">SSH TUN/TAP tunneling</h2>
<p>I won’t go into detail, but you can create a bi-directional TCP tunnel with the <code>-w</code> flag. The interfaces must be created beforehand, and I haven’t tested it yet.</p>
<p><code>-w local_tun[:remote_tun]</code></p>
<h2 id="how-to-run-ssh-in-the-background-a-hrefbackground-idbackgrounda">How to run SSH in the background <a href="#background" id="background">#</a></h2>
<dl>
<dt>The native way to run the tunnel in the background would be <code>-fN</code>:</dt>
<dd><code>-f</code> - run in the background</dd>
<dd><code>-N</code> - no shell</dd>
</dl>
<p><code>ssh -fN -L 8001:127.0.0.1:8000 user@REMOTE-MACHINE</code></p>
<p>Others than that: use screen or some other tools.</p>
<h4 id="stop-the-ssh-running-in-the-background">Stop the SSH running in the background</h4>
<pre><code>user@pleasejustwork:~$ ps -ef | grep ssh
[...]
user      19255       1  0 11:40 ?        00:00:00 ssh -fN -L 8001:127.0.0.1:8000 user@REMOTE-MACHINE
[...]
</code></pre>
<dl>
<dt>Kill the process with the PID:</dt>
<dd><code>kill 19255</code></dd>
</dl>
<h2 id="keep-ssh-connection-alive">Keep SSH connection alive</h2>
<p>I won’t go into detail, but there are different ways to keep the SSH connection alive.</p>
<h4 id="handle-timeouts-with-heartbeats">Handle timeouts with heartbeats</h4>
<p>Both options can be set on the client or server, or both.</p>
<dl>
<dt><code>ClientAliveInterval</code> will send a request every <code>n</code> seconds to keep the connection alive:</dt>
<dd><code>ClientAliveInterval 15</code></dd>
<dt><code>ClientAliveCountMax</code> is the number of heartbeat requests sent after not receiving an respond from the other side of the connection before terminating the connection:</dt>
<dd><code>ClientAliveCountMax 3</code></dd>
<dd><code>3</code> is the default, and setting it to <code>0</code> will disable connection termination. In this example, the connection would drop after around 45 seconds without any responds.</dd>
</dl>
<h4 id="reconnecting-after-termination">Reconnecting after termination</h4>
<p>There are mutliple ways to do it; autossh, scripts, cronjobs, and so on.</p>
<p>This is beyond this post and I might write about in the future.</p>
<h2 id="limitations-a-hreflimitations-idlimitationsa">Limitations <a href="#limitations" id="limitations">#</a></h2>
<h4 id="udp">UDP</h4>
<p>SSH depends on a reliable delivery to be able to decrypt everything correctly. UDP does not offer any reliability and is therefore not supported and recommended to use over the SSH tunnel.</p>
<p>That said, there are ways to do it as described in <a href="http://zarb.org/~gc/html/udp-in-ssh-tunneling.html">this post</a>. I still need to test it.</p>
<h4 id="tcp-over-tcp">TCP-over-TCP</h4>
<p>It lowers the throughput due to more overhead and increases the latency. On connections with packet loss or high latencies (e.x. satellite) it can cause a <a href="https://openvpn.net/faq/what-is-tcp-meltdown/">TCP meltdown</a>.</p>
<p><a href="http://sites.inka.de/sites/bigred/devel/tcp-tcp.html">This post</a> is a great write-up.</p>
<p>Nevertheless, I’d been using OpenVPN-over-TCP for a while, and it worked flawlessly. Less throughput than UDP, but reliable. So, it highly depends on your setup.</p>
<h4 id="not-a-vpn-replacement">Not a VPN replacement</h4>
<p>Overall, it is not a VPN replacement. SSH tunneling can be used as such, but a VPN is better suited for better performance.</p>
<h4 id="potential-security-risk">Potential security risk</h4>
<p>If you do not need those features, it is recommended to turn them of. Threat actors could use said features to avoid firewalls and other security measures.</p>
<hr/>
<dl>
<dt>General links:</dt>
<dd><a href="https://www.man7.org/linux/man-pages/man1/ssh.1.html">SSH manual</a></dd>
<dd><a href="https://www.man7.org/linux/man-pages/man5/sshd_config.5.html">sshd_config manual</a></dd>
</dl>
<p>The inspiration of this blog post are the following <a href="https://unix.stackexchange.com/a/115906">unix.stackexchange answer</a> and <a href="http://dirk-loss.de/ssh-port-forwarding.htm">blog post of Dirk Loss</a>.</p>
<p>Thanks to Frank and ruffy for valuable feedback!</p>
<hr/>


<hr/>





<hr/>
<b>Most recent Articles:</b>


  <li><a href="https://ittavern.com/dummy-ip-and-mac-addresses-for-documentation-and-sanitization/">Dummy IP &amp; MAC Addresses for Documentation &amp; Sanitization</a></li>

  <li><a href="https://ittavern.com/deploying-isso-commenting-system-for-static-content-using-docker/">Deploying ISSO Commenting System for Static Content using Docker</a></li>

  <li><a href="https://ittavern.com/generate-a-vanity-v3-hidden-service-onion-address-with-mkp224o/">Generate a Vanity v3 Hidden Service Onion Address with mkp224o</a></li>

  <li><a href="https://ittavern.com/ssh-audit-primer-audit-your-ssh-server/">ssh-audit Primer - Audit your SSH Server</a></li>

  <li><a href="https://ittavern.com/mtr-more-detailed-traceroute/">mtr - More Detailed Traceroute - Network Troubleshooting</a></li>


</div></div>
  </body>
</html>
