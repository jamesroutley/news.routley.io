<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://colincogle.name/blog/byo-weather-station/">Original</a>
    <h1>Putting a dumb weather station on the internet</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody text">
					<section id="sec1">
						<header><h2>The Problem</h2></header>
						<p>
							Perhaps it&#39;s apartment life cramping my <abbr title="High Frequency">HF</abbr> style, but I&#39;ve been into <abbr title="Automatic Packet Reporting System">APRS</abbr> ever since I got into ham radio.  It&#39;s an interesting way to share little bits of data with the world such as messages, positions, and weather information.
						</p>
						<p>
							As such, there are many commercial weather stations available that one can buy and hook up, and they will share their measurements via APRS, using either radio or the Internet (the latter is called <abbr title="Automatic Packet Reporting System - Internet Service">APRS-IS</abbr>).  I&#39;ve seen some online, and they&#39;re great.  Some of them can measure temperature, humidity, precipiation, wind, radiation, light intensity, and more.  The major downside, though, is that these are expensive and cumbersome.
						</p>
						<p>
							There are few hobbies that really embrace the hacker ethos, and amateur radio is one of them.  It&#39;s the only service where the <abbr title="Federal Communications Commission">FCC</abbr> explicitly allows operators to build their own compliant equipment.
						</p>
						<figure>
							<picture>
								<source srcset="bilbo.avif" type="image/avif"/>
								<source srcset="bilbo.webp" type="image/webp"/>
								<img src="https://hazure.neocities.org/articles/bilbo.jpg" lowsrc="bilbo@lowsrc.jpg" alt="A meme featuring Bilbo Baggins from Peter Jackson&#39;s &#34;The Lord of the Rings: The Fellowship of the Ring&#34;, contemplating wearing The One Ring.  Text: &#34;After all, why not?  Why shouldn&#39;t I build my own ham radio equipment?&#34;" longdesc="https://knowyourmeme.com/memes/after-all-why-not-why-shouldnt-i-keep-it" loading="lazy"/>
							</picture>
							<figcaption>Time is money, and sometimes, you have more money than time.  This is not one of those cases.</figcaption>
						</figure>
					</section>

					<section id="sec2">
						<header><h2>The Hardware</h2></header>
						<p>
							So, I picked up a nondescript wireless indoor/outdoor thermometer from Temu.  This is a barebones kit, lacking even a brand name, but it works very well.  A battery-powered transmitter goes outside, and a base station sits inside.  Like most things, this uses the 433 <abbr title="megahertz">MHz</abbr> band like many other consumer electronics.  After a simple pairing procedure that&#39;s no more complicated than pressing two buttons, the transmitter says, <q>It&#39;s 25 degrees outside,</q> and the base station shows that number on the screen.
						</p>
						<figure>
							<picture>
								<source srcset="transmitter.avif" type="image/avif"/>
								<source srcset="transmitter.jxl" type="image/jxl"/>
								<source srcset="transmitter.webp" type="image/webp"/>
								<img src="https://hazure.neocities.org/articles/transmitter.jpg" lowsrc="transmitter@lowsrc.jpg" alt="The outdoor transmitter to my weather station, snuggled up under the porch stairs.  Christmas lights are visible nearby." loading="lazy"/>
							</picture>
							<figcaption>No, the LED Christmas lights don&#39;t affect the temperature readings.</figcaption>
						</figure>
						<p>
							It&#39;s about as simple as it gets.  Being cheap, it&#39;s powered by alkaline batteries, transmits on a common frequency using a radio that was probably bought by the pallet, and does not encrypt the signal over the air.  We&#39;re going to use this to our advantage.
						</p>
						<p>
							Years ago, I bought an RTL-<abbr title="Software Defined Radio">SDR</abbr> for no good reason.  First designed to let computers listen to <abbr title="Digital Video Broadcasting - Terrestrial">DVB-T</abbr> television signals, hackers quickly found out that this little <abbr title="Universal Serial Bus">USB</abbr> dongle can listen to just about any frequency.  The included antenna somewhat limits the product, but for what I need it for, it&#39;ll be perfect.
						</p>
						<p>
							I have my desktop computer near the window, so it can pick up the signals from the transmitter.  If you don&#39;t have that luxury, grab a Raspberry Pi or other single-board computer.  Connecting it to the Internet is left as an exercise to the reader.
						</p>
					</section>

					<section id="sec3">
						<header><h2>The Parser</h2></header>
						<p>
							<a rel="external related" href="https://github.com/merbanan/rtl_433">The <code>rtl_433</code> app</a> is an open-source decoder for signals on the 433 <abbr title="megahertz">MHz</abbr> band.  Once your SDR dongle is connected to your computer, you can simply run the <code>rtl_433</code> command-line app and watch for periodic broadcasts from your weather stations&#39; transmitters.
						</p>
						<figure>
							<picture>
								<source srcset="rtl_433.jxl" type="image/jxl"/>
								<source srcset="rtl_433.webp" type="image/webp"/>
								<img src="https://hazure.neocities.org/articles/rtl_433.png" lowsrc="rtl_433@lowsrc.png" alt="Terminal output of the rtl_433 command.  Aside from showing some noise level adjustments, there are a few lines of JSON data from various sensors in my neighborhood, including my weather station&#39;s transmitter." loading="lazy"/>
							</picture>
							<figcaption>It&#39;s not much to look at, but this step doesn&#39;t make things pretty.  That&#39;s happening later.</figcaption>
						</figure>
						<p>
							Once I got a feel for the data being transmitted, I messed around with command-line options until I got the output just the way I like it.
						</p>
						<figure>
							<code>
								<span>
									<nobr>rtl_433</nobr>
									<nobr title="M for metadata">-M <span>time:iso</span></nobr>
									<nobr title="M for metadata">-M <span>protocol</span></nobr>
									<nobr title="M for metadata">-M <span>level</span></nobr>
									<nobr title="C for conversion">-C <span>customary</span></nobr>
									<nobr title="g for gain">-g <span>0</span></nobr>
									<nobr title="Y for minimum level detection">-Y <span>autolevel</span></nobr>
									<nobr title="M for metadata">-M <span>noise</span></nobr>
									<nobr title="f for frequency">-f <span title="433.9 MHz">433.90M</span></nobr>
									<nobr title="F for output format">-F <span>log</span></nobr>
									<nobr title="F for output format">-F <span>syslog:127.0.0.1:42069</span></nobr>
									<nobr title="v, once, for a little more verbosity">-v</nobr>
								</span>
							</code>
							<figcaption>Of everything here, the most important options are the ones to emit sniffed data in the <abbr title="JavaScript Object Notation" aria-label="jason">JSON</abbr> format, and the option to send it to localhost on port 42069.  More on that later.</figcaption>
						</figure>
						<p>
							You can save this as a shell script and run it to build a daemon that will sniff your weather station&#39;s data and send it somewhere for processing.  In the next section, we&#39;ll build that somewhere.
						</p>
					</section>

					<section id="sec4">
						<header><h2>The Uploader</h2></header>
						<p>
							People who have been following me for a while know that I&#39;ve written a popular command-line tool called <a rel="external related" href="https://github.com/rhymeswithmogul/aprs-weather-submit"><code>aprs-weather-submit</code></a>.  As I said <a href="https://hazure.neocities.org/blog/aprs-weather-submit" title="Another blog post for you" rel="prev related" rev="next related">when I first introduced it to the world</a>, it lets you send out arbitrary weather data.  While you can go outside, eyeball a thermometer, then come back inside to report it, I&#39;d intended for enterprising hackers to use it to bring their own weather data to the Internet of Things.  This is no exception!
						</p>
						<p>
							Now, my Bash skills aren&#39;t that great, and I didn&#39;t feel like sitting down and writing a data parser in C (at least not yet).  So, I turned to another of my cross-platform language skills, <a rel="tag" href="https://hazure.neocities.org/tags/PowerShell">PowerShell</a>.
						</p>
						<p>
							To make your lives easier, <a href="https://hazure.neocities.org/articles/WeatherStationParser.ps1" type="text/plain">you can view and save my parser and uploader script</a>.  I&#39;ll summarize it briefly for you:
						</p>
						<ol>
							<li>The script starts a UDP listener on 127.0.0.1:42069 (by default).  That will listen for data sent by <code>rtl_433</code>.</li>
							<li>Ignore any data that&#39;s not from a weather station.</li>
							<li>Ignore any data that&#39;s not from <em>my</em> weather station.</li>
							<li>Parse out the temperature and humidity.</li>
							<li><code>aprs-weather-submit</code> is called with the hardcoded callsign and <abbr title="service set identifier">SSID</abbr>, hardcoded location, and the weather data.  It&#39;s all sent to the <a rel="external noopener" href="https://www.aprs2.net">Tier 2 APRS servers</a>, and nodes may digipeat it over <abbr title="radio frequency">RF</abbr>.</li>
							<li>The current time, temperature, and humidity are saved.  The weather station may broadcast a few times a minute, but it&#39;s considered rude to emit duplicate APRS packets more than once every ten minutes, so if the weather isn&#39;t changing, we&#39;re not going to spam the airwaves.</li>
						</ol>
						<p>
							My particular weather station can only sense temperature and humidity.  Other sensors might be able to detect barometric pressure.  If yours reports more or less data than mine, you can update the PowerShell script to include that.  <code>aprs-weather-submit</code> supports any environmental data defined in <a rel="external noopener" href="http://www.aprs.org/doc/APRS101.PDF" type="application/pdf">the APRS specification</a> and its addenda.
						</p>
						<p>
							At this point, we&#39;ve connected the Temu weather station to the Internet and the ham radio network.  Anyone with an APRS-enabled radio, digipeater, receiver, or <a rel="external noopener" href="https://aprs.to/station/station.php?id=921976">just a web browser</a> can see what the temperature and humidity are at my house.
						</p>
						<p>
							But not everyone has an amateur radio license, and some of those who do don&#39;t have the equipment to listen to APRS packets.  Now, if you read the script, you&#39;ll see some stuff about Mastodon in there.  What&#39;s going on with that?
						</p>
					</section>

					<section id="sec5">
						<header><h2>The Tooter</h2></header>
						<p>
							Not content with sharing my data via APRS, I decided to be even crazier and share out my data via Mastodon.  This federated social network that succeeded the former birdsite welcomes bots (that openly identify as bots), so I decided to create an account for this.  <a rel="external me noopener" href="https://mastodon.colincogle.name/@colin" title="Follow @colin@colincogle.name on Mastodon!">I run my own Mastodon instance</a>, so I was able to create <a rel="external related noopener" href="https://mastodon.colincogle.name/@weather" title="Follow @weather@colincogle.name on Mastodon, if you dare.">a bot account for my weather station</a>.  However, you should have no issues creating a second account on any Mastodon instance.  Edit the profile, images, links, and whatnot to your liking.
						</p>
						<p>
							Once you&#39;re in your account settings, look for the options to create an <abbr title="Application Programming Interface">API</abbr> token.  Save it somewhere secure.  It&#39;s considered bad practice to hardcode it into your script, but I&#39;m going to do it anyway, because this is just for me and it runs on my home computer.
						</p>
						<p>
							Once you have that server address and the authorization token pasted into the PowerShell script, this script will toot no more than once per hour.  Any more and we risk alienating anyone who&#39;s crazy enough to follow this bot account.
						</p>
						<figure>
							<div>
								<blockquote data-embed-url="https://mastodon.colincogle.name/@weather/113637639999983315/embed">
									<a href="https://mastodon.colincogle.name/@weather/113637639999983315" target="_blank" rel="external related">
										<picture>
											<source srcset="weather-toot.avif" type="image/avif"/>
											<source srcset="weather-toot.jxl" type="image/jxl"/>
											<source srcset="weather-toot.webp" type="image/webp"/>
											<img src="https://hazure.neocities.org/articles/weather-toot.png" lowsrc="weather-toot@lowsrc.png" alt="The first Mastodon post by @weather@colincogle.name.  It reads: &#34;The current temperature is 7.2°C (44.96°F) with 93% humidity.  It&#39;s chilly out here!&#34;" loading="lazy" longdesc="https://mastodon.colincogle.name/@weather/113637639999983315/embed"/>
										</picture>
									</a>
								</blockquote>
								<picture>
									<source srcset="weather-toot.avif" type="image/avif"/>
									<source srcset="weather-toot.jxl" type="image/jxl"/>
									<source srcset="weather-toot.webp" type="image/webp"/>
									<img src="https://hazure.neocities.org/articles/weather-toot.png" lowsrc="weather-toot@lowsrc.png" alt="The first Mastodon post by @weather@colincogle.name.  It reads: &#34;The current temperature is 7.2°C (44.96°F) with 93% humidity.  It&#39;s chilly out here!&#34;" loading="lazy" longdesc="https://mastodon.colincogle.name/@weather/113637639999983315/embed"/>
								</picture>
							</div>
							<figcaption>The first toot from my weather station.  Rather inauspicious, but it does exactly what it&#39;s told.</figcaption>
						</figure>
						<p>
							With that, our little experiment is complete!  You can use an APRS app to check the weather at home, or simply open up Mastodon and look for the last toot from your weather station&#39;s account!
						</p>
					</section>
				</div></div>
  </body>
</html>
