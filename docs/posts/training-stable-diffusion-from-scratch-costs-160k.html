<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.mosaicml.com/blog/training-stable-diffusion-from-scratch-costs-160k">Original</a>
    <h1>Training Stable Diffusion from Scratch Costs &lt;$160k</h1>
    
    <div id="readability-page-1" class="page"><div><p>We wanted to know how much time (and money) it would cost to train a Stable Diffusion model from scratch using our Streaming datasets, Composer, and MosaicML Cloud Platform. Our results: it would take us 79,000 A100-hours in 13 days, for a total training cost of less than $160,000. Our tooling not only reduces time and cost by 2.5x, but it is also extensible and simple to use.</p></div><div><div><blockquote> <h3> Try out our Stable Diffusion code <a href="https://github.com/mosaicml/diffusion-benchmark">here!</a>   </h3> </blockquote></div><p>The <a href="https://www.nytimes.com/2023/01/07/technology/generative-ai-chatgpt-investments.html" target="_blank">AI world is buzzing</a> with the power of large generative neural networks such as ChatGPT, Stable Diffusion, and more. These models are capable of impressive performance on a wide range of tasks, but due to their size and complexity, only a handful of organizations have the ability to train them. As a consequence, access to these models can be restricted by the organization that owns them, and users have no control over the data the model has seen during training. </p><p>That’s how we can help: at MosaicML, we make it easier to train large models efficiently, enabling more organizations to train <strong>their own models</strong> on <strong>their own data</strong>. As shown in a <a href="https://www.mosaicml.com/blog/gpt-3-quality-for-500k" target="_blank">previous blog post</a>, our <a href="https://github.com/mosaicml/streaming" target="_blank">StreamingDataset library</a>, our training framework <a href="https://github.com/mosaicml/composer" target="_blank">Composer</a>, and our <a href="https://www.mosaicml.com/blog/introducing-mosaicml-cloud" target="_blank">MosaicML Cloud</a> platform significantly simplify the process of <a href="https://www.mosaicml.com/blog/gpt-3-quality-for-500k" target="_blank">training large language models</a> (LLMs). For this blog post, we used that same process to measure the time and cost to train a <a href="https://stablediffusionweb.com/" target="_blank">Stable Diffusion model</a> from scratch. We estimated an upper-bound of <strong>79,000 A100-hours to train Stable Diffusion v2 base in 13 days on our MosaicML Cloud platform, corresponding to a total training cost of less than $160,000.</strong> This is a 2.5x reduction in the time and cost reported in the <a href="https://huggingface.co/stabilityai/stable-diffusion-2-base">model card</a> from Stability AI. In addition to saving time and money, our Streaming, Composer, and MosaicML Cloud tools make it dead-simple to set up and scale Stable Diffusion training across hundreds of GPUs without any additional effort. The code we used for this experiment is open-source and ready to run; check it out <a href="https://github.com/mosaicml/diffusion-benchmark">here</a>! And if you’re interested in training diffusion models yourself on the MosaicML Cloud, <a href="https://forms.mosaicml.com/demo">contact us for a demo</a>.</p><h2><strong>Time and Cost Estimates</strong></h2><p><strong>Table 1</strong> and <strong>Figure 1</strong> below illustrate how the Stable Diffusion V2 base training time and cost estimates vary by the number of GPUs used. Our final estimate for 256 A100s is 12.83 days to train with a cost of $160,000, a 2.5x reduction in the time and cost reported in the Stable Diffusion <a href="https://huggingface.co/stabilityai/stable-diffusion-2-base">model card</a>. These estimates were calculated using measured throughput and assumed training on 2.9 billion samples. Throughput was measured by training on 512x512 resolution images and captions with a max tokenized length of 77. We scaled GPUs from 8 to 128 NVIDIA 40GB A100s, then extrapolated throughput to 256 A100s based on these measurements.</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><p><img src="https://assets-global.website-files.com/61fd4eb76a8d78bc0676b47d/63cf7cb6264c4050ed2ea00e_Screen%20Shot%202023-01-23%20at%2010.37.19%20PM.png" loading="lazy" alt=""/></p><figcaption><strong><em>Table 1</em></strong><em>: Time and cost estimates to train a Stable Diffusion model on 2.9 billion samples when increasing the number of NVIDIA 40GB A100 GPUs. Throughput measurements were done with a global batch size of 2048 and a per device microbatch size of 4. *256 A100 throughput was extrapolated using the other throughput measurements.  </em></figcaption></figure><figure class="w-richtext-align-center w-richtext-figure-type-image"><p><img src="https://assets-global.website-files.com/61fd4eb76a8d78bc0676b47d/63cf62e0d9dfa570fca02620_Figure1.png" loading="lazy" alt=""/></p><figcaption><strong><em>Figure 1: </em></strong><em>Plot of days to train versus number of NVIDIA 40GB A100 GPUs. “Measured” indicates empirically verified throughput numbers. “Predicted” demonstrates how we estimated throughput at 256 GPUs.</em></figcaption></figure><h2><strong>Benchmark Setup</strong></h2><p>How did we get these results? We took advantage of a MosaicML Streaming dataset, our Composer training framework, and the MosaicML Cloud to measure throughput when training a Stable Diffusion model. You can reproduce our results using the code in <a href="https://github.com/mosaicml/diffusion-benchmark" target="_blank">this repo</a>. Read on for more details:</p><h3><strong>Streaming</strong></h3><p>A major pain point when training Stable Diffusion is working with enormous datasets such as <a href="https://laion.ai/blog/laion-5b/" target="_blank">LAION-5B</a>. The <a href="https://github.com/mosaicml/streaming" target="_blank">MosaicML StreamingDataset library</a> makes it significantly easier to manage and use these massive datasets. It works by converting the target dataset into a Streaming format, then storing the converted dataset to the desired cloud storage (e.g. an AWS S3 bucket). To use the stored dataset, we simply define a “StreamingDataset” class that pulls and transforms samples from the stored dataset. </p><p>For our results, we streamed a subset of the <a href="https://laion.ai/blog/laion-400-open-dataset/" target="_blank">LAION-400M</a> dataset with 256x256 images and their associated captions. Images were resized to 512x512 for final throughput measurements. We estimated the Streaming data loader throughput to be at least 30x higher than model throughput in all configurations we tested, so we’re unlikely to see data loader-related bottlenecks anytime soon. Check out our <a href="https://github.com/mosaicml/diffusion-benchmark/tree/main/data.py" target="_blank">data script</a> to see how we defined our streaming dataset and watch out for our soon-to-be-released Streaming blog post for more details!</p><h3><strong>Composer</strong></h3><p>Our open-source <a href="https://composer.dev/" target="_blank">Composer</a> library contains many state-of-the-art methods for accelerating neural network training and improving generalization. For this project, we first defined a <a href="https://docs.mosaicml.com/en/v0.12.0/composer_model.html" target="_blank">ComposerModel</a> for Stable Diffusion using models from <a href="https://huggingface.co/docs/diffusers/index" target="_blank">HuggingFace’s Diffusers library</a> and configs from “stabilityai/stable-diffusion-2-base”. The ComposerModel and Streaming dataset were provided to Composer’s <a href="https://docs.mosaicml.com/en/v0.12.0/trainer/using_the_trainer.html" target="_blank">Trainer</a> with an AdamW optimizer, an EMA algorithm<sup>2</sup>, a throughput measurement callback, and a Weights and Biases logger. Finally, we called “fit()” on the Trainer object to start training. </p><h3><strong>MosaicML Cloud</strong></h3><p><a href="https://cloud.mosaicml.com/" target="_blank">MosaicML Cloud</a> orchestrates and monitors compute infrastructure for large-scale training jobs. Our job scheduler makes launching and scaling jobs easy.<strong> Figure 2</strong> shows the MosaicML Cloud training configuration (left) and the CLI used to launch the training run (right). From the configuration, we can easily scale the number of GPUs with the “gpu_num” parameter. The same code we write for one node can automatically leverage tens of nodes and hundreds of GPUs.</p><figure class="w-richtext-align-center w-richtext-figure-type-image"><p><img src="https://assets-global.website-files.com/61fd4eb76a8d78bc0676b47d/63cf669c60f8f42c1aea5677_Figure2.png" loading="lazy" alt=""/></p><figcaption><strong><em>Figure 2</em></strong><em>: Running multi-node jobs is as easy as changing the “gpu_num” field. </em><strong><em>Left: </em></strong><em>Example MosaicML Cloud training configuration. </em><strong><em>Right: </em></strong><em>Starting a training run with Mosaic CLI (mcli). </em></figcaption></figure><h2><strong>What’s Next?  </strong></h2><p>In this blog post, we estimated a 2.5x reduction in time and cost to train Stable Diffusion when using our Streaming datasets, Composer library, and MosaicML Cloud. This is a great preliminary result, but we’re not done yet. In a future blog post, we’ll verify how we can train to convergence at this speed. For updates on our latest work, join our <a href="https://join.slack.com/t/mosaicml-community/shared_invite/zt-1btms90mc-GipE2ufuPkKY0QBrmF3LSA" target="_blank">Community Slack</a> or follow us on <a href="https://twitter.com/MosaicML">Twitter</a>. If your organization wants to start training diffusion models today, you can <a href="https://forms.mosaicml.com/demo" target="_blank">schedule a demo online</a> or email us at <a href="mailto:demo@mosaicml.com">demo@mosaicml.com</a>.</p><p>Notes:</p><ol start="1" role="list"><li><em>Per device microbatch size is related to gradient accumulation, but microbatch size is easier to use when increasing the number of GPUs. Per device microbatch size and gradient accumulation are related as follows: grad_accum = global_batch_size / (n_devices * per_device_microbatch_size). For more details, check out the “device_train_microbatch_size” variable in Composer’s </em><a href="https://docs.mosaicml.com/en/v0.12.0/api_reference/generated/composer.Trainer.html#composer.Trainer" target="_blank"><em>Trainer API reference</em></a><em>.</em></li><li><em>Composer has a built-in </em><a href="https://docs.mosaicml.com/en/v0.12.0/method_cards/ema.html" target="_blank"><em>EMA algorithm</em></a><em>, but we had to improve its memory efficiency for our benchmark hence the EMA implementation in our benchmark repo. We will update the EMA algorithm in Composer to be more memory efficient soon.</em></li></ol></div><div><h2>What’s a Rich Text element?</h2><p>The rich text element allows you to <a href="http://google.com">create and format</a> headings, paragraphs, blockquotes, images, and video all in one place instead of having to add and format them individually. Just double-click and easily create content.</p><h4>Static and dynamic content editing</h4><p>A rich text element can be used with static or dynamic content. For static content, just drop it into any page and begin editing. For dynamic content, add a rich text field to any collection and then connect a rich text element to that field in the settings panel. Voila!</p><h4>How to customize formatting for each rich text</h4><p>Headings, paragraphs, blockquotes, figures, images, and figure captions can all be styled after a class is added to the rich text element using the &#34;When inside of&#34; nested selector system.</p></div></div>
  </body>
</html>
