<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/programming/GoFutureClearBuiltin">Original</a>
    <h1>Go 1.21 may have a clear(x) builtin</h1>
    
    <div id="readability-page-1" class="page"><div><h2>Go 1.21 may have a <code>clear(x)</code> builtin and there&#39;s an interesting reason why</h2>

	<p><small>November 18, 2022</small></p>
</div><div><p>Recently I noticed <a href="https://go-review.googlesource.com/c/go/+/448076">an interesting Go change in the development
version</a>, which
adds type checking of a &#39;<code>clear</code>&#39; builtin function. This was the
first I&#39;d heard of such a thing, but the CL had a helpful link to
the Go issue, <a href="https://github.com/golang/go/issues/56351">proposal: spec: add clear(x) builtin, to clear
map, zero content of slice, ptr-to-array #56351</a>. The title basically
says what it&#39;s about, but it turns out that there&#39;s a surprising
and interesting reason why Go sort of needs this.</p>

<p>On the surface you might think that this wasn&#39;t an important change,
because you can always do this by hand even for maps. While there&#39;s no
built in way to clear a map, you can use a for loop:</p>

<blockquote><pre>for k := range m {
   delete(m, k)
}
</pre>
</blockquote>

<p>This for loop is less efficient than clearing a map in one operation,
but it turns out that there is a subtle tricky issue that makes it
not always work correctly. That issue is maps with <a href="https://en.wikipedia.org/wiki/NaN">floating point
NaNs</a> as keys (well, as the value
of some keys). The moment a NaN is a key in your map, you can&#39;t
delete it this way.</p>

<p>(Really, <a href="https://go.dev/play/p/kzzPWiycpJ-">you can see it in this playground example using math.NaN()</a>.)</p>

<p>The cause of this issue with NaNs in maps is that <a href="https://go.dev/ref/spec#Comparison_operators">Go follows the
IEEE-754 standard for floating point comparison</a>, and under this
standard a NaN is never equal to anything, even another NaN or even
itself. Although formally speaking <a href="https://go.dev/ref/spec#Deletion_of_map_elements"><code>delete()</code> isn&#39;t defined in
terms of specific key equality</a> (in general
<a href="https://go.dev/ref/spec#Map_types">maps don&#39;t quite specify things like that</a>), in practice it works that
way. Since delete() is implicitly based on key equality and NaNs
never compare equal to each other, delete() can never remove key
values that are NaNs, even if you got the key value from a &#39;<code>range</code>&#39;
over the map.</p>

<p>Of course you&#39;re probably not going to deliberately use NaN as a
key value in a map. But you may well use floating point values as
keys, and NaNs might sneak into your floating point values in all
sorts of ways. If they do, and you have code that clears a map this
way, you&#39;re going to get a surprise (hopefully a relatively harmless
one). There&#39;s no way to fix this without changing how maps with
floating point keys handle NaNs, and even that opens up various
questions. Adding a clear() builtin is more efficient and doesn&#39;t
open up the NaN can of worms.</p>

<p>This NaN issue was a surprise to me. Had you asked me before I&#39;d
read <a href="https://github.com/golang/go/issues/56351">the proposal</a>, I
would have expected &#39;clear()&#39; to be added only for efficiency and
clarity. I had no idea there was also a correctness reason to have
it.</p>

<p>(While <a href="https://go-review.googlesource.com/c/go/+/448076">the current change</a> will likely be
in Go 1.20, a clear builtin likely won&#39;t appear until Go 1.21 at
the earliest.)</p>

<p>PS: If you suspect that this implies interesting and disturbing
things for NaNs as key values in maps, you&#39;re correct. But that&#39;s
for another entry.</p>
</div></div>
  </body>
</html>
