<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.loro.dev/blog/loro-now-open-source">Original</a>
    <h1>Loro: Reimagine state management with CRDTs</h1>
    
    <div id="readability-page-1" class="page"><article><main><div><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg><p>Loro Now Open Source: Reimagine State Management with CRDTs</p></div>
<!-- -->

<div><p>Loro, our high-performance CRDTs library, is now open source</p><p>.</p></div>
<p>In this article, we share our vision for the local-first software development paradigm,
explain why we&#39;re excited about it, and discuss the current status of Loro.</p>
<p>With better DevTools, documentation, and a friendly ecosystem, everyone can easily
build local-first software.</p>
<p><img alt="Loro&#39;s &#39;time machine&#39; example" loading="lazy" width="1730" height="1066" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fcolab_and_travel.42fd844b.gif&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fcolab_and_travel.42fd844b.gif&amp;w=3840&amp;q=75 2x" src="https://www.loro.dev/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fcolab_and_travel.42fd844b.gif&amp;w=3840&amp;q=75"/></p>
<div><p>You can build collaborative apps with time travel features easily using Loro.
<a href="https://loro-react-flow-example.vercel.app/" target="_blank" rel="noreferrer">Play the example online<span> (opens in a new tab)</span></a>.</p></div>
<h2>Envisioning the Local-First Development Paradigm<a href="#envisioning-the-local-first-development-paradigm" id="envisioning-the-local-first-development-paradigm" aria-label="Permalink for this section"></a></h2>
<p>Distributed states are commonly found in numerous scenarios, such as multiplayer
games, multi-device document synchronization, and edge networks. These scenarios
require synchronization to achieve consistency, usually entailing elaborate design
and coding. For instance, considerations for network issues or concurrent write operations
are necessary. However, for a wide range of applications CRDTs can simplify the code significantly:</p>
<ul>
<li>CRDTs can automatically merge concurrent writes without conflicts.</li>
<li>Fewer abstractions. There&#39;s no need to design specific backend database schemas,
manually execute expected conflict merges, or implement interfaces to memory and memory to
persistent structure conversions.</li>
<li>Offline supports are right out of the box</li>
</ul>
<details><summary>What are CRDTs</summary></details>
<details><summary>When you can&#39;t use CRDTs</summary></details>
<p>Since the data resides locally, client applications can directly access and
manipulate local data, offering both speed and availability. Additionally,
due to CRDTs&#39; nature, synchronization / real-time collaboration can be achieved without relying on
centralized servers (similar to Git, allowing migration to other platforms
without data loss). With performance improvements, CRDTs increasingly
replace traditional real-time collaboration solutions in various contexts.</p>
<p>This represents a new paradigm. Local-first not only empowers users with control over
their data, but also makes developers&#39; lives easier.</p>
<p><img alt="Local-first" loading="lazy" width="1910" height="1204" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2FUntitled.4966eea6.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2FUntitled.4966eea6.png&amp;w=3840&amp;q=75 2x" src="https://www.loro.dev/_next/image?url=%2F_next%2Fstatic%2Fmedia%2FUntitled.4966eea6.png&amp;w=3840&amp;q=75"/></p>
<p>The annual growth rate of the <em>&#34;local-first&#34;</em> star count in GitHub has reached 40%+.</p>
<h3>Integrating CRDTs with UI State Management<a href="#integrating-crdts-with-ui-state-management" id="integrating-crdts-with-ui-state-management" aria-label="Permalink for this section"></a></h3>
<p><img alt="Loro&#39;s rich text collaboration example" loading="lazy" width="1660" height="720" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Frichtext.62b5791f.gif&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Frichtext.62b5791f.gif&amp;w=3840&amp;q=75 2x" src="https://www.loro.dev/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Frichtext.62b5791f.gif&amp;w=3840&amp;q=75"/></p>
<p>Loro&#39;s rich text collaboration example</p>
<p>Since CRDTs enable conflict-free automatic merging, the challenge with using
CRDTs shifts to &#34;how to express operations and states on CRDTs&#34;.</p>
<p>Front-end state management libraries often necessitate defining the retrieval of
<code dir="ltr">State</code> and the specification of <code dir="ltr">Actions</code>, as illustrated by this example from
Vue&#39;s state management tool, Pinia:</p>
<div><pre data-language="ts" data-theme="default"><code dir="ltr" data-language="ts" data-theme="default"><span><span>export</span><span> </span><span>const</span><span> </span><span>useCartStore</span><span> </span><span>=</span><span> </span><span>defineStore</span><span>({</span></span>
<span><span>  id</span><span>:</span><span> </span><span>&#34;cart&#34;</span><span>,</span></span>
<span><span>  </span><span>state</span><span>:</span><span> () </span><span>=&gt;</span><span> ({</span></span>
<span><span>    rawItems</span><span>:</span><span> [] </span><span>as</span><span> </span><span>string</span><span>[]</span><span>,</span></span>
<span><span>  })</span><span>,</span></span>
<span><span>  getters</span><span>:</span><span> {</span></span>
<span><span>    </span><span>items</span><span>:</span><span> (state)</span><span>:</span><span> </span><span>Array</span><span>&lt;{ name</span><span>:</span><span> </span><span>string</span><span>; amount</span><span>:</span><span> </span><span>number</span><span> }&gt; </span><span>=&gt;</span></span>
<span><span>      </span><span>state</span><span>.</span><span>rawItems</span><span>.reduce</span><span>((items</span><span>,</span><span> item) </span><span>=&gt;</span><span> {</span></span>
<span><span>        </span><span>const</span><span> </span><span>existingItem</span><span> </span><span>=</span><span> </span><span>items</span><span>.find</span><span>((it) </span><span>=&gt;</span><span> </span><span>it</span><span>.name </span><span>===</span><span> item);</span></span>
<span> </span>
<span><span>        </span><span>if</span><span> (</span><span>!</span><span>existingItem) {</span></span>
<span><span>          </span><span>items</span><span>.push</span><span>({ name</span><span>:</span><span> item</span><span>,</span><span> amount</span><span>:</span><span> </span><span>1</span><span> });</span></span>
<span><span>        } </span><span>else</span><span> {</span></span>
<span><span>          </span><span>existingItem</span><span>.amount</span><span>++</span><span>;</span></span>
<span><span>        }</span></span>
<span> </span>
<span><span>        </span><span>return</span><span> items;</span></span>
<span><span>      }</span><span>,</span><span> [] </span><span>as</span><span> </span><span>Array</span><span>&lt;{ name</span><span>:</span><span> </span><span>string</span><span>; amount</span><span>:</span><span> </span><span>number</span><span> }&gt;)</span><span>,</span></span>
<span><span>  }</span><span>,</span></span>
<span><span>  actions</span><span>:</span><span> {</span></span>
<span><span>    </span><span>addItem</span><span>(name</span><span>:</span><span> </span><span>string</span><span>) {</span></span>
<span><span>      </span><span>this</span><span>.</span><span>rawItems</span><span>.push</span><span>(name);</span></span>
<span><span>    }</span><span>,</span></span>
<span> </span>
<span><span>    </span><span>removeItem</span><span>(name</span><span>:</span><span> </span><span>string</span><span>) {</span></span>
<span><span>      </span><span>const</span><span> </span><span>i</span><span> </span><span>=</span><span> </span><span>this</span><span>.</span><span>rawItems</span><span>.lastIndexOf</span><span>(name);</span></span>
<span><span>      </span><span>if</span><span> (i </span><span>&gt;</span><span> </span><span>-</span><span>1</span><span>) </span><span>this</span><span>.</span><span>rawItems</span><span>.splice</span><span>(i</span><span>,</span><span> </span><span>1</span><span>);</span></span>
<span><span>    }</span><span>,</span></span>
<span> </span>
<span><span>    </span><span>async</span><span> </span><span>purchaseItems</span><span>() {</span></span>
<span><span>      </span><span>const</span><span> </span><span>user</span><span> </span><span>=</span><span> </span><span>useUserStore</span><span>();</span></span>
<span><span>      </span><span>if</span><span> (</span><span>!</span><span>user</span><span>.name) </span><span>return</span><span>;</span></span>
<span> </span>
<span><span>      </span><span>console</span><span>.log</span><span>(</span><span>&#34;Purchasing&#34;</span><span>,</span><span> </span><span>this</span><span>.items);</span></span>
<span><span>      </span><span>const</span><span> </span><span>n</span><span> </span><span>=</span><span> </span><span>this</span><span>.</span><span>items</span><span>.</span><span>length</span><span>;</span></span>
<span><span>      </span><span>this</span><span>.rawItems </span><span>=</span><span> [];</span></span>
<span> </span>
<span><span>      </span><span>return</span><span> n;</span></span>
<span><span>    }</span><span>,</span></span>
<span><span>  }</span><span>,</span></span>
<span><span>});</span></span></code></pre></div>
<p>This paradigm and CRDTs are easily compatible: The state in the state management
libraries corresponds to CRDT types, and Action corresponds to a set of
CRDT operations.</p>
<p>Thus, implementing UI state management through CRDTs does not require users to
change their habits. It also has many advanced features:</p>
<ul>
<li>Make states automatically synchronizable / support real-time
collaboration.</li>
<li>Like Git, maintain a complete distributed editing history.</li>
<li>It can store an extensively large editing history with a low memory footprint
and a compact encoding size. Below is an example.</li>
</ul>
<p>With this, you can effortlessly implement products with real-time / async collaboration
and time machine features.</p>
<p><img alt="Tracing a document with 360,000 operations using Loro" loading="lazy" width="800" height="589" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2FUntitled.1382fd32.gif&amp;w=828&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2FUntitled.1382fd32.gif&amp;w=1920&amp;q=75 2x" src="https://www.loro.dev/_next/image?url=%2F_next%2Fstatic%2Fmedia%2FUntitled.1382fd32.gif&amp;w=1920&amp;q=75"/></p>
<div><p>Time travel a document with 360,000+ operations using Loro. To load the whole history and playback, it only takes 8.4MB in memory. And the entire history only takes 361KB in storage.
The editing trace is from </p><p>.</p></div>
<h2>Introduction to Loro<a href="#introduction-to-loro" id="introduction-to-loro" aria-label="Permalink for this section"></a></h2>
<p>Loro is our CRDTs library, now open-sourced under a permissive license. We believe a
cooperative and friendly open-source community is key to creating outstanding
developer experiences.</p>
<p>We aim to make Loro simple to use, extensible, and maintain high performance.
The following is the latest status of Loro.</p>
<h3>CRDTs<a href="#crdts" id="crdts" aria-label="Permalink for this section"></a></h3>
<p>We have explored extensively, supporting a range of CRDT algorithms that have
yet to be widely used.</p>
<h4>OT-like CRDTs<a href="#ot-like-crdts" id="ot-like-crdts" aria-label="Permalink for this section"></a></h4>
<p>Our CRDTs library is built on the brilliant concept of OT-like CRDTs from Seph Gentle&#39;s
<a href="https://github.com/josephg/diamond-types" target="_blank" rel="noreferrer">Diamond-type<span> (opens in a new tab)</span></a>.
Seph Gentle is currently writing a paper on it, which is worth looking forward
to. Its notable features include reducing the cost of local operations, easier
historical data reclamation, and sometimes lower storage and memory overhead.
However, it relies on high-performance algorithms to apply remote operations.
This design has great potential and we are excited about its future.</p>
<details><summary>Brief Introduction to OT-like CRDT algorithms</summary></details>
<h4>Rich Text CRDTs<a href="#rich-text-crdts" id="rich-text-crdts" aria-label="Permalink for this section"></a></h4>
<p>In May of this year, we open-sourced the
<a href="https://github.com/loro-dev/crdt-richtext" target="_blank" rel="noreferrer">crdt-richtext<span> (opens in a new tab)</span></a> project, integrating
the algorithms of the rich text CRDT <a href="https://www.inkandswitch.com/peritext/" target="_blank" rel="noreferrer">Peritext by Ink&amp;Switch<span> (opens in a new tab)</span></a> and
the sequance CRDT <a href="https://arxiv.org/abs/2305.00583" target="_blank" rel="noreferrer">Fugue by Matthew Weidner<span> (opens in a new tab)</span></a>.
A brief introduction to these two algorithms can be found in
<a href="https://www.notion.so/crdt-richtext-Rust-implementation-of-Peritext-and-Fugue-c49ef2a411c0404196170ac8daf066c0?pvs=21" target="_blank" rel="noreferrer">our blog at the time<span> (opens in a new tab)</span></a>.</p>
<p>Based on our experience from previous projects, we have integrated a rich text
CRDT and Fugue into our framework in the current Loro. However, the biggest
challenge was that <a href="https://github.com/inkandswitch/peritext/issues/31" target="_blank" rel="noreferrer">Peritext did not integrate well with OT-like
CRDTs<span> (opens in a new tab)</span></a>. We have recently
overcome this issue. We developed a new rich text CRDT algorithm that can run on
OT-like CRDTs and has passed the capabilities listed in the Peritext paper&#39;s
Criteria for rich text CRDTs, with no new issues revealed in our current million
fuzzing tests. We will write an article in the future specifically to introduce this
algorithm.</p>
<h4>Movable Tree<a href="#movable-tree" id="movable-tree" aria-label="Permalink for this section"></a></h4>
<p>We have also supported a movable tree CRDT. Synchronizing tree movements is often
complex due to the potential for circular references. Addressing this issue
in the distributed environment is even more challenging.</p>
<p>We implemented Martin Kleppmann&#39;s paper, <a href="https://ieeexplore.ieee.org/document/9563274/" target="_blank" rel="noreferrer"><em>A Highly-Available Move Operation for
Replicated Trees</em><span> (opens in a new tab)</span></a>. The idea
of this algorithm is to sort all move operations, ensuring the ordering is consistent
across the replicas. Then, each operation is applied sequentially.
If an operation would cause a circular reference, it has no effect.</p>
<p>We found it to be elegant in design and also performant.
The time complexity of local operations is O(k) (k being the average tree depth, as circular
reference detection is required). For applying remote operations, which entails
inserting new operations into the sorted list, we must undo operations that are
subsequent in the ordering, apply the remote operation, and then redo the undone
operations, with a cost of O(km) (m being the number of operations to undo).</p>
<p><img alt="Untitled" loading="lazy" width="1440" height="810" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2FUntitled%201.213bb232.gif&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2FUntitled%201.213bb232.gif&amp;w=3840&amp;q=75 2x" src="https://www.loro.dev/_next/image?url=%2F_next%2Fstatic%2Fmedia%2FUntitled%201.213bb232.gif&amp;w=3840&amp;q=75"/></p>
<p>Visualization of applying a remote op</p>
<p>Our tests show that local operations involving ten thousand random movements
among a thousand nodes take less than 10ms (tested on an M2 MAX chip). Moreover,
the cost of merging remote operations in this algorithm is similar to applying
remote operations in OT-like CRDTs, making it adoptable. We&#39;ve also
experimented with
<a href="https://madebyevan.com/algos/log-spaced-snapshots/" target="_blank" rel="noreferrer">log-spaced snapshots<span> (opens in a new tab)</span></a> and
immutable data structure approaches in our
<a href="https://github.com/loro-dev/movable-tree" target="_blank" rel="noreferrer">movable-tree project<span> (opens in a new tab)</span></a>, concluding
that the undo + redo method is the fastest and the most memory-efficient.</p>
<h3>Data Structures<a href="#data-structures" id="data-structures" aria-label="Permalink for this section"></a></h3>
<p>Designing and experimenting with data structures is routine in Loro&#39;s
development process.</p>
<p>We previously open-sourced
<a href="https://github.com/loro-dev/generic-btree" target="_blank" rel="noreferrer">generic-btree<span> (opens in a new tab)</span></a> and have redesigned
its structure for a more compact memory layout and cache-friendliness. Besides
its remarkable performance, its flexibility enables us to support various
information types required for Text, like utf16/Unicode code points/utf8, with
minimal code. We also extensively reuse it to fulfill various requirements,
highlighting Rust&#39;s impressive type expression capabilities.</p>
<p>Internally, we&#39;ve
<a href="https://www.loro.dev/docs/advanced/doc_state_and_oplog" target="_blank" rel="noreferrer">separated the document&#39;s state from its history<span> (opens in a new tab)</span></a>.
The state represents the current form of the document, akin to Git&#39;s HEAD
pointer, while the document&#39;s history resembles the complete operation history
behind Git. Hence, multiple document states can correspond to the same history.
This structure simplifies our code and facilitates future support for version
control.</p>
<p>Most of our optimizations thus far have focused on text manipulations, historically
one of the thorniest problems in CRDTs. In the future, we plan optimizations for a
wider range of real-world scenarios.</p>
<h3>The Future<a href="#the-future" id="the-future" aria-label="Permalink for this section"></a></h3>
<p><img alt="Untitled" loading="lazy" width="1630" height="1638" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2FUntitled%202.bc755aa8.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2FUntitled%202.bc755aa8.png&amp;w=3840&amp;q=75 2x" src="https://www.loro.dev/_next/image?url=%2F_next%2Fstatic%2Fmedia%2FUntitled%202.bc755aa8.png&amp;w=3840&amp;q=75"/></p>
<p>We aim to reach version 1.0 by mid-next year, with much work to complete.</p>
<p>Given our limited workforce, we will first provide a WASM interface
for web developers to experiment with. Optimizing the WASM size is one of our
goals for this phase. Much of our design work is still ongoing, and we plan to
stabilize it in the next quarter, aiming for a simple yet powerful and flexible
API. We welcome ideas and suggestions in our <a href="https://discord.gg/tUsBSVfqzf" target="_blank" rel="noreferrer">community discussions<span> (opens in a new tab)</span></a>.</p>
<p>There&#39;s also extensive documentation work to make working with Loro enjoyable.
A potential indicator of success would be GPT generating sufficiently good code
based on our documentation.</p>
<p>Developing tools for developers is a challenging and exciting task.
Many developer tools and visualization methods in front-end development are
exceptionally good, and we hope to bring such experiences into the world of CRDTs and
local-first development. DevTools will reveal CRDTs&#39; hidden states and simplify control,
making state maintenance and debugging a breeze.</p>
<p>We also plan to support richer CRDT semantics, including Movable Lists and global
undo/redo operations to support more diverse application scenarios.</p>
<h2>Seeking Collaborative Project Opportunities<a href="#seeking-collaborative-project-opportunities" id="seeking-collaborative-project-opportunities" aria-label="Permalink for this section"></a></h2>
<p>Our design and optimization efforts need feedback from real-world applications. If you are
excited about a local-first future and think Loro can help you, please contact us directly
at <a href="mailto:zx@loro.dev">zx@loro.dev</a>. We&#39;re open to collaboration and ready to help.</p></main></article></div>
  </body>
</html>
