<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/Articles/867158/">Original</a>
    <h1>Adding a “duress” password with PAM Duress (2021)</h1>
    
    <div id="readability-page-1" class="page"><div>
<center>
           <div><b>Benefits for LWN subscribers</b><p>The primary benefit from <a href="https://lwn.net/subscribe/">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!</p></div>
           </center>
           
<p>
Users often store a lot of sensitive information on their computers—from
credentials to banned texts to family photos—that they might 
normally expect to be 
protected by the login password of their account.  Under some
circumstances, though, users can be required to log into their system so
that some third party (e.g. government agent) can examine and potentially
copy said data. A new project, <a href="https://github.com/nuvious/pam-duress">PAM Duress</a>, provides a way
to add other passwords to an account, each with its own behavior, which
might be a way to avoid granting full access to the system, though the
legality is in question.
</p>

<p>
As its name would imply, PAM Duress is a <a href="https://en.wikipedia.org/wiki/Pluggable_authentication_module">pluggable
authentication module</a> (PAM), which is the mechanism used on Linux and
other Unix operating systems to easily allow adding different kinds of
authentication methods.  PAM is not exactly standardized, however, so
there are multiple implementations of it, including <a href="https://github.com/linux-pam/linux-pam">Linux PAM</a> that is used by
Linux distributions.  The Duress module allows administrators to configure
the system to check for one or more extra passwords if the normal password
associated with the user account does not match what is provided.
</p>

<p>
The project page gives a few examples of the kind of actions that could be
triggered by an alternate password:
</p><blockquote>
This functionality could be used to allow someone pressed to give a
password under [coercion] to provide a password that grants access but in the
background runs scripts to clean up sensitive data, close connections to
other networks to limit lateral movement, and/or to send off a [notification]
or alert (potentially one with detailed information like location, visible
wifi hotspots, a picture from the camera, a link to a stream from the
microphone, etc). You could even spawn a process to remove the pam_duress
module so the threat actor won&#39;t be able to see if the duress module was
available. 
</blockquote>


<p>
Scripts or binaries that are meant to be used when duress passwords are
entered (i.e. duress programs) can be placed in either <tt>/etc/duress.d</tt>, for global duress
actions, or <tt>~/.duress</tt> for those specific to a particular user.  In
either case, the <tt>duress_sign</tt> script is used to process a file into
something that PAM Duress can use.  The script will prompt for a password,
which it hashes with SHA-256, using the SHA-256 hash of the file&#39;s contents
as the salt; the resulting hash value is written to
<tt><i>duress-script-name</i>.sha256</tt>.  That stored hash protects
against changes to the script and securely &#34;stores&#34; the password within a
single hash value.
</p>

<p>
In order to use PAM Duress, the system&#39;s PAM authentication file
(e.g. <tt>/etc/pam.d/common-auth</tt>) needs to be set up to try the user&#39;s
password first (with the normal <tt>pam_unix.so</tt> module); if that
fails, it should be configured to invoke <tt>pam_duress.so</tt> to check for any
matching duress passwords.  As shown in the documentation, that might look
like the following:
</p><pre>    # Example /etc/pam.d/common-auth
    auth    [success=2 default=ignore]      pam_unix.so
    auth    [success=1 default=ignore]      pam_duress.so

    auth    requisite                       pam_deny.so
</pre>


<p>
When invoked, 
PAM Duress will look at each file in the two duress program
directories, hashing the provided password
using the hash of the file&#39;s contents as salt, then comparing it to the
value in the corresponding <tt>.sha256</tt> file; if there is a match, the duress
program gets invoked.  If any file matches, success will be returned to PAM, which will 
result in access being granted and the user&#39;s login shell being invoked
after the duress programs are run.
</p>

<p>
A simple <a href="https://github.com/nuvious/pam-duress/blob/main/docs/examples/Pushover.md">example</a> to demonstrate the module is provided in the repository.  The
<tt>pushover.sh</tt> script uses the API of the <a href="https://pushover.net/">Pushover</a> service to send a message
reporting 
that the duress password has been used.  The message includes the username
of who logged in along with the local and external IP addresses of the system.
</p>

<p>
On the page describing the example, 
the script is signed with a password that is meant to
be given to
each person when it gets installed on their system.  The example points out
that the password should be changed if someone who knows it leaves the
organization, but other strategies could be used (e.g. individual
passwords).  The integrity hash on the scripts seems to mostly be aimed at
preventing inadvertent changes, since an attacker with access to the
filesystem has lots of other ways to compromise the system. The
demonstration script
uses a configuration file for API keys that has no hash protection so
it could be changed without detection—not that it really matters in the
grand scheme of things.
</p>

<p>
Sending a message when the duress password has been used seems relatively
innocuous from a legal perspective, but some of the other possible uses may
not be.
In a <a href="https://news.ycombinator.com/item?id=28267975">lengthy Hacker
News discussion</a> about PAM Duress, multiple commenters pointed out that
deleting files in the background when requested to log in at a border
crossing may well be an offense—if it is detected.  It is, as with
everything regarding security, a question of the type of threats being
protected against.  As &#34;jeroenhd&#34; <a href="https://news.ycombinator.com/item?id=28268903">put it</a>:
</p><blockquote>
If you&#39;re held under gunpoint, that script that wipes your entire hard
drive will only make your day worse. 
<p>
AFAIK if you actually get detained and questioned at airports, your drive
will already get imaged before any password is even tried. You may be able
to get away with this on a mobile device where this feature isn&#39;t generally
expected (because who uses Linux on a smartphone in the first place). 
</p><p>
I always wonder at what scenarios like these are supposed to be about. If
saying no is not an option, pissing off your captors by giving them fake
info probably isn&#39;t either. 
</p><p>
I don&#39;t know what law enforcement would be looking for on my work drive,
but if saying no is no longer an option, my encryption password isn&#39;t worth
getting shot over.  
</p></blockquote>


<p>
&#34;Spooky23&#34; <a href="https://news.ycombinator.com/item?id=28270119">said</a> 
that the idea of handling the situation with a technical means like PAM
Duress is &#34;<span>silly nerd porn</span>&#34;.  Someone who has data that the
authorities want access to should not be crossing a border with it on
their device: &#34;<span>The only way to win is not to play.</span>&#34;  But
others pointed out that the intent of a duress password is to &#34;<span>give
the appearance of compliance</span>&#34; as &#34;dredmorbius&#34; <a href="https://news.ycombinator.com/item?id=28277474">said</a>, which may be
enough to satisfy the investigator and head off further inquiry.
</p>

<p>
No discussion of this sort ever happens without a reference to the <a href="https://xkcd.com/538/">xkcd pipe wrench scenario</a>.  Technical
means to avert the often arbitrary and capricious nature of border searches
and the like are certainly attractive to those of a technical bent.  But
providing <a href="https://en.wikipedia.org/wiki/Plausible_deniability">plausible
deniability</a> by way of <a href="https://blog.linuxbrujo.net/posts/plausible-deniability-with-luks/">hidden
encrypted disk partitions</a>, <a href="https://en.wikipedia.org/wiki/Rubberhose_(file_system)">filesystems
that look like gibberish</a>, or other schemes of that nature can all fall
prey to the wrench scenario.  If the 
authorities (or criminals, though it is sometimes hard to tell the
difference these days) want to access the data badly enough, they are going to find
a—quite possibly non-technical—means to do so.
</p>

<p>
As might be guessed, there were suggestions of other ideas for technical measures,
such as a
<a href="https://www.kali.org/blog/emergency-self-destruction-luks-kali/">mechanism
to &#34;nuke&#34; an encrypted disk</a> if a duress password is entered.  There was
also a pointer to an earlier project, <a href="https://github.com/rafket/pam_duress">pam_duress</a>, which has much
the same focus as its nearly identical name would imply.  In addition,
there were suggestions of storing the sensitive data elsewhere (e.g. encrypted
in the cloud) for restoration once the destination has been reached.
</p>

<p>
In
the final analysis, having no sensitive data when crossing a border or
otherwise being in a situation where there is a potential for duress being
applied is the safest solution. Storing said data &#34;elsewhere&#34; has its own
set of risks, of course—the cloud is hardly beyond the reach of
nation-state actors. Dangerous-to-possess data, which is often defined
quite differently in various parts of the world, is difficult to handle; technical
means can certainly help but they are no panacea. 
</p></div></div>
  </body>
</html>
