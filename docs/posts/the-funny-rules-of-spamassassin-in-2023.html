<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://updown.io/blog/the-funny-rules-of-spamassassin-in-2023">Original</a>
    <h1>The funny rules of SpamAssassin in 2023</h1>
    
    <div id="readability-page-1" class="page"><section id="articles">
  <div>
    <h2>
      <a href="https://updown.io/blog">Blog</a> <em> 〉</em>The funny rules of SpamAssassin in 2023 (deep dive)
    </h2><p>This investigation was surprising to me so I thought it would be interesting to share my findings and I hope you&#39;ll like it.</p>

<p>Some of my clients occasionally reported that the updown confirmation email (used to confirm a new email address, provided by <a href="https://github.com/heartcombo/devise/blob/main/app/views/devise/mailer/confirmation_instructions.html.erb">Devise</a>) had been classified as spam, we&#39;re talking about this one:</p>

<p><img src="https://updown.io/files/655b30f9893e4ad2c794f3c4.png" alt="confirmation email screenshot"/></p>

<p>Doesn&#39;t look too spammy so far but sometimes mails servers running <a href="https://spamassassin.apache.org/">SpamAssassin</a> were indeed reporting a rating above 5 on its &#34;Spam-Score&#34;. 5 being the default threshold from SpamAssassin to consider an email as spam. If we have access to the raw email with headers, this is something we can often see easily (real example provided by one client):</p>
<div><pre><code><span>X-Spam-Report</span><span>:</span><span> 
    *  0.0 HTML_MESSAGE BODY: Nachricht =?UTF-8?Q?enth=E4lt?= HTML
    *  2.8 HTML_IMAGE_ONLY_28 BODY: HTML: images with 2400-2800 bytes of words
    * -0.0 T_SCC_BODY_TEXT_LINE No description available.
    *  4.0 URI_PHISH Phishing using web form</span>
<span>X-Spam-Score</span><span>:</span><span> 6.8</span>
</code></pre></div>
<p>So I started investigating why SpamAssassin was applying these rules to this email and oh boy I wasn&#39;t ready for what I found 😅</p>

<p>I first tried reproducing the problem locally by installing SpamAssassin and running some checks on the exact same email from that client (example instructions used on Ubuntu 22.04):</p>
<div><pre><code><span>&gt;</span><span> </span><span>sudo </span>apt <span>install </span>spamassassin
<span>
</span><span>&gt;</span><span> </span>spamassassin <span>-V</span>
<span>SpamAssassin version 3.4.6
  running on Perl version 5.34.0

</span><span>&gt;</span><span> </span>spamassassin <span>-t</span> &lt; confirmation-instructions.eml
<span># ...
</span><span>Content analysis details:   (0.6 points, 5.0 required)

 pts rule name              description
---- ---------------------- --------------------------------------------------
-1.0 RCVD_IN_MSPIKE_H5      RBL: Excellent reputation (+5)
                            [104.245.209.212 listed in wl.mailspike.net]
-0.0 SPF_HELO_PASS          SPF: HELO matches SPF record
 0.7 HTML_IMAGE_ONLY_28     BODY: HTML: images with 2400-2800 bytes of
                            words
 0.0 HTML_MESSAGE           BODY: HTML included in message
-0.1 DKIM_VALID             Message has at least one valid DKIM or DK signature
-0.1 DKIM_VALID_AU          Message has a valid DKIM or DK signature from
                            author&#39;s domain
 0.1 DKIM_SIGNED            Message has a DKIM or DK signature, not necessarily
                            valid
-0.0 RCVD_IN_MSPIKE_WL      Mailspike good senders
 1.0 URI_PHISH              Phishing using web form
</span></code></pre></div>
<p>Dissapointingly the result was very different and the score very low. We could still see the same impacting rules though (<code>HTML_IMAGE_ONLY_28</code> and <code>URI_PHISH</code>) but with lower scores.</p>

<p>I also tried with the <code>-Lt</code> options which means &#34;local-only test&#34; (no calls to remote servers, online blacklists, etc.) and in that case there&#39;s fewer tests as expected but it <strong>increases</strong> the score of others:</p>
<div><pre><code><span>&gt;</span><span> </span>spamassassin <span>-Lt</span> &lt; confirmation-instructions.eml
<span># ...
</span><span>Content analysis details:   (3.8 points, 5.0 required)

 pts rule name              description
---- ---------------------- --------------------------------------------------
 0.0 HTML_MESSAGE           BODY: HTML included in message
 2.8 HTML_IMAGE_ONLY_28     BODY: HTML: images with 2400-2800 bytes of
                            words
 1.0 URI_PHISH              Phishing using web form
</span></code></pre></div>
<p>This is likely to make up for the fact that there&#39;s less signal to be used so they need to amplify the only available signals in order to reach the spam score threshold of 5 earlier, I guess.</p>

<blockquote>
<p>If you do/can have a local DNS resolver, I would recommend making sure you enable <a href="https://cwiki.apache.org/confluence/display/spamassassin/UsingNetworkTests">network rules</a> for more reliable results. If using <code>spampd</code>, this is configured with <code>LOCALONLY=0</code>  in <code>/etc/default/spampd</code> </p>
</blockquote>

<p>So even though the scores were lower, I knew they could be multiplied for some reasons and also by configuration so better see if I can avoid the email being flagged as <code>HTML_IMAGE_ONLY_28</code> and <code>URI_PHISH</code> entirely to eliminate the problem.</p>

<p>I first wrote a quick way to test these emails spam scores in my specs (using <code>spamd</code> the daemon version of SpamAssassin, and <code>spamc</code> the command-line client). In order to be able to iterate and test changes quickly, but also to <strong>avoid regressions in the future</strong>. Future changes of my emails or future versions of SpamAssassin:</p>
<div><pre><code><span>def</span> <span>spam_check</span> <span>email</span>
  <span># Using spamc/spamd (daemon) if available, much faster</span>
  <span>cmd</span> <span>=</span> <span>&#34;spamc --full --connect-retries=1&#34;</span>
  <span># Using spamassassin (standalone cmd), slower but supports local-only option</span>
  <span># cmd = &#34;spamassassin -Lt&#34;</span>
  <span># Inject Received header to trigger more rules like __VIA_ML (return-path contains &#34;bounces@&#34;)</span>
  <span>stdin</span> <span>=</span> <span>&#34;Received: by mta212a-ord.mtasv.net id h6qj0s27tk4a for &lt;</span><span>#{</span><span>email</span><span>.</span><span>to</span><span>.</span><span>first</span><span>}</span><span>&gt;; </span><span>#{</span><span>email</span><span>.</span><span>date</span><span>.</span><span>rfc2822</span><span>}</span><span> (envelope-from &lt;pm_bounces@bounce.updown.io&gt;)</span><span>\n</span><span>&#34;</span> <span>+</span> <span>email</span><span>.</span><span>to_s</span>
  <span>out</span><span>,</span> <span>err</span><span>,</span> <span>status</span> <span>=</span> <span>Open3</span><span>.</span><span>capture3</span><span>(</span><span>cmd</span><span>,</span> <span>stdin_data: </span><span>stdin</span><span>)</span>
  <span>if</span> <span>out</span> <span>==</span> <span>&#34;0/0</span><span>\n</span><span>&#34;</span>
    <span>skip</span> <span>&#34;spamd is not running: `sudo systemctl start spamassassin.service`&#34;</span>
  <span>elsif</span> <span>status</span><span>.</span><span>success?</span>
    <span># minor processing to have stable rules orders and remove width limit</span>
    <span>headers</span><span>,</span> <span>rules</span> <span>=</span> <span>out</span><span>.</span><span>chomp</span><span>.</span><span>split</span><span>(</span><span>&#34;--</span><span>\n</span><span>&#34;</span><span>)</span>
    <span>rules</span><span>.</span><span>gsub!</span><span>(</span><span>/\n\s{5,}/m</span><span>,</span> <span>&#34; &#34;</span><span>)</span>
    <span>return</span> <span>headers</span> <span>+</span> <span>&#34;</span><span>\n</span><span>&#34;</span> <span>+</span> <span>rules</span><span>.</span><span>lines</span><span>.</span><span>sort</span><span>.</span><span>join</span>
  <span>else</span>
    <span>raise</span> <span>Error</span><span>.</span><span>new</span><span>(</span><span>&#34;Command `</span><span>#{</span><span>cmd</span><span>}</span><span>` exited with status </span><span>#{</span><span>status</span><span>.</span><span>to_i</span><span>}</span><span>: </span><span>#{</span><span>err</span><span>}</span><span>&#34;</span><span>)</span>
  <span>end</span>
<span>rescue</span> <span>Errno</span><span>::</span><span>ENOENT</span> <span>=&gt;</span> <span>e</span>
  <span>skip</span> <span>&#34;SpamAssassin not installed: </span><span>#{</span><span>e</span><span>.</span><span>to_s</span><span>}</span><span>&#34;</span>
<span>end</span>
</code></pre></div><div><pre><code><span>require</span> <span>&#34;rails_helper&#34;</span>

<span>describe</span> <span>UserMailer</span> <span>do</span> <span># Devise inherited mailer</span>
  <span>let</span><span>(</span><span>:user</span><span>)</span> <span>{</span> <span>create</span> <span>:user</span> <span>}</span>
  <span>let</span><span>(</span><span>:email</span><span>)</span> <span>{</span> <span>ActionMailer</span><span>::</span><span>Base</span><span>.</span><span>deliveries</span><span>.</span><span>last</span> <span>}</span>

  <span>describe</span> <span>&#39;#confirmation_instructions&#39;</span> <span>do</span>
    <span>subject</span> <span>{</span> <span>user</span> <span>}</span>

    <span>it</span> <span>&#34;passes spam check&#34;</span> <span>do</span>
      <span>subject</span>
      <span>expect</span><span>(</span><span>spam_check</span><span>(</span><span>email</span><span>)).</span><span>to</span> <span>include</span><span>(</span><span>&lt;&lt;~</span><span>REPORT</span><span>)</span><span>
        Content analysis details:   (0.0 points, 5.0 required)

         pts rule name              description
        ---- ---------------------- ------------------------------------------------
         0.0 HTML_IMAGE_ONLY_32     BODY: HTML: images with 2800-3200 bytes of words
         0.0 HTML_MESSAGE           BODY: HTML included in message
        -0.0 NO_RELAYS              Informational: message was not relayed via SMTP
</span><span>      REPORT</span>
    <span>end</span>
  <span>end</span>
<span>end</span>
</code></pre></div>
<p>Now let&#39;s have a look at these two rules. It&#39;s hard to find clear definitions sometimes but fortunately SpamAssassin is <a href="https://github.com/apache/spamassassin">open source</a> so where there is a will there&#39;s a way.</p>

<h3>HTML_IMAGE_ONLY_24</h3>

<p>This  one is the easiest and the most self-explanatory, it simply checks if the email contains an image (it does, the updown.io logo) and if the content is between 2000 and 2400 bytes. So basically if the email is short and has an image, it&#39;s more likely to be spam (this is because of spam email which hide text as images to avoid filters). Only two options here:</p>

<p>I choose the later to keep a consistent look and also because of the second rule. In the end I only increased it a bit and now it matches the <code>HTML_IMAGE_ONLY_32</code> rule, this rule scores <strong>2.2</strong> in local-only testing but <strong>0</strong> (surprisingly) when network test are enabled. (If we follow the same logic as <code>HTML_IMAGE_ONLY_24</code>, it should have been 2.2/4 ≃ 0.55)</p>

<p>Getting rid of this rule would require much more text bloat or cheating (invisible text, etc..) and it matches more of my emails, so for the moment I decided to leave it like that and wait for the next problem. 2.2 is not enough on it&#39;s own to trip the spam threshold (5) and hopefully spamassassin will improve this part before I need to hack around it.  </p>

<h3>URI_PHISH</h3>

<p>Now for the most interesting part, after some online search I first <a href="https://spamassassin.apache.org/full/3.4.x/doc/Mail_SpamAssassin_Plugin_Phishing.txt">found this</a> which seems to be a plugin checking for URL against a blacklist, but it gives the <code>URI_PHISHING</code>  rule (not exactly the same) and I didn&#39;t install any plugin, so this is not the one.</p>

<p>I then found this <a href="https://bz.apache.org/SpamAssassin/show_bug.cgi?id=7940">very interesting report</a> in 2021 about a similar confirmation email receiving a &#34;false positive&#34; classification as <code>URI_PHISH</code>, and the official answer was:</p>

<blockquote>
<p><em>It&#39;s not based on &#34;phishing URLs&#34; or the specific link, it&#39;s based on having body text that looks like account phishing and having a URL.  The body text that looks suspiciously like phishing is, unsurprisingly, &#34;confirm your account&#34;.</em></p>

<p><em>As Loren said, this is not a FP, as the total score for the message did not exceed the spam threshold. This is a single-rule hit on spammy-looking content without other signs to support it. That happens.</em></p>

<p><em>It is not a bug that a given rule will hit some ham. The only suggestion I can offer is that you reword your message to make it look less like phishing.</em></p>
</blockquote>

<p>So let&#39;s skip over the fact that it is now very sad that anti-spam filters have to block any simple confirmation email just because scamers are successfully abusing people with them...</p>

<p>That piqued my curiousity: what are they looking for in the email exactly? how can I make sure that the change I make won&#39;t be matched by another rule or in the future? (yes we unfortunately have to think like scammers now in order to get our regular email accepted...)</p>

<p>So by searching for <code>URI_PHISH</code> into the code I ended up in this <a href="https://github.com/apache/spamassassin/blob/773338709e3a4e53380ec9b7ef530af5f115d5ed/rulesrc/sandbox/jhardin/20_misc_testing.cf#L1340">big rules file</a> which does contain this (extract slightly simplified):</p>
<div><pre><code>meta        __URI_PHISH    __HAS_ANY_URI <span>&amp;&amp;</span> <span>!</span>__URI_GOOGLE_DOC <span>&amp;&amp;</span> <span>!</span>__URI_GOOG_STO_HTML <span>&amp;&amp;</span> <span>(</span>__EMAIL_PHISH <span>||</span> __ACCT_PHISH<span>)</span>
meta        URI_PHISH      __URI_PHISH <span>&amp;&amp;</span> <span>!</span>ALL_TRUSTED <span>&amp;&amp;</span> <span>!</span>__UNSUB_LINK <span>&amp;&amp;</span> <span>!</span>__TAG_EXISTS_CENTER <span>&amp;&amp;</span> <span>!</span>__HAS_SENDER <span>&amp;&amp;</span> <span>!</span>__CAN_HELP <span>&amp;&amp;</span> <span>!</span>__VIA_ML <span>&amp;&amp;</span> <span>!</span>__UPPERCASE_URI <span>&amp;&amp;</span> <span>!</span>__HAS_CC <span>&amp;&amp;</span> <span>!</span>__NUMBERS_IN_SUBJ <span>&amp;&amp;</span> <span>!</span>__PCT_FOR_YOU <span>&amp;&amp;</span> <span>!</span>__MOZILLA_MSGID <span>&amp;&amp;</span> <span>!</span>__FB_COST <span>&amp;&amp;</span> <span>!</span>__hk_bigmoney <span>&amp;&amp;</span> <span>!</span>__REMOTE_IMAGE <span>&amp;&amp;</span> <span>!</span>__HELO_HIGHPROFILE <span>&amp;&amp;</span> <span>!</span>__RCD_RDNS_SMTP_MESSY <span>&amp;&amp;</span> <span>!</span>__BUGGED_IMG <span>&amp;&amp;</span> <span>!</span>__FB_TOUR <span>&amp;&amp;</span> <span>!</span>__RCVD_DOTGOV_EXT 
describe    URI_PHISH            Phishing using web form
score       URI_PHISH            4.00   <span># limit</span>
</code></pre></div>
<p>Ok so we now have an entry point which contains <strong>MANY</strong> other rules of course (some of which also contains other rules). I checked <strong>ALL</strong> of them for you ^^ and here are my most interesting findings:</p>

<h4>First in the positive rules, which needs to be true:</h4>

<ul>
<li><code>__HAS_ANY_URI</code> → simple regexp on <code>/^\w+:\/\//</code></li>
<li><code>__EMAIL_PHISH || __ACCT_PHISH</code> → these the sub rules where the main &#34;phishing&#34; heuristics happens</li>
</ul>

<h4>Now let&#39;s look at all the negative rules here (starting with a <code>!</code>) which are meant to exclude content (if this rule is true, then the <code>URI_PHISH</code> rule will NOT apply):</h4>

<ul>
<li><code>!__URI_GOOGLE_DOC</code> and  <code>!__URI_GOOG_STO_HTML</code> → regexp on <code>docs\.google\.com</code> and <code>storage\.googleapis\.com</code>, they got their own special rule so are excluded here.</li>
<li><code>!ALL_TRUSTED</code> → this is for when you configure some internal email servers as &#34;trusted&#34;, not applicable here</li>
<li><code>!__UNSUB_LINK</code> → ⚠️ Also interesting, this one tries to match unsubscribe links with <code>/\b(?:(?:un)?subscri(?:ber?|ptions?)|abuses?|opt(?:ing)?.?out)\b/i</code>. This is good to know that simply having an unsubscribe link could prevent <code>URI_PHISH</code>, but unfortunately for an account confirmation email you can&#39;t really &#34;unsubscribe&#34; people, this is not a mailing list or on-boarding email. Otherwise this would have a been a good option to improve both the spam score and the user experience.</li>
<li><code>!__VIA_ML</code> → this rule checks if the envelope-from/return-path contains &#34;bounces@&#34; to declare this is a &#34;Mailing List&#34;. In my case using <a href="https://postmarkapp.com/">Postmark</a> this is the case and cannot be customized unfortunately (only the domain: <code>pm_bounces@bounce.updown.io</code>). So I guess you should avoid using &#34;bounces@&#34; in your return path addresses for transactional emails if you can... </li>
</ul>

<h4>And now let&#39;s have a look at my favorites: the totally WTF rules 😱:</h4>

<ul>
<li><code>!__TAG_EXISTS_CENTER</code> → this rule just checks for the presence of a <code>&lt;center&gt;</code> tag. So if you add one, magically your email is no longer <code>URI_PHISH</code>... WAIT, WHAT? Surely if your email is centered the old way, then it&#39;s not phishing (tested locally).</li>
<li><code>!__HAS_SENDER</code> → if you add ANY <code>Sender</code> header, the <code>URI_PHISH</code> rule is skipped… The goal of the Sender header is for services sending emails on behalf of other users, it helps for authentication validations. But anybody can put anything in here, so there&#39;s no reason to consider an email &#34;less phishing&#34; because it contains this header. (tested locally)</li>
<li><code>!__CAN_HELP</code> →  even simpler, this will skip the rule if the email contains &#34;can help&#34;... (tested locally)</li>
<li><code>!__UPPERCASE_URI</code> → pretty self-explanatory</li>
<li><code>!__HAS_CC</code> → what? why?</li>
<li><code>!__NUMBERS_IN_SUBJ</code> → OK so more than 3 digits in subject line also helps...  <code>/\d{3}/</code></li>
<li><code>!__FB_COST</code> → this is one checks for  the word... &#34;cost&#34;. Yep, just that. Put it in an email and suddenly it&#39;s not phishing... (tested locally) </li>
<li><code>!__FB_TOUR</code> → similarly this one checks for the word &#34;tour&#34;...</li>
</ul>

<p>It&#39;s likely that some of these rules are only here to replace <code>URI_PHISH</code> by another one more specific maybe (like we saw the case with Google Doc URLs), but still in this state it&#39;s pretty easy to exploit them and in my testing locally, using those words to trigger those rules didn&#39;t cause other spam rules to appear...</p>

<p>Which means that in the end we have a spam filter which is very easy to fool, yet easily tripped by honest emails...</p>

<h3>What I changed in the end</h3>

<ol>
<li>I tried changing the <strong>return-path</strong> to avoid &#34;bounces@&#34; but couldn&#39;t do it with Postmark unfortunately.</li>
<li>I did not want to ~use~ <strong>exploit</strong> any of the stupid hacks like &#34;cost&#34; or &#34;&lt;center&gt;&#34;.</li>
<li>I changed the <strong>wording</strong> of the email to make it longer and avoid the common word combinations matched in the regexp (see screenshot below for the new version)</li>
<li>I also added a <code>Sender</code> header (only for some emails and with the same value as <code>From</code>) in order to please the rules because this one doesn&#39;t look too hackish, but I still don&#39;t feel great about this 🙃.</li>
</ol>

<h4>New email</h4>

<p><img src="https://updown.io/files/655b50e2893e4ad2c7951554.png" alt="new email screenshot"/></p>
</div>
</section></div>
  </body>
</html>
