<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://00xbyte.github.io/posts/Don%27t-Believe-Your-Eyes-A-WhatsApp-Clickjacking-Vulnerability/">Original</a>
    <h1>A clickjacking vulnerability in WhatsApp that enables phishing attacks</h1>
    
    <div id="readability-page-1" class="page"><div><p>Imagine you have received a WhatsApp message with a link to <code>ln.instagram.com</code>.</p><p>I have found a <a href="https://en.wikipedia.org/wiki/Clickjacking">clickjacking</a> vulnerability in WhatsApp that enables phishing attacks.</p><h2 id="discovery-process"><span>Discovery Process</span><a href="#discovery-process"><i></i></a></h2><p>I started my research looking for a way to make a message recipient perform an HTTP request. My initial thought was to check WA’s link preview feature. I hoped the the link would be rendered twice, once by the sender and once by the receiver. In order to check my theory, I created a <a href="https://webhook.site/">webhook</a> and sent it to a friend. Sadly only one request was made, only by me.</p><h3 id="issue-1---link-preview-mismatch"><span>Issue #1 - Link Preview Mismatch</span><a href="#issue-1---link-preview-mismatch"><i></i></a></h3><p>I decided to take a look into what data is sent in a WA message that contains a link with a preview. My goal was to intercept the message, change the link and the preview to mismatch, and send it. </p><p><a href="https://00xbyte.github.io/assets/img/post/websocket.png"><img src="data:image/svg+xml,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; viewBox=&#39;0 0 540 400&#39;%3E%3C/svg%3E" data-src="/assets/img/post/websocket.png" alt="" width="540" height="400" data-proofer-ignore=""/></a></p><p>Instead of understanding the encryption mechanism, I decided insert a breakpoint a moment before the message was encrypted and sent through the websocket. WA web’s javascript was uglified and minified, however after a while of searching I found the right place.</p><p><a href="https://00xbyte.github.io/assets/img/post/link%20object.png"><img src="data:image/svg+xml,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; viewBox=&#39;0 0 540 400&#39;%3E%3C/svg%3E" data-src="/assets/img/post/link%20object.png" alt="" width="540" height="400" data-proofer-ignore=""/></a></p><p>Exactly as I suspected, the link and the preview were sent separately!</p><div><table><thead><tr><th>Property</th><th>Purpose</th></tr></thead><tbody><tr><td><code>text</code></td><td>The text of the message</td></tr><tr><td><code>canonicalURL</code></td><td>The domain that is shown at the bottom of the preview</td></tr><tr><td><code>matchedText</code></td><td>Seems to be compared against <code>canonicalURL</code>, also tested that its value apears in <code>text</code></td></tr></tbody></table></div><p>I discovered that if the <code>matchedText</code> was deleted from the object, I could create a mismatch!</p><p><a href="https://00xbyte.github.io/assets/img/post/preview%20mismatch.jpg"><img src="data:image/svg+xml,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; viewBox=&#39;0 0 540 400&#39;%3E%3C/svg%3E" data-src="/assets/img/post/preview%20mismatch.jpg" alt="" width="540" height="400" data-proofer-ignore=""/></a></p><p>Success! I have created a message with a preview to one site, and when clicked, leads to another. This was a great start, but I didn’t want the real link to be shown in the message. I was looking for ways to hide the message text.</p><h3 id="issue-2---disguising-links-2k2e"><span>Issue #2 - Disguising Links (2K2E)</span><a href="#issue-2---disguising-links-2k2e"><i></i></a></h3><p>I remembered that some unicode characters can change the representation of text, so I tried fuzzing characters to see their effect:</p><div><p><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
</pre></td><td><pre><span>function</span> <span>fuzz</span><span>(</span><span>start</span><span>,</span> <span>end</span><span>)</span> <span>{</span>
	<span>for </span><span>(</span><span>let</span> <span>i</span> <span>=</span> <span>start</span><span>;</span> <span>i</span> <span>&lt;=</span> <span>end</span> <span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
	    <span>j</span> <span>=</span> <span>i</span><span>.</span><span>toString</span><span>(</span><span>16</span><span>)</span>
	    <span>if </span><span>(</span><span>j</span><span>.</span><span>length</span> <span>&lt;</span> <span>4</span><span>)</span> <span>{</span> <span>j</span> <span>=</span> <span>&#34;</span><span>0</span><span>&#34;</span><span>.</span><span>repeat</span><span>(</span><span>4</span> <span>-</span><span>j</span><span>.</span><span>length</span><span>)</span> <span>+</span> <span>j</span><span>}</span>
 	    <span>msg</span> <span>+=</span> <span>eval</span><span>(</span><span>&#34;</span><span>\&#34;\\</span><span>u</span><span>&#34;</span><span>+</span><span>j</span><span>+</span><span>&#34;</span><span>\&#34;</span><span>&#34;</span><span>)</span>
			<span>+</span> <span>&#34;</span><span>https://google.com/</span><span>&#34;</span> <span>+</span> <span>i</span><span>.</span><span>toString</span><span>(</span><span>16</span><span>)</span>
			<span>+</span> <span>&#34;</span><span>\n</span><span>&#34;</span> 
	<span>}</span>
<span>}</span>
</pre></td></tr></tbody></table></code></p></div><p>I observed the results and one result caught my eye. One of the lines (<code>202e</code>) was in reverse:</p><p><a href="https://00xbyte.github.io/assets/img/post/fuzzing.jpg"><img src="data:image/svg+xml,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; viewBox=&#39;0 0 540 400&#39;%3E%3C/svg%3E" data-src="/assets/img/post/fuzzing.jpg" alt="" width="540" height="400" data-proofer-ignore=""/></a></p><p>Apparently, the unicode character <a href="https://unicode-explorer.com/c/202E"><code>U+202E</code></a> (Right-To-Left Override) alters the way that text is presented to the user by displaying it in reverse order.</p><h4 id="crafting-a-mirror-url"><span>Crafting A Mirror URL</span><a href="#crafting-a-mirror-url"><i></i></a></h4><p>I wanted to create a URL that, when reversed, looked like <code>https://instagram.com</code>. This means that the link should be <code>moc.margatsni//:sttph</code> (<code>\u202e</code>+<code>moc.margatsni//:sttph</code> = <code>https://instagram.com</code> )</p><p>This fist problem is the TLD. I cannot register a <code>.margatsni</code> domain.</p><p>Problem number two was that the URL needed to start with <code>https://</code> in order to look legitimate.</p><blockquote><p>With a mirror URL and the <code>U+202E</code> character, an attacker can make any URL look like any other!</p></blockquote><h3 id="final-result"><span>Final Result</span><a href="#final-result"><i></i></a></h3><p>Finally I have a legitimate looking URL that seems like it leads to Instagram, when in fact it leads to my blog <a href="https://00xbyte.github.io/">Security Is Broken</a>.</p><p><a href="https://00xbyte.github.io/assets/img/post/clickjacking.png"><img src="data:image/svg+xml,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; viewBox=&#39;0 0 540 400&#39;%3E%3C/svg%3E" data-src="/assets/img/post/clickjacking.png" alt="" width="540" height="400" data-proofer-ignore=""/></a></p><h2 id="attack-scenario"><span>Attack Scenario</span><a href="#attack-scenario"><i></i></a></h2><p>Utilizing both these issues can allow attackers to perform phishing attacks where they construct legitimate looking links that lead to malicious websites.</p><p>The full attack flow:</p><ol><li>An attacker purchases the mirror domain of the site they would like to impersonate. For example <code>moc.margatsni.nl</code> to impersonate <code>ln.instagram.com</code></li><li>The attacker creates a message with a link to original domain in order to use its preview.<div><p><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td><pre><span>{</span><span>
 </span><span>&#34;text&#34;</span><span>:</span><span> </span><span>&#34;https://instagram.com/&#34;</span><span>,</span><span>
 </span><span>&#34;matchedText&#34;</span><span>:</span><span> </span><span>&#34;https://instagram.com/&#34;</span><span>,</span><span>
 </span><span>&#34;canonicalUrl&#34;</span><span>:</span><span> </span><span>&#34;https://instagram.com/&#34;</span><span>,</span><span>
 </span><span>&#34;description&#34;</span><span>:</span><span> </span><span>&#34;Create an account...&#34;</span><span>,</span><span>
 </span><span>&#34;title&#34;</span><span>:</span><span> </span><span>&#34;Instagram&#34;</span><span>,</span><span>
 </span><span>&#34;jpegThumbnail&#34;</span><span>:</span><span> </span><span>{},</span><span>
 </span><span>&#34;previewType&#34;</span><span>:</span><span> </span><span>0</span><span>,</span><span>
 </span><span>&#34;mediaKey&#34;</span><span>:</span><span> </span><span>{},</span><span>
 </span><span>&#34;mediaKeyTimestamp&#34;</span><span>:</span><span> </span><span>1693302818542</span><span>,</span><span>
 </span><span>&#34;thumbnailDirectPath&#34;</span><span>:</span><span> </span><span>&#34;/v/t62.36...&#34;</span><span>,</span><span>
 </span><span>&#34;thumbnailSha256&#34;</span><span>:</span><span> </span><span>{},</span><span>
 </span><span>&#34;thumbnailEncSha256&#34;</span><span>:</span><span> </span><span>{},</span><span>
 </span><span>&#34;thumbnailHeight&#34;</span><span>:</span><span> </span><span>1024</span><span>,</span><span>
 </span><span>&#34;thumbnailWidth&#34;</span><span>:</span><span> </span><span>1024</span><span>,</span><span>
 </span><span>&#34;inviteLinkGroupTypeV2&#34;</span><span>:</span><span> </span><span>0</span><span>
</span><span>}</span><span>
</span></pre></td></tr></tbody></table></code></p></div></li><li>The attacker then removes the <code>matchedText</code> property and changes the <code>text</code> property to the following value: <code>U+202E</code> + “URL to the mirror domain” + <code>//:sptth</code><div><p><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td><pre><span>{</span><span>
 </span><span>&#34;text&#34;</span><span>:</span><span> </span><span>&#34;</span><span>\u</span><span>202ehttps://moc.margatsni.nl//:sptth&#34;</span><span>,</span><span>
 </span><span>&#34;canonicalUrl&#34;</span><span>:</span><span> </span><span>&#34;https://instagram.com/&#34;</span><span>,</span><span>
 </span><span>&#34;description&#34;</span><span>:</span><span> </span><span>&#34;Create an account...&#34;</span><span>,</span><span>
 </span><span>&#34;title&#34;</span><span>:</span><span> </span><span>&#34;Instagram&#34;</span><span>,</span><span>
 </span><span>&#34;jpegThumbnail&#34;</span><span>:</span><span> </span><span>{},</span><span>
 </span><span>&#34;previewType&#34;</span><span>:</span><span> </span><span>0</span><span>,</span><span>
 </span><span>&#34;mediaKey&#34;</span><span>:</span><span> </span><span>{},</span><span>
 </span><span>&#34;mediaKeyTimestamp&#34;</span><span>:</span><span> </span><span>1693302818542</span><span>,</span><span>
 </span><span>&#34;thumbnailDirectPath&#34;</span><span>:</span><span> </span><span>&#34;/v/t62.36...&#34;</span><span>,</span><span>
 </span><span>&#34;thumbnailSha256&#34;</span><span>:</span><span> </span><span>{},</span><span>
 </span><span>&#34;thumbnailEncSha256&#34;</span><span>:</span><span> </span><span>{},</span><span>
 </span><span>&#34;thumbnailHeight&#34;</span><span>:</span><span> </span><span>1024</span><span>,</span><span>
 </span><span>&#34;thumbnailWidth&#34;</span><span>:</span><span> </span><span>1024</span><span>,</span><span>
 </span><span>&#34;inviteLinkGroupTypeV2&#34;</span><span>:</span><span> </span><span>0</span><span>
</span><span>}</span><span>
</span></pre></td></tr></tbody></table></code></p></div></li><li>Finally the attacker sends the crafted message to their victim</li></ol><blockquote><p>Because we support many different platforms and environments, there are a significant number of ways that some platform could choose to normalize a URL differently than our server-side logic does. To address that, we have systems in place which allow us to adjust our URL normalization logic dynamically in the event of real-world spam and abuse.</p></blockquote><p>Sadly, Meta has shown no intention to resolve this security issue and from their response it seems that they will try to stop these attacks only if their systems detect them as spam. This means that WhatsApp users can only cross their fingers that they won’t fall victims to 2K2E attacks.</p><h2 id="mitigation"><span>Mitigation</span><a href="#mitigation"><i></i></a></h2><p>Because Meta has no intention of fixing this issue, links on WhatsApp cannot be trusted. In order to not fall victim to a 2K2E phishing attack, before clicking on a link, copy it. The clipboard preview should show the link address while sanitizing the <code>U+202E</code> character.</p><h2 id="update"><span>Update</span><a href="#update"><i></i></a></h2><p>I have found other services that do not have proper sanitization and are vulnerable to 2K2E as well.</p></div></div>
  </body>
</html>
