<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/Articles/731581/">Original</a>
    <h1>LuaTeX Comes of Age (2017)</h1>
    
    <div id="readability-page-1" class="page"><div>
<center>
           <div><b>This article brought to you by LWN subscribers</b><p>Subscribers to LWN.net made this article — and everything that
       surrounds it — possible.  If you appreciate our content, please
       <a href="https://lwn.net/subscribe/">buy a subscription</a> and make the next
       set of articles possible.</p></div>
           </center>
           
<p><a href="https://www.tug.org/whatis.html">TeX</a> has been the tool of
choice for the preparation of papers and documents for mathematicians,
physicists, and other authors of technical material for many
years. Although it takes some effort to learn how to use this venerable
work of free software, its devotees become addicted to its ability to
produce publication-quality manuscripts from a plain-text,
version-control-friendly format.</p>

<p>Most TeX users use <a href="https://www.latex-project.org/">LaTeX</a>,
which is a set of commands and macros built on 
top of TeX that allow automated cross-referencing, indexing, creation of
a table of contents, and automatic formatting of many types of
documents. TeX, LaTeX, a host of associated utilities, fonts, and related
programs are assembled into a large package called <a href="https://www.tug.org/texlive/">TeX Live</a>. It&#39;s available through
the package managers of many Linux distributions, but to get an up-to-date
version, one often needs to <a href="https://www.tug.org/texlive/acquire.html">download</a> it from its
maintainers directly.</p>

<p>The 2017 version of TeXLive was recently released. As usual, this new
release contains no big surprises and should create no compatibility
issues. All of those who use TeX in their daily work will eventually get
around to starting the big download before bedtime to reap the benefits of
dozens of <a href="https://www.tug.org/texlive/doc/texlive-en/texlive-en.html">incremental
improvements</a>.  Enthusiastic readers of <a href="https://www.tug.org/svn/texlive/trunk/Build/source/texk/web2c/luatexdir/NEWS?view=markup">release
notes</a> may encounter one notable tidbit, however: the version of <a href="http://www.luatex.org/">LuaTeX</a>, 
a key component of TeX Live, is now numbered 1.0.4.</p>

<p>LuaTeX is a project with several components and goals, all of which take
TeX in new directions. This project modernizes font handling, using Unicode
for input and output, including for math. It allows you to use any OpenType or
TrueType font on your system, and to select typefaces, styles, variants, and
font features easily and flexibly. LuaTeX embeds the Lua scripting language
into TeX, allowing authors a new level of power and control. Previously,
authors who needed to bend TeX to do non-standard or unusual typesetting
tasks were obliged to program in the TeX language itself, which is an arcane and
specialized skill. With LuaTeX, authors can accomplish these tasks by
writing scripts in a language with a more familiar syntax.</p>

<p>As recently as just a few years ago, however, documentation writers were
warning against using the still-evolving LuaTeX in critical work. For
example, there is a cautionary note in <a href="http://dante.ctan.org/tex-archive/info/luatex/lualatex-doc/lualatex-doc.pdf">&#34;A guide to
LuaLaTeX&#34; [PDF]</a>, which is one of the few available introductory
documents about the 
project.</p>

<p>LuaTeX is now out of beta, however, which means that the time for
worrying about this has now passed. According to the <a href="http://www.luatex.org/roadmap.html">official roadmap</a>, LuaTeX has
become &#34;<span>functionally complete</span>&#34;; most of the
functionality and interfaces are considered to be stable.
You can now undertake large LuaTeX projects without worrying about your
document breaking with the next upgrade. A &#34;large LuaTeX project&#34;
in this context means not just a long document that you happen to process
using LuaTeX, but one that makes extensive use of the Lua scripting that
the project makes possible.</p>

<p>In fact, LuaTeX has been the generally preferred TeX implementation for
some time. It has become an inseparable part of <a href="http://wiki.contextgarden.net/What_is_ConTeXt">ConTeXt</a>, which is
a large 
project that is a popular alternative to LaTeX for publishing all kinds of
documents, especially books and pamphlets.  LuaTeX passing version 1 means
that its official status has caught up to its 
de facto status as the center of development in the TeX world.</p>

<h4>Terminology</h4>

<p>As terms in the TeX world can become confusing, this brief aside may be
called for. The <em>engine</em> is the command that you type to compile
your document. The name of the engine determines, among other things, what
<em>format</em> will be used, and what kind of output file TeX will
create. There are two choices of output file: the original DVI file and the
generally more popular and useful PDF. There are a handful of formats, such
as Plain TeX and LaTeX, that are large sets of macros that alter the
behavior of the TeX typesetting program that underlies everything, and that
expose various settings and commands to the author.</p>

<p>For example, the engine <code>pdftex</code> will use the Plain TeX
format to create a PDF; the <code>latex</code> command will use the LaTeX
format to create a DVI; and <code>lualatex</code> will use the LaTeX format
and create a PDF by running a version of the <code>pdftex</code> program
that has been rewritten in C and can interoperate with the Lua scripting
language.</p>

<p>Most of the terms with weird mixtures of case refer to formats (LaTeX)
or projects such as LuaTeX.</p>

<h4>Why LuaTeX?</h4>

<p>LuaTeX provides many advantages over the more traditional versions of
TeX, and a couple of possible disadvantages. There are some, usually older,
LaTeX packages that are incompatible with LuaTeX; if you depend on one of
these, then you may want to stick with XeLaTeX (a part of <a href="http://xetex.sourceforge.net/">XeTeX</a>), which is the Unicode-aware
LaTeX-like project, or even the older pdfLaTeX, if necessary. You may,
however, want to consider either making the jump to ConTeXt, which can
duplicate the capabilities of many old LaTeX packages, or trying to
reproduce the effects you want with some Lua scripting.</p>

<p>Another disadvantage is that, for some documents, <tt>luatex</tt> can be
slower 
than the other engines. According to the Introduction of the <a href="http://www.luatex.org/svn/trunk/manual/luatex.pdf">LuaTeX
Reference [230-page PDF]</a>, when using Plain TeX, for example,
<code>pdftex</code> will almost always be faster than <code>luatex</code>,
but complex documents, especially using the recent incarnation of ConTeXt,
often run faster with <code>luatex</code>. In any case, the difference is
typically about a factor of two or so.</p>

<p>One of the delightful advantages of LuaTeX is its simple and powerful
font handling, which I demonstrated in a previous <a href="https://lwn.net/Articles/657157/">article about recent TeX
developments</a>. In addition to the features introduced in that article, I
should mention that LuaTeX has highly developed support for directional
typesetting, which means it can handle languages that go from right to left
or vertically.   Another advantage, for some, is easier access to <a href="https://www.tug.org/metapost.html">MetaPost</a>, bringing an
efficient graphical subsystem into the TeX engine.</p>

<p>LuaTeX has a handful of commands to suppress different kinds of error
messages. Some of these don&#39;t merely turn off the messages, but cause
things to be permitted that were previously forbidden. For example, you can
tell TeX that it&#39;s OK to have a paragraph break inside an equation, which
frees you up to format your math input more flexibly.</p>

<p>There are several improvements in math typesetting related to the
possibility of using wide glyphs in equations. The distance between
equations and their numbers can now be controlled. There is a new type of
leader, whose alignment is based on the largest enclosing box (rather than
the smallest). You can set the minimum word length in which hyphenation
will be allowed.</p>

<p>Aside from font handling, these are all minor enhancements; there are
dozens more listed in the reference manual linked above. The headline
feature of LuaTeX is its embedding of the <a href="http://www.lua.org/about.html">Lua</a> scripting language, and
everything that enables.</p>

<h4>Lua</h4>

<p>Lua is a deceptively simple, but sophisticated, modern scripting
language.  Some of Lua&#39;s unusual, or unusually nice, features are: a single data
structure (the &#34;table&#34;); functions that can return multiple
results; proper tail calls; lexical scoping (closures, etc.); built-in
coroutines; and &#34;metatables&#34; and metamethods.</p>

<p>The features that make Lua so popular as an embedded scripting language,
however, are its <a href="https://dzone.com/articles/lua-not-your-average-scripting-language">small
footprint</a> (10,000 lines of C and a compiled, static library of 500K)
and its design from the ground up as a language for embedding in C and C++
programs. Its JIT compiler and advanced garbage collection make for good
performance in both time and space. The tradeoff is its relatively spare
standard library, but this is supplemented by a <a href="https://luarocks.org/">healthy ecosystem</a> of official and
contributed packages.

</p><p>
Lua is widely used, for example, by game developers,
who can program the core game behavior in C while defining the game play
logic in Lua. You can <a href="https://www.lua.org/download.html">get
the latest version</a> of the language up and running on any system with an
ANSI C compiler — there are no extra dependencies. On many distributions, there
is also a recent version available through the package management system,
and, finally, there are binaries provided for a variety of operating
systems. Lua has an interactive mode that you can start by typing
<code>lua</code> in the terminal. This of course helps in learning the
language through experimentation but, unlike Python and Lisp, typing a
something won&#39;t return its result unfortunately; you need to use the
<code>print</code> statement.</p>

<p>Fortunately the application of Lua within TeX documents rarely requires
anything beyond basic knowledge of the language. Those who wish a
systematic introduction may want to study the book <em>Programming in
Lua</em>; all of the editions of the book, covering recent versions of the
language, can be found <a href="http://www.lua.org/pil/">here</a>,
including an early edition available free of charge.</p>

<h4>Lua in LaTeX</h4>

<p>By simply including the line <code>\usepackage{luacode}</code> in your
LaTeX document&#39;s preamble, and processing it with the <code>lualatex</code>
command, you can mix Lua in with your LaTeX. There are two major ways of
incorporating Lua into your document; the first is to insert the results of
a Lua calculation into the TeX token stream, by using
<code>tex.print</code> (or <code>tex.sprint</code>, that inserts the output
inline, avoiding a line break) instead of the normal Lua <code>print</code>
function. <a href="http://lwn.net/Articles/657157/">This article</a> shows
how to do that by using Lua to compute a numerical table within a LaTeX
document that formats the table, and another one that graphs it.

</p><p>
Below is
another example that uses Lua to calculate a fancy paragraph shape and
construct the TeX command for defining it. The <a href="https://www.tug.org/utilities/plain/cseq.html#parshape-rp"><code>\parshape</code>
command</a> in LaTeX or Plain TeX lets you define any shape for the current
paragraph, but it&#39;s verbose and cumbersome, because you need to type in a
list of line lengths and indents, following the number of lines that you
want it to apply to. Wouldn&#39;t it be nice to be able to simply say that you
would like a paragraph to have the shape of a particular mathematical
expression? Here is a little LaTeX document that typesets the beginning of
a great American novel in the wavy shape of the cos<sup>2</sup>
function:</p>

<pre>    \documentclass{article}
    \usepackage{luacode}
    \usepackage{fontspec}
    \begin{document}
    \setlength{\parindent}{0pt}
    \pagestyle{empty}
    \begin{luacode*}
	function mpshape()
	    shape = &#34;&#34;
	    n = 23
	    bl = 10
	    for i = 1, n do
	       indent = string.format(&#34;%4f&#34;, 2*math.cos(i*2*math.pi/n)^2)
	       length = string.format(&#34;%4f&#34;, bl - 2*indent)
	       shape = shape..&#34; &#34;..indent..&#34;cm &#34;..length..&#34;cm&#34;
	    end
	    tex.sprint(&#34;\\parshape= &#34;..n..&#34; &#34;..shape)
	end
    \end{luacode*}
    
    \luadirect{mpshape()}
    Call me Ishmael. Some years ago—never mind how long precisely—having [text deleted]
    
    \end{document}
</pre>

<p>Here is the output:</p>

<blockquote>
<img src="https://lwn.net/images/2017/luatex-fig1.png" alt="[Opening of Moby Dick in a
wavy shape.]" width="600" height="525"/>
</blockquote>

<p>A few things here need a little explanation. We need to include the
fontspec package to enable Unicode input: this should be a standard part of
your preamble if you are using LuaTeX, in which case you probably have a
handful of additional fontspec commands to set up your fonts (the em-dashes
in the input are the only Unicode here). The <code>luacode*</code>
environment passes its contents directly to Lua, and frees you from
worrying about escaping special TeX characters such as backslashes. This is
explained in the <a href="http://mirrors.ibiblio.org/CTAN/macros/luatex/latex/luacode/luacode.pdf">documentation</a>
for the <code>luacode</code> LaTeX package. Everything
between the lines <code>\begin{luacode*}</code> and
<code>\end{luacode*}</code> is not TeX, but pure Lua. The Lua code here
serves to define the function <code>mpshape</code>, that takes no
arguments. The function uses an &#34;arithmetic for&#34; loop with a
common syntax. Note that all blocks are terminated with
<code>end</code>, and that white space is insignificant (except
for comments). The &#34;..&#34; operator used several times is string
concatenation; Lua converts numbers to strings as needed.</p>

<p>We&#39;ve used string formatting, which works in Lua just as in C and many
other languages. The dimensions are in cm, and <code>bl</code> is the
unaltered line length. This document follows a common pattern, which is to
define some functions in a <code>luacode*</code> environment, and invoke
them in the document as needed. You can also put the function definitions
in an external file.</p>

<p>When you want to actually execute some Lua code, call it as the argument
of a <code>luadirect</code> command. Here you must use caution if you are
inserting Lua code directly rather than merely calling a function, as we do
here: the one place where line breaks are significant in Lua is in
comments, which begin with &#34;--&#34; and extend to the end of the
line. But TeX changes line breaks to spaces, which means that a comment in
your code will comment out everything that comes after it. Here the
<code>luadirect</code> command runs our <code>mpshape</code> function,
which in turn inserts the <code>parshape</code> command into the TeX
stream. I&#39;ve kept things simple for illustration, but you can easily see
how this could be generalized. Since Lua has an <code>eval</code> function,
you could pass a mathematical expression into <code>mpshape</code> as an
argument, along with values for <code>bl</code> and <code>n</code> (the
number of lines to process, here hard-coded as 23, which I found by trial
and error).</p>

<h4>Altering typesetting with callbacks</h4>

<p>There is a whole different level of Lua-TeX integration afforded by
<em>callbacks</em> from TeX&#39;s processing stages. TeX processes documents in
a series of steps, such as reading input, hyphenating, inserting glue,
ligaturing, breaking lines, and many more (see the LuaTeX reference manual
linked to above). At each of these stages, TeX is dealing with a linked
list of <em>nodes</em>, which are elements such as glyphs, kerns, lines,
etc., with associated collections of properties. In order to modify one of
TeX&#39;s processing stages, you write a Lua function that manipulates the
relevant node list, and register this function as a callback
attached to the stage. When the TeX engine reaches the stage in question,
it will call the registered function, and continue as normal after it
returns, but with a modified node list.</p>

<p>Here is a example of a LaTeX document that uses this technique to
gradually decrease the grey value of each line in a paragraph, creating a
fade-out effect. Consider that it would be impossible to create this effect
by, for example, inserting color commands in the input file, because one
does not know where TeX will break lines until one actually runs the
document through it; and the line breaks depend on the line width. You need
to insert the color commands as part of the line breaking process, and this
is precisely what LuaTeX callbacks enable.</p>

<p>Here is a complete document that you can process with the
<code>lualatex</code> command to get the output in the figure. It will make
more sense than it does at first glance after the explanation that
follows.</p>

<pre>    \documentclass{article}
    \usepackage{luacode}
    \usepackage{fontspec}
    \usepackage[total={10cm,25cm},centering]{geometry}
    \begin{document}
    \setlength{\parindent}{0pt}
    \pagestyle{empty}
    \begin{luacode*}
    
        function fadelines(head)
            WHAT = node.id(&#34;whatsit&#34;)
            COL = node.subtype(&#34;pdf_colorstack&#34;)
            colorize = node.new(WHAT,COL)
            gvalue = 0
            for line in node.traverse_id(0,head) do
                colorize.data = gvalue..&#34; g&#34;
                node.insert_before(head, line, node.copy(colorize))
                gvalue = math.min(gvalue + 0.06, 1)
            end
            return head
        end
    
        luatexbase.add_to_callback(&#34;post_linebreak_filter&#34;, fadelines, &#34;fadelines&#34;)
    
    \end{luacode*}
    
    
    Call me Ishmael. [text deleted]
    
    \end{document}
</pre>

<p>Here is the result:</p>

<blockquote>
<img src="https://lwn.net/images/2017/luatex-fig2.png" alt="[Opening of Moby Dick
fading out.]" width="600" height="424"/> 
</blockquote>

<p>The <code>luacode</code> section starts with another function
definition, this time taking an argument that is the <code>head</code> of
a list of TeX nodes; which list of nodes it gets passed will be determined later
by how the function is registered as a callback. The first three lines of
the function define <code>colorize</code> to be a &#34;whatsit&#34; node,
which is a node type used for such things as PDF output. The
<code>for</code> block loops over nodes of type 0, which are &#34;hlist
nodes&#34;, beginning at the <code>HEAD</code>. For each node it defines a
string with the value &#34;gvalue g&#34;, where the number
<code>gvalue</code> starts at 0 (full black) and increases by 0.06 at each
iteration. The string is used as a new value for the <code>data</code>
field of the <code>colorize</code> node, which is then inserted before the
current node. The <code>node.insert_before</code> function takes care of
keeping the link structure correct as the new node is inserted into the
linked list. When TeX constructs the output PDF, the colorize nodes become
constructs that set the color.</p>

<p>After the function definition, the
<code>luatexbase.add_to_callback</code> call registers the function as a
callback attached to the post-linebreak phase. Our function
<code>fadelines</code> will be called immediately after TeX finishes
breaking the text into lines. The node list traversed by the function will
be the final, typeset list of lines. The string in the final argument can
be any label, and is used for a subsequent unregister command if
desired.</p>

<p>If all this seems a bit arcane, that&#39;s because it is. There is little in
the way of gentle tutorial material to teach one how to do this kind of
work. But, after studying some <a href="http://mirrors.ibiblio.org/CTAN/macros/luatex/generic/chickenize/chickenize.pdf">example
code [52-page amusing PDF]</a>, carefully reading a few sections of the
reference manual, and some experimentation, I was pleasantly surprised at
how quickly I could go from an idea to a working implementation. Although
anything that you can do with these techniques you could also do, in
theory, by programming purely in TeX, using Lua and the interfaces defined
in the LuaTeX project is far simpler. If you&#39;ve had the pleasure of trying
to read and understand a LaTeX style file, for example, the code here will
seem far less arcane by comparison.</p>

<p>A simple modification of our <code>fadelines</code> function will change
the color of the output text letter-by-letter. Here is the new function and
its output:</p>

<pre>    function fadelines(head)
        GLYPH = node.id(&#34;glyph&#34;)
        WHAT = node.id(&#34;whatsit&#34;)
        COL = node.subtype(&#34;pdf_colorstack&#34;)
        colorize = node.new(WHAT,COL)
        cvalue = 0
        for line in node.traverse_id(GLYPH,head) do
            colorize.data = cvalue..&#34; &#34;..1 - cvalue..&#34; .5&#34;..&#34; rg&#34;
            node.insert_before(head, line, node.copy(colorize))
            cvalue = math.min(cvalue + .0008, 1)
        end
        return head
    end

    luatexbase.add_to_callback(&#34;pre_linebreak_filter&#34;, fadelines, &#34;fadelines&#34;)
</pre>

<blockquote>
<img src="https://lwn.net/images/2017/luatex-fig3.png" alt="[Rainbow Moby Dick.]" width="600" height="445"/>
</blockquote>

<p>At the beginning of the function the <code>GLYPH</code> variable is set
to the node representing a single printed character. The constructed string
used for the <code>data</code> field of the coloring node now has the form
&#34;<code>R G B rg</code>&#34;, and is made to change gradually as the
loop traverses the <code>GLYPH</code> nodes. Finally, we register the
function to the <code>pre_linebreak_filter</code> callback, to get access
to the list of glyph nodes.</p>

<h4>Parting words</h4>

<p>Since any LuaTeX document may contain any code whatsoever in the form of
embedded Lua scripts, you must use caution in processing documents from
untrusted sources. &#34;Normal&#34; TeX has traditionally refused to run
operating system commands (to run external programs, for example) unless
you specifically enabled them, but that safety check is absent from
LuaTeX. You can, however, invoke <code>lualatex</code> with the
<code>--safer</code> flag, which disables several features that could cause
mischief, including spawning processes and creating files. See pp. 44-45 of
the above-linked reference manual for details.</p>

<p>If you are undertaking a large project using LaTeX, such as writing a
textbook, or a series of smaller projects where you may want to get TeX to
perform typesetting tricks that are not covered by a LaTeX package, I
believe it is well worth it to become acquainted with the techniques
described here. Although TeX is a Turing-complete language, actually
writing TeX code to do anything non-trivial is dark magic. In contrast,
after very little study you can do things with LuaTeX that would be
practically impossible without it. Lua is pleasant to program in. The
ability to insert the results of Lua computations into the TeX document is
already immensely useful; the next level, direct access to TeX internals,
gives you <a href="http://wiki.luatex.org/index.php/TeX_without_TeX">powers</a> that
used to be the exclusive possession of the most advanced TeX wizards.</p></div></div>
  </body>
</html>
