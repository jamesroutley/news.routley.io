<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://xenodium.com/introducing-agent-shell">Original</a>
    <h1>Emacs agent-shell (powered by ACP)</h1>
    
    <div id="readability-page-1" class="page">
    
    














    
    <time datetime="2025-09-25T00:00:00.000Z">September 25, 2025</time>
    
    <p>Not long ago, I <a href="https://xenodium.com/introducing-acpel">introduced acp.el</a>, an Emacs lisp implementation of ACP (<a href="https://agentclientprotocol.com">Agent Client Protocol</a>), the agent protocol <a href="https://zed.dev/blog/claude-code-via-acp">developed between Zed and Google folks</a>.</p>
<p>While I&#39;ve been happily accessing LLMs from my beloved text editor via <a href="https://github.com/xenodium/chatgpt-shell">chatgpt-shell</a> (a <a href="https://xenodium.com/a-tiny-upgrade-to-the-llm-model-picker">multi-model</a> package I built), I&#39;ve been fairly slow on the AI agents uptake. Probably a severe case of <a href="https://knowyourmeme.com/memes/old-man-yells-at-cloud">old-man-shouts-at-cloud</a> sorta thing, but hey I want well-integrated tools in my text editor. When I heard of ACP, I knew this was the thing I was waiting for to play around with agents.</p>
<p>With an early <a href="https://github.com/xenodium/acp.el">acp.el</a> client library in place, I set out to build an Emacs-native agent integrationâ€¦ Today, I have an initial version of <a href="https://github.com/xenodium/agent-shell">agent-shell</a> I can share.</p>
<p><img src="https://xenodium.github.io/images/introducing-agent-shell/agent-shell.png" alt=""/></p>
<p><code>agent-shell</code> is a native Emacs shell, powered by <a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Shell-Prompts.html">comint-mode</a> (check out Mickey&#39;s <a href="https://www.masteringemacs.org/article/comint-writing-command-interpreter">comint article</a> btw). As such, we don&#39;t have to dance between char and line modes to interact with things. <code>agent-shell</code> is just a regular Emacs buffer like any other you&#39;re used to.</p>
<h2 id="agent-agnostic" tabindex="-1">Agent-agnostic</h2>
<p>Thanks to ACP, we can now build agent-agnostic experiences by simply configuring our clients to communicate with their respective agents using a common protocol. As users, we benefit from a single, consistent experience, powered by any agent of our choice.</p>
<p>Configuring different agents from <code>agent-shell</code> boils down which agent we want running in the comms process. Here&#39;s an example of Gemini CLI vs Claude Code configuration:</p>
<pre><code>(defun agent-shell-start-gemini-agent ()
  &#34;Start an interactive Gemini CLI agent shell.&#34;
  (interactive)
  (agent-shell--start
   :new-session t
   :mode-line-name &#34;Gemini&#34;
   :buffer-name &#34;Gemini&#34;
   :shell-prompt &#34;Gemini&gt; &#34;
   :shell-prompt-regexp &#34;Gemini&gt; &#34;
   :needs-authentication t
   :authenticate-request-maker (lambda ()
                                 (acp-make-authenticate-request :method-id &#34;gemini-api-key&#34;))
   :client-maker (lambda ()
                   (acp-make-client :command &#34;gemini&#34;
                                    :command-params &#39;(&#34;--experimental-acp&#34;)
                                    :environment-variables (list (format &#34;GEMINI_API_KEY=%s&#34; (agent-shell-google-key)))))))
</code></pre>
<pre><code>(defun agent-shell-start-claude-code-agent ()
  &#34;Start an interactive Claude Code agent shell.&#34;
  (interactive)
  (agent-shell--start
   :new-session t
   :mode-line-name &#34;Claude Code&#34;
   :buffer-name &#34;Claude Code&#34;
   :shell-prompt &#34;Claude Code&gt; &#34;
   :shell-prompt-regexp &#34;Claude Code&gt; &#34;
   :client-maker (lambda ()
                   (acp-make-client :command &#34;claude-code-acp&#34;
                                    :environment-variables (list (format &#34;ANTHROPIC_API_KEY=%s&#34; (agent-shell-anthropic-key)))))))
</code></pre>
<p>I&#39;ve yet to try other agents. If you get another agent running, I&#39;d love to hear about it. Maybe submit a <a href="https://github.com/xenodium/agent-shell/pulls">pull request</a>?</p>
<h2 id="traffic" tabindex="-1">Traffic</h2>
<p>While I&#39;ve been relying on my <a href="https://github.com/xenodium/acp.el">acp.el</a> client library, I&#39;m still fairly new to the protocol. I often inspect traffic to see what&#39;s going on. After staring at json for far too long, I figured I may as well build some tooling around <a href="https://github.com/xenodium/acp.el">acp.el</a> to make my life easier. I added a traffic buffer for that. From <code>agent-shell</code>, you can invoke it via <code>M-x agent-shell-view-traffic</code>.</p>
<p><img src="https://raw.githubusercontent.com/xenodium/acp.el/refs/heads/main/traffic.gif" alt=""/></p>
<h2 id="fake-agents" tabindex="-1">Fake agents</h2>
<p>Developing <code>agent-shell</code> against paid agents got expensive quickly. Not only expensive, but my edit-compile-run cycle also became boringly slow waiting for agents. While I knew I wanted some sort of fake agent to work against, I didn&#39;t want to craft the fake traffic myself. Remember that traffic buffer I showed ya? Well, I can now save that traffic to disk and replay it later. This enabled me to run problematic sessions once and quickly replay multiple times to fix things. While re-playing has its quirks and limitations, it&#39;s done the job for now.</p>
<p>You can see a Claude Code session below, followed by its replayed counterpart via fake infrastructure.</p>
<p><img src="https://xenodium.github.io/images/introducing-agent-shell/claude.png" alt=""/></p>
<p><img src="https://xenodium.github.io/images/introducing-agent-shell/fake.png" alt=""/></p>
<h2 id="what&#39;s-next" tabindex="-1">What&#39;s next</h2>
<p>Getting here took quite a bit of work. Having said that, it&#39;s only a start. I myself need to get more familiar with agent usage and evolve the package UX however it feels most natural within its new habitat. Lately, I&#39;ve been experimenting with a quick diff buffer, driven by n/p keys, shown along the permission dialog.</p>
<pre><code>#+ATTR_HTML: :width 99%
</code></pre>
<p><a href="https://xenodium.github.io/images/introducing-agent-shell/diff.png"><img src="https://xenodium.github.io/images/introducing-agent-shell/diff.png" alt=""/></a></p>
<p>While I&#39;ve implemented enough parts of the <a href="https://agentclientprotocol.com/protocol/schema">Agent Client Protocol Schema</a> to make the package useful, it&#39;s hardly complete. I&#39;ve yet to fully familiarize myself with most protocol features.</p>
<h2 id="take-them-for-a-spin" tabindex="-1">Take them for a spin</h2>
<p>Both of my new Emacs packages, <a href="https://github.com/xenodium/agent-shell">agent-shell</a> and <a href="https://github.com/xenodium/acp.el">acp.el</a>, are now available on GitHub. As an agent user, go straight to <a href="https://github.com/xenodium/agent-shell">agent-shell</a>. If you&#39;re a package author and would like to build an ACP experience, then give <a href="https://github.com/xenodium/acp.el">acp.el</a> a try. Both packages are brand new and may have rough edges. Be sure to file bugs or feature requests as needed.</p>

<p>I&#39;ve been heads down, working on these packages for some time. If you&#39;re using cloud LLM services, you&#39;re likely already paying for tokens. If you find my work useful, please consider <a href="https://github.com/sponsors/xenodium">routing some of those coins</a> to help fund it. Maybe my tools make you more productive at work? Ask your <a href="https://github.com/sponsors/xenodium">employer to support the work</a>. These packages not only take time and effort, but also cost me money. <a href="https://github.com/sponsors/xenodium">Help fund the work</a>.</p>

    </div>
  </body>
</html>
