<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://georgek.github.io/blog/posts/multiple-web-projects-traefik/">Original</a>
    <h1>Working on Multiple Web Projects with Docker Compose and Traefik</h1>
    
    <div id="readability-page-1" class="page"><div id="outline-text-headline-4"><p>This doesn&#39;t quite solve our problem yet. We don&#39;t want all of our various projects
inside one compose file. Luckily Traefik communicates with the Docker daemon directly
and doesn&#39;t really care about the compose file, but you do need to make sure a few
things are in order for this to work.</p><p>Firstly, make a docker network especially for Traefik to communicate with other services
that you want to expose, for example:</p><div><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span></code></pre></td><td><pre tabindex="0"><code data-lang="yaml"><span><span><span># traefik/compose.yaml</span>
</span></span><span><span><span>services</span>:
</span></span><span><span>  <span>reverse-proxy</span>:
</span></span><span><span>    <span>image</span>: traefik:v2.10
</span></span><span><span>    <span>restart</span>: unless-stopped
</span></span><span><span>    <span>command</span>: --api.insecure=true --providers.docker
</span></span><span><span>    <span>ports</span>:
</span></span><span><span>      - <span>&#34;80:80&#34;</span>
</span></span><span><span>      - <span>&#34;8080:8080&#34;</span>
</span></span><span><span>    <span>volumes</span>:
</span></span><span><span>      - <span>&#34;/var/run/docker.sock:/var/run/docker.sock&#34;</span>
</span></span><span><span>    <span>networks</span>:
</span></span><span><span>      - traefik
</span></span><span><span>
</span></span><span><span><span>networks</span>:
</span></span><span><span>  <span>traefik</span>:
</span></span><span><span>    <span>attachable</span>: <span>true</span>
</span></span><span><span>    <span>name</span>: traefik</span></span></code></pre></td></tr></tbody></table></div></div></div><p>We create the network <code>traefik</code> and give it the name &#34;traefik&#34; (otherwise docker compose
would scope it by project, e.g. &#34;traefik_traefik&#34;). We also allow other containers to
attach to this network.</p><p>Then in our <code>compose.override.yaml</code> file from above, instead of mapping ports, we do the
following:</p><div><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span></code></pre></td><td><pre tabindex="0"><code data-lang="yaml"><span><span><span># proj/compose.override.yaml</span>
</span></span><span><span><span>services</span>:
</span></span><span><span>  <span>web</span>:
</span></span><span><span>    <span>labels</span>:
</span></span><span><span>      - <span>&#34;traefik.http.routers.proj.rule=Host(`proj.traefik.me`)&#34;</span>
</span></span><span><span>      - <span>&#34;traefik.http.services.proj.loadbalancer.server.port=8000&#34;</span>
</span></span><span><span>      - <span>&#34;traefik.docker.network=traefik&#34;</span>
</span></span><span><span>    <span>networks</span>:
</span></span><span><span>      - default
</span></span><span><span>      - traefik
</span></span><span><span>
</span></span><span><span><span>networks</span>:
</span></span><span><span>  <span>traefik</span>:
</span></span><span><span>    <span>external</span>: <span>true</span></span></span></code></pre></td></tr></tbody></table></div></div></div><p>Now, after bringing up first the traefik project then your web project, you should be
able to browse to <a href="http://proj.traefik.me/">http://proj.traefik.me/</a> in your web browser.</p><p>There&#39;s a few things going on here. First, we have declared the <code>traefik</code> network as an
external network. This means compose won&#39;t manage it, but expects it to exist (so you
must start your traefik composition first). Next we override the <code>networks</code> setting of
<code>web</code> to make it part of the <code>traefik</code> network too. Note we also have to add the
<code>default</code> network, otherwise it wouldn&#39;t be able to communicate with <code>db</code> and other
services on its own default network.</p><p>The <code>traefik.http.routers.proj.rule</code> label configures Traefik to route HTTP traffic with
the &#34;proj.traefik.me&#34; hostname to the container. The <code>traffic.docker.network</code> label is
necessary because <code>web</code> is on two networks. Finally, we set
<code>traefik.http.services.proj.loadbalancer.server.port</code> for completeness, just in case
your container needs a different port mapping than the port it is set to expose, or if
it exposes multiple ports.</p><p>There is one final piece of magic: the &#34;traefik.me&#34; hostname. What is that? You can
read about it at <a href="http://traefik.me/">http://traefik.me/</a>. Essentially it is a DNS service that resolves to
any IP address that you want, but by default it resolves <code>&lt;xxx&gt;.traefik.me</code> to
<code>127.0.0.1</code>. There are other services like this including <a href="https://sslip.io/">https://sslip.io/</a> and
<a href="https://nip.io/">https://nip.io/</a>.</p><p>Now, because we don&#39;t need to define any ports at all, it is possible to take advantage
of a newish compose feature and reinstate the ports in the original <code>compose.yaml</code> file
for those developers who don&#39;t want to set up Traefik for themselves. So our final
configuration looks like this:</p><div><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span></code></pre></td><td><pre tabindex="0"><code data-lang="yaml"><span><span><span># compose.yaml</span>
</span></span><span><span><span>services</span>:
</span></span><span><span>  <span>db</span>:
</span></span><span><span>    <span>image</span>: <span>&#34;postgres&#34;</span>
</span></span><span><span>    <span>environment</span>:
</span></span><span><span>      <span>POSTGRES_DB</span>: <span>&#34;proj&#34;</span>
</span></span><span><span>      <span>POSTGRES_USER</span>: <span>&#34;user&#34;</span>
</span></span><span><span>      <span>POSTGRES_PASSWORD</span>: <span>&#34;pass&#34;</span>
</span></span><span><span>
</span></span><span><span>  <span>web</span>:
</span></span><span><span>    <span>build</span>: .
</span></span><span><span>    <span>depends_on</span>:
</span></span><span><span>      - <span>&#34;db&#34;</span>
</span></span><span><span>    <span>environment</span>:
</span></span><span><span>      <span>DATABASE_URL</span>: <span>&#34;postgres://user:pass@db/proj&#34;</span>
</span></span><span><span>    <span>ports</span>:
</span></span><span><span>      - <span>&#34;8000:80&#34;</span></span></span></code></pre></td></tr></tbody></table></div></div></div><div><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span></code></pre></td><td><pre tabindex="0"><code data-lang="yaml"><span><span><span># compose.override.yaml (to be created by each developer)</span>
</span></span><span><span><span>services</span>:
</span></span><span><span>  <span>web</span>:
</span></span><span><span>    <span>labels</span>:
</span></span><span><span>      - <span>&#34;traefik.http.routers.proj.rule=Host(`proj.traefik.me`)&#34;</span>
</span></span><span><span>      - <span>&#34;traefik.http.services.proj.loadbalancer.server.port=8000&#34;</span>
</span></span><span><span>      - <span>&#34;traefik.docker.network=traefik&#34;</span>
</span></span><span><span>    <span>networks</span>:
</span></span><span><span>      - default
</span></span><span><span>      - traefik
</span></span><span><span>    <span>ports</span>: !reset []
</span></span><span><span>
</span></span><span><span><span>networks</span>:
</span></span><span><span>  <span>traefik</span>:
</span></span><span><span>    <span>external</span>: <span>true</span></span></span></code></pre></td></tr></tbody></table></div></div></div><p>The <code>!reset []</code> tag sets the ports back to empty; you can read about it <a href="https://docs.docker.com/compose/compose-file/13-merge/#reset-value">here</a>. Note that
unfortunately it can&#39;t be used to set <em>new</em> ports, only reset them to default (you would
have to use two layers of override file to set new ports). The <code>!reset</code> tag requires a
fairly recent version of docker compose, at least greater than 2.18.0.</p><p>A final note: you can check that these overrides are working correctly by running
<code>docker compose config</code>.</p></div></div>
  </body>
</html>
