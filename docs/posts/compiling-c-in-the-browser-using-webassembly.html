<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://wasmer.io/posts/clang-in-browser">Original</a>
    <h1>Show HN: Compiling C in the browser using WebAssembly</h1>
    
    <div id="readability-page-1" class="page"><div><p>Weâ€™ve reached a major milestone in making any software run with WebAssembly.
Thanks to the newest release of Wasmer (4.4) and the Wasmer JS SDK (0.8.0) you can now run clang anywhere Wasmer runs!</p>
<p>This allows compiling C programs from virtually anywhere. Including Javascript and your preferred browser! (we tested Chrome, Safari and Firefox and everything is working like a charm).</p>
<p>For those eager to see it in action, head over to <a href="http://wasmer.sh/">wasmer.sh</a> to try a live demo (note: it requires a 100MB download):</p>
<pre><code># NOTE: this will download the clang package (100Mb), so it might take a while...
wasmer run clang/clang example.c -o example.wasm
wasmer run example.wasm
</code></pre>
<blockquote>
<p>Note: we <a href="https://x.com/wasmerio/status/1234903250249273344?lang=en">attempted running clang</a> few years ago, but because of WASI limitations we were unable to call <code>posix_spawn</code> which limited the usage and usability of clang in the browser, Firefox and Safari were not supported by then but are fully supported now.</p>
</blockquote>
<hr/>
<p>Why is running <code>clang</code> with Wasmer useful, what use cases will enable?</p>
<ul>
<li>
<p>You can compile C code to WebAssembly easily just using the <code>wasmer</code> CLI: no toolchains or complex installations needed, install Wasmer and you are ready to go!</p>
</li>
<li>
<p><a href="https://wasix.org/">WASIX</a> is now self-hosted meaning it can compile itself and any C programs.</p>
</li>
<li>
<p>You can compile C projects directly from JavaScript! (Continue reading to learn how to use <code>clang</code> with the Wasmer JS SDK.)</p>
<p>We expect online IDEs to start adopting the SDK to allow their users compile and run C programs in the browser.</p>
</li>
<li>
<p><strong>Reproducible builds</strong> anywhere (using the same version of Wasmer)</p>
</li>
</ul>
<p>Enough with the tech talkâ€”letâ€™s see a demo!</p>
<p>Create a <code>donut.c</code> file with the following content (example taken from the awesome <a href="https://www.a1k0n.net/2011/07/20/donut-math.html">Donut Math</a>):</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

             k;double sin()
         ,cos();main(){float A=
       0,B=0,i,j,z[1760];char b[
     1760];printf(&#34;\x1b[2J&#34;);for(;;
  ){memset(b,32,1760);memset(z,0,7040)
  ;for(j=0;6.28&gt;j;j+=0.07)for(i=0;6.28
 &gt;i;i+=0.02){float c=sin(i),d=cos(j),e=
 sin(A),f=sin(j),g=cos(A),h=d+2,D=1/(c*
 h*e+f*g+5),l=cos      (i),m=cos(B),n=s\
in(B),t=c*h*g-f*        e;int x=40+30*D*
(l*h*m-t*n),y=            12+15*D*(l*h*n
+t*m),o=x+80*y,          N=8*((f*e-c*d*g
 )*m-c*d*e-f*g-l        *d*n);if(22&gt;y&amp;&amp;
 y&gt;0&amp;&amp;x&gt;0&amp;&amp;80&gt;x&amp;&amp;D&gt;z[o]){z[o]=D;;;b[o]=
 &#34;.,-~:;=!*#$@&#34;[N&gt;0?N:0];}}/*#****!!-*/
  printf(&#34;\x1b[H&#34;);for(k=0;1761&gt;k;k++)
   putchar(k%80?b[k]:10);A+=0.04;B+=
     0.02;}}/*****####*******!!=;:~
       ~::==!!!**********!!!==::-
         .,~~;;;========;;;:~-.
             ..,--------,*/
</code></pre>
<p>We can run clang with Wasmer and compile it to WASI and WASIX (<em>just make sure <a href="https://docs.wasmer.io/install">you have Wasmer installed locally</a>!</em>):</p>
<pre><code>$ wasmer run clang/clang --dir=. -- -Wno-implicit-int donut.c -o donut.wasm
$ wasmer run donut.wasm
</code></pre>
<p>To run clang on your browser, you can try the following on <a href="https://wasmer.sh">wasmer.sh</a> (we added <code>donut.c</code> to the <code>/home</code> dir so itâ€™s easier to try):</p>
<pre><code>wasmer run clang/clang -Wno-implicit-int donut.c -o donut.wasm
wasmer run /home/donut.wasm
</code></pre>
<p>The exciting news is that the clang package can compile, not just the donut c example, but any <a href="https://github.com/wasix-org/wasix-libc/blob/main/examples">complicated examples</a> from WASIX.</p>
<p>And more importantlyâ€¦ it works fully in the browser! (and also via the Wasmer Javascript SDK, read below to check the example of how to run clang in any of your Javascript projects!)</p>
<p><img src="https://wasmer.io/_next/image?url=https%3A%2F%2Fcdn.wasmer.io%2Fimages%2Fclang-donut.original.png&amp;w=1920&amp;q=75" alt="Donut compiled to Wasm in the browser"/></p>
<blockquote>
<p>Note: the <code>clang/clang</code> package currently weights about 100Mb uncompressed (as it requires the clang binaries + the system libraries). We are working on reducing the size and also serving it in compressed format. So ideally you should just need to download ~30Mb to use clang with Wasmer: either in your local shell, in your browser or in your Javascript project!</p>
</blockquote>
<h2>Javascript SDK usage</h2>
<p>Do you want to use <code>clang</code> in your Javascript project? Thanks to our newly released <a href="http://wasmer.io/posts/introducing-wasmer-js-wdk">Wasmer JS</a> SDK you can do it easily, in both the browser and Node.js/Bun etc:</p>
<pre><code>
import {
  init,
  Wasmer,
  Directory
} from &#34;https://unpkg.com/@wasmer/sdk@latest/dist/index.mjs&#34;;

await init();

const clang = await Wasmer.fromRegistry(&#34;clang/clang&#34;);
const project = new Directory();
await project.writeFile(&#34;example.c&#34;,
`#include&lt;stdio.h&gt;

int main() {
  printf(&#34;Hello World&#34;);
  return 0;
}
`);

let instance = await clang.entrypoint.run({
  args: [&#34;/project/example.c&#34;, &#34;-o&#34;, &#34;/project/example.wasm&#34;],
  mount: { &#34;/project&#34;: project },
});
const output = await instance.wait();

if (!output.ok) {
  throw new Error(`Clang failed. Exit: ${output.code}:`);
}

// The generated wasm file from clang
let wasm = await project.readFile(&#34;example.wasm&#34;);

const example = await Wasmer.fromFile(wasm);
const result = await example.entrypoint.run();
const outputExample = await result.wait();

// This should be &#34;Hello World&#34;
console.log(outputExample.stdout);
</code></pre>
<p>You can find a working <code>index.html</code> file executing clang: <a href="https://github.com/wasmerio/wasmer-js/blob/main/examples/clang-cdn/index.html">https://github.com/wasmerio/wasmer-js/blob/main/examples/clang-cdn/index.html</a></p>
<h3>One last thing! ðŸª„</h3>
<p>Wasmerâ€™s clang can even <strong>optimize the file for you automatically</strong> using <code>wasm-opt</code> under the hood (Clang automatically detects if <code>wasm-opt</code> is used, and it will be automatically called when optimizing the file)</p>
<pre><code>wasmer run clang/clang --use wasmer/wasm-opt --dir=. -- -o example.wasm -O2
</code></pre>
<p>Imagine using Emscripten without needing its toolchain installedâ€”or even better, imagine running Emscripten in the browser. We&#39;ve made this possible thanks to the <a href="https://wasix.org/"><strong>WASIX</strong></a> ecosystem ðŸŽ‰.</p>

<p>We are incredibly excited for this milestone, as it opens the door for many upcoming features that we are going to need in Wasmer and Wasmer Edge:</p>
<ul>
<li>
<p>Compiling <strong>native Python libraries</strong> directly from within WASIX. Imagine being able to have PIP compiling things in Wasm upon install, e.g.:</p>
<pre><code>wasmer run python --entrypoint pip -- install numpy # This compiles numpy to WASIX, all within Wasmer processes
</code></pre>
</li>
<li>
<p>Using <strong><a href="https://wasmer.io/posts/py2wasm-a-python-to-wasm-compiler">py2wasm</a></strong> with a bundled compiler</p>
</li>
<li>
<p>Compiling <a href="https://medium.com/@elves.silva.vieira/javascript-achieves-breakthrough-performance-with-static-hermes-6286b0ac8ef7">Static Hermes</a> to WASIX, so we can generate native Wasm files from JS.</p>
</li>
<li>
<p>New tooling? (any project depending on LLVM can now be easily compiled to WebAssembly!)</p>
</li>
</ul>
<p>This is the beginning of an awesome journey, we can&#39;t wait to see what you create next with this.</p>
<p>Feel free to give Wasmer a star if you liked the article or tell us how you are thinking on using the project:</p>
<ul>
<li>Github: <a href="https://github.com/wasmerio/wasmer">https://github.com/wasmerio/wasmer</a></li>
<li>Or join us in our Discord: <a href="https://discord.gg/rWkMNStrEW">https://discord.gg/rWkMNStrEW</a></li>
</ul>
<hr/>
<p>I want to give a special mention to Sebastien, who made the hard work on compiling clang to WASIX possible. Check his personal project, box86, if you want to see more awesome programs running anywhere: <a href="https://box86.org/">box86.org</a></p></div></div>
  </body>
</html>
