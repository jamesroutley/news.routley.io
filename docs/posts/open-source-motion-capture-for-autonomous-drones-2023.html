<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://joshuabird.com/blog/post/mocap-drones">Original</a>
    <h1>Open Source Motion Capture for Autonomous Drones (2023)</h1>
    
    <div id="readability-page-1" class="page"><div id="main-row">
			<div id="main-col">

				

				<div>
					<h2>Introduction</h2>
<p>While the core content of my motion capture drones project is on the YouTube video, I thought I should create a blog post with some additional details and my own thoughts on the project. If you haven&#39;t watched the video do that first, it covers all the fun stuff.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/0ql20JKrscQ?si=xHhHJlPGrH6qom_W" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe>
<h2>Motivation</h2>
<p>Like most of my projects, I ended up doing this just because I thought it would be really cool. There are so many incredible videos of drone swarms on YouTube, but they all used motion capture setups that cost tens of thousands of dollars. I thought it would be fun to try create my own indoor drone swarm, so I started looking for open source motion capture systems. There are a ton of single camera motion capture systems for humans (mostly developed for v-tubers? seriously haha), but shockingly little work done for robotics motion capture. There is <a href="https://youtu.be/XIw9cZ8i4mE?si=-nn8RndDR8YR7LKy">one video</a> from a few years ago which shows a similar PS3 eye motion capture system used for humanoid tracking, but the creator seems against releasing the source code which is a shame.</p>
<p>So yeah, this project is an attempt to fill the void of open source motion capture systems. I decided to fly drones with it as a flashy demonstration of what kinds of things it can be used for; it&#39;s a nice way to wrap the project up into a cool real world demonstration that grabs people&#39;s imagination â€“ something which I feel more open source projects should do!</p>
<h2>The Drone</h2>
<p>I&#39;ve gotten a lot of questions about the drones I used in this project, which I guess should be expected since they are the (visual) star of the show!</p>
<p>Initially, I looked into buying off the shelf researched focused micro drones, like the <a href="https://store.bitcraze.io/products/crazyflie-2-1">CrazyFlie</a> or <a href="https://store.espcopter.com/product/espcopter-full-kit/">EspCopter</a>, but they all were quite expensive. In the low-cost spirit of this project, I decided to build my own mini drones.</p>
<p>I considered using something like the <a href="https://www.aliexpress.com/item/1005005993270358.html">ESP-Drone</a>, which can be bought for really cheap online. However, that would require developing / adapting flight controller software to run on the ESP32, which I knew would be a project in its self. I instead decided to just build a small drone with an ESP32 emulating an RC receiver. This solution is nice because it also allows my system to be used with any drone and flight controller.</p>
<p>Below are the parts I used to build my drone:</p>
<table>
<thead>
<tr>
<th>Device</th>
<th>Price</th>
<th>Name</th>
<th>Comments</th>
</tr>
</thead>
<tbody>
<tr>
<td>Flight controller</td>
<td>$23</td>
<td><a href="https://www.aliexpress.com/item/1005001674141725.html">F3 EVO Micro Brushed Flight Controller</a></td>
<td>Running <a href="https://betaflight.com/">BetaFlight</a></td>
</tr>
<tr>
<td>Frame Motor &amp; Props</td>
<td>$13</td>
<td><a href="https://www.aliexpress.com/item/32776829828.html">Generic 95mm brushed drone frame, 8520 brushed motors, 55mm props</a></td>
<td></td>
</tr>
<tr>
<td>Battery</td>
<td>$5</td>
<td><a href="https://www.fogstar.co.uk/collections/batteries/products/ydl-18350-battery">YDL 18350</a></td>
<td>1100mah, 9A</td>
</tr>
<tr>
<td>Battery holder</td>
<td>$0.5</td>
<td><a href="https://www.aliexpress.com/item/1005001346705221.html">1S 18350 battery holder</a></td>
<td></td>
</tr>
<tr>
<td>IR markers</td>
<td>$0.1</td>
<td>3mm IR Led</td>
<td>You need to sandpaper the surface so they emit light evenly, instead of just up</td>
</tr>
<tr>
<td>ESP32 receiver</td>
<td>$4</td>
<td><a href="https://www.aliexpress.com/item/32858054775.html">WEMOS D1 Mini ESP32 USB-C</a></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>Total cost: ~$50 USD</li>
<li>Flight time: ~10min</li>
<li>Thrust/Weight: Very shit lol. Maybe 1.5?</li>
</ul>
<p>The flight controller had to run some ancient version of BetaFlight since it has the old f3 microprocessor, but for what I&#39;m doing that was totally fine.</p>
<p>The LEDs are attached to the drone using stiff wires, which also carry the power. The whole drone was surprisingly crash resistant, it probably crashed over 100 times but the thing is so light and the props are so small that it never really broke. The weak point is definitely the brushed motors, which give out after a few hours of flying. It probably didn&#39;t help that I bought the cheapest, shittiest brushed motors I could find on Aliexpress lol.</p>
<p>If I decided to fully commit to making a drone swarm, I would definitely use the esp-drone platform. It would be a pain to get flying, but it would cut out so many components from the system since the ESP32 would both wirelessly receive messages and control the motors. It would literally just a flying pcb, so it should be able to get really good flight times.</p>
<h2>Cameras</h2>
<p>In the video I kinda breezed over a lot of the details of the cameras, but there is a fair bit of nuance involved to convert the PS3 eye cameras to the infrared cameras I used in this project.</p>
<p>There are two options to doing this:</p>
<h4>Option 1: Use the original lens</h4>
<p>This is what I did.</p>
<p>Pros:</p>
<ul>
<li>No extra hardware needed</li>
</ul>
<p>Cons:</p>
<ul>
<li><em>Not all PS3 eye cameras can be converted using this method</em></li>
<li>Quite difficult and finicky</li>
</ul>
<p>The biggest downside of this method is that it doesn&#39;t work for all PS3 cameras. Only the &#34;old&#34; type of PS3 cameras that have a curved front lens element and no white ring inside the lens can be used. This is really annoying because you often can&#39;t tell if a camera is the new or old type when looking at ebay listings, etc. I just bought 8 cameras for $1 each, and 5 of them ended up being the correct type.</p>
<p><img src="https://joshuabird.com/assets/blog/index/img/mocap-drones/1.jpeg" alt=""/></p>
<p><span>The good and bad PS3 eye camera types. Trust me it&#39;s impossible with the bad type. [Source](https://www.youtube.com/watch?v=ZOJoVTcl_XE)</span></p><p>Here are the steps:</p>
<ol>
<li>Remove the outer plastic shell</li>
<li>Unscrew the lens mount</li>
<li>Use a small sharp knife or soldering iron to cut <em>around</em> the pink IR cut filter inside the lens. Don&#39;t just shatter the glass, cut around it and pry it out. This will take a while (it took me like 30min my first time).</li>
<li>Removing the IR cut filter changes the focal length of the lens, so we need to make the lens closer to the sensor for the image to be in focus. Use course sandpaper or a file to file down the lens mount by a small amount, checking every few minutes if the image is in focus or not. If you file away too much, you can use a piece of tape or something as a shim. The sweet spot is a fraction of a mm, so be careful. If you don&#39;t do this step your images will be out of focus!</li>
<li>Glue the floppy disk IR filter on the outside of the lens</li>
</ol>
<p>There are tons of tutorials online, <a href="https://www.youtube.com/watch?v=ZOJoVTcl_XE">this one</a> is pretty good.</p>
<h4>Option 2: Use a new lens</h4>
<p>I didn&#39;t do this, but if I were to do it again I would definitely do it this way. I don&#39;t see any reason why it won&#39;t work.</p>
<p>Pros:</p>
<ul>
<li>Much easier and faster to do</li>
<li>Any PS3 eye camera can be used</li>
</ul>
<p>Cons:</p>
<ul>
<li>Requires you to buy a new lens</li>
</ul>
<p>Basically, instead of going through the hassle of removing the IR cut filter from the original lens and filing down the mount, just throw away the original lens a put a new one on. The new lens needs to have a reasonably large field of view and <em>no IR cut filter</em> so it can let IR light through. These types of lenses are often marketed as &#34;night vision&#34; security camera lenses or something like that. You also need to buy a lens that has the correct mount to fit on the PS3 eye PCB, or just 3D print a mount.</p>
<p>Here are the steps:</p>
<ol>
<li>Remove the outer plastic shell</li>
<li>Unscrew the lens mount</li>
<li>Screw on the new lens mount</li>
<li>Glue the floppy disk IR filter on the outside of the lens</li>
</ol>
<p>Wow, that was easy.</p>
<h4>PS3 eye shutter sync</h4>
<p>Another reason why the PS3 eye is great for this application is because you can physically sync all the camera&#39;s shutters, so they take pictures at the same time. The shutter sync signal wire can be found on the PCB (google it for details), and then you can pulse a sync signal to all the cameras. My camera case has space for a 3.5mm jack which can be used to daisy-chain the camera&#39;s shutter sync signals together.</p>
<p>I didn&#39;t actually end up using this feature, however. The signal wire on the PCB is really hard to find, and is in different places depending on the camera iteration. I also got some weird artifacts when using the sync signal, and I didn&#39;t really notice an increase in accuracy. I think that the low resolution of these cameras (320x240) and relatively slow speeds of the drones means that the impact of shutter syncing is pretty negligible. If you pushed the system up to 150fps and had fast moving objects, the shutter sync pulse would probably be very useful.</p>
<h4>Building the rest of the camera</h4>
<p>We also need to 3D print the case and swivel mount for the camera. You can find the files on the GitHub repo.</p>
<p>Here are a list of parts I used to build the camera:</p>
<table>
<thead>
<tr>
<th>Device</th>
<th>Price</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr>
<td>PS3 Eye</td>
<td>$1</td>
<td><a href="https://uk.webuy.com/product-detail?id=spseyee001">CeX</a></td>
</tr>
<tr>
<td>IR Ring Floodlight</td>
<td>$0.9</td>
<td><a href="https://www.aliexpress.com/item/1005004769256780.html?spm=a2g0o.order_list.order_list_main.65.39b21802Y7okmP">Aliexpress</a></td>
</tr>
<tr>
<td>5m USB Active Extension Cable</td>
<td>$4</td>
<td><a href="https://www.aliexpress.com/item/1005005291924270.html?spm=a2g0o.order_list.order_list_main.70.39b21802Y7okmP">Aliexpress</a></td>
</tr>
<tr>
<td>3.5mm Jack Plug</td>
<td>$0.2</td>
<td><a href="https://www.aliexpress.com/item/32829236032.html?spm=a2g0o.order_list.order_list_main.95.39b21802Y7okmP">Aliexpress</a></td>
</tr>
<tr>
<td>3m 3.5mm Extension Cable</td>
<td>$1</td>
<td><a href="https://www.aliexpress.com/item/1005001869220220.html">Aliexpress</a></td>
</tr>
</tbody>
</table>
<p>The 3.5mm jack and extension cable are only needed if you want to sync the shutters.</p>
<h2>Conclusion / Rambly Reflection</h2>
<p>This project worked out really well â€“ I&#39;m kinda blown away by how accurate it ended up being. I still can&#39;t believe that there isn&#39;t any big open source motion capture system, at least none that I&#39;ve seen so far. It kinda ashames me that my shitty undocumented code is like the most starred non-humanoid motion capture repository under the &#34;motion-capture&#34; tag on GitHub.</p>
<p>I briefly mentioned this in the video, but I was also working at Palantir this summer as an intern. I had an amazing time working there, I mean they had three free meals a day, unlimited alcohol, drinks and snacks â€“ what else could you ask for. The combination of loving your job and free food is a dangerous one, as I would literally stay for dinner every day (I made up for this by coming in to work later than I probably should have lol). Unfortunately, this didnâ€™t give me much free time to work on my drone project, but that didnâ€™t really stop me.</p>
<p>Most days would be 10am-6pm at Palantir and then 7pm-2am working on my motion capture drones (thankfully I lived 10min from work). It absolutely wasnâ€™t a healthy work-life balance, but thatâ€™s the downside of loving coding. From an outside perspective, I can see why it could look pretty sad to spend most of my day writing code, but I guess I do it because I really do love it. Just as some people watch Netflix, crochet or play video games to unwind after work, I like to code. Which is a bit confusing because I also write code for work, but I guess I&#39;m just very lucky.</p>
<p>However, even I have a limit to how much programming I can do before losing my mind. I was definitely feeling pretty burnt out by the end of my 3 month summer, causing me to slow down on the drone project and focus more on work and simply relaxing. Uni started the Monday after I finished my internship, so that definitely was the right call as Cambridge terms are notoriously flat out.</p>
<p>It is nice to have worked on a proper coding project after years of film photography projects, my website was becoming a bit overrun with them haha</p>

				</div>
			</div>
		</div><div id="suggestions-row">
			<div id="suggestions-main-col">
				<h2>Read More:</h2>
									<div data-postinternalname="my-life-in-data">
						<p><img src="https://joshuabird.com/assets/blog/index/img/my-life-in-data/thumbnail.jpeg"/>
						</p>
						<p>
							
							<h5>Visualising my sleep, Spotify, social media habits and everything in between</h5>
							
						</p>
					</div>

											
														<div data-postinternalname="flowblocks">
						<p><img src="https://joshuabird.com/assets/blog/index/img/flowblocks-thumnail.jpeg"/>
						</p>
						<p>
							
							<h5>Cambridge group project for the Raspberry Pi Foundation</h5>
							
						</p>
					</div>

											
														<div data-postinternalname="3d-printed-film-video-camera">
						<p><img src="https://joshuabird.com/assets/blog/index/img/3d-printed-film-video-camera/thumbnail.jpg"/>
						</p>
						<p>
							
							<h5>An expensive and unreliable way to record low quality videos!</h5>
							
						</p>
					</div>

												</div>
		</div></div>
  </body>
</html>
