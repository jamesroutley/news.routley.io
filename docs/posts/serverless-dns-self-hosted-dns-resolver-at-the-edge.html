<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/serverless-dns/serverless-dns">Original</a>
    <h1>Serverless DNS: Self-hosted DNS resolver at the edge</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><h4 dir="auto"><a id="user-content-its-a-bird-its-a-plane-its-a-self-hosted-pi-hole-esque-dns-resolver" aria-hidden="true" href="#its-a-bird-its-a-plane-its-a-self-hosted-pi-hole-esque-dns-resolver"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>It&#39;s a bird, it&#39;s a plane, it&#39;s... a self-hosted, pi-hole esque, DNS resolver</h4>
<p dir="auto"><em>serverless-dns</em> is a Pi-Hole esque <a href="https://github.com/serverless-dns/blocklists">content-blocking</a>, serverless, stub DNS-over-HTTPS (DoH) and DNS-over-TLS (DoT) resolver. Runs out-of-the-box on <a href="https://workers.dev" rel="nofollow">Cloudflare Workers</a>, <a href="https://deno.com/deploy" rel="nofollow">Deno Deploy</a>, and <a href="https://fly.io/" rel="nofollow">Fly.io</a>. Free tiers of all these services should be enough to cover 10 to 20 devices worth of DNS traffic per month.</p>
<h3 dir="auto"><a id="user-content-the-rethinkdns-resolver" aria-hidden="true" href="#the-rethinkdns-resolver"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>The RethinkDNS resolver</h3>
<p dir="auto">RethinkDNS runs <code>serverless-dns</code> in production at these endpoints:</p>
<table>
<thead>
<tr>
<th>Cloud platform</th>
<th>Server locations</th>
<th>Protocol</th>
<th>Domain</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td><g-emoji alias="partly_sunny" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/26c5.png">â›…</g-emoji> Cloudflare Workers</td>
<td>200+ (<a href="https://check-host.net/check-ping?host=https://basic.rethinkdns.com" rel="nofollow">ping</a>)</td>
<td>DoH</td>
<td><code>basic.rethinkdns.com</code></td>
<td><a href="https://rethinkdns.com/configure?p=doh" rel="nofollow">configure</a></td>
</tr>
<tr>
<td><g-emoji alias="sauropod" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f995.png">ðŸ¦•</g-emoji> Deno Deploy</td>
<td>30+ (<a href="https://check-host.net/check-ping?host=https://deno.dev" rel="nofollow">ping</a>)</td>
<td>DoH</td>
<td><em>private beta</em></td>
<td></td>
</tr>
<tr>
<td><g-emoji alias="parachute" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1fa82.png">ðŸª‚</g-emoji> Fly.io</td>
<td>30+ (<a href="https://check-host.net/check-ping?host=https://max.rethinkdns.com" rel="nofollow">ping</a>)</td>
<td>DoH and DoT</td>
<td><code>max.rethinkdns.com</code></td>
<td><a href="https://rethinkdns.com/configure?p=dot" rel="nofollow">configure</a></td>
</tr>
</tbody>
</table>
<p dir="auto">Server-side processing takes from 0 milliseconds (ms) to 2ms (median), and end-to-end latency (varies across regions and networks) is between 10ms to 30ms (median).</p>
<h3 dir="auto"><a id="user-content-self-host" aria-hidden="true" href="#self-host"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Self-host</h3>
<p dir="auto">Cloudflare Workers is the easiest platform to setup <code>serverless-dns</code>:</p>
<p dir="auto"><a href="https://deploy.workers.cloudflare.com/?url=https://github.com/serverless-dns/serverless-dns" rel="nofollow"><img src="https://camo.githubusercontent.com/6eb04703e85da31c430de46d32a904a7c55c0b3bc00811ae689f14faf91cd32e/68747470733a2f2f6465706c6f792e776f726b6572732e636c6f7564666c6172652e636f6d2f627574746f6e" alt="Deploy to Cloudflare Workers" data-canonical-src="https://deploy.workers.cloudflare.com/button"/></a></p>
<p dir="auto">For step-by-step instructions, refer:</p>
<table>
<thead>
<tr>
<th>Platform</th>
<th>Difficulty</th>
<th>Runtime</th>
<th>Doc</th>
</tr>
</thead>
<tbody>
<tr>
<td><g-emoji alias="partly_sunny" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/26c5.png">â›…</g-emoji> Cloudflare</td>
<td>Easy</td>
<td><a href="https://v8.dev" rel="nofollow">v8</a> <em>Isolates</em></td>
<td><a href="https://docs.rethinkdns.com/dns/open-source#cloudflare" rel="nofollow">Hosting on Cloudflare Workers</a></td>
</tr>
<tr>
<td><g-emoji alias="sauropod" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f995.png">ðŸ¦•</g-emoji> Deno.com</td>
<td>Moderate</td>
<td><a href="https://deno.land" rel="nofollow">Deno</a> <em>Isolates</em></td>
<td><a href="https://docs.rethinkdns.com/dns/open-source#deno-deploy" rel="nofollow">Hosting on Deno.com</a></td>
</tr>
<tr>
<td><g-emoji alias="parachute" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1fa82.png">ðŸª‚</g-emoji> Fly.io</td>
<td>Hard</td>
<td><a href="https://nodejs.org" rel="nofollow">Node</a> <em>MicroVM</em></td>
<td><a href="https://docs.rethinkdns.com/dns/open-source#fly-io" rel="nofollow">Hosting on Fly.io</a></td>
</tr>
</tbody>
</table>
<p dir="auto">To setup blocklists, visit <code>https://&lt;my-domain&gt;.tld/configure</code> from your browser (it should load something similar to <a href="https://rethinkdns.com/configure" rel="nofollow">RethinkDNS&#39; <em>configure</em> page</a>).</p>
<p dir="auto">For help or assistance, feel free to <a href="https://github.com/celzero/docs/issues">open an issue</a> or <a href="https://github.com/celzero/docs">submit a patch</a>.</p>
<hr/>
<h3 dir="auto"><a id="user-content-development" aria-hidden="true" href="#development"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Development</h3>
<h4 dir="auto"><a id="user-content-setup" aria-hidden="true" href="#setup"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Setup</h4>
<p dir="auto">Code:</p>
<div data-snippet-clipboard-copy-content="# navigate to work dir
cd /my/work/dir

# clone this repository
git clone https://github.com/serverless-dns/serverless-dns.git

# navigate to serverless-dns
cd ./serverless-dns"><pre><span><span>#</span> navigate to work dir</span>
<span>cd</span> /my/work/dir

<span><span>#</span> clone this repository</span>
git clone https://github.com/serverless-dns/serverless-dns.git

<span><span>#</span> navigate to serverless-dns</span>
<span>cd</span> ./serverless-dns</pre></div>
<p dir="auto">Node:</p>
<div data-snippet-clipboard-copy-content="# install node v16+ via nvm, if required
# https://github.com/nvm-sh/nvm#installing-and-updating
wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
nvm install --lts

# get js dependencies
npm i

# (optional) update dependencies
npm update

# run serverless-dns on node
./run n

# run a clinicjs.org profiler
./run n [cpu|fn|mem]"><pre><span><span>#</span> install node v16+ via nvm, if required</span>
<span><span>#</span> https://github.com/nvm-sh/nvm#installing-and-updating</span>
wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh <span>|</span> bash
nvm install --lts

<span><span>#</span> get js dependencies</span>
npm i

<span><span>#</span> (optional) update dependencies</span>
npm update

<span><span>#</span> run serverless-dns on node</span>
./run n

<span><span>#</span> run a clinicjs.org profiler</span>
./run n [cpu<span>|</span>fn<span>|</span>mem]</pre></div>
<p dir="auto">Deno:</p>
<div data-snippet-clipboard-copy-content="# install deno.land v1.18+
# https://github.com/denoland/deno/#install
curl -fsSL https://deno.land/install.sh | sh

# run serverless-dns on deno
./run d"><pre><span><span>#</span> install deno.land v1.18+</span>
<span><span>#</span> https://github.com/denoland/deno/#install</span>
curl -fsSL https://deno.land/install.sh <span>|</span> sh

<span><span>#</span> run serverless-dns on deno</span>
./run d</pre></div>
<p dir="auto">Wrangler:</p>
<div data-snippet-clipboard-copy-content="# install Cloudflare Workers (cli) aka Wrangler
# https://developers.cloudflare.com/workers/cli-wrangler/install-update
npm i @cloudflare/wrangler -g

# run serverless-dns on Cloudflare Workers (cli)
# Make sure to setup Wrangler first:
# https://developers.cloudflare.com/workers/cli-wrangler/authentication
./run w

# profile wrangler with Chrome DevTools
# blog.cloudflare.com/profiling-your-workers-with-wrangler"><pre><span><span>#</span> install Cloudflare Workers (cli) aka Wrangler</span>
<span><span>#</span> https://developers.cloudflare.com/workers/cli-wrangler/install-update</span>
npm i @cloudflare/wrangler -g

<span><span>#</span> run serverless-dns on Cloudflare Workers (cli)</span>
<span><span>#</span> Make sure to setup Wrangler first:</span>
<span><span>#</span> https://developers.cloudflare.com/workers/cli-wrangler/authentication</span>
./run w

<span><span>#</span> profile wrangler with Chrome DevTools</span>
<span><span>#</span> blog.cloudflare.com/profiling-your-workers-with-wrangler</span></pre></div>
<h4 dir="auto"><a id="user-content-code-style" aria-hidden="true" href="#code-style"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Code style</h4>
<p dir="auto">Commits on this repository enforces the Google JavaScript style guide (ref: <a href="https://github.com/serverless-dns/serverless-dns/blob/main/.eslintrc.cjs">.eslintrc.cjs</a>).
A git <code>pre-commit</code> hook that runs linter (eslint) and formatter (prettier) on <code>.js</code> files. Use <code>git commit --no-verify</code>
to bypass this hook.</p>
<p dir="auto">Pull requests are also checked for code style violations and fixed automatically where possible.</p>
<h4 dir="auto"><a id="user-content-env-vars" aria-hidden="true" href="#env-vars"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Env vars</h4>
<p dir="auto">Configure <code>.env</code> (<a href="https://github.com/serverless-dns/serverless-dns/blob/main/.env.example">ref</a>) or <a href="https://github.com/serverless-dns/serverless-dns/blob/main/src/core/env.js"><code>env.js</code></a> if you need to tweak the defaults.
Values in <code>.env</code> file take precedence over corresponding variables set in <code>env.js</code>. For Cloudflare Workers
setup env vars in <a href="https://github.com/serverless-dns/serverless-dns/blob/main/wrangler.toml"><code>wrangler.toml</code></a>, instead.</p>
<h4 dir="auto"><a id="user-content-request-flow" aria-hidden="true" href="#request-flow"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Request flow</h4>
<ol dir="auto">
<li>The request/response flow: client &lt;-&gt; <code>src/server-[node|workers|deno]</code> &lt;-&gt; <a href="https://github.com/serverless-dns/serverless-dns/blob/main/src/core/doh.js"><code>doh.js</code></a> &lt;-&gt; <a href="https://github.com/serverless-dns/serverless-dns/blob/main/src/core/plugin.js"><code>plugin.js</code></a></li>
<li>The <code>plugin.js</code> flow: <code>userOperation.js</code> -&gt; <code>cacheResponse.js</code> -&gt; <code>cc.js</code> -&gt; <code>dnsResolver.js</code></li>
</ol>
<hr/>
<h4 dir="auto"><a id="user-content-a-note-about-runtimes" aria-hidden="true" href="#a-note-about-runtimes"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>A note about runtimes</h4>
<p dir="auto">Deno Deploy (cloud) and Deno (the runtime) do not expose the same API surface (for example, Deno Deploy only
supports HTTP/S server-listeners; whereas, Deno suports raw TCP/UDP/TLS in addition to plain HTTP and HTTP/S).</p>
<p dir="auto">Except on Node, <code>serverless-dns</code> uses DoH upstreams defined by env vars, <code>CF_DNS_RESOLVER_URL</code> / <code>CF_DNS_RESOLVER_URL_2</code>.
On Node, the default DNS upstream is <code>1.1.1.2</code> (<a href="https://github.com/serverless-dns/serverless-dns/blob/15f628460/src/commons/dnsutil.js#L28">ref</a>).</p>
<p dir="auto">The entrypoint for Node and Deno are <a href="https://github.com/serverless-dns/serverless-dns/blob/main/src/server-node.js"><code>src/server-node.js</code></a>, <a href="https://github.com/serverless-dns/serverless-dns/blob/main/src/server-deno.ts"><code>src/server-deno.ts</code></a> respectively,
and both listen for TCP-over-TLS, HTTP/S connections; whereas, the entrypoint for Cloudflare Workers, which only listens over HTTP (cli) or
over HTTP/S (prod), is <a href="https://github.com/serverless-dns/serverless-dns/blob/main/src/server-workers.js"><code>src/server-workers.js</code></a>.</p>
<p dir="auto">For prod setups on Deno and local (non-prod) setups on Node, the <code>key</code> (private) and <code>cert</code> (public chain)
files, by default, are read from paths defined in env vars, <code>TLS_KEY_PATH</code> and <code>TLS_CRT_PATH</code>.</p>
<p dir="auto">Whilst for prod setup on Node (on Fly.io), either <code>TLS_OFFLOAD</code> must be set to <code>true</code> or <code>key</code> and <code>cert</code> <em>must</em> be
<em>base64</em> encoded in env var <code>TLS_CERTKEY</code> (<a href="https://github.com/serverless-dns/serverless-dns/blob/f57c579/src/core/node/config.js#L61-L92">ref</a>), like so:</p>
<div data-snippet-clipboard-copy-content="# EITHER: offload tls to fly.io and set tls_offload to true
TLS_OFFLOAD=&#34;true&#34;
# OR: base64 representation of both key (private) and cert (public chain)
TLS_CERTKEY=&#34;KEY=b64_key_content\nCRT=b64_cert_content&#34;"><pre><span><span>#</span> EITHER: offload tls to fly.io and set tls_offload to true</span>
TLS_OFFLOAD=<span><span>&#34;</span>true<span>&#34;</span></span>
<span><span>#</span> OR: base64 representation of both key (private) and cert (public chain)</span>
TLS_CERTKEY=<span><span>&#34;</span>KEY=b64_key_content\nCRT=b64_cert_content<span>&#34;</span></span></pre></div>
<p dir="auto"><em>Process</em> bringup is different for each of these runtimes: For Node, <a href="https://github.com/serverless-dns/serverless-dns/blob/main/src/core/node/config.js"><code>src/core/node/config.js</code></a> governs the <em>bringup</em>;
while for Deno, it is <a href="https://github.com/serverless-dns/serverless-dns/blob/main/src/core/deno/config.ts"><code>src/core/deno/config.ts</code></a> and for Workers it is <a href="https://github.com/serverless-dns/serverless-dns/blob/main/src/core/workers/config.js"><code>src/core/workers/config.js</code></a>.
<a href="https://github.com/serverless-dns/serverless-dns/blob/main/src/system.js"><code>src/system.js</code></a> pub-sub co-ordinates the <em>bringup</em> phase among various modules.</p>
<p dir="auto">On Node and Deno, in-process DNS caching, backed by <a href="https://github.com/serverless-dns/lfu-cache"><code>@serverless-dns/lfu-cache</code></a>
is used; on Cloudflare Workers, both, <a href="https://developers.cloudflare.com/workers/runtime-apis/cache" rel="nofollow">Cache Web API</a> and
in-process caches are used. To disable caching altogether on all three platfroms, set env var, <code>PROFILE_DNS_RESOLVES=true</code>.</p>
<h4 dir="auto"><a id="user-content-cloud" aria-hidden="true" href="#cloud"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Cloud</h4>
<p dir="auto">Cloudflare Workers and Deno Deploy are ephemeral, as in, the process that serves client request is not long-lived,
and in fact, two back-to-back requests may be served by two different <a href="https://developers.cloudflare.com/workers/learning/how-workers-works" rel="nofollow"><em>isolates</em></a> (processes). Resolver on Fly.io, running Node, is backed by <a href="https://fly.io/blog/docker-without-docker/" rel="nofollow">persistent VMs</a> and is hence longer-lived,
like traditional &#34;serverfull&#34; environments.</p>
<p dir="auto">Cloudflare Workers build-time and runtime configurations are defined in <a href="https://github.com/serverless-dns/serverless-dns/blob/main/wrangler.toml"><code>wrangler.toml</code></a>.
<a href="https://github.com/serverless-dns/serverless-dns/blob/main/webpack.config.cjs">Webpack5 bundles the files</a> in an ESM module which is then uploaded to Cloudflare by <em>Wrangler</em>.</p>
<p dir="auto">For Deno Deploy, the code-base is bundled up in a single javascript file with <code>deno bundle</code> and then handed off
to Deno.com.</p>
<p dir="auto">For Fly.io, which runs Node, the runtime directives are defined in <a href="https://github.com/serverless-dns/serverless-dns/blob/main/fly.toml"><code>fly.toml</code></a> (used by <code>dev</code> and <code>live</code> deployment-types),
while deploy directives are in <a href="https://github.com/serverless-dns/serverless-dns/blob/main/node.Dockerfile"><code>node.Dockerfile</code></a>. <a href="https://fly.io/docs/flyctl" rel="nofollow"><code>flyctl</code></a> accordingly sets
up <code>serverless-dns</code> on Fly.io&#39;s infrastructure.</p>
<p dir="auto">For deploys offloading TLS termination to Fly.io (<code>B1</code> deployment-type), the runtime directives are instead defined in
<a href="https://github.com/serverless-dns/serverless-dns/blob/main/fly.tls.toml"><code>fly.tls.toml</code></a>, which sets up HTTP2 Cleartext and HTTP/1.1 on port 443, and DNS over TCP on port 853.</p>
<p dir="auto">Ref: <em><a href="https://github.com/serverless-dns/serverless-dns/blob/main/.github/workflows">github/workflows</a></em>.</p>
<h3 dir="auto"><a id="user-content-blocklists" aria-hidden="true" href="#blocklists"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Blocklists</h3>
<p dir="auto">190+ blocklists are compressed in a <em>Succinct Radix Trie</em> (<a href="https://stevehanov.ca/blog/?id=120" rel="nofollow">based on Steve Hanov&#39;s impl</a>) with modifications
to speed up string search (<a href="https://github.com/serverless-dns/serverless-dns/blob/main/src/plugins/blocklist-wrapper/radixTrie.js"><code>lookup</code></a>) at the expense of &#34;succintness&#34;. The blocklists are versioned
with unix timestamp (env var: <code>CF_LATEST_BLOCKLIST_TIMESTAMP</code>), and generated once every week, but we&#39;d like to generate &#39;em daily / hourly,
if possible <a href="https://github.com/serverless-dns/blocklists/issues/19" data-hovercard-type="issue" data-hovercard-url="/serverless-dns/blocklists/issues/19/hovercard">see</a>), and hosted on Lightsail Object Store (env var: <code>CF_BLOCKLIST_URL</code>).
<code>serverless-dns</code> downloads <a href="https://github.com/serverless-dns/serverless-dns/blob/15f62846/src/core/node/blocklists.js#L14-L16">3 blocklist files</a>
required to setup the radix trie during runtime bringup or, <a href="https://github.com/serverless-dns/serverless-dns/blob/15f62846/src/plugins/dns-operation/dnsResolver.js#L167">lazily</a>, when serving a DNS request.</p>
<p dir="auto"><code>serverless-dns</code> compiles around ~5M entries (as of Feb 2022) in to a succinct radix trie, from around 190+ blocklists. These are defined in <a href="https://github.com/serverless-dns/blocklists">serverless-dns/blocklists</a> repository.</p>
</article>
          </div></div>
  </body>
</html>
