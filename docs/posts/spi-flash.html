<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://trmm.net/SPI_flash/">Original</a>
    <h1>SPI Flash</h1>
    
    <div id="readability-page-1" class="page"><div data-md-component="container">
      
      
        
          
        
      
      <main data-md-component="main">
        <div>
          
            
              
              
            
            
              
              
            
          
          
            <div data-md-component="content">
              <article>
                
                  



  

<h3 id="spi-flash-reader">SPI Flash reader</h3>
<p><a href="https://www.flickr.com/photos/osr/18611312982/lightbox"><img src="https://live.staticflickr.com/8850/18611312982_f57ca516e9_b.jpg" srcset="https://live.staticflickr.com/8850/18611312982_f57ca516e9_b.jpg 1024w, https://live.staticflickr.com/8850/18611312982_f57ca516e9.jpg 400w"/></a>
Like <a href="http://ho.ax/posts/2012/06/unbricking-a-macbook/">ho.ax</a>, I had been using a Dangerous Prototypes buspirate to read SPI flash boot ROMs, but it was too slow.  So I built a dedicated one with a <a href="https://trmm.net/Category:Teensy">Teensy 2 or 3</a> and a 8-SOIC chip-clip.  It can read/write the entire multi-megabit ROM in a minute. Sources are available from <a href="https://bitbucket.org/hudson/spiflash/src">bitbucket.org/hudson/spiflash</a>.</p>
<h2 id="spotting-boot-roms">Spotting boot ROMs</h2>
<p><a href="https://www.flickr.com/photos/osr/14774124196/lightbox"><img src="https://live.staticflickr.com/3904/14774124196_9477577280_b.jpg" srcset="https://live.staticflickr.com/3904/14774124196_9477577280_b.jpg 1024w, https://live.staticflickr.com/3904/14774124196_9477577280.jpg 400w"/></a>
Many SPI flash chips are 8-SOIC, like this 8 megabyte 25L6406E.  On x86 sytems they are also typically memory mapped at 0xFF800000, but it is also easy to read them with an external reader.</p>
<h2 id="pinout">Pinout</h2>

<p>These pins are large enough that it is easy to attach with a buspirate/logic-probe clips or using a dedicated chip clip that connects to all eight pins at once.  On the bottom of the Teensy 2 there is a pad footprint for a 3.3 volt regulator -- I&#39;ve cut the trace and soldered one in, as <a href="https://www.pjrc.com/teensy/3volt.html">described here</a>. For the Teensy 3, which runs at native 3.3V, no hardware modifications are required.</p>
<p>Most laptops and some servers use 8-pin chips in either SOIC or DIP packages:</p>
<div><pre><span></span><code>                        +------+
(white) B0      !CE  ---| o    |----  +V      3v3 (red or brown)
(brown) B3       SO  ---|      |---- !RST
                !WP  ---|      |----  SCK     B1 (green)
(black) GND     GND  ---|      |----  SI      B2 (blue)
                        +------+
</code></pre></div>
<p><a href="https://www.flickr.com/photos/osr/40140781551/lightbox"><img src="https://live.staticflickr.com/4721/40140781551_745e0f5b2c_b.jpg" srcset="https://live.staticflickr.com/4721/40140781551_745e0f5b2c_b.jpg 1024w, https://live.staticflickr.com/4721/40140781551_745e0f5b2c.jpg 400w"/></a></p>
<p>For the 16-pin chips typically found on server motherboards, the pinout is:</p>
<div><pre><span></span><code>      NC ---- 1 o     16 --- CLK
    Vcc (3v)- 2   W   15 --- DI
      NC ---- 3   I   14 --- NC
      NC ---- 4   N   13 --- NC
      NC ---- 5   B   12 --- NC
      NC ---- 6   O   11 --- NC
     /CS ---- 7   N   10 --- GND
      DO ---- 8   D    9 --- NC
</code></pre></div>
<p>Sometimes the SPI flash chip doesn&#39;t respond to the <code>i</code> command -- the result comes back as all 0xFF.  If I cycle power to the chip a few times it starts to respond.  I&#39;m not sure what the root cause is of this, but to make it easier I&#39;ve put a separate jumper on the power pin from the teensy to the SOIC chip.  This allows me to cycle the power until I get a good read of the chip ID.</p>
<p><a href="https://www.flickr.com/photos/osr/19556871015/lightbox"><img src="https://live.staticflickr.com/265/19556871015_1e28211cff_b.jpg" srcset="https://live.staticflickr.com/265/19556871015_1e28211cff_b.jpg 1024w, https://live.staticflickr.com/265/19556871015_1e28211cff.jpg 400w"/></a>
Some MacBooks have debug ports on them that connect to the SPI flash ROM (and maybe other interesting debug signals?).  I&#39;ve probed the MacBookPro 10,1 and mapped the pinout for almost all of the SPI signals, with the exception of Power and !WP.</p>
<h2 id="usage">Usage</h2>
<p>The reader should show up as a serial device on your computer.  It has a the following simple commands:</p>
<ul>
<li>
<p><code>i</code>: Read chip ID; if all 0xFF or 0x00, then something is wrong. The format of the ID result is described in the data sheet and JEDEC standard:
<img alt="" src="https://trmm.net/images/RDID_ID.png"/></p>
</li>
<li>
<p><code>r7f0000↵</code>: read 16 bytes from 0x7f0000 and hex dump them.</p>
</li>
<li><code>e7f0000↵</code>: erase a sector at address 7f0000. You shouldn&#39;t need to do this since the upload command will erase sectors as it crosses them.</li>
<li>
<p><code>u190000 1a0000↵</code>: Upload (and erase) 0x1a0000 bytes to 0x190000. Typically I will then shell out from minicom and run <a href="http://www.ivarch.com/programs/pv.shtml">pv</a>; you could also use <code>cat</code> although it wouldn&#39;t give you any feedback on the transfer:</p>
<pre><code>pv new-rom.section.rom &gt; /dev/ttyACM0
</code></pre>
</li>
<li>
<p>The entire ROM can be read using xmodem.  Shell out from minicom and run:</p>
<pre><code>rx &lt; /dev/ttyACM0 &gt; /dev/ttyACM0 rom.bin
</code></pre>
</li>
</ul>
<h2 id="reverse-engineering">Reverse Engineering</h2>
<p>More details on reverse engineering a ROM are described in my <a href="https://trmm.net/Thunderstrike_31c3">Thunderstrike talk at 31c3</a>.</p>
<p><a href="https://trmm.net/Category:ROM"><span>ROM</span></a>
<a href="https://trmm.net/Category:Teensy"><span>Teensy</span></a>
<a href="https://trmm.net/Category:2013"><span>2013</span></a>
<a href="https://trmm.net/Category:Reverse_engineering"><span>Reverse engineering</span></a></p>

  <hr/>
<p><small>
    
      Last update:
      <span>November 8, 2020</span>
      
    
  </small>
</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        
      
    </div></div>
  </body>
</html>
