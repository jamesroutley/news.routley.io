<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mattyyeung.github.io/deterministic-quoting">Original</a>
    <h1>Deterministic Quoting: Making LLMs safer for healthcare</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <!-- "Healthcare needs trustworthy LLMs: Introducing Deterministic Quoting" -->
<!-- Hallucination-Free RAG: How we bring trust to Healthcare AI -->
<p>LLMs have the potential to revolutionise our field of healthcare, but the fear and reality of hallucinations prevent adoption in most applications.</p>

<p>At <a href="https://www.invetechgroup.com/">Invetech</a>, we’re working on <strong>“Deterministic Quoting”</strong>, a new technique that ensures quotations from source material are verbatim, not hallucinated.</p>

<p><img src="https://mattyyeung.github.io/assets/deterministic-quoting/1_bigger.png" alt=""/></p>

<p>In this example, everything displayed with a blue background is <strong>guaranteed to be <em>verbatim</em> from source material. No hallucinations.</strong> LLMs remain imperfect, so it may still choose to quote the <em>wrong part</em> of the source material, but only “real” quotations are displayed on blue - they are deterministically generated.</p>

<p>We think Deterministic Quoting is an “enabler” for deploying LLMs where there are serious consequences to incorrect information, such as:</p>
<ul>
  <li>AIs that process medical records</li>
  <li>AIs that assist in diagnosis</li>
  <li>AIs which reference medical guidelines</li>
</ul>

<p>Many LLM systems can be designed to deterministically quote. This article provides motivation and explains a basic implementation.</p>

<h4 id="contents">Contents:</h4>
<ol>
  <li><a href="#1-hallucinations-matter">Hallucinations Matter</a></li>
  <li><a href="#2-introducing-deterministic-quoting">Introducing Deterministic Quoting</a></li>
  <li><a href="#3-how-well-does-it-work">How Well Does It Work?</a></li>
  <li><a href="#4-applications">Applications</a></li>
  <li><a href="#5-technical-details-how-is-it-implemented">Technical Details: How is it Implemented?</a></li>
  <li><a href="#6-beyond-the-minimalist-implementation">Beyond the Minimalist Implementation</a></li>
  <li><a href="#7-conclusion-is-this-really-ready-for-healthcare">Conclusion: Is This Really Ready For Healthcare?</a></li>
</ol>

<hr/>

<h2 id="1-hallucinations-matter">1. Hallucinations Matter</h2>

<p><img src="https://mattyyeung.github.io/assets/deterministic-quoting/hallucination.png" alt=""/></p>

<p>Hallucinations are endemic to LLM systems.</p>

<ul>
  <li>The biggest models from OpenAI, Google, Anthropic etc. hallucinate more than 20% of the time in some use-cases <!--TODO--></li>
  <li>It’s safe to assume that the next generation (ChatGPT “5”, Gemini 1.5 Ultra, etc.) will continue to hallucinate, albeit at a lower rate</li>
  <li>Some LLMs are trained/prompted to cite sources… but these citations themselves can be hallucinated! This can be particularly problematic: users are more likely to trust authoritative-looking citations
<!-- * At least [one system](https://gemini.google.com/) offers a function to verify claims by querying a search engine, but this still requires vigilance from the user --></li>
  <li>“Check your own answer” iterative methods can reduce the rate of hallucinations, but only partially.</li>
  <li>Attaching relevant source material to the query (<a href="https://blogs.nvidia.com/blog/what-is-retrieval-augmented-generation/">RAG</a>) is better than training/fine-tuning/LoRA (see <a href="https://en.wikipedia.org/wiki/Catastrophic_interference">catastrophic forgetting</a>), but even still the material is sometimes transformed when quoted in the output.</li>
</ul>

<p>In short: any information that passes through an LLM is potentially “tainted”.</p>

<h3 id="so-what">So what?</h3>

<p>In naturally conservative fields like healthcare we do not deploy systems that are reliable “most of the time”. Even a low rate of hallucination is enough to prevent adoption at scale for most of our use-cases. We simply can’t burden users with the task of independent verification – mistakes and their consequences are inevitable.</p>

<!--TODO-->

<p>Eventually, LLM quality may be high enough to be trustworthy as-is, but this is not currently within sight. Until then…</p>

<h2 id="2-introducing-deterministic-quoting">2. Introducing: Deterministic Quoting</h2>

<p>Deterministic Quoting techniques bridge the LLM “trust gap”.</p>

<p>Applications with Deterministic Quoting provide verbatim “ground-truth” information interspersed with LLM commentary. It combines the convenience and flexibility of the LLM with trustworthy data that is guaranteed to be hallucination-free. Users benefit from the framing and commentary but can easily verify the underlying assumptions without extra action.</p>

<p><img src="https://mattyyeung.github.io/assets/deterministic-quoting/2.png" alt=""/></p>

<p>The “hallucination-free” guarantee is achieved by ensuring that the data displayed on the blue background has never passed through an LLM (or any non-deterministic AI model). The AI chooses which section of source material to quote, but the retrieval of that text is a traditional non-AI database lookup. That’s the only way to guarantee that an LLM has not transformed text: don’t send it through the LLM in the first place.</p>

<p>The approach is imperfect: the surrounding text (white background) has come directly from an LLM and therefore may still be hallucinated. Or, the AI can choose an irrelevant (but still verbatim) quote to display. Still, the result is a significant improvement: users report intuitively grasping the difference between trusted quotations and prose generated by the LLM.</p>

<h2 id="3-how-well-does-it-work">3. How well does it work?</h2>

<p>In practice, we meet the stated goal of “zero false positives” for any quoted text. That is, 100% of all text displayed in the special quote box (the blue background in the examples) is indeed verbatim, not hallucinated.</p>

<p>In addition, several other metrics are useful:</p>

<ul>
  <li>Are there hallucinations in the non-DQ prose? (ie. white background)</li>
  <li>Was the right quote/data chosen by the LLM? Is it relevant to the question?</li>
  <li>Is user’s query answered?</li>
</ul>

<p>Here, the underlying LLM remains the limiting factor for quality, DQ is only part of the story. We don’t expect DQ to improve these metrics, our goal is to avoid regressions.</p>

<p>Here are some preliminary results comparing a standard RAG pipeline (Llamaindex + ChatGPT 4) with a modified version with a minimalistic implementation of DQ. N=60, non-public dataset.</p>

<table>
  <tbody>
    <tr>
      <td> </td>
      <td><strong>Baseline</strong></td>
      <td><strong>Goal</strong></td>
      <td><strong>With DQ</strong></td>
    </tr>
    <tr>
      <td>Hallucinations in blue box:</td>
      <td>N/A</td>
      <td>0</td>
      <td><strong>0</strong></td>
    </tr>
    <tr>
      <td>Hallucinations outside blue box:</td>
      <td>12%</td>
      <td>Better than baseline</td>
      <td>2%</td>
    </tr>
    <tr>
      <td>Was the quote/data relevant?</td>
      <td>90%</td>
      <td>Baseline</td>
      <td>92%</td>
    </tr>
    <tr>
      <td>Is the user’s query answered?</td>
      <td>83%</td>
      <td>Baseline</td>
      <td>88%</td>
    </tr>
  </tbody>
</table>

<p>While preliminary, this data is consistent with other experiments we have run: adding DQ does not appear to degrade the overall quality of answers. If anything, answer quality may slightly improve.</p>

<h2 id="4-applications">4. Applications</h2>

<p>DQ techniques provide benefit wherever hallucinations are problematic – typically Information Retrieval (eg RAG) and related systems. 
<!-- TODO more! --></p>
<ul>
  <li>a pharmacist discussing drug interactions and side effects with an AI assistant</li>
  <li>an anxious patient doesn’t get through all of their questions in the 7 minutes they have with their surgeon but has all the time in the world to discuss with a knowledgable AI assistant</li>
  <li>a doctor asks the medical records system if a patient has a history of heart conditions - it responds with a summarised list</li>
  <li>an assistant to front-line medical staff with knowledge of best-practice diagnosis and treatment for common conditions</li>
  <li>an educational aid that allows students to query textbooks or other study material</li>
</ul>

<p>Proof-of-concept demonstations already exist - organisations are clearly excited about the potential for these systems. But in most of these, there are serious consequences to hallucinations. Few are currently reliable enough to deploy at scale.</p>

<p>Of course, DQ may be applied outside healthcare too - eg. systems with knowledge of legisliation, financial regulation or works of literature. But here, we constrain the discussion to healtcare.</p>

<hr/>

<h2 id="5-technical-details-how-is-it-implemented">5. Technical Details: How is it Implemented?</h2>

<p>While implementations will vary, DQ fundamentally involves a sending LLM outputs to a separate module that replaces potentially-hallucinated quotations with verbatim copies direct from the source material. This replacement is a traditional non-AI database query, that is, it’s “deterministic”.</p>

<p>Before discussing advanced implementations, let’s build a proof-of-concept. The simplest way is to take a typical RAG pipeline and make some modifications.</p>

<h3 id="a-minimalist-implementation-of-dq-a-modified-rag-pipeline">A “Minimalist Implementation” of DQ: a modified RAG Pipeline</h3>

<p>A typical RAG pipeline:</p>

<p><img src="https://mattyyeung.github.io/assets/deterministic-quoting/RAG-pipeline.png" alt=""/></p>

<p>Note how the retrieved source material passes through the LLM - and is therefore liable to be transformed (hallucinated) before it is shown to the user.</p>

<p>We want to fix this by adding a “deterministic lookup” of quotes after all calls to the LLM are complete. Note how the new modules are added <em>after</em> the LLM.</p>

<p><img src="https://mattyyeung.github.io/assets/deterministic-quoting/RAG-pipeline-with-DQ.png" alt=""/></p>

<p>To achieve this, we make six changes to the original:</p>

<ol>
  <li>Chunker: modify to suit in-line quotation</li>
  <li>Generate a unique reference string for each chunk</li>
  <li>Retrieval: wrap chunks in a structured format - including a unique reference - before passing to the LLM.</li>
  <li>Prompt: instruct the LLM to cite references for all claims and output a structured format for these references</li>
  <li>Deterministic lookup: use those references to loop back to the source material to find the original quote</li>
  <li>Add support to GUI</li>
</ol>

<h3 id="chunking-approach">Chunking Approach</h3>

<p>We add two constraints to the document “chunker” - the module that splits our dataset up into indexable pieces.</p>

<p>First, we prefer smaller chunks that are easily displayed in and around the LLM’s commentary. In RAG with current-generation LLMs, chunks are often quite large - a page of text or more. But this simple implementation of DQ only displays whole chunks, not parts. A whole page for each quote would often be too much for users to conveniently parse, so paragraph-sized are preferred. Of course, the LLM can still quote several consecutive paragraphs where relevant.</p>

<p><img src="https://mattyyeung.github.io/assets/deterministic-quoting/3.png" alt=""/></p>

<p>Second, we want chunk boundaries to be logical to a user: displaying cut-off pieces of a section could be confusing. Such <strong>“semantic chunking”</strong> can be tedious, depending heavily on the source material structure and format. However, it does seem to provide an improvement in the quality of some answers, presumably because there is semantic value in the structure of the document.</p>

<p>Like most ML systems, source data preparation and chunking are often the most time consuming to implement.</p>

<h3 id="give-each-chunk-a-unique-reference-string">Give Each Chunk a Unique Reference String</h3>

<p>We create a unique reference string for each chunk. This string is used in several ways:</p>

<ul>
  <li>stored in the datastore as metadata for each chunk</li>
  <li>passed into the LLM context as a “header” for its chunk inside a &lt;title&gt; tag</li>
  <li>output by the LLM alongside anything it wants to quote – again in a &lt;title&gt; tag</li>
  <li>(ideally, if meaningful to humans) displayed in the “blue box” as a link to the original source.</li>
</ul>

<p>This is not always straightforward. Difficulties include:</p>

<ul>
  <li>unstructured documents. Humans would say “half-way down page 32”</li>
  <li>dealing with duplicates: eg “Section 1: Introduction” may appear in multiple documents, 2 documents may have the same name, or the corpus may contain multiple revisions of the same document</li>
  <li>the stretch goal of making the string meaningful to humans can be difficult, depending on the document set</li>
</ul>

<h3 id="prompt-engineering">Prompt Engineering</h3>

<p>Here is an example system prompt for a system with access to our internal medical device design standards:</p>

<div><div><pre><code>System prompt:
You are an expert Q&amp;A system with excellent knowledge of the internal documentation of our company, Invetech.
Invetech designs medical devices, so it is critical that you always accurately quote the reference information you use to answer the query.
</code></pre></div></div>

<p>Like typical RAG systems, we instruct the LLM to only answer from the source material, not its learned “memory”. Unlike many RAG systems, however, we instruct the LLM to always cite sources, keeping “commentary” separate from the quotes.</p>

<div><div><pre><code>Always answer the query using the provided reference information, and not prior knowledge.
The reference information is provided below as a list of &#34;sections&#34;. Each section is encapsulated by a &lt;quote&gt; tag.
Each &lt;quote&gt; contains a &lt;title&gt; tag at the very beginning. Use this title when quoting.

Some rules to follow:
1. Always use the appropriate &lt;quote&gt;s to answer the question.
2. Include a plain English summary in answer to the query, based on the text in the relevant &lt;quote&gt;s. There is no need to simply repeat the quoted text, however.
</code></pre></div></div>

<p>When citing, we instruct the LLM to start with the unique reference string in a structured format. XML-style works well, but so do json or others.</p>

<div><div><pre><code>3. Quote the whole section so the user can see where the information has come from. Always include the &lt;quote&gt; tags, including the title, when quoting.
4. Always start quotes with &#34;&lt;quote&gt;&#34; and end quotes with &#34;&lt;/quote&gt;&#34;
5. Quote multiple sections if relevant, but always quote whole sections using the correct format.
6. Use the term &#34;Reference information&#34; instead of &#34;context information&#34;
7. Always quote whole sections verbatim, not a subset.
</code></pre></div></div>

<h3 id="retrieval-of-top-k-chunks">Retrieval of Top-K Chunks</h3>

<p>The only change to retrieval is the format used when inserting into LLM context. We use the same format we want the LLM to output – including the unique reference string from above inside &lt;title&gt; tags. This provides the LLM with examples of the preferred format without eating up valuable context space. An example:</p>

<div><div><pre><code><span>&lt;quote&gt;</span>
   <span>&lt;title&gt;</span>ICD-10 Version:2019 - Chapter VI Diseases of the nervous system - G43.1<span>&lt;/title&gt;</span>
   G43.1 Migraine with aura [classical migraine]
   <span>&lt;link&gt;</span>https://icd.who.int/browse10/2019/en#G43.1<span>&lt;/link&gt;</span>
<span>&lt;/quote&gt;</span>
</code></pre></div></div>

<h3 id="deterministic-lookup">Deterministic Lookup</h3>

<p>After the LLM output has been returned, quotations matching the above format are extracted. In the minimal implementation of DQ, only the unique reference string is kept. The actual quote text is discarded because it may contain hallucinations.</p>

<p>The application looks up the unique reference string in the chunk index. If it matches, the true quotation text is inserted into the &lt;quote&gt; tag text. Otherwise, the unique reference string has been hallucinated – the quotation is invalid.</p>

<p>When this step is complete, everything contained within a &lt;quote&gt; tag is guaranteed to be a valid quotation directly from the source material.</p>

<h3 id="gui-changes">GUI Changes</h3>

<p>To complete our minimalist implementation of DQ, we modify the GUI to clearly distinguish between quotations and LLM prose. In the examples above, we:</p>
<ul>
  <li>put the text in a blue box</li>
  <li>add a user-readable reference (ideally the unique reference string)</li>
  <li>label it as deterministically generated</li>
  <li>add a link to the source</li>
</ul>

<p><img src="https://mattyyeung.github.io/assets/deterministic-quoting/4.png" alt=""/></p>

<hr/>
<h2 id="6-beyond-the-minimalist-implementation">6. Beyond the Minimalist Implementation</h2>

<p>While the implementation above is a useful explainer there are many opportunities for improvement. Our tests have shown significant improvement beyond the proof-of-principle implementation:</p>

<h4 id="reducing-the-rate-of-irrelevant-answers-and-omissions">Reducing the rate of irrelevant answers and omissions</h4>
<ul>
  <li>Detect &amp; reject answers that fail to use deterministic quoting</li>
  <li>Detect if the answer fails to answer the question (imperfect, because an LLM is used to do this)</li>
  <li>Replace the “unique reference string matching” with a more sophisticated method of matching a selected quote to the ground-truth database.</li>
  <li>Prompt engineering to encourage “I don’t know” responses</li>
</ul>

<h4 id="presenting-information-the-llms-in-a-more-machine-understandable-manner">Presenting information the LLMs in a more machine-understandable manner</h4>
<ul>
  <li>Improved versions of semantic chunking - eg overlapping chunks or processing documents multiple times with different chunk sizes</li>
  <li>Adding more meta-data to chunks - For example, sometimes nearby subheading will provide important context</li>
  <li>Diagrams, charts and tables are notoriously difficult for AI systems to understand. DQ has its own challenges with these, though they are much easier to solve than the general problem faced by all RAG systems</li>
  <li>Iterative calls to the LLM to narrow down source material</li>
  <li>Customising parsing and chunking to the dataset, or, where possible, changing dataset format to suit the LLM</li>
</ul>

<p>Generally, these techniques are not spcific to DQ, but often provide more benefit when used with DQ.</p>

<h4 id="non-rag-applications">Non-RAG Applications</h4>

<p>DQ isn’t limited to RAG systems. However, implementation can be more cumbersome because some parts of the RAG pipeline (eg chunking) are required for DQ.</p>

<p>For example, upcoming models from Google et al. <a href="https://blog.google/technology/ai/google-gemini-next-generation-model-february-2024/">can fit whole books in context</a> - enough to make RAG unnecessary for small corpuses. They still hallucinate, so Deterministic Quoting remains beneficial, but the source data must be chunked (ideally semantically) and indexed as it was in RAG.</p>

<!-- 
- DQ for user inputs too
- Top-K algorithm also inserts nearby chunks - instead of overlapping chunks
- screenshots of docs
- tables
- diagrams
- multi-layered quotes
- detect no quotes in response
- allow user to ask for quotes
- more sophisticated processing of the LLM output to determine which chunks are being quoted. Instead of using the unique reference string, blocks of text can be sent to the embeddings model to determine the best match.
- iterative calls to LLM to narrow down from a large chunk to a smaller one that is suitable for displaying inline. Still needs to be deterministically generated before display.
 -->

<hr/>

<h2 id="7-conclusion-is-this-really-ready-for-healthcare">7. Conclusion: Is this Really Ready for Healthcare?</h2>

<p>Deterministic Quoting helps to bridge the LLM “trust gap”. Combining the flexibility of LLMs with the reliability of non-AI quote lookups, DQ gives users confidence in the “ground truth” data assumed by the AI.</p>

<p>Advanced versions of the technique are still under development, but even basic implementations show significant improvement over the current state-of-the-art. Future versions can provide further improvements to quality of answers and flexibility when parsing a wide range of input documentation.</p>

<p>For some applications, a basic DQ implementation may be the difference between a proof-of-concept and a system with enough trustworthiness to deploy into production. For others, there is still work to be done before we can demonstrate sufficient safety. In all cases, it is clear that some variation of DQ will remain useful as long as models continue to hallucinate.</p>

<hr/>

<div><p>
Contributors: Chris Herring, Lars Katzfey &amp; I. We work at <a href="https://www.invetechgroup.com/">Invetech</a></p></div>

<!--TODO. Ideas:
- Hallucinations remain an unsolved problem, but deterministic quoting may open up new application spaces for LLMs.
- Many AI systems can be designed to “Deterministically Quote”.
- Some variation of DQ will remain useful as long as models hallucinate - even at a low rate.
- More sophisticated systems don’t just discard this text, it can (marginally) improve “are-we-looking-up-the-right-thing accuracy”

We look forward to a time when the fantastic potential of LLMs can be safely deployed in mission-critical applications like healthcare. 

-->

  </div>
</article>

      </div>
    </div></div>
  </body>
</html>
