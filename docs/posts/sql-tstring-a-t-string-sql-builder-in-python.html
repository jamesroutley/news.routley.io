<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/pgjones/sql-tstring">Original</a>
    <h1>Show HN: SQL-tString a t-string SQL builder in Python</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><a href="https://github.com/pgjones/sql-tstring/commits/main"><img alt="Build Status" src="https://github.com/pgjones/sql-tstring/actions/workflows/ci.yml/badge.svg"/>
</a> <a href="https://pypi.python.org/pypi/Sql-Tstring/" rel="nofollow"><img alt="pypi" src="https://camo.githubusercontent.com/62aed4ad0ed435e9e101f5ab18532f932b340af1159ded979af25a255e11eb87/68747470733a2f2f696d672e736869656c64732e696f2f707970692f762f73716c2d74737472696e672e737667" data-canonical-src="https://img.shields.io/pypi/v/sql-tstring.svg"/>
</a> <a href="https://pypi.python.org/pypi/Sql-Tstring/" rel="nofollow"><img alt="python" src="https://camo.githubusercontent.com/47a0131ab116cfb2a686ef169b937467200e01c8f6c933def2112a7a68684ae0/68747470733a2f2f696d672e736869656c64732e696f2f707970692f707976657273696f6e732f73716c2d74737472696e672e737667" data-canonical-src="https://img.shields.io/pypi/pyversions/sql-tstring.svg"/>
</a> <a href="https://github.com/pgjones/sql-tstring/blob/main/LICENSE"><img alt="license" src="https://camo.githubusercontent.com/6581c31c16c1b13ddc2efb92e2ad69a93ddc4a92fd871ff15d401c4c6c9155a4/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6c6963656e73652d4d49542d626c75652e737667" data-canonical-src="https://img.shields.io/badge/license-MIT-blue.svg"/>
</a></p>
<p dir="auto">SQL-tString allows for t-string based construction of sql queries
without allowing for SQL injection. The basic usage is as follows,</p>
<div dir="auto" data-snippet-clipboard-copy-content="from sql_tstring import sql

a = 1

query, values = sql(
    t&#34;&#34;&#34;SELECT a, b, c
          FROM tbl
         WHERE a = {a}&#34;&#34;&#34;,
)"><pre><span>from</span> <span>sql_tstring</span> <span>import</span> <span>sql</span>

<span>a</span> <span>=</span> <span>1</span>

<span>query</span>, <span>values</span> <span>=</span> <span>sql</span>(
    <span>t</span><span>&#34;&#34;&#34;SELECT a, b, c</span>
<span>          FROM tbl</span>
<span>         WHERE a = {a}&#34;&#34;&#34;</span>,
)</pre></div>
<p dir="auto">The <code>query</code> is a <code>str</code> and <code>values</code> a <code>list[Any]</code>, both are
then typically passed to a DB connection. Note the parameters can only
be identifiers that identify variables (in the above example in the
locals()) e.g. <code>{a - 1}</code> is not valid.</p>
<p dir="auto">SQL-tString will convert parameters to SQL placeholders where
appropriate. In other locations SQL-tString will allow pre defined
column or table names to be used,</p>
<div dir="auto" data-snippet-clipboard-copy-content="from sql_tstring import sql, sql_context

col = &#34;a&#34;
table = &#34;tbl&#34;

with sql_context(columns={&#34;a&#34;}, tables={&#34;tbl&#34;}):
    query, values = sql(
        t&#34;SELECT {col} FROM {table}&#34;,
    )"><pre><span>from</span> <span>sql_tstring</span> <span>import</span> <span>sql</span>, <span>sql_context</span>

<span>col</span> <span>=</span> <span>&#34;a&#34;</span>
<span>table</span> <span>=</span> <span>&#34;tbl&#34;</span>

<span>with</span> <span>sql_context</span>(<span>columns</span><span>=</span>{<span>&#34;a&#34;</span>}, <span>tables</span><span>=</span>{<span>&#34;tbl&#34;</span>}):
    <span>query</span>, <span>values</span> <span>=</span> <span>sql</span>(
        <span>t</span><span>&#34;SELECT {col} FROM {table}&#34;</span>,
    )</pre></div>
<p dir="auto">If the value of <code>col</code> or <code>table</code> does not match the valid values
given to the <code>sql_context</code> function an error will be raised.</p>
<a name="user-content-rewriting-values"></a>

<p dir="auto">SQL-tString will also remove parameters if they are set to the special
value of <code>Absent</code> (or <code>RewritingValue.Absent</code>). This is most
useful for optional updates, or conditionals,</p>
<div dir="auto" data-snippet-clipboard-copy-content="from sql_tstring import Absent, sql

a = Absent
b = Absent

query, values = sql(
    t&#34;&#34;&#34;UPDATE tbl
           SET a = {a},
               b = 1
         WHERE b = {b}&#34;&#34;&#34;,
)"><pre><span>from</span> <span>sql_tstring</span> <span>import</span> <span>Absent</span>, <span>sql</span>

<span>a</span> <span>=</span> <span>Absent</span>
<span>b</span> <span>=</span> <span>Absent</span>

<span>query</span>, <span>values</span> <span>=</span> <span>sql</span>(
    <span>t</span><span>&#34;&#34;&#34;UPDATE tbl</span>
<span>           SET a = {a},</span>
<span>               b = 1</span>
<span>         WHERE b = {b}&#34;&#34;&#34;</span>,
)</pre></div>
<p dir="auto">As both <code>a</code> and <code>b</code> are <code>Absent</code> the above <code>query</code> will be
<code>UPDATE tbl SET b =1</code>.</p>
<p dir="auto">In addition for conditionals the values <code>IsNull</code> (or
<code>RewritingValue.IS_NULL</code>) and <code>IsNotNull</code> (or
<code>RewritingValue.IS_NOT_NULL</code>) can be used to rewrite the conditional
as expected. This is useful as <code>x = NULL</code> is always false in SQL.</p>
<a name="user-content-paramstyle-dialect"></a>

<p dir="auto">By default SQL-tString uses the <code>qmark</code> <a href="https://peps.python.org/pep-0249/#paramstyle" rel="nofollow">paramstyle</a> (dialect) but also
supports the <code>$</code> paramstyle or asyncpg dialect. This is best changed
globally via,</p>
<div dir="auto" data-snippet-clipboard-copy-content="from sql_tstring import Context, set_context

set_context(Context(dialect=&#34;asyncpg&#34;))"><pre><span>from</span> <span>sql_tstring</span> <span>import</span> <span>Context</span>, <span>set_context</span>

<span>set_context</span>(<span>Context</span>(<span>dialect</span><span>=</span><span>&#34;asyncpg&#34;</span>))</pre></div>
<a name="user-content-pre-python-3-14-usage"></a>

<p dir="auto">t-strings were introduced in Python 3.14 via, <a href="https://peps.python.org/pep-0750/" rel="nofollow">PEP 750</a>, however this library can be
used with Python 3.12 and 3.13 as follows,</p>
<div dir="auto" data-snippet-clipboard-copy-content="from sql_tstring import sql

a = 1

query, values = sql(
    &#34;&#34;&#34;SELECT a, b, c
         FROM tbl
        WHERE a = {a}&#34;&#34;&#34;,
    locals(),
)"><pre><span>from</span> <span>sql_tstring</span> <span>import</span> <span>sql</span>

<span>a</span> <span>=</span> <span>1</span>

<span>query</span>, <span>values</span> <span>=</span> <span>sql</span>(
    <span>&#34;&#34;&#34;SELECT a, b, c</span>
<span>         FROM tbl</span>
<span>        WHERE a = {a}&#34;&#34;&#34;</span>,
    <span>locals</span>(),
)</pre></div>
<p dir="auto">Please note though that only simple variable identifiers can be placed
within the braces.</p>

</article></div></div>
  </body>
</html>
