<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gist.github.com/rbitr/9c68379d3e0b79c9f06eb3f867624576">Original</a>
    <h1>Random Numbers in Bash</h1>
    
    <div id="readability-page-1" class="page"><div>
  <div id="file-random_notes-md">
      
      <div id="file-random_notes-md-readme">
    <article itemprop="text">
<p dir="auto">There is a variable $RANDOM than you can read in bash or zsh to get a random number beteen 0 and 32767. Here in zsh on my (old) mac:</p>
<div dir="auto"><pre>% <span>echo</span> <span>$RANDOM</span>
13757
% <span>echo</span> <span>$RANDOM</span>
16896</pre></div>
<p dir="auto">Logically you could make a bunch of random numbers with a loop</p>
<div dir="auto"><pre>% <span>for</span> <span>x</span> <span>in</span> {1..10}<span>;</span> <span>do</span> <span>echo</span> <span>$RANDOM</span><span>;</span> <span>done</span>
14020
14135
10150
15776
431
6192
6705
15111
27049
23618</pre></div>
<p dir="auto">zsh has an intentional quirk where the random same random state is passed to any subshell, which I didn&#39;t</p>
<div dir="auto"><pre><span><span>#</span> rnd2.sh</span>
<span><span>#!</span> /bin/bash</span>

<span>for</span> <span><span>((</span>i<span>=</span><span>1</span>;i<span>&lt;=</span><span>10</span>;i<span>++</span><span>))</span></span>
<span>do</span>
<span>echo</span> <span><span>$(</span>echo <span>$RANDOM</span><span>)</span></span> <span><span>#</span> random runs in subshell</span>
<span>done</span></pre></div>
<p dir="auto">Running the above with zsh gives the same random numnber every time:</p>
<pre><code>% zsh rnd2.sh
12958
12958
12958
12958
12958
12958
12958
12958
12958
12958
</code></pre>
<p dir="auto">Running with bash gives what at first I thought was a random sequence:</p>
<div dir="auto"><pre>% bash rnd2.sh
32075
16146
216
17054
1124
17963
2033
18871
2942
19780</pre></div>
<p dir="auto">In zsh it is possible to seed the RNG with <code>RANDOM=$RANDOM</code> to avoid this behavior, or you can just run in bash. I learned all this from Stack overflow after Kagi-ing why all my numbers were the same: <a href="https://stackoverflow.com/questions/63544826/unix-shell-why-are-the-same-random-numbers-repeated" rel="nofollow">https://stackoverflow.com/questions/63544826/unix-shell-why-are-the-same-random-numbers-repeated</a>. I also know from the usual SO type comments that $RANDOM is not a great RNG, if for some reason you thought it was. It uses a simple modulus function for generating the numbers, and it generates numbers that end in 8 or 9 slighlty less often. I don&#39;t care about any of that, I just wanted something that wasn&#39;t obviously nonrandom.</p>
<p dir="auto">So far so good. Then I wrote the following:</p>
<div dir="auto"><pre><span><span>#</span> rnd8.sh</span>
<span><span>#!</span> /bin/bash</span>

<span>for</span> <span><span>((</span>i<span>=</span><span>1</span>;i<span>&lt;=</span><span>10</span>;i<span>++</span><span>))</span></span>
<span>do</span>
<span>echo</span> <span><span>$(</span>bc <span>&lt;&lt;&lt;</span> <span><span>$RANDOM</span></span><span>)</span></span>
<span>done</span></pre></div>
<div dir="auto"><pre>% ./rnd8.sh <span><span>#</span> running in bash</span>
8726
10075
11424
12773
14123
15472
16821
18170
19519
20869</pre></div>
<p dir="auto">The numbers all are in order and differ by either 1349 or occasionally 1350.</p>
<p dir="auto">If I run the same code in bash on Linux it appears normally random:</p>
<div dir="auto"><pre>$ ./rnd8.sh
14276
14526
24676
22391
13409
18486
8645
19573
14892
6701</pre></div>
<p dir="auto">I switched here to using a random number input into <code>bc</code> because that was closer to my real use case and it where I noticed this. If you look back at the output from <code>rnd2.sh</code> that uses <code>echo</code>:</p>
<div dir="auto"><pre>% bash rnd2.sh
32075
16146
216
17054
1124
17963
2033
18871
2942
19780</pre></div>
<p dir="auto">You see this is actually two interleaved streams of number, counting up modulo 32768, i.e. it can be split into</p>
<div dir="auto"><pre>32075 16146
216 17054
1124 17963
2033 18871
2942 19780</pre></div>
<p dir="auto">What is responsible for this? I assume it&#39;s something to do with the way the subshells are invoked. And is the difference between the mac and ubuntu because of the shell versions involved (bash 3.2.57(1)-release on the mac, 5.0.17(1)-release on ubuntu) or some other reason? Or most likely, am I overlooking some obvious thing? Either way, my conclusion is that I should look for a more reliable way to get random numbers.</p>
<div dir="auto"><pre>python -c <span><span>&#34;</span>from random import*; print(choice(range(2**15)))<span>&#34;</span></span></pre></div>
<p dir="auto">To answer my own question, it&#39;s the bash version. Running 3.2.57 under linux gives the same result.</p>
<p dir="auto">If you look at the bash source code, the RNG is in <code>variables.c</code>:</p>
<div dir="auto"><pre><span>static</span> <span>unsigned</span> <span>long</span> rseed = <span>1</span>;

...

<span>static</span> <span>int</span>
<span>brand</span> ()
{
  rseed = rseed * <span>1103515245</span> + <span>12345</span>;
  <span>return</span> ((<span>unsigned</span> <span>int</span>)((rseed &gt;&gt; <span>16</span>) &amp; <span>32767</span>));       <span><span>/*</span> was % 32768 <span>*/</span></span>
}</pre></div>
<p dir="auto">And in a subshell:</p>
<div dir="auto"><pre><span>int</span>
<span>get_random_number</span> ()
{
  <span>int</span> rv;

  <span><span>/*</span> Reset for command and process substitution. <span>*/</span></span>
  <span>if</span> (subshell_environment &amp;&amp; seeded_subshell == <span>0</span>)
    {
      <span>sbrand</span> (rseed + <span>getpid</span>() + NOW);
      seeded_subshell = <span>1</span>;
    }

  <span>do</span>
    rv = <span>brand</span> ();
  <span>while</span> (rv == last_random_value);
  <span>return</span> rv;
}</pre></div>
<p dir="auto">I&#39;d guess that <code>NOW</code> doesn&#39;t change fast enough, and pids are getting cycled in a way that the random state isn&#39;t getting re-seeded?</p>
<p dir="auto">Turns out the time part may at least partially relate. If I run the code below, I get a single monotonic sequence of numbers as output, rather than the interleaved ones.</p>
<pre><code>#! /bin/bash

for ((i=1;i&lt;=10;i++))
do
echo $(echo $RANDOM)
sleep 2
done
</code></pre>
<p dir="auto">I could do mpre experiments and try to definitelvely determine what&#39;s happening, bottom line, don&#39;t use $RANDOM, even for unimportant random numbers.,</p>
</article>
  </div>

  </div>
</div></div>
  </body>
</html>
