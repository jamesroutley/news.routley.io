<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://phoboslab.org/log/2023/04/qoa-specification">Original</a>
    <h1>Quite OK Audio Format</h1>
    
    <div id="readability-page-1" class="page"><div>	
	<div>
		
		<p>— Tuesday, April 25th 2023</p>
	</div>
	

	<p>The specification for the <em><a href="https://qoaformat.org">Quite OK Audio Format</a></em>, 
announced in a <a href="https://phoboslab.org/log/2023/02/qoa-time-domain-audio-compression">previous blog post</a>, 
is now finalized. QOA is a lossy audio compression format. Typical audio 
signals (44100hz, stereo) are encoded into 278 kbits/s, or more precisely 3.2 
bits per sample – exactly 1/5 of the bits needed for an uncompressed WAV.</p>
<p><img src="https://phoboslab.org/content/assets/qoa-logo.svg" alt="qoa Logo"/>
</p>
<p>The QOA-Specification <a href="https://qoaformat.org/qoa-specification.pdf">fits on a single-page PDF</a>.
More information and test samples can be found on <a href="https://qoaformat.org/">qoaformat.org</a>. 
The source is on <a href="https://github.com/phoboslab/qoa">github</a>.</p>
<h2>Performance Improvements</h2>
<p>Over the past few weeks I implemented some changes to the reference en-/decoder
to improve performance, specifically when decoding.</p>
<p>The largest performance gain, an 8% improvement, came from a somewhat 
counter-intuitive looking change: a specialization of the <code>qoa_clamp()</code> function.</p>
<pre><code><span>static</span> inline <span>int</span> qoa_clamp<span>(</span><span>int</span> v<span>,</span> <span>int</span> min<span>,</span> <span>int</span> max<span>)</span> <span>{</span>
    <span>if</span> <span>(</span>v <span>&lt;</span> min<span>)</span> <span>{</span> <span>return</span> min<span>;</span> <span>}</span>
    <span>if</span> <span>(</span>v <span>&gt;</span> max<span>)</span> <span>{</span> <span>return</span> max<span>;</span> <span>}</span>
    <span>return</span> v<span>;</span>
<span>}</span>

<span>static</span> inline <span>int</span> qoa_clamp_s16<span>(</span><span>int</span> v<span>)</span> <span>{</span>
    <span>if</span> <span>((</span><span>unsigned</span> <span>int</span><span>)(</span>v <span>+</span> <span>32768</span><span>)</span> <span>&gt;</span> <span>65535</span><span>)</span> <span>{</span>
        <span>if</span> <span>(</span>v <span>&lt;</span> <span>-</span><span>32768</span><span>)</span> <span>{</span> <span>return</span> <span>-</span><span>32768</span><span>;</span> <span>}</span>
        <span>if</span> <span>(</span>v <span>&gt;</span>  <span>32767</span><span>)</span> <span>{</span> <span>return</span>  <span>32767</span><span>;</span> <span>}</span>
    <span>}</span>
    <span>return</span> v<span>;</span>
<span>}</span></code></pre>
<p>The clamp function in the decoder is <em>extremely</em> hot. It is called for each
output sample to clamp it into the 16 bit range. The reason that <code>qoa_clamp_s16()</code> 
is faster than <code>qoa_clamp()</code> is owed to the fact that these output samples are
very rarely clamped at all.</p>
<p>The extra <code>if</code> statement here checks for both branches (<code>v &lt; -32768</code> and <code>v &gt; 32767</code>)
simultaneously and is very rarely taken. This helps the CPU&#39;s branch predictor to
correctly predict and skip the branch in the vast majority of cases.</p>
<p>I also tried to re-implement the whole inner decoder loop with x86/x64 SIMD 
intrinsics, but failed to make it faster than what <code>gcc -O3</code> would produce – a
testament to the advances of modern compilers! Luckily, QOA is already pretty
fast.</p>
<h2>Benchmark Results</h2>
<p>For these benchmarks I used the 2 hour 43 minute stereo audio track of the 
Bladerunner 2049 movie. All codecs were tested single threaded 
(<code>-threads 1</code> for ffmpeg) and output was sent to <code>/dev/null</code>. The Vorbis, Opus, 
MP3, M4A and ADPCM files were encoded with ffmpeg&#39;s default settings.</p>
<p>My CPU is an Intel i7-6700k; input files were stored on an NVME SSD. The 
measurements were taken with <code>time</code> in the terminal, using the best out of 5 runs. 
<strong>Please take these results here with a huge grain of salt. This is only meant to 
give a general idea of the performance between various codecs</strong>.</p>
<p>Results for bladerunner.wav, stereo 44100 hz, 9807 sec, 1650 mb:</p>
<table>
    <tbody><tr>                  <th>Format  </th><th>Lib/Tool  </th><th>encode (s)</th><th>decode (s)</th><th>size (mb)</th></tr>
    <tr>                  <td>wv -b3  </td><td>wavpack   </td><td>    42.175</td><td>    29.800</td><td>      304</td></tr>
    <tr>                  <td>wv -b2  </td><td>wavpack   </td><td>    37.821</td><td>    25.690</td><td>      234</td></tr>
    <tr>                  <td>opus    </td><td>ffmpeg    </td><td>   315.232</td><td>    20.410</td><td>      116</td></tr>
    <tr>                  <td>wv      </td><td>wavpack   </td><td>    26.494</td><td>    15.584</td><td>      558</td></tr>
    <tr>                  <td>vorbis  </td><td>stb_vorbis</td><td>          </td><td>    13.593</td><td>         </td></tr>
    <tr>                  <td>mp3     </td><td>ffmpeg    </td><td>   146.223</td><td>     9.631</td><td>      149</td></tr>
    <tr>                  <td>vorbis  </td><td>ffmpeg    </td><td>   145.125</td><td>     8.732</td><td>      200</td></tr>
    <tr>                  <td>flac    </td><td>ffmpeg    </td><td>    18.148</td><td>     8.715</td><td>      552</td></tr>
    <tr>                  <td>mp3     </td><td>dr_mp3    </td><td>          </td><td>     7.503</td><td>         </td></tr>
    <tr>                  <td>aac     </td><td>ffmpeg    </td><td>    86.884</td><td>     6.636</td><td>      151</td></tr>
    <tr>                  <td>flac    </td><td>dr_flac   </td><td>          </td><td>     6.429</td><td>         </td></tr>
    <tr>                  <td>adpcm_ms</td><td>ffmpeg    </td><td>    10.424</td><td>     3.690</td><td>      417</td></tr>
    <tr><td>qoa     </td><td>qoaconv   </td><td>    25.752</td><td>     2.996</td><td>      333</td></tr>
</tbody></table>
<p>Curiously, even MS ADPCM is slower to decode than QOA. I suspect that ffmpeg 
itself has some considerable overhead, with the data traveling through many
layers of abstractions.</p>
<p>So as it stands, QOA is the fastest format to decode in my (admittedly limited) 
tests. In any case, I believe that QOA offers a worthwhile tradeoff between file
size, quality and decoding speed.</p>
<h2>Implementations</h2>
<p>Apart from the <a href="https://github.com/phoboslab/qoa">reference implementation</a>, QOA 
has already been ported to a number of different languages, including
<a href="https://github.com/mattdesl/qoa-format">JavaScript</a>,
<a href="https://github.com/SerenityOS/serenity/blob/master/Userland/Libraries/LibAudio/QOALoader.h">C++</a>,
<a href="https://github.com/JohannesFriedrich/qoa4R">R</a>,
<a href="https://github.com/rafaelcaricio/qoaudio">Rust</a>,
<a href="https://github.com/AuburnSounds/audio-formats">D</a> and this
<a href="https://github.com/pfusik/qoa-ci">Ć project by @pfusik</a> which transpiles to C, C++, C#, Java, JavaScript, 
Python, Swift and TypeScript.</p>
<p>As part of @pfusik&#39;s project he also provides a <a href="https://www.foobar2000.org/components/view/foo_qoa">QOA Plugin for Foobar2000</a>. 
With Foobar2000 being one of my favorite pieces of software, this is very cool to see!</p>
<p><img src="https://phoboslab.org/content/assets/foobar-2000-qoa.png" alt="QOA Plugin for Foobar2000"/></p>
<p>QOA is also supported in the game engine <a href="https://www.raylib.com/">raylib</a>. It&#39;s probably just a matter of time until we
see the first game that uses QOA for audio playback. I&#39;m excited!</p>
<h2>The Specification</h2>
<p>The final specification details the exact file format as well as the steps 
needed to decode. Again, the whole specification is just a 
<a href="https://qoaformat.org/qoa-specification.pdf">single page PDF</a>:</p>
<p><a href="https://qoaformat.org/qoa-specification.pdf"><img src="https://phoboslab.org/content/assets/qoa-specification.png" alt="qoa File Format Specification"/></a></p></div></div>
  </body>
</html>
