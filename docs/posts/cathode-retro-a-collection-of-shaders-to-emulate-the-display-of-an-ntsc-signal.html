<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/DeadlyRedCube/Cathode-Retro">Original</a>
    <h1>Cathode-Retro: A collection of shaders to emulate the display of an NTSC signal</h1>
    
    <div id="readability-page-1" class="page"><div><blockquote><p>Some thoughts on melding <code>R</code> with lower level languages and package management</p></blockquote><h2 id="background">Background</h2><p>I like plotting with <code>ggplot2</code>. It makes more sense to me than the other
plotting systems. These notes arose while binding <a href="https://github.com/HaoZeke/readCon">readCon</a> and <a href="https://github.com/TheochemUI/potlib">potlib</a> for
<a href="https://github.com/HaoZeke/cuh2vizR">cuh2vizR</a>. However, for best practices, my <a href="https://github.com/ropensci/fastMatMR">fastMatMR</a> project should be consulted.</p><h2 id="idiosyncracies">Idiosyncracies</h2><ul><li>I find it odd that <code>R</code> packages commit so much generated code<ul><li>Can be simplified with a CI bot</li></ul></li></ul><h2 id="repo-setup">Repo setup</h2><p><code>pixi</code> with <code>renv</code> turns out to be surprisingly robust. I normally begin with:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span><span>echo</span> <span>&#34;.pixi/&#34;</span> &gt; .gitignore
</span></span><span><span>2</span><span>gibo dump R C++ <span>|</span> cat &gt;&gt; .gitignore
</span></span><span><span>3</span><span>pixi init
</span></span><span><span>4</span><span>pixi add radian r-renv compilers
</span></span><span><span>5</span><span>git add .
</span></span><span><span>6</span><span>git commit -m <span>&#34;PRJ: Let there be light&#34;</span>
</span></span></code></pre></div><p>The rest of the preliminaries can take place within the context of <code>renv</code> and
<code>pixi shell</code>. I tend to leave <code>LICENSE</code> and other templates to <code>usethis</code>.</p><h3 id="renv-package-development"><code>renv</code> package development</h3><p>This is fairly straightforward, but takes a while to run, from the <code>radian</code>
terminal (after <code>pixi-shell</code>).</p><div><pre tabindex="0"><code data-lang="R"><span><span>1</span><span><span>renv</span><span>::</span><span>init</span><span>()</span>
</span></span><span><span>2</span><span><span>install.packages</span><span>(</span><span>c</span><span>(</span><span>&#34;devtools&#34;</span><span>))</span> <span># can take a while</span>
</span></span><span><span>3</span><span><span>usethis</span><span>::</span><span>create_package</span><span>(</span><span>&#34;.&#34;</span><span>)</span> <span># from $GITROOT</span>
</span></span></code></pre></div><p>Now we can start with the rest of the templates.</p><div><pre tabindex="0"><code data-lang="R"><span><span>1</span><span><span>usethis</span><span>::</span><span>use_mit_license</span><span>()</span>
</span></span><span><span>2</span><span><span>usethis</span><span>::</span><span>use_readme_rmd</span><span>()</span>
</span></span></code></pre></div><div><p><strong>Warning</strong></p><p>CRAN doesn’t like fixed dependencies, see <a href="https://github.com/ropensci-review-tools/pkgcheck/issues/149">the discussion here</a>, and often for
developing packages one might not need <code>renv</code> though it still makes sense if one
has multiple development machines. This turned out to be something I regretted,
though <code>pixi</code> is still useful.</p></div><h2 id="stylistic-decisions">Stylistic decisions</h2><p>Always a good idea to lint and style from the get-go, so:</p><div><pre tabindex="0"><code data-lang="R"><span><span>1</span><span><span>install.packages</span><span>(</span><span>c</span><span>(</span><span>&#34;lintr&#34;</span><span>,</span> <span>&#34;styler&#34;</span><span>))</span>
</span></span></code></pre></div><p>Also remember to add <code>.pixi/</code> to <code>.Rbuildignore</code> otherwise local checks will
parse the entire contents of the rather substantial folder.</p><h3 id="pre-commit-hooks">Pre-commit hooks</h3><p>For my packages, I tend to use a <code>pre-commit-hook</code> configured with <code>.pre-commit-config.yaml</code>:</p><div><pre tabindex="0"><code data-lang="yaml"><span><span> 1</span><span><span>repos</span><span>:</span><span>
</span></span></span><span><span> 2</span><span><span></span>- <span>repo</span><span>:</span><span> </span><span>https://github.com/pre-commit/pre-commit-hooks</span><span>
</span></span></span><span><span> 3</span><span><span>  </span><span>rev</span><span>:</span><span> </span><span>v4.4.0</span><span>
</span></span></span><span><span> 4</span><span><span>  </span><span>hooks</span><span>:</span><span>
</span></span></span><span><span> 5</span><span><span>  </span>- <span>id</span><span>:</span><span> </span><span>trailing-whitespace</span><span>
</span></span></span><span><span> 6</span><span><span>    </span><span>exclude</span><span>:</span><span> </span><span>^(.lintr)</span><span>
</span></span></span><span><span> 7</span><span><span>  </span>- <span>id</span><span>:</span><span> </span><span>end-of-file-fixer</span><span>
</span></span></span><span><span> 8</span><span><span>  </span>- <span>id</span><span>:</span><span> </span><span>check-yaml</span><span>
</span></span></span><span><span> 9</span><span><span>  </span>- <span>id</span><span>:</span><span> </span><span>check-added-large-files</span><span>
</span></span></span><span><span>10</span><span><span></span>- <span>repo</span><span>:</span><span> </span><span>https://github.com/pre-commit/mirrors-clang-format</span><span>
</span></span></span><span><span>11</span><span><span>  </span><span>rev</span><span>:</span><span> </span><span>v16.0.6</span><span>
</span></span></span><span><span>12</span><span><span>  </span><span>hooks</span><span>:</span><span>
</span></span></span><span><span>13</span><span><span>  </span>- <span>id</span><span>:</span><span> </span><span>clang-format</span><span>
</span></span></span></code></pre></div><p>Which can be used via:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span><span># Check</span>
</span></span><span><span>2</span><span>pipx run pre-commit run -a
</span></span><span><span>3</span><span><span># Install</span>
</span></span><span><span>4</span><span>pipx run pre-commit install
</span></span></code></pre></div><p>Also worth noting is the CI configuration for the same especially useful for
contributors, <code>.github/workflows/pre-commit.yml</code>:</p><div><pre tabindex="0"><code data-lang="yaml"><span><span> 1</span><span><span>name</span><span>:</span><span> </span><span>pre-commit</span><span>
</span></span></span><span><span> 2</span><span><span></span><span>on</span><span>:</span><span>
</span></span></span><span><span> 3</span><span><span>  </span><span>pull_request</span><span>:</span><span>
</span></span></span><span><span> 4</span><span><span>  </span><span>push</span><span>:</span><span>
</span></span></span><span><span> 5</span><span><span>    </span><span>branches</span><span>:</span><span> </span><span>[</span><span>main]</span><span>
</span></span></span><span><span> 6</span><span><span></span><span>jobs</span><span>:</span><span>
</span></span></span><span><span> 7</span><span><span>  </span><span>pre-commit</span><span>:</span><span>
</span></span></span><span><span> 8</span><span><span>    </span><span>runs-on</span><span>:</span><span> </span><span>ubuntu-latest</span><span>
</span></span></span><span><span> 9</span><span><span>    </span><span>steps</span><span>:</span><span>
</span></span></span><span><span>10</span><span><span>    </span>- <span>uses</span><span>:</span><span> </span><span>actions/checkout@v3</span><span>
</span></span></span><span><span>11</span><span><span>    </span>- <span>uses</span><span>:</span><span> </span><span>actions/setup-python@v3</span><span>
</span></span></span><span><span>12</span><span><span>      </span><span>with</span><span>:</span><span>
</span></span></span><span><span>13</span><span><span>        </span><span>python-version</span><span>:</span><span> </span><span>&#39;3.11&#39;</span><span>
</span></span></span><span><span>14</span><span><span>    </span>- <span>uses</span><span>:</span><span> </span><span>pre-commit/action@v2.0.3</span><span>
</span></span></span></code></pre></div><p>However, sometimes <code>pre-commit</code> for <code>R</code> can be flakey. In such situations consider:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span>find . <span>\(</span> -path <span>&#34;./.pixi&#34;</span> -o -path <span>&#34;./renv&#34;</span> <span>\)</span> -prune -o -type f -name <span>&#34;*.R&#34;</span> -exec Rscript -e <span>&#39;library(styler); style_file(&#34;{}&#34;)&#39;</span> <span>\;</span>
</span></span><span><span>2</span><span>Rscript -e <span>&#39;library(lintr); lintr::lint_package(&#34;.&#34;)&#39;</span>
</span></span></code></pre></div><p>In any case, always remember to run <code>renv::snapshot()</code> after an
<code>install.packages</code> call.</p><h3 id="ropensci-package-check">ROpenSci package check</h3><div><p><strong>Warning</strong></p><p>This is <strong>really</strong> slow locally, but required in the <code>renv</code> workflow. Still annoying to run locally!</p></div><p>We need to install this with a non-CRAN <a href="https://docs.ropensci.org/pkgcheck/">source</a>:</p><div><pre tabindex="0"><code data-lang="R"><span><span>1</span><span><span>options </span><span>(</span><span>repos</span> <span>=</span> <span>c </span><span>(</span>
</span></span><span><span>2</span><span>        <span>ropenscireviewtools</span> <span>=</span> <span>&#34;https://ropensci-review-tools.r-universe.dev&#34;</span><span>,</span>
</span></span><span><span>3</span><span>        <span>CRAN</span> <span>=</span> <span>&#34;https://cloud.r-project.org&#34;</span>
</span></span><span><span>4</span><span>    <span>))</span>
</span></span><span><span>5</span><span><span>install.packages</span><span>(</span><span>&#34;pkgcheck&#34;</span><span>)</span>
</span></span></code></pre></div><p>When its finally done, add the CI configuration.</p><div><pre tabindex="0"><code data-lang="yaml"><span><span> 1</span><span><span>name</span><span>:</span><span> </span><span>ROpenSci pkg-check</span><span>
</span></span></span><span><span> 2</span><span><span></span><span>on</span><span>:</span><span>
</span></span></span><span><span> 3</span><span><span>  </span><span>push</span><span>:</span><span>
</span></span></span><span><span> 4</span><span><span>    </span><span>branches</span><span>:</span><span>
</span></span></span><span><span> 5</span><span><span>      </span>- <span>main</span><span>
</span></span></span><span><span> 6</span><span><span>  </span><span>pull_request</span><span>:</span><span>
</span></span></span><span><span> 7</span><span><span>    </span><span>branches</span><span>:</span><span>
</span></span></span><span><span> 8</span><span><span>      </span>- <span>main</span><span>
</span></span></span><span><span> 9</span><span><span></span><span>jobs</span><span>:</span><span>
</span></span></span><span><span>10</span><span><span>  </span><span>pkgcheck</span><span>:</span><span>
</span></span></span><span><span>11</span><span><span>    </span><span>runs-on</span><span>:</span><span> </span><span>ubuntu-latest</span><span>
</span></span></span><span><span>12</span><span><span>    </span><span>steps</span><span>:</span><span>
</span></span></span><span><span>13</span><span><span>      </span>- <span>uses</span><span>:</span><span> </span><span>actions/checkout@v3</span><span>
</span></span></span><span><span>14</span><span><span>        </span><span>with</span><span>:</span><span>
</span></span></span><span><span>15</span><span><span>          </span><span>submodules</span><span>:</span><span> </span><span>&#34;recursive&#34;</span><span>
</span></span></span><span><span>16</span><span><span>          </span><span>fetch-depth</span><span>:</span><span> </span><span>0</span><span>
</span></span></span><span><span>17</span><span><span>      </span>- <span>name</span><span>:</span><span> </span><span>pkgcheck</span><span>
</span></span></span><span><span>18</span><span><span>        </span><span>uses</span><span>:</span><span> </span><span>ropensci-review-tools/pkgcheck-action@v1.0.0</span><span>
</span></span></span></code></pre></div><h2 id="using-cpp11">Using <code>cpp11</code></h2><p>Even after <code>usethis::use_package(&#34;cpp11&#34;)</code> one must link to it explicitly in the <code>DESCRIPITON</code>:</p><div><pre tabindex="0"><code data-lang="yaml"><span><span>1</span><span><span> </span><span>SystemRequirements</span><span>:</span><span> </span><span>C++17</span><span>
</span></span></span><span><span>2</span><span><span> </span><span>Encoding</span><span>:</span><span> </span><span>UTF-8</span><span>
</span></span></span><span><span>3</span><span><span> </span><span>Roxygen</span><span>:</span><span> </span><span>list(markdown = TRUE)</span><span>
</span></span></span><span><span>4</span><span><span> </span><span>RoxygenNote</span><span>:</span><span> </span><span>7.2.3</span><span>
</span></span></span><span><span>5</span><span><span></span><span>+LinkingTo</span><span>:</span><span>
</span></span></span><span><span>6</span><span><span></span><span>+    cpp11</span><span>
</span></span></span><span><span>7</span><span><span> </span><span>Imports</span><span>:</span><span>
</span></span></span><span><span>8</span><span><span>     </span><span>cpp11</span><span>
</span></span></span></code></pre></div><p>One of the other things which tripped me up is that the functions are not
automatically exported, and so one needs to create, in <code>R/$PKGNAME-package.R</code>:</p><div><pre tabindex="0"><code data-lang="R"><span><span>1</span><span><span>## usethis namespace: start</span>
</span></span><span><span>2</span><span><span>#&#39; @useDynLib your-package-name, .registration = TRUE</span>
</span></span><span><span>3</span><span><span>## usethis namespace: end</span>
</span></span><span><span>4</span><span><span>#&#39; @export func-name-from-cpp11.R</span>
</span></span><span><span>5</span><span><span>NULL</span>
</span></span></code></pre></div><p>Finally, in most cases I found <code>devtools::load_all()</code> to be a bit insufficient, had to use the more complete:</p><div><pre tabindex="0"><code data-lang="R"><span><span>1</span><span><span>devtools</span><span>::</span><span>clean_dll</span><span>()</span>
</span></span><span><span>2</span><span><span>cpp11</span><span>::</span><span>cpp_register</span><span>()</span>
</span></span><span><span>3</span><span><span>devtools</span><span>::</span><span>document</span><span>()</span>
</span></span><span><span>4</span><span><span>devtools</span><span>::</span><span>load_all</span><span>()</span>
</span></span></code></pre></div><p>I never understood why the <code>R</code> community commits so many generated files, personally I like to prepend my <code>gitignore</code> with:</p><div><pre tabindex="0"><code data-lang="fallback"><span><span>1</span><span>## Generated files
</span></span><span><span>2</span><span>R/cpp11.R
</span></span><span><span>3</span><span>src/cpp11.cpp
</span></span><span><span>4</span><span>man/
</span></span></code></pre></div><div><p><strong>Warning</strong></p><p>Sadly the entire <code>R</code> ecosystem of checks will fail with this, so a first approximation committing everything might make some sense..</p></div><p>Later, a bot or CI action can be used to populate a “full” branch of the
repository without muddying my nice <code>git</code> history. In fact, some of these are
actually already part of the set of <a href="https://github.com/r-lib/actions/tree/v2/examples">Github Actions</a> supported by <code>usethis::</code>. I
ended up with:</p><div><pre tabindex="0"><code data-lang="R"><span><span>1</span><span><span>usethis</span><span>::</span><span>use_github_action</span><span>()</span> <span>## Basic, smoke test</span>
</span></span><span><span>2</span><span><span>usethis</span><span>::</span><span>use_github_action</span><span>(</span><span>&#34;check-standard&#34;</span><span>)</span> <span>## Overwrite older</span>
</span></span></code></pre></div><p>I was also initially thrown by the requirement of including copies of source
code. I suspect this might be bypassed by using <code>meson</code> as I have in <code>cuh2vizR</code>,
unless CRAN packages are built without internet access. It would make it much
easier to handle updates if <code>meson</code> were to handle setting up the dependencies,
however, it isn’t exactly part of <code>R-tools</code><sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup>.</p><h2 id="appeasing-pkgcheck">Appeasing <code>pkgcheck</code></h2><p>Some thoughts:</p><ul><li>No <code>renv</code> in <code>.Rprofile</code></li><li>Use <code>codemetar</code> to get a <code>codemeta.json</code></li><li>Add a <code>CONTRIBUTING.md</code> (e.g. here)<ul><li>Not strictly necessary but I also go with a <code>CODE_OF_CONDUCT.md</code> (e.g. here)</li></ul></li></ul><p>Personally I needed some <code>tex</code> updates:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span>tlmgr install collection-latexrecommended
</span></span><span><span>2</span><span>tlmgr install collection-fontsrecommended
</span></span></code></pre></div><p>Always best to include a <code>.covrignore</code> but when in a pinch, this will work:</p><div><pre tabindex="0"><code data-lang="R"><span><span>1</span><span><span>covr</span><span>::</span><span>package_coverage</span><span>(</span><span>line_exclusions</span><span>=</span><span>file.path</span><span>(</span><span>&#34;.pixi&#34;</span><span>,</span> <span>list.files</span><span>(</span><span>path</span><span>=</span><span>&#34;.pixi&#34;</span><span>,</span> <span>recursi</span>
</span></span><span><span>2</span><span>    <span>ve</span><span>=</span><span>T</span><span>)))</span>
</span></span></code></pre></div><p>Also useful was:</p><div><pre tabindex="0"><code data-lang="R"><span><span>1</span><span><span>usethis</span><span>::</span><span>use_build_ignore</span><span>(</span><span>c</span><span>(</span><span>&#34;newsfragments/&#34;</span><span>,</span> <span>&#34;pixi.*&#34;</span><span>,</span> <span>&#34;CONTRIBUTING.md&#34;</span><span>,</span> <span>&#34;CODE_OF_CONDUCT.md&#34;</span><span>,</span> <span>&#34;.covrignore&#34;</span><span>))</span>
</span></span></code></pre></div><p>It is also important, for benchmarking and other long running vignettes, to have
them cached or precomputed, as detailed in <a href="https://www.kloppenborg.ca/2021/06/long-running-vignettes/">this blog post</a> which in turn
references an <a href="https://ropensci.org/blog/2019/12/08/precompute-vignettes/">older ROpenSci post</a>. Vignette images are a whole other beast,
nicely <a href="https://www.jumpingrivers.com/blog/knitr-rmarkdown-image-size/">covered here</a>.</p><h2 id="conclusions">Conclusions</h2><p>These were my rough notes while developing guidelines during the first release
of <a href="https://github.com/ropensci/fastMatMR">fastMatMR</a>. There were additional changes to my packages, mostly in terms of
making them more in keeping with the <code>R</code> community expectations and best
practices. I went through the <code>ROpenSci</code> process and eventually also released to
<code>CRAN</code>, but will cover that in a follow-up.</p></div></div>
  </body>
</html>
