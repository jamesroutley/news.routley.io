<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/naugtur/running-qix-malware">Original</a>
    <h1>You too can run malware from NPM (I mean without consequences)</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">Phishing NPM package authors continues, unsurprisingly.
The stakes are not high enough to switch from phishing to anything more advanced (like <a href="https://xkcd.com/538/" rel="nofollow">https://xkcd.com/538/</a>) but seeing article blurbs say &#34;Supply chain Attack&#34; next to &#34;These packages generally receive 2-3 billion downloads per week.&#34; might finally be enough to make an impression, one hopes.</p>
<p dir="auto">This is not a detailed analysis of the attack, there&#39;s plenty of that already. If you&#39;re looking for one, visit our friends at <a href="https://socket.dev/blog/npm-author-qix-compromised-in-major-supply-chain-attack" rel="nofollow">https://socket.dev/blog/npm-author-qix-compromised-in-major-supply-chain-attack</a></p>
<p dir="auto">Instead, let&#39;s look at how you could have a compromised dependency like that get into your app and be stopped.</p>
<p dir="auto">One of the compromised packages was <code>is-arrayish</code> and I&#39;ll use that as an example going forward.</p>

<p dir="auto">So if an app uses <code>is-arrayish</code> in the browser, it will override <code>fetch</code>, <code>XMLHttpRequest</code> and <code>window.ethereum.request</code> and whenever it finds a transaction being sent, it&#39;ll replace the target address with one of the malware author&#39;s addresses that looks most alike.</p>
<p dir="auto">I won&#39;t go into this either, but you can take a look at the summary of &#34;donations&#34; some other friends linked to here: <a href="https://intel.arkm.com/explorer/entity/61fbc095-f19b-479d-a037-5469aba332ab" rel="nofollow">https://intel.arkm.com/explorer/entity/61fbc095-f19b-479d-a037-5469aba332ab</a></p>
<p dir="auto">Pretty low impact for an attack this big. Some of it seems to be people mocking the malware author with worthless transfers.</p>

<p dir="auto">Say we have an app.
The app allows the user to send a meaningless transaction to themselves. Don&#39;t expect it to make sense.
It also uses <code>is-arrayish</code> because otherwise we&#39;d have nothing to demo.</p>
<div dir="auto" data-snippet-clipboard-copy-content="const isArrayish = require(&#34;is-arrayish&#34;);

const button = document.createElement(&#34;button&#34;);
button.textContent = &#34;Send ETH Transaction&#34;;
document.body.appendChild(button);

button.addEventListener(&#34;click&#34;, async () =&gt; {
  const accounts = await window.ethereum.request({
    method: &#34;eth_requestAccounts&#34;,
  });
  if (!isArrayish(accounts)) {
    throw new Error(&#34;Accounts response must be array-like&#34;);
  }
  const myAddr = accounts[0];

  const txHash = await window.ethereum.request({
    method: &#34;eth_sendTransaction&#34;,
    params: [
      {
        value: &#34;0x5af3107a4000&#34;,
        from: myAddr,
        to: myAddr,
      },
    ],
  });
  console.log(&#34;Transaction sent:&#34;, txHash);
});"><pre><span>const</span> <span>isArrayish</span> <span>=</span> <span>require</span><span>(</span><span>&#34;is-arrayish&#34;</span><span>)</span><span>;</span>

<span>const</span> <span>button</span> <span>=</span> <span>document</span><span>.</span><span>createElement</span><span>(</span><span>&#34;button&#34;</span><span>)</span><span>;</span>
<span>button</span><span>.</span><span>textContent</span> <span>=</span> <span>&#34;Send ETH Transaction&#34;</span><span>;</span>
<span>document</span><span>.</span><span>body</span><span>.</span><span>appendChild</span><span>(</span><span>button</span><span>)</span><span>;</span>

<span>button</span><span>.</span><span>addEventListener</span><span>(</span><span>&#34;click&#34;</span><span>,</span> <span>async</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>const</span> <span>accounts</span> <span>=</span> <span>await</span> <span>window</span><span>.</span><span>ethereum</span><span>.</span><span>request</span><span>(</span><span>{</span>
    <span>method</span>: <span>&#34;eth_requestAccounts&#34;</span><span>,</span>
  <span>}</span><span>)</span><span>;</span>
  <span>if</span> <span>(</span><span>!</span><span>isArrayish</span><span>(</span><span>accounts</span><span>)</span><span>)</span> <span>{</span>
    <span>throw</span> <span>new</span> <span>Error</span><span>(</span><span>&#34;Accounts response must be array-like&#34;</span><span>)</span><span>;</span>
  <span>}</span>
  <span>const</span> <span>myAddr</span> <span>=</span> <span>accounts</span><span>[</span><span>0</span><span>]</span><span>;</span>

  <span>const</span> <span>txHash</span> <span>=</span> <span>await</span> <span>window</span><span>.</span><span>ethereum</span><span>.</span><span>request</span><span>(</span><span>{</span>
    <span>method</span>: <span>&#34;eth_sendTransaction&#34;</span><span>,</span>
    <span>params</span>: <span>[</span>
      <span>{</span>
        <span>value</span>: <span>&#34;0x5af3107a4000&#34;</span><span>,</span>
        <span>from</span>: <span>myAddr</span><span>,</span>
        <span>to</span>: <span>myAddr</span><span>,</span>
      <span>}</span><span>,</span>
    <span>]</span><span>,</span>
  <span>}</span><span>)</span><span>;</span>
  <span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;Transaction sent:&#34;</span><span>,</span> <span>txHash</span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span></pre></div>
<p dir="auto">This is what it looks like:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/naugtur/running-qix-malware/blob/main/img/scr1.png"><img src="https://github.com/naugtur/running-qix-malware/raw/main/img/scr1.png" alt=""/></a></p>
<p dir="auto">Now <strong>after you update <code>is-arrayish</code> to 0.3.3</strong> and rebuild the project, you might notice a slight difference.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/naugtur/running-qix-malware/blob/main/img/scr2.png"><img src="https://github.com/naugtur/running-qix-malware/raw/main/img/scr2.png" alt=""/></a></p>

<p dir="auto">If your project was set up with LavaMoat, you&#39;d be using a policy to decide which package is allowed access to what. <a href="https://lavamoat.github.io/guides/policy/" rel="nofollow">More about policies in the guide</a></p>
<p dir="auto">With LavaMoat, all <code>is-arrayish</code> can do is fail:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/naugtur/running-qix-malware/blob/main/img/scr3.png"><img src="https://github.com/naugtur/running-qix-malware/raw/main/img/scr3.png" alt=""/></a></p>
<div data-snippet-clipboard-copy-content="TypeError: Cannot define property fetch, object is not extensible"><pre><code>TypeError: Cannot define property fetch, object is not extensible
</code></pre></div>
<p dir="auto"><em>BTW, If the malware was written a little better to avoid detection and fail silently, the functionality of the app would be fully restored.</em></p>

<p dir="auto">To protect the project, <a href="https://www.npmjs.com/package/@lavamoat/webpack" rel="nofollow">@lavamoat/webpack</a> was used.</p>
<p dir="auto">In short, what it does is: it puts modules from every dependency in a separate lexical global context that we call <code>Compartment</code> and only allows access to globals that the policy lists. I also controls which packages can import which other packages.</p>
<p dir="auto">If the project dependency gets updated to contain malicious code, the policy will not allow it to access any globals or imports it didn&#39;t use before.</p>
<p dir="auto">Read more in the <a href="https://lavamoat.github.io/guides/webpack/" rel="nofollow">official guide</a></p>
</article></div></div>
  </body>
</html>
