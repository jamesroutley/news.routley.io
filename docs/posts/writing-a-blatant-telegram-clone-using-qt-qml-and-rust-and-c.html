<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kemble.net/blog/provoke/">Original</a>
    <h1>Writing a blatant Telegram clone using Qt, QML and Rust. And C&#43;&#43;</h1>
    
    <div id="readability-page-1" class="page"><div>
      
  <article>
    
    <div>
      <blockquote>
<p>This was a fun project for a couple of days, but I will probably shelve it for now so I can continue what I was already working on before. Read on to follow along with my journey.</p>
<p><b>Spoilers:</b> I didn’t get very far.</p>
</blockquote>
<p>Get ready for an Opinion Dump of an intro:</p>
<p>I have fond memories from 10 years ago of using Qt, and especially QML. It’s just so easy to think of a design and make it happen with QML. I chose to use Svelte for building Web Apps™ while it was still very beta just because it was the closest experience to QML I came across.</p>
<p>Rust is pretty great. Also been a huge fan of that since like 2012 when I saw an example on the front page where the compiler validated pointer usage at compile time without adding any extra work at run time. Basically black magic after trying to fix the worst kind of bugs in C++.</p>
<p>I became a full time Full Stack Web Developer against all my intentions. I like making user interfaces and solving hard problems though, so it’s not so bad. I have been wanting to make a properly “native” application for a while though.</p>
<p>I wonder if anyone out there is a full time Full Stack Film Developer (that sounded funnier in my head).</p>
<p>I like <a href="https://telegram.org/">Telegram</a> a lot, because I believe they have put the most love into their user interfaces out of all the chat programs I have seen. Also “Saved Messages” and being able to access all my messages from the last 10 years is pretty great. I also think Telegram is kinda lame in every other respect. I started trying out Element (a Matrix client) last week. The Android app is very decent these days, but the desktop app while clearly quite nice just doesn’t spark joy like Telegram’s desktop app. I played around with a bunch of other Matrix desktop clients just to see if the experience would be closer to Telegram, I could write a pros and cons list but that’s not why we’re here.</p>
<p>The “<a href="https://play.google.com/store/apps/details?id=io.element.android.x&amp;hl=en-US">Element X</a>” app (the <strong>X</strong> is for Xtreme, I guess) uses a Rust library called <a href="https://github.com/matrix-org/matrix-rust-sdk"><code>matrix-rust-sdk</code></a>, which apparently solves many of the problems you might face while making a Matrix client. That might be useful later on.</p>
<p>Anyway, here’s a random project I started working on just because I felt like it would be fun to use QML again while trying to generally use Rust instead of C++.</p>
<p><b>Goal:</b> Create a Telegram clone, whatever you already read the title.</p>
<h2 id="day-one-hour-zero">Day One, Hour Zero</h2>
<p>I’ve wanted to try using QML as the UI for a Rust app for a while, so that’s the driving force here. I’ve looked at some stuff in the past, but first I want to properly learn about what’s available.</p>
<ul>
<li><a href="https://github.com/woboq/qmetaobject-rs">qmetaobject-rs</a></li>
<li><a href="https://github.com/KDAB/cxx-qt">cxx-qt</a></li>
<li>Some other stuff that seems less good to build an app on top of, sorry everyone.</li>
</ul>
<p>In hindsight I know I wanted:</p>
<ul>
<li><code>cargo run</code> to be decently fast, both clean and incremental</li>
<li>Hot reloading</li>
<li>Ability to access all functionality of Qt if I wanted</li>
</ul>
<p>I started with cxx-qt because it seemed like the most official way to do Qt development, and definitely lets you access all Qt functionality. I made a super bare bones “open a window” program which got me excited, and I committed it to a git repo and everything. I may have spent like 30 minutes at this point coming up with a name for it.</p>
<p>Provoke</p>
<p>I don’t mind it. It’s in italics so it must be fancy.</p>
<p>I then spent hours trying to find ways to make cxx-qt not do some really expensive code generation and recompilation step every time I saved, then found out that VS Code was running <code>cargo check</code> one way while in the terminal <code>cargo check</code> was doing some other thing, and effectively blowing the cache every time I switched from one to the other.</p>
<p>Anyway it all made me a bit sad and I just wanted to write some delicious QML for goodness sake, so I moved on to qmetaobject-rs knowing that it can’t just access literally any Qt type I like, but maybe it will let me write some QML sooner, and not have an upsetting building experience?</p>
<p>Basically, yes, I got some QML running like immediately, and the builds are super fast.</p>
<p>But not fast enough, I want some kind of hot reloading. I’m not putting up with this after using Svelte for years.</p>
<p>Actual good hot reloading is not very trivial to implement, but I don’t need it to be actually good. After a couple of failed attempts due to restrictions with qmetaobject-rs’s design (I do actually recommend qmetaobject-rs btw, it’s good), I ended up hacking together a thing that registers a “HotReload” object with QML, which internally keeps a “should hot reload?” <code>Arc&lt;AtomicBool&gt;</code>. When a QML file modification is detected, another “anything changed?” bool is set to true, then when the window gains focus and it sees that something has been modified, it sets that bool to true then literally quits the app.</p>
<p>I then have a loop that checks if hot reloading has been requested and boots up the event loop again and loads the new QML files. To answer your question from two sentences ago, I originally immediately rebooted the app when a file changed, but that closed the window and opened the window again over the top of Vee Ess Cohde, and I press Ctrl+S a lot. I then added a button to the window that I needed to click to make the reload happen, but the file-modification-then-window-focus trigger is much, much better.</p>
<div><pre tabindex="0"><code data-lang="rust"><span><span><span>// Watch the files:
</span></span></span><span><span><span></span><span>let</span> (tx, rx) <span>=</span> std::sync::mpsc::channel();
</span></span><span><span><span>let</span> <span>mut</span> watcher <span>=</span> notify::recommended_watcher(tx).unwrap();
</span></span><span><span>watcher.configure(notify::Config::default().with_compare_contents(<span>true</span>)).unwrap();
</span></span><span><span>watcher.watch(Path::new(qml_folder), notify::RecursiveMode::Recursive).unwrap();
</span></span><span><span>
</span></span><span><span><span>let</span> thread_dirty_state <span>=</span> dirty_state.clone();
</span></span><span><span>std::thread::spawn(<span>move</span> <span>||</span> {
</span></span><span><span>	<span>while</span> <span>let</span> Ok(change) <span>=</span> rx.recv() {
</span></span><span><span>		<span>if</span> <span>let</span> Ok(change) <span>=</span> change {
</span></span><span><span>			<span>if</span> <span>let</span> notify::EventKind::Modify(modification) <span>=</span> change.kind {
</span></span><span><span>				thread_dirty_state.store(<span>true</span>, std::sync::atomic::Ordering::SeqCst);
</span></span><span><span>			}
</span></span><span><span>		}
</span></span><span><span>	}
</span></span><span><span>});
</span></span><span><span>
</span></span><span><span><span>// The event loop, loop:
</span></span></span><span><span><span></span><span>loop</span> {
</span></span><span><span>	hot_reload_state.store(<span>false</span>, std::sync::atomic::Ordering::SeqCst);
</span></span><span><span>	<span>let</span> <span>mut</span> engine <span>=</span> QmlEngine::new();
</span></span><span><span>	println!(<span>&#34;------&#34;</span>);
</span></span><span><span>	println!(<span>&#34;RELOAD&#34;</span>);
</span></span><span><span>
</span></span><span><span>	engine.set_property(<span>&#34;HotReload&#34;</span>.into(), hot_reload.pinned().into());
</span></span><span><span>	engine.load_file(format!(<span>&#34;</span><span>{qml_folder}</span><span>main.qml&#34;</span>).into());
</span></span><span><span>	engine.exec();
</span></span><span><span>
</span></span><span><span>	<span>if</span> <span>!</span>hot_reload_state.load(std::sync::atomic::Ordering::SeqCst) {
</span></span><span><span>		<span>break</span>;
</span></span><span><span>	}
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span><span>// Implementation of the HotReload object that gets registered with QML.
</span></span></span><span><span><span></span><span>impl</span> HotReload {
</span></span><span><span>	<span>fn</span> <span>reload_if_dirty</span>(<span>&amp;</span>self) {
</span></span><span><span>		<span>if</span> self.dirty_state.load(std::sync::atomic::Ordering::SeqCst) {
</span></span><span><span>			self.reload();
</span></span><span><span>		}
</span></span><span><span>	}
</span></span><span><span>
</span></span><span><span>	<span>fn</span> <span>reload</span>(<span>&amp;</span>self) {
</span></span><span><span>		self.dirty_state.store(<span>false</span>, std::sync::atomic::Ordering::SeqCst);
</span></span><span><span>		self.reload_state.store(<span>true</span>, std::sync::atomic::Ordering::SeqCst);
</span></span><span><span>		QCoreApplication::quit();
</span></span><span><span>	}
</span></span><span><span>}
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="js"><span><span><span>// Then from QML, the main window does this:
</span></span></span><span><span><span></span><span>onActiveChanged</span><span>:</span> {
</span></span><span><span>	<span>HotReload</span>.<span>reload_if_dirty</span>()
</span></span><span><span>}
</span></span></code></pre></div><p>I can’t say it’s amazing, but it was easy to implement and it gets the job done.</p>
<p>QML has a Language Server now which is awesome, but I couldn’t figure out how to get it working so I just opened up <a href="https://www.qt.io/development/tools/qt-creator-ide">Qt Creator</a> and edited QML there (Qt Creator is actually very good, perhaps unexpectedly so for those who haven’t used it). I then did something later on which made the language server work so I could just use VS Code to edit it with all my lovely custom configs and keyboard shortcuts. I’m still not sure what I did to make it work. Might look into that later.</p>
<p>Well that was fun, moving on…</p>
<h2 id="hour-five">Hour Five</h2>
<p>The great Telegram Ripping-Off begins.</p>
<p>Let’s start with the splitter that goes between the chat list sidebar and the actual chat. The sidebar has a 65px “collapsed” mode where it only shows icons of the chats, but the “normal” minimum is 260px. The right of the split can be min 380px. The provided splitter widget didn’t have enough features, so I just made my own one. That’s the great thing about a good UI language, you can just make your own one of a thing and it will be fun and not sad (just keep accessibility in mind even if you don’t implement it during the prototyping stage).</p>
<p>Here it is!</p>
<video width="100%" controls="">
	<source src="/provoke/splitter.webm" type="video/webm"/>
	If you&#39;re seeing this sentence, there&#39;s a bunch of videos on this page and it will look kinda boring without them.
</video>
<p>Note how the mouse cursor doesn’t stay as ↔ when it’s not exactly on the splitter. The <a href="https://doc.qt.io/QT-6/qml-qtquick-controls-splitview.html">built-in QML splitter</a> had that problem 15 years ago, and it’s still like that now :(</p>
<p>If I could access <a href="https://doc.qt.io/qt-6/qguiapplication.html#setOverrideCursor"><code>QGuiApplication::setOverrideCursor</code></a> I could make my splitter not have that problem, but as it stands, with my simple qmetaobject-rs project and 0% C++, I just can’t. Oh well, I’ll look into it later.</p>
<p>It’s a little bit buggy and the mouse doesn’t always line up with the splitter.</p>
<h2 id="3am-same-day">3am, same day</h2>
<p>I got a bit carried away. My commit messages since the last section were: <code>Various UI work</code>, <code>More UI stuff</code>, <code>Sidebar collapsing is much more advanced</code>, and <code>More UI work</code>. Highly descriptive. I basically re-learned a tonne of stuff about QML, including how to make nice animations, and was honestly quite pleased with myself with how close I got some of the interactions to Telegram. There will be a lot more of that coming up.</p>
<p>Just watch the following motion picture!</p>
<video width="100%" controls="">
	<source src="/provoke/moreuiwork.webm" type="video/webm"/>
</video>
<p>I even created my own implementation of that Material Design growing-circle-inside-of-another-circular-mask thingo. I spent too long on this because I found what I wanted: <a href="https://doc.qt.io/qt-6/qml-qt5compat-graphicaleffects-opacitymask.html">OpacityMask</a>, but realised it’s in the <code>Qt5Compat.GraphicalEffects</code> package because it’s basically deprecated. I then spent ages trying to figure out how to use MultiEffect to do the same thing and found that its mask feature seems to treat alpha as a boolean (could be wrong here, I just couldn’t make it work), then I went down the next rabbit hole of writing a custom shader effect, then because that was obnoxiously difficult to get <a href="https://doc.qt.io/qt-6/qml-qtquick-shadereffect.html">ShaderEffect</a> working, I just went back to using <code>OpacityMask</code>. Problem solved I guess.</p>
<h2 id="next-day-or-same-day-depending-on-how-you-think-about-it">Next Day, or Same Day, Depending On How You Think About It</h2>
<p><img src="https://kemble.net/provoke/chatbubble.png" alt="Chat Bubble"/></p>
<p>I made a chat bubble. That little tail thing in the bottom right was fun. It’s in the bottom left if someone else sent the message, how thoughtful. I used Inkscape to make a little thingy like this:</p>
<p><img src="https://kemble.net/provoke/littlethingy.png" alt="Little Thingy"/></p>
<p>Then copy-pasted the path into a PathSvg item in QML:</p>
<div><pre tabindex="0"><code data-lang="js"><span><span><span>path</span><span>:</span> (<span>root</span>.<span>other</span>
</span></span><span><span>	<span>?</span> <span>&#34;m 40,-8 c 4.418278,0 8,3.581722 8,8 v 16 c 0,4.418278 -3.581722,8 -8,8 H 0 C 8.836556,24 16,16.836556 16,8 V 0 c 0,-4.418278 3.581722,-8 8,-8 z&#34;</span>
</span></span><span><span>	<span>:</span> <span>&#34;M 8,-8 C 3.581722,-8 0,-4.418278 0,0 v 16 c 0,4.418278 3.581722,8 8,8 H 48 C 39.163444,24 32,16.836556 32,8 V 0 c 0,-4.418278 -3.581722,-8 -8,-8 z&#34;</span>
</span></span><span><span>)
</span></span></code></pre></div><p>But who cares about that when Telegram has this very cool, swoonworthy emoji-reaction popup!</p>
<video width="100%" controls="">
	<source src="/provoke/telegramreactionpopup.webm" type="video/webm"/>
</video>
<p>That’s Telegram, not my work. Wait, so it has one row of 7 emojis, but then you click the expand button and that row becomes the first row of emojis in a scroll view, following a search box that appears above, also inside the scroll view. Also, the expand button fades away, revealing that the row had 8 emojis the whole time?!?!? What snazziness to live up to. Let me have a go:</p>
<video width="100%" controls="">
	<source src="/provoke/myreactionpopup.webm" type="video/webm"/>
</video>
<p>Wait, did that emoji reaction popup just go <em>outside</em> the window? Be still my beating heart.</p>
<p>So that’s cool. What else is there?</p>
<video width="100%" controls="">
	<source src="/provoke/messageselection.webm" type="video/webm"/>
</video>
<p>Message selection, what a rush!</p>
<h3 id="fancy-animations">Fancy Animations</h3>
<p>The secret to pulling off a fancy synchronised animation without having to set up some complicated animation framework, is to just use a <a href="https://doc.qt.io/qt-6/qml-qtquick-numberanimation.html"><code>NumberAnimation</code></a> and some maths.</p>
<p>I might have a bit of state like <code>property bool expand</code>, and I want stuff to animate whenever <code>expand</code> changes.</p>
<p>Just follow along with my simple step-by-step instructions!</p>
<ol>
<li>
<p>Make another <code>real</code> property with “ness” tacked on the end, and bind it to the state property</p>
<p><code>property real expandness: expand ? 1 : 0</code></p>
</li>
<li>
<p>Make the <code>real</code> number animate whenever it changes:</p>
<p><code>Behavior on expandness { NumberAnimation { duration: 500; easing.type: Easing.InOutQuad } }</code></p>
</li>
<li>
<p>Bind stuff to it:</p>
<ul>
<li><code>opacity: 1 - expandness</code>,</li>
<li><code>height: lerp(0, topSectionContent.height, expandness)</code></li>
<li><code>radius: lerp(barHeight / 2, 5, expandness)</code></li>
<li>etc. etc.</li>
</ul>
</li>
</ol>
<p>Once I figured out those steps, I started using the technique everywhere!</p>
<h3 id="minimise-to-the-system-tray">Minimise to the System Tray</h3>
<video width="100%" controls="">
	<source src="/provoke/systemtray.webm" type="video/webm"/>
</video>
<p>Just in case you didn’t notice, Spectacle is Recording.</p>
<p>“I am glad I downloaded 1.6mb to watch that just then. Why is he expanding and collapsing the side bar again again and again? I thought he already did that in a previous video?”</p>
<p>Look closer!</p>
<video width="100%" controls="">
	<source src="/provoke/systemtraycount.webm" type="video/webm"/>
</video>
<p>This was surprisingly hard to record ‘cause I drew a rectangle around the system tray icon then when I clicked record, the “stop recording” system tray icon appeared and pushed my icon out of view :(</p>
<p>Here’s my first attempt:</p>
<video width="100%" controls="">
	<source src="/provoke/systemtraycountfail.webm" type="video/webm"/>
</video>
<p>Captivating.</p>
<p>At first I was going to use a Rust library to implement the tray icon, then I remembered that Qt actually comes with that functionality. My main concern was the possibility of making the number appear in the icon without it being a huge pain. I was thinking I would have to get some C++ action going to make this work, then after much too long, I realised that <code>QSystemTrayIcon</code> is actually in the QWidgets library so I’d have to pull all that in just to get it working! Then a lightbulb appeared. What if QML has its own version? The answer to that is yes, it’s called <code>SystemTrayIcon</code>, but it’s under <code>Qt.labs.platform</code> which means it’s experimental. Good thing I don’t care about that.</p>
<p>So the trick was to get the number on the icon, like I mentioned before. The <code>icon.source</code> property of <code>SystemTrayIcon</code> takes a URL to an icon. That’s awkward. What am I to do? Create some kind of virtual file system that I can upload new icon pictures to that have the number overlay? Create 100 icons for all the possible counts? Is there some kind of built-in way to get a URL to a custom picture in Qt? That would be pretty fancy.</p>
<p>Turns out Qt is pretty fancy.</p>
<p>It’s actually pretty sweet. Basically what you do is create a normal UI with QML:</p>
<div><pre tabindex="0"><code data-lang="qml"><span><span><span>Image</span> {
</span></span><span><span>	<span>id: trayImageItem</span>
</span></span><span><span>	<span>source:</span> <span>&#34;qrc:/icons/icon_margin.svg&#34;</span>
</span></span><span><span>	<span>width:</span> <span>64</span>
</span></span><span><span>	<span>height:</span> <span>64</span>
</span></span><span><span>
</span></span><span><span>	<span>Rectangle</span> {
</span></span><span><span>		<span>anchors.right:</span> <span>parent</span>.<span>right</span>
</span></span><span><span>		<span>anchors.rightMargin:</span> <span>1</span>
</span></span><span><span>		<span>anchors.bottom:</span> <span>parent</span>.<span>bottom</span>
</span></span><span><span>		<span>anchors.bottomMargin:</span> <span>1</span>
</span></span><span><span>		<span>width:</span> <span>messageCountText</span>.<span>implicitWidth</span> <span>+</span> <span>6</span>
</span></span><span><span>		<span>height:</span> <span>messageCountText</span>.<span>implicitHeight</span>
</span></span><span><span>		<span>color:</span> <span>&#34;#f23c34&#34;</span>
</span></span><span><span>		<span>radius:</span> <span>16</span>
</span></span><span><span>		<span>visible:</span> <span>root</span>.<span>messageCount</span> <span>&gt;</span> <span>0</span>
</span></span><span><span>
</span></span><span><span>		<span>Text</span> {
</span></span><span><span>			<span>id: messageCountText</span>
</span></span><span><span>			<span>x:</span> <span>3</span>
</span></span><span><span>			<span>text:</span> <span>root</span>.<span>messageCount</span> <span>&gt;</span> <span>99</span> <span>?</span> <span>&#34;＋&#34;</span> <span>:</span> <span>root</span>.<span>messageCount</span>
</span></span><span><span>			<span>color:</span> <span>&#34;white&#34;</span>
</span></span><span><span>			<span>opacity:</span> <span>0.9</span>
</span></span><span><span>			<span>font.pixelSize:</span> <span>30</span>
</span></span><span><span>			<span>font.weight:</span> <span>Font</span>.<span>Bold</span>
</span></span><span><span>		}
</span></span><span><span>	}
</span></span><span><span>}
</span></span></code></pre></div><p>Then create a <code>ShaderEffectSource</code>, which captures a new image of the <code>trayImageItem</code> whenever it changes (even if it is invisible, which is very important in this situation):</p>
<div><pre tabindex="0"><code data-lang="qml"><span><span><span>ShaderEffectSource</span> {
</span></span><span><span>	<span>id: trayImageSource</span>
</span></span><span><span>	<span>anchors.fill:</span> <span>trayImageItem</span>
</span></span><span><span>	<span>sourceItem:</span> <span>trayImageItem</span>
</span></span><span><span>	<span>visible:</span> <span>false</span>
</span></span><span><span>	<span>live:</span> <span>true</span>
</span></span><span><span>	<span>hideSource:</span> <span>true</span>
</span></span><span><span>}
</span></span></code></pre></div><p>Then whenever the message count changes, I call <code>updateTrayIcon()</code>:</p>
<div><pre tabindex="0"><code data-lang="js"><span><span><span>function</span> <span>updateTrayIcon</span>() {
</span></span><span><span>	<span>trayImageSource</span>.<span>grabToImage</span>(<span>result</span> =&gt; {
</span></span><span><span>		<span>trayIcon</span>.<span>icon</span>.<span>source</span> <span>=</span> <span>result</span>.<span>url</span>
</span></span><span><span>	})
</span></span><span><span>}
</span></span></code></pre></div><p><code>result.url</code> looks something like <code>itemgrabber:#1</code>, so basically Qt implements exactly that crazy idea I described above. Neat.</p>
<p>The system tray task convinced me to finally make an icon:</p>
<p><img src="https://kemble.net/ProvokeIcon.png" alt="Provoke Icon"/></p>
<p>I didn’t want a speech bubble, it’s already been done, and I wouldn’t want this app to be mistaken for any app that’s already on the market. I was thinking of a horn or something, but it needed to kinda fill the space so I went for a megaphone look. It also kinda looks like an axe, which goes well with the name Provoke I guess.</p>
<h2 id="alright-time-for-some-c">Alright, time for some C++</h2>
<p>I haven’t written any C++ in years. It still lives on in my brain though, in the “things that are extremely complicated and over-engineered, but actually kind of awesome” section.</p>
<p>I do not want to make my build much more complicated to make this work, or add more complexity than it deserves. I just want to be able to access some stuff in Qt that isn’t exposed to Rust or QML yet, without it being a pain to work with.</p>
<p>After some research I decided the best way to go about that would be to just use Qt properly the way it was intended, but keep it slim. Following was much experimentation then a chosen solution:</p>
<ul>
<li>Make a folder called “cpp”</li>
<li>Put a CMakeLists.txt file in it, and a cpp/hpp pair</li>
</ul>
<div><pre tabindex="0"><code data-lang="cmake"><span><span>cmake_minimum_required(<span>VERSION</span> <span>3.16</span>)<span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span>project(<span>provokecpp</span> <span>LANGUAGES</span> <span>CXX</span>)<span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span>set(<span>CMAKE_CXX_STANDARD</span> <span>17</span>)<span>
</span></span></span><span><span><span></span>set(<span>CMAKE_CXX_STANDARD_REQUIRED</span> <span>ON</span>)<span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span>set(<span>CMAKE_AUTOMOC</span> <span>ON</span>)<span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span>find_package(<span>Qt6</span> <span>COMPONENTS</span> <span>Core</span> <span>Gui</span> <span>Qml</span> <span>REQUIRED</span>)<span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span>qt_add_library(<span>provokecpp</span> <span>STATIC</span>
</span></span><span><span>	<span>provokecpp.cpp</span>
</span></span><span><span>	<span>provokecpp.hpp</span>
</span></span><span><span>)<span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span>target_link_libraries(<span>provokecpp</span>
</span></span><span><span>	<span>Qt6::Core</span>
</span></span><span><span>	<span>Qt6::Gui</span>
</span></span><span><span>	<span>Qt6::Qml</span>
</span></span><span><span>)<span>
</span></span></span></code></pre></div><ul>
<li>Write some QObjects the old-fashioned way, then <code>extern &#34;C&#34;</code> a function which registers stuff with QML.</li>
</ul>
<div><pre tabindex="0"><code data-lang="c++"><span><span>QObject<span>*</span> <span>provoke_tools_singleton_provider</span>(QQmlEngine<span>*</span> engine, QJSEngine<span>*</span> jsEngine) {
</span></span><span><span>	<span>return</span> <span>new</span> ProvokeTools();
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span><span>extern</span> <span>&#34;C&#34;</span> <span>void</span> register_provoke_qml_types() {
</span></span><span><span>	qmlRegisterSingletonType<span>&lt;</span>ProvokeTools<span>&gt;</span>(<span>&#34;provoke&#34;</span>, <span>1</span>, <span>0</span>, <span>&#34;ProvokeTools&#34;</span>, provoke_tools_singleton_provider);
</span></span><span><span>	<span>// This sounds like it would solve that problem that I had with my Splitter!
</span></span></span><span><span><span></span>	qmlRegisterType<span>&lt;</span>OverrideMouseCursor<span>&gt;</span>(<span>&#34;provoke&#34;</span>, <span>1</span>, <span>0</span>, <span>&#34;OverrideMouseCursor&#34;</span>);
</span></span><span><span>}
</span></span></code></pre></div><ul>
<li>“You keep talking about Rust, but mostly you’ve just written QML and C++, I feel ripped off” - Fair enough, but I intend to use Rust for the “model” layer and any custom UI elements and logic that call for native code. That stuff just hasn’t really come up yet.</li>
<li>Add a <code>build.rs</code> file and use the <code>cmake</code> crate to build the “cpp” folder. I find this part quite cool, as you don’t even see it running the C++ compiler when you do <code>cargo run</code> and all the build stuff happens in the <code>target</code> folder with everything else. It even caches the result and only re-runs the C++ build if a dependency changes:</li>
</ul>
<div><pre tabindex="0"><code data-lang="rust"><span><span><span>fn</span> <span>main</span>() {
</span></span><span><span>	<span>let</span> dest <span>=</span> cmake::Config::new(<span>&#34;cpp&#34;</span>)
</span></span><span><span>		.build_target(<span>&#34;all&#34;</span>)
</span></span><span><span>		.build();
</span></span><span><span>
</span></span><span><span>	println!(<span>&#34;cargo::rerun-if-changed=cpp/CMakeLists.txt&#34;</span>);
</span></span><span><span>	println!(<span>&#34;cargo::rerun-if-changed=cpp/provokecpp.cpp&#34;</span>);
</span></span><span><span>	println!(<span>&#34;cargo::rerun-if-changed=cpp/provokecpp.hpp&#34;</span>);
</span></span><span><span>	
</span></span><span><span>	println!(<span>&#34;cargo::rustc-link-search=native=</span><span>{}</span><span>/build&#34;</span>, dest.display());
</span></span><span><span>	println!(<span>&#34;cargo::rustc-link-lib=static=provokecpp&#34;</span>);
</span></span><span><span>}
</span></span></code></pre></div><ul>
<li>From Rust, import the symbol and call it on startup:</li>
</ul>
<div><pre tabindex="0"><code data-lang="rust"><span><span><span>unsafe</span> <span>extern</span> <span>&#34;C&#34;</span> {
</span></span><span><span>	<span>unsafe</span> <span>fn</span> <span>register_provoke_qml_types</span>();
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span><span>..</span>
</span></span><span><span>
</span></span><span><span>register_provoke_qml_types();
</span></span></code></pre></div><p>This isn’t exactly innovative, but there were lots of ways to go about solving this problem. It’s a nice setup, and I can forget it’s even there. It builds pretty much instantly (for now). I can even export more <code>extern &#34;C&#34;</code> functions as needed.</p>
<h2 id="and-then-i-wrote-the-important-news-alert-that-you-just-finished-reading">And then I wrote the important news alert that you just finished reading</h2>
<p>Here we are.</p>
<p><img src="https://kemble.net/provoke/sofar.png" alt="So Far"/></p>
<p>I Can’t Believe It’s Not Telegram.</p>
<p>I keep mistaking it for the real Telegram so I think the illusion is working.</p>
<p><a href="https://github.com/yokljo/provoke">Here’s the repo</a></p>
<p><img src="https://kemble.net/provoke/languages.png" alt="Languages"/></p>
<p>Other is my favourite language, I’m surprised I didn’t use it more.</p>
<p>Will he keep working on it? Will it grow to become the worlds most popular messenger app due to its superior user experience? Will he even keep working on it after this? Will he go back to working on that game engine? Or that sewing pattern CAD idea? Will there ever be another blog post on this website?</p>
<p>Find out on the next episode of App Dev By That Guy!</p>

    </div>
    
  </article>

    </div></div>
  </body>
</html>
