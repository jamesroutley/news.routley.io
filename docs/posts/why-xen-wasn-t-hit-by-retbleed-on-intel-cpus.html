<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://xcp-ng.org/blog/2022/08/26/why-xen-wasnt-hit-by-retbleed-on-intel-cpus/">Original</a>
    <h1>Why Xen Wasn&#39;t Hit by RETBleed on Intel CPUs</h1>
    
    <div id="readability-page-1" class="page"><div>
              
              <p>You probably heard about RETBleed security issue. Almost all operating systems had to release patches regarding this new hardware vulnerability. See our previous blog post about it:</p><figure><a href="https://xcp-ng.org/blog/2022/07/15/retbleed-security-patch/"><div><p>RETBleed security patch</p><p>RETBleed vulnerability is here! Fear not, there‚Äôs a patch available for XCP-ng.</p><p><img src="https://xcp-ng.org/blog/content/images/size/w256h256/2021/03/mainlogo.png" alt=""/><span>Olivier Lambert</span></p></div><p><img src="https://xcp-ng.org/blog/content/images/2022/07/retbleed.jpg" alt=""/></p></a></figure><p>But why Xen did release a fix only for AMD CPUs while Intel seems to be also hit? The answer is very interesting and another proof that Xen Project is taking security VERY seriously.</p><h2 id="security-is-hard">Security is hard</h2><p>For example, on Linux kernel, both Intel and AMD CPUs were impacted, as you can read here: <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-29900">CVE-2022-29900</a> (AMD) and <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-29901">CVE-2022-29901</a> (Intel).</p><p>In the <a href="https://xenbits.xen.org/xsa/advisory-407.html">Xen security bulletin</a>, only <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-29900">CVE-2022-29900</a> was fixed. What about <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-29901">CVE-2022-29901</a> on Intel side?</p><p>RETBleed on Intel isn&#39;t in fact a new hardware issue. It&#39;s a consequence of choices made by some OSes 4 years ago (including Linux), when Spectre-like speculation issues started to be known. To understand a bit more about it, we need first to talk about the first mitigation to those speculation issues: retpoline. They were introduced in 2018, as one possible mitigation against Spectre v2 speculative execution attacks.</p><figure><img src="https://xcp-ng.org/blog/content/images/2022/07/NewTux.svg.png" alt="" loading="lazy" width="208" height="250"/></figure><h3 id="retpoline-concept">Retpoline concept</h3><p>To mitigate speculation/side-channel issues, there&#39;s mainly 2 options:</p><ul><li>direct manipulation on the hardware level (requiring CPU microcode updates)</li><li>rewrite software such that it doesn&#39;t use the problematic predictor.</li></ul><p>So in the end, retpoline is primarily a software construct where specific knowledge on the hardware is needed to mitigate branch target injection.</p><figure><img src="https://xcp-ng.org/blog/content/images/2022/07/retpoline.png" alt="" loading="lazy" width="529" height="284"/><figcaption>Retpoline concept, from Intel documentation</figcaption></figure><p><strong>Are retpolines enough to stop speculative executions attack? Well, it&#39;s not, and RETBleed is the living proof of it</strong>. Despite some public warning inside the<a href="https://lkml.org/lkml/2018/1/22/598"> Linux project (4 years ago)</a> about the insufficient capability of retpolines to protect against those attacks in some configurations, and even suggesting other solutions to fix it (see below), it was decided to left it &#34;as is&#34;.</p><p>Mostly because people didn&#39;t believe that it was possible to exploit the retpoline limitations versus the performance penalty to mitigate them. As we seen, it was more a belief than a true statement, which is sadly common regarding security in general.</p><p>So is there other solutions to protect against these attacks? Yes, using IBRS!</p><h3 id="ibrs-to-the-rescue">IBRS to the rescue</h3><p>So when retpolines aren&#39;t safe, there is indeed another possibility to protect yourself from speculation attacks: using IBRS. Another acronym, yay! IBRS means &#34;Indirect Branch Restricted Speculation&#34;. This is an Intel CPU specific feature, restricting speculation of indirect branches, and therefore protecting indirect branch predictions.</p><p>So why not using it for everything? Well, there&#39;s multiple reasons:</p><ul><li>it&#39;s a kind of &#34;retrofit&#34; added in the microcode, not originally a native/hardware mitigation (in Skylake CPUs): it is very SLOW compared to retpoline üêå</li><li>it&#39;s harder to implement than just doing retpolines from the hypervisor or operating system perspective üë∑</li></ul><p>That&#39;s likely why other projects/OSes decided to not use it‚Ä¶ until RETBleed!</p><div><p>üí°</p><p><strong>eIBRS</strong>: since IBRS was very slow and a kind of a &#34;hack&#34;, Intel added Enhanced IBRS (eIBRS) since Cascade Lake generation: you can see it as the &#34;hardware implementation&#34; of IBRS, which was microcode only. Skylake and previous generations are doomed to be slow and to rely only on IBRS to be &#34;safe&#34;.</p></div><p>If you want to read more about IBRS and eIBRS, you can directly <a href="https://www.intel.com/content/www/us/en/developer/articles/technical/software-security-guidance/technical-documentation/indirect-branch-restricted-speculation.html">read the Intel official documentation</a>.</p><h2 id="xen-project-and-security">Xen Project and security</h2><p>However, security is a top priority for Xen: that&#39;s why the open source project didn&#39;t left the hypervisor with incomplete mitigations for 4 years, and decided instead to use IBRS when it was crucial despite the performance hit for the affected CPUs.</p><figure><img src="https://xcp-ng.org/blog/content/images/2022/07/xenprojectlogoclean-1.png" alt="" loading="lazy" width="361" height="150"/></figure><p>The approach in Xen was to virtualize and expose <code>MSR_SPEC_CTRL</code> to the guest operating system. This way, even Windows system could rely on their own code to call IBRS when needed (which is the case). That&#39;s why IBRS was exposed to guests back in 2018 (<a href="https://xenbits.xen.org/xsa/advisory-263.html">XSA 263</a>).</p><p>All of this explains why the latest <a href="https://xenbits.xen.org/xsa/advisory-407.html">Xen Security Advisory (XSA) 407</a> was only about AMD:</p><blockquote>On Intel CPUs, Retbleed is not a new vulnerability; it is only applicable to software which did not follow Intel&#39;s original Spectre-v2 guidance.</blockquote><p>This is a great demonstration that <strong>Xen Project is taking security very seriously</strong>, as we also do here for XCP-ng. By the way, if you are still not convinced, you can have a read on <a href="https://xenproject.org/users/security/">https://xenproject.org/users/security</a>.</p><p>Frankly, Xen is probably the best Open Source project I know in terms of taking security seriously. If you are interested to learn more about how Xen Project is working on deep security issues, <a href="https://xcp-ng.org/forum">let us know</a>, we&#39;ll be happy to go deeper and even get some Xen core developers interviews!</p>
                <section>
                  
                  <ul>
                      <li>
                        <a href="https://xcp-ng.org/blog/tag/security/" title="Security">Security</a>
                      </li>
                      <li>
                        <a href="https://xcp-ng.org/blog/tag/news/" title="News">News</a>
                      </li>
                  </ul>
                </section>
            </div></div>
  </body>
</html>
