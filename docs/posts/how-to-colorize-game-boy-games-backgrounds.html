<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://toruzz.com/blog/how-to-colorize-gb-games-04/">Original</a>
    <h1>How to colorize Game Boy games – Backgrounds</h1>
    
    <div id="readability-page-1" class="page"><div id="__blog-post-container" itemprop="articleBody">
<p><img decoding="async" loading="lazy" alt="Hero image" src="https://toruzz.com/assets/images/howtocolorize-cover-9a06fbdacaba131ea64038654c8dce2c.png" width="1120" height="500"/></p>
<p>With <a href="https://toruzz.com/blog/how-to-colorize-gb-games-03">our sprites now beautifully colorized</a>, it&#39;s finally time to focus on what will make our colorization really shine — backgrounds. In this entry, we&#39;ll try to get the backgrounds as close to the final look as possible.</p>
<h2 id="planning-our-approach">Planning our approach<a href="#planning-our-approach" aria-label="Direct link to Planning our approach" title="Direct link to Planning our approach">​</a></h2>
<p>At first glance, it may seem that coloring the backgrounds is as simple as <a href="https://gbdev.io/pandocs/Tile_Maps.html#bg-map-attributes-cgb-mode-only" target="_blank" rel="noopener noreferrer">applying the attributes we want to the BG Map</a>. While technically correct, achieving great results usually demands additional work, such as editing graphics, adding new ones, and adjusting level layouts.</p>
<p>Unfortunately, what we learn in this lesson won&#39;t be universally applicable, since the best strategy for applying BG attributes depends heavily on the type of game we are colorizing, the original code, and the desired result. For instance, a static puzzle game may not require intercepting the background printing routine, while action games most likely will.</p>
<p>That said, the general process remains clear: locate the background data and understand how it&#39;s rendered on the screen, then adapt or introduce new code to incorporate the desired attributes into the BG Map.</p>
<p>In our case, we&#39;ll take a straightforward approach: locate the routine responsible for printing the background to the screen, duplicate it, and adjust it to add our BG attributes. Keep in mind that this might not always be the most efficient way to do it (although we can always enable <a href="https://gbdev.io/pandocs/CGB_Registers.html#ff4d--key1-cgb-mode-only-prepare-speed-switch" target="_blank" rel="noopener noreferrer">double speed mode</a>).</p>
<h2 id="locating-the-background-printing-routine">Locating the Background Printing Routine<a href="#locating-the-background-printing-routine" aria-label="Direct link to Locating the Background Printing Routine" title="Direct link to Locating the Background Printing Routine">​</a></h2>
<p>To find our routine, we&#39;ll set a write breakpoint where a new column or line will start to be drawn as we move. In this case, that would be <code>$9816</code>. After some analysis, we&#39;ll identify the desired routine located at <code>$1EEB-$1F06</code>:</p>
<div><p>./references/kirby.asm @ $1EEB</p><div><pre tabindex="0"><code><span><span> </span><span>PrintBG:</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>bc</span><span>,</span><span>$CB00</span><span>	</span><span></span><br/></span><span><span>  </span><span>@Loop:</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span>	</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>h</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>and</span><span> </span><span>a</span><span></span><br/></span><span><span>	</span><span>ret</span><span> </span><span>z</span><span>		</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span>	</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>l</span><span>,</span><span>a</span><span></span><br/></span><span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>ldi</span><span> </span><span>(</span><span>hl</span><span>)</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>(</span><span>hl</span><span>)</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>de</span><span>,</span><span>$001F</span><span>	</span><span></span><br/></span><span><span>	</span><span>add</span><span> </span><span>hl</span><span>,</span><span>de</span><span></span><br/></span><span><span>	</span><span>ldi</span><span> </span><span>(</span><span>hl</span><span>)</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>(</span><span>hl</span><span>)</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>jr</span><span> </span><span>@Loop</span><br/></span></code></pre></div></div>
<p>This can be very different from game to game, but the process is always the same: set a breakpoint and trace the code until we find the routine we want.</p>
<h2 id="adding-custom-attributes">Adding custom attributes<a href="#adding-custom-attributes" aria-label="Direct link to Adding custom attributes" title="Direct link to Adding custom attributes">​</a></h2>
<p>Looking at the code above, we notice that the data is already stored at <code>$CB00</code> sequentially. The first two bytes point to the BG Map destination, while the following bytes represent the tile data (2x2 tile blocks). We&#39;ll replicate this process, but instead of just copying the data, we&#39;ll fetch values from a BG Map attributes table previously stored in RAM.</p>
<p>For this, the tile value serves as the low byte, and a fixed value (<code>&gt;ATTR_MAP</code>) as the high byte. Take a close look at this code:</p>
<div><p>./backgrounds.asm</p><div><pre tabindex="0"><code><span><span>.BANK</span><span> </span><span>0</span><span> </span><span>SLOT</span><span> </span><span>0</span><span></span><br/></span><span><span></span><span>.ORG</span><span> </span><span>$1EEB</span><span></span><br/></span><span><span></span><span>.SECTION</span><span> </span><span>&#34;Background printing routine Hook&#34;</span><span> </span><span>OVERWRITE</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>bc</span><span>,</span><span>$CB00</span><span>	</span><span></span><br/></span><span><span>	</span><span>jp</span><span> </span><span>PrintBG</span><span></span><br/></span><span><span></span><span>.ENDS</span><span></span><br/></span><span><span></span><span>.SECTION</span><span> </span><span>&#34;Background printing routine&#34;</span><span> </span><span>FREE</span><span></span><br/></span><span><span> </span><span>PrintBG:</span><span></span><br/></span><span><span>	</span><span>@Loop:</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span>	</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>h</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>and</span><span> </span><span>a</span><span></span><br/></span><span><span>	</span><span>jr</span><span> </span><span>z</span><span>,</span><span>PrintBGAttributes</span><span></span><br/></span><span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span>	</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>l</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>ldi</span><span> </span><span>(</span><span>hl</span><span>)</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>(</span><span>hl</span><span>)</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>de</span><span>,</span><span>$001F</span><span>	</span><span></span><br/></span><span><span>	</span><span>add</span><span> </span><span>hl</span><span>,</span><span>de</span><span></span><br/></span><span><span>	</span><span>ldi</span><span> </span><span>(</span><span>hl</span><span>)</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>(</span><span>hl</span><span>)</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>jr</span><span> </span><span>@Loop</span><span></span><br/></span><span><span></span><br/></span><span><span> </span><span>PrintBGAttributes:</span><span></span><br/></span><span><span>	SETVRAM </span><span>1</span><span>	</span><br/></span><span><span>	</span><span>ld</span><span> </span><span>bc</span><span>,</span><span>$CB00</span><span></span><br/></span><span><span></span><br/></span><span><span>	</span><span>@Loop:</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span>	</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>h</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>and</span><span> </span><span>a</span><span></span><br/></span><span><span>	</span><span>jr</span><span> </span><span>z</span><span>,</span><span>@Exit</span><span></span><br/></span><span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span>	</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>l</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>call</span><span> </span><span>GetAttr</span><span></span><br/></span><span><span>	</span><span>ldi</span><span> </span><span>(</span><span>hl</span><span>)</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>call</span><span> </span><span>GetAttr</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>(</span><span>hl</span><span>)</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>de</span><span>,</span><span>$001F</span><span>	</span><span></span><br/></span><span><span>	</span><span>add</span><span> </span><span>hl</span><span>,</span><span>de</span><span></span><br/></span><span><span>	</span><span>call</span><span> </span><span>GetAttr</span><span></span><br/></span><span><span>	</span><span>ldi</span><span> </span><span>(</span><span>hl</span><span>)</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span></span><br/></span><span><span>	</span><span>inc</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>call</span><span> </span><span>GetAttr</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>(</span><span>hl</span><span>)</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>jr</span><span> </span><span>@Loop</span><span></span><br/></span><span><span></span><br/></span><span><span>	</span><span>@Exit:</span><span></span><br/></span><span><span>	SETVRAM </span><span>0</span><span></span><br/></span><span><span>	</span><span>ret</span><span></span><br/></span><span><span></span><br/></span><span><span> </span><span>GetAttr:</span><span></span><br/></span><span><span>	</span><span>push</span><span> </span><span>bc</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>b</span><span>,</span><span>&gt;ATTR_MAP</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>c</span><span>,</span><span>a</span><span></span><br/></span><span><span>	</span><span>ld</span><span> </span><span>a</span><span>,</span><span>(</span><span>bc</span><span>)</span><span></span><br/></span><span><span>	</span><span>pop</span><span> </span><span>bc</span><span></span><br/></span><span><span></span><br/></span><span><span>	</span><span>push</span><span> </span><span>af</span><span></span><br/></span><span><span>	WAITBLANK</span><br/></span><span><span>	</span><span>pop</span><span> </span><span>af</span><span></span><br/></span><span><span>	</span><span>ret</span><span></span><br/></span><span><span></span><span>.ENDS</span><br/></span></code></pre></div></div>
<p>To insert this code into our ROM, we&#39;ll only need a couple of things: to define the macro <code>SETVRAM</code>, which you can find in the <a href="https://github.com/toruzz/WebsiteHowtoCode/blob/main/03/macros.asm" target="_blank" rel="noopener noreferrer">previous code</a>, and define <code>ATTR_MAP</code> as an empty region in RAM (for example, <code>$D800</code>).</p>
<p>If we do it and run the game, we&#39;ll see... nothing new, actually. This is because we haven&#39;t populated <code>ATTR_MAP</code> yet. To see some changes, we can go to <code>$D800</code> (or the chosen address) in our debugger and write some values. The result should resemble this:</p>
<p><img decoding="async" loading="lazy" alt="Kirby&amp;#39;s BG with random attributes" src="https://toruzz.com/assets/images/kirby-bg-001-4313046b89a0987cfd6d189b4f225cbc.png" width="1113" height="807"/></p>
<p>Look at that! Of course, we&#39;ll need to populate that table at various points in the game depending on how complex we want our colorization to be.</p>
<p>For now, we can just initialize the table with some values and see how it looks in the game.</p>
<p><img decoding="async" loading="lazy" alt="Kirby&amp;#39;s BG with selected attributes" src="https://toruzz.com/assets/images/kirby-bg-002-0ce7e0cfd8b4c145b68100c5c4b8cd9d.png" width="1113" height="807"/></p>
<p>Everything seems to be looking good, but there&#39;s still some work to be done.</p>
<h2 id="editing-the-graphics-and-levels">Editing the graphics and levels<a href="#editing-the-graphics-and-levels" aria-label="Direct link to Editing the graphics and levels" title="Direct link to Editing the graphics and levels">​</a></h2>
<p>Regarding graphics editing there is not much to comment on, but it&#39;s very likely we&#39;ll have to do it to make them look good with the new palettes. That&#39;s right — I strongly recommend adapting the graphics to the new palettes and not the other way around, otherwise you will surely struggle to reuse them later on.</p>
<p>In our particular case, graphics need recompression and some pointers need to be updated, but as it&#39;s already been mentioned that&#39;s beyond the scope of this tutorial. For those interested, you can check the source code below.</p>
<p>With our graphics edited, backgrounds should look like this:</p>
<p><img decoding="async" loading="lazy" alt="Kirby&amp;#39;s BG with selected attributes and edited graphics" src="https://toruzz.com/assets/images/kirby-bg-003-0b4b56a850af1a95beae87a8888b5dd4.png" width="1113" height="807"/></p>
<p>Of course, in the original game, the sky is no different from the inside of a cloud or mountain (as they share the same tiles), the corners of the stone poles can have the wrong background color, etc. so we&#39;ll have to change either the printed tiles or attributes in these areas.</p>
<p>There are different ways to go about it, but I still recommend following our strategy of maintaining a 1:1 relation between tiles and attributes, editing the level layout a bit to have a unique cloud tile, mountain tile, and so on. Don&#39;t worry about VRAM space; by assigning appropriate attributes to tiles normally used by sprites, we can utilize custom graphics loaded in <code>VRAM1</code>.</p>
<p>While each game will require investigation into how this is done, a common practice for storing level map is to have consecutive level blocks (2x2 tiles) that compose the level map. This is how Kirby&#39;s Dream Land does it, just with the data being compressed.</p>
<p>So in our case we&#39;ll have to decompress the data, edit it, compress it again, insert it somewhere and change the pointers to it.</p>
<p><img decoding="async" loading="lazy" alt="Kirby&amp;#39;s BG finished" src="https://toruzz.com/assets/images/kirby-bg-004-16ab618b34a024d001089bec6f300315.png" width="1113" height="807"/></p>
<p>And that&#39;s it! We&#39;ll deal with the HUD later, but as you can see now we have a much closer-to-final look.</p>
<p>As you might have noticed, some of the steps in this entry are very game specific so I didn&#39;t go into much detail about how to do them. Still, I hope this gives you a good idea of what to do and why it&#39;s important to edit a bit more than just the attributes. If you&#39;re interested in the specifics of Kirby&#39;s Dream Land, you can check the source code below.</p>
<p>In the next entry, we&#39;ll take a look at how to implement some effects like fade-ins and fade-outs.</p>
<p><a href="https://github.com/toruzz/WebsiteHowtoCode/tree/main/04" target="_blank" rel="noopener noreferrer">Check out the code so far in GitHub<span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8.5 8.5" style="enable-background:new 0 0 8.5 8.5" xml:space="preserve"><path fill="currentColor" d="M6.8.7h-5v1H6L.5 7.2l.8.8 5.5-5.5v4.2h1v-6z"></path></svg></span></a></p></div></div>
  </body>
</html>
