<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://undeadly.org/cgi?action=article;sid=20240607042157">Original</a>
    <h1>OpenSSH introduces options to penalize undesirable behavior</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>Contributed by
<a href="http://bsdly.blogspot.com/">Peter N. M. Hansteen</a>
on <time datetime="2024-06-06T17:54:01Z">2024-06-06</time>
from the sshd to carry a big stick dept.</p><p>
In a recent <a href="https://marc.info/?l=openbsd-cvs&amp;m=171769392207688&amp;w=2">commit</a>, Damien Miller (<code>djm@</code>) introduced the new <a href="https://man.openbsd.org/sshd">sshd(8)</a> configurations options, <code><a href="https://man.openbsd.org/sshd_config.5#PerSourcePenalties">PerSourcePenalties</a></code> and <code><a href="https://man.openbsd.org/sshd_config.5#PerSourcePenaltyExemptList">PerSourcePenaltyExemptList</a></code>, to provide a built in facility in <a href="https://man.openbsd.org/sshd">sshd(8)</a> itself to penalize undesirable behavior, and to shield specific clients from penalty, respectively. 
</p><p>
The commit message reads,
</p><blockquote><pre>List:       openbsd-cvs
Subject:    CVS: cvs.openbsd.org: src
From:       Damien Miller &lt;djm () cvs ! openbsd ! org&gt;
Date:       2024-06-06 17:15:26

CVSROOT:	/cvs
Module name:	src
Changes by:	djm@cvs.openbsd.org	2024/06/06 11:15:26

Modified files:
	usr.bin/ssh    : misc.c misc.h monitor.c monitor_wrap.c 
	                 servconf.c servconf.h srclimit.c srclimit.h 
	                 sshd-session.c sshd.c sshd_config.5 

Log message:
Add a facility to <a href="https://man.openbsd.org/sshd">sshd(8)</a> to penalise particular problematic client
behaviours, controlled by two new <a href="https://man.openbsd.org/sshd_config">sshd_config(5)</a> options:
<a href="https://man.openbsd.org/sshd_config#PerSourcePenalties">PerSourcePenalties</a> and <a href="https://man.openbsd.org/sshd_config#PerSourcePenaltyExemptList">PerSourcePenaltyExemptList</a>.
</pre></blockquote>

<blockquote><pre>When PerSourcePenalties are enabled, <a href="https://man.openbsd.org/sshd">sshd(8)</a> will monitor the exit
status of its child pre-auth session processes. Through the exit
status, it can observe situations where the session did not
authenticate as expected. These conditions include when the client
repeatedly attempted authentication unsucessfully (possibly indicating
an attack against one or more accounts, <abbr>e.g.</abbr> password guessing), or
when client behaviour caused sshd to crash (possibly indicating
attempts to exploit sshd).

When such a condition is observed, sshd will record a penalty of some
duration (<abbr>e.g.</abbr> 30 seconds) against the client&#39;s address. If this time
is above a minimum threshold specified by the PerSourcePenalties, then
connections from the client address will be refused (along with any
others in the same <a href="https://man.openbsd.org/sshd_config.5#PerSourceNetBlockSize">PerSourceNetBlockSize</a> <abbr>CIDR</abbr> range).

Repeated offenses by the same client address will accrue greater
penalties, up to a configurable maximum. A <a href="https://man.openbsd.org/sshd_config.5#PerSourcePenaltyExemptList">PerSourcePenaltyExemptList</a>
option allows certain address ranges to be exempt from all penalties.

We hope these options will make it significantly more difficult for
attackers to find accounts with weak/guessable passwords or exploit
bugs in sshd(8) itself.

PerSourcePenalties is off by default, but we expect to enable it
automatically in the near future.

much feedback markus@ and others, ok markus@
</pre></blockquote><p>
This new facility comes in addition to the already well known and loved  <a href="https://man.openbsd.org/pf.conf#Stateful_Tracking_Options"><code>pf.conf</code> <em>state tracking options</em></a>, and is for now available only in <a href="https://www.openbsd.org/">OpenBSD</a>-<code>current</code>, but is almost certainly to be available in the upcoming OpenBSD <em>7.6</em> release.
</p><p>
At first we were wondering whether these options would be enabled by default before the new release. We did not have to wait long. This <a href="https://marc.info/?l=openbsd-cvs&amp;m=171770534714766&amp;w=2">subsequent commit</a> settled the issue:
</p><blockquote><pre>List:       openbsd-cvs
Subject:    CVS: cvs.openbsd.org: src
From:       Damien Miller &lt;djm () cvs ! openbsd ! org&gt;
Date:       2024-06-06 20:25:48

CVSROOT:	/cvs
Module name:	src
Changes by:	djm@cvs.openbsd.org	2024/06/06 14:25:48

Modified files:
	usr.bin/ssh    : servconf.c 

Log message:
enable PerSourcePenalties by default.

ok markus

<abbr>NB.</abbr> if you run a sshd that accepts connections from behind large NAT
blocks, proxies or anything else that aggregates many possible users
behind few <abbr>IP</abbr> addresses, then this change may cause legitimate traffic
to be denied.

Please read the PerSourcePenalties, PerSourcePenaltyExemptList and
PerSourceNetBlockSize options in sshd_config(5) for how to tune your
sshd(8) for your specific circumstances.
</pre></blockquote><p>
So now we know: starting with OpenBSD 7.6, <code>PerSourcePenalties</code> will be enabled by default, and admins who do not themselves run <abbr>PF</abbr> or other network translation mechanisms will need to keep the consequences of inconsiderate <abbr>NAT</abbr> use in mind.
</p></div></div>
  </body>
</html>
