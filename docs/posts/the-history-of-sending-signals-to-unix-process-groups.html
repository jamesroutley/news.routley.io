<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/ProcessGroupsAndSignals">Original</a>
    <h1>The history of sending signals to Unix process groups</h1>
    
    <div id="readability-page-1" class="page"><div><h2>The history of sending signals to Unix process groups</h2>

	<p><small>September  5, 2022</small></p>
</div><div><p>All (Unix) processes are members of some <a href="https://en.wikipedia.org/wiki/Process_group"><em>process group</em></a>. Process groups go
very far back in Unix; they&#39;re present at least as far back as
Fourth Edition (V4) Unix. However, they aren&#39;t really &#34;process
groups&#34; in the modern sense, as we can see from the relevant <code>proc</code>
struct field being called <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=V4/nsys/proc.h"><code>p_ttyp</code></a>.
Instead they were used primarily to send signals to your terminal
processes when various things happened (see <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=V4/nsys/dmr/tty.c">dmr/tty.c</a>
and <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=V4/nsys/dmr/dc.c">dmr/dc.c</a>),
and the &#39;process group number&#39; was the address of the <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=V4/nsys/tty.h">&#39;<code>struct
tty</code>&#39;</a>
for your terminal.</p>

<p>In V7, <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=V7/usr/sys/h/proc.h">h/proc.h</a> changed
the <code>p_ttyp</code> field to <code>p_pgrp</code> and now called it the &#39;process
group leader&#39;. However, there&#39;s (still) no way to send a signal to
a process group from user code, although various tools know about
the idea of process groups and will report them to user level (for
example <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=V7/usr/man/man1/pstat.1m">pstat.1m</a>,
which gets this information in the traditional Unix approach of
reading kernel memory, per <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=V7/usr/src/cmd/pstat.c">cmd/pstat.c</a>).
V7 is also where the &#39;process group&#39; number becomes the process ID of
the first process to open a (serial) tty after it&#39;s been closed.</p>

<p>(The V6 ps is aware of <code>p_ttyp</code> and uses it to report the controlling
terminal, but I don&#39;t think it prints it. In any case the specific value
of the &#39;process group&#39; in V6 isn&#39;t very meaningful, since it&#39;s still the
address of a kernel structure instead of the PID of the process group
leader.)</p>

<p>The inability to send signals to process groups changed, apparently
independently, in System III and 4BSD. In System III, <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=SysIII/usr/src/man/man2/kill.2">kill(2)</a>
documents the modern approach of sending a signal to the a process
group by using a negative &#39;PID&#39; in the <code>kill(2)</code> system call. System
III also has an explicit <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=SysIII/usr/src/man/man2/getpid.2"><code>getpgrp(2)</code></a>
system call and supports <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=SysIII/usr/src/man/man2/setpgrp.2"><code>setpgrp(2)</code></a>.
According to <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=SysIII/usr/src/man/man2/intro.2">intro.2</a>,
System III claims to differentiate between the &#39;process group&#39; and
the &#39;tty group&#39;; however, <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=SysIII/usr/include/sys/proc.h">proc.h</a>
only has the V7 <code>p_pgrp</code>, and the code to do things like handle
control-C (in <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=SysIII/usr/src/uts/vax/io/tt0.c">tt0.c</a>)
uses <code>p_pgrp</code> (via <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=SysIII/usr/src/uts/vax/os/sig.c"><code>signal()</code> in sig.c</a>).
I don&#39;t know enough to say why System III decided to let process
groups change and be exposed explicitly.</p>

<p>In 4BSD the reason for a change is much simpler, because 4BSD
introduced <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/JobControlAndTTYs"><em>job control</em></a>. Job control
intrinsically involves multiple process groups, which requires
exposing them to user level code and providing user level code ways
to send signals to entire process groups. As I mentioned in
<a href="https://utcc.utoronto.ca/~cks/space/blog/unix/KillBySignalNameOrigin">yesterday&#39;s entry</a>, 4BSD implements the
ability to signal process groups in a different way from System
III. Although 4BSD has a separate <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=4BSD/usr/man/man2/killpg.2j"><code>killpg(2j)</code></a>
function that calls itself a system call, the actual implementation
uses the <code>kill(2)</code> system call with the signal number negated instead
of the process ID (see the code for kill() in <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=4BSD/usr/src/sys/sys/sys4.c">sys4.c</a>,
and also <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=4BSD/usr/src/lib/libjobs/killpg.s">killpg.s</a>).
By 4.1c BSD there&#39;s an actual <code>killpg()</code> system call, although
<a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=4.1cBSD/a/sys/sys/kern_sig.c">kern_sig.c</a>
calls it temporary. Only in 4.3 BSD does the behavior of negative
PIDs appear in <code>kill(2)</code>, and even then <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=4.3BSD/usr/man/man2/kill.2">kill.2</a>
says that it&#39;s for compatibility with System V. 4.3 BSD is also
where the <code>kill()</code> system call stops supporting the 4BSD behavior
of sending signals to process groups instead of PIDs through negative
signal numbers (see <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=4.3BSD/usr/src/sys/sys/kern_sig.c">kern_sig.c</a>).</p>

<p>Before I started down this rabbit hole I would have assumed that
you could send signals to process groups as far back as at least
V7, and that it would have been done in the modern way. I wouldn&#39;t
have guessed that signaling process groups was developed separately
in both main branches of Unix (AT&amp;T and BSD), and that they initially
used different APIs.</p>

<p>Since I just looked it up, POSIX standardized both <a href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/killpg.html"><code>killpg()</code></a>
and the modern version of <a href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/kill.html"><code>kill()</code></a>.
You can of course implement your <code>killpg()</code> through a POSIX standard
<code>kill()</code>, so you don&#39;t need both as actual system calls.</p>
</div></div>
  </body>
</html>
